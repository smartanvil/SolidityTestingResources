Class {
	#name : #SRT7a8a770b36e27177a68424c9d4ddcdd2c32dcb1b,
	#superclass : #SRTContracts,
	#category : #SolidityTestingResources
}

{ #category : #base64 }
SRT7a8a770b36e27177a68424c9d4ddcdd2c32dcb1b >> base64 [
	^ 'cHJhZ21hIHNvbGlkaXR5IF4wLjQuMTM7CgppbnRlcmZhY2UgQ29udmVyc2lvblJhdGVzSW50ZXJmYWNlIHsKCiAgICBmdW5jdGlvbiByZWNvcmRJbWJhbGFuY2UoCiAgICAgICAgRVJDMjAgdG9rZW4sCiAgICAgICAgaW50IGJ1eUFtb3VudCwKICAgICAgICB1aW50IHJhdGVVcGRhdGVCbG9jaywKICAgICAgICB1aW50IGN1cnJlbnRCbG9jawogICAgKQogICAgICAgIHB1YmxpYzsKCiAgICBmdW5jdGlvbiBnZXRSYXRlKEVSQzIwIHRva2VuLCB1aW50IGN1cnJlbnRCbG9ja051bWJlciwgYm9vbCBidXksIHVpbnQgcXR5KSBwdWJsaWMgdmlldyByZXR1cm5zKHVpbnQpOwp9CgppbnRlcmZhY2UgRVJDMjAgewogICAgZnVuY3Rpb24gdG90YWxTdXBwbHkoKSBwdWJsaWMgdmlldyByZXR1cm5zICh1aW50IHN1cHBseSk7CiAgICBmdW5jdGlvbiBiYWxhbmNlT2YoYWRkcmVzcyBfb3duZXIpIHB1YmxpYyB2aWV3IHJldHVybnMgKHVpbnQgYmFsYW5jZSk7CiAgICBmdW5jdGlvbiB0cmFuc2ZlcihhZGRyZXNzIF90bywgdWludCBfdmFsdWUpIHB1YmxpYyByZXR1cm5zIChib29sIHN1Y2Nlc3MpOwogICAgZnVuY3Rpb24gdHJhbnNmZXJGcm9tKGFkZHJlc3MgX2Zyb20sIGFkZHJlc3MgX3RvLCB1aW50IF92YWx1ZSkgcHVibGljIHJldHVybnMgKGJvb2wgc3VjY2Vzcyk7CiAgICBmdW5jdGlvbiBhcHByb3ZlKGFkZHJlc3MgX3NwZW5kZXIsIHVpbnQgX3ZhbHVlKSBwdWJsaWMgcmV0dXJucyAoYm9vbCBzdWNjZXNzKTsKICAgIGZ1bmN0aW9uIGFsbG93YW5jZShhZGRyZXNzIF9vd25lciwgYWRkcmVzcyBfc3BlbmRlcikgcHVibGljIHZpZXcgcmV0dXJucyAodWludCByZW1haW5pbmcpOwogICAgZnVuY3Rpb24gZGVjaW1hbHMoKSBwdWJsaWMgdmlldyByZXR1cm5zKHVpbnQgZGlnaXRzKTsKICAgIGV2ZW50IEFwcHJvdmFsKGFkZHJlc3MgaW5kZXhlZCBfb3duZXIsIGFkZHJlc3MgaW5kZXhlZCBfc3BlbmRlciwgdWludCBfdmFsdWUpOwp9CgppbnRlcmZhY2UgRXhwZWN0ZWRSYXRlSW50ZXJmYWNlIHsKICAgIGZ1bmN0aW9uIGdldEV4cGVjdGVkUmF0ZShFUkMyMCBzcmMsIEVSQzIwIGRlc3QsIHVpbnQgc3JjUXR5KSBwdWJsaWMgdmlldwogICAgICAgIHJldHVybnMgKHVpbnQgZXhwZWN0ZWRSYXRlLCB1aW50IHNsaXBwYWdlUmF0ZSk7Cn0KCmludGVyZmFjZSBGZWVCdXJuZXJJbnRlcmZhY2UgewogICAgZnVuY3Rpb24gaGFuZGxlRmVlcyAodWludCB0cmFkZVdlaUFtb3VudCwgYWRkcmVzcyByZXNlcnZlLCBhZGRyZXNzIHdhbGxldCkgcHVibGljIHJldHVybnMoYm9vbCk7Cn0KCmludGVyZmFjZSBLeWJlclJlc2VydmVJbnRlcmZhY2UgewoKICAgIGZ1bmN0aW9uIHRyYWRlKAogICAgICAgIEVSQzIwIHNyY1Rva2VuLAogICAgICAgIHVpbnQgc3JjQW1vdW50LAogICAgICAgIEVSQzIwIGRlc3RUb2tlbiwKICAgICAgICBhZGRyZXNzIGRlc3RBZGRyZXNzLAogICAgICAgIHVpbnQgY29udmVyc2lvblJhdGUsCiAgICAgICAgYm9vbCB2YWxpZGF0ZQogICAgKQogICAgICAgIHB1YmxpYwogICAgICAgIHBheWFibGUKICAgICAgICByZXR1cm5zKGJvb2wpOwoKICAgIGZ1bmN0aW9uIGdldENvbnZlcnNpb25SYXRlKEVSQzIwIHNyYywgRVJDMjAgZGVzdCwgdWludCBzcmNRdHksIHVpbnQgYmxvY2tOdW1iZXIpIHB1YmxpYyB2aWV3IHJldHVybnModWludCk7Cn0KCmNvbnRyYWN0IFBlcm1pc3Npb25Hcm91cHMgewoKICAgIGFkZHJlc3MgcHVibGljIGFkbWluOwogICAgYWRkcmVzcyBwdWJsaWMgcGVuZGluZ0FkbWluOwogICAgbWFwcGluZyhhZGRyZXNzPT5ib29sKSBpbnRlcm5hbCBvcGVyYXRvcnM7CiAgICBtYXBwaW5nKGFkZHJlc3M9PmJvb2wpIGludGVybmFsIGFsZXJ0ZXJzOwogICAgYWRkcmVzc1tdIGludGVybmFsIG9wZXJhdG9yc0dyb3VwOwogICAgYWRkcmVzc1tdIGludGVybmFsIGFsZXJ0ZXJzR3JvdXA7CiAgICB1aW50IGNvbnN0YW50IGludGVybmFsIE1BWF9HUk9VUF9TSVpFID0gNTA7CgogICAgZnVuY3Rpb24gUGVybWlzc2lvbkdyb3VwcygpIHB1YmxpYyB7CiAgICAgICAgYWRtaW4gPSBtc2cuc2VuZGVyOwogICAgfQoKICAgIG1vZGlmaWVyIG9ubHlBZG1pbigpIHsKICAgICAgICByZXF1aXJlKG1zZy5zZW5kZXIgPT0gYWRtaW4pOwogICAgICAgIF87CiAgICB9CgogICAgbW9kaWZpZXIgb25seU9wZXJhdG9yKCkgewogICAgICAgIHJlcXVpcmUob3BlcmF0b3JzW21zZy5zZW5kZXJdKTsKICAgICAgICBfOwogICAgfQoKICAgIG1vZGlmaWVyIG9ubHlBbGVydGVyKCkgewogICAgICAgIHJlcXVpcmUoYWxlcnRlcnNbbXNnLnNlbmRlcl0pOwogICAgICAgIF87CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0T3BlcmF0b3JzICgpIGV4dGVybmFsIHZpZXcgcmV0dXJucyhhZGRyZXNzW10pIHsKICAgICAgICByZXR1cm4gb3BlcmF0b3JzR3JvdXA7CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0QWxlcnRlcnMgKCkgZXh0ZXJuYWwgdmlldyByZXR1cm5zKGFkZHJlc3NbXSkgewogICAgICAgIHJldHVybiBhbGVydGVyc0dyb3VwOwogICAgfQoKICAgIGV2ZW50IFRyYW5zZmVyQWRtaW5QZW5kaW5nKGFkZHJlc3MgcGVuZGluZ0FkbWluKTsKCiAgICAvKioKICAgICAqIEBkZXYgQWxsb3dzIHRoZSBjdXJyZW50IGFkbWluIHRvIHNldCB0aGUgcGVuZGluZ0FkbWluIGFkZHJlc3MuCiAgICAgKiBAcGFyYW0gbmV3QWRtaW4gVGhlIGFkZHJlc3MgdG8gdHJhbnNmZXIgb3duZXJzaGlwIHRvLgogICAgICovCiAgICBmdW5jdGlvbiB0cmFuc2ZlckFkbWluKGFkZHJlc3MgbmV3QWRtaW4pIHB1YmxpYyBvbmx5QWRtaW4gewogICAgICAgIHJlcXVpcmUobmV3QWRtaW4gIT0gYWRkcmVzcygwKSk7CiAgICAgICAgVHJhbnNmZXJBZG1pblBlbmRpbmcocGVuZGluZ0FkbWluKTsKICAgICAgICBwZW5kaW5nQWRtaW4gPSBuZXdBZG1pbjsKICAgIH0KCiAgICAvKioKICAgICAqIEBkZXYgQWxsb3dzIHRoZSBjdXJyZW50IGFkbWluIHRvIHNldCB0aGUgYWRtaW4gaW4gb25lIHR4LiBVc2VmdWwgaW5pdGlhbCBkZXBsb3ltZW50LgogICAgICogQHBhcmFtIG5ld0FkbWluIFRoZSBhZGRyZXNzIHRvIHRyYW5zZmVyIG93bmVyc2hpcCB0by4KICAgICAqLwogICAgZnVuY3Rpb24gdHJhbnNmZXJBZG1pblF1aWNrbHkoYWRkcmVzcyBuZXdBZG1pbikgcHVibGljIG9ubHlBZG1pbiB7CiAgICAgICAgcmVxdWlyZShuZXdBZG1pbiAhPSBhZGRyZXNzKDApKTsKICAgICAgICBUcmFuc2ZlckFkbWluUGVuZGluZyhuZXdBZG1pbik7CiAgICAgICAgQWRtaW5DbGFpbWVkKG5ld0FkbWluLCBhZG1pbik7CiAgICAgICAgYWRtaW4gPSBuZXdBZG1pbjsKICAgIH0KCiAgICBldmVudCBBZG1pbkNsYWltZWQoIGFkZHJlc3MgbmV3QWRtaW4sIGFkZHJlc3MgcHJldmlvdXNBZG1pbik7CgogICAgLyoqCiAgICAgKiBAZGV2IEFsbG93cyB0aGUgcGVuZGluZ0FkbWluIGFkZHJlc3MgdG8gZmluYWxpemUgdGhlIGNoYW5nZSBhZG1pbiBwcm9jZXNzLgogICAgICovCiAgICBmdW5jdGlvbiBjbGFpbUFkbWluKCkgcHVibGljIHsKICAgICAgICByZXF1aXJlKHBlbmRpbmdBZG1pbiA9PSBtc2cuc2VuZGVyKTsKICAgICAgICBBZG1pbkNsYWltZWQocGVuZGluZ0FkbWluLCBhZG1pbik7CiAgICAgICAgYWRtaW4gPSBwZW5kaW5nQWRtaW47CiAgICAgICAgcGVuZGluZ0FkbWluID0gYWRkcmVzcygwKTsKICAgIH0KCiAgICBldmVudCBBbGVydGVyQWRkZWQgKGFkZHJlc3MgbmV3QWxlcnRlciwgYm9vbCBpc0FkZCk7CgogICAgZnVuY3Rpb24gYWRkQWxlcnRlcihhZGRyZXNzIG5ld0FsZXJ0ZXIpIHB1YmxpYyBvbmx5QWRtaW4gewogICAgICAgIHJlcXVpcmUoIWFsZXJ0ZXJzW25ld0FsZXJ0ZXJdKTsgLy8gcHJldmVudCBkdXBsaWNhdGVzLgogICAgICAgIHJlcXVpcmUoYWxlcnRlcnNHcm91cC5sZW5ndGggPCBNQVhfR1JPVVBfU0laRSk7CgogICAgICAgIEFsZXJ0ZXJBZGRlZChuZXdBbGVydGVyLCB0cnVlKTsKICAgICAgICBhbGVydGVyc1tuZXdBbGVydGVyXSA9IHRydWU7CiAgICAgICAgYWxlcnRlcnNHcm91cC5wdXNoKG5ld0FsZXJ0ZXIpOwogICAgfQoKICAgIGZ1bmN0aW9uIHJlbW92ZUFsZXJ0ZXIgKGFkZHJlc3MgYWxlcnRlcikgcHVibGljIG9ubHlBZG1pbiB7CiAgICAgICAgcmVxdWlyZShhbGVydGVyc1thbGVydGVyXSk7CiAgICAgICAgYWxlcnRlcnNbYWxlcnRlcl0gPSBmYWxzZTsKCiAgICAgICAgZm9yICh1aW50IGkgPSAwOyBpIDwgYWxlcnRlcnNHcm91cC5sZW5ndGg7ICsraSkgewogICAgICAgICAgICBpZiAoYWxlcnRlcnNHcm91cFtpXSA9PSBhbGVydGVyKSB7CiAgICAgICAgICAgICAgICBhbGVydGVyc0dyb3VwW2ldID0gYWxlcnRlcnNHcm91cFthbGVydGVyc0dyb3VwLmxlbmd0aCAtIDFdOwogICAgICAgICAgICAgICAgYWxlcnRlcnNHcm91cC5sZW5ndGgtLTsKICAgICAgICAgICAgICAgIEFsZXJ0ZXJBZGRlZChhbGVydGVyLCBmYWxzZSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBldmVudCBPcGVyYXRvckFkZGVkKGFkZHJlc3MgbmV3T3BlcmF0b3IsIGJvb2wgaXNBZGQpOwoKICAgIGZ1bmN0aW9uIGFkZE9wZXJhdG9yKGFkZHJlc3MgbmV3T3BlcmF0b3IpIHB1YmxpYyBvbmx5QWRtaW4gewogICAgICAgIHJlcXVpcmUoIW9wZXJhdG9yc1tuZXdPcGVyYXRvcl0pOyAvLyBwcmV2ZW50IGR1cGxpY2F0ZXMuCiAgICAgICAgcmVxdWlyZShvcGVyYXRvcnNHcm91cC5sZW5ndGggPCBNQVhfR1JPVVBfU0laRSk7CgogICAgICAgIE9wZXJhdG9yQWRkZWQobmV3T3BlcmF0b3IsIHRydWUpOwogICAgICAgIG9wZXJhdG9yc1tuZXdPcGVyYXRvcl0gPSB0cnVlOwogICAgICAgIG9wZXJhdG9yc0dyb3VwLnB1c2gobmV3T3BlcmF0b3IpOwogICAgfQoKICAgIGZ1bmN0aW9uIHJlbW92ZU9wZXJhdG9yIChhZGRyZXNzIG9wZXJhdG9yKSBwdWJsaWMgb25seUFkbWluIHsKICAgICAgICByZXF1aXJlKG9wZXJhdG9yc1tvcGVyYXRvcl0pOwogICAgICAgIG9wZXJhdG9yc1tvcGVyYXRvcl0gPSBmYWxzZTsKCiAgICAgICAgZm9yICh1aW50IGkgPSAwOyBpIDwgb3BlcmF0b3JzR3JvdXAubGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgaWYgKG9wZXJhdG9yc0dyb3VwW2ldID09IG9wZXJhdG9yKSB7CiAgICAgICAgICAgICAgICBvcGVyYXRvcnNHcm91cFtpXSA9IG9wZXJhdG9yc0dyb3VwW29wZXJhdG9yc0dyb3VwLmxlbmd0aCAtIDFdOwogICAgICAgICAgICAgICAgb3BlcmF0b3JzR3JvdXAubGVuZ3RoIC09IDE7CiAgICAgICAgICAgICAgICBPcGVyYXRvckFkZGVkKG9wZXJhdG9yLCBmYWxzZSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KfQoKaW50ZXJmYWNlIFNhbml0eVJhdGVzSW50ZXJmYWNlIHsKICAgIGZ1bmN0aW9uIGdldFNhbml0eVJhdGUoRVJDMjAgc3JjLCBFUkMyMCBkZXN0KSBwdWJsaWMgdmlldyByZXR1cm5zKHVpbnQpOwp9Cgpjb250cmFjdCBVdGlscyB7CgogICAgRVJDMjAgY29uc3RhbnQgaW50ZXJuYWwgRVRIX1RPS0VOX0FERFJFU1MgPSBFUkMyMCgweDAwZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZSk7CiAgICB1aW50ICBjb25zdGFudCBpbnRlcm5hbCBQUkVDSVNJT04gPSAoMTAqKjE4KTsKICAgIHVpbnQgIGNvbnN0YW50IGludGVybmFsIE1BWF9RVFkgICA9ICgxMCoqMjgpOyAvLyAxMEIgdG9rZW5zCiAgICB1aW50ICBjb25zdGFudCBpbnRlcm5hbCBNQVhfUkFURSAgPSAoUFJFQ0lTSU9OICogMTAqKjYpOyAvLyB1cCB0byAxTSB0b2tlbnMgcGVyIEVUSAogICAgdWludCAgY29uc3RhbnQgaW50ZXJuYWwgTUFYX0RFQ0lNQUxTID0gMTg7CiAgICB1aW50ICBjb25zdGFudCBpbnRlcm5hbCBFVEhfREVDSU1BTFMgPSAxODsKICAgIG1hcHBpbmcoYWRkcmVzcz0+dWludCkgaW50ZXJuYWwgZGVjaW1hbHM7CgogICAgZnVuY3Rpb24gc2V0RGVjaW1hbHMoRVJDMjAgdG9rZW4pIGludGVybmFsIHsKICAgICAgICBpZiAodG9rZW4gPT0gRVRIX1RPS0VOX0FERFJFU1MpIGRlY2ltYWxzW3Rva2VuXSA9IEVUSF9ERUNJTUFMUzsKICAgICAgICBlbHNlIGRlY2ltYWxzW3Rva2VuXSA9IHRva2VuLmRlY2ltYWxzKCk7CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0RGVjaW1hbHMoRVJDMjAgdG9rZW4pIGludGVybmFsIHZpZXcgcmV0dXJucyh1aW50KSB7CiAgICAgICAgaWYgKHRva2VuID09IEVUSF9UT0tFTl9BRERSRVNTKSByZXR1cm4gRVRIX0RFQ0lNQUxTOyAvLyBzYXZlIHN0b3JhZ2UgYWNjZXNzCiAgICAgICAgdWludCB0b2tlbkRlY2ltYWxzID0gZGVjaW1hbHNbdG9rZW5dOwogICAgICAgIC8vIHRlY2huaWNhbGx5LCB0aGVyZSBtaWdodCBiZSB0b2tlbiB3aXRoIGRlY2ltYWxzIDAKICAgICAgICAvLyBtb3Jlb3ZlciwgdmVyeSBwb3NzaWJsZSB0aGF0IG9sZCB0b2tlbnMgaGF2ZSBkZWNpbWFscyAwCiAgICAgICAgLy8gdGhlc2UgdG9rZW5zIHdpbGwganVzdCBoYXZlIGhpZ2hlciBnYXMgZmVlcy4KICAgICAgICBpZih0b2tlbkRlY2ltYWxzID09IDApIHJldHVybiB0b2tlbi5kZWNpbWFscygpOwoKICAgICAgICByZXR1cm4gdG9rZW5EZWNpbWFsczsKICAgIH0KCiAgICBmdW5jdGlvbiBjYWxjRHN0UXR5KHVpbnQgc3JjUXR5LCB1aW50IHNyY0RlY2ltYWxzLCB1aW50IGRzdERlY2ltYWxzLCB1aW50IHJhdGUpIGludGVybmFsIHB1cmUgcmV0dXJucyh1aW50KSB7CiAgICAgICAgcmVxdWlyZShzcmNRdHkgPD0gTUFYX1FUWSk7CiAgICAgICAgcmVxdWlyZShyYXRlIDw9IE1BWF9SQVRFKTsKCiAgICAgICAgaWYgKGRzdERlY2ltYWxzID49IHNyY0RlY2ltYWxzKSB7CiAgICAgICAgICAgIHJlcXVpcmUoKGRzdERlY2ltYWxzIC0gc3JjRGVjaW1hbHMpIDw9IE1BWF9ERUNJTUFMUyk7CiAgICAgICAgICAgIHJldHVybiAoc3JjUXR5ICogcmF0ZSAqICgxMCoqKGRzdERlY2ltYWxzIC0gc3JjRGVjaW1hbHMpKSkgLyBQUkVDSVNJT047CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVxdWlyZSgoc3JjRGVjaW1hbHMgLSBkc3REZWNpbWFscykgPD0gTUFYX0RFQ0lNQUxTKTsKICAgICAgICAgICAgcmV0dXJuIChzcmNRdHkgKiByYXRlKSAvIChQUkVDSVNJT04gKiAoMTAqKihzcmNEZWNpbWFscyAtIGRzdERlY2ltYWxzKSkpOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBjYWxjU3JjUXR5KHVpbnQgZHN0UXR5LCB1aW50IHNyY0RlY2ltYWxzLCB1aW50IGRzdERlY2ltYWxzLCB1aW50IHJhdGUpIGludGVybmFsIHB1cmUgcmV0dXJucyh1aW50KSB7CiAgICAgICAgcmVxdWlyZShkc3RRdHkgPD0gTUFYX1FUWSk7CiAgICAgICAgcmVxdWlyZShyYXRlIDw9IE1BWF9SQVRFKTsKICAgICAgICAKICAgICAgICAvL3NvdXJjZSBxdWFudGl0eSBpcyByb3VuZGVkIHVwLiB0byBhdm9pZCBkZXN0IHF1YW50aXR5IGJlaW5nIHRvbyBsb3cuCiAgICAgICAgdWludCBudW1lcmF0b3I7CiAgICAgICAgdWludCBkZW5vbWluYXRvcjsKICAgICAgICBpZiAoc3JjRGVjaW1hbHMgPj0gZHN0RGVjaW1hbHMpIHsKICAgICAgICAgICAgcmVxdWlyZSgoc3JjRGVjaW1hbHMgLSBkc3REZWNpbWFscykgPD0gTUFYX0RFQ0lNQUxTKTsKICAgICAgICAgICAgbnVtZXJhdG9yID0gKFBSRUNJU0lPTiAqIGRzdFF0eSAqICgxMCoqKHNyY0RlY2ltYWxzIC0gZHN0RGVjaW1hbHMpKSk7CiAgICAgICAgICAgIGRlbm9taW5hdG9yID0gcmF0ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXF1aXJlKChkc3REZWNpbWFscyAtIHNyY0RlY2ltYWxzKSA8PSBNQVhfREVDSU1BTFMpOwogICAgICAgICAgICBudW1lcmF0b3IgPSAoUFJFQ0lTSU9OICogZHN0UXR5KTsKICAgICAgICAgICAgZGVub21pbmF0b3IgPSAocmF0ZSAqICgxMCoqKGRzdERlY2ltYWxzIC0gc3JjRGVjaW1hbHMpKSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiAobnVtZXJhdG9yICsgZGVub21pbmF0b3IgLSAxKSAvIGRlbm9taW5hdG9yOyAvL2F2b2lkIHJvdW5kaW5nIGRvd24gZXJyb3JzCiAgICB9Cn0KCmNvbnRyYWN0IFdoaXRlTGlzdEludGVyZmFjZSB7CiAgICBmdW5jdGlvbiBnZXRVc2VyQ2FwSW5XZWkoYWRkcmVzcyB1c2VyKSBleHRlcm5hbCB2aWV3IHJldHVybnMgKHVpbnQgdXNlckNhcFdlaSk7Cn0KCmNvbnRyYWN0IFdpdGhkcmF3YWJsZSBpcyBQZXJtaXNzaW9uR3JvdXBzIHsKCiAgICBldmVudCBUb2tlbldpdGhkcmF3KEVSQzIwIHRva2VuLCB1aW50IGFtb3VudCwgYWRkcmVzcyBzZW5kVG8pOwoKICAgIC8qKgogICAgICogQGRldiBXaXRoZHJhdyBhbGwgRVJDMjAgY29tcGF0aWJsZSB0b2tlbnMKICAgICAqIEBwYXJhbSB0b2tlbiBFUkMyMCBUaGUgYWRkcmVzcyBvZiB0aGUgdG9rZW4gY29udHJhY3QKICAgICAqLwogICAgZnVuY3Rpb24gd2l0aGRyYXdUb2tlbihFUkMyMCB0b2tlbiwgdWludCBhbW91bnQsIGFkZHJlc3Mgc2VuZFRvKSBleHRlcm5hbCBvbmx5QWRtaW4gewogICAgICAgIHJlcXVpcmUodG9rZW4udHJhbnNmZXIoc2VuZFRvLCBhbW91bnQpKTsKICAgICAgICBUb2tlbldpdGhkcmF3KHRva2VuLCBhbW91bnQsIHNlbmRUbyk7CiAgICB9CgogICAgZXZlbnQgRXRoZXJXaXRoZHJhdyh1aW50IGFtb3VudCwgYWRkcmVzcyBzZW5kVG8pOwoKICAgIC8qKgogICAgICogQGRldiBXaXRoZHJhdyBFdGhlcnMKICAgICAqLwogICAgZnVuY3Rpb24gd2l0aGRyYXdFdGhlcih1aW50IGFtb3VudCwgYWRkcmVzcyBzZW5kVG8pIGV4dGVybmFsIG9ubHlBZG1pbiB7CiAgICAgICAgc2VuZFRvLnRyYW5zZmVyKGFtb3VudCk7CiAgICAgICAgRXRoZXJXaXRoZHJhdyhhbW91bnQsIHNlbmRUbyk7CiAgICB9Cn0KCmNvbnRyYWN0IEt5YmVyTmV0d29yayBpcyBXaXRoZHJhd2FibGUsIFV0aWxzIHsKCiAgICB1aW50IHB1YmxpYyBuZWdsaWdpYmxlUmF0ZURpZmYgPSAxMDsgLy8gYmFzaWMgcmF0ZSBzdGVwcyB3aWxsIGJlIGluIDAuMDElCiAgICBLeWJlclJlc2VydmVJbnRlcmZhY2VbXSBwdWJsaWMgcmVzZXJ2ZXM7CiAgICBtYXBwaW5nKGFkZHJlc3M9PmJvb2wpIHB1YmxpYyBpc1Jlc2VydmU7CiAgICBXaGl0ZUxpc3RJbnRlcmZhY2UgcHVibGljIHdoaXRlTGlzdENvbnRyYWN0OwogICAgRXhwZWN0ZWRSYXRlSW50ZXJmYWNlIHB1YmxpYyBleHBlY3RlZFJhdGVDb250cmFjdDsKICAgIEZlZUJ1cm5lckludGVyZmFjZSAgICBwdWJsaWMgZmVlQnVybmVyQ29udHJhY3Q7CiAgICB1aW50ICAgICAgICAgICAgICAgICAgcHVibGljIG1heEdhc1ByaWNlID0gNTAgKiAxMDAwICogMTAwMCAqIDEwMDA7IC8vIDUwIGd3ZWkKICAgIGJvb2wgICAgICAgICAgICAgICAgICBwdWJsaWMgZW5hYmxlZCA9IGZhbHNlOyAvLyBuZXR3b3JrIGlzIGVuYWJsZWQKICAgIG1hcHBpbmcoYnl0ZXMzMj0+dWludCkgcHVibGljIGluZm87IC8vIHRoaXMgaXMgb25seSBhIFVJIGZpZWxkIGZvciBleHRlcm5hbCBhcHAuCiAgICBtYXBwaW5nKGFkZHJlc3M9Pm1hcHBpbmcoYnl0ZXMzMj0+Ym9vbCkpIHB1YmxpYyBwZXJSZXNlcnZlTGlzdGVkUGFpcnM7CgogICAgZnVuY3Rpb24gS3liZXJOZXR3b3JrKGFkZHJlc3MgX2FkbWluKSBwdWJsaWMgewogICAgICAgIHJlcXVpcmUoX2FkbWluICE9IGFkZHJlc3MoMCkpOwogICAgICAgIGFkbWluID0gX2FkbWluOwogICAgfQoKICAgIGV2ZW50IEV0aGVyUmVjZWl2YWwoYWRkcmVzcyBpbmRleGVkIHNlbmRlciwgdWludCBhbW91bnQpOwoKICAgIC8qIHNvbGhpbnQtZGlzYWJsZSBuby1jb21wbGV4LWZhbGxiYWNrICovCiAgICBmdW5jdGlvbigpIHB1YmxpYyBwYXlhYmxlIHsKICAgICAgICByZXF1aXJlKGlzUmVzZXJ2ZVttc2cuc2VuZGVyXSk7CiAgICAgICAgRXRoZXJSZWNlaXZhbChtc2cuc2VuZGVyLCBtc2cudmFsdWUpOwogICAgfQogICAgLyogc29saGludC1lbmFibGUgbm8tY29tcGxleC1mYWxsYmFjayAqLwoKICAgIGV2ZW50IEV4ZWN1dGVUcmFkZShhZGRyZXNzIGluZGV4ZWQgc2VuZGVyLCBFUkMyMCBzcmMsIEVSQzIwIGRlc3QsIHVpbnQgYWN0dWFsU3JjQW1vdW50LCB1aW50IGFjdHVhbERlc3RBbW91bnQpOwoKICAgIC8vLyBAbm90aWNlIHVzZSB0b2tlbiBhZGRyZXNzIEVUSF9UT0tFTl9BRERSRVNTIGZvciBldGhlcgogICAgLy8vIEBkZXYgbWFrZXMgYSB0cmFkZSBiZXR3ZWVuIHNyYyBhbmQgZGVzdCB0b2tlbiBhbmQgc2VuZCBkZXN0IHRva2VuIHRvIGRlc3RBZGRyZXNzCiAgICAvLy8gQHBhcmFtIHNyYyBTcmMgdG9rZW4KICAgIC8vLyBAcGFyYW0gc3JjQW1vdW50IGFtb3VudCBvZiBzcmMgdG9rZW5zCiAgICAvLy8gQHBhcmFtIGRlc3QgICBEZXN0aW5hdGlvbiB0b2tlbgogICAgLy8vIEBwYXJhbSBkZXN0QWRkcmVzcyBBZGRyZXNzIHRvIHNlbmQgdG9rZW5zIHRvCiAgICAvLy8gQHBhcmFtIG1heERlc3RBbW91bnQgQSBsaW1pdCBvbiB0aGUgYW1vdW50IG9mIGRlc3QgdG9rZW5zCiAgICAvLy8gQHBhcmFtIG1pbkNvbnZlcnNpb25SYXRlIFRoZSBtaW5pbWFsIGNvbnZlcnNpb24gcmF0ZS4gSWYgYWN0dWFsIHJhdGUgaXMgbG93ZXIsIHRyYWRlIGlzIGNhbmNlbGVkLgogICAgLy8vIEBwYXJhbSB3YWxsZXRJZCBpcyB0aGUgd2FsbGV0IElEIHRvIHNlbmQgcGFydCBvZiB0aGUgZmVlcwogICAgLy8vIEByZXR1cm4gYW1vdW50IG9mIGFjdHVhbCBkZXN0IHRva2VucwogICAgZnVuY3Rpb24gdHJhZGUoCiAgICAgICAgRVJDMjAgc3JjLAogICAgICAgIHVpbnQgc3JjQW1vdW50LAogICAgICAgIEVSQzIwIGRlc3QsCiAgICAgICAgYWRkcmVzcyBkZXN0QWRkcmVzcywKICAgICAgICB1aW50IG1heERlc3RBbW91bnQsCiAgICAgICAgdWludCBtaW5Db252ZXJzaW9uUmF0ZSwKICAgICAgICBhZGRyZXNzIHdhbGxldElkCiAgICApCiAgICAgICAgcHVibGljCiAgICAgICAgcGF5YWJsZQogICAgICAgIHJldHVybnModWludCkKICAgIHsKICAgICAgICByZXF1aXJlKGVuYWJsZWQpOwoKICAgICAgICB1aW50IHVzZXJTcmNCYWxhbmNlQmVmb3JlOwogICAgICAgIHVpbnQgdXNlclNyY0JhbGFuY2VBZnRlcjsKICAgICAgICB1aW50IHVzZXJEZXN0QmFsYW5jZUJlZm9yZTsKICAgICAgICB1aW50IHVzZXJEZXN0QmFsYW5jZUFmdGVyOwoKICAgICAgICB1c2VyU3JjQmFsYW5jZUJlZm9yZSA9IGdldEJhbGFuY2Uoc3JjLCBtc2cuc2VuZGVyKTsKICAgICAgICBpZiAoc3JjID09IEVUSF9UT0tFTl9BRERSRVNTKQogICAgICAgICAgICB1c2VyU3JjQmFsYW5jZUJlZm9yZSArPSBtc2cudmFsdWU7CiAgICAgICAgdXNlckRlc3RCYWxhbmNlQmVmb3JlID0gZ2V0QmFsYW5jZShkZXN0LCBkZXN0QWRkcmVzcyk7CgogICAgICAgIHVpbnQgYWN0dWFsRGVzdEFtb3VudCA9IGRvVHJhZGUoc3JjLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3JjQW1vdW50LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVzdCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlc3RBZGRyZXNzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF4RGVzdEFtb3VudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1pbkNvbnZlcnNpb25SYXRlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2FsbGV0SWQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgcmVxdWlyZShhY3R1YWxEZXN0QW1vdW50ID4gMCk7CgogICAgICAgIHVzZXJTcmNCYWxhbmNlQWZ0ZXIgPSBnZXRCYWxhbmNlKHNyYywgbXNnLnNlbmRlcik7CiAgICAgICAgdXNlckRlc3RCYWxhbmNlQWZ0ZXIgPSBnZXRCYWxhbmNlKGRlc3QsIGRlc3RBZGRyZXNzKTsKCiAgICAgICAgcmVxdWlyZSh1c2VyU3JjQmFsYW5jZUFmdGVyIDw9IHVzZXJTcmNCYWxhbmNlQmVmb3JlKTsKICAgICAgICByZXF1aXJlKHVzZXJEZXN0QmFsYW5jZUFmdGVyID49IHVzZXJEZXN0QmFsYW5jZUJlZm9yZSk7CgogICAgICAgIHJlcXVpcmUoKHVzZXJEZXN0QmFsYW5jZUFmdGVyIC0gdXNlckRlc3RCYWxhbmNlQmVmb3JlKSA+PQogICAgICAgICAgICBjYWxjRHN0UXR5KCh1c2VyU3JjQmFsYW5jZUJlZm9yZSAtIHVzZXJTcmNCYWxhbmNlQWZ0ZXIpLCBnZXREZWNpbWFscyhzcmMpLCBnZXREZWNpbWFscyhkZXN0KSwKICAgICAgICAgICAgICAgIG1pbkNvbnZlcnNpb25SYXRlKSk7CgogICAgICAgIHJldHVybiBhY3R1YWxEZXN0QW1vdW50OwogICAgfQoKICAgIGV2ZW50IEFkZFJlc2VydmVUb05ldHdvcmsoS3liZXJSZXNlcnZlSW50ZXJmYWNlIHJlc2VydmUsIGJvb2wgYWRkKTsKCiAgICAvLy8gQG5vdGljZSBjYW4gYmUgY2FsbGVkIG9ubHkgYnkgYWRtaW4KICAgIC8vLyBAZGV2IGFkZCBvciBkZWxldGVzIGEgcmVzZXJ2ZSB0by9mcm9tIHRoZSBuZXR3b3JrLgogICAgLy8vIEBwYXJhbSByZXNlcnZlIFRoZSByZXNlcnZlIGFkZHJlc3MuCiAgICAvLy8gQHBhcmFtIGFkZCBJZiB0cnVlLCB0aGUgYWRkIHJlc2VydmUuIE90aGVyd2lzZSBkZWxldGUgcmVzZXJ2ZS4KICAgIGZ1bmN0aW9uIGFkZFJlc2VydmUoS3liZXJSZXNlcnZlSW50ZXJmYWNlIHJlc2VydmUsIGJvb2wgYWRkKSBwdWJsaWMgb25seUFkbWluIHsKCiAgICAgICAgaWYgKGFkZCkgewogICAgICAgICAgICByZXF1aXJlKCFpc1Jlc2VydmVbcmVzZXJ2ZV0pOwogICAgICAgICAgICByZXNlcnZlcy5wdXNoKHJlc2VydmUpOwogICAgICAgICAgICBpc1Jlc2VydmVbcmVzZXJ2ZV0gPSB0cnVlOwogICAgICAgICAgICBBZGRSZXNlcnZlVG9OZXR3b3JrKHJlc2VydmUsIHRydWUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlzUmVzZXJ2ZVtyZXNlcnZlXSA9IGZhbHNlOwogICAgICAgICAgICAvLyB3aWxsIGhhdmUgdHJvdWJsZSBpZiBtb3JlIHRoYW4gNTBrIHJlc2VydmVzLi4uCiAgICAgICAgICAgIGZvciAodWludCBpID0gMDsgaSA8IHJlc2VydmVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAocmVzZXJ2ZXNbaV0gPT0gcmVzZXJ2ZSkgewogICAgICAgICAgICAgICAgICAgIHJlc2VydmVzW2ldID0gcmVzZXJ2ZXNbcmVzZXJ2ZXMubGVuZ3RoIC0gMV07CiAgICAgICAgICAgICAgICAgICAgcmVzZXJ2ZXMubGVuZ3RoLS07CiAgICAgICAgICAgICAgICAgICAgQWRkUmVzZXJ2ZVRvTmV0d29yayhyZXNlcnZlLCBmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgZXZlbnQgTGlzdFJlc2VydmVQYWlycyhhZGRyZXNzIHJlc2VydmUsIEVSQzIwIHNyYywgRVJDMjAgZGVzdCwgYm9vbCBhZGQpOwoKICAgIC8vLyBAbm90aWNlIGNhbiBiZSBjYWxsZWQgb25seSBieSBhZG1pbgogICAgLy8vIEBkZXYgYWxsb3cgb3IgcHJldmVudCBhIHNwZWNpZmljIHJlc2VydmUgdG8gdHJhZGUgYSBwYWlyIG9mIHRva2VucwogICAgLy8vIEBwYXJhbSByZXNlcnZlIFRoZSByZXNlcnZlIGFkZHJlc3MuCiAgICAvLy8gQHBhcmFtIHNyYyBTcmMgdG9rZW4KICAgIC8vLyBAcGFyYW0gZGVzdCBEZXN0aW5hdGlvbiB0b2tlbgogICAgLy8vIEBwYXJhbSBhZGQgSWYgdHJ1ZSB0aGVuIGVuYWJsZSB0cmFkZSwgb3RoZXJ3aXNlIGRlbGlzdCBwYWlyLgogICAgZnVuY3Rpb24gbGlzdFBhaXJGb3JSZXNlcnZlKGFkZHJlc3MgcmVzZXJ2ZSwgRVJDMjAgc3JjLCBFUkMyMCBkZXN0LCBib29sIGFkZCkgcHVibGljIG9ubHlBZG1pbiB7CiAgICAgICAgKHBlclJlc2VydmVMaXN0ZWRQYWlyc1tyZXNlcnZlXSlba2VjY2FrMjU2KHNyYywgZGVzdCldID0gYWRkOwoKICAgICAgICBpZiAoc3JjICE9IEVUSF9UT0tFTl9BRERSRVNTKSB7CiAgICAgICAgICAgIGlmIChhZGQpIHsKICAgICAgICAgICAgICAgIHNyYy5hcHByb3ZlKHJlc2VydmUsIDIqKjI1NSk7IC8vIGFwcHJvdmUgaW5maW5pdHkKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHNyYy5hcHByb3ZlKHJlc2VydmUsIDApOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBzZXREZWNpbWFscyhzcmMpOwogICAgICAgIHNldERlY2ltYWxzKGRlc3QpOwoKICAgICAgICBMaXN0UmVzZXJ2ZVBhaXJzKHJlc2VydmUsIHNyYywgZGVzdCwgYWRkKTsKICAgIH0KCiAgICBmdW5jdGlvbiBzZXRQYXJhbXMoCiAgICAgICAgV2hpdGVMaXN0SW50ZXJmYWNlICAgIF93aGl0ZUxpc3QsCiAgICAgICAgRXhwZWN0ZWRSYXRlSW50ZXJmYWNlIF9leHBlY3RlZFJhdGUsCiAgICAgICAgRmVlQnVybmVySW50ZXJmYWNlICAgIF9mZWVCdXJuZXIsCiAgICAgICAgdWludCAgICAgICAgICAgICAgICAgIF9tYXhHYXNQcmljZSwKICAgICAgICB1aW50ICAgICAgICAgICAgICAgICAgX25lZ2xpZ2libGVSYXRlRGlmZgogICAgKQogICAgICAgIHB1YmxpYwogICAgICAgIG9ubHlBZG1pbgogICAgewogICAgICAgIHJlcXVpcmUoX3doaXRlTGlzdCAhPSBhZGRyZXNzKDApKTsKICAgICAgICByZXF1aXJlKF9mZWVCdXJuZXIgIT0gYWRkcmVzcygwKSk7CiAgICAgICAgcmVxdWlyZShfZXhwZWN0ZWRSYXRlICE9IGFkZHJlc3MoMCkpOwogICAgICAgIHJlcXVpcmUoX25lZ2xpZ2libGVSYXRlRGlmZiA8PSAxMDAgKiAxMDApOyAvLyBhdCBtb3N0IDEwMCUKICAgICAgICAKICAgICAgICB3aGl0ZUxpc3RDb250cmFjdCA9IF93aGl0ZUxpc3Q7CiAgICAgICAgZXhwZWN0ZWRSYXRlQ29udHJhY3QgPSBfZXhwZWN0ZWRSYXRlOwogICAgICAgIGZlZUJ1cm5lckNvbnRyYWN0ID0gX2ZlZUJ1cm5lcjsKICAgICAgICBtYXhHYXNQcmljZSA9IF9tYXhHYXNQcmljZTsKICAgICAgICBuZWdsaWdpYmxlUmF0ZURpZmYgPSBfbmVnbGlnaWJsZVJhdGVEaWZmOwogICAgfQoKICAgIGZ1bmN0aW9uIHNldEVuYWJsZShib29sIF9lbmFibGUpIHB1YmxpYyBvbmx5QWRtaW4gewogICAgICAgIGlmIChfZW5hYmxlKSB7CiAgICAgICAgICAgIHJlcXVpcmUod2hpdGVMaXN0Q29udHJhY3QgIT0gYWRkcmVzcygwKSk7CiAgICAgICAgICAgIHJlcXVpcmUoZmVlQnVybmVyQ29udHJhY3QgIT0gYWRkcmVzcygwKSk7CiAgICAgICAgICAgIHJlcXVpcmUoZXhwZWN0ZWRSYXRlQ29udHJhY3QgIT0gYWRkcmVzcygwKSk7CiAgICAgICAgfQogICAgICAgIGVuYWJsZWQgPSBfZW5hYmxlOwogICAgfQoKICAgIGZ1bmN0aW9uIHNldEluZm8oYnl0ZXMzMiBmaWVsZCwgdWludCB2YWx1ZSkgcHVibGljIG9ubHlPcGVyYXRvciB7CiAgICAgICAgaW5mb1tmaWVsZF0gPSB2YWx1ZTsKICAgIH0KCiAgICAvLy8gQGRldiByZXR1cm5zIG51bWJlciBvZiByZXNlcnZlcwogICAgLy8vIEByZXR1cm4gbnVtYmVyIG9mIHJlc2VydmVzCiAgICBmdW5jdGlvbiBnZXROdW1SZXNlcnZlcygpIHB1YmxpYyB2aWV3IHJldHVybnModWludCkgewogICAgICAgIHJldHVybiByZXNlcnZlcy5sZW5ndGg7CiAgICB9CgogICAgLy8vIEBub3RpY2Ugc2hvdWxkIGJlIGNhbGxlZCBvZmYgY2hhaW4gd2l0aCBhcyBtdWNoIGdhcyBhcyBuZWVkZWQKICAgIC8vLyBAZGV2IGdldCBhbiBhcnJheSBvZiBhbGwgcmVzZXJ2ZXMKICAgIC8vLyBAcmV0dXJuIEFuIGFycmF5IG9mIGFsbCByZXNlcnZlcwogICAgZnVuY3Rpb24gZ2V0UmVzZXJ2ZXMoKSBwdWJsaWMgdmlldyByZXR1cm5zKEt5YmVyUmVzZXJ2ZUludGVyZmFjZVtdKSB7CiAgICAgICAgcmV0dXJuIHJlc2VydmVzOwogICAgfQoKICAgIC8vLyBAZGV2IGdldCB0aGUgYmFsYW5jZSBvZiBhIHVzZXIuCiAgICAvLy8gQHBhcmFtIHRva2VuIFRoZSB0b2tlbiB0eXBlCiAgICAvLy8gQHJldHVybiBUaGUgYmFsYW5jZQogICAgZnVuY3Rpb24gZ2V0QmFsYW5jZShFUkMyMCB0b2tlbiwgYWRkcmVzcyB1c2VyKSBwdWJsaWMgdmlldyByZXR1cm5zKHVpbnQpIHsKICAgICAgICBpZiAodG9rZW4gPT0gRVRIX1RPS0VOX0FERFJFU1MpCiAgICAgICAgICAgIHJldHVybiB1c2VyLmJhbGFuY2U7CiAgICAgICAgZWxzZQogICAgICAgICAgICByZXR1cm4gdG9rZW4uYmFsYW5jZU9mKHVzZXIpOwogICAgfQoKICAgIC8vLyBAbm90aWNlIHVzZSB0b2tlbiBhZGRyZXNzIEVUSF9UT0tFTl9BRERSRVNTIGZvciBldGhlcgogICAgLy8vIEBkZXYgYmVzdCBjb252ZXJzaW9uIHJhdGUgZm9yIGEgcGFpciBvZiB0b2tlbnMsIGlmIG51bWJlciBvZiByZXNlcnZlcyBoYXZlIHNtYWxsIGRpZmZlcmVuY2VzLiByYW5kb21pemUKICAgIC8vLyBAcGFyYW0gc3JjIFNyYyB0b2tlbgogICAgLy8vIEBwYXJhbSBkZXN0IERlc3RpbmF0aW9uIHRva2VuCiAgICAvKiBzb2xoaW50LWRpc2FibGUgY29kZS1jb21wbGV4aXR5ICovCiAgICBmdW5jdGlvbiBmaW5kQmVzdFJhdGUoRVJDMjAgc3JjLCBFUkMyMCBkZXN0LCB1aW50IHNyY1F0eSkgcHVibGljIHZpZXcgcmV0dXJucyh1aW50LCB1aW50KSB7CiAgICAgICAgdWludCBiZXN0UmF0ZSA9IDA7CiAgICAgICAgdWludCBiZXN0UmVzZXJ2ZSA9IDA7CiAgICAgICAgdWludCBudW1SZWxldmFudFJlc2VydmVzID0gMDsKICAgICAgICB1aW50IG51bVJlc2VydmVzID0gcmVzZXJ2ZXMubGVuZ3RoOwogICAgICAgIHVpbnRbXSBtZW1vcnkgcmF0ZXMgPSBuZXcgdWludFtdKG51bVJlc2VydmVzKTsKICAgICAgICB1aW50W10gbWVtb3J5IHJlc2VydmVDYW5kaWRhdGVzID0gbmV3IHVpbnRbXShudW1SZXNlcnZlcyk7CgogICAgICAgIGZvciAodWludCBpID0gMDsgaSA8IG51bVJlc2VydmVzOyBpKyspIHsKICAgICAgICAgICAgLy9saXN0IGFsbCByZXNlcnZlcyB0aGF0IGhhdmUgdGhpcyB0b2tlbi4KICAgICAgICAgICAgaWYgKCEocGVyUmVzZXJ2ZUxpc3RlZFBhaXJzW3Jlc2VydmVzW2ldXSlba2VjY2FrMjU2KHNyYywgZGVzdCldKSBjb250aW51ZTsKCiAgICAgICAgICAgIHJhdGVzW2ldID0gcmVzZXJ2ZXNbaV0uZ2V0Q29udmVyc2lvblJhdGUoc3JjLCBkZXN0LCBzcmNRdHksIGJsb2NrLm51bWJlcik7CgogICAgICAgICAgICBpZiAocmF0ZXNbaV0gPiBiZXN0UmF0ZSkgewogICAgICAgICAgICAgICAgLy9iZXN0IHJhdGUgaXMgaGlnaGVzdCByYXRlCiAgICAgICAgICAgICAgICBiZXN0UmF0ZSA9IHJhdGVzW2ldOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoYmVzdFJhdGUgPiAwKSB7CiAgICAgICAgICAgIHVpbnQgcmFuZG9tID0gMDsKICAgICAgICAgICAgdWludCBzbWFsbGVzdFJlbGV2YW50UmF0ZSA9IChiZXN0UmF0ZSAqIDEwMDAwKSAvICgxMDAwMCArIG5lZ2xpZ2libGVSYXRlRGlmZik7CgogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbnVtUmVzZXJ2ZXM7IGkrKykgewogICAgICAgICAgICAgICAgaWYgKHJhdGVzW2ldID49IHNtYWxsZXN0UmVsZXZhbnRSYXRlKSB7CiAgICAgICAgICAgICAgICAgICAgcmVzZXJ2ZUNhbmRpZGF0ZXNbbnVtUmVsZXZhbnRSZXNlcnZlcysrXSA9IGk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChudW1SZWxldmFudFJlc2VydmVzID4gMSkgewogICAgICAgICAgICAgICAgLy93aGVuIGVuY291bnRlcmluZyBzbWFsbCByYXRlIGRpZmYgZnJvbSBiZXN0UmF0ZS4gZHJhdyBmcm9tIHJlbGV2YW50IHJlc2VydmVzCiAgICAgICAgICAgICAgICByYW5kb20gPSB1aW50KGJsb2NrLmJsb2NraGFzaChibG9jay5udW1iZXItMSkpICUgbnVtUmVsZXZhbnRSZXNlcnZlczsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgYmVzdFJlc2VydmUgPSByZXNlcnZlQ2FuZGlkYXRlc1tyYW5kb21dOwogICAgICAgICAgICBiZXN0UmF0ZSA9IHJhdGVzW2Jlc3RSZXNlcnZlXTsKICAgICAgICB9CgogICAgICAgIHJldHVybiAoYmVzdFJlc2VydmUsIGJlc3RSYXRlKTsKICAgIH0KICAgIC8qIHNvbGhpbnQtZW5hYmxlIGNvZGUtY29tcGxleGl0eSAqLwoKICAgIGZ1bmN0aW9uIGdldEV4cGVjdGVkUmF0ZShFUkMyMCBzcmMsIEVSQzIwIGRlc3QsIHVpbnQgc3JjUXR5KQogICAgICAgIHB1YmxpYyB2aWV3CiAgICAgICAgcmV0dXJucyAodWludCBleHBlY3RlZFJhdGUsIHVpbnQgc2xpcHBhZ2VSYXRlKQogICAgewogICAgICAgIHJlcXVpcmUoZXhwZWN0ZWRSYXRlQ29udHJhY3QgIT0gYWRkcmVzcygwKSk7CiAgICAgICAgcmV0dXJuIGV4cGVjdGVkUmF0ZUNvbnRyYWN0LmdldEV4cGVjdGVkUmF0ZShzcmMsIGRlc3QsIHNyY1F0eSk7CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0VXNlckNhcEluV2VpKGFkZHJlc3MgdXNlcikgcHVibGljIHZpZXcgcmV0dXJucyh1aW50KSB7CiAgICAgICAgcmV0dXJuIHdoaXRlTGlzdENvbnRyYWN0LmdldFVzZXJDYXBJbldlaSh1c2VyKTsKICAgIH0KCiAgICBmdW5jdGlvbiBkb1RyYWRlKAogICAgICAgIEVSQzIwIHNyYywKICAgICAgICB1aW50IHNyY0Ftb3VudCwKICAgICAgICBFUkMyMCBkZXN0LAogICAgICAgIGFkZHJlc3MgZGVzdEFkZHJlc3MsCiAgICAgICAgdWludCBtYXhEZXN0QW1vdW50LAogICAgICAgIHVpbnQgbWluQ29udmVyc2lvblJhdGUsCiAgICAgICAgYWRkcmVzcyB3YWxsZXRJZAogICAgKQogICAgICAgIGludGVybmFsCiAgICAgICAgcmV0dXJucyh1aW50KQogICAgewogICAgICAgIHJlcXVpcmUodHguZ2FzcHJpY2UgPD0gbWF4R2FzUHJpY2UpOwogICAgICAgIHJlcXVpcmUodmFsaWRhdGVUcmFkZUlucHV0KHNyYywgc3JjQW1vdW50LCBkZXN0QWRkcmVzcykpOwoKICAgICAgICB1aW50IHJlc2VydmVJbmQ7CiAgICAgICAgdWludCByYXRlOwoKICAgICAgICAocmVzZXJ2ZUluZCwgcmF0ZSkgPSBmaW5kQmVzdFJhdGUoc3JjLCBkZXN0LCBzcmNBbW91bnQpOwogICAgICAgIEt5YmVyUmVzZXJ2ZUludGVyZmFjZSB0aGVSZXNlcnZlID0gcmVzZXJ2ZXNbcmVzZXJ2ZUluZF07CiAgICAgICAgcmVxdWlyZShyYXRlID4gMCk7CiAgICAgICAgcmVxdWlyZShyYXRlIDwgTUFYX1JBVEUpOwogICAgICAgIHJlcXVpcmUocmF0ZSA+PSBtaW5Db252ZXJzaW9uUmF0ZSk7CgogICAgICAgIHVpbnQgYWN0dWFsU3JjQW1vdW50ID0gc3JjQW1vdW50OwogICAgICAgIHVpbnQgYWN0dWFsRGVzdEFtb3VudCA9IGNhbGNEZXN0QW1vdW50KHNyYywgZGVzdCwgYWN0dWFsU3JjQW1vdW50LCByYXRlKTsKICAgICAgICBpZiAoYWN0dWFsRGVzdEFtb3VudCA+IG1heERlc3RBbW91bnQpIHsKICAgICAgICAgICAgYWN0dWFsRGVzdEFtb3VudCA9IG1heERlc3RBbW91bnQ7CiAgICAgICAgICAgIGFjdHVhbFNyY0Ftb3VudCA9IGNhbGNTcmNBbW91bnQoc3JjLCBkZXN0LCBhY3R1YWxEZXN0QW1vdW50LCByYXRlKTsKICAgICAgICAgICAgcmVxdWlyZShhY3R1YWxTcmNBbW91bnQgPD0gc3JjQW1vdW50KTsKICAgICAgICB9CgogICAgICAgIC8vIGRvIHRoZSB0cmFkZQogICAgICAgIC8vIHZlcmlmeSB0cmFkZSBzaXplIGlzIHNtYWxsZXIgdGhhbiB1c2VyIGNhcAogICAgICAgIHVpbnQgZXRoQW1vdW50OwogICAgICAgIGlmIChzcmMgPT0gRVRIX1RPS0VOX0FERFJFU1MpIHsKICAgICAgICAgICAgZXRoQW1vdW50ID0gYWN0dWFsU3JjQW1vdW50OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGV0aEFtb3VudCA9IGFjdHVhbERlc3RBbW91bnQ7CiAgICAgICAgfQoKICAgICAgICByZXF1aXJlKGV0aEFtb3VudCA8PSBnZXRVc2VyQ2FwSW5XZWkobXNnLnNlbmRlcikpOwogICAgICAgIHJlcXVpcmUoZG9SZXNlcnZlVHJhZGUoCiAgICAgICAgICAgICAgICBzcmMsCiAgICAgICAgICAgICAgICBhY3R1YWxTcmNBbW91bnQsCiAgICAgICAgICAgICAgICBkZXN0LAogICAgICAgICAgICAgICAgZGVzdEFkZHJlc3MsCiAgICAgICAgICAgICAgICBhY3R1YWxEZXN0QW1vdW50LAogICAgICAgICAgICAgICAgdGhlUmVzZXJ2ZSwKICAgICAgICAgICAgICAgIHJhdGUsCiAgICAgICAgICAgICAgICB0cnVlKSk7CgogICAgICAgIGlmICgoYWN0dWFsU3JjQW1vdW50IDwgc3JjQW1vdW50KSAmJiAoc3JjID09IEVUSF9UT0tFTl9BRERSRVNTKSkgewogICAgICAgICAgICBtc2cuc2VuZGVyLnRyYW5zZmVyKHNyY0Ftb3VudCAtIGFjdHVhbFNyY0Ftb3VudCk7CiAgICAgICAgfQoKICAgICAgICByZXF1aXJlKGZlZUJ1cm5lckNvbnRyYWN0LmhhbmRsZUZlZXMoZXRoQW1vdW50LCB0aGVSZXNlcnZlLCB3YWxsZXRJZCkpOwoKICAgICAgICBFeGVjdXRlVHJhZGUobXNnLnNlbmRlciwgc3JjLCBkZXN0LCBhY3R1YWxTcmNBbW91bnQsIGFjdHVhbERlc3RBbW91bnQpOwogICAgICAgIHJldHVybiBhY3R1YWxEZXN0QW1vdW50OwogICAgfQoKICAgIC8vLyBAbm90aWNlIHVzZSB0b2tlbiBhZGRyZXNzIEVUSF9UT0tFTl9BRERSRVNTIGZvciBldGhlcgogICAgLy8vIEBkZXYgZG8gb25lIHRyYWRlIHdpdGggYSByZXNlcnZlCiAgICAvLy8gQHBhcmFtIHNyYyBTcmMgdG9rZW4KICAgIC8vLyBAcGFyYW0gYW1vdW50IGFtb3VudCBvZiBzcmMgdG9rZW5zCiAgICAvLy8gQHBhcmFtIGRlc3QgICBEZXN0aW5hdGlvbiB0b2tlbgogICAgLy8vIEBwYXJhbSBkZXN0QWRkcmVzcyBBZGRyZXNzIHRvIHNlbmQgdG9rZW5zIHRvCiAgICAvLy8gQHBhcmFtIHJlc2VydmUgUmVzZXJ2ZSB0byB1c2UKICAgIC8vLyBAcGFyYW0gdmFsaWRhdGUgSWYgdHJ1ZSwgYWRkaXRpb25hbCB2YWxpZGF0aW9ucyBhcmUgYXBwbGljYWJsZQogICAgLy8vIEByZXR1cm4gdHJ1ZSBpZiB0cmFkZSBpcyBzdWNjZXNzZnVsCiAgICBmdW5jdGlvbiBkb1Jlc2VydmVUcmFkZSgKICAgICAgICBFUkMyMCBzcmMsCiAgICAgICAgdWludCBhbW91bnQsCiAgICAgICAgRVJDMjAgZGVzdCwKICAgICAgICBhZGRyZXNzIGRlc3RBZGRyZXNzLAogICAgICAgIHVpbnQgZXhwZWN0ZWREZXN0QW1vdW50LAogICAgICAgIEt5YmVyUmVzZXJ2ZUludGVyZmFjZSByZXNlcnZlLAogICAgICAgIHVpbnQgY29udmVyc2lvblJhdGUsCiAgICAgICAgYm9vbCB2YWxpZGF0ZQogICAgKQogICAgICAgIGludGVybmFsCiAgICAgICAgcmV0dXJucyhib29sKQogICAgewogICAgICAgIHVpbnQgY2FsbFZhbHVlID0gMDsKCiAgICAgICAgaWYgKHNyYyA9PSBFVEhfVE9LRU5fQUREUkVTUykgewogICAgICAgICAgICBjYWxsVmFsdWUgPSBhbW91bnQ7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gdGFrZSBzcmMgdG9rZW5zIHRvIHRoaXMgY29udHJhY3QKICAgICAgICAgICAgc3JjLnRyYW5zZmVyRnJvbShtc2cuc2VuZGVyLCB0aGlzLCBhbW91bnQpOwogICAgICAgIH0KCiAgICAgICAgLy8gcmVzZXJ2ZSBzZW5kcyB0b2tlbnMvZXRoIHRvIG5ldHdvcmsuIG5ldHdvcmsgc2VuZHMgaXQgdG8gZGVzdGluYXRpb24KICAgICAgICByZXF1aXJlKHJlc2VydmUudHJhZGUudmFsdWUoY2FsbFZhbHVlKShzcmMsIGFtb3VudCwgZGVzdCwgdGhpcywgY29udmVyc2lvblJhdGUsIHZhbGlkYXRlKSk7CgogICAgICAgIGlmIChkZXN0ID09IEVUSF9UT0tFTl9BRERSRVNTKSB7CiAgICAgICAgICAgIGRlc3RBZGRyZXNzLnRyYW5zZmVyKGV4cGVjdGVkRGVzdEFtb3VudCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVxdWlyZShkZXN0LnRyYW5zZmVyKGRlc3RBZGRyZXNzLCBleHBlY3RlZERlc3RBbW91bnQpKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIGZ1bmN0aW9uIGNhbGNEZXN0QW1vdW50KEVSQzIwIHNyYywgRVJDMjAgZGVzdCwgdWludCBzcmNBbW91bnQsIHVpbnQgcmF0ZSkgaW50ZXJuYWwgdmlldyByZXR1cm5zKHVpbnQpIHsKICAgICAgICByZXR1cm4gY2FsY0RzdFF0eShzcmNBbW91bnQsIGdldERlY2ltYWxzKHNyYyksIGdldERlY2ltYWxzKGRlc3QpLCByYXRlKTsKICAgIH0KCiAgICBmdW5jdGlvbiBjYWxjU3JjQW1vdW50KEVSQzIwIHNyYywgRVJDMjAgZGVzdCwgdWludCBkZXN0QW1vdW50LCB1aW50IHJhdGUpIGludGVybmFsIHZpZXcgcmV0dXJucyh1aW50KSB7CiAgICAgICAgcmV0dXJuIGNhbGNTcmNRdHkoZGVzdEFtb3VudCwgZ2V0RGVjaW1hbHMoc3JjKSwgZ2V0RGVjaW1hbHMoZGVzdCksIHJhdGUpOwogICAgfQoKICAgIC8vLyBAbm90aWNlIHVzZSB0b2tlbiBhZGRyZXNzIEVUSF9UT0tFTl9BRERSRVNTIGZvciBldGhlcgogICAgLy8vIEBkZXYgY2hlY2tzIHRoYXQgdXNlciBzZW50IGV0aGVyL3Rva2VucyB0byBjb250cmFjdCBiZWZvcmUgdHJhZGUKICAgIC8vLyBAcGFyYW0gc3JjIFNyYyB0b2tlbgogICAgLy8vIEBwYXJhbSBzcmNBbW91bnQgYW1vdW50IG9mIHNyYyB0b2tlbnMKICAgIC8vLyBAcmV0dXJuIHRydWUgaWYgaW5wdXQgaXMgdmFsaWQKICAgIGZ1bmN0aW9uIHZhbGlkYXRlVHJhZGVJbnB1dChFUkMyMCBzcmMsIHVpbnQgc3JjQW1vdW50LCBhZGRyZXNzIGRlc3RBZGRyZXNzKSBpbnRlcm5hbCB2aWV3IHJldHVybnMoYm9vbCkgewogICAgICAgIGlmICgoc3JjQW1vdW50ID49IE1BWF9RVFkpIHx8IChzcmNBbW91bnQgPT0gMCkgfHwgKGRlc3RBZGRyZXNzID09IDApKQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CgogICAgICAgIGlmIChzcmMgPT0gRVRIX1RPS0VOX0FERFJFU1MpIHsKICAgICAgICAgICAgaWYgKG1zZy52YWx1ZSAhPSBzcmNBbW91bnQpCiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKChtc2cudmFsdWUgIT0gMCkgfHwgKHNyYy5hbGxvd2FuY2UobXNnLnNlbmRlciwgdGhpcykgPCBzcmNBbW91bnQpKQogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9Cn0KCmNvbnRyYWN0IEt5YmVyUmVzZXJ2ZSBpcyBLeWJlclJlc2VydmVJbnRlcmZhY2UsIFdpdGhkcmF3YWJsZSwgVXRpbHMgewoKICAgIGFkZHJlc3MgcHVibGljIGt5YmVyTmV0d29yazsKICAgIGJvb2wgcHVibGljIHRyYWRlRW5hYmxlZDsKICAgIENvbnZlcnNpb25SYXRlc0ludGVyZmFjZSBwdWJsaWMgY29udmVyc2lvblJhdGVzQ29udHJhY3Q7CiAgICBTYW5pdHlSYXRlc0ludGVyZmFjZSBwdWJsaWMgc2FuaXR5UmF0ZXNDb250cmFjdDsKICAgIG1hcHBpbmcoYnl0ZXMzMj0+Ym9vbCkgcHVibGljIGFwcHJvdmVkV2l0aGRyYXdBZGRyZXNzZXM7IC8vIHNoYTModG9rZW4sYWRkcmVzcyk9PmJvb2wKCiAgICBmdW5jdGlvbiBLeWJlclJlc2VydmUoYWRkcmVzcyBfa3liZXJOZXR3b3JrLCBDb252ZXJzaW9uUmF0ZXNJbnRlcmZhY2UgX3JhdGVzQ29udHJhY3QsIGFkZHJlc3MgX2FkbWluKSBwdWJsaWMgewogICAgICAgIHJlcXVpcmUoX2FkbWluICE9IGFkZHJlc3MoMCkpOwogICAgICAgIHJlcXVpcmUoX3JhdGVzQ29udHJhY3QgIT0gYWRkcmVzcygwKSk7CiAgICAgICAgcmVxdWlyZShfa3liZXJOZXR3b3JrICE9IGFkZHJlc3MoMCkpOwogICAgICAgIGt5YmVyTmV0d29yayA9IF9reWJlck5ldHdvcms7CiAgICAgICAgY29udmVyc2lvblJhdGVzQ29udHJhY3QgPSBfcmF0ZXNDb250cmFjdDsKICAgICAgICBhZG1pbiA9IF9hZG1pbjsKICAgICAgICB0cmFkZUVuYWJsZWQgPSB0cnVlOwogICAgfQoKICAgIGV2ZW50IERlcG9zaXRUb2tlbihFUkMyMCB0b2tlbiwgdWludCBhbW91bnQpOwoKICAgIGZ1bmN0aW9uKCkgcHVibGljIHBheWFibGUgewogICAgICAgIERlcG9zaXRUb2tlbihFVEhfVE9LRU5fQUREUkVTUywgbXNnLnZhbHVlKTsKICAgIH0KCiAgICBldmVudCBUcmFkZUV4ZWN1dGUoCiAgICAgICAgYWRkcmVzcyBpbmRleGVkIG9yaWdpbiwKICAgICAgICBhZGRyZXNzIHNyYywKICAgICAgICB1aW50IHNyY0Ftb3VudCwKICAgICAgICBhZGRyZXNzIGRlc3RUb2tlbiwKICAgICAgICB1aW50IGRlc3RBbW91bnQsCiAgICAgICAgYWRkcmVzcyBkZXN0QWRkcmVzcwogICAgKTsKCiAgICBmdW5jdGlvbiB0cmFkZSgKICAgICAgICBFUkMyMCBzcmNUb2tlbiwKICAgICAgICB1aW50IHNyY0Ftb3VudCwKICAgICAgICBFUkMyMCBkZXN0VG9rZW4sCiAgICAgICAgYWRkcmVzcyBkZXN0QWRkcmVzcywKICAgICAgICB1aW50IGNvbnZlcnNpb25SYXRlLAogICAgICAgIGJvb2wgdmFsaWRhdGUKICAgICkKICAgICAgICBwdWJsaWMKICAgICAgICBwYXlhYmxlCiAgICAgICAgcmV0dXJucyhib29sKQogICAgewogICAgICAgIHJlcXVpcmUodHJhZGVFbmFibGVkKTsKICAgICAgICByZXF1aXJlKG1zZy5zZW5kZXIgPT0ga3liZXJOZXR3b3JrKTsKCiAgICAgICAgcmVxdWlyZShkb1RyYWRlKHNyY1Rva2VuLCBzcmNBbW91bnQsIGRlc3RUb2tlbiwgZGVzdEFkZHJlc3MsIGNvbnZlcnNpb25SYXRlLCB2YWxpZGF0ZSkpOwoKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICBldmVudCBUcmFkZUVuYWJsZWQoYm9vbCBlbmFibGUpOwoKICAgIGZ1bmN0aW9uIGVuYWJsZVRyYWRlKCkgcHVibGljIG9ubHlBZG1pbiByZXR1cm5zKGJvb2wpIHsKICAgICAgICB0cmFkZUVuYWJsZWQgPSB0cnVlOwogICAgICAgIFRyYWRlRW5hYmxlZCh0cnVlKTsKCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgZnVuY3Rpb24gZGlzYWJsZVRyYWRlKCkgcHVibGljIG9ubHlBbGVydGVyIHJldHVybnMoYm9vbCkgewogICAgICAgIHRyYWRlRW5hYmxlZCA9IGZhbHNlOwogICAgICAgIFRyYWRlRW5hYmxlZChmYWxzZSk7CgogICAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIGV2ZW50IFdpdGhkcmF3QWRkcmVzc0FwcHJvdmVkKEVSQzIwIHRva2VuLCBhZGRyZXNzIGFkZHIsIGJvb2wgYXBwcm92ZSk7CgogICAgZnVuY3Rpb24gYXBwcm92ZVdpdGhkcmF3QWRkcmVzcyhFUkMyMCB0b2tlbiwgYWRkcmVzcyBhZGRyLCBib29sIGFwcHJvdmUpIHB1YmxpYyBvbmx5QWRtaW4gewogICAgICAgIGFwcHJvdmVkV2l0aGRyYXdBZGRyZXNzZXNba2VjY2FrMjU2KHRva2VuLCBhZGRyKV0gPSBhcHByb3ZlOwogICAgICAgIFdpdGhkcmF3QWRkcmVzc0FwcHJvdmVkKHRva2VuLCBhZGRyLCBhcHByb3ZlKTsKCiAgICAgICAgc2V0RGVjaW1hbHModG9rZW4pOwogICAgfQoKICAgIGV2ZW50IFdpdGhkcmF3RnVuZHMoRVJDMjAgdG9rZW4sIHVpbnQgYW1vdW50LCBhZGRyZXNzIGRlc3RpbmF0aW9uKTsKCiAgICBmdW5jdGlvbiB3aXRoZHJhdyhFUkMyMCB0b2tlbiwgdWludCBhbW91bnQsIGFkZHJlc3MgZGVzdGluYXRpb24pIHB1YmxpYyBvbmx5T3BlcmF0b3IgcmV0dXJucyhib29sKSB7CiAgICAgICAgcmVxdWlyZShhcHByb3ZlZFdpdGhkcmF3QWRkcmVzc2VzW2tlY2NhazI1Nih0b2tlbiwgZGVzdGluYXRpb24pXSk7CgogICAgICAgIGlmICh0b2tlbiA9PSBFVEhfVE9LRU5fQUREUkVTUykgewogICAgICAgICAgICBkZXN0aW5hdGlvbi50cmFuc2ZlcihhbW91bnQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlcXVpcmUodG9rZW4udHJhbnNmZXIoZGVzdGluYXRpb24sIGFtb3VudCkpOwogICAgICAgIH0KCiAgICAgICAgV2l0aGRyYXdGdW5kcyh0b2tlbiwgYW1vdW50LCBkZXN0aW5hdGlvbik7CgogICAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIGV2ZW50IFNldENvbnRyYWN0QWRkcmVzc2VzKGFkZHJlc3MgbmV0d29yaywgYWRkcmVzcyByYXRlLCBhZGRyZXNzIHNhbml0eSk7CgogICAgZnVuY3Rpb24gc2V0Q29udHJhY3RzKGFkZHJlc3MgX2t5YmVyTmV0d29yaywgQ29udmVyc2lvblJhdGVzSW50ZXJmYWNlIF9jb252ZXJzaW9uUmF0ZXMsIFNhbml0eVJhdGVzSW50ZXJmYWNlIF9zYW5pdHlSYXRlcykKICAgICAgICBwdWJsaWMKICAgICAgICBvbmx5QWRtaW4KICAgIHsKICAgICAgICByZXF1aXJlKF9reWJlck5ldHdvcmsgIT0gYWRkcmVzcygwKSk7CiAgICAgICAgcmVxdWlyZShfY29udmVyc2lvblJhdGVzICE9IGFkZHJlc3MoMCkpOwoKICAgICAgICBreWJlck5ldHdvcmsgPSBfa3liZXJOZXR3b3JrOwogICAgICAgIGNvbnZlcnNpb25SYXRlc0NvbnRyYWN0ID0gX2NvbnZlcnNpb25SYXRlczsKICAgICAgICBzYW5pdHlSYXRlc0NvbnRyYWN0ID0gX3Nhbml0eVJhdGVzOwoKICAgICAgICBTZXRDb250cmFjdEFkZHJlc3NlcyhreWJlck5ldHdvcmssIGNvbnZlcnNpb25SYXRlc0NvbnRyYWN0LCBzYW5pdHlSYXRlc0NvbnRyYWN0KTsKICAgIH0KCiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAvLy8gc3RhdHVzIGZ1bmN0aW9ucyAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICBmdW5jdGlvbiBnZXRCYWxhbmNlKEVSQzIwIHRva2VuKSBwdWJsaWMgdmlldyByZXR1cm5zKHVpbnQpIHsKICAgICAgICBpZiAodG9rZW4gPT0gRVRIX1RPS0VOX0FERFJFU1MpCiAgICAgICAgICAgIHJldHVybiB0aGlzLmJhbGFuY2U7CiAgICAgICAgZWxzZQogICAgICAgICAgICByZXR1cm4gdG9rZW4uYmFsYW5jZU9mKHRoaXMpOwogICAgfQoKICAgIGZ1bmN0aW9uIGdldERlc3RRdHkoRVJDMjAgc3JjLCBFUkMyMCBkZXN0LCB1aW50IHNyY1F0eSwgdWludCByYXRlKSBwdWJsaWMgdmlldyByZXR1cm5zKHVpbnQpIHsKICAgICAgICB1aW50IGRzdERlY2ltYWxzID0gZ2V0RGVjaW1hbHMoZGVzdCk7CiAgICAgICAgdWludCBzcmNEZWNpbWFscyA9IGdldERlY2ltYWxzKHNyYyk7CgogICAgICAgIHJldHVybiBjYWxjRHN0UXR5KHNyY1F0eSwgc3JjRGVjaW1hbHMsIGRzdERlY2ltYWxzLCByYXRlKTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRTcmNRdHkoRVJDMjAgc3JjLCBFUkMyMCBkZXN0LCB1aW50IGRzdFF0eSwgdWludCByYXRlKSBwdWJsaWMgdmlldyByZXR1cm5zKHVpbnQpIHsKICAgICAgICB1aW50IGRzdERlY2ltYWxzID0gZ2V0RGVjaW1hbHMoZGVzdCk7CiAgICAgICAgdWludCBzcmNEZWNpbWFscyA9IGdldERlY2ltYWxzKHNyYyk7CgogICAgICAgIHJldHVybiBjYWxjU3JjUXR5KGRzdFF0eSwgc3JjRGVjaW1hbHMsIGRzdERlY2ltYWxzLCByYXRlKTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRDb252ZXJzaW9uUmF0ZShFUkMyMCBzcmMsIEVSQzIwIGRlc3QsIHVpbnQgc3JjUXR5LCB1aW50IGJsb2NrTnVtYmVyKSBwdWJsaWMgdmlldyByZXR1cm5zKHVpbnQpIHsKICAgICAgICBFUkMyMCB0b2tlbjsKICAgICAgICBib29sICBidXk7CgogICAgICAgIGlmICghdHJhZGVFbmFibGVkKSByZXR1cm4gMDsKCiAgICAgICAgaWYgKEVUSF9UT0tFTl9BRERSRVNTID09IHNyYykgewogICAgICAgICAgICBidXkgPSB0cnVlOwogICAgICAgICAgICB0b2tlbiA9IGRlc3Q7CiAgICAgICAgfSBlbHNlIGlmIChFVEhfVE9LRU5fQUREUkVTUyA9PSBkZXN0KSB7CiAgICAgICAgICAgIGJ1eSA9IGZhbHNlOwogICAgICAgICAgICB0b2tlbiA9IHNyYzsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gMDsgLy8gcGFpciBpcyBub3QgbGlzdGVkCiAgICAgICAgfQoKICAgICAgICB1aW50IHJhdGUgPSBjb252ZXJzaW9uUmF0ZXNDb250cmFjdC5nZXRSYXRlKHRva2VuLCBibG9ja051bWJlciwgYnV5LCBzcmNRdHkpOwogICAgICAgIHVpbnQgZGVzdFF0eSA9IGdldERlc3RRdHkoc3JjLCBkZXN0LCBzcmNRdHksIHJhdGUpOwoKICAgICAgICBpZiAoZ2V0QmFsYW5jZShkZXN0KSA8IGRlc3RRdHkpIHJldHVybiAwOwoKICAgICAgICBpZiAoc2FuaXR5UmF0ZXNDb250cmFjdCAhPSBhZGRyZXNzKDApKSB7CiAgICAgICAgICAgIHVpbnQgc2FuaXR5UmF0ZSA9IHNhbml0eVJhdGVzQ29udHJhY3QuZ2V0U2FuaXR5UmF0ZShzcmMsIGRlc3QpOwogICAgICAgICAgICBpZiAocmF0ZSA+IHNhbml0eVJhdGUpIHJldHVybiAwOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHJhdGU7CiAgICB9CgogICAgLy8vIEBkZXYgZG8gYSB0cmFkZQogICAgLy8vIEBwYXJhbSBzcmNUb2tlbiBTcmMgdG9rZW4KICAgIC8vLyBAcGFyYW0gc3JjQW1vdW50IEFtb3VudCBvZiBzcmMgdG9rZW4KICAgIC8vLyBAcGFyYW0gZGVzdFRva2VuIERlc3RpbmF0aW9uIHRva2VuCiAgICAvLy8gQHBhcmFtIGRlc3RBZGRyZXNzIERlc3RpbmF0aW9uIGFkZHJlc3MgdG8gc2VuZCB0b2tlbnMgdG8KICAgIC8vLyBAcGFyYW0gdmFsaWRhdGUgSWYgdHJ1ZSwgYWRkaXRpb25hbCB2YWxpZGF0aW9ucyBhcmUgYXBwbGljYWJsZQogICAgLy8vIEByZXR1cm4gdHJ1ZSBpZmYgdHJhZGUgaXMgc3VjY2Vzc2Z1bAogICAgZnVuY3Rpb24gZG9UcmFkZSgKICAgICAgICBFUkMyMCBzcmNUb2tlbiwKICAgICAgICB1aW50IHNyY0Ftb3VudCwKICAgICAgICBFUkMyMCBkZXN0VG9rZW4sCiAgICAgICAgYWRkcmVzcyBkZXN0QWRkcmVzcywKICAgICAgICB1aW50IGNvbnZlcnNpb25SYXRlLAogICAgICAgIGJvb2wgdmFsaWRhdGUKICAgICkKICAgICAgICBpbnRlcm5hbAogICAgICAgIHJldHVybnMoYm9vbCkKICAgIHsKICAgICAgICAvLyBjYW4gc2tpcCB2YWxpZGF0aW9uIGlmIGRvbmUgYXQga3liZXIgbmV0d29yayBsZXZlbAogICAgICAgIGlmICh2YWxpZGF0ZSkgewogICAgICAgICAgICByZXF1aXJlKGNvbnZlcnNpb25SYXRlID4gMCk7CiAgICAgICAgICAgIGlmIChzcmNUb2tlbiA9PSBFVEhfVE9LRU5fQUREUkVTUykKICAgICAgICAgICAgICAgIHJlcXVpcmUobXNnLnZhbHVlID09IHNyY0Ftb3VudCk7CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHJlcXVpcmUobXNnLnZhbHVlID09IDApOwogICAgICAgIH0KCiAgICAgICAgdWludCBkZXN0QW1vdW50ID0gZ2V0RGVzdFF0eShzcmNUb2tlbiwgZGVzdFRva2VuLCBzcmNBbW91bnQsIGNvbnZlcnNpb25SYXRlKTsKICAgICAgICAvLyBzYW5pdHkgY2hlY2sKICAgICAgICByZXF1aXJlKGRlc3RBbW91bnQgPiAwKTsKCiAgICAgICAgLy8gYWRkIHRvIGltYmFsYW5jZQogICAgICAgIEVSQzIwIHRva2VuOwogICAgICAgIGludCBidXk7CiAgICAgICAgaWYgKHNyY1Rva2VuID09IEVUSF9UT0tFTl9BRERSRVNTKSB7CiAgICAgICAgICAgIGJ1eSA9IGludChkZXN0QW1vdW50KTsKICAgICAgICAgICAgdG9rZW4gPSBkZXN0VG9rZW47CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgYnV5ID0gLTEgKiBpbnQoc3JjQW1vdW50KTsKICAgICAgICAgICAgdG9rZW4gPSBzcmNUb2tlbjsKICAgICAgICB9CgogICAgICAgIGNvbnZlcnNpb25SYXRlc0NvbnRyYWN0LnJlY29yZEltYmFsYW5jZSgKICAgICAgICAgICAgdG9rZW4sCiAgICAgICAgICAgIGJ1eSwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgYmxvY2subnVtYmVyCiAgICAgICAgKTsKCiAgICAgICAgLy8gY29sbGVjdCBzcmMgdG9rZW5zCiAgICAgICAgaWYgKHNyY1Rva2VuICE9IEVUSF9UT0tFTl9BRERSRVNTKSB7CiAgICAgICAgICAgIHJlcXVpcmUoc3JjVG9rZW4udHJhbnNmZXJGcm9tKG1zZy5zZW5kZXIsIHRoaXMsIHNyY0Ftb3VudCkpOwogICAgICAgIH0KCiAgICAgICAgLy8gc2VuZCBkZXN0IHRva2VucwogICAgICAgIGlmIChkZXN0VG9rZW4gPT0gRVRIX1RPS0VOX0FERFJFU1MpIHsKICAgICAgICAgICAgZGVzdEFkZHJlc3MudHJhbnNmZXIoZGVzdEFtb3VudCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVxdWlyZShkZXN0VG9rZW4udHJhbnNmZXIoZGVzdEFkZHJlc3MsIGRlc3RBbW91bnQpKTsKICAgICAgICB9CgogICAgICAgIFRyYWRlRXhlY3V0ZShtc2cuc2VuZGVyLCBzcmNUb2tlbiwgc3JjQW1vdW50LCBkZXN0VG9rZW4sIGRlc3RBbW91bnQsIGRlc3RBZGRyZXNzKTsKCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9Cn0KCmNvbnRyYWN0IFZvbHVtZUltYmFsYW5jZVJlY29yZGVyIGlzIFdpdGhkcmF3YWJsZSB7CgogICAgdWludCBjb25zdGFudCBpbnRlcm5hbCBTTElESU5HX1dJTkRPV19TSVpFID0gNTsKICAgIHVpbnQgY29uc3RhbnQgaW50ZXJuYWwgUE9XXzJfNjQgPSAyICoqIDY0OwoKICAgIHN0cnVjdCBUb2tlbkNvbnRyb2xJbmZvIHsKICAgICAgICB1aW50IG1pbmltYWxSZWNvcmRSZXNvbHV0aW9uOyAvLyBjYW4gYmUgcm91Z2hseSAxIGNlbnQKICAgICAgICB1aW50IG1heFBlckJsb2NrSW1iYWxhbmNlOyAvLyBpbiB0d2VpIHJlc29sdXRpb24KICAgICAgICB1aW50IG1heFRvdGFsSW1iYWxhbmNlOyAvLyBtYXggdG90YWwgaW1iYWxhbmNlIChiZXR3ZWVuIHJhdGUgdXBkYXRlcykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGJlZm9yZSBoYWx0aW5nIHRyYWRlCiAgICB9CgogICAgbWFwcGluZyhhZGRyZXNzID0+IFRva2VuQ29udHJvbEluZm8pIGludGVybmFsIHRva2VuQ29udHJvbEluZm87CgogICAgc3RydWN0IFRva2VuSW1iYWxhbmNlRGF0YSB7CiAgICAgICAgaW50ICBsYXN0QmxvY2tCdXlVbml0c0ltYmFsYW5jZTsKICAgICAgICB1aW50IGxhc3RCbG9jazsKCiAgICAgICAgaW50ICB0b3RhbEJ1eVVuaXRzSW1iYWxhbmNlOwogICAgICAgIHVpbnQgbGFzdFJhdGVVcGRhdGVCbG9jazsKICAgIH0KCiAgICBtYXBwaW5nKGFkZHJlc3MgPT4gbWFwcGluZyh1aW50PT51aW50KSkgcHVibGljIHRva2VuSW1iYWxhbmNlRGF0YTsKCiAgICBmdW5jdGlvbiBWb2x1bWVJbWJhbGFuY2VSZWNvcmRlcihhZGRyZXNzIF9hZG1pbikgcHVibGljIHsKICAgICAgICByZXF1aXJlKF9hZG1pbiAhPSBhZGRyZXNzKDApKTsKICAgICAgICBhZG1pbiA9IF9hZG1pbjsKICAgIH0KCiAgICBmdW5jdGlvbiBzZXRUb2tlbkNvbnRyb2xJbmZvKAogICAgICAgIEVSQzIwIHRva2VuLAogICAgICAgIHVpbnQgbWluaW1hbFJlY29yZFJlc29sdXRpb24sCiAgICAgICAgdWludCBtYXhQZXJCbG9ja0ltYmFsYW5jZSwKICAgICAgICB1aW50IG1heFRvdGFsSW1iYWxhbmNlCiAgICApCiAgICAgICAgcHVibGljCiAgICAgICAgb25seUFkbWluCiAgICB7CiAgICAgICAgdG9rZW5Db250cm9sSW5mb1t0b2tlbl0gPQogICAgICAgICAgICBUb2tlbkNvbnRyb2xJbmZvKAogICAgICAgICAgICAgICAgbWluaW1hbFJlY29yZFJlc29sdXRpb24sCiAgICAgICAgICAgICAgICBtYXhQZXJCbG9ja0ltYmFsYW5jZSwKICAgICAgICAgICAgICAgIG1heFRvdGFsSW1iYWxhbmNlCiAgICAgICAgICAgICk7CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0VG9rZW5Db250cm9sSW5mbyhFUkMyMCB0b2tlbikgcHVibGljIHZpZXcgcmV0dXJucyh1aW50LCB1aW50LCB1aW50KSB7CiAgICAgICAgcmV0dXJuICh0b2tlbkNvbnRyb2xJbmZvW3Rva2VuXS5taW5pbWFsUmVjb3JkUmVzb2x1dGlvbiwKICAgICAgICAgICAgICAgIHRva2VuQ29udHJvbEluZm9bdG9rZW5dLm1heFBlckJsb2NrSW1iYWxhbmNlLAogICAgICAgICAgICAgICAgdG9rZW5Db250cm9sSW5mb1t0b2tlbl0ubWF4VG90YWxJbWJhbGFuY2UpOwogICAgfQoKICAgIGZ1bmN0aW9uIGFkZEltYmFsYW5jZSgKICAgICAgICBFUkMyMCB0b2tlbiwKICAgICAgICBpbnQgYnV5QW1vdW50LAogICAgICAgIHVpbnQgcmF0ZVVwZGF0ZUJsb2NrLAogICAgICAgIHVpbnQgY3VycmVudEJsb2NrCiAgICApCiAgICAgICAgaW50ZXJuYWwKICAgIHsKICAgICAgICB1aW50IGN1cnJlbnRCbG9ja0luZGV4ID0gY3VycmVudEJsb2NrICUgU0xJRElOR19XSU5ET1dfU0laRTsKICAgICAgICBpbnQgcmVjb3JkZWRCdXlBbW91bnQgPSBpbnQoYnV5QW1vdW50IC8gaW50KHRva2VuQ29udHJvbEluZm9bdG9rZW5dLm1pbmltYWxSZWNvcmRSZXNvbHV0aW9uKSk7CgogICAgICAgIGludCBwcmV2SW1iYWxhbmNlID0gMDsKCiAgICAgICAgVG9rZW5JbWJhbGFuY2VEYXRhIG1lbW9yeSBjdXJyZW50QmxvY2tEYXRhID0KICAgICAgICAgICAgZGVjb2RlVG9rZW5JbWJhbGFuY2VEYXRhKHRva2VuSW1iYWxhbmNlRGF0YVt0b2tlbl1bY3VycmVudEJsb2NrSW5kZXhdKTsKCiAgICAgICAgLy8gZmlyc3Qgc2NlbmFyaW8gLSB0aGlzIGlzIG5vdCB0aGUgZmlyc3QgdHggaW4gdGhlIGN1cnJlbnQgYmxvY2sKICAgICAgICBpZiAoY3VycmVudEJsb2NrRGF0YS5sYXN0QmxvY2sgPT0gY3VycmVudEJsb2NrKSB7CiAgICAgICAgICAgIGlmICh1aW50KGN1cnJlbnRCbG9ja0RhdGEubGFzdFJhdGVVcGRhdGVCbG9jaykgPT0gcmF0ZVVwZGF0ZUJsb2NrKSB7CiAgICAgICAgICAgICAgICAvLyBqdXN0IGluY3JlYXNlIGltYmFsYW5jZQogICAgICAgICAgICAgICAgY3VycmVudEJsb2NrRGF0YS5sYXN0QmxvY2tCdXlVbml0c0ltYmFsYW5jZSArPSByZWNvcmRlZEJ1eUFtb3VudDsKICAgICAgICAgICAgICAgIGN1cnJlbnRCbG9ja0RhdGEudG90YWxCdXlVbml0c0ltYmFsYW5jZSArPSByZWNvcmRlZEJ1eUFtb3VudDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIGltYmFsYW5jZSB3YXMgY2hhbmdlZCBpbiB0aGUgbWlkZGxlIG9mIHRoZSBibG9jawogICAgICAgICAgICAgICAgcHJldkltYmFsYW5jZSA9IGdldEltYmFsYW5jZUluUmFuZ2UodG9rZW4sIHJhdGVVcGRhdGVCbG9jaywgY3VycmVudEJsb2NrKTsKICAgICAgICAgICAgICAgIGN1cnJlbnRCbG9ja0RhdGEudG90YWxCdXlVbml0c0ltYmFsYW5jZSA9IGludChwcmV2SW1iYWxhbmNlKSArIHJlY29yZGVkQnV5QW1vdW50OwogICAgICAgICAgICAgICAgY3VycmVudEJsb2NrRGF0YS5sYXN0QmxvY2tCdXlVbml0c0ltYmFsYW5jZSArPSByZWNvcmRlZEJ1eUFtb3VudDsKICAgICAgICAgICAgICAgIGN1cnJlbnRCbG9ja0RhdGEubGFzdFJhdGVVcGRhdGVCbG9jayA9IHVpbnQocmF0ZVVwZGF0ZUJsb2NrKTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIGZpcnN0IHR4IGluIHRoZSBjdXJyZW50IGJsb2NrCiAgICAgICAgICAgIGludCBjdXJyZW50QmxvY2tJbWJhbGFuY2U7CiAgICAgICAgICAgIChwcmV2SW1iYWxhbmNlLCBjdXJyZW50QmxvY2tJbWJhbGFuY2UpID0gZ2V0SW1iYWxhbmNlU2luY2VSYXRlVXBkYXRlKHRva2VuLCByYXRlVXBkYXRlQmxvY2ssIGN1cnJlbnRCbG9jayk7CgogICAgICAgICAgICBjdXJyZW50QmxvY2tEYXRhLmxhc3RCbG9ja0J1eVVuaXRzSW1iYWxhbmNlID0gcmVjb3JkZWRCdXlBbW91bnQ7CiAgICAgICAgICAgIGN1cnJlbnRCbG9ja0RhdGEubGFzdEJsb2NrID0gdWludChjdXJyZW50QmxvY2spOwogICAgICAgICAgICBjdXJyZW50QmxvY2tEYXRhLmxhc3RSYXRlVXBkYXRlQmxvY2sgPSB1aW50KHJhdGVVcGRhdGVCbG9jayk7CiAgICAgICAgICAgIGN1cnJlbnRCbG9ja0RhdGEudG90YWxCdXlVbml0c0ltYmFsYW5jZSA9IGludChwcmV2SW1iYWxhbmNlKSArIHJlY29yZGVkQnV5QW1vdW50OwogICAgICAgIH0KCiAgICAgICAgdG9rZW5JbWJhbGFuY2VEYXRhW3Rva2VuXVtjdXJyZW50QmxvY2tJbmRleF0gPSBlbmNvZGVUb2tlbkltYmFsYW5jZURhdGEoY3VycmVudEJsb2NrRGF0YSk7CiAgICB9CgogICAgZnVuY3Rpb24gc2V0R2FyYmFnZVRvVm9sdW1lUmVjb3JkZXIoRVJDMjAgdG9rZW4pIGludGVybmFsIHsKICAgICAgICBmb3IgKHVpbnQgaSA9IDA7IGkgPCBTTElESU5HX1dJTkRPV19TSVpFOyBpKyspIHsKICAgICAgICAgICAgdG9rZW5JbWJhbGFuY2VEYXRhW3Rva2VuXVtpXSA9IDB4MTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0SW1iYWxhbmNlSW5SYW5nZShFUkMyMCB0b2tlbiwgdWludCBzdGFydEJsb2NrLCB1aW50IGVuZEJsb2NrKSBpbnRlcm5hbCB2aWV3IHJldHVybnMoaW50IGJ1eUltYmFsYW5jZSkgewogICAgICAgIC8vIGNoZWNrIHRoZSBpbWJhbGFuY2UgaW4gdGhlIHNsaWRpbmcgd2luZG93CiAgICAgICAgcmVxdWlyZShzdGFydEJsb2NrIDw9IGVuZEJsb2NrKTsKCiAgICAgICAgYnV5SW1iYWxhbmNlID0gMDsKCiAgICAgICAgZm9yICh1aW50IHdpbmRvd0luZCA9IDA7IHdpbmRvd0luZCA8IFNMSURJTkdfV0lORE9XX1NJWkU7IHdpbmRvd0luZCsrKSB7CiAgICAgICAgICAgIFRva2VuSW1iYWxhbmNlRGF0YSBtZW1vcnkgcGVyQmxvY2tEYXRhID0gZGVjb2RlVG9rZW5JbWJhbGFuY2VEYXRhKHRva2VuSW1iYWxhbmNlRGF0YVt0b2tlbl1bd2luZG93SW5kXSk7CgogICAgICAgICAgICBpZiAocGVyQmxvY2tEYXRhLmxhc3RCbG9jayA8PSBlbmRCbG9jayAmJiBwZXJCbG9ja0RhdGEubGFzdEJsb2NrID49IHN0YXJ0QmxvY2spIHsKICAgICAgICAgICAgICAgIGJ1eUltYmFsYW5jZSArPSBpbnQocGVyQmxvY2tEYXRhLmxhc3RCbG9ja0J1eVVuaXRzSW1iYWxhbmNlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBnZXRJbWJhbGFuY2VTaW5jZVJhdGVVcGRhdGUoRVJDMjAgdG9rZW4sIHVpbnQgcmF0ZVVwZGF0ZUJsb2NrLCB1aW50IGN1cnJlbnRCbG9jaykKICAgICAgICBpbnRlcm5hbCB2aWV3CiAgICAgICAgcmV0dXJucyhpbnQgYnV5SW1iYWxhbmNlLCBpbnQgY3VycmVudEJsb2NrSW1iYWxhbmNlKQogICAgewogICAgICAgIGJ1eUltYmFsYW5jZSA9IDA7CiAgICAgICAgY3VycmVudEJsb2NrSW1iYWxhbmNlID0gMDsKICAgICAgICB1aW50IGxhdGVzdEJsb2NrID0gMDsKICAgICAgICBpbnQgaW1iYWxhbmNlSW5SYW5nZSA9IDA7CiAgICAgICAgdWludCBzdGFydEJsb2NrID0gcmF0ZVVwZGF0ZUJsb2NrOwogICAgICAgIHVpbnQgZW5kQmxvY2sgPSBjdXJyZW50QmxvY2s7CgogICAgICAgIGZvciAodWludCB3aW5kb3dJbmQgPSAwOyB3aW5kb3dJbmQgPCBTTElESU5HX1dJTkRPV19TSVpFOyB3aW5kb3dJbmQrKykgewogICAgICAgICAgICBUb2tlbkltYmFsYW5jZURhdGEgbWVtb3J5IHBlckJsb2NrRGF0YSA9IGRlY29kZVRva2VuSW1iYWxhbmNlRGF0YSh0b2tlbkltYmFsYW5jZURhdGFbdG9rZW5dW3dpbmRvd0luZF0pOwoKICAgICAgICAgICAgaWYgKHBlckJsb2NrRGF0YS5sYXN0QmxvY2sgPD0gZW5kQmxvY2sgJiYgcGVyQmxvY2tEYXRhLmxhc3RCbG9jayA+PSBzdGFydEJsb2NrKSB7CiAgICAgICAgICAgICAgICBpbWJhbGFuY2VJblJhbmdlICs9IHBlckJsb2NrRGF0YS5sYXN0QmxvY2tCdXlVbml0c0ltYmFsYW5jZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHBlckJsb2NrRGF0YS5sYXN0UmF0ZVVwZGF0ZUJsb2NrICE9IHJhdGVVcGRhdGVCbG9jaykgY29udGludWU7CiAgICAgICAgICAgIGlmIChwZXJCbG9ja0RhdGEubGFzdEJsb2NrIDwgbGF0ZXN0QmxvY2spIGNvbnRpbnVlOwoKICAgICAgICAgICAgbGF0ZXN0QmxvY2sgPSBwZXJCbG9ja0RhdGEubGFzdEJsb2NrOwogICAgICAgICAgICBidXlJbWJhbGFuY2UgPSBwZXJCbG9ja0RhdGEudG90YWxCdXlVbml0c0ltYmFsYW5jZTsKICAgICAgICAgICAgaWYgKHVpbnQocGVyQmxvY2tEYXRhLmxhc3RCbG9jaykgPT0gY3VycmVudEJsb2NrKSB7CiAgICAgICAgICAgICAgICBjdXJyZW50QmxvY2tJbWJhbGFuY2UgPSBwZXJCbG9ja0RhdGEubGFzdEJsb2NrQnV5VW5pdHNJbWJhbGFuY2U7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChidXlJbWJhbGFuY2UgPT0gMCkgewogICAgICAgICAgICBidXlJbWJhbGFuY2UgPSBpbWJhbGFuY2VJblJhbmdlOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBnZXRJbWJhbGFuY2UoRVJDMjAgdG9rZW4sIHVpbnQgcmF0ZVVwZGF0ZUJsb2NrLCB1aW50IGN1cnJlbnRCbG9jaykKICAgICAgICBpbnRlcm5hbCB2aWV3CiAgICAgICAgcmV0dXJucyhpbnQgdG90YWxJbWJhbGFuY2UsIGludCBjdXJyZW50QmxvY2tJbWJhbGFuY2UpCiAgICB7CgogICAgICAgIGludCByZXNvbHV0aW9uID0gaW50KHRva2VuQ29udHJvbEluZm9bdG9rZW5dLm1pbmltYWxSZWNvcmRSZXNvbHV0aW9uKTsKCiAgICAgICAgKHRvdGFsSW1iYWxhbmNlLCBjdXJyZW50QmxvY2tJbWJhbGFuY2UpID0KICAgICAgICAgICAgZ2V0SW1iYWxhbmNlU2luY2VSYXRlVXBkYXRlKAogICAgICAgICAgICAgICAgdG9rZW4sCiAgICAgICAgICAgICAgICByYXRlVXBkYXRlQmxvY2ssCiAgICAgICAgICAgICAgICBjdXJyZW50QmxvY2spOwoKICAgICAgICB0b3RhbEltYmFsYW5jZSAqPSByZXNvbHV0aW9uOwogICAgICAgIGN1cnJlbnRCbG9ja0ltYmFsYW5jZSAqPSByZXNvbHV0aW9uOwogICAgfQoKICAgIGZ1bmN0aW9uIGdldE1heFBlckJsb2NrSW1iYWxhbmNlKEVSQzIwIHRva2VuKSBpbnRlcm5hbCB2aWV3IHJldHVybnModWludCkgewogICAgICAgIHJldHVybiB0b2tlbkNvbnRyb2xJbmZvW3Rva2VuXS5tYXhQZXJCbG9ja0ltYmFsYW5jZTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRNYXhUb3RhbEltYmFsYW5jZShFUkMyMCB0b2tlbikgaW50ZXJuYWwgdmlldyByZXR1cm5zKHVpbnQpIHsKICAgICAgICByZXR1cm4gdG9rZW5Db250cm9sSW5mb1t0b2tlbl0ubWF4VG90YWxJbWJhbGFuY2U7CiAgICB9CgogICAgZnVuY3Rpb24gZW5jb2RlVG9rZW5JbWJhbGFuY2VEYXRhKFRva2VuSW1iYWxhbmNlRGF0YSBkYXRhKSBpbnRlcm5hbCBwdXJlIHJldHVybnModWludCkgewogICAgICAgIC8vIGNoZWNrIGZvciBvdmVyZmxvd3MKICAgICAgICByZXF1aXJlKGRhdGEubGFzdEJsb2NrQnV5VW5pdHNJbWJhbGFuY2UgPCBpbnQoUE9XXzJfNjQgLyAyKSk7CiAgICAgICAgcmVxdWlyZShkYXRhLmxhc3RCbG9ja0J1eVVuaXRzSW1iYWxhbmNlID4gaW50KC0xICogaW50KFBPV18yXzY0KSAvIDIpKTsKICAgICAgICByZXF1aXJlKGRhdGEubGFzdEJsb2NrIDwgUE9XXzJfNjQpOwogICAgICAgIHJlcXVpcmUoZGF0YS50b3RhbEJ1eVVuaXRzSW1iYWxhbmNlIDwgaW50KFBPV18yXzY0IC8gMikpOwogICAgICAgIHJlcXVpcmUoZGF0YS50b3RhbEJ1eVVuaXRzSW1iYWxhbmNlID4gaW50KC0xICogaW50KFBPV18yXzY0KSAvIDIpKTsKICAgICAgICByZXF1aXJlKGRhdGEubGFzdFJhdGVVcGRhdGVCbG9jayA8IFBPV18yXzY0KTsKCiAgICAgICAgLy8gZG8gZW5jb2RpbmcKICAgICAgICB1aW50IHJlc3VsdCA9IHVpbnQoZGF0YS5sYXN0QmxvY2tCdXlVbml0c0ltYmFsYW5jZSkgJiAoUE9XXzJfNjQgLSAxKTsKICAgICAgICByZXN1bHQgfD0gZGF0YS5sYXN0QmxvY2sgKiBQT1dfMl82NDsKICAgICAgICByZXN1bHQgfD0gKHVpbnQoZGF0YS50b3RhbEJ1eVVuaXRzSW1iYWxhbmNlKSAmIChQT1dfMl82NCAtIDEpKSAqIFBPV18yXzY0ICogUE9XXzJfNjQ7CiAgICAgICAgcmVzdWx0IHw9IGRhdGEubGFzdFJhdGVVcGRhdGVCbG9jayAqIFBPV18yXzY0ICogUE9XXzJfNjQgKiBQT1dfMl82NDsKCiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICBmdW5jdGlvbiBkZWNvZGVUb2tlbkltYmFsYW5jZURhdGEodWludCBpbnB1dCkgaW50ZXJuYWwgcHVyZSByZXR1cm5zKFRva2VuSW1iYWxhbmNlRGF0YSkgewogICAgICAgIFRva2VuSW1iYWxhbmNlRGF0YSBtZW1vcnkgZGF0YTsKCiAgICAgICAgZGF0YS5sYXN0QmxvY2tCdXlVbml0c0ltYmFsYW5jZSA9IGludChpbnQ2NChpbnB1dCAmIChQT1dfMl82NCAtIDEpKSk7CiAgICAgICAgZGF0YS5sYXN0QmxvY2sgPSB1aW50KHVpbnQ2NCgoaW5wdXQgLyBQT1dfMl82NCkgJiAoUE9XXzJfNjQgLSAxKSkpOwogICAgICAgIGRhdGEudG90YWxCdXlVbml0c0ltYmFsYW5jZSA9IGludChpbnQ2NCgoaW5wdXQgLyAoUE9XXzJfNjQgKiBQT1dfMl82NCkpICYgKFBPV18yXzY0IC0gMSkpKTsKICAgICAgICBkYXRhLmxhc3RSYXRlVXBkYXRlQmxvY2sgPSB1aW50KHVpbnQ2NCgoaW5wdXQgLyAoUE9XXzJfNjQgKiBQT1dfMl82NCAqIFBPV18yXzY0KSkpKTsKCiAgICAgICAgcmV0dXJuIGRhdGE7CiAgICB9Cn0KCmNvbnRyYWN0IENvbnZlcnNpb25SYXRlcyBpcyBDb252ZXJzaW9uUmF0ZXNJbnRlcmZhY2UsIFZvbHVtZUltYmFsYW5jZVJlY29yZGVyLCBVdGlscyB7CgogICAgLy8gYnBzIC0gYmFzaWMgcmF0ZSBzdGVwcy4gb25lIHN0ZXAgaXMgMSAvIDEwMDAwIG9mIHRoZSByYXRlLgogICAgc3RydWN0IFN0ZXBGdW5jdGlvbiB7CiAgICAgICAgaW50W10geDsgLy8gcXVhbnRpdHkgZm9yIGVhY2ggc3RlcC4gUXVhbnRpdHkgb2YgZWFjaCBzdGVwIGluY2x1ZGVzIHByZXZpb3VzIHN0ZXBzLgogICAgICAgIGludFtdIHk7IC8vIHJhdGUgY2hhbmdlIHBlciBxdWFudGl0eSBzdGVwICBpbiBicHMuCiAgICB9CgogICAgc3RydWN0IFRva2VuRGF0YSB7CiAgICAgICAgYm9vbCBsaXN0ZWQ7ICAvLyB3YXMgYWRkZWQgdG8gcmVzZXJ2ZQogICAgICAgIGJvb2wgZW5hYmxlZDsgLy8gd2hldGhlciB0cmFkZSBpcyBlbmFibGVkCgogICAgICAgIC8vIHBvc2l0aW9uIGluIHRoZSBjb21wYWN0IGRhdGEKICAgICAgICB1aW50IGNvbXBhY3REYXRhQXJyYXlJbmRleDsKICAgICAgICB1aW50IGNvbXBhY3REYXRhRmllbGRJbmRleDsKCiAgICAgICAgLy8gcmF0ZSBkYXRhLiBiYXNlIGFuZCBjaGFuZ2VzIGFjY29yZGluZyB0byBxdWFudGl0eSBhbmQgcmVzZXJ2ZSBiYWxhbmNlLgogICAgICAgIC8vIGdlbmVyYWxseSBzcGVha2luZy4gU2VsbCByYXRlIGlzIDEgLyBidXkgcmF0ZSBpLmUuIHRoZSBidXkgaW4gdGhlIG90aGVyIGRpcmVjdGlvbi4KICAgICAgICB1aW50IGJhc2VCdXlSYXRlOyAgLy8gaW4gUFJFQ0lTSU9OIHVuaXRzLiBzZWUgS3liZXJDb25zdGFudHMKICAgICAgICB1aW50IGJhc2VTZWxsUmF0ZTsgLy8gUFJFQ0lTSU9OIHVuaXRzLiB3aXRob3V0IChzZWxsIC8gYnV5KSBzcHJlYWQgaXQgaXMgMSAvIGJhc2VCdXlSYXRlCiAgICAgICAgU3RlcEZ1bmN0aW9uIGJ1eVJhdGVRdHlTdGVwRnVuY3Rpb247IC8vIGluIGJwcy4gaGlnaGVyIHF1YW50aXR5IC0gYmlnZ2VyIHRoZSByYXRlLgogICAgICAgIFN0ZXBGdW5jdGlvbiBzZWxsUmF0ZVF0eVN0ZXBGdW5jdGlvbjsvLyBpbiBicHMuIGhpZ2hlciB0aGUgcXVhCiAgICAgICAgU3RlcEZ1bmN0aW9uIGJ1eVJhdGVJbWJhbGFuY2VTdGVwRnVuY3Rpb247IC8vIGluIEJQUy4gaGlnaGVyIHJlc2VydmUgaW1iYWxhbmNlIC0gYmlnZ2VyIHRoZSByYXRlLgogICAgICAgIFN0ZXBGdW5jdGlvbiBzZWxsUmF0ZUltYmFsYW5jZVN0ZXBGdW5jdGlvbjsKICAgIH0KCiAgICAvKgogICAgdGhpcyBpcyB0aGUgZGF0YSBmb3IgdG9rZW5SYXRlc0NvbXBhY3REYXRhCiAgICBidXQgc29saWRpdHkgY29tcGlsZXIgb3B0aW1pemVyIGlzIHN1Yi1vcHRpbWFsLCBhbmQgY2Fubm90IHdyaXRlIHRoaXMgc3RydWN0dXJlIGluIGEgc2luZ2xlIHN0b3JhZ2Ugd3JpdGUKICAgIHNvIHdlIHJlcHJlc2VudCBpdCBhcyBieXRlczMyIGFuZCBkbyB0aGUgYnl0ZSB0cmlja3Mgb3Vyc2VsdmVzLgogICAgc3RydWN0IFRva2VuUmF0ZXNDb21wYWN0RGF0YSB7CiAgICAgICAgYnl0ZXMxNCBidXk7ICAvLyBjaGFuZ2UgYnV5IHJhdGUgb2YgdG9rZW4gZnJvbSBiYXNlQnV5UmF0ZSBpbiAxMCBicHMKICAgICAgICBieXRlczE0IHNlbGw7IC8vIGNoYW5nZSBzZWxsIHJhdGUgb2YgdG9rZW4gZnJvbSBiYXNlU2VsbFJhdGUgaW4gMTAgYnBzCgogICAgICAgIHVpbnQzMiBibG9ja051bWJlcjsKICAgIH0gKi8KICAgIHVpbnQgcHVibGljIHZhbGlkUmF0ZUR1cmF0aW9uSW5CbG9ja3MgPSAxMDsgLy8gcmF0ZXMgYXJlIHZhbGlkIGZvciB0aGlzIGFtb3VudCBvZiBibG9ja3MKICAgIEVSQzIwW10gaW50ZXJuYWwgbGlzdGVkVG9rZW5zOwogICAgbWFwcGluZyhhZGRyZXNzPT5Ub2tlbkRhdGEpIGludGVybmFsIHRva2VuRGF0YTsKICAgIGJ5dGVzMzJbXSBpbnRlcm5hbCB0b2tlblJhdGVzQ29tcGFjdERhdGE7CiAgICB1aW50IHB1YmxpYyBudW1Ub2tlbnNJbkN1cnJlbnRDb21wYWN0RGF0YSA9IDA7CiAgICBhZGRyZXNzIHB1YmxpYyByZXNlcnZlQ29udHJhY3Q7CiAgICB1aW50IGNvbnN0YW50IGludGVybmFsIE5VTV9UT0tFTlNfSU5fQ09NUEFDVF9EQVRBID0gMTQ7CiAgICB1aW50IGNvbnN0YW50IGludGVybmFsIEJZVEVTXzE0X09GRlNFVCA9ICgyICoqICg4ICogTlVNX1RPS0VOU19JTl9DT01QQUNUX0RBVEEpKTsKICAgIHVpbnQgY29uc3RhbnQgaW50ZXJuYWwgTUFYX1NURVBTX0lOX0ZVTkNUSU9OID0gMTA7CiAgICBpbnQgIGNvbnN0YW50IGludGVybmFsIE1BWF9CUFNfQURKVVNUTUVOVCA9IDEwICoqIDExOyAvLyAxQiAlCiAgICBpbnQgIGNvbnN0YW50IGludGVybmFsIE1JTl9CUFNfQURKVVNUTUVOVCA9IC0xMDAgKiAxMDA7IC8vIGNhbm5vdCBnbyBkb3duIGJ5IG1vcmUgdGhhbiAxMDAlCgogICAgZnVuY3Rpb24gQ29udmVyc2lvblJhdGVzKGFkZHJlc3MgX2FkbWluKSBwdWJsaWMgVm9sdW1lSW1iYWxhbmNlUmVjb3JkZXIoX2FkbWluKQogICAgICAgIHsgfSAvLyBzb2xoaW50LWRpc2FibGUtbGluZSBuby1lbXB0eS1ibG9ja3MKCiAgICBmdW5jdGlvbiBhZGRUb2tlbihFUkMyMCB0b2tlbikgcHVibGljIG9ubHlBZG1pbiB7CgogICAgICAgIHJlcXVpcmUoIXRva2VuRGF0YVt0b2tlbl0ubGlzdGVkKTsKICAgICAgICB0b2tlbkRhdGFbdG9rZW5dLmxpc3RlZCA9IHRydWU7CiAgICAgICAgbGlzdGVkVG9rZW5zLnB1c2godG9rZW4pOwoKICAgICAgICBpZiAobnVtVG9rZW5zSW5DdXJyZW50Q29tcGFjdERhdGEgPT0gMCkgewogICAgICAgICAgICB0b2tlblJhdGVzQ29tcGFjdERhdGEubGVuZ3RoKys7IC8vIGFkZCBuZXcgc3RydWN0dXJlCiAgICAgICAgfQoKICAgICAgICB0b2tlbkRhdGFbdG9rZW5dLmNvbXBhY3REYXRhQXJyYXlJbmRleCA9IHRva2VuUmF0ZXNDb21wYWN0RGF0YS5sZW5ndGggLSAxOwogICAgICAgIHRva2VuRGF0YVt0b2tlbl0uY29tcGFjdERhdGFGaWVsZEluZGV4ID0gbnVtVG9rZW5zSW5DdXJyZW50Q29tcGFjdERhdGE7CgogICAgICAgIG51bVRva2Vuc0luQ3VycmVudENvbXBhY3REYXRhID0gKG51bVRva2Vuc0luQ3VycmVudENvbXBhY3REYXRhICsgMSkgJSBOVU1fVE9LRU5TX0lOX0NPTVBBQ1RfREFUQTsKCiAgICAgICAgc2V0R2FyYmFnZVRvVm9sdW1lUmVjb3JkZXIodG9rZW4pOwoKICAgICAgICBzZXREZWNpbWFscyh0b2tlbik7CiAgICB9CgogICAgZnVuY3Rpb24gc2V0Q29tcGFjdERhdGEoYnl0ZXMxNFtdIGJ1eSwgYnl0ZXMxNFtdIHNlbGwsIHVpbnQgYmxvY2tOdW1iZXIsIHVpbnRbXSBpbmRpY2VzKSBwdWJsaWMgb25seU9wZXJhdG9yIHsKCiAgICAgICAgcmVxdWlyZShidXkubGVuZ3RoID09IHNlbGwubGVuZ3RoKTsKICAgICAgICByZXF1aXJlKGluZGljZXMubGVuZ3RoID09IGJ1eS5sZW5ndGgpOwogICAgICAgIHJlcXVpcmUoYmxvY2tOdW1iZXIgPD0gMHhGRkZGRkZGRik7CgogICAgICAgIHVpbnQgYnl0ZXMxNE9mZnNldCA9IEJZVEVTXzE0X09GRlNFVDsKCiAgICAgICAgZm9yICh1aW50IGkgPSAwOyBpIDwgaW5kaWNlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICByZXF1aXJlKGluZGljZXNbaV0gPCB0b2tlblJhdGVzQ29tcGFjdERhdGEubGVuZ3RoKTsKICAgICAgICAgICAgdWludCBkYXRhID0gdWludChidXlbaV0pIHwgdWludChzZWxsW2ldKSAqIGJ5dGVzMTRPZmZzZXQgfCAoYmxvY2tOdW1iZXIgKiAoYnl0ZXMxNE9mZnNldCAqIGJ5dGVzMTRPZmZzZXQpKTsKICAgICAgICAgICAgdG9rZW5SYXRlc0NvbXBhY3REYXRhW2luZGljZXNbaV1dID0gYnl0ZXMzMihkYXRhKTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gc2V0QmFzZVJhdGUoCiAgICAgICAgRVJDMjBbXSB0b2tlbnMsCiAgICAgICAgdWludFtdIGJhc2VCdXksCiAgICAgICAgdWludFtdIGJhc2VTZWxsLAogICAgICAgIGJ5dGVzMTRbXSBidXksCiAgICAgICAgYnl0ZXMxNFtdIHNlbGwsCiAgICAgICAgdWludCBibG9ja051bWJlciwKICAgICAgICB1aW50W10gaW5kaWNlcwogICAgKQogICAgICAgIHB1YmxpYwogICAgICAgIG9ubHlPcGVyYXRvcgogICAgewogICAgICAgIHJlcXVpcmUodG9rZW5zLmxlbmd0aCA9PSBiYXNlQnV5Lmxlbmd0aCk7CiAgICAgICAgcmVxdWlyZSh0b2tlbnMubGVuZ3RoID09IGJhc2VTZWxsLmxlbmd0aCk7CiAgICAgICAgcmVxdWlyZShzZWxsLmxlbmd0aCA9PSBidXkubGVuZ3RoKTsKICAgICAgICByZXF1aXJlKHNlbGwubGVuZ3RoID09IGluZGljZXMubGVuZ3RoKTsKCiAgICAgICAgZm9yICh1aW50IGluZCA9IDA7IGluZCA8IHRva2Vucy5sZW5ndGg7IGluZCsrKSB7CiAgICAgICAgICAgIHJlcXVpcmUodG9rZW5EYXRhW3Rva2Vuc1tpbmRdXS5saXN0ZWQpOwogICAgICAgICAgICB0b2tlbkRhdGFbdG9rZW5zW2luZF1dLmJhc2VCdXlSYXRlID0gYmFzZUJ1eVtpbmRdOwogICAgICAgICAgICB0b2tlbkRhdGFbdG9rZW5zW2luZF1dLmJhc2VTZWxsUmF0ZSA9IGJhc2VTZWxsW2luZF07CiAgICAgICAgfQoKICAgICAgICBzZXRDb21wYWN0RGF0YShidXksIHNlbGwsIGJsb2NrTnVtYmVyLCBpbmRpY2VzKTsKICAgIH0KCiAgICBmdW5jdGlvbiBzZXRRdHlTdGVwRnVuY3Rpb24oCiAgICAgICAgRVJDMjAgdG9rZW4sCiAgICAgICAgaW50W10geEJ1eSwKICAgICAgICBpbnRbXSB5QnV5LAogICAgICAgIGludFtdIHhTZWxsLAogICAgICAgIGludFtdIHlTZWxsCiAgICApCiAgICAgICAgcHVibGljCiAgICAgICAgb25seU9wZXJhdG9yCiAgICB7CiAgICAgICAgcmVxdWlyZSh4QnV5Lmxlbmd0aCA9PSB5QnV5Lmxlbmd0aCk7CiAgICAgICAgcmVxdWlyZSh4U2VsbC5sZW5ndGggPT0geVNlbGwubGVuZ3RoKTsKICAgICAgICByZXF1aXJlKHhCdXkubGVuZ3RoIDw9IE1BWF9TVEVQU19JTl9GVU5DVElPTik7CiAgICAgICAgcmVxdWlyZSh4U2VsbC5sZW5ndGggPD0gTUFYX1NURVBTX0lOX0ZVTkNUSU9OKTsKICAgICAgICByZXF1aXJlKHRva2VuRGF0YVt0b2tlbl0ubGlzdGVkKTsKCiAgICAgICAgdG9rZW5EYXRhW3Rva2VuXS5idXlSYXRlUXR5U3RlcEZ1bmN0aW9uID0gU3RlcEZ1bmN0aW9uKHhCdXksIHlCdXkpOwogICAgICAgIHRva2VuRGF0YVt0b2tlbl0uc2VsbFJhdGVRdHlTdGVwRnVuY3Rpb24gPSBTdGVwRnVuY3Rpb24oeFNlbGwsIHlTZWxsKTsKICAgIH0KCiAgICBmdW5jdGlvbiBzZXRJbWJhbGFuY2VTdGVwRnVuY3Rpb24oCiAgICAgICAgRVJDMjAgdG9rZW4sCiAgICAgICAgaW50W10geEJ1eSwKICAgICAgICBpbnRbXSB5QnV5LAogICAgICAgIGludFtdIHhTZWxsLAogICAgICAgIGludFtdIHlTZWxsCiAgICApCiAgICAgICAgcHVibGljCiAgICAgICAgb25seU9wZXJhdG9yCiAgICB7CiAgICAgICAgcmVxdWlyZSh4QnV5Lmxlbmd0aCA9PSB5QnV5Lmxlbmd0aCk7CiAgICAgICAgcmVxdWlyZSh4U2VsbC5sZW5ndGggPT0geVNlbGwubGVuZ3RoKTsKICAgICAgICByZXF1aXJlKHhCdXkubGVuZ3RoIDw9IE1BWF9TVEVQU19JTl9GVU5DVElPTik7CiAgICAgICAgcmVxdWlyZSh4U2VsbC5sZW5ndGggPD0gTUFYX1NURVBTX0lOX0ZVTkNUSU9OKTsKICAgICAgICByZXF1aXJlKHRva2VuRGF0YVt0b2tlbl0ubGlzdGVkKTsKCiAgICAgICAgdG9rZW5EYXRhW3Rva2VuXS5idXlSYXRlSW1iYWxhbmNlU3RlcEZ1bmN0aW9uID0gU3RlcEZ1bmN0aW9uKHhCdXksIHlCdXkpOwogICAgICAgIHRva2VuRGF0YVt0b2tlbl0uc2VsbFJhdGVJbWJhbGFuY2VTdGVwRnVuY3Rpb24gPSBTdGVwRnVuY3Rpb24oeFNlbGwsIHlTZWxsKTsKICAgIH0KCiAgICBmdW5jdGlvbiBzZXRWYWxpZFJhdGVEdXJhdGlvbkluQmxvY2tzKHVpbnQgZHVyYXRpb24pIHB1YmxpYyBvbmx5QWRtaW4gewogICAgICAgIHZhbGlkUmF0ZUR1cmF0aW9uSW5CbG9ja3MgPSBkdXJhdGlvbjsKICAgIH0KCiAgICBmdW5jdGlvbiBlbmFibGVUb2tlblRyYWRlKEVSQzIwIHRva2VuKSBwdWJsaWMgb25seUFkbWluIHsKICAgICAgICByZXF1aXJlKHRva2VuRGF0YVt0b2tlbl0ubGlzdGVkKTsKICAgICAgICByZXF1aXJlKHRva2VuQ29udHJvbEluZm9bdG9rZW5dLm1pbmltYWxSZWNvcmRSZXNvbHV0aW9uICE9IDApOwogICAgICAgIHRva2VuRGF0YVt0b2tlbl0uZW5hYmxlZCA9IHRydWU7CiAgICB9CgogICAgZnVuY3Rpb24gZGlzYWJsZVRva2VuVHJhZGUoRVJDMjAgdG9rZW4pIHB1YmxpYyBvbmx5QWxlcnRlciB7CiAgICAgICAgcmVxdWlyZSh0b2tlbkRhdGFbdG9rZW5dLmxpc3RlZCk7CiAgICAgICAgdG9rZW5EYXRhW3Rva2VuXS5lbmFibGVkID0gZmFsc2U7CiAgICB9CgogICAgZnVuY3Rpb24gc2V0UmVzZXJ2ZUFkZHJlc3MoYWRkcmVzcyByZXNlcnZlKSBwdWJsaWMgb25seUFkbWluIHsKICAgICAgICByZXNlcnZlQ29udHJhY3QgPSByZXNlcnZlOwogICAgfQoKICAgIGZ1bmN0aW9uIHJlY29yZEltYmFsYW5jZSgKICAgICAgICBFUkMyMCB0b2tlbiwKICAgICAgICBpbnQgYnV5QW1vdW50LAogICAgICAgIHVpbnQgcmF0ZVVwZGF0ZUJsb2NrLAogICAgICAgIHVpbnQgY3VycmVudEJsb2NrCiAgICApCiAgICAgICAgcHVibGljCiAgICB7CiAgICAgICAgcmVxdWlyZShtc2cuc2VuZGVyID09IHJlc2VydmVDb250cmFjdCk7CgogICAgICAgIGlmIChyYXRlVXBkYXRlQmxvY2sgPT0gMCkgcmF0ZVVwZGF0ZUJsb2NrID0gZ2V0UmF0ZVVwZGF0ZUJsb2NrKHRva2VuKTsKCiAgICAgICAgcmV0dXJuIGFkZEltYmFsYW5jZSh0b2tlbiwgYnV5QW1vdW50LCByYXRlVXBkYXRlQmxvY2ssIGN1cnJlbnRCbG9jayk7CiAgICB9CgogICAgLyogc29saGludC1kaXNhYmxlIGZ1bmN0aW9uLW1heC1saW5lcyAqLwogICAgZnVuY3Rpb24gZ2V0UmF0ZShFUkMyMCB0b2tlbiwgdWludCBjdXJyZW50QmxvY2tOdW1iZXIsIGJvb2wgYnV5LCB1aW50IHF0eSkgcHVibGljIHZpZXcgcmV0dXJucyh1aW50KSB7CiAgICAgICAgLy8gY2hlY2sgaWYgdHJhZGUgaXMgZW5hYmxlZAogICAgICAgIGlmICghdG9rZW5EYXRhW3Rva2VuXS5lbmFibGVkKSByZXR1cm4gMDsKICAgICAgICBpZiAodG9rZW5Db250cm9sSW5mb1t0b2tlbl0ubWluaW1hbFJlY29yZFJlc29sdXRpb24gPT0gMCkgcmV0dXJuIDA7IC8vIHRva2VuIGNvbnRyb2wgaW5mbyBub3Qgc2V0CgogICAgICAgIC8vIGdldCByYXRlIHVwZGF0ZSBibG9jawogICAgICAgIGJ5dGVzMzIgY29tcGFjdERhdGEgPSB0b2tlblJhdGVzQ29tcGFjdERhdGFbdG9rZW5EYXRhW3Rva2VuXS5jb21wYWN0RGF0YUFycmF5SW5kZXhdOwoKICAgICAgICB1aW50IHVwZGF0ZVJhdGVCbG9jayA9IGdldExhc3Q0Qnl0ZXMoY29tcGFjdERhdGEpOwogICAgICAgIGlmIChjdXJyZW50QmxvY2tOdW1iZXIgPj0gdXBkYXRlUmF0ZUJsb2NrICsgdmFsaWRSYXRlRHVyYXRpb25JbkJsb2NrcykgcmV0dXJuIDA7IC8vIHJhdGUgaXMgZXhwaXJlZAogICAgICAgIC8vIGNoZWNrIGltYmFsYW5jZQogICAgICAgIGludCB0b3RhbEltYmFsYW5jZTsKICAgICAgICBpbnQgYmxvY2tJbWJhbGFuY2U7CiAgICAgICAgKHRvdGFsSW1iYWxhbmNlLCBibG9ja0ltYmFsYW5jZSkgPSBnZXRJbWJhbGFuY2UodG9rZW4sIHVwZGF0ZVJhdGVCbG9jaywgY3VycmVudEJsb2NrTnVtYmVyKTsKCiAgICAgICAgLy8gY2FsY3VsYXRlIGFjdHVhbCByYXRlCiAgICAgICAgaW50IGltYmFsYW5jZVF0eTsKICAgICAgICBpbnQgZXh0cmFCcHM7CiAgICAgICAgaW50OCByYXRlVXBkYXRlOwogICAgICAgIHVpbnQgcmF0ZTsKCiAgICAgICAgaWYgKGJ1eSkgewogICAgICAgICAgICAvLyBzdGFydCB3aXRoIGJhc2UgcmF0ZQogICAgICAgICAgICByYXRlID0gdG9rZW5EYXRhW3Rva2VuXS5iYXNlQnV5UmF0ZTsKCiAgICAgICAgICAgIC8vIGFkZCByYXRlIHVwZGF0ZQogICAgICAgICAgICByYXRlVXBkYXRlID0gZ2V0UmF0ZUJ5dGVGcm9tQ29tcGFjdERhdGEoY29tcGFjdERhdGEsIHRva2VuLCB0cnVlKTsKICAgICAgICAgICAgZXh0cmFCcHMgPSBpbnQocmF0ZVVwZGF0ZSkgKiAxMDsKICAgICAgICAgICAgcmF0ZSA9IGFkZEJwcyhyYXRlLCBleHRyYUJwcyk7CgogICAgICAgICAgICAvLyBjb21wdXRlIHRva2VuIHF0eQogICAgICAgICAgICBxdHkgPSBnZXRUb2tlblF0eSh0b2tlbiwgcmF0ZSwgcXR5KTsKICAgICAgICAgICAgaW1iYWxhbmNlUXR5ID0gaW50KHF0eSk7CiAgICAgICAgICAgIHRvdGFsSW1iYWxhbmNlICs9IGltYmFsYW5jZVF0eTsKCiAgICAgICAgICAgIC8vIGFkZCBxdHkgb3ZlcmhlYWQKICAgICAgICAgICAgZXh0cmFCcHMgPSBleGVjdXRlU3RlcEZ1bmN0aW9uKHRva2VuRGF0YVt0b2tlbl0uYnV5UmF0ZVF0eVN0ZXBGdW5jdGlvbiwgaW50KHF0eSkpOwogICAgICAgICAgICByYXRlID0gYWRkQnBzKHJhdGUsIGV4dHJhQnBzKTsKCiAgICAgICAgICAgIC8vIGFkZCBpbWJhbGFuY2Ugb3ZlcmhlYWQKICAgICAgICAgICAgZXh0cmFCcHMgPSBleGVjdXRlU3RlcEZ1bmN0aW9uKHRva2VuRGF0YVt0b2tlbl0uYnV5UmF0ZUltYmFsYW5jZVN0ZXBGdW5jdGlvbiwgdG90YWxJbWJhbGFuY2UpOwogICAgICAgICAgICByYXRlID0gYWRkQnBzKHJhdGUsIGV4dHJhQnBzKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBzdGFydCB3aXRoIGJhc2UgcmF0ZQogICAgICAgICAgICByYXRlID0gdG9rZW5EYXRhW3Rva2VuXS5iYXNlU2VsbFJhdGU7CgogICAgICAgICAgICAvLyBhZGQgcmF0ZSB1cGRhdGUKICAgICAgICAgICAgcmF0ZVVwZGF0ZSA9IGdldFJhdGVCeXRlRnJvbUNvbXBhY3REYXRhKGNvbXBhY3REYXRhLCB0b2tlbiwgZmFsc2UpOwogICAgICAgICAgICBleHRyYUJwcyA9IGludChyYXRlVXBkYXRlKSAqIDEwOwogICAgICAgICAgICByYXRlID0gYWRkQnBzKHJhdGUsIGV4dHJhQnBzKTsKCiAgICAgICAgICAgIC8vIGNvbXB1dGUgdG9rZW4gcXR5CiAgICAgICAgICAgIGltYmFsYW5jZVF0eSA9IC0xICogaW50KHF0eSk7CiAgICAgICAgICAgIHRvdGFsSW1iYWxhbmNlICs9IGltYmFsYW5jZVF0eTsKCiAgICAgICAgICAgIC8vIGFkZCBxdHkgb3ZlcmhlYWQKICAgICAgICAgICAgZXh0cmFCcHMgPSBleGVjdXRlU3RlcEZ1bmN0aW9uKHRva2VuRGF0YVt0b2tlbl0uc2VsbFJhdGVRdHlTdGVwRnVuY3Rpb24sIGludChxdHkpKTsKICAgICAgICAgICAgcmF0ZSA9IGFkZEJwcyhyYXRlLCBleHRyYUJwcyk7CgogICAgICAgICAgICAvLyBhZGQgaW1iYWxhbmNlIG92ZXJoZWFkCiAgICAgICAgICAgIGV4dHJhQnBzID0gZXhlY3V0ZVN0ZXBGdW5jdGlvbih0b2tlbkRhdGFbdG9rZW5dLnNlbGxSYXRlSW1iYWxhbmNlU3RlcEZ1bmN0aW9uLCB0b3RhbEltYmFsYW5jZSk7CiAgICAgICAgICAgIHJhdGUgPSBhZGRCcHMocmF0ZSwgZXh0cmFCcHMpOwogICAgICAgIH0KCiAgICAgICAgaWYgKGFicyh0b3RhbEltYmFsYW5jZSkgPj0gZ2V0TWF4VG90YWxJbWJhbGFuY2UodG9rZW4pKSByZXR1cm4gMDsKICAgICAgICBpZiAoYWJzKGJsb2NrSW1iYWxhbmNlICsgaW1iYWxhbmNlUXR5KSA+PSBnZXRNYXhQZXJCbG9ja0ltYmFsYW5jZSh0b2tlbikpIHJldHVybiAwOwoKICAgICAgICByZXR1cm4gcmF0ZTsKICAgIH0KICAgIC8qIHNvbGhpbnQtZW5hYmxlIGZ1bmN0aW9uLW1heC1saW5lcyAqLwoKICAgIGZ1bmN0aW9uIGdldEJhc2ljUmF0ZShFUkMyMCB0b2tlbiwgYm9vbCBidXkpIHB1YmxpYyB2aWV3IHJldHVybnModWludCkgewogICAgICAgIGlmIChidXkpCiAgICAgICAgICAgIHJldHVybiB0b2tlbkRhdGFbdG9rZW5dLmJhc2VCdXlSYXRlOwogICAgICAgIGVsc2UKICAgICAgICAgICAgcmV0dXJuIHRva2VuRGF0YVt0b2tlbl0uYmFzZVNlbGxSYXRlOwogICAgfQoKICAgIGZ1bmN0aW9uIGdldENvbXBhY3REYXRhKEVSQzIwIHRva2VuKSBwdWJsaWMgdmlldyByZXR1cm5zKHVpbnQsIHVpbnQsIGJ5dGUsIGJ5dGUpIHsKICAgICAgICByZXF1aXJlKHRva2VuRGF0YVt0b2tlbl0ubGlzdGVkKTsKCiAgICAgICAgdWludCBhcnJheUluZGV4ID0gdG9rZW5EYXRhW3Rva2VuXS5jb21wYWN0RGF0YUFycmF5SW5kZXg7CiAgICAgICAgdWludCBmaWVsZE9mZnNldCA9IHRva2VuRGF0YVt0b2tlbl0uY29tcGFjdERhdGFGaWVsZEluZGV4OwoKICAgICAgICByZXR1cm4gKAogICAgICAgICAgICBhcnJheUluZGV4LAogICAgICAgICAgICBmaWVsZE9mZnNldCwKICAgICAgICAgICAgYnl0ZShnZXRSYXRlQnl0ZUZyb21Db21wYWN0RGF0YSh0b2tlblJhdGVzQ29tcGFjdERhdGFbYXJyYXlJbmRleF0sIHRva2VuLCB0cnVlKSksCiAgICAgICAgICAgIGJ5dGUoZ2V0UmF0ZUJ5dGVGcm9tQ29tcGFjdERhdGEodG9rZW5SYXRlc0NvbXBhY3REYXRhW2FycmF5SW5kZXhdLCB0b2tlbiwgZmFsc2UpKQogICAgICAgICk7CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0VG9rZW5CYXNpY0RhdGEoRVJDMjAgdG9rZW4pIHB1YmxpYyB2aWV3IHJldHVybnMoYm9vbCwgYm9vbCkgewogICAgICAgIHJldHVybiAodG9rZW5EYXRhW3Rva2VuXS5saXN0ZWQsIHRva2VuRGF0YVt0b2tlbl0uZW5hYmxlZCk7CiAgICB9CgogICAgLyogc29saGludC1kaXNhYmxlIGNvZGUtY29tcGxleGl0eSAqLwogICAgZnVuY3Rpb24gZ2V0U3RlcEZ1bmN0aW9uRGF0YShFUkMyMCB0b2tlbiwgdWludCBjb21tYW5kLCB1aW50IHBhcmFtKSBwdWJsaWMgdmlldyByZXR1cm5zKGludCkgewogICAgICAgIGlmIChjb21tYW5kID09IDApIHJldHVybiBpbnQodG9rZW5EYXRhW3Rva2VuXS5idXlSYXRlUXR5U3RlcEZ1bmN0aW9uLngubGVuZ3RoKTsKICAgICAgICBpZiAoY29tbWFuZCA9PSAxKSByZXR1cm4gdG9rZW5EYXRhW3Rva2VuXS5idXlSYXRlUXR5U3RlcEZ1bmN0aW9uLnhbcGFyYW1dOwogICAgICAgIGlmIChjb21tYW5kID09IDIpIHJldHVybiBpbnQodG9rZW5EYXRhW3Rva2VuXS5idXlSYXRlUXR5U3RlcEZ1bmN0aW9uLnkubGVuZ3RoKTsKICAgICAgICBpZiAoY29tbWFuZCA9PSAzKSByZXR1cm4gdG9rZW5EYXRhW3Rva2VuXS5idXlSYXRlUXR5U3RlcEZ1bmN0aW9uLnlbcGFyYW1dOwoKICAgICAgICBpZiAoY29tbWFuZCA9PSA0KSByZXR1cm4gaW50KHRva2VuRGF0YVt0b2tlbl0uc2VsbFJhdGVRdHlTdGVwRnVuY3Rpb24ueC5sZW5ndGgpOwogICAgICAgIGlmIChjb21tYW5kID09IDUpIHJldHVybiB0b2tlbkRhdGFbdG9rZW5dLnNlbGxSYXRlUXR5U3RlcEZ1bmN0aW9uLnhbcGFyYW1dOwogICAgICAgIGlmIChjb21tYW5kID09IDYpIHJldHVybiBpbnQodG9rZW5EYXRhW3Rva2VuXS5zZWxsUmF0ZVF0eVN0ZXBGdW5jdGlvbi55Lmxlbmd0aCk7CiAgICAgICAgaWYgKGNvbW1hbmQgPT0gNykgcmV0dXJuIHRva2VuRGF0YVt0b2tlbl0uc2VsbFJhdGVRdHlTdGVwRnVuY3Rpb24ueVtwYXJhbV07CgogICAgICAgIGlmIChjb21tYW5kID09IDgpIHJldHVybiBpbnQodG9rZW5EYXRhW3Rva2VuXS5idXlSYXRlSW1iYWxhbmNlU3RlcEZ1bmN0aW9uLngubGVuZ3RoKTsKICAgICAgICBpZiAoY29tbWFuZCA9PSA5KSByZXR1cm4gdG9rZW5EYXRhW3Rva2VuXS5idXlSYXRlSW1iYWxhbmNlU3RlcEZ1bmN0aW9uLnhbcGFyYW1dOwogICAgICAgIGlmIChjb21tYW5kID09IDEwKSByZXR1cm4gaW50KHRva2VuRGF0YVt0b2tlbl0uYnV5UmF0ZUltYmFsYW5jZVN0ZXBGdW5jdGlvbi55Lmxlbmd0aCk7CiAgICAgICAgaWYgKGNvbW1hbmQgPT0gMTEpIHJldHVybiB0b2tlbkRhdGFbdG9rZW5dLmJ1eVJhdGVJbWJhbGFuY2VTdGVwRnVuY3Rpb24ueVtwYXJhbV07CgogICAgICAgIGlmIChjb21tYW5kID09IDEyKSByZXR1cm4gaW50KHRva2VuRGF0YVt0b2tlbl0uc2VsbFJhdGVJbWJhbGFuY2VTdGVwRnVuY3Rpb24ueC5sZW5ndGgpOwogICAgICAgIGlmIChjb21tYW5kID09IDEzKSByZXR1cm4gdG9rZW5EYXRhW3Rva2VuXS5zZWxsUmF0ZUltYmFsYW5jZVN0ZXBGdW5jdGlvbi54W3BhcmFtXTsKICAgICAgICBpZiAoY29tbWFuZCA9PSAxNCkgcmV0dXJuIGludCh0b2tlbkRhdGFbdG9rZW5dLnNlbGxSYXRlSW1iYWxhbmNlU3RlcEZ1bmN0aW9uLnkubGVuZ3RoKTsKICAgICAgICBpZiAoY29tbWFuZCA9PSAxNSkgcmV0dXJuIHRva2VuRGF0YVt0b2tlbl0uc2VsbFJhdGVJbWJhbGFuY2VTdGVwRnVuY3Rpb24ueVtwYXJhbV07CgogICAgICAgIHJldmVydCgpOwogICAgfQogICAgLyogc29saGludC1lbmFibGUgY29kZS1jb21wbGV4aXR5ICovCgogICAgZnVuY3Rpb24gZ2V0UmF0ZVVwZGF0ZUJsb2NrKEVSQzIwIHRva2VuKSBwdWJsaWMgdmlldyByZXR1cm5zKHVpbnQpIHsKICAgICAgICBieXRlczMyIGNvbXBhY3REYXRhID0gdG9rZW5SYXRlc0NvbXBhY3REYXRhW3Rva2VuRGF0YVt0b2tlbl0uY29tcGFjdERhdGFBcnJheUluZGV4XTsKICAgICAgICByZXR1cm4gZ2V0TGFzdDRCeXRlcyhjb21wYWN0RGF0YSk7CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0TGlzdGVkVG9rZW5zKCkgcHVibGljIHZpZXcgcmV0dXJucyhFUkMyMFtdKSB7CiAgICAgICAgcmV0dXJuIGxpc3RlZFRva2VuczsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRUb2tlblF0eShFUkMyMCB0b2tlbiwgdWludCBldGhRdHksIHVpbnQgcmF0ZSkgaW50ZXJuYWwgdmlldyByZXR1cm5zKHVpbnQpIHsKICAgICAgICB1aW50IGRzdERlY2ltYWxzID0gZ2V0RGVjaW1hbHModG9rZW4pOwogICAgICAgIHVpbnQgc3JjRGVjaW1hbHMgPSBFVEhfREVDSU1BTFM7CgogICAgICAgIHJldHVybiBjYWxjRHN0UXR5KGV0aFF0eSwgc3JjRGVjaW1hbHMsIGRzdERlY2ltYWxzLCByYXRlKTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRMYXN0NEJ5dGVzKGJ5dGVzMzIgYikgaW50ZXJuYWwgcHVyZSByZXR1cm5zKHVpbnQpIHsKICAgICAgICAvLyBjYW5ub3QgdHJ1c3QgY29tcGlsZXIgd2l0aCBub3QgdHVybmluZyBiaXQgb3BlcmF0aW9ucyBpbnRvIEVYUCBvcGNvZGUKICAgICAgICByZXR1cm4gdWludChiKSAvIChCWVRFU18xNF9PRkZTRVQgKiBCWVRFU18xNF9PRkZTRVQpOwogICAgfQoKICAgIGZ1bmN0aW9uIGdldFJhdGVCeXRlRnJvbUNvbXBhY3REYXRhKGJ5dGVzMzIgZGF0YSwgRVJDMjAgdG9rZW4sIGJvb2wgYnV5KSBpbnRlcm5hbCB2aWV3IHJldHVybnMoaW50OCkgewogICAgICAgIHVpbnQgZmllbGRPZmZzZXQgPSB0b2tlbkRhdGFbdG9rZW5dLmNvbXBhY3REYXRhRmllbGRJbmRleDsKICAgICAgICB1aW50IGJ5dGVPZmZzZXQ7CiAgICAgICAgaWYgKGJ1eSkKICAgICAgICAgICAgYnl0ZU9mZnNldCA9IDMyIC0gTlVNX1RPS0VOU19JTl9DT01QQUNUX0RBVEEgKyBmaWVsZE9mZnNldDsKICAgICAgICBlbHNlCiAgICAgICAgICAgIGJ5dGVPZmZzZXQgPSA0ICsgZmllbGRPZmZzZXQ7CgogICAgICAgIHJldHVybiBpbnQ4KGRhdGFbYnl0ZU9mZnNldF0pOwogICAgfQoKICAgIGZ1bmN0aW9uIGV4ZWN1dGVTdGVwRnVuY3Rpb24oU3RlcEZ1bmN0aW9uIGYsIGludCB4KSBpbnRlcm5hbCBwdXJlIHJldHVybnMoaW50KSB7CiAgICAgICAgdWludCBsZW4gPSBmLnkubGVuZ3RoOwogICAgICAgIGZvciAodWludCBpbmQgPSAwOyBpbmQgPCBsZW47IGluZCsrKSB7CiAgICAgICAgICAgIGlmICh4IDw9IGYueFtpbmRdKSByZXR1cm4gZi55W2luZF07CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZi55W2xlbi0xXTsKICAgIH0KCiAgICBmdW5jdGlvbiBhZGRCcHModWludCByYXRlLCBpbnQgYnBzKSBpbnRlcm5hbCBwdXJlIHJldHVybnModWludCkgewogICAgICAgIHJlcXVpcmUocmF0ZSA8PSBNQVhfUkFURSk7CiAgICAgICAgcmVxdWlyZShicHMgPj0gTUlOX0JQU19BREpVU1RNRU5UKTsKICAgICAgICByZXF1aXJlKGJwcyA8PSBNQVhfQlBTX0FESlVTVE1FTlQpOwoKICAgICAgICB1aW50IG1heEJwcyA9IDEwMCAqIDEwMDsKICAgICAgICByZXR1cm4gKHJhdGUgKiB1aW50KGludChtYXhCcHMpICsgYnBzKSkgLyBtYXhCcHM7CiAgICB9CgogICAgZnVuY3Rpb24gYWJzKGludCB4KSBpbnRlcm5hbCBwdXJlIHJldHVybnModWludCkgewogICAgICAgIGlmICh4IDwgMCkKICAgICAgICAgICAgcmV0dXJuIHVpbnQoLTEgKiB4KTsKICAgICAgICBlbHNlCiAgICAgICAgICAgIHJldHVybiB1aW50KHgpOwogICAgfQp9Cgpjb250cmFjdCBXcmFwcGVyIGlzIFV0aWxzIHsKCiAgICBmdW5jdGlvbiBnZXRCYWxhbmNlcyhhZGRyZXNzIHJlc2VydmUsIEVSQzIwW10gdG9rZW5zKSBwdWJsaWMgdmlldyByZXR1cm5zKHVpbnRbXSkgewogICAgICAgIHVpbnRbXSBtZW1vcnkgcmVzdWx0ID0gbmV3IHVpbnRbXSh0b2tlbnMubGVuZ3RoKTsKICAgICAgICBmb3IgKHVpbnQgaSA9IDA7IGkgPCB0b2tlbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdWludCBiYWxhbmNlID0gMDsKICAgICAgICAgICAgaWYgKHRva2Vuc1tpXSA9PSBFVEhfVE9LRU5fQUREUkVTUykgewogICAgICAgICAgICAgICAgYmFsYW5jZSA9IHJlc2VydmUuYmFsYW5jZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGJhbGFuY2UgPSB0b2tlbnNbaV0uYmFsYW5jZU9mKHJlc2VydmUpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXN1bHRbaV0gPSBiYWxhbmNlOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRCeXRlRnJvbUJ5dGVzMTQoYnl0ZXMxNCB4LCB1aW50IGJ5dGVJbmQpIHB1YmxpYyBwdXJlIHJldHVybnMoYnl0ZSkgewogICAgICAgIHJlcXVpcmUoYnl0ZUluZCA8PSAxMyk7CiAgICAgICAgcmV0dXJuIHhbYnl0ZUluZF07CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0SW50OEZyb21CeXRlKGJ5dGVzMTQgeCwgdWludCBieXRlSW5kKSBwdWJsaWMgcHVyZSByZXR1cm5zKGludDgpIHsKICAgICAgICByZXF1aXJlKGJ5dGVJbmQgPD0gMTMpOwogICAgICAgIHJldHVybiBpbnQ4KHhbYnl0ZUluZF0pOwogICAgfQoKLy8gICAgc3RydWN0IFRva2VuUmF0ZXNDb21wYWN0RGF0YSB7Ci8vICAgICAgICBieXRlczE0IGJ1eTsgIC8vIGNoYW5nZSBidXkgcmF0ZSBvZiB0b2tlbiBmcm9tIGJhc2VCdXlSYXRlIGluIDEwIGJwcwovLyAgICAgICAgYnl0ZXMxNCBzZWxsOyAvLyBjaGFuZ2Ugc2VsbCByYXRlIG9mIHRva2VuIGZyb20gYmFzZVNlbGxSYXRlIGluIDEwIGJwcwovLwovLyAgICAgICAgdWludDMyIGJsb2NrTnVtYmVyOwovLyAgICB9Ci8vCi8vICAgIGZ1bmN0aW9uIGdldERhdGFGcm9tQ29tcGFjdChUb2tlblJhdGVzQ29tcGFjdERhdGEgY29tcGFjdCwgdWludCBieXRlSW5kKSBwdWJsaWMgcHVyZQovLyAgICAgICAgcmV0dXJucyhpbnQ4IGJ1eUJ5dGUsIGludDggc2VsbEJ5dGUsIHVpbnQgYmxvY2tOdW1iZXIpCi8vICAgIHsKLy8gICAgICAgIGJsb2NrTnVtYmVyID0gdWludChjb21wYWN0LmJsb2NrTnVtYmVyKTsKLy8vLyAgICAgICAgcmV0dXJuIChjb21wYWN0LmJ1eVtieXRlSW5kXSwgY29tcGFjdC5zZWxsW2J5dGVJbmRdLCB1aW50KGNvbXBhY3QuYmxvY2tOdW1iZXIpKTsKLy8gICAgfQoKICAgIGZ1bmN0aW9uIGdldENvbXBhY3REYXRhKENvbnZlcnNpb25SYXRlcyByYXRlc0NvbnRyYWN0LCBFUkMyMCB0b2tlbikgaW50ZXJuYWwgdmlldyByZXR1cm5zKGludDgsaW50OCx1aW50KSB7CiAgICAgICAgdWludCBidWxrSW5kZXg7IHVpbnQgaW5kZXg7IGJ5dGUgYnV5OyBieXRlIHNlbGw7IHVpbnQgdXBkYXRlQmxvY2s7CiAgICAgICAgKGJ1bGtJbmRleCwgaW5kZXgsIGJ1eSwgc2VsbCkgPSByYXRlc0NvbnRyYWN0LmdldENvbXBhY3REYXRhKHRva2VuKTsKICAgICAgICB1cGRhdGVCbG9jayA9IHJhdGVzQ29udHJhY3QuZ2V0UmF0ZVVwZGF0ZUJsb2NrKHRva2VuKTsKCiAgICAgICAgcmV0dXJuIChpbnQ4KGJ1eSksIGludDgoc2VsbCksIHVwZGF0ZUJsb2NrKTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRUb2tlblJhdGVzKENvbnZlcnNpb25SYXRlcyByYXRlc0NvbnRyYWN0LCBFUkMyMFtdIHRva2VuTGlzdCkKICAgICAgICBwdWJsaWMgdmlldwogICAgICAgIHJldHVybnModWludFtdLCB1aW50W10sIGludDhbXSwgaW50OFtdLCB1aW50W10pCiAgICB7CiAgICAgICAgdWludFtdIG1lbW9yeSBidXlCYXNlcyA9IG5ldyB1aW50W10odG9rZW5MaXN0Lmxlbmd0aCk7CiAgICAgICAgdWludFtdIG1lbW9yeSBzZWxsQmFzZXMgPSBuZXcgdWludFtdKHRva2VuTGlzdC5sZW5ndGgpOwogICAgICAgIGludDhbXSBtZW1vcnkgY29tcGFjdEJ1eSA9IG5ldyBpbnQ4W10odG9rZW5MaXN0Lmxlbmd0aCk7CiAgICAgICAgaW50OFtdIG1lbW9yeSBjb21wYWN0U2VsbCA9IG5ldyBpbnQ4W10odG9rZW5MaXN0Lmxlbmd0aCk7CiAgICAgICAgdWludFtdIG1lbW9yeSB1cGRhdGVCbG9jayA9IG5ldyB1aW50W10odG9rZW5MaXN0Lmxlbmd0aCk7CgogICAgICAgIGZvciAodWludCBpID0gMDsgIGkgPCB0b2tlbkxpc3QubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgYnV5QmFzZXNbaV0gPSByYXRlc0NvbnRyYWN0LmdldEJhc2ljUmF0ZSh0b2tlbkxpc3RbaV0sIHRydWUpOwogICAgICAgICAgICBzZWxsQmFzZXNbaV0gPSByYXRlc0NvbnRyYWN0LmdldEJhc2ljUmF0ZSh0b2tlbkxpc3RbaV0sIGZhbHNlKTsKCiAgICAgICAgICAgIChjb21wYWN0QnV5W2ldLCBjb21wYWN0U2VsbFtpXSwgdXBkYXRlQmxvY2tbaV0pID0gZ2V0Q29tcGFjdERhdGEocmF0ZXNDb250cmFjdCwgdG9rZW5MaXN0W2ldKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiAoYnV5QmFzZXMsIHNlbGxCYXNlcywgY29tcGFjdEJ1eSwgY29tcGFjdFNlbGwsIHVwZGF0ZUJsb2NrKTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRUb2tlbkluZGljaWVzKENvbnZlcnNpb25SYXRlcyByYXRlc0NvbnRyYWN0LCBFUkMyMFtdIHRva2VuTGlzdCkgcHVibGljIHZpZXcgcmV0dXJucyh1aW50W10sIHVpbnRbXSkgewogICAgICAgIHVpbnRbXSBtZW1vcnkgYnVsa0luZGljZXMgPSBuZXcgdWludFtdKHRva2VuTGlzdC5sZW5ndGgpOwogICAgICAgIHVpbnRbXSBtZW1vcnkgdG9rZW5JbmRleEluQnVsayA9IG5ldyB1aW50W10odG9rZW5MaXN0Lmxlbmd0aCk7CgogICAgICAgIGZvciAodWludCBpID0gMDsgaSA8IHRva2VuTGlzdC5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB1aW50IGJ1bGtJbmRleDsgdWludCBpbmRleDsgYnl0ZSBidXk7IGJ5dGUgc2VsbDsKICAgICAgICAgICAgKGJ1bGtJbmRleCwgaW5kZXgsIGJ1eSwgc2VsbCkgPSByYXRlc0NvbnRyYWN0LmdldENvbXBhY3REYXRhKHRva2VuTGlzdFtpXSk7CgogICAgICAgICAgICBidWxrSW5kaWNlc1tpXSA9IGJ1bGtJbmRleDsKICAgICAgICAgICAgdG9rZW5JbmRleEluQnVsa1tpXSA9IGluZGV4OwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIChidWxrSW5kaWNlcyx0b2tlbkluZGV4SW5CdWxrKTsKICAgIH0KCgogICAgZnVuY3Rpb24gZ2V0RXhwZWN0ZWRSYXRlcyggS3liZXJOZXR3b3JrIG5ldHdvcmssIEVSQzIwW10gc3JjcywgRVJDMjBbXSBkZXN0cywgdWludFtdIHF0eSApCiAgICAgICAgcHVibGljIHZpZXcgcmV0dXJucyh1aW50W10sIHVpbnRbXSkKICAgIHsKICAgICAgICByZXF1aXJlKCBzcmNzLmxlbmd0aCA9PSBkZXN0cy5sZW5ndGggKTsKICAgICAgICByZXF1aXJlKCBzcmNzLmxlbmd0aCA9PSBxdHkubGVuZ3RoICk7CgogICAgICAgIHVpbnRbXSBtZW1vcnkgcmF0ZXMgPSBuZXcgdWludFtdKHNyY3MubGVuZ3RoKTsKICAgICAgICB1aW50W10gbWVtb3J5IHNsaXBwYWdlID0gbmV3IHVpbnRbXShzcmNzLmxlbmd0aCk7CiAgICAgICAgZm9yICggdWludCBpID0gMDsgaSA8IHNyY3MubGVuZ3RoOyBpKysgKSB7CiAgICAgICAgICAgIChyYXRlc1tpXSxzbGlwcGFnZVtpXSkgPSBuZXR3b3JrLmdldEV4cGVjdGVkUmF0ZShzcmNzW2ldLGRlc3RzW2ldLHF0eVtpXSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gKHJhdGVzLCBzbGlwcGFnZSk7CiAgICB9Cn0='.
	

]
