Class {
	#name : #SRT233007FDeeB9a1BFB705666f87a6B3e8b5B301B1,
	#superclass : #SRTContracts,
	#category : #SolidityTestingResources
}

{ #category : #base64 }
SRT233007FDeeB9a1BFB705666f87a6B3e8b5B301B1 >> base64 [
	^ 'cHJhZ21hIHNvbGlkaXR5IF4wLjQuMTM7Ci8vIFRoYW5rcyB0byBPcGVuWmVwcGVsaW5lICYgVG9rZW5NYXJrZXQgZm9yIHRoZSBhd2Vzb21lIExpYnJhcmllcy4KY29udHJhY3QgU2FmZU1hdGhMaWIgewogIGZ1bmN0aW9uIHNhZmVNdWwodWludCBhLCB1aW50IGIpIHJldHVybnMgKHVpbnQpIHsKICAgIHVpbnQgYyA9IGEgKiBiOwogICAgYXNzZXJ0KGEgPT0gMCB8fCBjIC8gYSA9PSBiKTsKICAgIHJldHVybiBjOwogIH0KCiAgZnVuY3Rpb24gc2FmZVN1Yih1aW50IGEsIHVpbnQgYikgcmV0dXJucyAodWludCkgewogICAgYXNzZXJ0KGIgPD0gYSk7CiAgICByZXR1cm4gYSAtIGI7CiAgfQoKICBmdW5jdGlvbiBzYWZlQWRkKHVpbnQgYSwgdWludCBiKSByZXR1cm5zICh1aW50KSB7CiAgICB1aW50IGMgPSBhICsgYjsKICAgIGFzc2VydChjPj1hKTsKICAgIHJldHVybiBjOwogIH0KfQoKY29udHJhY3QgT3duYWJsZSB7CiAgYWRkcmVzcyBwdWJsaWMgb3duZXI7CiAgYWRkcmVzcyBwdWJsaWMgbmV3T3duZXI7CiAgZXZlbnQgT3duZXJzaGlwVHJhbnNmZXJyZWQoYWRkcmVzcyBpbmRleGVkIF9mcm9tLCBhZGRyZXNzIGluZGV4ZWQgX3RvKTsKICBmdW5jdGlvbiBPd25hYmxlKCkgewogICAgb3duZXIgPSBtc2cuc2VuZGVyOwogIH0KICBtb2RpZmllciBvbmx5T3duZXIgewogICAgcmVxdWlyZShtc2cuc2VuZGVyID09IG93bmVyKTsKICAgIF87CiAgfQogIGZ1bmN0aW9uIHRyYW5zZmVyT3duZXJzaGlwKGFkZHJlc3MgX25ld093bmVyKSBvbmx5T3duZXIgewogICAgbmV3T3duZXIgPSBfbmV3T3duZXI7CiAgfQoKICBmdW5jdGlvbiBhY2NlcHRPd25lcnNoaXAoKSB7CiAgICByZXF1aXJlKG1zZy5zZW5kZXIgPT0gbmV3T3duZXIpOwogICAgT3duZXJzaGlwVHJhbnNmZXJyZWQob3duZXIsIG5ld093bmVyKTsKICAgIG93bmVyID0gbmV3T3duZXI7CiAgfQogIAp9Cgpjb250cmFjdCBFUkMyMEJhc2ljIHsKICB1aW50IHB1YmxpYyB0b3RhbFN1cHBseTsKICBmdW5jdGlvbiBiYWxhbmNlT2YoYWRkcmVzcyB3aG8pIGNvbnN0YW50IHJldHVybnMgKHVpbnQpOwogIGZ1bmN0aW9uIHRyYW5zZmVyKGFkZHJlc3MgX3RvLCB1aW50IF92YWx1ZSkgcmV0dXJucyAoYm9vbCBzdWNjZXNzKTsKICBldmVudCBUcmFuc2ZlcihhZGRyZXNzIGluZGV4ZWQgZnJvbSwgYWRkcmVzcyBpbmRleGVkIHRvLCB1aW50IHZhbHVlKTsKfQoKY29udHJhY3QgRVJDMjAgaXMgRVJDMjBCYXNpYyB7CiAgZnVuY3Rpb24gYWxsb3dhbmNlKGFkZHJlc3Mgb3duZXIsIGFkZHJlc3Mgc3BlbmRlcikgY29uc3RhbnQgcmV0dXJucyAodWludCk7CiAgZnVuY3Rpb24gdHJhbnNmZXJGcm9tKGFkZHJlc3MgX2Zyb20sIGFkZHJlc3MgX3RvLCB1aW50IF92YWx1ZSkgcmV0dXJucyAoYm9vbCBzdWNjZXNzKTsKICBmdW5jdGlvbiBhcHByb3ZlKGFkZHJlc3MgX3NwZW5kZXIsIHVpbnQgX3ZhbHVlKSByZXR1cm5zIChib29sIHN1Y2Nlc3MpOwogIGV2ZW50IEFwcHJvdmFsKGFkZHJlc3MgaW5kZXhlZCBvd25lciwgYWRkcmVzcyBpbmRleGVkIHNwZW5kZXIsIHVpbnQgdmFsdWUpOwp9Cgpjb250cmFjdCBGcmFjdGlvbmFsRVJDMjAgaXMgRVJDMjAgewogIHVpbnQ4IHB1YmxpYyBkZWNpbWFsczsKfQoKY29udHJhY3QgU3RhbmRhcmRUb2tlbiBpcyBFUkMyMCwgU2FmZU1hdGhMaWIgewogIC8qIFRva2VuIHN1cHBseSBnb3QgaW5jcmVhc2VkIGFuZCBhIG5ldyBvd25lciByZWNlaXZlZCB0aGVzZSB0b2tlbnMgKi8KICBldmVudCBNaW50ZWQoYWRkcmVzcyByZWNlaXZlciwgdWludCBhbW91bnQpOwoKICAvKiBBY3R1YWwgYmFsYW5jZXMgb2YgdG9rZW4gaG9sZGVycyAqLwogIG1hcHBpbmcoYWRkcmVzcyA9PiB1aW50KSBiYWxhbmNlczsKCiAgLyogYXBwcm92ZSgpIGFsbG93YW5jZXMgKi8KICBtYXBwaW5nIChhZGRyZXNzID0+IG1hcHBpbmcgKGFkZHJlc3MgPT4gdWludCkpIGFsbG93ZWQ7CgogIGZ1bmN0aW9uIHRyYW5zZmVyKGFkZHJlc3MgX3RvLCB1aW50IF92YWx1ZSkgcmV0dXJucyAoYm9vbCBzdWNjZXNzKSB7CiAgICBpZiAoYmFsYW5jZXNbbXNnLnNlbmRlcl0gPj0gX3ZhbHVlIAogICAgICAgICYmIF92YWx1ZSA+IDAgCiAgICAgICAgJiYgYmFsYW5jZXNbX3RvXSArIF92YWx1ZSA+IGJhbGFuY2VzW190b10KICAgICAgICApIHsKICAgICAgYmFsYW5jZXNbbXNnLnNlbmRlcl0gPSBzYWZlU3ViKGJhbGFuY2VzW21zZy5zZW5kZXJdLF92YWx1ZSk7CiAgICAgIGJhbGFuY2VzW190b10gPSBzYWZlQWRkKGJhbGFuY2VzW190b10sX3ZhbHVlKTsKICAgICAgVHJhbnNmZXIobXNnLnNlbmRlciwgX3RvLCBfdmFsdWUpOwogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIGVsc2V7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIAogIH0KCiAgZnVuY3Rpb24gdHJhbnNmZXJGcm9tKGFkZHJlc3MgX2Zyb20sIGFkZHJlc3MgX3RvLCB1aW50IF92YWx1ZSkgcmV0dXJucyAoYm9vbCBzdWNjZXNzKSB7CiAgICB1aW50IF9hbGxvd2FuY2UgPSBhbGxvd2VkW19mcm9tXVttc2cuc2VuZGVyXTsKCiAgICBpZiAoYmFsYW5jZXNbX2Zyb21dID49IF92YWx1ZSAgIC8vIEZyb20gYS9jIGhhcyBiYWxhbmNlCiAgICAgICAgJiYgX2FsbG93YW5jZSA+PSBfdmFsdWUgICAgLy8gVHJhbnNmZXIgYXBwcm92ZWQKICAgICAgICAmJiBfdmFsdWUgPiAwICAgICAgICAgICAgICAvLyBOb24temVybyB0cmFuc2ZlcgogICAgICAgICYmIGJhbGFuY2VzW190b10gKyBfdmFsdWUgPiBiYWxhbmNlc1tfdG9dICAvLyBPdmVyZmxvdyBjaGVjawogICAgICAgICl7CiAgICBiYWxhbmNlc1tfdG9dID0gc2FmZUFkZChiYWxhbmNlc1tfdG9dLF92YWx1ZSk7CiAgICBiYWxhbmNlc1tfZnJvbV0gPSBzYWZlU3ViKGJhbGFuY2VzW19mcm9tXSxfdmFsdWUpOwogICAgYWxsb3dlZFtfZnJvbV1bbXNnLnNlbmRlcl0gPSBzYWZlU3ViKF9hbGxvd2FuY2UsX3ZhbHVlKTsKICAgIFRyYW5zZmVyKF9mcm9tLCBfdG8sIF92YWx1ZSk7CiAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICBlbHNlIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogIH0KCiAgZnVuY3Rpb24gYmFsYW5jZU9mKGFkZHJlc3MgX293bmVyKSBjb25zdGFudCByZXR1cm5zICh1aW50IGJhbGFuY2UpIHsKICAgIHJldHVybiBiYWxhbmNlc1tfb3duZXJdOwogIH0KCiAgZnVuY3Rpb24gYXBwcm92ZShhZGRyZXNzIF9zcGVuZGVyLCB1aW50IF92YWx1ZSkgcmV0dXJucyAoYm9vbCBzdWNjZXNzKSB7CgogICAgLy8gVG8gY2hhbmdlIHRoZSBhcHByb3ZlIGFtb3VudCB5b3UgZmlyc3QgaGF2ZSB0byByZWR1Y2UgdGhlIGFkZHJlc3Nlc2AKICAgIC8vICBhbGxvd2FuY2UgdG8gemVybyBieSBjYWxsaW5nIGBhcHByb3ZlKF9zcGVuZGVyLCAwKWAgaWYgaXQgaXMgbm90CiAgICAvLyAgYWxyZWFkeSAwIHRvIG1pdGlnYXRlIHRoZSByYWNlIGNvbmRpdGlvbiBkZXNjcmliZWQgaGVyZToKICAgIC8vICBodHRwczovL2dpdGh1Yi5jb20vZXRoZXJldW0vRUlQcy9pc3N1ZXMvMjAjaXNzdWVjb21tZW50LTI2MzUyNDcyOQogICAgcmVxdWlyZSghKChfdmFsdWUgIT0gMCkgJiYgKGFsbG93ZWRbbXNnLnNlbmRlcl1bX3NwZW5kZXJdICE9IDApKSk7CiAgICAvL2lmICgoX3ZhbHVlICE9IDApICYmIChhbGxvd2VkW21zZy5zZW5kZXJdW19zcGVuZGVyXSAhPSAwKSkgdGhyb3c7CgogICAgYWxsb3dlZFttc2cuc2VuZGVyXVtfc3BlbmRlcl0gPSBfdmFsdWU7CiAgICBBcHByb3ZhbChtc2cuc2VuZGVyLCBfc3BlbmRlciwgX3ZhbHVlKTsKICAgIHJldHVybiB0cnVlOwogIH0KCiAgZnVuY3Rpb24gYWxsb3dhbmNlKGFkZHJlc3MgX293bmVyLCBhZGRyZXNzIF9zcGVuZGVyKSBjb25zdGFudCByZXR1cm5zICh1aW50IHJlbWFpbmluZykgewogICAgcmV0dXJuIGFsbG93ZWRbX293bmVyXVtfc3BlbmRlcl07CiAgfQoKfQoKLyoqCiAqIFVwZ3JhZGUgYWdlbnQgaW50ZXJmYWNlIGluc3BpcmVkIGJ5IEx1bnlyLgogKgogKiBVcGdyYWRlIGFnZW50IHRyYW5zZmVycyB0b2tlbnMgdG8gYSBuZXcgY29udHJhY3QuCiAqIFVwZ3JhZGUgYWdlbnQgaXRzZWxmIGNhbiBiZSB0aGUgdG9rZW4gY29udHJhY3QsIG9yIGp1c3QgYSBtaWRkbGUgbWFuIGNvbnRyYWN0IGRvaW5nIHRoZSBoZWF2eSBsaWZ0aW5nLgogKi8KY29udHJhY3QgVXBncmFkZUFnZW50IHsKICB1aW50IHB1YmxpYyBvcmlnaW5hbFN1cHBseTsKICAvKiogSW50ZXJmYWNlIG1hcmtlciAqLwogIGZ1bmN0aW9uIGlzVXBncmFkZUFnZW50KCkgcHVibGljIGNvbnN0YW50IHJldHVybnMgKGJvb2wpIHsKICAgIHJldHVybiB0cnVlOwogIH0KICBmdW5jdGlvbiB1cGdyYWRlRnJvbShhZGRyZXNzIF9mcm9tLCB1aW50MjU2IF92YWx1ZSkgcHVibGljOwp9CgovKioKICogQSB0b2tlbiB1cGdyYWRlIG1lY2hhbmlzbSB3aGVyZSB1c2VycyBjYW4gb3B0LWluIGFtb3VudCBvZiB0b2tlbnMgdG8gdGhlIG5leHQgc21hcnQgY29udHJhY3QgcmV2aXNpb24uCiAqCiAqIEZpcnN0IGVudmlzaW9uZWQgYnkgR29sZW0gYW5kIEx1bnlyIHByb2plY3RzLgogKi8KY29udHJhY3QgVXBncmFkZWFibGVUb2tlbiBpcyBTdGFuZGFyZFRva2VuIHsKCiAgLyoqIENvbnRyYWN0IC8gcGVyc29uIHdobyBjYW4gc2V0IHRoZSB1cGdyYWRlIHBhdGguIFRoaXMgY2FuIGJlIHRoZSBzYW1lIGFzIHRlYW0gbXVsdGlzaWcgd2FsbGV0LCBhcyB3aGF0IGl0IGlzIHdpdGggaXRzIGRlZmF1bHQgdmFsdWUuICovCiAgYWRkcmVzcyBwdWJsaWMgdXBncmFkZU1hc3RlcjsKCiAgLyoqIFRoZSBuZXh0IGNvbnRyYWN0IHdoZXJlIHRoZSB0b2tlbnMgd2lsbCBiZSBtaWdyYXRlZC4gKi8KICBVcGdyYWRlQWdlbnQgcHVibGljIHVwZ3JhZGVBZ2VudDsKCiAgLyoqIEhvdyBtYW55IHRva2VucyB3ZSBoYXZlIHVwZ3JhZGVkIGJ5IG5vdy4gKi8KICB1aW50MjU2IHB1YmxpYyB0b3RhbFVwZ3JhZGVkOwoKICAvKioKICAgKiBVcGdyYWRlIHN0YXRlcy4KICAgKgogICAqIC0gTm90QWxsb3dlZDogVGhlIGNoaWxkIGNvbnRyYWN0IGhhcyBub3QgcmVhY2hlZCBhIGNvbmRpdGlvbiB3aGVyZSB0aGUgdXBncmFkZSBjYW4gYmd1bgogICAqIC0gV2FpdGluZ0ZvckFnZW50OiBUb2tlbiBhbGxvd3MgdXBncmFkZSwgYnV0IHdlIGRvbid0IGhhdmUgYSBuZXcgYWdlbnQgeWV0CiAgICogLSBSZWFkeVRvVXBncmFkZTogVGhlIGFnZW50IGlzIHNldCwgYnV0IG5vdCBhIHNpbmdsZSB0b2tlbiBoYXMgYmVlbiB1cGdyYWRlZCB5ZXQKICAgKiAtIFVwZ3JhZGluZzogVXBncmFkZSBhZ2VudCBpcyBzZXQgYW5kIHRoZSBiYWxhbmNlIGhvbGRlcnMgY2FuIHVwZ3JhZGUgdGhlaXIgdG9rZW5zCiAgICoKICAgKi8KICBlbnVtIFVwZ3JhZGVTdGF0ZSB7VW5rbm93biwgTm90QWxsb3dlZCwgV2FpdGluZ0ZvckFnZW50LCBSZWFkeVRvVXBncmFkZSwgVXBncmFkaW5nfQoKICAvKioKICAgKiBTb21lYm9keSBoYXMgdXBncmFkZWQgc29tZSBvZiBoaXMgdG9rZW5zLgogICAqLwogIGV2ZW50IFVwZ3JhZGUoYWRkcmVzcyBpbmRleGVkIF9mcm9tLCBhZGRyZXNzIGluZGV4ZWQgX3RvLCB1aW50MjU2IF92YWx1ZSk7CgogIC8qKgogICAqIE5ldyB1cGdyYWRlIGFnZW50IGF2YWlsYWJsZS4KICAgKi8KICBldmVudCBVcGdyYWRlQWdlbnRTZXQoYWRkcmVzcyBhZ2VudCk7CgogIC8qKgogICAqIERvIG5vdCBhbGxvdyBjb25zdHJ1Y3Rpb24gd2l0aG91dCB1cGdyYWRlIG1hc3RlciBzZXQuCiAgICovCiAgZnVuY3Rpb24gVXBncmFkZWFibGVUb2tlbihhZGRyZXNzIF91cGdyYWRlTWFzdGVyKSB7CiAgICB1cGdyYWRlTWFzdGVyID0gX3VwZ3JhZGVNYXN0ZXI7CiAgfQoKICAvKioKICAgKiBBbGxvdyB0aGUgdG9rZW4gaG9sZGVyIHRvIHVwZ3JhZGUgc29tZSBvZiB0aGVpciB0b2tlbnMgdG8gYSBuZXcgY29udHJhY3QuCiAgICovCiAgZnVuY3Rpb24gdXBncmFkZSh1aW50MjU2IHZhbHVlKSBwdWJsaWMgewogICAgVXBncmFkZVN0YXRlIHN0YXRlID0gZ2V0VXBncmFkZVN0YXRlKCk7CiAgICByZXF1aXJlKChzdGF0ZSA9PSBVcGdyYWRlU3RhdGUuUmVhZHlUb1VwZ3JhZGUgfHwgc3RhdGUgPT0gVXBncmFkZVN0YXRlLlVwZ3JhZGluZykpOwogICAgLy8gaWYoIShzdGF0ZSA9PSBVcGdyYWRlU3RhdGUuUmVhZHlUb1VwZ3JhZGUgfHwgc3RhdGUgPT0gVXBncmFkZVN0YXRlLlVwZ3JhZGluZykpIHsKICAgIC8vICAgLy8gQ2FsbGVkIGluIGEgYmFkIHN0YXRlCiAgICAvLyAgIHRocm93OwogICAgLy8gfQoKICAgIC8vIFZhbGlkYXRlIGlucHV0IHZhbHVlLgogICAgcmVxdWlyZSh2YWx1ZSAhPSAwKTsKCiAgICBiYWxhbmNlc1ttc2cuc2VuZGVyXSA9IHNhZmVTdWIoYmFsYW5jZXNbbXNnLnNlbmRlcl0sdmFsdWUpOwoKICAgIC8vIFRha2UgdG9rZW5zIG91dCBmcm9tIGNpcmN1bGF0aW9uCiAgICB0b3RhbFN1cHBseSA9IHNhZmVTdWIodG90YWxTdXBwbHksdmFsdWUpOwogICAgdG90YWxVcGdyYWRlZCA9IHNhZmVBZGQodG90YWxVcGdyYWRlZCx2YWx1ZSk7CgogICAgLy8gVXBncmFkZSBhZ2VudCByZWlzc3VlcyB0aGUgdG9rZW5zCiAgICB1cGdyYWRlQWdlbnQudXBncmFkZUZyb20obXNnLnNlbmRlciwgdmFsdWUpOwogICAgVXBncmFkZShtc2cuc2VuZGVyLCB1cGdyYWRlQWdlbnQsIHZhbHVlKTsKICB9CgogIC8qKgogICAqIFNldCBhbiB1cGdyYWRlIGFnZW50IHRoYXQgaGFuZGxlcwogICAqLwogIGZ1bmN0aW9uIHNldFVwZ3JhZGVBZ2VudChhZGRyZXNzIGFnZW50KSBleHRlcm5hbCB7CiAgICByZXF1aXJlKGNhblVwZ3JhZGUoKSk7CiAgICAvLyBpZighY2FuVXBncmFkZSgpKSB7CiAgICAvLyAgIC8vIFRoZSB0b2tlbiBpcyBub3QgeWV0IGluIGEgc3RhdGUgdGhhdCB3ZSBjb3VsZCB0aGluayB1cGdyYWRpbmcKICAgIC8vICAgdGhyb3c7CiAgICAvLyB9CgogICAgcmVxdWlyZShhZ2VudCAhPSAweDApOwogICAgLy9pZiAoYWdlbnQgPT0gMHgwKSB0aHJvdzsKICAgIC8vIE9ubHkgYSBtYXN0ZXIgY2FuIGRlc2lnbmF0ZSB0aGUgbmV4dCBhZ2VudAogICAgcmVxdWlyZShtc2cuc2VuZGVyID09IHVwZ3JhZGVNYXN0ZXIpOwogICAgLy9pZiAobXNnLnNlbmRlciAhPSB1cGdyYWRlTWFzdGVyKSB0aHJvdzsKICAgIC8vIFVwZ3JhZGUgaGFzIGFscmVhZHkgYmVndW4gZm9yIGFuIGFnZW50CiAgICByZXF1aXJlKGdldFVwZ3JhZGVTdGF0ZSgpICE9IFVwZ3JhZGVTdGF0ZS5VcGdyYWRpbmcpOwogICAgLy9pZiAoZ2V0VXBncmFkZVN0YXRlKCkgPT0gVXBncmFkZVN0YXRlLlVwZ3JhZGluZykgdGhyb3c7CgogICAgdXBncmFkZUFnZW50ID0gVXBncmFkZUFnZW50KGFnZW50KTsKCiAgICAvLyBCYWQgaW50ZXJmYWNlCiAgICByZXF1aXJlKHVwZ3JhZGVBZ2VudC5pc1VwZ3JhZGVBZ2VudCgpKTsKICAgIC8vaWYoIXVwZ3JhZGVBZ2VudC5pc1VwZ3JhZGVBZ2VudCgpKSB0aHJvdzsKICAgIC8vIE1ha2Ugc3VyZSB0aGF0IHRva2VuIHN1cHBsaWVzIG1hdGNoIGluIHNvdXJjZSBhbmQgdGFyZ2V0CiAgICByZXF1aXJlKHVwZ3JhZGVBZ2VudC5vcmlnaW5hbFN1cHBseSgpID09IHRvdGFsU3VwcGx5KTsKICAgIC8vaWYgKHVwZ3JhZGVBZ2VudC5vcmlnaW5hbFN1cHBseSgpICE9IHRvdGFsU3VwcGx5KSB0aHJvdzsKCiAgICBVcGdyYWRlQWdlbnRTZXQodXBncmFkZUFnZW50KTsKICB9CgogIC8qKgogICAqIEdldCB0aGUgc3RhdGUgb2YgdGhlIHRva2VuIHVwZ3JhZGUuCiAgICovCiAgZnVuY3Rpb24gZ2V0VXBncmFkZVN0YXRlKCkgcHVibGljIGNvbnN0YW50IHJldHVybnMoVXBncmFkZVN0YXRlKSB7CiAgICBpZighY2FuVXBncmFkZSgpKSByZXR1cm4gVXBncmFkZVN0YXRlLk5vdEFsbG93ZWQ7CiAgICBlbHNlIGlmKGFkZHJlc3ModXBncmFkZUFnZW50KSA9PSAweDAwKSByZXR1cm4gVXBncmFkZVN0YXRlLldhaXRpbmdGb3JBZ2VudDsKICAgIGVsc2UgaWYodG90YWxVcGdyYWRlZCA9PSAwKSByZXR1cm4gVXBncmFkZVN0YXRlLlJlYWR5VG9VcGdyYWRlOwogICAgZWxzZSByZXR1cm4gVXBncmFkZVN0YXRlLlVwZ3JhZGluZzsKICB9CgogIC8qKgogICAqIENoYW5nZSB0aGUgdXBncmFkZSBtYXN0ZXIuCiAgICoKICAgKiBUaGlzIGFsbG93cyB1cyB0byBzZXQgYSBuZXcgb3duZXIgZm9yIHRoZSB1cGdyYWRlIG1lY2hhbmlzbS4KICAgKi8KICBmdW5jdGlvbiBzZXRVcGdyYWRlTWFzdGVyKGFkZHJlc3MgbWFzdGVyKSBwdWJsaWMgewogICAgcmVxdWlyZShtYXN0ZXIgIT0gMHgwKTsKICAgIC8vaWYgKG1hc3RlciA9PSAweDApIHRocm93OwogICAgcmVxdWlyZShtc2cuc2VuZGVyID09IHVwZ3JhZGVNYXN0ZXIpOwogICAgLy9pZiAobXNnLnNlbmRlciAhPSB1cGdyYWRlTWFzdGVyKSB0aHJvdzsKICAgIHVwZ3JhZGVNYXN0ZXIgPSBtYXN0ZXI7CiAgfQoKICAvKioKICAgKiBDaGlsZCBjb250cmFjdCBjYW4gZW5hYmxlIHRvIHByb3ZpZGUgdGhlIGNvbmRpdGlvbiB3aGVuIHRoZSB1cGdyYWRlIGNhbiBiZWd1bi4KICAgKi8KICBmdW5jdGlvbiBjYW5VcGdyYWRlKCkgcHVibGljIGNvbnN0YW50IHJldHVybnMoYm9vbCkgewogICAgIHJldHVybiB0cnVlOwogIH0KCn0KCi8qKgogKiBEZWZpbmUgaW50ZXJmYWNlIGZvciByZWxlYXNpbmcgdGhlIHRva2VuIHRyYW5zZmVyIGFmdGVyIGEgc3VjY2Vzc2Z1bCBjcm93ZHNhbGUuCiAqLwpjb250cmFjdCBSZWxlYXNhYmxlVG9rZW4gaXMgRVJDMjAsIE93bmFibGUgewoKICAvKiBUaGUgZmluYWxpemVyIGNvbnRyYWN0IHRoYXQgYWxsb3dzIHVubGlmdCB0aGUgdHJhbnNmZXIgbGltaXRzIG9uIHRoaXMgdG9rZW4gKi8KICBhZGRyZXNzIHB1YmxpYyByZWxlYXNlQWdlbnQ7CgogIC8qKiBBIGNyb3dkc2FsZSBjb250cmFjdCBjYW4gcmVsZWFzZSB1cyB0byB0aGUgd2lsZCBpZiBJQ08gc3VjY2Vzcy4gSWYgZmFsc2Ugd2UgYXJlIGFyZSBpbiB0cmFuc2ZlciBsb2NrIHVwIHBlcmlvZC4qLwogIGJvb2wgcHVibGljIHJlbGVhc2VkID0gZmFsc2U7CgogIC8qKiBNYXAgb2YgYWdlbnRzIHRoYXQgYXJlIGFsbG93ZWQgdG8gdHJhbnNmZXIgdG9rZW5zIHJlZ2FyZGxlc3Mgb2YgdGhlIGxvY2sgZG93biBwZXJpb2QuIFRoZXNlIGFyZSBjcm93ZHNhbGUgY29udHJhY3RzIGFuZCBwb3NzaWJsZSB0aGUgdGVhbSBtdWx0aXNpZyBpdHNlbGYuICovCiAgbWFwcGluZyAoYWRkcmVzcyA9PiBib29sKSBwdWJsaWMgdHJhbnNmZXJBZ2VudHM7CgogIC8qKgogICAqIExpbWl0IHRva2VuIHRyYW5zZmVyIHVudGlsIHRoZSBjcm93ZHNhbGUgaXMgb3Zlci4KICAgKgogICAqLwogIG1vZGlmaWVyIGNhblRyYW5zZmVyKGFkZHJlc3MgX3NlbmRlcikgewoKICAgIGlmKCFyZWxlYXNlZCkgewogICAgICAgIHJlcXVpcmUodHJhbnNmZXJBZ2VudHNbX3NlbmRlcl0pOwogICAgICAgIC8vIGlmKCF0cmFuc2ZlckFnZW50c1tfc2VuZGVyXSkgewogICAgICAgIC8vICAgICB0aHJvdzsKICAgICAgICAvLyB9CiAgICB9CgogICAgXzsKICB9CgogIC8qKgogICAqIFNldCB0aGUgY29udHJhY3QgdGhhdCBjYW4gY2FsbCByZWxlYXNlIGFuZCBtYWtlIHRoZSB0b2tlbiB0cmFuc2ZlcmFibGUuCiAgICoKICAgKiBEZXNpZ24gY2hvaWNlLiBBbGxvdyByZXNldCB0aGUgcmVsZWFzZSBhZ2VudCB0byBmaXggZmF0IGZpbmdlciBtaXN0YWtlcy4KICAgKi8KICBmdW5jdGlvbiBzZXRSZWxlYXNlQWdlbnQoYWRkcmVzcyBhZGRyKSBvbmx5T3duZXIgaW5SZWxlYXNlU3RhdGUoZmFsc2UpIHB1YmxpYyB7CgogICAgLy8gV2UgZG9uJ3QgZG8gaW50ZXJmYWNlIGNoZWNrIGhlcmUgYXMgd2UgbWlnaHQgd2FudCB0byBhIG5vcm1hbCB3YWxsZXQgYWRkcmVzcyB0byBhY3QgYXMgYSByZWxlYXNlIGFnZW50CiAgICByZWxlYXNlQWdlbnQgPSBhZGRyOwogIH0KCiAgLyoqCiAgICogT3duZXIgY2FuIGFsbG93IGEgcGFydGljdWxhciBhZGRyZXNzIChhIGNyb3dkc2FsZSBjb250cmFjdCkgdG8gdHJhbnNmZXIgdG9rZW5zIGRlc3BpdGUgdGhlIGxvY2sgdXAgcGVyaW9kLgogICAqLwogIGZ1bmN0aW9uIHNldFRyYW5zZmVyQWdlbnQoYWRkcmVzcyBhZGRyLCBib29sIHN0YXRlKSBvbmx5T3duZXIgaW5SZWxlYXNlU3RhdGUoZmFsc2UpIHB1YmxpYyB7CiAgICB0cmFuc2ZlckFnZW50c1thZGRyXSA9IHN0YXRlOwogIH0KCiAgLyoqCiAgICogT25lIHdheSBmdW5jdGlvbiB0byByZWxlYXNlIHRoZSB0b2tlbnMgdG8gdGhlIHdpbGQuCiAgICoKICAgKiBDYW4gYmUgY2FsbGVkIG9ubHkgZnJvbSB0aGUgcmVsZWFzZSBhZ2VudCB0aGF0IGlzIHRoZSBmaW5hbCBJQ08gY29udHJhY3QuIEl0IGlzIG9ubHkgY2FsbGVkIGlmIHRoZSBjcm93ZHNhbGUgaGFzIGJlZW4gc3VjY2VzcyAoZmlyc3QgbWlsZXN0b25lIHJlYWNoZWQpLgogICAqLwogIGZ1bmN0aW9uIHJlbGVhc2VUb2tlblRyYW5zZmVyKCkgcHVibGljIG9ubHlSZWxlYXNlQWdlbnQgewogICAgcmVsZWFzZWQgPSB0cnVlOwogIH0KCiAgLyoqIFRoZSBmdW5jdGlvbiBjYW4gYmUgY2FsbGVkIG9ubHkgYmVmb3JlIG9yIGFmdGVyIHRoZSB0b2tlbnMgaGF2ZSBiZWVuIHJlbGVhc2VzZCAqLwogIG1vZGlmaWVyIGluUmVsZWFzZVN0YXRlKGJvb2wgcmVsZWFzZVN0YXRlKSB7CiAgICByZXF1aXJlKHJlbGVhc2VTdGF0ZSA9PSByZWxlYXNlZCk7CiAgICAvLyBpZihyZWxlYXNlU3RhdGUgIT0gcmVsZWFzZWQpIHsKICAgIC8vICAgICB0aHJvdzsKICAgIC8vIH0KICAgIF87CiAgfQoKICAvKiogVGhlIGZ1bmN0aW9uIGNhbiBiZSBjYWxsZWQgb25seSBieSBhIHdoaXRlbGlzdGVkIHJlbGVhc2UgYWdlbnQuICovCiAgbW9kaWZpZXIgb25seVJlbGVhc2VBZ2VudCgpIHsKICAgIHJlcXVpcmUobXNnLnNlbmRlciA9PSByZWxlYXNlQWdlbnQpOwogICAgLy8gaWYobXNnLnNlbmRlciAhPSByZWxlYXNlQWdlbnQpIHsKICAgIC8vICAgICB0aHJvdzsKICAgIC8vIH0KICAgIF87CiAgfQoKICBmdW5jdGlvbiB0cmFuc2ZlcihhZGRyZXNzIF90bywgdWludCBfdmFsdWUpIGNhblRyYW5zZmVyKG1zZy5zZW5kZXIpIHJldHVybnMgKGJvb2wgc3VjY2VzcykgewogICAgLy8gQ2FsbCBTdGFuZGFyZFRva2VuLnRyYW5zZmVyKCkKICAgcmV0dXJuIHN1cGVyLnRyYW5zZmVyKF90bywgX3ZhbHVlKTsKICB9CgogIGZ1bmN0aW9uIHRyYW5zZmVyRnJvbShhZGRyZXNzIF9mcm9tLCBhZGRyZXNzIF90bywgdWludCBfdmFsdWUpIGNhblRyYW5zZmVyKF9mcm9tKSByZXR1cm5zIChib29sIHN1Y2Nlc3MpIHsKICAgIC8vIENhbGwgU3RhbmRhcmRUb2tlbi50cmFuc2ZlckZvcm0oKQogICAgcmV0dXJuIHN1cGVyLnRyYW5zZmVyRnJvbShfZnJvbSwgX3RvLCBfdmFsdWUpOwogIH0KCn0KCi8qKgogKiBBIHRva2VuIHRoYXQgY2FuIGluY3JlYXNlIGl0cyBzdXBwbHkgYnkgYW5vdGhlciBjb250cmFjdC4KICoKICogVGhpcyBhbGxvd3MgdW5jYXBwZWQgY3Jvd2RzYWxlIGJ5IGR5bmFtaWNhbGx5IGluY3JlYXNpbmcgdGhlIHN1cHBseSB3aGVuIG1vbmV5IHBvdXJzIGluLgogKiBPbmx5IG1pbnQgYWdlbnRzLCBjb250cmFjdHMgd2hpdGVsaXN0ZWQgYnkgb3duZXIsIGNhbiBtaW50IG5ldyB0b2tlbnMuCiAqCiAqLwpjb250cmFjdCBNaW50YWJsZVRva2VuIGlzIFN0YW5kYXJkVG9rZW4sIE93bmFibGUgewoKICBib29sIHB1YmxpYyBtaW50aW5nRmluaXNoZWQgPSBmYWxzZTsKCiAgLyoqIExpc3Qgb2YgYWdlbnRzIHRoYXQgYXJlIGFsbG93ZWQgdG8gY3JlYXRlIG5ldyB0b2tlbnMgKi8KICBtYXBwaW5nIChhZGRyZXNzID0+IGJvb2wpIHB1YmxpYyBtaW50QWdlbnRzOwoKICBldmVudCBNaW50aW5nQWdlbnRDaGFuZ2VkKGFkZHJlc3MgYWRkciwgYm9vbCBzdGF0ZSAgKTsKCiAgLyoqCiAgICogQ3JlYXRlIG5ldyB0b2tlbnMgYW5kIGFsbG9jYXRlIHRoZW0gdG8gYW4gYWRkcmVzcy4uCiAgICoKICAgKiBPbmx5IGNhbGxhYmx5IGJ5IGEgY3Jvd2RzYWxlIGNvbnRyYWN0IChtaW50IGFnZW50KS4KICAgKi8KICBmdW5jdGlvbiBtaW50KGFkZHJlc3MgcmVjZWl2ZXIsIHVpbnQgYW1vdW50KSBvbmx5TWludEFnZW50IGNhbk1pbnQgcHVibGljIHsKICAgIHRvdGFsU3VwcGx5ID0gc2FmZUFkZCh0b3RhbFN1cHBseSwgYW1vdW50KTsKICAgIGJhbGFuY2VzW3JlY2VpdmVyXSA9IHNhZmVBZGQoYmFsYW5jZXNbcmVjZWl2ZXJdLCBhbW91bnQpOwoKICAgIC8vIFRoaXMgd2lsbCBtYWtlIHRoZSBtaW50IHRyYW5zYWN0aW9uIGFwcGVyIGluIEV0aGVyU2Nhbi5pbwogICAgLy8gV2UgY2FuIHJlbW92ZSB0aGlzIGFmdGVyIHRoZXJlIGlzIGEgc3RhbmRhcmRpemVkIG1pbnRpbmcgZXZlbnQKICAgIFRyYW5zZmVyKDAsIHJlY2VpdmVyLCBhbW91bnQpOwogIH0KCiAgLyoqCiAgICogT3duZXIgY2FuIGFsbG93IGEgY3Jvd2RzYWxlIGNvbnRyYWN0IHRvIG1pbnQgbmV3IHRva2Vucy4KICAgKi8KICBmdW5jdGlvbiBzZXRNaW50QWdlbnQoYWRkcmVzcyBhZGRyLCBib29sIHN0YXRlKSBvbmx5T3duZXIgY2FuTWludCBwdWJsaWMgewogICAgbWludEFnZW50c1thZGRyXSA9IHN0YXRlOwogICAgTWludGluZ0FnZW50Q2hhbmdlZChhZGRyLCBzdGF0ZSk7CiAgfQoKICBtb2RpZmllciBvbmx5TWludEFnZW50KCkgewogICAgLy8gT25seSBjcm93ZHNhbGUgY29udHJhY3RzIGFyZSBhbGxvd2VkIHRvIG1pbnQgbmV3IHRva2VucwogICAgcmVxdWlyZShtaW50QWdlbnRzW21zZy5zZW5kZXJdKTsKICAgIC8vIGlmKCFtaW50QWdlbnRzW21zZy5zZW5kZXJdKSB7CiAgICAvLyAgICAgdGhyb3c7CiAgICAvLyB9CiAgICBfOwogIH0KCiAgLyoqIE1ha2Ugc3VyZSB3ZSBhcmUgbm90IGRvbmUgeWV0LiAqLwogIG1vZGlmaWVyIGNhbk1pbnQoKSB7CiAgICByZXF1aXJlKCFtaW50aW5nRmluaXNoZWQpOwogICAgLy9pZihtaW50aW5nRmluaXNoZWQpIHRocm93OwogICAgXzsKICB9Cn0KCmNvbnRyYWN0IEFsbG9jYXRhYmxlIGlzIE93bmFibGUgewoKICAvKiogTGlzdCBvZiBhZ2VudHMgdGhhdCBhcmUgYWxsb3dlZCB0byBhbGxvY2F0ZSBuZXcgdG9rZW5zICovCiAgbWFwcGluZyAoYWRkcmVzcyA9PiBib29sKSBwdWJsaWMgYWxsb2NhdGVBZ2VudHM7CgogIGV2ZW50IEFsbG9jYXRlQWdlbnRDaGFuZ2VkKGFkZHJlc3MgYWRkciwgYm9vbCBzdGF0ZSAgKTsKCiAgLyoqCiAgICogT3duZXIgY2FuIGFsbG93IGEgY3Jvd2RzYWxlIGNvbnRyYWN0IHRvIGFsbG9jYXRlIG5ldyB0b2tlbnMuCiAgICovCiAgZnVuY3Rpb24gc2V0QWxsb2NhdGVBZ2VudChhZGRyZXNzIGFkZHIsIGJvb2wgc3RhdGUpIG9ubHlPd25lciBwdWJsaWMgewogICAgYWxsb2NhdGVBZ2VudHNbYWRkcl0gPSBzdGF0ZTsKICAgIEFsbG9jYXRlQWdlbnRDaGFuZ2VkKGFkZHIsIHN0YXRlKTsKICB9CgogIG1vZGlmaWVyIG9ubHlBbGxvY2F0ZUFnZW50KCkgewogICAgLy8gT25seSBjcm93ZHNhbGUgY29udHJhY3RzIGFyZSBhbGxvd2VkIHRvIGFsbG9jYXRlIG5ldyB0b2tlbnMKICAgIHJlcXVpcmUoYWxsb2NhdGVBZ2VudHNbbXNnLnNlbmRlcl0pOwogICAgXzsKICB9Cn0KCi8qKgogKiBBIGNyb3dkc2FsZWQgdG9rZW4uCiAqCiAqIEFuIEVSQy0yMCB0b2tlbiBkZXNpZ25lZCBzcGVjaWZpY2FsbHkgZm9yIGNyb3dkc2FsZXMgd2l0aCBpbnZlc3RvciBwcm90ZWN0aW9uIGFuZCBmdXJ0aGVyIGRldmVsb3BtZW50IHBhdGguCiAqCiAqIC0gVGhlIHRva2VuIHRyYW5zZmVyKCkgaXMgZGlzYWJsZWQgdW50aWwgdGhlIGNyb3dkc2FsZSBpcyBvdmVyCiAqIC0gVGhlIHRva2VuIGNvbnRyYWN0IGdpdmVzIGFuIG9wdC1pbiB1cGdyYWRlIHBhdGggdG8gYSBuZXcgY29udHJhY3QKICogLSBUaGUgc2FtZSB0b2tlbiBjYW4gYmUgcGFydCBvZiBzZXZlcmFsIGNyb3dkc2FsZXMgdGhyb3VnaCBhcHByb3ZlKCkgbWVjaGFuaXNtCiAqIC0gVGhlIHRva2VuIGNhbiBiZSBjYXBwZWQgKHN1cHBseSBzZXQgaW4gdGhlIGNvbnN0cnVjdG9yKSBvciB1bmNhcHBlZCAoY3Jvd2RzYWxlIGNvbnRyYWN0IGNhbiBtaW50IG5ldyB0b2tlbnMpCiAqCiAqLwogY29udHJhY3QgQ3Jvd2RzYWxlVG9rZW4gaXMgUmVsZWFzYWJsZVRva2VuLCBNaW50YWJsZVRva2VuLCBVcGdyYWRlYWJsZVRva2VuIHsKCiAgZXZlbnQgVXBkYXRlZFRva2VuSW5mb3JtYXRpb24oc3RyaW5nIG5ld05hbWUsIHN0cmluZyBuZXdTeW1ib2wpOwoKICBzdHJpbmcgcHVibGljIG5hbWU7CgogIHN0cmluZyBwdWJsaWMgc3ltYm9sOwoKICB1aW50OCBwdWJsaWMgZGVjaW1hbHM7CgogIC8qKgogICAqIENvbnN0cnVjdCB0aGUgdG9rZW4uCiAgICoKICAgKiBUaGlzIHRva2VuIG11c3QgYmUgY3JlYXRlZCB0aHJvdWdoIGEgdGVhbSBtdWx0aXNpZyB3YWxsZXQsIHNvIHRoYXQgaXQgaXMgb3duZWQgYnkgdGhhdCB3YWxsZXQuCiAgICoKICAgKiBAcGFyYW0gX25hbWUgVG9rZW4gbmFtZQogICAqIEBwYXJhbSBfc3ltYm9sIFRva2VuIHN5bWJvbCAtIHNob3VsZCBiZSBhbGwgY2FwcwogICAqIEBwYXJhbSBfaW5pdGlhbFN1cHBseSBIb3cgbWFueSB0b2tlbnMgd2Ugc3RhcnQgd2l0aAogICAqIEBwYXJhbSBfZGVjaW1hbHMgTnVtYmVyIG9mIGRlY2ltYWwgcGxhY2VzCiAgICogQHBhcmFtIF9taW50YWJsZSBBcmUgbmV3IHRva2VucyBjcmVhdGVkIG92ZXIgdGhlIGNyb3dkc2FsZSBvciBkbyB3ZSBkaXN0cmlidXRlIG9ubHkgdGhlIGluaXRpYWwgc3VwcGx5PyBOb3RlIHRoYXQgd2hlbiB0aGUgdG9rZW4gYmVjb21lcyB0cmFuc2ZlcmFibGUgdGhlIG1pbnRpbmcgYWx3YXlzIGVuZHMuCiAgICovCiAgZnVuY3Rpb24gQ3Jvd2RzYWxlVG9rZW4oc3RyaW5nIF9uYW1lLCBzdHJpbmcgX3N5bWJvbCwgdWludCBfaW5pdGlhbFN1cHBseSwgdWludDggX2RlY2ltYWxzLCBib29sIF9taW50YWJsZSkKICAgIFVwZ3JhZGVhYmxlVG9rZW4obXNnLnNlbmRlcikgCiAgewoKICAgIC8vIENyZWF0ZSBhbnkgYWRkcmVzcywgY2FuIGJlIHRyYW5zZmVycmVkCiAgICAvLyB0byB0ZWFtIG11bHRpc2lnIHZpYSBjaGFuZ2VPd25lcigpLAogICAgLy8gYWxzbyByZW1lbWJlciB0byBjYWxsIHNldFVwZ3JhZGVNYXN0ZXIoKQogICAgb3duZXIgPSBtc2cuc2VuZGVyOwoKICAgIG5hbWUgPSBfbmFtZTsKICAgIHN5bWJvbCA9IF9zeW1ib2w7CgogICAgdG90YWxTdXBwbHkgPSBfaW5pdGlhbFN1cHBseTsKCiAgICBkZWNpbWFscyA9IF9kZWNpbWFsczsKCiAgICAvLyBDcmVhdGUgaW5pdGlhbGx5IGFsbCBiYWxhbmNlIG9uIHRoZSB0ZWFtIG11bHRpc2lnCiAgICBiYWxhbmNlc1tvd25lcl0gPSB0b3RhbFN1cHBseTsKCiAgICBpZih0b3RhbFN1cHBseSA+IDApIHsKICAgICAgTWludGVkKG93bmVyLCB0b3RhbFN1cHBseSk7CiAgICB9CgogICAgLy8gTm8gbW9yZSBuZXcgc3VwcGx5IGFsbG93ZWQgYWZ0ZXIgdGhlIHRva2VuIGNyZWF0aW9uCiAgICBpZighX21pbnRhYmxlKSB7CiAgICAgIG1pbnRpbmdGaW5pc2hlZCA9IHRydWU7CiAgICAgIHJlcXVpcmUodG90YWxTdXBwbHkgIT0gMCk7CiAgICB9CiAgfQoKICAvKioKICAgKiBXaGVuIHRva2VuIGlzIHJlbGVhc2VkIHRvIGJlIHRyYW5zZmVyYWJsZSwgZW5mb3JjZSBubyBuZXcgdG9rZW5zIGNhbiBiZSBjcmVhdGVkLgogICAqLwogIGZ1bmN0aW9uIHJlbGVhc2VUb2tlblRyYW5zZmVyKCkgcHVibGljIG9ubHlSZWxlYXNlQWdlbnQgewogICAgbWludGluZ0ZpbmlzaGVkID0gdHJ1ZTsKICAgIHN1cGVyLnJlbGVhc2VUb2tlblRyYW5zZmVyKCk7CiAgfQogIAoKICAvKioKICAgKiBBbGxvdyB1cGdyYWRlIGFnZW50IGZ1bmN0aW9uYWxpdHkga2ljayBpbiBvbmx5IGlmIHRoZSBjcm93ZHNhbGUgd2FzIHN1Y2Nlc3MuCiAgICovCiAgZnVuY3Rpb24gY2FuVXBncmFkZSgpIHB1YmxpYyBjb25zdGFudCByZXR1cm5zKGJvb2wpIHsKICAgIHJldHVybiByZWxlYXNlZCAmJiBzdXBlci5jYW5VcGdyYWRlKCk7CiAgfQoKICAvKioKICAgKiBPd25lciBjYW4gdXBkYXRlIHRva2VuIGluZm9ybWF0aW9uIGhlcmUKICAgKi8KICBmdW5jdGlvbiBzZXRUb2tlbkluZm9ybWF0aW9uKHN0cmluZyBfbmFtZSwgc3RyaW5nIF9zeW1ib2wpIG9ubHlPd25lciB7CiAgICBuYW1lID0gX25hbWU7CiAgICBzeW1ib2wgPSBfc3ltYm9sOwogICAgVXBkYXRlZFRva2VuSW5mb3JtYXRpb24obmFtZSwgc3ltYm9sKTsKICB9CgoKfQoKCgovKioKICogRmluYWxpemUgYWdlbnQgZGVmaW5lcyB3aGF0IGhhcHBlbnMgYXQgdGhlIGVuZCBvZiBzdWNjZXNlZnVsIGNyb3dkc2FsZS4KICoKICogLSBBbGxvY2F0ZSB0b2tlbnMgZm9yIGZvdW5kZXJzLCBib3VudGllcyBhbmQgY29tbXVuaXR5CiAqIC0gTWFrZSB0b2tlbnMgdHJhbnNmZXJhYmxlCiAqIC0gZXRjLgogKi8KY29udHJhY3QgRmluYWxpemVBZ2VudCB7CgogIGZ1bmN0aW9uIGlzRmluYWxpemVBZ2VudCgpIHB1YmxpYyBjb25zdGFudCByZXR1cm5zKGJvb2wpIHsKICAgIHJldHVybiB0cnVlOwogIH0KCiAgLyoqIFJldHVybiB0cnVlIGlmIHdlIGNhbiBydW4gZmluYWxpemVDcm93ZHNhbGUoKSBwcm9wZXJseS4KICAgKgogICAqIFRoaXMgaXMgYSBzYWZldHkgY2hlY2sgZnVuY3Rpb24gdGhhdCBkb2Vzbid0IGFsbG93IGNyb3dkc2FsZSB0byBiZWdpbgogICAqIHVubGVzcyB0aGUgZmluYWxpemVyIGhhcyBiZWVuIHNldCB1cCBwcm9wZXJseS4KICAgKi8KICBmdW5jdGlvbiBpc1NhbmUoKSBwdWJsaWMgY29uc3RhbnQgcmV0dXJucyAoYm9vbCk7CgogIC8qKiBDYWxsZWQgb25jZSBieSBjcm93ZHNhbGUgZmluYWxpemUoKSBpZiB0aGUgc2FsZSB3YXMgc3VjY2Vzcy4gKi8KICBmdW5jdGlvbiBmaW5hbGl6ZUNyb3dkc2FsZSgpOwoKfQoKLyoqCiAqIEludGVyZmFjZSBmb3IgZGVmaW5pbmcgY3Jvd2RzYWxlIHByaWNpbmcuCiAqLwpjb250cmFjdCBQcmljaW5nU3RyYXRlZ3kgewoKICAvKiogSW50ZXJmYWNlIGRlY2xhcmF0aW9uLiAqLwogIGZ1bmN0aW9uIGlzUHJpY2luZ1N0cmF0ZWd5KCkgcHVibGljIGNvbnN0YW50IHJldHVybnMgKGJvb2wpIHsKICAgIHJldHVybiB0cnVlOwogIH0KCiAgLyoqIFNlbGYgY2hlY2sgaWYgYWxsIHJlZmVyZW5jZXMgYXJlIGNvcnJlY3RseSBzZXQuCiAgICoKICAgKiBDaGVja3MgdGhhdCBwcmljaW5nIHN0cmF0ZWd5IG1hdGNoZXMgY3Jvd2RzYWxlIHBhcmFtZXRlcnMuCiAgICovCiAgZnVuY3Rpb24gaXNTYW5lKGFkZHJlc3MgY3Jvd2RzYWxlKSBwdWJsaWMgY29uc3RhbnQgcmV0dXJucyAoYm9vbCkgewogICAgcmV0dXJuIHRydWU7CiAgfQoKICAvKioKICAgKiBXaGVuIHNvbWVib2R5IHRyaWVzIHRvIGJ1eSB0b2tlbnMgZm9yIFggZXRoLCBjYWxjdWxhdGUgaG93IG1hbnkgdG9rZW5zIHRoZXkgZ2V0LgogICAqCiAgICoKICAgKiBAcGFyYW0gdmFsdWUgLSBXaGF0IGlzIHRoZSB2YWx1ZSBvZiB0aGUgdHJhbnNhY3Rpb24gc2VuZCBpbiBhcyB3ZWkKICAgKiBAcGFyYW0gdG9rZW5zU29sZCAtIGhvdyBtdWNoIHRva2VucyBoYXZlIGJlZW4gc29sZCB0aGlzIGZhcgogICAqIEBwYXJhbSB3ZWlSYWlzZWQgLSBob3cgbXVjaCBtb25leSBoYXMgYmVlbiByYWlzZWQgdGhpcyBmYXIKICAgKiBAcGFyYW0gbXNnU2VuZGVyIC0gd2hvIGlzIHRoZSBpbnZlc3RvciBvZiB0aGlzIHRyYW5zYWN0aW9uCiAgICogQHBhcmFtIGRlY2ltYWxzIC0gaG93IG1hbnkgZGVjaW1hbCB1bml0cyB0aGUgdG9rZW4gaGFzCiAgICogQHJldHVybiBBbW91bnQgb2YgdG9rZW5zIHRoZSBpbnZlc3RvciByZWNlaXZlcwogICAqLwogIGZ1bmN0aW9uIGNhbGN1bGF0ZVByaWNlKHVpbnQgdmFsdWUsIHVpbnQgd2VpUmFpc2VkLCB1aW50IHRva2Vuc1NvbGQsIGFkZHJlc3MgbXNnU2VuZGVyLCB1aW50IGRlY2ltYWxzKSBwdWJsaWMgY29uc3RhbnQgcmV0dXJucyAodWludCB0b2tlbkFtb3VudCk7Cn0KCi8qCiAqIEhhbHRhYmxlCiAqCiAqIEFic3RyYWN0IGNvbnRyYWN0IHRoYXQgYWxsb3dzIGNoaWxkcmVuIHRvIGltcGxlbWVudCBhbgogKiBlbWVyZ2VuY3kgc3RvcCBtZWNoYW5pc20uIERpZmZlcnMgZnJvbSBQYXVzYWJsZSBieSBjYXVzaW5nIGEgdGhyb3cgd2hlbiBpbiBoYWx0IG1vZGUuCiAqCiAqCiAqIE9yaWdpbmFsbHkgZW52aXNpb25lZCBpbiBGaXJzdEJsb29kIElDTyBjb250cmFjdC4KICovCmNvbnRyYWN0IEhhbHRhYmxlIGlzIE93bmFibGUgewogIGJvb2wgcHVibGljIGhhbHRlZDsKCiAgbW9kaWZpZXIgc3RvcEluRW1lcmdlbmN5IHsKICAgIHJlcXVpcmUoIWhhbHRlZCk7CiAgICAvL2lmIChoYWx0ZWQpIHRocm93OwogICAgXzsKICB9CgogIG1vZGlmaWVyIG9ubHlJbkVtZXJnZW5jeSB7CiAgICByZXF1aXJlKGhhbHRlZCk7CiAgICAvL2lmICghaGFsdGVkKSB0aHJvdzsKICAgIF87CiAgfQoKICAvLyBjYWxsZWQgYnkgdGhlIG93bmVyIG9uIGVtZXJnZW5jeSwgdHJpZ2dlcnMgc3RvcHBlZCBzdGF0ZQogIGZ1bmN0aW9uIGhhbHQoKSBleHRlcm5hbCBvbmx5T3duZXIgewogICAgaGFsdGVkID0gdHJ1ZTsKICB9CgogIC8vIGNhbGxlZCBieSB0aGUgb3duZXIgb24gZW5kIG9mIGVtZXJnZW5jeSwgcmV0dXJucyB0byBub3JtYWwgc3RhdGUKICBmdW5jdGlvbiB1bmhhbHQoKSBleHRlcm5hbCBvbmx5T3duZXIgb25seUluRW1lcmdlbmN5IHsKICAgIGhhbHRlZCA9IGZhbHNlOwogIH0KCn0KCgovKioKICogQWJzdHJhY3QgYmFzZSBjb250cmFjdCBmb3IgdG9rZW4gc2FsZXMuCiAqCiAqIEhhbmRsZQogKiAtIHN0YXJ0IGFuZCBlbmQgZGF0ZXMKICogLSBhY2NlcHRpbmcgaW52ZXN0bWVudHMKICogLSBtaW5pbXVtIGZ1bmRpbmcgZ29hbCBhbmQgcmVmdW5kCiAqIC0gdmFyaW91cyBzdGF0aXN0aWNzIGR1cmluZyB0aGUgY3Jvd2RmdW5kCiAqIC0gZGlmZmVyZW50IHByaWNpbmcgc3RyYXRlZ2llcwogKiAtIGRpZmZlcmVudCBpbnZlc3RtZW50IHBvbGljaWVzIChyZXF1aXJlIHNlcnZlciBzaWRlIGN1c3RvbWVyIGlkLCBhbGxvdyBvbmx5IHdoaXRlbGlzdGVkIGFkZHJlc3NlcykKICoKICovCmNvbnRyYWN0IENyb3dkc2FsZSBpcyBBbGxvY2F0YWJsZSwgSGFsdGFibGUsIFNhZmVNYXRoTGliIHsKCiAgLyogTWF4IGludmVzdG1lbnQgY291bnQgd2hlbiB3ZSBhcmUgc3RpbGwgYWxsb3dlZCB0byBjaGFuZ2UgdGhlIG11bHRpc2lnIGFkZHJlc3MgKi8KICB1aW50IHB1YmxpYyBNQVhfSU5WRVNUTUVOVFNfQkVGT1JFX01VTFRJU0lHX0NIQU5HRSA9IDU7CgogIC8qIFRoZSB0b2tlbiB3ZSBhcmUgc2VsbGluZyAqLwogIEZyYWN0aW9uYWxFUkMyMCBwdWJsaWMgdG9rZW47CgogIC8qIFRva2VuIFZlc3RpbmcgQ29udHJhY3QgKi8KICBhZGRyZXNzIHB1YmxpYyB0b2tlblZlc3RpbmdBZGRyZXNzOwoKICAvKiBIb3cgd2UgYXJlIGdvaW5nIHRvIHByaWNlIG91ciBvZmZlcmluZyAqLwogIFByaWNpbmdTdHJhdGVneSBwdWJsaWMgcHJpY2luZ1N0cmF0ZWd5OwoKICAvKiBQb3N0LXN1Y2Nlc3MgY2FsbGJhY2sgKi8KICBGaW5hbGl6ZUFnZW50IHB1YmxpYyBmaW5hbGl6ZUFnZW50OwoKICAvKiB0b2tlbnMgd2lsbCBiZSB0cmFuc2ZlcmVkIGZyb20gdGhpcyBhZGRyZXNzICovCiAgYWRkcmVzcyBwdWJsaWMgbXVsdGlzaWdXYWxsZXQ7CgogIC8qIGlmIHRoZSBmdW5kaW5nIGdvYWwgaXMgbm90IHJlYWNoZWQsIGludmVzdG9ycyBtYXkgd2l0aGRyYXcgdGhlaXIgZnVuZHMgKi8KICB1aW50IHB1YmxpYyBtaW5pbXVtRnVuZGluZ0dvYWw7CgogIC8qIHRoZSBVTklYIHRpbWVzdGFtcCBzdGFydCBkYXRlIG9mIHRoZSBjcm93ZHNhbGUgKi8KICB1aW50IHB1YmxpYyBzdGFydHNBdDsKCiAgLyogdGhlIFVOSVggdGltZXN0YW1wIGVuZCBkYXRlIG9mIHRoZSBjcm93ZHNhbGUgKi8KICB1aW50IHB1YmxpYyBlbmRzQXQ7CgogIC8qIHRoZSBudW1iZXIgb2YgdG9rZW5zIGFscmVhZHkgc29sZCB0aHJvdWdoIHRoaXMgY29udHJhY3QqLwogIHVpbnQgcHVibGljIHRva2Vuc1NvbGQgPSAwOwoKICAvKiBIb3cgbWFueSB3ZWkgb2YgZnVuZGluZyB3ZSBoYXZlIHJhaXNlZCAqLwogIHVpbnQgcHVibGljIHdlaVJhaXNlZCA9IDA7CgogIC8qIEhvdyBtYW55IGRpc3RpbmN0IGFkZHJlc3NlcyBoYXZlIGludmVzdGVkICovCiAgdWludCBwdWJsaWMgaW52ZXN0b3JDb3VudCA9IDA7CgogIC8qIEhvdyBtdWNoIHdlaSB3ZSBoYXZlIHJldHVybmVkIGJhY2sgdG8gdGhlIGNvbnRyYWN0IGFmdGVyIGEgZmFpbGVkIGNyb3dkZnVuZC4gKi8KICB1aW50IHB1YmxpYyBsb2FkZWRSZWZ1bmQgPSAwOwoKICAvKiBIb3cgbXVjaCB3ZWkgd2UgaGF2ZSBnaXZlbiBiYWNrIHRvIGludmVzdG9ycy4qLwogIHVpbnQgcHVibGljIHdlaVJlZnVuZGVkID0gMDsKCiAgLyogSGFzIHRoaXMgY3Jvd2RzYWxlIGJlZW4gZmluYWxpemVkICovCiAgYm9vbCBwdWJsaWMgZmluYWxpemVkOwoKICAvKiBEbyB3ZSBuZWVkIHRvIGhhdmUgdW5pcXVlIGNvbnRyaWJ1dG9yIGlkIGZvciBlYWNoIGN1c3RvbWVyICovCiAgYm9vbCBwdWJsaWMgcmVxdWlyZUN1c3RvbWVySWQ7CgogIC8qKgogICAgKiBEbyB3ZSB2ZXJpZnkgdGhhdCBjb250cmlidXRvciBoYXMgYmVlbiBjbGVhcmVkIG9uIHRoZSBzZXJ2ZXIgc2lkZSAoYWNjcmVkaXRlZCBpbnZlc3RvcnMgb25seSkuCiAgICAqIFRoaXMgbWV0aG9kIHdhcyBmaXJzdCB1c2VkIGluIEZpcnN0Qmxvb2QgY3Jvd2RzYWxlIHRvIGVuc3VyZSBhbGwgY29udHJpYnV0b3JzIGhhdmUgYWNjZXB0ZWQgdGVybXMgb24gc2FsZSAob24gdGhlIHdlYikuCiAgICAqLwogIGJvb2wgcHVibGljIHJlcXVpcmVkU2lnbmVkQWRkcmVzczsKCiAgLyogU2VydmVyIHNpZGUgYWRkcmVzcyB0aGF0IHNpZ25lZCBhbGxvd2VkIGNvbnRyaWJ1dG9ycyAoRXRoZXJldW0gYWRkcmVzc2VzKSB0aGF0IGNhbiBwYXJ0aWNpcGF0ZSB0aGUgY3Jvd2RzYWxlICovCiAgYWRkcmVzcyBwdWJsaWMgc2lnbmVyQWRkcmVzczsKCiAgLyoqIEhvdyBtdWNoIEVUSCBlYWNoIGFkZHJlc3MgaGFzIGludmVzdGVkIHRvIHRoaXMgY3Jvd2RzYWxlICovCiAgbWFwcGluZyAoYWRkcmVzcyA9PiB1aW50MjU2KSBwdWJsaWMgaW52ZXN0ZWRBbW91bnRPZjsKCiAgLyoqIEhvdyBtdWNoIHRva2VucyB0aGlzIGNyb3dkc2FsZSBoYXMgY3JlZGl0ZWQgZm9yIGVhY2ggaW52ZXN0b3IgYWRkcmVzcyAqLwogIG1hcHBpbmcgKGFkZHJlc3MgPT4gdWludDI1NikgcHVibGljIHRva2VuQW1vdW50T2Y7CgogIC8qKiBBZGRyZXNzZXMgdGhhdCBhcmUgYWxsb3dlZCB0byBpbnZlc3QgZXZlbiBiZWZvcmUgSUNPIG9mZmljYWwgb3BlbnMuIEZvciB0ZXN0aW5nLCBmb3IgSUNPIHBhcnRuZXJzLCBldGMuICovCiAgbWFwcGluZyAoYWRkcmVzcyA9PiBib29sKSBwdWJsaWMgZWFybHlQYXJ0aWNpcGFudFdoaXRlbGlzdDsKCiAgLyoqIFRoaXMgaXMgZm9yIG1hbnVsIHRlc3RpbmcgZm9yIHRoZSBpbnRlcmFjdGlvbiBmcm9tIG93bmVyIHdhbGxldC4gWW91IGNhbiBzZXQgaXQgdG8gYW55IHZhbHVlIGFuZCBpbnNwZWN0IHRoaXMgaW4gYmxvY2tjaGFpbiBleHBsb3JlciB0byBzZWUgdGhhdCBjcm93ZHNhbGUgaW50ZXJhY3Rpb24gd29ya3MuICovCiAgdWludCBwdWJsaWMgb3duZXJUZXN0VmFsdWU7CgogIC8qKiBTdGF0ZSBtYWNoaW5lCiAgICoKICAgKiAtIFByZXBhcmluZzogQWxsIGNvbnRyYWN0IGluaXRpYWxpemF0aW9uIGNhbGxzIGFuZCB2YXJpYWJsZXMgaGF2ZSBub3QgYmVlbiBzZXQgeWV0CiAgICogLSBQcmVmdW5kaW5nOiBXZSBoYXZlIG5vdCBwYXNzZWQgc3RhcnQgdGltZSB5ZXQKICAgKiAtIEZ1bmRpbmc6IEFjdGl2ZSBjcm93ZHNhbGUKICAgKiAtIFN1Y2Nlc3M6IE1pbmltdW0gZnVuZGluZyBnb2FsIHJlYWNoZWQKICAgKiAtIEZhaWx1cmU6IE1pbmltdW0gZnVuZGluZyBnb2FsIG5vdCByZWFjaGVkIGJlZm9yZSBlbmRpbmcgdGltZQogICAqIC0gRmluYWxpemVkOiBUaGUgZmluYWxpemVkIGhhcyBiZWVuIGNhbGxlZCBhbmQgc3VjY2VzZnVsbHkgZXhlY3V0ZWQKICAgKiAtIFJlZnVuZGluZzogUmVmdW5kcyBhcmUgbG9hZGVkIG9uIHRoZSBjb250cmFjdCBmb3IgcmVjbGFpbS4KICAgKi8KICBlbnVtIFN0YXRle1Vua25vd24sIFByZXBhcmluZywgUHJlRnVuZGluZywgRnVuZGluZywgU3VjY2VzcywgRmFpbHVyZSwgRmluYWxpemVkLCBSZWZ1bmRpbmd9CgogIC8vIEEgbmV3IGludmVzdG1lbnQgd2FzIG1hZGUKICBldmVudCBJbnZlc3RlZChhZGRyZXNzIGludmVzdG9yLCB1aW50IHdlaUFtb3VudCwgdWludCB0b2tlbkFtb3VudCwgc3RyaW5nIGN1c3RJZCk7CgogIC8vIFJlZnVuZCB3YXMgcHJvY2Vzc2VkIGZvciBhIGNvbnRyaWJ1dG9yCiAgZXZlbnQgUmVmdW5kKGFkZHJlc3MgaW52ZXN0b3IsIHVpbnQgd2VpQW1vdW50KTsKCiAgLy8gVGhlIHJ1bGVzIHdlcmUgY2hhbmdlZCB3aGF0IGtpbmQgb2YgaW52ZXN0bWVudHMgd2UgYWNjZXB0CiAgZXZlbnQgSW52ZXN0bWVudFBvbGljeUNoYW5nZWQoYm9vbCByZXF1aXJlQ3VzdElkLCBib29sIHJlcXVpcmVkU2lnbmVkQWRkciwgYWRkcmVzcyBzaWduZXJBZGRyKTsKCiAgLy8gQWRkcmVzcyBlYXJseSBwYXJ0aWNpcGF0aW9uIHdoaXRlbGlzdCBzdGF0dXMgY2hhbmdlZAogIGV2ZW50IFdoaXRlbGlzdGVkKGFkZHJlc3MgYWRkciwgYm9vbCBzdGF0dXMpOwoKICAvLyBDcm93ZHNhbGUgZW5kIHRpbWUgaGFzIGJlZW4gY2hhbmdlZAogIGV2ZW50IEVuZHNBdENoYW5nZWQodWludCBlbmRBdCk7CgogIGZ1bmN0aW9uIENyb3dkc2FsZShhZGRyZXNzIF90b2tlbiwgUHJpY2luZ1N0cmF0ZWd5IF9wcmljaW5nU3RyYXRlZ3ksIGFkZHJlc3MgX211bHRpc2lnV2FsbGV0LCAKICB1aW50IF9zdGFydCwgdWludCBfZW5kLCB1aW50IF9taW5pbXVtRnVuZGluZ0dvYWwsIGFkZHJlc3MgX3Rva2VuVmVzdGluZ0FkZHJlc3MpIHsKCiAgICBvd25lciA9IG1zZy5zZW5kZXI7CgogICAgdG9rZW4gPSBGcmFjdGlvbmFsRVJDMjAoX3Rva2VuKTsKCiAgICB0b2tlblZlc3RpbmdBZGRyZXNzID0gX3Rva2VuVmVzdGluZ0FkZHJlc3M7CgogICAgc2V0UHJpY2luZ1N0cmF0ZWd5KF9wcmljaW5nU3RyYXRlZ3kpOwoKICAgIG11bHRpc2lnV2FsbGV0ID0gX211bHRpc2lnV2FsbGV0OwogICAgcmVxdWlyZShtdWx0aXNpZ1dhbGxldCAhPSAwKTsKICAgIC8vIGlmKG11bHRpc2lnV2FsbGV0ID09IDApIHsKICAgIC8vICAgICB0aHJvdzsKICAgIC8vIH0KCiAgICByZXF1aXJlKF9zdGFydCAhPSAwKTsKICAgIC8vIGlmKF9zdGFydCA9PSAwKSB7CiAgICAvLyAgICAgdGhyb3c7CiAgICAvLyB9CgogICAgc3RhcnRzQXQgPSBfc3RhcnQ7CgogICAgcmVxdWlyZShfZW5kICE9IDApOwogICAgLy8gaWYoX2VuZCA9PSAwKSB7CiAgICAvLyAgICAgdGhyb3c7CiAgICAvLyB9CgogICAgZW5kc0F0ID0gX2VuZDsKCiAgICAvLyBEb24ndCBtZXNzIHRoZSBkYXRlcwogICAgcmVxdWlyZShzdGFydHNBdCA8IGVuZHNBdCk7CiAgICAvLyBpZihzdGFydHNBdCA+PSBlbmRzQXQpIHsKICAgIC8vICAgICB0aHJvdzsKICAgIC8vIH0KCiAgICAvLyBNaW5pbXVtIGZ1bmRpbmcgZ29hbCBjYW4gYmUgemVybwogICAgbWluaW11bUZ1bmRpbmdHb2FsID0gX21pbmltdW1GdW5kaW5nR29hbDsKICB9CgogIC8qKgogICAqIERvbid0IGV4cGVjdCB0byBqdXN0IHNlbmQgaW4gbW9uZXkgYW5kIGdldCB0b2tlbnMuCiAgICovCiAgZnVuY3Rpb24oKSBwYXlhYmxlIHsKICAgIHJlcXVpcmUoZmFsc2UpOwogIH0KCiAgLyoqCiAgICogTWFrZSBhbiBpbnZlc3RtZW50LgogICAqCiAgICogQ3Jvd2RzYWxlIG11c3QgYmUgcnVubmluZyBmb3Igb25lIHRvIGludmVzdC4KICAgKiBXZSBtdXN0IGhhdmUgbm90IHByZXNzZWQgdGhlIGVtZXJnZW5jeSBicmFrZS4KICAgKgogICAqIEBwYXJhbSByZWNlaXZlciBUaGUgRXRoZXJldW0gYWRkcmVzcyB3aG8gcmVjZWl2ZXMgdGhlIHRva2VucwogICAqIEBwYXJhbSBjdXN0b21lcklkIChvcHRpb25hbCkgVVVJRCB2NCB0byB0cmFjayB0aGUgc3VjY2Vzc2Z1bCBwYXltZW50cyBvbiB0aGUgc2VydmVyIHNpZGUKICAgKgogICAqLwogIGZ1bmN0aW9uIGludmVzdEludGVybmFsKGFkZHJlc3MgcmVjZWl2ZXIsIHN0cmluZyBjdXN0b21lcklkKSBzdG9wSW5FbWVyZ2VuY3kgcHJpdmF0ZSB7CgogICAgLy8gRGV0ZXJtaW5lIGlmIGl0J3MgYSBnb29kIHRpbWUgdG8gYWNjZXB0IGludmVzdG1lbnQgZnJvbSB0aGlzIHBhcnRpY2lwYW50CiAgICBpZihnZXRTdGF0ZSgpID09IFN0YXRlLlByZUZ1bmRpbmcpIHsKICAgICAgLy8gQXJlIHdlIHdoaXRlbGlzdGVkIGZvciBlYXJseSBkZXBvc2l0CiAgICAgIHJlcXVpcmUoZWFybHlQYXJ0aWNpcGFudFdoaXRlbGlzdFtyZWNlaXZlcl0pOwogICAgICAvLyBpZighZWFybHlQYXJ0aWNpcGFudFdoaXRlbGlzdFtyZWNlaXZlcl0pIHsKICAgICAgLy8gICB0aHJvdzsKICAgICAgLy8gfQogICAgfSBlbHNlIGlmKGdldFN0YXRlKCkgPT0gU3RhdGUuRnVuZGluZykgewogICAgICAvLyBSZXRhaWwgcGFydGljaXBhbnRzIGNhbiBvbmx5IGNvbWUgaW4gd2hlbiB0aGUgY3Jvd2RzYWxlIGlzIHJ1bm5pbmcKICAgICAgLy8gcGFzcwogICAgfSBlbHNlIHsKICAgICAgLy8gVW53YW50ZWQgc3RhdGUKICAgICAgcmVxdWlyZShmYWxzZSk7CiAgICB9CgogICAgdWludCB3ZWlBbW91bnQgPSBtc2cudmFsdWU7CiAgICB1aW50IHRva2VuQW1vdW50ID0gcHJpY2luZ1N0cmF0ZWd5LmNhbGN1bGF0ZVByaWNlKHdlaUFtb3VudCwgd2VpUmFpc2VkLCB0b2tlbnNTb2xkLCBtc2cuc2VuZGVyLCB0b2tlbi5kZWNpbWFscygpKTsKCiAgICByZXF1aXJlKHRva2VuQW1vdW50ICE9IDApOwogICAgLy8gaWYodG9rZW5BbW91bnQgPT0gMCkgewogICAgLy8gICAvLyBEdXN0IHRyYW5zYWN0aW9uCiAgICAvLyAgIHRocm93OwogICAgLy8gfQoKICAgIGlmKGludmVzdGVkQW1vdW50T2ZbcmVjZWl2ZXJdID09IDApIHsKICAgICAgIC8vIEEgbmV3IGludmVzdG9yCiAgICAgICBpbnZlc3RvckNvdW50Kys7CiAgICB9CgogICAgLy8gVXBkYXRlIGludmVzdG9yCiAgICBpbnZlc3RlZEFtb3VudE9mW3JlY2VpdmVyXSA9IHNhZmVBZGQoaW52ZXN0ZWRBbW91bnRPZltyZWNlaXZlcl0sd2VpQW1vdW50KTsKICAgIHRva2VuQW1vdW50T2ZbcmVjZWl2ZXJdID0gc2FmZUFkZCh0b2tlbkFtb3VudE9mW3JlY2VpdmVyXSx0b2tlbkFtb3VudCk7CgogICAgLy8gVXBkYXRlIHRvdGFscwogICAgd2VpUmFpc2VkID0gc2FmZUFkZCh3ZWlSYWlzZWQsd2VpQW1vdW50KTsKICAgIHRva2Vuc1NvbGQgPSBzYWZlQWRkKHRva2Vuc1NvbGQsdG9rZW5BbW91bnQpOwoKICAgIC8vIENoZWNrIHRoYXQgd2UgZGlkIG5vdCBidXN0IHRoZSBjYXAKICAgIHJlcXVpcmUoIWlzQnJlYWtpbmdDYXAod2VpQW1vdW50LCB0b2tlbkFtb3VudCwgd2VpUmFpc2VkLCB0b2tlbnNTb2xkKSk7CiAgICAvLyBpZihpc0JyZWFraW5nQ2FwKHdlaUFtb3VudCwgdG9rZW5BbW91bnQsIHdlaVJhaXNlZCwgdG9rZW5zU29sZCkpIHsKICAgIC8vICAgdGhyb3c7CiAgICAvLyB9CgogICAgYXNzaWduVG9rZW5zKHJlY2VpdmVyLCB0b2tlbkFtb3VudCk7CgogICAgLy8gUG9ja2V0IHRoZSBtb25leQogICAgcmVxdWlyZShtdWx0aXNpZ1dhbGxldC5zZW5kKHdlaUFtb3VudCkpOwoKICAgIC8vIFRlbGwgdXMgaW52ZXN0IHdhcyBzdWNjZXNzCiAgICBJbnZlc3RlZChyZWNlaXZlciwgd2VpQW1vdW50LCB0b2tlbkFtb3VudCwgY3VzdG9tZXJJZCk7CiAgfQoKICAvKioKICAgKiBhbGxvY2F0ZSB0b2tlbnMgZm9yIHRoZSBlYXJseSBpbnZlc3RvcnMuCiAgICoKICAgKiBQcmVhbGxvY2F0ZWQgdG9rZW5zIGhhdmUgYmVlbiBzb2xkIGJlZm9yZSB0aGUgYWN0dWFsIGNyb3dkc2FsZSBvcGVucy4KICAgKiBUaGlzIGZ1bmN0aW9uIG1pbnRzIHRoZSB0b2tlbnMgYW5kIG1vdmVzIHRoZSBjcm93ZHNhbGUgbmVlZGxlLgogICAqCiAgICogSW52ZXN0b3IgY291bnQgaXMgbm90IGhhbmRsZWQ7IGl0IGlzIGFzc3VtZWQgdGhpcyBnb2VzIGZvciBtdWx0aXBsZSBpbnZlc3RvcnMKICAgKiBhbmQgdGhlIHRva2VuIGRpc3RyaWJ1dGlvbiBoYXBwZW5zIG91dHNpZGUgdGhlIHNtYXJ0IGNvbnRyYWN0IGZsb3cuCiAgICoKICAgKiBObyBtb25leSBpcyBleGNoYW5nZWQsIGFzIHRoZSBjcm93ZHNhbGUgdGVhbSBhbHJlYWR5IGhhdmUgcmVjZWl2ZWQgdGhlIHBheW1lbnQuCiAgICoKICAgKiBAcGFyYW0gd2VpUHJpY2UgUHJpY2Ugb2YgYSBzaW5nbGUgZnVsbCB0b2tlbiBpbiB3ZWkKICAgKgogICAqLwogIGZ1bmN0aW9uIGFsbG9jYXRlKGFkZHJlc3MgcmVjZWl2ZXIsIHVpbnQgdG9rZW5BbW91bnQsIHVpbnQgd2VpUHJpY2UsIHN0cmluZyBjdXN0b21lcklkLCAgdWludCBsb2NrZWRUb2tlbkFtb3VudCkgcHVibGljIG9ubHlBbGxvY2F0ZUFnZW50IHsKCiAgICAvLyBjYW5ub3QgbG9jayBtb3JlIHRoYW4gdG90YWwgdG9rZW5zCiAgICByZXF1aXJlKGxvY2tlZFRva2VuQW1vdW50IDw9IHRva2VuQW1vdW50KTsKCiAgICB1aW50IHdlaUFtb3VudCA9ICh3ZWlQcmljZSAqIHRva2VuQW1vdW50KS8xMCoqdWludCh0b2tlbi5kZWNpbWFscygpKTsgLy8gVGhpcyBjYW4gYmUgYWxzbyAwLCB3ZSBnaXZlIG91dCB0b2tlbnMgZm9yIGZyZWUKCiAgICB3ZWlSYWlzZWQgPSBzYWZlQWRkKHdlaVJhaXNlZCx3ZWlBbW91bnQpOwogICAgdG9rZW5zU29sZCA9IHNhZmVBZGQodG9rZW5zU29sZCx0b2tlbkFtb3VudCk7CgogICAgaW52ZXN0ZWRBbW91bnRPZltyZWNlaXZlcl0gPSBzYWZlQWRkKGludmVzdGVkQW1vdW50T2ZbcmVjZWl2ZXJdLHdlaUFtb3VudCk7CiAgICB0b2tlbkFtb3VudE9mW3JlY2VpdmVyXSA9IHNhZmVBZGQodG9rZW5BbW91bnRPZltyZWNlaXZlcl0sdG9rZW5BbW91bnQpOwoKICAgIC8vIGFzc2lnbiBsb2NrZWQgdG9rZW4gdG8gVmVzdGluZyBjb250cmFjdAogICAgaWYgKGxvY2tlZFRva2VuQW1vdW50ID4gMCkgewogICAgICBUb2tlblZlc3RpbmcgdG9rZW5WZXN0aW5nID0gVG9rZW5WZXN0aW5nKHRva2VuVmVzdGluZ0FkZHJlc3MpOwogICAgICAvLyB0byBwcmV2ZW50IG1pbnRpbmcgb2YgdG9rZW5zIHdoaWNoIHdpbGwgYmUgdXNlbGVzcyBhcyB2ZXN0aW5nIGFtb3VudCBjYW5ub3QgYmUgdXBkYXRlZAogICAgICByZXF1aXJlKCF0b2tlblZlc3RpbmcuaXNWZXN0aW5nU2V0KHJlY2VpdmVyKSk7CiAgICAgIGFzc2lnblRva2Vucyh0b2tlblZlc3RpbmdBZGRyZXNzLCBsb2NrZWRUb2tlbkFtb3VudCk7CiAgICAgIC8vIHNldCB2ZXN0aW5nIHdpdGggZGVmYXVsdCBzY2hlZHVsZQogICAgICB0b2tlblZlc3Rpbmcuc2V0VmVzdGluZ1dpdGhEZWZhdWx0U2NoZWR1bGUocmVjZWl2ZXIsIGxvY2tlZFRva2VuQW1vdW50KTsgCiAgICB9CgogICAgLy8gYXNzaWduIHJlbWFpbmluZyB0b2tlbnMgdG8gY29udHJpYnV0b3IKICAgIGlmICh0b2tlbkFtb3VudCAtIGxvY2tlZFRva2VuQW1vdW50ID4gMCkgewogICAgICBhc3NpZ25Ub2tlbnMocmVjZWl2ZXIsIHRva2VuQW1vdW50IC0gbG9ja2VkVG9rZW5BbW91bnQpOwogICAgfQoKICAgIC8vIFRlbGwgdXMgaW52ZXN0IHdhcyBzdWNjZXNzCiAgICBJbnZlc3RlZChyZWNlaXZlciwgd2VpQW1vdW50LCB0b2tlbkFtb3VudCwgY3VzdG9tZXJJZCk7CiAgfQoKICAvKioKICAgKiBBbGxvdyBhbm9ueW1vdXMgY29udHJpYnV0aW9ucyB0byB0aGlzIGNyb3dkc2FsZS4KICAgKi8KICAvLyBmdW5jdGlvbiBpbnZlc3RXaXRoU2lnbmVkQWRkcmVzcyhhZGRyZXNzIGFkZHIsIHVpbnQxMjggY3VzdG9tZXJJZCwgdWludDggdiwgYnl0ZXMzMiByLCBieXRlczMyIHMpIHB1YmxpYyBwYXlhYmxlIHsKICAvLyAgICBieXRlczMyIGhhc2ggPSBzaGEyNTYoYWRkcik7CiAgLy8gICAgaWYgKGVjcmVjb3ZlcihoYXNoLCB2LCByLCBzKSAhPSBzaWduZXJBZGRyZXNzKSB0aHJvdzsKICAvLyAgICByZXF1aXJlKGN1c3RvbWVySWQgIT0gMCk7CiAgLy8gICAgLy9pZihjdXN0b21lcklkID09IDApIHRocm93OyAgLy8gVVVJRHY0IHNhbml0eSBjaGVjawogIC8vICAgIGludmVzdEludGVybmFsKGFkZHIsIGN1c3RvbWVySWQpOwogIC8vIH0KCiAgLyoqCiAgICogVHJhY2sgd2hvIGlzIHRoZSBjdXN0b21lciBtYWtpbmcgdGhlIHBheW1lbnQgc28gd2UgY2FuIHNlbmQgdGhhbmsgeW91IGVtYWlsLgogICAqLwogIGZ1bmN0aW9uIGludmVzdFdpdGhDdXN0b21lcklkKGFkZHJlc3MgYWRkciwgc3RyaW5nIGN1c3RvbWVySWQpIHB1YmxpYyBwYXlhYmxlIHsKICAgIHJlcXVpcmUoIXJlcXVpcmVkU2lnbmVkQWRkcmVzcyk7CiAgICAvL2lmKHJlcXVpcmVkU2lnbmVkQWRkcmVzcykgdGhyb3c7IC8vIENyb3dkc2FsZSBhbGxvd3Mgb25seSBzZXJ2ZXItc2lkZSBzaWduZWQgcGFydGljaXBhbnRzCiAgICBieXRlcyBtZW1vcnkgY3VzdElkVGVzdCA9IGJ5dGVzKGN1c3RvbWVySWQpOwogICAgcmVxdWlyZShjdXN0SWRUZXN0Lmxlbmd0aCAhPSAwKTsKICAgIC8vaWYoY3VzdG9tZXJJZCA9PSAwKSB0aHJvdzsgIC8vIFVVSUR2NCBzYW5pdHkgY2hlY2sKICAgIGludmVzdEludGVybmFsKGFkZHIsIGN1c3RvbWVySWQpOwogIH0KCiAgLyoqCiAgICogQWxsb3cgYW5vbnltb3VzIGNvbnRyaWJ1dGlvbnMgdG8gdGhpcyBjcm93ZHNhbGUuCiAgICovCiAgZnVuY3Rpb24gaW52ZXN0KGFkZHJlc3MgYWRkcikgcHVibGljIHBheWFibGUgewogICAgcmVxdWlyZSghcmVxdWlyZUN1c3RvbWVySWQpOwogICAgLy9pZihyZXF1aXJlQ3VzdG9tZXJJZCkgdGhyb3c7IC8vIENyb3dkc2FsZSBuZWVkcyB0byB0cmFjayBwYXJ0aXBhbnRzIGZvciB0aGFuayB5b3UgZW1haWwKICAgIAogICAgcmVxdWlyZSghcmVxdWlyZWRTaWduZWRBZGRyZXNzKTsKICAgIC8vaWYocmVxdWlyZWRTaWduZWRBZGRyZXNzKSB0aHJvdzsgLy8gQ3Jvd2RzYWxlIGFsbG93cyBvbmx5IHNlcnZlci1zaWRlIHNpZ25lZCBwYXJ0aWNpcGFudHMKICAgIGludmVzdEludGVybmFsKGFkZHIsICIiKTsKICB9CgogIC8qKgogICAqIEludmVzdCB0byB0b2tlbnMsIHJlY29nbml6ZSB0aGUgcGF5ZXIgYW5kIGNsZWFyIGhpcyBhZGRyZXNzLgogICAqCiAgICovCiAgCiAgLy8gZnVuY3Rpb24gYnV5V2l0aFNpZ25lZEFkZHJlc3ModWludDEyOCBjdXN0b21lcklkLCB1aW50OCB2LCBieXRlczMyIHIsIGJ5dGVzMzIgcykgcHVibGljIHBheWFibGUgewogIC8vICAgaW52ZXN0V2l0aFNpZ25lZEFkZHJlc3MobXNnLnNlbmRlciwgY3VzdG9tZXJJZCwgdiwgciwgcyk7CiAgLy8gfQoKICAvKioKICAgKiBJbnZlc3QgdG8gdG9rZW5zLCByZWNvZ25pemUgdGhlIHBheWVyLgogICAqCiAgICovCiAgZnVuY3Rpb24gYnV5V2l0aEN1c3RvbWVySWQoc3RyaW5nIGN1c3RvbWVySWQpIHB1YmxpYyBwYXlhYmxlIHsKICAgIGludmVzdFdpdGhDdXN0b21lcklkKG1zZy5zZW5kZXIsIGN1c3RvbWVySWQpOwogIH0KCiAgLyoqCiAgICogVGhlIGJhc2ljIGVudHJ5IHBvaW50IHRvIHBhcnRpY2lwYXRlIHRoZSBjcm93ZHNhbGUgcHJvY2Vzcy4KICAgKgogICAqIFBheSBmb3IgZnVuZGluZywgZ2V0IGludmVzdGVkIHRva2VucyBiYWNrIGluIHRoZSBzZW5kZXIgYWRkcmVzcy4KICAgKi8KICBmdW5jdGlvbiBidXkoKSBwdWJsaWMgcGF5YWJsZSB7CiAgICBpbnZlc3QobXNnLnNlbmRlcik7CiAgfQoKICAvKioKICAgKiBGaW5hbGl6ZSBhIHN1Y2NjZXNmdWwgY3Jvd2RzYWxlLgogICAqCiAgICogVGhlIG93bmVyIGNhbiB0cmlnZ3JlIGEgY2FsbCB0aGUgY29udHJhY3QgdGhhdCBwcm92aWRlcyBwb3N0LWNyb3dkc2FsZSBhY3Rpb25zLCBsaWtlIHJlbGVhc2luZyB0aGUgdG9rZW5zLgogICAqLwogIGZ1bmN0aW9uIGZpbmFsaXplKCkgcHVibGljIGluU3RhdGUoU3RhdGUuU3VjY2Vzcykgb25seU93bmVyIHN0b3BJbkVtZXJnZW5jeSB7CgogICAgLy8gQWxyZWFkeSBmaW5hbGl6ZWQKICAgIHJlcXVpcmUoIWZpbmFsaXplZCk7CiAgICAvLyBpZihmaW5hbGl6ZWQpIHsKICAgIC8vICAgdGhyb3c7CiAgICAvLyB9CgogICAgLy8gRmluYWxpemluZyBpcyBvcHRpb25hbC4gV2Ugb25seSBjYWxsIGl0IGlmIHdlIGFyZSBnaXZlbiBhIGZpbmFsaXppbmcgYWdlbnQuCiAgICBpZihhZGRyZXNzKGZpbmFsaXplQWdlbnQpICE9IDApIHsKICAgICAgZmluYWxpemVBZ2VudC5maW5hbGl6ZUNyb3dkc2FsZSgpOwogICAgfQoKICAgIGZpbmFsaXplZCA9IHRydWU7CiAgfQoKICAvKioKICAgKiBBbGxvdyB0byAocmUpc2V0IGZpbmFsaXplIGFnZW50LgogICAqCiAgICogRGVzaWduIGNob2ljZTogbm8gc3RhdGUgcmVzdHJpY3Rpb25zIG9uIHNldHRpbmcgdGhpcywgc28gdGhhdCB3ZSBjYW4gZml4IGZhdCBmaW5nZXIgbWlzdGFrZXMuCiAgICovCiAgZnVuY3Rpb24gc2V0RmluYWxpemVBZ2VudChGaW5hbGl6ZUFnZW50IGFkZHIpIG9ubHlPd25lciB7CiAgICBmaW5hbGl6ZUFnZW50ID0gYWRkcjsKCiAgICAvLyBEb24ndCBhbGxvdyBzZXR0aW5nIGJhZCBhZ2VudAogICAgcmVxdWlyZShmaW5hbGl6ZUFnZW50LmlzRmluYWxpemVBZ2VudCgpKTsKICAgIC8vIGlmKCFmaW5hbGl6ZUFnZW50LmlzRmluYWxpemVBZ2VudCgpKSB7CiAgICAvLyAgIHRocm93OwogICAgLy8gfQogIH0KCiAgLyoqCiAgICogU2V0IHBvbGljeSBkbyB3ZSBuZWVkIHRvIGhhdmUgc2VydmVyLXNpZGUgY3VzdG9tZXIgaWRzIGZvciB0aGUgaW52ZXN0bWVudHMuCiAgICoKICAgKi8KICBmdW5jdGlvbiBzZXRSZXF1aXJlQ3VzdG9tZXJJZChib29sIHZhbHVlKSBvbmx5T3duZXIgewogICAgcmVxdWlyZUN1c3RvbWVySWQgPSB2YWx1ZTsKICAgIEludmVzdG1lbnRQb2xpY3lDaGFuZ2VkKHJlcXVpcmVDdXN0b21lcklkLCByZXF1aXJlZFNpZ25lZEFkZHJlc3MsIHNpZ25lckFkZHJlc3MpOwogIH0KCiAgLyoqCiAgICogU2V0IHBvbGljeSBpZiBhbGwgaW52ZXN0b3JzIG11c3QgYmUgY2xlYXJlZCBvbiB0aGUgc2VydmVyIHNpZGUgZmlyc3QuCiAgICoKICAgKiBUaGlzIGlzIGUuZy4gZm9yIHRoZSBhY2NyZWRpdGVkIGludmVzdG9yIGNsZWFyaW5nLgogICAqCiAgICovCiAgLy8gZnVuY3Rpb24gc2V0UmVxdWlyZVNpZ25lZEFkZHJlc3MoYm9vbCB2YWx1ZSwgYWRkcmVzcyBfc2lnbmVyQWRkcmVzcykgb25seU93bmVyIHsKICAvLyAgIHJlcXVpcmVkU2lnbmVkQWRkcmVzcyA9IHZhbHVlOwogIC8vICAgc2lnbmVyQWRkcmVzcyA9IF9zaWduZXJBZGRyZXNzOwogIC8vICAgSW52ZXN0bWVudFBvbGljeUNoYW5nZWQocmVxdWlyZUN1c3RvbWVySWQsIHJlcXVpcmVkU2lnbmVkQWRkcmVzcywgc2lnbmVyQWRkcmVzcyk7CiAgLy8gfQoKICAvKioKICAgKiBBbGxvdyBhZGRyZXNzZXMgdG8gZG8gZWFybHkgcGFydGljaXBhdGlvbi4KICAgKgogICAqIFRPRE86IEZpeCBzcGVsbGluZyBlcnJvciBpbiB0aGUgbmFtZQogICAqLwogIGZ1bmN0aW9uIHNldEVhcmx5UGFyaWNpcGFudFdoaXRlbGlzdChhZGRyZXNzIGFkZHIsIGJvb2wgc3RhdHVzKSBvbmx5T3duZXIgewogICAgZWFybHlQYXJ0aWNpcGFudFdoaXRlbGlzdFthZGRyXSA9IHN0YXR1czsKICAgIFdoaXRlbGlzdGVkKGFkZHIsIHN0YXR1cyk7CiAgfQoKICAvKioKICAgKiBBbGxvdyBjcm93ZHNhbGUgb3duZXIgdG8gY2xvc2UgZWFybHkgb3IgZXh0ZW5kIHRoZSBjcm93ZHNhbGUuCiAgICoKICAgKiBUaGlzIGlzIHVzZWZ1bCBlLmcuIGZvciBhIG1hbnVhbCBzb2Z0IGNhcCBpbXBsZW1lbnRhdGlvbjoKICAgKiAtIGFmdGVyIFggYW1vdW50IGlzIHJlYWNoZWQgZGV0ZXJtaW5lIG1hbnVhbCBjbG9zaW5nCiAgICoKICAgKiBUaGlzIG1heSBwdXQgdGhlIGNyb3dkc2FsZSB0byBhbiBpbnZhbGlkIHN0YXRlLAogICAqIGJ1dCB3ZSB0cnVzdCBvd25lcnMga25vdyB3aGF0IHRoZXkgYXJlIGRvaW5nLgogICAqCiAgICovCiAgZnVuY3Rpb24gc2V0RW5kc0F0KHVpbnQgdGltZSkgb25seU93bmVyIHsKCiAgICByZXF1aXJlKG5vdyA8PSB0aW1lKTsKCiAgICBlbmRzQXQgPSB0aW1lOwogICAgRW5kc0F0Q2hhbmdlZChlbmRzQXQpOwogIH0KCiAgLyoqCiAgICogQWxsb3cgdG8gKHJlKXNldCBwcmljaW5nIHN0cmF0ZWd5LgogICAqCiAgICogRGVzaWduIGNob2ljZTogbm8gc3RhdGUgcmVzdHJpY3Rpb25zIG9uIHRoZSBzZXQsIHNvIHRoYXQgd2UgY2FuIGZpeCBmYXQgZmluZ2VyIG1pc3Rha2VzLgogICAqLwogIGZ1bmN0aW9uIHNldFByaWNpbmdTdHJhdGVneShQcmljaW5nU3RyYXRlZ3kgX3ByaWNpbmdTdHJhdGVneSkgb25seU93bmVyIHsKICAgIHByaWNpbmdTdHJhdGVneSA9IF9wcmljaW5nU3RyYXRlZ3k7CgogICAgLy8gRG9uJ3QgYWxsb3cgc2V0dGluZyBiYWQgYWdlbnQKICAgIHJlcXVpcmUocHJpY2luZ1N0cmF0ZWd5LmlzUHJpY2luZ1N0cmF0ZWd5KCkpOwogICAgLy8gaWYoIXByaWNpbmdTdHJhdGVneS5pc1ByaWNpbmdTdHJhdGVneSgpKSB7CiAgICAvLyAgIHRocm93OwogICAgLy8gfQogIH0KCiAgLyoqCiAgICogQWxsb3cgdG8gY2hhbmdlIHRoZSB0ZWFtIG11bHRpc2lnIGFkZHJlc3MgaW4gdGhlIGNhc2Ugb2YgZW1lcmdlbmN5LgogICAqCiAgICogVGhpcyBhbGxvd3MgdG8gc2F2ZSBhIGRlcGxveWVkIGNyb3dkc2FsZSB3YWxsZXQgaW4gdGhlIGNhc2UgdGhlIGNyb3dkc2FsZSBoYXMgbm90IHlldCBiZWd1bgogICAqICh3ZSBoYXZlIGRvbmUgb25seSBmZXcgdGVzdCB0cmFuc2FjdGlvbnMpLiBBZnRlciB0aGUgY3Jvd2RzYWxlIGlzIGdvaW5nCiAgICogdGhlbiBtdWx0aXNpZyBhZGRyZXNzIHN0YXlzIGxvY2tlZCBmb3IgdGhlIHNhZmV0eSByZWFzb25zLgogICAqLwogIGZ1bmN0aW9uIHNldE11bHRpc2lnKGFkZHJlc3MgYWRkcikgcHVibGljIG9ubHlPd25lciB7CgogICAgLy8gQ2hhbmdlCiAgICByZXF1aXJlKGludmVzdG9yQ291bnQgPD0gTUFYX0lOVkVTVE1FTlRTX0JFRk9SRV9NVUxUSVNJR19DSEFOR0UpOwoKICAgIG11bHRpc2lnV2FsbGV0ID0gYWRkcjsKICB9CgogIC8qKgogICAqIEFsbG93IGxvYWQgcmVmdW5kcyBiYWNrIG9uIHRoZSBjb250cmFjdCBmb3IgdGhlIHJlZnVuZGluZy4KICAgKgogICAqIFRoZSB0ZWFtIGNhbiB0cmFuc2ZlciB0aGUgZnVuZHMgYmFjayBvbiB0aGUgc21hcnQgY29udHJhY3QgaW4gdGhlIGNhc2UgdGhlIG1pbmltdW0gZ29hbCB3YXMgbm90IHJlYWNoZWQuLgogICAqLwogIGZ1bmN0aW9uIGxvYWRSZWZ1bmQoKSBwdWJsaWMgcGF5YWJsZSBpblN0YXRlKFN0YXRlLkZhaWx1cmUpIHsKICAgIHJlcXVpcmUobXNnLnZhbHVlICE9IDApOwogICAgLy9pZihtc2cudmFsdWUgPT0gMCkgdGhyb3c7CiAgICBsb2FkZWRSZWZ1bmQgPSBzYWZlQWRkKGxvYWRlZFJlZnVuZCxtc2cudmFsdWUpOwogIH0KCiAgLyoqCiAgICogSW52ZXN0b3JzIGNhbiBjbGFpbSByZWZ1bmQuCiAgICovCiAgZnVuY3Rpb24gcmVmdW5kKCkgcHVibGljIGluU3RhdGUoU3RhdGUuUmVmdW5kaW5nKSB7CiAgICB1aW50MjU2IHdlaVZhbHVlID0gaW52ZXN0ZWRBbW91bnRPZlttc2cuc2VuZGVyXTsKICAgIHJlcXVpcmUod2VpVmFsdWUgIT0gMCk7CiAgICAvL2lmICh3ZWlWYWx1ZSA9PSAwKSB0aHJvdzsKICAgIGludmVzdGVkQW1vdW50T2ZbbXNnLnNlbmRlcl0gPSAwOwogICAgd2VpUmVmdW5kZWQgPSBzYWZlQWRkKHdlaVJlZnVuZGVkLHdlaVZhbHVlKTsKICAgIFJlZnVuZChtc2cuc2VuZGVyLCB3ZWlWYWx1ZSk7CiAgICByZXF1aXJlKG1zZy5zZW5kZXIuc2VuZCh3ZWlWYWx1ZSkpOwogIH0KCiAgLyoqCiAgICogQHJldHVybiB0cnVlIGlmIHRoZSBjcm93ZHNhbGUgaGFzIHJhaXNlZCBlbm91Z2ggbW9uZXkgdG8gYmUgYSBzdWNjZXMKICAgKi8KICBmdW5jdGlvbiBpc01pbmltdW1Hb2FsUmVhY2hlZCgpIHB1YmxpYyBjb25zdGFudCByZXR1cm5zIChib29sIHJlYWNoZWQpIHsKICAgIHJldHVybiB3ZWlSYWlzZWQgPj0gbWluaW11bUZ1bmRpbmdHb2FsOwogIH0KCiAgLyoqCiAgICogQ2hlY2sgaWYgdGhlIGNvbnRyYWN0IHJlbGF0aW9uc2hpcCBsb29rcyBnb29kLgogICAqLwogIGZ1bmN0aW9uIGlzRmluYWxpemVyU2FuZSgpIHB1YmxpYyBjb25zdGFudCByZXR1cm5zIChib29sIHNhbmUpIHsKICAgIHJldHVybiBmaW5hbGl6ZUFnZW50LmlzU2FuZSgpOwogIH0KCiAgLyoqCiAgICogQ2hlY2sgaWYgdGhlIGNvbnRyYWN0IHJlbGF0aW9uc2hpcCBsb29rcyBnb29kLgogICAqLwogIGZ1bmN0aW9uIGlzUHJpY2luZ1NhbmUoKSBwdWJsaWMgY29uc3RhbnQgcmV0dXJucyAoYm9vbCBzYW5lKSB7CiAgICByZXR1cm4gcHJpY2luZ1N0cmF0ZWd5LmlzU2FuZShhZGRyZXNzKHRoaXMpKTsKICB9CgogIC8qKgogICAqIENyb3dkZnVuZCBzdGF0ZSBtYWNoaW5lIG1hbmFnZW1lbnQuCiAgICoKICAgKiBXZSBtYWtlIGl0IGEgZnVuY3Rpb24gYW5kIGRvIG5vdCBhc3NpZ24gdGhlIHJlc3VsdCB0byBhIHZhcmlhYmxlLCBzbyB0aGVyZSBpcyBubyBjaGFuY2Ugb2YgdGhlIHZhcmlhYmxlIGJlaW5nIHN0YWxlLgogICAqLwogIGZ1bmN0aW9uIGdldFN0YXRlKCkgcHVibGljIGNvbnN0YW50IHJldHVybnMgKFN0YXRlKSB7CiAgICBpZihmaW5hbGl6ZWQpIHJldHVybiBTdGF0ZS5GaW5hbGl6ZWQ7CiAgICBlbHNlIGlmIChhZGRyZXNzKGZpbmFsaXplQWdlbnQpID09IDApIHJldHVybiBTdGF0ZS5QcmVwYXJpbmc7CiAgICBlbHNlIGlmICghZmluYWxpemVBZ2VudC5pc1NhbmUoKSkgcmV0dXJuIFN0YXRlLlByZXBhcmluZzsKICAgIGVsc2UgaWYgKCFwcmljaW5nU3RyYXRlZ3kuaXNTYW5lKGFkZHJlc3ModGhpcykpKSByZXR1cm4gU3RhdGUuUHJlcGFyaW5nOwogICAgZWxzZSBpZiAoYmxvY2sudGltZXN0YW1wIDwgc3RhcnRzQXQpIHJldHVybiBTdGF0ZS5QcmVGdW5kaW5nOwogICAgZWxzZSBpZiAoYmxvY2sudGltZXN0YW1wIDw9IGVuZHNBdCAmJiAhaXNDcm93ZHNhbGVGdWxsKCkpIHJldHVybiBTdGF0ZS5GdW5kaW5nOwogICAgZWxzZSBpZiAoaXNNaW5pbXVtR29hbFJlYWNoZWQoKSkgcmV0dXJuIFN0YXRlLlN1Y2Nlc3M7CiAgICBlbHNlIGlmICghaXNNaW5pbXVtR29hbFJlYWNoZWQoKSAmJiB3ZWlSYWlzZWQgPiAwICYmIGxvYWRlZFJlZnVuZCA+PSB3ZWlSYWlzZWQpIHJldHVybiBTdGF0ZS5SZWZ1bmRpbmc7CiAgICBlbHNlIHJldHVybiBTdGF0ZS5GYWlsdXJlOwogIH0KCiAgLyoqIFRoaXMgaXMgZm9yIG1hbnVhbCB0ZXN0aW5nIG9mIG11bHRpc2lnIHdhbGxldCBpbnRlcmFjdGlvbiAqLwogIGZ1bmN0aW9uIHNldE93bmVyVGVzdFZhbHVlKHVpbnQgdmFsKSBvbmx5T3duZXIgewogICAgb3duZXJUZXN0VmFsdWUgPSB2YWw7CiAgfQoKICAvKiogSW50ZXJmYWNlIG1hcmtlci4gKi8KICBmdW5jdGlvbiBpc0Nyb3dkc2FsZSgpIHB1YmxpYyBjb25zdGFudCByZXR1cm5zIChib29sKSB7CiAgICByZXR1cm4gdHJ1ZTsKICB9CgogIC8vCiAgLy8gTW9kaWZpZXJzCiAgLy8KCiAgLyoqIE1vZGlmaWVkIGFsbG93aW5nIGV4ZWN1dGlvbiBvbmx5IGlmIHRoZSBjcm93ZHNhbGUgaXMgY3VycmVudGx5IHJ1bm5pbmcuICAqLwogIG1vZGlmaWVyIGluU3RhdGUoU3RhdGUgc3RhdGUpIHsKICAgIHJlcXVpcmUoZ2V0U3RhdGUoKSA9PSBzdGF0ZSk7CiAgICAvL2lmKGdldFN0YXRlKCkgIT0gc3RhdGUpIHRocm93OwogICAgXzsKICB9CgogICAvLwogIC8vIEFic3RyYWN0IGZ1bmN0aW9ucwogIC8vCgogIC8qKgogICAqIENoZWNrIGlmIHRoZSBjdXJyZW50IGludmVzdGVkIGJyZWFrcyBvdXIgY2FwIHJ1bGVzLgogICAqCiAgICoKICAgKiBUaGUgY2hpbGQgY29udHJhY3QgbXVzdCBkZWZpbmUgdGhlaXIgb3duIGNhcCBzZXR0aW5nIHJ1bGVzLgogICAqIFdlIGFsbG93IGEgbG90IG9mIGZsZXhpYmlsaXR5IHRocm91Z2ggZGlmZmVyZW50IGNhcHBpbmcgc3RyYXRlZ2llcyAoRVRILCB0b2tlbiBjb3VudCkKICAgKiBDYWxsZWQgZnJvbSBpbnZlc3QoKS4KICAgKgogICAqIEBwYXJhbSB3ZWlBbW91bnQgVGhlIGFtb3VudCBvZiB3ZWkgdGhlIGludmVzdG9yIHRyaWVzIHRvIGludmVzdCBpbiB0aGUgY3VycmVudCB0cmFuc2FjdGlvbgogICAqIEBwYXJhbSB0b2tlbkFtb3VudCBUaGUgYW1vdW50IG9mIHRva2VucyB3ZSB0cnkgdG8gZ2l2ZSB0byB0aGUgaW52ZXN0b3IgaW4gdGhlIGN1cnJlbnQgdHJhbnNhY3Rpb24KICAgKiBAcGFyYW0gd2VpUmFpc2VkVG90YWwgV2hhdCB3b3VsZCBiZSBvdXIgdG90YWwgcmFpc2VkIGJhbGFuY2UgYWZ0ZXIgdGhpcyB0cmFuc2FjdGlvbgogICAqIEBwYXJhbSB0b2tlbnNTb2xkVG90YWwgV2hhdCB3b3VsZCBiZSBvdXIgdG90YWwgc29sZCB0b2tlbnMgY291bnQgYWZ0ZXIgdGhpcyB0cmFuc2FjdGlvbgogICAqCiAgICogQHJldHVybiB0cnVlIGlmIHRha2luZyB0aGlzIGludmVzdG1lbnQgd291bGQgYnJlYWsgb3VyIGNhcCBydWxlcwogICAqLwogIGZ1bmN0aW9uIGlzQnJlYWtpbmdDYXAodWludCB3ZWlBbW91bnQsIHVpbnQgdG9rZW5BbW91bnQsIHVpbnQgd2VpUmFpc2VkVG90YWwsIHVpbnQgdG9rZW5zU29sZFRvdGFsKSBjb25zdGFudCByZXR1cm5zIChib29sIGxpbWl0QnJva2VuKTsKICAvKioKICAgKiBDaGVjayBpZiB0aGUgY3VycmVudCBjcm93ZHNhbGUgaXMgZnVsbCBhbmQgd2UgY2FuIG5vIGxvbmdlciBzZWxsIGFueSB0b2tlbnMuCiAgICovCiAgZnVuY3Rpb24gaXNDcm93ZHNhbGVGdWxsKCkgcHVibGljIGNvbnN0YW50IHJldHVybnMgKGJvb2wpOwoKICAvKioKICAgKiBDcmVhdGUgbmV3IHRva2VucyBvciB0cmFuc2ZlciBpc3N1ZWQgdG9rZW5zIHRvIHRoZSBpbnZlc3RvciBkZXBlbmRpbmcgb24gdGhlIGNhcCBtb2RlbC4KICAgKi8KICBmdW5jdGlvbiBhc3NpZ25Ub2tlbnMoYWRkcmVzcyByZWNlaXZlciwgdWludCB0b2tlbkFtb3VudCkgcHJpdmF0ZTsKCn0KCgoKLyoqCiAqIEF0IHRoZSBlbmQgb2YgdGhlIHN1Y2Nlc3NmdWwgY3Jvd2RzYWxlIGFsbG9jYXRlICUgYm9udXMgb2YgdG9rZW5zIHRvIHRoZSB0ZWFtLgogKgogKiBVbmxvY2sgdG9rZW5zLgogKgogKiBCb251c0FsbG9jYXRpb25GaW5hbCBtdXN0IGJlIHNldCBhcyB0aGUgbWludGluZyBhZ2VudCBmb3IgdGhlIE1pbnRhYmxlVG9rZW4uCiAqCiAqLwpjb250cmFjdCBCb251c0ZpbmFsaXplQWdlbnQgaXMgRmluYWxpemVBZ2VudCwgU2FmZU1hdGhMaWIgewoKICBDcm93ZHNhbGVUb2tlbiBwdWJsaWMgdG9rZW47CiAgQ3Jvd2RzYWxlIHB1YmxpYyBjcm93ZHNhbGU7CgogIC8qKiBUb3RhbCBwZXJjZW50IG9mIHRva2VucyBtaW50ZWQgdG8gdGhlIHRlYW0gYXQgdGhlIGVuZCBvZiB0aGUgc2FsZSBhcyBiYXNlIHBvaW50cyAoMC4wMDAxKSAqLwogIHVpbnQgcHVibGljIHRvdGFsTWVtYmVyczsKICB1aW50IHB1YmxpYyBhbGxvY2F0ZWRCb251czsKICBtYXBwaW5nIChhZGRyZXNzPT51aW50KSBib251c09mOwogIC8qKiBXaGVyZSB3ZSBtb3ZlIHRoZSB0b2tlbnMgYXQgdGhlIGVuZCBvZiB0aGUgc2FsZS4gKi8KICBhZGRyZXNzW10gcHVibGljIHRlYW1BZGRyZXNzZXM7CgoKICBmdW5jdGlvbiBCb251c0ZpbmFsaXplQWdlbnQoQ3Jvd2RzYWxlVG9rZW4gX3Rva2VuLCBDcm93ZHNhbGUgX2Nyb3dkc2FsZSwgdWludFtdIF9ib251c0Jhc2VQb2ludHMsIGFkZHJlc3NbXSBfdGVhbUFkZHJlc3NlcykgewogICAgdG9rZW4gPSBfdG9rZW47CiAgICBjcm93ZHNhbGUgPSBfY3Jvd2RzYWxlOwoKICAgIC8vY3Jvd2RzYWxlIGFkZHJlc3MgbXVzdCBub3QgYmUgMAogICAgcmVxdWlyZShhZGRyZXNzKGNyb3dkc2FsZSkgIT0gMCk7CgogICAgLy9ib251cyAmIHRlYW0gYWRkcmVzcyBhcnJheSBzaXplIG11c3QgbWF0Y2gKICAgIHJlcXVpcmUoX2JvbnVzQmFzZVBvaW50cy5sZW5ndGggPT0gX3RlYW1BZGRyZXNzZXMubGVuZ3RoKTsKCiAgICB0b3RhbE1lbWJlcnMgPSBfdGVhbUFkZHJlc3Nlcy5sZW5ndGg7CiAgICB0ZWFtQWRkcmVzc2VzID0gX3RlYW1BZGRyZXNzZXM7CiAgICAKICAgIC8vaWYgYW55IG9mIHRoZSBib251cyBpcyAwIHRocm93CiAgICAvLyBvdGhlcndpc2Ugc3VtIGl0IHVwIGluIHRvdGFsQWxsb2NhdGVkQm9udXMKICAgIGZvciAodWludCBpPTA7aTx0b3RhbE1lbWJlcnM7aSsrKXsKICAgICAgcmVxdWlyZShfYm9udXNCYXNlUG9pbnRzW2ldICE9IDApOwogICAgICAvL2lmKF9ib251c0Jhc2VQb2ludHNbaV0gPT0gMCkgdGhyb3c7CiAgICB9CgogICAgLy9pZiBhbnkgb2YgdGhlIGFkZHJlc3MgaXMgMCBvciBpbnZhbGlkIHRocm93CiAgICAvL290aGVyd2lzZSBpbml0aWFsaXplIHRoZSBib251c09mIGFycmF5CiAgICBmb3IgKHVpbnQgaj0wO2o8dG90YWxNZW1iZXJzO2orKyl7CiAgICAgIHJlcXVpcmUoX3RlYW1BZGRyZXNzZXNbal0gIT0gMCk7CiAgICAgIC8vaWYoX3RlYW1BZGRyZXNzZXNbal0gPT0gMCkgdGhyb3c7CiAgICAgIGJvbnVzT2ZbX3RlYW1BZGRyZXNzZXNbal1dID0gX2JvbnVzQmFzZVBvaW50c1tqXTsKICAgIH0KICB9CgogIC8qIENhbiB3ZSBydW4gZmluYWxpemUgcHJvcGVybHkgKi8KICBmdW5jdGlvbiBpc1NhbmUoKSBwdWJsaWMgY29uc3RhbnQgcmV0dXJucyAoYm9vbCkgewogICAgcmV0dXJuICh0b2tlbi5taW50QWdlbnRzKGFkZHJlc3ModGhpcykpID09IHRydWUpICYmICh0b2tlbi5yZWxlYXNlQWdlbnQoKSA9PSBhZGRyZXNzKHRoaXMpKTsKICB9CgogIC8qKiBDYWxsZWQgb25jZSBieSBjcm93ZHNhbGUgZmluYWxpemUoKSBpZiB0aGUgc2FsZSB3YXMgc3VjY2Vzcy4gKi8KICBmdW5jdGlvbiBmaW5hbGl6ZUNyb3dkc2FsZSgpIHsKCiAgICAvLyBpZiBmaW5hbGl6ZWQgaXMgbm90IGJlaW5nIGNhbGxlZCBmcm9tIHRoZSBjcm93ZHNhbGUgCiAgICAvLyBjb250cmFjdCB0aGVuIHRocm93CiAgICByZXF1aXJlKG1zZy5zZW5kZXIgPT0gYWRkcmVzcyhjcm93ZHNhbGUpKTsKCiAgICAvLyBpZihtc2cuc2VuZGVyICE9IGFkZHJlc3MoY3Jvd2RzYWxlKSkgewogICAgLy8gICB0aHJvdzsKICAgIC8vIH0KCiAgICAvLyBnZXQgdGhlIHRvdGFsIHNvbGQgdG9rZW5zIGNvdW50LgogICAgdWludCB0b2tlbnNTb2xkID0gY3Jvd2RzYWxlLnRva2Vuc1NvbGQoKTsKCiAgICBmb3IgKHVpbnQgaT0wO2k8dG90YWxNZW1iZXJzO2krKyl7CiAgICAgIGFsbG9jYXRlZEJvbnVzID0gc2FmZU11bCh0b2tlbnNTb2xkLCBib251c09mW3RlYW1BZGRyZXNzZXNbaV1dKSAvIDEwMDAwOwogICAgICAvLyBtb3ZlIHRva2VucyB0byB0aGUgdGVhbSBtdWx0aXNpZyB3YWxsZXQKICAgICAgdG9rZW4ubWludCh0ZWFtQWRkcmVzc2VzW2ldLCBhbGxvY2F0ZWRCb251cyk7CiAgICB9CgogICAgLy8gTWFrZSB0b2tlbiB0cmFuc2ZlcmFibGUKICAgIC8vIHJlYWxlYXNlIHRoZW0gaW4gdGhlIHdpbGQKICAgIC8vIEhlbGwgeWVhaCEhISB3ZSBkaWQgaXQuCiAgICB0b2tlbi5yZWxlYXNlVG9rZW5UcmFuc2ZlcigpOwogIH0KCn0KCi8qKgogKiBJQ08gY3Jvd2RzYWxlIGNvbnRyYWN0IHRoYXQgaXMgY2FwcGVkIGJ5IGFtb3V0IG9mIEVUSC4KICoKICogLSBUb2tlbnMgYXJlIGR5bmFtaWNhbGx5IGNyZWF0ZWQgZHVyaW5nIHRoZSBjcm93ZHNhbGUKICoKICoKICovCgpjb250cmFjdCBNaW50ZWRFdGhDYXBwZWRDcm93ZHNhbGUgaXMgQ3Jvd2RzYWxlIHsKCiAgLyogTWF4aW11bSBhbW91bnQgb2Ygd2VpIHRoaXMgY3Jvd2RzYWxlIGNhbiByYWlzZS4gKi8KICB1aW50IHB1YmxpYyB3ZWlDYXA7CgogIGZ1bmN0aW9uIE1pbnRlZEV0aENhcHBlZENyb3dkc2FsZShhZGRyZXNzIF90b2tlbiwgUHJpY2luZ1N0cmF0ZWd5IF9wcmljaW5nU3RyYXRlZ3ksIAogICAgYWRkcmVzcyBfbXVsdGlzaWdXYWxsZXQsIHVpbnQgX3N0YXJ0LCB1aW50IF9lbmQsIHVpbnQgX21pbmltdW1GdW5kaW5nR29hbCwgdWludCBfd2VpQ2FwLCAKICAgIGFkZHJlc3MgX3Rva2VuVmVzdGluZ0FkZHJlc3MpIAogICAgQ3Jvd2RzYWxlKF90b2tlbiwgX3ByaWNpbmdTdHJhdGVneSwgX211bHRpc2lnV2FsbGV0LCBfc3RhcnQsIF9lbmQsIF9taW5pbXVtRnVuZGluZ0dvYWwsIAogICAgX3Rva2VuVmVzdGluZ0FkZHJlc3MpIHsKICAgIAogICAgd2VpQ2FwID0gX3dlaUNhcDsKICB9CgogIC8qKgogICAqIENhbGxlZCBmcm9tIGludmVzdCgpIHRvIGNvbmZpcm0gaWYgdGhlIGN1cnJldCBpbnZlc3RtZW50IGRvZXMgbm90IGJyZWFrIG91ciBjYXAgcnVsZS4KICAgKi8KICBmdW5jdGlvbiBpc0JyZWFraW5nQ2FwKHVpbnQgd2VpQW1vdW50LCB1aW50IHRva2VuQW1vdW50LCB1aW50IHdlaVJhaXNlZFRvdGFsLCB1aW50IHRva2Vuc1NvbGRUb3RhbCkgY29uc3RhbnQgcmV0dXJucyAoYm9vbCBsaW1pdEJyb2tlbikgewogICAgcmV0dXJuIHdlaVJhaXNlZFRvdGFsID4gd2VpQ2FwOwogIH0KCiAgZnVuY3Rpb24gaXNDcm93ZHNhbGVGdWxsKCkgcHVibGljIGNvbnN0YW50IHJldHVybnMgKGJvb2wpIHsKICAgIHJldHVybiB3ZWlSYWlzZWQgPj0gd2VpQ2FwOwogIH0KCiAgLyoqCiAgICogRHluYW1pY2FsbHkgY3JlYXRlIHRva2VucyBhbmQgYXNzaWduIHRoZW0gdG8gdGhlIGludmVzdG9yLgogICAqLwogIGZ1bmN0aW9uIGFzc2lnblRva2VucyhhZGRyZXNzIHJlY2VpdmVyLCB1aW50IHRva2VuQW1vdW50KSBwcml2YXRlIHsKICAgIE1pbnRhYmxlVG9rZW4gbWludGFibGVUb2tlbiA9IE1pbnRhYmxlVG9rZW4odG9rZW4pOwogICAgbWludGFibGVUb2tlbi5taW50KHJlY2VpdmVyLCB0b2tlbkFtb3VudCk7CiAgfQp9CgoKCi8qKiBUcmFuY2hlIGJhc2VkIHByaWNpbmcgd2l0aCBzcGVjaWFsIHN1cHBvcnQgZm9yIHByZS1pY28gZGVhbHMuCiAqICAgICAgSW1wbGVtZW50aW5nICJmaXJzdCBwcmljZSIgdHJhbmNoZXMsIG1lYW5pbmcsIHRoYXQgaWYgYnllcnMgb3JkZXIgaXMKICogICAgICBjb3ZlcmluZyBtb3JlIHRoYW4gb25lIHRyYW5jaGUsIHRoZSBwcmljZSBvZiB0aGUgbG93ZXN0IHRyYW5jaGUgd2lsbCBhcHBseQogKiAgICAgIHRvIHRoZSB3aG9sZSBvcmRlci4KICovCmNvbnRyYWN0IEV0aFRyYW5jaGVQcmljaW5nIGlzIFByaWNpbmdTdHJhdGVneSwgT3duYWJsZSwgU2FmZU1hdGhMaWIgewoKICB1aW50IHB1YmxpYyBjb25zdGFudCBNQVhfVFJBTkNIRVMgPSAxMDsKIAogCiAgLy8gVGhpcyBjb250YWlucyBhbGwgcHJlLUlDTyBhZGRyZXNzZXMsIGFuZCB0aGVpciBwcmljZXMgKHdlaXMgcGVyIHRva2VuKQogIG1hcHBpbmcgKGFkZHJlc3MgPT4gdWludCkgcHVibGljIHByZWljb0FkZHJlc3NlczsKCiAgLyoqCiAgKiBEZWZpbmUgcHJpY2luZyBzY2hlZHVsZSB1c2luZyB0cmFuY2hlcy4KICAqLwoKICBzdHJ1Y3QgVHJhbmNoZSB7CiAgICAgIC8vIEFtb3VudCBpbiB3ZWlzIHdoZW4gdGhpcyB0cmFuY2hlIGJlY29tZXMgYWN0aXZlCiAgICAgIHVpbnQgYW1vdW50OwogICAgICAvLyBIb3cgbWFueSB0b2tlbnMgcGVyIHdlaSB5b3Ugd2lsbCBnZXQgd2hpbGUgdGhpcyB0cmFuY2hlIGlzIGFjdGl2ZQogICAgICB1aW50IHByaWNlOwogIH0KCiAgLy8gU3RvcmUgdHJhbmNoZXMgaW4gYSBmaXhlZCBhcnJheSwgc28gdGhhdCBpdCBjYW4gYmUgc2VlbiBpbiBhIGJsb2NrY2hhaW4gZXhwbG9yZXIKICAvLyBUcmFuY2hlIDAgaXMgYWx3YXlzICgwLCAwKQogIC8vIChUT0RPOiBjaGFuZ2UgdGhpcyB3aGVuIHdlIGNvbmZpcm0gZHluYW1pYyBhcnJheXMgYXJlIGV4cGxvcmFibGUpCiAgVHJhbmNoZVsxMF0gcHVibGljIHRyYW5jaGVzOwoKICAvLyBIb3cgbWFueSBhY3RpdmUgdHJhbmNoZXMgd2UgaGF2ZQogIHVpbnQgcHVibGljIHRyYW5jaGVDb3VudDsKCiAgLy8vIEBkZXYgQ29udHJ1Y3Rpb24sIGNyZWF0aW5nIGEgbGlzdCBvZiB0cmFuY2hlcwogIC8vLyBAcGFyYW0gX3RyYW5jaGVzIHVpbnRbXSB0cmFuY2hlcyBQYWlycyBvZiAoc3RhcnQgYW1vdW50LCBwcmljZSkKICBmdW5jdGlvbiBFdGhUcmFuY2hlUHJpY2luZyh1aW50W10gX3RyYW5jaGVzKSB7CiAgICAvLyBbIDAsIDY2NjY2NjY2NjY2NjY2NiwKICAgIC8vICAgMzAwMDAwMDAwMDAwMDAwMDAwMDAwMCwgNzY5MjMwNzY5MjMwNzY5LAogICAgLy8gICA1MDAwMDAwMDAwMDAwMDAwMDAwMDAwLCA5MDkwOTA5MDkwOTA5MDksCiAgICAvLyAgIDgwMDAwMDAwMDAwMDAwMDAwMDAwMDAsIDk1MjM4MDk1MjM4MDk1MiwKICAgIC8vICAgMjAwMDAwMDAwMDAwMDAwMDAwMDAwMCwgMTAwMDAwMDAwMDAwMDAwMCBdCiAgICAvLyBOZWVkIHRvIGhhdmUgdHVwbGVzLCBsZW5ndGggY2hlY2sKICAgIHJlcXVpcmUoIShfdHJhbmNoZXMubGVuZ3RoICUgMiA9PSAxIHx8IF90cmFuY2hlcy5sZW5ndGggPj0gTUFYX1RSQU5DSEVTKjIpKTsKICAgIC8vIGlmKF90cmFuY2hlcy5sZW5ndGggJSAyID09IDEgfHwgX3RyYW5jaGVzLmxlbmd0aCA+PSBNQVhfVFJBTkNIRVMqMikgewogICAgLy8gICB0aHJvdzsKICAgIC8vIH0KICAgIHRyYW5jaGVDb3VudCA9IF90cmFuY2hlcy5sZW5ndGggLyAyOwogICAgdWludCBoaWdoZXN0QW1vdW50ID0gMDsKICAgIGZvcih1aW50IGk9MDsgaTxfdHJhbmNoZXMubGVuZ3RoLzI7IGkrKykgewogICAgICB0cmFuY2hlc1tpXS5hbW91bnQgPSBfdHJhbmNoZXNbaSoyXTsKICAgICAgdHJhbmNoZXNbaV0ucHJpY2UgPSBfdHJhbmNoZXNbaSoyKzFdOwogICAgICAvLyBObyBpbnZhbGlkIHN0ZXBzCiAgICAgIHJlcXVpcmUoISgoaGlnaGVzdEFtb3VudCAhPSAwKSAmJiAodHJhbmNoZXNbaV0uYW1vdW50IDw9IGhpZ2hlc3RBbW91bnQpKSk7CiAgICAgIC8vIGlmKChoaWdoZXN0QW1vdW50ICE9IDApICYmICh0cmFuY2hlc1tpXS5hbW91bnQgPD0gaGlnaGVzdEFtb3VudCkpIHsKICAgICAgLy8gICB0aHJvdzsKICAgICAgLy8gfQogICAgICBoaWdoZXN0QW1vdW50ID0gdHJhbmNoZXNbaV0uYW1vdW50OwogICAgfQoKICAgIC8vIFdlIG5lZWQgdG8gc3RhcnQgZnJvbSB6ZXJvLCBvdGhlcndpc2Ugd2UgYmxvdyB1cCBvdXIgZGVwbG95bWVudAogICAgcmVxdWlyZSh0cmFuY2hlc1swXS5hbW91bnQgPT0gMCk7CiAgICAvLyBpZih0cmFuY2hlc1swXS5hbW91bnQgIT0gMCkgewogICAgLy8gICB0aHJvdzsKICAgIC8vIH0KCiAgICAvLyBMYXN0IHRyYW5jaGUgcHJpY2UgbXVzdCBiZSB6ZXJvLCB0ZXJtaW5hdGluZyB0aGUgY3Jvd2RhbGUKICAgIHJlcXVpcmUodHJhbmNoZXNbdHJhbmNoZUNvdW50LTFdLnByaWNlID09IDApOwogICAgLy8gaWYodHJhbmNoZXNbdHJhbmNoZUNvdW50LTFdLnByaWNlICE9IDApIHsKICAgIC8vICAgdGhyb3c7CiAgICAvLyB9CiAgfQoKICAvLy8gQGRldiBUaGlzIGlzIGludm9rZWQgb25jZSBmb3IgZXZlcnkgcHJlLUlDTyBhZGRyZXNzLCBzZXQgcHJpY2VQZXJUb2tlbgogIC8vLyAgICAgIHRvIDAgdG8gZGlzYWJsZQogIC8vLyBAcGFyYW0gcHJlaWNvQWRkcmVzcyBQcmVzYWxlRnVuZENvbGxlY3RvciBhZGRyZXNzCiAgLy8vIEBwYXJhbSBwcmljZVBlclRva2VuIEhvdyBtYW55IHdlaXMgb25lIHRva2VuIGNvc3QgZm9yIHByZS1pY28gaW52ZXN0b3JzCiAgZnVuY3Rpb24gc2V0UHJlaWNvQWRkcmVzcyhhZGRyZXNzIHByZWljb0FkZHJlc3MsIHVpbnQgcHJpY2VQZXJUb2tlbikKICAgIHB1YmxpYwogICAgb25seU93bmVyCiAgewogICAgcHJlaWNvQWRkcmVzc2VzW3ByZWljb0FkZHJlc3NdID0gcHJpY2VQZXJUb2tlbjsKICB9CgogIC8vLyBAZGV2IEl0ZXJhdGUgdGhyb3VnaCB0cmFuY2hlcy4gWW91IHJlYWNoIGVuZCBvZiB0cmFuY2hlcyB3aGVuIHByaWNlID0gMAogIC8vLyBAcmV0dXJuIHR1cGxlICh0aW1lLCBwcmljZSkKICBmdW5jdGlvbiBnZXRUcmFuY2hlKHVpbnQgbikgcHVibGljIGNvbnN0YW50IHJldHVybnMgKHVpbnQsIHVpbnQpIHsKICAgIHJldHVybiAodHJhbmNoZXNbbl0uYW1vdW50LCB0cmFuY2hlc1tuXS5wcmljZSk7CiAgfQoKICBmdW5jdGlvbiBnZXRGaXJzdFRyYW5jaGUoKSBwcml2YXRlIGNvbnN0YW50IHJldHVybnMgKFRyYW5jaGUpIHsKICAgIHJldHVybiB0cmFuY2hlc1swXTsKICB9CgogIGZ1bmN0aW9uIGdldExhc3RUcmFuY2hlKCkgcHJpdmF0ZSBjb25zdGFudCByZXR1cm5zIChUcmFuY2hlKSB7CiAgICByZXR1cm4gdHJhbmNoZXNbdHJhbmNoZUNvdW50LTFdOwogIH0KCiAgZnVuY3Rpb24gZ2V0UHJpY2luZ1N0YXJ0c0F0KCkgcHVibGljIGNvbnN0YW50IHJldHVybnMgKHVpbnQpIHsKICAgIHJldHVybiBnZXRGaXJzdFRyYW5jaGUoKS5hbW91bnQ7CiAgfQoKICBmdW5jdGlvbiBnZXRQcmljaW5nRW5kc0F0KCkgcHVibGljIGNvbnN0YW50IHJldHVybnMgKHVpbnQpIHsKICAgIHJldHVybiBnZXRMYXN0VHJhbmNoZSgpLmFtb3VudDsKICB9CgogIGZ1bmN0aW9uIGlzU2FuZShhZGRyZXNzIF9jcm93ZHNhbGUpIHB1YmxpYyBjb25zdGFudCByZXR1cm5zKGJvb2wpIHsKICAgIC8vIE91ciB0cmFuY2hlcyBhcmUgbm90IGJvdW5kIGJ5IHRpbWUsIHNvIHdlIGNhbid0IHJlYWxseSBjaGVjayBhcmUgd2Ugc2FuZQogICAgLy8gc28gd2UgcHJlc3VtZSB3ZSBhcmUgOykKICAgIC8vIEluIHRoZSBmdXR1cmUgd2UgY291bGQgc2F2ZSBhbmQgdHJhY2sgcmFpc2VkIHRva2VucywgYW5kIGNvbXBhcmUgaXQgdG8KICAgIC8vIHRoZSBDcm93ZHNhbGUgY29udHJhY3QuCiAgICByZXR1cm4gdHJ1ZTsKICB9CgogIC8vLyBAZGV2IEdldCB0aGUgY3VycmVudCB0cmFuY2hlIG9yIGJhaWwgb3V0IGlmIHdlIGFyZSBub3QgaW4gdGhlIHRyYW5jaGUgcGVyaW9kcy4KICAvLy8gQHBhcmFtIHdlaVJhaXNlZCB0b3RhbCBhbW91bnQgb2Ygd2VpcyByYWlzZWQsIGZvciBjYWxjdWxhdGluZyB0aGUgY3VycmVudCB0cmFuY2hlCiAgLy8vIEByZXR1cm4ge1t0eXBlXX0gW2Rlc2NyaXB0aW9uXQogIGZ1bmN0aW9uIGdldEN1cnJlbnRUcmFuY2hlKHVpbnQgd2VpUmFpc2VkKSBwcml2YXRlIGNvbnN0YW50IHJldHVybnMgKFRyYW5jaGUpIHsKICAgIHVpbnQgaTsKICAgIGZvcihpPTA7IGkgPCB0cmFuY2hlcy5sZW5ndGg7IGkrKykgewogICAgICBpZih3ZWlSYWlzZWQgPCB0cmFuY2hlc1tpXS5hbW91bnQpIHsKICAgICAgICByZXR1cm4gdHJhbmNoZXNbaS0xXTsKICAgICAgfQogICAgfQogIH0KCiAgLy8vIEBkZXYgR2V0IHRoZSBjdXJyZW50IHByaWNlLgogIC8vLyBAcGFyYW0gd2VpUmFpc2VkIHRvdGFsIGFtb3VudCBvZiB3ZWlzIHJhaXNlZCwgZm9yIGNhbGN1bGF0aW5nIHRoZSBjdXJyZW50IHRyYW5jaGUKICAvLy8gQHJldHVybiBUaGUgY3VycmVudCBwcmljZSBvciAwIGlmIHdlIGFyZSBvdXRzaWRlIHRyYWNoZSByYW5nZXMKICBmdW5jdGlvbiBnZXRDdXJyZW50UHJpY2UodWludCB3ZWlSYWlzZWQpIHB1YmxpYyBjb25zdGFudCByZXR1cm5zICh1aW50IHJlc3VsdCkgewogICAgcmV0dXJuIGdldEN1cnJlbnRUcmFuY2hlKHdlaVJhaXNlZCkucHJpY2U7CiAgfQoKICAvLy8gQGRldiBDYWxjdWxhdGUgdGhlIGN1cnJlbnQgcHJpY2UgZm9yIGJ1eSBpbiBhbW91bnQuCiAgZnVuY3Rpb24gY2FsY3VsYXRlUHJpY2UodWludCB2YWx1ZSwgdWludCB3ZWlSYWlzZWQsIHVpbnQgdG9rZW5zU29sZCwgYWRkcmVzcyBtc2dTZW5kZXIsIHVpbnQgZGVjaW1hbHMpIHB1YmxpYyBjb25zdGFudCByZXR1cm5zICh1aW50KSB7CgogICAgdWludCBtdWx0aXBsaWVyID0gMTAgKiogZGVjaW1hbHM7CgogICAgLy8gVGhpcyBpbnZlc3RvciBpcyBjb21pbmcgdGhyb3VnaCBwcmUtaWNvCiAgICBpZihwcmVpY29BZGRyZXNzZXNbbXNnU2VuZGVyXSA+IDApIHsKICAgICAgcmV0dXJuIHNhZmVNdWwodmFsdWUsIG11bHRpcGxpZXIpIC8gcHJlaWNvQWRkcmVzc2VzW21zZ1NlbmRlcl07CiAgICB9CgogICAgdWludCBwcmljZSA9IGdldEN1cnJlbnRQcmljZSh3ZWlSYWlzZWQpOwogICAgCiAgICByZXR1cm4gc2FmZU11bCh2YWx1ZSwgbXVsdGlwbGllcikgLyBwcmljZTsKICB9CgogIGZ1bmN0aW9uKCkgcGF5YWJsZSB7CiAgICByZXF1aXJlKGZhbHNlKTsgLy8gTm8gbW9uZXkgb24gdGhpcyBjb250cmFjdAogIH0KCn0KCgovKioKICogQ29udHJhY3QgdG8gZW5mb3JjZSBUb2tlbiBWZXN0aW5nCiAqLwpjb250cmFjdCBUb2tlblZlc3RpbmcgaXMgQWxsb2NhdGFibGUsIFNhZmVNYXRoTGliIHsKCiAgICBhZGRyZXNzIHB1YmxpYyBMQUxBVG9rZW5BZGRyZXNzOwoKICAgIC8qKiBrZWVwIHRyYWNrIG9mIHRvdGFsIHRva2VucyB5ZXQgdG8gYmUgcmVsZWFzZWQsIAogICAgICogdGhpcyBzaG91bGQgYmUgbGVzcyB0aGFuIG9yIGVxdWFsIHRvIExBTEEgdG9rZW5zIGhlbGQgYnkgdGhpcyBjb250cmFjdC4gCiAgICAgKi8KICAgIHVpbnQgcHVibGljIHRvdGFsVW5yZWxlYXNlZFRva2VuczsKCiAgICAvLyBkZWZhdWx0IHZlc3RpbmcgcGFyYW1ldGVycwogICAgdWludCBzdGFydEF0ID0gMDsKICAgIHVpbnQgY2xpZmYgPSAzOwogICAgdWludCBkdXJhdGlvbiA9IDEyOyAKICAgIHVpbnQgc3RlcCA9IDI1OTIwMDA7CiAgICBib29sIGNoYW5nZUZyZWV6ZWQgPSBmYWxzZTsKCiAgICBzdHJ1Y3QgVmVzdGluZ1NjaGVkdWxlIHsKICAgICAgICB1aW50IHN0YXJ0QXQ7CiAgICAgICAgdWludCBjbGlmZjsKICAgICAgICB1aW50IGR1cmF0aW9uOwogICAgICAgIHVpbnQgc3RlcDsKICAgICAgICB1aW50IGFtb3VudDsKICAgICAgICB1aW50IGFtb3VudFJlbGVhc2VkOwogICAgICAgIGJvb2wgY2hhbmdlRnJlZXplZDsKICAgIH0KCiAgICBtYXBwaW5nIChhZGRyZXNzID0+IFZlc3RpbmdTY2hlZHVsZSkgcHVibGljIHZlc3RpbmdNYXA7CgogICAgZXZlbnQgVmVzdGVkVG9rZW5zUmVsZWFzZWQoYWRkcmVzcyBfYWRyLCB1aW50IF9hbW91bnQpOwoKCiAgICBmdW5jdGlvbiBUb2tlblZlc3RpbmcoYWRkcmVzcyBfTEFMQVRva2VuQWRkcmVzcykgewogICAgICAgIExBTEFUb2tlbkFkZHJlc3MgPSBfTEFMQVRva2VuQWRkcmVzczsKICAgIH0KCgogICAgLyoqIE1vZGlmaWVyIHRvIGNoZWNrIGlmIGNoYW5nZXMgdG8gdmVzdGluZyBpcyBmcmVlemVkICAqLwogICAgbW9kaWZpZXIgY2hhbmdlc1RvVmVzdGluZ0ZyZWV6ZWQoYWRkcmVzcyBfYWRyKXsKICAgICAgICByZXF1aXJlKHZlc3RpbmdNYXBbX2Fkcl0uY2hhbmdlRnJlZXplZCk7CiAgICAgICAgXzsKICAgIH0KCgogICAgLyoqIE1vZGlmaWVyIHRvIGNoZWNrIGlmIGNoYW5nZXMgdG8gdmVzdGluZyBpcyBub3QgZnJlZXplZCB5ZXQgICovCiAgICBtb2RpZmllciBjaGFuZ2VzVG9WZXN0aW5nTm90RnJlZXplZChhZGRyZXNzIGFkcikgewogICAgICAgIHJlcXVpcmUoIXZlc3RpbmdNYXBbYWRyXS5jaGFuZ2VGcmVlemVkKTsgLy8gaWYgdmVzdGluZyBub3Qgc2V0IHRoZW4gYWxzbyBjaGFuZ2VGcmVlemVkIHdpbGwgYmUgZmFsc2UKICAgICAgICBfOwogICAgfQoKCiAgICAvKiogRnVuY3Rpb24gdG8gc2V0IGRlZmF1bHQgdmVzdGluZyBzY2hlZHVsZSBwYXJhbWV0ZXJzLiAqLwogICAgZnVuY3Rpb24gc2V0RGVmYXVsdFZlc3RpbmdQYXJhbWV0ZXJzKHVpbnQgX3N0YXJ0QXQsIHVpbnQgX2NsaWZmLCB1aW50IF9kdXJhdGlvbiwgCiAgICAgICAgdWludCBfc3RlcCwgYm9vbCBfY2hhbmdlRnJlZXplZCkgb25seUFsbG9jYXRlQWdlbnQgewoKICAgICAgICAvLyBkYXRhIHZhbGlkYXRpb24KICAgICAgICByZXF1aXJlKF9zdGVwICE9IDApOwogICAgICAgIHJlcXVpcmUoX2R1cmF0aW9uICE9IDApOwogICAgICAgIHJlcXVpcmUoX2NsaWZmIDw9IF9kdXJhdGlvbik7CgogICAgICAgIHN0YXJ0QXQgPSBfc3RhcnRBdDsKICAgICAgICBjbGlmZiA9IF9jbGlmZjsKICAgICAgICBkdXJhdGlvbiA9IF9kdXJhdGlvbjsgCiAgICAgICAgc3RlcCA9IF9zdGVwOwogICAgICAgIGNoYW5nZUZyZWV6ZWQgPSBfY2hhbmdlRnJlZXplZDsKCiAgICB9CgogICAgLyoqIEZ1bmN0aW9uIHRvIHNldCB2ZXN0aW5nIHdpdGggZGVmYXVsdCBzY2hlZHVsZS4gKi8KICAgIGZ1bmN0aW9uIHNldFZlc3RpbmdXaXRoRGVmYXVsdFNjaGVkdWxlKGFkZHJlc3MgX2FkciwgdWludCBfYW1vdW50KSAKICAgICAgICBjaGFuZ2VzVG9WZXN0aW5nTm90RnJlZXplZChfYWRyKSBvbmx5QWxsb2NhdGVBZ2VudCB7CiAgICAgICAgc2V0VmVzdGluZyhfYWRyLCBzdGFydEF0LCBjbGlmZiwgZHVyYXRpb24sIHN0ZXAsIF9hbW91bnQsIGNoYW5nZUZyZWV6ZWQpOwogICAgfQoKICAgIC8qKiBGdW5jdGlvbiB0byBzZXQvdXBkYXRlIHZlc3Rpbmcgc2NoZWR1bGUuIFBTIC0gQW1vdW50IGNhbm5vdCBiZSBjaGFuZ2VkIG9uY2Ugc2V0ICovCiAgICBmdW5jdGlvbiBzZXRWZXN0aW5nKGFkZHJlc3MgX2FkciwgdWludCBfc3RhcnRBdCwgdWludCBfY2xpZmYsIHVpbnQgX2R1cmF0aW9uLCAKICAgICAgICB1aW50IF9zdGVwLCB1aW50IF9hbW91bnQsIGJvb2wgX2NoYW5nZUZyZWV6ZWQpIGNoYW5nZXNUb1Zlc3RpbmdOb3RGcmVlemVkKF9hZHIpIG9ubHlBbGxvY2F0ZUFnZW50IHsKCiAgICAgICAgVmVzdGluZ1NjaGVkdWxlIHN0b3JhZ2UgdmVzdGluZ1NjaGVkdWxlID0gdmVzdGluZ01hcFtfYWRyXTsKCiAgICAgICAgLy8gZGF0YSB2YWxpZGF0aW9uCiAgICAgICAgcmVxdWlyZShfc3RlcCAhPSAwKTsKICAgICAgICByZXF1aXJlKF9hbW91bnQgIT0gMCB8fCB2ZXN0aW5nU2NoZWR1bGUuYW1vdW50ID4gMCk7CiAgICAgICAgcmVxdWlyZShfZHVyYXRpb24gIT0gMCk7CiAgICAgICAgcmVxdWlyZShfY2xpZmYgPD0gX2R1cmF0aW9uKTsKCiAgICAgICAgLy9pZiBzdGFydEF0IGlzIHplcm8sIHNldCBjdXJyZW50IHRpbWUgYXMgc3RhcnQgdGltZS4KICAgICAgICBpZiAoX3N0YXJ0QXQgPT0gMCkgCiAgICAgICAgICAgIF9zdGFydEF0ID0gYmxvY2sudGltZXN0YW1wOwoKICAgICAgICB2ZXN0aW5nU2NoZWR1bGUuc3RhcnRBdCA9IF9zdGFydEF0OwogICAgICAgIHZlc3RpbmdTY2hlZHVsZS5jbGlmZiA9IF9jbGlmZjsKICAgICAgICB2ZXN0aW5nU2NoZWR1bGUuZHVyYXRpb24gPSBfZHVyYXRpb247CiAgICAgICAgdmVzdGluZ1NjaGVkdWxlLnN0ZXAgPSBfc3RlcDsKCiAgICAgICAgLy8gc3BlY2lhbCBwcm9jZXNzaW5nIGZvciBmaXJzdCB0aW1lIHZlc3Rpbmcgc2V0dGluZwogICAgICAgIGlmICh2ZXN0aW5nU2NoZWR1bGUuYW1vdW50ID09IDApIHsKICAgICAgICAgICAgLy8gY2hlY2sgaWYgZW5vdWdoIHRva2VucyBhcmUgaGVsZCBieSB0aGlzIGNvbnRyYWN0CiAgICAgICAgICAgIEVSQzIwIExBTEFUb2tlbiA9IEVSQzIwKExBTEFUb2tlbkFkZHJlc3MpOwogICAgICAgICAgICByZXF1aXJlKExBTEFUb2tlbi5iYWxhbmNlT2YodGhpcykgPj0gc2FmZUFkZCh0b3RhbFVucmVsZWFzZWRUb2tlbnMsIF9hbW91bnQpKTsKICAgICAgICAgICAgdG90YWxVbnJlbGVhc2VkVG9rZW5zID0gc2FmZUFkZCh0b3RhbFVucmVsZWFzZWRUb2tlbnMsIF9hbW91bnQpOwogICAgICAgICAgICB2ZXN0aW5nU2NoZWR1bGUuYW1vdW50ID0gX2Ftb3VudDsgCiAgICAgICAgfQoKICAgICAgICB2ZXN0aW5nU2NoZWR1bGUuYW1vdW50UmVsZWFzZWQgPSAwOwogICAgICAgIHZlc3RpbmdTY2hlZHVsZS5jaGFuZ2VGcmVlemVkID0gX2NoYW5nZUZyZWV6ZWQ7CiAgICB9CgogICAgZnVuY3Rpb24gaXNWZXN0aW5nU2V0KGFkZHJlc3MgYWRyKSBwdWJsaWMgY29uc3RhbnQgcmV0dXJucyAoYm9vbCBpc1NldCkgewogICAgICAgIHJldHVybiB2ZXN0aW5nTWFwW2Fkcl0uYW1vdW50ICE9IDA7CiAgICB9CgogICAgZnVuY3Rpb24gZnJlZXplQ2hhbmdlc1RvVmVzdGluZyhhZGRyZXNzIF9hZHIpIGNoYW5nZXNUb1Zlc3RpbmdOb3RGcmVlemVkKF9hZHIpIG9ubHlBbGxvY2F0ZUFnZW50IHsKICAgICAgICByZXF1aXJlKGlzVmVzdGluZ1NldChfYWRyKSk7IC8vIGZpcnN0IGNoZWNrIGlmIHZlc3RpbmcgaXMgc2V0CiAgICAgICAgdmVzdGluZ01hcFtfYWRyXS5jaGFuZ2VGcmVlemVkID0gdHJ1ZTsKICAgIH0KCgogICAgLyoqIFJlbGVhc2UgdG9rZW5zIGFzIHBlciB2ZXN0aW5nIHNjaGVkdWxlLCBjYWxsZWQgYnkgY29udHJpYnV0b3IgICovCiAgICBmdW5jdGlvbiByZWxlYXNlTXlWZXN0ZWRUb2tlbnMoKSBjaGFuZ2VzVG9WZXN0aW5nRnJlZXplZChtc2cuc2VuZGVyKSB7CiAgICAgICAgcmVsZWFzZVZlc3RlZFRva2Vucyhtc2cuc2VuZGVyKTsKICAgIH0KCiAgICAvKiogUmVsZWFzZSB0b2tlbnMgYXMgcGVyIHZlc3Rpbmcgc2NoZWR1bGUsIGNhbGxlZCBieSBhbnlvbmUgICovCiAgICBmdW5jdGlvbiByZWxlYXNlVmVzdGVkVG9rZW5zKGFkZHJlc3MgX2FkcikgY2hhbmdlc1RvVmVzdGluZ0ZyZWV6ZWQoX2FkcikgewogICAgICAgIFZlc3RpbmdTY2hlZHVsZSBzdG9yYWdlIHZlc3RpbmdTY2hlZHVsZSA9IHZlc3RpbmdNYXBbX2Fkcl07CiAgICAgICAgCiAgICAgICAgLy8gY2hlY2sgaWYgYWxsIHRva2VucyBhcmUgbm90IHZlc3RlZAogICAgICAgIHJlcXVpcmUoc2FmZVN1Yih2ZXN0aW5nU2NoZWR1bGUuYW1vdW50LCB2ZXN0aW5nU2NoZWR1bGUuYW1vdW50UmVsZWFzZWQpID4gMCk7CiAgICAgICAgCiAgICAgICAgLy8gY2FsY3VsYXRlIHRvdGFsIHZlc3RlZCB0b2tlbnMgdGlsbCBub3cKICAgICAgICB1aW50IHRvdGFsVGltZSA9IGJsb2NrLnRpbWVzdGFtcCAtIHZlc3RpbmdTY2hlZHVsZS5zdGFydEF0OwogICAgICAgIHVpbnQgdG90YWxTdGVwcyA9IHRvdGFsVGltZSAvIHZlc3RpbmdTY2hlZHVsZS5zdGVwOwoKICAgICAgICAvLyBjaGVjayBpZiBjbGlmZiBpcyBwYXNzZWQKICAgICAgICByZXF1aXJlKHZlc3RpbmdTY2hlZHVsZS5jbGlmZiA8PSB0b3RhbFN0ZXBzKTsKCiAgICAgICAgdWludCB0b2tlbnNQZXJTdGVwID0gdmVzdGluZ1NjaGVkdWxlLmFtb3VudCAvIHZlc3RpbmdTY2hlZHVsZS5kdXJhdGlvbjsKICAgICAgICAvLyBjaGVjayBpZiBhbW91bnQgaXMgZGl2aXNibGUgYnkgZHVyYXRpb24KICAgICAgICBpZih0b2tlbnNQZXJTdGVwICogdmVzdGluZ1NjaGVkdWxlLmR1cmF0aW9uICE9IHZlc3RpbmdTY2hlZHVsZS5hbW91bnQpIHRva2Vuc1BlclN0ZXArKzsKCiAgICAgICAgdWludCB0b3RhbFJlbGVhc2FibGVBbW91bnQgPSBzYWZlTXVsKHRva2Vuc1BlclN0ZXAsIHRvdGFsU3RlcHMpOwoKICAgICAgICAvLyBoYW5kbGUgdGhlIGNhc2UgaWYgdXNlciBoYXMgbm90IGNsYWltZWQgZXZlbiBhZnRlciB2ZXN0aW5nIHBlcmlvZCBpcyBvdmVyIG9yIGFtb3VudCB3YXMgbm90IGRpdmlzaWJsZQogICAgICAgIGlmKHRvdGFsUmVsZWFzYWJsZUFtb3VudCA+IHZlc3RpbmdTY2hlZHVsZS5hbW91bnQpIHRvdGFsUmVsZWFzYWJsZUFtb3VudCA9IHZlc3RpbmdTY2hlZHVsZS5hbW91bnQ7CgogICAgICAgIHVpbnQgYW1vdW50VG9SZWxlYXNlID0gc2FmZVN1Yih0b3RhbFJlbGVhc2FibGVBbW91bnQsIHZlc3RpbmdTY2hlZHVsZS5hbW91bnRSZWxlYXNlZCk7CiAgICAgICAgdmVzdGluZ1NjaGVkdWxlLmFtb3VudFJlbGVhc2VkID0gc2FmZUFkZCh2ZXN0aW5nU2NoZWR1bGUuYW1vdW50UmVsZWFzZWQsIGFtb3VudFRvUmVsZWFzZSk7CgogICAgICAgIC8vIHRyYW5zZmVyIHZlc3RlZCB0b2tlbnMKICAgICAgICBFUkMyMCBMQUxBVG9rZW4gPSBFUkMyMChMQUxBVG9rZW5BZGRyZXNzKTsKICAgICAgICBMQUxBVG9rZW4udHJhbnNmZXIoX2FkciwgYW1vdW50VG9SZWxlYXNlKTsKICAgICAgICAvLyBkZWNyZW1lbnQgb3ZlcmFsbCB1bnJlbGVhc2VkIHRva2VuIGNvdW50CiAgICAgICAgdG90YWxVbnJlbGVhc2VkVG9rZW5zID0gc2FmZVN1Yih0b3RhbFVucmVsZWFzZWRUb2tlbnMsIGFtb3VudFRvUmVsZWFzZSk7CiAgICAgICAgVmVzdGVkVG9rZW5zUmVsZWFzZWQoX2FkciwgYW1vdW50VG9SZWxlYXNlKTsKICAgIH0KCn0='.
	

]
