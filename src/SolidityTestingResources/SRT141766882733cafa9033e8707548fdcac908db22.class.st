Class {
	#name : #SRT141766882733cafa9033e8707548fdcac908db22,
	#superclass : #SRTContracts,
	#category : #SolidityTestingResources
}

{ #category : #base64 }
SRT141766882733cafa9033e8707548fdcac908db22 >> base64 [
	^ 'cHJhZ21hIHNvbGlkaXR5IF4wLjQuMTk7CgovKioKICogQHRpdGxlIE93bmFibGUKICogQGRldiBUaGUgT3duYWJsZSBjb250cmFjdCBoYXMgYW4gb3duZXIgYWRkcmVzcywgYW5kIHByb3ZpZGVzIGJhc2ljIGF1dGhvcml6YXRpb24gY29udHJvbAogKiBmdW5jdGlvbnMsIHRoaXMgc2ltcGxpZmllcyB0aGUgaW1wbGVtZW50YXRpb24gb2YgInVzZXIgcGVybWlzc2lvbnMiLgogKi8KY29udHJhY3QgT3duYWJsZSB7CgogIGFkZHJlc3MgcHVibGljIG93bmVyOwoKICBldmVudCBPd25lcnNoaXBUcmFuc2ZlcnJlZChhZGRyZXNzIGluZGV4ZWQgcHJldmlvdXNPd25lciwgYWRkcmVzcyBpbmRleGVkIG5ld093bmVyKTsKCiAgLyoqCiAgICogQGRldiBUaGUgT3duYWJsZSBjb25zdHJ1Y3RvciBzZXRzIHRoZSBvcmlnaW5hbCBgb3duZXJgIG9mIHRoZSBjb250cmFjdCB0byB0aGUgc2VuZGVyCiAgICogYWNjb3VudC4KICAgKi8KICBmdW5jdGlvbiBPd25hYmxlKCkgcHVibGljIHsKICAgIG93bmVyID0gbXNnLnNlbmRlcjsKICB9CgogIC8qKgogICAqIEBkZXYgVGhyb3dzIGlmIGNhbGxlZCBieSBhbnkgYWNjb3VudCBvdGhlciB0aGFuIHRoZSBvd25lci4KICAgKi8KICBtb2RpZmllciBvbmx5T3duZXIoKSB7CiAgICByZXF1aXJlKG1zZy5zZW5kZXIgPT0gb3duZXIpOwogICAgXzsKICB9CgogIC8qKgogICAqIEBkZXYgQWxsb3dzIHRoZSBjdXJyZW50IG93bmVyIHRvIHRyYW5zZmVyIGNvbnRyb2wgb2YgdGhlIGNvbnRyYWN0IHRvIGEgbmV3T3duZXIuCiAgICogQHBhcmFtIG5ld093bmVyIFRoZSBhZGRyZXNzIHRvIHRyYW5zZmVyIG93bmVyc2hpcCB0by4KICAgKi8KICBmdW5jdGlvbiB0cmFuc2Zlck93bmVyc2hpcChhZGRyZXNzIG5ld093bmVyKSBvbmx5T3duZXIgcHVibGljIHsKICAgIHJlcXVpcmUobmV3T3duZXIgIT0gYWRkcmVzcygwKSk7CiAgICBPd25lcnNoaXBUcmFuc2ZlcnJlZChvd25lciwgbmV3T3duZXIpOwogICAgb3duZXIgPSBuZXdPd25lcjsKICB9Cgp9CgovKioKICogQHRpdGxlIEVqZWN0YWJsZU93bmFibGUKICogQGRldiBUaGUgRWplY3RhYmxlT3duYWJsZSBjb250cmFjdCBwcm92aWRlcyB0aGUgZnVuY3Rpb24gdG8gcmVtb3ZlIHRoZSBvd25lcnNoaXAgb2YgdGhlIGNvbnRyYWN0LgogKi8KY29udHJhY3QgRWplY3RhYmxlT3duYWJsZSBpcyBPd25hYmxlIHsKCiAgICAvKioKICAgICAqIEBkZXYgUmVtb3ZlIHRoZSBvd25lcnNoaXAgYnkgc2V0dGluZyB0aGUgb3duZXIgYWRkcmVzcyB0byBudWxsLAogICAgICogYWZ0ZXIgY2FsbGluZyB0aGlzIGZ1bmN0aW9uLCBhbGwgb25seU93bmVyIGZ1bmN0aW9uIHdpbGwgYmUgYmUgYWJsZSB0byBiZSBjYWxsZWQgYnkgYW55b25lIGFueW1vcmUsCiAgICAgKiB0aGUgY29udHJhY3Qgd2lsbCBhY2hpZXZlIHRydWx5IGRlY2VudHJhbGlzYXRpb24uCiAgICAqLwogICAgZnVuY3Rpb24gcmVtb3ZlT3duZXJzaGlwKCkgb25seU93bmVyIHB1YmxpYyB7CiAgICAgICAgb3duZXIgPSAweDA7CiAgICB9Cgp9CgovKioKICogQHRpdGxlIEpvaW50T3duYWJsZQogKiBAZGV2IEV4dGVuc2lvbiBmb3IgdGhlIE93bmFibGUgY29udHJhY3QsIHdoZXJlIHRoZSBvd25lciBjYW4gYXNzaWduIGF0IG1vc3QgMiBvdGhlciBhZGRyZXNzZXMKICogIHRvIG1hbmFnZSBzb21lIGZ1bmN0aW9ucyBvZiB0aGUgY29udHJhY3QsIHVzaW5nIHRoZSBlaXRoZXJPd25lciBtb2RpZmllci4KICogIE5vdGUgdGhhdCBvbmx5T3duZXIgbW9kaWZpZXIgd291bGQgc3RpbGwgYmUgYWNjZXNzaWJsZSBvbmx5IGZvciB0aGUgb3JpZ2luYWwgb3duZXIuCiAqLwpjb250cmFjdCBKb2ludE93bmFibGUgaXMgT3duYWJsZSB7CgogIGV2ZW50IEFub3RoZXJPd25lckFzc2lnbmVkKGFkZHJlc3MgaW5kZXhlZCBhbm90aGVyT3duZXIpOwoKICBhZGRyZXNzIHB1YmxpYyBhbm90aGVyT3duZXIxOwogIGFkZHJlc3MgcHVibGljIGFub3RoZXJPd25lcjI7CgogIC8qKgogICAqIEBkZXYgVGhyb3dzIGlmIGNhbGxlZCBieSBhbnkgYWNjb3VudCBvdGhlciB0aGFuIHRoZSBvd25lciBvciBhbm90aGVyT3duZXIuCiAgICovCiAgbW9kaWZpZXIgZWl0aGVyT3duZXIoKSB7CiAgICByZXF1aXJlKG1zZy5zZW5kZXIgPT0gb3duZXIgfHwgbXNnLnNlbmRlciA9PSBhbm90aGVyT3duZXIxIHx8IG1zZy5zZW5kZXIgPT0gYW5vdGhlck93bmVyMik7CiAgICBfOwogIH0KCiAgLyoqCiAgICogQGRldiBBbGxvd3MgdGhlIGN1cnJlbnQgb3duZXIgdG8gYXNzaWduIGFub3RoZXIgb3duZXIuCiAgICogQHBhcmFtIF9hbm90aGVyT3duZXIgVGhlIGFkZHJlc3MgdG8gYW5vdGhlciBvd25lci4KICAgKi8KICBmdW5jdGlvbiBhc3NpZ25Bbm90aGVyT3duZXIxKGFkZHJlc3MgX2Fub3RoZXJPd25lcikgb25seU93bmVyIHB1YmxpYyB7CiAgICByZXF1aXJlKF9hbm90aGVyT3duZXIgIT0gMCk7CiAgICBBbm90aGVyT3duZXJBc3NpZ25lZChfYW5vdGhlck93bmVyKTsKICAgIGFub3RoZXJPd25lcjEgPSBfYW5vdGhlck93bmVyOwogIH0KCiAgLyoqCiAgICogQGRldiBBbGxvd3MgdGhlIGN1cnJlbnQgb3duZXIgdG8gYXNzaWduIGFub3RoZXIgb3duZXIuCiAgICogQHBhcmFtIF9hbm90aGVyT3duZXIgVGhlIGFkZHJlc3MgdG8gYW5vdGhlciBvd25lci4KICAgKi8KICBmdW5jdGlvbiBhc3NpZ25Bbm90aGVyT3duZXIyKGFkZHJlc3MgX2Fub3RoZXJPd25lcikgb25seU93bmVyIHB1YmxpYyB7CiAgICByZXF1aXJlKF9hbm90aGVyT3duZXIgIT0gMCk7CiAgICBBbm90aGVyT3duZXJBc3NpZ25lZChfYW5vdGhlck93bmVyKTsKICAgIGFub3RoZXJPd25lcjIgPSBfYW5vdGhlck93bmVyOwogIH0KCn0KCi8qKgogKiBAdGl0bGUgUGF1c2FibGUKICogQGRldiBCYXNlIGNvbnRyYWN0IHdoaWNoIGFsbG93cyBjaGlsZHJlbiB0byBpbXBsZW1lbnQgYW4gZW1lcmdlbmN5IHN0b3AgbWVjaGFuaXNtLgogKi8KY29udHJhY3QgUGF1c2FibGUgaXMgT3duYWJsZSB7CgogIGV2ZW50IFBhdXNlKCk7CiAgZXZlbnQgVW5wYXVzZSgpOwoKICBib29sIHB1YmxpYyBwYXVzZWQgPSBmYWxzZTsKCiAgLyoqCiAgICogQGRldiBNb2RpZmllciB0byBtYWtlIGEgZnVuY3Rpb24gY2FsbGFibGUgb25seSB3aGVuIHRoZSBjb250cmFjdCBpcyBub3QgcGF1c2VkLgogICAqLwogIG1vZGlmaWVyIHdoZW5Ob3RQYXVzZWQoKSB7CiAgICByZXF1aXJlKCFwYXVzZWQpOwogICAgXzsKICB9CgogIC8qKgogICAqIEBkZXYgTW9kaWZpZXIgdG8gbWFrZSBhIGZ1bmN0aW9uIGNhbGxhYmxlIG9ubHkgd2hlbiB0aGUgY29udHJhY3QgaXMgcGF1c2VkLgogICAqLwogIG1vZGlmaWVyIHdoZW5QYXVzZWQoKSB7CiAgICByZXF1aXJlKHBhdXNlZCk7CiAgICBfOwogIH0KCiAgLyoqCiAgICogQGRldiBjYWxsZWQgYnkgdGhlIG93bmVyIHRvIHBhdXNlLCB0cmlnZ2VycyBzdG9wcGVkIHN0YXRlCiAgICovCiAgZnVuY3Rpb24gcGF1c2UoKSBvbmx5T3duZXIgd2hlbk5vdFBhdXNlZCBwdWJsaWMgewogICAgcGF1c2VkID0gdHJ1ZTsKICAgIFBhdXNlKCk7CiAgfQoKICAvKioKICAgKiBAZGV2IGNhbGxlZCBieSB0aGUgb3duZXIgdG8gdW5wYXVzZSwgcmV0dXJucyB0byBub3JtYWwgc3RhdGUKICAgKi8KICBmdW5jdGlvbiB1bnBhdXNlKCkgb25seU93bmVyIHdoZW5QYXVzZWQgcHVibGljIHsKICAgIHBhdXNlZCA9IGZhbHNlOwogICAgVW5wYXVzZSgpOwogIH0KCn0KCi8qKgogKiBAdGl0bGUgRGVzdHJ1Y3RpYmxlCiAqIEBkZXYgQmFzZSBjb250cmFjdCB0aGF0IGNhbiBiZSBkZXN0cm95ZWQgYnkgb3duZXIuIEFsbCBmdW5kcyBpbiBjb250cmFjdCB3aWxsIGJlIHNlbnQgdG8gdGhlIG93bmVyLgogKi8KY29udHJhY3QgRGVzdHJ1Y3RpYmxlIGlzIE93bmFibGUgewoKICBmdW5jdGlvbiBEZXN0cnVjdGlibGUoKSBwdWJsaWMgcGF5YWJsZSB7IH0KCiAgLyoqCiAgICogQGRldiBUcmFuc2ZlcnMgdGhlIGN1cnJlbnQgYmFsYW5jZSB0byB0aGUgb3duZXIgYW5kIHRlcm1pbmF0ZXMgdGhlIGNvbnRyYWN0LgogICAqLwogIGZ1bmN0aW9uIGRlc3Ryb3koKSBvbmx5T3duZXIgcHVibGljIHsKICAgIHNlbGZkZXN0cnVjdChvd25lcik7CiAgfQoKICBmdW5jdGlvbiBkZXN0cm95QW5kU2VuZChhZGRyZXNzIF9yZWNpcGllbnQpIG9ubHlPd25lciBwdWJsaWMgewogICAgc2VsZmRlc3RydWN0KF9yZWNpcGllbnQpOwogIH0KCn0KCi8qKgogKiBAdGl0bGUgU2FmZU1hdGgKICogQGRldiBNYXRoIG9wZXJhdGlvbnMgd2l0aCBzYWZldHkgY2hlY2tzIHRoYXQgdGhyb3cgb24gZXJyb3IKICovCmxpYnJhcnkgU2FmZU1hdGggewoKICAvKioKICAqIEBkZXYgTXVsdGlwbGllcyB0d28gbnVtYmVycywgdGhyb3dzIG9uIG92ZXJmbG93LgogICovCiAgZnVuY3Rpb24gbXVsKHVpbnQyNTYgYSwgdWludDI1NiBiKSBpbnRlcm5hbCBwdXJlIHJldHVybnMgKHVpbnQyNTYpIHsKICAgIGlmIChhID09IDApIHsKICAgICAgcmV0dXJuIDA7CiAgICB9CiAgICB1aW50MjU2IGMgPSBhICogYjsKICAgIGFzc2VydChjIC8gYSA9PSBiKTsKICAgIHJldHVybiBjOwogIH0KCiAgLyoqCiAgKiBAZGV2IEludGVnZXIgZGl2aXNpb24gb2YgdHdvIG51bWJlcnMsIHRydW5jYXRpbmcgdGhlIHF1b3RpZW50LgogICovCiAgZnVuY3Rpb24gZGl2KHVpbnQyNTYgYSwgdWludDI1NiBiKSBpbnRlcm5hbCBwdXJlIHJldHVybnMgKHVpbnQyNTYpIHsKICAgIC8vIGFzc2VydChiID4gMCk7IC8vIFNvbGlkaXR5IGF1dG9tYXRpY2FsbHkgdGhyb3dzIHdoZW4gZGl2aWRpbmcgYnkgMAogICAgdWludDI1NiBjID0gYSAvIGI7CiAgICAvLyBhc3NlcnQoYSA9PSBiICogYyArIGEgJSBiKTsgLy8gVGhlcmUgaXMgbm8gY2FzZSBpbiB3aGljaCB0aGlzIGRvZXNuJ3QgaG9sZAogICAgcmV0dXJuIGM7CiAgfQoKICAvKioKICAqIEBkZXYgU3Vic3RyYWN0cyB0d28gbnVtYmVycywgdGhyb3dzIG9uIG92ZXJmbG93IChpLmUuIGlmIHN1YnRyYWhlbmQgaXMgZ3JlYXRlciB0aGFuIG1pbnVlbmQpLgogICovCiAgZnVuY3Rpb24gc3ViKHVpbnQyNTYgYSwgdWludDI1NiBiKSBpbnRlcm5hbCBwdXJlIHJldHVybnMgKHVpbnQyNTYpIHsKICAgIGFzc2VydChiIDw9IGEpOwogICAgcmV0dXJuIGEgLSBiOwogIH0KCiAgLyoqCiAgKiBAZGV2IEFkZHMgdHdvIG51bWJlcnMsIHRocm93cyBvbiBvdmVyZmxvdy4KICAqLwogIGZ1bmN0aW9uIGFkZCh1aW50MjU2IGEsIHVpbnQyNTYgYikgaW50ZXJuYWwgcHVyZSByZXR1cm5zICh1aW50MjU2KSB7CiAgICB1aW50MjU2IGMgPSBhICsgYjsKICAgIGFzc2VydChjID49IGEpOwogICAgcmV0dXJuIGM7CiAgfQoKfQoKLyoqCiAqIEB0aXRsZSBQdWxsUGF5bWVudAogKiBAZGV2IEJhc2UgY29udHJhY3Qgc3VwcG9ydGluZyBhc3luYyBzZW5kIGZvciBwdWxsIHBheW1lbnRzLiBJbmhlcml0IGZyb20gdGhpcwogKiBjb250cmFjdCBhbmQgdXNlIGFzeW5jU2VuZCBpbnN0ZWFkIG9mIHNlbmQuCiAqLwpjb250cmFjdCBQdWxsUGF5bWVudCB7CgogIHVzaW5nIFNhZmVNYXRoIGZvciB1aW50MjU2OwoKICBtYXBwaW5nKGFkZHJlc3MgPT4gdWludDI1NikgcHVibGljIHBheW1lbnRzOwogIHVpbnQyNTYgcHVibGljIHRvdGFsUGF5bWVudHM7CgogIC8qKgogICAqIEBkZXYgd2l0aGRyYXcgYWNjdW11bGF0ZWQgYmFsYW5jZSwgY2FsbGVkIGJ5IHBheWVlLgogICAqLwogIGZ1bmN0aW9uIHdpdGhkcmF3UGF5bWVudHMoKSBwdWJsaWMgewogICAgYWRkcmVzcyBwYXllZSA9IG1zZy5zZW5kZXI7CiAgICB1aW50MjU2IHBheW1lbnQgPSBwYXltZW50c1twYXllZV07CgogICAgcmVxdWlyZShwYXltZW50ICE9IDApOwogICAgcmVxdWlyZSh0aGlzLmJhbGFuY2UgPj0gcGF5bWVudCk7CgogICAgdG90YWxQYXltZW50cyA9IHRvdGFsUGF5bWVudHMuc3ViKHBheW1lbnQpOwogICAgcGF5bWVudHNbcGF5ZWVdID0gMDsKCiAgICBhc3NlcnQocGF5ZWUuc2VuZChwYXltZW50KSk7CiAgfQoKICAvKioKICAgKiBAZGV2IENhbGxlZCBieSB0aGUgcGF5ZXIgdG8gc3RvcmUgdGhlIHNlbnQgYW1vdW50IGFzIGNyZWRpdCB0byBiZSBwdWxsZWQuCiAgICogQHBhcmFtIGRlc3QgVGhlIGRlc3RpbmF0aW9uIGFkZHJlc3Mgb2YgdGhlIGZ1bmRzLgogICAqIEBwYXJhbSBhbW91bnQgVGhlIGFtb3VudCB0byB0cmFuc2Zlci4KICAgKi8KICBmdW5jdGlvbiBhc3luY1NlbmQoYWRkcmVzcyBkZXN0LCB1aW50MjU2IGFtb3VudCkgaW50ZXJuYWwgewogICAgcGF5bWVudHNbZGVzdF0gPSBwYXltZW50c1tkZXN0XS5hZGQoYW1vdW50KTsKICAgIHRvdGFsUGF5bWVudHMgPSB0b3RhbFBheW1lbnRzLmFkZChhbW91bnQpOwogIH0KCn0KCi8qKgogKiBAdGl0bGUgQSBzaW1wbGlmaWVkIGludGVyZmFjZSBvZiBFUkMtNzIxLCBidXQgd2l0aG91dCBhcHByb3ZhbCBmdW5jdGlvbnMKICovCmNvbnRyYWN0IEVSQzcyMSB7CgogICAgLy8gRXZlbnRzCiAgICBldmVudCBUcmFuc2ZlcihhZGRyZXNzIGluZGV4ZWQgZnJvbSwgYWRkcmVzcyBpbmRleGVkIHRvLCB1aW50IHRva2VuSWQpOwoKICAgIC8vIEVSQzIwIGNvbXBhdGlibGUgZnVuY3Rpb25zCiAgICAvLyBmdW5jdGlvbiBuYW1lKCkgcHVibGljIHZpZXcgcmV0dXJucyAoc3RyaW5nKTsKICAgIC8vIGZ1bmN0aW9uIHN5bWJvbCgpIHB1YmxpYyB2aWV3IHJldHVybnMgKHN0cmluZyk7CiAgICBmdW5jdGlvbiB0b3RhbFN1cHBseSgpIHB1YmxpYyB2aWV3IHJldHVybnMgKHVpbnQpOwogICAgZnVuY3Rpb24gYmFsYW5jZU9mKGFkZHJlc3MgX293bmVyKSBwdWJsaWMgdmlldyByZXR1cm5zICh1aW50KTsKCiAgICAvLyBGdW5jdGlvbnMgdGhhdCBkZWZpbmUgb3duZXJzaGlwCiAgICBmdW5jdGlvbiBvd25lck9mKHVpbnQgX3Rva2VuSWQpIGV4dGVybmFsIHZpZXcgcmV0dXJucyAoYWRkcmVzcyk7CiAgICBmdW5jdGlvbiB0cmFuc2ZlcihhZGRyZXNzIF90bywgdWludCBfdG9rZW5JZCkgZXh0ZXJuYWw7Cgp9Cgpjb250cmFjdCBEdW5nZW9uU3RydWN0cyB7CgogICAgLyoqCiAgICAgKiBAZGV2IFRoZSBtYWluIER1bmdlb24gc3RydWN0LiBFdmVyeSBkdW5nZW9uIGluIHRoZSBnYW1lIGlzIHJlcHJlc2VudGVkIGJ5IHRoaXMgc3RydWN0dXJlLgogICAgICogQSBkdW5nZW9uIGlzIGNvbnNpc3RzIG9mIGFuIHVubGltaXRlZCBudW1iZXIgb2YgZmxvb3JzIGZvciB5b3VyIGhlcm9lcyB0byBjaGFsbGVuZ2UsCiAgICAgKiB0aGUgcG93ZXIgbGV2ZWwgb2YgYSBkdW5nZW9uIGlzIGVuY29kZWQgaW4gdGhlIGZsb29yR2VuZXMuIFNvbWUgZHVuZ2VvbnMgYXJlIGluIGZhY3QgbW9yZSAiY2hhbGxlbmdpbmciIHRoYW4gb3RoZXJzLAogICAgICogdGhlIHNlY3JldCBmb3JtdWxhIGZvciB0aGF0IGlzIGxlZnQgZm9yIHVzZXIgdG8gZmluZCBvdXQuCiAgICAgKgogICAgICogRWFjaCBkdW5nZW9uIGFsc28gaGFzIGEgInRyYWluaW5nIGFyZWEiLCBoZXJvZXMgY2FuIHBlcmZvcm0gdHJhaW5pbmdzIGFuZCB1cGdyYWRlIHRoZWlyIHN0YXQsCiAgICAgKiBhbmQgc29tZSBkdW5nZW9ucyBhcmUgbW9yZSBlZmZlY3RpdmUgaW4gdGhlIHRyYWluaW5nLCB3aGljaCBpcyBhbHNvIGEgc2VjcmV0IGZvcm11bGEhCiAgICAgKgogICAgICogV2hlbiBwbGF5ZXIgY2hhbGxlbmdlIG9yIGRvIHRyYWluaW5nIGluIGEgZHVuZ2VvbiwgdGhlIGZlZSB3aWxsIGJlIGNvbGxlY3RlZCBhcyB0aGUgZHVuZ2VvbiByZXdhcmRzLAogICAgICogd2hpY2ggd2lsbCBiZSByZXdhcmRlZCB0byB0aGUgcGxheWVyIHdobyBzdWNjZXNzZnVsbHkgY2hhbGxlbmdlZCB0aGUgY3VycmVudCBmbG9vci4KICAgICAqCiAgICAgKiBFYWNoIGR1bmdlb24gZml0cyBpbiBmaXRzIGludG8gdGhyZWUgMjU2LWJpdCB3b3Jkcy4KICAgICAqLwogICAgc3RydWN0IER1bmdlb24gewoKICAgICAgICAvLyBFYWNoIGR1bmdlb24gaGFzIGFuIElEIHdoaWNoIGlzIHRoZSBpbmRleCBpbiB0aGUgc3RvcmFnZSBhcnJheS4KCiAgICAgICAgLy8gVGhlIHRpbWVzdGFtcCBvZiB0aGUgYmxvY2sgd2hlbiB0aGlzIGR1bmdlb24gaXMgY3JlYXRlZC4KICAgICAgICB1aW50MzIgY3JlYXRpb25UaW1lOwoKICAgICAgICAvLyBUaGUgc3RhdHVzIG9mIHRoZSBkdW5nZW9uLCBlYWNoIGR1bmdlb24gY2FuIGhhdmUgNSBzdGF0dXMsIG5hbWVseToKICAgICAgICAvLyAwOiBBY3RpdmUgfCAxOiBUcmFuc3BvcnQgT25seSB8IDI6IENoYWxsZW5nZSBPbmx5IHwgMzogVHJhaW4gT25seSB8IDQ6IEluQWN0aXZlCiAgICAgICAgdWludDggc3RhdHVzOwoKICAgICAgICAvLyBUaGUgZHVuZ2VvbidzIGRpZmZpY3VsdHksIHRoZSBoaWdoZXIgdGhlIGRpZmZpY3VsdHksCiAgICAgICAgLy8gbm9ybWFsbHksIHRoZSAicmFyZXIiIHRoZSBzZWVkR2VuZXMsIHRoZSBoaWdoZXIgdGhlIGRpZmZjdWx0eSwKICAgICAgICAvLyBhbmQgdGhlIGhpZ2hlciB0aGUgY29udHJpYnV0aW9uIGZlZSBpdCBpcyB0byBjaGFsbGVuZ2UsIHRyYWluLCBhbmQgdHJhbnNwb3J0IHRvIHRoZSBkdW5nZW9uLAogICAgICAgIC8vIHRoZSBmb3JtdWxhIGZvciB0aGUgY29udHJpYnV0aW9uIGZlZSBpcyBpbiBEdW5nZW9uQ2hhbGxlbmdlIGFuZCBEdW5nZW9uVHJhaW5pbmcgY29udHJhY3RzLgogICAgICAgIC8vIEEgZHVuZ2VvbidzIGRpZmZpY3VsdHkgbmV2ZXIgY2hhbmdlLgogICAgICAgIHVpbnQ4IGRpZmZpY3VsdHk7CgogICAgICAgIC8vIFRoZSBkdW5nZW9uJ3MgY2FwYWNpdHksIG1heGltdW0gbnVtYmVyIG9mIHBsYXllcnMgYWxsb3dlZCB0byBzdGF5IG9uIHRoaXMgZHVuZ2Vvbi4KICAgICAgICAvLyBUaGUgY2FwYWNpdHkgb2YgdGhlIG5ld2JpZSBkdW5nZW9uIChIb2x5bGFuZCkgaXMgc2V0IGF0IDAgKHdoaWNoIGlzIGluZmluaXR5KS4KICAgICAgICAvLyBVc2luZyAxNi1iaXQgdW5zaWduZWQgaW50ZWdlcnMgY2FuIGhhdmUgYSBtYXhpbXVtIG9mIDY1NTM1IGluIGNhcGFjaXR5LgogICAgICAgIC8vIEEgZHVuZ2VvbidzIGNhcGFjaXR5IG5ldmVyIGNoYW5nZS4KICAgICAgICB1aW50MTYgY2FwYWNpdHk7CgogICAgICAgIC8vIFRoZSBjdXJyZW50IGZsb29yIG51bWJlciwgYSBkdW5nZW9uIGlzIGNvbnNpc3RzIG9mIGFuIHVtbGltaXRlZCBudW1iZXIgb2YgZmxvb3JzLAogICAgICAgIC8vIHdoZW4gdGhlcmUgaXMgaGVyb2VzIHN1Y2Nlc3NmdWxseSBjaGFsbGVuZ2VkIGEgZmxvb3IsIHRoZSBuZXh0IGZsb29yIHdpbGwgYmUKICAgICAgICAvLyBhdXRvbWF0aWNhbGx5IGdlbmVyYXRlZC4gVXNpbmcgMzItYml0IHVuc2lnbmVkIGludGVnZXIgY2FuIGhhdmUgYSBtYXhpbXVtIG9mIDQgYmlsbGlvbiBmbG9vcnMuCiAgICAgICAgdWludDMyIGZsb29yTnVtYmVyOwoKICAgICAgICAvLyBUaGUgdGltZXN0YW1wIG9mIHRoZSBibG9jayB3aGVuIHRoZSBjdXJyZW50IGZsb29yIGlzIGdlbmVyYXRlZC4KICAgICAgICB1aW50MzIgZmxvb3JDcmVhdGlvblRpbWU7CgogICAgICAgIC8vIEN1cnJlbnQgYWNjdW11bGF0ZWQgcmV3YXJkcywgc3VjY2Vzc2Z1bCBjaGFsbGVuZ2VyIHdpbGwgZ2V0IGEgbGFyZ2UgcHJvcG9ydGlvbiBvZiBpdC4KICAgICAgICB1aW50MTI4IHJld2FyZHM7CgogICAgICAgIC8vIFRoZSBzZWVkIGdlbmVzIG9mIHRoZSBkdW5nZW9uLCBpdCBpcyB1c2VkIGFzIHRoZSBiYXNlIGdlbmUgZm9yIGZpcnN0IGZsb29yLAogICAgICAgIC8vIHNvbWUgZHVuZ2VvbnMgYXJlIHJhcmVyIGFuZCBzb21lIGFyZSBtb3JlIGNvbW1vbiwgdGhlIGV4YWN0IGRldGFpbHMgYXJlLAogICAgICAgIC8vIG9mIGNvdXJzZSwgdG9wIHNlY3JldCBvZiB0aGUgZ2FtZSEKICAgICAgICAvLyBBIGR1bmdlb24ncyBzZWVkR2VuZXMgbmV2ZXIgY2hhbmdlLgogICAgICAgIHVpbnQgc2VlZEdlbmVzOwoKICAgICAgICAvLyBUaGUgZ2VuZXMgZm9yIGN1cnJlbnQgZmxvb3IsIGl0IGVuY29kZXMgdGhlIGRpZmZpY3VsdHkgbGV2ZWwgb2YgdGhlIGN1cnJlbnQgZmxvb3IuCiAgICAgICAgLy8gV2UgY29uc2lkZXJlZCB3aGV0aGVyIHRvIHN0b3JlIHRoZSBlbnRpcmUgYXJyYXkgb2YgZ2VuZXMgZm9yIGFsbCBmbG9vcnMsIGJ1dAogICAgICAgIC8vIGluIG9yZGVyIHRvIHNhdmUgc29tZSBwcmVjaW91cyBnYXMgd2UncmUgd2lsbGluZyB0byBzYWNyaWZpY2Ugc29tZSBmdW5jdGlvbmFsaXRpZXMgd2l0aCB0aGF0LgogICAgICAgIHVpbnQgZmxvb3JHZW5lczsKCiAgICB9CgogICAgLyoqCiAgICAgKiBAZGV2IFRoZSBtYWluIEhlcm8gc3RydWN0LiBFdmVyeSBoZXJvIGluIHRoZSBnYW1lIGlzIHJlcHJlc2VudGVkIGJ5IHRoaXMgc3RydWN0dXJlLgogICAgICovCiAgICBzdHJ1Y3QgSGVybyB7CgogICAgICAgIC8vIEVhY2ggaGVybyBoYXMgYW4gSUQgd2hpY2ggaXMgdGhlIGluZGV4IGluIHRoZSBzdG9yYWdlIGFycmF5LgoKICAgICAgICAvLyBUaGUgdGltZXN0YW1wIG9mIHRoZSBibG9jayB3aGVuIHRoaXMgZHVuZ2VvbiBpcyBjcmVhdGVkLgogICAgICAgIHVpbnQ2NCBjcmVhdGlvblRpbWU7CgogICAgICAgIC8vIFRoZSB0aW1lc3RhbXAgb2YgdGhlIGJsb2NrIHdoZXJlIGEgY2hhbGxlbmdlIGlzIHBlcmZvcm1lZCwgdXNlZCB0byBjYWxjdWxhdGUgd2hlbiBhIGhlcm8gaXMgYWxsb3dlZCB0byBlbmdhZ2UgaW4gYW5vdGhlciBjaGFsbGVuZ2UuCiAgICAgICAgdWludDY0IGNvb2xkb3duU3RhcnRUaW1lOwoKICAgICAgICAvLyBFdmVyeSB0aW1lIGEgaGVybyBjaGFsbGVuZ2UgYSBkdW5nZW9uLCBpdHMgY29vbGRvd24gaW5kZXggd2lsbCBiZSBpbmNyZW1lbnRlZCBieSBvbmUuCiAgICAgICAgdWludDMyIGNvb2xkb3duSW5kZXg7CgogICAgICAgIC8vIFRoZSBzZWVkIG9mIHRoZSBoZXJvLCB0aGUgZ2VuZSBlbmNvZGVzIHRoZSBwb3dlciBsZXZlbCBvZiB0aGUgaGVyby4KICAgICAgICAvLyBUaGlzIGlzIGFub3RoZXIgdG9wIHNlY3JldCBvZiB0aGUgZ2FtZSEgSGVybydzIGdlbmUgY2FuIGJlIHVwZ3JhZGVkIHZpYQogICAgICAgIC8vIHRyYWluaW5nIGluIGEgZHVuZ2Vvbi4KICAgICAgICB1aW50IGdlbmVzOwoKICAgIH0KCn0KCi8qKgogKiBAdGl0bGUgVGhlIEVSQy03MjEgY29tcGxpYW5jZSB0b2tlbiBjb250cmFjdCBmb3IgdGhlIER1bmdlb24gdG9rZW5zLgogKiBAZGV2IFNlZSB0aGUgRHVuZ2VvblN0cnVjdHMgY29udHJhY3QgdG8gc2VlIHRoZSBkZXRhaWxzIG9mIHRoZSBEdW5nZW9uIHRva2VuIGRhdGEgc3RydWN0dXJlLgogKi8KY29udHJhY3QgRHVuZ2VvblRva2VuIGlzIEVSQzcyMSwgRHVuZ2VvblN0cnVjdHMsIFBhdXNhYmxlLCBKb2ludE93bmFibGUgewoKICAgIC8qKgogICAgICogQG5vdGljZSBMaW1pdHMgdGhlIG51bWJlciBvZiBkdW5nZW9ucyB0aGUgY29udHJhY3Qgb3duZXIgY2FuIGV2ZXIgY3JlYXRlLgogICAgICovCiAgICB1aW50IHB1YmxpYyBjb25zdGFudCBEVU5HRU9OX0NSRUFUSU9OX0xJTUlUID0gMTAyNDsKCiAgICAvKioKICAgICAqIEBkZXYgVGhlIE1pbnQgZXZlbnQgaXMgZmlyZWQgd2hlbmV2ZXIgYSBuZXcgZHVuZ2VvbiBpcyBjcmVhdGVkLgogICAgICovCiAgICBldmVudCBNaW50KGFkZHJlc3MgaW5kZXhlZCBvd25lciwgdWludCBuZXdUb2tlbklkLCB1aW50IGRpZmZpY3VsdHksIHVpbnQgY2FwYWNpdHksIHVpbnQgc2VlZEdlbmVzKTsKCiAgICAvKioKICAgICAqIEBkZXYgVGhlIE5ld0R1bmdlb25GbG9vciBldmVudCBpcyBmaXJlZCB3aGVuZXZlciBhIG5ldyBkdW5nZW9uIGZsb29yIGlzIGFkZGVkLgogICAgICovCiAgICBldmVudCBOZXdEdW5nZW9uRmxvb3IodWludCB0aW1lc3RhbXAsIHVpbnQgaW5kZXhlZCBkdW5nZW9uSWQsIHVpbnQzMiBuZXdGbG9vck51bWJlciwgdWludDEyOCBuZXdSZXdhcmRzICwgdWludCBuZXdGbG9vckdlbmVzKTsKCiAgICAvKioKICAgICAqIEBkZXYgVHJhbnNmZXIgZXZlbnQgYXMgZGVmaW5lZCBpbiBjdXJyZW50IGRyYWZ0IG9mIEVSQzcyMS4gRW1pdHRlZCBldmVyeSB0aW1lIGEgdG9rZW4KICAgICAqICBvd25lcnNoaXAgKER1bmdlb24gTWFzdGVyKSBpcyBhc3NpZ25lZCwgaW5jbHVkaW5nIHRva2VuIGNyZWF0aW9uLgogICAgICovCiAgICBldmVudCBUcmFuc2ZlcihhZGRyZXNzIGluZGV4ZWQgZnJvbSwgYWRkcmVzcyBpbmRleGVkIHRvLCB1aW50IHRva2VuSWQpOwoKICAgIC8qKgogICAgICogQGRldiBOYW1lIG9mIHRva2VuLgogICAgICovCiAgICBzdHJpbmcgcHVibGljIGNvbnN0YW50IG5hbWUgPSAiRHVuZ2VvbiI7CgogICAgLyoqCiAgICAgKiBAZGV2IFN5bWJvbCBvZiB0b2tlbi4KICAgICAqLwogICAgc3RyaW5nIHB1YmxpYyBjb25zdGFudCBzeW1ib2wgPSAiRFVORyI7CgogICAgLyoqCiAgICAgKiBAZGV2IEFuIGFycmF5IGNvbnRhaW5pbmcgdGhlIER1bmdlb24gc3RydWN0LCB3aGljaCBjb250YWlucyBhbGwgdGhlIGR1bmdlb25zIGluIGV4aXN0YW5jZS4KICAgICAqICBUaGUgSUQgZm9yIGVhY2ggZHVuZ2VvbiBpcyB0aGUgaW5kZXggb2YgdGhpcyBhcnJheS4KICAgICAqLwogICAgRHVuZ2VvbltdIHB1YmxpYyBkdW5nZW9uczsKCiAgICAvKioKICAgICAqIEBkZXYgQSBtYXBwaW5nIGZyb20gdG9rZW4gSURzIHRvIHRoZSBhZGRyZXNzIHRoYXQgb3ducyB0aGVtLgogICAgICovCiAgICBtYXBwaW5nKHVpbnQgPT4gYWRkcmVzcykgdG9rZW5JbmRleFRvT3duZXI7CgogICAgLyoqCiAgICAgKiBAZGV2IEEgbWFwcGluZyBmcm9tIG93bmVyIGFkZHJlc3MgdG8gY291bnQgb2YgdG9rZW5zIHRoYXQgYWRkcmVzcyBvd25zLgogICAgICovCiAgICBtYXBwaW5nKGFkZHJlc3MgPT4gdWludCkgb3duZXJzaGlwVG9rZW5Db3VudDsKCiAgICAvKioKICAgICAqIEVhY2ggbm9uLWZ1bmdpYmxlIHRva2VuIG93bmVyIGNhbiBvd24gbW9yZSB0aGFuIG9uZSB0b2tlbiBhdCBvbmUgdGltZS4KICAgICAqIEJlY2F1c2UgZWFjaCB0b2tlbiBpcyByZWZlcmVuY2VkIGJ5IGl0cyB1bmlxdWUgSUQsIGhvd2V2ZXIsCiAgICAgKiBpdCBjYW4gZ2V0IGRpZmZpY3VsdCB0byBrZWVwIHRyYWNrIG9mIHRoZSBpbmRpdmlkdWFsIHRva2VucyB0aGF0IGEgdXNlciBtYXkgb3duLgogICAgICogVG8gZG8gdGhpcywgdGhlIGNvbnRyYWN0IGtlZXBzIGEgcmVjb3JkIG9mIHRoZSBJRHMgb2YgZWFjaCB0b2tlbiB0aGF0IGVhY2ggdXNlciBvd25zLgogICAgICovCiAgICBtYXBwaW5nKGFkZHJlc3MgPT4gdWludFtdKSBwdWJsaWMgb3duZXJUb2tlbnM7CgogICAgLyoqCiAgICAgKiBAZGV2IFJldHVybnMgdGhlIHRvdGFsIG51bWJlciBvZiB0b2tlbnMgY3VycmVudGx5IGluIGV4aXN0ZW5jZS4KICAgICAqLwogICAgZnVuY3Rpb24gdG90YWxTdXBwbHkoKSBwdWJsaWMgdmlldyByZXR1cm5zICh1aW50KSB7CiAgICAgICAgcmV0dXJuIGR1bmdlb25zLmxlbmd0aDsKICAgIH0KCiAgICAvKioKICAgICAqIEBkZXYgUmV0dXJucyB0aGUgbnVtYmVyIG9mIHRva2VucyBvd25lZCBieSBhIHNwZWNpZmljIGFkZHJlc3MuCiAgICAgKiBAcGFyYW0gX293bmVyIFRoZSBvd25lciBhZGRyZXNzIHRvIGNoZWNrLgogICAgICovCiAgICBmdW5jdGlvbiBiYWxhbmNlT2YoYWRkcmVzcyBfb3duZXIpIHB1YmxpYyB2aWV3IHJldHVybnMgKHVpbnQpIHsKICAgICAgICByZXR1cm4gb3duZXJzaGlwVG9rZW5Db3VudFtfb3duZXJdOwogICAgfQoKICAgIC8qKgogICAgICogQGRldiBDaGVja3MgaWYgYSBnaXZlbiBhZGRyZXNzIGlzIHRoZSBjdXJyZW50IG93bmVyIG9mIGEgcGFydGljdWxhciB0b2tlbi4KICAgICAqIEBwYXJhbSBfY2xhaW1hbnQgVGhlIGFkZHJlc3Mgd2UgYXJlIHZhbGlkYXRpbmcgYWdhaW5zdC4KICAgICAqIEBwYXJhbSBfdG9rZW5JZCBUb2tlbiBJRAogICAgICovCiAgICBmdW5jdGlvbiBfb3ducyhhZGRyZXNzIF9jbGFpbWFudCwgdWludCBfdG9rZW5JZCkgaW50ZXJuYWwgdmlldyByZXR1cm5zIChib29sKSB7CiAgICAgICAgcmV0dXJuIHRva2VuSW5kZXhUb093bmVyW190b2tlbklkXSA9PSBfY2xhaW1hbnQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBAZGV2IFJldHVybnMgdGhlIGFkZHJlc3MgY3VycmVudGx5IGFzc2lnbmVkIG93bmVyc2hpcCBvZiBhIGdpdmVuIHRva2VuLgogICAgICovCiAgICBmdW5jdGlvbiBvd25lck9mKHVpbnQgX3Rva2VuSWQpIGV4dGVybmFsIHZpZXcgcmV0dXJucyAoYWRkcmVzcykgewogICAgICAgIHJlcXVpcmUodG9rZW5JbmRleFRvT3duZXJbX3Rva2VuSWRdICE9IGFkZHJlc3MoMCkpOwoKICAgICAgICByZXR1cm4gdG9rZW5JbmRleFRvT3duZXJbX3Rva2VuSWRdOwogICAgfQoKICAgIC8qKgogICAgICogQGRldiBBc3NpZ25zIG93bmVyc2hpcCBvZiBhIHNwZWNpZmljIHRva2VuIHRvIGFuIGFkZHJlc3MuCiAgICAgKi8KICAgIGZ1bmN0aW9uIF90cmFuc2ZlcihhZGRyZXNzIF9mcm9tLCBhZGRyZXNzIF90bywgdWludCBfdG9rZW5JZCkgaW50ZXJuYWwgewogICAgICAgIC8vIEluY3JlbWVudCB0aGUgb3duZXJzaGlwVG9rZW5Db3VudC4KICAgICAgICBvd25lcnNoaXBUb2tlbkNvdW50W190b10rKzsKCiAgICAgICAgLy8gVHJhbnNmZXIgb3duZXJzaGlwLgogICAgICAgIHRva2VuSW5kZXhUb093bmVyW190b2tlbklkXSA9IF90bzsKCiAgICAgICAgLy8gQWRkIHRoZSBfdG9rZW5JZCB0byBvd25lclRva2Vuc1tfdG9dCiAgICAgICAgb3duZXJUb2tlbnNbX3RvXS5wdXNoKF90b2tlbklkKTsKCiAgICAgICAgLy8gV2hlbiBjcmVhdGluZyBuZXcgdG9rZW4sIF9mcm9tIGlzIDB4MCwgYnV0IHdlIGNhbid0IGFjY291bnQgdGhhdCBhZGRyZXNzLgogICAgICAgIGlmIChfZnJvbSAhPSBhZGRyZXNzKDApKSB7CiAgICAgICAgICAgIG93bmVyc2hpcFRva2VuQ291bnRbX2Zyb21dLS07CgogICAgICAgICAgICAvLyBSZW1vdmUgdGhlIF90b2tlbklkIGZyb20gb3duZXJUb2tlbnNbX2Zyb21dCiAgICAgICAgICAgIHVpbnRbXSBzdG9yYWdlIGZyb21Ub2tlbnMgPSBvd25lclRva2Vuc1tfZnJvbV07CiAgICAgICAgICAgIGJvb2wgaUZvdW5kID0gZmFsc2U7CgogICAgICAgICAgICBmb3IgKHVpbnQgaSA9IDA7IGkgPCBmcm9tVG9rZW5zLmxlbmd0aCAtIDE7IGkrKykgewogICAgICAgICAgICAgICAgaWYgKGlGb3VuZCkgewogICAgICAgICAgICAgICAgICAgIGZyb21Ub2tlbnNbaV0gPSBmcm9tVG9rZW5zW2kgKyAxXTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZnJvbVRva2Vuc1tpXSA9PSBfdG9rZW5JZCkgewogICAgICAgICAgICAgICAgICAgIGlGb3VuZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgZnJvbVRva2Vuc1tpXSA9IGZyb21Ub2tlbnNbaSArIDFdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBmcm9tVG9rZW5zLmxlbmd0aC0tOwogICAgICAgIH0KCiAgICAgICAgLy8gRW1pdCB0aGUgVHJhbnNmZXIgZXZlbnQuCiAgICAgICAgVHJhbnNmZXIoX2Zyb20sIF90bywgX3Rva2VuSWQpOwogICAgfQoKICAgIC8qKgogICAgICogQGRldiBFeHRlcm5hbCBmdW5jdGlvbiB0byB0cmFuc2ZlcnMgYSB0b2tlbiB0byBhbm90aGVyIGFkZHJlc3MuCiAgICAgKiBAcGFyYW0gX3RvIFRoZSBhZGRyZXNzIG9mIHRoZSByZWNpcGllbnQsIGNhbiBiZSBhIHVzZXIgb3IgY29udHJhY3QuCiAgICAgKiBAcGFyYW0gX3Rva2VuSWQgVGhlIElEIG9mIHRoZSB0b2tlbiB0byB0cmFuc2Zlci4KICAgICAqLwogICAgZnVuY3Rpb24gdHJhbnNmZXIoYWRkcmVzcyBfdG8sIHVpbnQgX3Rva2VuSWQpIHdoZW5Ob3RQYXVzZWQgZXh0ZXJuYWwgewogICAgICAgIC8vIFNhZmV0eSBjaGVjayB0byBwcmV2ZW50IGFnYWluc3QgYW4gdW5leHBlY3RlZCAweDAgZGVmYXVsdC4KICAgICAgICByZXF1aXJlKF90byAhPSBhZGRyZXNzKDApKTsKCiAgICAgICAgLy8gRGlzYWxsb3cgdHJhbnNmZXJzIHRvIHRoaXMgY29udHJhY3QgdG8gcHJldmVudCBhY2NpZGVudGFsIG1pc3VzZS4KICAgICAgICByZXF1aXJlKF90byAhPSBhZGRyZXNzKHRoaXMpKTsKCiAgICAgICAgLy8gWW91IGNhbiBvbmx5IHNlbmQgeW91ciBvd24gdG9rZW4uCiAgICAgICAgcmVxdWlyZShfb3ducyhtc2cuc2VuZGVyLCBfdG9rZW5JZCkpOwoKICAgICAgICAvLyBSZWFzc2lnbiBvd25lcnNoaXAsIGNsZWFyIHBlbmRpbmcgYXBwcm92YWxzLCBlbWl0IFRyYW5zZmVyIGV2ZW50LgogICAgICAgIF90cmFuc2Zlcihtc2cuc2VuZGVyLCBfdG8sIF90b2tlbklkKTsKICAgIH0KCiAgICAvKioKICAgICAqIEBkZXYgR2V0IGFuIGFycmF5IG9mIElEcyBvZiBlYWNoIHRva2VuIHRoYXQgYW4gdXNlciBvd25zLgogICAgICovCiAgICBmdW5jdGlvbiBnZXRPd25lclRva2VucyhhZGRyZXNzIF9vd25lcikgZXh0ZXJuYWwgdmlldyByZXR1cm5zKHVpbnRbXSkgewogICAgICAgIHJldHVybiBvd25lclRva2Vuc1tfb3duZXJdOwogICAgfQoKICAgIC8qKgogICAgICogQGRldiBUaGUgZXh0ZXJuYWwgZnVuY3Rpb24gdGhhdCBjcmVhdGVzIGEgbmV3IGR1bmdlb24gYW5kIHN0b3JlcyBpdCwgb25seSBjb250cmFjdCBvd25lcnMKICAgICAqICBjYW4gY3JlYXRlIG5ldyB0b2tlbiwgYW5kIHdpbGwgYmUgcmVzdHJpY3RlZCBieSB0aGUgRFVOR0VPTl9DUkVBVElPTl9MSU1JVC4KICAgICAqICBXaWxsIGdlbmVyYXRlIGEgTWludCBldmVudCwgYSAgTmV3RHVuZ2VvbkZsb29yIGV2ZW50LCBhbmQgYSBUcmFuc2ZlciBldmVudC4KICAgICAqIEBwYXJhbSBfZGlmZmljdWx0eSBUaGUgZGlmZmljdWx0eSBvZiB0aGUgbmV3IGR1bmdlb24uCiAgICAgKiBAcGFyYW0gX2NhcGFjaXR5IFRoZSBjYXBhY2l0eSBvZiB0aGUgbmV3IGR1bmdlb24uCiAgICAgKiBAcGFyYW0gX3NlZWRHZW5lcyBUaGUgc2VlZCBnZW5lcyBvZiB0aGUgbmV3IGR1bmdlb24uCiAgICAgKiBAcGFyYW0gX2ZpcnN0Rmxvb3JHZW5lcyBUaGUgZ2VuZXMgb2YgdGhlIGZpcnN0IGR1bmdlb24gZmxvb3IuCiAgICAgKiBAcmV0dXJuIFRoZSBkdW5nZW9uIElEIG9mIHRoZSBuZXcgZHVuZ2Vvbi4KICAgICAqLwogICAgZnVuY3Rpb24gY3JlYXRlRHVuZ2Vvbih1aW50IF9kaWZmaWN1bHR5LCB1aW50IF9jYXBhY2l0eSwgdWludCBfc2VlZEdlbmVzLCB1aW50IF9maXJzdEZsb29yR2VuZXMsIGFkZHJlc3MgX293bmVyKSBlaXRoZXJPd25lciBleHRlcm5hbCByZXR1cm5zICh1aW50KSB7CiAgICAgICAgLy8gRW5zdXJlIHRoZSB0b3RhbCBzdXBwbHkgaXMgd2l0aGluIHRoZSBmaXhlZCBsaW1pdC4KICAgICAgICByZXF1aXJlKHRvdGFsU3VwcGx5KCkgPCBEVU5HRU9OX0NSRUFUSU9OX0xJTUlUKTsKCiAgICAgICAgLy8gVVBEQVRFIFNUT1JBR0UKICAgICAgICAvLyBDcmVhdGUgYSBuZXcgZHVuZ2Vvbi4KICAgICAgICBkdW5nZW9ucy5wdXNoKER1bmdlb24odWludDMyKG5vdyksIDAsIHVpbnQ4KF9kaWZmaWN1bHR5KSwgdWludDE2KF9jYXBhY2l0eSksIDAsIDAsIDAsIF9zZWVkR2VuZXMsIDApKTsKCiAgICAgICAgLy8gVG9rZW4gaWQgaXMgdGhlIGluZGV4IGluIHRoZSBzdG9yYWdlIGFycmF5LgogICAgICAgIHVpbnQgbmV3VG9rZW5JZCA9IGR1bmdlb25zLmxlbmd0aCAtIDE7CgogICAgICAgIC8vIEVtaXQgdGhlIHRva2VuIG1pbnQgZXZlbnQuCiAgICAgICAgTWludChfb3duZXIsIG5ld1Rva2VuSWQsIF9kaWZmaWN1bHR5LCBfY2FwYWNpdHksIF9zZWVkR2VuZXMpOwoKICAgICAgICAvLyBJbml0aWFsaXplIHRoZSBmaXN0IGZsb29yLCB0aGlzIHdpbGwgZW1pdCB0aGUgTmV3RHVuZ2VvbkZsb29yIGV2ZW50LgogICAgICAgIGFkZER1bmdlb25OZXdGbG9vcihuZXdUb2tlbklkLCAwLCBfZmlyc3RGbG9vckdlbmVzKTsKCiAgICAgICAgLy8gVGhpcyB3aWxsIGFzc2lnbiBvd25lcnNoaXAsIGFuZCBhbHNvIGVtaXQgdGhlIFRyYW5zZmVyIGV2ZW50LgogICAgICAgIF90cmFuc2ZlcigwLCBfb3duZXIsIG5ld1Rva2VuSWQpOwoKICAgICAgICByZXR1cm4gbmV3VG9rZW5JZDsKICAgIH0KCiAgICAvKioKICAgICAqIEBkZXYgVGhlIGV4dGVybmFsIGZ1bmN0aW9uIHRvIHNldCBkdW5nZW9uIHN0YXR1cyBieSBpdHMgSUQsCiAgICAgKiAgcmVmZXIgdG8gRHVuZ2VvblN0cnVjdHMgZm9yIG1vcmUgaW5mb3JtYXRpb24gYWJvdXQgZHVuZ2VvbiBzdGF0dXMuCiAgICAgKiAgT25seSBjb250cmFjdCBvd25lcnMgY2FuIGFsdGVyIGR1bmdlb24gc3RhdGUuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHNldER1bmdlb25TdGF0dXModWludCBfaWQsIHVpbnQgX25ld1N0YXR1cykgZWl0aGVyT3duZXIgdG9rZW5FeGlzdHMoX2lkKSBleHRlcm5hbCB7CiAgICAgICAgZHVuZ2VvbnNbX2lkXS5zdGF0dXMgPSB1aW50OChfbmV3U3RhdHVzKTsKICAgIH0KCiAgICAvKioKICAgICAqIEBkZXYgVGhlIGV4dGVybmFsIGZ1bmN0aW9uIHRvIGFkZCBhZGRpdGlvbmFsIGR1bmdlb24gcmV3YXJkcyBieSBpdHMgSUQsCiAgICAgKiAgb25seSBjb250cmFjdCBvd25lcnMgY2FuIGFsdGVyIGR1bmdlb24gc3RhdGUuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGFkZER1bmdlb25SZXdhcmRzKHVpbnQgX2lkLCB1aW50IF9hZGRpdGluYWxSZXdhcmRzKSBlaXRoZXJPd25lciB0b2tlbkV4aXN0cyhfaWQpIGV4dGVybmFsIHsKICAgICAgICBkdW5nZW9uc1tfaWRdLnJld2FyZHMgKz0gdWludDEyOChfYWRkaXRpbmFsUmV3YXJkcyk7CiAgICB9CgogICAgLyoqCiAgICAgKiBAZGV2IFRoZSBleHRlcm5hbCBmdW5jdGlvbiB0byBhZGQgYW5vdGhlciBkdW5nZW9uIGZsb29yIGJ5IGl0cyBJRCwKICAgICAqICBvbmx5IGNvbnRyYWN0IG93bmVycyBjYW4gYWx0ZXIgZHVuZ2VvbiBzdGF0ZS4KICAgICAqICBXaWxsIGdlbmVyYXRlIGJvdGggYSBOZXdEdW5nZW9uRmxvb3IgZXZlbnQuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGFkZER1bmdlb25OZXdGbG9vcih1aW50IF9pZCwgdWludCBfbmV3UmV3YXJkcywgdWludCBfbmV3Rmxvb3JHZW5lcykgZWl0aGVyT3duZXIgdG9rZW5FeGlzdHMoX2lkKSBwdWJsaWMgewogICAgICAgIER1bmdlb24gc3RvcmFnZSBkdW5nZW9uID0gZHVuZ2VvbnNbX2lkXTsKCiAgICAgICAgZHVuZ2Vvbi5mbG9vck51bWJlcisrOwogICAgICAgIGR1bmdlb24uZmxvb3JDcmVhdGlvblRpbWUgPSB1aW50MzIobm93KTsKICAgICAgICBkdW5nZW9uLnJld2FyZHMgPSB1aW50MTI4KF9uZXdSZXdhcmRzKTsKICAgICAgICBkdW5nZW9uLmZsb29yR2VuZXMgPSBfbmV3Rmxvb3JHZW5lczsKCiAgICAgICAgLy8gRW1pdCB0aGUgTmV3RHVuZ2VvbkZsb29yIGV2ZW50LgogICAgICAgIE5ld0R1bmdlb25GbG9vcihub3csIF9pZCwgZHVuZ2Vvbi5mbG9vck51bWJlciwgZHVuZ2Vvbi5yZXdhcmRzLCBkdW5nZW9uLmZsb29yR2VuZXMpOwogICAgfQoKCiAgICAvKiA9PT09PT09PSBNT0RJRklFUlMgPT09PT09PT0gKi8KCiAgICAvKioKICAgICAqIEBkZXYgVGhyb3dzIGlmIF9kdW5nZW9uSWQgaXMgbm90IGNyZWF0ZWQgeWV0LgogICAgICovCiAgICBtb2RpZmllciB0b2tlbkV4aXN0cyh1aW50IF90b2tlbklkKSB7CiAgICAgICAgcmVxdWlyZShfdG9rZW5JZCA8IHRvdGFsU3VwcGx5KCkpOwogICAgICAgIF87CiAgICB9Cgp9CgovKioKICogQHRpdGxlIFRoZSBFUkMtNzIxIGNvbXBsaWFuY2UgdG9rZW4gY29udHJhY3QgZm9yIHRoZSBIZXJvIHRva2Vucy4KICogQGRldiBTZWUgdGhlIER1bmdlb25TdHJ1Y3RzIGNvbnRyYWN0IHRvIHNlZSB0aGUgZGV0YWlscyBvZiB0aGUgSGVybyB0b2tlbiBkYXRhIHN0cnVjdHVyZS4KICovCmNvbnRyYWN0IEhlcm9Ub2tlbiBpcyBFUkM3MjEsIER1bmdlb25TdHJ1Y3RzLCBQYXVzYWJsZSwgSm9pbnRPd25hYmxlIHsKCiAgICAvKioKICAgICAqIEBkZXYgVGhlIE1pbnQgZXZlbnQgaXMgZmlyZWQgd2hlbmV2ZXIgYSBuZXcgaGVybyBpcyBjcmVhdGVkLgogICAgICovCiAgICBldmVudCBNaW50KGFkZHJlc3MgaW5kZXhlZCBvd25lciwgdWludCBuZXdUb2tlbklkLCB1aW50IF9nZW5lcyk7CgogICAgLyoqCiAgICAgKiBAZGV2IFRyYW5zZmVyIGV2ZW50IGFzIGRlZmluZWQgaW4gY3VycmVudCBkcmFmdCBvZiBFUkM3MjEuIEVtaXR0ZWQgZXZlcnkgdGltZSBhIHRva2VuCiAgICAgKiAgb3duZXJzaGlwIGlzIGFzc2lnbmVkLCBpbmNsdWRpbmcgdG9rZW4gY3JlYXRpb24uCiAgICAgKi8KICAgIGV2ZW50IFRyYW5zZmVyKGFkZHJlc3MgaW5kZXhlZCBmcm9tLCBhZGRyZXNzIGluZGV4ZWQgdG8sIHVpbnQgdG9rZW5JZCk7CgogICAgLyoqCiAgICAgKiBAZGV2IE5hbWUgb2YgdG9rZW4uCiAgICAgKi8KICAgIHN0cmluZyBwdWJsaWMgY29uc3RhbnQgbmFtZSA9ICJIZXJvIjsKCiAgICAvKioKICAgICAqIEBkZXYgU3ltYm9sIG9mIHRva2VuLgogICAgICovCiAgICBzdHJpbmcgcHVibGljIGNvbnN0YW50IHN5bWJvbCA9ICJIRVJPIjsKCiAgICAvKioKICAgICAqIEBkZXYgQW4gYXJyYXkgY29udGFpbmluZyB0aGUgSGVybyBzdHJ1Y3QsIHdoaWNoIGNvbnRhaW5zIGFsbCB0aGUgaGVyb2VzIGluIGV4aXN0YW5jZS4KICAgICAqICBUaGUgSUQgZm9yIGVhY2ggaGVybyBpcyB0aGUgaW5kZXggb2YgdGhpcyBhcnJheS4KICAgICAqLwogICAgSGVyb1tdIHB1YmxpYyBoZXJvZXM7CgogICAgLyoqCiAgICAgKiBAZGV2IEEgbWFwcGluZyBmcm9tIHRva2VuIElEcyB0byB0aGUgYWRkcmVzcyB0aGF0IG93bnMgdGhlbS4KICAgICAqLwogICAgbWFwcGluZyh1aW50ID0+IGFkZHJlc3MpIHRva2VuSW5kZXhUb093bmVyOwoKICAgIC8qKgogICAgICogQGRldiBBIG1hcHBpbmcgZnJvbSBvd25lciBhZGRyZXNzIHRvIGNvdW50IG9mIHRva2VucyB0aGF0IGFkZHJlc3Mgb3ducy4KICAgICAqLwogICAgbWFwcGluZyhhZGRyZXNzID0+IHVpbnQpIG93bmVyc2hpcFRva2VuQ291bnQ7CgogICAgLyoqCiAgICAgKiBFYWNoIG5vbi1mdW5naWJsZSB0b2tlbiBvd25lciBjYW4gb3duIG1vcmUgdGhhbiBvbmUgdG9rZW4gYXQgb25lIHRpbWUuCiAgICAgKiBCZWNhdXNlIGVhY2ggdG9rZW4gaXMgcmVmZXJlbmNlZCBieSBpdHMgdW5pcXVlIElELCBob3dldmVyLAogICAgICogaXQgY2FuIGdldCBkaWZmaWN1bHQgdG8ga2VlcCB0cmFjayBvZiB0aGUgaW5kaXZpZHVhbCB0b2tlbnMgdGhhdCBhIHVzZXIgbWF5IG93bi4KICAgICAqIFRvIGRvIHRoaXMsIHRoZSBjb250cmFjdCBrZWVwcyBhIHJlY29yZCBvZiB0aGUgSURzIG9mIGVhY2ggdG9rZW4gdGhhdCBlYWNoIHVzZXIgb3ducy4KICAgICAqLwogICAgbWFwcGluZyhhZGRyZXNzID0+IHVpbnRbXSkgcHVibGljIG93bmVyVG9rZW5zOwoKICAgIC8qKgogICAgICogQGRldiBSZXR1cm5zIHRoZSB0b3RhbCBudW1iZXIgb2YgdG9rZW5zIGN1cnJlbnRseSBpbiBleGlzdGVuY2UuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHRvdGFsU3VwcGx5KCkgcHVibGljIHZpZXcgcmV0dXJucyAodWludCkgewogICAgICAgIHJldHVybiBoZXJvZXMubGVuZ3RoOwogICAgfQoKICAgIC8qKgogICAgICogQGRldiBSZXR1cm5zIHRoZSBudW1iZXIgb2YgdG9rZW5zIG93bmVkIGJ5IGEgc3BlY2lmaWMgYWRkcmVzcy4KICAgICAqIEBwYXJhbSBfb3duZXIgVGhlIG93bmVyIGFkZHJlc3MgdG8gY2hlY2suCiAgICAgKi8KICAgIGZ1bmN0aW9uIGJhbGFuY2VPZihhZGRyZXNzIF9vd25lcikgcHVibGljIHZpZXcgcmV0dXJucyAodWludCkgewogICAgICAgIHJldHVybiBvd25lcnNoaXBUb2tlbkNvdW50W19vd25lcl07CiAgICB9CgogICAgLyoqCiAgICAgKiBAZGV2IENoZWNrcyBpZiBhIGdpdmVuIGFkZHJlc3MgaXMgdGhlIGN1cnJlbnQgb3duZXIgb2YgYSBwYXJ0aWN1bGFyIHRva2VuLgogICAgICogQHBhcmFtIF9jbGFpbWFudCBUaGUgYWRkcmVzcyB3ZSBhcmUgdmFsaWRhdGluZyBhZ2FpbnN0LgogICAgICogQHBhcmFtIF90b2tlbklkIFRva2VuIElECiAgICAgKi8KICAgIGZ1bmN0aW9uIF9vd25zKGFkZHJlc3MgX2NsYWltYW50LCB1aW50IF90b2tlbklkKSBpbnRlcm5hbCB2aWV3IHJldHVybnMgKGJvb2wpIHsKICAgICAgICByZXR1cm4gdG9rZW5JbmRleFRvT3duZXJbX3Rva2VuSWRdID09IF9jbGFpbWFudDsKICAgIH0KCiAgICAvKioKICAgICAqIEBkZXYgUmV0dXJucyB0aGUgYWRkcmVzcyBjdXJyZW50bHkgYXNzaWduZWQgb3duZXJzaGlwIG9mIGEgZ2l2ZW4gdG9rZW4uCiAgICAgKi8KICAgIGZ1bmN0aW9uIG93bmVyT2YodWludCBfdG9rZW5JZCkgZXh0ZXJuYWwgdmlldyByZXR1cm5zIChhZGRyZXNzKSB7CiAgICAgICAgcmVxdWlyZSh0b2tlbkluZGV4VG9Pd25lcltfdG9rZW5JZF0gIT0gYWRkcmVzcygwKSk7CgogICAgICAgIHJldHVybiB0b2tlbkluZGV4VG9Pd25lcltfdG9rZW5JZF07CiAgICB9CgogICAgLyoqCiAgICAgKiBAZGV2IEFzc2lnbnMgb3duZXJzaGlwIG9mIGEgc3BlY2lmaWMgdG9rZW4gdG8gYW4gYWRkcmVzcy4KICAgICAqLwogICAgZnVuY3Rpb24gX3RyYW5zZmVyKGFkZHJlc3MgX2Zyb20sIGFkZHJlc3MgX3RvLCB1aW50IF90b2tlbklkKSBpbnRlcm5hbCB7CiAgICAgICAgLy8gSW5jcmVtZW50IHRoZSBvd25lcnNoaXBUb2tlbkNvdW50LgogICAgICAgIG93bmVyc2hpcFRva2VuQ291bnRbX3RvXSsrOwoKICAgICAgICAvLyBUcmFuc2ZlciBvd25lcnNoaXAuCiAgICAgICAgdG9rZW5JbmRleFRvT3duZXJbX3Rva2VuSWRdID0gX3RvOwoKICAgICAgICAvLyBBZGQgdGhlIF90b2tlbklkIHRvIG93bmVyVG9rZW5zW190b10KICAgICAgICBvd25lclRva2Vuc1tfdG9dLnB1c2goX3Rva2VuSWQpOwoKICAgICAgICAvLyBXaGVuIGNyZWF0aW5nIG5ldyB0b2tlbiwgX2Zyb20gaXMgMHgwLCBidXQgd2UgY2FuJ3QgYWNjb3VudCB0aGF0IGFkZHJlc3MuCiAgICAgICAgaWYgKF9mcm9tICE9IGFkZHJlc3MoMCkpIHsKICAgICAgICAgICAgb3duZXJzaGlwVG9rZW5Db3VudFtfZnJvbV0tLTsKCiAgICAgICAgICAgIC8vIFJlbW92ZSB0aGUgX3Rva2VuSWQgZnJvbSBvd25lclRva2Vuc1tfZnJvbV0KICAgICAgICAgICAgdWludFtdIHN0b3JhZ2UgZnJvbVRva2VucyA9IG93bmVyVG9rZW5zW19mcm9tXTsKICAgICAgICAgICAgYm9vbCBpRm91bmQgPSBmYWxzZTsKCiAgICAgICAgICAgIGZvciAodWludCBpID0gMDsgaSA8IGZyb21Ub2tlbnMubGVuZ3RoIC0gMTsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAoaUZvdW5kKSB7CiAgICAgICAgICAgICAgICAgICAgZnJvbVRva2Vuc1tpXSA9IGZyb21Ub2tlbnNbaSArIDFdOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChmcm9tVG9rZW5zW2ldID09IF90b2tlbklkKSB7CiAgICAgICAgICAgICAgICAgICAgaUZvdW5kID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBmcm9tVG9rZW5zW2ldID0gZnJvbVRva2Vuc1tpICsgMV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZyb21Ub2tlbnMubGVuZ3RoLS07CiAgICAgICAgfQoKICAgICAgICAvLyBFbWl0IHRoZSBUcmFuc2ZlciBldmVudC4KICAgICAgICBUcmFuc2ZlcihfZnJvbSwgX3RvLCBfdG9rZW5JZCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBAZGV2IEV4dGVybmFsIGZ1bmN0aW9uIHRvIHRyYW5zZmVycyBhIHRva2VuIHRvIGFub3RoZXIgYWRkcmVzcy4KICAgICAqIEBwYXJhbSBfdG8gVGhlIGFkZHJlc3Mgb2YgdGhlIHJlY2lwaWVudCwgY2FuIGJlIGEgdXNlciBvciBjb250cmFjdC4KICAgICAqIEBwYXJhbSBfdG9rZW5JZCBUaGUgSUQgb2YgdGhlIHRva2VuIHRvIHRyYW5zZmVyLgogICAgICovCiAgICBmdW5jdGlvbiB0cmFuc2ZlcihhZGRyZXNzIF90bywgdWludCBfdG9rZW5JZCkgd2hlbk5vdFBhdXNlZCBleHRlcm5hbCB7CiAgICAgICAgLy8gU2FmZXR5IGNoZWNrIHRvIHByZXZlbnQgYWdhaW5zdCBhbiB1bmV4cGVjdGVkIDB4MCBkZWZhdWx0LgogICAgICAgIHJlcXVpcmUoX3RvICE9IGFkZHJlc3MoMCkpOwoKICAgICAgICAvLyBEaXNhbGxvdyB0cmFuc2ZlcnMgdG8gdGhpcyBjb250cmFjdCB0byBwcmV2ZW50IGFjY2lkZW50YWwgbWlzdXNlLgogICAgICAgIHJlcXVpcmUoX3RvICE9IGFkZHJlc3ModGhpcykpOwoKICAgICAgICAvLyBZb3UgY2FuIG9ubHkgc2VuZCB5b3VyIG93biB0b2tlbi4KICAgICAgICByZXF1aXJlKF9vd25zKG1zZy5zZW5kZXIsIF90b2tlbklkKSk7CgogICAgICAgIC8vIFJlYXNzaWduIG93bmVyc2hpcCwgY2xlYXIgcGVuZGluZyBhcHByb3ZhbHMsIGVtaXQgVHJhbnNmZXIgZXZlbnQuCiAgICAgICAgX3RyYW5zZmVyKG1zZy5zZW5kZXIsIF90bywgX3Rva2VuSWQpOwogICAgfQoKICAgIC8qKgogICAgICogQGRldiBHZXQgYW4gYXJyYXkgb2YgSURzIG9mIGVhY2ggdG9rZW4gdGhhdCBhbiB1c2VyIG93bnMuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGdldE93bmVyVG9rZW5zKGFkZHJlc3MgX293bmVyKSBleHRlcm5hbCB2aWV3IHJldHVybnModWludFtdKSB7CiAgICAgICAgcmV0dXJuIG93bmVyVG9rZW5zW19vd25lcl07CiAgICB9CgogICAgLyoqCiAgICAgKiBAZGV2IEFuIGV4dGVybmFsIGZ1bmN0aW9uIHRoYXQgY3JlYXRlcyBhIG5ldyBoZXJvIGFuZCBzdG9yZXMgaXQsCiAgICAgKiAgb25seSBjb250cmFjdCBvd25lcnMgY2FuIGNyZWF0ZSBuZXcgdG9rZW4uCiAgICAgKiAgbWV0aG9kIGRvZXNuJ3QgZG8gYW55IGNoZWNraW5nIGFuZCBzaG91bGQgb25seSBiZSBjYWxsZWQgd2hlbiB0aGUKICAgICAqICBpbnB1dCBkYXRhIGlzIGtub3duIHRvIGJlIHZhbGlkLgogICAgICogQHBhcmFtIF9nZW5lcyBUaGUgZ2VuZSBvZiB0aGUgbmV3IGhlcm8uCiAgICAgKiBAcGFyYW0gX293bmVyIFRoZSBpbml0YWwgb3duZXIgb2YgdGhpcyBoZXJvLgogICAgICogQHJldHVybiBUaGUgaGVybyBJRCBvZiB0aGUgbmV3IGhlcm8uCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNyZWF0ZUhlcm8odWludCBfZ2VuZXMsIGFkZHJlc3MgX293bmVyKSBlaXRoZXJPd25lciBleHRlcm5hbCByZXR1cm5zICh1aW50KSB7CiAgICAgICAgLy8gVVBEQVRFIFNUT1JBR0UKICAgICAgICAvLyBDcmVhdGUgYSBuZXcgaGVyby4KICAgICAgICBoZXJvZXMucHVzaChIZXJvKHVpbnQ2NChub3cpLCAwLCAwLCBfZ2VuZXMpKTsKCiAgICAgICAgLy8gVG9rZW4gaWQgaXMgdGhlIGluZGV4IGluIHRoZSBzdG9yYWdlIGFycmF5LgogICAgICAgIHVpbnQgbmV3VG9rZW5JZCA9IGhlcm9lcy5sZW5ndGggLSAxOwoKICAgICAgICAvLyBFbWl0IHRoZSB0b2tlbiBtaW50IGV2ZW50LgogICAgICAgIE1pbnQoX293bmVyLCBuZXdUb2tlbklkLCBfZ2VuZXMpOwoKICAgICAgICAvLyBUaGlzIHdpbGwgYXNzaWduIG93bmVyc2hpcCwgYW5kIGFsc28gZW1pdCB0aGUgVHJhbnNmZXIgZXZlbnQuCiAgICAgICAgX3RyYW5zZmVyKDAsIF9vd25lciwgbmV3VG9rZW5JZCk7CgogICAgICAgIHJldHVybiBuZXdUb2tlbklkOwogICAgfQoKICAgIC8qKgogICAgICogQGRldiBUaGUgZXh0ZXJuYWwgZnVuY3Rpb24gdG8gc2V0IHRoZSBoZXJvIGdlbmVzIGJ5IGl0cyBJRCwKICAgICAqICBvbmx5IGNvbnRyYWN0IG93bmVycyBjYW4gYWx0ZXIgaGVybyBzdGF0ZS4KICAgICAqLwogICAgZnVuY3Rpb24gc2V0SGVyb0dlbmVzKHVpbnQgX2lkLCB1aW50IF9uZXdHZW5lcykgZWl0aGVyT3duZXIgdG9rZW5FeGlzdHMoX2lkKSBleHRlcm5hbCB7CiAgICAgICAgaGVyb2VzW19pZF0uZ2VuZXMgPSBfbmV3R2VuZXM7CiAgICB9CgogICAgLyoqCiAgICAgKiBAZGV2IFNldCB0aGUgY29vbGRvd25TdGFydFRpbWUgZm9yIHRoZSBnaXZlbiBoZXJvLiBBbHNvIGluY3JlbWVudHMgdGhlIGNvb2xkb3duSW5kZXguCiAgICAgKi8KICAgIGZ1bmN0aW9uIHRyaWdnZXJDb29sZG93bih1aW50IF9pZCkgZWl0aGVyT3duZXIgdG9rZW5FeGlzdHMoX2lkKSBleHRlcm5hbCB7CiAgICAgICAgSGVybyBzdG9yYWdlIGhlcm8gPSBoZXJvZXNbX2lkXTsKCiAgICAgICAgaGVyby5jb29sZG93blN0YXJ0VGltZSA9IHVpbnQ2NChub3cpOwogICAgICAgIGhlcm8uY29vbGRvd25JbmRleCsrOwogICAgfQoKCiAgICAvKiA9PT09PT09PSBNT0RJRklFUlMgPT09PT09PT0gKi8KCiAgICAvKioKICAgICAqIEBkZXYgVGhyb3dzIGlmIF9kdW5nZW9uSWQgaXMgbm90IGNyZWF0ZWQgeWV0LgogICAgICovCiAgICBtb2RpZmllciB0b2tlbkV4aXN0cyh1aW50IF90b2tlbklkKSB7CiAgICAgICAgcmVxdWlyZShfdG9rZW5JZCA8IHRvdGFsU3VwcGx5KCkpOwogICAgICAgIF87CiAgICB9Cgp9CgovKioKICogU0VDUkVUCiAqLwpjb250cmFjdCBDaGFsbGVuZ2VTY2llbmNlSW50ZXJmYWNlIHsKCiAgICAvKioKICAgICAqIEBkZXYgZ2l2ZW4gZ2VuZXMgb2YgY3VycmVudCBmbG9vciBhbmQgZHVuZ2VvbiBzZWVkLCByZXR1cm4gYSBnZW5ldGljIGNvbWJpbmF0aW9uIC0gbWF5IGhhdmUgYSByYW5kb20gZmFjdG9yLgogICAgICogQHBhcmFtIF9mbG9vckdlbmVzIEdlbmVzIG9mIGZsb29yLgogICAgICogQHBhcmFtIF9zZWVkR2VuZXMgU2VlZCBnZW5lcyBvZiBkdW5nZW9uLgogICAgICogQHJldHVybiBUaGUgcmVzdWx0aW5nIGdlbmVzLgogICAgICovCiAgICBmdW5jdGlvbiBtaXhHZW5lcyh1aW50IF9mbG9vckdlbmVzLCB1aW50IF9zZWVkR2VuZXMpIGV4dGVybmFsIHJldHVybnMgKHVpbnQpOwoKfQoKLyoqCiAqIFNFQ1JFVAogKi8KY29udHJhY3QgVHJhaW5pbmdTY2llbmNlSW50ZXJmYWNlIHsKCiAgICAvKioKICAgICAqIEBkZXYgZ2l2ZW4gZ2VuZXMgb2YgaGVybyBhbmQgY3VycmVudCBmbG9vciwgcmV0dXJuIGEgZ2VuZXRpYyBjb21iaW5hdGlvbiAtIG1heSBoYXZlIGEgcmFuZG9tIGZhY3Rvci4KICAgICAqIEBwYXJhbSBfaGVyb0dlbmVzIEdlbmVzIG9mIGhlcm8uCiAgICAgKiBAcGFyYW0gX2Zsb29yR2VuZXMgR2VuZXMgb2YgY3VycmVudCBmbG9vci4KICAgICAqIEBwYXJhbSBfZXF1aXBtZW50SWQgRXF1aXBtZW50IGluZGV4IHRvIHRyYWluIGZvciwgMCBpcyB0cmFpbiBhbGwgYXR0cmlidXRlcy4KICAgICAqIEByZXR1cm4gVGhlIHJlc3VsdGluZyBnZW5lcy4KICAgICAqLwogICAgZnVuY3Rpb24gbWl4R2VuZXModWludCBfaGVyb0dlbmVzLCB1aW50IF9mbG9vckdlbmVzLCB1aW50IF9lcXVpcG1lbnRJZCkgZXh0ZXJuYWwgcmV0dXJucyAodWludCk7Cgp9CgovKioKICogQHRpdGxlIER1bmdlb25CYXNlCiAqIEBkZXYgQmFzZSBjb250cmFjdCBmb3IgRXRoZXIgRHVuZ2Vvbi4gSXQgaW1wbGVtZW50cyBhbGwgbmVjZXNzYXJ5IHN1Yi1jbGFzc2VzLAogKiBob2xkcyBhbGwgdGhlIGJhc2Ugc3RvcmFnZSB2YXJpYWJsZXMsIGFuZCBzb21lIGNvbW1vbmx5IHVzZWQgZnVuY3Rpb25zLgogKi8KY29udHJhY3QgRHVuZ2VvbkJhc2UgaXMgRWplY3RhYmxlT3duYWJsZSwgUGF1c2FibGUsIFB1bGxQYXltZW50LCBEdW5nZW9uU3RydWN0cyB7CgogICAgLyogPT09PT09PT0gVE9LRU4gQ09OVFJBQ1RTID09PT09PT09ICovCgogICAgLyoqCiAgICAgKiBAZGV2IFRoZSBhZGRyZXNzIG9mIHRoZSBFUkM3MjEgdG9rZW4gY29udHJhY3QgbWFuYWdpbmcgYWxsIER1bmdlb24gdG9rZW5zLgogICAgICovCiAgICBEdW5nZW9uVG9rZW4gcHVibGljIGR1bmdlb25Ub2tlbkNvbnRyYWN0OwoKICAgIC8qKgogICAgICogQGRldiBUaGUgYWRkcmVzcyBvZiB0aGUgRVJDNzIxIHRva2VuIGNvbnRyYWN0IG1hbmFnaW5nIGFsbCBIZXJvIHRva2Vucy4KICAgICAqLwogICAgSGVyb1Rva2VuIHB1YmxpYyBoZXJvVG9rZW5Db250cmFjdDsKCgogICAgLyogPT09PT09PT0gQ0xPU0VEIFNPVVJDRSBDT05UUkFDVFMgPT09PT09PT0gKi8KCiAgICAvKioKICAgICAqIEBkZXYgVGhlIGFkZHJlc3Mgb2YgdGhlIENoYWxsZW5nZVNjaWVuY2UgY29udHJhY3QgdGhhdCBoYW5kbGVzIHRoZSBmbG9vciBnZW5lcmF0aW9uIG1lY2hhbmljcyBhZnRlciBjaGFsbGVuZ2Ugc3VjY2Vzcy4KICAgICAqLwogICAgQ2hhbGxlbmdlU2NpZW5jZUludGVyZmFjZSBjaGFsbGVuZ2VTY2llbmNlQ29udHJhY3Q7CgogICAgLyoqCiAgICAgKiBAZGV2IFRoZSBhZGRyZXNzIG9mIHRoZSBUcmFpbmluZ1NjaWVuY2UgY29udHJhY3QgdGhhdCBoYW5kbGVzIHRoZSBoZXJvIHRyYWluaW5nIG1lY2hhbmljcy4KICAgICAqLwogICAgVHJhaW5pbmdTY2llbmNlSW50ZXJmYWNlIHRyYWluaW5nU2NpZW5jZUNvbnRyYWN0OwoKCiAgICAvKiA9PT09PT09PSBDT05TVEFOVFMgPT09PT09PT0gKi8KCiAgICB1aW50MTZbMzJdIEVRVUlQTUVOVF9QT1dFUlMgPSBbCiAgICAgICAgMSwgMiwgNCwgNSwgMTYsIDE3LCAxOCwgMTksIDAsIDAsIDAsIDAsIDAsIDAsIDAsIDAsCiAgICAgICAgNCwgMTYsIDMyLCAzMywgMCwgMCwgMCwgMCwgMzIsIDY0LCAwLCAwLCAxMjgsIDAsIDAsIDAKICAgIF07CgogICAgdWludCBTVVBFUl9IRVJPX01VTFRJUExJRVIgPSAzMjsKCiAgICAvKiA9PT09PT09PSBTRVRURVIgRlVOQ1RJT05TID09PT09PT09ICovCgogICAgLyoqCiAgICAgKiBAZGV2IFNldCB0aGUgYWRkcmVzcyBvZiB0aGUgZHVuZ2VvbiB0b2tlbiBjb250cmFjdC4KICAgICAqIEBwYXJhbSBfbmV3RHVuZ2VvblRva2VuQ29udHJhY3QgQW4gYWRkcmVzcyBvZiBhIER1bmdlb25Ub2tlbiBjb250cmFjdC4KICAgICAqLwogICAgZnVuY3Rpb24gc2V0RHVuZ2VvblRva2VuQ29udHJhY3QoYWRkcmVzcyBfbmV3RHVuZ2VvblRva2VuQ29udHJhY3QpIG9ubHlPd25lciBleHRlcm5hbCB7CiAgICAgICAgZHVuZ2VvblRva2VuQ29udHJhY3QgPSBEdW5nZW9uVG9rZW4oX25ld0R1bmdlb25Ub2tlbkNvbnRyYWN0KTsKICAgIH0KCiAgICAvKioKICAgICAqIEBkZXYgU2V0IHRoZSBhZGRyZXNzIG9mIHRoZSBoZXJvIHRva2VuIGNvbnRyYWN0LgogICAgICogQHBhcmFtIF9uZXdIZXJvVG9rZW5Db250cmFjdCBBbiBhZGRyZXNzIG9mIGEgSGVyb1Rva2VuIGNvbnRyYWN0LgogICAgICovCiAgICBmdW5jdGlvbiBzZXRIZXJvVG9rZW5Db250cmFjdChhZGRyZXNzIF9uZXdIZXJvVG9rZW5Db250cmFjdCkgb25seU93bmVyIGV4dGVybmFsIHsKICAgICAgICBoZXJvVG9rZW5Db250cmFjdCA9IEhlcm9Ub2tlbihfbmV3SGVyb1Rva2VuQ29udHJhY3QpOwogICAgfQoKICAgIC8qKgogICAgICogQGRldiBTZXQgdGhlIGFkZHJlc3Mgb2YgdGhlIHNlY3JldCBkdW5nZW9uIGNoYWxsZW5nZSBmb3JtdWxhIGNvbnRyYWN0LgogICAgICogQHBhcmFtIF9uZXdDaGFsbGVuZ2VTY2llbmNlQWRkcmVzcyBBbiBhZGRyZXNzIG9mIGEgQ2hhbGxlbmdlU2NpZW5jZSBjb250cmFjdC4KICAgICAqLwogICAgZnVuY3Rpb24gc2V0Q2hhbGxlbmdlU2NpZW5jZUNvbnRyYWN0KGFkZHJlc3MgX25ld0NoYWxsZW5nZVNjaWVuY2VBZGRyZXNzKSBvbmx5T3duZXIgZXh0ZXJuYWwgewogICAgICAgIGNoYWxsZW5nZVNjaWVuY2VDb250cmFjdCA9IENoYWxsZW5nZVNjaWVuY2VJbnRlcmZhY2UoX25ld0NoYWxsZW5nZVNjaWVuY2VBZGRyZXNzKTsKICAgIH0KCiAgICAvKioKICAgICAqIEBkZXYgU2V0IHRoZSBhZGRyZXNzIG9mIHRoZSBzZWNyZXQgaGVybyB0cmFpbmluZyBmb3JtdWxhIGNvbnRyYWN0LgogICAgICogQHBhcmFtIF9uZXdUcmFpbmluZ1NjaWVuY2VBZGRyZXNzIEFuIGFkZHJlc3Mgb2YgYSBUcmFpbmluZ1NjaWVuY2UgY29udHJhY3QuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHNldFRyYWluaW5nU2NpZW5jZUNvbnRyYWN0KGFkZHJlc3MgX25ld1RyYWluaW5nU2NpZW5jZUFkZHJlc3MpIG9ubHlPd25lciBleHRlcm5hbCB7CiAgICAgICAgdHJhaW5pbmdTY2llbmNlQ29udHJhY3QgPSBUcmFpbmluZ1NjaWVuY2VJbnRlcmZhY2UoX25ld1RyYWluaW5nU2NpZW5jZUFkZHJlc3MpOwogICAgfQoKCiAgICAvKiA9PT09PT09PSBNT0RJRklFUlMgPT09PT09PT0gKi8KCiAgICAvKioKICAgICAqIEBkZXYgVGhyb3dzIGlmIF9kdW5nZW9uSWQgaXMgbm90IGNyZWF0ZWQgeWV0LgogICAgICovCiAgICBtb2RpZmllciBkdW5nZW9uRXhpc3RzKHVpbnQgX2R1bmdlb25JZCkgewogICAgICAgIHJlcXVpcmUoX2R1bmdlb25JZCA8IGR1bmdlb25Ub2tlbkNvbnRyYWN0LnRvdGFsU3VwcGx5KCkpOwogICAgICAgIF87CiAgICB9CgoKICAgIC8qID09PT09PT09IEhFTFBFUiBGVU5DVElPTlMgPT09PT09PT0gKi8KCiAgICAvKioKICAgICAqIEBkZXYgQW4gaW50ZXJuYWwgZnVuY3Rpb24gdG8gY2FsY3VsYXRlIHRoZSB0b3AgNSBoZXJvZXMgcG93ZXIgb2YgYSBwbGF5ZXIuCiAgICAgKi8KICAgIGZ1bmN0aW9uIF9nZXRUb3A1SGVyb2VzUG93ZXIoYWRkcmVzcyBfYWRkcmVzcywgdWludCBfZHVuZ2VvbklkKSBpbnRlcm5hbCB2aWV3IHJldHVybnMgKHVpbnQpIHsKICAgICAgICB1aW50IGhlcm9Db3VudCA9IGhlcm9Ub2tlbkNvbnRyYWN0LmJhbGFuY2VPZihfYWRkcmVzcyk7CgogICAgICAgIGlmIChoZXJvQ291bnQgPT0gMCkgewogICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICB9CgogICAgICAgIC8vIENvbXB1dGUgYWxsIGhlcm8gcG93ZXJzIGZvciBmdXJ0aGVyIGNhbGN1bGF0aW9uLgogICAgICAgIHVpbnRbXSBtZW1vcnkgaGVyb1Bvd2VycyA9IG5ldyB1aW50W10oaGVyb0NvdW50KTsKCiAgICAgICAgZm9yICh1aW50IGkgPSAwOyBpIDwgaGVyb0NvdW50OyBpKyspIHsKICAgICAgICAgICAgdWludCBoZXJvSWQgPSBoZXJvVG9rZW5Db250cmFjdC5vd25lclRva2VucyhfYWRkcmVzcywgaSk7CiAgICAgICAgICAgIHVpbnQgZ2VuZXM7CiAgICAgICAgICAgICgsLCwgZ2VuZXMpID0gaGVyb1Rva2VuQ29udHJhY3QuaGVyb2VzKGhlcm9JZCk7CiAgICAgICAgICAgIC8vIFBvd2VyIG9mIGR1bmdlb25JZCA9IDAgKG5vIHN1cGVyIGhlcm8gYm9vc3QpLgogICAgICAgICAgICBoZXJvUG93ZXJzW2ldID0gX2dldEhlcm9Qb3dlcihnZW5lcywgX2R1bmdlb25JZCk7CiAgICAgICAgfQoKICAgICAgICAvLyBDYWxjdWxhdGUgdGhlIHRvcCA1IGhlcm9lcyBwb3dlci4KICAgICAgICB1aW50IHJlc3VsdDsKICAgICAgICB1aW50IGN1ck1heDsKICAgICAgICB1aW50IGN1ck1heEluZGV4OwoKICAgICAgICBmb3IgKHVpbnQgajsgaiA8IDU7IGorKyl7CiAgICAgICAgICAgIGZvciAodWludCBrID0gMDsgayA8IGhlcm9Qb3dlcnMubGVuZ3RoOyBrKyspIHsKICAgICAgICAgICAgICAgIGlmIChoZXJvUG93ZXJzW2tdID4gY3VyTWF4KSB7CiAgICAgICAgICAgICAgICAgICAgY3VyTWF4ID0gaGVyb1Bvd2Vyc1trXTsKICAgICAgICAgICAgICAgICAgICBjdXJNYXhJbmRleCA9IGs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJlc3VsdCArPSBjdXJNYXg7CiAgICAgICAgICAgIGhlcm9Qb3dlcnNbY3VyTWF4SW5kZXhdID0gMDsKICAgICAgICAgICAgY3VyTWF4ID0gMDsKICAgICAgICAgICAgY3VyTWF4SW5kZXggPSAwOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIEBkZXYgQW4gaW50ZXJuYWwgZnVuY3Rpb24gdG8gY2FsY3VsYXRlIHRoZSBwb3dlciBvZiBhIGhlcm8sCiAgICAgKiAgaXQgY2FsY3VsYXRlcyB0aGUgYmFzZSBlcXVpcG1lbnQgcG93ZXIsIHN0YXRzIHBvd2VyLCBhbmQgIlN1cGVyIiBtdWx0aXBsaWVyLgogICAgICovCiAgICBmdW5jdGlvbiBfZ2V0SGVyb1Bvd2VyKHVpbnQgX2dlbmVzLCB1aW50IF9kdW5nZW9uSWQpIGludGVybmFsIHZpZXcgcmV0dXJucyAodWludCkgewogICAgICAgIHVpbnQgZGlmZmljdWx0eTsKICAgICAgICAoLCwgZGlmZmljdWx0eSwsLCwsLCkgPSBkdW5nZW9uVG9rZW5Db250cmFjdC5kdW5nZW9ucyhfZHVuZ2VvbklkKTsKCiAgICAgICAgLy8gQ2FsY3VsYXRlIHRvdGFsIHN0YXRzIHBvd2VyLgogICAgICAgIHVpbnQgc3RhdHNQb3dlcjsKCiAgICAgICAgZm9yICh1aW50IGkgPSAwOyBpIDwgNDsgaSsrKSB7CiAgICAgICAgICAgIHN0YXRzUG93ZXIgKz0gX2dlbmVzICUgMzIgKyAxOwogICAgICAgICAgICBfZ2VuZXMgLz0gMzIgKiogNDsKICAgICAgICB9CgogICAgICAgIC8vIENhbGN1bGF0ZSB0b3RhbCBlcXVpcG1lbnQgcG93ZXIuCiAgICAgICAgdWludCBlcXVpcG1lbnRQb3dlcjsKICAgICAgICB1aW50IHN1cGVyUmFuayA9IF9nZW5lcyAlIDMyOwoKICAgICAgICBmb3IgKHVpbnQgaiA9IDQ7IGogPCAxMjsgaisrKSB7CiAgICAgICAgICAgIHVpbnQgY3VyR2VuZSA9IF9nZW5lcyAlIDMyOwogICAgICAgICAgICBlcXVpcG1lbnRQb3dlciArPSBFUVVJUE1FTlRfUE9XRVJTW2N1ckdlbmVdOwogICAgICAgICAgICBfZ2VuZXMgLz0gMzIgKiogNDsKCiAgICAgICAgICAgIGlmIChzdXBlclJhbmsgIT0gY3VyR2VuZSkgewogICAgICAgICAgICAgICAgc3VwZXJSYW5rID0gMDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gQ2FsY3VsYXRlIHN1cGVyIHBvd2VyIGJvb3N0LgogICAgICAgIGJvb2wgaXNTdXBlciA9IHN1cGVyUmFuayA+PSAxNjsKICAgICAgICB1aW50IHN1cGVyQm9vc3Q7CgogICAgICAgIGlmIChpc1N1cGVyKSB7CiAgICAgICAgICAgIHN1cGVyQm9vc3QgPSAoZGlmZmljdWx0eSAtIDEpICogU1VQRVJfSEVST19NVUxUSVBMSUVSOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHN0YXRzUG93ZXIgKyBlcXVpcG1lbnRQb3dlciArIHN1cGVyQm9vc3Q7CiAgICB9CgogICAgLyoqCiAgICAgKiBAZGV2IEFuIGludGVybmFsIGZ1bmN0aW9uIHRvIGNhbGN1bGF0ZSB0aGUgZGlmZmljdWx0eSBvZiBhIGR1bmdlb24gZmxvb3IuCiAgICAgKi8KICAgIGZ1bmN0aW9uIF9nZXREdW5nZW9uUG93ZXIodWludCBfZ2VuZXMpIGludGVybmFsIHZpZXcgcmV0dXJucyAodWludCkgewogICAgICAgIC8vIENhbGN1bGF0ZSB0b3RhbCBkdW5nZW9uIHBvd2VyLgogICAgICAgIHVpbnQgZHVuZ2VvblBvd2VyOwoKICAgICAgICBmb3IgKHVpbnQgaiA9IDA7IGogPCAxMjsgaisrKSB7CiAgICAgICAgICAgIGR1bmdlb25Qb3dlciArPSBFUVVJUE1FTlRfUE9XRVJTW19nZW5lcyAlIDMyXTsKICAgICAgICAgICAgX2dlbmVzIC89IDMyICoqIDQ7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZHVuZ2VvblBvd2VyOwogICAgfQoKfQoKY29udHJhY3QgRHVuZ2VvblRyYW5zcG9ydGF0aW9uIGlzIER1bmdlb25CYXNlIHsKCiAgICAvKioKICAgICAqIEBkZXYgVGhlIFBsYXllclRyYW5zcG9ydGVkIGV2ZW50IGlzIGZpcmVkIHdoZW4gdXNlciB0cmFuc3BvcnRlZCB0byBhbm90aGVyIGR1bmdlb24uCiAgICAgKi8KICAgIGV2ZW50IFBsYXllclRyYW5zcG9ydGVkKHVpbnQgdGltZXN0YW1wLCBhZGRyZXNzIGluZGV4ZWQgcGxheWVyQWRkcmVzcywgdWludCBpbmRleGVkIG9yaWdpbkR1bmdlb25JZCwgdWludCBpbmRleGVkIGRlc3RpbmF0aW9uRHVuZ2VvbklkKTsKCgogICAgLyogPT09PT09PT0gR0FNRSBTRVRUSU5HUyA9PT09PT09PSAqLwoKICAgIC8qKgogICAgICogQG5vdGljZSBUaGUgYWN0dWFsIGZlZSBjb250cmlidXRpb24gcmVxdWlyZWQgdG8gY2FsbCB0cmFuc3BvcnQoKSBpcyBjYWxjdWxhdGVkIGJ5IHRoaXMgZmVlTXVsdGlwbGllciwKICAgICAqICB0aW1lcyB0aGUgZHVuZ2VvbiBkaWZmaWN1bHR5IG9mIGRlc3RpbmF0aW9uIGR1bmdlb24uIFRoZSBwYXltZW50IGlzIGFjY3VtdWxhdGVkIHRvIHRoZSByZXdhcmRzIG9mIHRoZSBvcmlnaW4gZHVuZ2VvbiwKICAgICAqICBhbmQgYSBsYXJnZSBwcm9wb3J0aW9uIHdpbGwgYmUgY2xhaW1lZCBieSB3aG9ldmVyIHN1Y2Nlc3NmdWxseSBjaGFsbGVuZ2VkIHRoZSBmbG9vci4KICAgICAqICAxMDAwIHN6YWJvID0gMC4wMDEgZXRoZXIKICAgICAqLwogICAgdWludCBwdWJsaWMgdHJhbnNwb3J0YXRpb25GZWVNdWx0aXBsaWVyID0gNTAwIHN6YWJvOwoKCiAgICAvKiA9PT09PT09PSBTVE9SQUdFID09PT09PT09ICovCgoKICAgIC8qKgogICAgICogQGRldiBBIG1hcHBpbmcgZnJvbSB0b2tlbiBJRHMgdG8gdGhlIGFkZHJlc3MgdGhhdCBvd25zIHRoZW0uCiAgICAgKi8KICAgIG1hcHBpbmcoYWRkcmVzcyA9PiB1aW50KSBwdWJsaWMgcGxheWVyVG9EdW5nZW9uSUQ7CgogICAgLyoqCiAgICAgKiBAZGV2IEEgbWFwcGluZyBmcm9tIG93bmVyIGFkZHJlc3MgdG8gY291bnQgb2YgdG9rZW5zIHRoYXQgYWRkcmVzcyBvd25zLgogICAgICovCiAgICBtYXBwaW5nKHVpbnQgPT4gdWludCkgcHVibGljIGR1bmdlb25QbGF5ZXJDb3VudDsKCiAgICAvKioKICAgICAqIEBkZXYgVGhlIG1haW4gZXh0ZXJuYWwgZnVuY3Rpb24gdG8gY2FsbCB3aGVuIGEgcGxheWVyIHRyYW5zcG9ydCB0byBhbm90aGVyIGR1bmdlb24uCiAgICAgKiAgV2lsbCBnZW5lcmF0ZSBhIFBsYXllclRyYW5zcG9ydGVkIGV2ZW50LgogICAgICovCiAgICBmdW5jdGlvbiB0cmFuc3BvcnQodWludCBfZGVzdGluYXRpb25EdW5nZW9uSWQpIHdoZW5Ob3RQYXVzZWQgZHVuZ2VvbkNhblRyYW5zcG9ydChfZGVzdGluYXRpb25EdW5nZW9uSWQpIGV4dGVybmFsIHBheWFibGUgewogICAgICAgIHVpbnQgb3JpZ2luRHVuZ2VvbklkID0gcGxheWVyVG9EdW5nZW9uSURbbXNnLnNlbmRlcl07CgogICAgICAgIC8vIERpc2FsbG93IHRyYW5zcG9ydCB0byB0aGUgc2FtZSBkdW5nZW9uLgogICAgICAgIHJlcXVpcmUoX2Rlc3RpbmF0aW9uRHVuZ2VvbklkICE9IG9yaWdpbkR1bmdlb25JZCk7CgogICAgICAgIC8vIEdldCB0aGUgZHVuZ2VvbiBkZXRhaWxzIGZyb20gdGhlIHRva2VuIGNvbnRyYWN0LgogICAgICAgIHVpbnQgZGlmZmljdWx0eTsKICAgICAgICB1aW50IGNhcGFjaXR5OwogICAgICAgICgsLCBkaWZmaWN1bHR5LCBjYXBhY2l0eSwsLCwsKSA9IGR1bmdlb25Ub2tlbkNvbnRyYWN0LmR1bmdlb25zKF9kZXN0aW5hdGlvbkR1bmdlb25JZCk7CgogICAgICAgIC8vIERpc2FsbG93IHdlYWtlciB1c2VyIHRvIHRyYW5zcG9ydCB0byAiZGlmZmljdWx0IiBkdW5nZW9uLgogICAgICAgIHVpbnQgdG9wNUhlcm9lc1Bvd2VyID0gX2dldFRvcDVIZXJvZXNQb3dlcihtc2cuc2VuZGVyLCBfZGVzdGluYXRpb25EdW5nZW9uSWQpOwogICAgICAgIHJlcXVpcmUodG9wNUhlcm9lc1Bvd2VyID49IGRpZmZpY3VsdHkgKiAxMik7CgogICAgICAgIC8vIENoZWNrcyBmb3IgcGF5bWVudCwgYW55IGV4Y2VlZGluZyBmdW5kcyB3aWxsIGJlIHRyYW5zZmVycmVkIGJhY2sgdG8gdGhlIHBsYXllci4KICAgICAgICB1aW50IGJhc2VGZWUgPSBkaWZmaWN1bHR5ICogdHJhbnNwb3J0YXRpb25GZWVNdWx0aXBsaWVyOwogICAgICAgIHVpbnQgYWRkaXRpb25hbEZlZSA9IHRvcDVIZXJvZXNQb3dlciAvIDQ4ICogdHJhbnNwb3J0YXRpb25GZWVNdWx0aXBsaWVyOwogICAgICAgIHVpbnQgcmVxdWlyZWRGZWUgPSBiYXNlRmVlICsgYWRkaXRpb25hbEZlZTsKICAgICAgICByZXF1aXJlKG1zZy52YWx1ZSA+PSByZXF1aXJlZEZlZSk7CgogICAgICAgIC8vICoqIFNUT1JBR0UgVVBEQVRFICoqCiAgICAgICAgLy8gSW5jcmVtZW50IHRoZSBhY2N1bXVsYXRlZCByZXdhcmRzIGZvciB0aGUgZHVuZ2Vvbi4KICAgICAgICBkdW5nZW9uVG9rZW5Db250cmFjdC5hZGREdW5nZW9uUmV3YXJkcyhvcmlnaW5EdW5nZW9uSWQsIHJlcXVpcmVkRmVlKTsKCiAgICAgICAgLy8gQ2FsY3VsYXRlIGFueSBleGNlc3MgZnVuZHMgYW5kIG1ha2UgaXQgYXZhaWxhYmxlIHRvIGJlIHdpdGhkcmF3ZWQgYnkgdGhlIHBsYXllci4KICAgICAgICBhc3luY1NlbmQobXNnLnNlbmRlciwgbXNnLnZhbHVlIC0gcmVxdWlyZWRGZWUpOwoKICAgICAgICBfdHJhbnNwb3J0KG9yaWdpbkR1bmdlb25JZCwgX2Rlc3RpbmF0aW9uRHVuZ2VvbklkKTsKICAgIH0KCiAgICAvKioKICAgICAqIFByaXZhdGUgZnVuY3Rpb24gdG8gYXNzaWducyBsb2NhdGlvbiBvZiBhIHBsYXllcgogICAgICovCiAgICBmdW5jdGlvbiBfdHJhbnNwb3J0KHVpbnQgX29yaWdpbkR1bmdlb25JZCwgdWludCBfZGVzdGluYXRpb25EdW5nZW9uSWQpIHByaXZhdGUgewogICAgICAgIC8vIElmIGEgcGxheWVyIGRvIG5vdCBoYXZlIGFueSBoZXJvLCBjbGFpbSBmaXJzdCBoZXJvLgogICAgICAgIGlmIChoZXJvVG9rZW5Db250cmFjdC5iYWxhbmNlT2YobXNnLnNlbmRlcikgPT0gMCkgewogICAgICAgICAgICBjbGFpbUhlcm8oKTsKICAgICAgICB9CgogICAgICAgIC8vICoqIFNUT1JBR0UgVVBEQVRFICoqCiAgICAgICAgLy8gVXBkYXRlIHRoZSBvd25lcnNoaXBUb2tlbkNvdW50LgogICAgICAgIGR1bmdlb25QbGF5ZXJDb3VudFtfb3JpZ2luRHVuZ2VvbklkXS0tOwogICAgICAgIGR1bmdlb25QbGF5ZXJDb3VudFtfZGVzdGluYXRpb25EdW5nZW9uSWRdKys7CgogICAgICAgIC8vICoqIFNUT1JBR0UgVVBEQVRFICoqCiAgICAgICAgLy8gVXBkYXRlIHBsYXllciBsb2NhdGlvbi4KICAgICAgICBwbGF5ZXJUb0R1bmdlb25JRFttc2cuc2VuZGVyXSA9IF9kZXN0aW5hdGlvbkR1bmdlb25JZDsKCiAgICAgICAgLy8gRW1pdCB0aGUgRHVuZ2VvbkNoYWxsZW5nZWQgZXZlbnQuCiAgICAgICAgUGxheWVyVHJhbnNwb3J0ZWQobm93LCBtc2cuc2VuZGVyLCBfb3JpZ2luRHVuZ2VvbklkLCBfZGVzdGluYXRpb25EdW5nZW9uSWQpOwogICAgfQoKCiAgICAvKiA9PT09PT09PSBPV05FUlNISVAgRlVOQ1RJT05TID09PT09PT09ICovCgogICAgLyoqCiAgICAgKiBAbm90aWNlIFVzZWQgaW4gdHJhbnNwb3J0LCBjaGFsbGVuZ2UgYW5kIHRyYWluLCB0byBnZXQgdGhlIGdlbmVzIG9mIGEgc3BlY2lmaWMgaGVybywKICAgICAqICBhIGNsYWltIGEgaGVybyBpZiBkaWRuJ3QgaGF2ZSBhbnkuCiAgICAgKi8KICAgIGZ1bmN0aW9uIF9nZXRIZXJvR2VuZXNPckNsYWltRmlyc3RIZXJvKHVpbnQgX2hlcm9JZCkgaW50ZXJuYWwgcmV0dXJucyAodWludCBoZXJvSWQsIHVpbnQgaGVyb0dlbmVzKSB7CiAgICAgICAgaGVyb0lkID0gX2hlcm9JZDsKCiAgICAgICAgLy8gSWYgYSBwbGF5ZXIgZG8gbm90IGhhdmUgYW55IGhlcm8sIGNsYWltIGZpcnN0IGhlcm8gZmlyc3QuCiAgICAgICAgaWYgKGhlcm9Ub2tlbkNvbnRyYWN0LmJhbGFuY2VPZihtc2cuc2VuZGVyKSA9PSAwKSB7CiAgICAgICAgICAgIGhlcm9JZCA9IGNsYWltSGVybygpOwogICAgICAgIH0KCiAgICAgICAgKCwsLGhlcm9HZW5lcykgPSBoZXJvVG9rZW5Db250cmFjdC5oZXJvZXMoaGVyb0lkKTsKICAgIH0KCiAgICAvKioKICAgICAqIEBkZXYgQ2xhaW0gYSBuZXcgaGVybyB3aXRoIGVtcHR5IGdlbmVzLgogICAgICovCiAgICBmdW5jdGlvbiBjbGFpbUhlcm8oKSBwdWJsaWMgcmV0dXJucyAodWludCkgewogICAgICAgIC8vIElmIGEgcGxheWVyIGRvIG5vdCB0cmFucG9ydCB0byBhbnkgZHVuZ2VvbiB5ZXQsIGFuZCBpdCBpcyB0aGUgZmlyc3QgdGltZSBjbGFpbWluZyB0aGUgaGVybywKICAgICAgICAvLyBzZXQgdGhlIGR1bmdlb24gbG9jYXRpb24sIGluY3JlbWVudCB0aGUgIzAgSG9seWxhbmQgcGxheWVyIGNvdW50IGJ5IDEuCiAgICAgICAgaWYgKHBsYXllclRvRHVuZ2VvbklEW21zZy5zZW5kZXJdID09IDAgJiYgaGVyb1Rva2VuQ29udHJhY3QuYmFsYW5jZU9mKG1zZy5zZW5kZXIpID09IDApIHsKICAgICAgICAgICAgZHVuZ2VvblBsYXllckNvdW50WzBdKys7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gaGVyb1Rva2VuQ29udHJhY3QuY3JlYXRlSGVybygwLCBtc2cuc2VuZGVyKTsKICAgIH0KCgogICAgLyogPT09PT09PT0gU0VUVEVSIEZVTkNUSU9OUyA9PT09PT09PSAqLwoKICAgIC8qKgogICAgICogQGRldiBVcGRhdGVzIHRoZSBmZWUgY29udHJpYnV0aW9uIG11bHRpcGxpZXIgcmVxdWlyZWQgZm9yIGNhbGxpbmcgdHJhbnNwb3J0KCkuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHNldFRyYW5zcG9ydGF0aW9uRmVlTXVsdGlwbGllcih1aW50IF9uZXdUcmFuc3BvcnRhdGlvbkZlZU11bHRpcGxpZXIpIG9ubHlPd25lciBleHRlcm5hbCB7CiAgICAgICAgdHJhbnNwb3J0YXRpb25GZWVNdWx0aXBsaWVyID0gX25ld1RyYW5zcG9ydGF0aW9uRmVlTXVsdGlwbGllcjsKICAgIH0KCgogICAgLyogPT09PT09PT0gTU9ESUZJRVJTID09PT09PT09ICovCgogICAgLyoqCiAgICAgKiBAZGV2IFRocm93cyBpZiBkdW5nZW9uIHN0YXR1cyBkbyBub3QgYWxsb3cgdHJhbnNwb3J0YXRpb24sIGFsc28gY2hlY2sgZm9yIGR1bmdlb24gZXhpc3RlbmNlLgogICAgICogIEFsc28gY2hlY2sgaWYgdGhlIGNhcGFjaXR5IG9mIHRoZSBkZXN0aW5hdGlvbiBkdW5nZW9uIGlzIHJlYWNoZWQuCiAgICAgKi8KICAgIG1vZGlmaWVyIGR1bmdlb25DYW5UcmFuc3BvcnQodWludCBfZGVzdGluYXRpb25EdW5nZW9uSWQpIHsKICAgICAgICByZXF1aXJlKF9kZXN0aW5hdGlvbkR1bmdlb25JZCA8IGR1bmdlb25Ub2tlbkNvbnRyYWN0LnRvdGFsU3VwcGx5KCkpOwogICAgICAgIHVpbnQgc3RhdHVzOwogICAgICAgIHVpbnQgY2FwYWNpdHk7CiAgICAgICAgKCxzdGF0dXMsLGNhcGFjaXR5LCwsLCwpID0gZHVuZ2VvblRva2VuQ29udHJhY3QuZHVuZ2VvbnMoX2Rlc3RpbmF0aW9uRHVuZ2VvbklkKTsKICAgICAgICByZXF1aXJlKHN0YXR1cyA9PSAwIHx8IHN0YXR1cyA9PSAxKTsKCiAgICAgICAgLy8gQ2hlY2sgaWYgdGhlIGNhcGFjaXR5IG9mIHRoZSBkZXN0aW5hdGlvbiBkdW5nZW9uIGlzIHJlYWNoZWQuCiAgICAgICAgLy8gQ2FwYWNpdHkgMCA9IEluZmluaXR5CiAgICAgICAgcmVxdWlyZShjYXBhY2l0eSA9PSAwIHx8IGR1bmdlb25QbGF5ZXJDb3VudFtfZGVzdGluYXRpb25EdW5nZW9uSWRdIDwgY2FwYWNpdHkpOwogICAgICAgIF87CiAgICB9Cgp9Cgpjb250cmFjdCBEdW5nZW9uQ2hhbGxlbmdlIGlzIER1bmdlb25UcmFuc3BvcnRhdGlvbiB7CgogICAgLyoqCiAgICAgKiBAZGV2IFRoZSBEdW5nZW9uQ2hhbGxlbmdlZCBldmVudCBpcyBmaXJlZCB3aGVuIHVzZXIgZmluaXNoZWQgYSBkdW5nZW9uIGNoYWxsZW5nZS4KICAgICAqLwogICAgZXZlbnQgRHVuZ2VvbkNoYWxsZW5nZWQodWludCB0aW1lc3RhbXAsIGFkZHJlc3MgaW5kZXhlZCBwbGF5ZXJBZGRyZXNzLCB1aW50IGluZGV4ZWQgZHVuZ2VvbklkLCB1aW50IGluZGV4ZWQgaGVyb0lkLCB1aW50IGhlcm9HZW5lcywgdWludCBmbG9vck51bWJlciwgdWludCBmbG9vckdlbmVzLCBib29sIHN1Y2Nlc3MsIHVpbnQgbmV3Rmxvb3JHZW5lcywgdWludCBzdWNjZXNzUmV3YXJkcywgdWludCBtYXN0ZXJSZXdhcmRzKTsKCgogICAgLyogPT09PT09PT0gR0FNRSBTRVRUSU5HUyA9PT09PT09PSAqLwoKICAgIC8qKgogICAgICogQG5vdGljZSBUaGUgYWN0dWFsIGZlZSBjb250cmlidXRpb24gcmVxdWlyZWQgdG8gY2FsbCBjaGFsbGVuZ2UoKSBpcyBjYWxjdWxhdGVkIGJ5IHRoaXMgZmVlTXVsdGlwbGllciwKICAgICAqICB0aW1lcyB0aGUgZHVuZ2VvbiBkaWZmaWN1bHR5LiBUaGUgcGF5bWVudCBpcyBhY2N1bXVsYXRlZCB0byB0aGUgZHVuZ2VvbiByZXdhcmRzLAogICAgICogIGFuZCBhIGxhcmdlIHByb3BvcnRpb24gd2lsbCBiZSBjbGFpbWVkIGJ5IHdob2V2ZXIgc3VjY2Vzc2Z1bGx5IGNoYWxsZW5nZWQgdGhlIGZsb29yLgogICAgICogIDEgZmlubmV5ID0gMC4wMDEgZXRoZXIKICAgICAqLwogICAgdWludCBwdWJsaWMgY2hhbGxlbmdlRmVlTXVsdGlwbGllciA9IDEgZmlubmV5OwoKICAgIC8qKgogICAgICogQGRldiBUaGUgcGVyY2VudGFnZSBmb3Igd2hpY2ggc3VjY2Vzc2Z1bCBjaGFsbGVuZ2VyIGJlIHJld2FyZGVkIG9mIHRoZSBkdW5nZW9ucycgYWNjdW11bGF0ZWQgcmV3YXJkcy4KICAgICAqICBUaGUgcmVtYWluaW5nIHJld2FyZHMgc3VidHJhY3QgZHVuZ2VvbiBtYXN0ZXIgcmV3YXJkcyB3aWxsIGJlIHVzZWQgYXMgdGhlIGJhc2UgcmV3YXJkcyBmb3IgbmV3IGZsb29yLgogICAgICovCiAgICB1aW50IHB1YmxpYyBjaGFsbGVuZ2VSZXdhcmRzUGVyY2VudCA9IDY0OwoKICAgIC8qKgogICAgICogQGRldiBUaGUgZGV2ZWxvcGVyIGZlZSBmb3Igb3duZXIKICAgICAqICBOb3RlIHRoYXQgd2hlbiBFdGhlciBEdW5nZW9uIGJlY29tZXMgdHJ1bHkgZGVjZW50cmFsaXNlZCwgY29udHJhY3Qgb3duZXJzaGlwIHdpbGwgYmUgZWplY3RlZCwKICAgICAqICBhbmQgdGhlIG1hc3RlciByZXdhcmRzIHdpbGwgYmUgcmV3YXJkZWQgdG8gdGhlIGR1bmdlb24gb3duZXIgKER1bmdlb24gTWFzdGVycykuCiAgICAgKi8KICAgIHVpbnQgcHVibGljIG1hc3RlclJld2FyZHNQZXJjZW50ID0gODsKCiAgICAvKioKICAgICAqIEBkZXYgVGhlIGNvb2xkb3duIHRpbWUgcGVyaW9kIHdoZXJlIGEgaGVybyBjYW4gZW5nYWdlIGluIGNoYWxsZW5nZSBhZ2Fpbi4KICAgICAqICBUaGlzIHNldHRpbmdzIHdpbGwgbGlrZWx5IGJlIGNoYW5nZWQgdG8gMjAgbWludXRlcyB3aGVuIG11bHRpcGxlIGhlcm9lcyBzeXN0ZW0gaXMgbGF1bmNoZWQgaW4gVmVyc2lvbiAxLgogICAgICovCiAgICB1aW50IHB1YmxpYyBjaGFsbGVuZ2VDb29sZG93blRpbWUgPSAzIG1pbnV0ZXM7CgogICAgLyoqCiAgICAgKiBAZGV2IFRoZSBwcmVwYXJhdGlvbiB0aW1lIHBlcmlvZCB3aGVyZSBhIG5ldyBkdW5nZW9uIGlzIGNyZWF0ZWQsIGJlZm9yZSBpdCBjYW4gYmUgY2hhbGxlbmdlZC4KICAgICAqICBUaGlzIHNldHRpbmdzIHdpbGwgbGlrZWx5IGJlIGNoYW5nZWQgdG8gYSBzbWFsbGVyIHBlcmlvZCAoZS5nLiAyMC0zMCBtaW51dGVzKSAuCiAgICAgKi8KICAgIHVpbnQgcHVibGljIGR1bmdlb25QcmVwYXJhdGlvblRpbWUgPSA2MCBtaW51dGVzOwoKICAgIC8qKgogICAgICogQGRldiBUaGUgY2hhbGxlbmdlIHJld2FyZHMgcGVyY2VudGFnZSB1c2VkIHJpZ2h0IGFmdGVyIHRoZSBwcmVwYXJhdGlvbiBwZXJpb2QuCiAgICAgKi8KICAgIHVpbnQgcHVibGljIHJ1c2hUaW1lQ2hhbGxlbmdlUmV3YXJkc1BlcmNlbnQgPSAzMDsKCiAgICAvKioKICAgICAqIEBkZXYgVGhlIG51bWJlciBvZiBmbG9vciBpbiB3aGljaCB0aGUgcnVzaFRpbWVDaGFsbGVuZ2VSZXdhcmRzUGVyY2VudCBiZSBhcHBsaWVkLgogICAgICovCiAgICB1aW50IHB1YmxpYyBydXNoVGltZUZsb29yQ291bnQgPSAzMDsKCiAgICAvKioKICAgICAqIEBkZXYgVGhlIG1haW4gZXh0ZXJuYWwgZnVuY3Rpb24gdG8gY2FsbCB3aGVuIGEgcGxheWVyIGNoYWxsZW5nZSBhIGR1bmdlb24sCiAgICAgKiAgaXQgZGV0ZXJtaW5lcyB3aGV0aGVyIGlmIHRoZSBwbGF5ZXIgc3VjY2Vzc2Z1bGx5IGNoYWxsZW5nZWQgdGhlIGN1cnJlbnQgZmxvb3IuCiAgICAgKiAgV2lsbCBnZW5lcmF0ZSBhIER1bmdlb25DaGFsbGVuZ2VkIGV2ZW50LgogICAgICovCiAgICBmdW5jdGlvbiBjaGFsbGVuZ2UodWludCBfZHVuZ2VvbklkLCB1aW50IF9oZXJvSWQpIHdoZW5Ob3RQYXVzZWQgZHVuZ2VvbkNhbkNoYWxsZW5nZShfZHVuZ2VvbklkKSBoZXJvQWxsb3dlZFRvQ2hhbGxlbmdlKF9oZXJvSWQpIGV4dGVybmFsIHBheWFibGUgewogICAgICAgIC8vIEdldCB0aGUgZHVuZ2VvbiBkZXRhaWxzIGZyb20gdGhlIHRva2VuIGNvbnRyYWN0LgogICAgICAgIHVpbnQgZGlmZmljdWx0eTsKICAgICAgICB1aW50IHNlZWRHZW5lczsKICAgICAgICAoLCwgZGlmZmljdWx0eSwsLCwsIHNlZWRHZW5lcywpID0gZHVuZ2VvblRva2VuQ29udHJhY3QuZHVuZ2VvbnMoX2R1bmdlb25JZCk7CgogICAgICAgIC8vIENoZWNrcyBmb3IgcGF5bWVudCwgYW55IGV4Y2VlZGluZyBmdW5kcyB3aWxsIGJlIHRyYW5zZmVycmVkIGJhY2sgdG8gdGhlIHBsYXllci4KICAgICAgICB1aW50IHJlcXVpcmVkRmVlID0gZGlmZmljdWx0eSAqIGNoYWxsZW5nZUZlZU11bHRpcGxpZXI7CiAgICAgICAgcmVxdWlyZShtc2cudmFsdWUgPj0gcmVxdWlyZWRGZWUpOwoKICAgICAgICAvLyAqKiBTVE9SQUdFIFVQREFURSAqKgogICAgICAgIC8vIEluY3JlbWVudCB0aGUgYWNjdW11bGF0ZWQgcmV3YXJkcyBmb3IgdGhlIGR1bmdlb24uCiAgICAgICAgZHVuZ2VvblRva2VuQ29udHJhY3QuYWRkRHVuZ2VvblJld2FyZHMoX2R1bmdlb25JZCwgcmVxdWlyZWRGZWUpOwoKICAgICAgICAvLyBDYWxjdWxhdGUgYW55IGV4Y2VzcyBmdW5kcyBhbmQgbWFrZSBpdCBhdmFpbGFibGUgdG8gYmUgd2l0aGRyYXdlZCBieSB0aGUgcGxheWVyLgogICAgICAgIGFzeW5jU2VuZChtc2cuc2VuZGVyLCBtc2cudmFsdWUgLSByZXF1aXJlZEZlZSk7CgogICAgICAgIC8vIFNwbGl0IHRoZSBjaGFsbGVuZ2UgZnVuY3Rpb24gaW50byBtdWx0aXBsZSBwYXJ0cyBiZWNhdXNlIG9mIHN0YWNrIHRvbyBkZWVwIGVycm9yLgogICAgICAgIF9jaGFsbGVuZ2VQYXJ0MihfZHVuZ2VvbklkLCBfaGVyb0lkKTsKICAgIH0KCiAgICAvKioKICAgICAqIFNwbGl0IHRoZSBjaGFsbGVuZ2UgZnVuY3Rpb24gaW50byBtdWx0aXBsZSBwYXJ0cyBiZWNhdXNlIG9mIHN0YWNrIHRvbyBkZWVwIGVycm9yLgogICAgICovCiAgICBmdW5jdGlvbiBfY2hhbGxlbmdlUGFydDIodWludCBfZHVuZ2VvbklkLCB1aW50IF9oZXJvSWQpIHByaXZhdGUgewogICAgICAgIHVpbnQgZmxvb3JOdW1iZXI7CiAgICAgICAgdWludCByZXdhcmRzOwogICAgICAgIHVpbnQgZmxvb3JHZW5lczsKICAgICAgICAoLCwsLCBmbG9vck51bWJlciwsIHJld2FyZHMsLCBmbG9vckdlbmVzKSA9IGR1bmdlb25Ub2tlbkNvbnRyYWN0LmR1bmdlb25zKF9kdW5nZW9uSWQpOwoKICAgICAgICAvLyBHZXQgdGhlIGhlcm8gZ2VuZSwgb3IgY2xhaW0gZmlyc3QgaGVyby4KICAgICAgICB1aW50IGhlcm9HZW5lczsKICAgICAgICAoX2hlcm9JZCwgaGVyb0dlbmVzKSA9IF9nZXRIZXJvR2VuZXNPckNsYWltRmlyc3RIZXJvKF9oZXJvSWQpOwoKICAgICAgICBib29sIHN1Y2Nlc3MgPSBfZ2V0Q2hhbGxlbmdlU3VjY2VzcyhoZXJvR2VuZXMsIF9kdW5nZW9uSWQsIGZsb29yR2VuZXMpOwoKICAgICAgICB1aW50IG5ld0Zsb29yR2VuZXM7CiAgICAgICAgdWludCBtYXN0ZXJSZXdhcmRzOwogICAgICAgIHVpbnQgc3VjY2Vzc1Jld2FyZHM7CiAgICAgICAgdWludCBuZXdSZXdhcmRzOwoKICAgICAgICAvLyBXaGV0aGVyIGEgY2hhbGxlbmdlIGlzIHN1Y2Nlc3Mgb3Igbm90IGlzIGRldGVybWluZWQgYnkgYSBzaW1wbGUgY29tcGFyaXNvbiBiZXR3ZWVuIGhlcm8gcG93ZXIgYW5kIGZsb29yIHBvd2VyLgogICAgICAgIGlmIChzdWNjZXNzKSB7CiAgICAgICAgICAgIG5ld0Zsb29yR2VuZXMgPSBfZ2V0TmV3Rmxvb3JHZW5lKF9kdW5nZW9uSWQpOwoKICAgICAgICAgICAgbWFzdGVyUmV3YXJkcyA9IHJld2FyZHMgKiBtYXN0ZXJSZXdhcmRzUGVyY2VudCAvIDEwMDsKCiAgICAgICAgICAgIGlmIChmbG9vck51bWJlciA8IHJ1c2hUaW1lRmxvb3JDb3VudCkgeyAvLyBydXNoIHRpbWUgcmlnaHQgYWZ0ZXIgcHJlcHJhdGlvbiBwZXJpb2QKICAgICAgICAgICAgICAgIHN1Y2Nlc3NSZXdhcmRzID0gcmV3YXJkcyAqIHJ1c2hUaW1lQ2hhbGxlbmdlUmV3YXJkc1BlcmNlbnQgLyAxMDA7CgogICAgICAgICAgICAgICAgLy8gVGhlIGR1bmdlb24gcmV3YXJkcyBmb3IgbmV3IGZsb29yIGFzIHRvdGFsIHJld2FyZHMgLSBjaGFsbGVuZ2UgcmV3YXJkcyAtIGRldmxlb3BlciBmZWUuCiAgICAgICAgICAgICAgICBuZXdSZXdhcmRzID0gcmV3YXJkcyAqICgxMDAgLSBydXNoVGltZUNoYWxsZW5nZVJld2FyZHNQZXJjZW50IC0gbWFzdGVyUmV3YXJkc1BlcmNlbnQpIC8gMTAwOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgc3VjY2Vzc1Jld2FyZHMgPSByZXdhcmRzICogY2hhbGxlbmdlUmV3YXJkc1BlcmNlbnQgLyAxMDA7CiAgICAgICAgICAgICAgICBuZXdSZXdhcmRzID0gcmV3YXJkcyAqICgxMDAgLSBjaGFsbGVuZ2VSZXdhcmRzUGVyY2VudCAtIG1hc3RlclJld2FyZHNQZXJjZW50KSAvIDEwMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gVFJJUExFIENPTkZJUk0gc2FuaXR5IGNoZWNrLgogICAgICAgICAgICByZXF1aXJlKHN1Y2Nlc3NSZXdhcmRzICsgbWFzdGVyUmV3YXJkcyArIG5ld1Jld2FyZHMgPD0gcmV3YXJkcyk7CgogICAgICAgICAgICAvLyAqKiBTVE9SQUdFIFVQREFURSAqKgogICAgICAgICAgICAvLyBBZGQgbmV3IGZsb29yIHdpdGggdGhlIG5ldyBmbG9vciBnZW5lcyBhbmQgbmV3IHJld2FyZHMuCiAgICAgICAgICAgIGR1bmdlb25Ub2tlbkNvbnRyYWN0LmFkZER1bmdlb25OZXdGbG9vcihfZHVuZ2VvbklkLCBuZXdSZXdhcmRzLCBuZXdGbG9vckdlbmVzKTsKCiAgICAgICAgICAgIC8vIE1hcmsgdGhlIGNoYWxsZW5nZSByZXdhcmRzIGF2YWlsYWJsZSB0byBiZSB3aXRoZHJhd2VkIGJ5IHRoZSBwbGF5ZXIuCiAgICAgICAgICAgIGFzeW5jU2VuZChtc2cuc2VuZGVyLCBzdWNjZXNzUmV3YXJkcyk7CgogICAgICAgICAgICAvLyBNYXJrIHRoZSBtYXN0ZXIgcmV3YXJkcyBhdmFpbGFibGUgdG8gYmUgd2l0aGRyYXdlZCBieSB0aGUgZHVuZ2VvbiBtYXN0ZXIuCiAgICAgICAgICAgIGFzeW5jU2VuZChkdW5nZW9uVG9rZW5Db250cmFjdC5vd25lck9mKF9kdW5nZW9uSWQpLCBtYXN0ZXJSZXdhcmRzKTsKICAgICAgICB9CgogICAgICAgIC8vICoqIFNUT1JBR0UgVVBEQVRFICoqCiAgICAgICAgLy8gVHJpZ2dlciB0aGUgY29vbGRvd24gZm9yIHRoZSBoZXJvLgogICAgICAgIGhlcm9Ub2tlbkNvbnRyYWN0LnRyaWdnZXJDb29sZG93bihfaGVyb0lkKTsKCiAgICAgICAgLy8gRW1pdCB0aGUgRHVuZ2VvbkNoYWxsZW5nZWQgZXZlbnQuCiAgICAgICAgRHVuZ2VvbkNoYWxsZW5nZWQobm93LCBtc2cuc2VuZGVyLCBfZHVuZ2VvbklkLCBfaGVyb0lkLCBoZXJvR2VuZXMsIGZsb29yTnVtYmVyLCBmbG9vckdlbmVzLCBzdWNjZXNzLCBuZXdGbG9vckdlbmVzLCBzdWNjZXNzUmV3YXJkcywgbWFzdGVyUmV3YXJkcyk7CiAgICB9CgogICAgLyoqCiAgICAgKiBTcGxpdCB0aGUgY2hhbGxlbmdlIGZ1bmN0aW9uIGludG8gbXVsdGlwbGUgcGFydHMgYmVjYXVzZSBvZiBzdGFjayB0b28gZGVlcCBlcnJvci4KICAgICAqLwogICAgZnVuY3Rpb24gX2dldENoYWxsZW5nZVN1Y2Nlc3ModWludCBfaGVyb0dlbmVzLCB1aW50IF9kdW5nZW9uSWQsIHVpbnQgX2Zsb29yR2VuZXMpIHByaXZhdGUgdmlldyByZXR1cm5zIChib29sKSB7CiAgICAgICAgLy8gRGV0ZXJtaW5lIGlmIHRoZSBwbGF5ZXIgY2hhbGxlbmdlIHN1Y2Nlc3NmdWx5IHRoZSBkdW5nZW9uIG9yIG5vdC4KICAgICAgICB1aW50IGhlcm9Qb3dlciA9IF9nZXRIZXJvUG93ZXIoX2hlcm9HZW5lcywgX2R1bmdlb25JZCk7CiAgICAgICAgdWludCBmbG9vclBvd2VyID0gX2dldER1bmdlb25Qb3dlcihfZmxvb3JHZW5lcyk7CgogICAgICAgIHJldHVybiBoZXJvUG93ZXIgPiBmbG9vclBvd2VyOwogICAgfQoKICAgIC8qKgogICAgICogU3BsaXQgdGhlIGNoYWxsZW5nZSBmdW5jdGlvbiBpbnRvIG11bHRpcGxlIHBhcnRzIGJlY2F1c2Ugb2Ygc3RhY2sgdG9vIGRlZXAgZXJyb3IuCiAgICAgKi8KICAgIGZ1bmN0aW9uIF9nZXROZXdGbG9vckdlbmUodWludCBfZHVuZ2VvbklkKSBwcml2YXRlIHJldHVybnMgKHVpbnQpIHsKICAgICAgICB1aW50IHNlZWRHZW5lczsKICAgICAgICB1aW50IGZsb29yR2VuZXM7CiAgICAgICAgKCwsLCwsLCBzZWVkR2VuZXMsIGZsb29yR2VuZXMpID0gZHVuZ2VvblRva2VuQ29udHJhY3QuZHVuZ2VvbnMoX2R1bmdlb25JZCk7CgogICAgICAgIC8vIENhbGN1bGF0ZSB0aGUgbmV3IGZsb29yIGdlbmUuCiAgICAgICAgdWludCBmbG9vclBvd2VyID0gX2dldER1bmdlb25Qb3dlcihmbG9vckdlbmVzKTsKCiAgICAgICAgLy8gQ2FsbCB0aGUgZXh0ZXJuYWwgY2xvc2VkIHNvdXJjZSBzZWNyZXQgZnVuY3Rpb24gdGhhdCBkZXRlcm1pbmVzIHRoZSByZXN1bHRpbmcgZmxvb3IgImdlbmVzIi4KICAgICAgICB1aW50IG5ld0Zsb29yR2VuZXMgPSBjaGFsbGVuZ2VTY2llbmNlQ29udHJhY3QubWl4R2VuZXMoZmxvb3JHZW5lcywgc2VlZEdlbmVzKTsKCiAgICAgICAgdWludCBuZXdGbG9vclBvd2VyID0gX2dldER1bmdlb25Qb3dlcihuZXdGbG9vckdlbmVzKTsKCiAgICAgICAgLy8gSWYgdGhlIHBvd2VyIGRlY3JlYXNlZCwgcm9sbGJhY2sgdG8gdGhlIGN1cnJlbnQgZmxvb3IgZ2VuZXMuCiAgICAgICAgaWYgKG5ld0Zsb29yUG93ZXIgPCBmbG9vclBvd2VyKSB7CiAgICAgICAgICAgIG5ld0Zsb29yR2VuZXMgPSBmbG9vckdlbmVzOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG5ld0Zsb29yR2VuZXM7CiAgICB9CgoKICAgIC8qID09PT09PT09IFNFVFRFUiBGVU5DVElPTlMgPT09PT09PT0gKi8KCiAgICAvKioKICAgICAqIEBkZXYgVXBkYXRlcyB0aGUgZmVlIGNvbnRyaWJ1dGlvbiBtdWx0aXBsaWVyIHJlcXVpcmVkIGZvciBjYWxsaW5nIGNoYWxsZW5nZSgpLgogICAgICovCiAgICBmdW5jdGlvbiBzZXRDaGFsbGVuZ2VGZWVNdWx0aXBsaWVyKHVpbnQgX25ld0NoYWxsZW5nZUZlZU11bHRpcGxpZXIpIG9ubHlPd25lciBleHRlcm5hbCB7CiAgICAgICAgY2hhbGxlbmdlRmVlTXVsdGlwbGllciA9IF9uZXdDaGFsbGVuZ2VGZWVNdWx0aXBsaWVyOwogICAgfQoKICAgIC8qKgogICAgICogQGRldiBVcGRhdGVzIHRoZSBjaGFsbGVuZ2UgcmV3YXJkcyBwZWNlbnRhZ2UuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHNldENoYWxsZW5nZVJld2FyZHNQZXJjZW50KHVpbnQgX25ld0NoYWxsZW5nZVJld2FyZHNQZXJjZW50KSBvbmx5T3duZXIgZXh0ZXJuYWwgewogICAgICAgIGNoYWxsZW5nZVJld2FyZHNQZXJjZW50ID0gX25ld0NoYWxsZW5nZVJld2FyZHNQZXJjZW50OwogICAgfQoKICAgIC8qKgogICAgICogQGRldiBVcGRhdGVzIHRoZSBtYXN0ZXIgcmV3YXJkcyBwZXJjZW50YWdlLgogICAgICovCiAgICBmdW5jdGlvbiBzZXRNYXN0ZXJSZXdhcmRzUGVyY2VudCh1aW50IF9uZXdNYXN0ZXJSZXdhcmRzUGVyY2VudCkgb25seU93bmVyIGV4dGVybmFsIHsKICAgICAgICBtYXN0ZXJSZXdhcmRzUGVyY2VudCA9IF9uZXdNYXN0ZXJSZXdhcmRzUGVyY2VudDsKICAgIH0KCiAgICAvKioKICAgICAqIEBkZXYgVXBkYXRlcyB0aGUgY2hhbGxlbmdlIGNvb2xkb3duIHRpbWUuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHNldENoYWxsZW5nZUNvb2xkb3duVGltZSh1aW50IF9uZXdDaGFsbGVuZ2VDb29sZG93blRpbWUpIG9ubHlPd25lciBleHRlcm5hbCB7CiAgICAgICAgY2hhbGxlbmdlQ29vbGRvd25UaW1lID0gX25ld0NoYWxsZW5nZUNvb2xkb3duVGltZTsKICAgIH0KCiAgICAvKioKICAgICAqIEBkZXYgVXBkYXRlcyB0aGUgY2hhbGxlbmdlIGNvb2xkb3duIHRpbWUuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHNldER1bmdlb25QcmVwYXJhdGlvblRpbWUodWludCBfbmV3RHVuZ2VvblByZXBhcmF0aW9uVGltZSkgb25seU93bmVyIGV4dGVybmFsIHsKICAgICAgICBkdW5nZW9uUHJlcGFyYXRpb25UaW1lID0gX25ld0R1bmdlb25QcmVwYXJhdGlvblRpbWU7CiAgICB9CgogICAgLyoqCiAgICAgKiBAZGV2IFVwZGF0ZXMgdGhlIHJ1c2ggdGltZSBjaGFsbGVuZ2UgcmV3YXJkcyBwZXJjZW50YWdlLgogICAgICovCiAgICBmdW5jdGlvbiBzZXRSdXNoVGltZUNoYWxsZW5nZVJld2FyZHNQZXJjZW50KHVpbnQgX25ld1J1c2hUaW1lQ2hhbGxlbmdlUmV3YXJkc1BlcmNlbnQpIG9ubHlPd25lciBleHRlcm5hbCB7CiAgICAgICAgcnVzaFRpbWVDaGFsbGVuZ2VSZXdhcmRzUGVyY2VudCA9IF9uZXdSdXNoVGltZUNoYWxsZW5nZVJld2FyZHNQZXJjZW50OwogICAgfQoKICAgIC8qKgogICAgICogQGRldiBVcGRhdGVzIHRoZSBydXNoIHRpbWUgZmxvb3IgY291bnQuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHNldFJ1c2hUaW1lRmxvb3JDb3VudCh1aW50IF9uZXdSdXNoVGltZUZsb29yQ291bnQpIG9ubHlPd25lciBleHRlcm5hbCB7CiAgICAgICAgcnVzaFRpbWVGbG9vckNvdW50ID0gX25ld1J1c2hUaW1lRmxvb3JDb3VudDsKICAgIH0KCgogICAgLyogPT09PT09PT0gTU9ESUZJRVJTID09PT09PT09ICovCgogICAgLyoqCiAgICAgKiBAZGV2IFRocm93cyBpZiBkdW5nZW9uIHN0YXR1cyBkbyBub3QgYWxsb3cgY2hhbGxlbmdlLCBhbHNvIGNoZWNrIGZvciBkdW5nZW9uIGV4aXN0ZW5jZS4KICAgICAqICBBbHNvIGNoZWNrIGlmIHRoZSB1c2VyIGlzIGluIHRoZSBkdW5nZW9uLgogICAgICogIEFsc28gY2hlY2sgaWYgdGhlIGR1bmdlb24gaXMgbm90IGluIHByZXBhcmF0aW9uIHBlcmlvZC4KICAgICAqLwogICAgbW9kaWZpZXIgZHVuZ2VvbkNhbkNoYWxsZW5nZSh1aW50IF9kdW5nZW9uSWQpIHsKICAgICAgICByZXF1aXJlKF9kdW5nZW9uSWQgPCBkdW5nZW9uVG9rZW5Db250cmFjdC50b3RhbFN1cHBseSgpKTsKICAgICAgICB1aW50IGNyZWF0aW9uVGltZTsKICAgICAgICB1aW50IHN0YXR1czsKICAgICAgICAoY3JlYXRpb25UaW1lLCBzdGF0dXMsLCwsLCwsKSA9IGR1bmdlb25Ub2tlbkNvbnRyYWN0LmR1bmdlb25zKF9kdW5nZW9uSWQpOwogICAgICAgIHJlcXVpcmUoc3RhdHVzID09IDAgfHwgc3RhdHVzID09IDIpOwoKICAgICAgICAvLyBDaGVjayBpZiB0aGUgdXNlciBpcyBpbiB0aGUgZHVuZ2Vvbi4KICAgICAgICByZXF1aXJlKHBsYXllclRvRHVuZ2VvbklEW21zZy5zZW5kZXJdID09IF9kdW5nZW9uSWQpOwoKICAgICAgICAvLyBDaGVjayBpZiB0aGUgZHVuZ2VvbiBpcyBub3QgaW4gcHJlcGFyYXRpb24gcGVyaW9kLgogICAgICAgIHJlcXVpcmUoY3JlYXRpb25UaW1lICsgZHVuZ2VvblByZXBhcmF0aW9uVGltZSA8PSBub3cpOwogICAgICAgIF87CiAgICB9CgogICAgLyoqCiAgICAgKiBAZGV2IFRocm93cyBpZiBwbGF5ZXIgZG9lcyBub3Qgb3duIHRoZSBoZXJvLCBvciBpdCBpcyBzdGlsbCBpbiBjb29sZG93bi4KICAgICAqICBVbmxlc3MgdGhlIHBsYXllciBkb2VzIG5vdCBoYXZlIGFueSBoZXJvIHlldCwgd2hpY2ggd2lsbCBhdXRvIGNsYWltIG9uZSBkdXJpbmcgZmlyc3QgY2hhbGxlbmdlIC8gdHJhaW4uCiAgICAgKi8KICAgIG1vZGlmaWVyIGhlcm9BbGxvd2VkVG9DaGFsbGVuZ2UodWludCBfaGVyb0lkKSB7CiAgICAgICAgaWYgKGhlcm9Ub2tlbkNvbnRyYWN0LmJhbGFuY2VPZihtc2cuc2VuZGVyKSA+IDApIHsKICAgICAgICAgICAgLy8gWW91IGNhbiBvbmx5IGNoYWxsZW5nZSB3aXRoIHlvdXIgb3duIGhlcm8uCiAgICAgICAgICAgIHJlcXVpcmUoaGVyb1Rva2VuQ29udHJhY3Qub3duZXJPZihfaGVyb0lkKSA9PSBtc2cuc2VuZGVyKTsKCiAgICAgICAgICAgIHVpbnQgY29vbGRvd25TdGFydFRpbWU7CiAgICAgICAgICAgICgsIGNvb2xkb3duU3RhcnRUaW1lLCwpID0gaGVyb1Rva2VuQ29udHJhY3QuaGVyb2VzKF9oZXJvSWQpOwogICAgICAgICAgICByZXF1aXJlKGNvb2xkb3duU3RhcnRUaW1lICsgY2hhbGxlbmdlQ29vbGRvd25UaW1lIDw9IG5vdyk7CiAgICAgICAgfQogICAgICAgIF87CiAgICB9Cgp9Cgpjb250cmFjdCBEdW5nZW9uVHJhaW5pbmcgaXMgRHVuZ2VvbkNoYWxsZW5nZSB7CgogICAgLyoqCiAgICAgKiBAZGV2IFRoZSBIZXJvVHJhaW5lZCBldmVudCBpcyBmaXJlZCB3aGVuIHVzZXIgZmluaXNoZWQgYSB0cmFpbmluZy4KICAgICAqLwogICAgZXZlbnQgSGVyb1RyYWluZWQodWludCB0aW1lc3RhbXAsIGFkZHJlc3MgaW5kZXhlZCBwbGF5ZXJBZGRyZXNzLCB1aW50IGluZGV4ZWQgZHVuZ2VvbklkLCB1aW50IGluZGV4ZWQgaGVyb0lkLCB1aW50IGhlcm9HZW5lcywgdWludCBmbG9vck51bWJlciwgdWludCBmbG9vckdlbmVzLCBib29sIHN1Y2Nlc3MsIHVpbnQgbmV3SGVyb0dlbmVzKTsKCgogICAgLyogPT09PT09PT0gR0FNRSBTRVRUSU5HUyA9PT09PT09PSAqLwoKICAgIC8qKgogICAgICogQGRldiBUaGUgYWN0dWFsIGZlZSBjb250cmlidXRpb24gcmVxdWlyZWQgdG8gY2FsbCB0cmFpblgoKSBpcyBjYWxjdWxhdGVkIGJ5IHRoaXMgZmVlTXVsdGlwbGllciwKICAgICAqICB0aW1lcyB0aGUgZHVuZ2VvbiBkaWZmaWN1bHR5LCB0aW1lcyBYLiBUaGUgcGF5bWVudCBpcyBhY2N1bXVsYXRlZCB0byB0aGUgZHVuZ2VvbiByZXdhcmRzLAogICAgICogIGFuZCBhIGxhcmdlIHByb3BvcnRpb24gd2lsbCBiZSBjbGFpbWVkIGJ5IHdob2V2ZXIgc3VjY2Vzc2Z1bGx5IGNoYWxsZW5nZWQgdGhlIGZsb29yLgogICAgICogIDEgZmlubmV5ID0gMC4wMDEgZXRoZXIKICAgICAqLwogICAgdWludCBwdWJsaWMgdHJhaW5pbmdGZWVNdWx0aXBsaWVyID0gMiBmaW5uZXk7CgogICAgLyoqCiAgICAgKiBAZGV2IFRoZSBkaXNjb3VudGVkIHRyYWluaW5nIGZlZSBtdWx0aXBsaWVyIHRvIGJlIHVzZWQgaW4gdGhlIHByZXBhcmF0aW9uIHBlcmlvZC4KICAgICAqIDEwMDAgc3phYm8gPSAwLjAwMSBldGhlcgogICAgICovCiAgICB1aW50IHB1YmxpYyBwcmVwYXJhdGlvblBlcmlvZFRyYWluaW5nRmVlTXVsdGlwbGllciA9IDE4MDAgc3phYm87CgogICAgLyoqCiAgICAgKiBAZGV2IFRoZSBhY3R1YWwgZmVlIGNvbnRyaWJ1dGlvbiByZXF1aXJlZCB0byBjYWxsIHRyYWluRXF1aXBtZW50KCkgaXMgY2FsY3VsYXRlZCBieSB0aGlzIGZlZU11bHRpcGxpZXIsCiAgICAgKiAgdGltZXMgdGhlIGR1bmdlb24gZGlmZmljdWx0eSwgdGltZXMgWC4gVGhlIHBheW1lbnQgaXMgYWNjdW11bGF0ZWQgdG8gdGhlIGR1bmdlb24gcmV3YXJkcywKICAgICAqICBhbmQgYSBsYXJnZSBwcm9wb3J0aW9uIHdpbGwgYmUgY2xhaW1lZCBieSB3aG9ldmVyIHN1Y2Nlc3NmdWxseSBjaGFsbGVuZ2VkIHRoZSBmbG9vci4KICAgICAqICAoTm8gcHJlcGFyYXRpb24gcGVyaW9kIGRpc2NvdW50IG9uIGVxdWlwbWVudCB0cmFpbmluZy4pCiAgICAgKiAgMTAwMCBzemFibyA9IDAuMDAxIGV0aGVyCiAgICAgKi8KICAgIHVpbnQgcHVibGljIGVxdWlwbWVudFRyYWluaW5nRmVlTXVsdGlwbGllciA9IDUwMCBzemFibzsKCiAgICAvKioKICAgICAqIEBkZXYgVGhlIGV4dGVybmFsIGZ1bmN0aW9uIHRvIGNhbGwgd2hlbiBhIGhlcm8gdHJhaW4gd2l0aCBhIGR1bmdlb24sCiAgICAgKiAgaXQgZGV0ZXJtaW5lcyB3aGV0aGVyIHdoZXRoZXIgYSB0cmFpbmluZyBpcyBzdWNjZXNzZnVsbHksIGFuZCB0aGUgcmVzdWx0aW5nIGdlbmVzLgogICAgICogIFdpbGwgZ2VuZXJhdGUgYSBEdW5nZW9uQ2hhbGxlbmdlZCBldmVudC4KICAgICAqLwogICAgZnVuY3Rpb24gdHJhaW4xKHVpbnQgX2R1bmdlb25JZCwgdWludCBfaGVyb0lkKSB3aGVuTm90UGF1c2VkIGR1bmdlb25DYW5UcmFpbihfZHVuZ2VvbklkKSBoZXJvQWxsb3dlZFRvVHJhaW4oX2hlcm9JZCkgZXh0ZXJuYWwgcGF5YWJsZSB7CiAgICAgICAgX3RyYWluKF9kdW5nZW9uSWQsIF9oZXJvSWQsIDAsIDEpOwogICAgfQoKICAgIGZ1bmN0aW9uIHRyYWluMih1aW50IF9kdW5nZW9uSWQsIHVpbnQgX2hlcm9JZCkgd2hlbk5vdFBhdXNlZCBkdW5nZW9uQ2FuVHJhaW4oX2R1bmdlb25JZCkgaGVyb0FsbG93ZWRUb1RyYWluKF9oZXJvSWQpIGV4dGVybmFsIHBheWFibGUgewogICAgICAgIF90cmFpbihfZHVuZ2VvbklkLCBfaGVyb0lkLCAwLCAyKTsKICAgIH0KCiAgICBmdW5jdGlvbiB0cmFpbjModWludCBfZHVuZ2VvbklkLCB1aW50IF9oZXJvSWQpIHdoZW5Ob3RQYXVzZWQgZHVuZ2VvbkNhblRyYWluKF9kdW5nZW9uSWQpIGhlcm9BbGxvd2VkVG9UcmFpbihfaGVyb0lkKSBleHRlcm5hbCBwYXlhYmxlIHsKICAgICAgICBfdHJhaW4oX2R1bmdlb25JZCwgX2hlcm9JZCwgMCwgMyk7CiAgICB9CgogICAgLyoqCiAgICAgKiBAZGV2IFRoZSBleHRlcm5hbCBmdW5jdGlvbiB0byBjYWxsIHdoZW4gYSBoZXJvIHRyYWluIGEgcGFydGljdWxhciBlcXVpcG1lbnQgd2l0aCBhIGR1bmdlb24sCiAgICAgKiAgaXQgZGV0ZXJtaW5lcyB3aGV0aGVyIHdoZXRoZXIgYSB0cmFpbmluZyBpcyBzdWNjZXNzZnVsbHksIGFuZCB0aGUgcmVzdWx0aW5nIGdlbmVzLgogICAgICogIFdpbGwgZ2VuZXJhdGUgYSBEdW5nZW9uQ2hhbGxlbmdlZCBldmVudC4KICAgICAqICBfZXF1aXBtZW50SW5kZXggaXMgdGhlIGluZGV4IG9mIGVxdWlwbWVudDogMCBpcyB0cmFpbiBhbGwgYXR0cmlidXRlcywgaW5jbHVkaW5nIGVxdWlwbWVudHMgYW5kIHN0YXRzLgogICAgICogIDE6IHdlYXBvbiB8IDI6IHNoaWVsZCB8IDM6IGFybW9yIHwgNDogc2hvZSB8IDU6IGhlbG1ldCB8IDY6IGdsb3ZlcyB8IDc6IGJlbHQgfCA4OiBzaGF3bAogICAgICovCiAgICBmdW5jdGlvbiB0cmFpbkVxdWlwbWVudCh1aW50IF9kdW5nZW9uSWQsIHVpbnQgX2hlcm9JZCwgdWludCBfZXF1aXBtZW50SW5kZXgpIHdoZW5Ob3RQYXVzZWQgZHVuZ2VvbkNhblRyYWluKF9kdW5nZW9uSWQpIGhlcm9BbGxvd2VkVG9UcmFpbihfaGVyb0lkKSBleHRlcm5hbCBwYXlhYmxlIHsKICAgICAgICByZXF1aXJlKF9lcXVpcG1lbnRJbmRleCA8PSA4KTsKCiAgICAgICAgX3RyYWluKF9kdW5nZW9uSWQsIF9oZXJvSWQsIF9lcXVpcG1lbnRJbmRleCwgMSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBAZGV2IEFuIGludGVybmFsIGZ1bmN0aW9uIG9mIGEgaGVybyB0cmFpbiB3aXRoIGR1bmdlb24sCiAgICAgKiAgaXQgZGV0ZXJtaW5lcyB3aGV0aGVyIHdoZXRoZXIgYSB0cmFpbmluZyBpcyBzdWNjZXNzZnVsbHksIGFuZCB0aGUgcmVzdWx0aW5nIGdlbmVzLgogICAgICogIFdpbGwgZ2VuZXJhdGUgYSBEdW5nZW9uQ2hhbGxlbmdlZCBldmVudC4KICAgICAqLwogICAgZnVuY3Rpb24gX3RyYWluKHVpbnQgX2R1bmdlb25JZCwgdWludCBfaGVyb0lkLCB1aW50IF9lcXVpcG1lbnRJbmRleCwgdWludCBfdHJhaW5pbmdUaW1lcykgcHJpdmF0ZSB7CiAgICAgICAgLy8gR2V0IHRoZSBkdW5nZW9uIGRldGFpbHMgZnJvbSB0aGUgdG9rZW4gY29udHJhY3QuCiAgICAgICAgdWludCBjcmVhdGlvblRpbWU7CiAgICAgICAgdWludCBkaWZmaWN1bHR5OwogICAgICAgIHVpbnQgZmxvb3JOdW1iZXI7CiAgICAgICAgdWludCByZXdhcmRzOwogICAgICAgIHVpbnQgc2VlZEdlbmVzOwogICAgICAgIHVpbnQgZmxvb3JHZW5lczsKICAgICAgICAoY3JlYXRpb25UaW1lLCxkaWZmaWN1bHR5LCxmbG9vck51bWJlciwscmV3YXJkcyxzZWVkR2VuZXMsZmxvb3JHZW5lcykgPSBkdW5nZW9uVG9rZW5Db250cmFjdC5kdW5nZW9ucyhfZHVuZ2VvbklkKTsKCiAgICAgICAgLy8gQ2hlY2sgZm9yIF90cmFpbmluZ1RpbWVzIGFibm9ybWFsaXR5LCB3ZSBwcm9iYWJseSB3b24ndCBoYXZlIGFueSBmZWF0dXJlIHRoYXQgdHJhaW4gYSBoZXJvIDEwIHRpbWVzIHdpdGggYSBzaW5nbGUgY2FsbC4KICAgICAgICByZXF1aXJlKF90cmFpbmluZ1RpbWVzIDwgMTApOwoKICAgICAgICAvLyBDaGVja3MgZm9yIHBheW1lbnQsIGFueSBleGNlZWRpbmcgZnVuZHMgd2lsbCBiZSB0cmFuc2ZlcnJlZCBiYWNrIHRvIHRoZSBwbGF5ZXIuCiAgICAgICAgdWludCByZXF1aXJlZEZlZTsKCiAgICAgICAgaWYgKF9lcXVpcG1lbnRJbmRleCA+IDApIHsgLy8gdHJhaW4gc3BlY2lmaWMgZXF1aXBtZW50cwogICAgICAgICAgICByZXF1aXJlZEZlZSA9IGRpZmZpY3VsdHkgKiBlcXVpcG1lbnRUcmFpbmluZ0ZlZU11bHRpcGxpZXIgKiBfdHJhaW5pbmdUaW1lczsKICAgICAgICB9IGVsc2UgaWYgKG5vdyA8IGNyZWF0aW9uVGltZSArIGR1bmdlb25QcmVwYXJhdGlvblRpbWUpIHsgLy8gdHJhaW4gYWxsIGF0dHJpYnV0ZXMsIHByZXBhcmF0aW9uIHBlcmlvZAogICAgICAgICAgICByZXF1aXJlZEZlZSA9IGRpZmZpY3VsdHkgKiBwcmVwYXJhdGlvblBlcmlvZFRyYWluaW5nRmVlTXVsdGlwbGllciAqIF90cmFpbmluZ1RpbWVzOwogICAgICAgIH0gZWxzZSB7IC8vIHRyYWluIGFsbCBhdHRyaWJ1dGVzLCBub3JtYWwgcGVyaW9kCiAgICAgICAgICAgIHJlcXVpcmVkRmVlID0gZGlmZmljdWx0eSAqIHRyYWluaW5nRmVlTXVsdGlwbGllciAqIF90cmFpbmluZ1RpbWVzOwogICAgICAgIH0KCiAgICAgICAgcmVxdWlyZShtc2cudmFsdWUgPj0gcmVxdWlyZWRGZWUpOwoKICAgICAgICAvLyBHZXQgdGhlIGhlcm8gZ2VuZSwgb3IgY2xhaW0gZmlyc3QgaGVyby4KICAgICAgICB1aW50IGhlcm9HZW5lczsKICAgICAgICAoX2hlcm9JZCwgaGVyb0dlbmVzKSA9IF9nZXRIZXJvR2VuZXNPckNsYWltRmlyc3RIZXJvKF9oZXJvSWQpOwoKICAgICAgICAvLyAqKiBTVE9SQUdFIFVQREFURSAqKgogICAgICAgIC8vIEluY3JlbWVudCB0aGUgYWNjdW11bGF0ZWQgcmV3YXJkcyBmb3IgdGhlIGR1bmdlb24uCiAgICAgICAgZHVuZ2VvblRva2VuQ29udHJhY3QuYWRkRHVuZ2VvblJld2FyZHMoX2R1bmdlb25JZCwgcmVxdWlyZWRGZWUpOwoKICAgICAgICAvLyBDYWxjdWxhdGUgYW55IGV4Y2VzcyBmdW5kcyBhbmQgbWFrZSBpdCBhdmFpbGFibGUgdG8gYmUgd2l0aGRyYXdlZCBieSB0aGUgcGxheWVyLgogICAgICAgIGFzeW5jU2VuZChtc2cuc2VuZGVyLCBtc2cudmFsdWUgLSByZXF1aXJlZEZlZSk7CgogICAgICAgIC8vIFNwbGl0IHRoZSBfdHJhaW4gZnVuY3Rpb24gaW50byBtdWx0aXBsZSBwYXJ0cyBiZWNhdXNlIG9mIHN0YWNrIHRvbyBkZWVwIGVycm9yLgogICAgICAgIF90cmFpblBhcnQyKF9kdW5nZW9uSWQsIF9oZXJvSWQsIGhlcm9HZW5lcywgX2VxdWlwbWVudEluZGV4LCBfdHJhaW5pbmdUaW1lcyk7CiAgICB9CgogICAgLyoqCiAgICAgKiBTcGxpdCB0aGUgX3RyYWluIGZ1bmN0aW9uIGludG8gbXVsdGlwbGUgcGFydHMgYmVjYXVzZSBvZiBTdGFjayBUb28gRGVlcCBlcnJvci4KICAgICAqLwogICAgZnVuY3Rpb24gX3RyYWluUGFydDIodWludCBfZHVuZ2VvbklkLCB1aW50IF9oZXJvSWQsIHVpbnQgX2hlcm9HZW5lcywgdWludCBfZXF1aXBtZW50SW5kZXgsIHVpbnQgX3RyYWluaW5nVGltZXMpIHByaXZhdGUgewogICAgICAgIC8vIEdldCB0aGUgZHVuZ2VvbiBkZXRhaWxzIGZyb20gdGhlIHRva2VuIGNvbnRyYWN0LgogICAgICAgIHVpbnQgZmxvb3JOdW1iZXI7CiAgICAgICAgdWludCBmbG9vckdlbmVzOwogICAgICAgICgsLCwsIGZsb29yTnVtYmVyLCwsLCBmbG9vckdlbmVzKSA9IGR1bmdlb25Ub2tlbkNvbnRyYWN0LmR1bmdlb25zKF9kdW5nZW9uSWQpOwoKICAgICAgICAvLyBEZXRlcm1pbmUgaWYgdGhlIGhlcm8gdHJhaW5pbmcgaXMgc3VjY2Vzc2Z1bCBvciBub3QsIGFuZCB0aGUgcmVzdWx0aW5nIGdlbmVzLgogICAgICAgIHVpbnQgaGVyb1Bvd2VyID0gX2dldEhlcm9Qb3dlcihfaGVyb0dlbmVzLCBfZHVuZ2VvbklkKTsKCiAgICAgICAgdWludCBuZXdIZXJvR2VuZXMgPSBfaGVyb0dlbmVzOwogICAgICAgIHVpbnQgbmV3SGVyb1Bvd2VyID0gaGVyb1Bvd2VyOwoKICAgICAgICAvLyBUcmFpbiB0aGUgaGVybyBtdWx0aXBsZSB0aW1lcyBhY2NvcmRpbmcgdG8gX3RyYWluaW5nVGltZXMsCiAgICAgICAgLy8gZWFjaCB0aW1lIGlmIHRoZSByZXN1bHRpbmcgcG93ZXIgaXMgbGFyZ2VyLCB1cGRhdGUgbmV3IGhlcm8gcG93ZXIuCiAgICAgICAgZm9yICh1aW50IGkgPSAwOyBpIDwgX3RyYWluaW5nVGltZXM7IGkrKykgewogICAgICAgICAgICAvLyBDYWxsIHRoZSBleHRlcm5hbCBjbG9zZWQgc291cmNlIHNlY3JldCBmdW5jdGlvbiB0aGF0IGRldGVybWluZXMgdGhlIHJlc3VsdGluZyBoZXJvICJnZW5lcyIuCiAgICAgICAgICAgIHVpbnQgdG1wSGVyb0dlbmVzID0gdHJhaW5pbmdTY2llbmNlQ29udHJhY3QubWl4R2VuZXMobmV3SGVyb0dlbmVzLCBmbG9vckdlbmVzLCBfZXF1aXBtZW50SW5kZXgpOwoKICAgICAgICAgICAgdWludCB0bXBIZXJvUG93ZXIgPSBfZ2V0SGVyb1Bvd2VyKHRtcEhlcm9HZW5lcywgX2R1bmdlb25JZCk7CgogICAgICAgICAgICBpZiAodG1wSGVyb1Bvd2VyID4gbmV3SGVyb1Bvd2VyKSB7CiAgICAgICAgICAgICAgICBuZXdIZXJvR2VuZXMgPSB0bXBIZXJvR2VuZXM7CiAgICAgICAgICAgICAgICBuZXdIZXJvUG93ZXIgPSB0bXBIZXJvUG93ZXI7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIFByZXZlbnQgcmVkdWNlZCBwb3dlci4KICAgICAgICBpZiAobmV3SGVyb1Bvd2VyID4gaGVyb1Bvd2VyKSB7CiAgICAgICAgICAgIC8vICoqIFNUT1JBR0UgVVBEQVRFICoqCiAgICAgICAgICAgIC8vIFNldCB0aGUgdXBncmFkZWQgaGVybyBnZW5lcy4KICAgICAgICAgICAgaGVyb1Rva2VuQ29udHJhY3Quc2V0SGVyb0dlbmVzKF9oZXJvSWQsIG5ld0hlcm9HZW5lcyk7CiAgICAgICAgfQoKICAgICAgICAvLyBFbWl0IHRoZSBIZXJvVHJhaW5lZCBldmVudC4KICAgICAgICBIZXJvVHJhaW5lZChub3csIG1zZy5zZW5kZXIsIF9kdW5nZW9uSWQsIF9oZXJvSWQsIF9oZXJvR2VuZXMsIGZsb29yTnVtYmVyLCBmbG9vckdlbmVzLCBuZXdIZXJvUG93ZXIgPiBoZXJvUG93ZXIsIG5ld0hlcm9HZW5lcyk7CiAgICB9CgoKICAgIC8qID09PT09PT09IFNFVFRFUiBGVU5DVElPTlMgPT09PT09PT0gKi8KCiAgICAvLy8gQGRldiBVcGRhdGVzIHRoZSBmZWUgY29udHJpYnV0aW9uIG11bHRpcGxpZXIgcmVxdWlyZWQgZm9yIGNhbGxpbmcgdHJhaW5YKCkuCiAgICBmdW5jdGlvbiBzZXRUcmFpbmluZ0ZlZU11bHRpcGxpZXIodWludCBfbmV3VHJhaW5pbmdGZWVNdWx0aXBsaWVyKSBvbmx5T3duZXIgZXh0ZXJuYWwgewogICAgICAgIHRyYWluaW5nRmVlTXVsdGlwbGllciA9IF9uZXdUcmFpbmluZ0ZlZU11bHRpcGxpZXI7CiAgICB9CgogICAgLy8vIEBkZXYgVXBkYXRlcyB0aGUgZmVlIGNvbnRyaWJ1dGlvbiBtdWx0aXBsaWVyIGZvciBwcmVwYXJhdGlvbiBwZXJpb2QgcmVxdWlyZWQgZm9yIGNhbGxpbmcgdHJhaW5YKCkuCiAgICBmdW5jdGlvbiBzZXRQcmVwYXJhdGlvblBlcmlvZFRyYWluaW5nRmVlTXVsdGlwbGllcih1aW50IF9uZXdQcmVwYXJhdGlvblBlcmlvZFRyYWluaW5nRmVlTXVsdGlwbGllcikgb25seU93bmVyIGV4dGVybmFsIHsKICAgICAgICBwcmVwYXJhdGlvblBlcmlvZFRyYWluaW5nRmVlTXVsdGlwbGllciA9IF9uZXdQcmVwYXJhdGlvblBlcmlvZFRyYWluaW5nRmVlTXVsdGlwbGllcjsKICAgIH0KCiAgICAvLy8gQGRldiBVcGRhdGVzIHRoZSBmZWUgY29udHJpYnV0aW9uIG11bHRpcGxpZXIgcmVxdWlyZWQgZm9yIGNhbGxpbmcgdHJhaW5FcXVpcG1lbnQoKS4KICAgIGZ1bmN0aW9uIHNldEVxdWlwbWVudFRyYWluaW5nRmVlTXVsdGlwbGllcih1aW50IF9uZXdFcXVpcG1lbnRUcmFpbmluZ0ZlZU11bHRpcGxpZXIpIG9ubHlPd25lciBleHRlcm5hbCB7CiAgICAgICAgZXF1aXBtZW50VHJhaW5pbmdGZWVNdWx0aXBsaWVyID0gX25ld0VxdWlwbWVudFRyYWluaW5nRmVlTXVsdGlwbGllcjsKICAgIH0KCgogICAgLyogPT09PT09PT0gTU9ESUZJRVJTID09PT09PT09ICovCgogICAgLyoqCiAgICAgKiBAZGV2IFRocm93cyBpZiBkdW5nZW9uIHN0YXR1cyBkbyBub3QgYWxsb3cgdHJhaW5pbmcsIGFsc28gY2hlY2sgZm9yIGR1bmdlb24gZXhpc3RlbmNlLgogICAgICogIEFsc28gY2hlY2sgaWYgdGhlIHVzZXIgaXMgaW4gdGhlIGR1bmdlb24uCiAgICAgKi8KICAgIG1vZGlmaWVyIGR1bmdlb25DYW5UcmFpbih1aW50IF9kdW5nZW9uSWQpIHsKICAgICAgICByZXF1aXJlKF9kdW5nZW9uSWQgPCBkdW5nZW9uVG9rZW5Db250cmFjdC50b3RhbFN1cHBseSgpKTsKICAgICAgICB1aW50IHN0YXR1czsKICAgICAgICAoLHN0YXR1cywsLCwsLCwpID0gZHVuZ2VvblRva2VuQ29udHJhY3QuZHVuZ2VvbnMoX2R1bmdlb25JZCk7CiAgICAgICAgcmVxdWlyZShzdGF0dXMgPT0gMCB8fCBzdGF0dXMgPT0gMyk7CgogICAgICAgIC8vIEFsc28gY2hlY2sgaWYgdGhlIHVzZXIgaXMgaW4gdGhlIGR1bmdlb24uCiAgICAgICAgcmVxdWlyZShwbGF5ZXJUb0R1bmdlb25JRFttc2cuc2VuZGVyXSA9PSBfZHVuZ2VvbklkKTsKICAgICAgICBfOwogICAgfQoKICAgIC8qKgogICAgICogQGRldiBUaHJvd3MgaWYgcGxheWVyIGRvZXMgbm90IG93biB0aGUgaGVyby4KICAgICAqICBVbmxlc3MgdGhlIHBsYXllciBkb2VzIG5vdCBoYXZlIGFueSBoZXJvIHlldCwgd2hpY2ggd2lsbCBhdXRvIGNsYWltIG9uZSBkdXJpbmcgZmlyc3QgY2hhbGxlbmdlIC8gdHJhaW4uCiAgICAgKi8KICAgIG1vZGlmaWVyIGhlcm9BbGxvd2VkVG9UcmFpbih1aW50IF9oZXJvSWQpIHsKICAgICAgICBpZiAoaGVyb1Rva2VuQ29udHJhY3QuYmFsYW5jZU9mKG1zZy5zZW5kZXIpID4gMCkgewogICAgICAgICAgICAvLyBZb3UgY2FuIG9ubHkgdHJhaW4gd2l0aCB5b3VyIG93biBoZXJvLgogICAgICAgICAgICByZXF1aXJlKGhlcm9Ub2tlbkNvbnRyYWN0Lm93bmVyT2YoX2hlcm9JZCkgPT0gbXNnLnNlbmRlcik7CiAgICAgICAgfQogICAgICAgIF87CiAgICB9CgoKfQoKLyoqCiAqIEB0aXRsZSBEdW5nZW9uQ29yZUJldGEKICogQGRldiBDb3JlIENvbnRyYWN0IG9mIEV0aGVyIER1bmdlb24uCiAqICBXaGVuIFZlcnNpb24gMSBsYXVuY2hlcywgRHVuZ2VvbkNvcmVWZXJzaW9uMSBjb250cmFjdCB3aWxsIGJlIGRlcGxveWVkIGFuZCBEdW5nZW9uQ29yZUJldGEgd2lsbCBiZSBkZXN0cm95ZWQuCiAqICBTaW5jZSBhbGwgZHVuZ2VvbnMgYW5kIGhlcm9lcyBhcmUgc3RvcmVkIGFzIHRva2VucyBpbiBleHRlcm5hbCBjb250cmFjdHMsIHRoZXkgcmVtYWlucyBpbW11dGFibGUuCiAqLwpjb250cmFjdCBEdW5nZW9uQ29yZUJldGEgaXMgRGVzdHJ1Y3RpYmxlLCBEdW5nZW9uVHJhaW5pbmcgewoKICAgIC8qKgogICAgICogSW5pdGlhbGl6ZSB0aGUgRHVuZ2VvbkNvcmUgY29udHJhY3Qgd2l0aCBhbGwgdGhlIHJlcXVpcmVkIGNvbnRyYWN0IGFkZHJlc3Nlcy4KICAgICAqLwogICAgZnVuY3Rpb24gRHVuZ2VvbkNvcmVCZXRhKAogICAgICAgIGFkZHJlc3MgX2R1bmdlb25Ub2tlbkFkZHJlc3MsCiAgICAgICAgYWRkcmVzcyBfaGVyb1Rva2VuQWRkcmVzcywKICAgICAgICBhZGRyZXNzIF9jaGFsbGVuZ2VTY2llbmNlQWRkcmVzcywKICAgICAgICBhZGRyZXNzIF90cmFpbmluZ1NjaWVuY2VBZGRyZXNzCiAgICApIHB1YmxpYyB7CiAgICAgICAgZHVuZ2VvblRva2VuQ29udHJhY3QgPSBEdW5nZW9uVG9rZW4oX2R1bmdlb25Ub2tlbkFkZHJlc3MpOwogICAgICAgIGhlcm9Ub2tlbkNvbnRyYWN0ID0gSGVyb1Rva2VuKF9oZXJvVG9rZW5BZGRyZXNzKTsKICAgICAgICBjaGFsbGVuZ2VTY2llbmNlQ29udHJhY3QgPSBDaGFsbGVuZ2VTY2llbmNlSW50ZXJmYWNlKF9jaGFsbGVuZ2VTY2llbmNlQWRkcmVzcyk7CiAgICAgICAgdHJhaW5pbmdTY2llbmNlQ29udHJhY3QgPSBUcmFpbmluZ1NjaWVuY2VJbnRlcmZhY2UoX3RyYWluaW5nU2NpZW5jZUFkZHJlc3MpOwogICAgfQoKICAgIC8qKgogICAgICogQGRldiBUaGUgZXh0ZXJuYWwgZnVuY3Rpb24gdG8gZ2V0IGFsbCB0aGUgcmVsZXZhbnQgaW5mb3JtYXRpb24gYWJvdXQgYSBzcGVjaWZpYyBkdW5nZW9uIGJ5IGl0cyBJRC4KICAgICAqIEBwYXJhbSBfaWQgVGhlIElEIG9mIHRoZSBkdW5nZW9uLgogICAgICovCiAgICBmdW5jdGlvbiBnZXREdW5nZW9uRGV0YWlscyh1aW50IF9pZCkgZXh0ZXJuYWwgdmlldyByZXR1cm5zICh1aW50IGNyZWF0aW9uVGltZSwgdWludCBzdGF0dXMsIHVpbnQgZGlmZmljdWx0eSwgdWludCBjYXBhY2l0eSwgYm9vbCBpc1JlYWR5LCB1aW50IHBsYXllckNvdW50KSB7CiAgICAgICAgcmVxdWlyZShfaWQgPCBkdW5nZW9uVG9rZW5Db250cmFjdC50b3RhbFN1cHBseSgpKTsKCiAgICAgICAgLy8gRGlkbid0IGdldCB0aGUgImZsb29yQ3JlYXRpb25UaW1lIiBiZWNhdXNlIG9mIFN0YWNrIFRvbyBEZWVwIGVycm9yLgogICAgICAgIChjcmVhdGlvblRpbWUsIHN0YXR1cywgZGlmZmljdWx0eSwgY2FwYWNpdHksLCwsLCkgPSBkdW5nZW9uVG9rZW5Db250cmFjdC5kdW5nZW9ucyhfaWQpOwoKICAgICAgICAvLyBEdW5nZW9uIGlzIHJlYWR5IHRvIGJlIGNoYWxsZW5nZWQgKG5vdCBpbiBwcmVwYXJhdGlvbiBtb2RlKS4KICAgICAgICBpc1JlYWR5ID0gY3JlYXRpb25UaW1lICsgZHVuZ2VvblByZXBhcmF0aW9uVGltZSA8PSBub3c7CiAgICAgICAgcGxheWVyQ291bnQgPSBkdW5nZW9uUGxheWVyQ291bnRbX2lkXTsKICAgIH0KCiAgICAvKioKICAgICAqIEBkZXYgU3BsaXQgZmxvb3IgcmVsYXRlZCBkZXRhaWxzIG91dCBvZiBnZXREdW5nZW9uRGV0YWlscywganVzdCB0byBhdm9pZCBTdGFjayBUb28gRGVlcCBlcnJvci4KICAgICAqIEBwYXJhbSBfaWQgVGhlIElEIG9mIHRoZSBkdW5nZW9uLgogICAgICovCiAgICBmdW5jdGlvbiBnZXREdW5nZW9uRmxvb3JEZXRhaWxzKHVpbnQgX2lkKSBleHRlcm5hbCB2aWV3IHJldHVybnMgKHVpbnQgZmxvb3JOdW1iZXIsIHVpbnQgZmxvb3JDcmVhdGlvblRpbWUsIHVpbnQgcmV3YXJkcywgdWludCBzZWVkR2VuZXMsIHVpbnQgZmxvb3JHZW5lcykgewogICAgICAgIHJlcXVpcmUoX2lkIDwgZHVuZ2VvblRva2VuQ29udHJhY3QudG90YWxTdXBwbHkoKSk7CgogICAgICAgIC8vIERpZG4ndCBnZXQgdGhlICJmbG9vckNyZWF0aW9uVGltZSIgYmVjYXVzZSBvZiBTdGFjayBUb28gRGVlcCBlcnJvci4KICAgICAgICAoLCwsLCBmbG9vck51bWJlciwgZmxvb3JDcmVhdGlvblRpbWUsIHJld2FyZHMsIHNlZWRHZW5lcywgZmxvb3JHZW5lcykgPSBkdW5nZW9uVG9rZW5Db250cmFjdC5kdW5nZW9ucyhfaWQpOwogICAgfQoKICAgIC8qKgogICAgICogQGRldiBUaGUgZXh0ZXJuYWwgZnVuY3Rpb24gdG8gZ2V0IGFsbCB0aGUgcmVsZXZhbnQgaW5mb3JtYXRpb24gYWJvdXQgYSBzcGVjaWZpYyBoZXJvIGJ5IGl0cyBJRC4KICAgICAqIEBwYXJhbSBfaWQgVGhlIElEIG9mIHRoZSBoZXJvLgogICAgICovCiAgICBmdW5jdGlvbiBnZXRIZXJvRGV0YWlscyh1aW50IF9pZCkgZXh0ZXJuYWwgdmlldyByZXR1cm5zICh1aW50IGNyZWF0aW9uVGltZSwgdWludCBjb29sZG93blN0YXJ0VGltZSwgdWludCBjb29sZG93bkluZGV4LCB1aW50IGdlbmVzLCBib29sIGlzUmVhZHkpIHsKICAgICAgICByZXF1aXJlKF9pZCA8IGhlcm9Ub2tlbkNvbnRyYWN0LnRvdGFsU3VwcGx5KCkpOwoKICAgICAgICAoY3JlYXRpb25UaW1lLCBjb29sZG93blN0YXJ0VGltZSwgY29vbGRvd25JbmRleCwgZ2VuZXMpID0gaGVyb1Rva2VuQ29udHJhY3QuaGVyb2VzKF9pZCk7CgogICAgICAgIC8vIEhlcm8gaXMgcmVhZHkgdG8gY2hhbGxlbmdlIChub3QgaW4gY29vbGRvd24gbW9kZSkuCiAgICAgICAgaXNSZWFkeSA9IGNvb2xkb3duU3RhcnRUaW1lICsgY2hhbGxlbmdlQ29vbGRvd25UaW1lIDw9IG5vdzsKICAgIH0KCiAgICAvKioKICAgICAqIEBkZXYgVGhlIGV4dGVybmFsIGZ1bmN0aW9uIHRvIGdldCBhbGwgdGhlIHJlbGV2YW50IGluZm9ybWF0aW9uIGFib3V0IGEgc3BlY2lmaWMgcGxheWVyIGJ5IGl0cyBhZGRyZXNzLgogICAgICogQHBhcmFtIF9hZGRyZXNzIFRoZSBhZGRyZXNzIG9mIHRoZSBwbGF5ZXIuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGdldFBsYXllckRldGFpbHMoYWRkcmVzcyBfYWRkcmVzcykgZXh0ZXJuYWwgdmlldyByZXR1cm5zICh1aW50IGR1bmdlb25JZCwgdWludCBwYXltZW50KSB7CiAgICAgICAgZHVuZ2VvbklkID0gcGxheWVyVG9EdW5nZW9uSURbX2FkZHJlc3NdOwogICAgICAgIHBheW1lbnQgPSBwYXltZW50c1tfYWRkcmVzc107CiAgICB9Cgp9'.
	

]
