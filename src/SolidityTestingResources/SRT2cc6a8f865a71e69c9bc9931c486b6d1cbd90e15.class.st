Class {
	#name : #SRT2cc6a8f865a71e69c9bc9931c486b6d1cbd90e15,
	#superclass : #SRTContracts,
	#category : #SolidityTestingResources
}

{ #category : #base64 }
SRT2cc6a8f865a71e69c9bc9931c486b6d1cbd90e15 >> base64 [
	^ 'cHJhZ21hIHNvbGlkaXR5IF4wLjQuMTE7CgovLyBOQjogdGhpcyBpcyB0aGUgbmV3ZXIgRVJDMjAgcmV0dXJuaW5nIGJvb2wsIG5lZWQgZGlmZmVyZW50IGJvb2sgY29udHJhY3QgZm9yIG9sZGVyIHN0eWxlIHRva2Vucwpjb250cmFjdCBFUkMyMCB7CiAgZnVuY3Rpb24gdG90YWxTdXBwbHkoKSBjb25zdGFudCByZXR1cm5zICh1aW50KTsKICBmdW5jdGlvbiBiYWxhbmNlT2YoYWRkcmVzcyBfb3duZXIpIGNvbnN0YW50IHJldHVybnMgKHVpbnQgYmFsYW5jZSk7CiAgZnVuY3Rpb24gdHJhbnNmZXIoYWRkcmVzcyBfdG8sIHVpbnQgX3ZhbHVlKSByZXR1cm5zIChib29sIHN1Y2Nlc3MpOwogIGZ1bmN0aW9uIHRyYW5zZmVyRnJvbShhZGRyZXNzIF9mcm9tLCBhZGRyZXNzIF90bywgdWludCBfdmFsdWUpIHJldHVybnMgKGJvb2wgc3VjY2Vzcyk7CiAgZnVuY3Rpb24gYXBwcm92ZShhZGRyZXNzIF9zcGVuZGVyLCB1aW50IF92YWx1ZSkgcmV0dXJucyAoYm9vbCBzdWNjZXNzKTsKICBmdW5jdGlvbiBhbGxvd2FuY2UoYWRkcmVzcyBfb3duZXIsIGFkZHJlc3MgX3NwZW5kZXIpIGNvbnN0YW50IHJldHVybnMgKHVpbnQgcmVtYWluaW5nKTsKICBldmVudCBUcmFuc2ZlcihhZGRyZXNzIGluZGV4ZWQgX2Zyb20sIGFkZHJlc3MgaW5kZXhlZCBfdG8sIHVpbnQgX3ZhbHVlKTsKICBldmVudCBBcHByb3ZhbChhZGRyZXNzIGluZGV4ZWQgX293bmVyLCBhZGRyZXNzIGluZGV4ZWQgX3NwZW5kZXIsIHVpbnQgX3ZhbHVlKTsKfQoKLy8gVWJpVG9rLmlvIG9uLWNoYWluIGNvbnRpbnVvdXMgbGltaXQgb3JkZXIgYm9vayBtYXRjaGluZyBlbmdpbmUuCi8vIFRoaXMgdmFyaWF0aW9uIGlzIGZvciBhICJuaWNlIiBFUkMyMCB0b2tlbiBhcyBiYXNlLCBFVEggYXMgcXVvdGVkLCBhbmQgc3RhbmRhcmQgZmVlcyB3aXRoIHJld2FyZCB0b2tlbi4KLy8gQ29weXJpZ2h0IChjKSBCb25uYWcgTGltaXRlZC4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KLy8gVmVyc2lvbiAxLjAuMC4KLy8gVGhpcyBjb250cmFjdCBhbGxvd3MgbWluUHJpY2VFeHBvbmVudCwgYmFzZU1pbkluaXRpYWxTaXplLCBhbmQgYmFzZU1pblJlbWFpbmluZ1NpemUKLy8gdG8gYmUgc2V0IGF0IGluaXQoKSB0aW1lIGFwcHJvcHJpYXRlbHkgZm9yIHRoZSB0b2tlbiBkZWNpbWFscyBhbmQgbGlrZWx5IHZhbHVlLgovLwpjb250cmFjdCBCb29rRVJDMjBFdGhWMURlYyB7CgogIGVudW0gQm9va1R5cGUgewogICAgRVJDMjBFdGhWMQogIH0KCiAgZW51bSBEaXJlY3Rpb24gewogICAgSW52YWxpZCwKICAgIEJ1eSwKICAgIFNlbGwKICB9CgogIGVudW0gU3RhdHVzIHsKICAgIFVua25vd24sCiAgICBSZWplY3RlZCwKICAgIE9wZW4sCiAgICBEb25lLAogICAgTmVlZHNHYXMsCiAgICBTZW5kaW5nLCAvLyBub3QgdXNlZCBieSBjb250cmFjdCAtIHdlYiBvbmx5CiAgICBGYWlsZWRTZW5kLCAvLyBub3QgdXNlZCBieSBjb250cmFjdCAtIHdlYiBvbmx5CiAgICBGYWlsZWRUeG4gLy8gbm90IHVzZWQgYnkgY29udHJhY3QgLSB3ZWIgb25seQogIH0KCiAgZW51bSBSZWFzb25Db2RlIHsKICAgIE5vbmUsCiAgICBJbnZhbGlkUHJpY2UsCiAgICBJbnZhbGlkU2l6ZSwKICAgIEludmFsaWRUZXJtcywKICAgIEluc3VmZmljaWVudEZ1bmRzLAogICAgV291bGRUYWtlLAogICAgVW5tYXRjaGVkLAogICAgVG9vTWFueU1hdGNoZXMsCiAgICBDbGllbnRDYW5jZWwKICB9CgogIGVudW0gVGVybXMgewogICAgR1RDTm9HYXNUb3B1cCwKICAgIEdUQ1dpdGhHYXNUb3B1cCwKICAgIEltbWVkaWF0ZU9yQ2FuY2VsLAogICAgTWFrZXJPbmx5CiAgfQoKICBzdHJ1Y3QgT3JkZXIgewogICAgLy8gdGhlc2UgYXJlIGltbXV0YWJsZSBvbmNlIHBsYWNlZDoKCiAgICBhZGRyZXNzIGNsaWVudDsKICAgIHVpbnQxNiBwcmljZTsgICAgICAgICAgICAgIC8vIHBhY2tlZCByZXByZXNlbnRhdGlvbiBvZiBzaWRlICsgcHJpY2UKICAgIHVpbnQgc2l6ZUJhc2U7CiAgICBUZXJtcyB0ZXJtczsKCiAgICAvLyB0aGVzZSBhcmUgbXV0YWJsZSB1bnRpbCBEb25lIG9yIFJlamVjdGVkOgogICAgCiAgICBTdGF0dXMgc3RhdHVzOwogICAgUmVhc29uQ29kZSByZWFzb25Db2RlOwogICAgdWludDEyOCBleGVjdXRlZEJhc2U7ICAgICAgLy8gZ3Jvc3MgYW1vdW50IGV4ZWN1dGVkIGluIGJhc2UgY3VycmVuY3kgKGJlZm9yZSBmZWUgZGVkdWN0aW9uKQogICAgdWludDEyOCBleGVjdXRlZENudHI7ICAgICAgLy8gZ3Jvc3MgYW1vdW50IGV4ZWN1dGVkIGluIGNvdW50ZXIgY3VycmVuY3kgKGJlZm9yZSBmZWUgZGVkdWN0aW9uKQogICAgdWludDEyOCBmZWVzQmFzZU9yQ250cjsgICAgLy8gYmFzZSBmb3IgYnV5LCBjbnRyIGZvciBzZWxsCiAgICB1aW50MTI4IGZlZXNSd3JkOwogIH0KICAKICBzdHJ1Y3QgT3JkZXJDaGFpbiB7CiAgICB1aW50MTI4IGZpcnN0T3JkZXJJZDsKICAgIHVpbnQxMjggbGFzdE9yZGVySWQ7CiAgfQoKICBzdHJ1Y3QgT3JkZXJDaGFpbk5vZGUgewogICAgdWludDEyOCBuZXh0T3JkZXJJZDsKICAgIHVpbnQxMjggcHJldk9yZGVySWQ7CiAgfQogIAogIC8vIEl0IHNob3VsZCBiZSBwb3NzaWJsZSB0byByZWNvbnN0cnVjdCB0aGUgZXhwZWN0ZWQgc3RhdGUgb2YgdGhlIGNvbnRyYWN0IGdpdmVuOgogIC8vICAtIENsaWVudFBheW1lbnRFdmVudCBsb2cgaGlzdG9yeQogIC8vICAtIENsaWVudE9yZGVyRXZlbnQgbG9nIGhpc3RvcnkKICAvLyAgLSBDYWxsaW5nIGdldE9yZGVyIGZvciB0aGUgb3RoZXIgaW1tdXRhYmxlIG9yZGVyIGZpZWxkcyBvZiBvcmRlcnMgcmVmZXJlbmNlZCBieSBDbGllbnRPcmRlckV2ZW50CiAgCiAgZW51bSBDbGllbnRQYXltZW50RXZlbnRUeXBlIHsKICAgIERlcG9zaXQsCiAgICBXaXRoZHJhdywKICAgIFRyYW5zZmVyRnJvbSwKICAgIFRyYW5zZmVyCiAgfQoKICBlbnVtIEJhbGFuY2VUeXBlIHsKICAgIEJhc2UsCiAgICBDbnRyLAogICAgUndyZAogIH0KCiAgZXZlbnQgQ2xpZW50UGF5bWVudEV2ZW50KAogICAgYWRkcmVzcyBpbmRleGVkIGNsaWVudCwKICAgIENsaWVudFBheW1lbnRFdmVudFR5cGUgY2xpZW50UGF5bWVudEV2ZW50VHlwZSwKICAgIEJhbGFuY2VUeXBlIGJhbGFuY2VUeXBlLAogICAgaW50IGNsaWVudEJhbGFuY2VEZWx0YQogICk7CgogIGVudW0gQ2xpZW50T3JkZXJFdmVudFR5cGUgewogICAgQ3JlYXRlLAogICAgQ29udGludWUsCiAgICBDYW5jZWwKICB9CgogIGV2ZW50IENsaWVudE9yZGVyRXZlbnQoCiAgICBhZGRyZXNzIGluZGV4ZWQgY2xpZW50LAogICAgQ2xpZW50T3JkZXJFdmVudFR5cGUgY2xpZW50T3JkZXJFdmVudFR5cGUsCiAgICB1aW50MTI4IG9yZGVySWQsCiAgICB1aW50IG1heE1hdGNoZXMKICApOwoKICBlbnVtIE1hcmtldE9yZGVyRXZlbnRUeXBlIHsKICAgIC8vIG9yZGVyQ291bnQrKywgZGVwdGggKz0gZGVwdGhCYXNlCiAgICBBZGQsCiAgICAvLyBvcmRlckNvdW50LS0sIGRlcHRoIC09IGRlcHRoQmFzZQogICAgUmVtb3ZlLAogICAgLy8gb3JkZXJDb3VudC0tLCBkZXB0aCAtPSBkZXB0aEJhc2UsIHRyYWRlZCArPSB0cmFkZUJhc2UKICAgIC8vIChkZXB0aCBjaGFuZ2UgYW5kIHRyYWRlZCBjaGFuZ2UgZGlmZmVyIHdoZW4gdGlueSByZW1haW5pbmcgYW1vdW50IHJlZnVuZGVkKQogICAgQ29tcGxldGVGaWxsLAogICAgLy8gb3JkZXJDb3VudCB1bmNoYW5nZWQsIGRlcHRoIC09IGRlcHRoQmFzZSwgdHJhZGVkICs9IHRyYWRlQmFzZQogICAgUGFydGlhbEZpbGwKICB9CgogIC8vIFRlY2huaWNhbGx5IG5vdCBuZWVkZWQgYnV0IHRoZXNlIGV2ZW50cyBjYW4gYmUgdXNlZCB0byBtYWludGFpbiBhbiBvcmRlciBib29rIG9yCiAgLy8gd2F0Y2ggZm9yIGZpbGxzLiBOb3RlIHRoYXQgdGhlIG9yZGVySWQgYW5kIHByaWNlIGFyZSB0aG9zZSBvZiB0aGUgbWFrZXIuCgogIGV2ZW50IE1hcmtldE9yZGVyRXZlbnQoCiAgICB1aW50MjU2IGluZGV4ZWQgZXZlbnRUaW1lc3RhbXAsCiAgICB1aW50MTI4IGluZGV4ZWQgb3JkZXJJZCwKICAgIE1hcmtldE9yZGVyRXZlbnRUeXBlIG1hcmtldE9yZGVyRXZlbnRUeXBlLAogICAgdWludDE2IHByaWNlLAogICAgdWludCBkZXB0aEJhc2UsCiAgICB1aW50IHRyYWRlQmFzZQogICk7CgogIC8vIHRoZSBiYXNlIHRva2VuIChlLmcuIFRFU1QpCiAgCiAgRVJDMjAgYmFzZVRva2VuOwoKICAvLyBtaW5pbXVtIG9yZGVyIHNpemUgKGluY2x1c2l2ZSkKICB1aW50IGJhc2VNaW5Jbml0aWFsU2l6ZTsgLy8gc2V0IGF0IGluaXQKCiAgLy8gaWYgZm9sbG93aW5nIHBhcnRpYWwgbWF0Y2gsIHRoZSByZW1hbmluZyBnZXRzIHNtYWxsZXIgdGhhbiB0aGlzLCByZW1vdmUgZnJvbSBib29rIGFuZCByZWZ1bmQ6CiAgLy8gZ2VuZXJhbGx5IHdlIG1ha2UgdGhpcyAxMCUgb2YgYmFzZU1pbkluaXRpYWxTaXplCiAgdWludCBiYXNlTWluUmVtYWluaW5nU2l6ZTsgLy8gc2V0IGF0IGluaXQKCiAgLy8gbWF4aW11bSBvcmRlciBzaXplIChleGNsdXNpdmUpCiAgLy8gY2hvc2VuIHNvIHRoYXQgZXZlbiBtdWx0aXBsaWVkIGJ5IHRoZSBtYXggcHJpY2UgKG9yIGRpdmlkZWQgYnkgdGhlIG1pbiBwcmljZSksCiAgLy8gYW5kIHRoZW4gbXVsdGlwbGllZCBieSBldGhSd3JkUmF0ZSwgaXQgc3RpbGwgZml0cyBpbiAyXjEyNywgYWxsb3dpbmcgdXMgdG8gc2F2ZQogIC8vIHNvbWUgZ2FzIGJ5IHN0b3JpbmcgZXhlY3V0ZWQgKyBmZWUgZmllbGRzIGFzIHVpbnQxMjguCiAgLy8gZXZlbiB3aXRoIDE4IGRlY2ltYWxzLCB0aGlzIHN0aWxsIGFsbG93cyBvcmRlciBzaXplcyB1cCB0byAxLDAwMCwwMDAsMDAwLgogIC8vIGlmIHdlIGVuY291bnRlciBhIHRva2VuIHdpdGggZS5nLiAzNiBkZWNpbWFscyB3ZSdsbCBoYXZlIHRvIHJldmlzaXQgLi4uCiAgdWludCBjb25zdGFudCBiYXNlTWF4U2l6ZSA9IDEwICoqIDMwOwoKICAvLyB0aGUgY291bnRlciBjdXJyZW5jeSAoRVRIKQogIC8vIChubyBhZGRyZXNzIGJlY2F1c2UgaXQgaXMgRVRIKQoKICAvLyBhdm9pZCB0aGUgYm9vayBnZXR0aW5nIGNsdXR0ZXJlZCB1cCB3aXRoIHRpbnkgYW1vdW50cyBub3Qgd29ydGggdGhlIGdhcwogIHVpbnQgY29uc3RhbnQgY250ck1pbkluaXRpYWxTaXplID0gMTAgZmlubmV5OwoKICAvLyBzZWUgY29tbWVudHMgZm9yIGJhc2VNYXhTaXplCiAgdWludCBjb25zdGFudCBjbnRyTWF4U2l6ZSA9IDEwICoqIDMwOwoKICAvLyB0aGUgcmV3YXJkIHRva2VuIHRoYXQgY2FuIGJlIHVzZWQgdG8gcGF5IGZlZXMgKFVCSSkKCiAgRVJDMjAgcndyZFRva2VuOyAvLyBzZXQgYXQgaW5pdAoKICAvLyB1c2VkIHRvIGNvbnZlcnQgRVRIIGFtb3VudCB0byByZXdhcmQgdG9rZW5zIHdoZW4gcGF5aW5nIGZlZSB3aXRoIHJld2FyZCB0b2tlbnMKICB1aW50IGNvbnN0YW50IGV0aFJ3cmRSYXRlID0gMTAwMDsKICAKICAvLyBmdW5kcyB0aGF0IGJlbG9uZyB0byBjbGllbnRzIChiYXNlLCBjb3VudGVyLCBhbmQgcmV3YXJkKQoKICBtYXBwaW5nIChhZGRyZXNzID0+IHVpbnQpIGJhbGFuY2VCYXNlRm9yQ2xpZW50OwogIG1hcHBpbmcgKGFkZHJlc3MgPT4gdWludCkgYmFsYW5jZUNudHJGb3JDbGllbnQ7CiAgbWFwcGluZyAoYWRkcmVzcyA9PiB1aW50KSBiYWxhbmNlUndyZEZvckNsaWVudDsKCiAgLy8gZmVlIGNoYXJnZWQgb24gbGlxdWlkaXR5IHRha2VuLCBleHByZXNzZWQgYXMgYSBkaXZpc29yCiAgLy8gKGUuZy4gMjAwMCBtZWFucyAxLzIwMDAsIG9yIDAuMDUlKQoKICB1aW50IGNvbnN0YW50IGZlZURpdmlzb3IgPSAyMDAwOwogIAogIC8vIGZlZXMgY2hhcmdlZCBhcmUgZ2l2ZW4gdG86CiAgCiAgYWRkcmVzcyBmZWVDb2xsZWN0b3I7IC8vIHNldCBhdCBpbml0CgogIC8vIGFsbCBvcmRlcnMgZXZlciBjcmVhdGVkCiAgCiAgbWFwcGluZyAodWludDEyOCA9PiBPcmRlcikgb3JkZXJGb3JPcmRlcklkOwogIAogIC8vIEVmZmVjdGl2ZWx5IGEgY29tcGFjdCBtYXBwaW5nIGZyb20gcHJpY2UgdG8gd2hldGhlciB0aGVyZSBhcmUgYW55IG9wZW4gb3JkZXJzIGF0IHRoYXQgcHJpY2UuCiAgLy8gU2VlICJQcmljZSBDYWxjdWxhdGlvbiBDb25zdGFudHMiIGJlbG93IGFzIHRvIHdoeSA4NS4KCiAgdWludDI1Nls4NV0gb2NjdXBpZWRQcmljZUJpdG1hcHM7CgogIC8vIFRoZXNlIGFsbG93IHVzIHRvIHdhbGsgb3ZlciB0aGUgb3JkZXJzIGluIHRoZSBib29rIGF0IGEgZ2l2ZW4gcHJpY2UgbGV2ZWwgKGFuZCBhZGQgbW9yZSkuCgogIG1hcHBpbmcgKHVpbnQxNiA9PiBPcmRlckNoYWluKSBvcmRlckNoYWluRm9yT2NjdXBpZWRQcmljZTsKICBtYXBwaW5nICh1aW50MTI4ID0+IE9yZGVyQ2hhaW5Ob2RlKSBvcmRlckNoYWluTm9kZUZvck9wZW5PcmRlcklkOwoKICAvLyBUaGVzZSBhbGxvdyBhIGNsaWVudCB0byAocmVhc29uYWJseSkgZWZmaWNpZW50bHkgZmluZCB0aGVpciBvd24gb3JkZXJzCiAgLy8gd2l0aG91dCByZWx5aW5nIG9uIGV2ZW50cyAod2hpY2ggZXZlbiBpbmRleGVkIGFyZSBhIGJpdCBleHBlbnNpdmUgdG8gc2VhcmNoCiAgLy8gYW5kIGNhbm5vdCBiZSBhY2Nlc3NlZCBmcm9tIHNtYXJ0IGNvbnRyYWN0cykuIFNlZSB3YWxrT3JkZXJzLgoKICBtYXBwaW5nIChhZGRyZXNzID0+IHVpbnQxMjgpIG1vc3RSZWNlbnRPcmRlcklkRm9yQ2xpZW50OwogIG1hcHBpbmcgKHVpbnQxMjggPT4gdWludDEyOCkgY2xpZW50UHJldmlvdXNPcmRlcklkQmVmb3JlT3JkZXJJZDsKCiAgLy8gUHJpY2UgQ2FsY3VsYXRpb24gQ29uc3RhbnRzLgogIC8vCiAgLy8gV2UgcGFjayBkaXJlY3Rpb24gYW5kIHByaWNlIGludG8gYSBjcmFmdHkgZGVjaW1hbCBmbG9hdGluZyBwb2ludCByZXByZXNlbnRhdGlvbgogIC8vIGZvciBlZmZpY2llbnQgaW5kZXhpbmcgYnkgcHJpY2UsIHRoZSBtYWluIHRoaW5nIHdlIGxvc2UgYnkgZG9pbmcgc28gaXMgcHJlY2lzaW9uIC0KICAvLyB3ZSBvbmx5IGhhdmUgMyBzaWduaWZpY2FudCBmaWd1cmVzIGluIG91ciBwcmljZXMuCiAgLy8KICAvLyBBbiB1bnBhY2tlZCBwcmljZSBjb25zaXN0cyBvZjoKICAvLwogIC8vICAgZGlyZWN0aW9uIC0gaW52YWxpZCAvIGJ1eSAvIHNlbGwKICAvLyAgIG1hbnRpc3NhICAtIHJhbmdlcyBmcm9tIDEwMCB0byA5OTkgcmVwcmVzZW50aW5nIDAuMTAwIHRvIDAuOTk5CiAgLy8gICBleHBvbmVudCAgLSByYW5nZXMgZnJvbSBtaW5pbXVtUHJpY2VFeHBvbmVudCB0byBtaW5pbXVtUHJpY2VFeHBvbmVudCArIDExCiAgLy8gICAgICAgICAgICAgICAoZS5nLiAtNSB0byArNiBmb3IgYSB0eXBpY2FsIHBhaXIgd2hlcmUgbWluUHJpY2VFeHBvbmVudCA9IC01KQogIC8vCiAgLy8gVGhlIHBhY2tlZCByZXByZXNlbnRhdGlvbiBoYXMgMjE2MDEgZGlmZmVyZW50IHByaWNlIHZhbHVlczoKICAvLwogIC8vICAgICAgMCAgPSBpbnZhbGlkIChjYW4gYmUgdXNlZCBhcyBtYXJrZXIgdmFsdWUpCiAgLy8gICAgICAxICA9IGJ1eSBhdCBtYXhpbXVtIHByaWNlICgwLjk5OSAqIDEwICoqIDYpCiAgLy8gICAgLi4uICA9IG90aGVyIGJ1eSBwcmljZXMgaW4gZGVzY2VuZGluZyBvcmRlcgogIC8vICAgNTQwMCAgPSBidXkgYXQgMS4wMAogIC8vICAgIC4uLiAgPSBvdGhlciBidXkgcHJpY2VzIGluIGRlc2NlbmRpbmcgb3JkZXIKICAvLyAgMTA4MDAgID0gYnV5IGF0IG1pbmltdW0gcHJpY2UgKDAuMTAwICogMTAgKiogLTUpCiAgLy8gIDEwODAxICA9IHNlbGwgYXQgbWluaW11bSBwcmljZSAoMC4xMDAgKiAxMCAqKiAtNSkKICAvLyAgICAuLi4gID0gb3RoZXIgc2VsbCBwcmljZXMgaW4gZGVzY2VuZGluZyBvcmRlcgogIC8vICAxNjIwMSAgPSBzZWxsIGF0IDEuMDAKICAvLyAgICAuLi4gID0gb3RoZXIgc2VsbCBwcmljZXMgaW4gZGVzY2VuZGluZyBvcmRlcgogIC8vICAyMTYwMCAgPSBzZWxsIGF0IG1heGltdW0gcHJpY2UgKDAuOTk5ICogMTAgKiogNikKICAvLyAgMjE2MDErID0gZG8gbm90IHVzZQogIC8vCiAgLy8gSWYgd2Ugd2FudCB0byBtYXAgZWFjaCBwYWNrZWQgcHJpY2UgdG8gYSBib29sZWFuIHZhbHVlICh3aGljaCB3ZSBkbyksCiAgLy8gd2UgcmVxdWlyZSA4NSAyNTYtYml0IHdvcmRzLiBPciA0Mi41IGZvciBlYWNoIHNpZGUgb2YgdGhlIGJvb2suCiAgCiAgaW50OCBtaW5QcmljZUV4cG9uZW50OyAvLyBzZXQgYXQgaW5pdAoKICB1aW50IGNvbnN0YW50IGludmFsaWRQcmljZSA9IDA7CgogIC8vIGNhcmVmdWw6IG1heCA9IGxhcmdlc3QgdW5wYWNrZWQgdmFsdWUsIG5vdCBsYXJnZXN0IHBhY2tlZCB2YWx1ZQogIHVpbnQgY29uc3RhbnQgbWF4QnV5UHJpY2UgPSAxOyAKICB1aW50IGNvbnN0YW50IG1pbkJ1eVByaWNlID0gMTA4MDA7CiAgdWludCBjb25zdGFudCBtaW5TZWxsUHJpY2UgPSAxMDgwMTsKICB1aW50IGNvbnN0YW50IG1heFNlbGxQcmljZSA9IDIxNjAwOwoKICAvLyBDb25zdHJ1Y3Rvci4KICAvLwogIC8vIFNldHMgZmVlQ29sbGVjdG9yIHRvIHRoZSBjcmVhdG9yLiBDcmVhdG9yIG5lZWRzIHRvIGNhbGwgaW5pdCgpIHRvIGZpbmlzaCBzZXR1cC4KICAvLwogIGZ1bmN0aW9uIEJvb2tFUkMyMEV0aFYxRGVjKCkgewogICAgYWRkcmVzcyBjcmVhdG9yID0gbXNnLnNlbmRlcjsKICAgIGZlZUNvbGxlY3RvciA9IGNyZWF0b3I7CiAgfQoKICAvLyAiUHVibGljIiBNYW5hZ2VtZW50IC0gc2V0IGFkZHJlc3Mgb2YgYmFzZSBhbmQgcmV3YXJkIHRva2Vucy4KICAvLwogIC8vIENhbiBvbmx5IGJlIGRvbmUgb25jZSAobm9ybWFsbHkgaW1tZWRpYXRlbHkgYWZ0ZXIgY3JlYXRpb24pIGJ5IHRoZSBmZWUgY29sbGVjdG9yLgogIC8vCiAgLy8gVXNlZCBpbnN0ZWFkIG9mIGEgY29uc3RydWN0b3IgdG8gbWFrZSBkZXBsb3ltZW50IGVhc2llci4KICAvLwogIC8vIGJhc2VNaW5Jbml0aWFsU2l6ZSBpcyB0aGUgbWluaW11bSBvcmRlciBzaXplIGluIHRva2VuLXdlaTsKICAvLyB0aGUgbWluaW11bSByZXN0aW5nIHNpemUgd2lsbCBiZSBvbmUgdGVudGggb2YgdGhhdC4KICAvLwogIC8vIG1pblByaWNlRXhwb25lbnQgY29udHJvbHMgdGhlIHJhbmdlIG9mIHByaWNlcyBzdXBwb3J0ZWQgYnkgdGhlIGNvbnRyYWN0OwogIC8vIHRoZSByYW5nZSB3aWxsIGJlIDAuMTAwKjEwKiptaW5QcmljZUV4cG9uZW50IHRvIDAuOTk5KjEwKioobWluUHJpY2VFeHBvbmVudCArIDExKQogIC8vIGJ1dCBjYXJlZnVsOyB0aGlzIGlzIGluIHRva2VuLXdlaSA6IHdlaSwgaWdub3JpbmcgdGhlIG51bWJlciBvZiBkZWNpbWFscyBvZiB0aGUgdG9rZW4KICAvLyBlLmcuIC01IGltcGxpZXMgMSB0b2tlbi13ZWkgd29ydGggYmV0d2VlbiAwLjEwMGUtNSB0byAwLjk5OWUrNiB3ZWkKICAvLyB3aGljaCBpbXBsaWVzIHNhbWUgdG9rZW46ZXRoIGV4Y2hhbmdlIHJhdGUgaWYgdG9rZW4gZGVjaW1hbHMgYXJlIDE4IGxpa2UgZXRoLAogIC8vIGJ1dCBpZiB0b2tlbiBkZWNpbWFscyBhcmUgOCwgdGhhdCB3b3VsZCBpbXBseSAxIHRva2VuIHdvcnRoIDEwIHdlaSB0byAwLjAwMDk5OSBFVEguCiAgLy8KICBmdW5jdGlvbiBpbml0KEVSQzIwIF9iYXNlVG9rZW4sIEVSQzIwIF9yd3JkVG9rZW4sIHVpbnQgX2Jhc2VNaW5Jbml0aWFsU2l6ZSwgaW50OCBfbWluUHJpY2VFeHBvbmVudCkgcHVibGljIHsKICAgIHJlcXVpcmUobXNnLnNlbmRlciA9PSBmZWVDb2xsZWN0b3IpOwogICAgcmVxdWlyZShhZGRyZXNzKGJhc2VUb2tlbikgPT0gMCk7CiAgICByZXF1aXJlKGFkZHJlc3MoX2Jhc2VUb2tlbikgIT0gMCk7CiAgICByZXF1aXJlKGFkZHJlc3MocndyZFRva2VuKSA9PSAwKTsKICAgIHJlcXVpcmUoYWRkcmVzcyhfcndyZFRva2VuKSAhPSAwKTsKICAgIHJlcXVpcmUoX2Jhc2VNaW5Jbml0aWFsU2l6ZSA+PSAxMCk7CiAgICByZXF1aXJlKF9iYXNlTWluSW5pdGlhbFNpemUgPCBiYXNlTWF4U2l6ZSAvIDEwMDAwMDApOwogICAgcmVxdWlyZShfbWluUHJpY2VFeHBvbmVudCA+PSAtMjAgJiYgX21pblByaWNlRXhwb25lbnQgPD0gMjApOwogICAgaWYgKF9taW5QcmljZUV4cG9uZW50IDwgMikgewogICAgICByZXF1aXJlKF9iYXNlTWluSW5pdGlhbFNpemUgPj0gMTAgKiogdWludCgzLWludChtaW5QcmljZUV4cG9uZW50KSkpOwogICAgfQogICAgYmFzZU1pbkluaXRpYWxTaXplID0gX2Jhc2VNaW5Jbml0aWFsU2l6ZTsKICAgIC8vIGR1c3QgcHJldmVudGlvbi4gdHJ1bmNhdGlvbiBvaywga25vdyA+PSAxMAogICAgYmFzZU1pblJlbWFpbmluZ1NpemUgPSBfYmFzZU1pbkluaXRpYWxTaXplIC8gMTA7CiAgICBtaW5QcmljZUV4cG9uZW50ID0gX21pblByaWNlRXhwb25lbnQ7CiAgICAvLyBhdHRlbXB0IHRvIGNhdGNoIGJhZCB0b2tlbnM6CiAgICByZXF1aXJlKF9iYXNlVG9rZW4udG90YWxTdXBwbHkoKSA+IDApOwogICAgYmFzZVRva2VuID0gX2Jhc2VUb2tlbjsKICAgIHJlcXVpcmUoX3J3cmRUb2tlbi50b3RhbFN1cHBseSgpID4gMCk7CiAgICByd3JkVG9rZW4gPSBfcndyZFRva2VuOwogIH0KCiAgLy8gIlB1YmxpYyIgTWFuYWdlbWVudCAtIGNoYW5nZSBmZWUgY29sbGVjdG9yCiAgLy8KICAvLyBUaGUgbmV3IGZlZSBjb2xsZWN0b3Igb25seSBnZXRzIGZlZXMgY2hhcmdlZCBhZnRlciB0aGlzIHBvaW50LgogIC8vCiAgZnVuY3Rpb24gY2hhbmdlRmVlQ29sbGVjdG9yKGFkZHJlc3MgbmV3RmVlQ29sbGVjdG9yKSBwdWJsaWMgewogICAgYWRkcmVzcyBvbGRGZWVDb2xsZWN0b3IgPSBmZWVDb2xsZWN0b3I7CiAgICByZXF1aXJlKG1zZy5zZW5kZXIgPT0gb2xkRmVlQ29sbGVjdG9yKTsKICAgIHJlcXVpcmUobmV3RmVlQ29sbGVjdG9yICE9IG9sZEZlZUNvbGxlY3Rvcik7CiAgICBmZWVDb2xsZWN0b3IgPSBuZXdGZWVDb2xsZWN0b3I7CiAgfQogIAogIC8vIFB1YmxpYyBJbmZvIFZpZXcgLSB3aGF0IGlzIGJlaW5nIHRyYWRlZCBoZXJlLCB3aGF0IGFyZSB0aGUgbGltaXRzPwogIC8vCiAgZnVuY3Rpb24gZ2V0Qm9va0luZm8oKSBwdWJsaWMgY29uc3RhbnQgcmV0dXJucyAoCiAgICAgIEJvb2tUeXBlIF9ib29rVHlwZSwgYWRkcmVzcyBfYmFzZVRva2VuLCBhZGRyZXNzIF9yd3JkVG9rZW4sCiAgICAgIHVpbnQgX2Jhc2VNaW5Jbml0aWFsU2l6ZSwgdWludCBfY250ck1pbkluaXRpYWxTaXplLAogICAgICB1aW50IF9mZWVEaXZpc29yLCBhZGRyZXNzIF9mZWVDb2xsZWN0b3IKICAgICkgewogICAgcmV0dXJuICgKICAgICAgQm9va1R5cGUuRVJDMjBFdGhWMSwKICAgICAgYWRkcmVzcyhiYXNlVG9rZW4pLAogICAgICBhZGRyZXNzKHJ3cmRUb2tlbiksCiAgICAgIGJhc2VNaW5Jbml0aWFsU2l6ZSwgLy8gY2FuIGFzc3VtZSBtaW4gcmVzdGluZyBzaXplIGlzIG9uZSB0ZW50aCBvZiB0aGlzCiAgICAgIGNudHJNaW5Jbml0aWFsU2l6ZSwKICAgICAgZmVlRGl2aXNvciwKICAgICAgZmVlQ29sbGVjdG9yCiAgICApOwogIH0KCiAgLy8gUHVibGljIEZ1bmRzIFZpZXcgLSBnZXQgYmFsYW5jZXMgaGVsZCBieSBjb250cmFjdCBvbiBiZWhhbGYgb2YgdGhlIGNsaWVudCwKICAvLyBvciBiYWxhbmNlcyBhcHByb3ZlZCBmb3IgZGVwb3NpdCBidXQgbm90IHlldCBjbGFpbWVkIGJ5IHRoZSBjb250cmFjdC4KICAvLwogIC8vIEV4Y2x1ZGVzIGZ1bmRzIGluIG9wZW4gb3JkZXJzLgogIC8vCiAgLy8gSGVscHMgYSB3ZWIgdWkgZ2V0IGEgY29uc2lzdGVudCBzbmFwc2hvdCBvZiBiYWxhbmNlcy4KICAvLwogIC8vIEl0IHdvdWxkIGJlIG5pY2UgdG8gcmV0dXJuIHRoZSBvZmYtZXhjaGFuZ2UgRVRIIGJhbGFuY2UgdG9vIGJ1dCB0aGVyZSdzIGEKICAvLyBiaXphcnJlIGJ1ZyBpbiBnZXRoIChhbmQgYXBwYXJlbnRseSBhcyBhIHJlc3VsdCB2aWEgTWV0YU1hc2spIHRoYXQgbGVhZHMKICAvLyB0byB1bnByZWRpY3RhYmxlIGJlaGF2aW91ciB3aGVuIGxvb2tpbmcgdXAgY2xpZW50IGJhbGFuY2VzIGluIGNvbnN0YW50CiAgLy8gZnVuY3Rpb25zIC0gc2VlIGUuZy4gaHR0cHM6Ly9naXRodWIuY29tL2V0aGVyZXVtL3NvbGlkaXR5L2lzc3Vlcy8yMzI1IC4KICAvLwogIGZ1bmN0aW9uIGdldENsaWVudEJhbGFuY2VzKGFkZHJlc3MgY2xpZW50KSBwdWJsaWMgY29uc3RhbnQgcmV0dXJucyAoCiAgICAgIHVpbnQgYm9va0JhbGFuY2VCYXNlLAogICAgICB1aW50IGJvb2tCYWxhbmNlQ250ciwKICAgICAgdWludCBib29rQmFsYW5jZVJ3cmQsCiAgICAgIHVpbnQgYXBwcm92ZWRCYWxhbmNlQmFzZSwKICAgICAgdWludCBhcHByb3ZlZEJhbGFuY2VSd3JkLAogICAgICB1aW50IG93bkJhbGFuY2VCYXNlLAogICAgICB1aW50IG93bkJhbGFuY2VSd3JkCiAgICApIHsKICAgIGJvb2tCYWxhbmNlQmFzZSA9IGJhbGFuY2VCYXNlRm9yQ2xpZW50W2NsaWVudF07CiAgICBib29rQmFsYW5jZUNudHIgPSBiYWxhbmNlQ250ckZvckNsaWVudFtjbGllbnRdOwogICAgYm9va0JhbGFuY2VSd3JkID0gYmFsYW5jZVJ3cmRGb3JDbGllbnRbY2xpZW50XTsKICAgIGFwcHJvdmVkQmFsYW5jZUJhc2UgPSBiYXNlVG9rZW4uYWxsb3dhbmNlKGNsaWVudCwgYWRkcmVzcyh0aGlzKSk7CiAgICBhcHByb3ZlZEJhbGFuY2VSd3JkID0gcndyZFRva2VuLmFsbG93YW5jZShjbGllbnQsIGFkZHJlc3ModGhpcykpOwogICAgb3duQmFsYW5jZUJhc2UgPSBiYXNlVG9rZW4uYmFsYW5jZU9mKGNsaWVudCk7CiAgICBvd25CYWxhbmNlUndyZCA9IHJ3cmRUb2tlbi5iYWxhbmNlT2YoY2xpZW50KTsKICB9CgogIC8vIFB1YmxpYyBGdW5kcyBNYW5pcHVsYXRpb24gLSBkZXBvc2l0IHByZXZpb3VzbHktYXBwcm92ZWQgYmFzZSB0b2tlbnMuCiAgLy8KICBmdW5jdGlvbiB0cmFuc2ZlckZyb21CYXNlKCkgcHVibGljIHsKICAgIGFkZHJlc3MgY2xpZW50ID0gbXNnLnNlbmRlcjsKICAgIGFkZHJlc3MgYm9vayA9IGFkZHJlc3ModGhpcyk7CiAgICAvLyB3ZSB0cnVzdCB0aGUgRVJDMjAgdG9rZW4gY29udHJhY3Qgbm90IHRvIGRvIG5hc3R5IHRoaW5ncyBsaWtlIGNhbGwgYmFjayBpbnRvIHVzIC0KICAgIC8vIGlmIHdlIGNhbm5vdCB0cnVzdCB0aGUgdG9rZW4gdGhlbiB3aHkgYXJlIHdlIGFsbG93aW5nIGl0IHRvIGJlIHRyYWRlZD8KICAgIHVpbnQgYW1vdW50QmFzZSA9IGJhc2VUb2tlbi5hbGxvd2FuY2UoY2xpZW50LCBib29rKTsKICAgIHJlcXVpcmUoYW1vdW50QmFzZSA+IDApOwogICAgLy8gTkI6IG5lZWRzIGNoYW5nZSBmb3Igb2xkZXIgRVJDMjAgdG9rZW5zIHRoYXQgZG9uJ3QgcmV0dXJuIGJvb2wKICAgIHJlcXVpcmUoYmFzZVRva2VuLnRyYW5zZmVyRnJvbShjbGllbnQsIGJvb2ssIGFtb3VudEJhc2UpKTsKICAgIC8vIGJlbHQgYW5kIGJyYWNlcwogICAgYXNzZXJ0KGJhc2VUb2tlbi5hbGxvd2FuY2UoY2xpZW50LCBib29rKSA9PSAwKTsKICAgIGJhbGFuY2VCYXNlRm9yQ2xpZW50W2NsaWVudF0gKz0gYW1vdW50QmFzZTsKICAgIENsaWVudFBheW1lbnRFdmVudChjbGllbnQsIENsaWVudFBheW1lbnRFdmVudFR5cGUuVHJhbnNmZXJGcm9tLCBCYWxhbmNlVHlwZS5CYXNlLCBpbnQoYW1vdW50QmFzZSkpOwogIH0KCiAgLy8gUHVibGljIEZ1bmRzIE1hbmlwdWxhdGlvbiAtIHdpdGhkcmF3IGJhc2UgdG9rZW5zIChhcyBhIHRyYW5zZmVyKS4KICAvLwogIGZ1bmN0aW9uIHRyYW5zZmVyQmFzZSh1aW50IGFtb3VudEJhc2UpIHB1YmxpYyB7CiAgICBhZGRyZXNzIGNsaWVudCA9IG1zZy5zZW5kZXI7CiAgICByZXF1aXJlKGFtb3VudEJhc2UgPiAwKTsKICAgIHJlcXVpcmUoYW1vdW50QmFzZSA8PSBiYWxhbmNlQmFzZUZvckNsaWVudFtjbGllbnRdKTsKICAgIC8vIG92ZXJmbG93IHNhZmUgc2luY2Ugd2UgY2hlY2tlZCBsZXNzIHRoYW4gYmFsYW5jZSBhYm92ZQogICAgYmFsYW5jZUJhc2VGb3JDbGllbnRbY2xpZW50XSAtPSBhbW91bnRCYXNlOwogICAgLy8gd2UgdHJ1c3QgdGhlIEVSQzIwIHRva2VuIGNvbnRyYWN0IG5vdCB0byBkbyBuYXN0eSB0aGluZ3MgbGlrZSBjYWxsIGJhY2sgaW50byB1cyAtCiAgICAvLyBpZiB3ZSBjYW5ub3QgdHJ1c3QgdGhlIHRva2VuIHRoZW4gd2h5IGFyZSB3ZSBhbGxvd2luZyBpdCB0byBiZSB0cmFkZWQ/CiAgICAvLyBOQjogbmVlZHMgY2hhbmdlIGZvciBvbGRlciBFUkMyMCB0b2tlbnMgdGhhdCBkb24ndCByZXR1cm4gYm9vbAogICAgcmVxdWlyZShiYXNlVG9rZW4udHJhbnNmZXIoY2xpZW50LCBhbW91bnRCYXNlKSk7CiAgICBDbGllbnRQYXltZW50RXZlbnQoY2xpZW50LCBDbGllbnRQYXltZW50RXZlbnRUeXBlLlRyYW5zZmVyLCBCYWxhbmNlVHlwZS5CYXNlLCAtaW50KGFtb3VudEJhc2UpKTsKICB9CgogIC8vIFB1YmxpYyBGdW5kcyBNYW5pcHVsYXRpb24gLSBkZXBvc2l0IGNvdW50ZXIgY3VycmVuY3kgKEVUSCkuCiAgLy8KICBmdW5jdGlvbiBkZXBvc2l0Q250cigpIHB1YmxpYyBwYXlhYmxlIHsKICAgIGFkZHJlc3MgY2xpZW50ID0gbXNnLnNlbmRlcjsKICAgIHVpbnQgYW1vdW50Q250ciA9IG1zZy52YWx1ZTsKICAgIHJlcXVpcmUoYW1vdW50Q250ciA+IDApOwogICAgLy8gb3ZlcmZsb3cgc2FmZSAtIGlmIHNvbWVvbmUgb3ducyBwb3coMiwyNTUpIEVUSCB3ZSBoYXZlIGJpZ2dlciBwcm9ibGVtcwogICAgYmFsYW5jZUNudHJGb3JDbGllbnRbY2xpZW50XSArPSBhbW91bnRDbnRyOwogICAgQ2xpZW50UGF5bWVudEV2ZW50KGNsaWVudCwgQ2xpZW50UGF5bWVudEV2ZW50VHlwZS5EZXBvc2l0LCBCYWxhbmNlVHlwZS5DbnRyLCBpbnQoYW1vdW50Q250cikpOwogIH0KCiAgLy8gUHVibGljIEZ1bmRzIE1hbmlwdWxhdGlvbiAtIHdpdGhkcmF3IGNvdW50ZXIgY3VycmVuY3kgKEVUSCkuCiAgLy8KICBmdW5jdGlvbiB3aXRoZHJhd0NudHIodWludCBhbW91bnRDbnRyKSBwdWJsaWMgewogICAgYWRkcmVzcyBjbGllbnQgPSBtc2cuc2VuZGVyOwogICAgcmVxdWlyZShhbW91bnRDbnRyID4gMCk7CiAgICByZXF1aXJlKGFtb3VudENudHIgPD0gYmFsYW5jZUNudHJGb3JDbGllbnRbY2xpZW50XSk7CiAgICAvLyBvdmVyZmxvdyBzYWZlIC0gY2hlY2tlZCBsZXNzIHRoYW4gYmFsYW5jZSBhYm92ZQogICAgYmFsYW5jZUNudHJGb3JDbGllbnRbY2xpZW50XSAtPSBhbW91bnRDbnRyOwogICAgLy8gc2FmZSAtIG5vdCBlbm91Z2ggZ2FzIHRvIGRvIGFueXRoaW5nIGludGVyZXN0aW5nIGluIGZhbGxiYWNrLCBhbHJlYWR5IGFkanVzdGVkIGJhbGFuY2UKICAgIGNsaWVudC50cmFuc2ZlcihhbW91bnRDbnRyKTsKICAgIENsaWVudFBheW1lbnRFdmVudChjbGllbnQsIENsaWVudFBheW1lbnRFdmVudFR5cGUuV2l0aGRyYXcsIEJhbGFuY2VUeXBlLkNudHIsIC1pbnQoYW1vdW50Q250cikpOwogIH0KCiAgLy8gUHVibGljIEZ1bmRzIE1hbmlwdWxhdGlvbiAtIGRlcG9zaXQgcHJldmlvdXNseS1hcHByb3ZlZCByZXdhcmQgdG9rZW5zLgogIC8vCiAgZnVuY3Rpb24gdHJhbnNmZXJGcm9tUndyZCgpIHB1YmxpYyB7CiAgICBhZGRyZXNzIGNsaWVudCA9IG1zZy5zZW5kZXI7CiAgICBhZGRyZXNzIGJvb2sgPSBhZGRyZXNzKHRoaXMpOwogICAgdWludCBhbW91bnRSd3JkID0gcndyZFRva2VuLmFsbG93YW5jZShjbGllbnQsIGJvb2spOwogICAgcmVxdWlyZShhbW91bnRSd3JkID4gMCk7CiAgICAvLyB3ZSB3cm90ZSB0aGUgcmV3YXJkIHRva2VuIHNvIHdlIGtub3cgaXQgc3VwcG9ydHMgRVJDMjAgcHJvcGVybHkgYW5kIGlzIG5vdCBldmlsCiAgICByZXF1aXJlKHJ3cmRUb2tlbi50cmFuc2ZlckZyb20oY2xpZW50LCBib29rLCBhbW91bnRSd3JkKSk7CiAgICAvLyBiZWx0IGFuZCBicmFjZXMKICAgIGFzc2VydChyd3JkVG9rZW4uYWxsb3dhbmNlKGNsaWVudCwgYm9vaykgPT0gMCk7CiAgICBiYWxhbmNlUndyZEZvckNsaWVudFtjbGllbnRdICs9IGFtb3VudFJ3cmQ7CiAgICBDbGllbnRQYXltZW50RXZlbnQoY2xpZW50LCBDbGllbnRQYXltZW50RXZlbnRUeXBlLlRyYW5zZmVyRnJvbSwgQmFsYW5jZVR5cGUuUndyZCwgaW50KGFtb3VudFJ3cmQpKTsKICB9CgogIC8vIFB1YmxpYyBGdW5kcyBNYW5pcHVsYXRpb24gLSB3aXRoZHJhdyBiYXNlIHRva2VucyAoYXMgYSB0cmFuc2ZlcikuCiAgLy8KICBmdW5jdGlvbiB0cmFuc2ZlclJ3cmQodWludCBhbW91bnRSd3JkKSBwdWJsaWMgewogICAgYWRkcmVzcyBjbGllbnQgPSBtc2cuc2VuZGVyOwogICAgcmVxdWlyZShhbW91bnRSd3JkID4gMCk7CiAgICByZXF1aXJlKGFtb3VudFJ3cmQgPD0gYmFsYW5jZVJ3cmRGb3JDbGllbnRbY2xpZW50XSk7CiAgICAvLyBvdmVyZmxvdyBzYWZlIC0gY2hlY2tlZCBsZXNzIHRoYW4gYmFsYW5jZSBhYm92ZQogICAgYmFsYW5jZVJ3cmRGb3JDbGllbnRbY2xpZW50XSAtPSBhbW91bnRSd3JkOwogICAgLy8gd2Ugd3JvdGUgdGhlIHJld2FyZCB0b2tlbiBzbyB3ZSBrbm93IGl0IHN1cHBvcnRzIEVSQzIwIHByb3Blcmx5IGFuZCBpcyBub3QgZXZpbAogICAgcmVxdWlyZShyd3JkVG9rZW4udHJhbnNmZXIoY2xpZW50LCBhbW91bnRSd3JkKSk7CiAgICBDbGllbnRQYXltZW50RXZlbnQoY2xpZW50LCBDbGllbnRQYXltZW50RXZlbnRUeXBlLlRyYW5zZmVyLCBCYWxhbmNlVHlwZS5Sd3JkLCAtaW50KGFtb3VudFJ3cmQpKTsKICB9CgogIC8vIFB1YmxpYyBPcmRlciBWaWV3IC0gZ2V0IGZ1bGwgZGV0YWlscyBvZiBhbiBvcmRlci4KICAvLwogIC8vIElmIHRoZSBvcmRlcklkIGRvZXMgbm90IGV4aXN0LCBzdGF0dXMgd2lsbCBiZSBVbmtub3duLgogIC8vCiAgZnVuY3Rpb24gZ2V0T3JkZXIodWludDEyOCBvcmRlcklkKSBwdWJsaWMgY29uc3RhbnQgcmV0dXJucyAoCiAgICBhZGRyZXNzIGNsaWVudCwgdWludDE2IHByaWNlLCB1aW50IHNpemVCYXNlLCBUZXJtcyB0ZXJtcywKICAgIFN0YXR1cyBzdGF0dXMsIFJlYXNvbkNvZGUgcmVhc29uQ29kZSwgdWludCBleGVjdXRlZEJhc2UsIHVpbnQgZXhlY3V0ZWRDbnRyLAogICAgdWludCBmZWVzQmFzZU9yQ250ciwgdWludCBmZWVzUndyZCkgewogICAgT3JkZXIgc3RvcmFnZSBvcmRlciA9IG9yZGVyRm9yT3JkZXJJZFtvcmRlcklkXTsKICAgIHJldHVybiAob3JkZXIuY2xpZW50LCBvcmRlci5wcmljZSwgb3JkZXIuc2l6ZUJhc2UsIG9yZGVyLnRlcm1zLAogICAgICAgICAgICBvcmRlci5zdGF0dXMsIG9yZGVyLnJlYXNvbkNvZGUsIG9yZGVyLmV4ZWN1dGVkQmFzZSwgb3JkZXIuZXhlY3V0ZWRDbnRyLAogICAgICAgICAgICBvcmRlci5mZWVzQmFzZU9yQ250ciwgb3JkZXIuZmVlc1J3cmQpOwogIH0KCiAgLy8gUHVibGljIE9yZGVyIFZpZXcgLSBnZXQgbXV0YWJsZSBkZXRhaWxzIG9mIGFuIG9yZGVyLgogIC8vCiAgLy8gSWYgdGhlIG9yZGVySWQgZG9lcyBub3QgZXhpc3QsIHN0YXR1cyB3aWxsIGJlIFVua25vd24uCiAgLy8KICBmdW5jdGlvbiBnZXRPcmRlclN0YXRlKHVpbnQxMjggb3JkZXJJZCkgcHVibGljIGNvbnN0YW50IHJldHVybnMgKAogICAgU3RhdHVzIHN0YXR1cywgUmVhc29uQ29kZSByZWFzb25Db2RlLCB1aW50IGV4ZWN1dGVkQmFzZSwgdWludCBleGVjdXRlZENudHIsCiAgICB1aW50IGZlZXNCYXNlT3JDbnRyLCB1aW50IGZlZXNSd3JkKSB7CiAgICBPcmRlciBzdG9yYWdlIG9yZGVyID0gb3JkZXJGb3JPcmRlcklkW29yZGVySWRdOwogICAgcmV0dXJuIChvcmRlci5zdGF0dXMsIG9yZGVyLnJlYXNvbkNvZGUsIG9yZGVyLmV4ZWN1dGVkQmFzZSwgb3JkZXIuZXhlY3V0ZWRDbnRyLAogICAgICAgICAgICBvcmRlci5mZWVzQmFzZU9yQ250ciwgb3JkZXIuZmVlc1J3cmQpOwogIH0KICAKICAvLyBQdWJsaWMgT3JkZXIgVmlldyAtIGVudW1lcmF0ZSBhbGwgcmVjZW50IG9yZGVycyArIGFsbCBvcGVuIG9yZGVycyBmb3Igb25lIGNsaWVudC4KICAvLwogIC8vIE5vdCByZWFsbHkgZGVzaWduZWQgZm9yIHVzZSBmcm9tIGEgc21hcnQgY29udHJhY3QgdHJhbnNhY3Rpb24uCiAgLy8KICAvLyBJZGVhIGlzOgogIC8vICAtIGNsaWVudCBlbnN1cmVzIG9yZGVyIGlkcyBhcmUgZ2VuZXJhdGVkIHNvIHRoYXQgbW9zdC1zaWduZmljYW50IHBhcnQgaXMgdGltZS1iYXNlZDsKICAvLyAgLSBjbGllbnQgZGVjaWRlcyB0aGV5IHdhbnQgYWxsIG9yZGVycyBhZnRlciBhIGNlcnRhaW4gcG9pbnQtaW4tdGltZSwKICAvLyAgICBhbmQgY2hvb3NlcyBtaW5DbG9zZWRPcmRlcklkQ3V0b2ZmIGFjY29yZGluZ2x5OwogIC8vICAtIGJlZm9yZSB0aGF0IHBvaW50LWluLXRpbWUgdGhleSBqdXN0IGdldCBvcGVuIGFuZCBuZWVkcyBnYXMgb3JkZXJzCiAgLy8gIC0gY2xpZW50IGNhbGxzIHdhbGtDbGllbnRPcmRlcnMgd2l0aCBtYXliZUxhc3RPcmRlcklkUmV0dXJuZWQgPSAwIGluaXRpYWxseTsKICAvLyAgLSB0aGVuIHJlcGVhdHMgd2l0aCB0aGUgb3JkZXJJZCByZXR1cm5lZCBieSB3YWxrQ2xpZW50T3JkZXJzOwogIC8vICAtIChhbmQgc3RvcHMgaWYgaXQgcmV0dXJucyBhIHplcm8gb3JkZXJJZCk7CiAgLy8KICAvLyBOb3RlIHRoYXQgY2xpZW50IGlzIG9ubHkgdXNlZCB3aGVuIG1heWJlTGFzdE9yZGVySWRSZXR1cm5lZCA9IDAuCiAgLy8KICBmdW5jdGlvbiB3YWxrQ2xpZW50T3JkZXJzKAogICAgICBhZGRyZXNzIGNsaWVudCwgdWludDEyOCBtYXliZUxhc3RPcmRlcklkUmV0dXJuZWQsIHVpbnQxMjggbWluQ2xvc2VkT3JkZXJJZEN1dG9mZgogICAgKSBwdWJsaWMgY29uc3RhbnQgcmV0dXJucyAoCiAgICAgIHVpbnQxMjggb3JkZXJJZCwgdWludDE2IHByaWNlLCB1aW50IHNpemVCYXNlLCBUZXJtcyB0ZXJtcywKICAgICAgU3RhdHVzIHN0YXR1cywgUmVhc29uQ29kZSByZWFzb25Db2RlLCB1aW50IGV4ZWN1dGVkQmFzZSwgdWludCBleGVjdXRlZENudHIsCiAgICAgIHVpbnQgZmVlc0Jhc2VPckNudHIsIHVpbnQgZmVlc1J3cmQpIHsKICAgIGlmIChtYXliZUxhc3RPcmRlcklkUmV0dXJuZWQgPT0gMCkgewogICAgICBvcmRlcklkID0gbW9zdFJlY2VudE9yZGVySWRGb3JDbGllbnRbY2xpZW50XTsKICAgIH0gZWxzZSB7CiAgICAgIG9yZGVySWQgPSBjbGllbnRQcmV2aW91c09yZGVySWRCZWZvcmVPcmRlcklkW21heWJlTGFzdE9yZGVySWRSZXR1cm5lZF07CiAgICB9CiAgICB3aGlsZSAodHJ1ZSkgewogICAgICBpZiAob3JkZXJJZCA9PSAwKSByZXR1cm47CiAgICAgIE9yZGVyIHN0b3JhZ2Ugb3JkZXIgPSBvcmRlckZvck9yZGVySWRbb3JkZXJJZF07CiAgICAgIGlmIChvcmRlcklkID49IG1pbkNsb3NlZE9yZGVySWRDdXRvZmYpIGJyZWFrOwogICAgICBpZiAob3JkZXIuc3RhdHVzID09IFN0YXR1cy5PcGVuIHx8IG9yZGVyLnN0YXR1cyA9PSBTdGF0dXMuTmVlZHNHYXMpIGJyZWFrOwogICAgICBvcmRlcklkID0gY2xpZW50UHJldmlvdXNPcmRlcklkQmVmb3JlT3JkZXJJZFtvcmRlcklkXTsKICAgIH0KICAgIHJldHVybiAob3JkZXJJZCwgb3JkZXIucHJpY2UsIG9yZGVyLnNpemVCYXNlLCBvcmRlci50ZXJtcywKICAgICAgICAgICAgb3JkZXIuc3RhdHVzLCBvcmRlci5yZWFzb25Db2RlLCBvcmRlci5leGVjdXRlZEJhc2UsIG9yZGVyLmV4ZWN1dGVkQ250ciwKICAgICAgICAgICAgb3JkZXIuZmVlc0Jhc2VPckNudHIsIG9yZGVyLmZlZXNSd3JkKTsKICB9CiAKICAvLyBJbnRlcm5hbCBQcmljZSBDYWxjdWxhdGlvbiAtIHR1cm4gcGFja2VkIHByaWNlIGludG8gYSBmcmllbmRsaWVyIHVucGFja2VkIHByaWNlLgogIC8vCiAgZnVuY3Rpb24gdW5wYWNrUHJpY2UodWludDE2IHByaWNlKSBpbnRlcm5hbCBjb25zdGFudCByZXR1cm5zICgKICAgICAgRGlyZWN0aW9uIGRpcmVjdGlvbiwgdWludDE2IG1hbnRpc3NhLCBpbnQ4IGV4cG9uZW50CiAgICApIHsKICAgIHVpbnQgc2lkZWRQcmljZUluZGV4ID0gdWludChwcmljZSk7CiAgICB1aW50IHByaWNlSW5kZXg7CiAgICBpZiAoc2lkZWRQcmljZUluZGV4IDwgMSB8fCBzaWRlZFByaWNlSW5kZXggPiBtYXhTZWxsUHJpY2UpIHsKICAgICAgZGlyZWN0aW9uID0gRGlyZWN0aW9uLkludmFsaWQ7CiAgICAgIG1hbnRpc3NhID0gMDsKICAgICAgZXhwb25lbnQgPSAwOwogICAgICByZXR1cm47CiAgICB9IGVsc2UgaWYgKHNpZGVkUHJpY2VJbmRleCA8PSBtaW5CdXlQcmljZSkgewogICAgICBkaXJlY3Rpb24gPSBEaXJlY3Rpb24uQnV5OwogICAgICBwcmljZUluZGV4ID0gbWluQnV5UHJpY2UgLSBzaWRlZFByaWNlSW5kZXg7CiAgICB9IGVsc2UgewogICAgICBkaXJlY3Rpb24gPSBEaXJlY3Rpb24uU2VsbDsKICAgICAgcHJpY2VJbmRleCA9IHNpZGVkUHJpY2VJbmRleCAtIG1pblNlbGxQcmljZTsKICAgIH0KICAgIHVpbnQgemVyb0Jhc2VkTWFudGlzc2EgPSBwcmljZUluZGV4ICUgOTAwOwogICAgdWludCB6ZXJvQmFzZWRFeHBvbmVudCA9IHByaWNlSW5kZXggLyA5MDA7CiAgICBtYW50aXNzYSA9IHVpbnQxNih6ZXJvQmFzZWRNYW50aXNzYSArIDEwMCk7CiAgICBleHBvbmVudCA9IGludDgoemVyb0Jhc2VkRXhwb25lbnQpICsgbWluUHJpY2VFeHBvbmVudDsKICAgIHJldHVybjsKICB9CiAgCiAgLy8gSW50ZXJuYWwgUHJpY2UgQ2FsY3VsYXRpb24gLSBpcyBhIHBhY2tlZCBwcmljZSBvbiB0aGUgYnV5IHNpZGU/CiAgLy8KICAvLyBUaHJvd3MgYW4gZXJyb3IgaWYgcHJpY2UgaXMgaW52YWxpZC4KICAvLwogIGZ1bmN0aW9uIGlzQnV5UHJpY2UodWludDE2IHByaWNlKSBpbnRlcm5hbCBjb25zdGFudCByZXR1cm5zIChib29sIGlzQnV5KSB7CiAgICAvLyB5ZXMsIHRoaXMgbG9va3Mgb2RkLCBidXQgbWF4IGhlcmUgaXMgaGlnaGVzdCBfdW5wYWNrZWRfIHByaWNlCiAgICByZXR1cm4gcHJpY2UgPj0gbWF4QnV5UHJpY2UgJiYgcHJpY2UgPD0gbWluQnV5UHJpY2U7CiAgfQogIAogIC8vIEludGVybmFsIFByaWNlIENhbGN1bGF0aW9uIC0gdHVybiBhIHBhY2tlZCBidXkgcHJpY2UgaW50byBhIHBhY2tlZCBzZWxsIHByaWNlLgogIC8vCiAgLy8gSW52YWxpZCBwcmljZSByZW1haW5zIGludmFsaWQuCiAgLy8KICBmdW5jdGlvbiBjb21wdXRlT3Bwb3NpdGVQcmljZSh1aW50MTYgcHJpY2UpIGludGVybmFsIGNvbnN0YW50IHJldHVybnMgKHVpbnQxNiBvcHBvc2l0ZSkgewogICAgaWYgKHByaWNlIDwgbWF4QnV5UHJpY2UgfHwgcHJpY2UgPiBtYXhTZWxsUHJpY2UpIHsKICAgICAgcmV0dXJuIHVpbnQxNihpbnZhbGlkUHJpY2UpOwogICAgfSBlbHNlIGlmIChwcmljZSA8PSBtaW5CdXlQcmljZSkgewogICAgICByZXR1cm4gdWludDE2KG1heFNlbGxQcmljZSAtIChwcmljZSAtIG1heEJ1eVByaWNlKSk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gdWludDE2KG1heEJ1eVByaWNlICsgKG1heFNlbGxQcmljZSAtIHByaWNlKSk7CiAgICB9CiAgfQogIAogIC8vIEludGVybmFsIFByaWNlIENhbGN1bGF0aW9uIC0gY29tcHV0ZSBhbW91bnQgaW4gY291bnRlciBjdXJyZW5jeSB0aGF0IHdvdWxkCiAgLy8gYmUgb2J0YWluZWQgYnkgc2VsbGluZyBiYXNlQW1vdW50IGF0IHRoZSBnaXZlbiB1bnBhY2tlZCBwcmljZSAoaWYgbm8gZmVlcykuCiAgLy8KICAvLyBOb3RlczoKICAvLyAgLSBEb2VzIG5vdCB2YWxpZGF0ZSBwcmljZSAtIGNhbGxlciBtdXN0IGVuc3VyZSB2YWxpZC4KICAvLyAgLSBDb3VsZCBvdmVyZmxvdyBwcm9kdWNpbmcgdmVyeSB1bmV4cGVjdGVkIHJlc3VsdHMgaWYgYmFzZUFtb3VudCB2ZXJ5CiAgLy8gICAgbGFyZ2UgLSBjYWxsZXIgbXVzdCBjaGVjayB0aGlzLgogIC8vICAtIFRoaXMgcm91bmRzIHRoZSBhbW91bnQgdG93YXJkcyB6ZXJvLgogIC8vICAtIE1heSB0cnVuY2F0ZSB0byB6ZXJvIGlmIGJhc2VBbW91bnQgdmVyeSBzbWFsbCAtIHBvdGVudGlhbGx5IGFsbG93aW5nCiAgLy8gICAgemVyby1jb3N0IGJ1eXMgb3IgcG9pbnRsZXNzIHNhbGVzIC0gY2FsbGVyIG11c3QgY2hlY2sgdGhpcy4KICAvLwogIGZ1bmN0aW9uIGNvbXB1dGVDbnRyQW1vdW50VXNpbmdVbnBhY2tlZCgKICAgICAgdWludCBiYXNlQW1vdW50LCB1aW50MTYgbWFudGlzc2EsIGludDggZXhwb25lbnQKICAgICkgaW50ZXJuYWwgY29uc3RhbnQgcmV0dXJucyAodWludCBjbnRyQW1vdW50KSB7CiAgICBpZiAoZXhwb25lbnQgPCAwKSB7CiAgICAgIHJldHVybiBiYXNlQW1vdW50ICogdWludChtYW50aXNzYSkgLyAxMDAwIC8gMTAgKiogdWludCgtZXhwb25lbnQpOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGJhc2VBbW91bnQgKiB1aW50KG1hbnRpc3NhKSAvIDEwMDAgKiAxMCAqKiB1aW50KGV4cG9uZW50KTsKICAgIH0KICB9CgogIC8vIEludGVybmFsIFByaWNlIENhbGN1bGF0aW9uIC0gY29tcHV0ZSBhbW91bnQgaW4gY291bnRlciBjdXJyZW5jeSB0aGF0IHdvdWxkCiAgLy8gYmUgb2J0YWluZWQgYnkgc2VsbGluZyBiYXNlQW1vdW50IGF0IHRoZSBnaXZlbiBwYWNrZWQgcHJpY2UgKGlmIG5vIGZlZXMpLgogIC8vCiAgLy8gTm90ZXM6CiAgLy8gIC0gRG9lcyBub3QgdmFsaWRhdGUgcHJpY2UgLSBjYWxsZXIgbXVzdCBlbnN1cmUgdmFsaWQuCiAgLy8gIC0gRGlyZWN0aW9uIG9mIHRoZSBwYWNrZWQgcHJpY2UgaXMgaWdub3JlZC4KICAvLyAgLSBDb3VsZCBvdmVyZmxvdyBwcm9kdWNpbmcgdmVyeSB1bmV4cGVjdGVkIHJlc3VsdHMgaWYgYmFzZUFtb3VudCB2ZXJ5CiAgLy8gICAgbGFyZ2UgLSBjYWxsZXIgbXVzdCBjaGVjayB0aGlzLgogIC8vICAtIFRoaXMgcm91bmRzIHRoZSBhbW91bnQgdG93YXJkcyB6ZXJvIChyZWdhcmRsZXNzIG9mIEJ1eSBvciBTZWxsKS4KICAvLyAgLSBNYXkgdHJ1bmNhdGUgdG8gemVybyBpZiBiYXNlQW1vdW50IHZlcnkgc21hbGwgLSBwb3RlbnRpYWxseSBhbGxvd2luZwogIC8vICAgIHplcm8tY29zdCBidXlzIG9yIHBvaW50bGVzcyBzYWxlcyAtIGNhbGxlciBtdXN0IGNoZWNrIHRoaXMuCiAgLy8KICBmdW5jdGlvbiBjb21wdXRlQ250ckFtb3VudFVzaW5nUGFja2VkKAogICAgICB1aW50IGJhc2VBbW91bnQsIHVpbnQxNiBwcmljZQogICAgKSBpbnRlcm5hbCBjb25zdGFudCByZXR1cm5zICh1aW50KSB7CiAgICB2YXIgKCwgbWFudGlzc2EsIGV4cG9uZW50KSA9IHVucGFja1ByaWNlKHByaWNlKTsKICAgIHJldHVybiBjb21wdXRlQ250ckFtb3VudFVzaW5nVW5wYWNrZWQoYmFzZUFtb3VudCwgbWFudGlzc2EsIGV4cG9uZW50KTsKICB9CgogIC8vIFB1YmxpYyBPcmRlciBQbGFjZW1lbnQgLSBjcmVhdGUgb3JkZXIgYW5kIHRyeSB0byBtYXRjaCBpdCBhbmQvb3IgYWRkIGl0IHRvIHRoZSBib29rLgogIC8vCiAgZnVuY3Rpb24gY3JlYXRlT3JkZXIoCiAgICAgIHVpbnQxMjggb3JkZXJJZCwgdWludDE2IHByaWNlLCB1aW50IHNpemVCYXNlLCBUZXJtcyB0ZXJtcywgdWludCBtYXhNYXRjaGVzCiAgICApIHB1YmxpYyB7CiAgICBhZGRyZXNzIGNsaWVudCA9IG1zZy5zZW5kZXI7CiAgICByZXF1aXJlKG9yZGVySWQgIT0gMCAmJiBvcmRlckZvck9yZGVySWRbb3JkZXJJZF0uY2xpZW50ID09IDApOwogICAgQ2xpZW50T3JkZXJFdmVudChjbGllbnQsIENsaWVudE9yZGVyRXZlbnRUeXBlLkNyZWF0ZSwgb3JkZXJJZCwgbWF4TWF0Y2hlcyk7CiAgICBvcmRlckZvck9yZGVySWRbb3JkZXJJZF0gPQogICAgICBPcmRlcihjbGllbnQsIHByaWNlLCBzaXplQmFzZSwgdGVybXMsIFN0YXR1cy5Vbmtub3duLCBSZWFzb25Db2RlLk5vbmUsIDAsIDAsIDAsIDApOwogICAgdWludDEyOCBwcmV2aW91c01vc3RSZWNlbnRPcmRlcklkRm9yQ2xpZW50ID0gbW9zdFJlY2VudE9yZGVySWRGb3JDbGllbnRbY2xpZW50XTsKICAgIG1vc3RSZWNlbnRPcmRlcklkRm9yQ2xpZW50W2NsaWVudF0gPSBvcmRlcklkOwogICAgY2xpZW50UHJldmlvdXNPcmRlcklkQmVmb3JlT3JkZXJJZFtvcmRlcklkXSA9IHByZXZpb3VzTW9zdFJlY2VudE9yZGVySWRGb3JDbGllbnQ7CiAgICBPcmRlciBzdG9yYWdlIG9yZGVyID0gb3JkZXJGb3JPcmRlcklkW29yZGVySWRdOwogICAgdmFyIChkaXJlY3Rpb24sIG1hbnRpc3NhLCBleHBvbmVudCkgPSB1bnBhY2tQcmljZShwcmljZSk7CiAgICBpZiAoZGlyZWN0aW9uID09IERpcmVjdGlvbi5JbnZhbGlkKSB7CiAgICAgIG9yZGVyLnN0YXR1cyA9IFN0YXR1cy5SZWplY3RlZDsKICAgICAgb3JkZXIucmVhc29uQ29kZSA9IFJlYXNvbkNvZGUuSW52YWxpZFByaWNlOwogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAoc2l6ZUJhc2UgPCBiYXNlTWluSW5pdGlhbFNpemUgfHwgc2l6ZUJhc2UgPiBiYXNlTWF4U2l6ZSkgewogICAgICBvcmRlci5zdGF0dXMgPSBTdGF0dXMuUmVqZWN0ZWQ7CiAgICAgIG9yZGVyLnJlYXNvbkNvZGUgPSBSZWFzb25Db2RlLkludmFsaWRTaXplOwogICAgICByZXR1cm47CiAgICB9CiAgICB1aW50IHNpemVDbnRyID0gY29tcHV0ZUNudHJBbW91bnRVc2luZ1VucGFja2VkKHNpemVCYXNlLCBtYW50aXNzYSwgZXhwb25lbnQpOwogICAgaWYgKHNpemVDbnRyIDwgY250ck1pbkluaXRpYWxTaXplIHx8IHNpemVDbnRyID4gY250ck1heFNpemUpIHsKICAgICAgb3JkZXIuc3RhdHVzID0gU3RhdHVzLlJlamVjdGVkOwogICAgICBvcmRlci5yZWFzb25Db2RlID0gUmVhc29uQ29kZS5JbnZhbGlkU2l6ZTsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKHRlcm1zID09IFRlcm1zLk1ha2VyT25seSAmJiBtYXhNYXRjaGVzICE9IDApIHsKICAgICAgb3JkZXIuc3RhdHVzID0gU3RhdHVzLlJlamVjdGVkOwogICAgICBvcmRlci5yZWFzb25Db2RlID0gUmVhc29uQ29kZS5JbnZhbGlkVGVybXM7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmICghZGViaXRGdW5kcyhjbGllbnQsIGRpcmVjdGlvbiwgc2l6ZUJhc2UsIHNpemVDbnRyKSkgewogICAgICBvcmRlci5zdGF0dXMgPSBTdGF0dXMuUmVqZWN0ZWQ7CiAgICAgIG9yZGVyLnJlYXNvbkNvZGUgPSBSZWFzb25Db2RlLkluc3VmZmljaWVudEZ1bmRzOwogICAgICByZXR1cm47CiAgICB9CiAgICBwcm9jZXNzT3JkZXIob3JkZXJJZCwgbWF4TWF0Y2hlcyk7CiAgfQoKICAvLyBQdWJsaWMgT3JkZXIgUGxhY2VtZW50IC0gY2FuY2VsIG9yZGVyCiAgLy8KICBmdW5jdGlvbiBjYW5jZWxPcmRlcih1aW50MTI4IG9yZGVySWQpIHB1YmxpYyB7CiAgICBhZGRyZXNzIGNsaWVudCA9IG1zZy5zZW5kZXI7CiAgICBPcmRlciBzdG9yYWdlIG9yZGVyID0gb3JkZXJGb3JPcmRlcklkW29yZGVySWRdOwogICAgcmVxdWlyZShvcmRlci5jbGllbnQgPT0gY2xpZW50KTsKICAgIFN0YXR1cyBzdGF0dXMgPSBvcmRlci5zdGF0dXM7CiAgICBpZiAoc3RhdHVzICE9IFN0YXR1cy5PcGVuICYmIHN0YXR1cyAhPSBTdGF0dXMuTmVlZHNHYXMpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgQ2xpZW50T3JkZXJFdmVudChjbGllbnQsIENsaWVudE9yZGVyRXZlbnRUeXBlLkNhbmNlbCwgb3JkZXJJZCwgMCk7CiAgICBpZiAoc3RhdHVzID09IFN0YXR1cy5PcGVuKSB7CiAgICAgIHJlbW92ZU9wZW5PcmRlckZyb21Cb29rKG9yZGVySWQpOwogICAgICBNYXJrZXRPcmRlckV2ZW50KGJsb2NrLnRpbWVzdGFtcCwgb3JkZXJJZCwgTWFya2V0T3JkZXJFdmVudFR5cGUuUmVtb3ZlLCBvcmRlci5wcmljZSwKICAgICAgICBvcmRlci5zaXplQmFzZSAtIG9yZGVyLmV4ZWN1dGVkQmFzZSwgMCk7CiAgICB9CiAgICByZWZ1bmRVbm1hdGNoZWRBbmRGaW5pc2gob3JkZXJJZCwgU3RhdHVzLkRvbmUsIFJlYXNvbkNvZGUuQ2xpZW50Q2FuY2VsKTsKICB9CgogIC8vIFB1YmxpYyBPcmRlciBQbGFjZW1lbnQgLSBjb250aW51ZSBwbGFjaW5nIGFuIG9yZGVyIGluICdOZWVkc0dhcycgc3RhdGUKICAvLwogIGZ1bmN0aW9uIGNvbnRpbnVlT3JkZXIodWludDEyOCBvcmRlcklkLCB1aW50IG1heE1hdGNoZXMpIHB1YmxpYyB7CiAgICBhZGRyZXNzIGNsaWVudCA9IG1zZy5zZW5kZXI7CiAgICBPcmRlciBzdG9yYWdlIG9yZGVyID0gb3JkZXJGb3JPcmRlcklkW29yZGVySWRdOwogICAgcmVxdWlyZShvcmRlci5jbGllbnQgPT0gY2xpZW50KTsKICAgIGlmIChvcmRlci5zdGF0dXMgIT0gU3RhdHVzLk5lZWRzR2FzKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIENsaWVudE9yZGVyRXZlbnQoY2xpZW50LCBDbGllbnRPcmRlckV2ZW50VHlwZS5Db250aW51ZSwgb3JkZXJJZCwgbWF4TWF0Y2hlcyk7CiAgICBvcmRlci5zdGF0dXMgPSBTdGF0dXMuVW5rbm93bjsKICAgIHByb2Nlc3NPcmRlcihvcmRlcklkLCBtYXhNYXRjaGVzKTsKICB9CgogIC8vIEludGVybmFsIE9yZGVyIFBsYWNlbWVudCAtIHJlbW92ZSBhIHN0aWxsLW9wZW4gb3JkZXIgZnJvbSB0aGUgYm9vay4KICAvLwogIC8vIENhbGxlcidzIGpvYiB0byB1cGRhdGUvcmVmdW5kIHRoZSBvcmRlciArIHJhaXNlIGV2ZW50LCB0aGlzIGp1c3QKICAvLyB1cGRhdGVzIHRoZSBvcmRlciBjaGFpbiBhbmQgYml0bWFzay4KICAvLwogIC8vIFRvbyBleHBlbnNpdmUgdG8gZG8gb24gZWFjaCByZXN0aW5nIG9yZGVyIG1hdGNoIC0gd2Ugb25seSBkbyB0aGlzIGZvciBhbgogIC8vIG9yZGVyIGJlaW5nIGNhbmNlbGxlZC4gU2VlIG1hdGNoV2l0aE9jY3VwaWVkUHJpY2UgZm9yIHNpbWlsYXIgbG9naWMuCiAgLy8KICBmdW5jdGlvbiByZW1vdmVPcGVuT3JkZXJGcm9tQm9vayh1aW50MTI4IG9yZGVySWQpIGludGVybmFsIHsKICAgIE9yZGVyIHN0b3JhZ2Ugb3JkZXIgPSBvcmRlckZvck9yZGVySWRbb3JkZXJJZF07CiAgICB1aW50MTYgcHJpY2UgPSBvcmRlci5wcmljZTsKICAgIE9yZGVyQ2hhaW4gc3RvcmFnZSBvcmRlckNoYWluID0gb3JkZXJDaGFpbkZvck9jY3VwaWVkUHJpY2VbcHJpY2VdOwogICAgT3JkZXJDaGFpbk5vZGUgc3RvcmFnZSBvcmRlckNoYWluTm9kZSA9IG9yZGVyQ2hhaW5Ob2RlRm9yT3Blbk9yZGVySWRbb3JkZXJJZF07CiAgICB1aW50MTI4IG5leHRPcmRlcklkID0gb3JkZXJDaGFpbk5vZGUubmV4dE9yZGVySWQ7CiAgICB1aW50MTI4IHByZXZPcmRlcklkID0gb3JkZXJDaGFpbk5vZGUucHJldk9yZGVySWQ7CiAgICBpZiAobmV4dE9yZGVySWQgIT0gMCkgewogICAgICBPcmRlckNoYWluTm9kZSBzdG9yYWdlIG5leHRPcmRlckNoYWluTm9kZSA9IG9yZGVyQ2hhaW5Ob2RlRm9yT3Blbk9yZGVySWRbbmV4dE9yZGVySWRdOwogICAgICBuZXh0T3JkZXJDaGFpbk5vZGUucHJldk9yZGVySWQgPSBwcmV2T3JkZXJJZDsKICAgIH0gZWxzZSB7CiAgICAgIG9yZGVyQ2hhaW4ubGFzdE9yZGVySWQgPSBwcmV2T3JkZXJJZDsKICAgIH0KICAgIGlmIChwcmV2T3JkZXJJZCAhPSAwKSB7CiAgICAgIE9yZGVyQ2hhaW5Ob2RlIHN0b3JhZ2UgcHJldk9yZGVyQ2hhaW5Ob2RlID0gb3JkZXJDaGFpbk5vZGVGb3JPcGVuT3JkZXJJZFtwcmV2T3JkZXJJZF07CiAgICAgIHByZXZPcmRlckNoYWluTm9kZS5uZXh0T3JkZXJJZCA9IG5leHRPcmRlcklkOwogICAgfSBlbHNlIHsKICAgICAgb3JkZXJDaGFpbi5maXJzdE9yZGVySWQgPSBuZXh0T3JkZXJJZDsKICAgIH0KICAgIGlmIChuZXh0T3JkZXJJZCA9PSAwICYmIHByZXZPcmRlcklkID09IDApIHsKICAgICAgdWludCBibWkgPSBwcmljZSAvIDI1NjsgIC8vIGluZGV4IGludG8gYXJyYXkgb2YgYml0bWFwcwogICAgICB1aW50IGJ0aSA9IHByaWNlICUgMjU2OyAgLy8gYml0IHBvc2l0aW9uIHdpdGhpbiBiaXRtYXAKICAgICAgLy8gd2Uga25vdyB3YXMgcHJldmlvdXNseSBvY2N1cGllZCBzbyBYT1IgY2xlYXJzCiAgICAgIG9jY3VwaWVkUHJpY2VCaXRtYXBzW2JtaV0gXj0gMiAqKiBidGk7CiAgICB9CiAgfQoKICAvLyBJbnRlcm5hbCBPcmRlciBQbGFjZW1lbnQgLSBjcmVkaXQgZnVuZHMgcmVjZWl2ZWQgd2hlbiB0YWtpbmcgbGlxdWlkaXR5IGZyb20gYm9vawogIC8vCiAgZnVuY3Rpb24gY3JlZGl0RXhlY3V0ZWRGdW5kc0xlc3NGZWVzKHVpbnQxMjggb3JkZXJJZCwgdWludCBvcmlnaW5hbEV4ZWN1dGVkQmFzZSwgdWludCBvcmlnaW5hbEV4ZWN1dGVkQ250cikgaW50ZXJuYWwgewogICAgT3JkZXIgc3RvcmFnZSBvcmRlciA9IG9yZGVyRm9yT3JkZXJJZFtvcmRlcklkXTsKICAgIHVpbnQgbGlxdWlkaXR5VGFrZW5CYXNlID0gb3JkZXIuZXhlY3V0ZWRCYXNlIC0gb3JpZ2luYWxFeGVjdXRlZEJhc2U7CiAgICB1aW50IGxpcXVpZGl0eVRha2VuQ250ciA9IG9yZGVyLmV4ZWN1dGVkQ250ciAtIG9yaWdpbmFsRXhlY3V0ZWRDbnRyOwogICAgLy8gTm9ybWFsbHkgd2UgZGVkdWN0IHRoZSBmZWUgZnJvbSB0aGUgY3VycmVuY3kgYm91Z2h0IChiYXNlIGZvciBidXksIGNudHIgZm9yIHNlbGwpLAogICAgLy8gaG93ZXZlciB3ZSBhbHNvIGFjY2VwdCByZXdhcmQgdG9rZW5zIGZyb20gdGhlIHJld2FyZCBiYWxhbmNlIGlmIGl0IGNvdmVycyB0aGUgZmVlLAogICAgLy8gd2l0aCB0aGUgcmV3YXJkIGFtb3VudCBjb252ZXJ0ZWQgZnJvbSB0aGUgRVRIIGFtb3VudCAodGhlIGNvdW50ZXIgY3VycmVuY3kgaGVyZSkKICAgIC8vIGF0IGEgZml4ZWQgZXhjaGFuZ2UgcmF0ZS4KICAgIC8vIE92ZXJmbG93IHNhZmUgc2luY2Ugd2UgZW5zdXJlIG9yZGVyIHNpemUgPCAxMF4zMCBpbiBib3RoIGN1cnJlbmNpZXMgKHNlZSBiYXNlTWF4U2l6ZSkuCiAgICAvLyBDYW4gdHJ1bmNhdGUgdG8gemVybywgd2hpY2ggaXMgZmluZS4KICAgIHVpbnQgZmVlc1J3cmQgPSBsaXF1aWRpdHlUYWtlbkNudHIgLyBmZWVEaXZpc29yICogZXRoUndyZFJhdGU7CiAgICB1aW50IGZlZXNCYXNlT3JDbnRyOwogICAgYWRkcmVzcyBjbGllbnQgPSBvcmRlci5jbGllbnQ7CiAgICB1aW50IGF2YWlsUndyZCA9IGJhbGFuY2VSd3JkRm9yQ2xpZW50W2NsaWVudF07CiAgICBpZiAoZmVlc1J3cmQgPD0gYXZhaWxSd3JkKSB7CiAgICAgIGJhbGFuY2VSd3JkRm9yQ2xpZW50W2NsaWVudF0gPSBhdmFpbFJ3cmQgLSBmZWVzUndyZDsKICAgICAgYmFsYW5jZVJ3cmRGb3JDbGllbnRbZmVlQ29sbGVjdG9yXSA9IGZlZXNSd3JkOwogICAgICAvLyBOZWVkICs9IHJhdGhlciB0aGFuID0gYmVjYXVzZSBjb3VsZCBoYXZlIHBhaWQgc29tZSBmZWVzIGVhcmxpZXIgaW4gTmVlZHNHYXMgc2l0dWF0aW9uLgogICAgICAvLyBPdmVyZmxvdyBzYWZlIHNpbmNlIHdlIGVuc3VyZSBvcmRlciBzaXplIDwgMTBeMzAgaW4gYm90aCBjdXJyZW5jaWVzIChzZWUgYmFzZU1heFNpemUpLgogICAgICAvLyBDYW4gdHJ1bmNhdGUgdG8gemVybywgd2hpY2ggaXMgZmluZS4KICAgICAgb3JkZXIuZmVlc1J3cmQgKz0gdWludDEyOChmZWVzUndyZCk7CiAgICAgIGlmIChpc0J1eVByaWNlKG9yZGVyLnByaWNlKSkgewogICAgICAgIGJhbGFuY2VCYXNlRm9yQ2xpZW50W2NsaWVudF0gKz0gbGlxdWlkaXR5VGFrZW5CYXNlOwogICAgICB9IGVsc2UgewogICAgICAgIGJhbGFuY2VDbnRyRm9yQ2xpZW50W2NsaWVudF0gKz0gbGlxdWlkaXR5VGFrZW5DbnRyOwogICAgICB9CiAgICB9IGVsc2UgaWYgKGlzQnV5UHJpY2Uob3JkZXIucHJpY2UpKSB7CiAgICAgIC8vIFNlZSBjb21tZW50cyBpbiBicmFuY2ggYWJvdmUgcmU6IHVzZSBvZiArPSBhbmQgb3ZlcmZsb3cgc2FmZXR5LgogICAgICBmZWVzQmFzZU9yQ250ciA9IGxpcXVpZGl0eVRha2VuQmFzZSAvIGZlZURpdmlzb3I7CiAgICAgIGJhbGFuY2VCYXNlRm9yQ2xpZW50W29yZGVyLmNsaWVudF0gKz0gKGxpcXVpZGl0eVRha2VuQmFzZSAtIGZlZXNCYXNlT3JDbnRyKTsKICAgICAgb3JkZXIuZmVlc0Jhc2VPckNudHIgKz0gdWludDEyOChmZWVzQmFzZU9yQ250cik7CiAgICAgIGJhbGFuY2VCYXNlRm9yQ2xpZW50W2ZlZUNvbGxlY3Rvcl0gKz0gZmVlc0Jhc2VPckNudHI7CiAgICB9IGVsc2UgewogICAgICAvLyBTZWUgY29tbWVudHMgaW4gYnJhbmNoIGFib3ZlIHJlOiB1c2Ugb2YgKz0gYW5kIG92ZXJmbG93IHNhZmV0eS4KICAgICAgZmVlc0Jhc2VPckNudHIgPSBsaXF1aWRpdHlUYWtlbkNudHIgLyBmZWVEaXZpc29yOwogICAgICBiYWxhbmNlQ250ckZvckNsaWVudFtvcmRlci5jbGllbnRdICs9IChsaXF1aWRpdHlUYWtlbkNudHIgLSBmZWVzQmFzZU9yQ250cik7CiAgICAgIG9yZGVyLmZlZXNCYXNlT3JDbnRyICs9IHVpbnQxMjgoZmVlc0Jhc2VPckNudHIpOwogICAgICBiYWxhbmNlQ250ckZvckNsaWVudFtmZWVDb2xsZWN0b3JdICs9IGZlZXNCYXNlT3JDbnRyOwogICAgfQogIH0KCiAgLy8gSW50ZXJuYWwgT3JkZXIgUGxhY2VtZW50IC0gcHJvY2VzcyBhIGNyZWF0ZWQgYW5kIHNhbml0eSBjaGVja2VkIG9yZGVyLgogIC8vCiAgLy8gVXNlZCBib3RoIGZvciBuZXcgb3JkZXJzIGFuZCBmb3IgZ2FzIHRvcHVwLgogIC8vCiAgZnVuY3Rpb24gcHJvY2Vzc09yZGVyKHVpbnQxMjggb3JkZXJJZCwgdWludCBtYXhNYXRjaGVzKSBpbnRlcm5hbCB7CiAgICBPcmRlciBzdG9yYWdlIG9yZGVyID0gb3JkZXJGb3JPcmRlcklkW29yZGVySWRdOwoKICAgIHVpbnQgb3VyT3JpZ2luYWxFeGVjdXRlZEJhc2UgPSBvcmRlci5leGVjdXRlZEJhc2U7CiAgICB1aW50IG91ck9yaWdpbmFsRXhlY3V0ZWRDbnRyID0gb3JkZXIuZXhlY3V0ZWRDbnRyOwoKICAgIHZhciAob3VyRGlyZWN0aW9uLCkgPSB1bnBhY2tQcmljZShvcmRlci5wcmljZSk7CiAgICB1aW50IHRoZWlyUHJpY2VTdGFydCA9IChvdXJEaXJlY3Rpb24gPT0gRGlyZWN0aW9uLkJ1eSkgPyBtaW5TZWxsUHJpY2UgOiBtYXhCdXlQcmljZTsKICAgIHVpbnQgdGhlaXJQcmljZUVuZCA9IGNvbXB1dGVPcHBvc2l0ZVByaWNlKG9yZGVyLnByaWNlKTsKICAgCiAgICBNYXRjaFN0b3BSZWFzb24gbWF0Y2hTdG9wUmVhc29uID0KICAgICAgbWF0Y2hBZ2FpbnN0Qm9vayhvcmRlcklkLCB0aGVpclByaWNlU3RhcnQsIHRoZWlyUHJpY2VFbmQsIG1heE1hdGNoZXMpOwoKICAgIGNyZWRpdEV4ZWN1dGVkRnVuZHNMZXNzRmVlcyhvcmRlcklkLCBvdXJPcmlnaW5hbEV4ZWN1dGVkQmFzZSwgb3VyT3JpZ2luYWxFeGVjdXRlZENudHIpOwoKICAgIGlmIChvcmRlci50ZXJtcyA9PSBUZXJtcy5JbW1lZGlhdGVPckNhbmNlbCkgewogICAgICBpZiAobWF0Y2hTdG9wUmVhc29uID09IE1hdGNoU3RvcFJlYXNvbi5TYXRpc2ZpZWQpIHsKICAgICAgICByZWZ1bmRVbm1hdGNoZWRBbmRGaW5pc2gob3JkZXJJZCwgU3RhdHVzLkRvbmUsIFJlYXNvbkNvZGUuTm9uZSk7CiAgICAgICAgcmV0dXJuOwogICAgICB9IGVsc2UgaWYgKG1hdGNoU3RvcFJlYXNvbiA9PSBNYXRjaFN0b3BSZWFzb24uTWF4TWF0Y2hlcykgewogICAgICAgIHJlZnVuZFVubWF0Y2hlZEFuZEZpbmlzaChvcmRlcklkLCBTdGF0dXMuRG9uZSwgUmVhc29uQ29kZS5Ub29NYW55TWF0Y2hlcyk7CiAgICAgICAgcmV0dXJuOwogICAgICB9IGVsc2UgaWYgKG1hdGNoU3RvcFJlYXNvbiA9PSBNYXRjaFN0b3BSZWFzb24uQm9va0V4aGF1c3RlZCkgewogICAgICAgIHJlZnVuZFVubWF0Y2hlZEFuZEZpbmlzaChvcmRlcklkLCBTdGF0dXMuRG9uZSwgUmVhc29uQ29kZS5Vbm1hdGNoZWQpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgfSBlbHNlIGlmIChvcmRlci50ZXJtcyA9PSBUZXJtcy5NYWtlck9ubHkpIHsKICAgICAgaWYgKG1hdGNoU3RvcFJlYXNvbiA9PSBNYXRjaFN0b3BSZWFzb24uTWF4TWF0Y2hlcykgewogICAgICAgIHJlZnVuZFVubWF0Y2hlZEFuZEZpbmlzaChvcmRlcklkLCBTdGF0dXMuUmVqZWN0ZWQsIFJlYXNvbkNvZGUuV291bGRUYWtlKTsKICAgICAgICByZXR1cm47CiAgICAgIH0gZWxzZSBpZiAobWF0Y2hTdG9wUmVhc29uID09IE1hdGNoU3RvcFJlYXNvbi5Cb29rRXhoYXVzdGVkKSB7CiAgICAgICAgZW50ZXJPcmRlcihvcmRlcklkKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgIH0gZWxzZSBpZiAob3JkZXIudGVybXMgPT0gVGVybXMuR1RDTm9HYXNUb3B1cCkgewogICAgICBpZiAobWF0Y2hTdG9wUmVhc29uID09IE1hdGNoU3RvcFJlYXNvbi5TYXRpc2ZpZWQpIHsKICAgICAgICByZWZ1bmRVbm1hdGNoZWRBbmRGaW5pc2gob3JkZXJJZCwgU3RhdHVzLkRvbmUsIFJlYXNvbkNvZGUuTm9uZSk7CiAgICAgICAgcmV0dXJuOwogICAgICB9IGVsc2UgaWYgKG1hdGNoU3RvcFJlYXNvbiA9PSBNYXRjaFN0b3BSZWFzb24uTWF4TWF0Y2hlcykgewogICAgICAgIHJlZnVuZFVubWF0Y2hlZEFuZEZpbmlzaChvcmRlcklkLCBTdGF0dXMuRG9uZSwgUmVhc29uQ29kZS5Ub29NYW55TWF0Y2hlcyk7CiAgICAgICAgcmV0dXJuOwogICAgICB9IGVsc2UgaWYgKG1hdGNoU3RvcFJlYXNvbiA9PSBNYXRjaFN0b3BSZWFzb24uQm9va0V4aGF1c3RlZCkgewogICAgICAgIGVudGVyT3JkZXIob3JkZXJJZCk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICB9IGVsc2UgaWYgKG9yZGVyLnRlcm1zID09IFRlcm1zLkdUQ1dpdGhHYXNUb3B1cCkgewogICAgICBpZiAobWF0Y2hTdG9wUmVhc29uID09IE1hdGNoU3RvcFJlYXNvbi5TYXRpc2ZpZWQpIHsKICAgICAgICByZWZ1bmRVbm1hdGNoZWRBbmRGaW5pc2gob3JkZXJJZCwgU3RhdHVzLkRvbmUsIFJlYXNvbkNvZGUuTm9uZSk7CiAgICAgICAgcmV0dXJuOwogICAgICB9IGVsc2UgaWYgKG1hdGNoU3RvcFJlYXNvbiA9PSBNYXRjaFN0b3BSZWFzb24uTWF4TWF0Y2hlcykgewogICAgICAgIG9yZGVyLnN0YXR1cyA9IFN0YXR1cy5OZWVkc0dhczsKICAgICAgICByZXR1cm47CiAgICAgIH0gZWxzZSBpZiAobWF0Y2hTdG9wUmVhc29uID09IE1hdGNoU3RvcFJlYXNvbi5Cb29rRXhoYXVzdGVkKSB7CiAgICAgICAgZW50ZXJPcmRlcihvcmRlcklkKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgIH0KICAgIGFzc2VydChmYWxzZSk7IC8vIHNob3VsZCBub3QgYmUgcG9zc2libGUgdG8gcmVhY2ggaGVyZQogIH0KIAogIC8vIFVzZWQgaW50ZXJuYWxseSB0byBpbmRpY2F0ZSB3aHkgd2Ugc3RvcHBlZCBtYXRjaGluZyBhbiBvcmRlciBhZ2FpbnN0IHRoZSBib29rLgoKICBlbnVtIE1hdGNoU3RvcFJlYXNvbiB7CiAgICBOb25lLAogICAgTWF4TWF0Y2hlcywKICAgIFNhdGlzZmllZCwKICAgIFByaWNlRXhoYXVzdGVkLAogICAgQm9va0V4aGF1c3RlZAogIH0KIAogIC8vIEludGVybmFsIE9yZGVyIFBsYWNlbWVudCAtIE1hdGNoIHRoZSBnaXZlbiBvcmRlciBhZ2FpbnN0IHRoZSBib29rLgogIC8vCiAgLy8gUmVzdGluZyBvcmRlcnMgbWF0Y2hlZCB3aWxsIGJlIHVwZGF0ZWQsIHJlbW92ZWQgZnJvbSBib29rIGFuZCBmdW5kcyBjcmVkaXRlZCB0byB0aGVpciBvd25lcnMuCiAgLy8KICAvLyBPbmx5IHVwZGF0ZXMgdGhlIGV4ZWN1dGVkQmFzZSBhbmQgZXhlY3V0ZWRDbnRyIG9mIHRoZSBnaXZlbiBvcmRlciAtIGNhbGxlciBpcyByZXNwb25zaWJsZQogIC8vIGZvciBjcmVkaXRpbmcgbWF0Y2hlZCBmdW5kcywgY2hhcmdpbmcgZmVlcywgbWFya2luZyBvcmRlciBhcyBkb25lIC8gZW50ZXJpbmcgaXQgaW50byB0aGUgYm9vay4KICAvLwogIC8vIG1hdGNoU3RvcFJlYXNvbiByZXR1cm5lZCB3aWxsIGJlIG9uZSBvZiBNYXhNYXRjaGVzLCBTYXRpc2ZpZWQgb3IgQm9va0V4aGF1c3RlZC4KICAvLwogIC8vIENhbGxpbmcgd2l0aCBtYXhNYXRjaGVzID09IDAgaXMgb2sgLSBhbmQgZXhwZWN0ZWQgd2hlbiB0aGUgb3JkZXIgaXMgYSBtYWtlci1vbmx5IG9yZGVyLgogIC8vCiAgZnVuY3Rpb24gbWF0Y2hBZ2FpbnN0Qm9vaygKICAgICAgdWludDEyOCBvcmRlcklkLCB1aW50IHRoZWlyUHJpY2VTdGFydCwgdWludCB0aGVpclByaWNlRW5kLCB1aW50IG1heE1hdGNoZXMKICAgICkgaW50ZXJuYWwgcmV0dXJucyAoCiAgICAgIE1hdGNoU3RvcFJlYXNvbiBtYXRjaFN0b3BSZWFzb24KICAgICkgewogICAgT3JkZXIgc3RvcmFnZSBvcmRlciA9IG9yZGVyRm9yT3JkZXJJZFtvcmRlcklkXTsKICAgIAogICAgdWludCBibWkgPSB0aGVpclByaWNlU3RhcnQgLyAyNTY7ICAvLyBpbmRleCBpbnRvIGFycmF5IG9mIGJpdG1hcHMKICAgIHVpbnQgYnRpID0gdGhlaXJQcmljZVN0YXJ0ICUgMjU2OyAgLy8gYml0IHBvc2l0aW9uIHdpdGhpbiBiaXRtYXAKICAgIHVpbnQgYm1pRW5kID0gdGhlaXJQcmljZUVuZCAvIDI1NjsgLy8gbGFzdCBiaXRtYXAgdG8gc2VhcmNoCiAgICB1aW50IGJ0aUVuZCA9IHRoZWlyUHJpY2VFbmQgJSAyNTY7IC8vIHN0b3AgYXQgdGhpcyBiaXQgaW4gdGhlIGxhc3QgYml0bWFwCgogICAgdWludCBjYm0gPSBvY2N1cGllZFByaWNlQml0bWFwc1tibWldOyAvLyBvcmlnaW5hbCBjb3B5IG9mIGN1cnJlbnQgYml0bWFwCiAgICB1aW50IGRibSA9IGNibTsgLy8gZGlydHkgdmVyc2lvbiBvZiBjdXJyZW50IGJpdG1hcCB3aGVyZSB3ZSBtYXkgaGF2ZSBjbGVhcmVkIGJpdHMKICAgIHVpbnQgd2JtID0gY2JtID4+IGJ0aTsgLy8gd29ya2luZyBjb3B5IG9mIGN1cnJlbnQgYml0bWFwIHdoaWNoIHdlIGtlZXAgc2hpZnRpbmcKICAgIAogICAgLy8gdGhlc2UgbG9vcHMgYXJlIHByZXR0eSB1Z2x5LCBhbmQgc29tZXdoYXQgdW5wcmVkaWNhdGFibGUgaW4gdGVybXMgb2YgZ2FzLAogICAgLy8gLi4uIGJ1dCBuby1vbmUgZWxzZSBoYXMgY29tZSB1cCB3aXRoIGEgYmV0dGVyIG1hdGNoaW5nIGVuZ2luZSB5ZXQhCgogICAgYm9vbCByZW1vdmVkTGFzdEF0UHJpY2U7CiAgICBtYXRjaFN0b3BSZWFzb24gPSBNYXRjaFN0b3BSZWFzb24uTm9uZTsKCiAgICB3aGlsZSAoYm1pIDwgYm1pRW5kKSB7CiAgICAgIGlmICh3Ym0gPT0gMCB8fCBidGkgPT0gMjU2KSB7CiAgICAgICAgaWYgKGRibSAhPSBjYm0pIHsKICAgICAgICAgIG9jY3VwaWVkUHJpY2VCaXRtYXBzW2JtaV0gPSBkYm07CiAgICAgICAgfQogICAgICAgIGJ0aSA9IDA7CiAgICAgICAgYm1pKys7CiAgICAgICAgY2JtID0gb2NjdXBpZWRQcmljZUJpdG1hcHNbYm1pXTsKICAgICAgICB3Ym0gPSBjYm07CiAgICAgICAgZGJtID0gY2JtOwogICAgICB9IGVsc2UgewogICAgICAgIGlmICgod2JtICYgMSkgIT0gMCkgewogICAgICAgICAgLy8gY2FyZWZ1bCAtIGNvcHktYW5kLXBhc3RlZCBpbiBsb29wIGJlbG93IC4uLgogICAgICAgICAgKHJlbW92ZWRMYXN0QXRQcmljZSwgbWF4TWF0Y2hlcywgbWF0Y2hTdG9wUmVhc29uKSA9CiAgICAgICAgICAgIG1hdGNoV2l0aE9jY3VwaWVkUHJpY2Uob3JkZXIsIHVpbnQxNihibWkgKiAyNTYgKyBidGkpLCBtYXhNYXRjaGVzKTsKICAgICAgICAgIGlmIChyZW1vdmVkTGFzdEF0UHJpY2UpIHsKICAgICAgICAgICAgZGJtIF49IDIgKiogYnRpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKG1hdGNoU3RvcFJlYXNvbiA9PSBNYXRjaFN0b3BSZWFzb24uUHJpY2VFeGhhdXN0ZWQpIHsKICAgICAgICAgICAgbWF0Y2hTdG9wUmVhc29uID0gTWF0Y2hTdG9wUmVhc29uLk5vbmU7CiAgICAgICAgICB9IGVsc2UgaWYgKG1hdGNoU3RvcFJlYXNvbiAhPSBNYXRjaFN0b3BSZWFzb24uTm9uZSkgewogICAgICAgICAgICAvLyB3ZSBtaWdodCBzdGlsbCBoYXZlIGNoYW5nZXMgaW4gZGJtIHRvIHdyaXRlIGJhY2sgLSBzZWUgbGF0ZXIKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGJ0aSArPSAxOwogICAgICAgIHdibSAvPSAyOwogICAgICB9CiAgICB9CiAgICBpZiAobWF0Y2hTdG9wUmVhc29uID09IE1hdGNoU3RvcFJlYXNvbi5Ob25lKSB7CiAgICAgIC8vIHdlJ3ZlIHJlYWNoZWQgdGhlIGxhc3QgYml0bWFwIHdlIG5lZWQgdG8gc2VhcmNoLAogICAgICAvLyB3ZSdsbCBzdG9wIGF0IGJ0aUVuZCBub3QgMjU2IHRoaXMgdGltZS4KICAgICAgd2hpbGUgKGJ0aSA8PSBidGlFbmQgJiYgd2JtICE9IDApIHsKICAgICAgICBpZiAoKHdibSAmIDEpICE9IDApIHsKICAgICAgICAgIC8vIGNhcmVmdWwgLSBjb3B5LWFuZC1wYXN0ZWQgaW4gbG9vcCBhYm92ZSAuLi4KICAgICAgICAgIChyZW1vdmVkTGFzdEF0UHJpY2UsIG1heE1hdGNoZXMsIG1hdGNoU3RvcFJlYXNvbikgPQogICAgICAgICAgICBtYXRjaFdpdGhPY2N1cGllZFByaWNlKG9yZGVyLCB1aW50MTYoYm1pICogMjU2ICsgYnRpKSwgbWF4TWF0Y2hlcyk7CiAgICAgICAgICBpZiAocmVtb3ZlZExhc3RBdFByaWNlKSB7CiAgICAgICAgICAgIGRibSBePSAyICoqIGJ0aTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChtYXRjaFN0b3BSZWFzb24gPT0gTWF0Y2hTdG9wUmVhc29uLlByaWNlRXhoYXVzdGVkKSB7CiAgICAgICAgICAgIG1hdGNoU3RvcFJlYXNvbiA9IE1hdGNoU3RvcFJlYXNvbi5Ob25lOwogICAgICAgICAgfSBlbHNlIGlmIChtYXRjaFN0b3BSZWFzb24gIT0gTWF0Y2hTdG9wUmVhc29uLk5vbmUpIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGJ0aSArPSAxOwogICAgICAgIHdibSAvPSAyOwogICAgICB9CiAgICB9CiAgICAvLyBDYXJlZnVsIC0gaWYgd2UgZXhpdGVkIHRoZSBmaXJzdCBsb29wIGVhcmx5LCBvciB3ZSB3ZW50IGludG8gdGhlIHNlY29uZCBsb29wLAogICAgLy8gKGx1Y2tpbHkgY2FuJ3QgYm90aCBoYXBwZW4pIHRoZW4gd2UgaGF2ZW4ndCBmbHVzaGVkIHRoZSBkaXJ0eSBiaXRtYXAgYmFjayB0bwogICAgLy8gc3RvcmFnZSAtIGRvIHRoYXQgbm93IGlmIHdlIG5lZWQgdG8uCiAgICBpZiAoZGJtICE9IGNibSkgewogICAgICBvY2N1cGllZFByaWNlQml0bWFwc1tibWldID0gZGJtOwogICAgfQogICAgaWYgKG1hdGNoU3RvcFJlYXNvbiA9PSBNYXRjaFN0b3BSZWFzb24uTm9uZSkgewogICAgICBtYXRjaFN0b3BSZWFzb24gPSBNYXRjaFN0b3BSZWFzb24uQm9va0V4aGF1c3RlZDsKICAgIH0KICB9CgogIC8vIEludGVybmFsIE9yZGVyIFBsYWNlbWVudC4KICAvLwogIC8vIE1hdGNoIG91ciBvcmRlciBhZ2FpbnN0IHVwIHRvIG1heE1hdGNoZXMgcmVzdGluZyBvcmRlcnMgYXQgdGhlIGdpdmVuIHByaWNlICh3aGljaAogIC8vIGlzIGtub3duIGJ5IHRoZSBjYWxsZXIgdG8gaGF2ZSBhdCBsZWFzdCBvbmUgcmVzdGluZyBvcmRlcikuCiAgLy8KICAvLyBUaGUgbWF0Y2hlcyAocGFydGlhbCBvciBjb21wbGV0ZSkgb2YgdGhlIHJlc3Rpbmcgb3JkZXJzIGFyZSByZWNvcmRlZCwgYW5kIHRoZWlyCiAgLy8gZnVuZHMgYXJlIGNyZWRpdGVkLgogIC8vCiAgLy8gVGhlIG9yZGVyIGNoYWluIGZvciB0aGUgcmVzdGluZyBvcmRlcnMgaXMgdXBkYXRlZCwgYnV0IHRoZSBvY2N1cGllZCBwcmljZSBiaXRtYXAgaXMgTk9UIC0KICAvLyB0aGUgY2FsbGVyIG11c3QgY2xlYXIgdGhlIHJlbGV2YW50IGJpdCBpZiByZW1vdmVkTGFzdEF0UHJpY2UgPSB0cnVlIGlzIHJldHVybmVkLgogIC8vCiAgLy8gT25seSB1cGRhdGVzIHRoZSBleGVjdXRlZEJhc2UgYW5kIGV4ZWN1dGVkQ250ciBvZiBvdXIgb3JkZXIgLSBjYWxsZXIgaXMgcmVzcG9uc2libGUKICAvLyBmb3IgZS5nLiBjcmVkaXRpbmcgb3VyIG1hdGNoZWQgZnVuZHMsIHVwZGF0aW5nIHN0YXR1cy4KICAvLwogIC8vIENhbGxpbmcgd2l0aCBtYXhNYXRjaGVzID09IDAgaXMgb2sgLSBhbmQgZXhwZWN0ZWQgd2hlbiB0aGUgb3JkZXIgaXMgYSBtYWtlci1vbmx5IG9yZGVyLgogIC8vCiAgLy8gUmV0dXJuczoKICAvLyAgIHJlbW92ZWRMYXN0QXRQcmljZToKICAvLyAgICAgdHJ1ZSBpZmYgdGhlcmUgYXJlIG5vIGxvbmdlciBhbnkgcmVzdGluZyBvcmRlcnMgYXQgdGhpcyBwcmljZSAtIGNhbGxlciB3aWxsIG5lZWQKICAvLyAgICAgdG8gdXBkYXRlIHRoZSBvY2N1cGllZCBwcmljZSBiaXRtYXAuCiAgLy8KICAvLyAgIG1hdGNoZXNMZWZ0OgogIC8vICAgICBtYXhNYXRjaGVzIHBhc3NlZCBpbiBtaW51cyB0aGUgbnVtYmVyIG9mIG1hdGNoZXMgbWFkZSBieSB0aGlzIGNhbGwKICAvLwogIC8vICAgbWF0Y2hTdG9wUmVhc29uOgogIC8vICAgICBJZiBvdXIgb3JkZXIgaXMgY29tcGxldGVseSBtYXRjaGVkLCBtYXRjaFN0b3BSZWFzb24gd2lsbCBiZSBTYXRpc2ZpZWQuCiAgLy8gICAgIElmIG91ciBvcmRlciBpcyBub3QgY29tcGxldGVseSBtYXRjaGVkLCBtYXRjaFN0b3BSZWFzb24gd2lsbCBiZSBlaXRoZXI6CiAgLy8gICAgICAgIE1heE1hdGNoZXMgKHdlIGFyZSBub3QgYWxsb3dlZCB0byBtYXRjaCBhbnkgbW9yZSB0aW1lcykKICAvLyAgICAgb3I6CiAgLy8gICAgICAgIFByaWNlRXhoYXVzdGVkIChub3RoaW5nIGxlZnQgb24gdGhlIGJvb2sgYXQgdGhpcyBleGFjdCBwcmljZSkKICAvLwogIGZ1bmN0aW9uIG1hdGNoV2l0aE9jY3VwaWVkUHJpY2UoCiAgICAgIE9yZGVyIHN0b3JhZ2Ugb3VyT3JkZXIsIHVpbnQxNiB0aGVpclByaWNlLCB1aW50IG1heE1hdGNoZXMKICAgICkgaW50ZXJuYWwgcmV0dXJucyAoCiAgICBib29sIHJlbW92ZWRMYXN0QXRQcmljZSwgdWludCBtYXRjaGVzTGVmdCwgTWF0Y2hTdG9wUmVhc29uIG1hdGNoU3RvcFJlYXNvbikgewogICAgbWF0Y2hlc0xlZnQgPSBtYXhNYXRjaGVzOwogICAgdWludCB3b3JraW5nT3VyRXhlY3V0ZWRCYXNlID0gb3VyT3JkZXIuZXhlY3V0ZWRCYXNlOwogICAgdWludCB3b3JraW5nT3VyRXhlY3V0ZWRDbnRyID0gb3VyT3JkZXIuZXhlY3V0ZWRDbnRyOwogICAgdWludDEyOCB0aGVpck9yZGVySWQgPSBvcmRlckNoYWluRm9yT2NjdXBpZWRQcmljZVt0aGVpclByaWNlXS5maXJzdE9yZGVySWQ7CiAgICBtYXRjaFN0b3BSZWFzb24gPSBNYXRjaFN0b3BSZWFzb24uTm9uZTsKICAgIHdoaWxlICh0cnVlKSB7CiAgICAgIGlmIChtYXRjaGVzTGVmdCA9PSAwKSB7CiAgICAgICAgbWF0Y2hTdG9wUmVhc29uID0gTWF0Y2hTdG9wUmVhc29uLk1heE1hdGNoZXM7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgICAgdWludCBtYXRjaEJhc2U7CiAgICAgIHVpbnQgbWF0Y2hDbnRyOwogICAgICAodGhlaXJPcmRlcklkLCBtYXRjaEJhc2UsIG1hdGNoQ250ciwgbWF0Y2hTdG9wUmVhc29uKSA9CiAgICAgICAgbWF0Y2hXaXRoVGhlaXJzKChvdXJPcmRlci5zaXplQmFzZSAtIHdvcmtpbmdPdXJFeGVjdXRlZEJhc2UpLCB0aGVpck9yZGVySWQsIHRoZWlyUHJpY2UpOwogICAgICB3b3JraW5nT3VyRXhlY3V0ZWRCYXNlICs9IG1hdGNoQmFzZTsKICAgICAgd29ya2luZ091ckV4ZWN1dGVkQ250ciArPSBtYXRjaENudHI7CiAgICAgIG1hdGNoZXNMZWZ0IC09IDE7CiAgICAgIGlmIChtYXRjaFN0b3BSZWFzb24gIT0gTWF0Y2hTdG9wUmVhc29uLk5vbmUpIHsKICAgICAgICBicmVhazsKICAgICAgfQogICAgfQogICAgb3VyT3JkZXIuZXhlY3V0ZWRCYXNlID0gdWludDEyOCh3b3JraW5nT3VyRXhlY3V0ZWRCYXNlKTsKICAgIG91ck9yZGVyLmV4ZWN1dGVkQ250ciA9IHVpbnQxMjgod29ya2luZ091ckV4ZWN1dGVkQ250cik7CiAgICBpZiAodGhlaXJPcmRlcklkID09IDApIHsKICAgICAgb3JkZXJDaGFpbkZvck9jY3VwaWVkUHJpY2VbdGhlaXJQcmljZV0uZmlyc3RPcmRlcklkID0gMDsKICAgICAgb3JkZXJDaGFpbkZvck9jY3VwaWVkUHJpY2VbdGhlaXJQcmljZV0ubGFzdE9yZGVySWQgPSAwOwogICAgICByZW1vdmVkTGFzdEF0UHJpY2UgPSB0cnVlOwogICAgfSBlbHNlIHsKICAgICAgLy8gTkI6IGluIHNvbWUgY2FzZXMgKGUuZy4gbWF4TWF0Y2hlcyA9PSAwKSB0aGlzIGlzIGEgbm8tb3AuCiAgICAgIG9yZGVyQ2hhaW5Gb3JPY2N1cGllZFByaWNlW3RoZWlyUHJpY2VdLmZpcnN0T3JkZXJJZCA9IHRoZWlyT3JkZXJJZDsKICAgICAgb3JkZXJDaGFpbk5vZGVGb3JPcGVuT3JkZXJJZFt0aGVpck9yZGVySWRdLnByZXZPcmRlcklkID0gMDsKICAgICAgcmVtb3ZlZExhc3RBdFByaWNlID0gZmFsc2U7CiAgICB9CiAgfQogIAogIC8vIEludGVybmFsIE9yZGVyIFBsYWNlbWVudC4KICAvLwogIC8vIE1hdGNoIHVwIHRvIG91ciByZW1haW5pbmcgYW1vdW50IGFnYWluc3QgYSByZXN0aW5nIG9yZGVyIGluIHRoZSBib29rLgogIC8vCiAgLy8gVGhlIG1hdGNoIChwYXJ0aWFsLCBjb21wbGV0ZSBvciBlZmZlY3RpdmVseS1jb21wbGV0ZSkgb2YgdGhlIHJlc3Rpbmcgb3JkZXIKICAvLyBpcyByZWNvcmRlZCwgYW5kIHRoZWlyIGZ1bmRzIGFyZSBjcmVkaXRlZC4KICAvLwogIC8vIFRoZWlyIG9yZGVyIGlzIE5PVCByZW1vdmVkIGZyb20gdGhlIGJvb2sgYnkgdGhpcyBjYWxsIC0gdGhlIGNhbGxlciBtdXN0IGRvIHRoYXQKICAvLyBpZiB0aGUgbmV4dFRoZWlyT3JkZXJJZCByZXR1cm5lZCBpcyBub3QgZXF1YWwgdG8gdGhlIHRoZWlyT3JkZXJJZCBwYXNzZWQgaW4uCiAgLy8KICAvLyBSZXR1cm5zOgogIC8vCiAgLy8gICBuZXh0VGhlaXJPcmRlcklkOgogIC8vICAgICBJZiB3ZSBkaWQgbm90IGNvbXBsZXRlbHkgbWF0Y2ggdGhlaXIgb3JkZXIsIHdpbGwgYmUgc2FtZSBhcyB0aGVpck9yZGVySWQuCiAgLy8gICAgIElmIHdlIGNvbXBsZXRlbHkgbWF0Y2hlZCB0aGVpciBvcmRlciwgd2lsbCBiZSBvcmRlcklkIG9mIG5leHQgb3JkZXIgYXQgdGhlCiAgLy8gICAgIHNhbWUgcHJpY2UgLSBvciB6ZXJvIGlmIHRoaXMgd2FzIHRoZSBsYXN0IG9yZGVyIGFuZCB3ZSd2ZSBub3cgZmlsbGVkIGl0LgogIC8vCiAgLy8gICBtYXRjaFN0b3BSZWFzb246CiAgLy8gICAgIElmIG91ciBvcmRlciBpcyBjb21wbGV0ZWx5IG1hdGNoZWQsIG1hdGNoU3RvcFJlYXNvbiB3aWxsIGJlIFNhdGlzZmllZC4KICAvLyAgICAgSWYgb3VyIG9yZGVyIGlzIG5vdCBjb21wbGV0ZWx5IG1hdGNoZWQsIG1hdGNoU3RvcFJlYXNvbiB3aWxsIGJlIGVpdGhlcgogIC8vICAgICBQcmljZUV4aGF1c3RlZCAoaWYgbm90aGluZyBsZWZ0IGF0IHRoaXMgZXhhY3QgcHJpY2UpIG9yIE5vbmUgKGlmIGNhbiBjb250aW51ZSkuCiAgLy8gCiAgZnVuY3Rpb24gbWF0Y2hXaXRoVGhlaXJzKAogICAgdWludCBvdXJSZW1haW5pbmdCYXNlLCB1aW50MTI4IHRoZWlyT3JkZXJJZCwgdWludDE2IHRoZWlyUHJpY2UpIGludGVybmFsIHJldHVybnMgKAogICAgdWludDEyOCBuZXh0VGhlaXJPcmRlcklkLCB1aW50IG1hdGNoQmFzZSwgdWludCBtYXRjaENudHIsIE1hdGNoU3RvcFJlYXNvbiBtYXRjaFN0b3BSZWFzb24pIHsKICAgIE9yZGVyIHN0b3JhZ2UgdGhlaXJPcmRlciA9IG9yZGVyRm9yT3JkZXJJZFt0aGVpck9yZGVySWRdOwogICAgdWludCB0aGVpclJlbWFpbmluZ0Jhc2UgPSB0aGVpck9yZGVyLnNpemVCYXNlIC0gdGhlaXJPcmRlci5leGVjdXRlZEJhc2U7CiAgICBpZiAob3VyUmVtYWluaW5nQmFzZSA8IHRoZWlyUmVtYWluaW5nQmFzZSkgewogICAgICBtYXRjaEJhc2UgPSBvdXJSZW1haW5pbmdCYXNlOwogICAgfSBlbHNlIHsKICAgICAgbWF0Y2hCYXNlID0gdGhlaXJSZW1haW5pbmdCYXNlOwogICAgfQogICAgbWF0Y2hDbnRyID0gY29tcHV0ZUNudHJBbW91bnRVc2luZ1BhY2tlZChtYXRjaEJhc2UsIHRoZWlyUHJpY2UpOwogICAgLy8gSXQgbWF5IHNlZW0gYSBiaXQgb2RkIHRvIHN0b3AgaGVyZSBpZiBvdXIgcmVtYWluaW5nIGFtb3VudCBpcyB2ZXJ5IHNtYWxsIC0KICAgIC8vIHRoZXJlIGNvdWxkIHN0aWxsIGJlIHJlc3Rpbmcgb3JkZXJzIHdlIGNhbiBtYXRjaCBpdCBhZ2FpbnN0LiBCdXQgdGhlIGdhcwogICAgLy8gY29zdCBvZiBtYXRjaGluZyBlYWNoIG9yZGVyIGlzIHF1aXRlIGhpZ2ggLSBwb3RlbnRpYWxseSBoaWdoIGVub3VnaCB0bwogICAgLy8gd2lwZSBvdXQgdGhlIHByb2ZpdCB0aGUgdGFrZXIgaG9wZXMgZm9yIGZyb20gdHJhZGluZyB0aGUgdGlueSBhbW91bnQgbGVmdC4KICAgIGlmICgob3VyUmVtYWluaW5nQmFzZSAtIG1hdGNoQmFzZSkgPCBiYXNlTWluUmVtYWluaW5nU2l6ZSkgewogICAgICBtYXRjaFN0b3BSZWFzb24gPSBNYXRjaFN0b3BSZWFzb24uU2F0aXNmaWVkOwogICAgfSBlbHNlIHsKICAgICAgbWF0Y2hTdG9wUmVhc29uID0gTWF0Y2hTdG9wUmVhc29uLk5vbmU7CiAgICB9CiAgICBib29sIHRoZWlyc0RlYWQgPSByZWNvcmRUaGVpck1hdGNoKHRoZWlyT3JkZXIsIHRoZWlyT3JkZXJJZCwgdGhlaXJQcmljZSwgbWF0Y2hCYXNlLCBtYXRjaENudHIpOwogICAgaWYgKHRoZWlyc0RlYWQpIHsKICAgICAgbmV4dFRoZWlyT3JkZXJJZCA9IG9yZGVyQ2hhaW5Ob2RlRm9yT3Blbk9yZGVySWRbdGhlaXJPcmRlcklkXS5uZXh0T3JkZXJJZDsKICAgICAgaWYgKG1hdGNoU3RvcFJlYXNvbiA9PSBNYXRjaFN0b3BSZWFzb24uTm9uZSAmJiBuZXh0VGhlaXJPcmRlcklkID09IDApIHsKICAgICAgICBtYXRjaFN0b3BSZWFzb24gPSBNYXRjaFN0b3BSZWFzb24uUHJpY2VFeGhhdXN0ZWQ7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIG5leHRUaGVpck9yZGVySWQgPSB0aGVpck9yZGVySWQ7CiAgICB9CiAgfQoKICAvLyBJbnRlcm5hbCBPcmRlciBQbGFjZW1lbnQuCiAgLy8KICAvLyBSZWNvcmQgbWF0Y2ggKHBhcnRpYWwgb3IgY29tcGxldGUpIG9mIHJlc3Rpbmcgb3JkZXIsIGFuZCBjcmVkaXQgdGhlbSB0aGVpciBmdW5kcy4KICAvLwogIC8vIElmIHRoZWlyIG9yZGVyIGlzIGNvbXBsZXRlbHkgbWF0Y2hlZCwgdGhlIG9yZGVyIGlzIG1hcmtlZCBhcyBkb25lLAogIC8vIGFuZCAidGhlaXJzRGVhZCIgaXMgcmV0dXJuZWQgYXMgdHJ1ZS4KICAvLwogIC8vIFRoZSBvcmRlciBpcyBOT1QgcmVtb3ZlZCBmcm9tIHRoZSBib29rIGJ5IHRoaXMgY2FsbCAtIHRoZSBjYWxsZXIKICAvLyBtdXN0IGRvIHRoYXQgaWYgdGhlaXJzRGVhZCBpcyB0cnVlLgogIC8vCiAgLy8gTm8gc2FuaXR5IGNoZWNrcyBhcmUgbWFkZSAtIHRoZSBjYWxsZXIgbXVzdCBiZSBzdXJlIHRoZSBvcmRlciBpcwogIC8vIG5vdCBhbHJlYWR5IGRvbmUgYW5kIGhhcyBzdWZmaWNpZW50IHJlbWFpbmluZy4gKFllcywgd2UnZCBsaWtlIHRvCiAgLy8gY2hlY2sgaGVyZSB0b28gYnV0IHdlIGNhbm5vdCBhZmZvcmQgdGhlIGdhcykuCiAgLy8KICBmdW5jdGlvbiByZWNvcmRUaGVpck1hdGNoKAogICAgICBPcmRlciBzdG9yYWdlIHRoZWlyT3JkZXIsIHVpbnQxMjggdGhlaXJPcmRlcklkLCB1aW50MTYgdGhlaXJQcmljZSwgdWludCBtYXRjaEJhc2UsIHVpbnQgbWF0Y2hDbnRyCiAgICApIGludGVybmFsIHJldHVybnMgKGJvb2wgdGhlaXJzRGVhZCkgewogICAgLy8gdGhleSBhcmUgYSBtYWtlciBzbyBubyBmZWVzCiAgICAvLyBvdmVyZmxvdyBzYWZlIC0gc2VlIGNvbW1lbnRzIGFib3V0IGJhc2VNYXhTaXplCiAgICAvLyBleGVjdXRlZEJhc2UgY2Fubm90IGdvID4gc2l6ZUJhc2UgZHVlIHRvIGxvZ2ljIGluIG1hdGNoV2l0aFRoZWlycwogICAgdGhlaXJPcmRlci5leGVjdXRlZEJhc2UgKz0gdWludDEyOChtYXRjaEJhc2UpOwogICAgdGhlaXJPcmRlci5leGVjdXRlZENudHIgKz0gdWludDEyOChtYXRjaENudHIpOwogICAgaWYgKGlzQnV5UHJpY2UodGhlaXJQcmljZSkpIHsKICAgICAgLy8gdGhleSBoYXZlIGJvdWdodCBiYXNlICh1c2luZyB0aGUgY291bnRlciB0aGV5IGFscmVhZHkgcGFpZCB3aGVuIGNyZWF0aW5nIHRoZSBvcmRlcikKICAgICAgYmFsYW5jZUJhc2VGb3JDbGllbnRbdGhlaXJPcmRlci5jbGllbnRdICs9IG1hdGNoQmFzZTsKICAgIH0gZWxzZSB7CiAgICAgIC8vIHRoZXkgaGF2ZSBib3VnaHQgY291bnRlciAodXNpbmcgdGhlIGJhc2UgdGhleSBhbHJlYWR5IHBhaWQgd2hlbiBjcmVhdGluZyB0aGUgb3JkZXIpCiAgICAgIGJhbGFuY2VDbnRyRm9yQ2xpZW50W3RoZWlyT3JkZXIuY2xpZW50XSArPSBtYXRjaENudHI7CiAgICB9CiAgICB1aW50IHN0aWxsUmVtYWluaW5nQmFzZSA9IHRoZWlyT3JkZXIuc2l6ZUJhc2UgLSB0aGVpck9yZGVyLmV4ZWN1dGVkQmFzZTsKICAgIC8vIGF2b2lkIGxlYXZpbmcgdGlueSBhbW91bnRzIGluIHRoZSBib29rIC0gcmVmdW5kIHJlbWFpbmluZyBpZiB0b28gc21hbGwKICAgIGlmIChzdGlsbFJlbWFpbmluZ0Jhc2UgPCBiYXNlTWluUmVtYWluaW5nU2l6ZSkgewogICAgICByZWZ1bmRVbm1hdGNoZWRBbmRGaW5pc2godGhlaXJPcmRlcklkLCBTdGF0dXMuRG9uZSwgUmVhc29uQ29kZS5Ob25lKTsKICAgICAgLy8gc29tZW9uZSBidWlsZGluZyBhbiBVSSBvbiB0b3AgbmVlZHMgdG8ga25vdyBob3cgbXVjaCB3YXMgbWF0Y2ggYW5kIGhvdyBtdWNoIHdhcyByZWZ1bmQKICAgICAgTWFya2V0T3JkZXJFdmVudChibG9jay50aW1lc3RhbXAsIHRoZWlyT3JkZXJJZCwgTWFya2V0T3JkZXJFdmVudFR5cGUuQ29tcGxldGVGaWxsLAogICAgICAgIHRoZWlyUHJpY2UsIG1hdGNoQmFzZSArIHN0aWxsUmVtYWluaW5nQmFzZSwgbWF0Y2hCYXNlKTsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9IGVsc2UgewogICAgICBNYXJrZXRPcmRlckV2ZW50KGJsb2NrLnRpbWVzdGFtcCwgdGhlaXJPcmRlcklkLCBNYXJrZXRPcmRlckV2ZW50VHlwZS5QYXJ0aWFsRmlsbCwKICAgICAgICB0aGVpclByaWNlLCBtYXRjaEJhc2UsIG1hdGNoQmFzZSk7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICB9CgogIC8vIEludGVybmFsIE9yZGVyIFBsYWNlbWVudC4KICAvLwogIC8vIFJlZnVuZCBhbnkgdW5tYXRjaGVkIGZ1bmRzIGluIGFuIG9yZGVyIChiYXNlZCBvbiBleGVjdXRlZCB2cyBzaXplKSBhbmQgbW92ZSB0byBhIGZpbmFsIHN0YXRlLgogIC8vCiAgLy8gVGhlIG9yZGVyIGlzIE5PVCByZW1vdmVkIGZyb20gdGhlIGJvb2sgYnkgdGhpcyBjYWxsIGFuZCBubyBldmVudCBpcyByYWlzZWQuCiAgLy8KICAvLyBObyBzYW5pdHkgY2hlY2tzIGFyZSBtYWRlIC0gdGhlIGNhbGxlciBtdXN0IGJlIHN1cmUgdGhlIG9yZGVyIGhhcyBub3QgYWxyZWFkeSBiZWVuIHJlZnVuZGVkLgogIC8vCiAgZnVuY3Rpb24gcmVmdW5kVW5tYXRjaGVkQW5kRmluaXNoKHVpbnQxMjggb3JkZXJJZCwgU3RhdHVzIHN0YXR1cywgUmVhc29uQ29kZSByZWFzb25Db2RlKSBpbnRlcm5hbCB7CiAgICBPcmRlciBzdG9yYWdlIG9yZGVyID0gb3JkZXJGb3JPcmRlcklkW29yZGVySWRdOwogICAgdWludDE2IHByaWNlID0gb3JkZXIucHJpY2U7CiAgICBpZiAoaXNCdXlQcmljZShwcmljZSkpIHsKICAgICAgdWludCBzaXplQ250ciA9IGNvbXB1dGVDbnRyQW1vdW50VXNpbmdQYWNrZWQob3JkZXIuc2l6ZUJhc2UsIHByaWNlKTsKICAgICAgYmFsYW5jZUNudHJGb3JDbGllbnRbb3JkZXIuY2xpZW50XSArPSBzaXplQ250ciAtIG9yZGVyLmV4ZWN1dGVkQ250cjsKICAgIH0gZWxzZSB7CiAgICAgIGJhbGFuY2VCYXNlRm9yQ2xpZW50W29yZGVyLmNsaWVudF0gKz0gb3JkZXIuc2l6ZUJhc2UgLSBvcmRlci5leGVjdXRlZEJhc2U7CiAgICB9CiAgICBvcmRlci5zdGF0dXMgPSBzdGF0dXM7CiAgICBvcmRlci5yZWFzb25Db2RlID0gcmVhc29uQ29kZTsKICB9CgogIC8vIEludGVybmFsIE9yZGVyIFBsYWNlbWVudC4KICAvLwogIC8vIEVudGVyIGEgbm90IGNvbXBsZXRlbHkgbWF0Y2hlZCBvcmRlciBpbnRvIHRoZSBib29rLCBtYXJraW5nIHRoZSBvcmRlciBhcyBvcGVuLgogIC8vCiAgLy8gVGhpcyB1cGRhdGVzIHRoZSBvY2N1cGllZCBwcmljZSBiaXRtYXAgYW5kIGNoYWluLgogIC8vCiAgLy8gTm8gc2FuaXR5IGNoZWNrcyBhcmUgbWFkZSAtIHRoZSBjYWxsZXIgbXVzdCBiZSBzdXJlIHRoZSBvcmRlcgogIC8vIGhhcyBzb21lIHVubWF0Y2hlZCBhbW91bnQgYW5kIGhhcyBiZWVuIHBhaWQgZm9yIQogIC8vCiAgZnVuY3Rpb24gZW50ZXJPcmRlcih1aW50MTI4IG9yZGVySWQpIGludGVybmFsIHsKICAgIE9yZGVyIHN0b3JhZ2Ugb3JkZXIgPSBvcmRlckZvck9yZGVySWRbb3JkZXJJZF07CiAgICB1aW50MTYgcHJpY2UgPSBvcmRlci5wcmljZTsKICAgIE9yZGVyQ2hhaW4gc3RvcmFnZSBvcmRlckNoYWluID0gb3JkZXJDaGFpbkZvck9jY3VwaWVkUHJpY2VbcHJpY2VdOwogICAgT3JkZXJDaGFpbk5vZGUgc3RvcmFnZSBvcmRlckNoYWluTm9kZSA9IG9yZGVyQ2hhaW5Ob2RlRm9yT3Blbk9yZGVySWRbb3JkZXJJZF07CiAgICBpZiAob3JkZXJDaGFpbi5maXJzdE9yZGVySWQgPT0gMCkgewogICAgICBvcmRlckNoYWluLmZpcnN0T3JkZXJJZCA9IG9yZGVySWQ7CiAgICAgIG9yZGVyQ2hhaW4ubGFzdE9yZGVySWQgPSBvcmRlcklkOwogICAgICBvcmRlckNoYWluTm9kZS5uZXh0T3JkZXJJZCA9IDA7CiAgICAgIG9yZGVyQ2hhaW5Ob2RlLnByZXZPcmRlcklkID0gMDsKICAgICAgdWludCBiaXRtYXBJbmRleCA9IHByaWNlIC8gMjU2OwogICAgICB1aW50IGJpdEluZGV4ID0gcHJpY2UgJSAyNTY7CiAgICAgIG9jY3VwaWVkUHJpY2VCaXRtYXBzW2JpdG1hcEluZGV4XSB8PSAoMiAqKiBiaXRJbmRleCk7CiAgICB9IGVsc2UgewogICAgICB1aW50MTI4IGV4aXN0aW5nTGFzdE9yZGVySWQgPSBvcmRlckNoYWluLmxhc3RPcmRlcklkOwogICAgICBPcmRlckNoYWluTm9kZSBzdG9yYWdlIGV4aXN0aW5nTGFzdE9yZGVyQ2hhaW5Ob2RlID0gb3JkZXJDaGFpbk5vZGVGb3JPcGVuT3JkZXJJZFtleGlzdGluZ0xhc3RPcmRlcklkXTsKICAgICAgb3JkZXJDaGFpbk5vZGUubmV4dE9yZGVySWQgPSAwOwogICAgICBvcmRlckNoYWluTm9kZS5wcmV2T3JkZXJJZCA9IGV4aXN0aW5nTGFzdE9yZGVySWQ7CiAgICAgIGV4aXN0aW5nTGFzdE9yZGVyQ2hhaW5Ob2RlLm5leHRPcmRlcklkID0gb3JkZXJJZDsKICAgICAgb3JkZXJDaGFpbi5sYXN0T3JkZXJJZCA9IG9yZGVySWQ7CiAgICB9CiAgICBNYXJrZXRPcmRlckV2ZW50KGJsb2NrLnRpbWVzdGFtcCwgb3JkZXJJZCwgTWFya2V0T3JkZXJFdmVudFR5cGUuQWRkLAogICAgICBwcmljZSwgb3JkZXIuc2l6ZUJhc2UgLSBvcmRlci5leGVjdXRlZEJhc2UsIDApOwogICAgb3JkZXIuc3RhdHVzID0gU3RhdHVzLk9wZW47CiAgfQoKICAvLyBJbnRlcm5hbCBPcmRlciBQbGFjZW1lbnQuCiAgLy8KICAvLyBDaGFyZ2UgdGhlIGNsaWVudCBmb3IgdGhlIGNvc3Qgb2YgcGxhY2luZyBhbiBvcmRlciBpbiB0aGUgZ2l2ZW4gZGlyZWN0aW9uLgogIC8vCiAgLy8gUmV0dXJuIHRydWUgaWYgc3VjY2Vzc2Z1bCwgZmFsc2Ugb3RoZXJ3aXNlLgogIC8vCiAgZnVuY3Rpb24gZGViaXRGdW5kcygKICAgICAgYWRkcmVzcyBjbGllbnQsIERpcmVjdGlvbiBkaXJlY3Rpb24sIHVpbnQgc2l6ZUJhc2UsIHVpbnQgc2l6ZUNudHIKICAgICkgaW50ZXJuYWwgcmV0dXJucyAoYm9vbCBzdWNjZXNzKSB7CiAgICBpZiAoZGlyZWN0aW9uID09IERpcmVjdGlvbi5CdXkpIHsKICAgICAgdWludCBhdmFpbGFibGVDbnRyID0gYmFsYW5jZUNudHJGb3JDbGllbnRbY2xpZW50XTsKICAgICAgaWYgKGF2YWlsYWJsZUNudHIgPCBzaXplQ250cikgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICBiYWxhbmNlQ250ckZvckNsaWVudFtjbGllbnRdID0gYXZhaWxhYmxlQ250ciAtIHNpemVDbnRyOwogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0gZWxzZSBpZiAoZGlyZWN0aW9uID09IERpcmVjdGlvbi5TZWxsKSB7CiAgICAgIHVpbnQgYXZhaWxhYmxlQmFzZSA9IGJhbGFuY2VCYXNlRm9yQ2xpZW50W2NsaWVudF07CiAgICAgIGlmIChhdmFpbGFibGVCYXNlIDwgc2l6ZUJhc2UpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgYmFsYW5jZUJhc2VGb3JDbGllbnRbY2xpZW50XSA9IGF2YWlsYWJsZUJhc2UgLSBzaXplQmFzZTsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgfQoKICAvLyBQdWJsaWMgQm9vayBWaWV3CiAgLy8gCiAgLy8gSW50ZW5kZWQgZm9yIHB1YmxpYyBib29rIGRlcHRoIGVudW1lcmF0aW9uIGZyb20gd2ViMyAob3Igc2ltaWxhcikuCiAgLy8KICAvLyBOb3Qgc3VpdGFibGUgZm9yIHVzZSBmcm9tIGEgc21hcnQgY29udHJhY3QgdHJhbnNhY3Rpb24gLSBnYXMgdXNhZ2UKICAvLyBjb3VsZCBiZSB2ZXJ5IGhpZ2ggaWYgd2UgaGF2ZSBtYW55IG9yZGVycyBhdCB0aGUgc2FtZSBwcmljZS4KICAvLwogIC8vIFN0YXJ0IGF0IHRoZSBnaXZlbiBpbmNsdXNpdmUgcHJpY2UgKGFuZCBzaWRlKSBhbmQgd2FsayBkb3duIHRoZSBib29rCiAgLy8gKGdldHRpbmcgbGVzcyBhZ2dyZXNzaXZlKSB1bnRpbCB3ZSBmaW5kIHNvbWUgb3BlbiBvcmRlcnMgb3IgcmVhY2ggdGhlCiAgLy8gbGVhc3QgYWdncmVzc2l2ZSBwcmljZS4KICAvLwogIC8vIFJldHVybnMgdGhlIHByaWNlIHdoZXJlIHdlIGZvdW5kIHRoZSBvcmRlcihzKSwgdGhlIGRlcHRoIGF0IHRoYXQgcHJpY2UKICAvLyAoemVybyBpZiBub25lIGZvdW5kKSwgb3JkZXIgY291bnQgdGhlcmUsIGFuZCB0aGUgY3VycmVudCBibG9ja051bWJlci4KICAvLwogIC8vIChUaGUgYmxvY2tOdW1iZXIgaXMgaGFuZHkgaWYgeW91J3JlIHRha2luZyBhIHNuYXBzaG90IHdoaWNoIHlvdSBpbnRlbmQKICAvLyAgdG8ga2VlcCB1cC10by1kYXRlIHdpdGggdGhlIG1hcmtldCBvcmRlciBldmVudHMpLgogIC8vCiAgLy8gVG8gd2FsayB0aGUgYm9vaywgdGhlIGNhbGxlciBzaG91bGQgc3RhcnQgYnkgY2FsbGluZyB3YWxrQm9vayB3aXRoIHRoZQogIC8vIG1vc3QgYWdncmVzc2l2ZSBidXkgcHJpY2UgKEJ1eSBAIDk5OTAwMCkuCiAgLy8gSWYgdGhlIHByaWNlIHJldHVybmVkIGlzIHRoZSBsZWFzdCBhZ2dyZXNzaXZlIGJ1eSBwcmljZSAoQnV5IEAgMC4wMDAwMDEpLAogIC8vIHRoZSBzaWRlIGlzIGNvbXBsZXRlLgogIC8vIE90aGVyd2lzZSwgY2FsbCB3YWxrQm9vayBhZ2FpbiB3aXRoIHRoZSAocGFja2VkKSBwcmljZSByZXR1cm5lZCArIDEuCiAgLy8gVGhlbiByZXBlYXQgZm9yIHRoZSBzZWxsIHNpZGUsIHN0YXJ0aW5nIHdpdGggU2VsbCBAIDAuMDAwMDAxIGFuZCBzdG9wcGluZwogIC8vIHdoZW4gU2VsbCBAIDk5OTAwMCBpcyByZXR1cm5lZC4KICAvLwogIGZ1bmN0aW9uIHdhbGtCb29rKHVpbnQxNiBmcm9tUHJpY2UpIHB1YmxpYyBjb25zdGFudCByZXR1cm5zICgKICAgICAgdWludDE2IHByaWNlLCB1aW50IGRlcHRoQmFzZSwgdWludCBvcmRlckNvdW50LCB1aW50IGJsb2NrTnVtYmVyCiAgICApIHsKICAgIHVpbnQgcHJpY2VTdGFydCA9IGZyb21QcmljZTsKICAgIHVpbnQgcHJpY2VFbmQgPSAoaXNCdXlQcmljZShmcm9tUHJpY2UpKSA/IG1pbkJ1eVByaWNlIDogbWF4U2VsbFByaWNlOwogICAgCiAgICAvLyBTZWUgY29tbWVudHMgaW4gbWF0Y2hBZ2FpbnN0Qm9vayByZTogaG93IHRoZXNlIGNyYXp5IGxvb3BzIHdvcmsuCiAgICAKICAgIHVpbnQgYm1pID0gcHJpY2VTdGFydCAvIDI1NjsKICAgIHVpbnQgYnRpID0gcHJpY2VTdGFydCAlIDI1NjsKICAgIHVpbnQgYm1pRW5kID0gcHJpY2VFbmQgLyAyNTY7CiAgICB1aW50IGJ0aUVuZCA9IHByaWNlRW5kICUgMjU2OwoKICAgIHVpbnQgd2JtID0gb2NjdXBpZWRQcmljZUJpdG1hcHNbYm1pXSA+PiBidGk7CiAgICAKICAgIHdoaWxlIChibWkgPCBibWlFbmQpIHsKICAgICAgaWYgKHdibSA9PSAwIHx8IGJ0aSA9PSAyNTYpIHsKICAgICAgICBidGkgPSAwOwogICAgICAgIGJtaSsrOwogICAgICAgIHdibSA9IG9jY3VwaWVkUHJpY2VCaXRtYXBzW2JtaV07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKCh3Ym0gJiAxKSAhPSAwKSB7CiAgICAgICAgICAvLyBjYXJlZnVsIC0gY29weS1wYXN0ZWQgaW4gYmVsb3cgbG9vcAogICAgICAgICAgcHJpY2UgPSB1aW50MTYoYm1pICogMjU2ICsgYnRpKTsKICAgICAgICAgIChkZXB0aEJhc2UsIG9yZGVyQ291bnQpID0gc3VtRGVwdGgob3JkZXJDaGFpbkZvck9jY3VwaWVkUHJpY2VbcHJpY2VdLmZpcnN0T3JkZXJJZCk7CiAgICAgICAgICByZXR1cm4gKHByaWNlLCBkZXB0aEJhc2UsIG9yZGVyQ291bnQsIGJsb2NrLm51bWJlcik7CiAgICAgICAgfQogICAgICAgIGJ0aSArPSAxOwogICAgICAgIHdibSAvPSAyOwogICAgICB9CiAgICB9CiAgICAvLyB3ZSd2ZSByZWFjaGVkIHRoZSBsYXN0IGJpdG1hcCB3ZSBuZWVkIHRvIHNlYXJjaCwgc3RvcCBhdCBidGlFbmQgbm90IDI1NiB0aGlzIHRpbWUuCiAgICB3aGlsZSAoYnRpIDw9IGJ0aUVuZCAmJiB3Ym0gIT0gMCkgewogICAgICBpZiAoKHdibSAmIDEpICE9IDApIHsKICAgICAgICAvLyBjYXJlZnVsIC0gY29weS1wYXN0ZWQgaW4gYWJvdmUgbG9vcAogICAgICAgIHByaWNlID0gdWludDE2KGJtaSAqIDI1NiArIGJ0aSk7CiAgICAgICAgKGRlcHRoQmFzZSwgb3JkZXJDb3VudCkgPSBzdW1EZXB0aChvcmRlckNoYWluRm9yT2NjdXBpZWRQcmljZVtwcmljZV0uZmlyc3RPcmRlcklkKTsKICAgICAgICByZXR1cm4gKHByaWNlLCBkZXB0aEJhc2UsIG9yZGVyQ291bnQsIGJsb2NrLm51bWJlcik7CiAgICAgIH0KICAgICAgYnRpICs9IDE7CiAgICAgIHdibSAvPSAyOwogICAgfQogICAgcmV0dXJuICh1aW50MTYocHJpY2VFbmQpLCAwLCAwLCBibG9jay5udW1iZXIpOwogIH0KCiAgLy8gSW50ZXJuYWwgQm9vayBWaWV3LgogIC8vCiAgLy8gU2VlIHdhbGtCb29rIC0gYWRkcyB1cCBvcGVuIGRlcHRoIGF0IGEgcHJpY2Ugc3RhcnRpbmcgZnJvbSBhbgogIC8vIG9yZGVyIHdoaWNoIGlzIGFzc3VtZWQgdG8gYmUgb3Blbi4gQ2FyZWZ1bCAtIHVubGltaXRlZCBnYXMgdXNlLgogIC8vCiAgZnVuY3Rpb24gc3VtRGVwdGgodWludDEyOCBvcmRlcklkKSBpbnRlcm5hbCBjb25zdGFudCByZXR1cm5zICh1aW50IGRlcHRoLCB1aW50IG9yZGVyQ291bnQpIHsKICAgIHdoaWxlICh0cnVlKSB7CiAgICAgIE9yZGVyIHN0b3JhZ2Ugb3JkZXIgPSBvcmRlckZvck9yZGVySWRbb3JkZXJJZF07CiAgICAgIGRlcHRoICs9IG9yZGVyLnNpemVCYXNlIC0gb3JkZXIuZXhlY3V0ZWRCYXNlOwogICAgICBvcmRlckNvdW50Kys7CiAgICAgIG9yZGVySWQgPSBvcmRlckNoYWluTm9kZUZvck9wZW5PcmRlcklkW29yZGVySWRdLm5leHRPcmRlcklkOwogICAgICBpZiAob3JkZXJJZCA9PSAwKSB7CiAgICAgICAgcmV0dXJuIChkZXB0aCwgb3JkZXJDb3VudCk7CiAgICAgIH0KICAgIH0KICB9Cn0='.
	

]
