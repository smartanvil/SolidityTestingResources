Class {
	#name : #SRTac5ce3f18806e27fe616734abb2506766fd7e0ec,
	#superclass : #SRTContracts,
	#category : #SolidityTestingResources
}

{ #category : #base64 }
SRTac5ce3f18806e27fe616734abb2506766fd7e0ec >> base64 [
	^ 'cHJhZ21hIHNvbGlkaXR5IF4wLjQuMTE7Cgpjb250cmFjdCBPd25hYmxlIHsKICAvLyByZXBsYWNlIHdpdGggcHJvcGVyIHplcHBlbGluIHNtYXJ0IGNvbnRyYWN0CiAgYWRkcmVzcyBwdWJsaWMgb3duZXI7CgogIGZ1bmN0aW9uIE93bmFibGUoKSB7CiAgICBvd25lciA9IG1zZy5zZW5kZXI7CiAgfQoKICBtb2RpZmllciBvbmx5T3duZXIoKSB7CiAgICBpZiAobXNnLnNlbmRlciAhPSBvd25lcikKICAgICAgdGhyb3c7CiAgICBfOwogIH0KCiAgZnVuY3Rpb24gdHJhbnNmZXJPd25lcnNoaXAoYWRkcmVzcyBuZXdPd25lcikgb25seU93bmVyIHsKICAgIGlmIChuZXdPd25lciAhPSBhZGRyZXNzKDApKQogICAgICBvd25lciA9IG5ld093bmVyOwogIH0KfQoKCmNvbnRyYWN0IERlc3RydWN0YWJsZSBpcyBPd25hYmxlIHsKICBmdW5jdGlvbiBzZWxmZGVzdHJ1Y3QoKSBleHRlcm5hbCBvbmx5T3duZXIgewogICAgLy8gZnJlZSBldGhlcmV1bSBuZXR3b3JrIHN0YXRlIHdoZW4gZG9uZQogICAgc2VsZmRlc3RydWN0KG93bmVyKTsKICB9Cn0KCgpjb250cmFjdCBNYXRoIHsKICAvLyBzY2FsZSBvZiB0aGUgZW11bGF0ZWQgZml4ZWQgcG9pbnQgb3BlcmF0aW9ucwogIHVpbnQgY29uc3RhbnQgcHVibGljIEZQX1NDQUxFID0gMTAwMDA7CgogIC8vIHRvZG86IHNob3VsZCBiZSBhIGxpYnJhcnkKICBmdW5jdGlvbiBkaXZSb3VuZCh1aW50IHYsIHVpbnQgZCkgaW50ZXJuYWwgY29uc3RhbnQgcmV0dXJucyh1aW50KSB7CiAgICAvLyByb3VuZCB1cCBpZiAlIGlzIGhhbGYgb3IgbW9yZQogICAgcmV0dXJuICh2ICsgKGQvMikpIC8gZDsKICB9CgogIGZ1bmN0aW9uIGFic0RpZmYodWludCB2MSwgdWludCB2MikgcHVibGljIGNvbnN0YW50IHJldHVybnModWludCkgewogICAgcmV0dXJuIHYxID4gdjIgPyB2MSAtIHYyIDogdjIgLSB2MTsKICB9CgogIGZ1bmN0aW9uIHNhZmVNdWwodWludCBhLCB1aW50IGIpIHB1YmxpYyBjb25zdGFudCByZXR1cm5zICh1aW50KSB7CiAgICB1aW50IGMgPSBhICogYjsKICAgIGlmIChhID09IDAgfHwgYyAvIGEgPT0gYikKICAgICAgcmV0dXJuIGM7CiAgICBlbHNlCiAgICAgIHRocm93OwogIH0KCiAgZnVuY3Rpb24gc2FmZUFkZCh1aW50IGEsIHVpbnQgYikgaW50ZXJuYWwgY29uc3RhbnQgcmV0dXJucyAodWludCkgewogICAgdWludCBjID0gYSArIGI7CiAgICBpZiAoIShjPj1hICYmIGM+PWIpKQogICAgICB0aHJvdzsKICAgIHJldHVybiBjOwogIH0KfQoKCmNvbnRyYWN0IFRpbWVTb3VyY2UgewogIHVpbnQzMiBwcml2YXRlIG1vY2tOb3c7CgogIGZ1bmN0aW9uIGN1cnJlbnRUaW1lKCkgcHVibGljIGNvbnN0YW50IHJldHVybnMgKHVpbnQzMikgewogICAgLy8gd2UgZG8gbm90IHN1cHBvcnQgZGF0ZXMgbXVjaCBpbnRvIGZ1dHVyZSAoU3VuLCAwNyBGZWIgMjEwNiAwNjoyODoxNSBHTVQpCiAgICBpZiAoYmxvY2sudGltZXN0YW1wID4gMHhGRkZGRkZGRikKICAgICAgdGhyb3c7CiAgICByZXR1cm4gbW9ja05vdyA+IDAgPyBtb2NrTm93IDogdWludDMyKGJsb2NrLnRpbWVzdGFtcCk7CiAgfQoKICBmdW5jdGlvbiBtb2NrVGltZSh1aW50MzIgdCkgcHVibGljIHsKICAgIC8vIG5vIG1vY2tpbmcgb24gbWFpbm5ldAogICAgaWYgKGJsb2NrLm51bWJlciA+IDMzMTYwMjkpCiAgICAgIHRocm93OwogICAgbW9ja05vdyA9IHQ7CiAgfQp9CgoKY29udHJhY3QgQmFzZU9wdGlvbnNDb252ZXJ0ZXIgewoKICAvLyBtb2RpZmllcnMgYXJlIGluaGVyaXRlZCwgY2hlY2sgYG93bmVkYCBwYXR0ZXJuCiAgLy8gICBodHRwOi8vc29saWRpdHkucmVhZHRoZWRvY3MuaW8vZW4vZGV2ZWxvcC9jb250cmFjdHMuaHRtbCNmdW5jdGlvbi1tb2RpZmllcnMKICBtb2RpZmllciBvbmx5RVNPUCgpIHsKICAgIGlmIChtc2cuc2VuZGVyICE9IGdldEVTT1AoKSkKICAgICAgdGhyb3c7CiAgICBfOwogIH0KCiAgLy8gcmV0dXJucyBFU09QIGFkZHJlc3Mgd2hpY2ggaXMgYSBzb2xlIGV4ZWN1dG9yIG9mIGV4ZXJjaXNlT3B0aW9ucyBmdW5jdGlvbgogIGZ1bmN0aW9uIGdldEVTT1AoKSBwdWJsaWMgY29uc3RhbnQgcmV0dXJucyAoYWRkcmVzcyk7CiAgLy8gZGVhZGxpbmUgZm9yIGVtcGxveWVlcyB0byBleGVyY2lzZSBvcHRpb25zCiAgZnVuY3Rpb24gZ2V0RXhlcmNpc2VQZXJpb2REZWFkbGluZSgpIHB1YmxpYyBjb25zdGFudCByZXR1cm5zICh1aW50MzIpOwoKICAvLyBleGVyY2lzZSBvZiBvcHRpb25zIGZvciBnaXZlbiBlbXBsb3llZSBhbmQgYW1vdW50LCBwbGVhc2Ugbm90ZSB0aGF0IGVtcGxveWVlIGFkZHJlc3MgbWF5IGJlIDAKICAvLyAuLiBpbiB3aGljaCBjYXNlIHRoZSBpbnRlbnRpb24gaXMgdG8gYnVybiBvcHRpb25zCiAgZnVuY3Rpb24gZXhlcmNpc2VPcHRpb25zKGFkZHJlc3MgZW1wbG95ZWUsIHVpbnQgcG9vbE9wdGlvbnMsIHVpbnQgZXh0cmFPcHRpb25zLCB1aW50IGJvbnVzT3B0aW9ucywKICAgIGJvb2wgYWdyZWVUb0FjY2VsZXJhdGVkVmVzdGluZ0JvbnVzQ29uZGl0aW9ucykgb25seUVTT1AgcHVibGljOwp9Cgpjb250cmFjdCBFU09QVHlwZXMgewogIC8vIGVudW1zIGFyZSBudW1iZXJlZCBzdGFydGluZyBmcm9tIDAuIE5vdFNldCBpcyB1c2VkIHRvIGNoZWNrIGZvciBub24gZXhpc3RpbmcgbWFwcGluZwogIGVudW0gRW1wbG95ZWVTdGF0ZSB7IE5vdFNldCwgV2FpdGluZ0ZvclNpZ25hdHVyZSwgRW1wbG95ZWQsIFRlcm1pbmF0ZWQsIE9wdGlvbnNFeGVyY2lzZWQgfQogIC8vIHBsZWFzZSBub3RlIHRoYXQgMzIgYml0IHVuc2lnbmVkIGludCBpcyB1c2VkIHRvIHJlcHJlc2VudCBVTklYIHRpbWUgd2hpY2ggaXMgZW5vdWdoIHRvIHJlcHJlc2VudCBkYXRlcyB1bnRpbCBTdW4sIDA3IEZlYiAyMTA2IDA2OjI4OjE1IEdNVAogIC8vIHN0b3JhZ2UgYWNjZXNzIGlzIG9wdGltaXplZCBzbyBzdHJ1Y3QgbGF5b3V0IGlzIGltcG9ydGFudAogIHN0cnVjdCBFbXBsb3llZSB7CiAgICAgIC8vIHdoZW4gdmVzdGluZyBzdGFydHMKICAgICAgdWludDMyIGlzc3VlRGF0ZTsKICAgICAgLy8gd2FpdCBmb3IgZW1wbG95ZWUgc2lnbmF0dXJlIHVudGlsIHRoYXQgdGltZQogICAgICB1aW50MzIgdGltZVRvU2lnbjsKICAgICAgLy8gZGF0ZSB3aGVuIGVtcGxveWVlIHdhcyB0ZXJtaW5hdGVkLCAwIGZvciBub3QgdGVybWluYXRlZAogICAgICB1aW50MzIgdGVybWluYXRlZEF0OwogICAgICAvLyB3aGVuIGZhZGUgb3V0IHN0YXJ0cywgMCBmb3Igbm90IHNldCwgaW5pdGFsbHkgPT0gdGVybWluYXRlZEF0CiAgICAgIC8vIHVzZWQgb25seSB3aGVuIGNhbGN1bGF0aW5nIG9wdGlvbnMgcmV0dXJuZWQgdG8gcG9vbAogICAgICB1aW50MzIgZmFkZW91dFN0YXJ0czsKICAgICAgLy8gcG9vbE9wdGlvbnMgZW1wbG95ZWUgZ2V0cyAoZXhpdCBib251cyBub3QgaW5jbHVkZWQpCiAgICAgIHVpbnQzMiBwb29sT3B0aW9uczsKICAgICAgLy8gZXh0cmEgb3B0aW9ucyBlbXBsb3llZSBnZXRzIChuZXVmdW5kIHdpbGwgbm90IHRoaXMgb3B0aW9uKQogICAgICB1aW50MzIgZXh0cmFPcHRpb25zOwogICAgICAvLyB0aW1lIGF0IHdoaWNoIGVtcGxveWVlIGdvdCBzdXNwZW5kZWQsIDAgLSBub3Qgc3VzcGVuZGVkCiAgICAgIHVpbnQzMiBzdXNwZW5kZWRBdDsKICAgICAgLy8gd2hhdCBpcyBlbXBsb3llZSBjdXJyZW50IHN0YXR1cywgdGFrZXMgOCBiaXQgaW4gc3RvcmFnZQogICAgICBFbXBsb3llZVN0YXRlIHN0YXRlOwogICAgICAvLyBpbmRleCBpbiBpdGVyYWJsZSBtYXBwaW5nCiAgICAgIHVpbnQxNiBpZHg7CiAgICAgIC8vIHJlc2VydmUgdW50aWwgZnVsbCAyNTYgYml0IHdvcmQKICAgICAgLy91aW50MjQgcmVzZXJ2ZWQ7CiAgfQoKICBmdW5jdGlvbiBzZXJpYWxpemVFbXBsb3llZShFbXBsb3llZSBtZW1vcnkgZW1wbG95ZWUpCiAgICBpbnRlcm5hbAogICAgY29uc3RhbnQKICAgIHJldHVybnModWludFs5XSBlbXApCiAgewogICAgICAvLyBndWVzcyB3aGF0OiBzdHJ1Y3QgbGF5b3V0IGluIG1lbW9yeSBpcyBhbGlnbmVkIHRvIHdvcmQgKDI1NiBiaXRzKQogICAgICAvLyBzdHJ1Y3QgaW4gc3RvcmFnZSBpcyBieXRlIGFsaWduZWQKICAgICAgYXNzZW1ibHkgewogICAgICAgIC8vIHJldHVybiBtZW1vcnkgYWxpZ25lZCBzdHJ1Y3QgYXMgYXJyYXkgb2Ygd29yZHMKICAgICAgICAvLyBJIGp1c3Qgd29uZGVyIHdoZW4gJ2VtcGxveWVlJyBtZW1vcnkgaXMgZGVhbGxvY2F0ZWQKICAgICAgICAvLyBhbnN3ZXI6IG1lbW9yeSBpcyBub3QgZGVhbGxvY2F0ZWQgdW50aWwgdHJhbnNhY3Rpb24gZW5kcwogICAgICAgIGVtcCA6PSBlbXBsb3llZQogICAgICB9CiAgfQoKICBmdW5jdGlvbiBkZXNlcmlhbGl6ZUVtcGxveWVlKHVpbnRbOV0gc2VyaWFsaXplZEVtcGxveWVlKQogICAgaW50ZXJuYWwKICAgIGNvbnN0YW50CiAgICByZXR1cm5zIChFbXBsb3llZSBtZW1vcnkgZW1wKQogIHsKICAgICAgYXNzZW1ibHkgeyBlbXAgOj0gc2VyaWFsaXplZEVtcGxveWVlIH0KICB9Cn0KCgpjb250cmFjdCBDb2RlVXBkYXRlYWJsZSBpcyBPd25hYmxlIHsKICAgIC8vIGFsbG93cyB0byBzdG9wIG9wZXJhdGlvbnMgYW5kIG1pZ3JhdGUgZGF0YSB0byBkaWZmZXJlbnQgY29udHJhY3QKICAgIGVudW0gQ29kZVVwZGF0ZVN0YXRlIHsgQ3VycmVudENvZGUsIE9uZ29pbmdVcGRhdGUgLyosIENvZGVVcGRhdGVkKi99CiAgICBDb2RlVXBkYXRlU3RhdGUgcHVibGljIGNvZGVVcGRhdGVTdGF0ZTsKCiAgICBtb2RpZmllciBpc0N1cnJlbnRDb2RlKCkgewogICAgICBpZiAoY29kZVVwZGF0ZVN0YXRlICE9IENvZGVVcGRhdGVTdGF0ZS5DdXJyZW50Q29kZSkKICAgICAgICB0aHJvdzsKICAgICAgXzsKICAgIH0KCiAgICBtb2RpZmllciBpbkNvZGVVcGRhdGUoKSB7CiAgICAgIGlmIChjb2RlVXBkYXRlU3RhdGUgIT0gQ29kZVVwZGF0ZVN0YXRlLk9uZ29pbmdVcGRhdGUpCiAgICAgICAgdGhyb3c7CiAgICAgIF87CiAgICB9CgogICAgZnVuY3Rpb24gYmVnaW5Db2RlVXBkYXRlKCkgcHVibGljIG9ubHlPd25lciBpc0N1cnJlbnRDb2RlIHsKICAgICAgY29kZVVwZGF0ZVN0YXRlID0gQ29kZVVwZGF0ZVN0YXRlLk9uZ29pbmdVcGRhdGU7CiAgICB9CgogICAgZnVuY3Rpb24gY2FuY2VsQ29kZVVwZGF0ZSgpIHB1YmxpYyBvbmx5T3duZXIgaW5Db2RlVXBkYXRlIHsKICAgICAgY29kZVVwZGF0ZVN0YXRlID0gQ29kZVVwZGF0ZVN0YXRlLkN1cnJlbnRDb2RlOwogICAgfQoKICAgIGZ1bmN0aW9uIGNvbXBsZXRlQ29kZVVwZGF0ZSgpIHB1YmxpYyBvbmx5T3duZXIgaW5Db2RlVXBkYXRlIHsKICAgICAgc2VsZmRlc3RydWN0KG93bmVyKTsKICAgIH0KfQoKY29udHJhY3QgRW1wbG95ZWVzTGlzdCBpcyBFU09QVHlwZXMsIE93bmFibGUsIERlc3RydWN0YWJsZSB7CiAgZXZlbnQgQ3JlYXRlRW1wbG95ZWUoYWRkcmVzcyBpbmRleGVkIGUsIHVpbnQzMiBwb29sT3B0aW9ucywgdWludDMyIGV4dHJhT3B0aW9ucywgdWludDE2IGlkeCk7CiAgZXZlbnQgVXBkYXRlRW1wbG95ZWUoYWRkcmVzcyBpbmRleGVkIGUsIHVpbnQzMiBwb29sT3B0aW9ucywgdWludDMyIGV4dHJhT3B0aW9ucywgdWludDE2IGlkeCk7CiAgZXZlbnQgQ2hhbmdlRW1wbG95ZWVTdGF0ZShhZGRyZXNzIGluZGV4ZWQgZSwgRW1wbG95ZWVTdGF0ZSBvbGRTdGF0ZSwgRW1wbG95ZWVTdGF0ZSBuZXdTdGF0ZSk7CiAgZXZlbnQgUmVtb3ZlRW1wbG95ZWUoYWRkcmVzcyBpbmRleGVkIGUpOwogIG1hcHBpbmcgKGFkZHJlc3MgPT4gRW1wbG95ZWUpIGVtcGxveWVlczsKICAvLyBhZGRyZXNzZXMgaW4gdGhlIG1hcHBpbmcsIGV2ZXIKICBhZGRyZXNzW10gcHVibGljIGFkZHJlc3NlczsKCiAgZnVuY3Rpb24gc2l6ZSgpIGV4dGVybmFsIGNvbnN0YW50IHJldHVybnMgKHVpbnQxNikgewogICAgcmV0dXJuIHVpbnQxNihhZGRyZXNzZXMubGVuZ3RoKTsKICB9CgogIGZ1bmN0aW9uIHNldEVtcGxveWVlKGFkZHJlc3MgZSwgdWludDMyIGlzc3VlRGF0ZSwgdWludDMyIHRpbWVUb1NpZ24sIHVpbnQzMiB0ZXJtaW5hdGVkQXQsIHVpbnQzMiBmYWRlb3V0U3RhcnRzLAogICAgdWludDMyIHBvb2xPcHRpb25zLCB1aW50MzIgZXh0cmFPcHRpb25zLCB1aW50MzIgc3VzcGVuZGVkQXQsIEVtcGxveWVlU3RhdGUgc3RhdGUpCiAgICBleHRlcm5hbAogICAgb25seU93bmVyCiAgICByZXR1cm5zIChib29sIGlzTmV3KQogIHsKICAgIHVpbnQxNiBlbXBJZHggPSBlbXBsb3llZXNbZV0uaWR4OwogICAgaWYgKGVtcElkeCA9PSAwKSB7CiAgICAgIC8vIG5ldyBlbGVtZW50CiAgICAgIHVpbnQgc2l6ZSA9IGFkZHJlc3Nlcy5sZW5ndGg7CiAgICAgIGlmIChzaXplID09IDB4RkZGRikKICAgICAgICB0aHJvdzsKICAgICAgaXNOZXcgPSB0cnVlOwogICAgICBlbXBJZHggPSB1aW50MTYoc2l6ZSArIDEpOwogICAgICBhZGRyZXNzZXMucHVzaChlKTsKICAgICAgQ3JlYXRlRW1wbG95ZWUoZSwgcG9vbE9wdGlvbnMsIGV4dHJhT3B0aW9ucywgZW1wSWR4KTsKICAgIH0gZWxzZSB7CiAgICAgIGlzTmV3ID0gZmFsc2U7CiAgICAgIFVwZGF0ZUVtcGxveWVlKGUsIHBvb2xPcHRpb25zLCBleHRyYU9wdGlvbnMsIGVtcElkeCk7CiAgICB9CiAgICBlbXBsb3llZXNbZV0gPSBFbXBsb3llZSh7CiAgICAgICAgaXNzdWVEYXRlOiBpc3N1ZURhdGUsCiAgICAgICAgdGltZVRvU2lnbjogdGltZVRvU2lnbiwKICAgICAgICB0ZXJtaW5hdGVkQXQ6IHRlcm1pbmF0ZWRBdCwKICAgICAgICBmYWRlb3V0U3RhcnRzOiBmYWRlb3V0U3RhcnRzLAogICAgICAgIHBvb2xPcHRpb25zOiBwb29sT3B0aW9ucywKICAgICAgICBleHRyYU9wdGlvbnM6IGV4dHJhT3B0aW9ucywKICAgICAgICBzdXNwZW5kZWRBdDogc3VzcGVuZGVkQXQsCiAgICAgICAgc3RhdGU6IHN0YXRlLAogICAgICAgIGlkeDogZW1wSWR4CiAgICAgIH0pOwogIH0KCiAgZnVuY3Rpb24gY2hhbmdlU3RhdGUoYWRkcmVzcyBlLCBFbXBsb3llZVN0YXRlIHN0YXRlKQogICAgZXh0ZXJuYWwKICAgIG9ubHlPd25lcgogIHsKICAgIGlmIChlbXBsb3llZXNbZV0uaWR4ID09IDApCiAgICAgIHRocm93OwogICAgQ2hhbmdlRW1wbG95ZWVTdGF0ZShlLCBlbXBsb3llZXNbZV0uc3RhdGUsIHN0YXRlKTsKICAgIGVtcGxveWVlc1tlXS5zdGF0ZSA9IHN0YXRlOwogIH0KCiAgZnVuY3Rpb24gc2V0RmFkZW91dFN0YXJ0cyhhZGRyZXNzIGUsIHVpbnQzMiBmYWRlb3V0U3RhcnRzKQogICAgZXh0ZXJuYWwKICAgIG9ubHlPd25lcgogIHsKICAgIGlmIChlbXBsb3llZXNbZV0uaWR4ID09IDApCiAgICAgIHRocm93OwogICAgVXBkYXRlRW1wbG95ZWUoZSwgZW1wbG95ZWVzW2VdLnBvb2xPcHRpb25zLCBlbXBsb3llZXNbZV0uZXh0cmFPcHRpb25zLCBlbXBsb3llZXNbZV0uaWR4KTsKICAgIGVtcGxveWVlc1tlXS5mYWRlb3V0U3RhcnRzID0gZmFkZW91dFN0YXJ0czsKICB9CgogIGZ1bmN0aW9uIHJlbW92ZUVtcGxveWVlKGFkZHJlc3MgZSkKICAgIGV4dGVybmFsCiAgICBvbmx5T3duZXIKICAgIHJldHVybnMgKGJvb2wpCiAgewogICAgdWludDE2IGVtcElkeCA9IGVtcGxveWVlc1tlXS5pZHg7CiAgICBpZiAoZW1wSWR4ID4gMCkgewogICAgICAgIGRlbGV0ZSBlbXBsb3llZXNbZV07CiAgICAgICAgZGVsZXRlIGFkZHJlc3Nlc1tlbXBJZHgtMV07CiAgICAgICAgUmVtb3ZlRW1wbG95ZWUoZSk7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICByZXR1cm4gZmFsc2U7CiAgfQoKICBmdW5jdGlvbiB0ZXJtaW5hdGVFbXBsb3llZShhZGRyZXNzIGUsIHVpbnQzMiBpc3N1ZURhdGUsIHVpbnQzMiB0ZXJtaW5hdGVkQXQsIHVpbnQzMiBmYWRlb3V0U3RhcnRzLCBFbXBsb3llZVN0YXRlIHN0YXRlKQogICAgZXh0ZXJuYWwKICAgIG9ubHlPd25lcgogIHsKICAgIGlmIChzdGF0ZSAhPSBFbXBsb3llZVN0YXRlLlRlcm1pbmF0ZWQpCiAgICAgICAgdGhyb3c7CiAgICBFbXBsb3llZSBlbXBsb3llZSA9IGVtcGxveWVlc1tlXTsgLy8gZ2V0cyByZWZlcmVuY2UgdG8gc3RvcmFnZSBhbmQgb3B0aW1pemVyIGRvZXMgaXQgd2l0aCBvbmUgU1NUT1JFCiAgICBpZiAoZW1wbG95ZWUuaWR4ID09IDApCiAgICAgIHRocm93OwogICAgQ2hhbmdlRW1wbG95ZWVTdGF0ZShlLCBlbXBsb3llZS5zdGF0ZSwgc3RhdGUpOwogICAgZW1wbG95ZWUuc3RhdGUgPSBzdGF0ZTsKICAgIGVtcGxveWVlLmlzc3VlRGF0ZSA9IGlzc3VlRGF0ZTsKICAgIGVtcGxveWVlLnRlcm1pbmF0ZWRBdCA9IHRlcm1pbmF0ZWRBdDsKICAgIGVtcGxveWVlLmZhZGVvdXRTdGFydHMgPSBmYWRlb3V0U3RhcnRzOwogICAgZW1wbG95ZWUuc3VzcGVuZGVkQXQgPSAwOwogICAgVXBkYXRlRW1wbG95ZWUoZSwgZW1wbG95ZWUucG9vbE9wdGlvbnMsIGVtcGxveWVlLmV4dHJhT3B0aW9ucywgZW1wbG95ZWUuaWR4KTsKICB9CgogIGZ1bmN0aW9uIGdldEVtcGxveWVlKGFkZHJlc3MgZSkKICAgIGV4dGVybmFsCiAgICBjb25zdGFudAogICAgcmV0dXJucyAodWludDMyLCB1aW50MzIsIHVpbnQzMiwgdWludDMyLCB1aW50MzIsIHVpbnQzMiwgdWludDMyLCBFbXBsb3llZVN0YXRlKQogIHsKICAgICAgRW1wbG95ZWUgZW1wbG95ZWUgPSBlbXBsb3llZXNbZV07CiAgICAgIGlmIChlbXBsb3llZS5pZHggPT0gMCkKICAgICAgICB0aHJvdzsKICAgICAgLy8gd2hlcmUgaXMgc3RydWN0IHppcC91bnppcCA6PgogICAgICByZXR1cm4gKGVtcGxveWVlLmlzc3VlRGF0ZSwgZW1wbG95ZWUudGltZVRvU2lnbiwgZW1wbG95ZWUudGVybWluYXRlZEF0LCBlbXBsb3llZS5mYWRlb3V0U3RhcnRzLAogICAgICAgIGVtcGxveWVlLnBvb2xPcHRpb25zLCBlbXBsb3llZS5leHRyYU9wdGlvbnMsIGVtcGxveWVlLnN1c3BlbmRlZEF0LCBlbXBsb3llZS5zdGF0ZSk7CiAgfQoKICAgZnVuY3Rpb24gaGFzRW1wbG95ZWUoYWRkcmVzcyBlKQogICAgIGV4dGVybmFsCiAgICAgY29uc3RhbnQKICAgICByZXR1cm5zIChib29sKQogICB7CiAgICAgIC8vIHRoaXMgaXMgdmVyeSBpbmVmZmljaWVudCAtIHdob2xlIHdvcmQgaXMgbG9hZGVkIGp1c3QgdG8gY2hlY2sgdGhpcwogICAgICByZXR1cm4gZW1wbG95ZWVzW2VdLmlkeCAhPSAwOwogICAgfQoKICBmdW5jdGlvbiBnZXRTZXJpYWxpemVkRW1wbG95ZWUoYWRkcmVzcyBlKQogICAgZXh0ZXJuYWwKICAgIGNvbnN0YW50CiAgICByZXR1cm5zICh1aW50WzldKQogIHsKICAgIEVtcGxveWVlIG1lbW9yeSBlbXBsb3llZSA9IGVtcGxveWVlc1tlXTsKICAgIGlmIChlbXBsb3llZS5pZHggPT0gMCkKICAgICAgdGhyb3c7CiAgICByZXR1cm4gc2VyaWFsaXplRW1wbG95ZWUoZW1wbG95ZWUpOwogIH0KfQoKCmNvbnRyYWN0IEVSQzIwT3B0aW9uc0NvbnZlcnRlciBpcyBCYXNlT3B0aW9uc0NvbnZlcnRlciwgVGltZVNvdXJjZSwgTWF0aCB7CiAgLy8gc2VlIGJhc2UgY2xhc3MgZm9yIGV4cGxhbmF0aW9ucwogIGFkZHJlc3MgZXNvcEFkZHJlc3M7CiAgdWludDMyIGV4ZXJjaXNlUGVyaW9kRGVhZGxpbmU7CiAgLy8gYmFsYW5jZXMgZm9yIGNvbnZlcnRlZCBvcHRpb25zCiAgbWFwcGluZyhhZGRyZXNzID0+IHVpbnQpIGludGVybmFsIGJhbGFuY2VzOwogIC8vIHRvdGFsIHN1cHBseQogIHVpbnQgcHVibGljIHRvdGFsU3VwcGx5OwoKICAvLyBkZWFkbGluZSBmb3IgYWxsIG9wdGlvbnMgY29udmVyc2lvbiBpbmNsdWRpbmcgY29tcGFueSdzIGFjdGlvbnMKICB1aW50MzIgcHVibGljIG9wdGlvbnNDb252ZXJzaW9uRGVhZGxpbmU7CgogIGV2ZW50IFRyYW5zZmVyKGFkZHJlc3MgaW5kZXhlZCBmcm9tLCBhZGRyZXNzIGluZGV4ZWQgdG8sIHVpbnQgdmFsdWUpOwoKICBtb2RpZmllciBjb252ZXJ0aW5nKCkgewogICAgLy8gdGhyb3cgYWZ0ZXIgZGVhZGxpbmUKICAgIGlmIChjdXJyZW50VGltZSgpID49IGV4ZXJjaXNlUGVyaW9kRGVhZGxpbmUpCiAgICAgIHRocm93OwogICAgXzsKICB9CgogIG1vZGlmaWVyIGNvbnZlcnRlZCgpIHsKICAgIC8vIHRocm93IGJlZm9yZSBkZWFkbGluZQogICAgaWYgKGN1cnJlbnRUaW1lKCkgPCBvcHRpb25zQ29udmVyc2lvbkRlYWRsaW5lKQogICAgICB0aHJvdzsKICAgIF87CiAgfQoKCiAgZnVuY3Rpb24gZ2V0RVNPUCgpIHB1YmxpYyBjb25zdGFudCByZXR1cm5zIChhZGRyZXNzKSB7CiAgICByZXR1cm4gZXNvcEFkZHJlc3M7CiAgfQoKICBmdW5jdGlvbiBnZXRFeGVyY2lzZVBlcmlvZERlYWRsaW5lKCkgcHVibGljIGNvbnN0YW50IHJldHVybnModWludDMyKSB7CiAgICByZXR1cm4gZXhlcmNpc2VQZXJpb2REZWFkbGluZTsKICB9CgogIGZ1bmN0aW9uIGV4ZXJjaXNlT3B0aW9ucyhhZGRyZXNzIGVtcGxveWVlLCB1aW50IHBvb2xPcHRpb25zLCB1aW50IGV4dHJhT3B0aW9ucywgdWludCBib251c09wdGlvbnMsCiAgICBib29sIGFncmVlVG9BY2NlbGVyYXRlZFZlc3RpbmdCb251c0NvbmRpdGlvbnMpCiAgICBwdWJsaWMKICAgIG9ubHlFU09QCiAgICBjb252ZXJ0aW5nCiAgewogICAgLy8gaWYgbm8gb3ZlcmZsb3cgb24gdG90YWxTdXBwbHksIG5vIG92ZXJmbG93cyBsYXRlcgogICAgdWludCBvcHRpb25zID0gc2FmZUFkZChzYWZlQWRkKHBvb2xPcHRpb25zLCBleHRyYU9wdGlvbnMpLCBib251c09wdGlvbnMpOwogICAgdG90YWxTdXBwbHkgPSBzYWZlQWRkKHRvdGFsU3VwcGx5LCBvcHRpb25zKTsKICAgIGJhbGFuY2VzW2VtcGxveWVlXSArPSBvcHRpb25zOwogICAgVHJhbnNmZXIoMCwgZW1wbG95ZWUsIG9wdGlvbnMpOwogIH0KCiAgZnVuY3Rpb24gdHJhbnNmZXIoYWRkcmVzcyBfdG8sIHVpbnQgX3ZhbHVlKSBjb252ZXJ0ZWQgcHVibGljIHsKICAgIGlmIChiYWxhbmNlc1ttc2cuc2VuZGVyXSA8IF92YWx1ZSkKICAgICAgdGhyb3c7CiAgICBiYWxhbmNlc1ttc2cuc2VuZGVyXSAtPSBfdmFsdWU7CiAgICBiYWxhbmNlc1tfdG9dICs9IF92YWx1ZTsKICAgIFRyYW5zZmVyKG1zZy5zZW5kZXIsIF90bywgX3ZhbHVlKTsKICB9CgogIGZ1bmN0aW9uIGJhbGFuY2VPZihhZGRyZXNzIF9vd25lcikgY29uc3RhbnQgcHVibGljIHJldHVybnMgKHVpbnQgYmFsYW5jZSkgewogICAgcmV0dXJuIGJhbGFuY2VzW19vd25lcl07CiAgfQoKICBmdW5jdGlvbiAoKSBwYXlhYmxlIHsKICAgIHRocm93OwogIH0KCiAgZnVuY3Rpb24gRVJDMjBPcHRpb25zQ29udmVydGVyKGFkZHJlc3MgZXNvcCwgdWludDMyIGV4ZXJjaXNlRGVhZGxpbmUsIHVpbnQzMiBjb252ZXJzaW9uRGVhZGxpbmUpIHsKICAgIGVzb3BBZGRyZXNzID0gZXNvcDsKICAgIGV4ZXJjaXNlUGVyaW9kRGVhZGxpbmUgPSBleGVyY2lzZURlYWRsaW5lOwogICAgb3B0aW9uc0NvbnZlcnNpb25EZWFkbGluZSA9IGNvbnZlcnNpb25EZWFkbGluZTsKICB9Cn0KCmNvbnRyYWN0IEVTT1BNaWdyYXRpb24gewogIG1vZGlmaWVyIG9ubHlPbGRFU09QKCkgewogICAgaWYgKG1zZy5zZW5kZXIgIT0gZ2V0T2xkRVNPUCgpKQogICAgICB0aHJvdzsKICAgIF87CiAgfQoKICAvLyByZXR1cm5zIEVTT1AgYWRkcmVzcyB3aGljaCBpcyBhIHNvbGUgZXhlY3V0b3Igb2YgZXhlcmNpc2VPcHRpb25zIGZ1bmN0aW9uCiAgZnVuY3Rpb24gZ2V0T2xkRVNPUCgpIHB1YmxpYyBjb25zdGFudCByZXR1cm5zIChhZGRyZXNzKTsKCiAgLy8gbWlncmF0ZSBlbXBsb3llZSB0byBuZXcgRVNPUCBjb250cmFjdCwgdGhyb3dzIGlmIG5vdCBwb3NzaWJsZQogIC8vIGluIHNpbXBsZXN0IGNhc2UgbmV3IEVTT1AgY29udHJhY3Qgc2hvdWxkIGRlcml2ZSBmcm9tIHRoaXMgY29udHJhY3QgYW5kIGltcGxlbWVudCBhYnN0cmFjdCBtZXRob2RzCiAgLy8gZW1wbG95ZWVzIGxpc3QgaXMgYXZhaWxhYmxlIGZvciBpbnNwZWN0aW9uIGJ5IGVtcGxveWVlIGFkZHJlc3MKICAvLyBwb29sT3B0aW9ucyBhbmQgZXh0cmFPcHRpb24gaXMgYW1vdW50IG9mIG9wdGlvbnMgdHJhbnNmZXJyZWQgb3V0IG9mIG9sZCBFU09QIGNvbnRyYWN0CiAgZnVuY3Rpb24gbWlncmF0ZShhZGRyZXNzIGVtcGxveWVlLCB1aW50IHBvb2xPcHRpb25zLCB1aW50IGV4dHJhT3B0aW9ucykgb25seU9sZEVTT1AgcHVibGljOwp9Cgpjb250cmFjdCBFU09QIGlzIEVTT1BUeXBlcywgQ29kZVVwZGF0ZWFibGUsIFRpbWVTb3VyY2UgewogIC8vIGVtcGxveWVlIGNoYW5nZWQgZXZlbnRzCiAgZXZlbnQgRVNPUE9mZmVyZWQoYWRkcmVzcyBpbmRleGVkIGVtcGxveWVlLCBhZGRyZXNzIGNvbXBhbnksIHVpbnQzMiBwb29sT3B0aW9ucywgdWludDMyIGV4dHJhT3B0aW9ucyk7CiAgZXZlbnQgRW1wbG95ZWVTaWduZWRUb0VTT1AoYWRkcmVzcyBpbmRleGVkIGVtcGxveWVlKTsKICBldmVudCBTdXNwZW5kRW1wbG95ZWUoYWRkcmVzcyBpbmRleGVkIGVtcGxveWVlLCB1aW50MzIgc3VzcGVuZGVkQXQpOwogIGV2ZW50IENvbnRpbnVlU3VzcGVuZGVkRW1wbG95ZWUoYWRkcmVzcyBpbmRleGVkIGVtcGxveWVlLCB1aW50MzIgY29udGludWVkQXQsIHVpbnQzMiBzdXNwZW5kZWRQZXJpb2QpOwogIGV2ZW50IFRlcm1pbmF0ZUVtcGxveWVlKGFkZHJlc3MgaW5kZXhlZCBlbXBsb3llZSwgYWRkcmVzcyBjb21wYW55LCB1aW50MzIgdGVybWluYXRlZEF0LCBUZXJtaW5hdGlvblR5cGUgdGVybVR5cGUpOwogIGV2ZW50IEVtcGxveWVlT3B0aW9uc0V4ZXJjaXNlZChhZGRyZXNzIGluZGV4ZWQgZW1wbG95ZWUsIGFkZHJlc3MgZXhlcmNpc2VkRm9yLCB1aW50MzIgcG9vbE9wdGlvbnMsIGJvb2wgZGlzYWJsZUFjY2VsZXJhdGVkVmVzdGluZyk7CiAgZXZlbnQgRW1wbG95ZWVNaWdyYXRlZChhZGRyZXNzIGluZGV4ZWQgZW1wbG95ZWUsIGFkZHJlc3MgbWlncmF0aW9uLCB1aW50IHBvb2wsIHVpbnQgZXh0cmEpOwogIC8vIGVzb3AgY2hhbmdlZCBldmVudHMKICBldmVudCBFU09QT3BlbmVkKGFkZHJlc3MgY29tcGFueSk7CiAgZXZlbnQgT3B0aW9uc0NvbnZlcnNpb25PZmZlcmVkKGFkZHJlc3MgY29tcGFueSwgYWRkcmVzcyBjb252ZXJ0ZXIsIHVpbnQzMiBjb252ZXJ0ZWRBdCwgdWludDMyIGV4ZXJjaXNlUGVyaW9kRGVhZGxpbmUpOwogIGVudW0gRVNPUFN0YXRlIHsgTmV3LCBPcGVuLCBDb252ZXJzaW9uIH0KICAvLyB1c2UgcmV0cnVuIGNvZGVzIHVudGlsIHJldmVydCBvcGNvZGUgaXMgaW1wbGVtZW50ZWQKICBlbnVtIFJldHVybkNvZGVzIHsgT0ssIEludmFsaWRFbXBsb3llZVN0YXRlLCBUb29MYXRlLCBJbnZhbGlkUGFyYW1ldGVycywgVG9vRWFybHkgIH0KICAvLyBldmVudCByYWlzZWQgd2hlbiByZXR1cm4gY29kZSBmcm9tIGEgZnVuY3Rpb24gaXMgbm90IE9LLCB3aGVuIE9LIGlzIHJldHVybmVkIG9uZSBvZiBldmVudHMgYWJvdmUgaXMgcmFpc2VkCiAgZXZlbnQgUmV0dXJuQ29kZShSZXR1cm5Db2RlcyByYyk7CiAgZW51bSBUZXJtaW5hdGlvblR5cGUgeyBSZWd1bGFyLCBCYWRMZWF2ZXIgfQoKICAvL0NPTkZJRwogIE9wdGlvbnNDYWxjdWxhdG9yIHB1YmxpYyBvcHRpb25zQ2FsY3VsYXRvcjsKICAvLyB0b3RhbCBwb29sT3B0aW9ucyBpbiBUaGUgUG9vbAogIHVpbnQgcHVibGljIHRvdGFsUG9vbE9wdGlvbnM7CiAgLy8gaXBmcyBoYXNoIG9mIGRvY3VtZW50IGVzdGFibGlzaGluZyB0aGlzIEVTT1AKICBieXRlcyBwdWJsaWMgRVNPUExlZ2FsV3JhcHBlcklQRlNIYXNoOwogIC8vIGNvbXBhbnkgYWRkcmVzcwogIGFkZHJlc3MgcHVibGljIGNvbXBhbnlBZGRyZXNzOwogIC8vIHJvb3Qgb2YgaW1tdXRhYmxlIHJvb3Qgb2YgdHJ1c3QgcG9pbnRpbmcgdG8gZ2l2ZW4gRVNPUCBpbXBsZW1lbnRhdGlvbgogIGFkZHJlc3MgcHVibGljIHJvb3RPZlRydXN0OwogIC8vIGRlZmF1bHQgcGVyaW9kIGZvciBlbXBsb3llZSBzaWduYXR1cmUKICB1aW50MzIgY29uc3RhbnQgcHVibGljIE1JTklNVU1fTUFOVUFMX1NJR05fUEVSSU9EID0gMiB3ZWVrczsKCiAgLy8gU1RBVEUKICAvLyBwb29sT3B0aW9ucyB0aGF0IHJlbWFpbiB0byBiZSBhc3NpZ25lZAogIHVpbnQgcHVibGljIHJlbWFpbmluZ1Bvb2xPcHRpb25zOwogIC8vIHN0YXRlIG9mIEVTT1AKICBFU09QU3RhdGUgcHVibGljIGVzb3BTdGF0ZTsgLy8gYXV0b21hdGljYWxseSBzZXRzIHRvIE9wZW4gKDApCiAgLy8gbGlzdCBvZiBlbXBsb3llZXMKICBFbXBsb3llZXNMaXN0IHB1YmxpYyBlbXBsb3llZXM7CiAgLy8gaG93IG1hbnkgZXh0cmEgb3B0aW9ucyBpbnNlcnRlZAogIHVpbnQgcHVibGljIHRvdGFsRXh0cmFPcHRpb25zOwogIC8vIHdoZW4gY29udmVyc2lvbiBldmVudCBoYXBwZW5lZAogIHVpbnQzMiBwdWJsaWMgY29udmVyc2lvbk9mZmVyZWRBdDsKICAvLyBlbXBsb3llZSBjb252ZXJzaW9uIGRlYWRsaW5lCiAgdWludDMyIHB1YmxpYyBleGVyY2lzZU9wdGlvbnNEZWFkbGluZTsKICAvLyBvcHRpb24gY29udmVyc2lvbiBwcm94eQogIEJhc2VPcHRpb25zQ29udmVydGVyIHB1YmxpYyBvcHRpb25zQ29udmVydGVyOwoKICAvLyBtaWdyYXRpb24gZGVzdGluYXRpb25zIHBlciBlbXBsb3llZQogIG1hcHBpbmcgKGFkZHJlc3MgPT4gRVNPUE1pZ3JhdGlvbikgcHJpdmF0ZSBtaWdyYXRpb25zOwoKICBtb2RpZmllciBoYXNFbXBsb3llZShhZGRyZXNzIGUpIHsKICAgIC8vIHdpbGwgdGhyb3cgb24gdW5rbm93biBhZGRyZXNzCiAgICBpZiAoIWVtcGxveWVlcy5oYXNFbXBsb3llZShlKSkKICAgICAgdGhyb3c7CiAgICBfOwogIH0KCiAgbW9kaWZpZXIgb25seUVTT1BOZXcoKSB7CiAgICBpZiAoZXNvcFN0YXRlICE9IEVTT1BTdGF0ZS5OZXcpCiAgICAgIHRocm93OwogICAgXzsKICB9CgogIG1vZGlmaWVyIG9ubHlFU09QT3BlbigpIHsKICAgIGlmIChlc29wU3RhdGUgIT0gRVNPUFN0YXRlLk9wZW4pCiAgICAgIHRocm93OwogICAgXzsKICB9CgogIG1vZGlmaWVyIG9ubHlFU09QQ29udmVyc2lvbigpIHsKICAgIGlmIChlc29wU3RhdGUgIT0gRVNPUFN0YXRlLkNvbnZlcnNpb24pCiAgICAgIHRocm93OwogICAgXzsKICB9CgogIG1vZGlmaWVyIG9ubHlDb21wYW55KCkgewogICAgaWYgKGNvbXBhbnlBZGRyZXNzICE9IG1zZy5zZW5kZXIpCiAgICAgIHRocm93OwogICAgXzsKICB9CgogIGZ1bmN0aW9uIGRpc3RyaWJ1dGVBbmRSZXR1cm5Ub1Bvb2wodWludCBkaXN0cmlidXRlZE9wdGlvbnMsIHVpbnQgaWR4KQogICAgaW50ZXJuYWwKICAgIHJldHVybnMgKHVpbnQpCiAgewogICAgLy8gZW51bWVyYXRlIGFsbCBlbXBsb3llZXMgdGhhdCB3ZXJlIG9mZmVyZWQgcG9vbE9wdGlvbnMgYWZ0ZXIgdGhhbiBmcm9tSWR4IC0xIGVtcGxveWVlCiAgICBFbXBsb3llZSBtZW1vcnkgZW1wOwogICAgZm9yICh1aW50IGkgPSBpZHg7IGkgPCBlbXBsb3llZXMuc2l6ZSgpOyBpKyspIHsKICAgICAgYWRkcmVzcyBlYSA9IGVtcGxveWVlcy5hZGRyZXNzZXMoaSk7CiAgICAgIGlmIChlYSAhPSAwKSB7IC8vIGFkZHJlc3MoMCkgaXMgZGVsZXRlZCBlbXBsb3llZQogICAgICAgIGVtcCA9IF9sb2FkZW1wKGVhKTsKICAgICAgICAvLyBza2lwIGVtcGxveWVlcyB3aXRoIG5vIHBvb2xPcHRpb25zIGFuZCB0ZXJtaW5hdGVkIGVtcGxveWVlcwogICAgICAgIGlmIChlbXAucG9vbE9wdGlvbnMgPiAwICYmICggZW1wLnN0YXRlID09IEVtcGxveWVlU3RhdGUuV2FpdGluZ0ZvclNpZ25hdHVyZSB8fCBlbXAuc3RhdGUgPT0gRW1wbG95ZWVTdGF0ZS5FbXBsb3llZCkgKSB7CiAgICAgICAgICB1aW50IG5ld29wdGlvbnMgPSBvcHRpb25zQ2FsY3VsYXRvci5jYWxjTmV3RW1wbG95ZWVQb29sT3B0aW9ucyhkaXN0cmlidXRlZE9wdGlvbnMpOwogICAgICAgICAgZW1wLnBvb2xPcHRpb25zICs9IHVpbnQzMihuZXdvcHRpb25zKTsKICAgICAgICAgIGRpc3RyaWJ1dGVkT3B0aW9ucyAtPSB1aW50MzIobmV3b3B0aW9ucyk7CiAgICAgICAgICBfc2F2ZWVtcChlYSwgZW1wKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBkaXN0cmlidXRlZE9wdGlvbnM7CiAgfQoKICBmdW5jdGlvbiByZW1vdmVFbXBsb3llZXNXaXRoRXhwaXJlZFNpZ25hdHVyZXNBbmRSZXR1cm5GYWRlb3V0KCkKICAgIG9ubHlFU09QT3BlbgogICAgaXNDdXJyZW50Q29kZQogICAgcHVibGljCiAgewogICAgLy8gcmVtb3ZlcyBlbXBsb3llZXMgdGhhdCBkaWRuJ3Qgc2lnbiBhbmQgc2VuZHMgdGhlaXIgcG9vbE9wdGlvbnMgYmFjayB0byB0aGUgcG9vbAogICAgLy8gY29tcHV0ZXMgZmFkZW91dCBmb3IgdGVybWluYXRlZCBlbXBsb3llZXMgYW5kIHJldHVybnMgaXQgdG8gcG9vbAogICAgLy8gd2UgbGV0IGFueW9uZSB0byBjYWxsIHRoYXQgbWV0aG9kIGFuZCBzcGVuZCBnYXMgb24gaXQKICAgIEVtcGxveWVlIG1lbW9yeSBlbXA7CiAgICB1aW50MzIgY3QgPSBjdXJyZW50VGltZSgpOwogICAgZm9yICh1aW50IGkgPSAwOyBpIDwgZW1wbG95ZWVzLnNpemUoKTsgaSsrKSB7CiAgICAgIGFkZHJlc3MgZWEgPSBlbXBsb3llZXMuYWRkcmVzc2VzKGkpOwogICAgICBpZiAoZWEgIT0gMCkgeyAvLyBhZGRyZXNzKDApIGlzIGRlbGV0ZWQgZW1wbG95ZWUKICAgICAgICB2YXIgc2VyID0gZW1wbG95ZWVzLmdldFNlcmlhbGl6ZWRFbXBsb3llZShlYSk7CiAgICAgICAgZW1wID0gZGVzZXJpYWxpemVFbXBsb3llZShzZXIpOwogICAgICAgIC8vIHJlbW92ZSBlbXBsb3llZXMgd2l0aCBleHBpcmVkIHNpZ25hdHVyZXMKICAgICAgICBpZiAoZW1wLnN0YXRlID09IEVtcGxveWVlU3RhdGUuV2FpdGluZ0ZvclNpZ25hdHVyZSAmJiBjdCA+IGVtcC50aW1lVG9TaWduKSB7CiAgICAgICAgICByZW1haW5pbmdQb29sT3B0aW9ucyArPSBkaXN0cmlidXRlQW5kUmV0dXJuVG9Qb29sKGVtcC5wb29sT3B0aW9ucywgaSsxKTsKICAgICAgICAgIHRvdGFsRXh0cmFPcHRpb25zIC09IGVtcC5leHRyYU9wdGlvbnM7CiAgICAgICAgICAvLyBhY3R1YWxseSB0aGlzIGp1c3Qgc2V0cyBhZGRyZXNzIHRvIDAgc28gaXRlcmF0b3IgY2FuIGNvbnRpbnVlCiAgICAgICAgICBlbXBsb3llZXMucmVtb3ZlRW1wbG95ZWUoZWEpOwogICAgICAgIH0KICAgICAgICAvLyByZXR1cm4gZmFkZW91dCB0byBwb29sCiAgICAgICAgaWYgKGVtcC5zdGF0ZSA9PSBFbXBsb3llZVN0YXRlLlRlcm1pbmF0ZWQgJiYgY3QgPiBlbXAuZmFkZW91dFN0YXJ0cykgewogICAgICAgICAgdmFyIChyZXR1cm5lZFBvb2xPcHRpb25zLCByZXR1cm5lZEV4dHJhT3B0aW9ucykgPSBvcHRpb25zQ2FsY3VsYXRvci5jYWxjdWxhdGVGYWRlb3V0VG9Qb29sKGN0LCBzZXIpOwogICAgICAgICAgaWYgKHJldHVybmVkUG9vbE9wdGlvbnMgPiAwIHx8IHJldHVybmVkRXh0cmFPcHRpb25zID4gMCkgewogICAgICAgICAgICBlbXBsb3llZXMuc2V0RmFkZW91dFN0YXJ0cyhlYSwgY3QpOwogICAgICAgICAgICAvLyBvcHRpb25zIGZyb20gZmFkZW91dCBhcmUgbm90IGRpc3RyaWJ1dGVkIHRvIG90aGVyIGVtcGxveWVlcyBidXQgcmV0dXJuZWQgdG8gcG9vbAogICAgICAgICAgICByZW1haW5pbmdQb29sT3B0aW9ucyArPSByZXR1cm5lZFBvb2xPcHRpb25zOwogICAgICAgICAgICAvLyB3ZSBtYWludGFpbiBleHRyYVBvb2wgZm9yIGVhc2llciBzdGF0aXN0aWNzCiAgICAgICAgICAgIHRvdGFsRXh0cmFPcHRpb25zIC09IHJldHVybmVkRXh0cmFPcHRpb25zOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KCiAgZnVuY3Rpb24gb3BlbkVTT1AodWludDMyIHBUb3RhbFBvb2xPcHRpb25zLCBieXRlcyBwRVNPUExlZ2FsV3JhcHBlcklQRlNIYXNoKQogICAgZXh0ZXJuYWwKICAgIG9ubHlDb21wYW55CiAgICBvbmx5RVNPUE5ldwogICAgaXNDdXJyZW50Q29kZQogICAgcmV0dXJucyAoUmV0dXJuQ29kZXMpCiAgewogICAgLy8gb3B0aW9ucyBhcmUgc3RvcmVkIGluIHVuaXQzMgogICAgaWYgKHBUb3RhbFBvb2xPcHRpb25zID4gMTEwMDAwMCB8fCBwVG90YWxQb29sT3B0aW9ucyA8IDEwMDAwKSB7CiAgICAgIHJldHVybiBfbG9nZXJyb3IoUmV0dXJuQ29kZXMuSW52YWxpZFBhcmFtZXRlcnMpOwogICAgfQoKICAgIHRvdGFsUG9vbE9wdGlvbnMgPSBwVG90YWxQb29sT3B0aW9uczsKICAgIHJlbWFpbmluZ1Bvb2xPcHRpb25zID0gdG90YWxQb29sT3B0aW9uczsKICAgIEVTT1BMZWdhbFdyYXBwZXJJUEZTSGFzaCA9IHBFU09QTGVnYWxXcmFwcGVySVBGU0hhc2g7CgogICAgZXNvcFN0YXRlID0gRVNPUFN0YXRlLk9wZW47CiAgICBFU09QT3BlbmVkKGNvbXBhbnlBZGRyZXNzKTsKICAgIHJldHVybiBSZXR1cm5Db2Rlcy5PSzsKICB9CgogIGZ1bmN0aW9uIG9mZmVyT3B0aW9uc1RvRW1wbG95ZWUoYWRkcmVzcyBlLCB1aW50MzIgaXNzdWVEYXRlLCB1aW50MzIgdGltZVRvU2lnbiwgdWludDMyIGV4dHJhT3B0aW9ucywgYm9vbCBwb29sQ2xlYW51cCkKICAgIGV4dGVybmFsCiAgICBvbmx5RVNPUE9wZW4KICAgIG9ubHlDb21wYW55CiAgICBpc0N1cnJlbnRDb2RlCiAgICByZXR1cm5zIChSZXR1cm5Db2RlcykKICB7CiAgICAvLyBkbyBub3QgYWRkIHR3aWNlCiAgICBpZiAoZW1wbG95ZWVzLmhhc0VtcGxveWVlKGUpKSB7CiAgICAgIHJldHVybiBfbG9nZXJyb3IoUmV0dXJuQ29kZXMuSW52YWxpZEVtcGxveWVlU3RhdGUpOwogICAgfQogICAgaWYgKHRpbWVUb1NpZ24gPCBjdXJyZW50VGltZSgpICsgTUlOSU1VTV9NQU5VQUxfU0lHTl9QRVJJT0QpIHsKICAgICAgcmV0dXJuIF9sb2dlcnJvcihSZXR1cm5Db2Rlcy5Ub29MYXRlKTsKICAgIH0KICAgIGlmIChwb29sQ2xlYW51cCkgewogICAgICAvLyByZWNvdmVyIHBvb2xPcHRpb25zIGZvciBlbXBsb3llZXMgd2l0aCBleHBpcmVkIHNpZ25hdHVyZXMKICAgICAgLy8gcmV0dXJuIGZhZGUgb3V0IHRvIHBvb2wKICAgICAgcmVtb3ZlRW1wbG95ZWVzV2l0aEV4cGlyZWRTaWduYXR1cmVzQW5kUmV0dXJuRmFkZW91dCgpOwogICAgfQogICAgdWludCBwb29sT3B0aW9ucyA9IG9wdGlvbnNDYWxjdWxhdG9yLmNhbGNOZXdFbXBsb3llZVBvb2xPcHRpb25zKHJlbWFpbmluZ1Bvb2xPcHRpb25zKTsKICAgIGlmIChwb29sT3B0aW9ucyA+IDB4RkZGRkZGRkYpCiAgICAgIHRocm93OwogICAgRW1wbG95ZWUgbWVtb3J5IGVtcCA9IEVtcGxveWVlKHsKICAgICAgaXNzdWVEYXRlOiBpc3N1ZURhdGUsIHRpbWVUb1NpZ246IHRpbWVUb1NpZ24sIHRlcm1pbmF0ZWRBdDogMCwgZmFkZW91dFN0YXJ0czogMCwgcG9vbE9wdGlvbnM6IHVpbnQzMihwb29sT3B0aW9ucyksCiAgICAgIGV4dHJhT3B0aW9uczogZXh0cmFPcHRpb25zLCBzdXNwZW5kZWRBdDogMCwgc3RhdGU6IEVtcGxveWVlU3RhdGUuV2FpdGluZ0ZvclNpZ25hdHVyZSwgaWR4OiAwCiAgICB9KTsKICAgIF9zYXZlZW1wKGUsIGVtcCk7CiAgICByZW1haW5pbmdQb29sT3B0aW9ucyAtPSBwb29sT3B0aW9uczsKICAgIHRvdGFsRXh0cmFPcHRpb25zICs9IGV4dHJhT3B0aW9uczsKICAgIEVTT1BPZmZlcmVkKGUsIGNvbXBhbnlBZGRyZXNzLCB1aW50MzIocG9vbE9wdGlvbnMpLCBleHRyYU9wdGlvbnMpOwogICAgcmV0dXJuIFJldHVybkNvZGVzLk9LOwogIH0KCiAgLy8gdG9kbzogaW1wbGVtZW50IGdyb3VwIGFkZCBzb21lZGF5LCBob3dldmVyIGZ1bmMgZGlzdHJpYnV0ZUFuZFJldHVyblRvUG9vbCBnZXRzIHZlcnkgY29tcGxpY2F0ZWQKICAvLyB0b2RvOiBmdW5jdGlvbiBjYWxjTmV3RW1wbG95ZWVQb29sT3B0aW9ucyh1aW50IHJlbWFpbmluZywgdWludDggZ3JvdXBTaXplKQogIC8vIHRvZG86IGZ1bmN0aW9uIGFkZE5ld0VtcGxveWVlc1RvRVNPUChhZGRyZXNzW10gZW1wcywgdWludDMyIGlzc3VlRGF0ZSwgdWludDMyIHRpbWVUb1NpZ24pCgogIGZ1bmN0aW9uIG9mZmVyT3B0aW9uc1RvRW1wbG95ZWVPbmx5RXh0cmEoYWRkcmVzcyBlLCB1aW50MzIgaXNzdWVEYXRlLCB1aW50MzIgdGltZVRvU2lnbiwgdWludDMyIGV4dHJhT3B0aW9ucykKICAgIGV4dGVybmFsCiAgICBvbmx5RVNPUE9wZW4KICAgIG9ubHlDb21wYW55CiAgICBpc0N1cnJlbnRDb2RlCiAgICByZXR1cm5zIChSZXR1cm5Db2RlcykKICB7CiAgICAvLyBkbyBub3QgYWRkIHR3aWNlCiAgICBpZiAoZW1wbG95ZWVzLmhhc0VtcGxveWVlKGUpKSB7CiAgICAgIHJldHVybiBfbG9nZXJyb3IoUmV0dXJuQ29kZXMuSW52YWxpZEVtcGxveWVlU3RhdGUpOwogICAgfQogICAgaWYgKHRpbWVUb1NpZ24gPCBjdXJyZW50VGltZSgpICsgTUlOSU1VTV9NQU5VQUxfU0lHTl9QRVJJT0QpIHsKICAgICAgcmV0dXJuIF9sb2dlcnJvcihSZXR1cm5Db2Rlcy5Ub29MYXRlKTsKICAgIH0KICAgIEVtcGxveWVlIG1lbW9yeSBlbXAgPSBFbXBsb3llZSh7CiAgICAgIGlzc3VlRGF0ZTogaXNzdWVEYXRlLCB0aW1lVG9TaWduOiB0aW1lVG9TaWduLCB0ZXJtaW5hdGVkQXQ6IDAsIGZhZGVvdXRTdGFydHM6IDAsIHBvb2xPcHRpb25zOiAwLAogICAgICBleHRyYU9wdGlvbnM6IGV4dHJhT3B0aW9ucywgc3VzcGVuZGVkQXQ6IDAsIHN0YXRlOiBFbXBsb3llZVN0YXRlLldhaXRpbmdGb3JTaWduYXR1cmUsIGlkeDogMAogICAgfSk7CiAgICBfc2F2ZWVtcChlLCBlbXApOwogICAgdG90YWxFeHRyYU9wdGlvbnMgKz0gZXh0cmFPcHRpb25zOwogICAgRVNPUE9mZmVyZWQoZSwgY29tcGFueUFkZHJlc3MsIDAsIGV4dHJhT3B0aW9ucyk7CiAgICByZXR1cm4gUmV0dXJuQ29kZXMuT0s7CiAgfQoKICBmdW5jdGlvbiBpbmNyZWFzZUVtcGxveWVlRXh0cmFPcHRpb25zKGFkZHJlc3MgZSwgdWludDMyIGV4dHJhT3B0aW9ucykKICAgIGV4dGVybmFsCiAgICBvbmx5RVNPUE9wZW4KICAgIG9ubHlDb21wYW55CiAgICBpc0N1cnJlbnRDb2RlCiAgICBoYXNFbXBsb3llZShlKQogICAgcmV0dXJucyAoUmV0dXJuQ29kZXMpCiAgewogICAgRW1wbG95ZWUgbWVtb3J5IGVtcCA9IF9sb2FkZW1wKGUpOwogICAgaWYgKGVtcC5zdGF0ZSAhPSBFbXBsb3llZVN0YXRlLkVtcGxveWVkICYmIGVtcC5zdGF0ZSAhPSBFbXBsb3llZVN0YXRlLldhaXRpbmdGb3JTaWduYXR1cmUpIHsKICAgICAgcmV0dXJuIF9sb2dlcnJvcihSZXR1cm5Db2Rlcy5JbnZhbGlkRW1wbG95ZWVTdGF0ZSk7CiAgICB9CiAgICBlbXAuZXh0cmFPcHRpb25zICs9IGV4dHJhT3B0aW9uczsKICAgIF9zYXZlZW1wKGUsIGVtcCk7CiAgICB0b3RhbEV4dHJhT3B0aW9ucyArPSBleHRyYU9wdGlvbnM7CiAgICBFU09QT2ZmZXJlZChlLCBjb21wYW55QWRkcmVzcywgMCwgZXh0cmFPcHRpb25zKTsKICAgIHJldHVybiBSZXR1cm5Db2Rlcy5PSzsKICB9CgogIGZ1bmN0aW9uIGVtcGxveWVlU2lnbnNUb0VTT1AoKQogICAgZXh0ZXJuYWwKICAgIGhhc0VtcGxveWVlKG1zZy5zZW5kZXIpCiAgICBvbmx5RVNPUE9wZW4KICAgIGlzQ3VycmVudENvZGUKICAgIHJldHVybnMgKFJldHVybkNvZGVzKQogIHsKICAgIEVtcGxveWVlIG1lbW9yeSBlbXAgPSBfbG9hZGVtcChtc2cuc2VuZGVyKTsKICAgIGlmIChlbXAuc3RhdGUgIT0gRW1wbG95ZWVTdGF0ZS5XYWl0aW5nRm9yU2lnbmF0dXJlKSB7CiAgICAgIHJldHVybiBfbG9nZXJyb3IoUmV0dXJuQ29kZXMuSW52YWxpZEVtcGxveWVlU3RhdGUpOwogICAgfQogICAgdWludDMyIHQgPSBjdXJyZW50VGltZSgpOwogICAgaWYgKHQgPiBlbXAudGltZVRvU2lnbikgewogICAgICByZW1haW5pbmdQb29sT3B0aW9ucyArPSBkaXN0cmlidXRlQW5kUmV0dXJuVG9Qb29sKGVtcC5wb29sT3B0aW9ucywgZW1wLmlkeCk7CiAgICAgIHRvdGFsRXh0cmFPcHRpb25zIC09IGVtcC5leHRyYU9wdGlvbnM7CiAgICAgIGVtcGxveWVlcy5yZW1vdmVFbXBsb3llZShtc2cuc2VuZGVyKTsKICAgICAgcmV0dXJuIF9sb2dlcnJvcihSZXR1cm5Db2Rlcy5Ub29MYXRlKTsKICAgIH0KICAgIGVtcGxveWVlcy5jaGFuZ2VTdGF0ZShtc2cuc2VuZGVyLCBFbXBsb3llZVN0YXRlLkVtcGxveWVkKTsKICAgIEVtcGxveWVlU2lnbmVkVG9FU09QKG1zZy5zZW5kZXIpOwogICAgcmV0dXJuIFJldHVybkNvZGVzLk9LOwogIH0KCiAgZnVuY3Rpb24gdG9nZ2xlRW1wbG95ZWVTdXNwZW5zaW9uKGFkZHJlc3MgZSwgdWludDMyIHRvZ2dsZWRBdCkKICAgIGV4dGVybmFsCiAgICBvbmx5RVNPUE9wZW4KICAgIG9ubHlDb21wYW55CiAgICBoYXNFbXBsb3llZShlKQogICAgaXNDdXJyZW50Q29kZQogICAgcmV0dXJucyAoUmV0dXJuQ29kZXMpCiAgewogICAgRW1wbG95ZWUgbWVtb3J5IGVtcCA9IF9sb2FkZW1wKGUpOwogICAgaWYgKGVtcC5zdGF0ZSAhPSBFbXBsb3llZVN0YXRlLkVtcGxveWVkKSB7CiAgICAgIHJldHVybiBfbG9nZXJyb3IoUmV0dXJuQ29kZXMuSW52YWxpZEVtcGxveWVlU3RhdGUpOwogICAgfQogICAgaWYgKGVtcC5zdXNwZW5kZWRBdCA9PSAwKSB7CiAgICAgIC8vc3VzcGVuZCBhY3Rpb24KICAgICAgZW1wLnN1c3BlbmRlZEF0ID0gdG9nZ2xlZEF0OwogICAgICBTdXNwZW5kRW1wbG95ZWUoZSwgdG9nZ2xlZEF0KTsKICAgIH0gZWxzZSB7CiAgICAgIGlmIChlbXAuc3VzcGVuZGVkQXQgPiB0b2dnbGVkQXQpIHsKICAgICAgICByZXR1cm4gX2xvZ2Vycm9yKFJldHVybkNvZGVzLlRvb0xhdGUpOwogICAgICB9CiAgICAgIHVpbnQzMiBzdXNwZW5kZWRQZXJpb2QgPSB0b2dnbGVkQXQgLSBlbXAuc3VzcGVuZGVkQXQ7CiAgICAgIC8vIG1vdmUgZXZlcnl0aGluZyBieSBzdXNwZW5zaW9uIHBlcmlvZCBieSBjaGFuZ2luZyBpc3N1ZURhdGUKICAgICAgZW1wLmlzc3VlRGF0ZSArPSBzdXNwZW5kZWRQZXJpb2Q7CiAgICAgIGVtcC5zdXNwZW5kZWRBdCA9IDA7CiAgICAgIENvbnRpbnVlU3VzcGVuZGVkRW1wbG95ZWUoZSwgdG9nZ2xlZEF0LCBzdXNwZW5kZWRQZXJpb2QpOwogICAgfQogICAgX3NhdmVlbXAoZSwgZW1wKTsKICAgIHJldHVybiBSZXR1cm5Db2Rlcy5PSzsKICB9CgogIGZ1bmN0aW9uIHRlcm1pbmF0ZUVtcGxveWVlKGFkZHJlc3MgZSwgdWludDMyIHRlcm1pbmF0ZWRBdCwgdWludDggdGVybWluYXRpb25UeXBlKQogICAgZXh0ZXJuYWwKICAgIG9ubHlFU09QT3BlbgogICAgb25seUNvbXBhbnkKICAgIGhhc0VtcGxveWVlKGUpCiAgICBpc0N1cnJlbnRDb2RlCiAgICByZXR1cm5zIChSZXR1cm5Db2RlcykKICB7CiAgICAvLyB0ZXJtaW5hdGVzIGFuIGVtcGxveWVlCiAgICBUZXJtaW5hdGlvblR5cGUgdGVybVR5cGUgPSBUZXJtaW5hdGlvblR5cGUodGVybWluYXRpb25UeXBlKTsKICAgIEVtcGxveWVlIG1lbW9yeSBlbXAgPSBfbG9hZGVtcChlKTsKICAgIC8vIHRvZG86IGNoZWNrIHRlcm1pbmF0aW9uIHRpbWUgYWdhaW5zdCBpc3N1ZURhdGUKICAgIGlmICh0ZXJtaW5hdGVkQXQgPCBlbXAuaXNzdWVEYXRlKSB7CiAgICAgIHJldHVybiBfbG9nZXJyb3IoUmV0dXJuQ29kZXMuSW52YWxpZFBhcmFtZXRlcnMpOwogICAgfQogICAgaWYgKGVtcC5zdGF0ZSA9PSBFbXBsb3llZVN0YXRlLldhaXRpbmdGb3JTaWduYXR1cmUpCiAgICAgIHRlcm1UeXBlID0gVGVybWluYXRpb25UeXBlLkJhZExlYXZlcjsKICAgIGVsc2UgaWYgKGVtcC5zdGF0ZSAhPSBFbXBsb3llZVN0YXRlLkVtcGxveWVkKSB7CiAgICAgIHJldHVybiBfbG9nZXJyb3IoUmV0dXJuQ29kZXMuSW52YWxpZEVtcGxveWVlU3RhdGUpOwogICAgfQogICAgLy8gaG93IG1hbnkgcG9vbE9wdGlvbnMgcmV0dXJuZWQgdG8gcG9vbAogICAgdWludCByZXR1cm5lZE9wdGlvbnM7CiAgICB1aW50IHJldHVybmVkRXh0cmFPcHRpb25zOwogICAgaWYgKHRlcm1UeXBlID09IFRlcm1pbmF0aW9uVHlwZS5SZWd1bGFyKSB7CiAgICAgIC8vIHJlZ3VsYXIgdGVybWluYXRpb24sIGNvbXB1dGUgc3VzcGVuc2lvbgogICAgICBpZiAoZW1wLnN1c3BlbmRlZEF0ID4gMCAmJiBlbXAuc3VzcGVuZGVkQXQgPCB0ZXJtaW5hdGVkQXQpCiAgICAgICAgZW1wLmlzc3VlRGF0ZSArPSB0ZXJtaW5hdGVkQXQgLSBlbXAuc3VzcGVuZGVkQXQ7CiAgICAgIC8vIHZlc3RpbmcgYXBwbGllcwogICAgICByZXR1cm5lZE9wdGlvbnMgPSBlbXAucG9vbE9wdGlvbnMgLSBvcHRpb25zQ2FsY3VsYXRvci5jYWxjdWxhdGVWZXN0ZWRPcHRpb25zKHRlcm1pbmF0ZWRBdCwgZW1wLmlzc3VlRGF0ZSwgZW1wLnBvb2xPcHRpb25zKTsKICAgICAgcmV0dXJuZWRFeHRyYU9wdGlvbnMgPSBlbXAuZXh0cmFPcHRpb25zIC0gb3B0aW9uc0NhbGN1bGF0b3IuY2FsY3VsYXRlVmVzdGVkT3B0aW9ucyh0ZXJtaW5hdGVkQXQsIGVtcC5pc3N1ZURhdGUsIGVtcC5leHRyYU9wdGlvbnMpOwogICAgICBlbXBsb3llZXMudGVybWluYXRlRW1wbG95ZWUoZSwgZW1wLmlzc3VlRGF0ZSwgdGVybWluYXRlZEF0LCB0ZXJtaW5hdGVkQXQsIEVtcGxveWVlU3RhdGUuVGVybWluYXRlZCk7CiAgICB9IGVsc2UgaWYgKHRlcm1UeXBlID09IFRlcm1pbmF0aW9uVHlwZS5CYWRMZWF2ZXIpIHsKICAgICAgLy8gYmFkIGxlYXZlciAtIGVtcGxveWVlIGlzIGtpY2tlZCBvdXQgZnJvbSBFU09QLCByZXR1cm4gYWxsIHBvb2xPcHRpb25zCiAgICAgIHJldHVybmVkT3B0aW9ucyA9IGVtcC5wb29sT3B0aW9uczsKICAgICAgcmV0dXJuZWRFeHRyYU9wdGlvbnMgPSBlbXAuZXh0cmFPcHRpb25zOwogICAgICBlbXBsb3llZXMucmVtb3ZlRW1wbG95ZWUoZSk7CiAgICB9CiAgICByZW1haW5pbmdQb29sT3B0aW9ucyArPSBkaXN0cmlidXRlQW5kUmV0dXJuVG9Qb29sKHJldHVybmVkT3B0aW9ucywgZW1wLmlkeCk7CiAgICB0b3RhbEV4dHJhT3B0aW9ucyAtPSByZXR1cm5lZEV4dHJhT3B0aW9uczsKICAgIFRlcm1pbmF0ZUVtcGxveWVlKGUsIGNvbXBhbnlBZGRyZXNzLCB0ZXJtaW5hdGVkQXQsIHRlcm1UeXBlKTsKICAgIHJldHVybiBSZXR1cm5Db2Rlcy5PSzsKICB9CgogIGZ1bmN0aW9uIG9mZmVyT3B0aW9uc0NvbnZlcnNpb24oQmFzZU9wdGlvbnNDb252ZXJ0ZXIgY29udmVydGVyKQogICAgZXh0ZXJuYWwKICAgIG9ubHlFU09QT3BlbgogICAgb25seUNvbXBhbnkKICAgIGlzQ3VycmVudENvZGUKICAgIHJldHVybnMgKFJldHVybkNvZGVzKQogIHsKICAgIHVpbnQzMiBvZmZlck1hZGVBdCA9IGN1cnJlbnRUaW1lKCk7CiAgICBpZiAoY29udmVydGVyLmdldEV4ZXJjaXNlUGVyaW9kRGVhZGxpbmUoKSAtIG9mZmVyTWFkZUF0IDwgTUlOSU1VTV9NQU5VQUxfU0lHTl9QRVJJT0QpIHsKICAgICAgcmV0dXJuIF9sb2dlcnJvcihSZXR1cm5Db2Rlcy5Ub29MYXRlKTsKICAgIH0KICAgIC8vIGV4ZXJjaXNlT3B0aW9ucyBtdXN0IGJlIGNhbGxhYmxlIGJ5IHVzCiAgICBpZiAoY29udmVydGVyLmdldEVTT1AoKSAhPSBhZGRyZXNzKHRoaXMpKSB7CiAgICAgIHJldHVybiBfbG9nZXJyb3IoUmV0dXJuQ29kZXMuSW52YWxpZFBhcmFtZXRlcnMpOwogICAgfQogICAgLy8gcmV0dXJuIHRvIHBvb2wgZXZlcnl0aGluZyB3ZSBjYW4KICAgIHJlbW92ZUVtcGxveWVlc1dpdGhFeHBpcmVkU2lnbmF0dXJlc0FuZFJldHVybkZhZGVvdXQoKTsKICAgIC8vIGZyb20gbm93IHZlc3RpbmcgYW5kIGZhZGVvdXQgc3RvcHMsIG5vIG5ldyBlbXBsb3llZXMgbWF5IGJlIGFkZGVkCiAgICBjb252ZXJzaW9uT2ZmZXJlZEF0ID0gb2ZmZXJNYWRlQXQ7CiAgICBleGVyY2lzZU9wdGlvbnNEZWFkbGluZSA9IGNvbnZlcnRlci5nZXRFeGVyY2lzZVBlcmlvZERlYWRsaW5lKCk7CiAgICBvcHRpb25zQ29udmVydGVyID0gY29udmVydGVyOwogICAgLy8gdGhpcyBpcyB2ZXJ5IGlycmV2ZXJzaWJsZQogICAgZXNvcFN0YXRlID0gRVNPUFN0YXRlLkNvbnZlcnNpb247CiAgICBPcHRpb25zQ29udmVyc2lvbk9mZmVyZWQoY29tcGFueUFkZHJlc3MsIGFkZHJlc3MoY29udmVydGVyKSwgb2ZmZXJNYWRlQXQsIGV4ZXJjaXNlT3B0aW9uc0RlYWRsaW5lKTsKICAgIHJldHVybiBSZXR1cm5Db2Rlcy5PSzsKICB9CgogIGZ1bmN0aW9uIGV4ZXJjaXNlT3B0aW9uc0ludGVybmFsKHVpbnQzMiBjYWxjQXRUaW1lLCBhZGRyZXNzIGVtcGxveWVlLCBhZGRyZXNzIGV4ZXJjaXNlRm9yLAogICAgYm9vbCBkaXNhYmxlQWNjZWxlcmF0ZWRWZXN0aW5nKQogICAgaW50ZXJuYWwKICAgIHJldHVybnMgKFJldHVybkNvZGVzKQogIHsKICAgIEVtcGxveWVlIG1lbW9yeSBlbXAgPSBfbG9hZGVtcChlbXBsb3llZSk7CiAgICBpZiAoZW1wLnN0YXRlID09IEVtcGxveWVlU3RhdGUuT3B0aW9uc0V4ZXJjaXNlZCkgewogICAgICByZXR1cm4gX2xvZ2Vycm9yKFJldHVybkNvZGVzLkludmFsaWRFbXBsb3llZVN0YXRlKTsKICAgIH0KICAgIC8vIGlmIHdlIGFyZSBidXJuaW5nIG9wdGlvbnMgdGhlbiBzZW5kIDAKICAgIGlmIChleGVyY2lzZUZvciAhPSBhZGRyZXNzKDApKSB7CiAgICAgIHZhciAocG9vbCwgZXh0cmEsIGJvbnVzKSA9IG9wdGlvbnNDYWxjdWxhdG9yLmNhbGN1bGF0ZU9wdGlvbnNDb21wb25lbnRzKHNlcmlhbGl6ZUVtcGxveWVlKGVtcCksCiAgICAgICAgY2FsY0F0VGltZSwgY29udmVyc2lvbk9mZmVyZWRBdCwgZGlzYWJsZUFjY2VsZXJhdGVkVmVzdGluZyk7CiAgICAgIH0KICAgIC8vIGNhbGwgYmVmb3JlIG9wdGlvbnMgY29udmVyc2lvbiBjb250cmFjdCB0byBwcmV2ZW50IHJlLWVudHJ5CiAgICBlbXBsb3llZXMuY2hhbmdlU3RhdGUoZW1wbG95ZWUsIEVtcGxveWVlU3RhdGUuT3B0aW9uc0V4ZXJjaXNlZCk7CiAgICAvLyBleGVyY2lzZSBvcHRpb25zIGluIHRoZSBuYW1lIG9mIGVtcGxveWVlIGFuZCBhc3NpZ24gdGhvc2UgdG8gZXhlcmNpc2VGb3IKICAgIG9wdGlvbnNDb252ZXJ0ZXIuZXhlcmNpc2VPcHRpb25zKGV4ZXJjaXNlRm9yLCBwb29sLCBleHRyYSwgYm9udXMsICFkaXNhYmxlQWNjZWxlcmF0ZWRWZXN0aW5nKTsKICAgIEVtcGxveWVlT3B0aW9uc0V4ZXJjaXNlZChlbXBsb3llZSwgZXhlcmNpc2VGb3IsIHVpbnQzMihwb29sICsgZXh0cmEgKyBib251cyksICFkaXNhYmxlQWNjZWxlcmF0ZWRWZXN0aW5nKTsKICAgIHJldHVybiBSZXR1cm5Db2Rlcy5PSzsKICB9CgogIGZ1bmN0aW9uIGVtcGxveWVlRXhlcmNpc2VPcHRpb25zKGJvb2wgYWdyZWVUb0FjY2VsZXJhdGVkVmVzdGluZ0JvbnVzQ29uZGl0aW9ucykKICAgIGV4dGVybmFsCiAgICBvbmx5RVNPUENvbnZlcnNpb24KICAgIGhhc0VtcGxveWVlKG1zZy5zZW5kZXIpCiAgICBpc0N1cnJlbnRDb2RlCiAgICByZXR1cm5zIChSZXR1cm5Db2RlcykKICB7CiAgICB1aW50MzIgY3QgPSBjdXJyZW50VGltZSgpOwogICAgaWYgKGN0ID4gZXhlcmNpc2VPcHRpb25zRGVhZGxpbmUpIHsKICAgICAgcmV0dXJuIF9sb2dlcnJvcihSZXR1cm5Db2Rlcy5Ub29MYXRlKTsKICAgIH0KICAgIHJldHVybiBleGVyY2lzZU9wdGlvbnNJbnRlcm5hbChjdCwgbXNnLnNlbmRlciwgbXNnLnNlbmRlciwgIWFncmVlVG9BY2NlbGVyYXRlZFZlc3RpbmdCb251c0NvbmRpdGlvbnMpOwogIH0KCiAgZnVuY3Rpb24gZW1wbG95ZWVEZW55RXhlcmNpc2VPcHRpb25zKCkKICAgIGV4dGVybmFsCiAgICBvbmx5RVNPUENvbnZlcnNpb24KICAgIGhhc0VtcGxveWVlKG1zZy5zZW5kZXIpCiAgICBpc0N1cnJlbnRDb2RlCiAgICByZXR1cm5zIChSZXR1cm5Db2RlcykKICB7CiAgICB1aW50MzIgY3QgPSBjdXJyZW50VGltZSgpOwogICAgaWYgKGN0ID4gZXhlcmNpc2VPcHRpb25zRGVhZGxpbmUpIHsKICAgICAgcmV0dXJuIF9sb2dlcnJvcihSZXR1cm5Db2Rlcy5Ub29MYXRlKTsKICAgIH0KICAgIC8vIGJ1cm4gdGhlIG9wdGlvbnMgYnkgc2VuZGluZyB0byAwCiAgICByZXR1cm4gZXhlcmNpc2VPcHRpb25zSW50ZXJuYWwoY3QsIG1zZy5zZW5kZXIsIGFkZHJlc3MoMCksIHRydWUpOwogIH0KCiAgZnVuY3Rpb24gZXhlcmNpc2VFeHBpcmVkRW1wbG95ZWVPcHRpb25zKGFkZHJlc3MgZSwgYm9vbCBkaXNhYmxlQWNjZWxlcmF0ZWRWZXN0aW5nKQogICAgZXh0ZXJuYWwKICAgIG9ubHlFU09QQ29udmVyc2lvbgogICAgb25seUNvbXBhbnkKICAgIGhhc0VtcGxveWVlKGUpCiAgICBpc0N1cnJlbnRDb2RlCiAgcmV0dXJucyAoUmV0dXJuQ29kZXMpCiAgewogICAgLy8gY29tcGFueSBjYW4gY29udmVydCBvcHRpb25zIGZvciBhbnkgZW1wbG95ZWUgdGhhdCBkaWQgbm90IGNvbnZlcnRlZCAoYWZ0ZXIgZGVhZGxpbmUpCiAgICB1aW50MzIgY3QgPSBjdXJyZW50VGltZSgpOwogICAgaWYgKGN0IDw9IGV4ZXJjaXNlT3B0aW9uc0RlYWRsaW5lKSB7CiAgICAgIHJldHVybiBfbG9nZXJyb3IoUmV0dXJuQ29kZXMuVG9vRWFybHkpOwogICAgfQogICAgcmV0dXJuIGV4ZXJjaXNlT3B0aW9uc0ludGVybmFsKGN0LCBlLCBjb21wYW55QWRkcmVzcywgZGlzYWJsZUFjY2VsZXJhdGVkVmVzdGluZyk7CiAgfQoKICBmdW5jdGlvbiBhbGxvd0VtcGxveWVlTWlncmF0aW9uKGFkZHJlc3MgZW1wbG95ZWUsIEVTT1BNaWdyYXRpb24gbWlncmF0aW9uKQogICAgZXh0ZXJuYWwKICAgIG9ubHlFU09QT3BlbgogICAgaGFzRW1wbG95ZWUoZW1wbG95ZWUpCiAgICBvbmx5Q29tcGFueQogICAgaXNDdXJyZW50Q29kZQogICAgcmV0dXJucyAoUmV0dXJuQ29kZXMpCiAgewogICAgaWYgKGFkZHJlc3MobWlncmF0aW9uKSA9PSAwKQogICAgICB0aHJvdzsKICAgIC8vIG9ubHkgZW1wbG95ZWQgYW5kIHRlcm1pbmF0ZWQgdXNlcnMgbWF5IG1pZ3JhdGUKICAgIEVtcGxveWVlIG1lbW9yeSBlbXAgPSBfbG9hZGVtcChlbXBsb3llZSk7CiAgICBpZiAoZW1wLnN0YXRlICE9IEVtcGxveWVlU3RhdGUuRW1wbG95ZWQgJiYgZW1wLnN0YXRlICE9IEVtcGxveWVlU3RhdGUuVGVybWluYXRlZCkgewogICAgICByZXR1cm4gX2xvZ2Vycm9yKFJldHVybkNvZGVzLkludmFsaWRFbXBsb3llZVN0YXRlKTsKICAgIH0KICAgIG1pZ3JhdGlvbnNbZW1wbG95ZWVdID0gbWlncmF0aW9uOyAvLyBjYW4gYmUgY2xlYXJlZCB3aXRoIDAgYWRkcmVzcwogICAgcmV0dXJuIFJldHVybkNvZGVzLk9LOwogIH0KCiAgZnVuY3Rpb24gZW1wbG95ZWVNaWdyYXRlc1RvTmV3RVNPUChFU09QTWlncmF0aW9uIG1pZ3JhdGlvbikKICAgIGV4dGVybmFsCiAgICBvbmx5RVNPUE9wZW4KICAgIGhhc0VtcGxveWVlKG1zZy5zZW5kZXIpCiAgICBpc0N1cnJlbnRDb2RlCiAgICByZXR1cm5zIChSZXR1cm5Db2RlcykKICB7CiAgICAvLyBlbXBsb3llZSBtYXkgbWlncmF0ZSB0byBuZXcgRVNPUCBjb250cmFjdCB3aXRoIGRpZmZlcmVudCBydWxlcwogICAgLy8gaWYgbWlncmF0aW9uIG5vdCBzZXQgdXAgYnkgY29tcGFueSB0aGVuIHRocm93CiAgICBpZiAoYWRkcmVzcyhtaWdyYXRpb24pID09IDAgfHwgbWlncmF0aW9uc1ttc2cuc2VuZGVyXSAhPSBtaWdyYXRpb24pCiAgICAgIHRocm93OwogICAgLy8gZmlyc3QgZ2l2ZSBiYWNrIHdoYXQgeW91IGFscmVhZHkgb3duCiAgICByZW1vdmVFbXBsb3llZXNXaXRoRXhwaXJlZFNpZ25hdHVyZXNBbmRSZXR1cm5GYWRlb3V0KCk7CiAgICAvLyBvbmx5IGVtcGxveWVkIGFuZCB0ZXJtaW5hdGVkIHVzZXJzIG1heSBtaWdyYXRlCiAgICBFbXBsb3llZSBtZW1vcnkgZW1wID0gX2xvYWRlbXAobXNnLnNlbmRlcik7CiAgICBpZiAoZW1wLnN0YXRlICE9IEVtcGxveWVlU3RhdGUuRW1wbG95ZWQgJiYgZW1wLnN0YXRlICE9IEVtcGxveWVlU3RhdGUuVGVybWluYXRlZCkgewogICAgICByZXR1cm4gX2xvZ2Vycm9yKFJldHVybkNvZGVzLkludmFsaWRFbXBsb3llZVN0YXRlKTsKICAgIH0KICAgIC8vIHdpdGggYWNjZWxlcmF0ZWQgdmVzdGluZyBpZiBwb3NzaWJsZSAtIHRha2Ugb3V0IGFsbCBwb3NzaWJsZSBvcHRpb25zCiAgICB2YXIgKHBvb2wsIGV4dHJhLCBfKSA9IG9wdGlvbnNDYWxjdWxhdG9yLmNhbGN1bGF0ZU9wdGlvbnNDb21wb25lbnRzKHNlcmlhbGl6ZUVtcGxveWVlKGVtcCksIGN1cnJlbnRUaW1lKCksIDAsIGZhbHNlKTsKICAgIGRlbGV0ZSBtaWdyYXRpb25zW21zZy5zZW5kZXJdOwogICAgLy8gZXhlY3V0ZSBtaWdyYXRpb24gcHJvY2VkdXJlCiAgICBtaWdyYXRpb24ubWlncmF0ZShtc2cuc2VuZGVyLCBwb29sLCBleHRyYSk7CiAgICAvLyBleHRyYSBvcHRpb25zIGFyZSBtb3ZlZCB0byBuZXcgY29udHJhY3QKICAgIHRvdGFsRXh0cmFPcHRpb25zIC09IGVtcC5zdGF0ZSA9PSBFbXBsb3llZVN0YXRlLkVtcGxveWVkID8gZW1wLmV4dHJhT3B0aW9ucyA6IGV4dHJhOwogICAgLy8gcG9vbCBvcHRpb25zIGFyZSBtb3ZlZCB0byBuZXcgY29udHJhY3QgYW5kIHJlbW92ZWQgZnJvbSBUaGUgUG9vbAogICAgLy8gcGxlYXNlIG5vdGUgdGhhdCBzZXBhcmF0ZSBQb29sIHdpbGwgbWFuYWdlIG1pZ3JhdGVkIG9wdGlvbnMgYW5kCiAgICAvLyBhbGdvcml0aG0gdGhhdCByZXR1cm5zIHRvIHBvb2wgYW5kIGRpc3RyaWJ1dGVzIHdpbGwgbm90IGJlIHVzZWQKICAgIHRvdGFsUG9vbE9wdGlvbnMgLT0gZW1wLnN0YXRlID09IEVtcGxveWVlU3RhdGUuRW1wbG95ZWQgPyBlbXAucG9vbE9wdGlvbnMgOiBwb29sOwogICAgLy8gZ29uZSBmcm9tIGN1cnJlbnQgY29udHJhY3QKICAgIGVtcGxveWVlcy5yZW1vdmVFbXBsb3llZShtc2cuc2VuZGVyKTsKICAgIEVtcGxveWVlTWlncmF0ZWQobXNnLnNlbmRlciwgbWlncmF0aW9uLCBwb29sLCBleHRyYSk7CiAgICByZXR1cm4gUmV0dXJuQ29kZXMuT0s7CiAgfQoKICBmdW5jdGlvbiBjYWxjRWZmZWN0aXZlT3B0aW9uc0ZvckVtcGxveWVlKGFkZHJlc3MgZSwgdWludDMyIGNhbGNBdFRpbWUpCiAgICBwdWJsaWMKICAgIGNvbnN0YW50CiAgICBoYXNFbXBsb3llZShlKQogICAgaXNDdXJyZW50Q29kZQogICAgcmV0dXJucyAodWludCkKICB7CiAgICByZXR1cm4gb3B0aW9uc0NhbGN1bGF0b3IuY2FsY3VsYXRlT3B0aW9ucyhlbXBsb3llZXMuZ2V0U2VyaWFsaXplZEVtcGxveWVlKGUpLCBjYWxjQXRUaW1lLCBjb252ZXJzaW9uT2ZmZXJlZEF0LCBmYWxzZSk7CiAgfQoKICBmdW5jdGlvbiBfbG9nZXJyb3IoUmV0dXJuQ29kZXMgYykgcHJpdmF0ZSByZXR1cm5zIChSZXR1cm5Db2RlcykgewogICAgUmV0dXJuQ29kZShjKTsKICAgIHJldHVybiBjOwogIH0KCiAgZnVuY3Rpb24gX2xvYWRlbXAoYWRkcmVzcyBlKSBwcml2YXRlIGNvbnN0YW50IHJldHVybnMgKEVtcGxveWVlIG1lbW9yeSkgewogICAgcmV0dXJuIGRlc2VyaWFsaXplRW1wbG95ZWUoZW1wbG95ZWVzLmdldFNlcmlhbGl6ZWRFbXBsb3llZShlKSk7CiAgfQoKICBmdW5jdGlvbiBfc2F2ZWVtcChhZGRyZXNzIGUsIEVtcGxveWVlIG1lbW9yeSBlbXApIHByaXZhdGUgewogICAgZW1wbG95ZWVzLnNldEVtcGxveWVlKGUsIGVtcC5pc3N1ZURhdGUsIGVtcC50aW1lVG9TaWduLCBlbXAudGVybWluYXRlZEF0LCBlbXAuZmFkZW91dFN0YXJ0cywgZW1wLnBvb2xPcHRpb25zLAogICAgICBlbXAuZXh0cmFPcHRpb25zLCBlbXAuc3VzcGVuZGVkQXQsIGVtcC5zdGF0ZSk7CiAgfQoKICBmdW5jdGlvbiBjb21wbGV0ZUNvZGVVcGRhdGUoKSBwdWJsaWMgb25seU93bmVyIGluQ29kZVVwZGF0ZSB7CiAgICBlbXBsb3llZXMudHJhbnNmZXJPd25lcnNoaXAobXNnLnNlbmRlcik7CiAgICBDb2RlVXBkYXRlYWJsZS5jb21wbGV0ZUNvZGVVcGRhdGUoKTsKICB9CgogIGZ1bmN0aW9uKCkKICAgICAgcGF5YWJsZQogIHsKICAgICAgdGhyb3c7CiAgfQoKICBmdW5jdGlvbiBFU09QKGFkZHJlc3MgY29tcGFueSwgYWRkcmVzcyBwUm9vdE9mVHJ1c3QsIE9wdGlvbnNDYWxjdWxhdG9yIHBPcHRpb25zQ2FsY3VsYXRvciwgRW1wbG95ZWVzTGlzdCBwRW1wbG95ZWVzTGlzdCkgewogICAgLy9lc29wU3RhdGUgPSBFU09QU3RhdGUuTmV3OyAvLyB0aGF0cyBpbml0aWFsIHZhbHVlCiAgICBjb21wYW55QWRkcmVzcyA9IGNvbXBhbnk7CiAgICByb290T2ZUcnVzdCA9IHBSb290T2ZUcnVzdDsKICAgIGVtcGxveWVlcyA9IHBFbXBsb3llZXNMaXN0OwogICAgb3B0aW9uc0NhbGN1bGF0b3IgPSBwT3B0aW9uc0NhbGN1bGF0b3I7CiAgfQp9CgoKCgpjb250cmFjdCBPcHRpb25zQ2FsY3VsYXRvciBpcyBPd25hYmxlLCBEZXN0cnVjdGFibGUsIE1hdGgsIEVTT1BUeXBlcyB7CiAgLy8gY2xpZmYgZHVyYXRpb24gaW4gc2Vjb25kcwogIHVpbnQgcHVibGljIGNsaWZmUGVyaW9kOwogIC8vIHZlc3RpbmcgZHVyYXRpb24gaW4gc2Vjb25kcwogIHVpbnQgcHVibGljIHZlc3RpbmdQZXJpb2Q7CiAgLy8gbWF4aW11bSBwcm9taWxsZSB0aGF0IGNhbiBmYWRlIG91dAogIHVpbnQgcHVibGljIG1heEZhZGVvdXRQcm9taWxsZTsKICAvLyBtaW5pbWFsIG9wdGlvbnMgYWZ0ZXIgZmFkZW91dAogIGZ1bmN0aW9uIHJlc2lkdWFsQW1vdW50UHJvbWlsbGUoKSBwdWJsaWMgY29uc3RhbnQgcmV0dXJucyh1aW50KSB7IHJldHVybiBGUF9TQ0FMRSAtIG1heEZhZGVvdXRQcm9taWxsZTsgfQogIC8vIGV4aXQgYm9udXMgcHJvbWlsbGUKICB1aW50IHB1YmxpYyBib251c09wdGlvbnNQcm9taWxsZTsKICAvLyBwZXIgbWlsbGUgb2YgdW5hc3NpZ25lZCBwb29sT3B0aW9ucyB0aGF0IG5ldyBlbXBsb3llZSBnZXRzCiAgdWludCBwdWJsaWMgbmV3RW1wbG95ZWVQb29sUHJvbWlsbGU7CiAgLy8gb3B0aW9ucyBwZXIgc2hhcmUKICB1aW50IHB1YmxpYyBvcHRpb25zUGVyU2hhcmU7CiAgLy8gb3B0aW9ucyBzdHJpa2UgcHJpY2UKICB1aW50IGNvbnN0YW50IHB1YmxpYyBTVFJJS0VfUFJJQ0UgPSAxOwogIC8vIGNvbXBhbnkgYWRkcmVzcwogIGFkZHJlc3MgcHVibGljIGNvbXBhbnlBZGRyZXNzOwogIC8vIGNoZWNrcyBpZiBjYWxjdWxhdG9yIGkgaW5pdGlhbGl6ZWQKICBmdW5jdGlvbiBoYXNQYXJhbWV0ZXJzKCkgcHVibGljIGNvbnN0YW50IHJldHVybnMoYm9vbCkgeyByZXR1cm4gb3B0aW9uc1BlclNoYXJlID4gMDsgfQoKICBtb2RpZmllciBvbmx5Q29tcGFueSgpIHsKICAgIGlmIChjb21wYW55QWRkcmVzcyAhPSBtc2cuc2VuZGVyKQogICAgICB0aHJvdzsKICAgIF87CiAgfQoKICBmdW5jdGlvbiBjYWxjTmV3RW1wbG95ZWVQb29sT3B0aW9ucyh1aW50IHJlbWFpbmluZ1Bvb2xPcHRpb25zKQogICAgcHVibGljCiAgICBjb25zdGFudAogICAgcmV0dXJucyAodWludCkKICB7CiAgICByZXR1cm4gZGl2Um91bmQocmVtYWluaW5nUG9vbE9wdGlvbnMgKiBuZXdFbXBsb3llZVBvb2xQcm9taWxsZSwgRlBfU0NBTEUpOwogIH0KCiAgZnVuY3Rpb24gY2FsY3VsYXRlVmVzdGVkT3B0aW9ucyh1aW50IHQsIHVpbnQgdmVzdGluZ1N0YXJ0cywgdWludCBvcHRpb25zKQogICAgcHVibGljCiAgICBjb25zdGFudAogICAgcmV0dXJucyAodWludCkKICB7CiAgICBpZiAodCA8PSB2ZXN0aW5nU3RhcnRzKQogICAgICByZXR1cm4gMDsKICAgIC8vIGFwcGx5IHZlc3RpbmcKICAgIHVpbnQgZWZmZWN0aXZlVGltZSA9IHQgLSB2ZXN0aW5nU3RhcnRzOwogICAgLy8gaWYgd2l0aGluIGNsaWZmIG5vdGhpbmcgaXMgZHVlCiAgICBpZiAoZWZmZWN0aXZlVGltZSA8IGNsaWZmUGVyaW9kKQogICAgICByZXR1cm4gMDsKICAgIGVsc2UKICAgICAgcmV0dXJuICBlZmZlY3RpdmVUaW1lIDwgdmVzdGluZ1BlcmlvZCA/IGRpdlJvdW5kKG9wdGlvbnMgKiBlZmZlY3RpdmVUaW1lLCB2ZXN0aW5nUGVyaW9kKSA6IG9wdGlvbnM7CiAgfQoKICBmdW5jdGlvbiBhcHBseUZhZGVvdXRUb09wdGlvbnModWludDMyIHQsIHVpbnQzMiBpc3N1ZURhdGUsIHVpbnQzMiB0ZXJtaW5hdGVkQXQsIHVpbnQgb3B0aW9ucywgdWludCB2ZXN0ZWRPcHRpb25zKQogICAgcHVibGljCiAgICBjb25zdGFudAogICAgcmV0dXJucyAodWludCkKICB7CiAgICBpZiAodCA8IHRlcm1pbmF0ZWRBdCkKICAgICAgcmV0dXJuIHZlc3RlZE9wdGlvbnM7CiAgICB1aW50IHRpbWVmcm9tVGVybWluYXRpb24gPSB0IC0gdGVybWluYXRlZEF0OwogICAgLy8gZmFkZW91dCBkdXJhdGlvbiBlcXVhbHMgdG8gZW1wbG95bWVudCBkdXJhdGlvbgogICAgdWludCBlbXBsb3ltZW50UGVyaW9kID0gdGVybWluYXRlZEF0IC0gaXNzdWVEYXRlOwogICAgLy8gbWluaW11bSB2YWx1ZSBvZiBvcHRpb25zIGF0IHRoZSBlbmQgb2YgZmFkZW91dCwgaXQgaXMgYSAlIG9mIGFsbCBlbXBsb3llZSdzIG9wdGlvbnMKICAgIHVpbnQgbWluRmFkZVZhbHVlID0gZGl2Um91bmQob3B0aW9ucyAqIChGUF9TQ0FMRSAtIG1heEZhZGVvdXRQcm9taWxsZSksIEZQX1NDQUxFKTsKICAgIC8vIGhvd2V2ZXIgZW1wbG95ZWUgY2Fubm90IGhhdmUgbW9yZSB0aGFuIG9wdGlvbnMgYWZ0ZXIgZmFkZW91dCB0aGFuIGhlIHdhcyB2ZXN0ZWQgYXQgdGVybWluYXRpb24KICAgIGlmIChtaW5GYWRlVmFsdWUgPj0gdmVzdGVkT3B0aW9ucykKICAgICAgcmV0dXJuIHZlc3RlZE9wdGlvbnM7CiAgICByZXR1cm4gdGltZWZyb21UZXJtaW5hdGlvbiA+IGVtcGxveW1lbnRQZXJpb2QgPwogICAgICBtaW5GYWRlVmFsdWUgIDoKICAgICAgKG1pbkZhZGVWYWx1ZSArIGRpdlJvdW5kKCh2ZXN0ZWRPcHRpb25zIC0gbWluRmFkZVZhbHVlKSAqIChlbXBsb3ltZW50UGVyaW9kIC0gdGltZWZyb21UZXJtaW5hdGlvbiksIGVtcGxveW1lbnRQZXJpb2QpKTsKICB9CgogIGZ1bmN0aW9uIGNhbGN1bGF0ZU9wdGlvbnNDb21wb25lbnRzKHVpbnRbOV0gZW1wbG95ZWUsIHVpbnQzMiBjYWxjQXRUaW1lLCB1aW50MzIgY29udmVyc2lvbk9mZmVyZWRBdCwKICAgIGJvb2wgZGlzYWJsZUFjY2VsZXJhdGVkVmVzdGluZykKICAgIHB1YmxpYwogICAgY29uc3RhbnQKICAgIHJldHVybnMgKHVpbnQsIHVpbnQsIHVpbnQpCiAgewogICAgLy8gcmV0dXJucyB0dXBsZSBvZiAodmVzdGVkIHBvb2wgb3B0aW9ucywgdmVzdGVkIGV4dHJhIG9wdGlvbnMsIGJvbnVzKQogICAgRW1wbG95ZWUgbWVtb3J5IGVtcCA9IGRlc2VyaWFsaXplRW1wbG95ZWUoZW1wbG95ZWUpOwogICAgLy8gbm8gb3B0aW9ucyBmb3IgY29udmVydGVkIG9wdGlvbnMgb3Igd2hlbiBlc29wIGlzIG5vdCBzaW5nZWQKICAgIGlmIChlbXAuc3RhdGUgPT0gRW1wbG95ZWVTdGF0ZS5PcHRpb25zRXhlcmNpc2VkIHx8IGVtcC5zdGF0ZSA9PSBFbXBsb3llZVN0YXRlLldhaXRpbmdGb3JTaWduYXR1cmUpCiAgICAgIHJldHVybiAoMCwwLDApOwogICAgLy8gbm8gb3B0aW9ucyB3aGVuIGVzb3AgaXMgYmVpbmcgY29udmVydGVkIGFuZCBjb252ZXJzaW9uIGRlYWRsaW5lIGV4cGlyZWQKICAgIGJvb2wgaXNFU09QQ29udmVydGVkID0gY29udmVyc2lvbk9mZmVyZWRBdCA+IDAgJiYgY2FsY0F0VGltZSA+PSBjb252ZXJzaW9uT2ZmZXJlZEF0OyAvLyB0aGlzIGZ1bmN0aW9uIHRpbWUtdHJhdmVscwogICAgdWludCBpc3N1ZWRPcHRpb25zID0gZW1wLnBvb2xPcHRpb25zICsgZW1wLmV4dHJhT3B0aW9uczsKICAgIC8vIGVtcGxveWVlIHdpdGggbm8gb3B0aW9ucwogICAgaWYgKGlzc3VlZE9wdGlvbnMgPT0gMCkKICAgICAgcmV0dXJuICgwLDAsMCk7CiAgICAvLyBpZiBlbXAgaXMgdGVybWluYXRlZCBidXQgd2UgY2FsYyBvcHRpb25zIGJlZm9yZSB0ZXJtLCBzaW11bGF0ZSBlbXBsb3llZCBhZ2FpbgogICAgaWYgKGNhbGNBdFRpbWUgPCBlbXAudGVybWluYXRlZEF0ICYmIGVtcC50ZXJtaW5hdGVkQXQgPiAwKQogICAgICBlbXAuc3RhdGUgPSBFbXBsb3llZVN0YXRlLkVtcGxveWVkOwogICAgdWludCB2ZXN0ZWRPcHRpb25zID0gaXNzdWVkT3B0aW9uczsKICAgIGJvb2wgYWNjZWxlcmF0ZVZlc3RpbmcgPSBpc0VTT1BDb252ZXJ0ZWQgJiYgZW1wLnN0YXRlID09IEVtcGxveWVlU3RhdGUuRW1wbG95ZWQgJiYgIWRpc2FibGVBY2NlbGVyYXRlZFZlc3Rpbmc7CiAgICBpZiAoIWFjY2VsZXJhdGVWZXN0aW5nKSB7CiAgICAgIC8vIGNob29zZSB2ZXN0aW5nIHRpbWUKICAgICAgdWludDMyIGNhbGNWZXN0aW5nQXQgPSBlbXAuc3RhdGUgPT0KICAgICAgICAvLyBpZiB0ZXJtaW5hdGVkIHRoZW4gdmVzdGluZyBjYWxjdWxhdGVkIGF0IHRlcm1pbmF0aW9uCiAgICAgICAgRW1wbG95ZWVTdGF0ZS5UZXJtaW5hdGVkID8gZW1wLnRlcm1pbmF0ZWRBdCA6CiAgICAgICAgLy8gaWYgZW1wbG95ZWUgaXMgc3VwZW5kZWQgdGhlbiBjb21wdXRlIHZlc3RpbmcgYXQgc3VzcGVuc2lvbiB0aW1lCiAgICAgICAgKGVtcC5zdXNwZW5kZWRBdCA+IDAgJiYgZW1wLnN1c3BlbmRlZEF0IDwgY2FsY0F0VGltZSA/IGVtcC5zdXNwZW5kZWRBdCA6CiAgICAgICAgLy8gaWYgY29udmVyc2lvbiBvZmZlciB0aGVuIHZlc3RpbmcgY2FsdWNhdGVkIGF0IHRpbWUgdGhlIG9mZmVyIHdhcyBtYWRlCiAgICAgICAgY29udmVyc2lvbk9mZmVyZWRBdCA+IDAgPyBjb252ZXJzaW9uT2ZmZXJlZEF0IDoKICAgICAgICAvLyBvdGhlcndpc2UgdXNlIGN1cnJlbnQgdGltZQogICAgICAgIGNhbGNBdFRpbWUpOwogICAgICB2ZXN0ZWRPcHRpb25zID0gY2FsY3VsYXRlVmVzdGVkT3B0aW9ucyhjYWxjVmVzdGluZ0F0LCBlbXAuaXNzdWVEYXRlLCBpc3N1ZWRPcHRpb25zKTsKICAgIH0KICAgIC8vIGNhbGMgZmFkZW91dCBmb3IgdGVybWluYXRlZCBlbXBsb3llZXMKICAgIGlmIChlbXAuc3RhdGUgPT0gRW1wbG95ZWVTdGF0ZS5UZXJtaW5hdGVkKSB7CiAgICAgIC8vIHVzZSBjb252ZXJzaW9uIGV2ZW50IHRpbWUgdG8gY29tcHV0ZSBmYWRlb3V0IHRvIHN0b3AgZmFkZW91dCBvbiBjb252ZXJzaW9uIElGIG5vdCBhZnRlciBjb252ZXJzaW9uIGRhdGUKICAgICAgdmVzdGVkT3B0aW9ucyA9IGFwcGx5RmFkZW91dFRvT3B0aW9ucyhpc0VTT1BDb252ZXJ0ZWQgPyBjb252ZXJzaW9uT2ZmZXJlZEF0IDogY2FsY0F0VGltZSwKICAgICAgICBlbXAuaXNzdWVEYXRlLCBlbXAudGVybWluYXRlZEF0LCBpc3N1ZWRPcHRpb25zLCB2ZXN0ZWRPcHRpb25zKTsKICAgIH0KICAgIHZhciAodmVzdGVkUG9vbE9wdGlvbnMsIHZlc3RlZEV4dHJhT3B0aW9ucykgPSBleHRyYWN0VmVzdGVkT3B0aW9uc0NvbXBvbmVudHMoZW1wLnBvb2xPcHRpb25zLCBlbXAuZXh0cmFPcHRpb25zLCB2ZXN0ZWRPcHRpb25zKTsKICAgIC8vIGlmICh2ZXN0ZWRQb29sT3B0aW9ucyArIHZlc3RlZEV4dHJhT3B0aW9ucyAhPSB2ZXN0ZWRPcHRpb25zKSB0aHJvdzsKICAgIHJldHVybiAgKHZlc3RlZFBvb2xPcHRpb25zLCB2ZXN0ZWRFeHRyYU9wdGlvbnMsCiAgICAgIGFjY2VsZXJhdGVWZXN0aW5nID8gZGl2Um91bmQodmVzdGVkUG9vbE9wdGlvbnMqYm9udXNPcHRpb25zUHJvbWlsbGUsIEZQX1NDQUxFKSA6IDAgKTsKICB9CgogIGZ1bmN0aW9uIGNhbGN1bGF0ZU9wdGlvbnModWludFs5XSBlbXBsb3llZSwgdWludDMyIGNhbGNBdFRpbWUsIHVpbnQzMiBjb252ZXJzaW9uT2ZmZXJlZEF0LCBib29sIGRpc2FibGVBY2NlbGVyYXRlZFZlc3RpbmcpCiAgICBwdWJsaWMKICAgIGNvbnN0YW50CiAgICByZXR1cm5zICh1aW50KQogIHsKICAgIHZhciAodmVzdGVkUG9vbE9wdGlvbnMsIHZlc3RlZEV4dHJhT3B0aW9ucywgYm9udXMpID0gY2FsY3VsYXRlT3B0aW9uc0NvbXBvbmVudHMoZW1wbG95ZWUsIGNhbGNBdFRpbWUsCiAgICAgIGNvbnZlcnNpb25PZmZlcmVkQXQsIGRpc2FibGVBY2NlbGVyYXRlZFZlc3RpbmcpOwogICAgcmV0dXJuIHZlc3RlZFBvb2xPcHRpb25zICsgdmVzdGVkRXh0cmFPcHRpb25zICsgYm9udXM7CiAgfQoKICBmdW5jdGlvbiBleHRyYWN0VmVzdGVkT3B0aW9uc0NvbXBvbmVudHModWludCBpc3N1ZWRQb29sT3B0aW9ucywgdWludCBpc3N1ZWRFeHRyYU9wdGlvbnMsIHVpbnQgdmVzdGVkT3B0aW9ucykKICAgIHB1YmxpYwogICAgY29uc3RhbnQKICAgIHJldHVybnMgKHVpbnQsIHVpbnQpCiAgewogICAgLy8gYnJlYWtzIGRvd24gdmVzdGVkIG9wdGlvbnMgaW50byBwb29sIG9wdGlvbnMgYW5kIGV4dHJhIG9wdGlvbnMgY29tcG9uZW50cwogICAgaWYgKGlzc3VlZEV4dHJhT3B0aW9ucyA9PSAwKQogICAgICByZXR1cm4gKHZlc3RlZE9wdGlvbnMsIDApOwogICAgdWludCBwb29sT3B0aW9ucyA9IGRpdlJvdW5kKGlzc3VlZFBvb2xPcHRpb25zKnZlc3RlZE9wdGlvbnMsIGlzc3VlZFBvb2xPcHRpb25zICsgaXNzdWVkRXh0cmFPcHRpb25zKTsKICAgIHJldHVybiAocG9vbE9wdGlvbnMsIHZlc3RlZE9wdGlvbnMgLSBwb29sT3B0aW9ucyk7CiAgfQoKICBmdW5jdGlvbiBjYWxjdWxhdGVGYWRlb3V0VG9Qb29sKHVpbnQzMiB0LCB1aW50WzldIGVtcGxveWVlKQogICAgcHVibGljCiAgICBjb25zdGFudAogICAgcmV0dXJucyAodWludCwgdWludCkKICB7CiAgICBFbXBsb3llZSBtZW1vcnkgZW1wID0gZGVzZXJpYWxpemVFbXBsb3llZShlbXBsb3llZSk7CgogICAgdWludCB2ZXN0ZWRPcHRpb25zID0gY2FsY3VsYXRlVmVzdGVkT3B0aW9ucyhlbXAudGVybWluYXRlZEF0LCBlbXAuaXNzdWVEYXRlLCBlbXAucG9vbE9wdGlvbnMpOwogICAgdWludCByZXR1cm5lZFBvb2xPcHRpb25zID0gYXBwbHlGYWRlb3V0VG9PcHRpb25zKGVtcC5mYWRlb3V0U3RhcnRzLCBlbXAuaXNzdWVEYXRlLCBlbXAudGVybWluYXRlZEF0LCBlbXAucG9vbE9wdGlvbnMsIHZlc3RlZE9wdGlvbnMpIC0KICAgICAgYXBwbHlGYWRlb3V0VG9PcHRpb25zKHQsIGVtcC5pc3N1ZURhdGUsIGVtcC50ZXJtaW5hdGVkQXQsIGVtcC5wb29sT3B0aW9ucywgdmVzdGVkT3B0aW9ucyk7CiAgICB1aW50IHZlc3RlZEV4dHJhT3B0aW9ucyA9IGNhbGN1bGF0ZVZlc3RlZE9wdGlvbnMoZW1wLnRlcm1pbmF0ZWRBdCwgZW1wLmlzc3VlRGF0ZSwgZW1wLmV4dHJhT3B0aW9ucyk7CiAgICB1aW50IHJldHVybmVkRXh0cmFPcHRpb25zID0gYXBwbHlGYWRlb3V0VG9PcHRpb25zKGVtcC5mYWRlb3V0U3RhcnRzLCBlbXAuaXNzdWVEYXRlLCBlbXAudGVybWluYXRlZEF0LCBlbXAuZXh0cmFPcHRpb25zLCB2ZXN0ZWRFeHRyYU9wdGlvbnMpIC0KICAgICAgYXBwbHlGYWRlb3V0VG9PcHRpb25zKHQsIGVtcC5pc3N1ZURhdGUsIGVtcC50ZXJtaW5hdGVkQXQsIGVtcC5leHRyYU9wdGlvbnMsIHZlc3RlZEV4dHJhT3B0aW9ucyk7CgogICAgcmV0dXJuIChyZXR1cm5lZFBvb2xPcHRpb25zLCByZXR1cm5lZEV4dHJhT3B0aW9ucyk7CiAgfQoKICBmdW5jdGlvbiBzaW11bGF0ZU9wdGlvbnModWludDMyIGlzc3VlRGF0ZSwgdWludDMyIHRlcm1pbmF0ZWRBdCwgdWludDMyIHBvb2xPcHRpb25zLAogICAgdWludDMyIGV4dHJhT3B0aW9ucywgdWludDMyIHN1c3BlbmRlZEF0LCB1aW50OCBlbXBsb3llZVN0YXRlLCB1aW50MzIgY2FsY0F0VGltZSkKICAgIHB1YmxpYwogICAgY29uc3RhbnQKICAgIHJldHVybnMgKHVpbnQpCiAgewogICAgRW1wbG95ZWUgbWVtb3J5IGVtcCA9IEVtcGxveWVlKHtpc3N1ZURhdGU6IGlzc3VlRGF0ZSwgdGVybWluYXRlZEF0OiB0ZXJtaW5hdGVkQXQsCiAgICAgIHBvb2xPcHRpb25zOiBwb29sT3B0aW9ucywgZXh0cmFPcHRpb25zOiBleHRyYU9wdGlvbnMsIHN0YXRlOiBFbXBsb3llZVN0YXRlKGVtcGxveWVlU3RhdGUpLAogICAgICB0aW1lVG9TaWduOiBpc3N1ZURhdGUrMiB3ZWVrcywgZmFkZW91dFN0YXJ0czogdGVybWluYXRlZEF0LCBzdXNwZW5kZWRBdDogc3VzcGVuZGVkQXQsCiAgICAgIGlkeDoxfSk7CiAgICByZXR1cm4gY2FsY3VsYXRlT3B0aW9ucyhzZXJpYWxpemVFbXBsb3llZShlbXApLCBjYWxjQXRUaW1lLCAwLCBmYWxzZSk7CiAgfQoKICBmdW5jdGlvbiBzZXRQYXJhbWV0ZXJzKHVpbnQzMiBwQ2xpZmZQZXJpb2QsIHVpbnQzMiBwVmVzdGluZ1BlcmlvZCwgdWludDMyIHBSZXNpZHVhbEFtb3VudFByb21pbGxlLAogICAgdWludDMyIHBCb251c09wdGlvbnNQcm9taWxsZSwgdWludDMyIHBOZXdFbXBsb3llZVBvb2xQcm9taWxsZSwgdWludDMyIHBPcHRpb25zUGVyU2hhcmUpCiAgICBleHRlcm5hbAogICAgb25seUNvbXBhbnkKICB7CiAgICBpZiAocFJlc2lkdWFsQW1vdW50UHJvbWlsbGUgPiBGUF9TQ0FMRSB8fCBwQm9udXNPcHRpb25zUHJvbWlsbGUgPiBGUF9TQ0FMRSB8fCBwTmV3RW1wbG95ZWVQb29sUHJvbWlsbGUgPiBGUF9TQ0FMRQogICAgIHx8IHBPcHRpb25zUGVyU2hhcmUgPT0gMCkKICAgICAgdGhyb3c7CiAgICBpZiAocENsaWZmUGVyaW9kID4gcFZlc3RpbmdQZXJpb2QpCiAgICAgIHRocm93OwogICAgLy8gaW5pdGlhbGl6YXRpb24gY2Fubm90IGJlIGNhbGxlZCBmb3IgYSBzZWNvbmQgdGltZQogICAgaWYgKGhhc1BhcmFtZXRlcnMoKSkKICAgICAgdGhyb3c7CiAgICBjbGlmZlBlcmlvZCA9IHBDbGlmZlBlcmlvZDsKICAgIHZlc3RpbmdQZXJpb2QgPSBwVmVzdGluZ1BlcmlvZDsKICAgIG1heEZhZGVvdXRQcm9taWxsZSA9IEZQX1NDQUxFIC0gcFJlc2lkdWFsQW1vdW50UHJvbWlsbGU7CiAgICBib251c09wdGlvbnNQcm9taWxsZSA9IHBCb251c09wdGlvbnNQcm9taWxsZTsKICAgIG5ld0VtcGxveWVlUG9vbFByb21pbGxlID0gcE5ld0VtcGxveWVlUG9vbFByb21pbGxlOwogICAgb3B0aW9uc1BlclNoYXJlID0gcE9wdGlvbnNQZXJTaGFyZTsKICB9CgogIGZ1bmN0aW9uIE9wdGlvbnNDYWxjdWxhdG9yKGFkZHJlc3MgcENvbXBhbnlBZGRyZXNzKSB7CiAgICBjb21wYW55QWRkcmVzcyA9IHBDb21wYW55QWRkcmVzczsKICB9Cn0KCmNvbnRyYWN0IFByb2NlZWRzT3B0aW9uc0NvbnZlcnRlciBpcyBPd25hYmxlLCBFUkMyME9wdGlvbnNDb252ZXJ0ZXIgewogIG1hcHBpbmcgKGFkZHJlc3MgPT4gdWludCkgaW50ZXJuYWwgd2l0aGRyYXdhbHM7CiAgdWludFtdIGludGVybmFsIHBheW91dHM7CgogIGZ1bmN0aW9uIG1ha2VQYXlvdXQoKSBjb252ZXJ0ZWQgcGF5YWJsZSBvbmx5T3duZXIgcHVibGljIHsKICAgIC8vIGl0IGRvZXMgbm90IG1ha2Ugc2Vuc2UgdG8gZGlzdHJpYnV0ZSBsZXNzIHRoYW4gZXRoZXIKICAgIGlmIChtc2cudmFsdWUgPCAxIGV0aGVyKQogICAgICB0aHJvdzsKICAgIHBheW91dHMucHVzaChtc2cudmFsdWUpOwogIH0KCiAgZnVuY3Rpb24gd2l0aGRyYXcoKSBjb252ZXJ0ZWQgcHVibGljIHJldHVybnMgKHVpbnQpIHsKICAgIC8vIHdpdGhkcmF3IGZvciBtc2cuc2VuZGVyCiAgICB1aW50IGJhbGFuY2UgPSBiYWxhbmNlT2YobXNnLnNlbmRlcik7CiAgICBpZiAoYmFsYW5jZSA9PSAwKQogICAgICByZXR1cm4gMDsKICAgIHVpbnQgcGF5bWVudElkID0gd2l0aGRyYXdhbHNbbXNnLnNlbmRlcl07CiAgICAvLyBpZiBhbGwgcGF5b3V0cyBmb3IgZ2l2ZW4gdG9rZW4gaG9sZGVyIGV4ZWN1dGVkIHRoZW4gZXhpdAogICAgaWYgKHBheW1lbnRJZCA9PSBwYXlvdXRzLmxlbmd0aCkKICAgICAgcmV0dXJuIDA7CiAgICB1aW50IHBheW91dCA9IDA7CiAgICBmb3IgKHVpbnQgaSA9IHBheW1lbnRJZDsgaTxwYXlvdXRzLmxlbmd0aDsgaSsrKSB7CiAgICAgIC8vIGl0IGlzIHNhZmUgdG8gbWFrZSBwYXlvdXRzIHByby1yYXRhOiAoMSkgdG9rZW4gc3VwcGx5IHdpbGwgbm90IGNoYW5nZSAtIGNoZWNrIGNvbnZlcnRlZC9jb252ZXJzaW9uIG1vZGlmaWVycwogICAgICAvLyAtLSAoMikgYmFsYW5jZXMgd2lsbCBub3QgY2hhbmdlOiBjaGVjayB0cmFuc2ZlciBvdmVycmlkZSB3aGljaCBsaW1pdHMgdHJhbnNmZXIgYmV0d2VlbiBhY2NvdW50cwogICAgICAvLyBOT1RFOiBzYWZlTXVsIHRocm93cyBvbiBvdmVyZmxvdywgY2FuIGxvY2sgdXNlcnMgb3V0IG9mIHRoZWlyIHdpdGhkcmF3YWxzIGlmIGJhbGFuY2UgaXMgdmVyeSBoaWdoCiAgICAgIC8vIEByZW1jbyBJIGtub3cuIGFueSBzdWdnZXN0aW9ucz8gZXhwcmVzc2lvbiBiZWxvdyBnaXZlcyBtb3N0IHByZWNpc2lvbgogICAgICB1aW50IHRoaXNQYXlvdXQgPSBkaXZSb3VuZChzYWZlTXVsKHBheW91dHNbaV0sIGJhbGFuY2UpLCB0b3RhbFN1cHBseSk7CiAgICAgIHBheW91dCArPSB0aGlzUGF5b3V0OwogICAgfQogICAgLy8gY2hhbmdlIG5vdyB0byBwcmV2ZW50IHJlLWVudHJ5IChub3QgbmVjZXNzYXJ5IGR1ZSB0byBsb3cgc2VuZCgpIGdhcyBsaW1pdCkKICAgIHdpdGhkcmF3YWxzW21zZy5zZW5kZXJdID0gcGF5b3V0cy5sZW5ndGg7CiAgICBpZiAocGF5b3V0ID4gMCkgewogICAgICAvLyBub3cgbW9kaWZ5IHBheW91dCB3aXRoaW4gMTAwMCB3ZWlzIGFzIHdlIGhhZCByb3VuZGluZyBlcnJvcnMgY29taW5nIGZyb20gcHJvLXJhdGEgYW1vdW50cwogICAgICAvLyBAcmVtY28gbWF4aW11bSByb3VuZGluZyBlcnJvciBpcyAobnVtX2VtcGxveWVlcyAqIG51bV9wYXltZW50cykgLyAyIHdpdGggdGhlIG1lYW4gMAogICAgICAvLyAtLS0gMTAwMCB3ZWkgaXMgc3RpbGwgbm90aGluZywgcGxlYXNlIGV4cGxhaW4gbWUgd2hhdCBwcm9ibGVtIHlvdSBzZWUgaGVyZQogICAgICBpZiAoIGFic0RpZmYodGhpcy5iYWxhbmNlLCBwYXlvdXQpIDwgMTAwMCB3ZWkgKQogICAgICAgIHBheW91dCA9IHRoaXMuYmFsYW5jZTsgLy8gc2VuZCBhbGwKICAgICAgLy9pZighbXNnLnNlbmRlci5jYWxsLnZhbHVlKHBheW91dCkoKSkgLy8gcmUgZW50cnkgdGVzdAogICAgICAvLyAgdGhyb3c7CiAgICAgIGlmICghbXNnLnNlbmRlci5zZW5kKHBheW91dCkpCiAgICAgICAgdGhyb3c7CiAgICB9CiAgICByZXR1cm4gcGF5b3V0OwogIH0KCiAgZnVuY3Rpb24gdHJhbnNmZXIoYWRkcmVzcyBfdG8sIHVpbnQgX3ZhbHVlKSBwdWJsaWMgY29udmVydGVkIHsKICAgIC8vIGlmIGFueXRoaW5nIHdhcyB3aXRoZHJhd24gdGhlbiBibG9jayB0cmFuc2ZlciB0byBwcmV2ZW50IG11bHRpcGxlIHdpdGhkcmF3YWxzCiAgICAvLyB0b2RvOiB3ZSBjb3VsZCBhbGxvdyB0cmFuc2ZlciB0byBuZXcgYWNjb3VudCAobm8gdG9rZW4gYmFsYW5jZSkKICAgIC8vIHRvZG86IHdlIGNvdWxkIGFsbG93IHRyYW5zZmVyIGJldHdlZW4gYWNjb3VudCB0aGF0IGZ1bGx5IHdpdGhkcmF3biAoYnV0IHdoYXQncyB0aGUgcG9pbnQ/IC10b2tlbiBoYXMgMCB2YWx1ZSB0aGVuKQogICAgLy8gdG9kbzogdGhlcmUgYXJlIGEgZmV3IG90aGVyIGVkZ2UgY2FzZXMgd2hlcmUgdGhlcmUncyB0cmFuc2ZlciBhbmQgbm8gZG91YmxlIHNwZW5kaW5nCiAgICBpZiAod2l0aGRyYXdhbHNbX3RvXSA+IDAgfHwgd2l0aGRyYXdhbHNbbXNnLnNlbmRlcl0gPiAwKQogICAgICB0aHJvdzsKICAgIEVSQzIwT3B0aW9uc0NvbnZlcnRlci50cmFuc2ZlcihfdG8sIF92YWx1ZSk7CiAgfQoKICBmdW5jdGlvbiBQcm9jZWVkc09wdGlvbnNDb252ZXJ0ZXIoYWRkcmVzcyBlc29wLCB1aW50MzIgZXhlcmNpc2VEZWFkbGluZSwgdWludDMyIGNvbnZlcnNpb25EZWFkbGluZSkKICAgIEVSQzIwT3B0aW9uc0NvbnZlcnRlcihlc29wLCBleGVyY2lzZURlYWRsaW5lLCBjb252ZXJzaW9uRGVhZGxpbmUpCiAgewogIH0KfQoKY29udHJhY3QgUm9UIGlzIE93bmFibGUgewogICAgYWRkcmVzcyBwdWJsaWMgRVNPUEFkZHJlc3M7CiAgICBldmVudCBFU09QQW5kQ29tcGFueVNldChhZGRyZXNzIEVTT1BBZGRyZXNzLCBhZGRyZXNzIGNvbXBhbnlBZGRyZXNzKTsKCiAgICBmdW5jdGlvbiBzZXRFU09QKGFkZHJlc3MgRVNPUCwgYWRkcmVzcyBjb21wYW55KSBwdWJsaWMgb25seU93bmVyIHsKICAgICAgLy8gb3duZXIgc2V0cyBFU09QIGFuZCBjb21wYW55IG9ubHkgb25jZSB0aGVuIHBhc3NlcyBvd25lcnNoaXAgdG8gY29tcGFueQogICAgICAvLyBpbml0aWFsbHkgb3duZXIgaXMgYSBkZXZlbG9wZXIvYWRtaW4KICAgICAgRVNPUEFkZHJlc3MgPSBFU09QOwogICAgICB0cmFuc2Zlck93bmVyc2hpcChjb21wYW55KTsKICAgICAgRVNPUEFuZENvbXBhbnlTZXQoRVNPUCwgY29tcGFueSk7CiAgICB9CgogICAgZnVuY3Rpb24ga2lsbE9uVW5zdXBwb3J0ZWRGb3JrKCkgcHVibGljIG9ubHlPd25lciB7CiAgICAgIC8vIHRoaXMgbWV0aG9kIG1heSBvbmx5IGJlIGNhbGxlZCBieSBjb21wYW55IG9uIHVuc3VwcG9ydGVkIGZvcmtzCiAgICAgIGRlbGV0ZSBFU09QQWRkcmVzczsKICAgICAgc2VsZmRlc3RydWN0KG93bmVyKTsKICAgIH0KfQ=='.
	

]
