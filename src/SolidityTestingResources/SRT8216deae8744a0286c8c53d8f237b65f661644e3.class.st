Class {
	#name : #SRT8216deae8744a0286c8c53d8f237b65f661644e3,
	#superclass : #SRTContracts,
	#category : #SolidityTestingResources
}

{ #category : #base64 }
SRT8216deae8744a0286c8c53d8f237b65f661644e3 >> base64 [
	^ 'cHJhZ21hIHNvbGlkaXR5IF4wLjQuMTE7CgovLyBOQjogdGhpcyBpcyB0aGUgbmV3ZXIgRVJDMjAgcmV0dXJuaW5nIGJvb2wsIG5lZWQgZGlmZmVyZW50IGJvb2sgY29udHJhY3QgZm9yIG9sZGVyIHN0eWxlIHRva2Vucwpjb250cmFjdCBFUkMyMCB7CiAgZnVuY3Rpb24gdG90YWxTdXBwbHkoKSBjb25zdGFudCByZXR1cm5zICh1aW50KTsKICBmdW5jdGlvbiBiYWxhbmNlT2YoYWRkcmVzcyBfb3duZXIpIGNvbnN0YW50IHJldHVybnMgKHVpbnQgYmFsYW5jZSk7CiAgZnVuY3Rpb24gdHJhbnNmZXIoYWRkcmVzcyBfdG8sIHVpbnQgX3ZhbHVlKSByZXR1cm5zIChib29sIHN1Y2Nlc3MpOwogIGZ1bmN0aW9uIHRyYW5zZmVyRnJvbShhZGRyZXNzIF9mcm9tLCBhZGRyZXNzIF90bywgdWludCBfdmFsdWUpIHJldHVybnMgKGJvb2wgc3VjY2Vzcyk7CiAgZnVuY3Rpb24gYXBwcm92ZShhZGRyZXNzIF9zcGVuZGVyLCB1aW50IF92YWx1ZSkgcmV0dXJucyAoYm9vbCBzdWNjZXNzKTsKICBmdW5jdGlvbiBhbGxvd2FuY2UoYWRkcmVzcyBfb3duZXIsIGFkZHJlc3MgX3NwZW5kZXIpIGNvbnN0YW50IHJldHVybnMgKHVpbnQgcmVtYWluaW5nKTsKICBldmVudCBUcmFuc2ZlcihhZGRyZXNzIGluZGV4ZWQgX2Zyb20sIGFkZHJlc3MgaW5kZXhlZCBfdG8sIHVpbnQgX3ZhbHVlKTsKICBldmVudCBBcHByb3ZhbChhZGRyZXNzIGluZGV4ZWQgX293bmVyLCBhZGRyZXNzIGluZGV4ZWQgX3NwZW5kZXIsIHVpbnQgX3ZhbHVlKTsKfQoKLy8gVWJpVG9rLmlvIGxpbWl0IG9yZGVyIGJvb2sgd2l0aCBhbiAibmljZSIgRVJDMjAgdG9rZW4gYXMgYmFzZSwgRVRIIGFzIHF1b3RlZCwgYW5kIHN0YW5kYXJkIGZlZXMuCi8vIENvcHlyaWdodCAoYykgQm9ubmFnIExpbWl0ZWQuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCi8vCmNvbnRyYWN0IEJvb2tFUkMyMEV0aFYxIHsKCiAgZW51bSBCb29rVHlwZSB7CiAgICBFUkMyMEV0aFYxCiAgfQoKICBlbnVtIERpcmVjdGlvbiB7CiAgICBJbnZhbGlkLAogICAgQnV5LAogICAgU2VsbAogIH0KCiAgZW51bSBTdGF0dXMgewogICAgVW5rbm93biwKICAgIFJlamVjdGVkLAogICAgT3BlbiwKICAgIERvbmUsCiAgICBOZWVkc0dhcywKICAgIFNlbmRpbmcsIC8vIG5vdCB1c2VkIGJ5IGNvbnRyYWN0IC0gd2ViIG9ubHkKICAgIEZhaWxlZFNlbmQsIC8vIG5vdCB1c2VkIGJ5IGNvbnRyYWN0IC0gd2ViIG9ubHkKICAgIEZhaWxlZFR4biAvLyBub3QgdXNlZCBieSBjb250cmFjdCAtIHdlYiBvbmx5CiAgfQoKICBlbnVtIFJlYXNvbkNvZGUgewogICAgTm9uZSwKICAgIEludmFsaWRQcmljZSwKICAgIEludmFsaWRTaXplLAogICAgSW52YWxpZFRlcm1zLAogICAgSW5zdWZmaWNpZW50RnVuZHMsCiAgICBXb3VsZFRha2UsCiAgICBVbm1hdGNoZWQsCiAgICBUb29NYW55TWF0Y2hlcywKICAgIENsaWVudENhbmNlbAogIH0KCiAgZW51bSBUZXJtcyB7CiAgICBHVENOb0dhc1RvcHVwLAogICAgR1RDV2l0aEdhc1RvcHVwLAogICAgSW1tZWRpYXRlT3JDYW5jZWwsCiAgICBNYWtlck9ubHkKICB9CgogIHN0cnVjdCBPcmRlciB7CiAgICAvLyB0aGVzZSBhcmUgaW1tdXRhYmxlIG9uY2UgcGxhY2VkOgoKICAgIGFkZHJlc3MgY2xpZW50OwogICAgdWludDE2IHByaWNlOyAgICAgICAgICAgICAgLy8gcGFja2VkIHJlcHJlc2VudGF0aW9uIG9mIHNpZGUgKyBwcmljZQogICAgdWludCBzaXplQmFzZTsKICAgIFRlcm1zIHRlcm1zOwoKICAgIC8vIHRoZXNlIGFyZSBtdXRhYmxlIHVudGlsIERvbmUgb3IgUmVqZWN0ZWQ6CiAgICAKICAgIFN0YXR1cyBzdGF0dXM7CiAgICBSZWFzb25Db2RlIHJlYXNvbkNvZGU7CiAgICB1aW50MTI4IGV4ZWN1dGVkQmFzZTsgICAgICAvLyBncm9zcyBhbW91bnQgZXhlY3V0ZWQgaW4gYmFzZSBjdXJyZW5jeSAoYmVmb3JlIGZlZSBkZWR1Y3Rpb24pCiAgICB1aW50MTI4IGV4ZWN1dGVkQ250cjsgICAgICAvLyBncm9zcyBhbW91bnQgZXhlY3V0ZWQgaW4gY291bnRlciBjdXJyZW5jeSAoYmVmb3JlIGZlZSBkZWR1Y3Rpb24pCiAgICB1aW50MTI4IGZlZXNCYXNlT3JDbnRyOyAgICAvLyBiYXNlIGZvciBidXksIGNudHIgZm9yIHNlbGwKICAgIHVpbnQxMjggZmVlc1J3cmQ7CiAgfQogIAogIHN0cnVjdCBPcmRlckNoYWluIHsKICAgIHVpbnQxMjggZmlyc3RPcmRlcklkOwogICAgdWludDEyOCBsYXN0T3JkZXJJZDsKICB9CgogIHN0cnVjdCBPcmRlckNoYWluTm9kZSB7CiAgICB1aW50MTI4IG5leHRPcmRlcklkOwogICAgdWludDEyOCBwcmV2T3JkZXJJZDsKICB9CiAgCiAgZW51bSBDbGllbnRQYXltZW50RXZlbnRUeXBlIHsKICAgIERlcG9zaXQsCiAgICBXaXRoZHJhdywKICAgIFRyYW5zZmVyRnJvbSwKICAgIFRyYW5zZmVyCiAgfQoKICBlbnVtIEJhbGFuY2VUeXBlIHsKICAgIEJhc2UsCiAgICBDbnRyLAogICAgUndyZAogIH0KCiAgZXZlbnQgQ2xpZW50UGF5bWVudEV2ZW50KAogICAgYWRkcmVzcyBpbmRleGVkIGNsaWVudCwKICAgIENsaWVudFBheW1lbnRFdmVudFR5cGUgY2xpZW50UGF5bWVudEV2ZW50VHlwZSwKICAgIEJhbGFuY2VUeXBlIGJhbGFuY2VUeXBlLAogICAgaW50IGNsaWVudEJhbGFuY2VEZWx0YQogICk7CgogIGVudW0gQ2xpZW50T3JkZXJFdmVudFR5cGUgewogICAgQ3JlYXRlLAogICAgQ29udGludWUsCiAgICBDYW5jZWwKICB9CgogIGV2ZW50IENsaWVudE9yZGVyRXZlbnQoCiAgICBhZGRyZXNzIGluZGV4ZWQgY2xpZW50LAogICAgQ2xpZW50T3JkZXJFdmVudFR5cGUgY2xpZW50T3JkZXJFdmVudFR5cGUsCiAgICB1aW50MTI4IG9yZGVySWQKICApOwoKICBlbnVtIE1hcmtldE9yZGVyRXZlbnRUeXBlIHsKICAgIC8vIG9yZGVyQ291bnQrKywgZGVwdGggKz0gZGVwdGhCYXNlCiAgICBBZGQsCiAgICAvLyBvcmRlckNvdW50LS0sIGRlcHRoIC09IGRlcHRoQmFzZQogICAgUmVtb3ZlLAogICAgLy8gb3JkZXJDb3VudC0tLCBkZXB0aCAtPSBkZXB0aEJhc2UsIHRyYWRlZCArPSB0cmFkZUJhc2UKICAgIC8vIChkZXB0aCBjaGFuZ2UgYW5kIHRyYWRlZCBjaGFuZ2UgZGlmZmVyIHdoZW4gdGlueSByZW1haW5pbmcgYW1vdW50IHJlZnVuZGVkKQogICAgQ29tcGxldGVGaWxsLAogICAgLy8gb3JkZXJDb3VudCB1bmNoYW5nZWQsIGRlcHRoIC09IGRlcHRoQmFzZSwgdHJhZGVkICs9IHRyYWRlQmFzZQogICAgUGFydGlhbEZpbGwKICB9CgogIC8vIHRoZXNlIGV2ZW50cyBjYW4gYmUgdXNlZCB0byBidWlsZCBhbiBvcmRlciBib29rIG9yIHdhdGNoIGZvciBmaWxscwogIC8vIG5vdGUgdGhhdCB0aGUgb3JkZXJJZCBhbmQgcHJpY2UgYXJlIHRob3NlIG9mIHRoZSBtYWtlcgogIGV2ZW50IE1hcmtldE9yZGVyRXZlbnQoCiAgICB1aW50MjU2IGluZGV4ZWQgZXZlbnRUaW1lc3RhbXAsCiAgICB1aW50MTI4IGluZGV4ZWQgb3JkZXJJZCwKICAgIE1hcmtldE9yZGVyRXZlbnRUeXBlIG1hcmtldE9yZGVyRXZlbnRUeXBlLAogICAgdWludDE2IHByaWNlLAogICAgdWludCBkZXB0aEJhc2UsCiAgICB1aW50IHRyYWRlQmFzZQogICk7CgogIC8vIHRoZSBiYXNlIHRva2VuIChlLmcuIFRFU1QpCiAgCiAgRVJDMjAgYmFzZVRva2VuOwoKICAvLyBtaW5pbXVtIG9yZGVyIHNpemUgKGluY2x1c2l2ZSkKICB1aW50IGNvbnN0YW50IGJhc2VNaW5Jbml0aWFsU2l6ZSA9IDEwMCBmaW5uZXk7CgogIC8vIGlmIGZvbGxvd2luZyBwYXJ0aWFsIG1hdGNoLCB0aGUgcmVtYW5pbmcgZ2V0cyBzbWFsbGVyIHRoYW4gdGhpcywgcmVtb3ZlIGZyb20gYm9vayBhbmQgcmVmdW5kOgogIC8vIGdlbmVyYWxseSB3ZSBtYWtlIHRoaXMgMTAlIG9mIGJhc2VNaW5Jbml0aWFsU2l6ZQogIHVpbnQgY29uc3RhbnQgYmFzZU1pblJlbWFpbmluZ1NpemUgPSAxMCBmaW5uZXk7CgogIC8vIG1heGltdW0gb3JkZXIgc2l6ZSAoZXhjbHVzaXZlKQogIC8vIGNob3NlbiBzbyB0aGF0IGV2ZW4gbXVsdGlwbGllZCBieSB0aGUgbWF4IHByaWNlIChvciBkaXZpZGVkIGJ5IHRoZSBtaW4gcHJpY2UpLAogIC8vIGFuZCB0aGVuIG11bHRpcGxpZWQgYnkgZXRoUndyZFJhdGUsIGl0IHN0aWxsIGZpdHMgaW4gMl4xMjcsIGFsbG93aW5nIHVzIHRvIHNhdmUKICAvLyBzb21lIGdhcyBieSBzdG9yaW5nIGV4ZWN1dGVkICsgZmVlIGZpZWxkcyBhcyB1aW50MTI4LgogIC8vIGV2ZW4gd2l0aCAxOCBkZWNpbWFscywgdGhpcyBzdGlsbCBhbGxvd3Mgb3JkZXIgc2l6ZXMgdXAgdG8gMSwwMDAsMDAwLDAwMC4KICAvLyBpZiB3ZSBlbmNvdW50ZXIgYSB0b2tlbiB3aXRoIGUuZy4gMzYgZGVjaW1hbHMgd2UnbGwgaGF2ZSB0byByZXZpc2l0IC4uLgogIHVpbnQgY29uc3RhbnQgYmFzZU1heFNpemUgPSAxMCAqKiAzMDsKCiAgLy8gdGhlIGNvdW50ZXIgY3VycmVuY3kgKEVUSCkKICAvLyAobm8gYWRkcmVzcyBiZWNhdXNlIGl0IGlzIEVUSCkKCiAgLy8gYXZvaWQgdGhlIGJvb2sgZ2V0dGluZyBjbHV0dGVyZWQgdXAgd2l0aCB0aW55IGFtb3VudHMgbm90IHdvcnRoIHRoZSBnYXMKICB1aW50IGNvbnN0YW50IGNudHJNaW5Jbml0aWFsU2l6ZSA9IDEwIGZpbm5leTsKCiAgLy8gc2VlIGNvbW1lbnRzIGZvciBiYXNlTWF4U2l6ZQogIHVpbnQgY29uc3RhbnQgY250ck1heFNpemUgPSAxMCAqKiAzMDsKCiAgLy8gdGhlIHJld2FyZCB0b2tlbiB0aGF0IGNhbiBiZSB1c2VkIHRvIHBheSBmZWVzIChVQkkpCgogIEVSQzIwIHJ3cmRUb2tlbjsKCiAgLy8gdXNlZCB0byBjb252ZXJ0IEVUSCBhbW91bnQgdG8gcmV3YXJkIHRva2VucyB3aGVuIHBheWluZyBmZWUgd2l0aCByZXdhcmQgdG9rZW5zCiAgdWludCBjb25zdGFudCBldGhSd3JkUmF0ZSA9IDEwMDA7CiAgCiAgLy8gZnVuZHMgdGhhdCBiZWxvbmcgdG8gY2xpZW50cyAoYmFzZSwgY291bnRlciwgYW5kIHJld2FyZCkKCiAgbWFwcGluZyAoYWRkcmVzcyA9PiB1aW50KSBiYWxhbmNlQmFzZUZvckNsaWVudDsKICBtYXBwaW5nIChhZGRyZXNzID0+IHVpbnQpIGJhbGFuY2VDbnRyRm9yQ2xpZW50OwogIG1hcHBpbmcgKGFkZHJlc3MgPT4gdWludCkgYmFsYW5jZVJ3cmRGb3JDbGllbnQ7CgogIC8vIGZlZSBjaGFyZ2VkIG9uIGxpcXVpZGl0eSB0YWtlbiwgZXhwcmVzc2VkIGFzIGEgZGl2aXNvcgogIC8vIChlLmcuIDIwMDAgbWVhbnMgMS8yMDAwLCBvciAwLjA1JSkKCiAgdWludCBjb25zdGFudCBmZWVEaXZpc29yID0gMjAwMDsKICAKICAvLyBmZWVzIGNoYXJnZWQgYXJlIGdpdmVuIHRvOgogIAogIGFkZHJlc3MgZmVlQ29sbGVjdG9yOwoKICAvLyBhbGwgb3JkZXJzIGV2ZXIgY3JlYXRlZAogIAogIG1hcHBpbmcgKHVpbnQxMjggPT4gT3JkZXIpIG9yZGVyRm9yT3JkZXJJZDsKICAKICAvLyBFZmZlY3RpdmVseSBhIGNvbXBhY3QgbWFwcGluZyBmcm9tIHByaWNlIHRvIHdoZXRoZXIgdGhlcmUgYXJlIGFueSBvcGVuIG9yZGVycyBhdCB0aGF0IHByaWNlLgogIC8vIFNlZSAiUHJpY2UgQ2FsY3VsYXRpb24gQ29uc3RhbnRzIiBiZWxvdyBhcyB0byB3aHkgODUuCgogIHVpbnQyNTZbODVdIG9jY3VwaWVkUHJpY2VCaXRtYXBzOwoKICAvLyBUaGVzZSBhbGxvdyB1cyB0byB3YWxrIG92ZXIgdGhlIG9yZGVycyBpbiB0aGUgYm9vayBhdCBhIGdpdmVuIHByaWNlIGxldmVsIChhbmQgYWRkIG1vcmUpLgoKICBtYXBwaW5nICh1aW50MTYgPT4gT3JkZXJDaGFpbikgb3JkZXJDaGFpbkZvck9jY3VwaWVkUHJpY2U7CiAgbWFwcGluZyAodWludDEyOCA9PiBPcmRlckNoYWluTm9kZSkgb3JkZXJDaGFpbk5vZGVGb3JPcGVuT3JkZXJJZDsKCiAgLy8gVGhlc2UgYWxsb3cgYSBjbGllbnQgdG8gKHJlYXNvbmFibHkpIGVmZmljaWVudGx5IGZpbmQgdGhlaXIgb3duIG9yZGVycwogIC8vIHdpdGhvdXQgcmVseWluZyBvbiBldmVudHMgKHdoaWNoIGV2ZW4gaW5kZXhlZCBhcmUgYSBiaXQgZXhwZW5zaXZlIHRvIHNlYXJjaAogIC8vIGFuZCBjYW5ub3QgYmUgYWNjZXNzZWQgZnJvbSBzbWFydCBjb250cmFjdHMpLiBTZWUgd2Fsa09yZGVycy4KCiAgbWFwcGluZyAoYWRkcmVzcyA9PiB1aW50MTI4KSBtb3N0UmVjZW50T3JkZXJJZEZvckNsaWVudDsKICBtYXBwaW5nICh1aW50MTI4ID0+IHVpbnQxMjgpIGNsaWVudFByZXZpb3VzT3JkZXJJZEJlZm9yZU9yZGVySWQ7CgogIC8vIFByaWNlIENhbGN1bGF0aW9uIENvbnN0YW50cy4KICAvLwogIC8vIFdlIHBhY2sgZGlyZWN0aW9uIGFuZCBwcmljZSBpbnRvIGEgY3JhZnR5IGRlY2ltYWwgZmxvYXRpbmcgcG9pbnQgcmVwcmVzZW50YXRpb24KICAvLyBmb3IgZWZmaWNpZW50IGluZGV4aW5nIGJ5IHByaWNlLCB0aGUgbWFpbiB0aGluZyB3ZSBsb3NlIGJ5IGRvaW5nIHNvIGlzIHByZWNpc2lvbiAtCiAgLy8gd2Ugb25seSBoYXZlIDMgc2lnbmlmaWNhbnQgZmlndXJlcyBpbiBvdXIgcHJpY2VzLgogIC8vCiAgLy8gQW4gdW5wYWNrZWQgcHJpY2UgY29uc2lzdHMgb2Y6CiAgLy8KICAvLyAgIGRpcmVjdGlvbiAtIGludmFsaWQgLyBidXkgLyBzZWxsCiAgLy8gICBtYW50aXNzYSAgLSByYW5nZXMgZnJvbSAxMDAgdG8gOTk5IHJlcHJlc2VudGluZyAwLjEwMCB0byAwLjk5OQogIC8vICAgZXhwb25lbnQgIC0gcmFuZ2VzIGZyb20gbWluaW11bVByaWNlRXhwb25lbnQgdG8gbWluaW11bVByaWNlRXhwb25lbnQgKyAxMQogIC8vICAgICAgICAgICAgICAgKGUuZy4gLTUgdG8gKzYgZm9yIGEgdHlwaWNhbCBwYWlyIHdoZXJlIG1pblByaWNlRXhwb25lbnQgPSAtNSkKICAvLwogIC8vIFRoZSBwYWNrZWQgcmVwcmVzZW50YXRpb24gaGFzIDIxNjAxIGRpZmZlcmVudCBwcmljZSB2YWx1ZXM6CiAgLy8KICAvLyAgICAgIDAgID0gaW52YWxpZCAoY2FuIGJlIHVzZWQgYXMgbWFya2VyIHZhbHVlKQogIC8vICAgICAgMSAgPSBidXkgYXQgbWF4aW11bSBwcmljZSAoMC45OTkgKiAxMCAqKiA2KQogIC8vICAgIC4uLiAgPSBvdGhlciBidXkgcHJpY2VzIGluIGRlc2NlbmRpbmcgb3JkZXIKICAvLyAgIDU0MDEgID0gYnV5IGF0IDEuMDAKICAvLyAgICAuLi4gID0gb3RoZXIgYnV5IHByaWNlcyBpbiBkZXNjZW5kaW5nIG9yZGVyCiAgLy8gIDEwODAwICA9IGJ1eSBhdCBtaW5pbXVtIHByaWNlICgwLjEwMCAqIDEwICoqIC01KQogIC8vICAxMDgwMSAgPSBzZWxsIGF0IG1pbmltdW0gcHJpY2UgKDAuMTAwICogMTAgKiogLTUpCiAgLy8gICAgLi4uICA9IG90aGVyIHNlbGwgcHJpY2VzIGluIGRlc2NlbmRpbmcgb3JkZXIKICAvLyAgMTYyMDEgID0gc2VsbCBhdCAxLjAwCiAgLy8gICAgLi4uICA9IG90aGVyIHNlbGwgcHJpY2VzIGluIGRlc2NlbmRpbmcgb3JkZXIKICAvLyAgMjE2MDAgID0gc2VsbCBhdCBtYXhpbXVtIHByaWNlICgwLjk5OSAqIDEwICoqIDYpCiAgLy8gIDIxNjAxKyA9IGRvIG5vdCB1c2UKICAvLwogIC8vIElmIHdlIHdhbnQgdG8gbWFwIGVhY2ggcGFja2VkIHByaWNlIHRvIGEgYm9vbGVhbiB2YWx1ZSAod2hpY2ggd2UgZG8pLAogIC8vIHdlIHJlcXVpcmUgODUgMjU2LWJpdCB3b3Jkcy4gT3IgNDIuNSBmb3IgZWFjaCBzaWRlIG9mIHRoZSBib29rLgogIAogIGludDggY29uc3RhbnQgbWluUHJpY2VFeHBvbmVudCA9IC01OwoKICB1aW50IGNvbnN0YW50IGludmFsaWRQcmljZSA9IDA7CgogIC8vIGNhcmVmdWw6IG1heCA9IGxhcmdlc3QgdW5wYWNrZWQgdmFsdWUsIG5vdCBsYXJnZXN0IHBhY2tlZCB2YWx1ZQogIHVpbnQgY29uc3RhbnQgbWF4QnV5UHJpY2UgPSAxOyAKICB1aW50IGNvbnN0YW50IG1pbkJ1eVByaWNlID0gMTA4MDA7CiAgdWludCBjb25zdGFudCBtaW5TZWxsUHJpY2UgPSAxMDgwMTsKICB1aW50IGNvbnN0YW50IG1heFNlbGxQcmljZSA9IDIxNjAwOwoKICAvLyBDb25zdHJ1Y3Rvci4KICAvLwogIC8vIFNldHMgZmVlQ29sbGVjdG9yIHRvIHRoZSBjcmVhdG9yLiBDcmVhdG9yIG5lZWRzIHRvIGNhbGwgaW5pdCgpIHRvIGZpbmlzaCBzZXR1cC4KICAvLwogIGZ1bmN0aW9uIEJvb2tFUkMyMEV0aFYxKCkgewogICAgYWRkcmVzcyBjcmVhdG9yID0gbXNnLnNlbmRlcjsKICAgIGZlZUNvbGxlY3RvciA9IGNyZWF0b3I7CiAgfQoKICAvLyAiUHVibGljIiBNYW5hZ2VtZW50IC0gc2V0IGFkZHJlc3Mgb2YgYmFzZSBhbmQgcmV3YXJkIHRva2Vucy4KICAvLwogIC8vIENhbiBvbmx5IGJlIGRvbmUgb25jZSAobm9ybWFsbHkgaW1tZWRpYXRlbHkgYWZ0ZXIgY3JlYXRpb24pIGJ5IHRoZSBmZWUgY29sbGVjdG9yLgogIC8vCiAgLy8gVXNlZCBpbnN0ZWFkIG9mIGEgY29uc3RydWN0b3IgdG8gbWFrZSBkZXBsb3ltZW50IGVhc2llci4KICAvLwogIGZ1bmN0aW9uIGluaXQoRVJDMjAgX2Jhc2VUb2tlbiwgRVJDMjAgX3J3cmRUb2tlbikgcHVibGljIHsKICAgIHJlcXVpcmUobXNnLnNlbmRlciA9PSBmZWVDb2xsZWN0b3IpOwogICAgcmVxdWlyZShhZGRyZXNzKGJhc2VUb2tlbikgPT0gMCk7CiAgICByZXF1aXJlKGFkZHJlc3MoX2Jhc2VUb2tlbikgIT0gMCk7CiAgICByZXF1aXJlKGFkZHJlc3MocndyZFRva2VuKSA9PSAwKTsKICAgIHJlcXVpcmUoYWRkcmVzcyhfcndyZFRva2VuKSAhPSAwKTsKICAgIC8vIGF0dGVtcHQgdG8gY2F0Y2ggYmFkIHRva2VuczoKICAgIHJlcXVpcmUoX2Jhc2VUb2tlbi50b3RhbFN1cHBseSgpID4gMCk7CiAgICBiYXNlVG9rZW4gPSBfYmFzZVRva2VuOwogICAgcmVxdWlyZShfcndyZFRva2VuLnRvdGFsU3VwcGx5KCkgPiAwKTsKICAgIHJ3cmRUb2tlbiA9IF9yd3JkVG9rZW47CiAgfQoKICAvLyAiUHVibGljIiBNYW5hZ2VtZW50IC0gY2hhbmdlIGZlZSBjb2xsZWN0b3IKICAvLwogIC8vIFRoZSBuZXcgZmVlIGNvbGxlY3RvciBvbmx5IGdldHMgZmVlcyBjaGFyZ2VkIGFmdGVyIHRoaXMgcG9pbnQuCiAgLy8KICBmdW5jdGlvbiBjaGFuZ2VGZWVDb2xsZWN0b3IoYWRkcmVzcyBuZXdGZWVDb2xsZWN0b3IpIHB1YmxpYyB7CiAgICBhZGRyZXNzIG9sZEZlZUNvbGxlY3RvciA9IGZlZUNvbGxlY3RvcjsKICAgIHJlcXVpcmUobXNnLnNlbmRlciA9PSBvbGRGZWVDb2xsZWN0b3IpOwogICAgcmVxdWlyZShuZXdGZWVDb2xsZWN0b3IgIT0gb2xkRmVlQ29sbGVjdG9yKTsKICAgIGZlZUNvbGxlY3RvciA9IG5ld0ZlZUNvbGxlY3RvcjsKICB9CiAgCiAgLy8gUHVibGljIEluZm8gVmlldyAtIHdoYXQgaXMgYmVpbmcgdHJhZGVkIGhlcmUsIHdoYXQgYXJlIHRoZSBsaW1pdHM/CiAgLy8KICBmdW5jdGlvbiBnZXRCb29rSW5mbygpIHB1YmxpYyBjb25zdGFudCByZXR1cm5zICgKICAgICAgQm9va1R5cGUgX2Jvb2tUeXBlLCBhZGRyZXNzIF9iYXNlVG9rZW4sIGFkZHJlc3MgX3J3cmRUb2tlbiwKICAgICAgdWludCBfYmFzZU1pbkluaXRpYWxTaXplLCB1aW50IF9jbnRyTWluSW5pdGlhbFNpemUsCiAgICAgIHVpbnQgX2ZlZURpdmlzb3IsIGFkZHJlc3MgX2ZlZUNvbGxlY3RvcgogICAgKSB7CiAgICByZXR1cm4gKAogICAgICBCb29rVHlwZS5FUkMyMEV0aFYxLAogICAgICBhZGRyZXNzKGJhc2VUb2tlbiksCiAgICAgIGFkZHJlc3MocndyZFRva2VuKSwKICAgICAgYmFzZU1pbkluaXRpYWxTaXplLAogICAgICBjbnRyTWluSW5pdGlhbFNpemUsCiAgICAgIGZlZURpdmlzb3IsCiAgICAgIGZlZUNvbGxlY3RvcgogICAgKTsKICB9CgogIC8vIFB1YmxpYyBGdW5kcyBWaWV3IC0gZ2V0IGJhbGFuY2VzIGhlbGQgYnkgY29udHJhY3Qgb24gYmVoYWxmIG9mIHRoZSBjbGllbnQsCiAgLy8gb3IgYmFsYW5jZXMgYXBwcm92ZWQgZm9yIGRlcG9zaXQgYnV0IG5vdCB5ZXQgY2xhaW1lZCBieSB0aGUgY29udHJhY3QuCiAgLy8KICAvLyBFeGNsdWRlcyBmdW5kcyBpbiBvcGVuIG9yZGVycy4KICAvLwogIC8vIEhlbHBzIGEgd2ViIHVpIGdldCBhIGNvbnNpc3RlbnQgc25hcHNob3Qgb2YgYmFsYW5jZXMuCiAgLy8KICAvLyBJdCB3b3VsZCBiZSBuaWNlIHRvIHJldHVybiB0aGUgb2ZmLWV4Y2hhbmdlIEVUSCBiYWxhbmNlIHRvbyBidXQgdGhlcmUncyBhCiAgLy8gYml6YXJyZSBidWcgaW4gZ2V0aCAoYW5kIGFwcGFyZW50bHkgYXMgYSByZXN1bHQgdmlhIE1ldGFNYXNrKSB0aGF0IGxlYWRzCiAgLy8gdG8gdW5wcmVkaWN0YWJsZSBiZWhhdmlvdXIgd2hlbiBsb29raW5nIHVwIGNsaWVudCBiYWxhbmNlcyBpbiBjb25zdGFudAogIC8vIGZ1bmN0aW9ucyAtIHNlZSBlLmcuIGh0dHBzOi8vZ2l0aHViLmNvbS9ldGhlcmV1bS9zb2xpZGl0eS9pc3N1ZXMvMjMyNSAuCiAgLy8KICBmdW5jdGlvbiBnZXRDbGllbnRCYWxhbmNlcyhhZGRyZXNzIGNsaWVudCkgcHVibGljIGNvbnN0YW50IHJldHVybnMgKAogICAgICB1aW50IGJvb2tCYWxhbmNlQmFzZSwKICAgICAgdWludCBib29rQmFsYW5jZUNudHIsCiAgICAgIHVpbnQgYm9va0JhbGFuY2VSd3JkLAogICAgICB1aW50IGFwcHJvdmVkQmFsYW5jZUJhc2UsCiAgICAgIHVpbnQgYXBwcm92ZWRCYWxhbmNlUndyZCwKICAgICAgdWludCBvd25CYWxhbmNlQmFzZSwKICAgICAgdWludCBvd25CYWxhbmNlUndyZAogICAgKSB7CiAgICBib29rQmFsYW5jZUJhc2UgPSBiYWxhbmNlQmFzZUZvckNsaWVudFtjbGllbnRdOwogICAgYm9va0JhbGFuY2VDbnRyID0gYmFsYW5jZUNudHJGb3JDbGllbnRbY2xpZW50XTsKICAgIGJvb2tCYWxhbmNlUndyZCA9IGJhbGFuY2VSd3JkRm9yQ2xpZW50W2NsaWVudF07CiAgICBhcHByb3ZlZEJhbGFuY2VCYXNlID0gYmFzZVRva2VuLmFsbG93YW5jZShjbGllbnQsIGFkZHJlc3ModGhpcykpOwogICAgYXBwcm92ZWRCYWxhbmNlUndyZCA9IHJ3cmRUb2tlbi5hbGxvd2FuY2UoY2xpZW50LCBhZGRyZXNzKHRoaXMpKTsKICAgIG93bkJhbGFuY2VCYXNlID0gYmFzZVRva2VuLmJhbGFuY2VPZihjbGllbnQpOwogICAgb3duQmFsYW5jZVJ3cmQgPSByd3JkVG9rZW4uYmFsYW5jZU9mKGNsaWVudCk7CiAgfQoKICAvLyBQdWJsaWMgRnVuZHMgTWFuaXB1bGF0aW9uIC0gZGVwb3NpdCBwcmV2aW91c2x5LWFwcHJvdmVkIGJhc2UgdG9rZW5zLgogIC8vCiAgZnVuY3Rpb24gdHJhbnNmZXJGcm9tQmFzZSgpIHB1YmxpYyB7CiAgICBhZGRyZXNzIGNsaWVudCA9IG1zZy5zZW5kZXI7CiAgICBhZGRyZXNzIGJvb2sgPSBhZGRyZXNzKHRoaXMpOwogICAgLy8gd2UgdHJ1c3QgdGhlIEVSQzIwIHRva2VuIGNvbnRyYWN0IG5vdCB0byBkbyBuYXN0eSB0aGluZ3MgbGlrZSBjYWxsIGJhY2sgaW50byB1cyAtCiAgICAvLyBpZiB3ZSBjYW5ub3QgdHJ1c3QgdGhlIHRva2VuIHRoZW4gd2h5IGFyZSB3ZSBhbGxvd2luZyBpdCB0byBiZSB0cmFkZWQ/CiAgICB1aW50IGFtb3VudEJhc2UgPSBiYXNlVG9rZW4uYWxsb3dhbmNlKGNsaWVudCwgYm9vayk7CiAgICByZXF1aXJlKGFtb3VudEJhc2UgPiAwKTsKICAgIC8vIE5COiBuZWVkcyBjaGFuZ2UgZm9yIG9sZGVyIEVSQzIwIHRva2VucyB0aGF0IGRvbid0IHJldHVybiBib29sCiAgICByZXF1aXJlKGJhc2VUb2tlbi50cmFuc2ZlckZyb20oY2xpZW50LCBib29rLCBhbW91bnRCYXNlKSk7CiAgICAvLyBiZWx0IGFuZCBicmFjZXMKICAgIGFzc2VydChiYXNlVG9rZW4uYWxsb3dhbmNlKGNsaWVudCwgYm9vaykgPT0gMCk7CiAgICBiYWxhbmNlQmFzZUZvckNsaWVudFtjbGllbnRdICs9IGFtb3VudEJhc2U7CiAgICBDbGllbnRQYXltZW50RXZlbnQoY2xpZW50LCBDbGllbnRQYXltZW50RXZlbnRUeXBlLlRyYW5zZmVyRnJvbSwgQmFsYW5jZVR5cGUuQmFzZSwgaW50KGFtb3VudEJhc2UpKTsKICB9CgogIC8vIFB1YmxpYyBGdW5kcyBNYW5pcHVsYXRpb24gLSB3aXRoZHJhdyBiYXNlIHRva2VucyAoYXMgYSB0cmFuc2ZlcikuCiAgLy8KICBmdW5jdGlvbiB0cmFuc2ZlckJhc2UodWludCBhbW91bnRCYXNlKSBwdWJsaWMgewogICAgYWRkcmVzcyBjbGllbnQgPSBtc2cuc2VuZGVyOwogICAgcmVxdWlyZShhbW91bnRCYXNlID4gMCk7CiAgICByZXF1aXJlKGFtb3VudEJhc2UgPD0gYmFsYW5jZUJhc2VGb3JDbGllbnRbY2xpZW50XSk7CiAgICAvLyBvdmVyZmxvdyBzYWZlIHNpbmNlIHdlIGNoZWNrZWQgbGVzcyB0aGFuIGJhbGFuY2UgYWJvdmUKICAgIGJhbGFuY2VCYXNlRm9yQ2xpZW50W2NsaWVudF0gLT0gYW1vdW50QmFzZTsKICAgIC8vIHdlIHRydXN0IHRoZSBFUkMyMCB0b2tlbiBjb250cmFjdCBub3QgdG8gZG8gbmFzdHkgdGhpbmdzIGxpa2UgY2FsbCBiYWNrIGludG8gdXMgLQogICAgLy8gaWYgd2UgY2Fubm90IHRydXN0IHRoZSB0b2tlbiB0aGVuIHdoeSBhcmUgd2UgYWxsb3dpbmcgaXQgdG8gYmUgdHJhZGVkPwogICAgLy8gTkI6IG5lZWRzIGNoYW5nZSBmb3Igb2xkZXIgRVJDMjAgdG9rZW5zIHRoYXQgZG9uJ3QgcmV0dXJuIGJvb2wKICAgIHJlcXVpcmUoYmFzZVRva2VuLnRyYW5zZmVyKGNsaWVudCwgYW1vdW50QmFzZSkpOwogICAgQ2xpZW50UGF5bWVudEV2ZW50KGNsaWVudCwgQ2xpZW50UGF5bWVudEV2ZW50VHlwZS5UcmFuc2ZlciwgQmFsYW5jZVR5cGUuQmFzZSwgLWludChhbW91bnRCYXNlKSk7CiAgfQoKICAvLyBQdWJsaWMgRnVuZHMgTWFuaXB1bGF0aW9uIC0gZGVwb3NpdCBjb3VudGVyIGN1cnJlbmN5IChFVEgpLgogIC8vCiAgZnVuY3Rpb24gZGVwb3NpdENudHIoKSBwdWJsaWMgcGF5YWJsZSB7CiAgICBhZGRyZXNzIGNsaWVudCA9IG1zZy5zZW5kZXI7CiAgICB1aW50IGFtb3VudENudHIgPSBtc2cudmFsdWU7CiAgICByZXF1aXJlKGFtb3VudENudHIgPiAwKTsKICAgIC8vIG92ZXJmbG93IHNhZmUgLSBpZiBzb21lb25lIG93bnMgcG93KDIsMjU1KSBFVEggd2UgaGF2ZSBiaWdnZXIgcHJvYmxlbXMKICAgIGJhbGFuY2VDbnRyRm9yQ2xpZW50W2NsaWVudF0gKz0gYW1vdW50Q250cjsKICAgIENsaWVudFBheW1lbnRFdmVudChjbGllbnQsIENsaWVudFBheW1lbnRFdmVudFR5cGUuRGVwb3NpdCwgQmFsYW5jZVR5cGUuQ250ciwgaW50KGFtb3VudENudHIpKTsKICB9CgogIC8vIFB1YmxpYyBGdW5kcyBNYW5pcHVsYXRpb24gLSB3aXRoZHJhdyBjb3VudGVyIGN1cnJlbmN5IChFVEgpLgogIC8vCiAgZnVuY3Rpb24gd2l0aGRyYXdDbnRyKHVpbnQgYW1vdW50Q250cikgcHVibGljIHsKICAgIGFkZHJlc3MgY2xpZW50ID0gbXNnLnNlbmRlcjsKICAgIHJlcXVpcmUoYW1vdW50Q250ciA+IDApOwogICAgcmVxdWlyZShhbW91bnRDbnRyIDw9IGJhbGFuY2VDbnRyRm9yQ2xpZW50W2NsaWVudF0pOwogICAgLy8gb3ZlcmZsb3cgc2FmZSAtIGNoZWNrZWQgbGVzcyB0aGFuIGJhbGFuY2UgYWJvdmUKICAgIGJhbGFuY2VDbnRyRm9yQ2xpZW50W2NsaWVudF0gLT0gYW1vdW50Q250cjsKICAgIC8vIHNhZmUgLSBub3QgZW5vdWdoIGdhcyB0byBkbyBhbnl0aGluZyBpbnRlcmVzdGluZyBpbiBmYWxsYmFjaywgYWxyZWFkeSBhZGp1c3RlZCBiYWxhbmNlCiAgICBjbGllbnQudHJhbnNmZXIoYW1vdW50Q250cik7CiAgICBDbGllbnRQYXltZW50RXZlbnQoY2xpZW50LCBDbGllbnRQYXltZW50RXZlbnRUeXBlLldpdGhkcmF3LCBCYWxhbmNlVHlwZS5DbnRyLCAtaW50KGFtb3VudENudHIpKTsKICB9CgogIC8vIFB1YmxpYyBGdW5kcyBNYW5pcHVsYXRpb24gLSBkZXBvc2l0IHByZXZpb3VzbHktYXBwcm92ZWQgcmV3YXJkIHRva2Vucy4KICAvLwogIGZ1bmN0aW9uIHRyYW5zZmVyRnJvbVJ3cmQoKSBwdWJsaWMgewogICAgYWRkcmVzcyBjbGllbnQgPSBtc2cuc2VuZGVyOwogICAgYWRkcmVzcyBib29rID0gYWRkcmVzcyh0aGlzKTsKICAgIHVpbnQgYW1vdW50UndyZCA9IHJ3cmRUb2tlbi5hbGxvd2FuY2UoY2xpZW50LCBib29rKTsKICAgIHJlcXVpcmUoYW1vdW50UndyZCA+IDApOwogICAgLy8gd2Ugd3JvdGUgdGhlIHJld2FyZCB0b2tlbiBzbyB3ZSBrbm93IGl0IHN1cHBvcnRzIEVSQzIwIHByb3Blcmx5IGFuZCBpcyBub3QgZXZpbAogICAgcmVxdWlyZShyd3JkVG9rZW4udHJhbnNmZXJGcm9tKGNsaWVudCwgYm9vaywgYW1vdW50UndyZCkpOwogICAgLy8gYmVsdCBhbmQgYnJhY2VzCiAgICBhc3NlcnQocndyZFRva2VuLmFsbG93YW5jZShjbGllbnQsIGJvb2spID09IDApOwogICAgYmFsYW5jZVJ3cmRGb3JDbGllbnRbY2xpZW50XSArPSBhbW91bnRSd3JkOwogICAgQ2xpZW50UGF5bWVudEV2ZW50KGNsaWVudCwgQ2xpZW50UGF5bWVudEV2ZW50VHlwZS5UcmFuc2ZlckZyb20sIEJhbGFuY2VUeXBlLlJ3cmQsIGludChhbW91bnRSd3JkKSk7CiAgfQoKICAvLyBQdWJsaWMgRnVuZHMgTWFuaXB1bGF0aW9uIC0gd2l0aGRyYXcgYmFzZSB0b2tlbnMgKGFzIGEgdHJhbnNmZXIpLgogIC8vCiAgZnVuY3Rpb24gdHJhbnNmZXJSd3JkKHVpbnQgYW1vdW50UndyZCkgcHVibGljIHsKICAgIGFkZHJlc3MgY2xpZW50ID0gbXNnLnNlbmRlcjsKICAgIHJlcXVpcmUoYW1vdW50UndyZCA+IDApOwogICAgcmVxdWlyZShhbW91bnRSd3JkIDw9IGJhbGFuY2VSd3JkRm9yQ2xpZW50W2NsaWVudF0pOwogICAgLy8gb3ZlcmZsb3cgc2FmZSAtIGNoZWNrZWQgbGVzcyB0aGFuIGJhbGFuY2UgYWJvdmUKICAgIGJhbGFuY2VSd3JkRm9yQ2xpZW50W2NsaWVudF0gLT0gYW1vdW50UndyZDsKICAgIC8vIHdlIHdyb3RlIHRoZSByZXdhcmQgdG9rZW4gc28gd2Uga25vdyBpdCBzdXBwb3J0cyBFUkMyMCBwcm9wZXJseSBhbmQgaXMgbm90IGV2aWwKICAgIHJlcXVpcmUocndyZFRva2VuLnRyYW5zZmVyKGNsaWVudCwgYW1vdW50UndyZCkpOwogICAgQ2xpZW50UGF5bWVudEV2ZW50KGNsaWVudCwgQ2xpZW50UGF5bWVudEV2ZW50VHlwZS5UcmFuc2ZlciwgQmFsYW5jZVR5cGUuUndyZCwgLWludChhbW91bnRSd3JkKSk7CiAgfQoKICAvLyBQdWJsaWMgT3JkZXIgVmlldyAtIGdldCBmdWxsIGRldGFpbHMgb2YgYW4gb3JkZXIuCiAgLy8KICAvLyBJZiB0aGUgb3JkZXJJZCBkb2VzIG5vdCBleGlzdCwgc3RhdHVzIHdpbGwgYmUgVW5rbm93bi4KICAvLwogIGZ1bmN0aW9uIGdldE9yZGVyKHVpbnQxMjggb3JkZXJJZCkgcHVibGljIGNvbnN0YW50IHJldHVybnMgKAogICAgYWRkcmVzcyBjbGllbnQsIHVpbnQxNiBwcmljZSwgdWludCBzaXplQmFzZSwgVGVybXMgdGVybXMsCiAgICBTdGF0dXMgc3RhdHVzLCBSZWFzb25Db2RlIHJlYXNvbkNvZGUsIHVpbnQgZXhlY3V0ZWRCYXNlLCB1aW50IGV4ZWN1dGVkQ250ciwKICAgIHVpbnQgZmVlc0Jhc2VPckNudHIsIHVpbnQgZmVlc1J3cmQpIHsKICAgIE9yZGVyIHN0b3JhZ2Ugb3JkZXIgPSBvcmRlckZvck9yZGVySWRbb3JkZXJJZF07CiAgICByZXR1cm4gKG9yZGVyLmNsaWVudCwgb3JkZXIucHJpY2UsIG9yZGVyLnNpemVCYXNlLCBvcmRlci50ZXJtcywKICAgICAgICAgICAgb3JkZXIuc3RhdHVzLCBvcmRlci5yZWFzb25Db2RlLCBvcmRlci5leGVjdXRlZEJhc2UsIG9yZGVyLmV4ZWN1dGVkQ250ciwKICAgICAgICAgICAgb3JkZXIuZmVlc0Jhc2VPckNudHIsIG9yZGVyLmZlZXNSd3JkKTsKICB9CgogIC8vIFB1YmxpYyBPcmRlciBWaWV3IC0gZ2V0IG11dGFibGUgZGV0YWlscyBvZiBhbiBvcmRlci4KICAvLwogIC8vIElmIHRoZSBvcmRlcklkIGRvZXMgbm90IGV4aXN0LCBzdGF0dXMgd2lsbCBiZSBVbmtub3duLgogIC8vCiAgZnVuY3Rpb24gZ2V0T3JkZXJTdGF0ZSh1aW50MTI4IG9yZGVySWQpIHB1YmxpYyBjb25zdGFudCByZXR1cm5zICgKICAgIFN0YXR1cyBzdGF0dXMsIFJlYXNvbkNvZGUgcmVhc29uQ29kZSwgdWludCBleGVjdXRlZEJhc2UsIHVpbnQgZXhlY3V0ZWRDbnRyLAogICAgdWludCBmZWVzQmFzZU9yQ250ciwgdWludCBmZWVzUndyZCkgewogICAgT3JkZXIgc3RvcmFnZSBvcmRlciA9IG9yZGVyRm9yT3JkZXJJZFtvcmRlcklkXTsKICAgIHJldHVybiAob3JkZXIuc3RhdHVzLCBvcmRlci5yZWFzb25Db2RlLCBvcmRlci5leGVjdXRlZEJhc2UsIG9yZGVyLmV4ZWN1dGVkQ250ciwKICAgICAgICAgICAgb3JkZXIuZmVlc0Jhc2VPckNudHIsIG9yZGVyLmZlZXNSd3JkKTsKICB9CiAgCiAgLy8gUHVibGljIE9yZGVyIFZpZXcgLSBlbnVtZXJhdGUgYWxsIHJlY2VudCBvcmRlcnMgKyBhbGwgb3BlbiBvcmRlcnMgZm9yIG9uZSBjbGllbnQuCiAgLy8KICAvLyBOb3QgcmVhbGx5IGRlc2lnbmVkIGZvciB1c2UgZnJvbSBhIHNtYXJ0IGNvbnRyYWN0IHRyYW5zYWN0aW9uLgogIC8vCiAgLy8gSWRlYSBpczoKICAvLyAgLSBjbGllbnQgZW5zdXJlcyBvcmRlciBpZHMgYXJlIGdlbmVyYXRlZCBzbyB0aGF0IG1vc3Qtc2lnbmZpY2FudCBwYXJ0IGlzIHRpbWUtYmFzZWQ7CiAgLy8gIC0gY2xpZW50IGRlY2lkZXMgdGhleSB3YW50IGFsbCBvcmRlcnMgYWZ0ZXIgYSBjZXJ0YWluIHBvaW50LWluLXRpbWUsCiAgLy8gICAgYW5kIGNob29zZXMgbWluQ2xvc2VkT3JkZXJJZEN1dG9mZiBhY2NvcmRpbmdseTsKICAvLyAgLSBiZWZvcmUgdGhhdCBwb2ludC1pbi10aW1lIHRoZXkganVzdCBnZXQgb3BlbiBhbmQgbmVlZHMgZ2FzIG9yZGVycwogIC8vICAtIGNsaWVudCBjYWxscyB3YWxrQ2xpZW50T3JkZXJzIHdpdGggbWF5YmVMYXN0T3JkZXJJZFJldHVybmVkID0gMCBpbml0aWFsbHk7CiAgLy8gIC0gdGhlbiByZXBlYXRzIHdpdGggdGhlIG9yZGVySWQgcmV0dXJuZWQgYnkgd2Fsa0NsaWVudE9yZGVyczsKICAvLyAgLSAoYW5kIHN0b3BzIGlmIGl0IHJldHVybnMgYSB6ZXJvIG9yZGVySWQpOwogIC8vCiAgLy8gTm90ZSB0aGF0IGNsaWVudCBpcyBvbmx5IHVzZWQgd2hlbiBtYXliZUxhc3RPcmRlcklkUmV0dXJuZWQgPSAwLgogIC8vCiAgZnVuY3Rpb24gd2Fsa0NsaWVudE9yZGVycygKICAgICAgYWRkcmVzcyBjbGllbnQsIHVpbnQxMjggbWF5YmVMYXN0T3JkZXJJZFJldHVybmVkLCB1aW50MTI4IG1pbkNsb3NlZE9yZGVySWRDdXRvZmYKICAgICkgcHVibGljIGNvbnN0YW50IHJldHVybnMgKAogICAgICB1aW50MTI4IG9yZGVySWQsIHVpbnQxNiBwcmljZSwgdWludCBzaXplQmFzZSwgVGVybXMgdGVybXMsCiAgICAgIFN0YXR1cyBzdGF0dXMsIFJlYXNvbkNvZGUgcmVhc29uQ29kZSwgdWludCBleGVjdXRlZEJhc2UsIHVpbnQgZXhlY3V0ZWRDbnRyLAogICAgICB1aW50IGZlZXNCYXNlT3JDbnRyLCB1aW50IGZlZXNSd3JkKSB7CiAgICBpZiAobWF5YmVMYXN0T3JkZXJJZFJldHVybmVkID09IDApIHsKICAgICAgb3JkZXJJZCA9IG1vc3RSZWNlbnRPcmRlcklkRm9yQ2xpZW50W2NsaWVudF07CiAgICB9IGVsc2UgewogICAgICBvcmRlcklkID0gY2xpZW50UHJldmlvdXNPcmRlcklkQmVmb3JlT3JkZXJJZFttYXliZUxhc3RPcmRlcklkUmV0dXJuZWRdOwogICAgfQogICAgd2hpbGUgKHRydWUpIHsKICAgICAgaWYgKG9yZGVySWQgPT0gMCkgcmV0dXJuOwogICAgICBPcmRlciBzdG9yYWdlIG9yZGVyID0gb3JkZXJGb3JPcmRlcklkW29yZGVySWRdOwogICAgICBpZiAob3JkZXJJZCA+PSBtaW5DbG9zZWRPcmRlcklkQ3V0b2ZmKSBicmVhazsKICAgICAgaWYgKG9yZGVyLnN0YXR1cyA9PSBTdGF0dXMuT3BlbiB8fCBvcmRlci5zdGF0dXMgPT0gU3RhdHVzLk5lZWRzR2FzKSBicmVhazsKICAgICAgb3JkZXJJZCA9IGNsaWVudFByZXZpb3VzT3JkZXJJZEJlZm9yZU9yZGVySWRbb3JkZXJJZF07CiAgICB9CiAgICByZXR1cm4gKG9yZGVySWQsIG9yZGVyLnByaWNlLCBvcmRlci5zaXplQmFzZSwgb3JkZXIudGVybXMsCiAgICAgICAgICAgIG9yZGVyLnN0YXR1cywgb3JkZXIucmVhc29uQ29kZSwgb3JkZXIuZXhlY3V0ZWRCYXNlLCBvcmRlci5leGVjdXRlZENudHIsCiAgICAgICAgICAgIG9yZGVyLmZlZXNCYXNlT3JDbnRyLCBvcmRlci5mZWVzUndyZCk7CiAgfQogCiAgLy8gSW50ZXJuYWwgUHJpY2UgQ2FsY3VsYXRpb24gLSB0dXJuIHBhY2tlZCBwcmljZSBpbnRvIGEgZnJpZW5kbGllciB1bnBhY2tlZCBwcmljZS4KICAvLwogIGZ1bmN0aW9uIHVucGFja1ByaWNlKHVpbnQxNiBwcmljZSkgaW50ZXJuYWwgY29uc3RhbnQgcmV0dXJucyAoCiAgICAgIERpcmVjdGlvbiBkaXJlY3Rpb24sIHVpbnQxNiBtYW50aXNzYSwgaW50OCBleHBvbmVudAogICAgKSB7CiAgICB1aW50IHNpZGVkUHJpY2VJbmRleCA9IHVpbnQocHJpY2UpOwogICAgdWludCBwcmljZUluZGV4OwogICAgaWYgKHNpZGVkUHJpY2VJbmRleCA8IDEgfHwgc2lkZWRQcmljZUluZGV4ID4gbWF4U2VsbFByaWNlKSB7CiAgICAgIGRpcmVjdGlvbiA9IERpcmVjdGlvbi5JbnZhbGlkOwogICAgICBtYW50aXNzYSA9IDA7CiAgICAgIGV4cG9uZW50ID0gMDsKICAgICAgcmV0dXJuOwogICAgfSBlbHNlIGlmIChzaWRlZFByaWNlSW5kZXggPD0gbWluQnV5UHJpY2UpIHsKICAgICAgZGlyZWN0aW9uID0gRGlyZWN0aW9uLkJ1eTsKICAgICAgcHJpY2VJbmRleCA9IG1pbkJ1eVByaWNlIC0gc2lkZWRQcmljZUluZGV4OwogICAgfSBlbHNlIHsKICAgICAgZGlyZWN0aW9uID0gRGlyZWN0aW9uLlNlbGw7CiAgICAgIHByaWNlSW5kZXggPSBzaWRlZFByaWNlSW5kZXggLSBtaW5TZWxsUHJpY2U7CiAgICB9CiAgICB1aW50IHplcm9CYXNlZE1hbnRpc3NhID0gcHJpY2VJbmRleCAlIDkwMDsKICAgIHVpbnQgemVyb0Jhc2VkRXhwb25lbnQgPSBwcmljZUluZGV4IC8gOTAwOwogICAgbWFudGlzc2EgPSB1aW50MTYoemVyb0Jhc2VkTWFudGlzc2EgKyAxMDApOwogICAgZXhwb25lbnQgPSBpbnQ4KHplcm9CYXNlZEV4cG9uZW50KSArIG1pblByaWNlRXhwb25lbnQ7CiAgICByZXR1cm47CiAgfQogIAogIC8vIEludGVybmFsIFByaWNlIENhbGN1bGF0aW9uIC0gaXMgYSBwYWNrZWQgcHJpY2Ugb24gdGhlIGJ1eSBzaWRlPwogIC8vCiAgLy8gVGhyb3dzIGFuIGVycm9yIGlmIHByaWNlIGlzIGludmFsaWQuCiAgLy8KICBmdW5jdGlvbiBpc0J1eVByaWNlKHVpbnQxNiBwcmljZSkgaW50ZXJuYWwgY29uc3RhbnQgcmV0dXJucyAoYm9vbCBpc0J1eSkgewogICAgLy8geWVzLCB0aGlzIGxvb2tzIG9kZCwgYnV0IG1heCBoZXJlIGlzIGhpZ2hlc3QgX3VucGFja2VkXyBwcmljZQogICAgcmV0dXJuIHByaWNlID49IG1heEJ1eVByaWNlICYmIHByaWNlIDw9IG1pbkJ1eVByaWNlOwogIH0KICAKICAvLyBJbnRlcm5hbCBQcmljZSBDYWxjdWxhdGlvbiAtIHR1cm4gYSBwYWNrZWQgYnV5IHByaWNlIGludG8gYSBwYWNrZWQgc2VsbCBwcmljZS4KICAvLwogIC8vIEludmFsaWQgcHJpY2UgcmVtYWlucyBpbnZhbGlkLgogIC8vCiAgZnVuY3Rpb24gY29tcHV0ZU9wcG9zaXRlUHJpY2UodWludDE2IHByaWNlKSBpbnRlcm5hbCBjb25zdGFudCByZXR1cm5zICh1aW50MTYgb3Bwb3NpdGUpIHsKICAgIGlmIChwcmljZSA8IG1heEJ1eVByaWNlIHx8IHByaWNlID4gbWF4U2VsbFByaWNlKSB7CiAgICAgIHJldHVybiB1aW50MTYoaW52YWxpZFByaWNlKTsKICAgIH0gZWxzZSBpZiAocHJpY2UgPD0gbWluQnV5UHJpY2UpIHsKICAgICAgcmV0dXJuIHVpbnQxNihtYXhTZWxsUHJpY2UgLSAocHJpY2UgLSBtYXhCdXlQcmljZSkpOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHVpbnQxNihtYXhCdXlQcmljZSArIChtYXhTZWxsUHJpY2UgLSBwcmljZSkpOwogICAgfQogIH0KICAKICAvLyBJbnRlcm5hbCBQcmljZSBDYWxjdWxhdGlvbiAtIGNvbXB1dGUgYW1vdW50IGluIGNvdW50ZXIgY3VycmVuY3kgdGhhdCB3b3VsZAogIC8vIGJlIG9idGFpbmVkIGJ5IHNlbGxpbmcgYmFzZUFtb3VudCBhdCB0aGUgZ2l2ZW4gdW5wYWNrZWQgcHJpY2UgKGlmIG5vIGZlZXMpLgogIC8vCiAgLy8gTm90ZXM6CiAgLy8gIC0gRG9lcyBub3QgdmFsaWRhdGUgcHJpY2UgLSBjYWxsZXIgbXVzdCBlbnN1cmUgdmFsaWQuCiAgLy8gIC0gQ291bGQgb3ZlcmZsb3cgcHJvZHVjaW5nIHZlcnkgdW5leHBlY3RlZCByZXN1bHRzIGlmIGJhc2VBbW91bnQgdmVyeQogIC8vICAgIGxhcmdlIC0gY2FsbGVyIG11c3QgY2hlY2sgdGhpcy4KICAvLyAgLSBUaGlzIHJvdW5kcyB0aGUgYW1vdW50IHRvd2FyZHMgemVyby4KICAvLyAgLSBNYXkgdHJ1bmNhdGUgdG8gemVybyBpZiBiYXNlQW1vdW50IHZlcnkgc21hbGwgLSBwb3RlbnRpYWxseSBhbGxvd2luZwogIC8vICAgIHplcm8tY29zdCBidXlzIG9yIHBvaW50bGVzcyBzYWxlcyAtIGNhbGxlciBtdXN0IGNoZWNrIHRoaXMuCiAgLy8KICBmdW5jdGlvbiBjb21wdXRlQ250ckFtb3VudFVzaW5nVW5wYWNrZWQoCiAgICAgIHVpbnQgYmFzZUFtb3VudCwgdWludDE2IG1hbnRpc3NhLCBpbnQ4IGV4cG9uZW50CiAgICApIGludGVybmFsIGNvbnN0YW50IHJldHVybnMgKHVpbnQgY250ckFtb3VudCkgewogICAgaWYgKGV4cG9uZW50IDwgMCkgewogICAgICByZXR1cm4gYmFzZUFtb3VudCAqIHVpbnQobWFudGlzc2EpIC8gMTAwMCAvIDEwICoqIHVpbnQoLWV4cG9uZW50KTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBiYXNlQW1vdW50ICogdWludChtYW50aXNzYSkgLyAxMDAwICogMTAgKiogdWludChleHBvbmVudCk7CiAgICB9CiAgfQoKICAvLyBJbnRlcm5hbCBQcmljZSBDYWxjdWxhdGlvbiAtIGNvbXB1dGUgYW1vdW50IGluIGNvdW50ZXIgY3VycmVuY3kgdGhhdCB3b3VsZAogIC8vIGJlIG9idGFpbmVkIGJ5IHNlbGxpbmcgYmFzZUFtb3VudCBhdCB0aGUgZ2l2ZW4gcGFja2VkIHByaWNlIChpZiBubyBmZWVzKS4KICAvLwogIC8vIE5vdGVzOgogIC8vICAtIERvZXMgbm90IHZhbGlkYXRlIHByaWNlIC0gY2FsbGVyIG11c3QgZW5zdXJlIHZhbGlkLgogIC8vICAtIERpcmVjdGlvbiBvZiB0aGUgcGFja2VkIHByaWNlIGlzIGlnbm9yZWQuCiAgLy8gIC0gQ291bGQgb3ZlcmZsb3cgcHJvZHVjaW5nIHZlcnkgdW5leHBlY3RlZCByZXN1bHRzIGlmIGJhc2VBbW91bnQgdmVyeQogIC8vICAgIGxhcmdlIC0gY2FsbGVyIG11c3QgY2hlY2sgdGhpcy4KICAvLyAgLSBUaGlzIHJvdW5kcyB0aGUgYW1vdW50IHRvd2FyZHMgemVybyAocmVnYXJkbGVzcyBvZiBCdXkgb3IgU2VsbCkuCiAgLy8gIC0gTWF5IHRydW5jYXRlIHRvIHplcm8gaWYgYmFzZUFtb3VudCB2ZXJ5IHNtYWxsIC0gcG90ZW50aWFsbHkgYWxsb3dpbmcKICAvLyAgICB6ZXJvLWNvc3QgYnV5cyBvciBwb2ludGxlc3Mgc2FsZXMgLSBjYWxsZXIgbXVzdCBjaGVjayB0aGlzLgogIC8vCiAgZnVuY3Rpb24gY29tcHV0ZUNudHJBbW91bnRVc2luZ1BhY2tlZCgKICAgICAgdWludCBiYXNlQW1vdW50LCB1aW50MTYgcHJpY2UKICAgICkgaW50ZXJuYWwgY29uc3RhbnQgcmV0dXJucyAodWludCkgewogICAgdmFyICgsIG1hbnRpc3NhLCBleHBvbmVudCkgPSB1bnBhY2tQcmljZShwcmljZSk7CiAgICByZXR1cm4gY29tcHV0ZUNudHJBbW91bnRVc2luZ1VucGFja2VkKGJhc2VBbW91bnQsIG1hbnRpc3NhLCBleHBvbmVudCk7CiAgfQoKICAvLyBQdWJsaWMgT3JkZXIgUGxhY2VtZW50IC0gY3JlYXRlIG9yZGVyIGFuZCB0cnkgdG8gbWF0Y2ggaXQgYW5kL29yIGFkZCBpdCB0byB0aGUgYm9vay4KICAvLwogIGZ1bmN0aW9uIGNyZWF0ZU9yZGVyKAogICAgICB1aW50MTI4IG9yZGVySWQsIHVpbnQxNiBwcmljZSwgdWludCBzaXplQmFzZSwgVGVybXMgdGVybXMsIHVpbnQgbWF4TWF0Y2hlcwogICAgKSBwdWJsaWMgewogICAgYWRkcmVzcyBjbGllbnQgPSBtc2cuc2VuZGVyOwogICAgcmVxdWlyZShjbGllbnQgIT0gMCAmJiBvcmRlcklkICE9IDAgJiYgb3JkZXJGb3JPcmRlcklkW29yZGVySWRdLmNsaWVudCA9PSAwKTsKICAgIENsaWVudE9yZGVyRXZlbnQoY2xpZW50LCBDbGllbnRPcmRlckV2ZW50VHlwZS5DcmVhdGUsIG9yZGVySWQpOwogICAgb3JkZXJGb3JPcmRlcklkW29yZGVySWRdID0KICAgICAgT3JkZXIoY2xpZW50LCBwcmljZSwgc2l6ZUJhc2UsIHRlcm1zLCBTdGF0dXMuVW5rbm93biwgUmVhc29uQ29kZS5Ob25lLCAwLCAwLCAwLCAwKTsKICAgIHVpbnQxMjggcHJldmlvdXNNb3N0UmVjZW50T3JkZXJJZEZvckNsaWVudCA9IG1vc3RSZWNlbnRPcmRlcklkRm9yQ2xpZW50W2NsaWVudF07CiAgICBtb3N0UmVjZW50T3JkZXJJZEZvckNsaWVudFtjbGllbnRdID0gb3JkZXJJZDsKICAgIGNsaWVudFByZXZpb3VzT3JkZXJJZEJlZm9yZU9yZGVySWRbb3JkZXJJZF0gPSBwcmV2aW91c01vc3RSZWNlbnRPcmRlcklkRm9yQ2xpZW50OwogICAgT3JkZXIgc3RvcmFnZSBvcmRlciA9IG9yZGVyRm9yT3JkZXJJZFtvcmRlcklkXTsKICAgIHZhciAoZGlyZWN0aW9uLCBtYW50aXNzYSwgZXhwb25lbnQpID0gdW5wYWNrUHJpY2UocHJpY2UpOwogICAgaWYgKGRpcmVjdGlvbiA9PSBEaXJlY3Rpb24uSW52YWxpZCkgewogICAgICBvcmRlci5zdGF0dXMgPSBTdGF0dXMuUmVqZWN0ZWQ7CiAgICAgIG9yZGVyLnJlYXNvbkNvZGUgPSBSZWFzb25Db2RlLkludmFsaWRQcmljZTsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKHNpemVCYXNlIDwgYmFzZU1pbkluaXRpYWxTaXplIHx8IHNpemVCYXNlID4gYmFzZU1heFNpemUpIHsKICAgICAgb3JkZXIuc3RhdHVzID0gU3RhdHVzLlJlamVjdGVkOwogICAgICBvcmRlci5yZWFzb25Db2RlID0gUmVhc29uQ29kZS5JbnZhbGlkU2l6ZTsKICAgICAgcmV0dXJuOwogICAgfQogICAgdWludCBzaXplQ250ciA9IGNvbXB1dGVDbnRyQW1vdW50VXNpbmdVbnBhY2tlZChzaXplQmFzZSwgbWFudGlzc2EsIGV4cG9uZW50KTsKICAgIGlmIChzaXplQ250ciA8IGNudHJNaW5Jbml0aWFsU2l6ZSB8fCBzaXplQ250ciA+IGNudHJNYXhTaXplKSB7CiAgICAgIG9yZGVyLnN0YXR1cyA9IFN0YXR1cy5SZWplY3RlZDsKICAgICAgb3JkZXIucmVhc29uQ29kZSA9IFJlYXNvbkNvZGUuSW52YWxpZFNpemU7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmICh0ZXJtcyA9PSBUZXJtcy5NYWtlck9ubHkgJiYgbWF4TWF0Y2hlcyAhPSAwKSB7CiAgICAgIG9yZGVyLnN0YXR1cyA9IFN0YXR1cy5SZWplY3RlZDsKICAgICAgb3JkZXIucmVhc29uQ29kZSA9IFJlYXNvbkNvZGUuSW52YWxpZFRlcm1zOwogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAoIWRlYml0RnVuZHMoY2xpZW50LCBkaXJlY3Rpb24sIHNpemVCYXNlLCBzaXplQ250cikpIHsKICAgICAgb3JkZXIuc3RhdHVzID0gU3RhdHVzLlJlamVjdGVkOwogICAgICBvcmRlci5yZWFzb25Db2RlID0gUmVhc29uQ29kZS5JbnN1ZmZpY2llbnRGdW5kczsKICAgICAgcmV0dXJuOwogICAgfQogICAgcHJvY2Vzc09yZGVyKG9yZGVySWQsIG1heE1hdGNoZXMpOwogIH0KCiAgLy8gUHVibGljIE9yZGVyIFBsYWNlbWVudCAtIGNhbmNlbCBvcmRlcgogIC8vCiAgZnVuY3Rpb24gY2FuY2VsT3JkZXIodWludDEyOCBvcmRlcklkKSBwdWJsaWMgewogICAgYWRkcmVzcyBjbGllbnQgPSBtc2cuc2VuZGVyOwogICAgT3JkZXIgc3RvcmFnZSBvcmRlciA9IG9yZGVyRm9yT3JkZXJJZFtvcmRlcklkXTsKICAgIHJlcXVpcmUob3JkZXIuY2xpZW50ID09IGNsaWVudCk7CiAgICBTdGF0dXMgc3RhdHVzID0gb3JkZXIuc3RhdHVzOwogICAgaWYgKHN0YXR1cyAhPSBTdGF0dXMuT3BlbiAmJiBzdGF0dXMgIT0gU3RhdHVzLk5lZWRzR2FzKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmIChzdGF0dXMgPT0gU3RhdHVzLk9wZW4pIHsKICAgICAgcmVtb3ZlT3Blbk9yZGVyRnJvbUJvb2sob3JkZXJJZCk7CiAgICAgIE1hcmtldE9yZGVyRXZlbnQoYmxvY2sudGltZXN0YW1wLCBvcmRlcklkLCBNYXJrZXRPcmRlckV2ZW50VHlwZS5SZW1vdmUsIG9yZGVyLnByaWNlLAogICAgICAgIG9yZGVyLnNpemVCYXNlIC0gb3JkZXIuZXhlY3V0ZWRCYXNlLCAwKTsKICAgIH0KICAgIHJlZnVuZFVubWF0Y2hlZEFuZEZpbmlzaChvcmRlcklkLCBTdGF0dXMuRG9uZSwgUmVhc29uQ29kZS5DbGllbnRDYW5jZWwpOwogIH0KCiAgLy8gUHVibGljIE9yZGVyIFBsYWNlbWVudCAtIGNvbnRpbnVlIHBsYWNpbmcgYW4gb3JkZXIgaW4gJ05lZWRzR2FzJyBzdGF0ZQogIC8vCiAgZnVuY3Rpb24gY29udGludWVPcmRlcih1aW50MTI4IG9yZGVySWQsIHVpbnQgbWF4TWF0Y2hlcykgcHVibGljIHsKICAgIGFkZHJlc3MgY2xpZW50ID0gbXNnLnNlbmRlcjsKICAgIE9yZGVyIHN0b3JhZ2Ugb3JkZXIgPSBvcmRlckZvck9yZGVySWRbb3JkZXJJZF07CiAgICByZXF1aXJlKG9yZGVyLmNsaWVudCA9PSBjbGllbnQpOwogICAgaWYgKG9yZGVyLnN0YXR1cyAhPSBTdGF0dXMuTmVlZHNHYXMpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgb3JkZXIuc3RhdHVzID0gU3RhdHVzLlVua25vd247CiAgICBwcm9jZXNzT3JkZXIob3JkZXJJZCwgbWF4TWF0Y2hlcyk7CiAgfQoKICAvLyBJbnRlcm5hbCBPcmRlciBQbGFjZW1lbnQgLSByZW1vdmUgYSBzdGlsbC1vcGVuIG9yZGVyIGZyb20gdGhlIGJvb2suCiAgLy8KICAvLyBDYWxsZXIncyBqb2IgdG8gdXBkYXRlL3JlZnVuZCB0aGUgb3JkZXIgKyByYWlzZSBldmVudCwgdGhpcyBqdXN0CiAgLy8gdXBkYXRlcyB0aGUgb3JkZXIgY2hhaW4gYW5kIGJpdG1hc2suCiAgLy8KICAvLyBUb28gZXhwZW5zaXZlIHRvIGRvIG9uIGVhY2ggcmVzdGluZyBvcmRlciBtYXRjaCAtIHdlIG9ubHkgZG8gdGhpcyBmb3IgYW4KICAvLyBvcmRlciBiZWluZyBjYW5jZWxsZWQuIFNlZSBtYXRjaFdpdGhPY2N1cGllZFByaWNlIGZvciBzaW1pbGFyIGxvZ2ljLgogIC8vCiAgZnVuY3Rpb24gcmVtb3ZlT3Blbk9yZGVyRnJvbUJvb2sodWludDEyOCBvcmRlcklkKSBpbnRlcm5hbCB7CiAgICBPcmRlciBzdG9yYWdlIG9yZGVyID0gb3JkZXJGb3JPcmRlcklkW29yZGVySWRdOwogICAgdWludDE2IHByaWNlID0gb3JkZXIucHJpY2U7CiAgICBPcmRlckNoYWluIHN0b3JhZ2Ugb3JkZXJDaGFpbiA9IG9yZGVyQ2hhaW5Gb3JPY2N1cGllZFByaWNlW3ByaWNlXTsKICAgIE9yZGVyQ2hhaW5Ob2RlIHN0b3JhZ2Ugb3JkZXJDaGFpbk5vZGUgPSBvcmRlckNoYWluTm9kZUZvck9wZW5PcmRlcklkW29yZGVySWRdOwogICAgdWludDEyOCBuZXh0T3JkZXJJZCA9IG9yZGVyQ2hhaW5Ob2RlLm5leHRPcmRlcklkOwogICAgdWludDEyOCBwcmV2T3JkZXJJZCA9IG9yZGVyQ2hhaW5Ob2RlLnByZXZPcmRlcklkOwogICAgaWYgKG5leHRPcmRlcklkICE9IDApIHsKICAgICAgT3JkZXJDaGFpbk5vZGUgc3RvcmFnZSBuZXh0T3JkZXJDaGFpbk5vZGUgPSBvcmRlckNoYWluTm9kZUZvck9wZW5PcmRlcklkW25leHRPcmRlcklkXTsKICAgICAgbmV4dE9yZGVyQ2hhaW5Ob2RlLnByZXZPcmRlcklkID0gcHJldk9yZGVySWQ7CiAgICB9IGVsc2UgewogICAgICBvcmRlckNoYWluLmxhc3RPcmRlcklkID0gcHJldk9yZGVySWQ7CiAgICB9CiAgICBpZiAocHJldk9yZGVySWQgIT0gMCkgewogICAgICBPcmRlckNoYWluTm9kZSBzdG9yYWdlIHByZXZPcmRlckNoYWluTm9kZSA9IG9yZGVyQ2hhaW5Ob2RlRm9yT3Blbk9yZGVySWRbcHJldk9yZGVySWRdOwogICAgICBwcmV2T3JkZXJDaGFpbk5vZGUubmV4dE9yZGVySWQgPSBuZXh0T3JkZXJJZDsKICAgIH0gZWxzZSB7CiAgICAgIG9yZGVyQ2hhaW4uZmlyc3RPcmRlcklkID0gbmV4dE9yZGVySWQ7CiAgICB9CiAgICBpZiAobmV4dE9yZGVySWQgPT0gMCAmJiBwcmV2T3JkZXJJZCA9PSAwKSB7CiAgICAgIHVpbnQgYm1pID0gcHJpY2UgLyAyNTY7ICAvLyBpbmRleCBpbnRvIGFycmF5IG9mIGJpdG1hcHMKICAgICAgdWludCBidGkgPSBwcmljZSAlIDI1NjsgIC8vIGJpdCBwb3NpdGlvbiB3aXRoaW4gYml0bWFwCiAgICAgIC8vIHdlIGtub3cgd2FzIHByZXZpb3VzbHkgb2NjdXBpZWQgc28gWE9SIGNsZWFycwogICAgICBvY2N1cGllZFByaWNlQml0bWFwc1tibWldIF49IDIgKiogYnRpOwogICAgfQogIH0KCiAgLy8gSW50ZXJuYWwgT3JkZXIgUGxhY2VtZW50IC0gY3JlZGl0IGZ1bmRzIHJlY2VpdmVkIHdoZW4gdGFraW5nIGxpcXVpZGl0eSBmcm9tIGJvb2sKICAvLwogIGZ1bmN0aW9uIGNyZWRpdEV4ZWN1dGVkRnVuZHNMZXNzRmVlcyh1aW50MTI4IG9yZGVySWQsIHVpbnQgb3JpZ2luYWxFeGVjdXRlZEJhc2UsIHVpbnQgb3JpZ2luYWxFeGVjdXRlZENudHIpIGludGVybmFsIHsKICAgIE9yZGVyIHN0b3JhZ2Ugb3JkZXIgPSBvcmRlckZvck9yZGVySWRbb3JkZXJJZF07CiAgICB1aW50IGxpcXVpZGl0eVRha2VuQmFzZSA9IG9yZGVyLmV4ZWN1dGVkQmFzZSAtIG9yaWdpbmFsRXhlY3V0ZWRCYXNlOwogICAgdWludCBsaXF1aWRpdHlUYWtlbkNudHIgPSBvcmRlci5leGVjdXRlZENudHIgLSBvcmlnaW5hbEV4ZWN1dGVkQ250cjsKICAgIC8vIE5vcm1hbGx5IHdlIGRlZHVjdCB0aGUgZmVlIGZyb20gdGhlIGN1cnJlbmN5IGJvdWdodCAoYmFzZSBmb3IgYnV5LCBjbnRyIGZvciBzZWxsKSwKICAgIC8vIGhvd2V2ZXIgd2UgYWxzbyBhY2NlcHQgcmV3YXJkIHRva2VucyBmcm9tIHRoZSByZXdhcmQgYmFsYW5jZSBpZiBpdCBjb3ZlcnMgdGhlIGZlZSwKICAgIC8vIHdpdGggdGhlIHJld2FyZCBhbW91bnQgY29udmVydGVkIGZyb20gdGhlIEVUSCBhbW91bnQgKHRoZSBjb3VudGVyIGN1cnJlbmN5IGhlcmUpCiAgICAvLyBhdCBhIGZpeGVkIGV4Y2hhbmdlIHJhdGUuCiAgICAvLyBPdmVyZmxvdyBzYWZlIHNpbmNlIHdlIGVuc3VyZSBvcmRlciBzaXplIDwgMTBeMzAgaW4gYm90aCBjdXJyZW5jaWVzIChzZWUgYmFzZU1heFNpemUpLgogICAgLy8gQ2FuIHRydW5jYXRlIHRvIHplcm8sIHdoaWNoIGlzIGZpbmUuCiAgICB1aW50IGZlZXNSd3JkID0gbGlxdWlkaXR5VGFrZW5DbnRyIC8gZmVlRGl2aXNvciAqIGV0aFJ3cmRSYXRlOwogICAgdWludCBmZWVzQmFzZU9yQ250cjsKICAgIGFkZHJlc3MgY2xpZW50ID0gb3JkZXIuY2xpZW50OwogICAgdWludCBhdmFpbFJ3cmQgPSBiYWxhbmNlUndyZEZvckNsaWVudFtjbGllbnRdOwogICAgaWYgKGZlZXNSd3JkIDw9IGF2YWlsUndyZCkgewogICAgICBiYWxhbmNlUndyZEZvckNsaWVudFtjbGllbnRdID0gYXZhaWxSd3JkIC0gZmVlc1J3cmQ7CiAgICAgIGJhbGFuY2VSd3JkRm9yQ2xpZW50W2ZlZUNvbGxlY3Rvcl0gPSBmZWVzUndyZDsKICAgICAgLy8gTmVlZCArPSByYXRoZXIgdGhhbiA9IGJlY2F1c2UgY291bGQgaGF2ZSBwYWlkIHNvbWUgZmVlcyBlYXJsaWVyIGluIE5lZWRzR2FzIHNpdHVhdGlvbi4KICAgICAgLy8gT3ZlcmZsb3cgc2FmZSBzaW5jZSB3ZSBlbnN1cmUgb3JkZXIgc2l6ZSA8IDEwXjMwIGluIGJvdGggY3VycmVuY2llcyAoc2VlIGJhc2VNYXhTaXplKS4KICAgICAgLy8gQ2FuIHRydW5jYXRlIHRvIHplcm8sIHdoaWNoIGlzIGZpbmUuCiAgICAgIG9yZGVyLmZlZXNSd3JkICs9IHVpbnQxMjgoZmVlc1J3cmQpOwogICAgICBpZiAoaXNCdXlQcmljZShvcmRlci5wcmljZSkpIHsKICAgICAgICBiYWxhbmNlQmFzZUZvckNsaWVudFtjbGllbnRdICs9IGxpcXVpZGl0eVRha2VuQmFzZTsKICAgICAgfSBlbHNlIHsKICAgICAgICBiYWxhbmNlQ250ckZvckNsaWVudFtjbGllbnRdICs9IGxpcXVpZGl0eVRha2VuQ250cjsKICAgICAgfQogICAgfSBlbHNlIGlmIChpc0J1eVByaWNlKG9yZGVyLnByaWNlKSkgewogICAgICAvLyBTZWUgY29tbWVudHMgaW4gYnJhbmNoIGFib3ZlIHJlOiB1c2Ugb2YgKz0gYW5kIG92ZXJmbG93IHNhZmV0eS4KICAgICAgZmVlc0Jhc2VPckNudHIgPSBsaXF1aWRpdHlUYWtlbkJhc2UgLyBmZWVEaXZpc29yOwogICAgICBiYWxhbmNlQmFzZUZvckNsaWVudFtvcmRlci5jbGllbnRdICs9IChsaXF1aWRpdHlUYWtlbkJhc2UgLSBmZWVzQmFzZU9yQ250cik7CiAgICAgIG9yZGVyLmZlZXNCYXNlT3JDbnRyICs9IHVpbnQxMjgoZmVlc0Jhc2VPckNudHIpOwogICAgICBiYWxhbmNlQmFzZUZvckNsaWVudFtmZWVDb2xsZWN0b3JdICs9IGZlZXNCYXNlT3JDbnRyOwogICAgfSBlbHNlIHsKICAgICAgLy8gU2VlIGNvbW1lbnRzIGluIGJyYW5jaCBhYm92ZSByZTogdXNlIG9mICs9IGFuZCBvdmVyZmxvdyBzYWZldHkuCiAgICAgIGZlZXNCYXNlT3JDbnRyID0gbGlxdWlkaXR5VGFrZW5DbnRyIC8gZmVlRGl2aXNvcjsKICAgICAgYmFsYW5jZUNudHJGb3JDbGllbnRbb3JkZXIuY2xpZW50XSArPSAobGlxdWlkaXR5VGFrZW5DbnRyIC0gZmVlc0Jhc2VPckNudHIpOwogICAgICBvcmRlci5mZWVzQmFzZU9yQ250ciArPSB1aW50MTI4KGZlZXNCYXNlT3JDbnRyKTsKICAgICAgYmFsYW5jZUNudHJGb3JDbGllbnRbZmVlQ29sbGVjdG9yXSArPSBmZWVzQmFzZU9yQ250cjsKICAgIH0KICB9CgogIC8vIEludGVybmFsIE9yZGVyIFBsYWNlbWVudCAtIHByb2Nlc3MgYSBjcmVhdGVkIGFuZCBzYW5pdHkgY2hlY2tlZCBvcmRlci4KICAvLwogIC8vIFVzZWQgYm90aCBmb3IgbmV3IG9yZGVycyBhbmQgZm9yIGdhcyB0b3B1cC4KICAvLwogIGZ1bmN0aW9uIHByb2Nlc3NPcmRlcih1aW50MTI4IG9yZGVySWQsIHVpbnQgbWF4TWF0Y2hlcykgaW50ZXJuYWwgewogICAgT3JkZXIgc3RvcmFnZSBvcmRlciA9IG9yZGVyRm9yT3JkZXJJZFtvcmRlcklkXTsKCiAgICB1aW50IG91ck9yaWdpbmFsRXhlY3V0ZWRCYXNlID0gb3JkZXIuZXhlY3V0ZWRCYXNlOwogICAgdWludCBvdXJPcmlnaW5hbEV4ZWN1dGVkQ250ciA9IG9yZGVyLmV4ZWN1dGVkQ250cjsKCiAgICB2YXIgKG91ckRpcmVjdGlvbiwpID0gdW5wYWNrUHJpY2Uob3JkZXIucHJpY2UpOwogICAgdWludCB0aGVpclByaWNlU3RhcnQgPSAob3VyRGlyZWN0aW9uID09IERpcmVjdGlvbi5CdXkpID8gbWluU2VsbFByaWNlIDogbWF4QnV5UHJpY2U7CiAgICB1aW50IHRoZWlyUHJpY2VFbmQgPSBjb21wdXRlT3Bwb3NpdGVQcmljZShvcmRlci5wcmljZSk7CiAgIAogICAgTWF0Y2hTdG9wUmVhc29uIG1hdGNoU3RvcFJlYXNvbiA9CiAgICAgIG1hdGNoQWdhaW5zdEJvb2sob3JkZXJJZCwgdGhlaXJQcmljZVN0YXJ0LCB0aGVpclByaWNlRW5kLCBtYXhNYXRjaGVzKTsKCiAgICBjcmVkaXRFeGVjdXRlZEZ1bmRzTGVzc0ZlZXMob3JkZXJJZCwgb3VyT3JpZ2luYWxFeGVjdXRlZEJhc2UsIG91ck9yaWdpbmFsRXhlY3V0ZWRDbnRyKTsKCiAgICBpZiAob3JkZXIudGVybXMgPT0gVGVybXMuSW1tZWRpYXRlT3JDYW5jZWwpIHsKICAgICAgaWYgKG1hdGNoU3RvcFJlYXNvbiA9PSBNYXRjaFN0b3BSZWFzb24uU2F0aXNmaWVkKSB7CiAgICAgICAgcmVmdW5kVW5tYXRjaGVkQW5kRmluaXNoKG9yZGVySWQsIFN0YXR1cy5Eb25lLCBSZWFzb25Db2RlLk5vbmUpOwogICAgICAgIHJldHVybjsKICAgICAgfSBlbHNlIGlmIChtYXRjaFN0b3BSZWFzb24gPT0gTWF0Y2hTdG9wUmVhc29uLk1heE1hdGNoZXMpIHsKICAgICAgICByZWZ1bmRVbm1hdGNoZWRBbmRGaW5pc2gob3JkZXJJZCwgU3RhdHVzLkRvbmUsIFJlYXNvbkNvZGUuVG9vTWFueU1hdGNoZXMpOwogICAgICAgIHJldHVybjsKICAgICAgfSBlbHNlIGlmIChtYXRjaFN0b3BSZWFzb24gPT0gTWF0Y2hTdG9wUmVhc29uLkJvb2tFeGhhdXN0ZWQpIHsKICAgICAgICByZWZ1bmRVbm1hdGNoZWRBbmRGaW5pc2gob3JkZXJJZCwgU3RhdHVzLkRvbmUsIFJlYXNvbkNvZGUuVW5tYXRjaGVkKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgIH0gZWxzZSBpZiAob3JkZXIudGVybXMgPT0gVGVybXMuTWFrZXJPbmx5KSB7CiAgICAgIGlmIChtYXRjaFN0b3BSZWFzb24gPT0gTWF0Y2hTdG9wUmVhc29uLk1heE1hdGNoZXMpIHsKICAgICAgICByZWZ1bmRVbm1hdGNoZWRBbmRGaW5pc2gob3JkZXJJZCwgU3RhdHVzLlJlamVjdGVkLCBSZWFzb25Db2RlLldvdWxkVGFrZSk7CiAgICAgICAgcmV0dXJuOwogICAgICB9IGVsc2UgaWYgKG1hdGNoU3RvcFJlYXNvbiA9PSBNYXRjaFN0b3BSZWFzb24uQm9va0V4aGF1c3RlZCkgewogICAgICAgIGVudGVyT3JkZXIob3JkZXJJZCk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICB9IGVsc2UgaWYgKG9yZGVyLnRlcm1zID09IFRlcm1zLkdUQ05vR2FzVG9wdXApIHsKICAgICAgaWYgKG1hdGNoU3RvcFJlYXNvbiA9PSBNYXRjaFN0b3BSZWFzb24uU2F0aXNmaWVkKSB7CiAgICAgICAgcmVmdW5kVW5tYXRjaGVkQW5kRmluaXNoKG9yZGVySWQsIFN0YXR1cy5Eb25lLCBSZWFzb25Db2RlLk5vbmUpOwogICAgICAgIHJldHVybjsKICAgICAgfSBlbHNlIGlmIChtYXRjaFN0b3BSZWFzb24gPT0gTWF0Y2hTdG9wUmVhc29uLk1heE1hdGNoZXMpIHsKICAgICAgICByZWZ1bmRVbm1hdGNoZWRBbmRGaW5pc2gob3JkZXJJZCwgU3RhdHVzLkRvbmUsIFJlYXNvbkNvZGUuVG9vTWFueU1hdGNoZXMpOwogICAgICAgIHJldHVybjsKICAgICAgfSBlbHNlIGlmIChtYXRjaFN0b3BSZWFzb24gPT0gTWF0Y2hTdG9wUmVhc29uLkJvb2tFeGhhdXN0ZWQpIHsKICAgICAgICBlbnRlck9yZGVyKG9yZGVySWQpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgfSBlbHNlIGlmIChvcmRlci50ZXJtcyA9PSBUZXJtcy5HVENXaXRoR2FzVG9wdXApIHsKICAgICAgaWYgKG1hdGNoU3RvcFJlYXNvbiA9PSBNYXRjaFN0b3BSZWFzb24uU2F0aXNmaWVkKSB7CiAgICAgICAgcmVmdW5kVW5tYXRjaGVkQW5kRmluaXNoKG9yZGVySWQsIFN0YXR1cy5Eb25lLCBSZWFzb25Db2RlLk5vbmUpOwogICAgICAgIHJldHVybjsKICAgICAgfSBlbHNlIGlmIChtYXRjaFN0b3BSZWFzb24gPT0gTWF0Y2hTdG9wUmVhc29uLk1heE1hdGNoZXMpIHsKICAgICAgICBvcmRlci5zdGF0dXMgPSBTdGF0dXMuTmVlZHNHYXM7CiAgICAgICAgcmV0dXJuOwogICAgICB9IGVsc2UgaWYgKG1hdGNoU3RvcFJlYXNvbiA9PSBNYXRjaFN0b3BSZWFzb24uQm9va0V4aGF1c3RlZCkgewogICAgICAgIGVudGVyT3JkZXIob3JkZXJJZCk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICB9CiAgICBhc3NlcnQoZmFsc2UpOyAvLyBzaG91bGQgbm90IGJlIHBvc3NpYmxlIHRvIHJlYWNoIGhlcmUKICB9CiAKICAvLyBVc2VkIGludGVybmFsbHkgdG8gaW5kaWNhdGUgd2h5IHdlIHN0b3BwZWQgbWF0Y2hpbmcgYW4gb3JkZXIgYWdhaW5zdCB0aGUgYm9vay4KCiAgZW51bSBNYXRjaFN0b3BSZWFzb24gewogICAgTm9uZSwKICAgIE1heE1hdGNoZXMsCiAgICBTYXRpc2ZpZWQsCiAgICBQcmljZUV4aGF1c3RlZCwKICAgIEJvb2tFeGhhdXN0ZWQKICB9CiAKICAvLyBJbnRlcm5hbCBPcmRlciBQbGFjZW1lbnQgLSBNYXRjaCB0aGUgZ2l2ZW4gb3JkZXIgYWdhaW5zdCB0aGUgYm9vay4KICAvLwogIC8vIFJlc3Rpbmcgb3JkZXJzIG1hdGNoZWQgd2lsbCBiZSB1cGRhdGVkLCByZW1vdmVkIGZyb20gYm9vayBhbmQgZnVuZHMgY3JlZGl0ZWQgdG8gdGhlaXIgb3duZXJzLgogIC8vCiAgLy8gT25seSB1cGRhdGVzIHRoZSBleGVjdXRlZEJhc2UgYW5kIGV4ZWN1dGVkQ250ciBvZiB0aGUgZ2l2ZW4gb3JkZXIgLSBjYWxsZXIgaXMgcmVzcG9uc2libGUKICAvLyBmb3IgY3JlZGl0aW5nIG1hdGNoZWQgZnVuZHMsIGNoYXJnaW5nIGZlZXMsIG1hcmtpbmcgb3JkZXIgYXMgZG9uZSAvIGVudGVyaW5nIGl0IGludG8gdGhlIGJvb2suCiAgLy8KICAvLyBtYXRjaFN0b3BSZWFzb24gcmV0dXJuZWQgd2lsbCBiZSBvbmUgb2YgTWF4TWF0Y2hlcywgU2F0aXNmaWVkIG9yIEJvb2tFeGhhdXN0ZWQuCiAgLy8KICBmdW5jdGlvbiBtYXRjaEFnYWluc3RCb29rKAogICAgICB1aW50MTI4IG9yZGVySWQsIHVpbnQgdGhlaXJQcmljZVN0YXJ0LCB1aW50IHRoZWlyUHJpY2VFbmQsIHVpbnQgbWF4TWF0Y2hlcwogICAgKSBpbnRlcm5hbCByZXR1cm5zICgKICAgICAgTWF0Y2hTdG9wUmVhc29uIG1hdGNoU3RvcFJlYXNvbgogICAgKSB7CiAgICBPcmRlciBzdG9yYWdlIG9yZGVyID0gb3JkZXJGb3JPcmRlcklkW29yZGVySWRdOwogICAgCiAgICB1aW50IGJtaSA9IHRoZWlyUHJpY2VTdGFydCAvIDI1NjsgIC8vIGluZGV4IGludG8gYXJyYXkgb2YgYml0bWFwcwogICAgdWludCBidGkgPSB0aGVpclByaWNlU3RhcnQgJSAyNTY7ICAvLyBiaXQgcG9zaXRpb24gd2l0aGluIGJpdG1hcAogICAgdWludCBibWlFbmQgPSB0aGVpclByaWNlRW5kIC8gMjU2OyAvLyBsYXN0IGJpdG1hcCB0byBzZWFyY2gKICAgIHVpbnQgYnRpRW5kID0gdGhlaXJQcmljZUVuZCAlIDI1NjsgLy8gc3RvcCBhdCB0aGlzIGJpdCBpbiB0aGUgbGFzdCBiaXRtYXAKCiAgICB1aW50IGNibSA9IG9jY3VwaWVkUHJpY2VCaXRtYXBzW2JtaV07IC8vIG9yaWdpbmFsIGNvcHkgb2YgY3VycmVudCBiaXRtYXAKICAgIHVpbnQgZGJtID0gY2JtOyAvLyBkaXJ0eSB2ZXJzaW9uIG9mIGN1cnJlbnQgYml0bWFwIHdoZXJlIHdlIG1heSBoYXZlIGNsZWFyZWQgYml0cwogICAgdWludCB3Ym0gPSBjYm0gPj4gYnRpOyAvLyB3b3JraW5nIGNvcHkgb2YgY3VycmVudCBiaXRtYXAgd2hpY2ggd2Uga2VlcCBzaGlmdGluZwogICAgCiAgICAvLyB0aGVzZSBsb29wcyBhcmUgcHJldHR5IHVnbHksIGFuZCBzb21ld2hhdCB1bnByZWRpY2F0YWJsZSBpbiB0ZXJtcyBvZiBnYXMsCiAgICAvLyAuLi4gYnV0IG5vLW9uZSBlbHNlIGhhcyBjb21lIHVwIHdpdGggYSBiZXR0ZXIgbWF0Y2hpbmcgZW5naW5lIHlldCEKCiAgICBib29sIHJlbW92ZWRMYXN0QXRQcmljZTsKICAgIG1hdGNoU3RvcFJlYXNvbiA9IE1hdGNoU3RvcFJlYXNvbi5Ob25lOwoKICAgIHdoaWxlIChibWkgPCBibWlFbmQpIHsKICAgICAgaWYgKHdibSA9PSAwIHx8IGJ0aSA9PSAyNTYpIHsKICAgICAgICBpZiAoZGJtICE9IGNibSkgewogICAgICAgICAgb2NjdXBpZWRQcmljZUJpdG1hcHNbYm1pXSA9IGRibTsKICAgICAgICB9CiAgICAgICAgYnRpID0gMDsKICAgICAgICBibWkrKzsKICAgICAgICBjYm0gPSBvY2N1cGllZFByaWNlQml0bWFwc1tibWldOwogICAgICAgIHdibSA9IGNibTsKICAgICAgICBkYm0gPSBjYm07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKCh3Ym0gJiAxKSAhPSAwKSB7CiAgICAgICAgICAvLyBjYXJlZnVsIC0gY29weS1hbmQtcGFzdGVkIGluIGxvb3AgYmVsb3cgLi4uCiAgICAgICAgICAocmVtb3ZlZExhc3RBdFByaWNlLCBtYXhNYXRjaGVzLCBtYXRjaFN0b3BSZWFzb24pID0KICAgICAgICAgICAgbWF0Y2hXaXRoT2NjdXBpZWRQcmljZShvcmRlciwgdWludDE2KGJtaSAqIDI1NiArIGJ0aSksIG1heE1hdGNoZXMpOwogICAgICAgICAgaWYgKHJlbW92ZWRMYXN0QXRQcmljZSkgewogICAgICAgICAgICBkYm0gXj0gMiAqKiBidGk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobWF0Y2hTdG9wUmVhc29uID09IE1hdGNoU3RvcFJlYXNvbi5QcmljZUV4aGF1c3RlZCkgewogICAgICAgICAgICBtYXRjaFN0b3BSZWFzb24gPSBNYXRjaFN0b3BSZWFzb24uTm9uZTsKICAgICAgICAgIH0gZWxzZSBpZiAobWF0Y2hTdG9wUmVhc29uICE9IE1hdGNoU3RvcFJlYXNvbi5Ob25lKSB7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBidGkgKz0gMTsKICAgICAgICB3Ym0gLz0gMjsKICAgICAgfQogICAgfQogICAgaWYgKG1hdGNoU3RvcFJlYXNvbiA9PSBNYXRjaFN0b3BSZWFzb24uTm9uZSkgewogICAgICAvLyB3ZSd2ZSByZWFjaGVkIHRoZSBsYXN0IGJpdG1hcCB3ZSBuZWVkIHRvIHNlYXJjaCwKICAgICAgLy8gd2UnbGwgc3RvcCBhdCBidGlFbmQgbm90IDI1NiB0aGlzIHRpbWUuCiAgICAgIHdoaWxlIChidGkgPD0gYnRpRW5kICYmIHdibSAhPSAwKSB7CiAgICAgICAgaWYgKCh3Ym0gJiAxKSAhPSAwKSB7CiAgICAgICAgICAvLyBjYXJlZnVsIC0gY29weS1hbmQtcGFzdGVkIGluIGxvb3AgYWJvdmUgLi4uCiAgICAgICAgICAocmVtb3ZlZExhc3RBdFByaWNlLCBtYXhNYXRjaGVzLCBtYXRjaFN0b3BSZWFzb24pID0KICAgICAgICAgICAgbWF0Y2hXaXRoT2NjdXBpZWRQcmljZShvcmRlciwgdWludDE2KGJtaSAqIDI1NiArIGJ0aSksIG1heE1hdGNoZXMpOwogICAgICAgICAgaWYgKHJlbW92ZWRMYXN0QXRQcmljZSkgewogICAgICAgICAgICBkYm0gXj0gMiAqKiBidGk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobWF0Y2hTdG9wUmVhc29uID09IE1hdGNoU3RvcFJlYXNvbi5QcmljZUV4aGF1c3RlZCkgewogICAgICAgICAgICBtYXRjaFN0b3BSZWFzb24gPSBNYXRjaFN0b3BSZWFzb24uTm9uZTsKICAgICAgICAgIH0gZWxzZSBpZiAobWF0Y2hTdG9wUmVhc29uICE9IE1hdGNoU3RvcFJlYXNvbi5Ob25lKSB7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBidGkgKz0gMTsKICAgICAgICB3Ym0gLz0gMjsKICAgICAgfQogICAgfQogICAgLy8gQ2FyZWZ1bCAtIGlmIHdlIGV4aXRlZCB0aGUgZmlyc3QgbG9vcCBlYXJseSwgb3Igd2Ugd2VudCBpbnRvIHRoZSBzZWNvbmQgbG9vcCwKICAgIC8vIChsdWNraWx5IGNhbid0IGJvdGggaGFwcGVuKSB0aGVuIHdlIGhhdmVuJ3QgZmx1c2hlZCB0aGUgZGlydHkgYml0bWFwIGJhY2sgdG8KICAgIC8vIHN0b3JhZ2UgLSBkbyB0aGF0IG5vdyBpZiB3ZSBuZWVkIHRvLgogICAgaWYgKGRibSAhPSBjYm0pIHsKICAgICAgb2NjdXBpZWRQcmljZUJpdG1hcHNbYm1pXSA9IGRibTsKICAgIH0KICAgIGlmIChtYXRjaFN0b3BSZWFzb24gPT0gTWF0Y2hTdG9wUmVhc29uLk5vbmUpIHsKICAgICAgbWF0Y2hTdG9wUmVhc29uID0gTWF0Y2hTdG9wUmVhc29uLkJvb2tFeGhhdXN0ZWQ7CiAgICB9CiAgfQoKICAvLyBJbnRlcm5hbCBPcmRlciBQbGFjZW1lbnQuCiAgLy8KICAvLyBNYXRjaCBvdXIgb3JkZXIgYWdhaW5zdCB1cCB0byBtYXhNYXRjaGVzIHJlc3Rpbmcgb3JkZXJzIGF0IHRoZSBnaXZlbiBwcmljZSAod2hpY2gKICAvLyBpcyBrbm93biBieSB0aGUgY2FsbGVyIHRvIGhhdmUgYXQgbGVhc3Qgb25lIHJlc3Rpbmcgb3JkZXIpLgogIC8vCiAgLy8gVGhlIG1hdGNoZXMgKHBhcnRpYWwgb3IgY29tcGxldGUpIG9mIHRoZSByZXN0aW5nIG9yZGVycyBhcmUgcmVjb3JkZWQsIGFuZCB0aGVpcgogIC8vIGZ1bmRzIGFyZSBjcmVkaXRlZC4KICAvLwogIC8vIFRoZSBvcmRlciBjaGFpbiBmb3IgdGhlIHJlc3Rpbmcgb3JkZXJzIGlzIHVwZGF0ZWQsIGJ1dCB0aGUgb2NjdXBpZWQgcHJpY2UgYml0bWFwIGlzIE5PVCAtCiAgLy8gdGhlIGNhbGxlciBtdXN0IGNsZWFyIHRoZSByZWxldmFudCBiaXQgaWYgcmVtb3ZlZExhc3RBdFByaWNlID0gdHJ1ZSBpcyByZXR1cm5lZC4KICAvLwogIC8vIE9ubHkgdXBkYXRlcyB0aGUgZXhlY3V0ZWRCYXNlIGFuZCBleGVjdXRlZENudHIgb2Ygb3VyIG9yZGVyIC0gY2FsbGVyIGlzIHJlc3BvbnNpYmxlCiAgLy8gZm9yIGUuZy4gY3JlZGl0aW5nIG91ciBtYXRjaGVkIGZ1bmRzLCB1cGRhdGluZyBzdGF0dXMuCiAgLy8KICAvLyBDYWxsaW5nIHdpdGggbWF4TWF0Y2hlcyA9PSAwIGlzIG9rIC0gYW5kIGV4cGVjdGVkIHdoZW4gdGhlIG9yZGVyIGlzIGEgbWFrZXItb25seSBvcmRlci4KICAvLwogIC8vIFJldHVybnM6CiAgLy8gICByZW1vdmVkTGFzdEF0UHJpY2U6CiAgLy8gICAgIHRydWUgaWZmIHRoZXJlIGFyZSBubyBsb25nZXIgYW55IHJlc3Rpbmcgb3JkZXJzIGF0IHRoaXMgcHJpY2UgLSBjYWxsZXIgd2lsbCBuZWVkCiAgLy8gICAgIHRvIHVwZGF0ZSB0aGUgb2NjdXBpZWQgcHJpY2UgYml0bWFwLgogIC8vCiAgLy8gICBtYXRjaGVzTGVmdDoKICAvLyAgICAgbWF4TWF0Y2hlcyBwYXNzZWQgaW4gbWludXMgdGhlIG51bWJlciBvZiBtYXRjaGVzIG1hZGUgYnkgdGhpcyBjYWxsCiAgLy8KICAvLyAgIG1hdGNoU3RvcFJlYXNvbjoKICAvLyAgICAgSWYgb3VyIG9yZGVyIGlzIGNvbXBsZXRlbHkgbWF0Y2hlZCwgbWF0Y2hTdG9wUmVhc29uIHdpbGwgYmUgU2F0aXNmaWVkLgogIC8vICAgICBJZiBvdXIgb3JkZXIgaXMgbm90IGNvbXBsZXRlbHkgbWF0Y2hlZCwgbWF0Y2hTdG9wUmVhc29uIHdpbGwgYmUgZWl0aGVyOgogIC8vICAgICAgICBNYXhNYXRjaGVzICh3ZSBhcmUgbm90IGFsbG93ZWQgdG8gbWF0Y2ggYW55IG1vcmUgdGltZXMpCiAgLy8gICAgIG9yOgogIC8vICAgICAgICBQcmljZUV4aGF1c3RlZCAobm90aGluZyBsZWZ0IG9uIHRoZSBib29rIGF0IHRoaXMgZXhhY3QgcHJpY2UpCiAgLy8KICBmdW5jdGlvbiBtYXRjaFdpdGhPY2N1cGllZFByaWNlKAogICAgICBPcmRlciBzdG9yYWdlIG91ck9yZGVyLCB1aW50MTYgdGhlaXJQcmljZSwgdWludCBtYXhNYXRjaGVzCiAgICApIGludGVybmFsIHJldHVybnMgKAogICAgYm9vbCByZW1vdmVkTGFzdEF0UHJpY2UsIHVpbnQgbWF0Y2hlc0xlZnQsIE1hdGNoU3RvcFJlYXNvbiBtYXRjaFN0b3BSZWFzb24pIHsKICAgIG1hdGNoZXNMZWZ0ID0gbWF4TWF0Y2hlczsKICAgIHVpbnQgd29ya2luZ091ckV4ZWN1dGVkQmFzZSA9IG91ck9yZGVyLmV4ZWN1dGVkQmFzZTsKICAgIHVpbnQgd29ya2luZ091ckV4ZWN1dGVkQ250ciA9IG91ck9yZGVyLmV4ZWN1dGVkQ250cjsKICAgIHVpbnQxMjggdGhlaXJPcmRlcklkID0gb3JkZXJDaGFpbkZvck9jY3VwaWVkUHJpY2VbdGhlaXJQcmljZV0uZmlyc3RPcmRlcklkOwogICAgbWF0Y2hTdG9wUmVhc29uID0gTWF0Y2hTdG9wUmVhc29uLk5vbmU7CiAgICB3aGlsZSAodHJ1ZSkgewogICAgICBpZiAobWF0Y2hlc0xlZnQgPT0gMCkgewogICAgICAgIG1hdGNoU3RvcFJlYXNvbiA9IE1hdGNoU3RvcFJlYXNvbi5NYXhNYXRjaGVzOwogICAgICAgIGJyZWFrOwogICAgICB9CiAgICAgIHVpbnQgbWF0Y2hCYXNlOwogICAgICB1aW50IG1hdGNoQ250cjsKICAgICAgKHRoZWlyT3JkZXJJZCwgbWF0Y2hCYXNlLCBtYXRjaENudHIsIG1hdGNoU3RvcFJlYXNvbikgPQogICAgICAgIG1hdGNoV2l0aFRoZWlycygob3VyT3JkZXIuc2l6ZUJhc2UgLSB3b3JraW5nT3VyRXhlY3V0ZWRCYXNlKSwgdGhlaXJPcmRlcklkLCB0aGVpclByaWNlKTsKICAgICAgd29ya2luZ091ckV4ZWN1dGVkQmFzZSArPSBtYXRjaEJhc2U7CiAgICAgIHdvcmtpbmdPdXJFeGVjdXRlZENudHIgKz0gbWF0Y2hDbnRyOwogICAgICBtYXRjaGVzTGVmdCAtPSAxOwogICAgICBpZiAobWF0Y2hTdG9wUmVhc29uICE9IE1hdGNoU3RvcFJlYXNvbi5Ob25lKSB7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0KICAgIG91ck9yZGVyLmV4ZWN1dGVkQmFzZSA9IHVpbnQxMjgod29ya2luZ091ckV4ZWN1dGVkQmFzZSk7CiAgICBvdXJPcmRlci5leGVjdXRlZENudHIgPSB1aW50MTI4KHdvcmtpbmdPdXJFeGVjdXRlZENudHIpOwogICAgaWYgKHRoZWlyT3JkZXJJZCA9PSAwKSB7CiAgICAgIG9yZGVyQ2hhaW5Gb3JPY2N1cGllZFByaWNlW3RoZWlyUHJpY2VdLmZpcnN0T3JkZXJJZCA9IDA7CiAgICAgIG9yZGVyQ2hhaW5Gb3JPY2N1cGllZFByaWNlW3RoZWlyUHJpY2VdLmxhc3RPcmRlcklkID0gMDsKICAgICAgcmVtb3ZlZExhc3RBdFByaWNlID0gdHJ1ZTsKICAgIH0gZWxzZSB7CiAgICAgIC8vIE5COiBpbiBzb21lIGNhc2VzIChlLmcuIG1heE1hdGNoZXMgPT0gMCkgdGhpcyBpcyBhIG5vLW9wLgogICAgICBvcmRlckNoYWluRm9yT2NjdXBpZWRQcmljZVt0aGVpclByaWNlXS5maXJzdE9yZGVySWQgPSB0aGVpck9yZGVySWQ7CiAgICAgIG9yZGVyQ2hhaW5Ob2RlRm9yT3Blbk9yZGVySWRbdGhlaXJPcmRlcklkXS5wcmV2T3JkZXJJZCA9IDA7CiAgICAgIHJlbW92ZWRMYXN0QXRQcmljZSA9IGZhbHNlOwogICAgfQogIH0KICAKICAvLyBJbnRlcm5hbCBPcmRlciBQbGFjZW1lbnQuCiAgLy8KICAvLyBNYXRjaCB1cCB0byBvdXIgcmVtYWluaW5nIGFtb3VudCBhZ2FpbnN0IGEgcmVzdGluZyBvcmRlciBpbiB0aGUgYm9vay4KICAvLwogIC8vIFRoZSBtYXRjaCAocGFydGlhbCwgY29tcGxldGUgb3IgZWZmZWN0aXZlbHktY29tcGxldGUpIG9mIHRoZSByZXN0aW5nIG9yZGVyCiAgLy8gaXMgcmVjb3JkZWQsIGFuZCB0aGVpciBmdW5kcyBhcmUgY3JlZGl0ZWQuCiAgLy8KICAvLyBUaGVpciBvcmRlciBpcyBOT1QgcmVtb3ZlZCBmcm9tIHRoZSBib29rIGJ5IHRoaXMgY2FsbCAtIHRoZSBjYWxsZXIgbXVzdCBkbyB0aGF0CiAgLy8gaWYgdGhlIG5leHRUaGVpck9yZGVySWQgcmV0dXJuZWQgaXMgbm90IGVxdWFsIHRvIHRoZSB0aGVpck9yZGVySWQgcGFzc2VkIGluLgogIC8vCiAgLy8gUmV0dXJuczoKICAvLwogIC8vICAgbmV4dFRoZWlyT3JkZXJJZDoKICAvLyAgICAgSWYgd2UgZGlkIG5vdCBjb21wbGV0ZWx5IG1hdGNoIHRoZWlyIG9yZGVyLCB3aWxsIGJlIHNhbWUgYXMgdGhlaXJPcmRlcklkLgogIC8vICAgICBJZiB3ZSBjb21wbGV0ZWx5IG1hdGNoZWQgdGhlaXIgb3JkZXIsIHdpbGwgYmUgb3JkZXJJZCBvZiBuZXh0IG9yZGVyIGF0IHRoZQogIC8vICAgICBzYW1lIHByaWNlIC0gb3IgemVybyBpZiB0aGlzIHdhcyB0aGUgbGFzdCBvcmRlciBhbmQgd2UndmUgbm93IGZpbGxlZCBpdC4KICAvLwogIC8vICAgbWF0Y2hTdG9wUmVhc29uOgogIC8vICAgICBJZiBvdXIgb3JkZXIgaXMgY29tcGxldGVseSBtYXRjaGVkLCBtYXRjaFN0b3BSZWFzb24gd2lsbCBiZSBTYXRpc2ZpZWQuCiAgLy8gICAgIElmIG91ciBvcmRlciBpcyBub3QgY29tcGxldGVseSBtYXRjaGVkLCBtYXRjaFN0b3BSZWFzb24gd2lsbCBiZSBlaXRoZXIKICAvLyAgICAgUHJpY2VFeGhhdXN0ZWQgKGlmIG5vdGhpbmcgbGVmdCBhdCB0aGlzIGV4YWN0IHByaWNlKSBvciBOb25lIChpZiBjYW4gY29udGludWUpLgogIC8vIAogIGZ1bmN0aW9uIG1hdGNoV2l0aFRoZWlycygKICAgIHVpbnQgb3VyUmVtYWluaW5nQmFzZSwgdWludDEyOCB0aGVpck9yZGVySWQsIHVpbnQxNiB0aGVpclByaWNlKSBpbnRlcm5hbCByZXR1cm5zICgKICAgIHVpbnQxMjggbmV4dFRoZWlyT3JkZXJJZCwgdWludCBtYXRjaEJhc2UsIHVpbnQgbWF0Y2hDbnRyLCBNYXRjaFN0b3BSZWFzb24gbWF0Y2hTdG9wUmVhc29uKSB7CiAgICBPcmRlciBzdG9yYWdlIHRoZWlyT3JkZXIgPSBvcmRlckZvck9yZGVySWRbdGhlaXJPcmRlcklkXTsKICAgIHVpbnQgdGhlaXJSZW1haW5pbmdCYXNlID0gdGhlaXJPcmRlci5zaXplQmFzZSAtIHRoZWlyT3JkZXIuZXhlY3V0ZWRCYXNlOwogICAgaWYgKG91clJlbWFpbmluZ0Jhc2UgPCB0aGVpclJlbWFpbmluZ0Jhc2UpIHsKICAgICAgbWF0Y2hCYXNlID0gb3VyUmVtYWluaW5nQmFzZTsKICAgIH0gZWxzZSB7CiAgICAgIG1hdGNoQmFzZSA9IHRoZWlyUmVtYWluaW5nQmFzZTsKICAgIH0KICAgIG1hdGNoQ250ciA9IGNvbXB1dGVDbnRyQW1vdW50VXNpbmdQYWNrZWQobWF0Y2hCYXNlLCB0aGVpclByaWNlKTsKICAgIC8vIEl0IG1heSBzZWVtIGEgYml0IG9kZCB0byBzdG9wIGhlcmUgaWYgb3VyIHJlbWFpbmluZyBhbW91bnQgaXMgdmVyeSBzbWFsbCAtCiAgICAvLyB0aGVyZSBjb3VsZCBzdGlsbCBiZSByZXN0aW5nIG9yZGVycyB3ZSBjYW4gbWF0Y2ggaXQgYWdhaW5zdC4gQnV0IHRoZSBnYXMKICAgIC8vIGNvc3Qgb2YgbWF0Y2hpbmcgZWFjaCBvcmRlciBpcyBxdWl0ZSBoaWdoIC0gcG90ZW50aWFsbHkgaGlnaCBlbm91Z2ggdG8KICAgIC8vIHdpcGUgb3V0IHRoZSBwcm9maXQgdGhlIHRha2VyIGhvcGVzIGZvciBmcm9tIHRyYWRpbmcgdGhlIHRpbnkgYW1vdW50IGxlZnQuCiAgICBpZiAoKG91clJlbWFpbmluZ0Jhc2UgLSBtYXRjaEJhc2UpIDwgYmFzZU1pblJlbWFpbmluZ1NpemUpIHsKICAgICAgbWF0Y2hTdG9wUmVhc29uID0gTWF0Y2hTdG9wUmVhc29uLlNhdGlzZmllZDsKICAgIH0gZWxzZSB7CiAgICAgIG1hdGNoU3RvcFJlYXNvbiA9IE1hdGNoU3RvcFJlYXNvbi5Ob25lOwogICAgfQogICAgYm9vbCB0aGVpcnNEZWFkID0gcmVjb3JkVGhlaXJNYXRjaCh0aGVpck9yZGVyLCB0aGVpck9yZGVySWQsIHRoZWlyUHJpY2UsIG1hdGNoQmFzZSwgbWF0Y2hDbnRyKTsKICAgIGlmICh0aGVpcnNEZWFkKSB7CiAgICAgIG5leHRUaGVpck9yZGVySWQgPSBvcmRlckNoYWluTm9kZUZvck9wZW5PcmRlcklkW3RoZWlyT3JkZXJJZF0ubmV4dE9yZGVySWQ7CiAgICAgIGlmIChtYXRjaFN0b3BSZWFzb24gPT0gTWF0Y2hTdG9wUmVhc29uLk5vbmUgJiYgbmV4dFRoZWlyT3JkZXJJZCA9PSAwKSB7CiAgICAgICAgbWF0Y2hTdG9wUmVhc29uID0gTWF0Y2hTdG9wUmVhc29uLlByaWNlRXhoYXVzdGVkOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBuZXh0VGhlaXJPcmRlcklkID0gdGhlaXJPcmRlcklkOwogICAgfQogIH0KCiAgLy8gSW50ZXJuYWwgT3JkZXIgUGxhY2VtZW50LgogIC8vCiAgLy8gUmVjb3JkIG1hdGNoIChwYXJ0aWFsIG9yIGNvbXBsZXRlKSBvZiByZXN0aW5nIG9yZGVyLCBhbmQgY3JlZGl0IHRoZW0gdGhlaXIgZnVuZHMuCiAgLy8KICAvLyBJZiB0aGVpciBvcmRlciBpcyBjb21wbGV0ZWx5IG1hdGNoZWQsIHRoZSBvcmRlciBpcyBtYXJrZWQgYXMgZG9uZSwKICAvLyBhbmQgInRoZWlyc0RlYWQiIGlzIHJldHVybmVkIGFzIHRydWUuCiAgLy8KICAvLyBUaGUgb3JkZXIgaXMgTk9UIHJlbW92ZWQgZnJvbSB0aGUgYm9vayBieSB0aGlzIGNhbGwgLSB0aGUgY2FsbGVyCiAgLy8gbXVzdCBkbyB0aGF0IGlmIHRoZWlyc0RlYWQgaXMgdHJ1ZS4KICAvLwogIC8vIE5vIHNhbml0eSBjaGVja3MgYXJlIG1hZGUgLSB0aGUgY2FsbGVyIG11c3QgYmUgc3VyZSB0aGUgb3JkZXIgaXMKICAvLyBub3QgYWxyZWFkeSBkb25lIGFuZCBoYXMgc3VmZmljaWVudCByZW1haW5pbmcuIChZZXMsIHdlJ2QgbGlrZSB0bwogIC8vIGNoZWNrIGhlcmUgdG9vIGJ1dCB3ZSBjYW5ub3QgYWZmb3JkIHRoZSBnYXMpLgogIC8vCiAgZnVuY3Rpb24gcmVjb3JkVGhlaXJNYXRjaCgKICAgICAgT3JkZXIgc3RvcmFnZSB0aGVpck9yZGVyLCB1aW50MTI4IHRoZWlyT3JkZXJJZCwgdWludDE2IHRoZWlyUHJpY2UsIHVpbnQgbWF0Y2hCYXNlLCB1aW50IG1hdGNoQ250cgogICAgKSBpbnRlcm5hbCByZXR1cm5zIChib29sIHRoZWlyc0RlYWQpIHsKICAgIC8vIHRoZXkgYXJlIGEgbWFrZXIgc28gbm8gZmVlcwogICAgLy8gb3ZlcmZsb3cgc2FmZSAtIHNlZSBjb21tZW50cyBhYm91dCBiYXNlTWF4U2l6ZQogICAgLy8gZXhlY3V0ZWRCYXNlIGNhbm5vdCBnbyA+IHNpemVCYXNlIGR1ZSB0byBsb2dpYyBpbiBtYXRjaFdpdGhUaGVpcnMKICAgIHRoZWlyT3JkZXIuZXhlY3V0ZWRCYXNlICs9IHVpbnQxMjgobWF0Y2hCYXNlKTsKICAgIHRoZWlyT3JkZXIuZXhlY3V0ZWRDbnRyICs9IHVpbnQxMjgobWF0Y2hDbnRyKTsKICAgIGlmIChpc0J1eVByaWNlKHRoZWlyUHJpY2UpKSB7CiAgICAgIC8vIHRoZXkgaGF2ZSBib3VnaHQgYmFzZSAodXNpbmcgdGhlIGNvdW50ZXIgdGhleSBhbHJlYWR5IHBhaWQgd2hlbiBjcmVhdGluZyB0aGUgb3JkZXIpCiAgICAgIGJhbGFuY2VCYXNlRm9yQ2xpZW50W3RoZWlyT3JkZXIuY2xpZW50XSArPSBtYXRjaEJhc2U7CiAgICB9IGVsc2UgewogICAgICAvLyB0aGV5IGhhdmUgYm91Z2h0IGNvdW50ZXIgKHVzaW5nIHRoZSBiYXNlIHRoZXkgYWxyZWFkeSBwYWlkIHdoZW4gY3JlYXRpbmcgdGhlIG9yZGVyKQogICAgICBiYWxhbmNlQ250ckZvckNsaWVudFt0aGVpck9yZGVyLmNsaWVudF0gKz0gbWF0Y2hDbnRyOwogICAgfQogICAgdWludCBzdGlsbFJlbWFpbmluZ0Jhc2UgPSB0aGVpck9yZGVyLnNpemVCYXNlIC0gdGhlaXJPcmRlci5leGVjdXRlZEJhc2U7CiAgICAvLyBhdm9pZCBsZWF2aW5nIHRpbnkgYW1vdW50cyBpbiB0aGUgYm9vayAtIHJlZnVuZCByZW1haW5pbmcgaWYgdG9vIHNtYWxsCiAgICBpZiAoc3RpbGxSZW1haW5pbmdCYXNlIDwgYmFzZU1pblJlbWFpbmluZ1NpemUpIHsKICAgICAgcmVmdW5kVW5tYXRjaGVkQW5kRmluaXNoKHRoZWlyT3JkZXJJZCwgU3RhdHVzLkRvbmUsIFJlYXNvbkNvZGUuTm9uZSk7CiAgICAgIC8vIHNvbWVvbmUgYnVpbGRpbmcgYW4gVUkgb24gdG9wIG5lZWRzIHRvIGtub3cgaG93IG11Y2ggd2FzIG1hdGNoIGFuZCBob3cgbXVjaCB3YXMgcmVmdW5kCiAgICAgIE1hcmtldE9yZGVyRXZlbnQoYmxvY2sudGltZXN0YW1wLCB0aGVpck9yZGVySWQsIE1hcmtldE9yZGVyRXZlbnRUeXBlLkNvbXBsZXRlRmlsbCwKICAgICAgICB0aGVpclByaWNlLCBtYXRjaEJhc2UgKyBzdGlsbFJlbWFpbmluZ0Jhc2UsIG1hdGNoQmFzZSk7CiAgICAgIHJldHVybiB0cnVlOwogICAgfSBlbHNlIHsKICAgICAgTWFya2V0T3JkZXJFdmVudChibG9jay50aW1lc3RhbXAsIHRoZWlyT3JkZXJJZCwgTWFya2V0T3JkZXJFdmVudFR5cGUuUGFydGlhbEZpbGwsCiAgICAgICAgdGhlaXJQcmljZSwgbWF0Y2hCYXNlLCBtYXRjaEJhc2UpOwogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgfQoKICAvLyBJbnRlcm5hbCBPcmRlciBQbGFjZW1lbnQuCiAgLy8KICAvLyBSZWZ1bmQgYW55IHVubWF0Y2hlZCBmdW5kcyBpbiBhbiBvcmRlciAoYmFzZWQgb24gZXhlY3V0ZWQgdnMgc2l6ZSkgYW5kIG1vdmUgdG8gYSBmaW5hbCBzdGF0ZS4KICAvLwogIC8vIFRoZSBvcmRlciBpcyBOT1QgcmVtb3ZlZCBmcm9tIHRoZSBib29rIGJ5IHRoaXMgY2FsbCBhbmQgbm8gZXZlbnQgaXMgcmFpc2VkLgogIC8vCiAgLy8gTm8gc2FuaXR5IGNoZWNrcyBhcmUgbWFkZSAtIHRoZSBjYWxsZXIgbXVzdCBiZSBzdXJlIHRoZSBvcmRlciBoYXMgbm90IGFscmVhZHkgYmVlbiByZWZ1bmRlZC4KICAvLwogIGZ1bmN0aW9uIHJlZnVuZFVubWF0Y2hlZEFuZEZpbmlzaCh1aW50MTI4IG9yZGVySWQsIFN0YXR1cyBzdGF0dXMsIFJlYXNvbkNvZGUgcmVhc29uQ29kZSkgaW50ZXJuYWwgewogICAgT3JkZXIgc3RvcmFnZSBvcmRlciA9IG9yZGVyRm9yT3JkZXJJZFtvcmRlcklkXTsKICAgIHVpbnQxNiBwcmljZSA9IG9yZGVyLnByaWNlOwogICAgaWYgKGlzQnV5UHJpY2UocHJpY2UpKSB7CiAgICAgIHVpbnQgc2l6ZUNudHIgPSBjb21wdXRlQ250ckFtb3VudFVzaW5nUGFja2VkKG9yZGVyLnNpemVCYXNlLCBwcmljZSk7CiAgICAgIGJhbGFuY2VDbnRyRm9yQ2xpZW50W29yZGVyLmNsaWVudF0gKz0gc2l6ZUNudHIgLSBvcmRlci5leGVjdXRlZENudHI7CiAgICB9IGVsc2UgewogICAgICBiYWxhbmNlQmFzZUZvckNsaWVudFtvcmRlci5jbGllbnRdICs9IG9yZGVyLnNpemVCYXNlIC0gb3JkZXIuZXhlY3V0ZWRCYXNlOwogICAgfQogICAgb3JkZXIuc3RhdHVzID0gc3RhdHVzOwogICAgb3JkZXIucmVhc29uQ29kZSA9IHJlYXNvbkNvZGU7CiAgfQoKICAvLyBJbnRlcm5hbCBPcmRlciBQbGFjZW1lbnQuCiAgLy8KICAvLyBFbnRlciBhIG5vdCBjb21wbGV0ZWx5IG1hdGNoZWQgb3JkZXIgaW50byB0aGUgYm9vaywgbWFya2luZyB0aGUgb3JkZXIgYXMgb3Blbi4KICAvLwogIC8vIFRoaXMgdXBkYXRlcyB0aGUgb2NjdXBpZWQgcHJpY2UgYml0bWFwIGFuZCBjaGFpbi4KICAvLwogIC8vIE5vIHNhbml0eSBjaGVja3MgYXJlIG1hZGUgLSB0aGUgY2FsbGVyIG11c3QgYmUgc3VyZSB0aGUgb3JkZXIKICAvLyBoYXMgc29tZSB1bm1hdGNoZWQgYW1vdW50IGFuZCBoYXMgYmVlbiBwYWlkIGZvciEKICAvLwogIGZ1bmN0aW9uIGVudGVyT3JkZXIodWludDEyOCBvcmRlcklkKSBpbnRlcm5hbCB7CiAgICBPcmRlciBzdG9yYWdlIG9yZGVyID0gb3JkZXJGb3JPcmRlcklkW29yZGVySWRdOwogICAgdWludDE2IHByaWNlID0gb3JkZXIucHJpY2U7CiAgICBPcmRlckNoYWluIHN0b3JhZ2Ugb3JkZXJDaGFpbiA9IG9yZGVyQ2hhaW5Gb3JPY2N1cGllZFByaWNlW3ByaWNlXTsKICAgIE9yZGVyQ2hhaW5Ob2RlIHN0b3JhZ2Ugb3JkZXJDaGFpbk5vZGUgPSBvcmRlckNoYWluTm9kZUZvck9wZW5PcmRlcklkW29yZGVySWRdOwogICAgaWYgKG9yZGVyQ2hhaW4uZmlyc3RPcmRlcklkID09IDApIHsKICAgICAgb3JkZXJDaGFpbi5maXJzdE9yZGVySWQgPSBvcmRlcklkOwogICAgICBvcmRlckNoYWluLmxhc3RPcmRlcklkID0gb3JkZXJJZDsKICAgICAgb3JkZXJDaGFpbk5vZGUubmV4dE9yZGVySWQgPSAwOwogICAgICBvcmRlckNoYWluTm9kZS5wcmV2T3JkZXJJZCA9IDA7CiAgICAgIHVpbnQgYml0bWFwSW5kZXggPSBwcmljZSAvIDI1NjsKICAgICAgdWludCBiaXRJbmRleCA9IHByaWNlICUgMjU2OwogICAgICBvY2N1cGllZFByaWNlQml0bWFwc1tiaXRtYXBJbmRleF0gfD0gKDIgKiogYml0SW5kZXgpOwogICAgfSBlbHNlIHsKICAgICAgdWludDEyOCBleGlzdGluZ0xhc3RPcmRlcklkID0gb3JkZXJDaGFpbi5sYXN0T3JkZXJJZDsKICAgICAgT3JkZXJDaGFpbk5vZGUgc3RvcmFnZSBleGlzdGluZ0xhc3RPcmRlckNoYWluTm9kZSA9IG9yZGVyQ2hhaW5Ob2RlRm9yT3Blbk9yZGVySWRbZXhpc3RpbmdMYXN0T3JkZXJJZF07CiAgICAgIG9yZGVyQ2hhaW5Ob2RlLm5leHRPcmRlcklkID0gMDsKICAgICAgb3JkZXJDaGFpbk5vZGUucHJldk9yZGVySWQgPSBleGlzdGluZ0xhc3RPcmRlcklkOwogICAgICBleGlzdGluZ0xhc3RPcmRlckNoYWluTm9kZS5uZXh0T3JkZXJJZCA9IG9yZGVySWQ7CiAgICAgIG9yZGVyQ2hhaW4ubGFzdE9yZGVySWQgPSBvcmRlcklkOwogICAgfQogICAgTWFya2V0T3JkZXJFdmVudChibG9jay50aW1lc3RhbXAsIG9yZGVySWQsIE1hcmtldE9yZGVyRXZlbnRUeXBlLkFkZCwKICAgICAgcHJpY2UsIG9yZGVyLnNpemVCYXNlIC0gb3JkZXIuZXhlY3V0ZWRCYXNlLCAwKTsKICAgIG9yZGVyLnN0YXR1cyA9IFN0YXR1cy5PcGVuOwogIH0KCiAgLy8gSW50ZXJuYWwgT3JkZXIgUGxhY2VtZW50LgogIC8vCiAgLy8gQ2hhcmdlIHRoZSBjbGllbnQgZm9yIHRoZSBjb3N0IG9mIHBsYWNpbmcgYW4gb3JkZXIgaW4gdGhlIGdpdmVuIGRpcmVjdGlvbi4KICAvLwogIC8vIFJldHVybiB0cnVlIGlmIHN1Y2Nlc3NmdWwsIGZhbHNlIG90aGVyd2lzZS4KICAvLwogIGZ1bmN0aW9uIGRlYml0RnVuZHMoCiAgICAgIGFkZHJlc3MgY2xpZW50LCBEaXJlY3Rpb24gZGlyZWN0aW9uLCB1aW50IHNpemVCYXNlLCB1aW50IHNpemVDbnRyCiAgICApIGludGVybmFsIHJldHVybnMgKGJvb2wgc3VjY2VzcykgewogICAgaWYgKGRpcmVjdGlvbiA9PSBEaXJlY3Rpb24uQnV5KSB7CiAgICAgIHVpbnQgYXZhaWxhYmxlQ250ciA9IGJhbGFuY2VDbnRyRm9yQ2xpZW50W2NsaWVudF07CiAgICAgIGlmIChhdmFpbGFibGVDbnRyIDwgc2l6ZUNudHIpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgYmFsYW5jZUNudHJGb3JDbGllbnRbY2xpZW50XSA9IGF2YWlsYWJsZUNudHIgLSBzaXplQ250cjsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9IGVsc2UgaWYgKGRpcmVjdGlvbiA9PSBEaXJlY3Rpb24uU2VsbCkgewogICAgICB1aW50IGF2YWlsYWJsZUJhc2UgPSBiYWxhbmNlQmFzZUZvckNsaWVudFtjbGllbnRdOwogICAgICBpZiAoYXZhaWxhYmxlQmFzZSA8IHNpemVCYXNlKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIGJhbGFuY2VCYXNlRm9yQ2xpZW50W2NsaWVudF0gPSBhdmFpbGFibGVCYXNlIC0gc2l6ZUJhc2U7CiAgICAgIHJldHVybiB0cnVlOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogIH0KCiAgLy8gUHVibGljIEJvb2sgVmlldwogIC8vIAogIC8vIEludGVuZGVkIGZvciBwdWJsaWMgYm9vayBkZXB0aCBlbnVtZXJhdGlvbiBmcm9tIHdlYjMgKG9yIHNpbWlsYXIpLgogIC8vCiAgLy8gTm90IHN1aXRhYmxlIGZvciB1c2UgZnJvbSBhIHNtYXJ0IGNvbnRyYWN0IHRyYW5zYWN0aW9uIC0gZ2FzIHVzYWdlCiAgLy8gY291bGQgYmUgdmVyeSBoaWdoIGlmIHdlIGhhdmUgbWFueSBvcmRlcnMgYXQgdGhlIHNhbWUgcHJpY2UuCiAgLy8KICAvLyBTdGFydCBhdCB0aGUgZ2l2ZW4gaW5jbHVzaXZlIHByaWNlIChhbmQgc2lkZSkgYW5kIHdhbGsgZG93biB0aGUgYm9vawogIC8vIChnZXR0aW5nIGxlc3MgYWdncmVzc2l2ZSkgdW50aWwgd2UgZmluZCBzb21lIG9wZW4gb3JkZXJzIG9yIHJlYWNoIHRoZQogIC8vIGxlYXN0IGFnZ3Jlc3NpdmUgcHJpY2UuCiAgLy8KICAvLyBSZXR1cm5zIHRoZSBwcmljZSB3aGVyZSB3ZSBmb3VuZCB0aGUgb3JkZXIocyksIHRoZSBkZXB0aCBhdCB0aGF0IHByaWNlCiAgLy8gKHplcm8gaWYgbm9uZSBmb3VuZCksIG9yZGVyIGNvdW50IHRoZXJlLCBhbmQgdGhlIGN1cnJlbnQgYmxvY2tOdW1iZXIuCiAgLy8KICAvLyAoVGhlIGJsb2NrTnVtYmVyIGlzIGhhbmR5IGlmIHlvdSdyZSB0YWtpbmcgYSBzbmFwc2hvdCB3aGljaCB5b3UgaW50ZW5kCiAgLy8gIHRvIGtlZXAgdXAtdG8tZGF0ZSB3aXRoIHRoZSBtYXJrZXQgb3JkZXIgZXZlbnRzKS4KICAvLwogIC8vIFRvIHdhbGsgdGhlIGJvb2ssIHRoZSBjYWxsZXIgc2hvdWxkIHN0YXJ0IGJ5IGNhbGxpbmcgd2Fsa0Jvb2sgd2l0aCB0aGUKICAvLyBtb3N0IGFnZ3Jlc3NpdmUgYnV5IHByaWNlIChCdXkgQCA5OTkwMDApLgogIC8vIElmIHRoZSBwcmljZSByZXR1cm5lZCBpcyB0aGUgbGVhc3QgYWdncmVzc2l2ZSBidXkgcHJpY2UgKEJ1eSBAIDAuMDAwMDAxKSwKICAvLyB0aGUgc2lkZSBpcyBjb21wbGV0ZS4KICAvLyBPdGhlcndpc2UsIGNhbGwgd2Fsa0Jvb2sgYWdhaW4gd2l0aCB0aGUgKHBhY2tlZCkgcHJpY2UgcmV0dXJuZWQgKyAxLgogIC8vIFRoZW4gcmVwZWF0IGZvciB0aGUgc2VsbCBzaWRlLCBzdGFydGluZyB3aXRoIFNlbGwgQCAwLjAwMDAwMSBhbmQgc3RvcHBpbmcKICAvLyB3aGVuIFNlbGwgQCA5OTkwMDAgaXMgcmV0dXJuZWQuCiAgLy8KICBmdW5jdGlvbiB3YWxrQm9vayh1aW50MTYgZnJvbVByaWNlKSBwdWJsaWMgY29uc3RhbnQgcmV0dXJucyAoCiAgICAgIHVpbnQxNiBwcmljZSwgdWludCBkZXB0aEJhc2UsIHVpbnQgb3JkZXJDb3VudCwgdWludCBibG9ja051bWJlcgogICAgKSB7CiAgICB1aW50IHByaWNlU3RhcnQgPSBmcm9tUHJpY2U7CiAgICB1aW50IHByaWNlRW5kID0gKGlzQnV5UHJpY2UoZnJvbVByaWNlKSkgPyBtaW5CdXlQcmljZSA6IG1heFNlbGxQcmljZTsKICAgIAogICAgLy8gU2VlIGNvbW1lbnRzIGluIG1hdGNoQWdhaW5zdEJvb2sgcmU6IGhvdyB0aGVzZSBjcmF6eSBsb29wcyB3b3JrLgogICAgCiAgICB1aW50IGJtaSA9IHByaWNlU3RhcnQgLyAyNTY7CiAgICB1aW50IGJ0aSA9IHByaWNlU3RhcnQgJSAyNTY7CiAgICB1aW50IGJtaUVuZCA9IHByaWNlRW5kIC8gMjU2OwogICAgdWludCBidGlFbmQgPSBwcmljZUVuZCAlIDI1NjsKCiAgICB1aW50IHdibSA9IG9jY3VwaWVkUHJpY2VCaXRtYXBzW2JtaV0gPj4gYnRpOwogICAgCiAgICB3aGlsZSAoYm1pIDwgYm1pRW5kKSB7CiAgICAgIGlmICh3Ym0gPT0gMCB8fCBidGkgPT0gMjU2KSB7CiAgICAgICAgYnRpID0gMDsKICAgICAgICBibWkrKzsKICAgICAgICB3Ym0gPSBvY2N1cGllZFByaWNlQml0bWFwc1tibWldOwogICAgICB9IGVsc2UgewogICAgICAgIGlmICgod2JtICYgMSkgIT0gMCkgewogICAgICAgICAgLy8gY2FyZWZ1bCAtIGNvcHktcGFzdGVkIGluIGJlbG93IGxvb3AKICAgICAgICAgIHByaWNlID0gdWludDE2KGJtaSAqIDI1NiArIGJ0aSk7CiAgICAgICAgICAoZGVwdGhCYXNlLCBvcmRlckNvdW50KSA9IHN1bURlcHRoKG9yZGVyQ2hhaW5Gb3JPY2N1cGllZFByaWNlW3ByaWNlXS5maXJzdE9yZGVySWQpOwogICAgICAgICAgcmV0dXJuIChwcmljZSwgZGVwdGhCYXNlLCBvcmRlckNvdW50LCBibG9jay5udW1iZXIpOwogICAgICAgIH0KICAgICAgICBidGkgKz0gMTsKICAgICAgICB3Ym0gLz0gMjsKICAgICAgfQogICAgfQogICAgLy8gd2UndmUgcmVhY2hlZCB0aGUgbGFzdCBiaXRtYXAgd2UgbmVlZCB0byBzZWFyY2gsIHN0b3AgYXQgYnRpRW5kIG5vdCAyNTYgdGhpcyB0aW1lLgogICAgd2hpbGUgKGJ0aSA8PSBidGlFbmQgJiYgd2JtICE9IDApIHsKICAgICAgaWYgKCh3Ym0gJiAxKSAhPSAwKSB7CiAgICAgICAgLy8gY2FyZWZ1bCAtIGNvcHktcGFzdGVkIGluIGFib3ZlIGxvb3AKICAgICAgICBwcmljZSA9IHVpbnQxNihibWkgKiAyNTYgKyBidGkpOwogICAgICAgIChkZXB0aEJhc2UsIG9yZGVyQ291bnQpID0gc3VtRGVwdGgob3JkZXJDaGFpbkZvck9jY3VwaWVkUHJpY2VbcHJpY2VdLmZpcnN0T3JkZXJJZCk7CiAgICAgICAgcmV0dXJuIChwcmljZSwgZGVwdGhCYXNlLCBvcmRlckNvdW50LCBibG9jay5udW1iZXIpOwogICAgICB9CiAgICAgIGJ0aSArPSAxOwogICAgICB3Ym0gLz0gMjsKICAgIH0KICAgIHJldHVybiAodWludDE2KHByaWNlRW5kKSwgMCwgMCwgYmxvY2subnVtYmVyKTsKICB9CgogIC8vIEludGVybmFsIEJvb2sgVmlldy4KICAvLwogIC8vIFNlZSB3YWxrQm9vayAtIGFkZHMgdXAgb3BlbiBkZXB0aCBhdCBhIHByaWNlIHN0YXJ0aW5nIGZyb20gYW4KICAvLyBvcmRlciB3aGljaCBpcyBhc3N1bWVkIHRvIGJlIG9wZW4uIENhcmVmdWwgLSB1bmxpbWl0ZWQgZ2FzIHVzZS4KICAvLwogIGZ1bmN0aW9uIHN1bURlcHRoKHVpbnQxMjggb3JkZXJJZCkgaW50ZXJuYWwgY29uc3RhbnQgcmV0dXJucyAodWludCBkZXB0aCwgdWludCBvcmRlckNvdW50KSB7CiAgICB3aGlsZSAodHJ1ZSkgewogICAgICBPcmRlciBzdG9yYWdlIG9yZGVyID0gb3JkZXJGb3JPcmRlcklkW29yZGVySWRdOwogICAgICBkZXB0aCArPSBvcmRlci5zaXplQmFzZSAtIG9yZGVyLmV4ZWN1dGVkQmFzZTsKICAgICAgb3JkZXJDb3VudCsrOwogICAgICBvcmRlcklkID0gb3JkZXJDaGFpbk5vZGVGb3JPcGVuT3JkZXJJZFtvcmRlcklkXS5uZXh0T3JkZXJJZDsKICAgICAgaWYgKG9yZGVySWQgPT0gMCkgewogICAgICAgIHJldHVybiAoZGVwdGgsIG9yZGVyQ291bnQpOwogICAgICB9CiAgICB9CiAgfQp9'.
	

]
