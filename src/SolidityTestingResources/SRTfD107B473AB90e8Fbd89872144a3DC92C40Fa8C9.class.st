Class {
	#name : #SRTfD107B473AB90e8Fbd89872144a3DC92C40Fa8C9,
	#superclass : #SRTContracts,
	#category : #SolidityTestingResources
}

{ #category : #base64 }
SRTfD107B473AB90e8Fbd89872144a3DC92C40Fa8C9 >> base64 [
	^ 'cHJhZ21hIHNvbGlkaXR5IF4wLjQuMTg7Cgpjb250cmFjdCBTYWZlTWF0aExpYiB7CiAgCiAgZnVuY3Rpb24gc2FmZU11bCh1aW50MjU2IGEsIHVpbnQyNTYgYikgaW50ZXJuYWwgcHVyZSByZXR1cm5zICh1aW50MjU2KSB7CiAgICBpZiAoYSA9PSAwKSB7CiAgICAgIHJldHVybiAwOwogICAgfQogICAgdWludDI1NiBjID0gYSAqIGI7CiAgICBhc3NlcnQoYyAvIGEgPT0gYik7CiAgICByZXR1cm4gYzsKICB9CgogIGZ1bmN0aW9uIHNhZmVTdWIodWludDI1NiBhLCB1aW50MjU2IGIpIGludGVybmFsIHB1cmUgcmV0dXJucyAodWludDI1NikgewogICAgYXNzZXJ0KGIgPD0gYSk7CiAgICByZXR1cm4gYSAtIGI7CiAgfQoKICBmdW5jdGlvbiBzYWZlQWRkKHVpbnQyNTYgYSwgdWludDI1NiBiKSBpbnRlcm5hbCBwdXJlICByZXR1cm5zICh1aW50MjU2KSB7CiAgICB1aW50IGMgPSBhICsgYjsKICAgIGFzc2VydChjPj1hKTsKICAgIHJldHVybiBjOwogIH0KICBmdW5jdGlvbiBzYWZlRGl2KHVpbnQyNTYgYSwgdWludDI1NiBiKSBpbnRlcm5hbCBwdXJlIHJldHVybnMgKHVpbnQyNTYpIHsKICAgIC8vIGFzc2VydChiID4gMCk7IC8vIFNvbGlkaXR5IGF1dG9tYXRpY2FsbHkgdGhyb3dzIHdoZW4gZGl2aWRpbmcgYnkgMAogICAgdWludDI1NiBjID0gYSAvIGI7CiAgICAvLyBhc3NlcnQoYSA9PSBiICogYyArIGEgJSBiKTsgLy8gVGhlcmUgaXMgbm8gY2FzZSBpbiB3aGljaCB0aGlzIGRvZXNuJ3QgaG9sZAogICAgcmV0dXJuIGM7CiAgfQp9CgovKioKICogQHRpdGxlIE93bmFibGUKICogQGRldiBUaGUgT3duYWJsZSBjb250cmFjdCBoYXMgYW4gb3duZXIgYWRkcmVzcywgYW5kIHByb3ZpZGVzIGJhc2ljIGF1dGhvcml6YXRpb24gY29udHJvbCAKICogZnVuY3Rpb25zLCB0aGlzIHNpbXBsaWZpZXMgdGhlIGltcGxlbWVudGF0aW9uIG9mICJ1c2VyIHBlcm1pc3Npb25zIi4gCiAqLwpjb250cmFjdCBPd25hYmxlIHsKICBhZGRyZXNzIHB1YmxpYyBvd25lcjsKICBhZGRyZXNzIHB1YmxpYyBuZXdPd25lcjsKICBldmVudCBPd25lcnNoaXBUcmFuc2ZlcnJlZChhZGRyZXNzIGluZGV4ZWQgX2Zyb20sIGFkZHJlc3MgaW5kZXhlZCBfdG8pOwogIC8qKiAKICAgKiBAZGV2IFRoZSBPd25hYmxlIGNvbnN0cnVjdG9yIHNldHMgdGhlIG9yaWdpbmFsIGBvd25lcmAgb2YgdGhlIGNvbnRyYWN0IHRvIHRoZSBzZW5kZXIKICAgKiBhY2NvdW50LgogICAqLwogIGZ1bmN0aW9uIE93bmFibGUoKSBwdWJsaWMgewogICAgb3duZXIgPSBtc2cuc2VuZGVyOwogIH0KCgogIC8qKgogICAqIEBkZXYgVGhyb3dzIGlmIGNhbGxlZCBieSBhbnkgYWNjb3VudCBvdGhlciB0aGFuIHRoZSBvd25lci4gCiAgICovCiAgbW9kaWZpZXIgb25seU93bmVyIHsKICAgIHJlcXVpcmUobXNnLnNlbmRlciA9PSBvd25lcik7CiAgICBfOwogIH0KCiAgLyoqCiAgICogQGRldiBBbGxvd3MgdGhlIGN1cnJlbnQgb3duZXIgdG8gdHJhbnNmZXIgY29udHJvbCBvZiB0aGUgY29udHJhY3QgdG8gYSBuZXdPd25lci4KICAgKiBAcGFyYW0gX25ld093bmVyIFRoZSBhZGRyZXNzIHRvIHRyYW5zZmVyIG93bmVyc2hpcCB0by4gCiAgICovCiAgZnVuY3Rpb24gdHJhbnNmZXJPd25lcnNoaXAoYWRkcmVzcyBfbmV3T3duZXIpIHB1YmxpYyBvbmx5T3duZXIgewogICAgbmV3T3duZXIgPSBfbmV3T3duZXI7CiAgfQoKICBmdW5jdGlvbiBhY2NlcHRPd25lcnNoaXAoKSBwdWJsaWMgewogICAgcmVxdWlyZShtc2cuc2VuZGVyID09IG5ld093bmVyKTsKICAgIE93bmVyc2hpcFRyYW5zZmVycmVkKG93bmVyLCBuZXdPd25lcik7CiAgICBvd25lciA9ICBuZXdPd25lcjsKICB9Cgp9CgovKioKICogQHRpdGxlIEVSQzIwQmFzaWMKICogQGRldiBTaW1wbGVyIHZlcnNpb24gb2YgRVJDMjAgaW50ZXJmYWNlCiAqIEBkZXYgc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9ldGhlcmV1bS9FSVBzL2lzc3Vlcy8xNzkKICovCmNvbnRyYWN0IEVSQzIwQmFzaWMgewogIHVpbnQyNTYgcHVibGljIHRvdGFsU3VwcGx5OwogIGZ1bmN0aW9uIGJhbGFuY2VPZihhZGRyZXNzIHdobykgcHVibGljIHZpZXcgcmV0dXJucyAodWludDI1Nik7CiAgZnVuY3Rpb24gdHJhbnNmZXIoYWRkcmVzcyB0bywgdWludDI1NiB2YWx1ZSkgcHVibGljIHJldHVybnMgKGJvb2wpOwogIGV2ZW50IFRyYW5zZmVyKGFkZHJlc3MgaW5kZXhlZCBmcm9tLCBhZGRyZXNzIGluZGV4ZWQgdG8sIHVpbnQyNTYgdmFsdWUpOwp9CgovKioKICogQHRpdGxlIEVSQzIwIGludGVyZmFjZQogKiBAZGV2IHNlZSBodHRwczovL2dpdGh1Yi5jb20vZXRoZXJldW0vRUlQcy9pc3N1ZXMvMjAKICovCmNvbnRyYWN0IEVSQzIwIGlzIEVSQzIwQmFzaWMgewogIGZ1bmN0aW9uIGFsbG93YW5jZShhZGRyZXNzIG93bmVyLCBhZGRyZXNzIHNwZW5kZXIpIHB1YmxpYyB2aWV3IHJldHVybnMgKHVpbnQyNTYpOwogIGZ1bmN0aW9uIHRyYW5zZmVyRnJvbShhZGRyZXNzIGZyb20sIGFkZHJlc3MgdG8sIHVpbnQyNTYgdmFsdWUpIHB1YmxpYyByZXR1cm5zIChib29sKTsKICBmdW5jdGlvbiBhcHByb3ZlKGFkZHJlc3Mgc3BlbmRlciwgdWludDI1NiB2YWx1ZSkgcHVibGljIHJldHVybnMgKGJvb2wpOwogIGV2ZW50IEFwcHJvdmFsKGFkZHJlc3MgaW5kZXhlZCBvd25lciwgYWRkcmVzcyBpbmRleGVkIHNwZW5kZXIsIHVpbnQyNTYgdmFsdWUpOwp9CgovKioKICogQSB0b2tlbiB0aGF0IGRlZmluZXMgZnJhY3Rpb25hbCB1bml0cyBhcyBkZWNpbWFscy4KICovCmNvbnRyYWN0IEZyYWN0aW9uYWxFUkMyMCBpcyBFUkMyMCB7CiAgdWludDggcHVibGljIGRlY2ltYWxzOwp9CgovKioKICogU3RhbmRhcmQgRVJDMjAgdG9rZW4gd2l0aCBTaG9ydCBIYW5kIEF0dGFjayBhbmQgYXBwcm92ZSgpIHJhY2UgY29uZGl0aW9uIG1pdGlnYXRpb24uCiAqCiAqIEJhc2VkIG9uIGNvZGUgYnkgRmlyc3RCbG9vZDoKICogaHR0cHM6Ly9naXRodWIuY29tL0ZpcnN0Ymxvb2Rpby90b2tlbi9ibG9iL21hc3Rlci9zbWFydF9jb250cmFjdC9GaXJzdEJsb29kVG9rZW4uc29sCiAqLwpjb250cmFjdCBTdGFuZGFyZFRva2VuIGlzIEVSQzIwLCBTYWZlTWF0aExpYiB7CiAgLyogVG9rZW4gc3VwcGx5IGdvdCBpbmNyZWFzZWQgYW5kIGEgbmV3IG93bmVyIHJlY2VpdmVkIHRoZXNlIHRva2VucyAqLwogIGV2ZW50IE1pbnRlZChhZGRyZXNzIHJlY2VpdmVyLCB1aW50MjU2IGFtb3VudCk7CgogIC8qIEFjdHVhbCBiYWxhbmNlcyBvZiB0b2tlbiBob2xkZXJzICovCiAgbWFwcGluZyhhZGRyZXNzID0+IHVpbnQpIGJhbGFuY2VzOwoKICAvKiBhcHByb3ZlKCkgYWxsb3dhbmNlcyAqLwogIG1hcHBpbmcgKGFkZHJlc3MgPT4gbWFwcGluZyAoYWRkcmVzcyA9PiB1aW50MjU2KSkgYWxsb3dlZDsKCiAgZnVuY3Rpb24gdHJhbnNmZXIoYWRkcmVzcyBfdG8sIHVpbnQyNTYgX3ZhbHVlKQogIHB1YmxpYwogIHJldHVybnMgKGJvb2wpIAogIHsgCiAgICByZXF1aXJlKF90byAhPSBhZGRyZXNzKDApKTsKICAgIHJlcXVpcmUoX3ZhbHVlIDw9IGJhbGFuY2VzW21zZy5zZW5kZXJdKTsKCiAgICAvLyBTYWZlTWF0aC5zdWIgd2lsbCB0aHJvdyBpZiB0aGVyZSBpcyBub3QgZW5vdWdoIGJhbGFuY2UuCiAgICBiYWxhbmNlc1ttc2cuc2VuZGVyXSA9IHNhZmVTdWIoYmFsYW5jZXNbbXNnLnNlbmRlcl0sX3ZhbHVlKTsKICAgIGJhbGFuY2VzW190b10gPSBzYWZlQWRkKGJhbGFuY2VzW190b10sX3ZhbHVlKTsKICAgIFRyYW5zZmVyKG1zZy5zZW5kZXIsIF90bywgX3ZhbHVlKTsKICAgIHJldHVybiB0cnVlOwogICAgCiAgfQoKICBmdW5jdGlvbiB0cmFuc2ZlckZyb20oYWRkcmVzcyBfZnJvbSwgYWRkcmVzcyBfdG8sIHVpbnQyNTYgX3ZhbHVlKSBwdWJsaWMgcmV0dXJucyAoYm9vbCkgewogICAgdWludCBfYWxsb3dhbmNlID0gYWxsb3dlZFtfZnJvbV1bbXNnLnNlbmRlcl07CiAgICByZXF1aXJlKF90byAhPSBhZGRyZXNzKDApKTsKICAgIHJlcXVpcmUoX3ZhbHVlIDw9IGJhbGFuY2VzW19mcm9tXSk7CiAgICByZXF1aXJlKF92YWx1ZSA8PSBfYWxsb3dhbmNlKTsKICAgIHJlcXVpcmUoYmFsYW5jZXNbX3RvXSArIF92YWx1ZSA+IGJhbGFuY2VzW190b10pOwoKICAgIGJhbGFuY2VzW190b10gPSBzYWZlQWRkKGJhbGFuY2VzW190b10sX3ZhbHVlKTsKICAgIGJhbGFuY2VzW19mcm9tXSA9IHNhZmVTdWIoYmFsYW5jZXNbX2Zyb21dLF92YWx1ZSk7CiAgICBhbGxvd2VkW19mcm9tXVttc2cuc2VuZGVyXSA9IHNhZmVTdWIoX2FsbG93YW5jZSxfdmFsdWUpOwogICAgVHJhbnNmZXIoX2Zyb20sIF90bywgX3ZhbHVlKTsKICAgIHJldHVybiB0cnVlOwogIH0KCiAgZnVuY3Rpb24gYmFsYW5jZU9mKGFkZHJlc3MgX293bmVyKSBwdWJsaWMgY29uc3RhbnQgcmV0dXJucyAodWludCBiYWxhbmNlKSB7CiAgICByZXR1cm4gYmFsYW5jZXNbX293bmVyXTsKICB9CgogIC8qKgogICAqIEBkZXYgQXBwcm92ZSB0aGUgcGFzc2VkIGFkZHJlc3MgdG8gc3BlbmQgdGhlIHNwZWNpZmllZCBhbW91bnQgb2YgdG9rZW5zIG9uIGJlaGFsZiBvZiBtc2cuc2VuZGVyLgogICAqCiAgICogQmV3YXJlIHRoYXQgY2hhbmdpbmcgYW4gYWxsb3dhbmNlIHdpdGggdGhpcyBtZXRob2QgYnJpbmdzIHRoZSByaXNrIHRoYXQgc29tZW9uZSBtYXkgdXNlIGJvdGggdGhlIG9sZAogICAqIGFuZCB0aGUgbmV3IGFsbG93YW5jZSBieSB1bmZvcnR1bmF0ZSB0cmFuc2FjdGlvbiBvcmRlcmluZy4gT25lIHBvc3NpYmxlIHNvbHV0aW9uIHRvIG1pdGlnYXRlIHRoaXMKICAgKiByYWNlIGNvbmRpdGlvbiBpcyB0byBmaXJzdCByZWR1Y2UgdGhlIHNwZW5kZXIncyBhbGxvd2FuY2UgdG8gMCBhbmQgc2V0IHRoZSBkZXNpcmVkIHZhbHVlIGFmdGVyd2FyZHM6CiAgICogaHR0cHM6Ly9naXRodWIuY29tL2V0aGVyZXVtL0VJUHMvaXNzdWVzLzIwI2lzc3VlY29tbWVudC0yNjM1MjQ3MjkKICAgKiBAcGFyYW0gX3NwZW5kZXIgVGhlIGFkZHJlc3Mgd2hpY2ggd2lsbCBzcGVuZCB0aGUgZnVuZHMuCiAgICogQHBhcmFtIF92YWx1ZSBUaGUgYW1vdW50IG9mIHRva2VucyB0byBiZSBzcGVudC4KICAgKi8KCiAgZnVuY3Rpb24gYXBwcm92ZShhZGRyZXNzIF9zcGVuZGVyLCB1aW50MjU2IF92YWx1ZSkgcHVibGljIHJldHVybnMgKGJvb2wpIHsKICAgIGFsbG93ZWRbbXNnLnNlbmRlcl1bX3NwZW5kZXJdID0gX3ZhbHVlOwogICAgQXBwcm92YWwobXNnLnNlbmRlciwgX3NwZW5kZXIsIF92YWx1ZSk7CiAgICByZXR1cm4gdHJ1ZTsKICB9CgogIC8qKgogICAqIEBkZXYgRnVuY3Rpb24gdG8gY2hlY2sgdGhlIGFtb3VudCBvZiB0b2tlbnMgdGhhdCBhbiBvd25lciBhbGxvd2VkIHRvIGEgc3BlbmRlci4KICAgKiBAcGFyYW0gX293bmVyIGFkZHJlc3MgVGhlIGFkZHJlc3Mgd2hpY2ggb3ducyB0aGUgZnVuZHMuCiAgICogQHBhcmFtIF9zcGVuZGVyIGFkZHJlc3MgVGhlIGFkZHJlc3Mgd2hpY2ggd2lsbCBzcGVuZCB0aGUgZnVuZHMuCiAgICogQHJldHVybiBBIHVpbnQyNTYgc3BlY2lmeWluZyB0aGUgYW1vdW50IG9mIHRva2VucyBzdGlsbCBhdmFpbGFibGUgZm9yIHRoZSBzcGVuZGVyLgogICAqLwogIGZ1bmN0aW9uIGFsbG93YW5jZShhZGRyZXNzIF9vd25lciwgYWRkcmVzcyBfc3BlbmRlcikgcHVibGljIHZpZXcgcmV0dXJucyAodWludDI1NikgewogICAgcmV0dXJuIGFsbG93ZWRbX293bmVyXVtfc3BlbmRlcl07CiAgfQoKICAgLyoqCiAgICogQGRldiBJbmNyZWFzZSB0aGUgYW1vdW50IG9mIHRva2VucyB0aGF0IGFuIG93bmVyIGFsbG93ZWQgdG8gYSBzcGVuZGVyLgogICAqCiAgICogYXBwcm92ZSBzaG91bGQgYmUgY2FsbGVkIHdoZW4gYWxsb3dlZFtfc3BlbmRlcl0gPT0gMC4gVG8gaW5jcmVtZW50CiAgICogYWxsb3dlZCB2YWx1ZSBpcyBiZXR0ZXIgdG8gdXNlIHRoaXMgZnVuY3Rpb24gdG8gYXZvaWQgMiBjYWxscyAoYW5kIHdhaXQgdW50aWwKICAgKiB0aGUgZmlyc3QgdHJhbnNhY3Rpb24gaXMgbWluZWQpCiAgICogRnJvbSBNb25vbGl0aERBTyBUb2tlbi5zb2wKICAgKiBAcGFyYW0gX3NwZW5kZXIgVGhlIGFkZHJlc3Mgd2hpY2ggd2lsbCBzcGVuZCB0aGUgZnVuZHMuCiAgICogQHBhcmFtIF9hZGRlZFZhbHVlIFRoZSBhbW91bnQgb2YgdG9rZW5zIHRvIGluY3JlYXNlIHRoZSBhbGxvd2FuY2UgYnkuCiAgICovCiAgZnVuY3Rpb24gaW5jcmVhc2VBcHByb3ZhbChhZGRyZXNzIF9zcGVuZGVyLCB1aW50MjU2IF9hZGRlZFZhbHVlKSBwdWJsaWMgcmV0dXJucyAoYm9vbCkgewogICAgYWxsb3dlZFttc2cuc2VuZGVyXVtfc3BlbmRlcl0gPSBzYWZlQWRkKGFsbG93ZWRbbXNnLnNlbmRlcl1bX3NwZW5kZXJdLF9hZGRlZFZhbHVlKTsKICAgIEFwcHJvdmFsKG1zZy5zZW5kZXIsIF9zcGVuZGVyLCBhbGxvd2VkW21zZy5zZW5kZXJdW19zcGVuZGVyXSk7CiAgICByZXR1cm4gdHJ1ZTsKICB9CgogIC8qKgogICAqIEBkZXYgRGVjcmVhc2UgdGhlIGFtb3VudCBvZiB0b2tlbnMgdGhhdCBhbiBvd25lciBhbGxvd2VkIHRvIGEgc3BlbmRlci4KICAgKgogICAqIGFwcHJvdmUgc2hvdWxkIGJlIGNhbGxlZCB3aGVuIGFsbG93ZWRbX3NwZW5kZXJdID09IDAuIFRvIGRlY3JlbWVudAogICAqIGFsbG93ZWQgdmFsdWUgaXMgYmV0dGVyIHRvIHVzZSB0aGlzIGZ1bmN0aW9uIHRvIGF2b2lkIDIgY2FsbHMgKGFuZCB3YWl0IHVudGlsCiAgICogdGhlIGZpcnN0IHRyYW5zYWN0aW9uIGlzIG1pbmVkKQogICAqIEZyb20gTW9ub2xpdGhEQU8gVG9rZW4uc29sCiAgICogQHBhcmFtIF9zcGVuZGVyIFRoZSBhZGRyZXNzIHdoaWNoIHdpbGwgc3BlbmQgdGhlIGZ1bmRzLgogICAqIEBwYXJhbSBfc3VidHJhY3RlZFZhbHVlIFRoZSBhbW91bnQgb2YgdG9rZW5zIHRvIGRlY3JlYXNlIHRoZSBhbGxvd2FuY2UgYnkuCiAgICovCiAgZnVuY3Rpb24gZGVjcmVhc2VBcHByb3ZhbChhZGRyZXNzIF9zcGVuZGVyLCB1aW50MjU2IF9zdWJ0cmFjdGVkVmFsdWUpIHB1YmxpYyByZXR1cm5zIChib29sKSB7CiAgICB1aW50IG9sZFZhbHVlID0gYWxsb3dlZFttc2cuc2VuZGVyXVtfc3BlbmRlcl07CiAgICBpZiAoX3N1YnRyYWN0ZWRWYWx1ZSA+IG9sZFZhbHVlKSB7CiAgICAgIGFsbG93ZWRbbXNnLnNlbmRlcl1bX3NwZW5kZXJdID0gMDsKICAgIH0gZWxzZSB7CiAgICAgIGFsbG93ZWRbbXNnLnNlbmRlcl1bX3NwZW5kZXJdID0gc2FmZVN1YihvbGRWYWx1ZSxfc3VidHJhY3RlZFZhbHVlKTsKICAgIH0KICAgIEFwcHJvdmFsKG1zZy5zZW5kZXIsIF9zcGVuZGVyLCBhbGxvd2VkW21zZy5zZW5kZXJdW19zcGVuZGVyXSk7CiAgICByZXR1cm4gdHJ1ZTsKICB9Cgp9Ci8qKgogKiBVcGdyYWRlIGFnZW50IGludGVyZmFjZSBpbnNwaXJlZCBieSBMdW55ci4KICoKICogVXBncmFkZSBhZ2VudCB0cmFuc2ZlcnMgdG9rZW5zIHRvIGEgbmV3IGNvbnRyYWN0LgogKiBVcGdyYWRlIGFnZW50IGl0c2VsZiBjYW4gYmUgdGhlIHRva2VuIGNvbnRyYWN0LCBvciBqdXN0IGEgbWlkZGxlIG1hbiBjb250cmFjdCBkb2luZyB0aGUgaGVhdnkgbGlmdGluZy4KICovCmNvbnRyYWN0IFVwZ3JhZGVBZ2VudCB7CiAgdWludCBwdWJsaWMgb3JpZ2luYWxTdXBwbHk7CiAgLyoqIEludGVyZmFjZSBtYXJrZXIgKi8KICBmdW5jdGlvbiBpc1VwZ3JhZGVBZ2VudCgpIHB1YmxpYyBwdXJlIHJldHVybnMgKGJvb2wpIHsKICAgIHJldHVybiB0cnVlOwogIH0KICBmdW5jdGlvbiB1cGdyYWRlRnJvbShhZGRyZXNzIF9mcm9tLCB1aW50MjU2IF92YWx1ZSkgcHVibGljOwp9CgovKioKICogQSB0b2tlbiB1cGdyYWRlIG1lY2hhbmlzbSB3aGVyZSB1c2VycyBjYW4gb3B0LWluIGFtb3VudCBvZiB0b2tlbnMgdG8gdGhlIG5leHQgc21hcnQgY29udHJhY3QgcmV2aXNpb24uCiAqCiAqIEZpcnN0IGVudmlzaW9uZWQgYnkgR29sZW0gYW5kIEx1bnlyIHByb2plY3RzLgogKi8KY29udHJhY3QgVXBncmFkZWFibGVUb2tlbiBpcyBTdGFuZGFyZFRva2VuIHsKCiAgLyoqIENvbnRyYWN0IC8gcGVyc29uIHdobyBjYW4gc2V0IHRoZSB1cGdyYWRlIHBhdGguIFRoaXMgY2FuIGJlIHRoZSBzYW1lIGFzIHRlYW0gbXVsdGlzaWcgd2FsbGV0LCBhcyB3aGF0IGl0IGlzIHdpdGggaXRzIGRlZmF1bHQgdmFsdWUuICovCiAgYWRkcmVzcyBwdWJsaWMgdXBncmFkZU1hc3RlcjsKCiAgLyoqIFRoZSBuZXh0IGNvbnRyYWN0IHdoZXJlIHRoZSB0b2tlbnMgd2lsbCBiZSBtaWdyYXRlZC4gKi8KICBVcGdyYWRlQWdlbnQgcHVibGljIHVwZ3JhZGVBZ2VudDsKCiAgLyoqIEhvdyBtYW55IHRva2VucyB3ZSBoYXZlIHVwZ3JhZGVkIGJ5IG5vdy4gKi8KICB1aW50MjU2IHB1YmxpYyB0b3RhbFVwZ3JhZGVkOwoKICAvKioKICAgKiBVcGdyYWRlIHN0YXRlcy4KICAgKgogICAqIC0gTm90QWxsb3dlZDogVGhlIGNoaWxkIGNvbnRyYWN0IGhhcyBub3QgcmVhY2hlZCBhIGNvbmRpdGlvbiB3aGVyZSB0aGUgdXBncmFkZSBjYW4gYmd1bgogICAqIC0gV2FpdGluZ0ZvckFnZW50OiBUb2tlbiBhbGxvd3MgdXBncmFkZSwgYnV0IHdlIGRvbid0IGhhdmUgYSBuZXcgYWdlbnQgeWV0CiAgICogLSBSZWFkeVRvVXBncmFkZTogVGhlIGFnZW50IGlzIHNldCwgYnV0IG5vdCBhIHNpbmdsZSB0b2tlbiBoYXMgYmVlbiB1cGdyYWRlZCB5ZXQKICAgKiAtIFVwZ3JhZGluZzogVXBncmFkZSBhZ2VudCBpcyBzZXQgYW5kIHRoZSBiYWxhbmNlIGhvbGRlcnMgY2FuIHVwZ3JhZGUgdGhlaXIgdG9rZW5zCiAgICoKICAgKi8KICBlbnVtIFVwZ3JhZGVTdGF0ZSB7VW5rbm93biwgTm90QWxsb3dlZCwgV2FpdGluZ0ZvckFnZW50LCBSZWFkeVRvVXBncmFkZSwgVXBncmFkaW5nfQoKICAvKioKICAgKiBTb21lYm9keSBoYXMgdXBncmFkZWQgc29tZSBvZiBoaXMgdG9rZW5zLgogICAqLwogIGV2ZW50IFVwZ3JhZGUoYWRkcmVzcyBpbmRleGVkIF9mcm9tLCBhZGRyZXNzIGluZGV4ZWQgX3RvLCB1aW50MjU2IF92YWx1ZSk7CgogIC8qKgogICAqIE5ldyB1cGdyYWRlIGFnZW50IGF2YWlsYWJsZS4KICAgKi8KICBldmVudCBVcGdyYWRlQWdlbnRTZXQoYWRkcmVzcyBhZ2VudCk7CgogIC8qKgogICAqIERvIG5vdCBhbGxvdyBjb25zdHJ1Y3Rpb24gd2l0aG91dCB1cGdyYWRlIG1hc3RlciBzZXQuCiAgICovCiAgZnVuY3Rpb24gVXBncmFkZWFibGVUb2tlbihhZGRyZXNzIF91cGdyYWRlTWFzdGVyKSBwdWJsaWMgewogICAgdXBncmFkZU1hc3RlciA9IF91cGdyYWRlTWFzdGVyOwogIH0KCiAgLyoqCiAgICogQWxsb3cgdGhlIHRva2VuIGhvbGRlciB0byB1cGdyYWRlIHNvbWUgb2YgdGhlaXIgdG9rZW5zIHRvIGEgbmV3IGNvbnRyYWN0LgogICAqLwogIGZ1bmN0aW9uIHVwZ3JhZGUodWludDI1NiB2YWx1ZSkgcHVibGljIHsKICAgIFVwZ3JhZGVTdGF0ZSBzdGF0ZSA9IGdldFVwZ3JhZGVTdGF0ZSgpOwogICAgcmVxdWlyZSgoc3RhdGUgPT0gVXBncmFkZVN0YXRlLlJlYWR5VG9VcGdyYWRlIHx8IHN0YXRlID09IFVwZ3JhZGVTdGF0ZS5VcGdyYWRpbmcpKTsKCiAgICAvLyBWYWxpZGF0ZSBpbnB1dCB2YWx1ZS4KICAgIHJlcXVpcmUgKHZhbHVlICE9IDApOwoKICAgIGJhbGFuY2VzW21zZy5zZW5kZXJdID0gc2FmZVN1YihiYWxhbmNlc1ttc2cuc2VuZGVyXSx2YWx1ZSk7CgogICAgLy8gVGFrZSB0b2tlbnMgb3V0IGZyb20gY2lyY3VsYXRpb24KICAgIHRvdGFsU3VwcGx5ID0gc2FmZVN1Yih0b3RhbFN1cHBseSx2YWx1ZSk7CiAgICB0b3RhbFVwZ3JhZGVkID0gc2FmZUFkZCh0b3RhbFVwZ3JhZGVkLHZhbHVlKTsKCiAgICAvLyBVcGdyYWRlIGFnZW50IHJlaXNzdWVzIHRoZSB0b2tlbnMKICAgIHVwZ3JhZGVBZ2VudC51cGdyYWRlRnJvbShtc2cuc2VuZGVyLCB2YWx1ZSk7CiAgICBVcGdyYWRlKG1zZy5zZW5kZXIsIHVwZ3JhZGVBZ2VudCwgdmFsdWUpOwogIH0KCiAgLyoqCiAgICogU2V0IGFuIHVwZ3JhZGUgYWdlbnQgdGhhdCBoYW5kbGVzCiAgICovCiAgZnVuY3Rpb24gc2V0VXBncmFkZUFnZW50KGFkZHJlc3MgYWdlbnQpIGV4dGVybmFsIHsKICAgIHJlcXVpcmUoY2FuVXBncmFkZSgpKTsKCiAgICByZXF1aXJlKGFnZW50ICE9IDB4MCk7CiAgICAvLyBPbmx5IGEgbWFzdGVyIGNhbiBkZXNpZ25hdGUgdGhlIG5leHQgYWdlbnQKICAgIHJlcXVpcmUobXNnLnNlbmRlciA9PSB1cGdyYWRlTWFzdGVyKTsKICAgIC8vIFVwZ3JhZGUgaGFzIGFscmVhZHkgYmVndW4gZm9yIGFuIGFnZW50CiAgICByZXF1aXJlKGdldFVwZ3JhZGVTdGF0ZSgpICE9IFVwZ3JhZGVTdGF0ZS5VcGdyYWRpbmcpOwoKICAgIHVwZ3JhZGVBZ2VudCA9IFVwZ3JhZGVBZ2VudChhZ2VudCk7CgogICAgLy8gQmFkIGludGVyZmFjZQogICAgcmVxdWlyZSh1cGdyYWRlQWdlbnQuaXNVcGdyYWRlQWdlbnQoKSk7CiAgICAvLyBNYWtlIHN1cmUgdGhhdCB0b2tlbiBzdXBwbGllcyBtYXRjaCBpbiBzb3VyY2UgYW5kIHRhcmdldAogICAgcmVxdWlyZSh1cGdyYWRlQWdlbnQub3JpZ2luYWxTdXBwbHkoKSA9PSB0b3RhbFN1cHBseSk7CgogICAgVXBncmFkZUFnZW50U2V0KHVwZ3JhZGVBZ2VudCk7CiAgfQoKICAvKioKICAgKiBHZXQgdGhlIHN0YXRlIG9mIHRoZSB0b2tlbiB1cGdyYWRlLgogICAqLwogIGZ1bmN0aW9uIGdldFVwZ3JhZGVTdGF0ZSgpIHB1YmxpYyBjb25zdGFudCByZXR1cm5zKFVwZ3JhZGVTdGF0ZSkgewogICAgaWYoIWNhblVwZ3JhZGUoKSkgcmV0dXJuIFVwZ3JhZGVTdGF0ZS5Ob3RBbGxvd2VkOwogICAgZWxzZSBpZihhZGRyZXNzKHVwZ3JhZGVBZ2VudCkgPT0gMHgwMCkgcmV0dXJuIFVwZ3JhZGVTdGF0ZS5XYWl0aW5nRm9yQWdlbnQ7CiAgICBlbHNlIGlmKHRvdGFsVXBncmFkZWQgPT0gMCkgcmV0dXJuIFVwZ3JhZGVTdGF0ZS5SZWFkeVRvVXBncmFkZTsKICAgIGVsc2UgcmV0dXJuIFVwZ3JhZGVTdGF0ZS5VcGdyYWRpbmc7CiAgfQoKICAvKioKICAgKiBDaGFuZ2UgdGhlIHVwZ3JhZGUgbWFzdGVyLgogICAqCiAgICogVGhpcyBhbGxvd3MgdXMgdG8gc2V0IGEgbmV3IG93bmVyIGZvciB0aGUgdXBncmFkZSBtZWNoYW5pc20uCiAgICovCiAgZnVuY3Rpb24gc2V0VXBncmFkZU1hc3RlcihhZGRyZXNzIG1hc3RlcikgcHVibGljIHsKICAgIHJlcXVpcmUobWFzdGVyICE9IDB4MCk7CiAgICByZXF1aXJlKG1zZy5zZW5kZXIgPT0gdXBncmFkZU1hc3Rlcik7CiAgICB1cGdyYWRlTWFzdGVyID0gbWFzdGVyOwogIH0KCiAgLyoqCiAgICogQ2hpbGQgY29udHJhY3QgY2FuIGVuYWJsZSB0byBwcm92aWRlIHRoZSBjb25kaXRpb24gd2hlbiB0aGUgdXBncmFkZSBjYW4gYmVndW4uCiAgICovCiAgZnVuY3Rpb24gY2FuVXBncmFkZSgpIHB1YmxpYyB2aWV3IHJldHVybnMoYm9vbCkgewogICAgIHJldHVybiB0cnVlOwogIH0KCn0KCi8qKgogKiBEZWZpbmUgaW50ZXJmYWNlIGZvciByZWxlYXNpbmcgdGhlIHRva2VuIHRyYW5zZmVyIGFmdGVyIGEgc3VjY2Vzc2Z1bCBjcm93ZHNhbGUuCiAqLwpjb250cmFjdCBSZWxlYXNhYmxlVG9rZW4gaXMgRVJDMjAsIE93bmFibGUgewoKICAvKiBUaGUgZmluYWxpemVyIGNvbnRyYWN0IHRoYXQgYWxsb3dzIHVubGlmdCB0aGUgdHJhbnNmZXIgbGltaXRzIG9uIHRoaXMgdG9rZW4gKi8KICBhZGRyZXNzIHB1YmxpYyByZWxlYXNlQWdlbnQ7CgogIC8qKiBBIGNyb3dkc2FsZSBjb250cmFjdCBjYW4gcmVsZWFzZSB1cyB0byB0aGUgd2lsZCBpZiBJQ08gc3VjY2Vzcy4gSWYgZmFsc2Ugd2UgYXJlIGFyZSBpbiB0cmFuc2ZlciBsb2NrIHVwIHBlcmlvZC4qLwogIGJvb2wgcHVibGljIHJlbGVhc2VkID0gZmFsc2U7CgogIC8qKiBNYXAgb2YgYWdlbnRzIHRoYXQgYXJlIGFsbG93ZWQgdG8gdHJhbnNmZXIgdG9rZW5zIHJlZ2FyZGxlc3Mgb2YgdGhlIGxvY2sgZG93biBwZXJpb2QuIFRoZXNlIGFyZSBjcm93ZHNhbGUgY29udHJhY3RzIGFuZCBwb3NzaWJsZSB0aGUgdGVhbSBtdWx0aXNpZyBpdHNlbGYuICovCiAgbWFwcGluZyAoYWRkcmVzcyA9PiBib29sKSBwdWJsaWMgdHJhbnNmZXJBZ2VudHM7CgogIC8qKgogICAqIExpbWl0IHRva2VuIHRyYW5zZmVyIHVudGlsIHRoZSBjcm93ZHNhbGUgaXMgb3Zlci4KICAgKgogICAqLwogIG1vZGlmaWVyIGNhblRyYW5zZmVyKGFkZHJlc3MgX3NlbmRlcikgewoKICAgIGlmKCFyZWxlYXNlZCkgewogICAgICAgIHJlcXVpcmUodHJhbnNmZXJBZ2VudHNbX3NlbmRlcl0pOwogICAgfQoKICAgIF87CiAgfQoKICAvKioKICAgKiBTZXQgdGhlIGNvbnRyYWN0IHRoYXQgY2FuIGNhbGwgcmVsZWFzZSBhbmQgbWFrZSB0aGUgdG9rZW4gdHJhbnNmZXJhYmxlLgogICAqCiAgICogRGVzaWduIGNob2ljZS4gQWxsb3cgcmVzZXQgdGhlIHJlbGVhc2UgYWdlbnQgdG8gZml4IGZhdCBmaW5nZXIgbWlzdGFrZXMuCiAgICovCiAgZnVuY3Rpb24gc2V0UmVsZWFzZUFnZW50KGFkZHJlc3MgYWRkcikgb25seU93bmVyIGluUmVsZWFzZVN0YXRlKGZhbHNlKSBwdWJsaWMgewoKICAgIC8vIFdlIGRvbid0IGRvIGludGVyZmFjZSBjaGVjayBoZXJlIGFzIHdlIG1pZ2h0IHdhbnQgdG8gYSBub3JtYWwgd2FsbGV0IGFkZHJlc3MgdG8gYWN0IGFzIGEgcmVsZWFzZSBhZ2VudAogICAgcmVsZWFzZUFnZW50ID0gYWRkcjsKICB9CgogIC8qKgogICAqIE93bmVyIGNhbiBhbGxvdyBhIHBhcnRpY3VsYXIgYWRkcmVzcyAoYSBjcm93ZHNhbGUgY29udHJhY3QpIHRvIHRyYW5zZmVyIHRva2VucyBkZXNwaXRlIHRoZSBsb2NrIHVwIHBlcmlvZC4KICAgKi8KICBmdW5jdGlvbiBzZXRUcmFuc2ZlckFnZW50KGFkZHJlc3MgYWRkciwgYm9vbCBzdGF0ZSkgb25seU93bmVyIGluUmVsZWFzZVN0YXRlKGZhbHNlKSBwdWJsaWMgewogICAgdHJhbnNmZXJBZ2VudHNbYWRkcl0gPSBzdGF0ZTsKICB9CgogIC8qKgogICAqIE9uZSB3YXkgZnVuY3Rpb24gdG8gcmVsZWFzZSB0aGUgdG9rZW5zIHRvIHRoZSB3aWxkLgogICAqCiAgICogQ2FuIGJlIGNhbGxlZCBvbmx5IGZyb20gdGhlIHJlbGVhc2UgYWdlbnQgdGhhdCBpcyB0aGUgZmluYWwgSUNPIGNvbnRyYWN0LiBJdCBpcyBvbmx5IGNhbGxlZCBpZiB0aGUgY3Jvd2RzYWxlIGhhcyBiZWVuIHN1Y2Nlc3MgKGZpcnN0IG1pbGVzdG9uZSByZWFjaGVkKS4KICAgKi8KICBmdW5jdGlvbiByZWxlYXNlVG9rZW5UcmFuc2ZlcigpIHB1YmxpYyBvbmx5UmVsZWFzZUFnZW50IHsKICAgIHJlbGVhc2VkID0gdHJ1ZTsKICB9CgogIC8qKiBUaGUgZnVuY3Rpb24gY2FuIGJlIGNhbGxlZCBvbmx5IGJlZm9yZSBvciBhZnRlciB0aGUgdG9rZW5zIGhhdmUgYmVlbiByZWxlYXNlc2QgKi8KICBtb2RpZmllciBpblJlbGVhc2VTdGF0ZShib29sIHJlbGVhc2VTdGF0ZSkgewogICAgcmVxdWlyZShyZWxlYXNlU3RhdGUgPT0gcmVsZWFzZWQpOwogICAgXzsKICB9CgogIC8qKiBUaGUgZnVuY3Rpb24gY2FuIGJlIGNhbGxlZCBvbmx5IGJ5IGEgd2hpdGVsaXN0ZWQgcmVsZWFzZSBhZ2VudC4gKi8KICBtb2RpZmllciBvbmx5UmVsZWFzZUFnZW50KCkgewogICAgcmVxdWlyZShtc2cuc2VuZGVyID09IHJlbGVhc2VBZ2VudCk7CiAgICBfOwogIH0KCiAgZnVuY3Rpb24gdHJhbnNmZXIoYWRkcmVzcyBfdG8sIHVpbnQgX3ZhbHVlKSBjYW5UcmFuc2Zlcihtc2cuc2VuZGVyKSBwdWJsaWMgcmV0dXJucyAoYm9vbCBzdWNjZXNzKSB7CiAgICAvLyBDYWxsIFN0YW5kYXJkVG9rZW4udHJhbnNmZXIoKQogICByZXR1cm4gc3VwZXIudHJhbnNmZXIoX3RvLCBfdmFsdWUpOwogIH0KCiAgZnVuY3Rpb24gdHJhbnNmZXJGcm9tKGFkZHJlc3MgX2Zyb20sIGFkZHJlc3MgX3RvLCB1aW50IF92YWx1ZSkgY2FuVHJhbnNmZXIoX2Zyb20pIHB1YmxpYyByZXR1cm5zIChib29sIHN1Y2Nlc3MpIHsKICAgIC8vIENhbGwgU3RhbmRhcmRUb2tlbi50cmFuc2ZlckZvcm0oKQogICAgcmV0dXJuIHN1cGVyLnRyYW5zZmVyRnJvbShfZnJvbSwgX3RvLCBfdmFsdWUpOwogIH0KCn0KICAKLyoqCiAqIEEgdG9rZW4gdGhhdCBjYW4gaW5jcmVhc2UgaXRzIHN1cHBseSBieSBhbm90aGVyIGNvbnRyYWN0LgogKgogKiBUaGlzIGFsbG93cyB1bmNhcHBlZCBjcm93ZHNhbGUgYnkgZHluYW1pY2FsbHkgaW5jcmVhc2luZyB0aGUgc3VwcGx5IHdoZW4gbW9uZXkgcG91cnMgaW4uCiAqIE9ubHkgbWludCBhZ2VudHMsIGNvbnRyYWN0cyB3aGl0ZWxpc3RlZCBieSBvd25lciwgY2FuIG1pbnQgbmV3IHRva2Vucy4KICoKICovCmNvbnRyYWN0IE1pbnRhYmxlVG9rZW4gaXMgU3RhbmRhcmRUb2tlbiwgT3duYWJsZSB7CgogIGJvb2wgcHVibGljIG1pbnRpbmdGaW5pc2hlZCA9IGZhbHNlOwoKICAvKiogTGlzdCBvZiBhZ2VudHMgdGhhdCBhcmUgYWxsb3dlZCB0byBjcmVhdGUgbmV3IHRva2VucyAqLwogIG1hcHBpbmcgKGFkZHJlc3MgPT4gYm9vbCkgcHVibGljIG1pbnRBZ2VudHM7CgogIGV2ZW50IE1pbnRpbmdBZ2VudENoYW5nZWQoYWRkcmVzcyBhZGRyLCBib29sIHN0YXRlKTsKICBldmVudCBNaW50KGFkZHJlc3MgaW5kZXhlZCB0bywgdWludDI1NiBhbW91bnQpOwoKICAvKioKICAgKiBDcmVhdGUgbmV3IHRva2VucyBhbmQgYWxsb2NhdGUgdGhlbSB0byBhbiBhZGRyZXNzLi4KICAgKgogICAqIE9ubHkgY2FsbGFibHkgYnkgYSBjcm93ZHNhbGUgY29udHJhY3QgKG1pbnQgYWdlbnQpLgogICAqLwogIGZ1bmN0aW9uIG1pbnQoYWRkcmVzcyByZWNlaXZlciwgdWludDI1NiBhbW91bnQpIG9ubHlNaW50QWdlbnQgY2FuTWludCBwdWJsaWMgcmV0dXJucyhib29sKXsKICAgIHRvdGFsU3VwcGx5ID0gc2FmZUFkZCh0b3RhbFN1cHBseSwgYW1vdW50KTsKICAgIGJhbGFuY2VzW3JlY2VpdmVyXSA9IHNhZmVBZGQoYmFsYW5jZXNbcmVjZWl2ZXJdLCBhbW91bnQpOwoKICAgIC8vIFRoaXMgd2lsbCBtYWtlIHRoZSBtaW50IHRyYW5zYWN0aW9uIGFwcGVyIGluIEV0aGVyU2Nhbi5pbwogICAgLy8gV2UgY2FuIHJlbW92ZSB0aGlzIGFmdGVyIHRoZXJlIGlzIGEgc3RhbmRhcmRpemVkIG1pbnRpbmcgZXZlbnQKICAgIE1pbnQocmVjZWl2ZXIsIGFtb3VudCk7CiAgICBUcmFuc2ZlcigwLCByZWNlaXZlciwgYW1vdW50KTsKICAgIHJldHVybiB0cnVlOwogIH0KCiAgLyoqCiAgICogT3duZXIgY2FuIGFsbG93IGEgY3Jvd2RzYWxlIGNvbnRyYWN0IHRvIG1pbnQgbmV3IHRva2Vucy4KICAgKi8KICBmdW5jdGlvbiBzZXRNaW50QWdlbnQoYWRkcmVzcyBhZGRyLCBib29sIHN0YXRlKSBvbmx5T3duZXIgY2FuTWludCBwdWJsaWMgewogICAgbWludEFnZW50c1thZGRyXSA9IHN0YXRlOwogICAgTWludGluZ0FnZW50Q2hhbmdlZChhZGRyLCBzdGF0ZSk7CiAgfQoKICBtb2RpZmllciBvbmx5TWludEFnZW50KCkgewogICAgLy8gT25seSBjcm93ZHNhbGUgY29udHJhY3RzIGFyZSBhbGxvd2VkIHRvIG1pbnQgbmV3IHRva2VucwogICAgcmVxdWlyZShtaW50QWdlbnRzW21zZy5zZW5kZXJdKTsKICAgIF87CiAgfQoKICAvKiogTWFrZSBzdXJlIHdlIGFyZSBub3QgZG9uZSB5ZXQuICovCiAgbW9kaWZpZXIgY2FuTWludCgpIHsKICAgIHJlcXVpcmUoIW1pbnRpbmdGaW5pc2hlZCk7CiAgICBfOwogIH0KfQoKY29udHJhY3QgQWxsb2NhdGFibGUgaXMgT3duYWJsZSB7CgogIC8qKiBMaXN0IG9mIGFnZW50cyB0aGF0IGFyZSBhbGxvd2VkIHRvIGFsbG9jYXRlIG5ldyB0b2tlbnMgKi8KICBtYXBwaW5nIChhZGRyZXNzID0+IGJvb2wpIHB1YmxpYyBhbGxvY2F0ZUFnZW50czsKCiAgZXZlbnQgQWxsb2NhdGVBZ2VudENoYW5nZWQoYWRkcmVzcyBhZGRyLCBib29sIHN0YXRlICApOwoKICAvKioKICAgKiBPd25lciBjYW4gYWxsb3cgYSBjcm93ZHNhbGUgY29udHJhY3QgdG8gYWxsb2NhdGUgbmV3IHRva2Vucy4KICAgKi8KICBmdW5jdGlvbiBzZXRBbGxvY2F0ZUFnZW50KGFkZHJlc3MgYWRkciwgYm9vbCBzdGF0ZSkgb25seU93bmVyIHB1YmxpYyB7CiAgICBhbGxvY2F0ZUFnZW50c1thZGRyXSA9IHN0YXRlOwogICAgQWxsb2NhdGVBZ2VudENoYW5nZWQoYWRkciwgc3RhdGUpOwogIH0KCiAgbW9kaWZpZXIgb25seUFsbG9jYXRlQWdlbnQoKSB7CiAgICAvLyBPbmx5IGNyb3dkc2FsZSBjb250cmFjdHMgYXJlIGFsbG93ZWQgdG8gYWxsb2NhdGUgbmV3IHRva2VucwogICAgcmVxdWlyZShhbGxvY2F0ZUFnZW50c1ttc2cuc2VuZGVyXSk7CiAgICBfOwogIH0KfQoKLyoqCiAqIEEgY3Jvd2RzYWxlZCB0b2tlbi4KICoKICogQW4gRVJDLTIwIHRva2VuIGRlc2lnbmVkIHNwZWNpZmljYWxseSBmb3IgY3Jvd2RzYWxlcyB3aXRoIGludmVzdG9yIHByb3RlY3Rpb24gYW5kIGZ1cnRoZXIgZGV2ZWxvcG1lbnQgcGF0aC4KICoKICogLSBUaGUgdG9rZW4gdHJhbnNmZXIoKSBpcyBkaXNhYmxlZCB1bnRpbCB0aGUgY3Jvd2RzYWxlIGlzIG92ZXIKICogLSBUaGUgdG9rZW4gY29udHJhY3QgZ2l2ZXMgYW4gb3B0LWluIHVwZ3JhZGUgcGF0aCB0byBhIG5ldyBjb250cmFjdAogKiAtIFRoZSBzYW1lIHRva2VuIGNhbiBiZSBwYXJ0IG9mIHNldmVyYWwgY3Jvd2RzYWxlcyB0aHJvdWdoIGFwcHJvdmUoKSBtZWNoYW5pc20KICogLSBUaGUgdG9rZW4gY2FuIGJlIGNhcHBlZCAoc3VwcGx5IHNldCBpbiB0aGUgY29uc3RydWN0b3IpIG9yIHVuY2FwcGVkIChjcm93ZHNhbGUgY29udHJhY3QgY2FuIG1pbnQgbmV3IHRva2VucykKICoKICovCmNvbnRyYWN0IENyb3dkc2FsZVRva2VuIGlzIFJlbGVhc2FibGVUb2tlbiwgTWludGFibGVUb2tlbiwgVXBncmFkZWFibGVUb2tlbiB7CgogIGV2ZW50IFVwZGF0ZWRUb2tlbkluZm9ybWF0aW9uKHN0cmluZyBuZXdOYW1lLCBzdHJpbmcgbmV3U3ltYm9sKTsKCiAgc3RyaW5nIHB1YmxpYyBuYW1lOwoKICBzdHJpbmcgcHVibGljIHN5bWJvbDsKCiAgdWludDggcHVibGljIGRlY2ltYWxzOwoKICAvKioKICAgKiBDb25zdHJ1Y3QgdGhlIHRva2VuLgogICAqCiAgICogVGhpcyB0b2tlbiBtdXN0IGJlIGNyZWF0ZWQgdGhyb3VnaCBhIHRlYW0gbXVsdGlzaWcgd2FsbGV0LCBzbyB0aGF0IGl0IGlzIG93bmVkIGJ5IHRoYXQgd2FsbGV0LgogICAqCiAgICogQHBhcmFtIF9uYW1lIFRva2VuIG5hbWUKICAgKiBAcGFyYW0gX3N5bWJvbCBUb2tlbiBzeW1ib2wgLSBzaG91bGQgYmUgYWxsIGNhcHMKICAgKiBAcGFyYW0gX2luaXRpYWxTdXBwbHkgSG93IG1hbnkgdG9rZW5zIHdlIHN0YXJ0IHdpdGgKICAgKiBAcGFyYW0gX2RlY2ltYWxzIE51bWJlciBvZiBkZWNpbWFsIHBsYWNlcwogICAqIEBwYXJhbSBfbWludGFibGUgQXJlIG5ldyB0b2tlbnMgY3JlYXRlZCBvdmVyIHRoZSBjcm93ZHNhbGUgb3IgZG8gd2UgZGlzdHJpYnV0ZSBvbmx5IHRoZSBpbml0aWFsIHN1cHBseT8gTm90ZSB0aGF0IHdoZW4gdGhlIHRva2VuIGJlY29tZXMgdHJhbnNmZXJhYmxlIHRoZSBtaW50aW5nIGFsd2F5cyBlbmRzLgogICAqLwogIGZ1bmN0aW9uIENyb3dkc2FsZVRva2VuKHN0cmluZyBfbmFtZSwgc3RyaW5nIF9zeW1ib2wsIHVpbnQgX2luaXRpYWxTdXBwbHksIHVpbnQ4IF9kZWNpbWFscywgYm9vbCBfbWludGFibGUpCiAgICBwdWJsaWMKICAgIFVwZ3JhZGVhYmxlVG9rZW4obXNnLnNlbmRlcikgCiAgewoKICAgIC8vIENyZWF0ZSBhbnkgYWRkcmVzcywgY2FuIGJlIHRyYW5zZmVycmVkCiAgICAvLyB0byB0ZWFtIG11bHRpc2lnIHZpYSBjaGFuZ2VPd25lcigpLAogICAgLy8gYWxzbyByZW1lbWJlciB0byBjYWxsIHNldFVwZ3JhZGVNYXN0ZXIoKQogICAgb3duZXIgPSBtc2cuc2VuZGVyOwoKICAgIG5hbWUgPSBfbmFtZTsKICAgIHN5bWJvbCA9IF9zeW1ib2w7CgogICAgdG90YWxTdXBwbHkgPSBfaW5pdGlhbFN1cHBseTsKCiAgICBkZWNpbWFscyA9IF9kZWNpbWFsczsKCiAgICAvLyBDcmVhdGUgaW5pdGlhbGx5IGFsbCBiYWxhbmNlIG9uIHRoZSB0ZWFtIG11bHRpc2lnCiAgICBiYWxhbmNlc1tvd25lcl0gPSB0b3RhbFN1cHBseTsKCiAgICBpZih0b3RhbFN1cHBseSA+IDApIHsKICAgICAgTWludGVkKG93bmVyLCB0b3RhbFN1cHBseSk7CiAgICB9CgogICAgLy8gTm8gbW9yZSBuZXcgc3VwcGx5IGFsbG93ZWQgYWZ0ZXIgdGhlIHRva2VuIGNyZWF0aW9uCiAgICBpZighX21pbnRhYmxlKSB7CiAgICAgIG1pbnRpbmdGaW5pc2hlZCA9IHRydWU7CiAgICAgIHJlcXVpcmUodG90YWxTdXBwbHkgIT0gMCk7CiAgICB9CiAgfQoKICAvKioKICAgKiBXaGVuIHRva2VuIGlzIHJlbGVhc2VkIHRvIGJlIHRyYW5zZmVyYWJsZSwgZW5mb3JjZSBubyBuZXcgdG9rZW5zIGNhbiBiZSBjcmVhdGVkLgogICAqLwogIGZ1bmN0aW9uIHJlbGVhc2VUb2tlblRyYW5zZmVyKCkgcHVibGljIG9ubHlSZWxlYXNlQWdlbnQgewogICAgbWludGluZ0ZpbmlzaGVkID0gdHJ1ZTsKICAgIHN1cGVyLnJlbGVhc2VUb2tlblRyYW5zZmVyKCk7CiAgfQogIAoKICAvKioKICAgKiBBbGxvdyB1cGdyYWRlIGFnZW50IGZ1bmN0aW9uYWxpdHkga2ljayBpbiBvbmx5IGlmIHRoZSBjcm93ZHNhbGUgd2FzIHN1Y2Nlc3MuCiAgICovCiAgZnVuY3Rpb24gY2FuVXBncmFkZSgpIHB1YmxpYyB2aWV3IHJldHVybnMoYm9vbCkgewogICAgcmV0dXJuIHJlbGVhc2VkICYmIHN1cGVyLmNhblVwZ3JhZGUoKTsKICB9CgogIC8qKgogICAqIE93bmVyIGNhbiB1cGRhdGUgdG9rZW4gaW5mb3JtYXRpb24gaGVyZQogICAqLwogIGZ1bmN0aW9uIHNldFRva2VuSW5mb3JtYXRpb24oc3RyaW5nIF9uYW1lLCBzdHJpbmcgX3N5bWJvbCkgb25seU93bmVyIHB1YmxpYyB7CiAgICBuYW1lID0gX25hbWU7CiAgICBzeW1ib2wgPSBfc3ltYm9sOwogICAgVXBkYXRlZFRva2VuSW5mb3JtYXRpb24obmFtZSwgc3ltYm9sKTsKICB9CgoKfQoKLyoqCiAqIEZpbmFsaXplIGFnZW50IGRlZmluZXMgd2hhdCBoYXBwZW5zIGF0IHRoZSBlbmQgb2Ygc3VjY2VzZWZ1bCBjcm93ZHNhbGUuCiAqCiAqIC0gQWxsb2NhdGUgdG9rZW5zIGZvciBmb3VuZGVycywgYm91bnRpZXMgYW5kIGNvbW11bml0eQogKiAtIE1ha2UgdG9rZW5zIHRyYW5zZmVyYWJsZQogKiAtIGV0Yy4KICovCmNvbnRyYWN0IEZpbmFsaXplQWdlbnQgewoKICBmdW5jdGlvbiBpc0ZpbmFsaXplQWdlbnQoKSBwdWJsaWMgcHVyZSByZXR1cm5zKGJvb2wpIHsKICAgIHJldHVybiB0cnVlOwogIH0KCiAgLyoqIFJldHVybiB0cnVlIGlmIHdlIGNhbiBydW4gZmluYWxpemVDcm93ZHNhbGUoKSBwcm9wZXJseS4KICAgKgogICAqIFRoaXMgaXMgYSBzYWZldHkgY2hlY2sgZnVuY3Rpb24gdGhhdCBkb2Vzbid0IGFsbG93IGNyb3dkc2FsZSB0byBiZWdpbgogICAqIHVubGVzcyB0aGUgZmluYWxpemVyIGhhcyBiZWVuIHNldCB1cCBwcm9wZXJseS4KICAgKi8KICBmdW5jdGlvbiBpc1NhbmUoKSBwdWJsaWMgdmlldyByZXR1cm5zIChib29sKTsKCiAgLyoqIENhbGxlZCBvbmNlIGJ5IGNyb3dkc2FsZSBmaW5hbGl6ZSgpIGlmIHRoZSBzYWxlIHdhcyBzdWNjZXNzLiAqLwogIGZ1bmN0aW9uIGZpbmFsaXplQ3Jvd2RzYWxlKCkgcHVibGljIDsKCn0KCi8qKgogKiBJbnRlcmZhY2UgZm9yIGRlZmluaW5nIGNyb3dkc2FsZSBwcmljaW5nLgogKi8KY29udHJhY3QgUHJpY2luZ1N0cmF0ZWd5IHsKCiAgLyoqIEludGVyZmFjZSBkZWNsYXJhdGlvbi4gKi8KICBmdW5jdGlvbiBpc1ByaWNpbmdTdHJhdGVneSgpIHB1YmxpYyBwdXJlIHJldHVybnMgKGJvb2wpIHsKICAgIHJldHVybiB0cnVlOwogIH0KCiAgLyoqIFNlbGYgY2hlY2sgaWYgYWxsIHJlZmVyZW5jZXMgYXJlIGNvcnJlY3RseSBzZXQuCiAgICoKICAgKiBDaGVja3MgdGhhdCBwcmljaW5nIHN0cmF0ZWd5IG1hdGNoZXMgY3Jvd2RzYWxlIHBhcmFtZXRlcnMuCiAgICovCiAgZnVuY3Rpb24gaXNTYW5lKGFkZHJlc3MgY3Jvd2RzYWxlKSBwdWJsaWMgdmlldyByZXR1cm5zIChib29sKSB7CiAgICByZXR1cm4gdHJ1ZTsKICB9CgogIC8qKgogICAqIFdoZW4gc29tZWJvZHkgdHJpZXMgdG8gYnV5IHRva2VucyBmb3IgWCBldGgsIGNhbGN1bGF0ZSBob3cgbWFueSB0b2tlbnMgdGhleSBnZXQuCiAgICoKICAgKgogICAqIEBwYXJhbSB2YWx1ZSAtIFdoYXQgaXMgdGhlIHZhbHVlIG9mIHRoZSB0cmFuc2FjdGlvbiBzZW5kIGluIGFzIHdlaQogICAqIEBwYXJhbSB0b2tlbnNTb2xkIC0gaG93IG11Y2ggdG9rZW5zIGhhdmUgYmVlbiBzb2xkIHRoaXMgZmFyCiAgICogQHBhcmFtIHdlaVJhaXNlZCAtIGhvdyBtdWNoIG1vbmV5IGhhcyBiZWVuIHJhaXNlZCB0aGlzIGZhcgogICAqIEBwYXJhbSBtc2dTZW5kZXIgLSB3aG8gaXMgdGhlIGludmVzdG9yIG9mIHRoaXMgdHJhbnNhY3Rpb24KICAgKiBAcGFyYW0gZGVjaW1hbHMgLSBob3cgbWFueSBkZWNpbWFsIHVuaXRzIHRoZSB0b2tlbiBoYXMKICAgKiBAcmV0dXJuIEFtb3VudCBvZiB0b2tlbnMgdGhlIGludmVzdG9yIHJlY2VpdmVzCiAgICovCiAgZnVuY3Rpb24gY2FsY3VsYXRlUHJpY2UodWludDI1NiB2YWx1ZSwgdWludDI1NiB3ZWlSYWlzZWQsIHVpbnQyNTYgdG9rZW5zU29sZCwgYWRkcmVzcyBtc2dTZW5kZXIsIHVpbnQyNTYgZGVjaW1hbHMpIHB1YmxpYyBjb25zdGFudCByZXR1cm5zICh1aW50MjU2IHRva2VuQW1vdW50KTsKfQoKLyoKICogSGFsdGFibGUKICoKICogQWJzdHJhY3QgY29udHJhY3QgdGhhdCBhbGxvd3MgY2hpbGRyZW4gdG8gaW1wbGVtZW50IGFuCiAqIGVtZXJnZW5jeSBzdG9wIG1lY2hhbmlzbS4gRGlmZmVycyBmcm9tIFBhdXNhYmxlIGJ5IGNhdXNpbmcgYSB0aHJvdyB3aGVuIGluIGhhbHQgbW9kZS4KICoKICoKICogT3JpZ2luYWxseSBlbnZpc2lvbmVkIGluIEZpcnN0Qmxvb2QgSUNPIGNvbnRyYWN0LgogKi8KY29udHJhY3QgSGFsdGFibGUgaXMgT3duYWJsZSB7CiAgYm9vbCBwdWJsaWMgaGFsdGVkOwoKICBtb2RpZmllciBzdG9wSW5FbWVyZ2VuY3kgewogICAgcmVxdWlyZSghaGFsdGVkKTsKICAgIF87CiAgfQoKICBtb2RpZmllciBvbmx5SW5FbWVyZ2VuY3kgewogICAgcmVxdWlyZShoYWx0ZWQpOwogICAgXzsKICB9CgogIC8vIGNhbGxlZCBieSB0aGUgb3duZXIgb24gZW1lcmdlbmN5LCB0cmlnZ2VycyBzdG9wcGVkIHN0YXRlCiAgZnVuY3Rpb24gaGFsdCgpIGV4dGVybmFsIG9ubHlPd25lciB7CiAgICBoYWx0ZWQgPSB0cnVlOwogIH0KCiAgLy8gY2FsbGVkIGJ5IHRoZSBvd25lciBvbiBlbmQgb2YgZW1lcmdlbmN5LCByZXR1cm5zIHRvIG5vcm1hbCBzdGF0ZQogIGZ1bmN0aW9uIHVuaGFsdCgpIGV4dGVybmFsIG9ubHlPd25lciBvbmx5SW5FbWVyZ2VuY3kgewogICAgaGFsdGVkID0gZmFsc2U7CiAgfQoKfQoKCi8qKgogKiBBYnN0cmFjdCBiYXNlIGNvbnRyYWN0IGZvciB0b2tlbiBzYWxlcy4KICoKICogSGFuZGxlCiAqIC0gc3RhcnQgYW5kIGVuZCBkYXRlcwogKiAtIGFjY2VwdGluZyBpbnZlc3RtZW50cwogKiAtIG1pbmltdW0gZnVuZGluZyBnb2FsIGFuZCByZWZ1bmQKICogLSB2YXJpb3VzIHN0YXRpc3RpY3MgZHVyaW5nIHRoZSBjcm93ZGZ1bmQKICogLSBkaWZmZXJlbnQgcHJpY2luZyBzdHJhdGVnaWVzCiAqIC0gZGlmZmVyZW50IGludmVzdG1lbnQgcG9saWNpZXMgKHJlcXVpcmUgc2VydmVyIHNpZGUgY3VzdG9tZXIgaWQsIGFsbG93IG9ubHkgd2hpdGVsaXN0ZWQgYWRkcmVzc2VzKQogKgogKi8KY29udHJhY3QgQ3Jvd2RzYWxlIGlzIEFsbG9jYXRhYmxlLCBIYWx0YWJsZSwgU2FmZU1hdGhMaWIgewoKICAvKiBNYXggaW52ZXN0bWVudCBjb3VudCB3aGVuIHdlIGFyZSBzdGlsbCBhbGxvd2VkIHRvIGNoYW5nZSB0aGUgbXVsdGlzaWcgYWRkcmVzcyAqLwogIHVpbnQgcHVibGljIE1BWF9JTlZFU1RNRU5UU19CRUZPUkVfTVVMVElTSUdfQ0hBTkdFID0gNTsKCiAgLyogVGhlIHRva2VuIHdlIGFyZSBzZWxsaW5nICovCiAgRnJhY3Rpb25hbEVSQzIwIHB1YmxpYyB0b2tlbjsKCiAgLyogVG9rZW4gVmVzdGluZyBDb250cmFjdCAqLwogIGFkZHJlc3MgcHVibGljIHRva2VuVmVzdGluZ0FkZHJlc3M7CgogIC8qIEhvdyB3ZSBhcmUgZ29pbmcgdG8gcHJpY2Ugb3VyIG9mZmVyaW5nICovCiAgUHJpY2luZ1N0cmF0ZWd5IHB1YmxpYyBwcmljaW5nU3RyYXRlZ3k7CgogIC8qIFBvc3Qtc3VjY2VzcyBjYWxsYmFjayAqLwogIEZpbmFsaXplQWdlbnQgcHVibGljIGZpbmFsaXplQWdlbnQ7CgogIC8qIHRva2VucyB3aWxsIGJlIHRyYW5zZmVyZWQgZnJvbSB0aGlzIGFkZHJlc3MgKi8KICBhZGRyZXNzIHB1YmxpYyBtdWx0aXNpZ1dhbGxldDsKCiAgLyogaWYgdGhlIGZ1bmRpbmcgZ29hbCBpcyBub3QgcmVhY2hlZCwgaW52ZXN0b3JzIG1heSB3aXRoZHJhdyB0aGVpciBmdW5kcyAqLwogIHVpbnQyNTYgcHVibGljIG1pbmltdW1GdW5kaW5nR29hbDsKCiAgLyogdGhlIFVOSVggdGltZXN0YW1wIHN0YXJ0IGRhdGUgb2YgdGhlIGNyb3dkc2FsZSAqLwogIHVpbnQyNTYgcHVibGljIHN0YXJ0c0F0OwoKICAvKiB0aGUgVU5JWCB0aW1lc3RhbXAgZW5kIGRhdGUgb2YgdGhlIGNyb3dkc2FsZSAqLwogIHVpbnQyNTYgcHVibGljIGVuZHNBdDsKCiAgLyogdGhlIG51bWJlciBvZiB0b2tlbnMgYWxyZWFkeSBzb2xkIHRocm91Z2ggdGhpcyBjb250cmFjdCovCiAgdWludDI1NiBwdWJsaWMgdG9rZW5zU29sZCA9IDA7CgogIC8qIEhvdyBtYW55IHdlaSBvZiBmdW5kaW5nIHdlIGhhdmUgcmFpc2VkICovCiAgdWludDI1NiBwdWJsaWMgd2VpUmFpc2VkID0gMDsKCiAgLyogSG93IG1hbnkgZGlzdGluY3QgYWRkcmVzc2VzIGhhdmUgaW52ZXN0ZWQgKi8KICB1aW50MjU2IHB1YmxpYyBpbnZlc3RvckNvdW50ID0gMDsKCiAgLyogSG93IG11Y2ggd2VpIHdlIGhhdmUgcmV0dXJuZWQgYmFjayB0byB0aGUgY29udHJhY3QgYWZ0ZXIgYSBmYWlsZWQgY3Jvd2RmdW5kLiAqLwogIHVpbnQyNTYgcHVibGljIGxvYWRlZFJlZnVuZCA9IDA7CgogIC8qIEhvdyBtdWNoIHdlaSB3ZSBoYXZlIGdpdmVuIGJhY2sgdG8gaW52ZXN0b3JzLiovCiAgdWludDI1NiBwdWJsaWMgd2VpUmVmdW5kZWQgPSAwOwoKICAvKiBIYXMgdGhpcyBjcm93ZHNhbGUgYmVlbiBmaW5hbGl6ZWQgKi8KICBib29sIHB1YmxpYyBmaW5hbGl6ZWQ7CgogIC8qIERvIHdlIG5lZWQgdG8gaGF2ZSB1bmlxdWUgY29udHJpYnV0b3IgaWQgZm9yIGVhY2ggY3VzdG9tZXIgKi8KICBib29sIHB1YmxpYyByZXF1aXJlQ3VzdG9tZXJJZDsKCiAgLyoqCiAgICAqIERvIHdlIHZlcmlmeSB0aGF0IGNvbnRyaWJ1dG9yIGhhcyBiZWVuIGNsZWFyZWQgb24gdGhlIHNlcnZlciBzaWRlIChhY2NyZWRpdGVkIGludmVzdG9ycyBvbmx5KS4KICAgICogVGhpcyBtZXRob2Qgd2FzIGZpcnN0IHVzZWQgaW4gRmlyc3RCbG9vZCBjcm93ZHNhbGUgdG8gZW5zdXJlIGFsbCBjb250cmlidXRvcnMgaGF2ZSBhY2NlcHRlZCB0ZXJtcyBvbiBzYWxlIChvbiB0aGUgd2ViKS4KICAgICovCiAgYm9vbCBwdWJsaWMgcmVxdWlyZWRTaWduZWRBZGRyZXNzOwoKICAvKiBTZXJ2ZXIgc2lkZSBhZGRyZXNzIHRoYXQgc2lnbmVkIGFsbG93ZWQgY29udHJpYnV0b3JzIChFdGhlcmV1bSBhZGRyZXNzZXMpIHRoYXQgY2FuIHBhcnRpY2lwYXRlIHRoZSBjcm93ZHNhbGUgKi8KICBhZGRyZXNzIHB1YmxpYyBzaWduZXJBZGRyZXNzOwoKICAvKiogSG93IG11Y2ggRVRIIGVhY2ggYWRkcmVzcyBoYXMgaW52ZXN0ZWQgdG8gdGhpcyBjcm93ZHNhbGUgKi8KICBtYXBwaW5nIChhZGRyZXNzID0+IHVpbnQyNTYpIHB1YmxpYyBpbnZlc3RlZEFtb3VudE9mOwoKICAvKiogSG93IG11Y2ggdG9rZW5zIHRoaXMgY3Jvd2RzYWxlIGhhcyBjcmVkaXRlZCBmb3IgZWFjaCBpbnZlc3RvciBhZGRyZXNzICovCiAgbWFwcGluZyAoYWRkcmVzcyA9PiB1aW50MjU2KSBwdWJsaWMgdG9rZW5BbW91bnRPZjsKCiAgLyoqIEFkZHJlc3NlcyB0aGF0IGFyZSBhbGxvd2VkIHRvIGludmVzdCBldmVuIGJlZm9yZSBJQ08gb2ZmaWNhbCBvcGVucy4gRm9yIHRlc3RpbmcsIGZvciBJQ08gcGFydG5lcnMsIGV0Yy4gKi8KICBtYXBwaW5nIChhZGRyZXNzID0+IGJvb2wpIHB1YmxpYyBlYXJseVBhcnRpY2lwYW50V2hpdGVsaXN0OwoKICAvKiogVGhpcyBpcyBmb3IgbWFudWwgdGVzdGluZyBmb3IgdGhlIGludGVyYWN0aW9uIGZyb20gb3duZXIgd2FsbGV0LiBZb3UgY2FuIHNldCBpdCB0byBhbnkgdmFsdWUgYW5kIGluc3BlY3QgdGhpcyBpbiBibG9ja2NoYWluIGV4cGxvcmVyIHRvIHNlZSB0aGF0IGNyb3dkc2FsZSBpbnRlcmFjdGlvbiB3b3Jrcy4gKi8KICB1aW50MjU2IHB1YmxpYyBvd25lclRlc3RWYWx1ZTsKCiAgLyoqIFN0YXRlIG1hY2hpbmUKICAgKgogICAqIC0gUHJlcGFyaW5nOiBBbGwgY29udHJhY3QgaW5pdGlhbGl6YXRpb24gY2FsbHMgYW5kIHZhcmlhYmxlcyBoYXZlIG5vdCBiZWVuIHNldCB5ZXQKICAgKiAtIFByZWZ1bmRpbmc6IFdlIGhhdmUgbm90IHBhc3NlZCBzdGFydCB0aW1lIHlldAogICAqIC0gRnVuZGluZzogQWN0aXZlIGNyb3dkc2FsZQogICAqIC0gU3VjY2VzczogTWluaW11bSBmdW5kaW5nIGdvYWwgcmVhY2hlZAogICAqIC0gRmFpbHVyZTogTWluaW11bSBmdW5kaW5nIGdvYWwgbm90IHJlYWNoZWQgYmVmb3JlIGVuZGluZyB0aW1lCiAgICogLSBGaW5hbGl6ZWQ6IFRoZSBmaW5hbGl6ZWQgaGFzIGJlZW4gY2FsbGVkIGFuZCBzdWNjZXNmdWxseSBleGVjdXRlZAogICAqIC0gUmVmdW5kaW5nOiBSZWZ1bmRzIGFyZSBsb2FkZWQgb24gdGhlIGNvbnRyYWN0IGZvciByZWNsYWltLgogICAqLwogIGVudW0gU3RhdGV7VW5rbm93biwgUHJlcGFyaW5nLCBQcmVGdW5kaW5nLCBGdW5kaW5nLCBTdWNjZXNzLCBGYWlsdXJlLCBGaW5hbGl6ZWQsIFJlZnVuZGluZ30KCiAgLy8gQSBuZXcgaW52ZXN0bWVudCB3YXMgbWFkZQogIGV2ZW50IEludmVzdGVkKGFkZHJlc3MgaW52ZXN0b3IsIHVpbnQyNTYgd2VpQW1vdW50LCB1aW50MjU2IHRva2VuQW1vdW50LCBzdHJpbmcgY3VzdElkKTsKCiAgLy8gUmVmdW5kIHdhcyBwcm9jZXNzZWQgZm9yIGEgY29udHJpYnV0b3IKICBldmVudCBSZWZ1bmQoYWRkcmVzcyBpbnZlc3RvciwgdWludDI1NiB3ZWlBbW91bnQpOwoKICAvLyBUaGUgcnVsZXMgd2VyZSBjaGFuZ2VkIHdoYXQga2luZCBvZiBpbnZlc3RtZW50cyB3ZSBhY2NlcHQKICBldmVudCBJbnZlc3RtZW50UG9saWN5Q2hhbmdlZChib29sIHJlcXVpcmVDdXN0SWQsIGJvb2wgcmVxdWlyZWRTaWduZWRBZGRyLCBhZGRyZXNzIHNpZ25lckFkZHIpOwoKICAvLyBBZGRyZXNzIGVhcmx5IHBhcnRpY2lwYXRpb24gd2hpdGVsaXN0IHN0YXR1cyBjaGFuZ2VkCiAgZXZlbnQgV2hpdGVsaXN0ZWQoYWRkcmVzcyBhZGRyLCBib29sIHN0YXR1cyk7CgogIC8vIENyb3dkc2FsZSBlbmQgdGltZSBoYXMgYmVlbiBjaGFuZ2VkCiAgZXZlbnQgRW5kc0F0Q2hhbmdlZCh1aW50MjU2IGVuZEF0KTsKCiAgZnVuY3Rpb24gQ3Jvd2RzYWxlKGFkZHJlc3MgX3Rva2VuLCBQcmljaW5nU3RyYXRlZ3kgX3ByaWNpbmdTdHJhdGVneSwgYWRkcmVzcyBfbXVsdGlzaWdXYWxsZXQsIAogIHVpbnQyNTYgX3N0YXJ0LCB1aW50MjU2IF9lbmQsIHVpbnQyNTYgX21pbmltdW1GdW5kaW5nR29hbCwgYWRkcmVzcyBfdG9rZW5WZXN0aW5nQWRkcmVzcykgcHVibGljIHsKCiAgICBvd25lciA9IG1zZy5zZW5kZXI7CgogICAgdG9rZW4gPSBGcmFjdGlvbmFsRVJDMjAoX3Rva2VuKTsKCiAgICB0b2tlblZlc3RpbmdBZGRyZXNzID0gX3Rva2VuVmVzdGluZ0FkZHJlc3M7CgogICAgc2V0UHJpY2luZ1N0cmF0ZWd5KF9wcmljaW5nU3RyYXRlZ3kpOwoKICAgIG11bHRpc2lnV2FsbGV0ID0gX211bHRpc2lnV2FsbGV0OwogICAgcmVxdWlyZShtdWx0aXNpZ1dhbGxldCAhPSAwKTsKCiAgICByZXF1aXJlKF9zdGFydCAhPSAwKTsKCiAgICBzdGFydHNBdCA9IF9zdGFydDsKCiAgICByZXF1aXJlKF9lbmQgIT0gMCk7CgogICAgZW5kc0F0ID0gX2VuZDsKCiAgICAvLyBEb24ndCBtZXNzIHRoZSBkYXRlcwogICAgcmVxdWlyZShzdGFydHNBdCA8IGVuZHNBdCk7CgogICAgLy8gTWluaW11bSBmdW5kaW5nIGdvYWwgY2FuIGJlIHplcm8KICAgIG1pbmltdW1GdW5kaW5nR29hbCA9IF9taW5pbXVtRnVuZGluZ0dvYWw7CiAgfQoKICAvKioKICAgKiBEb24ndCBleHBlY3QgdG8ganVzdCBzZW5kIGluIG1vbmV5IGFuZCBnZXQgdG9rZW5zLgogICAqLwogIGZ1bmN0aW9uKCkgcGF5YWJsZSBwdWJsaWMgewogICAgcmVxdWlyZShmYWxzZSk7CiAgfQoKICAvKioKICAgKiBNYWtlIGFuIGludmVzdG1lbnQuCiAgICoKICAgKiBDcm93ZHNhbGUgbXVzdCBiZSBydW5uaW5nIGZvciBvbmUgdG8gaW52ZXN0LgogICAqIFdlIG11c3QgaGF2ZSBub3QgcHJlc3NlZCB0aGUgZW1lcmdlbmN5IGJyYWtlLgogICAqCiAgICogQHBhcmFtIHJlY2VpdmVyIFRoZSBFdGhlcmV1bSBhZGRyZXNzIHdobyByZWNlaXZlcyB0aGUgdG9rZW5zCiAgICogQHBhcmFtIGN1c3RvbWVySWQgKG9wdGlvbmFsKSBVVUlEIHY0IHRvIHRyYWNrIHRoZSBzdWNjZXNzZnVsIHBheW1lbnRzIG9uIHRoZSBzZXJ2ZXIgc2lkZQogICAqCiAgICovCiAgZnVuY3Rpb24gaW52ZXN0SW50ZXJuYWwoYWRkcmVzcyByZWNlaXZlciwgc3RyaW5nIGN1c3RvbWVySWQpIHN0b3BJbkVtZXJnZW5jeSBwcml2YXRlIHsKCiAgICAvLyBEZXRlcm1pbmUgaWYgaXQncyBhIGdvb2QgdGltZSB0byBhY2NlcHQgaW52ZXN0bWVudCBmcm9tIHRoaXMgcGFydGljaXBhbnQKICAgIGlmKGdldFN0YXRlKCkgPT0gU3RhdGUuUHJlRnVuZGluZykgewogICAgICAvLyBBcmUgd2Ugd2hpdGVsaXN0ZWQgZm9yIGVhcmx5IGRlcG9zaXQKICAgICAgcmVxdWlyZShlYXJseVBhcnRpY2lwYW50V2hpdGVsaXN0W3JlY2VpdmVyXSk7CiAgICAKICAgIH0gZWxzZSBpZihnZXRTdGF0ZSgpID09IFN0YXRlLkZ1bmRpbmcpIHsKICAgICAgLy8gUmV0YWlsIHBhcnRpY2lwYW50cyBjYW4gb25seSBjb21lIGluIHdoZW4gdGhlIGNyb3dkc2FsZSBpcyBydW5uaW5nCiAgICB9IGVsc2UgewogICAgICAvLyBVbndhbnRlZCBzdGF0ZQogICAgICByZXF1aXJlKGZhbHNlKTsKICAgIH0KCiAgICB1aW50IHdlaUFtb3VudCA9IG1zZy52YWx1ZTsKICAgIHVpbnQgdG9rZW5BbW91bnQgPSBwcmljaW5nU3RyYXRlZ3kuY2FsY3VsYXRlUHJpY2Uod2VpQW1vdW50LCB3ZWlSYWlzZWQsIHRva2Vuc1NvbGQsIG1zZy5zZW5kZXIsIHRva2VuLmRlY2ltYWxzKCkpOwoKICAgIHJlcXVpcmUodG9rZW5BbW91bnQgIT0gMCk7CgoKICAgIGlmKGludmVzdGVkQW1vdW50T2ZbcmVjZWl2ZXJdID09IDApIHsKICAgICAgIC8vIEEgbmV3IGludmVzdG9yCiAgICAgICBpbnZlc3RvckNvdW50Kys7CiAgICB9CgogICAgLy8gVXBkYXRlIGludmVzdG9yCiAgICBpbnZlc3RlZEFtb3VudE9mW3JlY2VpdmVyXSA9IHNhZmVBZGQoaW52ZXN0ZWRBbW91bnRPZltyZWNlaXZlcl0sd2VpQW1vdW50KTsKICAgIHRva2VuQW1vdW50T2ZbcmVjZWl2ZXJdID0gc2FmZUFkZCh0b2tlbkFtb3VudE9mW3JlY2VpdmVyXSx0b2tlbkFtb3VudCk7CgogICAgLy8gVXBkYXRlIHRvdGFscwogICAgd2VpUmFpc2VkID0gc2FmZUFkZCh3ZWlSYWlzZWQsd2VpQW1vdW50KTsKICAgIHRva2Vuc1NvbGQgPSBzYWZlQWRkKHRva2Vuc1NvbGQsdG9rZW5BbW91bnQpOwoKICAgIC8vIENoZWNrIHRoYXQgd2UgZGlkIG5vdCBidXN0IHRoZSBjYXAKICAgIHJlcXVpcmUoIWlzQnJlYWtpbmdDYXAod2VpQW1vdW50LCB0b2tlbkFtb3VudCwgd2VpUmFpc2VkLCB0b2tlbnNTb2xkKSk7CiAgICAvLyBpZihpc0JyZWFraW5nQ2FwKHdlaUFtb3VudCwgdG9rZW5BbW91bnQsIHdlaVJhaXNlZCwgdG9rZW5zU29sZCkpIHsKICAgIC8vICAgdGhyb3c7CiAgICAvLyB9CgogICAgYXNzaWduVG9rZW5zKHJlY2VpdmVyLCB0b2tlbkFtb3VudCk7CgogICAgLy8gUG9ja2V0IHRoZSBtb25leQogICAgcmVxdWlyZShtdWx0aXNpZ1dhbGxldC5zZW5kKHdlaUFtb3VudCkpOwoKICAgIC8vIFRlbGwgdXMgaW52ZXN0IHdhcyBzdWNjZXNzCiAgICBJbnZlc3RlZChyZWNlaXZlciwgd2VpQW1vdW50LCB0b2tlbkFtb3VudCwgY3VzdG9tZXJJZCk7CiAgfQoKICAvKioKICAgKiBhbGxvY2F0ZSB0b2tlbnMgZm9yIHRoZSBlYXJseSBpbnZlc3RvcnMuCiAgICoKICAgKiBQcmVhbGxvY2F0ZWQgdG9rZW5zIGhhdmUgYmVlbiBzb2xkIGJlZm9yZSB0aGUgYWN0dWFsIGNyb3dkc2FsZSBvcGVucy4KICAgKiBUaGlzIGZ1bmN0aW9uIG1pbnRzIHRoZSB0b2tlbnMgYW5kIG1vdmVzIHRoZSBjcm93ZHNhbGUgbmVlZGxlLgogICAqCiAgICogSW52ZXN0b3IgY291bnQgaXMgbm90IGhhbmRsZWQ7IGl0IGlzIGFzc3VtZWQgdGhpcyBnb2VzIGZvciBtdWx0aXBsZSBpbnZlc3RvcnMKICAgKiBhbmQgdGhlIHRva2VuIGRpc3RyaWJ1dGlvbiBoYXBwZW5zIG91dHNpZGUgdGhlIHNtYXJ0IGNvbnRyYWN0IGZsb3cuCiAgICoKICAgKiBObyBtb25leSBpcyBleGNoYW5nZWQsIGFzIHRoZSBjcm93ZHNhbGUgdGVhbSBhbHJlYWR5IGhhdmUgcmVjZWl2ZWQgdGhlIHBheW1lbnQuCiAgICoKICAgKiBAcGFyYW0gd2VpUHJpY2UgUHJpY2Ugb2YgYSBzaW5nbGUgZnVsbCB0b2tlbiBpbiB3ZWkKICAgKgogICAqLwogIGZ1bmN0aW9uIGFsbG9jYXRlKGFkZHJlc3MgcmVjZWl2ZXIsIHVpbnQyNTYgdG9rZW5BbW91bnQsIHVpbnQyNTYgd2VpUHJpY2UsIHN0cmluZyBjdXN0b21lcklkLCAgdWludDI1NiBsb2NrZWRUb2tlbkFtb3VudCkgcHVibGljIG9ubHlBbGxvY2F0ZUFnZW50IHsKCiAgICAvLyBjYW5ub3QgbG9jayBtb3JlIHRoYW4gdG90YWwgdG9rZW5zCiAgICByZXF1aXJlKGxvY2tlZFRva2VuQW1vdW50IDw9IHRva2VuQW1vdW50KTsKCiAgICB1aW50MjU2IHdlaUFtb3VudCA9ICh3ZWlQcmljZSAqIHRva2VuQW1vdW50KS8xMCoqdWludDI1Nih0b2tlbi5kZWNpbWFscygpKTsgLy8gVGhpcyBjYW4gYmUgYWxzbyAwLCB3ZSBnaXZlIG91dCB0b2tlbnMgZm9yIGZyZWUKCiAgICB3ZWlSYWlzZWQgPSBzYWZlQWRkKHdlaVJhaXNlZCx3ZWlBbW91bnQpOwogICAgdG9rZW5zU29sZCA9IHNhZmVBZGQodG9rZW5zU29sZCx0b2tlbkFtb3VudCk7CgogICAgaW52ZXN0ZWRBbW91bnRPZltyZWNlaXZlcl0gPSBzYWZlQWRkKGludmVzdGVkQW1vdW50T2ZbcmVjZWl2ZXJdLHdlaUFtb3VudCk7CiAgICB0b2tlbkFtb3VudE9mW3JlY2VpdmVyXSA9IHNhZmVBZGQodG9rZW5BbW91bnRPZltyZWNlaXZlcl0sdG9rZW5BbW91bnQpOwoKICAgIC8vIGFzc2lnbiBsb2NrZWQgdG9rZW4gdG8gVmVzdGluZyBjb250cmFjdAogICAgaWYgKGxvY2tlZFRva2VuQW1vdW50ID4gMCkgewogICAgICBUb2tlblZlc3RpbmcgdG9rZW5WZXN0aW5nID0gVG9rZW5WZXN0aW5nKHRva2VuVmVzdGluZ0FkZHJlc3MpOwogICAgICAvLyB0byBwcmV2ZW50IG1pbnRpbmcgb2YgdG9rZW5zIHdoaWNoIHdpbGwgYmUgdXNlbGVzcyBhcyB2ZXN0aW5nIGFtb3VudCBjYW5ub3QgYmUgdXBkYXRlZAogICAgICByZXF1aXJlKCF0b2tlblZlc3RpbmcuaXNWZXN0aW5nU2V0KHJlY2VpdmVyKSk7CiAgICAgIGFzc2lnblRva2Vucyh0b2tlblZlc3RpbmdBZGRyZXNzLCBsb2NrZWRUb2tlbkFtb3VudCk7CiAgICAgIC8vIHNldCB2ZXN0aW5nIHdpdGggZGVmYXVsdCBzY2hlZHVsZQogICAgICB0b2tlblZlc3Rpbmcuc2V0VmVzdGluZ1dpdGhEZWZhdWx0U2NoZWR1bGUocmVjZWl2ZXIsIGxvY2tlZFRva2VuQW1vdW50KTsgCiAgICB9CgogICAgLy8gYXNzaWduIHJlbWFpbmluZyB0b2tlbnMgdG8gY29udHJpYnV0b3IKICAgIGlmICh0b2tlbkFtb3VudCAtIGxvY2tlZFRva2VuQW1vdW50ID4gMCkgewogICAgICBhc3NpZ25Ub2tlbnMocmVjZWl2ZXIsIHRva2VuQW1vdW50IC0gbG9ja2VkVG9rZW5BbW91bnQpOwogICAgfQoKICAgIC8vIFRlbGwgdXMgaW52ZXN0IHdhcyBzdWNjZXNzCiAgICBJbnZlc3RlZChyZWNlaXZlciwgd2VpQW1vdW50LCB0b2tlbkFtb3VudCwgY3VzdG9tZXJJZCk7CiAgfQoKICAvKioKICAgKiBUcmFjayB3aG8gaXMgdGhlIGN1c3RvbWVyIG1ha2luZyB0aGUgcGF5bWVudCBzbyB3ZSBjYW4gc2VuZCB0aGFuayB5b3UgZW1haWwuCiAgICovCiAgZnVuY3Rpb24gaW52ZXN0V2l0aEN1c3RvbWVySWQoYWRkcmVzcyBhZGRyLCBzdHJpbmcgY3VzdG9tZXJJZCkgcHVibGljIHBheWFibGUgewogICAgcmVxdWlyZSghcmVxdWlyZWRTaWduZWRBZGRyZXNzKTsKICAgIC8vaWYocmVxdWlyZWRTaWduZWRBZGRyZXNzKSB0aHJvdzsgLy8gQ3Jvd2RzYWxlIGFsbG93cyBvbmx5IHNlcnZlci1zaWRlIHNpZ25lZCBwYXJ0aWNpcGFudHMKICAgIGJ5dGVzIG1lbW9yeSBjdXN0SWRUZXN0ID0gYnl0ZXMoY3VzdG9tZXJJZCk7CiAgICByZXF1aXJlKGN1c3RJZFRlc3QubGVuZ3RoICE9IDApOwogICAgLy9pZihjdXN0b21lcklkID09IDApIHRocm93OyAgLy8gVVVJRHY0IHNhbml0eSBjaGVjawogICAgaW52ZXN0SW50ZXJuYWwoYWRkciwgY3VzdG9tZXJJZCk7CiAgfQoKICAvKioKICAgKiBBbGxvdyBhbm9ueW1vdXMgY29udHJpYnV0aW9ucyB0byB0aGlzIGNyb3dkc2FsZS4KICAgKi8KICBmdW5jdGlvbiBpbnZlc3QoYWRkcmVzcyBhZGRyKSBwdWJsaWMgcGF5YWJsZSB7CiAgICByZXF1aXJlKCFyZXF1aXJlQ3VzdG9tZXJJZCk7CiAgICAKICAgIHJlcXVpcmUoIXJlcXVpcmVkU2lnbmVkQWRkcmVzcyk7CiAgICBpbnZlc3RJbnRlcm5hbChhZGRyLCAiIik7CiAgfQoKICAvKioKICAgKiBJbnZlc3QgdG8gdG9rZW5zLCByZWNvZ25pemUgdGhlIHBheWVyIGFuZCBjbGVhciBoaXMgYWRkcmVzcy4KICAgKgogICAqLwogIAogIC8vIGZ1bmN0aW9uIGJ1eVdpdGhTaWduZWRBZGRyZXNzKHVpbnQxMjggY3VzdG9tZXJJZCwgdWludDggdiwgYnl0ZXMzMiByLCBieXRlczMyIHMpIHB1YmxpYyBwYXlhYmxlIHsKICAvLyAgIGludmVzdFdpdGhTaWduZWRBZGRyZXNzKG1zZy5zZW5kZXIsIGN1c3RvbWVySWQsIHYsIHIsIHMpOwogIC8vIH0KCiAgLyoqCiAgICogSW52ZXN0IHRvIHRva2VucywgcmVjb2duaXplIHRoZSBwYXllci4KICAgKgogICAqLwogIGZ1bmN0aW9uIGJ1eVdpdGhDdXN0b21lcklkKHN0cmluZyBjdXN0b21lcklkKSBwdWJsaWMgcGF5YWJsZSB7CiAgICBpbnZlc3RXaXRoQ3VzdG9tZXJJZChtc2cuc2VuZGVyLCBjdXN0b21lcklkKTsKICB9CgogIC8qKgogICAqIFRoZSBiYXNpYyBlbnRyeSBwb2ludCB0byBwYXJ0aWNpcGF0ZSB0aGUgY3Jvd2RzYWxlIHByb2Nlc3MuCiAgICoKICAgKiBQYXkgZm9yIGZ1bmRpbmcsIGdldCBpbnZlc3RlZCB0b2tlbnMgYmFjayBpbiB0aGUgc2VuZGVyIGFkZHJlc3MuCiAgICovCiAgZnVuY3Rpb24gYnV5KCkgcHVibGljIHBheWFibGUgewogICAgaW52ZXN0KG1zZy5zZW5kZXIpOwogIH0KCiAgLyoqCiAgICogRmluYWxpemUgYSBzdWNjY2VzZnVsIGNyb3dkc2FsZS4KICAgKgogICAqIFRoZSBvd25lciBjYW4gdHJpZ2dyZSBhIGNhbGwgdGhlIGNvbnRyYWN0IHRoYXQgcHJvdmlkZXMgcG9zdC1jcm93ZHNhbGUgYWN0aW9ucywgbGlrZSByZWxlYXNpbmcgdGhlIHRva2Vucy4KICAgKi8KICBmdW5jdGlvbiBmaW5hbGl6ZSgpIHB1YmxpYyBpblN0YXRlKFN0YXRlLlN1Y2Nlc3MpIG9ubHlPd25lciBzdG9wSW5FbWVyZ2VuY3kgewoKICAgIC8vIEFscmVhZHkgZmluYWxpemVkCiAgICByZXF1aXJlKCFmaW5hbGl6ZWQpOwoKICAgIC8vIEZpbmFsaXppbmcgaXMgb3B0aW9uYWwuIFdlIG9ubHkgY2FsbCBpdCBpZiB3ZSBhcmUgZ2l2ZW4gYSBmaW5hbGl6aW5nIGFnZW50LgogICAgaWYoYWRkcmVzcyhmaW5hbGl6ZUFnZW50KSAhPSAwKSB7CiAgICAgIGZpbmFsaXplQWdlbnQuZmluYWxpemVDcm93ZHNhbGUoKTsKICAgIH0KCiAgICBmaW5hbGl6ZWQgPSB0cnVlOwogIH0KCiAgLyoqCiAgICogQWxsb3cgdG8gKHJlKXNldCBmaW5hbGl6ZSBhZ2VudC4KICAgKgogICAqIERlc2lnbiBjaG9pY2U6IG5vIHN0YXRlIHJlc3RyaWN0aW9ucyBvbiBzZXR0aW5nIHRoaXMsIHNvIHRoYXQgd2UgY2FuIGZpeCBmYXQgZmluZ2VyIG1pc3Rha2VzLgogICAqLwogIGZ1bmN0aW9uIHNldEZpbmFsaXplQWdlbnQoRmluYWxpemVBZ2VudCBhZGRyKSBwdWJsaWMgb25seU93bmVyIHsKICAgIGZpbmFsaXplQWdlbnQgPSBhZGRyOwoKICAgIC8vIERvbid0IGFsbG93IHNldHRpbmcgYmFkIGFnZW50CiAgICByZXF1aXJlKGZpbmFsaXplQWdlbnQuaXNGaW5hbGl6ZUFnZW50KCkpOwogIH0KCiAgLyoqCiAgICogU2V0IHBvbGljeSBkbyB3ZSBuZWVkIHRvIGhhdmUgc2VydmVyLXNpZGUgY3VzdG9tZXIgaWRzIGZvciB0aGUgaW52ZXN0bWVudHMuCiAgICoKICAgKi8KICBmdW5jdGlvbiBzZXRSZXF1aXJlQ3VzdG9tZXJJZChib29sIHZhbHVlKSBwdWJsaWMgb25seU93bmVyIHsKICAgIHJlcXVpcmVDdXN0b21lcklkID0gdmFsdWU7CiAgICBJbnZlc3RtZW50UG9saWN5Q2hhbmdlZChyZXF1aXJlQ3VzdG9tZXJJZCwgcmVxdWlyZWRTaWduZWRBZGRyZXNzLCBzaWduZXJBZGRyZXNzKTsKICB9CgogIC8qKgogICAqIEFsbG93IGFkZHJlc3NlcyB0byBkbyBlYXJseSBwYXJ0aWNpcGF0aW9uLgogICAqCiAgICogVE9ETzogRml4IHNwZWxsaW5nIGVycm9yIGluIHRoZSBuYW1lCiAgICovCiAgZnVuY3Rpb24gc2V0RWFybHlQYXJpY2lwYW50V2hpdGVsaXN0KGFkZHJlc3MgYWRkciwgYm9vbCBzdGF0dXMpIHB1YmxpYyBvbmx5T3duZXIgewogICAgZWFybHlQYXJ0aWNpcGFudFdoaXRlbGlzdFthZGRyXSA9IHN0YXR1czsKICAgIFdoaXRlbGlzdGVkKGFkZHIsIHN0YXR1cyk7CiAgfQoKICAvKioKICAgKiBBbGxvdyBjcm93ZHNhbGUgb3duZXIgdG8gY2xvc2UgZWFybHkgb3IgZXh0ZW5kIHRoZSBjcm93ZHNhbGUuCiAgICoKICAgKiBUaGlzIGlzIHVzZWZ1bCBlLmcuIGZvciBhIG1hbnVhbCBzb2Z0IGNhcCBpbXBsZW1lbnRhdGlvbjoKICAgKiAtIGFmdGVyIFggYW1vdW50IGlzIHJlYWNoZWQgZGV0ZXJtaW5lIG1hbnVhbCBjbG9zaW5nCiAgICoKICAgKiBUaGlzIG1heSBwdXQgdGhlIGNyb3dkc2FsZSB0byBhbiBpbnZhbGlkIHN0YXRlLAogICAqIGJ1dCB3ZSB0cnVzdCBvd25lcnMga25vdyB3aGF0IHRoZXkgYXJlIGRvaW5nLgogICAqCiAgICovCiAgZnVuY3Rpb24gc2V0RW5kc0F0KHVpbnQgdGltZSkgcHVibGljIG9ubHlPd25lciB7CgogICAgcmVxdWlyZShub3cgPD0gdGltZSk7CgogICAgZW5kc0F0ID0gdGltZTsKICAgIEVuZHNBdENoYW5nZWQoZW5kc0F0KTsKICB9CgogIC8qKgogICAqIEFsbG93IHRvIChyZSlzZXQgcHJpY2luZyBzdHJhdGVneS4KICAgKgogICAqIERlc2lnbiBjaG9pY2U6IG5vIHN0YXRlIHJlc3RyaWN0aW9ucyBvbiB0aGUgc2V0LCBzbyB0aGF0IHdlIGNhbiBmaXggZmF0IGZpbmdlciBtaXN0YWtlcy4KICAgKi8KICBmdW5jdGlvbiBzZXRQcmljaW5nU3RyYXRlZ3koUHJpY2luZ1N0cmF0ZWd5IF9wcmljaW5nU3RyYXRlZ3kpIHB1YmxpYyBvbmx5T3duZXIgewogICAgcHJpY2luZ1N0cmF0ZWd5ID0gX3ByaWNpbmdTdHJhdGVneTsKCiAgICAvLyBEb24ndCBhbGxvdyBzZXR0aW5nIGJhZCBhZ2VudAogICAgcmVxdWlyZShwcmljaW5nU3RyYXRlZ3kuaXNQcmljaW5nU3RyYXRlZ3koKSk7CiAgfQoKICAvKioKICAgKiBBbGxvdyB0byBjaGFuZ2UgdGhlIHRlYW0gbXVsdGlzaWcgYWRkcmVzcyBpbiB0aGUgY2FzZSBvZiBlbWVyZ2VuY3kuCiAgICoKICAgKiBUaGlzIGFsbG93cyB0byBzYXZlIGEgZGVwbG95ZWQgY3Jvd2RzYWxlIHdhbGxldCBpbiB0aGUgY2FzZSB0aGUgY3Jvd2RzYWxlIGhhcyBub3QgeWV0IGJlZ3VuCiAgICogKHdlIGhhdmUgZG9uZSBvbmx5IGZldyB0ZXN0IHRyYW5zYWN0aW9ucykuIEFmdGVyIHRoZSBjcm93ZHNhbGUgaXMgZ29pbmcKICAgKiB0aGVuIG11bHRpc2lnIGFkZHJlc3Mgc3RheXMgbG9ja2VkIGZvciB0aGUgc2FmZXR5IHJlYXNvbnMuCiAgICovCiAgZnVuY3Rpb24gc2V0TXVsdGlzaWcoYWRkcmVzcyBhZGRyKSBwdWJsaWMgb25seU93bmVyIHsKCiAgICAvLyBDaGFuZ2UKICAgIHJlcXVpcmUoaW52ZXN0b3JDb3VudCA8PSBNQVhfSU5WRVNUTUVOVFNfQkVGT1JFX01VTFRJU0lHX0NIQU5HRSk7CgogICAgbXVsdGlzaWdXYWxsZXQgPSBhZGRyOwogIH0KCiAgLyoqCiAgICogQWxsb3cgbG9hZCByZWZ1bmRzIGJhY2sgb24gdGhlIGNvbnRyYWN0IGZvciB0aGUgcmVmdW5kaW5nLgogICAqCiAgICogVGhlIHRlYW0gY2FuIHRyYW5zZmVyIHRoZSBmdW5kcyBiYWNrIG9uIHRoZSBzbWFydCBjb250cmFjdCBpbiB0aGUgY2FzZSB0aGUgbWluaW11bSBnb2FsIHdhcyBub3QgcmVhY2hlZC4uCiAgICovCiAgZnVuY3Rpb24gbG9hZFJlZnVuZCgpIHB1YmxpYyBwYXlhYmxlIGluU3RhdGUoU3RhdGUuRmFpbHVyZSkgewogICAgcmVxdWlyZShtc2cudmFsdWUgIT0gMCk7CiAgICBsb2FkZWRSZWZ1bmQgPSBzYWZlQWRkKGxvYWRlZFJlZnVuZCxtc2cudmFsdWUpOwogIH0KCiAgLyoqCiAgICogSW52ZXN0b3JzIGNhbiBjbGFpbSByZWZ1bmQuCiAgICovCiAgZnVuY3Rpb24gcmVmdW5kKCkgcHVibGljIGluU3RhdGUoU3RhdGUuUmVmdW5kaW5nKSB7CiAgICB1aW50MjU2IHdlaVZhbHVlID0gaW52ZXN0ZWRBbW91bnRPZlttc2cuc2VuZGVyXTsKICAgIHJlcXVpcmUod2VpVmFsdWUgIT0gMCk7CiAgICBpbnZlc3RlZEFtb3VudE9mW21zZy5zZW5kZXJdID0gMDsKICAgIHdlaVJlZnVuZGVkID0gc2FmZUFkZCh3ZWlSZWZ1bmRlZCx3ZWlWYWx1ZSk7CiAgICBSZWZ1bmQobXNnLnNlbmRlciwgd2VpVmFsdWUpOwogICAgcmVxdWlyZShtc2cuc2VuZGVyLnNlbmQod2VpVmFsdWUpKTsKICB9CgogIC8qKgogICAqIEByZXR1cm4gdHJ1ZSBpZiB0aGUgY3Jvd2RzYWxlIGhhcyByYWlzZWQgZW5vdWdoIG1vbmV5IHRvIGJlIGEgc3VjY2VzCiAgICovCiAgZnVuY3Rpb24gaXNNaW5pbXVtR29hbFJlYWNoZWQoKSBwdWJsaWMgY29uc3RhbnQgcmV0dXJucyAoYm9vbCByZWFjaGVkKSB7CiAgICByZXR1cm4gd2VpUmFpc2VkID49IG1pbmltdW1GdW5kaW5nR29hbDsKICB9CgogIC8qKgogICAqIENoZWNrIGlmIHRoZSBjb250cmFjdCByZWxhdGlvbnNoaXAgbG9va3MgZ29vZC4KICAgKi8KICBmdW5jdGlvbiBpc0ZpbmFsaXplclNhbmUoKSBwdWJsaWMgY29uc3RhbnQgcmV0dXJucyAoYm9vbCBzYW5lKSB7CiAgICByZXR1cm4gZmluYWxpemVBZ2VudC5pc1NhbmUoKTsKICB9CgogIC8qKgogICAqIENoZWNrIGlmIHRoZSBjb250cmFjdCByZWxhdGlvbnNoaXAgbG9va3MgZ29vZC4KICAgKi8KICBmdW5jdGlvbiBpc1ByaWNpbmdTYW5lKCkgcHVibGljIGNvbnN0YW50IHJldHVybnMgKGJvb2wgc2FuZSkgewogICAgcmV0dXJuIHByaWNpbmdTdHJhdGVneS5pc1NhbmUoYWRkcmVzcyh0aGlzKSk7CiAgfQoKICAvKioKICAgKiBDcm93ZGZ1bmQgc3RhdGUgbWFjaGluZSBtYW5hZ2VtZW50LgogICAqCiAgICogV2UgbWFrZSBpdCBhIGZ1bmN0aW9uIGFuZCBkbyBub3QgYXNzaWduIHRoZSByZXN1bHQgdG8gYSB2YXJpYWJsZSwgc28gdGhlcmUgaXMgbm8gY2hhbmNlIG9mIHRoZSB2YXJpYWJsZSBiZWluZyBzdGFsZS4KICAgKi8KICBmdW5jdGlvbiBnZXRTdGF0ZSgpIHB1YmxpYyBjb25zdGFudCByZXR1cm5zIChTdGF0ZSkgewogICAgaWYoZmluYWxpemVkKSByZXR1cm4gU3RhdGUuRmluYWxpemVkOwogICAgZWxzZSBpZiAoYWRkcmVzcyhmaW5hbGl6ZUFnZW50KSA9PSAwKSByZXR1cm4gU3RhdGUuUHJlcGFyaW5nOwogICAgZWxzZSBpZiAoIWZpbmFsaXplQWdlbnQuaXNTYW5lKCkpIHJldHVybiBTdGF0ZS5QcmVwYXJpbmc7CiAgICBlbHNlIGlmICghcHJpY2luZ1N0cmF0ZWd5LmlzU2FuZShhZGRyZXNzKHRoaXMpKSkgcmV0dXJuIFN0YXRlLlByZXBhcmluZzsKICAgIGVsc2UgaWYgKGJsb2NrLnRpbWVzdGFtcCA8IHN0YXJ0c0F0KSByZXR1cm4gU3RhdGUuUHJlRnVuZGluZzsKICAgIGVsc2UgaWYgKGJsb2NrLnRpbWVzdGFtcCA8PSBlbmRzQXQgJiYgIWlzQ3Jvd2RzYWxlRnVsbCgpKSByZXR1cm4gU3RhdGUuRnVuZGluZzsKICAgIGVsc2UgaWYgKGlzTWluaW11bUdvYWxSZWFjaGVkKCkpIHJldHVybiBTdGF0ZS5TdWNjZXNzOwogICAgZWxzZSBpZiAoIWlzTWluaW11bUdvYWxSZWFjaGVkKCkgJiYgd2VpUmFpc2VkID4gMCAmJiBsb2FkZWRSZWZ1bmQgPj0gd2VpUmFpc2VkKSByZXR1cm4gU3RhdGUuUmVmdW5kaW5nOwogICAgZWxzZSByZXR1cm4gU3RhdGUuRmFpbHVyZTsKICB9CgogIC8qKiBUaGlzIGlzIGZvciBtYW51YWwgdGVzdGluZyBvZiBtdWx0aXNpZyB3YWxsZXQgaW50ZXJhY3Rpb24gKi8KICBmdW5jdGlvbiBzZXRPd25lclRlc3RWYWx1ZSh1aW50IHZhbCkgcHVibGljIG9ubHlPd25lciB7CiAgICBvd25lclRlc3RWYWx1ZSA9IHZhbDsKICB9CgogIC8qKiBJbnRlcmZhY2UgbWFya2VyLiAqLwogIGZ1bmN0aW9uIGlzQ3Jvd2RzYWxlKCkgcHVibGljIHB1cmUgcmV0dXJucyAoYm9vbCkgewogICAgcmV0dXJuIHRydWU7CiAgfQoKICAvLwogIC8vIE1vZGlmaWVycwogIC8vCgogIC8qKiBNb2RpZmllZCBhbGxvd2luZyBleGVjdXRpb24gb25seSBpZiB0aGUgY3Jvd2RzYWxlIGlzIGN1cnJlbnRseSBydW5uaW5nLiAgKi8KICBtb2RpZmllciBpblN0YXRlKFN0YXRlIHN0YXRlKSB7CiAgICByZXF1aXJlKGdldFN0YXRlKCkgPT0gc3RhdGUpOwogICAgXzsKICB9CgogICAvLwogIC8vIEFic3RyYWN0IGZ1bmN0aW9ucwogIC8vCgogIC8qKgogICAqIENoZWNrIGlmIHRoZSBjdXJyZW50IGludmVzdGVkIGJyZWFrcyBvdXIgY2FwIHJ1bGVzLgogICAqCiAgICoKICAgKiBUaGUgY2hpbGQgY29udHJhY3QgbXVzdCBkZWZpbmUgdGhlaXIgb3duIGNhcCBzZXR0aW5nIHJ1bGVzLgogICAqIFdlIGFsbG93IGEgbG90IG9mIGZsZXhpYmlsaXR5IHRocm91Z2ggZGlmZmVyZW50IGNhcHBpbmcgc3RyYXRlZ2llcyAoRVRILCB0b2tlbiBjb3VudCkKICAgKiBDYWxsZWQgZnJvbSBpbnZlc3QoKS4KICAgKgogICAqIEBwYXJhbSB3ZWlBbW91bnQgVGhlIGFtb3VudCBvZiB3ZWkgdGhlIGludmVzdG9yIHRyaWVzIHRvIGludmVzdCBpbiB0aGUgY3VycmVudCB0cmFuc2FjdGlvbgogICAqIEBwYXJhbSB0b2tlbkFtb3VudCBUaGUgYW1vdW50IG9mIHRva2VucyB3ZSB0cnkgdG8gZ2l2ZSB0byB0aGUgaW52ZXN0b3IgaW4gdGhlIGN1cnJlbnQgdHJhbnNhY3Rpb24KICAgKiBAcGFyYW0gd2VpUmFpc2VkVG90YWwgV2hhdCB3b3VsZCBiZSBvdXIgdG90YWwgcmFpc2VkIGJhbGFuY2UgYWZ0ZXIgdGhpcyB0cmFuc2FjdGlvbgogICAqIEBwYXJhbSB0b2tlbnNTb2xkVG90YWwgV2hhdCB3b3VsZCBiZSBvdXIgdG90YWwgc29sZCB0b2tlbnMgY291bnQgYWZ0ZXIgdGhpcyB0cmFuc2FjdGlvbgogICAqCiAgICogQHJldHVybiB0cnVlIGlmIHRha2luZyB0aGlzIGludmVzdG1lbnQgd291bGQgYnJlYWsgb3VyIGNhcCBydWxlcwogICAqLwogIGZ1bmN0aW9uIGlzQnJlYWtpbmdDYXAodWludCB3ZWlBbW91bnQsIHVpbnQgdG9rZW5BbW91bnQsIHVpbnQgd2VpUmFpc2VkVG90YWwsIHVpbnQgdG9rZW5zU29sZFRvdGFsKSBwdWJsaWMgY29uc3RhbnQgcmV0dXJucyAoYm9vbCBsaW1pdEJyb2tlbik7CiAgLyoqCiAgICogQ2hlY2sgaWYgdGhlIGN1cnJlbnQgY3Jvd2RzYWxlIGlzIGZ1bGwgYW5kIHdlIGNhbiBubyBsb25nZXIgc2VsbCBhbnkgdG9rZW5zLgogICAqLwogIGZ1bmN0aW9uIGlzQ3Jvd2RzYWxlRnVsbCgpIHB1YmxpYyBjb25zdGFudCByZXR1cm5zIChib29sKTsKCiAgLyoqCiAgICogQ3JlYXRlIG5ldyB0b2tlbnMgb3IgdHJhbnNmZXIgaXNzdWVkIHRva2VucyB0byB0aGUgaW52ZXN0b3IgZGVwZW5kaW5nIG9uIHRoZSBjYXAgbW9kZWwuCiAgICovCiAgZnVuY3Rpb24gYXNzaWduVG9rZW5zKGFkZHJlc3MgcmVjZWl2ZXIsIHVpbnQgdG9rZW5BbW91bnQpIHByaXZhdGU7Cgp9CgovKioKICogQXQgdGhlIGVuZCBvZiB0aGUgc3VjY2Vzc2Z1bCBjcm93ZHNhbGUgYWxsb2NhdGUgJSBib251cyBvZiB0b2tlbnMgdG8gdGhlIHRlYW0uCiAqCiAqIFVubG9jayB0b2tlbnMuCiAqCiAqIEJvbnVzQWxsb2NhdGlvbkZpbmFsIG11c3QgYmUgc2V0IGFzIHRoZSBtaW50aW5nIGFnZW50IGZvciB0aGUgTWludGFibGVUb2tlbi4KICoKICovCmNvbnRyYWN0IEJvbnVzRmluYWxpemVBZ2VudCBpcyBGaW5hbGl6ZUFnZW50LCBTYWZlTWF0aExpYiB7CgogIENyb3dkc2FsZVRva2VuIHB1YmxpYyB0b2tlbjsKICBDcm93ZHNhbGUgcHVibGljIGNyb3dkc2FsZTsKCiAgLyoqIFRvdGFsIHBlcmNlbnQgb2YgdG9rZW5zIG1pbnRlZCB0byB0aGUgdGVhbSBhdCB0aGUgZW5kIG9mIHRoZSBzYWxlIGFzIGJhc2UgcG9pbnRzICgwLjAwMDEpICovCiAgdWludDI1NiBwdWJsaWMgdG90YWxNZW1iZXJzOwogIC8vIFBlciBhZGRyZXNzICUgb2YgdG90YWwgdG9rZW4gcmFpc2VkIHRvIGJlIGFzc2lnbmVkIHRvIHRoZSBtZW1iZXIgRXggMSUgaXMgcGFzc2VkIGFzIDEwMAogIHVpbnQyNTYgcHVibGljIGFsbG9jYXRlZEJvbnVzOwogIG1hcHBpbmcgKGFkZHJlc3M9PnVpbnQyNTYpIGJvbnVzT2Y7CiAgLyoqIFdoZXJlIHdlIG1vdmUgdGhlIHRva2VucyBhdCB0aGUgZW5kIG9mIHRoZSBzYWxlLiAqLwogIGFkZHJlc3NbXSBwdWJsaWMgdGVhbUFkZHJlc3NlczsKCgogIGZ1bmN0aW9uIEJvbnVzRmluYWxpemVBZ2VudChDcm93ZHNhbGVUb2tlbiBfdG9rZW4sIENyb3dkc2FsZSBfY3Jvd2RzYWxlLCB1aW50MjU2W10gX2JvbnVzQmFzZVBvaW50cywgYWRkcmVzc1tdIF90ZWFtQWRkcmVzc2VzKSBwdWJsaWMgewogICAgdG9rZW4gPSBfdG9rZW47CiAgICBjcm93ZHNhbGUgPSBfY3Jvd2RzYWxlOwoKICAgIC8vY3Jvd2RzYWxlIGFkZHJlc3MgbXVzdCBub3QgYmUgMAogICAgcmVxdWlyZShhZGRyZXNzKGNyb3dkc2FsZSkgIT0gMCk7CgogICAgLy9ib251cyAmIHRlYW0gYWRkcmVzcyBhcnJheSBzaXplIG11c3QgbWF0Y2gKICAgIHJlcXVpcmUoX2JvbnVzQmFzZVBvaW50cy5sZW5ndGggPT0gX3RlYW1BZGRyZXNzZXMubGVuZ3RoKTsKCiAgICB0b3RhbE1lbWJlcnMgPSBfdGVhbUFkZHJlc3Nlcy5sZW5ndGg7CiAgICB0ZWFtQWRkcmVzc2VzID0gX3RlYW1BZGRyZXNzZXM7CiAgICAKICAgIC8vaWYgYW55IG9mIHRoZSBib251cyBpcyAwIHRocm93CiAgICAvLyBvdGhlcndpc2Ugc3VtIGl0IHVwIGluIHRvdGFsQWxsb2NhdGVkQm9udXMKICAgIGZvciAodWludDI1NiBpPTA7aTx0b3RhbE1lbWJlcnM7aSsrKSB7CiAgICAgIHJlcXVpcmUoX2JvbnVzQmFzZVBvaW50c1tpXSAhPSAwKTsKICAgIH0KCiAgICAvL2lmIGFueSBvZiB0aGUgYWRkcmVzcyBpcyAwIG9yIGludmFsaWQgdGhyb3cKICAgIC8vb3RoZXJ3aXNlIGluaXRpYWxpemUgdGhlIGJvbnVzT2YgYXJyYXkKICAgIGZvciAodWludDI1NiBqPTA7ajx0b3RhbE1lbWJlcnM7aisrKSB7CiAgICAgIHJlcXVpcmUoX3RlYW1BZGRyZXNzZXNbal0gIT0gMCk7CiAgICAgIGJvbnVzT2ZbX3RlYW1BZGRyZXNzZXNbal1dID0gX2JvbnVzQmFzZVBvaW50c1tqXTsKICAgIH0KICB9CgogIC8qIENhbiB3ZSBydW4gZmluYWxpemUgcHJvcGVybHkgKi8KICBmdW5jdGlvbiBpc1NhbmUoKSBwdWJsaWMgdmlldyByZXR1cm5zIChib29sKSB7CiAgICByZXR1cm4gKHRva2VuLm1pbnRBZ2VudHMoYWRkcmVzcyh0aGlzKSkgPT0gdHJ1ZSkgJiYgKHRva2VuLnJlbGVhc2VBZ2VudCgpID09IGFkZHJlc3ModGhpcykpOwogIH0KCiAgLyoqIENhbGxlZCBvbmNlIGJ5IGNyb3dkc2FsZSBmaW5hbGl6ZSgpIGlmIHRoZSBzYWxlIHdhcyBzdWNjZXNzLiAqLwogIGZ1bmN0aW9uIGZpbmFsaXplQ3Jvd2RzYWxlKCkgcHVibGljIHsKCiAgICAvLyBpZiBmaW5hbGl6ZWQgaXMgbm90IGJlaW5nIGNhbGxlZCBmcm9tIHRoZSBjcm93ZHNhbGUgCiAgICAvLyBjb250cmFjdCB0aGVuIHRocm93CiAgICByZXF1aXJlKG1zZy5zZW5kZXIgPT0gYWRkcmVzcyhjcm93ZHNhbGUpKTsKCiAgICAvLyBnZXQgdGhlIHRvdGFsIHNvbGQgdG9rZW5zIGNvdW50LgogICAgdWludCB0b2tlbnNTb2xkID0gY3Jvd2RzYWxlLnRva2Vuc1NvbGQoKTsKCiAgICBmb3IgKHVpbnQyNTYgaT0wO2k8dG90YWxNZW1iZXJzO2krKykgewogICAgICBhbGxvY2F0ZWRCb251cyA9IHNhZmVNdWwodG9rZW5zU29sZCwgYm9udXNPZlt0ZWFtQWRkcmVzc2VzW2ldXSkgLyAxMDAwMDsKICAgICAgLy8gbW92ZSB0b2tlbnMgdG8gdGhlIHRlYW0gbXVsdGlzaWcgd2FsbGV0CiAgICAgIHRva2VuLm1pbnQodGVhbUFkZHJlc3Nlc1tpXSwgYWxsb2NhdGVkQm9udXMpOwogICAgfQoKICAgIHRva2VuLnJlbGVhc2VUb2tlblRyYW5zZmVyKCk7CiAgfQoKfQoKLyoqCiAqIElDTyBjcm93ZHNhbGUgY29udHJhY3QgdGhhdCBpcyBjYXBwZWQgYnkgYW1vdXQgb2YgRVRILgogKgogKiAtIFRva2VucyBhcmUgZHluYW1pY2FsbHkgY3JlYXRlZCBkdXJpbmcgdGhlIGNyb3dkc2FsZQogKgogKgogKi8KY29udHJhY3QgTWludGVkRXRoQ2FwcGVkQ3Jvd2RzYWxlIGlzIENyb3dkc2FsZSB7CgogIC8qIE1heGltdW0gYW1vdW50IG9mIHdlaSB0aGlzIGNyb3dkc2FsZSBjYW4gcmFpc2UuICovCiAgdWludCBwdWJsaWMgd2VpQ2FwOwoKICBmdW5jdGlvbiBNaW50ZWRFdGhDYXBwZWRDcm93ZHNhbGUoYWRkcmVzcyBfdG9rZW4sIFByaWNpbmdTdHJhdGVneSBfcHJpY2luZ1N0cmF0ZWd5LCAKICAgIGFkZHJlc3MgX211bHRpc2lnV2FsbGV0LCB1aW50MjU2IF9zdGFydCwgdWludDI1NiBfZW5kLCB1aW50MjU2IF9taW5pbXVtRnVuZGluZ0dvYWwsIHVpbnQyNTYgX3dlaUNhcCwgCiAgICBhZGRyZXNzIF90b2tlblZlc3RpbmdBZGRyZXNzKSAKICAgIENyb3dkc2FsZShfdG9rZW4sIF9wcmljaW5nU3RyYXRlZ3ksIF9tdWx0aXNpZ1dhbGxldCwgX3N0YXJ0LCBfZW5kLCBfbWluaW11bUZ1bmRpbmdHb2FsLCAKICAgIF90b2tlblZlc3RpbmdBZGRyZXNzKSBwdWJsaWMKICAgIHsgCiAgICAgIHdlaUNhcCA9IF93ZWlDYXA7CiAgICB9CgogIC8qKgogICAqIENhbGxlZCBmcm9tIGludmVzdCgpIHRvIGNvbmZpcm0gaWYgdGhlIGN1cnJldCBpbnZlc3RtZW50IGRvZXMgbm90IGJyZWFrIG91ciBjYXAgcnVsZS4KICAgKi8KICBmdW5jdGlvbiBpc0JyZWFraW5nQ2FwKHVpbnQyNTYgd2VpQW1vdW50LCB1aW50MjU2IHRva2VuQW1vdW50LCB1aW50MjU2IHdlaVJhaXNlZFRvdGFsLCB1aW50MjU2IHRva2Vuc1NvbGRUb3RhbCkgcHVibGljIGNvbnN0YW50IHJldHVybnMgKGJvb2wgbGltaXRCcm9rZW4pIHsKICAgIHJldHVybiB3ZWlSYWlzZWRUb3RhbCA+IHdlaUNhcDsKICB9CgogIGZ1bmN0aW9uIGlzQ3Jvd2RzYWxlRnVsbCgpIHB1YmxpYyBjb25zdGFudCByZXR1cm5zIChib29sKSB7CiAgICByZXR1cm4gd2VpUmFpc2VkID49IHdlaUNhcDsKICB9CgogIC8qKgogICAqIER5bmFtaWNhbGx5IGNyZWF0ZSB0b2tlbnMgYW5kIGFzc2lnbiB0aGVtIHRvIHRoZSBpbnZlc3Rvci4KICAgKi8KICBmdW5jdGlvbiBhc3NpZ25Ub2tlbnMoYWRkcmVzcyByZWNlaXZlciwgdWludDI1NiB0b2tlbkFtb3VudCkgcHJpdmF0ZSB7CiAgICBNaW50YWJsZVRva2VuIG1pbnRhYmxlVG9rZW4gPSBNaW50YWJsZVRva2VuKHRva2VuKTsKICAgIG1pbnRhYmxlVG9rZW4ubWludChyZWNlaXZlciwgdG9rZW5BbW91bnQpOwogIH0KfQovLy8gQGRldiBUcmFuY2hlIGJhc2VkIHByaWNpbmcgd2l0aCBzcGVjaWFsIHN1cHBvcnQgZm9yIHByZS1pY28gZGVhbHMuCi8vLyAgICAgIEltcGxlbWVudGluZyAiZmlyc3QgcHJpY2UiIHRyYW5jaGVzLCBtZWFuaW5nLCB0aGF0IGlmIGJ5ZXJzIG9yZGVyIGlzCi8vLyAgICAgIGNvdmVyaW5nIG1vcmUgdGhhbiBvbmUgdHJhbmNoZSwgdGhlIHByaWNlIG9mIHRoZSBsb3dlc3QgdHJhbmNoZSB3aWxsIGFwcGx5Ci8vLyAgICAgIHRvIHRoZSB3aG9sZSBvcmRlci4KY29udHJhY3QgRXRoVHJhbmNoZVByaWNpbmcgaXMgUHJpY2luZ1N0cmF0ZWd5LCBPd25hYmxlLCBTYWZlTWF0aExpYiB7CgogIHVpbnQgcHVibGljIGNvbnN0YW50IE1BWF9UUkFOQ0hFUyA9IDEwOwogCiAKICAvLyBUaGlzIGNvbnRhaW5zIGFsbCBwcmUtSUNPIGFkZHJlc3NlcywgYW5kIHRoZWlyIHByaWNlcyAod2VpcyBwZXIgdG9rZW4pCiAgbWFwcGluZyAoYWRkcmVzcyA9PiB1aW50MjU2KSBwdWJsaWMgcHJlaWNvQWRkcmVzc2VzOwoKICAvKioKICAqIERlZmluZSBwcmljaW5nIHNjaGVkdWxlIHVzaW5nIHRyYW5jaGVzLgogICovCgogIHN0cnVjdCBUcmFuY2hlIHsKICAgICAgLy8gQW1vdW50IGluIHdlaXMgd2hlbiB0aGlzIHRyYW5jaGUgYmVjb21lcyBhY3RpdmUKICAgICAgdWludCBhbW91bnQ7CiAgICAgIC8vIEhvdyBtYW55IHRva2VucyBwZXIgd2VpIHlvdSB3aWxsIGdldCB3aGlsZSB0aGlzIHRyYW5jaGUgaXMgYWN0aXZlCiAgICAgIHVpbnQgcHJpY2U7CiAgfQoKICAvLyBTdG9yZSB0cmFuY2hlcyBpbiBhIGZpeGVkIGFycmF5LCBzbyB0aGF0IGl0IGNhbiBiZSBzZWVuIGluIGEgYmxvY2tjaGFpbiBleHBsb3JlcgogIC8vIFRyYW5jaGUgMCBpcyBhbHdheXMgKDAsIDApCiAgLy8gKFRPRE86IGNoYW5nZSB0aGlzIHdoZW4gd2UgY29uZmlybSBkeW5hbWljIGFycmF5cyBhcmUgZXhwbG9yYWJsZSkKICBUcmFuY2hlWzEwXSBwdWJsaWMgdHJhbmNoZXM7CgogIC8vIEhvdyBtYW55IGFjdGl2ZSB0cmFuY2hlcyB3ZSBoYXZlCiAgdWludCBwdWJsaWMgdHJhbmNoZUNvdW50OwoKICAvLy8gQGRldiBDb250cnVjdGlvbiwgY3JlYXRpbmcgYSBsaXN0IG9mIHRyYW5jaGVzCiAgLy8vIEBwYXJhbSBfdHJhbmNoZXMgdWludFtdIHRyYW5jaGVzIFBhaXJzIG9mIChzdGFydCBhbW91bnQsIHByaWNlKQogIGZ1bmN0aW9uIEV0aFRyYW5jaGVQcmljaW5nKHVpbnRbXSBfdHJhbmNoZXMpIHB1YmxpYyB7CgogICAgLy8gTmVlZCB0byBoYXZlIHR1cGxlcywgbGVuZ3RoIGNoZWNrCiAgICByZXF1aXJlKCEoX3RyYW5jaGVzLmxlbmd0aCAlIDIgPT0gMSB8fCBfdHJhbmNoZXMubGVuZ3RoID49IE1BWF9UUkFOQ0hFUyoyKSk7CiAgICB0cmFuY2hlQ291bnQgPSBfdHJhbmNoZXMubGVuZ3RoIC8gMjsKICAgIHVpbnQyNTYgaGlnaGVzdEFtb3VudCA9IDA7CiAgICBmb3IodWludDI1NiBpPTA7IGk8X3RyYW5jaGVzLmxlbmd0aC8yOyBpKyspIHsKICAgICAgdHJhbmNoZXNbaV0uYW1vdW50ID0gX3RyYW5jaGVzW2kqMl07CiAgICAgIHRyYW5jaGVzW2ldLnByaWNlID0gX3RyYW5jaGVzW2kqMisxXTsKICAgICAgLy8gTm8gaW52YWxpZCBzdGVwcwogICAgICByZXF1aXJlKCEoKGhpZ2hlc3RBbW91bnQgIT0gMCkgJiYgKHRyYW5jaGVzW2ldLmFtb3VudCA8PSBoaWdoZXN0QW1vdW50KSkpOwogICAgICBoaWdoZXN0QW1vdW50ID0gdHJhbmNoZXNbaV0uYW1vdW50OwogICAgfQoKICAgIC8vIFdlIG5lZWQgdG8gc3RhcnQgZnJvbSB6ZXJvLCBvdGhlcndpc2Ugd2UgYmxvdyB1cCBvdXIgZGVwbG95bWVudAogICAgcmVxdWlyZSh0cmFuY2hlc1swXS5hbW91bnQgPT0gMCk7CgogICAgLy8gTGFzdCB0cmFuY2hlIHByaWNlIG11c3QgYmUgemVybywgdGVybWluYXRpbmcgdGhlIGNyb3dkYWxlCiAgICByZXF1aXJlKHRyYW5jaGVzW3RyYW5jaGVDb3VudC0xXS5wcmljZSA9PSAwKTsKICB9CgogIC8vLyBAZGV2IFRoaXMgaXMgaW52b2tlZCBvbmNlIGZvciBldmVyeSBwcmUtSUNPIGFkZHJlc3MsIHNldCBwcmljZVBlclRva2VuCiAgLy8vICAgICAgdG8gMCB0byBkaXNhYmxlCiAgLy8vIEBwYXJhbSBwcmVpY29BZGRyZXNzIFByZXNhbGVGdW5kQ29sbGVjdG9yIGFkZHJlc3MKICAvLy8gQHBhcmFtIHByaWNlUGVyVG9rZW4gSG93IG1hbnkgd2VpcyBvbmUgdG9rZW4gY29zdCBmb3IgcHJlLWljbyBpbnZlc3RvcnMKICBmdW5jdGlvbiBzZXRQcmVpY29BZGRyZXNzKGFkZHJlc3MgcHJlaWNvQWRkcmVzcywgdWludCBwcmljZVBlclRva2VuKQogICAgcHVibGljCiAgICBvbmx5T3duZXIKICB7CiAgICBwcmVpY29BZGRyZXNzZXNbcHJlaWNvQWRkcmVzc10gPSBwcmljZVBlclRva2VuOwogIH0KCiAgLy8vIEBkZXYgSXRlcmF0ZSB0aHJvdWdoIHRyYW5jaGVzLiBZb3UgcmVhY2ggZW5kIG9mIHRyYW5jaGVzIHdoZW4gcHJpY2UgPSAwCiAgLy8vIEByZXR1cm4gdHVwbGUgKHRpbWUsIHByaWNlKQogIGZ1bmN0aW9uIGdldFRyYW5jaGUodWludDI1NiBuKSBwdWJsaWMgY29uc3RhbnQgcmV0dXJucyAodWludCwgdWludCkgewogICAgcmV0dXJuICh0cmFuY2hlc1tuXS5hbW91bnQsIHRyYW5jaGVzW25dLnByaWNlKTsKICB9CgogIGZ1bmN0aW9uIGdldEZpcnN0VHJhbmNoZSgpIHByaXZhdGUgY29uc3RhbnQgcmV0dXJucyAoVHJhbmNoZSkgewogICAgcmV0dXJuIHRyYW5jaGVzWzBdOwogIH0KCiAgZnVuY3Rpb24gZ2V0TGFzdFRyYW5jaGUoKSBwcml2YXRlIGNvbnN0YW50IHJldHVybnMgKFRyYW5jaGUpIHsKICAgIHJldHVybiB0cmFuY2hlc1t0cmFuY2hlQ291bnQtMV07CiAgfQoKICBmdW5jdGlvbiBnZXRQcmljaW5nU3RhcnRzQXQoKSBwdWJsaWMgY29uc3RhbnQgcmV0dXJucyAodWludCkgewogICAgcmV0dXJuIGdldEZpcnN0VHJhbmNoZSgpLmFtb3VudDsKICB9CgogIGZ1bmN0aW9uIGdldFByaWNpbmdFbmRzQXQoKSBwdWJsaWMgY29uc3RhbnQgcmV0dXJucyAodWludCkgewogICAgcmV0dXJuIGdldExhc3RUcmFuY2hlKCkuYW1vdW50OwogIH0KCiAgZnVuY3Rpb24gaXNTYW5lKGFkZHJlc3MgX2Nyb3dkc2FsZSkgcHVibGljIHZpZXcgcmV0dXJucyhib29sKSB7CiAgICAvLyBPdXIgdHJhbmNoZXMgYXJlIG5vdCBib3VuZCBieSB0aW1lLCBzbyB3ZSBjYW4ndCByZWFsbHkgY2hlY2sgYXJlIHdlIHNhbmUKICAgIC8vIHNvIHdlIHByZXN1bWUgd2UgYXJlIDspCiAgICAvLyBJbiB0aGUgZnV0dXJlIHdlIGNvdWxkIHNhdmUgYW5kIHRyYWNrIHJhaXNlZCB0b2tlbnMsIGFuZCBjb21wYXJlIGl0IHRvCiAgICAvLyB0aGUgQ3Jvd2RzYWxlIGNvbnRyYWN0LgogICAgcmV0dXJuIHRydWU7CiAgfQoKICAvLy8gQGRldiBHZXQgdGhlIGN1cnJlbnQgdHJhbmNoZSBvciBiYWlsIG91dCBpZiB3ZSBhcmUgbm90IGluIHRoZSB0cmFuY2hlIHBlcmlvZHMuCiAgLy8vIEBwYXJhbSB3ZWlSYWlzZWQgdG90YWwgYW1vdW50IG9mIHdlaXMgcmFpc2VkLCBmb3IgY2FsY3VsYXRpbmcgdGhlIGN1cnJlbnQgdHJhbmNoZQogIC8vLyBAcmV0dXJuIHtbdHlwZV19IFtkZXNjcmlwdGlvbl0KICBmdW5jdGlvbiBnZXRDdXJyZW50VHJhbmNoZSh1aW50MjU2IHdlaVJhaXNlZCkgcHJpdmF0ZSBjb25zdGFudCByZXR1cm5zIChUcmFuY2hlKSB7CiAgICB1aW50IGk7CiAgICBmb3IoaT0wOyBpIDwgdHJhbmNoZXMubGVuZ3RoOyBpKyspIHsKICAgICAgaWYod2VpUmFpc2VkIDwgdHJhbmNoZXNbaV0uYW1vdW50KSB7CiAgICAgICAgcmV0dXJuIHRyYW5jaGVzW2ktMV07CiAgICAgIH0KICAgIH0KICB9CgogIC8vLyBAZGV2IEdldCB0aGUgY3VycmVudCBwcmljZS4KICAvLy8gQHBhcmFtIHdlaVJhaXNlZCB0b3RhbCBhbW91bnQgb2Ygd2VpcyByYWlzZWQsIGZvciBjYWxjdWxhdGluZyB0aGUgY3VycmVudCB0cmFuY2hlCiAgLy8vIEByZXR1cm4gVGhlIGN1cnJlbnQgcHJpY2Ugb3IgMCBpZiB3ZSBhcmUgb3V0c2lkZSB0cmFjaGUgcmFuZ2VzCiAgZnVuY3Rpb24gZ2V0Q3VycmVudFByaWNlKHVpbnQyNTYgd2VpUmFpc2VkKSBwdWJsaWMgY29uc3RhbnQgcmV0dXJucyAodWludDI1NiByZXN1bHQpIHsKICAgIHJldHVybiBnZXRDdXJyZW50VHJhbmNoZSh3ZWlSYWlzZWQpLnByaWNlOwogIH0KCiAgLy8vIEBkZXYgQ2FsY3VsYXRlIHRoZSBjdXJyZW50IHByaWNlIGZvciBidXkgaW4gYW1vdW50LgogIGZ1bmN0aW9uIGNhbGN1bGF0ZVByaWNlKHVpbnQyNTYgdmFsdWUsIHVpbnQyNTYgd2VpUmFpc2VkLCB1aW50MjU2IHRva2Vuc1NvbGQsIGFkZHJlc3MgbXNnU2VuZGVyLCB1aW50MjU2IGRlY2ltYWxzKSBwdWJsaWMgY29uc3RhbnQgcmV0dXJucyAodWludDI1NikgewoKICAgIHVpbnQyNTYgbXVsdGlwbGllciA9IDEwICoqIGRlY2ltYWxzOwoKICAgIC8vIFRoaXMgaW52ZXN0b3IgaXMgY29taW5nIHRocm91Z2ggcHJlLWljbwogICAgaWYocHJlaWNvQWRkcmVzc2VzW21zZ1NlbmRlcl0gPiAwKSB7CiAgICAgIHJldHVybiBzYWZlTXVsKHZhbHVlLCBtdWx0aXBsaWVyKSAvIHByZWljb0FkZHJlc3Nlc1ttc2dTZW5kZXJdOwogICAgfQoKICAgIHVpbnQyNTYgcHJpY2UgPSBnZXRDdXJyZW50UHJpY2Uod2VpUmFpc2VkKTsKICAgIAogICAgcmV0dXJuIHNhZmVNdWwodmFsdWUsIG11bHRpcGxpZXIpIC8gcHJpY2U7CiAgfQoKICBmdW5jdGlvbigpIHBheWFibGUgcHVibGljIHsKICAgIHJldmVydCgpOyAvLyBObyBtb25leSBvbiB0aGlzIGNvbnRyYWN0CiAgfQoKfQoKLyoqCiAqIENvbnRyYWN0IHRvIGVuZm9yY2UgVG9rZW4gVmVzdGluZwogKi8KY29udHJhY3QgVG9rZW5WZXN0aW5nIGlzIEFsbG9jYXRhYmxlLCBTYWZlTWF0aExpYiB7CgogICAgYWRkcmVzcyBwdWJsaWMgTEFMQVRva2VuQWRkcmVzczsKCiAgICAvKioga2VlcCB0cmFjayBvZiB0b3RhbCB0b2tlbnMgeWV0IHRvIGJlIHJlbGVhc2VkLCAKICAgICAqIHRoaXMgc2hvdWxkIGJlIGxlc3MgdGhhbiBvciBlcXVhbCB0byBMQUxBIHRva2VucyBoZWxkIGJ5IHRoaXMgY29udHJhY3QuIAogICAgICovCiAgICB1aW50MjU2IHB1YmxpYyB0b3RhbFVucmVsZWFzZWRUb2tlbnM7CgogICAgLy8gZGVmYXVsdCB2ZXN0aW5nIHBhcmFtZXRlcnMKICAgIHVpbnQyNTYgc3RhcnRBdCA9IDA7CiAgICB1aW50MjU2IGNsaWZmID0gMzsKICAgIHVpbnQyNTYgZHVyYXRpb24gPSAxMjsgCiAgICB1aW50MjU2IHN0ZXAgPSAyNTkyMDAwOwogICAgYm9vbCBjaGFuZ2VGcmVlemVkID0gZmFsc2U7CgogICAgc3RydWN0IFZlc3RpbmdTY2hlZHVsZSB7CiAgICAgICAgdWludDI1NiBzdGFydEF0OwogICAgICAgIHVpbnQyNTYgY2xpZmY7CiAgICAgICAgdWludDI1NiBkdXJhdGlvbjsKICAgICAgICB1aW50MjU2IHN0ZXA7CiAgICAgICAgdWludDI1NiBhbW91bnQ7CiAgICAgICAgdWludDI1NiBhbW91bnRSZWxlYXNlZDsKICAgICAgICBib29sIGNoYW5nZUZyZWV6ZWQ7CiAgICB9CgogICAgbWFwcGluZyAoYWRkcmVzcyA9PiBWZXN0aW5nU2NoZWR1bGUpIHB1YmxpYyB2ZXN0aW5nTWFwOwoKICAgIGV2ZW50IFZlc3RlZFRva2Vuc1JlbGVhc2VkKGFkZHJlc3MgX2FkciwgdWludDI1NiBfYW1vdW50KTsKCgogICAgZnVuY3Rpb24gVG9rZW5WZXN0aW5nKGFkZHJlc3MgX0xBTEFUb2tlbkFkZHJlc3MpIHB1YmxpYyB7CiAgICAgICAgTEFMQVRva2VuQWRkcmVzcyA9IF9MQUxBVG9rZW5BZGRyZXNzOwogICAgfQoKCiAgICAvKiogTW9kaWZpZXIgdG8gY2hlY2sgaWYgY2hhbmdlcyB0byB2ZXN0aW5nIGlzIGZyZWV6ZWQgICovCiAgICBtb2RpZmllciBjaGFuZ2VzVG9WZXN0aW5nRnJlZXplZChhZGRyZXNzIF9hZHIpewogICAgICAgIHJlcXVpcmUodmVzdGluZ01hcFtfYWRyXS5jaGFuZ2VGcmVlemVkKTsKICAgICAgICBfOwogICAgfQoKCiAgICAvKiogTW9kaWZpZXIgdG8gY2hlY2sgaWYgY2hhbmdlcyB0byB2ZXN0aW5nIGlzIG5vdCBmcmVlemVkIHlldCAgKi8KICAgIG1vZGlmaWVyIGNoYW5nZXNUb1Zlc3RpbmdOb3RGcmVlemVkKGFkZHJlc3MgYWRyKSB7CiAgICAgICAgcmVxdWlyZSghdmVzdGluZ01hcFthZHJdLmNoYW5nZUZyZWV6ZWQpOyAvLyBpZiB2ZXN0aW5nIG5vdCBzZXQgdGhlbiBhbHNvIGNoYW5nZUZyZWV6ZWQgd2lsbCBiZSBmYWxzZQogICAgICAgIF87CiAgICB9CgoKICAgIC8qKiBGdW5jdGlvbiB0byBzZXQgZGVmYXVsdCB2ZXN0aW5nIHNjaGVkdWxlIHBhcmFtZXRlcnMuICovCiAgICBmdW5jdGlvbiBzZXREZWZhdWx0VmVzdGluZ1BhcmFtZXRlcnModWludDI1NiBfc3RhcnRBdCwgdWludDI1NiBfY2xpZmYsIHVpbnQyNTYgX2R1cmF0aW9uLCAKICAgICAgICB1aW50MjU2IF9zdGVwLCBib29sIF9jaGFuZ2VGcmVlemVkKSBvbmx5QWxsb2NhdGVBZ2VudCBwdWJsaWMgewoKICAgICAgICAvLyBkYXRhIHZhbGlkYXRpb24KICAgICAgICByZXF1aXJlKF9zdGVwICE9IDApOwogICAgICAgIHJlcXVpcmUoX2R1cmF0aW9uICE9IDApOwogICAgICAgIHJlcXVpcmUoX2NsaWZmIDw9IF9kdXJhdGlvbik7CgogICAgICAgIHN0YXJ0QXQgPSBfc3RhcnRBdDsKICAgICAgICBjbGlmZiA9IF9jbGlmZjsKICAgICAgICBkdXJhdGlvbiA9IF9kdXJhdGlvbjsgCiAgICAgICAgc3RlcCA9IF9zdGVwOwogICAgICAgIGNoYW5nZUZyZWV6ZWQgPSBfY2hhbmdlRnJlZXplZDsKCiAgICB9CgogICAgLyoqIEZ1bmN0aW9uIHRvIHNldCB2ZXN0aW5nIHdpdGggZGVmYXVsdCBzY2hlZHVsZS4gKi8KICAgIGZ1bmN0aW9uIHNldFZlc3RpbmdXaXRoRGVmYXVsdFNjaGVkdWxlKGFkZHJlc3MgX2FkciwgdWludDI1NiBfYW1vdW50KSAKICAgICAgICBwdWJsaWMgCiAgICAgICAgY2hhbmdlc1RvVmVzdGluZ05vdEZyZWV6ZWQoX2Fkcikgb25seUFsbG9jYXRlQWdlbnQgewogICAgICAgIHNldFZlc3RpbmcoX2Fkciwgc3RhcnRBdCwgY2xpZmYsIGR1cmF0aW9uLCBzdGVwLCBfYW1vdW50LCBjaGFuZ2VGcmVlemVkKTsKICAgIH0KCiAgICAvKiogRnVuY3Rpb24gdG8gc2V0L3VwZGF0ZSB2ZXN0aW5nIHNjaGVkdWxlLiBQUyAtIEFtb3VudCBjYW5ub3QgYmUgY2hhbmdlZCBvbmNlIHNldCAqLwogICAgZnVuY3Rpb24gc2V0VmVzdGluZyhhZGRyZXNzIF9hZHIsIHVpbnQyNTYgX3N0YXJ0QXQsIHVpbnQyNTYgX2NsaWZmLCB1aW50MjU2IF9kdXJhdGlvbiwgCiAgICAgICAgdWludDI1NiBfc3RlcCwgdWludDI1NiBfYW1vdW50LCBib29sIF9jaGFuZ2VGcmVlemVkKSBwdWJsaWMgY2hhbmdlc1RvVmVzdGluZ05vdEZyZWV6ZWQoX2Fkcikgb25seUFsbG9jYXRlQWdlbnQgewoKICAgICAgICBWZXN0aW5nU2NoZWR1bGUgc3RvcmFnZSB2ZXN0aW5nU2NoZWR1bGUgPSB2ZXN0aW5nTWFwW19hZHJdOwoKICAgICAgICAvLyBkYXRhIHZhbGlkYXRpb24KICAgICAgICByZXF1aXJlKF9zdGVwICE9IDApOwogICAgICAgIHJlcXVpcmUoX2Ftb3VudCAhPSAwIHx8IHZlc3RpbmdTY2hlZHVsZS5hbW91bnQgPiAwKTsKICAgICAgICByZXF1aXJlKF9kdXJhdGlvbiAhPSAwKTsKICAgICAgICByZXF1aXJlKF9jbGlmZiA8PSBfZHVyYXRpb24pOwoKICAgICAgICAvL2lmIHN0YXJ0QXQgaXMgemVybywgc2V0IGN1cnJlbnQgdGltZSBhcyBzdGFydCB0aW1lLgogICAgICAgIGlmIChfc3RhcnRBdCA9PSAwKSAKICAgICAgICAgICAgX3N0YXJ0QXQgPSBibG9jay50aW1lc3RhbXA7CgogICAgICAgIHZlc3RpbmdTY2hlZHVsZS5zdGFydEF0ID0gX3N0YXJ0QXQ7CiAgICAgICAgdmVzdGluZ1NjaGVkdWxlLmNsaWZmID0gX2NsaWZmOwogICAgICAgIHZlc3RpbmdTY2hlZHVsZS5kdXJhdGlvbiA9IF9kdXJhdGlvbjsKICAgICAgICB2ZXN0aW5nU2NoZWR1bGUuc3RlcCA9IF9zdGVwOwoKICAgICAgICAvLyBzcGVjaWFsIHByb2Nlc3NpbmcgZm9yIGZpcnN0IHRpbWUgdmVzdGluZyBzZXR0aW5nCiAgICAgICAgaWYgKHZlc3RpbmdTY2hlZHVsZS5hbW91bnQgPT0gMCkgewogICAgICAgICAgICAvLyBjaGVjayBpZiBlbm91Z2ggdG9rZW5zIGFyZSBoZWxkIGJ5IHRoaXMgY29udHJhY3QKICAgICAgICAgICAgRVJDMjAgTEFMQVRva2VuID0gRVJDMjAoTEFMQVRva2VuQWRkcmVzcyk7CiAgICAgICAgICAgIHJlcXVpcmUoTEFMQVRva2VuLmJhbGFuY2VPZih0aGlzKSA+PSBzYWZlQWRkKHRvdGFsVW5yZWxlYXNlZFRva2VucywgX2Ftb3VudCkpOwogICAgICAgICAgICB0b3RhbFVucmVsZWFzZWRUb2tlbnMgPSBzYWZlQWRkKHRvdGFsVW5yZWxlYXNlZFRva2VucywgX2Ftb3VudCk7CiAgICAgICAgICAgIHZlc3RpbmdTY2hlZHVsZS5hbW91bnQgPSBfYW1vdW50OyAKICAgICAgICB9CgogICAgICAgIHZlc3RpbmdTY2hlZHVsZS5hbW91bnRSZWxlYXNlZCA9IDA7CiAgICAgICAgdmVzdGluZ1NjaGVkdWxlLmNoYW5nZUZyZWV6ZWQgPSBfY2hhbmdlRnJlZXplZDsKICAgIH0KCiAgICBmdW5jdGlvbiBpc1Zlc3RpbmdTZXQoYWRkcmVzcyBhZHIpIHB1YmxpYyBjb25zdGFudCByZXR1cm5zIChib29sIGlzU2V0KSB7CiAgICAgICAgcmV0dXJuIHZlc3RpbmdNYXBbYWRyXS5hbW91bnQgIT0gMDsKICAgIH0KCiAgICBmdW5jdGlvbiBmcmVlemVDaGFuZ2VzVG9WZXN0aW5nKGFkZHJlc3MgX2FkcikgcHVibGljIGNoYW5nZXNUb1Zlc3RpbmdOb3RGcmVlemVkKF9hZHIpIG9ubHlBbGxvY2F0ZUFnZW50IHsKICAgICAgICByZXF1aXJlKGlzVmVzdGluZ1NldChfYWRyKSk7IC8vIGZpcnN0IGNoZWNrIGlmIHZlc3RpbmcgaXMgc2V0CiAgICAgICAgdmVzdGluZ01hcFtfYWRyXS5jaGFuZ2VGcmVlemVkID0gdHJ1ZTsKICAgIH0KCgogICAgLyoqIFJlbGVhc2UgdG9rZW5zIGFzIHBlciB2ZXN0aW5nIHNjaGVkdWxlLCBjYWxsZWQgYnkgY29udHJpYnV0b3IgICovCiAgICBmdW5jdGlvbiByZWxlYXNlTXlWZXN0ZWRUb2tlbnMoKSBwdWJsaWMgY2hhbmdlc1RvVmVzdGluZ0ZyZWV6ZWQobXNnLnNlbmRlcikgewogICAgICAgIHJlbGVhc2VWZXN0ZWRUb2tlbnMobXNnLnNlbmRlcik7CiAgICB9CgogICAgLyoqIFJlbGVhc2UgdG9rZW5zIGFzIHBlciB2ZXN0aW5nIHNjaGVkdWxlLCBjYWxsZWQgYnkgYW55b25lICAqLwogICAgZnVuY3Rpb24gcmVsZWFzZVZlc3RlZFRva2VucyhhZGRyZXNzIF9hZHIpIHB1YmxpYyBjaGFuZ2VzVG9WZXN0aW5nRnJlZXplZChfYWRyKSB7CiAgICAgICAgVmVzdGluZ1NjaGVkdWxlIHN0b3JhZ2UgdmVzdGluZ1NjaGVkdWxlID0gdmVzdGluZ01hcFtfYWRyXTsKICAgICAgICAKICAgICAgICAvLyBjaGVjayBpZiBhbGwgdG9rZW5zIGFyZSBub3QgdmVzdGVkCiAgICAgICAgcmVxdWlyZShzYWZlU3ViKHZlc3RpbmdTY2hlZHVsZS5hbW91bnQsIHZlc3RpbmdTY2hlZHVsZS5hbW91bnRSZWxlYXNlZCkgPiAwKTsKICAgICAgICAKICAgICAgICAvLyBjYWxjdWxhdGUgdG90YWwgdmVzdGVkIHRva2VucyB0aWxsIG5vdwogICAgICAgIHVpbnQyNTYgdG90YWxUaW1lID0gYmxvY2sudGltZXN0YW1wIC0gdmVzdGluZ1NjaGVkdWxlLnN0YXJ0QXQ7CiAgICAgICAgdWludDI1NiB0b3RhbFN0ZXBzID0gdG90YWxUaW1lIC8gdmVzdGluZ1NjaGVkdWxlLnN0ZXA7CgogICAgICAgIC8vIGNoZWNrIGlmIGNsaWZmIGlzIHBhc3NlZAogICAgICAgIHJlcXVpcmUodmVzdGluZ1NjaGVkdWxlLmNsaWZmIDw9IHRvdGFsU3RlcHMpOwoKICAgICAgICB1aW50MjU2IHRva2Vuc1BlclN0ZXAgPSB2ZXN0aW5nU2NoZWR1bGUuYW1vdW50IC8gdmVzdGluZ1NjaGVkdWxlLmR1cmF0aW9uOwogICAgICAgIC8vIGNoZWNrIGlmIGFtb3VudCBpcyBkaXZpc2JsZSBieSBkdXJhdGlvbgogICAgICAgIGlmKHRva2Vuc1BlclN0ZXAgKiB2ZXN0aW5nU2NoZWR1bGUuZHVyYXRpb24gIT0gdmVzdGluZ1NjaGVkdWxlLmFtb3VudCkgdG9rZW5zUGVyU3RlcCsrOwoKICAgICAgICB1aW50MjU2IHRvdGFsUmVsZWFzYWJsZUFtb3VudCA9IHNhZmVNdWwodG9rZW5zUGVyU3RlcCwgdG90YWxTdGVwcyk7CgogICAgICAgIC8vIGhhbmRsZSB0aGUgY2FzZSBpZiB1c2VyIGhhcyBub3QgY2xhaW1lZCBldmVuIGFmdGVyIHZlc3RpbmcgcGVyaW9kIGlzIG92ZXIgb3IgYW1vdW50IHdhcyBub3QgZGl2aXNpYmxlCiAgICAgICAgaWYodG90YWxSZWxlYXNhYmxlQW1vdW50ID4gdmVzdGluZ1NjaGVkdWxlLmFtb3VudCkgdG90YWxSZWxlYXNhYmxlQW1vdW50ID0gdmVzdGluZ1NjaGVkdWxlLmFtb3VudDsKCiAgICAgICAgdWludDI1NiBhbW91bnRUb1JlbGVhc2UgPSBzYWZlU3ViKHRvdGFsUmVsZWFzYWJsZUFtb3VudCwgdmVzdGluZ1NjaGVkdWxlLmFtb3VudFJlbGVhc2VkKTsKICAgICAgICB2ZXN0aW5nU2NoZWR1bGUuYW1vdW50UmVsZWFzZWQgPSBzYWZlQWRkKHZlc3RpbmdTY2hlZHVsZS5hbW91bnRSZWxlYXNlZCwgYW1vdW50VG9SZWxlYXNlKTsKCiAgICAgICAgLy8gdHJhbnNmZXIgdmVzdGVkIHRva2VucwogICAgICAgIEVSQzIwIExBTEFUb2tlbiA9IEVSQzIwKExBTEFUb2tlbkFkZHJlc3MpOwogICAgICAgIExBTEFUb2tlbi50cmFuc2ZlcihfYWRyLCBhbW91bnRUb1JlbGVhc2UpOwogICAgICAgIC8vIGRlY3JlbWVudCBvdmVyYWxsIHVucmVsZWFzZWQgdG9rZW4gY291bnQKICAgICAgICB0b3RhbFVucmVsZWFzZWRUb2tlbnMgPSBzYWZlU3ViKHRvdGFsVW5yZWxlYXNlZFRva2VucywgYW1vdW50VG9SZWxlYXNlKTsKICAgICAgICBWZXN0ZWRUb2tlbnNSZWxlYXNlZChfYWRyLCBhbW91bnRUb1JlbGVhc2UpOwogICAgfQoKfQ=='.
	

]
