Class {
	#name : #SRT2fc5f7b04b1a43a64cfc066530f2bd87e001824d,
	#superclass : #SRTContracts,
	#category : #SolidityTestingResources
}

{ #category : #base64 }
SRT2fc5f7b04b1a43a64cfc066530f2bd87e001824d >> base64 [
	^ 'cHJhZ21hIHNvbGlkaXR5IF4wLjQuNjsKCi8qCiAgICBDb3B5cmlnaHQgMjAxNiwgSm9yZGkgQmF5bGluYQoKICAgIFRoaXMgcHJvZ3JhbSBpcyBmcmVlIHNvZnR3YXJlOiB5b3UgY2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3IgbW9kaWZ5CiAgICBpdCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFzIHB1Ymxpc2hlZCBieQogICAgdGhlIEZyZWUgU29mdHdhcmUgRm91bmRhdGlvbiwgZWl0aGVyIHZlcnNpb24gMyBvZiB0aGUgTGljZW5zZSwgb3IKICAgIChhdCB5b3VyIG9wdGlvbikgYW55IGxhdGVyIHZlcnNpb24uCgogICAgVGhpcyBwcm9ncmFtIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsCiAgICBidXQgV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZgogICAgTUVSQ0hBTlRBQklMSVRZIG9yIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFLiAgU2VlIHRoZQogICAgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmUgZGV0YWlscy4KCiAgICBZb3Ugc2hvdWxkIGhhdmUgcmVjZWl2ZWQgYSBjb3B5IG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZQogICAgYWxvbmcgd2l0aCB0aGlzIHByb2dyYW0uICBJZiBub3QsIHNlZSA8aHR0cDovL3d3dy5nbnUub3JnL2xpY2Vuc2VzLz4uCiAqLwoKLy8vIEB0aXRsZSBNaWxlc3RvbmVUcmFja2VyIENvbnRyYWN0Ci8vLyBAYXV0aG9yIEpvcmRpIEJheWxpbmEKLy8vIEBkZXYgVGhpcyBjb250cmFjdCB0cmFja3MgdGhlCgoKLy8vIGlzIHJ1bGVzIHRoZSByZWxhdGlvbiBiZXR3ZW4gYSBkb25vciBhbmQgYSByZWNpcGllbnQKLy8vICBpbiBvcmRlciB0byBndWFyYW50eSB0byB0aGUgZG9ub3IgdGhhdCB0aGUgam9iIHdpbGwgYmUgZG9uZSBhbmQgdG8gZ3VhcmFudHkKLy8vICB0byB0aGUgcmVjaXBpZW50IHRoYXQgaGUgd2lsbCBiZSBwYWlkCgoKLy8vIEBkZXYgV2UgdXNlIHRoZSBSTFAgbGlicmFyeSB0byBkZWNvZGUgUkxQIHNvIHRoYXQgdGhlIGRvbm9yIGNhbiBhcHByb3ZlIG9uZQovLy8gIHNldCBvZiBtaWxlc3RvbmUgY2hhbmdlcyBhdCBhIHRpbWUuCi8vLyAgaHR0cHM6Ly9naXRodWIuY29tL2FuZHJvbG8vc3RhbmRhcmQtY29udHJhY3RzL2Jsb2IvbWFzdGVyL2NvbnRyYWN0cy9zcmMvY29kZWMvUkxQLnNvbAoKCi8qKgoqIEB0aXRsZSBSTFBSZWFkZXIKKgoqIFJMUFJlYWRlciBpcyB1c2VkIHRvIHJlYWQgYW5kIHBhcnNlIFJMUCBlbmNvZGVkIGRhdGEgaW4gbWVtb3J5LgoqCiogQGF1dGhvciBBbmRyZWFzIE9sb2Zzc29uICg8YSBocmVmPSIvY2RuLWNnaS9sL2VtYWlsLXByb3RlY3Rpb24iIGNsYXNzPSJfX2NmX2VtYWlsX18iIGRhdGEtY2ZlbWFpbD0iMzU1NDViNTE0NzVhNTk1YTA0MGMwZDA1NzU1MjU4NTQ1YzU5MWI1NjVhNTgiPltlbWFpbCYjMTYwO3Byb3RlY3RlZF08L2E+KQoqLwpsaWJyYXJ5IFJMUCB7CgogdWludCBjb25zdGFudCBEQVRBX1NIT1JUX1NUQVJUID0gMHg4MDsKIHVpbnQgY29uc3RhbnQgREFUQV9MT05HX1NUQVJUID0gMHhCODsKIHVpbnQgY29uc3RhbnQgTElTVF9TSE9SVF9TVEFSVCA9IDB4QzA7CiB1aW50IGNvbnN0YW50IExJU1RfTE9OR19TVEFSVCA9IDB4Rjg7CgogdWludCBjb25zdGFudCBEQVRBX0xPTkdfT0ZGU0VUID0gMHhCNzsKIHVpbnQgY29uc3RhbnQgTElTVF9MT05HX09GRlNFVCA9IDB4Rjc7CgoKIHN0cnVjdCBSTFBJdGVtIHsKICAgICB1aW50IF91bnNhZmVfbWVtUHRyOyAgICAvLyBQb2ludGVyIHRvIHRoZSBSTFAtZW5jb2RlZCBieXRlcy4KICAgICB1aW50IF91bnNhZmVfbGVuZ3RoOyAgICAvLyBOdW1iZXIgb2YgYnl0ZXMuIFRoaXMgaXMgdGhlIGZ1bGwgbGVuZ3RoIG9mIHRoZSBzdHJpbmcuCiB9Cgogc3RydWN0IEl0ZXJhdG9yIHsKICAgICBSTFBJdGVtIF91bnNhZmVfaXRlbTsgICAvLyBJdGVtIHRoYXQncyBiZWluZyBpdGVyYXRlZCBvdmVyLgogICAgIHVpbnQgX3Vuc2FmZV9uZXh0UHRyOyAgIC8vIFBvc2l0aW9uIG9mIHRoZSBuZXh0IGl0ZW0gaW4gdGhlIGxpc3QuCiB9CgogLyogSXRlcmF0b3IgKi8KCiBmdW5jdGlvbiBuZXh0KEl0ZXJhdG9yIG1lbW9yeSBzZWxmKSBpbnRlcm5hbCBjb25zdGFudCByZXR1cm5zIChSTFBJdGVtIG1lbW9yeSBzdWJJdGVtKSB7CiAgICAgaWYoaGFzTmV4dChzZWxmKSkgewogICAgICAgICB2YXIgcHRyID0gc2VsZi5fdW5zYWZlX25leHRQdHI7CiAgICAgICAgIHZhciBpdGVtTGVuZ3RoID0gX2l0ZW1MZW5ndGgocHRyKTsKICAgICAgICAgc3ViSXRlbS5fdW5zYWZlX21lbVB0ciA9IHB0cjsKICAgICAgICAgc3ViSXRlbS5fdW5zYWZlX2xlbmd0aCA9IGl0ZW1MZW5ndGg7CiAgICAgICAgIHNlbGYuX3Vuc2FmZV9uZXh0UHRyID0gcHRyICsgaXRlbUxlbmd0aDsKICAgICB9CiAgICAgZWxzZQogICAgICAgICB0aHJvdzsKIH0KCiBmdW5jdGlvbiBuZXh0KEl0ZXJhdG9yIG1lbW9yeSBzZWxmLCBib29sIHN0cmljdCkgaW50ZXJuYWwgY29uc3RhbnQgcmV0dXJucyAoUkxQSXRlbSBtZW1vcnkgc3ViSXRlbSkgewogICAgIHN1Ykl0ZW0gPSBuZXh0KHNlbGYpOwogICAgIGlmKHN0cmljdCAmJiAhX3ZhbGlkYXRlKHN1Ykl0ZW0pKQogICAgICAgICB0aHJvdzsKICAgICByZXR1cm47CiB9CgogZnVuY3Rpb24gaGFzTmV4dChJdGVyYXRvciBtZW1vcnkgc2VsZikgaW50ZXJuYWwgY29uc3RhbnQgcmV0dXJucyAoYm9vbCkgewogICAgIHZhciBpdGVtID0gc2VsZi5fdW5zYWZlX2l0ZW07CiAgICAgcmV0dXJuIHNlbGYuX3Vuc2FmZV9uZXh0UHRyIDwgaXRlbS5fdW5zYWZlX21lbVB0ciArIGl0ZW0uX3Vuc2FmZV9sZW5ndGg7CiB9CgogLyogUkxQSXRlbSAqLwoKIC8vLyBAZGV2IENyZWF0ZXMgYW4gUkxQSXRlbSBmcm9tIGFuIGFycmF5IG9mIFJMUCBlbmNvZGVkIGJ5dGVzLgogLy8vIEBwYXJhbSBzZWxmIFRoZSBSTFAgZW5jb2RlZCBieXRlcy4KIC8vLyBAcmV0dXJuIEFuIFJMUEl0ZW0KIGZ1bmN0aW9uIHRvUkxQSXRlbShieXRlcyBtZW1vcnkgc2VsZikgaW50ZXJuYWwgY29uc3RhbnQgcmV0dXJucyAoUkxQSXRlbSBtZW1vcnkpIHsKICAgICB1aW50IGxlbiA9IHNlbGYubGVuZ3RoOwogICAgIGlmIChsZW4gPT0gMCkgewogICAgICAgICByZXR1cm4gUkxQSXRlbSgwLCAwKTsKICAgICB9CiAgICAgdWludCBtZW1QdHI7CiAgICAgYXNzZW1ibHkgewogICAgICAgICBtZW1QdHIgOj0gYWRkKHNlbGYsIDB4MjApCiAgICAgfQogICAgIHJldHVybiBSTFBJdGVtKG1lbVB0ciwgbGVuKTsKIH0KCiAvLy8gQGRldiBDcmVhdGVzIGFuIFJMUEl0ZW0gZnJvbSBhbiBhcnJheSBvZiBSTFAgZW5jb2RlZCBieXRlcy4KIC8vLyBAcGFyYW0gc2VsZiBUaGUgUkxQIGVuY29kZWQgYnl0ZXMuCiAvLy8gQHBhcmFtIHN0cmljdCBXaWxsIHRocm93IGlmIHRoZSBkYXRhIGlzIG5vdCBSTFAgZW5jb2RlZC4KIC8vLyBAcmV0dXJuIEFuIFJMUEl0ZW0KIGZ1bmN0aW9uIHRvUkxQSXRlbShieXRlcyBtZW1vcnkgc2VsZiwgYm9vbCBzdHJpY3QpIGludGVybmFsIGNvbnN0YW50IHJldHVybnMgKFJMUEl0ZW0gbWVtb3J5KSB7CiAgICAgdmFyIGl0ZW0gPSB0b1JMUEl0ZW0oc2VsZik7CiAgICAgaWYoc3RyaWN0KSB7CiAgICAgICAgIHVpbnQgbGVuID0gc2VsZi5sZW5ndGg7CiAgICAgICAgIGlmKF9wYXlsb2FkT2Zmc2V0KGl0ZW0pID4gbGVuKQogICAgICAgICAgICAgdGhyb3c7CiAgICAgICAgIGlmKF9pdGVtTGVuZ3RoKGl0ZW0uX3Vuc2FmZV9tZW1QdHIpICE9IGxlbikKICAgICAgICAgICAgIHRocm93OwogICAgICAgICBpZighX3ZhbGlkYXRlKGl0ZW0pKQogICAgICAgICAgICAgdGhyb3c7CiAgICAgfQogICAgIHJldHVybiBpdGVtOwogfQoKIC8vLyBAZGV2IENoZWNrIGlmIHRoZSBSTFAgaXRlbSBpcyBudWxsLgogLy8vIEBwYXJhbSBzZWxmIFRoZSBSTFAgaXRlbS4KIC8vLyBAcmV0dXJuICd0cnVlJyBpZiB0aGUgaXRlbSBpcyBudWxsLgogZnVuY3Rpb24gaXNOdWxsKFJMUEl0ZW0gbWVtb3J5IHNlbGYpIGludGVybmFsIGNvbnN0YW50IHJldHVybnMgKGJvb2wgcmV0KSB7CiAgICAgcmV0dXJuIHNlbGYuX3Vuc2FmZV9sZW5ndGggPT0gMDsKIH0KCiAvLy8gQGRldiBDaGVjayBpZiB0aGUgUkxQIGl0ZW0gaXMgYSBsaXN0LgogLy8vIEBwYXJhbSBzZWxmIFRoZSBSTFAgaXRlbS4KIC8vLyBAcmV0dXJuICd0cnVlJyBpZiB0aGUgaXRlbSBpcyBhIGxpc3QuCiBmdW5jdGlvbiBpc0xpc3QoUkxQSXRlbSBtZW1vcnkgc2VsZikgaW50ZXJuYWwgY29uc3RhbnQgcmV0dXJucyAoYm9vbCByZXQpIHsKICAgICBpZiAoc2VsZi5fdW5zYWZlX2xlbmd0aCA9PSAwKQogICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgdWludCBtZW1QdHIgPSBzZWxmLl91bnNhZmVfbWVtUHRyOwogICAgIGFzc2VtYmx5IHsKICAgICAgICAgcmV0IDo9IGlzemVybyhsdChieXRlKDAsIG1sb2FkKG1lbVB0cikpLCAweEMwKSkKICAgICB9CiB9CgogLy8vIEBkZXYgQ2hlY2sgaWYgdGhlIFJMUCBpdGVtIGlzIGRhdGEuCiAvLy8gQHBhcmFtIHNlbGYgVGhlIFJMUCBpdGVtLgogLy8vIEByZXR1cm4gJ3RydWUnIGlmIHRoZSBpdGVtIGlzIGRhdGEuCiBmdW5jdGlvbiBpc0RhdGEoUkxQSXRlbSBtZW1vcnkgc2VsZikgaW50ZXJuYWwgY29uc3RhbnQgcmV0dXJucyAoYm9vbCByZXQpIHsKICAgICBpZiAoc2VsZi5fdW5zYWZlX2xlbmd0aCA9PSAwKQogICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgdWludCBtZW1QdHIgPSBzZWxmLl91bnNhZmVfbWVtUHRyOwogICAgIGFzc2VtYmx5IHsKICAgICAgICAgcmV0IDo9IGx0KGJ5dGUoMCwgbWxvYWQobWVtUHRyKSksIDB4QzApCiAgICAgfQogfQoKIC8vLyBAZGV2IENoZWNrIGlmIHRoZSBSTFAgaXRlbSBpcyBlbXB0eSAoc3RyaW5nIG9yIGxpc3QpLgogLy8vIEBwYXJhbSBzZWxmIFRoZSBSTFAgaXRlbS4KIC8vLyBAcmV0dXJuICd0cnVlJyBpZiB0aGUgaXRlbSBpcyBudWxsLgogZnVuY3Rpb24gaXNFbXB0eShSTFBJdGVtIG1lbW9yeSBzZWxmKSBpbnRlcm5hbCBjb25zdGFudCByZXR1cm5zIChib29sIHJldCkgewogICAgIGlmKGlzTnVsbChzZWxmKSkKICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgIHVpbnQgYjA7CiAgICAgdWludCBtZW1QdHIgPSBzZWxmLl91bnNhZmVfbWVtUHRyOwogICAgIGFzc2VtYmx5IHsKICAgICAgICAgYjAgOj0gYnl0ZSgwLCBtbG9hZChtZW1QdHIpKQogICAgIH0KICAgICByZXR1cm4gKGIwID09IERBVEFfU0hPUlRfU1RBUlQgfHwgYjAgPT0gTElTVF9TSE9SVF9TVEFSVCk7CiB9CgogLy8vIEBkZXYgR2V0IHRoZSBudW1iZXIgb2YgaXRlbXMgaW4gYW4gUkxQIGVuY29kZWQgbGlzdC4KIC8vLyBAcGFyYW0gc2VsZiBUaGUgUkxQIGl0ZW0uCiAvLy8gQHJldHVybiBUaGUgbnVtYmVyIG9mIGl0ZW1zLgogZnVuY3Rpb24gaXRlbXMoUkxQSXRlbSBtZW1vcnkgc2VsZikgaW50ZXJuYWwgY29uc3RhbnQgcmV0dXJucyAodWludCkgewogICAgIGlmICghaXNMaXN0KHNlbGYpKQogICAgICAgICByZXR1cm4gMDsKICAgICB1aW50IGIwOwogICAgIHVpbnQgbWVtUHRyID0gc2VsZi5fdW5zYWZlX21lbVB0cjsKICAgICBhc3NlbWJseSB7CiAgICAgICAgIGIwIDo9IGJ5dGUoMCwgbWxvYWQobWVtUHRyKSkKICAgICB9CiAgICAgdWludCBwb3MgPSBtZW1QdHIgKyBfcGF5bG9hZE9mZnNldChzZWxmKTsKICAgICB1aW50IGxhc3QgPSBtZW1QdHIgKyBzZWxmLl91bnNhZmVfbGVuZ3RoIC0gMTsKICAgICB1aW50IGl0bXM7CiAgICAgd2hpbGUocG9zIDw9IGxhc3QpIHsKICAgICAgICAgcG9zICs9IF9pdGVtTGVuZ3RoKHBvcyk7CiAgICAgICAgIGl0bXMrKzsKICAgICB9CiAgICAgcmV0dXJuIGl0bXM7CiB9CgogLy8vIEBkZXYgQ3JlYXRlIGFuIGl0ZXJhdG9yLgogLy8vIEBwYXJhbSBzZWxmIFRoZSBSTFAgaXRlbS4KIC8vLyBAcmV0dXJuIEFuICdJdGVyYXRvcicgb3ZlciB0aGUgaXRlbS4KIGZ1bmN0aW9uIGl0ZXJhdG9yKFJMUEl0ZW0gbWVtb3J5IHNlbGYpIGludGVybmFsIGNvbnN0YW50IHJldHVybnMgKEl0ZXJhdG9yIG1lbW9yeSBpdCkgewogICAgIGlmICghaXNMaXN0KHNlbGYpKQogICAgICAgICB0aHJvdzsKICAgICB1aW50IHB0ciA9IHNlbGYuX3Vuc2FmZV9tZW1QdHIgKyBfcGF5bG9hZE9mZnNldChzZWxmKTsKICAgICBpdC5fdW5zYWZlX2l0ZW0gPSBzZWxmOwogICAgIGl0Ll91bnNhZmVfbmV4dFB0ciA9IHB0cjsKIH0KCiAvLy8gQGRldiBSZXR1cm4gdGhlIFJMUCBlbmNvZGVkIGJ5dGVzLgogLy8vIEBwYXJhbSBzZWxmIFRoZSBSTFBJdGVtLgogLy8vIEByZXR1cm4gVGhlIGJ5dGVzLgogZnVuY3Rpb24gdG9CeXRlcyhSTFBJdGVtIG1lbW9yeSBzZWxmKSBpbnRlcm5hbCBjb25zdGFudCByZXR1cm5zIChieXRlcyBtZW1vcnkgYnRzKSB7CiAgICAgdmFyIGxlbiA9IHNlbGYuX3Vuc2FmZV9sZW5ndGg7CiAgICAgaWYgKGxlbiA9PSAwKQogICAgICAgICByZXR1cm47CiAgICAgYnRzID0gbmV3IGJ5dGVzKGxlbik7CiAgICAgX2NvcHlUb0J5dGVzKHNlbGYuX3Vuc2FmZV9tZW1QdHIsIGJ0cywgbGVuKTsKIH0KCiAvLy8gQGRldiBEZWNvZGUgYW4gUkxQSXRlbSBpbnRvIGJ5dGVzLiBUaGlzIHdpbGwgbm90IHdvcmsgaWYgdGhlCiAvLy8gUkxQSXRlbSBpcyBhIGxpc3QuCiAvLy8gQHBhcmFtIHNlbGYgVGhlIFJMUEl0ZW0uCiAvLy8gQHJldHVybiBUaGUgZGVjb2RlZCBzdHJpbmcuCiBmdW5jdGlvbiB0b0RhdGEoUkxQSXRlbSBtZW1vcnkgc2VsZikgaW50ZXJuYWwgY29uc3RhbnQgcmV0dXJucyAoYnl0ZXMgbWVtb3J5IGJ0cykgewogICAgIGlmKCFpc0RhdGEoc2VsZikpCiAgICAgICAgIHRocm93OwogICAgIHZhciAoclN0YXJ0UG9zLCBsZW4pID0gX2RlY29kZShzZWxmKTsKICAgICBidHMgPSBuZXcgYnl0ZXMobGVuKTsKICAgICBfY29weVRvQnl0ZXMoclN0YXJ0UG9zLCBidHMsIGxlbik7CiB9CgogLy8vIEBkZXYgR2V0IHRoZSBsaXN0IG9mIHN1Yi1pdGVtcyBmcm9tIGFuIFJMUCBlbmNvZGVkIGxpc3QuCiAvLy8gV2FybmluZzogVGhpcyBpcyBpbmVmZmljaWVudCwgYXMgaXQgcmVxdWlyZXMgdGhhdCB0aGUgbGlzdCBpcyByZWFkIHR3aWNlLgogLy8vIEBwYXJhbSBzZWxmIFRoZSBSTFAgaXRlbS4KIC8vLyBAcmV0dXJuIEFycmF5IG9mIFJMUEl0ZW1zLgogZnVuY3Rpb24gdG9MaXN0KFJMUEl0ZW0gbWVtb3J5IHNlbGYpIGludGVybmFsIGNvbnN0YW50IHJldHVybnMgKFJMUEl0ZW1bXSBtZW1vcnkgbGlzdCkgewogICAgIGlmKCFpc0xpc3Qoc2VsZikpCiAgICAgICAgIHRocm93OwogICAgIHZhciBudW1JdGVtcyA9IGl0ZW1zKHNlbGYpOwogICAgIGxpc3QgPSBuZXcgUkxQSXRlbVtdKG51bUl0ZW1zKTsKICAgICB2YXIgaXQgPSBpdGVyYXRvcihzZWxmKTsKICAgICB1aW50IGlkeDsKICAgICB3aGlsZShoYXNOZXh0KGl0KSkgewogICAgICAgICBsaXN0W2lkeF0gPSBuZXh0KGl0KTsKICAgICAgICAgaWR4Kys7CiAgICAgfQogfQoKIC8vLyBAZGV2IERlY29kZSBhbiBSTFBJdGVtIGludG8gYW4gYXNjaWkgc3RyaW5nLiBUaGlzIHdpbGwgbm90IHdvcmsgaWYgdGhlCiAvLy8gUkxQSXRlbSBpcyBhIGxpc3QuCiAvLy8gQHBhcmFtIHNlbGYgVGhlIFJMUEl0ZW0uCiAvLy8gQHJldHVybiBUaGUgZGVjb2RlZCBzdHJpbmcuCiBmdW5jdGlvbiB0b0FzY2lpKFJMUEl0ZW0gbWVtb3J5IHNlbGYpIGludGVybmFsIGNvbnN0YW50IHJldHVybnMgKHN0cmluZyBtZW1vcnkgc3RyKSB7CiAgICAgaWYoIWlzRGF0YShzZWxmKSkKICAgICAgICAgdGhyb3c7CiAgICAgdmFyIChyU3RhcnRQb3MsIGxlbikgPSBfZGVjb2RlKHNlbGYpOwogICAgIGJ5dGVzIG1lbW9yeSBidHMgPSBuZXcgYnl0ZXMobGVuKTsKICAgICBfY29weVRvQnl0ZXMoclN0YXJ0UG9zLCBidHMsIGxlbik7CiAgICAgc3RyID0gc3RyaW5nKGJ0cyk7CiB9CgogLy8vIEBkZXYgRGVjb2RlIGFuIFJMUEl0ZW0gaW50byBhIHVpbnQuIFRoaXMgd2lsbCBub3Qgd29yayBpZiB0aGUKIC8vLyBSTFBJdGVtIGlzIGEgbGlzdC4KIC8vLyBAcGFyYW0gc2VsZiBUaGUgUkxQSXRlbS4KIC8vLyBAcmV0dXJuIFRoZSBkZWNvZGVkIHN0cmluZy4KIGZ1bmN0aW9uIHRvVWludChSTFBJdGVtIG1lbW9yeSBzZWxmKSBpbnRlcm5hbCBjb25zdGFudCByZXR1cm5zICh1aW50IGRhdGEpIHsKICAgICBpZighaXNEYXRhKHNlbGYpKQogICAgICAgICB0aHJvdzsKICAgICB2YXIgKHJTdGFydFBvcywgbGVuKSA9IF9kZWNvZGUoc2VsZik7CiAgICAgaWYgKGxlbiA+IDMyIHx8IGxlbiA9PSAwKQogICAgICAgICB0aHJvdzsKICAgICBhc3NlbWJseSB7CiAgICAgICAgIGRhdGEgOj0gZGl2KG1sb2FkKHJTdGFydFBvcyksIGV4cCgyNTYsIHN1YigzMiwgbGVuKSkpCiAgICAgfQogfQoKIC8vLyBAZGV2IERlY29kZSBhbiBSTFBJdGVtIGludG8gYSBib29sZWFuLiBUaGlzIHdpbGwgbm90IHdvcmsgaWYgdGhlCiAvLy8gUkxQSXRlbSBpcyBhIGxpc3QuCiAvLy8gQHBhcmFtIHNlbGYgVGhlIFJMUEl0ZW0uCiAvLy8gQHJldHVybiBUaGUgZGVjb2RlZCBzdHJpbmcuCiBmdW5jdGlvbiB0b0Jvb2woUkxQSXRlbSBtZW1vcnkgc2VsZikgaW50ZXJuYWwgY29uc3RhbnQgcmV0dXJucyAoYm9vbCBkYXRhKSB7CiAgICAgaWYoIWlzRGF0YShzZWxmKSkKICAgICAgICAgdGhyb3c7CiAgICAgdmFyIChyU3RhcnRQb3MsIGxlbikgPSBfZGVjb2RlKHNlbGYpOwogICAgIGlmIChsZW4gIT0gMSkKICAgICAgICAgdGhyb3c7CiAgICAgdWludCB0ZW1wOwogICAgIGFzc2VtYmx5IHsKICAgICAgICAgdGVtcCA6PSBieXRlKDAsIG1sb2FkKHJTdGFydFBvcykpCiAgICAgfQogICAgIGlmICh0ZW1wID4gMSkKICAgICAgICAgdGhyb3c7CiAgICAgcmV0dXJuIHRlbXAgPT0gMSA/IHRydWUgOiBmYWxzZTsKIH0KCiAvLy8gQGRldiBEZWNvZGUgYW4gUkxQSXRlbSBpbnRvIGEgYnl0ZS4gVGhpcyB3aWxsIG5vdCB3b3JrIGlmIHRoZQogLy8vIFJMUEl0ZW0gaXMgYSBsaXN0LgogLy8vIEBwYXJhbSBzZWxmIFRoZSBSTFBJdGVtLgogLy8vIEByZXR1cm4gVGhlIGRlY29kZWQgc3RyaW5nLgogZnVuY3Rpb24gdG9CeXRlKFJMUEl0ZW0gbWVtb3J5IHNlbGYpIGludGVybmFsIGNvbnN0YW50IHJldHVybnMgKGJ5dGUgZGF0YSkgewogICAgIGlmKCFpc0RhdGEoc2VsZikpCiAgICAgICAgIHRocm93OwogICAgIHZhciAoclN0YXJ0UG9zLCBsZW4pID0gX2RlY29kZShzZWxmKTsKICAgICBpZiAobGVuICE9IDEpCiAgICAgICAgIHRocm93OwogICAgIHVpbnQgdGVtcDsKICAgICBhc3NlbWJseSB7CiAgICAgICAgIHRlbXAgOj0gYnl0ZSgwLCBtbG9hZChyU3RhcnRQb3MpKQogICAgIH0KICAgICByZXR1cm4gYnl0ZSh0ZW1wKTsKIH0KCiAvLy8gQGRldiBEZWNvZGUgYW4gUkxQSXRlbSBpbnRvIGFuIGludC4gVGhpcyB3aWxsIG5vdCB3b3JrIGlmIHRoZQogLy8vIFJMUEl0ZW0gaXMgYSBsaXN0LgogLy8vIEBwYXJhbSBzZWxmIFRoZSBSTFBJdGVtLgogLy8vIEByZXR1cm4gVGhlIGRlY29kZWQgc3RyaW5nLgogZnVuY3Rpb24gdG9JbnQoUkxQSXRlbSBtZW1vcnkgc2VsZikgaW50ZXJuYWwgY29uc3RhbnQgcmV0dXJucyAoaW50IGRhdGEpIHsKICAgICByZXR1cm4gaW50KHRvVWludChzZWxmKSk7CiB9CgogLy8vIEBkZXYgRGVjb2RlIGFuIFJMUEl0ZW0gaW50byBhIGJ5dGVzMzIuIFRoaXMgd2lsbCBub3Qgd29yayBpZiB0aGUKIC8vLyBSTFBJdGVtIGlzIGEgbGlzdC4KIC8vLyBAcGFyYW0gc2VsZiBUaGUgUkxQSXRlbS4KIC8vLyBAcmV0dXJuIFRoZSBkZWNvZGVkIHN0cmluZy4KIGZ1bmN0aW9uIHRvQnl0ZXMzMihSTFBJdGVtIG1lbW9yeSBzZWxmKSBpbnRlcm5hbCBjb25zdGFudCByZXR1cm5zIChieXRlczMyIGRhdGEpIHsKICAgICByZXR1cm4gYnl0ZXMzMih0b1VpbnQoc2VsZikpOwogfQoKIC8vLyBAZGV2IERlY29kZSBhbiBSTFBJdGVtIGludG8gYW4gYWRkcmVzcy4gVGhpcyB3aWxsIG5vdCB3b3JrIGlmIHRoZQogLy8vIFJMUEl0ZW0gaXMgYSBsaXN0LgogLy8vIEBwYXJhbSBzZWxmIFRoZSBSTFBJdGVtLgogLy8vIEByZXR1cm4gVGhlIGRlY29kZWQgc3RyaW5nLgogZnVuY3Rpb24gdG9BZGRyZXNzKFJMUEl0ZW0gbWVtb3J5IHNlbGYpIGludGVybmFsIGNvbnN0YW50IHJldHVybnMgKGFkZHJlc3MgZGF0YSkgewogICAgIGlmKCFpc0RhdGEoc2VsZikpCiAgICAgICAgIHRocm93OwogICAgIHZhciAoclN0YXJ0UG9zLCBsZW4pID0gX2RlY29kZShzZWxmKTsKICAgICBpZiAobGVuICE9IDIwKQogICAgICAgICB0aHJvdzsKICAgICBhc3NlbWJseSB7CiAgICAgICAgIGRhdGEgOj0gZGl2KG1sb2FkKHJTdGFydFBvcyksIGV4cCgyNTYsIDEyKSkKICAgICB9CiB9CgogLy8gR2V0IHRoZSBwYXlsb2FkIG9mZnNldC4KIGZ1bmN0aW9uIF9wYXlsb2FkT2Zmc2V0KFJMUEl0ZW0gbWVtb3J5IHNlbGYpIHByaXZhdGUgY29uc3RhbnQgcmV0dXJucyAodWludCkgewogICAgIGlmKHNlbGYuX3Vuc2FmZV9sZW5ndGggPT0gMCkKICAgICAgICAgcmV0dXJuIDA7CiAgICAgdWludCBiMDsKICAgICB1aW50IG1lbVB0ciA9IHNlbGYuX3Vuc2FmZV9tZW1QdHI7CiAgICAgYXNzZW1ibHkgewogICAgICAgICBiMCA6PSBieXRlKDAsIG1sb2FkKG1lbVB0cikpCiAgICAgfQogICAgIGlmKGIwIDwgREFUQV9TSE9SVF9TVEFSVCkKICAgICAgICAgcmV0dXJuIDA7CiAgICAgaWYoYjAgPCBEQVRBX0xPTkdfU1RBUlQgfHwgKGIwID49IExJU1RfU0hPUlRfU1RBUlQgJiYgYjAgPCBMSVNUX0xPTkdfU1RBUlQpKQogICAgICAgICByZXR1cm4gMTsKICAgICBpZihiMCA8IExJU1RfU0hPUlRfU1RBUlQpCiAgICAgICAgIHJldHVybiBiMCAtIERBVEFfTE9OR19PRkZTRVQgKyAxOwogICAgIHJldHVybiBiMCAtIExJU1RfTE9OR19PRkZTRVQgKyAxOwogfQoKIC8vIEdldCB0aGUgZnVsbCBsZW5ndGggb2YgYW4gUkxQIGl0ZW0uCiBmdW5jdGlvbiBfaXRlbUxlbmd0aCh1aW50IG1lbVB0cikgcHJpdmF0ZSBjb25zdGFudCByZXR1cm5zICh1aW50IGxlbikgewogICAgIHVpbnQgYjA7CiAgICAgYXNzZW1ibHkgewogICAgICAgICBiMCA6PSBieXRlKDAsIG1sb2FkKG1lbVB0cikpCiAgICAgfQogICAgIGlmIChiMCA8IERBVEFfU0hPUlRfU1RBUlQpCiAgICAgICAgIGxlbiA9IDE7CiAgICAgZWxzZSBpZiAoYjAgPCBEQVRBX0xPTkdfU1RBUlQpCiAgICAgICAgIGxlbiA9IGIwIC0gREFUQV9TSE9SVF9TVEFSVCArIDE7CiAgICAgZWxzZSBpZiAoYjAgPCBMSVNUX1NIT1JUX1NUQVJUKSB7CiAgICAgICAgIGFzc2VtYmx5IHsKICAgICAgICAgICAgIGxldCBiTGVuIDo9IHN1YihiMCwgMHhCNykgLy8gYnl0ZXMgbGVuZ3RoIChEQVRBX0xPTkdfT0ZGU0VUKQogICAgICAgICAgICAgbGV0IGRMZW4gOj0gZGl2KG1sb2FkKGFkZChtZW1QdHIsIDEpKSwgZXhwKDI1Niwgc3ViKDMyLCBiTGVuKSkpIC8vIGRhdGEgbGVuZ3RoCiAgICAgICAgICAgICBsZW4gOj0gYWRkKDEsIGFkZChiTGVuLCBkTGVuKSkgLy8gdG90YWwgbGVuZ3RoCiAgICAgICAgIH0KICAgICB9CiAgICAgZWxzZSBpZiAoYjAgPCBMSVNUX0xPTkdfU1RBUlQpCiAgICAgICAgIGxlbiA9IGIwIC0gTElTVF9TSE9SVF9TVEFSVCArIDE7CiAgICAgZWxzZSB7CiAgICAgICAgIGFzc2VtYmx5IHsKICAgICAgICAgICAgIGxldCBiTGVuIDo9IHN1YihiMCwgMHhGNykgLy8gYnl0ZXMgbGVuZ3RoIChMSVNUX0xPTkdfT0ZGU0VUKQogICAgICAgICAgICAgbGV0IGRMZW4gOj0gZGl2KG1sb2FkKGFkZChtZW1QdHIsIDEpKSwgZXhwKDI1Niwgc3ViKDMyLCBiTGVuKSkpIC8vIGRhdGEgbGVuZ3RoCiAgICAgICAgICAgICBsZW4gOj0gYWRkKDEsIGFkZChiTGVuLCBkTGVuKSkgLy8gdG90YWwgbGVuZ3RoCiAgICAgICAgIH0KICAgICB9CiB9CgogLy8gR2V0IHN0YXJ0IHBvc2l0aW9uIGFuZCBsZW5ndGggb2YgdGhlIGRhdGEuCiBmdW5jdGlvbiBfZGVjb2RlKFJMUEl0ZW0gbWVtb3J5IHNlbGYpIHByaXZhdGUgY29uc3RhbnQgcmV0dXJucyAodWludCBtZW1QdHIsIHVpbnQgbGVuKSB7CiAgICAgaWYoIWlzRGF0YShzZWxmKSkKICAgICAgICAgdGhyb3c7CiAgICAgdWludCBiMDsKICAgICB1aW50IHN0YXJ0ID0gc2VsZi5fdW5zYWZlX21lbVB0cjsKICAgICBhc3NlbWJseSB7CiAgICAgICAgIGIwIDo9IGJ5dGUoMCwgbWxvYWQoc3RhcnQpKQogICAgIH0KICAgICBpZiAoYjAgPCBEQVRBX1NIT1JUX1NUQVJUKSB7CiAgICAgICAgIG1lbVB0ciA9IHN0YXJ0OwogICAgICAgICBsZW4gPSAxOwogICAgICAgICByZXR1cm47CiAgICAgfQogICAgIGlmIChiMCA8IERBVEFfTE9OR19TVEFSVCkgewogICAgICAgICBsZW4gPSBzZWxmLl91bnNhZmVfbGVuZ3RoIC0gMTsKICAgICAgICAgbWVtUHRyID0gc3RhcnQgKyAxOwogICAgIH0gZWxzZSB7CiAgICAgICAgIHVpbnQgYkxlbjsKICAgICAgICAgYXNzZW1ibHkgewogICAgICAgICAgICAgYkxlbiA6PSBzdWIoYjAsIDB4QjcpIC8vIERBVEFfTE9OR19PRkZTRVQKICAgICAgICAgfQogICAgICAgICBsZW4gPSBzZWxmLl91bnNhZmVfbGVuZ3RoIC0gMSAtIGJMZW47CiAgICAgICAgIG1lbVB0ciA9IHN0YXJ0ICsgYkxlbiArIDE7CiAgICAgfQogICAgIHJldHVybjsKIH0KCiAvLyBBc3N1bWVzIHRoYXQgZW5vdWdoIG1lbW9yeSBoYXMgYmVlbiBhbGxvY2F0ZWQgdG8gc3RvcmUgaW4gdGFyZ2V0LgogZnVuY3Rpb24gX2NvcHlUb0J5dGVzKHVpbnQgYnRzUHRyLCBieXRlcyBtZW1vcnkgdGd0LCB1aW50IGJ0c0xlbikgcHJpdmF0ZSBjb25zdGFudCB7CiAgICAgLy8gRXhwbG9pdGluZyB0aGUgZmFjdCB0aGF0ICd0Z3QnIHdhcyB0aGUgbGFzdCB0aGluZyB0byBiZSBhbGxvY2F0ZWQsCiAgICAgLy8gd2UgY2FuIHdyaXRlIGVudGlyZSB3b3JkcywgYW5kIGp1c3Qgb3ZlcndyaXRlIGFueSBleGNlc3MuCiAgICAgYXNzZW1ibHkgewogICAgICAgICB7CiAgICAgICAgICAgICAgICAgbGV0IGkgOj0gMCAvLyBTdGFydCBhdCBhcnIgKyAweDIwCiAgICAgICAgICAgICAgICAgbGV0IHdvcmRzIDo9IGRpdihhZGQoYnRzTGVuLCAzMSksIDMyKQogICAgICAgICAgICAgICAgIGxldCByT2Zmc2V0IDo9IGJ0c1B0cgogICAgICAgICAgICAgICAgIGxldCB3T2Zmc2V0IDo9IGFkZCh0Z3QsIDB4MjApCiAgICAgICAgICAgICB0YWdfbG9vcDoKICAgICAgICAgICAgICAgICBqdW1waShlbmQsIGVxKGksIHdvcmRzKSkKICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgIGxldCBvZmZzZXQgOj0gbXVsKGksIDB4MjApCiAgICAgICAgICAgICAgICAgICAgIG1zdG9yZShhZGQod09mZnNldCwgb2Zmc2V0KSwgbWxvYWQoYWRkKHJPZmZzZXQsIG9mZnNldCkpKQogICAgICAgICAgICAgICAgICAgICBpIDo9IGFkZChpLCAxKQogICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICBqdW1wKHRhZ19sb29wKQogICAgICAgICAgICAgZW5kOgogICAgICAgICAgICAgICAgIG1zdG9yZShhZGQodGd0LCBhZGQoMHgyMCwgbWxvYWQodGd0KSkpLCAwKQogICAgICAgICB9CiAgICAgfQogfQoKIC8vIENoZWNrIHRoYXQgYW4gUkxQIGl0ZW0gaXMgdmFsaWQuCiAgICAgZnVuY3Rpb24gX3ZhbGlkYXRlKFJMUEl0ZW0gbWVtb3J5IHNlbGYpIHByaXZhdGUgY29uc3RhbnQgcmV0dXJucyAoYm9vbCByZXQpIHsKICAgICAgICAgLy8gQ2hlY2sgdGhhdCBSTFAgaXMgd2VsbC1mb3JtZWQuCiAgICAgICAgIHVpbnQgYjA7CiAgICAgICAgIHVpbnQgYjE7CiAgICAgICAgIHVpbnQgbWVtUHRyID0gc2VsZi5fdW5zYWZlX21lbVB0cjsKICAgICAgICAgYXNzZW1ibHkgewogICAgICAgICAgICAgYjAgOj0gYnl0ZSgwLCBtbG9hZChtZW1QdHIpKQogICAgICAgICAgICAgYjEgOj0gYnl0ZSgxLCBtbG9hZChtZW1QdHIpKQogICAgICAgICB9CiAgICAgICAgIGlmKGIwID09IERBVEFfU0hPUlRfU1RBUlQgKyAxICYmIGIxIDwgREFUQV9TSE9SVF9TVEFSVCkKICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgfQp9CgoKCi8vLyBAZGV2IFRoaXMgY29udHJhY3QgYWxsb3dzIGZvciBgcmVjaXBpZW50YCB0byBzZXQgYW5kIG1vZGlmeSBtaWxlc3RvbmVzCmNvbnRyYWN0IE1pbGVzdG9uZVRyYWNrZXIgewogICAgdXNpbmcgUkxQIGZvciBSTFAuUkxQSXRlbTsKICAgIHVzaW5nIFJMUCBmb3IgUkxQLkl0ZXJhdG9yOwogICAgdXNpbmcgUkxQIGZvciBieXRlczsKCiAgICBzdHJ1Y3QgTWlsZXN0b25lIHsKICAgICAgICBzdHJpbmcgZGVzY3JpcHRpb247ICAgICAvLyBEZXNjcmlwdGlvbiBvZiB0aGlzIG1pbGVzdG9uZQogICAgICAgIHN0cmluZyB1cmw7ICAgICAgICAgICAgIC8vIEEgbGluayB0byBtb3JlIGluZm9ybWF0aW9uIChzd2FybSBnYXRld2F5KQogICAgICAgIHVpbnQgbWluQ29tcGxldGlvbkRhdGU7IC8vIEVhcmxpZXN0IFVOSVggdGltZSB0aGUgbWlsZXN0b25lIGNhbiBiZSBwYWlkCiAgICAgICAgdWludCBtYXhDb21wbGV0aW9uRGF0ZTsgLy8gTGF0ZXN0IFVOSVggdGltZSB0aGUgbWlsZXN0b25lIGNhbiBiZSBwYWlkCiAgICAgICAgYWRkcmVzcyBtaWxlc3RvbmVMZWFkTGluazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBTaW1pbGFyIHRvIGByZWNpcGllbnRgYnV0IGZvciB0aGlzIG1pbGVzdG9uZQogICAgICAgIGFkZHJlc3MgcmV2aWV3ZXI7ICAgICAgIC8vIENhbiByZWplY3QgdGhlIGNvbXBsZXRpb24gb2YgdGhpcyBtaWxlc3RvbmUKICAgICAgICB1aW50IHJldmlld1RpbWU7ICAgICAgICAvLyBIb3cgbWFueSBzZWNvbmRzIHRoZSByZXZpZXdlciBoYXMgdG8gcmV2aWV3CiAgICAgICAgYWRkcmVzcyBwYXltZW50U291cmNlOyAgLy8gV2hlcmUgdGhlIG1pbGVzdG9uZSBwYXltZW50IGlzIHNlbnQgZnJvbQogICAgICAgIGJ5dGVzIHBheURhdGE7ICAgICAgICAgIC8vIERhdGEgZGVmaW5pbmcgaG93IG11Y2ggZXRoZXIgaXMgc2VudCB3aGVyZQoKICAgICAgICBNaWxlc3RvbmVTdGF0dXMgc3RhdHVzOyAvLyBDdXJyZW50IHN0YXR1cyBvZiB0aGUgbWlsZXN0b25lCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gKENvbXBsZXRlZCwgQXV0aG9yaXplZEZvclBheW1lbnQuLi4pCiAgICAgICAgdWludCBkb25lVGltZTsgICAgICAgICAgLy8gVU5JWCB0aW1lIHdoZW4gdGhlIG1pbGVzdG9uZSB3YXMgbWFya2VkIERPTkUKICAgIH0KCiAgICAvLyBUaGUgbGlzdCBvZiBhbGwgdGhlIG1pbGVzdG9uZXMuCiAgICBNaWxlc3RvbmVbXSBwdWJsaWMgbWlsZXN0b25lczsKCiAgICBhZGRyZXNzIHB1YmxpYyByZWNpcGllbnQ7ICAgLy8gQ2FsbHMgZnVuY3Rpb25zIGluIHRoZSBuYW1lIG9mIHRoZSByZWNpcGllbnQKICAgIGFkZHJlc3MgcHVibGljIGRvbm9yOyAgICAgICAvLyBDYWxscyBmdW5jdGlvbnMgaW4gdGhlIG5hbWUgb2YgdGhlIGRvbm9yCiAgICBhZGRyZXNzIHB1YmxpYyBhcmJpdHJhdG9yOyAgLy8gQ2FsbHMgZnVuY3Rpb25zIGluIHRoZSBuYW1lIG9mIHRoZSBhcmJpdHJhdG9yCgogICAgZW51bSBNaWxlc3RvbmVTdGF0dXMgewogICAgICAgIEFjY2VwdGVkQW5kSW5Qcm9ncmVzcywKICAgICAgICBDb21wbGV0ZWQsCiAgICAgICAgQXV0aG9yaXplZEZvclBheW1lbnQsCiAgICAgICAgQ2FuY2VsZWQKICAgIH0KCiAgICAvLyBUcnVlIGlmIHRoZSBjYW1wYWlnbiBoYXMgYmVlbiBjYW5jZWxlZAogICAgYm9vbCBwdWJsaWMgY2FtcGFpZ25DYW5jZWxlZDsKCiAgICAvLyBUcnVlIGlmIGFuIGFwcHJvdmFsIG9uIGEgY2hhbmdlIHRvIGBtaWxlc3RvbmVzYCBpcyBhIHBlbmRpbmcKICAgIGJvb2wgcHVibGljIGNoYW5naW5nTWlsZXN0b25lczsKCiAgICAvLyBUaGUgcGVuZGluZyBjaGFuZ2UgdG8gYG1pbGVzdG9uZXNgIGVuY29kZWQgaW4gUkxQCiAgICBieXRlcyBwdWJsaWMgcHJvcG9zZWRNaWxlc3RvbmVzOwoKCiAgICAvLy8gQGRldiBUaGUgZm9sbG93aW5nIG1vZGlmaWVycyBvbmx5IGFsbG93IHNwZWNpZmljIHJvbGVzIHRvIGNhbGwgZnVuY3Rpb25zCiAgICAvLy8gd2l0aCB0aGVzZSBtb2RpZmllcnMKICAgIG1vZGlmaWVyIG9ubHlSZWNpcGllbnQgeyBpZiAobXNnLnNlbmRlciAhPSAgcmVjaXBpZW50KSB0aHJvdzsgXzsgfQogICAgbW9kaWZpZXIgb25seUFyYml0cmF0b3IgeyBpZiAobXNnLnNlbmRlciAhPSBhcmJpdHJhdG9yKSB0aHJvdzsgXzsgfQogICAgbW9kaWZpZXIgb25seURvbm9yIHsgaWYgKG1zZy5zZW5kZXIgIT0gZG9ub3IpIHRocm93OyBfOyB9CgogICAgLy8vIEBkZXYgVGhlIGZvbGxvd2luZyBtb2RpZmllcnMgcHJldmVudCBmdW5jdGlvbnMgZnJvbSBiZWluZyBjYWxsZWQgaWYgdGhlCiAgICAvLy8gY2FtcGFpZ24gaGFzIGJlZW4gY2FuY2VsZWQgb3IgaWYgbmV3IG1pbGVzdG9uZXMgYXJlIGJlaW5nIHByb3Bvc2VkCiAgICBtb2RpZmllciBjYW1wYWlnbk5vdENhbmNlbGVkIHsgaWYgKGNhbXBhaWduQ2FuY2VsZWQpIHRocm93OyBfOyB9CiAgICBtb2RpZmllciBub3RDaGFuZ2luZyB7IGlmIChjaGFuZ2luZ01pbGVzdG9uZXMpIHRocm93OyBfOyB9CgogLy8gQGRldiBFdmVudHMgdG8gbWFrZSB0aGUgcGF5bWVudCBtb3ZlbWVudHMgZWFzeSB0byBmaW5kIG9uIHRoZSBibG9ja2NoYWluCiAgICBldmVudCBOZXdNaWxlc3RvbmVMaXN0UHJvcG9zZWQoKTsKICAgIGV2ZW50IE5ld01pbGVzdG9uZUxpc3RVbnByb3Bvc2VkKCk7CiAgICBldmVudCBOZXdNaWxlc3RvbmVMaXN0QWNjZXB0ZWQoKTsKICAgIGV2ZW50IFByb3Bvc2FsU3RhdHVzQ2hhbmdlZCh1aW50IGlkUHJvcG9zYWwsIE1pbGVzdG9uZVN0YXR1cyBuZXdQcm9wb3NhbCk7CiAgICBldmVudCBDYW1wYWlnbkNhbmNlbGVkKCk7CgoKLy8vLy8vLy8vLy8KLy8gQ29uc3RydWN0b3IKLy8vLy8vLy8vLy8KCiAgICAvLy8gQG5vdGljZSBUaGUgQ29uc3RydWN0b3IgY3JlYXRlcyB0aGUgTWlsZXN0b25lIGNvbnRyYWN0IG9uIHRoZSBibG9ja2NoYWluCiAgICAvLy8gQHBhcmFtIF9hcmJpdHJhdG9yIEFkZHJlc3MgYXNzaWduZWQgdG8gYmUgdGhlIGFyYml0cmF0b3IKICAgIC8vLyBAcGFyYW0gX2Rvbm9yIEFkZHJlc3MgYXNzaWduZWQgdG8gYmUgdGhlIGRvbm9yCiAgICAvLy8gQHBhcmFtIF9yZWNpcGllbnQgQWRkcmVzcyBhc3NpZ25lZCB0byBiZSB0aGUgcmVjaXBpZW50CiAgICBmdW5jdGlvbiBNaWxlc3RvbmVUcmFja2VyICgKICAgICAgICBhZGRyZXNzIF9hcmJpdHJhdG9yLAogICAgICAgIGFkZHJlc3MgX2Rvbm9yLAogICAgICAgIGFkZHJlc3MgX3JlY2lwaWVudAogICAgKSB7CiAgICAgICAgYXJiaXRyYXRvciA9IF9hcmJpdHJhdG9yOwogICAgICAgIGRvbm9yID0gX2Rvbm9yOwogICAgICAgIHJlY2lwaWVudCA9IF9yZWNpcGllbnQ7CiAgICB9CgoKLy8vLy8vLy8vCi8vIEhlbHBlciBmdW5jdGlvbnMKLy8vLy8vLy8vCgogICAgLy8vIEByZXR1cm4gVGhlIG51bWJlciBvZiBtaWxlc3RvbmVzIGV2ZXIgY3JlYXRlZCBldmVuIGlmIHRoZXkgd2VyZSBjYW5jZWxlZAogICAgZnVuY3Rpb24gbnVtYmVyT2ZNaWxlc3RvbmVzKCkgY29uc3RhbnQgcmV0dXJucyAodWludCkgewogICAgICAgIHJldHVybiBtaWxlc3RvbmVzLmxlbmd0aDsKICAgIH0KCgovLy8vLy8vLwovLyBDaGFuZ2UgcGxheWVycwovLy8vLy8vLwoKICAgIC8vLyBAbm90aWNlIGBvbmx5QXJiaXRyYXRvcmAgUmVhc3NpZ25zIHRoZSBhcmJpdHJhdG9yIHRvIGEgbmV3IGFkZHJlc3MKICAgIC8vLyBAcGFyYW0gX25ld0FyYml0cmF0b3IgVGhlIG5ldyBhcmJpdHJhdG9yCiAgICBmdW5jdGlvbiBjaGFuZ2VBcmJpdHJhdG9yKGFkZHJlc3MgX25ld0FyYml0cmF0b3IpIG9ubHlBcmJpdHJhdG9yIHsKICAgICAgICBhcmJpdHJhdG9yID0gX25ld0FyYml0cmF0b3I7CiAgICB9CgogICAgLy8vIEBub3RpY2UgYG9ubHlEb25vcmAgUmVhc3NpZ25zIHRoZSBgZG9ub3JgIHRvIGEgbmV3IGFkZHJlc3MKICAgIC8vLyBAcGFyYW0gX25ld0Rvbm9yIFRoZSBuZXcgZG9ub3IKICAgIGZ1bmN0aW9uIGNoYW5nZURvbm9yKGFkZHJlc3MgX25ld0Rvbm9yKSBvbmx5RG9ub3IgewogICAgICAgIGRvbm9yID0gX25ld0Rvbm9yOwogICAgfQoKICAgIC8vLyBAbm90aWNlIGBvbmx5UmVjaXBpZW50YCBSZWFzc2lnbnMgdGhlIGByZWNpcGllbnRgIHRvIGEgbmV3IGFkZHJlc3MKICAgIC8vLyBAcGFyYW0gX25ld1JlY2lwaWVudCBUaGUgbmV3IHJlY2lwaWVudAogICAgZnVuY3Rpb24gY2hhbmdlUmVjaXBpZW50KGFkZHJlc3MgX25ld1JlY2lwaWVudCkgb25seVJlY2lwaWVudCB7CiAgICAgICAgcmVjaXBpZW50ID0gX25ld1JlY2lwaWVudDsKICAgIH0KCgovLy8vLy8vLy8vLy8KLy8gQ3JlYXRpb24gYW5kIG1vZGlmaWNhdGlvbiBvZiBNaWxlc3RvbmVzCi8vLy8vLy8vLy8vLwoKICAgIC8vLyBAbm90aWNlIGBvbmx5UmVjaXBpZW50YCBQcm9wb3NlcyBuZXcgbWlsZXN0b25lcyBvciBjaGFuZ2VzIG9sZAogICAgLy8vICBtaWxlc3RvbmVzLCB0aGlzIHdpbGwgcmVxdWlyZSBhIHVzZXIgaW50ZXJmYWNlIHRvIGJlIGJ1aWx0IHVwIHRvCiAgICAvLy8gIHN1cHBvcnQgdGhpcyBmdW5jdGlvbmFsaXR5IGFzIGFza3MgZm9yIFJMUCBlbmNvZGVkIGJ5dGVjb2RlIHRvIGJlCiAgICAvLy8gIGdlbmVyYXRlZCwgdW50aWwgdGhpcyBpbnRlcmZhY2UgaXMgYnVpbHQgeW91IGNhbiB1c2UgdGhpcyBzY3JpcHQ6CiAgICAvLy8gIGh0dHBzOi8vZ2l0aHViLmNvbS9HaXZldGgvbWlsZXN0b25ldHJhY2tlci9ibG9iL21hc3Rlci9qcy9taWxlc3RvbmV0cmFja2VyX2hlbHBlci5qcwogICAgLy8vICB0aGUgZnVuY3Rpb25zIG1pbGVzdG9uZXMyYnl0ZXMgYW5kIGJ5dGVzMm1pbGVzdG9uZXMgd2lsbCBlbmFibGUgdGhlCiAgICAvLy8gIHJlY2lwaWVudCB0byBlbmNvZGUgYW5kIGRlY29kZSBhIGxpc3Qgb2YgbWlsZXN0b25lcywgYWxzbyBzZWUKICAgIC8vLyAgaHR0cHM6Ly9naXRodWIuY29tL0dpdmV0aC9taWxlc3RvbmV0cmFja2VyL2Jsb2IvbWFzdGVyL1JFQURNRS5tZAogICAgLy8vIEBwYXJhbSBfbmV3TWlsZXN0b25lcyBUaGUgUkxQIGVuY29kZWQgbGlzdCBvZiBtaWxlc3RvbmVzOyBlYWNoIG1pbGVzdG9uZQogICAgLy8vICBoYXMgdGhlc2UgZmllbGRzOgogICAgLy8vICAgICAgIHN0cmluZyBkZXNjcmlwdGlvbiwKICAgIC8vLyAgICAgICBzdHJpbmcgdXJsLAogICAgLy8vICAgICAgIHVpbnQgbWluQ29tcGxldGlvbkRhdGUsICAvLyBzZWNvbmRzIHNpbmNlIDEvMS8xOTcwIChVTklYIHRpbWUpCiAgICAvLy8gICAgICAgdWludCBtYXhDb21wbGV0aW9uRGF0ZSwgIC8vIHNlY29uZHMgc2luY2UgMS8xLzE5NzAgKFVOSVggdGltZSkKICAgIC8vLyAgICAgICBhZGRyZXNzIG1pbGVzdG9uZUxlYWRMaW5rLAogICAgLy8vICAgICAgIGFkZHJlc3MgcmV2aWV3ZXIsCiAgICAvLy8gICAgICAgdWludCByZXZpZXdUaW1lCiAgICAvLy8gICAgICAgYWRkcmVzcyBwYXltZW50U291cmNlLAogICAgLy8vICAgICAgIGJ5dGVzIHBheURhdGEsCiAgICBmdW5jdGlvbiBwcm9wb3NlTWlsZXN0b25lcyhieXRlcyBfbmV3TWlsZXN0b25lcwogICAgKSBvbmx5UmVjaXBpZW50IGNhbXBhaWduTm90Q2FuY2VsZWQgewogICAgICAgIHByb3Bvc2VkTWlsZXN0b25lcyA9IF9uZXdNaWxlc3RvbmVzOwogICAgICAgIGNoYW5naW5nTWlsZXN0b25lcyA9IHRydWU7CiAgICAgICAgTmV3TWlsZXN0b25lTGlzdFByb3Bvc2VkKCk7CiAgICB9CgoKLy8vLy8vLy8vLy8vCi8vIE5vcm1hbCBhY3Rpb25zIHRoYXQgd2lsbCBjaGFuZ2UgdGhlIHN0YXRlIG9mIHRoZSBtaWxlc3RvbmVzCi8vLy8vLy8vLy8vLwoKICAgIC8vLyBAbm90aWNlIGBvbmx5UmVjaXBpZW50YCBDYW5jZWxzIHRoZSBwcm9wb3NlZCBtaWxlc3RvbmVzIGFuZCByZWFjdGl2YXRlcwogICAgLy8vICB0aGUgcHJldmlvdXMgc2V0IG9mIG1pbGVzdG9uZXMKICAgIGZ1bmN0aW9uIHVucHJvcG9zZU1pbGVzdG9uZXMoKSBvbmx5UmVjaXBpZW50IGNhbXBhaWduTm90Q2FuY2VsZWQgewogICAgICAgIGRlbGV0ZSBwcm9wb3NlZE1pbGVzdG9uZXM7CiAgICAgICAgY2hhbmdpbmdNaWxlc3RvbmVzID0gZmFsc2U7CiAgICAgICAgTmV3TWlsZXN0b25lTGlzdFVucHJvcG9zZWQoKTsKICAgIH0KCiAgICAvLy8gQG5vdGljZSBgb25seURvbm9yYCBBcHByb3ZlcyB0aGUgcHJvcG9zZWQgbWlsZXN0b25lIGxpc3QKICAgIC8vLyBAcGFyYW0gX2hhc2hQcm9wb3NhbHMgVGhlIHNoYTMoKSBvZiB0aGUgcHJvcG9zZWQgbWlsZXN0b25lIGxpc3QncwogICAgLy8vICBieXRlY29kZTsgdGhpcyBjb25maXJtcyB0aGF0IHRoZSBgZG9ub3JgIGtub3dzIHRoZSBzZXQgb2YgbWlsZXN0b25lcwogICAgLy8vICB0aGV5IGFyZSBhcHByb3ZpbmcKICAgIGZ1bmN0aW9uIGFjY2VwdFByb3Bvc2VkTWlsZXN0b25lcyhieXRlczMyIF9oYXNoUHJvcG9zYWxzCiAgICApIG9ubHlEb25vciBjYW1wYWlnbk5vdENhbmNlbGVkIHsKCiAgICAgICAgdWludCBpOwoKICAgICAgICBpZiAoIWNoYW5naW5nTWlsZXN0b25lcykgdGhyb3c7CiAgICAgICAgaWYgKHNoYTMocHJvcG9zZWRNaWxlc3RvbmVzKSAhPSBfaGFzaFByb3Bvc2FscykgdGhyb3c7CgogICAgICAgIC8vIENhbmNlbCBhbGwgdGhlIHVuZmluaXNoZWQgbWlsZXN0b25lcwogICAgICAgIGZvciAoaT0wOyBpPG1pbGVzdG9uZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgaWYgKG1pbGVzdG9uZXNbaV0uc3RhdHVzICE9IE1pbGVzdG9uZVN0YXR1cy5BdXRob3JpemVkRm9yUGF5bWVudCkgewogICAgICAgICAgICAgICAgbWlsZXN0b25lc1tpXS5zdGF0dXMgPSBNaWxlc3RvbmVTdGF0dXMuQ2FuY2VsZWQ7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgLy8gRGVjb2RlIHRoZSBSTFAgZW5jb2RlZCBtaWxlc3RvbmVzIGFuZCBhZGQgdGhlbSB0byB0aGUgbWlsZXN0b25lcyBsaXN0CiAgICAgICAgYnl0ZXMgbWVtb3J5IG1Qcm9wb3NlZE1pbGVzdG9uZXMgPSBwcm9wb3NlZE1pbGVzdG9uZXM7CgogICAgICAgIHZhciBpdG1Qcm9wb3NhbHMgPSBtUHJvcG9zZWRNaWxlc3RvbmVzLnRvUkxQSXRlbSh0cnVlKTsKCiAgICAgICAgaWYgKCFpdG1Qcm9wb3NhbHMuaXNMaXN0KCkpIHRocm93OwoKICAgICAgICB2YXIgaXRyUHJvcG9zYWxzID0gaXRtUHJvcG9zYWxzLml0ZXJhdG9yKCk7CgogICAgICAgIHdoaWxlKGl0clByb3Bvc2Fscy5oYXNOZXh0KCkpIHsKCgogICAgICAgICAgICB2YXIgaXRtUHJvcG9zYWwgPSBpdHJQcm9wb3NhbHMubmV4dCgpOwoKICAgICAgICAgICAgTWlsZXN0b25lIG1pbGVzdG9uZSA9IG1pbGVzdG9uZXNbbWlsZXN0b25lcy5sZW5ndGggKytdOwoKICAgICAgICAgICAgaWYgKCFpdG1Qcm9wb3NhbC5pc0xpc3QoKSkgdGhyb3c7CgogICAgICAgICAgICB2YXIgaXRyUHJvcG9zYWwgPSBpdG1Qcm9wb3NhbC5pdGVyYXRvcigpOwoKICAgICAgICAgICAgbWlsZXN0b25lLmRlc2NyaXB0aW9uID0gaXRyUHJvcG9zYWwubmV4dCgpLnRvQXNjaWkoKTsKICAgICAgICAgICAgbWlsZXN0b25lLnVybCA9IGl0clByb3Bvc2FsLm5leHQoKS50b0FzY2lpKCk7CiAgICAgICAgICAgIG1pbGVzdG9uZS5taW5Db21wbGV0aW9uRGF0ZSA9IGl0clByb3Bvc2FsLm5leHQoKS50b1VpbnQoKTsKICAgICAgICAgICAgbWlsZXN0b25lLm1heENvbXBsZXRpb25EYXRlID0gaXRyUHJvcG9zYWwubmV4dCgpLnRvVWludCgpOwogICAgICAgICAgICBtaWxlc3RvbmUubWlsZXN0b25lTGVhZExpbmsgPSBpdHJQcm9wb3NhbC5uZXh0KCkudG9BZGRyZXNzKCk7CiAgICAgICAgICAgIG1pbGVzdG9uZS5yZXZpZXdlciA9IGl0clByb3Bvc2FsLm5leHQoKS50b0FkZHJlc3MoKTsKICAgICAgICAgICAgbWlsZXN0b25lLnJldmlld1RpbWUgPSBpdHJQcm9wb3NhbC5uZXh0KCkudG9VaW50KCk7CiAgICAgICAgICAgIG1pbGVzdG9uZS5wYXltZW50U291cmNlID0gaXRyUHJvcG9zYWwubmV4dCgpLnRvQWRkcmVzcygpOwogICAgICAgICAgICBtaWxlc3RvbmUucGF5RGF0YSA9IGl0clByb3Bvc2FsLm5leHQoKS50b0RhdGEoKTsKCiAgICAgICAgICAgIG1pbGVzdG9uZS5zdGF0dXMgPSBNaWxlc3RvbmVTdGF0dXMuQWNjZXB0ZWRBbmRJblByb2dyZXNzOwoKICAgICAgICB9CgogICAgICAgIGRlbGV0ZSBwcm9wb3NlZE1pbGVzdG9uZXM7CiAgICAgICAgY2hhbmdpbmdNaWxlc3RvbmVzID0gZmFsc2U7CiAgICAgICAgTmV3TWlsZXN0b25lTGlzdEFjY2VwdGVkKCk7CiAgICB9CgogICAgLy8vIEBub3RpY2UgYG9ubHlSZWNpcGllbnRPckxlYWRMaW5rYE1hcmtzIGEgbWlsZXN0b25lIGFzIERPTkUgYW5kCiAgICAvLy8gIHJlYWR5IGZvciByZXZpZXcKICAgIC8vLyBAcGFyYW0gX2lkTWlsZXN0b25lIElEIG9mIHRoZSBtaWxlc3RvbmUgdGhhdCBoYXMgYmVlbiBjb21wbGV0ZWQKICAgIGZ1bmN0aW9uIG1hcmtNaWxlc3RvbmVDb21wbGV0ZSh1aW50IF9pZE1pbGVzdG9uZSkKICAgICAgICBjYW1wYWlnbk5vdENhbmNlbGVkIG5vdENoYW5naW5nCiAgICB7CiAgICAgICAgaWYgKF9pZE1pbGVzdG9uZSA+PSBtaWxlc3RvbmVzLmxlbmd0aCkgdGhyb3c7CiAgICAgICAgTWlsZXN0b25lIG1pbGVzdG9uZSA9IG1pbGVzdG9uZXNbX2lkTWlsZXN0b25lXTsKICAgICAgICBpZiAoICAobXNnLnNlbmRlciAhPSBtaWxlc3RvbmUubWlsZXN0b25lTGVhZExpbmspCiAgICAgICAgICAgICYmKG1zZy5zZW5kZXIgIT0gcmVjaXBpZW50KSkKICAgICAgICAgICAgdGhyb3c7CiAgICAgICAgaWYgKG1pbGVzdG9uZS5zdGF0dXMgIT0gTWlsZXN0b25lU3RhdHVzLkFjY2VwdGVkQW5kSW5Qcm9ncmVzcykgdGhyb3c7CiAgICAgICAgaWYgKG5vdyA8IG1pbGVzdG9uZS5taW5Db21wbGV0aW9uRGF0ZSkgdGhyb3c7CiAgICAgICAgaWYgKG5vdyA+IG1pbGVzdG9uZS5tYXhDb21wbGV0aW9uRGF0ZSkgdGhyb3c7CiAgICAgICAgbWlsZXN0b25lLnN0YXR1cyA9IE1pbGVzdG9uZVN0YXR1cy5Db21wbGV0ZWQ7CiAgICAgICAgbWlsZXN0b25lLmRvbmVUaW1lID0gbm93OwogICAgICAgIFByb3Bvc2FsU3RhdHVzQ2hhbmdlZChfaWRNaWxlc3RvbmUsIG1pbGVzdG9uZS5zdGF0dXMpOwogICAgfQoKICAgIC8vLyBAbm90aWNlIGBvbmx5UmV2aWV3ZXJgIEFwcHJvdmVzIGEgc3BlY2lmaWMgbWlsZXN0b25lCiAgICAvLy8gQHBhcmFtIF9pZE1pbGVzdG9uZSBJRCBvZiB0aGUgbWlsZXN0b25lIHRoYXQgaXMgYXBwcm92ZWQKICAgIGZ1bmN0aW9uIGFwcHJvdmVDb21wbGV0ZWRNaWxlc3RvbmUodWludCBfaWRNaWxlc3RvbmUpCiAgICAgICAgY2FtcGFpZ25Ob3RDYW5jZWxlZCBub3RDaGFuZ2luZwogICAgewogICAgICAgIGlmIChfaWRNaWxlc3RvbmUgPj0gbWlsZXN0b25lcy5sZW5ndGgpIHRocm93OwogICAgICAgIE1pbGVzdG9uZSBtaWxlc3RvbmUgPSBtaWxlc3RvbmVzW19pZE1pbGVzdG9uZV07CiAgICAgICAgaWYgKChtc2cuc2VuZGVyICE9IG1pbGVzdG9uZS5yZXZpZXdlcikgfHwKICAgICAgICAgICAgKG1pbGVzdG9uZS5zdGF0dXMgIT0gTWlsZXN0b25lU3RhdHVzLkNvbXBsZXRlZCkpIHRocm93OwoKICAgICAgICBhdXRob3JpemVQYXltZW50KF9pZE1pbGVzdG9uZSk7CiAgICB9CgogICAgLy8vIEBub3RpY2UgYG9ubHlSZXZpZXdlcmAgUmVqZWN0cyBhIHNwZWNpZmljIG1pbGVzdG9uZSdzIGNvbXBsZXRpb24gYW5kCiAgICAvLy8gIHJldmVydHMgdGhlIGBtaWxlc3RvbmUuc3RhdHVzYCBiYWNrIHRvIHRoZSBgQWNjZXB0ZWRBbmRJblByb2dyZXNzYAogICAgLy8vICBzdGF0ZQogICAgLy8vIEBwYXJhbSBfaWRNaWxlc3RvbmUgSUQgb2YgdGhlIG1pbGVzdG9uZSB0aGF0IGlzIGJlaW5nIHJlamVjdGVkCiAgICBmdW5jdGlvbiByZWplY3RNaWxlc3RvbmUodWludCBfaWRNaWxlc3RvbmUpCiAgICAgICAgY2FtcGFpZ25Ob3RDYW5jZWxlZCBub3RDaGFuZ2luZwogICAgewogICAgICAgIGlmIChfaWRNaWxlc3RvbmUgPj0gbWlsZXN0b25lcy5sZW5ndGgpIHRocm93OwogICAgICAgIE1pbGVzdG9uZSBtaWxlc3RvbmUgPSBtaWxlc3RvbmVzW19pZE1pbGVzdG9uZV07CiAgICAgICAgaWYgKChtc2cuc2VuZGVyICE9IG1pbGVzdG9uZS5yZXZpZXdlcikgfHwKICAgICAgICAgICAgKG1pbGVzdG9uZS5zdGF0dXMgIT0gTWlsZXN0b25lU3RhdHVzLkNvbXBsZXRlZCkpIHRocm93OwoKICAgICAgICBtaWxlc3RvbmUuc3RhdHVzID0gTWlsZXN0b25lU3RhdHVzLkFjY2VwdGVkQW5kSW5Qcm9ncmVzczsKICAgICAgICBQcm9wb3NhbFN0YXR1c0NoYW5nZWQoX2lkTWlsZXN0b25lLCBtaWxlc3RvbmUuc3RhdHVzKTsKICAgIH0KCiAgICAvLy8gQG5vdGljZSBgb25seVJlY2lwaWVudE9yTGVhZExpbmtgIFNlbmRzIHRoZSBtaWxlc3RvbmUgcGF5bWVudCBhcwogICAgLy8vICBzcGVjaWZpZWQgaW4gYHBheURhdGFgOyB0aGUgcmVjaXBpZW50IGNhbiBvbmx5IGNhbGwgdGhpcyBhZnRlciB0aGUKICAgIC8vLyAgYHJldmlld1RpbWVgIGhhcyBlbGFwc2VkCiAgICAvLy8gQHBhcmFtIF9pZE1pbGVzdG9uZSBJRCBvZiB0aGUgbWlsZXN0b25lIHRvIGJlIHBhaWQgb3V0CiAgICBmdW5jdGlvbiByZXF1ZXN0TWlsZXN0b25lUGF5bWVudCh1aW50IF9pZE1pbGVzdG9uZQogICAgICAgICkgY2FtcGFpZ25Ob3RDYW5jZWxlZCBub3RDaGFuZ2luZyB7CiAgICAgICAgaWYgKF9pZE1pbGVzdG9uZSA+PSBtaWxlc3RvbmVzLmxlbmd0aCkgdGhyb3c7CiAgICAgICAgTWlsZXN0b25lIG1pbGVzdG9uZSA9IG1pbGVzdG9uZXNbX2lkTWlsZXN0b25lXTsKICAgICAgICBpZiAoICAobXNnLnNlbmRlciAhPSBtaWxlc3RvbmUubWlsZXN0b25lTGVhZExpbmspCiAgICAgICAgICAgICYmKG1zZy5zZW5kZXIgIT0gcmVjaXBpZW50KSkKICAgICAgICAgICAgdGhyb3c7CiAgICAgICAgaWYgICgobWlsZXN0b25lLnN0YXR1cyAhPSBNaWxlc3RvbmVTdGF0dXMuQ29tcGxldGVkKSB8fAogICAgICAgICAgICAgKG5vdyA8IG1pbGVzdG9uZS5kb25lVGltZSArIG1pbGVzdG9uZS5yZXZpZXdUaW1lKSkKICAgICAgICAgICAgdGhyb3c7CgogICAgICAgIGF1dGhvcml6ZVBheW1lbnQoX2lkTWlsZXN0b25lKTsKICAgIH0KCiAgICAvLy8gQG5vdGljZSBgb25seVJlY2lwaWVudGAgQ2FuY2VscyBhIHByZXZpb3VzbHkgYWNjZXB0ZWQgbWlsZXN0b25lCiAgICAvLy8gQHBhcmFtIF9pZE1pbGVzdG9uZSBJRCBvZiB0aGUgbWlsZXN0b25lIHRvIGJlIGNhbmNlbGVkCiAgICBmdW5jdGlvbiBjYW5jZWxNaWxlc3RvbmUodWludCBfaWRNaWxlc3RvbmUpCiAgICAgICAgb25seVJlY2lwaWVudCBjYW1wYWlnbk5vdENhbmNlbGVkIG5vdENoYW5naW5nCiAgICB7CiAgICAgICAgaWYgKF9pZE1pbGVzdG9uZSA+PSBtaWxlc3RvbmVzLmxlbmd0aCkgdGhyb3c7CiAgICAgICAgTWlsZXN0b25lIG1pbGVzdG9uZSA9IG1pbGVzdG9uZXNbX2lkTWlsZXN0b25lXTsKICAgICAgICBpZiAgKChtaWxlc3RvbmUuc3RhdHVzICE9IE1pbGVzdG9uZVN0YXR1cy5BY2NlcHRlZEFuZEluUHJvZ3Jlc3MpICYmCiAgICAgICAgICAgICAobWlsZXN0b25lLnN0YXR1cyAhPSBNaWxlc3RvbmVTdGF0dXMuQ29tcGxldGVkKSkKICAgICAgICAgICAgdGhyb3c7CgogICAgICAgIG1pbGVzdG9uZS5zdGF0dXMgPSBNaWxlc3RvbmVTdGF0dXMuQ2FuY2VsZWQ7CiAgICAgICAgUHJvcG9zYWxTdGF0dXNDaGFuZ2VkKF9pZE1pbGVzdG9uZSwgbWlsZXN0b25lLnN0YXR1cyk7CiAgICB9CgogICAgLy8vIEBub3RpY2UgYG9ubHlBcmJpdHJhdG9yYCBGb3JjZXMgYSBtaWxlc3RvbmUgdG8gYmUgcGFpZCBvdXQgYXMgbG9uZyBhcyBpdAogICAgLy8vIGhhcyBub3QgYmVlbiBwYWlkIG9yIGNhbmNlbGVkCiAgICAvLy8gQHBhcmFtIF9pZE1pbGVzdG9uZSBJRCBvZiB0aGUgbWlsZXN0b25lIHRvIGJlIHBhaWQgb3V0CiAgICBmdW5jdGlvbiBhcmJpdHJhdGVBcHByb3ZlTWlsZXN0b25lKHVpbnQgX2lkTWlsZXN0b25lCiAgICApIG9ubHlBcmJpdHJhdG9yIGNhbXBhaWduTm90Q2FuY2VsZWQgbm90Q2hhbmdpbmcgewogICAgICAgIGlmIChfaWRNaWxlc3RvbmUgPj0gbWlsZXN0b25lcy5sZW5ndGgpIHRocm93OwogICAgICAgIE1pbGVzdG9uZSBtaWxlc3RvbmUgPSBtaWxlc3RvbmVzW19pZE1pbGVzdG9uZV07CiAgICAgICAgaWYgICgobWlsZXN0b25lLnN0YXR1cyAhPSBNaWxlc3RvbmVTdGF0dXMuQWNjZXB0ZWRBbmRJblByb2dyZXNzKSAmJgogICAgICAgICAgICAgKG1pbGVzdG9uZS5zdGF0dXMgIT0gTWlsZXN0b25lU3RhdHVzLkNvbXBsZXRlZCkpCiAgICAgICAgICAgdGhyb3c7CiAgICAgICAgYXV0aG9yaXplUGF5bWVudChfaWRNaWxlc3RvbmUpOwogICAgfQoKICAgIC8vLyBAbm90aWNlIGBvbmx5QXJiaXRyYXRvcmAgQ2FuY2VscyB0aGUgZW50aXJlIGNhbXBhaWduIHZvaWRpbmcgYWxsCiAgICAvLy8gIG1pbGVzdG9uZXMgdm8KICAgIGZ1bmN0aW9uIGFyYml0cmF0ZUNhbmNlbENhbXBhaWduKCkgb25seUFyYml0cmF0b3IgY2FtcGFpZ25Ob3RDYW5jZWxlZCB7CiAgICAgICAgY2FtcGFpZ25DYW5jZWxlZCA9IHRydWU7CiAgICAgICAgQ2FtcGFpZ25DYW5jZWxlZCgpOwogICAgfQoKICAgIC8vIEBkZXYgVGhpcyBpbnRlcm5hbCBmdW5jdGlvbiBpcyBleGVjdXRlZCB3aGVuIHRoZSBtaWxlc3RvbmUgaXMgcGFpZCBvdXQKICAgIGZ1bmN0aW9uIGF1dGhvcml6ZVBheW1lbnQodWludCBfaWRNaWxlc3RvbmUpIGludGVybmFsIHsKICAgICAgICBpZiAoX2lkTWlsZXN0b25lID49IG1pbGVzdG9uZXMubGVuZ3RoKSB0aHJvdzsKICAgICAgICBNaWxlc3RvbmUgbWlsZXN0b25lID0gbWlsZXN0b25lc1tfaWRNaWxlc3RvbmVdOwogICAgICAgIC8vIFJlY2hlY2sgYWdhaW4gdG8gbm90IHBheSB0d2ljZQogICAgICAgIGlmIChtaWxlc3RvbmUuc3RhdHVzID09IE1pbGVzdG9uZVN0YXR1cy5BdXRob3JpemVkRm9yUGF5bWVudCkgdGhyb3c7CiAgICAgICAgbWlsZXN0b25lLnN0YXR1cyA9IE1pbGVzdG9uZVN0YXR1cy5BdXRob3JpemVkRm9yUGF5bWVudDsKICAgICAgICBpZiAoIW1pbGVzdG9uZS5wYXltZW50U291cmNlLmNhbGwudmFsdWUoMCkobWlsZXN0b25lLnBheURhdGEpKQogICAgICAgICAgICB0aHJvdzsKICAgICAgICBQcm9wb3NhbFN0YXR1c0NoYW5nZWQoX2lkTWlsZXN0b25lLCBtaWxlc3RvbmUuc3RhdHVzKTsKICAgIH0KfQ=='.
	

]
