Class {
	#name : #SRT69569ec8ddf4dbd0a48a96bf7ab37e62cfe2c3ec,
	#superclass : #SRTContracts,
	#category : #SolidityTestingResources
}

{ #category : #base64 }
SRT69569ec8ddf4dbd0a48a96bf7ab37e62cfe2c3ec >> base64 [
	^ 'cHJhZ21hIHNvbGlkaXR5IF4wLjQuMTg7CgppbnRlcmZhY2UgQnVybmFibGVUb2tlbiB7CiAgICBmdW5jdGlvbiB0cmFuc2ZlckZyb20oYWRkcmVzcyBfZnJvbSwgYWRkcmVzcyBfdG8sIHVpbnQgX3ZhbHVlKSBwdWJsaWMgcmV0dXJucyAoYm9vbCk7CiAgICBmdW5jdGlvbiBidXJuRnJvbShhZGRyZXNzIF9mcm9tLCB1aW50MjU2IF92YWx1ZSkgcHVibGljIHJldHVybnMgKGJvb2wpOwp9CgppbnRlcmZhY2UgRVJDMjAgewogICAgZnVuY3Rpb24gdG90YWxTdXBwbHkoKSBwdWJsaWMgdmlldyByZXR1cm5zICh1aW50IHN1cHBseSk7CiAgICBmdW5jdGlvbiBiYWxhbmNlT2YoYWRkcmVzcyBfb3duZXIpIHB1YmxpYyB2aWV3IHJldHVybnMgKHVpbnQgYmFsYW5jZSk7CiAgICBmdW5jdGlvbiB0cmFuc2ZlcihhZGRyZXNzIF90bywgdWludCBfdmFsdWUpIHB1YmxpYyByZXR1cm5zIChib29sIHN1Y2Nlc3MpOwogICAgZnVuY3Rpb24gdHJhbnNmZXJGcm9tKGFkZHJlc3MgX2Zyb20sIGFkZHJlc3MgX3RvLCB1aW50IF92YWx1ZSkgcHVibGljIHJldHVybnMgKGJvb2wgc3VjY2Vzcyk7CiAgICBmdW5jdGlvbiBhcHByb3ZlKGFkZHJlc3MgX3NwZW5kZXIsIHVpbnQgX3ZhbHVlKSBwdWJsaWMgcmV0dXJucyAoYm9vbCBzdWNjZXNzKTsKICAgIGZ1bmN0aW9uIGFsbG93YW5jZShhZGRyZXNzIF9vd25lciwgYWRkcmVzcyBfc3BlbmRlcikgcHVibGljIHZpZXcgcmV0dXJucyAodWludCByZW1haW5pbmcpOwogICAgZnVuY3Rpb24gZGVjaW1hbHMoKSBwdWJsaWMgdmlldyByZXR1cm5zKHVpbnQgZGlnaXRzKTsKICAgIGV2ZW50IEFwcHJvdmFsKGFkZHJlc3MgaW5kZXhlZCBfb3duZXIsIGFkZHJlc3MgaW5kZXhlZCBfc3BlbmRlciwgdWludCBfdmFsdWUpOwp9CgppbnRlcmZhY2UgU2FuaXR5UmF0ZXNJbnRlcmZhY2UgewogICAgZnVuY3Rpb24gZ2V0U2FuaXR5UmF0ZShFUkMyMCBzcmMsIEVSQzIwIGRlc3QpIHB1YmxpYyB2aWV3IHJldHVybnModWludCk7Cn0KCmNvbnRyYWN0IFV0aWxzIHsKCiAgICBFUkMyMCBjb25zdGFudCBpbnRlcm5hbCBFVEhfVE9LRU5fQUREUkVTUyA9IEVSQzIwKDB4MDBlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlKTsKICAgIHVpbnQgIGNvbnN0YW50IGludGVybmFsIFBSRUNJU0lPTiA9ICgxMCoqMTgpOwogICAgdWludCAgY29uc3RhbnQgaW50ZXJuYWwgTUFYX1FUWSAgID0gKDEwKioyOCk7IC8vIDFCIHRva2VucwogICAgdWludCAgY29uc3RhbnQgaW50ZXJuYWwgTUFYX1JBVEUgID0gKFBSRUNJU0lPTiAqIDEwKio2KTsgLy8gdXAgdG8gMU0gdG9rZW5zIHBlciBFVEgKICAgIHVpbnQgIGNvbnN0YW50IGludGVybmFsIE1BWF9ERUNJTUFMUyA9IDE4OwoKICAgIGZ1bmN0aW9uIGNhbGNEc3RRdHkodWludCBzcmNRdHksIHVpbnQgc3JjRGVjaW1hbHMsIHVpbnQgZHN0RGVjaW1hbHMsIHVpbnQgcmF0ZSkgaW50ZXJuYWwgcHVyZSByZXR1cm5zKHVpbnQpIHsKICAgICAgICBpZiAoZHN0RGVjaW1hbHMgPj0gc3JjRGVjaW1hbHMpIHsKICAgICAgICAgICAgcmVxdWlyZSgoZHN0RGVjaW1hbHMgLSBzcmNEZWNpbWFscykgPD0gTUFYX0RFQ0lNQUxTKTsKICAgICAgICAgICAgcmV0dXJuIChzcmNRdHkgKiByYXRlICogKDEwKiooZHN0RGVjaW1hbHMgLSBzcmNEZWNpbWFscykpKSAvIFBSRUNJU0lPTjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXF1aXJlKChzcmNEZWNpbWFscyAtIGRzdERlY2ltYWxzKSA8PSBNQVhfREVDSU1BTFMpOwogICAgICAgICAgICByZXR1cm4gKHNyY1F0eSAqIHJhdGUpIC8gKFBSRUNJU0lPTiAqICgxMCoqKHNyY0RlY2ltYWxzIC0gZHN0RGVjaW1hbHMpKSk7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGNhbGNTcmNRdHkodWludCBkc3RRdHksIHVpbnQgc3JjRGVjaW1hbHMsIHVpbnQgZHN0RGVjaW1hbHMsIHVpbnQgcmF0ZSkgaW50ZXJuYWwgcHVyZSByZXR1cm5zKHVpbnQpIHsKICAgICAgICAvL3NvdXJjZSBxdWFudGl0eSBpcyByb3VuZGVkIHVwLiB0byBhdm9pZCBkZXN0IHF1YW50aXR5IGJlaW5nIHRvbyBsb3cuCiAgICAgICAgdWludCBudW1lcmF0b3I7CiAgICAgICAgdWludCBkZW5vbWluYXRvcjsKICAgICAgICBpZiAoc3JjRGVjaW1hbHMgPj0gZHN0RGVjaW1hbHMpIHsKICAgICAgICAgICAgcmVxdWlyZSgoc3JjRGVjaW1hbHMgLSBkc3REZWNpbWFscykgPD0gTUFYX0RFQ0lNQUxTKTsKICAgICAgICAgICAgbnVtZXJhdG9yID0gKFBSRUNJU0lPTiAqIGRzdFF0eSAqICgxMCoqKHNyY0RlY2ltYWxzIC0gZHN0RGVjaW1hbHMpKSk7CiAgICAgICAgICAgIGRlbm9taW5hdG9yID0gcmF0ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXF1aXJlKChkc3REZWNpbWFscyAtIHNyY0RlY2ltYWxzKSA8PSBNQVhfREVDSU1BTFMpOwogICAgICAgICAgICBudW1lcmF0b3IgPSAoUFJFQ0lTSU9OICogZHN0UXR5KTsKICAgICAgICAgICAgZGVub21pbmF0b3IgPSAocmF0ZSAqICgxMCoqKGRzdERlY2ltYWxzIC0gc3JjRGVjaW1hbHMpKSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiAobnVtZXJhdG9yICsgZGVub21pbmF0b3IgLSAxKSAvIGRlbm9taW5hdG9yOyAvL2F2b2lkIHJvdW5kaW5nIGRvd24gZXJyb3JzCiAgICB9Cn0KCmludGVyZmFjZSBGZWVCdXJuZXJJbnRlcmZhY2UgewogICAgZnVuY3Rpb24gaGFuZGxlRmVlcyAodWludCB0cmFkZVdlaUFtb3VudCwgYWRkcmVzcyByZXNlcnZlLCBhZGRyZXNzIHdhbGxldCkgcHVibGljIHJldHVybnMoYm9vbCk7Cn0KCmludGVyZmFjZSBFeHBlY3RlZFJhdGVJbnRlcmZhY2UgewogICAgZnVuY3Rpb24gZ2V0RXhwZWN0ZWRSYXRlKEVSQzIwIHNyYywgRVJDMjAgZGVzdCwgdWludCBzcmNRdHkpIHB1YmxpYyB2aWV3CiAgICAgICAgcmV0dXJucyAodWludCBleHBlY3RlZFJhdGUsIHVpbnQgc2xpcHBhZ2VSYXRlKTsKfQoKY29udHJhY3QgUGVybWlzc2lvbkdyb3VwcyB7CgogICAgYWRkcmVzcyBwdWJsaWMgYWRtaW47CiAgICBhZGRyZXNzIHB1YmxpYyBwZW5kaW5nQWRtaW47CiAgICBtYXBwaW5nKGFkZHJlc3M9PmJvb2wpIGludGVybmFsIG9wZXJhdG9yczsKICAgIG1hcHBpbmcoYWRkcmVzcz0+Ym9vbCkgaW50ZXJuYWwgYWxlcnRlcnM7CiAgICBhZGRyZXNzW10gaW50ZXJuYWwgb3BlcmF0b3JzR3JvdXA7CiAgICBhZGRyZXNzW10gaW50ZXJuYWwgYWxlcnRlcnNHcm91cDsKCiAgICBmdW5jdGlvbiBQZXJtaXNzaW9uR3JvdXBzKCkgcHVibGljIHsKICAgICAgICBhZG1pbiA9IG1zZy5zZW5kZXI7CiAgICB9CgogICAgbW9kaWZpZXIgb25seUFkbWluKCkgewogICAgICAgIHJlcXVpcmUobXNnLnNlbmRlciA9PSBhZG1pbik7CiAgICAgICAgXzsKICAgIH0KCiAgICBtb2RpZmllciBvbmx5T3BlcmF0b3IoKSB7CiAgICAgICAgcmVxdWlyZShvcGVyYXRvcnNbbXNnLnNlbmRlcl0pOwogICAgICAgIF87CiAgICB9CgogICAgbW9kaWZpZXIgb25seUFsZXJ0ZXIoKSB7CiAgICAgICAgcmVxdWlyZShhbGVydGVyc1ttc2cuc2VuZGVyXSk7CiAgICAgICAgXzsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRPcGVyYXRvcnMgKCkgZXh0ZXJuYWwgdmlldyByZXR1cm5zKGFkZHJlc3NbXSkgewogICAgICAgIHJldHVybiBvcGVyYXRvcnNHcm91cDsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRBbGVydGVycyAoKSBleHRlcm5hbCB2aWV3IHJldHVybnMoYWRkcmVzc1tdKSB7CiAgICAgICAgcmV0dXJuIGFsZXJ0ZXJzR3JvdXA7CiAgICB9CgogICAgZXZlbnQgVHJhbnNmZXJBZG1pblBlbmRpbmcoYWRkcmVzcyBwZW5kaW5nQWRtaW4pOwoKICAgIC8qKgogICAgICogQGRldiBBbGxvd3MgdGhlIGN1cnJlbnQgYWRtaW4gdG8gc2V0IHRoZSBwZW5kaW5nQWRtaW4gYWRkcmVzcy4KICAgICAqIEBwYXJhbSBuZXdBZG1pbiBUaGUgYWRkcmVzcyB0byB0cmFuc2ZlciBvd25lcnNoaXAgdG8uCiAgICAgKi8KICAgIGZ1bmN0aW9uIHRyYW5zZmVyQWRtaW4oYWRkcmVzcyBuZXdBZG1pbikgcHVibGljIG9ubHlBZG1pbiB7CiAgICAgICAgcmVxdWlyZShuZXdBZG1pbiAhPSBhZGRyZXNzKDApKTsKICAgICAgICBUcmFuc2ZlckFkbWluUGVuZGluZyhwZW5kaW5nQWRtaW4pOwogICAgICAgIHBlbmRpbmdBZG1pbiA9IG5ld0FkbWluOwogICAgfQoKICAgIGV2ZW50IEFkbWluQ2xhaW1lZCggYWRkcmVzcyBuZXdBZG1pbiwgYWRkcmVzcyBwcmV2aW91c0FkbWluKTsKCiAgICAvKioKICAgICAqIEBkZXYgQWxsb3dzIHRoZSBwZW5kaW5nQWRtaW4gYWRkcmVzcyB0byBmaW5hbGl6ZSB0aGUgY2hhbmdlIGFkbWluIHByb2Nlc3MuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNsYWltQWRtaW4oKSBwdWJsaWMgewogICAgICAgIHJlcXVpcmUocGVuZGluZ0FkbWluID09IG1zZy5zZW5kZXIpOwogICAgICAgIEFkbWluQ2xhaW1lZChwZW5kaW5nQWRtaW4sIGFkbWluKTsKICAgICAgICBhZG1pbiA9IHBlbmRpbmdBZG1pbjsKICAgICAgICBwZW5kaW5nQWRtaW4gPSBhZGRyZXNzKDApOwogICAgfQoKICAgIGV2ZW50IEFsZXJ0ZXJBZGRlZCAoYWRkcmVzcyBuZXdBbGVydGVyLCBib29sIGlzQWRkKTsKCiAgICBmdW5jdGlvbiBhZGRBbGVydGVyKGFkZHJlc3MgbmV3QWxlcnRlcikgcHVibGljIG9ubHlBZG1pbiB7CiAgICAgICAgcmVxdWlyZSghYWxlcnRlcnNbbmV3QWxlcnRlcl0pOyAvLyBwcmV2ZW50IGR1cGxpY2F0ZXMuCiAgICAgICAgQWxlcnRlckFkZGVkKG5ld0FsZXJ0ZXIsIHRydWUpOwogICAgICAgIGFsZXJ0ZXJzW25ld0FsZXJ0ZXJdID0gdHJ1ZTsKICAgICAgICBhbGVydGVyc0dyb3VwLnB1c2gobmV3QWxlcnRlcik7CiAgICB9CgogICAgZnVuY3Rpb24gcmVtb3ZlQWxlcnRlciAoYWRkcmVzcyBhbGVydGVyKSBwdWJsaWMgb25seUFkbWluIHsKICAgICAgICByZXF1aXJlKGFsZXJ0ZXJzW2FsZXJ0ZXJdKTsKICAgICAgICBhbGVydGVyc1thbGVydGVyXSA9IGZhbHNlOwoKICAgICAgICBmb3IgKHVpbnQgaSA9IDA7IGkgPCBhbGVydGVyc0dyb3VwLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgIGlmIChhbGVydGVyc0dyb3VwW2ldID09IGFsZXJ0ZXIpIHsKICAgICAgICAgICAgICAgIGFsZXJ0ZXJzR3JvdXBbaV0gPSBhbGVydGVyc0dyb3VwW2FsZXJ0ZXJzR3JvdXAubGVuZ3RoIC0gMV07CiAgICAgICAgICAgICAgICBhbGVydGVyc0dyb3VwLmxlbmd0aC0tOwogICAgICAgICAgICAgICAgQWxlcnRlckFkZGVkKGFsZXJ0ZXIsIGZhbHNlKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIGV2ZW50IE9wZXJhdG9yQWRkZWQoYWRkcmVzcyBuZXdPcGVyYXRvciwgYm9vbCBpc0FkZCk7CgogICAgZnVuY3Rpb24gYWRkT3BlcmF0b3IoYWRkcmVzcyBuZXdPcGVyYXRvcikgcHVibGljIG9ubHlBZG1pbiB7CiAgICAgICAgcmVxdWlyZSghb3BlcmF0b3JzW25ld09wZXJhdG9yXSk7IC8vIHByZXZlbnQgZHVwbGljYXRlcy4KICAgICAgICBPcGVyYXRvckFkZGVkKG5ld09wZXJhdG9yLCB0cnVlKTsKICAgICAgICBvcGVyYXRvcnNbbmV3T3BlcmF0b3JdID0gdHJ1ZTsKICAgICAgICBvcGVyYXRvcnNHcm91cC5wdXNoKG5ld09wZXJhdG9yKTsKICAgIH0KCiAgICBmdW5jdGlvbiByZW1vdmVPcGVyYXRvciAoYWRkcmVzcyBvcGVyYXRvcikgcHVibGljIG9ubHlBZG1pbiB7CiAgICAgICAgcmVxdWlyZShvcGVyYXRvcnNbb3BlcmF0b3JdKTsKICAgICAgICBvcGVyYXRvcnNbb3BlcmF0b3JdID0gZmFsc2U7CgogICAgICAgIGZvciAodWludCBpID0gMDsgaSA8IG9wZXJhdG9yc0dyb3VwLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgIGlmIChvcGVyYXRvcnNHcm91cFtpXSA9PSBvcGVyYXRvcikgewogICAgICAgICAgICAgICAgb3BlcmF0b3JzR3JvdXBbaV0gPSBvcGVyYXRvcnNHcm91cFtvcGVyYXRvcnNHcm91cC5sZW5ndGggLSAxXTsKICAgICAgICAgICAgICAgIG9wZXJhdG9yc0dyb3VwLmxlbmd0aCAtPSAxOwogICAgICAgICAgICAgICAgT3BlcmF0b3JBZGRlZChvcGVyYXRvciwgZmFsc2UpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Cn0KCmNvbnRyYWN0IFdpdGhkcmF3YWJsZSBpcyBQZXJtaXNzaW9uR3JvdXBzIHsKCiAgICBldmVudCBUb2tlbldpdGhkcmF3KEVSQzIwIHRva2VuLCB1aW50IGFtb3VudCwgYWRkcmVzcyBzZW5kVG8pOwoKICAgIC8qKgogICAgICogQGRldiBXaXRoZHJhdyBhbGwgRVJDMjAgY29tcGF0aWJsZSB0b2tlbnMKICAgICAqIEBwYXJhbSB0b2tlbiBFUkMyMCBUaGUgYWRkcmVzcyBvZiB0aGUgdG9rZW4gY29udHJhY3QKICAgICAqLwogICAgZnVuY3Rpb24gd2l0aGRyYXdUb2tlbihFUkMyMCB0b2tlbiwgdWludCBhbW91bnQsIGFkZHJlc3Mgc2VuZFRvKSBleHRlcm5hbCBvbmx5QWRtaW4gewogICAgICAgIHJlcXVpcmUodG9rZW4udHJhbnNmZXIoc2VuZFRvLCBhbW91bnQpKTsKICAgICAgICBUb2tlbldpdGhkcmF3KHRva2VuLCBhbW91bnQsIHNlbmRUbyk7CiAgICB9CgogICAgZXZlbnQgRXRoZXJXaXRoZHJhdyh1aW50IGFtb3VudCwgYWRkcmVzcyBzZW5kVG8pOwoKICAgIC8qKgogICAgICogQGRldiBXaXRoZHJhdyBFdGhlcnMKICAgICAqLwogICAgZnVuY3Rpb24gd2l0aGRyYXdFdGhlcih1aW50IGFtb3VudCwgYWRkcmVzcyBzZW5kVG8pIGV4dGVybmFsIG9ubHlBZG1pbiB7CiAgICAgICAgc2VuZFRvLnRyYW5zZmVyKGFtb3VudCk7CiAgICAgICAgRXRoZXJXaXRoZHJhdyhhbW91bnQsIHNlbmRUbyk7CiAgICB9Cn0KCmNvbnRyYWN0IEV4cGVjdGVkUmF0ZSBpcyBXaXRoZHJhd2FibGUsIEV4cGVjdGVkUmF0ZUludGVyZmFjZSB7CgogICAgS3liZXJOZXR3b3JrIGludGVybmFsIGt5YmVyTmV0d29yazsKICAgIHVpbnQgcHVibGljIHF1YW50aXR5RmFjdG9yID0gMjsKICAgIHVpbnQgcHVibGljIG1pblNsaXBwYWdlRmFjdG9ySW5CcHMgPSA1MDsKCiAgICBmdW5jdGlvbiBFeHBlY3RlZFJhdGUoS3liZXJOZXR3b3JrIF9reWJlck5ldHdvcmssIGFkZHJlc3MgX2FkbWluKSBwdWJsaWMgewogICAgICAgIHJlcXVpcmUoX2FkbWluICE9IGFkZHJlc3MoMCkpOwogICAgICAgIHJlcXVpcmUoX2t5YmVyTmV0d29yayAhPSBhZGRyZXNzKDApKTsKICAgICAgICBreWJlck5ldHdvcmsgPSBfa3liZXJOZXR3b3JrOwogICAgICAgIGFkbWluID0gX2FkbWluOwogICAgfQoKICAgIGV2ZW50IFF1YW50aXR5RmFjdG9yU2V0ICh1aW50IG5ld0ZhY3RvciwgdWludCBvbGRGYWN0b3IsIGFkZHJlc3Mgc2VuZGVyKTsKCiAgICBmdW5jdGlvbiBzZXRRdWFudGl0eUZhY3Rvcih1aW50IG5ld0ZhY3RvcikgcHVibGljIG9ubHlPcGVyYXRvciB7CiAgICAgICAgUXVhbnRpdHlGYWN0b3JTZXQocXVhbnRpdHlGYWN0b3IsIG5ld0ZhY3RvciwgbXNnLnNlbmRlcik7CiAgICAgICAgcXVhbnRpdHlGYWN0b3IgPSBuZXdGYWN0b3I7CiAgICB9CgogICAgZXZlbnQgTWluU2xpcHBhZ2VGYWN0b3JTZXQgKHVpbnQgbmV3TWluLCB1aW50IG9sZE1pbiwgYWRkcmVzcyBzZW5kZXIpOwoKICAgIGZ1bmN0aW9uIHNldE1pblNsaXBwYWdlRmFjdG9yKHVpbnQgYnBzKSBwdWJsaWMgb25seU9wZXJhdG9yIHsKICAgICAgICBNaW5TbGlwcGFnZUZhY3RvclNldChicHMsIG1pblNsaXBwYWdlRmFjdG9ySW5CcHMsIG1zZy5zZW5kZXIpOwogICAgICAgIG1pblNsaXBwYWdlRmFjdG9ySW5CcHMgPSBicHM7CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0RXhwZWN0ZWRSYXRlKEVSQzIwIHNyYywgRVJDMjAgZGVzdCwgdWludCBzcmNRdHkpCiAgICAgICAgcHVibGljIHZpZXcKICAgICAgICByZXR1cm5zICh1aW50IGV4cGVjdGVkUmF0ZSwgdWludCBzbGlwcGFnZVJhdGUpCiAgICB7CiAgICAgICAgcmVxdWlyZShxdWFudGl0eUZhY3RvciAhPSAwKTsKCiAgICAgICAgdWludCBiZXN0UmVzZXJ2ZTsKICAgICAgICB1aW50IG1pblNsaXBwYWdlOwoKICAgICAgICAoYmVzdFJlc2VydmUsIGV4cGVjdGVkUmF0ZSkgPSBreWJlck5ldHdvcmsuZmluZEJlc3RSYXRlKHNyYywgZGVzdCwgc3JjUXR5KTsKICAgICAgICAoYmVzdFJlc2VydmUsIHNsaXBwYWdlUmF0ZSkgPSBreWJlck5ldHdvcmsuZmluZEJlc3RSYXRlKHNyYywgZGVzdCwgKHNyY1F0eSAqIHF1YW50aXR5RmFjdG9yKSk7CgogICAgICAgIG1pblNsaXBwYWdlID0gKCgxMDAwMCAtIG1pblNsaXBwYWdlRmFjdG9ySW5CcHMpICogZXhwZWN0ZWRSYXRlKSAvIDEwMDAwOwogICAgICAgIGlmIChzbGlwcGFnZVJhdGUgPj0gbWluU2xpcHBhZ2UpIHsKICAgICAgICAgICAgc2xpcHBhZ2VSYXRlID0gbWluU2xpcHBhZ2U7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gKGV4cGVjdGVkUmF0ZSwgc2xpcHBhZ2VSYXRlKTsKICAgIH0KfQoKY29udHJhY3QgVm9sdW1lSW1iYWxhbmNlUmVjb3JkZXIgaXMgV2l0aGRyYXdhYmxlIHsKCiAgICB1aW50IGNvbnN0YW50IGludGVybmFsIFNMSURJTkdfV0lORE9XX1NJWkUgPSA1OwogICAgdWludCBjb25zdGFudCBpbnRlcm5hbCBQT1dfMl82NCA9IDIgKiogNjQ7CgogICAgc3RydWN0IFRva2VuQ29udHJvbEluZm8gewogICAgICAgIHVpbnQgbWluaW1hbFJlY29yZFJlc29sdXRpb247IC8vIGNhbiBiZSByb3VnaGx5IDEgY2VudAogICAgICAgIHVpbnQgbWF4UGVyQmxvY2tJbWJhbGFuY2U7IC8vIGluIHR3ZWkgcmVzb2x1dGlvbgogICAgICAgIHVpbnQgbWF4VG90YWxJbWJhbGFuY2U7IC8vIG1heCB0b3RhbCBpbWJhbGFuY2UgKGJldHdlZW4gcmF0ZSB1cGRhdGVzKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gYmVmb3JlIGhhbHRpbmcgdHJhZGUKICAgIH0KCiAgICBtYXBwaW5nKGFkZHJlc3MgPT4gVG9rZW5Db250cm9sSW5mbykgaW50ZXJuYWwgdG9rZW5Db250cm9sSW5mbzsKCiAgICBzdHJ1Y3QgVG9rZW5JbWJhbGFuY2VEYXRhIHsKICAgICAgICBpbnQgIGxhc3RCbG9ja0J1eVVuaXRzSW1iYWxhbmNlOwogICAgICAgIHVpbnQgbGFzdEJsb2NrOwoKICAgICAgICBpbnQgIHRvdGFsQnV5VW5pdHNJbWJhbGFuY2U7CiAgICAgICAgdWludCBsYXN0UmF0ZVVwZGF0ZUJsb2NrOwogICAgfQoKICAgIG1hcHBpbmcoYWRkcmVzcyA9PiBtYXBwaW5nKHVpbnQ9PnVpbnQpKSBwdWJsaWMgdG9rZW5JbWJhbGFuY2VEYXRhOwoKICAgIGZ1bmN0aW9uIFZvbHVtZUltYmFsYW5jZVJlY29yZGVyKGFkZHJlc3MgX2FkbWluKSBwdWJsaWMgewogICAgICAgIHJlcXVpcmUoX2FkbWluICE9IGFkZHJlc3MoMCkpOwogICAgICAgIGFkbWluID0gX2FkbWluOwogICAgfQoKICAgIGZ1bmN0aW9uIHNldFRva2VuQ29udHJvbEluZm8oCiAgICAgICAgRVJDMjAgdG9rZW4sCiAgICAgICAgdWludCBtaW5pbWFsUmVjb3JkUmVzb2x1dGlvbiwKICAgICAgICB1aW50IG1heFBlckJsb2NrSW1iYWxhbmNlLAogICAgICAgIHVpbnQgbWF4VG90YWxJbWJhbGFuY2UKICAgICkKICAgICAgICBwdWJsaWMKICAgICAgICBvbmx5QWRtaW4KICAgIHsKICAgICAgICB0b2tlbkNvbnRyb2xJbmZvW3Rva2VuXSA9CiAgICAgICAgICAgIFRva2VuQ29udHJvbEluZm8oCiAgICAgICAgICAgICAgICBtaW5pbWFsUmVjb3JkUmVzb2x1dGlvbiwKICAgICAgICAgICAgICAgIG1heFBlckJsb2NrSW1iYWxhbmNlLAogICAgICAgICAgICAgICAgbWF4VG90YWxJbWJhbGFuY2UKICAgICAgICAgICAgKTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRUb2tlbkNvbnRyb2xJbmZvKEVSQzIwIHRva2VuKSBwdWJsaWMgdmlldyByZXR1cm5zKHVpbnQsIHVpbnQsIHVpbnQpIHsKICAgICAgICByZXR1cm4gKHRva2VuQ29udHJvbEluZm9bdG9rZW5dLm1pbmltYWxSZWNvcmRSZXNvbHV0aW9uLAogICAgICAgICAgICAgICAgdG9rZW5Db250cm9sSW5mb1t0b2tlbl0ubWF4UGVyQmxvY2tJbWJhbGFuY2UsCiAgICAgICAgICAgICAgICB0b2tlbkNvbnRyb2xJbmZvW3Rva2VuXS5tYXhUb3RhbEltYmFsYW5jZSk7CiAgICB9CgogICAgZnVuY3Rpb24gYWRkSW1iYWxhbmNlKAogICAgICAgIEVSQzIwIHRva2VuLAogICAgICAgIGludCBidXlBbW91bnQsCiAgICAgICAgdWludCByYXRlVXBkYXRlQmxvY2ssCiAgICAgICAgdWludCBjdXJyZW50QmxvY2sKICAgICkKICAgICAgICBpbnRlcm5hbAogICAgewogICAgICAgIHVpbnQgY3VycmVudEJsb2NrSW5kZXggPSBjdXJyZW50QmxvY2sgJSBTTElESU5HX1dJTkRPV19TSVpFOwogICAgICAgIGludCByZWNvcmRlZEJ1eUFtb3VudCA9IGludChidXlBbW91bnQgLyBpbnQodG9rZW5Db250cm9sSW5mb1t0b2tlbl0ubWluaW1hbFJlY29yZFJlc29sdXRpb24pKTsKCiAgICAgICAgaW50IHByZXZJbWJhbGFuY2UgPSAwOwoKICAgICAgICBUb2tlbkltYmFsYW5jZURhdGEgbWVtb3J5IGN1cnJlbnRCbG9ja0RhdGEgPQogICAgICAgICAgICBkZWNvZGVUb2tlbkltYmFsYW5jZURhdGEodG9rZW5JbWJhbGFuY2VEYXRhW3Rva2VuXVtjdXJyZW50QmxvY2tJbmRleF0pOwoKICAgICAgICAvLyBmaXJzdCBzY2VuYXJpbyAtIHRoaXMgaXMgbm90IHRoZSBmaXJzdCB0eCBpbiB0aGUgY3VycmVudCBibG9jawogICAgICAgIGlmIChjdXJyZW50QmxvY2tEYXRhLmxhc3RCbG9jayA9PSBjdXJyZW50QmxvY2spIHsKICAgICAgICAgICAgaWYgKHVpbnQoY3VycmVudEJsb2NrRGF0YS5sYXN0UmF0ZVVwZGF0ZUJsb2NrKSA9PSByYXRlVXBkYXRlQmxvY2spIHsKICAgICAgICAgICAgICAgIC8vIGp1c3QgaW5jcmVhc2UgaW1iYWxhbmNlCiAgICAgICAgICAgICAgICBjdXJyZW50QmxvY2tEYXRhLmxhc3RCbG9ja0J1eVVuaXRzSW1iYWxhbmNlICs9IHJlY29yZGVkQnV5QW1vdW50OwogICAgICAgICAgICAgICAgY3VycmVudEJsb2NrRGF0YS50b3RhbEJ1eVVuaXRzSW1iYWxhbmNlICs9IHJlY29yZGVkQnV5QW1vdW50OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gaW1iYWxhbmNlIHdhcyBjaGFuZ2VkIGluIHRoZSBtaWRkbGUgb2YgdGhlIGJsb2NrCiAgICAgICAgICAgICAgICBwcmV2SW1iYWxhbmNlID0gZ2V0SW1iYWxhbmNlSW5SYW5nZSh0b2tlbiwgcmF0ZVVwZGF0ZUJsb2NrLCBjdXJyZW50QmxvY2spOwogICAgICAgICAgICAgICAgY3VycmVudEJsb2NrRGF0YS50b3RhbEJ1eVVuaXRzSW1iYWxhbmNlID0gaW50KHByZXZJbWJhbGFuY2UpICsgcmVjb3JkZWRCdXlBbW91bnQ7CiAgICAgICAgICAgICAgICBjdXJyZW50QmxvY2tEYXRhLmxhc3RCbG9ja0J1eVVuaXRzSW1iYWxhbmNlICs9IHJlY29yZGVkQnV5QW1vdW50OwogICAgICAgICAgICAgICAgY3VycmVudEJsb2NrRGF0YS5sYXN0UmF0ZVVwZGF0ZUJsb2NrID0gdWludChyYXRlVXBkYXRlQmxvY2spOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gZmlyc3QgdHggaW4gdGhlIGN1cnJlbnQgYmxvY2sKICAgICAgICAgICAgaW50IGN1cnJlbnRCbG9ja0ltYmFsYW5jZTsKICAgICAgICAgICAgKHByZXZJbWJhbGFuY2UsIGN1cnJlbnRCbG9ja0ltYmFsYW5jZSkgPSBnZXRJbWJhbGFuY2VTaW5jZVJhdGVVcGRhdGUodG9rZW4sIHJhdGVVcGRhdGVCbG9jaywgY3VycmVudEJsb2NrKTsKCiAgICAgICAgICAgIGN1cnJlbnRCbG9ja0RhdGEubGFzdEJsb2NrQnV5VW5pdHNJbWJhbGFuY2UgPSByZWNvcmRlZEJ1eUFtb3VudDsKICAgICAgICAgICAgY3VycmVudEJsb2NrRGF0YS5sYXN0QmxvY2sgPSB1aW50KGN1cnJlbnRCbG9jayk7CiAgICAgICAgICAgIGN1cnJlbnRCbG9ja0RhdGEubGFzdFJhdGVVcGRhdGVCbG9jayA9IHVpbnQocmF0ZVVwZGF0ZUJsb2NrKTsKICAgICAgICAgICAgY3VycmVudEJsb2NrRGF0YS50b3RhbEJ1eVVuaXRzSW1iYWxhbmNlID0gaW50KHByZXZJbWJhbGFuY2UpICsgcmVjb3JkZWRCdXlBbW91bnQ7CiAgICAgICAgfQoKICAgICAgICB0b2tlbkltYmFsYW5jZURhdGFbdG9rZW5dW2N1cnJlbnRCbG9ja0luZGV4XSA9IGVuY29kZVRva2VuSW1iYWxhbmNlRGF0YShjdXJyZW50QmxvY2tEYXRhKTsKICAgIH0KCiAgICBmdW5jdGlvbiBzZXRHYXJiYWdlVG9Wb2x1bWVSZWNvcmRlcihFUkMyMCB0b2tlbikgaW50ZXJuYWwgewogICAgICAgIGZvciAodWludCBpID0gMDsgaSA8IFNMSURJTkdfV0lORE9XX1NJWkU7IGkrKykgewogICAgICAgICAgICB0b2tlbkltYmFsYW5jZURhdGFbdG9rZW5dW2ldID0gMHgxOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBnZXRJbWJhbGFuY2VJblJhbmdlKEVSQzIwIHRva2VuLCB1aW50IHN0YXJ0QmxvY2ssIHVpbnQgZW5kQmxvY2spIGludGVybmFsIHZpZXcgcmV0dXJucyhpbnQgYnV5SW1iYWxhbmNlKSB7CiAgICAgICAgLy8gY2hlY2sgdGhlIGltYmFsYW5jZSBpbiB0aGUgc2xpZGluZyB3aW5kb3cKICAgICAgICByZXF1aXJlKHN0YXJ0QmxvY2sgPD0gZW5kQmxvY2spOwoKICAgICAgICBidXlJbWJhbGFuY2UgPSAwOwoKICAgICAgICBmb3IgKHVpbnQgd2luZG93SW5kID0gMDsgd2luZG93SW5kIDwgU0xJRElOR19XSU5ET1dfU0laRTsgd2luZG93SW5kKyspIHsKICAgICAgICAgICAgVG9rZW5JbWJhbGFuY2VEYXRhIG1lbW9yeSBwZXJCbG9ja0RhdGEgPSBkZWNvZGVUb2tlbkltYmFsYW5jZURhdGEodG9rZW5JbWJhbGFuY2VEYXRhW3Rva2VuXVt3aW5kb3dJbmRdKTsKCiAgICAgICAgICAgIGlmIChwZXJCbG9ja0RhdGEubGFzdEJsb2NrIDw9IGVuZEJsb2NrICYmIHBlckJsb2NrRGF0YS5sYXN0QmxvY2sgPj0gc3RhcnRCbG9jaykgewogICAgICAgICAgICAgICAgYnV5SW1iYWxhbmNlICs9IGludChwZXJCbG9ja0RhdGEubGFzdEJsb2NrQnV5VW5pdHNJbWJhbGFuY2UpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGdldEltYmFsYW5jZVNpbmNlUmF0ZVVwZGF0ZShFUkMyMCB0b2tlbiwgdWludCByYXRlVXBkYXRlQmxvY2ssIHVpbnQgY3VycmVudEJsb2NrKQogICAgICAgIGludGVybmFsIHZpZXcKICAgICAgICByZXR1cm5zKGludCBidXlJbWJhbGFuY2UsIGludCBjdXJyZW50QmxvY2tJbWJhbGFuY2UpCiAgICB7CiAgICAgICAgYnV5SW1iYWxhbmNlID0gMDsKICAgICAgICBjdXJyZW50QmxvY2tJbWJhbGFuY2UgPSAwOwogICAgICAgIHVpbnQgbGF0ZXN0QmxvY2sgPSAwOwogICAgICAgIGludCBpbWJhbGFuY2VJblJhbmdlID0gMDsKICAgICAgICB1aW50IHN0YXJ0QmxvY2sgPSByYXRlVXBkYXRlQmxvY2s7CiAgICAgICAgdWludCBlbmRCbG9jayA9IGN1cnJlbnRCbG9jazsKCiAgICAgICAgZm9yICh1aW50IHdpbmRvd0luZCA9IDA7IHdpbmRvd0luZCA8IFNMSURJTkdfV0lORE9XX1NJWkU7IHdpbmRvd0luZCsrKSB7CiAgICAgICAgICAgIFRva2VuSW1iYWxhbmNlRGF0YSBtZW1vcnkgcGVyQmxvY2tEYXRhID0gZGVjb2RlVG9rZW5JbWJhbGFuY2VEYXRhKHRva2VuSW1iYWxhbmNlRGF0YVt0b2tlbl1bd2luZG93SW5kXSk7CgogICAgICAgICAgICBpZiAocGVyQmxvY2tEYXRhLmxhc3RCbG9jayA8PSBlbmRCbG9jayAmJiBwZXJCbG9ja0RhdGEubGFzdEJsb2NrID49IHN0YXJ0QmxvY2spIHsKICAgICAgICAgICAgICAgIGltYmFsYW5jZUluUmFuZ2UgKz0gcGVyQmxvY2tEYXRhLmxhc3RCbG9ja0J1eVVuaXRzSW1iYWxhbmNlOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAocGVyQmxvY2tEYXRhLmxhc3RSYXRlVXBkYXRlQmxvY2sgIT0gcmF0ZVVwZGF0ZUJsb2NrKSBjb250aW51ZTsKICAgICAgICAgICAgaWYgKHBlckJsb2NrRGF0YS5sYXN0QmxvY2sgPCBsYXRlc3RCbG9jaykgY29udGludWU7CgogICAgICAgICAgICBsYXRlc3RCbG9jayA9IHBlckJsb2NrRGF0YS5sYXN0QmxvY2s7CiAgICAgICAgICAgIGJ1eUltYmFsYW5jZSA9IHBlckJsb2NrRGF0YS50b3RhbEJ1eVVuaXRzSW1iYWxhbmNlOwogICAgICAgICAgICBpZiAodWludChwZXJCbG9ja0RhdGEubGFzdEJsb2NrKSA9PSBjdXJyZW50QmxvY2spIHsKICAgICAgICAgICAgICAgIGN1cnJlbnRCbG9ja0ltYmFsYW5jZSA9IHBlckJsb2NrRGF0YS5sYXN0QmxvY2tCdXlVbml0c0ltYmFsYW5jZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKGJ1eUltYmFsYW5jZSA9PSAwKSB7CiAgICAgICAgICAgIGJ1eUltYmFsYW5jZSA9IGltYmFsYW5jZUluUmFuZ2U7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGdldEltYmFsYW5jZShFUkMyMCB0b2tlbiwgdWludCByYXRlVXBkYXRlQmxvY2ssIHVpbnQgY3VycmVudEJsb2NrKQogICAgICAgIGludGVybmFsIHZpZXcKICAgICAgICByZXR1cm5zKGludCB0b3RhbEltYmFsYW5jZSwgaW50IGN1cnJlbnRCbG9ja0ltYmFsYW5jZSkKICAgIHsKCiAgICAgICAgaW50IHJlc29sdXRpb24gPSBpbnQodG9rZW5Db250cm9sSW5mb1t0b2tlbl0ubWluaW1hbFJlY29yZFJlc29sdXRpb24pOwoKICAgICAgICAodG90YWxJbWJhbGFuY2UsIGN1cnJlbnRCbG9ja0ltYmFsYW5jZSkgPQogICAgICAgICAgICBnZXRJbWJhbGFuY2VTaW5jZVJhdGVVcGRhdGUoCiAgICAgICAgICAgICAgICB0b2tlbiwKICAgICAgICAgICAgICAgIHJhdGVVcGRhdGVCbG9jaywKICAgICAgICAgICAgICAgIGN1cnJlbnRCbG9jayk7CgogICAgICAgIHRvdGFsSW1iYWxhbmNlICo9IHJlc29sdXRpb247CiAgICAgICAgY3VycmVudEJsb2NrSW1iYWxhbmNlICo9IHJlc29sdXRpb247CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0TWF4UGVyQmxvY2tJbWJhbGFuY2UoRVJDMjAgdG9rZW4pIGludGVybmFsIHZpZXcgcmV0dXJucyh1aW50KSB7CiAgICAgICAgcmV0dXJuIHRva2VuQ29udHJvbEluZm9bdG9rZW5dLm1heFBlckJsb2NrSW1iYWxhbmNlOwogICAgfQoKICAgIGZ1bmN0aW9uIGdldE1heFRvdGFsSW1iYWxhbmNlKEVSQzIwIHRva2VuKSBpbnRlcm5hbCB2aWV3IHJldHVybnModWludCkgewogICAgICAgIHJldHVybiB0b2tlbkNvbnRyb2xJbmZvW3Rva2VuXS5tYXhUb3RhbEltYmFsYW5jZTsKICAgIH0KCiAgICBmdW5jdGlvbiBlbmNvZGVUb2tlbkltYmFsYW5jZURhdGEoVG9rZW5JbWJhbGFuY2VEYXRhIGRhdGEpIGludGVybmFsIHB1cmUgcmV0dXJucyh1aW50KSB7CiAgICAgICAgLy8gY2hlY2sgZm9yIG92ZXJmbG93cwogICAgICAgIHJlcXVpcmUoZGF0YS5sYXN0QmxvY2tCdXlVbml0c0ltYmFsYW5jZSA8IGludChQT1dfMl82NCAvIDIpKTsKICAgICAgICByZXF1aXJlKGRhdGEubGFzdEJsb2NrQnV5VW5pdHNJbWJhbGFuY2UgPiBpbnQoLTEgKiBpbnQoUE9XXzJfNjQpIC8gMikpOwogICAgICAgIHJlcXVpcmUoZGF0YS5sYXN0QmxvY2sgPCBQT1dfMl82NCk7CiAgICAgICAgcmVxdWlyZShkYXRhLnRvdGFsQnV5VW5pdHNJbWJhbGFuY2UgPCBpbnQoUE9XXzJfNjQgLyAyKSk7CiAgICAgICAgcmVxdWlyZShkYXRhLnRvdGFsQnV5VW5pdHNJbWJhbGFuY2UgPiBpbnQoLTEgKiBpbnQoUE9XXzJfNjQpIC8gMikpOwogICAgICAgIHJlcXVpcmUoZGF0YS5sYXN0UmF0ZVVwZGF0ZUJsb2NrIDwgUE9XXzJfNjQpOwoKICAgICAgICAvLyBkbyBlbmNvZGluZwogICAgICAgIHVpbnQgcmVzdWx0ID0gdWludChkYXRhLmxhc3RCbG9ja0J1eVVuaXRzSW1iYWxhbmNlKSAmIChQT1dfMl82NCAtIDEpOwogICAgICAgIHJlc3VsdCB8PSBkYXRhLmxhc3RCbG9jayAqIFBPV18yXzY0OwogICAgICAgIHJlc3VsdCB8PSAodWludChkYXRhLnRvdGFsQnV5VW5pdHNJbWJhbGFuY2UpICYgKFBPV18yXzY0IC0gMSkpICogUE9XXzJfNjQgKiBQT1dfMl82NDsKICAgICAgICByZXN1bHQgfD0gZGF0YS5sYXN0UmF0ZVVwZGF0ZUJsb2NrICogUE9XXzJfNjQgKiBQT1dfMl82NCAqIFBPV18yXzY0OwoKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIGZ1bmN0aW9uIGRlY29kZVRva2VuSW1iYWxhbmNlRGF0YSh1aW50IGlucHV0KSBpbnRlcm5hbCBwdXJlIHJldHVybnMoVG9rZW5JbWJhbGFuY2VEYXRhKSB7CiAgICAgICAgVG9rZW5JbWJhbGFuY2VEYXRhIG1lbW9yeSBkYXRhOwoKICAgICAgICBkYXRhLmxhc3RCbG9ja0J1eVVuaXRzSW1iYWxhbmNlID0gaW50KGludDY0KGlucHV0ICYgKFBPV18yXzY0IC0gMSkpKTsKICAgICAgICBkYXRhLmxhc3RCbG9jayA9IHVpbnQodWludDY0KChpbnB1dCAvIFBPV18yXzY0KSAmIChQT1dfMl82NCAtIDEpKSk7CiAgICAgICAgZGF0YS50b3RhbEJ1eVVuaXRzSW1iYWxhbmNlID0gaW50KGludDY0KChpbnB1dCAvIChQT1dfMl82NCAqIFBPV18yXzY0KSkgJiAoUE9XXzJfNjQgLSAxKSkpOwogICAgICAgIGRhdGEubGFzdFJhdGVVcGRhdGVCbG9jayA9IHVpbnQodWludDY0KChpbnB1dCAvIChQT1dfMl82NCAqIFBPV18yXzY0ICogUE9XXzJfNjQpKSkpOwoKICAgICAgICByZXR1cm4gZGF0YTsKICAgIH0KfQoKY29udHJhY3QgQ29udmVyc2lvblJhdGVzIGlzIFZvbHVtZUltYmFsYW5jZVJlY29yZGVyLCBVdGlscyB7CgogICAgLy8gYnBzIC0gYmFzaWMgcmF0ZSBzdGVwcy4gb25lIHN0ZXAgaXMgMSAvIDEwMDAwIG9mIHRoZSByYXRlLgogICAgc3RydWN0IFN0ZXBGdW5jdGlvbiB7CiAgICAgICAgaW50W10geDsgLy8gcXVhbnRpdHkgZm9yIGVhY2ggc3RlcC4gUXVhbnRpdHkgb2YgZWFjaCBzdGVwIGluY2x1ZGVzIHByZXZpb3VzIHN0ZXBzLgogICAgICAgIGludFtdIHk7IC8vIHJhdGUgY2hhbmdlIHBlciBxdWFudGl0eSBzdGVwICBpbiBicHMuCiAgICB9CgogICAgc3RydWN0IFRva2VuRGF0YSB7CiAgICAgICAgYm9vbCBsaXN0ZWQ7ICAvLyB3YXMgYWRkZWQgdG8gcmVzZXJ2ZQogICAgICAgIGJvb2wgZW5hYmxlZDsgLy8gd2hldGhlciB0cmFkZSBpcyBlbmFibGVkCgogICAgICAgIC8vIHBvc2l0aW9uIGluIHRoZSBjb21wYWN0IGRhdGEKICAgICAgICB1aW50IGNvbXBhY3REYXRhQXJyYXlJbmRleDsKICAgICAgICB1aW50IGNvbXBhY3REYXRhRmllbGRJbmRleDsKCiAgICAgICAgLy8gcmF0ZSBkYXRhLiBiYXNlIGFuZCBjaGFuZ2VzIGFjY29yZGluZyB0byBxdWFudGl0eSBhbmQgcmVzZXJ2ZSBiYWxhbmNlLgogICAgICAgIC8vIGdlbmVyYWxseSBzcGVha2luZy4gU2VsbCByYXRlIGlzIDEgLyBidXkgcmF0ZSBpLmUuIHRoZSBidXkgaW4gdGhlIG90aGVyIGRpcmVjdGlvbi4KICAgICAgICB1aW50IGJhc2VCdXlSYXRlOyAgLy8gaW4gUFJFQ0lTSU9OIHVuaXRzLiBzZWUgS3liZXJDb25zdGFudHMKICAgICAgICB1aW50IGJhc2VTZWxsUmF0ZTsgLy8gUFJFQ0lTSU9OIHVuaXRzLiB3aXRob3V0IChzZWxsIC8gYnV5KSBzcHJlYWQgaXQgaXMgMSAvIGJhc2VCdXlSYXRlCiAgICAgICAgU3RlcEZ1bmN0aW9uIGJ1eVJhdGVRdHlTdGVwRnVuY3Rpb247IC8vIGluIGJwcy4gaGlnaGVyIHF1YW50aXR5IC0gYmlnZ2VyIHRoZSByYXRlLgogICAgICAgIFN0ZXBGdW5jdGlvbiBzZWxsUmF0ZVF0eVN0ZXBGdW5jdGlvbjsvLyBpbiBicHMuIGhpZ2hlciB0aGUgcXVhCiAgICAgICAgU3RlcEZ1bmN0aW9uIGJ1eVJhdGVJbWJhbGFuY2VTdGVwRnVuY3Rpb247IC8vIGluIEJQUy4gaGlnaGVyIHJlc2VydmUgaW1iYWxhbmNlIC0gYmlnZ2VyIHRoZSByYXRlLgogICAgICAgIFN0ZXBGdW5jdGlvbiBzZWxsUmF0ZUltYmFsYW5jZVN0ZXBGdW5jdGlvbjsKICAgIH0KCiAgICAvKgogICAgdGhpcyBpcyB0aGUgZGF0YSBmb3IgdG9rZW5SYXRlc0NvbXBhY3REYXRhCiAgICBidXQgc29saWRpdHkgY29tcGlsZXIgb3B0aW1pemVyIGlzIHN1Yi1vcHRpbWFsLCBhbmQgY2Fubm90IHdyaXRlIHRoaXMgc3RydWN0dXJlIGluIGEgc2luZ2xlIHN0b3JhZ2Ugd3JpdGUKICAgIHNvIHdlIHJlcHJlc2VudCBpdCBhcyBieXRlczMyIGFuZCBkbyB0aGUgYnl0ZSB0cmlja3Mgb3Vyc2VsdmVzLgogICAgc3RydWN0IFRva2VuUmF0ZXNDb21wYWN0RGF0YSB7CiAgICAgICAgYnl0ZXMxNCBidXk7ICAvLyBjaGFuZ2UgYnV5IHJhdGUgb2YgdG9rZW4gZnJvbSBiYXNlQnV5UmF0ZSBpbiAxMCBicHMKICAgICAgICBieXRlczE0IHNlbGw7IC8vIGNoYW5nZSBzZWxsIHJhdGUgb2YgdG9rZW4gZnJvbSBiYXNlU2VsbFJhdGUgaW4gMTAgYnBzCgogICAgICAgIHVpbnQzMiBibG9ja051bWJlcjsKICAgIH0gKi8KICAgIHVpbnQgcHVibGljIHZhbGlkUmF0ZUR1cmF0aW9uSW5CbG9ja3MgPSAxMDsgLy8gcmF0ZXMgYXJlIHZhbGlkIGZvciB0aGlzIGFtb3VudCBvZiBibG9ja3MKICAgIEVSQzIwW10gaW50ZXJuYWwgbGlzdGVkVG9rZW5zOwogICAgbWFwcGluZyhhZGRyZXNzPT5Ub2tlbkRhdGEpIGludGVybmFsIHRva2VuRGF0YTsKICAgIGJ5dGVzMzJbXSBpbnRlcm5hbCB0b2tlblJhdGVzQ29tcGFjdERhdGE7CiAgICB1aW50IHB1YmxpYyBudW1Ub2tlbnNJbkN1cnJlbnRDb21wYWN0RGF0YSA9IDA7CiAgICBhZGRyZXNzIHB1YmxpYyByZXNlcnZlQ29udHJhY3Q7CiAgICB1aW50IGNvbnN0YW50IGludGVybmFsIE5VTV9UT0tFTlNfSU5fQ09NUEFDVF9EQVRBID0gMTQ7CiAgICB1aW50IGNvbnN0YW50IGludGVybmFsIEJZVEVTXzE0X09GRlNFVCA9ICgyICoqICg4ICogTlVNX1RPS0VOU19JTl9DT01QQUNUX0RBVEEpKTsKCiAgICBmdW5jdGlvbiBDb252ZXJzaW9uUmF0ZXMoYWRkcmVzcyBfYWRtaW4pIHB1YmxpYyBWb2x1bWVJbWJhbGFuY2VSZWNvcmRlcihfYWRtaW4pCiAgICAgICAgeyB9IC8vIHNvbGhpbnQtZGlzYWJsZS1saW5lIG5vLWVtcHR5LWJsb2NrcwoKICAgIGZ1bmN0aW9uIGFkZFRva2VuKEVSQzIwIHRva2VuKSBwdWJsaWMgb25seUFkbWluIHsKCiAgICAgICAgcmVxdWlyZSghdG9rZW5EYXRhW3Rva2VuXS5saXN0ZWQpOwogICAgICAgIHRva2VuRGF0YVt0b2tlbl0ubGlzdGVkID0gdHJ1ZTsKICAgICAgICBsaXN0ZWRUb2tlbnMucHVzaCh0b2tlbik7CgogICAgICAgIGlmIChudW1Ub2tlbnNJbkN1cnJlbnRDb21wYWN0RGF0YSA9PSAwKSB7CiAgICAgICAgICAgIHRva2VuUmF0ZXNDb21wYWN0RGF0YS5sZW5ndGgrKzsgLy8gYWRkIG5ldyBzdHJ1Y3R1cmUKICAgICAgICB9CgogICAgICAgIHRva2VuRGF0YVt0b2tlbl0uY29tcGFjdERhdGFBcnJheUluZGV4ID0gdG9rZW5SYXRlc0NvbXBhY3REYXRhLmxlbmd0aCAtIDE7CiAgICAgICAgdG9rZW5EYXRhW3Rva2VuXS5jb21wYWN0RGF0YUZpZWxkSW5kZXggPSBudW1Ub2tlbnNJbkN1cnJlbnRDb21wYWN0RGF0YTsKCiAgICAgICAgbnVtVG9rZW5zSW5DdXJyZW50Q29tcGFjdERhdGEgPSAobnVtVG9rZW5zSW5DdXJyZW50Q29tcGFjdERhdGEgKyAxKSAlIE5VTV9UT0tFTlNfSU5fQ09NUEFDVF9EQVRBOwoKICAgICAgICBzZXRHYXJiYWdlVG9Wb2x1bWVSZWNvcmRlcih0b2tlbik7CiAgICB9CgogICAgZnVuY3Rpb24gc2V0Q29tcGFjdERhdGEoYnl0ZXMxNFtdIGJ1eSwgYnl0ZXMxNFtdIHNlbGwsIHVpbnQgYmxvY2tOdW1iZXIsIHVpbnRbXSBpbmRpY2VzKSBwdWJsaWMgb25seU9wZXJhdG9yIHsKCiAgICAgICAgcmVxdWlyZShidXkubGVuZ3RoID09IHNlbGwubGVuZ3RoKTsKICAgICAgICByZXF1aXJlKGluZGljZXMubGVuZ3RoID09IGJ1eS5sZW5ndGgpOwogICAgICAgIHJlcXVpcmUoYmxvY2tOdW1iZXIgPD0gMHhGRkZGRkZGRik7CgogICAgICAgIHVpbnQgYnl0ZXMxNE9mZnNldCA9IEJZVEVTXzE0X09GRlNFVDsKCiAgICAgICAgZm9yICh1aW50IGkgPSAwOyBpIDwgaW5kaWNlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICByZXF1aXJlKGluZGljZXNbaV0gPCB0b2tlblJhdGVzQ29tcGFjdERhdGEubGVuZ3RoKTsKICAgICAgICAgICAgdWludCBkYXRhID0gdWludChidXlbaV0pIHwgdWludChzZWxsW2ldKSAqIGJ5dGVzMTRPZmZzZXQgfCAoYmxvY2tOdW1iZXIgKiAoYnl0ZXMxNE9mZnNldCAqIGJ5dGVzMTRPZmZzZXQpKTsKICAgICAgICAgICAgdG9rZW5SYXRlc0NvbXBhY3REYXRhW2luZGljZXNbaV1dID0gYnl0ZXMzMihkYXRhKTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gc2V0QmFzZVJhdGUoCiAgICAgICAgRVJDMjBbXSB0b2tlbnMsCiAgICAgICAgdWludFtdIGJhc2VCdXksCiAgICAgICAgdWludFtdIGJhc2VTZWxsLAogICAgICAgIGJ5dGVzMTRbXSBidXksCiAgICAgICAgYnl0ZXMxNFtdIHNlbGwsCiAgICAgICAgdWludCBibG9ja051bWJlciwKICAgICAgICB1aW50W10gaW5kaWNlcwogICAgKQogICAgICAgIHB1YmxpYwogICAgICAgIG9ubHlPcGVyYXRvcgogICAgewogICAgICAgIHJlcXVpcmUodG9rZW5zLmxlbmd0aCA9PSBiYXNlQnV5Lmxlbmd0aCk7CiAgICAgICAgcmVxdWlyZSh0b2tlbnMubGVuZ3RoID09IGJhc2VTZWxsLmxlbmd0aCk7CiAgICAgICAgcmVxdWlyZShzZWxsLmxlbmd0aCA9PSBidXkubGVuZ3RoKTsKICAgICAgICByZXF1aXJlKHNlbGwubGVuZ3RoID09IGluZGljZXMubGVuZ3RoKTsKCiAgICAgICAgZm9yICh1aW50IGluZCA9IDA7IGluZCA8IHRva2Vucy5sZW5ndGg7IGluZCsrKSB7CiAgICAgICAgICAgIHJlcXVpcmUodG9rZW5EYXRhW3Rva2Vuc1tpbmRdXS5saXN0ZWQpOwogICAgICAgICAgICB0b2tlbkRhdGFbdG9rZW5zW2luZF1dLmJhc2VCdXlSYXRlID0gYmFzZUJ1eVtpbmRdOwogICAgICAgICAgICB0b2tlbkRhdGFbdG9rZW5zW2luZF1dLmJhc2VTZWxsUmF0ZSA9IGJhc2VTZWxsW2luZF07CiAgICAgICAgfQoKICAgICAgICBzZXRDb21wYWN0RGF0YShidXksIHNlbGwsIGJsb2NrTnVtYmVyLCBpbmRpY2VzKTsKICAgIH0KCiAgICBmdW5jdGlvbiBzZXRRdHlTdGVwRnVuY3Rpb24oCiAgICAgICAgRVJDMjAgdG9rZW4sCiAgICAgICAgaW50W10geEJ1eSwKICAgICAgICBpbnRbXSB5QnV5LAogICAgICAgIGludFtdIHhTZWxsLAogICAgICAgIGludFtdIHlTZWxsCiAgICApCiAgICAgICAgcHVibGljCiAgICAgICAgb25seU9wZXJhdG9yCiAgICB7CiAgICAgICAgcmVxdWlyZSh4QnV5Lmxlbmd0aCA9PSB5QnV5Lmxlbmd0aCk7CiAgICAgICAgcmVxdWlyZSh4U2VsbC5sZW5ndGggPT0geVNlbGwubGVuZ3RoKTsKICAgICAgICByZXF1aXJlKHRva2VuRGF0YVt0b2tlbl0ubGlzdGVkKTsKCiAgICAgICAgdG9rZW5EYXRhW3Rva2VuXS5idXlSYXRlUXR5U3RlcEZ1bmN0aW9uID0gU3RlcEZ1bmN0aW9uKHhCdXksIHlCdXkpOwogICAgICAgIHRva2VuRGF0YVt0b2tlbl0uc2VsbFJhdGVRdHlTdGVwRnVuY3Rpb24gPSBTdGVwRnVuY3Rpb24oeFNlbGwsIHlTZWxsKTsKICAgIH0KCiAgICBmdW5jdGlvbiBzZXRJbWJhbGFuY2VTdGVwRnVuY3Rpb24oCiAgICAgICAgRVJDMjAgdG9rZW4sCiAgICAgICAgaW50W10geEJ1eSwKICAgICAgICBpbnRbXSB5QnV5LAogICAgICAgIGludFtdIHhTZWxsLAogICAgICAgIGludFtdIHlTZWxsCiAgICApCiAgICAgICAgcHVibGljCiAgICAgICAgb25seU9wZXJhdG9yCiAgICB7CiAgICAgICAgcmVxdWlyZSh4QnV5Lmxlbmd0aCA9PSB5QnV5Lmxlbmd0aCk7CiAgICAgICAgcmVxdWlyZSh4U2VsbC5sZW5ndGggPT0geVNlbGwubGVuZ3RoKTsKICAgICAgICByZXF1aXJlKHRva2VuRGF0YVt0b2tlbl0ubGlzdGVkKTsKCiAgICAgICAgdG9rZW5EYXRhW3Rva2VuXS5idXlSYXRlSW1iYWxhbmNlU3RlcEZ1bmN0aW9uID0gU3RlcEZ1bmN0aW9uKHhCdXksIHlCdXkpOwogICAgICAgIHRva2VuRGF0YVt0b2tlbl0uc2VsbFJhdGVJbWJhbGFuY2VTdGVwRnVuY3Rpb24gPSBTdGVwRnVuY3Rpb24oeFNlbGwsIHlTZWxsKTsKICAgIH0KCiAgICBmdW5jdGlvbiBzZXRWYWxpZFJhdGVEdXJhdGlvbkluQmxvY2tzKHVpbnQgZHVyYXRpb24pIHB1YmxpYyBvbmx5QWRtaW4gewogICAgICAgIHZhbGlkUmF0ZUR1cmF0aW9uSW5CbG9ja3MgPSBkdXJhdGlvbjsKICAgIH0KCiAgICBmdW5jdGlvbiBlbmFibGVUb2tlblRyYWRlKEVSQzIwIHRva2VuKSBwdWJsaWMgb25seUFkbWluIHsKICAgICAgICByZXF1aXJlKHRva2VuRGF0YVt0b2tlbl0ubGlzdGVkKTsKICAgICAgICByZXF1aXJlKHRva2VuQ29udHJvbEluZm9bdG9rZW5dLm1pbmltYWxSZWNvcmRSZXNvbHV0aW9uICE9IDApOwogICAgICAgIHRva2VuRGF0YVt0b2tlbl0uZW5hYmxlZCA9IHRydWU7CiAgICB9CgogICAgZnVuY3Rpb24gZGlzYWJsZVRva2VuVHJhZGUoRVJDMjAgdG9rZW4pIHB1YmxpYyBvbmx5QWxlcnRlciB7CiAgICAgICAgcmVxdWlyZSh0b2tlbkRhdGFbdG9rZW5dLmxpc3RlZCk7CiAgICAgICAgdG9rZW5EYXRhW3Rva2VuXS5lbmFibGVkID0gZmFsc2U7CiAgICB9CgogICAgZnVuY3Rpb24gc2V0UmVzZXJ2ZUFkZHJlc3MoYWRkcmVzcyByZXNlcnZlKSBwdWJsaWMgb25seUFkbWluIHsKICAgICAgICByZXNlcnZlQ29udHJhY3QgPSByZXNlcnZlOwogICAgfQoKICAgIGZ1bmN0aW9uIHJlY29yZEltYmFsYW5jZSgKICAgICAgICBFUkMyMCB0b2tlbiwKICAgICAgICBpbnQgYnV5QW1vdW50LAogICAgICAgIHVpbnQgcmF0ZVVwZGF0ZUJsb2NrLAogICAgICAgIHVpbnQgY3VycmVudEJsb2NrCiAgICApCiAgICAgICAgcHVibGljCiAgICB7CiAgICAgICAgcmVxdWlyZShtc2cuc2VuZGVyID09IHJlc2VydmVDb250cmFjdCk7CgogICAgICAgIGlmIChyYXRlVXBkYXRlQmxvY2sgPT0gMCkgcmF0ZVVwZGF0ZUJsb2NrID0gZ2V0UmF0ZVVwZGF0ZUJsb2NrKHRva2VuKTsKCiAgICAgICAgcmV0dXJuIGFkZEltYmFsYW5jZSh0b2tlbiwgYnV5QW1vdW50LCByYXRlVXBkYXRlQmxvY2ssIGN1cnJlbnRCbG9jayk7CiAgICB9CgogICAgLyogc29saGludC1kaXNhYmxlIGZ1bmN0aW9uLW1heC1saW5lcyAqLwogICAgZnVuY3Rpb24gZ2V0UmF0ZShFUkMyMCB0b2tlbiwgdWludCBjdXJyZW50QmxvY2tOdW1iZXIsIGJvb2wgYnV5LCB1aW50IHF0eSkgcHVibGljIHZpZXcgcmV0dXJucyh1aW50KSB7CiAgICAgICAgLy8gY2hlY2sgaWYgdHJhZGUgaXMgZW5hYmxlZAogICAgICAgIGlmICghdG9rZW5EYXRhW3Rva2VuXS5lbmFibGVkKSByZXR1cm4gMDsKICAgICAgICBpZiAodG9rZW5Db250cm9sSW5mb1t0b2tlbl0ubWluaW1hbFJlY29yZFJlc29sdXRpb24gPT0gMCkgcmV0dXJuIDA7IC8vIHRva2VuIGNvbnRyb2wgaW5mbyBub3Qgc2V0CgogICAgICAgIC8vIGdldCByYXRlIHVwZGF0ZSBibG9jawogICAgICAgIGJ5dGVzMzIgY29tcGFjdERhdGEgPSB0b2tlblJhdGVzQ29tcGFjdERhdGFbdG9rZW5EYXRhW3Rva2VuXS5jb21wYWN0RGF0YUFycmF5SW5kZXhdOwoKICAgICAgICB1aW50IHVwZGF0ZVJhdGVCbG9jayA9IGdldExhc3Q0Qnl0ZXMoY29tcGFjdERhdGEpOwogICAgICAgIGlmIChjdXJyZW50QmxvY2tOdW1iZXIgPj0gdXBkYXRlUmF0ZUJsb2NrICsgdmFsaWRSYXRlRHVyYXRpb25JbkJsb2NrcykgcmV0dXJuIDA7IC8vIHJhdGUgaXMgZXhwaXJlZAogICAgICAgIC8vIGNoZWNrIGltYmFsYW5jZQogICAgICAgIGludCB0b3RhbEltYmFsYW5jZTsKICAgICAgICBpbnQgYmxvY2tJbWJhbGFuY2U7CiAgICAgICAgKHRvdGFsSW1iYWxhbmNlLCBibG9ja0ltYmFsYW5jZSkgPSBnZXRJbWJhbGFuY2UodG9rZW4sIHVwZGF0ZVJhdGVCbG9jaywgY3VycmVudEJsb2NrTnVtYmVyKTsKCiAgICAgICAgLy8gY2FsY3VsYXRlIGFjdHVhbCByYXRlCiAgICAgICAgaW50IGltYmFsYW5jZVF0eTsKICAgICAgICBpbnQgZXh0cmFCcHM7CiAgICAgICAgaW50OCByYXRlVXBkYXRlOwogICAgICAgIHVpbnQgcmF0ZTsKCiAgICAgICAgaWYgKGJ1eSkgewogICAgICAgICAgICAvLyBzdGFydCB3aXRoIGJhc2UgcmF0ZQogICAgICAgICAgICByYXRlID0gdG9rZW5EYXRhW3Rva2VuXS5iYXNlQnV5UmF0ZTsKCiAgICAgICAgICAgIC8vIGFkZCByYXRlIHVwZGF0ZQogICAgICAgICAgICByYXRlVXBkYXRlID0gZ2V0UmF0ZUJ5dGVGcm9tQ29tcGFjdERhdGEoY29tcGFjdERhdGEsIHRva2VuLCB0cnVlKTsKICAgICAgICAgICAgZXh0cmFCcHMgPSBpbnQocmF0ZVVwZGF0ZSkgKiAxMDsKICAgICAgICAgICAgcmF0ZSA9IGFkZEJwcyhyYXRlLCBleHRyYUJwcyk7CgogICAgICAgICAgICAvLyBjb21wdXRlIHRva2VuIHF0eQogICAgICAgICAgICBxdHkgPSBnZXRUb2tlblF0eSh0b2tlbiwgcmF0ZSwgcXR5KTsKICAgICAgICAgICAgaW1iYWxhbmNlUXR5ID0gaW50KHF0eSk7CiAgICAgICAgICAgIHRvdGFsSW1iYWxhbmNlICs9IGltYmFsYW5jZVF0eTsKCiAgICAgICAgICAgIC8vIGFkZCBxdHkgb3ZlcmhlYWQKICAgICAgICAgICAgZXh0cmFCcHMgPSBleGVjdXRlU3RlcEZ1bmN0aW9uKHRva2VuRGF0YVt0b2tlbl0uYnV5UmF0ZVF0eVN0ZXBGdW5jdGlvbiwgaW50KHF0eSkpOwogICAgICAgICAgICByYXRlID0gYWRkQnBzKHJhdGUsIGV4dHJhQnBzKTsKCiAgICAgICAgICAgIC8vIGFkZCBpbWJhbGFuY2Ugb3ZlcmhlYWQKICAgICAgICAgICAgZXh0cmFCcHMgPSBleGVjdXRlU3RlcEZ1bmN0aW9uKHRva2VuRGF0YVt0b2tlbl0uYnV5UmF0ZUltYmFsYW5jZVN0ZXBGdW5jdGlvbiwgdG90YWxJbWJhbGFuY2UpOwogICAgICAgICAgICByYXRlID0gYWRkQnBzKHJhdGUsIGV4dHJhQnBzKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBzdGFydCB3aXRoIGJhc2UgcmF0ZQogICAgICAgICAgICByYXRlID0gdG9rZW5EYXRhW3Rva2VuXS5iYXNlU2VsbFJhdGU7CgogICAgICAgICAgICAvLyBhZGQgcmF0ZSB1cGRhdGUKICAgICAgICAgICAgcmF0ZVVwZGF0ZSA9IGdldFJhdGVCeXRlRnJvbUNvbXBhY3REYXRhKGNvbXBhY3REYXRhLCB0b2tlbiwgZmFsc2UpOwogICAgICAgICAgICBleHRyYUJwcyA9IGludChyYXRlVXBkYXRlKSAqIDEwOwogICAgICAgICAgICByYXRlID0gYWRkQnBzKHJhdGUsIGV4dHJhQnBzKTsKCiAgICAgICAgICAgIC8vIGNvbXB1dGUgdG9rZW4gcXR5CiAgICAgICAgICAgIGltYmFsYW5jZVF0eSA9IC0xICogaW50KHF0eSk7CiAgICAgICAgICAgIHRvdGFsSW1iYWxhbmNlICs9IGltYmFsYW5jZVF0eTsKCiAgICAgICAgICAgIC8vIGFkZCBxdHkgb3ZlcmhlYWQKICAgICAgICAgICAgZXh0cmFCcHMgPSBleGVjdXRlU3RlcEZ1bmN0aW9uKHRva2VuRGF0YVt0b2tlbl0uc2VsbFJhdGVRdHlTdGVwRnVuY3Rpb24sIGludChxdHkpKTsKICAgICAgICAgICAgcmF0ZSA9IGFkZEJwcyhyYXRlLCBleHRyYUJwcyk7CgogICAgICAgICAgICAvLyBhZGQgaW1iYWxhbmNlIG92ZXJoZWFkCiAgICAgICAgICAgIGV4dHJhQnBzID0gZXhlY3V0ZVN0ZXBGdW5jdGlvbih0b2tlbkRhdGFbdG9rZW5dLnNlbGxSYXRlSW1iYWxhbmNlU3RlcEZ1bmN0aW9uLCB0b3RhbEltYmFsYW5jZSk7CiAgICAgICAgICAgIHJhdGUgPSBhZGRCcHMocmF0ZSwgZXh0cmFCcHMpOwogICAgICAgIH0KCiAgICAgICAgaWYgKGFicyh0b3RhbEltYmFsYW5jZSArIGltYmFsYW5jZVF0eSkgPj0gZ2V0TWF4VG90YWxJbWJhbGFuY2UodG9rZW4pKSByZXR1cm4gMDsKICAgICAgICBpZiAoYWJzKGJsb2NrSW1iYWxhbmNlICsgaW1iYWxhbmNlUXR5KSA+PSBnZXRNYXhQZXJCbG9ja0ltYmFsYW5jZSh0b2tlbikpIHJldHVybiAwOwoKICAgICAgICByZXR1cm4gcmF0ZTsKICAgIH0KICAgIC8qIHNvbGhpbnQtZW5hYmxlIGZ1bmN0aW9uLW1heC1saW5lcyAqLwoKICAgIGZ1bmN0aW9uIGdldEJhc2ljUmF0ZShFUkMyMCB0b2tlbiwgYm9vbCBidXkpIHB1YmxpYyB2aWV3IHJldHVybnModWludCkgewogICAgICAgIGlmIChidXkpCiAgICAgICAgICAgIHJldHVybiB0b2tlbkRhdGFbdG9rZW5dLmJhc2VCdXlSYXRlOwogICAgICAgIGVsc2UKICAgICAgICAgICAgcmV0dXJuIHRva2VuRGF0YVt0b2tlbl0uYmFzZVNlbGxSYXRlOwogICAgfQoKICAgIGZ1bmN0aW9uIGdldENvbXBhY3REYXRhKEVSQzIwIHRva2VuKSBwdWJsaWMgdmlldyByZXR1cm5zKHVpbnQsIHVpbnQsIGJ5dGUsIGJ5dGUpIHsKICAgICAgICB1aW50IGFycmF5SW5kZXggPSB0b2tlbkRhdGFbdG9rZW5dLmNvbXBhY3REYXRhQXJyYXlJbmRleDsKICAgICAgICB1aW50IGZpZWxkT2Zmc2V0ID0gdG9rZW5EYXRhW3Rva2VuXS5jb21wYWN0RGF0YUZpZWxkSW5kZXg7CgogICAgICAgIHJldHVybiAoCiAgICAgICAgICAgIGFycmF5SW5kZXgsCiAgICAgICAgICAgIGZpZWxkT2Zmc2V0LAogICAgICAgICAgICBieXRlKGdldFJhdGVCeXRlRnJvbUNvbXBhY3REYXRhKHRva2VuUmF0ZXNDb21wYWN0RGF0YVthcnJheUluZGV4XSwgdG9rZW4sIHRydWUpKSwKICAgICAgICAgICAgYnl0ZShnZXRSYXRlQnl0ZUZyb21Db21wYWN0RGF0YSh0b2tlblJhdGVzQ29tcGFjdERhdGFbYXJyYXlJbmRleF0sIHRva2VuLCBmYWxzZSkpCiAgICAgICAgKTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRUb2tlbkJhc2ljRGF0YShFUkMyMCB0b2tlbikgcHVibGljIHZpZXcgcmV0dXJucyhib29sLCBib29sKSB7CiAgICAgICAgcmV0dXJuICh0b2tlbkRhdGFbdG9rZW5dLmxpc3RlZCwgdG9rZW5EYXRhW3Rva2VuXS5lbmFibGVkKTsKICAgIH0KCiAgICAvKiBzb2xoaW50LWRpc2FibGUgY29kZS1jb21wbGV4aXR5ICovCiAgICBmdW5jdGlvbiBnZXRTdGVwRnVuY3Rpb25EYXRhKEVSQzIwIHRva2VuLCB1aW50IGNvbW1hbmQsIHVpbnQgcGFyYW0pIHB1YmxpYyB2aWV3IHJldHVybnMoaW50KSB7CiAgICAgICAgaWYgKGNvbW1hbmQgPT0gMCkgcmV0dXJuIGludCh0b2tlbkRhdGFbdG9rZW5dLmJ1eVJhdGVRdHlTdGVwRnVuY3Rpb24ueC5sZW5ndGgpOwogICAgICAgIGlmIChjb21tYW5kID09IDEpIHJldHVybiB0b2tlbkRhdGFbdG9rZW5dLmJ1eVJhdGVRdHlTdGVwRnVuY3Rpb24ueFtwYXJhbV07CiAgICAgICAgaWYgKGNvbW1hbmQgPT0gMikgcmV0dXJuIGludCh0b2tlbkRhdGFbdG9rZW5dLmJ1eVJhdGVRdHlTdGVwRnVuY3Rpb24ueS5sZW5ndGgpOwogICAgICAgIGlmIChjb21tYW5kID09IDMpIHJldHVybiB0b2tlbkRhdGFbdG9rZW5dLmJ1eVJhdGVRdHlTdGVwRnVuY3Rpb24ueVtwYXJhbV07CgogICAgICAgIGlmIChjb21tYW5kID09IDQpIHJldHVybiBpbnQodG9rZW5EYXRhW3Rva2VuXS5zZWxsUmF0ZVF0eVN0ZXBGdW5jdGlvbi54Lmxlbmd0aCk7CiAgICAgICAgaWYgKGNvbW1hbmQgPT0gNSkgcmV0dXJuIHRva2VuRGF0YVt0b2tlbl0uc2VsbFJhdGVRdHlTdGVwRnVuY3Rpb24ueFtwYXJhbV07CiAgICAgICAgaWYgKGNvbW1hbmQgPT0gNikgcmV0dXJuIGludCh0b2tlbkRhdGFbdG9rZW5dLnNlbGxSYXRlUXR5U3RlcEZ1bmN0aW9uLnkubGVuZ3RoKTsKICAgICAgICBpZiAoY29tbWFuZCA9PSA3KSByZXR1cm4gdG9rZW5EYXRhW3Rva2VuXS5zZWxsUmF0ZVF0eVN0ZXBGdW5jdGlvbi55W3BhcmFtXTsKCiAgICAgICAgaWYgKGNvbW1hbmQgPT0gOCkgcmV0dXJuIGludCh0b2tlbkRhdGFbdG9rZW5dLmJ1eVJhdGVJbWJhbGFuY2VTdGVwRnVuY3Rpb24ueC5sZW5ndGgpOwogICAgICAgIGlmIChjb21tYW5kID09IDkpIHJldHVybiB0b2tlbkRhdGFbdG9rZW5dLmJ1eVJhdGVJbWJhbGFuY2VTdGVwRnVuY3Rpb24ueFtwYXJhbV07CiAgICAgICAgaWYgKGNvbW1hbmQgPT0gMTApIHJldHVybiBpbnQodG9rZW5EYXRhW3Rva2VuXS5idXlSYXRlSW1iYWxhbmNlU3RlcEZ1bmN0aW9uLnkubGVuZ3RoKTsKICAgICAgICBpZiAoY29tbWFuZCA9PSAxMSkgcmV0dXJuIHRva2VuRGF0YVt0b2tlbl0uYnV5UmF0ZUltYmFsYW5jZVN0ZXBGdW5jdGlvbi55W3BhcmFtXTsKCiAgICAgICAgaWYgKGNvbW1hbmQgPT0gMTIpIHJldHVybiBpbnQodG9rZW5EYXRhW3Rva2VuXS5zZWxsUmF0ZUltYmFsYW5jZVN0ZXBGdW5jdGlvbi54Lmxlbmd0aCk7CiAgICAgICAgaWYgKGNvbW1hbmQgPT0gMTMpIHJldHVybiB0b2tlbkRhdGFbdG9rZW5dLnNlbGxSYXRlSW1iYWxhbmNlU3RlcEZ1bmN0aW9uLnhbcGFyYW1dOwogICAgICAgIGlmIChjb21tYW5kID09IDE0KSByZXR1cm4gaW50KHRva2VuRGF0YVt0b2tlbl0uc2VsbFJhdGVJbWJhbGFuY2VTdGVwRnVuY3Rpb24ueS5sZW5ndGgpOwogICAgICAgIGlmIChjb21tYW5kID09IDE1KSByZXR1cm4gdG9rZW5EYXRhW3Rva2VuXS5zZWxsUmF0ZUltYmFsYW5jZVN0ZXBGdW5jdGlvbi55W3BhcmFtXTsKCiAgICAgICAgcmV2ZXJ0KCk7CiAgICB9CiAgICAvKiBzb2xoaW50LWVuYWJsZSBjb2RlLWNvbXBsZXhpdHkgKi8KCiAgICBmdW5jdGlvbiBnZXRSYXRlVXBkYXRlQmxvY2soRVJDMjAgdG9rZW4pIHB1YmxpYyB2aWV3IHJldHVybnModWludCkgewogICAgICAgIGJ5dGVzMzIgY29tcGFjdERhdGEgPSB0b2tlblJhdGVzQ29tcGFjdERhdGFbdG9rZW5EYXRhW3Rva2VuXS5jb21wYWN0RGF0YUFycmF5SW5kZXhdOwogICAgICAgIHJldHVybiBnZXRMYXN0NEJ5dGVzKGNvbXBhY3REYXRhKTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRMaXN0ZWRUb2tlbnMoKSBwdWJsaWMgdmlldyByZXR1cm5zKEVSQzIwW10pIHsKICAgICAgICByZXR1cm4gbGlzdGVkVG9rZW5zOwogICAgfQoKICAgIGZ1bmN0aW9uIGdldFRva2VuUXR5KEVSQzIwIHRva2VuLCB1aW50IGV0aFF0eSwgdWludCByYXRlKSBpbnRlcm5hbCB2aWV3IHJldHVybnModWludCkgewogICAgICAgIHVpbnQgZHN0RGVjaW1hbHMgPSB0b2tlbi5kZWNpbWFscygpOwogICAgICAgIHVpbnQgc3JjRGVjaW1hbHMgPSAxODsKCiAgICAgICAgcmV0dXJuIGNhbGNEc3RRdHkoZXRoUXR5LCBzcmNEZWNpbWFscywgZHN0RGVjaW1hbHMsIHJhdGUpOwogICAgfQoKICAgIGZ1bmN0aW9uIGdldExhc3Q0Qnl0ZXMoYnl0ZXMzMiBiKSBpbnRlcm5hbCBwdXJlIHJldHVybnModWludCkgewogICAgICAgIC8vIGNhbm5vdCB0cnVzdCBjb21waWxlciB3aXRoIG5vdCB0dXJuaW5nIGJpdCBvcGVyYXRpb25zIGludG8gRVhQIG9wY29kZQogICAgICAgIHJldHVybiB1aW50KGIpIC8gKEJZVEVTXzE0X09GRlNFVCAqIEJZVEVTXzE0X09GRlNFVCk7CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0UmF0ZUJ5dGVGcm9tQ29tcGFjdERhdGEoYnl0ZXMzMiBkYXRhLCBFUkMyMCB0b2tlbiwgYm9vbCBidXkpIGludGVybmFsIHZpZXcgcmV0dXJucyhpbnQ4KSB7CiAgICAgICAgdWludCBmaWVsZE9mZnNldCA9IHRva2VuRGF0YVt0b2tlbl0uY29tcGFjdERhdGFGaWVsZEluZGV4OwogICAgICAgIHVpbnQgYnl0ZU9mZnNldDsKICAgICAgICBpZiAoYnV5KQogICAgICAgICAgICBieXRlT2Zmc2V0ID0gMzIgLSBOVU1fVE9LRU5TX0lOX0NPTVBBQ1RfREFUQSArIGZpZWxkT2Zmc2V0OwogICAgICAgIGVsc2UKICAgICAgICAgICAgYnl0ZU9mZnNldCA9IDQgKyBmaWVsZE9mZnNldDsKCiAgICAgICAgcmV0dXJuIGludDgoZGF0YVtieXRlT2Zmc2V0XSk7CiAgICB9CgogICAgZnVuY3Rpb24gZXhlY3V0ZVN0ZXBGdW5jdGlvbihTdGVwRnVuY3Rpb24gZiwgaW50IHgpIGludGVybmFsIHB1cmUgcmV0dXJucyhpbnQpIHsKICAgICAgICB1aW50IGxlbiA9IGYueS5sZW5ndGg7CiAgICAgICAgZm9yICh1aW50IGluZCA9IDA7IGluZCA8IGxlbjsgaW5kKyspIHsKICAgICAgICAgICAgaWYgKHggPD0gZi54W2luZF0pIHJldHVybiBmLnlbaW5kXTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBmLnlbbGVuLTFdOwogICAgfQoKICAgIGZ1bmN0aW9uIGFkZEJwcyh1aW50IHJhdGUsIGludCBicHMpIGludGVybmFsIHB1cmUgcmV0dXJucyh1aW50KSB7CiAgICAgICAgdWludCBtYXhCcHMgPSAxMDAgKiAxMDA7CiAgICAgICAgcmV0dXJuIChyYXRlICogdWludChpbnQobWF4QnBzKSArIGJwcykpIC8gbWF4QnBzOwogICAgfQoKICAgIGZ1bmN0aW9uIGFicyhpbnQgeCkgaW50ZXJuYWwgcHVyZSByZXR1cm5zKHVpbnQpIHsKICAgICAgICBpZiAoeCA8IDApCiAgICAgICAgICAgIHJldHVybiB1aW50KC0xICogeCk7CiAgICAgICAgZWxzZQogICAgICAgICAgICByZXR1cm4gdWludCh4KTsKICAgIH0KfQoKY29udHJhY3QgS3liZXJOZXR3b3JrIGlzIFdpdGhkcmF3YWJsZSwgVXRpbHMgewoKICAgIHVpbnQgcHVibGljIG5lZ2xpZ2libGVSYXRlRGlmZiA9IDEwOyAvLyBiYXNpYyByYXRlIHN0ZXBzIHdpbGwgYmUgaW4gMC4wMSUKICAgIEt5YmVyUmVzZXJ2ZVtdIHB1YmxpYyByZXNlcnZlczsKICAgIG1hcHBpbmcoYWRkcmVzcz0+Ym9vbCkgcHVibGljIGlzUmVzZXJ2ZTsKICAgIFdoaXRlTGlzdCBwdWJsaWMgd2hpdGVMaXN0Q29udHJhY3Q7CiAgICBFeHBlY3RlZFJhdGVJbnRlcmZhY2UgcHVibGljIGV4cGVjdGVkUmF0ZUNvbnRyYWN0OwogICAgRmVlQnVybmVySW50ZXJmYWNlICAgIHB1YmxpYyBmZWVCdXJuZXJDb250cmFjdDsKICAgIHVpbnQgICAgICAgICAgICAgICAgICBwdWJsaWMgbWF4R2FzUHJpY2UgPSA1MCAqIDEwMDAgKiAxMDAwICogMTAwMDsgLy8gNTAgZ3dlaQogICAgYm9vbCAgICAgICAgICAgICAgICAgIHB1YmxpYyBlbmFibGVkID0gZmFsc2U7IC8vIG5ldHdvcmsgaXMgZW5hYmxlZAogICAgbWFwcGluZyhhZGRyZXNzPT5tYXBwaW5nKGJ5dGVzMzI9PmJvb2wpKSBwdWJsaWMgcGVyUmVzZXJ2ZUxpc3RlZFBhaXJzOwoKICAgIGZ1bmN0aW9uIEt5YmVyTmV0d29yayhhZGRyZXNzIF9hZG1pbikgcHVibGljIHsKICAgICAgICByZXF1aXJlKF9hZG1pbiAhPSBhZGRyZXNzKDApKTsKICAgICAgICBhZG1pbiA9IF9hZG1pbjsKICAgIH0KCiAgICBldmVudCBFdGhlclJlY2VpdmFsKGFkZHJlc3MgaW5kZXhlZCBzZW5kZXIsIHVpbnQgYW1vdW50KTsKCiAgICAvKiBzb2xoaW50LWRpc2FibGUgbm8tY29tcGxleC1mYWxsYmFjayAqLwogICAgZnVuY3Rpb24oKSBwdWJsaWMgcGF5YWJsZSB7CiAgICAgICAgcmVxdWlyZShpc1Jlc2VydmVbbXNnLnNlbmRlcl0pOwogICAgICAgIEV0aGVyUmVjZWl2YWwobXNnLnNlbmRlciwgbXNnLnZhbHVlKTsKICAgIH0KICAgIC8qIHNvbGhpbnQtZW5hYmxlIG5vLWNvbXBsZXgtZmFsbGJhY2sgKi8KCiAgICBldmVudCBFeGVjdXRlVHJhZGUoYWRkcmVzcyBpbmRleGVkIHNlbmRlciwgRVJDMjAgc3JjLCBFUkMyMCBkZXN0LCB1aW50IGFjdHVhbFNyY0Ftb3VudCwgdWludCBhY3R1YWxEZXN0QW1vdW50KTsKCiAgICAvLy8gQG5vdGljZSB1c2UgdG9rZW4gYWRkcmVzcyBFVEhfVE9LRU5fQUREUkVTUyBmb3IgZXRoZXIKICAgIC8vLyBAZGV2IG1ha2VzIGEgdHJhZGUgYmV0d2VlbiBzcmMgYW5kIGRlc3QgdG9rZW4gYW5kIHNlbmQgZGVzdCB0b2tlbiB0byBkZXN0QWRkcmVzcwogICAgLy8vIEBwYXJhbSBzcmMgU3JjIHRva2VuCiAgICAvLy8gQHBhcmFtIHNyY0Ftb3VudCBhbW91bnQgb2Ygc3JjIHRva2VucwogICAgLy8vIEBwYXJhbSBkZXN0ICAgRGVzdGluYXRpb24gdG9rZW4KICAgIC8vLyBAcGFyYW0gZGVzdEFkZHJlc3MgQWRkcmVzcyB0byBzZW5kIHRva2VucyB0bwogICAgLy8vIEBwYXJhbSBtYXhEZXN0QW1vdW50IEEgbGltaXQgb24gdGhlIGFtb3VudCBvZiBkZXN0IHRva2VucwogICAgLy8vIEBwYXJhbSBtaW5Db252ZXJzaW9uUmF0ZSBUaGUgbWluaW1hbCBjb252ZXJzaW9uIHJhdGUuIElmIGFjdHVhbCByYXRlIGlzIGxvd2VyLCB0cmFkZSBpcyBjYW5jZWxlZC4KICAgIC8vLyBAcGFyYW0gd2FsbGV0SWQgaXMgdGhlIHdhbGxldCBJRCB0byBzZW5kIHBhcnQgb2YgdGhlIGZlZXMKICAgIC8vLyBAcmV0dXJuIGFtb3VudCBvZiBhY3R1YWwgZGVzdCB0b2tlbnMKICAgIGZ1bmN0aW9uIHRyYWRlKAogICAgICAgIEVSQzIwIHNyYywKICAgICAgICB1aW50IHNyY0Ftb3VudCwKICAgICAgICBFUkMyMCBkZXN0LAogICAgICAgIGFkZHJlc3MgZGVzdEFkZHJlc3MsCiAgICAgICAgdWludCBtYXhEZXN0QW1vdW50LAogICAgICAgIHVpbnQgbWluQ29udmVyc2lvblJhdGUsCiAgICAgICAgYWRkcmVzcyB3YWxsZXRJZAogICAgKQogICAgICAgIHB1YmxpYwogICAgICAgIHBheWFibGUKICAgICAgICByZXR1cm5zKHVpbnQpCiAgICB7CiAgICAgICAgcmVxdWlyZShlbmFibGVkKTsKCiAgICAgICAgdWludCB1c2VyU3JjQmFsYW5jZUJlZm9yZTsKICAgICAgICB1aW50IHVzZXJTcmNCYWxhbmNlQWZ0ZXI7CiAgICAgICAgdWludCB1c2VyRGVzdEJhbGFuY2VCZWZvcmU7CiAgICAgICAgdWludCB1c2VyRGVzdEJhbGFuY2VBZnRlcjsKCiAgICAgICAgdXNlclNyY0JhbGFuY2VCZWZvcmUgPSBnZXRCYWxhbmNlKHNyYywgbXNnLnNlbmRlcik7CiAgICAgICAgaWYgKHNyYyA9PSBFVEhfVE9LRU5fQUREUkVTUykKICAgICAgICAgICAgdXNlclNyY0JhbGFuY2VCZWZvcmUgKz0gbXNnLnZhbHVlOwogICAgICAgIHVzZXJEZXN0QmFsYW5jZUJlZm9yZSA9IGdldEJhbGFuY2UoZGVzdCwgZGVzdEFkZHJlc3MpOwoKICAgICAgICB1aW50IGFjdHVhbERlc3RBbW91bnQgPSBkb1RyYWRlKHNyYywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNyY0Ftb3VudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlc3QsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXN0QWRkcmVzcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1heERlc3RBbW91bnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtaW5Db252ZXJzaW9uUmF0ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdhbGxldElkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgIHJlcXVpcmUoYWN0dWFsRGVzdEFtb3VudCA+IDApOwoKICAgICAgICB1c2VyU3JjQmFsYW5jZUFmdGVyID0gZ2V0QmFsYW5jZShzcmMsIG1zZy5zZW5kZXIpOwogICAgICAgIHVzZXJEZXN0QmFsYW5jZUFmdGVyID0gZ2V0QmFsYW5jZShkZXN0LCBkZXN0QWRkcmVzcyk7CgogICAgICAgIHJlcXVpcmUodXNlclNyY0JhbGFuY2VBZnRlciA8PSB1c2VyU3JjQmFsYW5jZUJlZm9yZSk7CiAgICAgICAgcmVxdWlyZSh1c2VyRGVzdEJhbGFuY2VBZnRlciA+PSB1c2VyRGVzdEJhbGFuY2VCZWZvcmUpOwoKICAgICAgICByZXF1aXJlKCh1c2VyRGVzdEJhbGFuY2VBZnRlciAtIHVzZXJEZXN0QmFsYW5jZUJlZm9yZSkgPj0KICAgICAgICAgICAgY2FsY0RzdFF0eSgodXNlclNyY0JhbGFuY2VCZWZvcmUgLSB1c2VyU3JjQmFsYW5jZUFmdGVyKSwgZ2V0RGVjaW1hbHMoc3JjKSwgZ2V0RGVjaW1hbHMoZGVzdCksCiAgICAgICAgICAgICAgICBtaW5Db252ZXJzaW9uUmF0ZSkpOwoKICAgICAgICByZXR1cm4gYWN0dWFsRGVzdEFtb3VudDsKICAgIH0KCiAgICBldmVudCBBZGRSZXNlcnZlVG9OZXR3b3JrKEt5YmVyUmVzZXJ2ZSByZXNlcnZlLCBib29sIGFkZCk7CgogICAgLy8vIEBub3RpY2UgY2FuIGJlIGNhbGxlZCBvbmx5IGJ5IGFkbWluCiAgICAvLy8gQGRldiBhZGQgb3IgZGVsZXRlcyBhIHJlc2VydmUgdG8vZnJvbSB0aGUgbmV0d29yay4KICAgIC8vLyBAcGFyYW0gcmVzZXJ2ZSBUaGUgcmVzZXJ2ZSBhZGRyZXNzLgogICAgLy8vIEBwYXJhbSBhZGQgSWYgdHJ1ZSwgdGhlIGFkZCByZXNlcnZlLiBPdGhlcndpc2UgZGVsZXRlIHJlc2VydmUuCiAgICBmdW5jdGlvbiBhZGRSZXNlcnZlKEt5YmVyUmVzZXJ2ZSByZXNlcnZlLCBib29sIGFkZCkgcHVibGljIG9ubHlBZG1pbiB7CgogICAgICAgIGlmIChhZGQpIHsKICAgICAgICAgICAgcmVxdWlyZSghaXNSZXNlcnZlW3Jlc2VydmVdKTsKICAgICAgICAgICAgcmVzZXJ2ZXMucHVzaChyZXNlcnZlKTsKICAgICAgICAgICAgaXNSZXNlcnZlW3Jlc2VydmVdID0gdHJ1ZTsKICAgICAgICAgICAgQWRkUmVzZXJ2ZVRvTmV0d29yayhyZXNlcnZlLCB0cnVlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpc1Jlc2VydmVbcmVzZXJ2ZV0gPSBmYWxzZTsKICAgICAgICAgICAgLy8gd2lsbCBoYXZlIHRyb3VibGUgaWYgbW9yZSB0aGFuIDUwayByZXNlcnZlcy4uLgogICAgICAgICAgICBmb3IgKHVpbnQgaSA9IDA7IGkgPCByZXNlcnZlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgaWYgKHJlc2VydmVzW2ldID09IHJlc2VydmUpIHsKICAgICAgICAgICAgICAgICAgICByZXNlcnZlc1tpXSA9IHJlc2VydmVzW3Jlc2VydmVzLmxlbmd0aCAtIDFdOwogICAgICAgICAgICAgICAgICAgIHJlc2VydmVzLmxlbmd0aC0tOwogICAgICAgICAgICAgICAgICAgIEFkZFJlc2VydmVUb05ldHdvcmsocmVzZXJ2ZSwgZmFsc2UpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIGV2ZW50IExpc3RSZXNlcnZlUGFpcnMoYWRkcmVzcyByZXNlcnZlLCBFUkMyMCBzcmMsIEVSQzIwIGRlc3QsIGJvb2wgYWRkKTsKCiAgICAvLy8gQG5vdGljZSBjYW4gYmUgY2FsbGVkIG9ubHkgYnkgYWRtaW4KICAgIC8vLyBAZGV2IGFsbG93IG9yIHByZXZlbnQgYSBzcGVjaWZpYyByZXNlcnZlIHRvIHRyYWRlIGEgcGFpciBvZiB0b2tlbnMKICAgIC8vLyBAcGFyYW0gcmVzZXJ2ZSBUaGUgcmVzZXJ2ZSBhZGRyZXNzLgogICAgLy8vIEBwYXJhbSBzcmMgU3JjIHRva2VuCiAgICAvLy8gQHBhcmFtIGRlc3QgRGVzdGluYXRpb24gdG9rZW4KICAgIC8vLyBAcGFyYW0gYWRkIElmIHRydWUgdGhlbiBlbmFibGUgdHJhZGUsIG90aGVyd2lzZSBkZWxpc3QgcGFpci4KICAgIGZ1bmN0aW9uIGxpc3RQYWlyRm9yUmVzZXJ2ZShhZGRyZXNzIHJlc2VydmUsIEVSQzIwIHNyYywgRVJDMjAgZGVzdCwgYm9vbCBhZGQpIHB1YmxpYyBvbmx5QWRtaW4gewogICAgICAgIChwZXJSZXNlcnZlTGlzdGVkUGFpcnNbcmVzZXJ2ZV0pW2tlY2NhazI1NihzcmMsIGRlc3QpXSA9IGFkZDsKCiAgICAgICAgaWYgKHNyYyAhPSBFVEhfVE9LRU5fQUREUkVTUykgewogICAgICAgICAgICBpZiAoYWRkKSB7CiAgICAgICAgICAgICAgICBzcmMuYXBwcm92ZShyZXNlcnZlLCAyKioyNTUpOyAvLyBhcHByb3ZlIGluZmluaXR5CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBzcmMuYXBwcm92ZShyZXNlcnZlLCAwKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgTGlzdFJlc2VydmVQYWlycyhyZXNlcnZlLCBzcmMsIGRlc3QsIGFkZCk7CiAgICB9CgogICAgZnVuY3Rpb24gc2V0UGFyYW1zKAogICAgICAgIFdoaXRlTGlzdCBfd2hpdGVMaXN0LAogICAgICAgIEV4cGVjdGVkUmF0ZUludGVyZmFjZSBfZXhwZWN0ZWRSYXRlLAogICAgICAgIEZlZUJ1cm5lckludGVyZmFjZSAgICBfZmVlQnVybmVyLAogICAgICAgIHVpbnQgICAgICAgICAgICAgICAgICBfbWF4R2FzUHJpY2UsCiAgICAgICAgdWludCAgICAgICAgICAgICAgICAgIF9uZWdsaWdpYmxlUmF0ZURpZmYKICAgICkKICAgICAgICBwdWJsaWMKICAgICAgICBvbmx5QWRtaW4KICAgIHsKICAgICAgICByZXF1aXJlKF93aGl0ZUxpc3QgIT0gYWRkcmVzcygwKSk7CiAgICAgICAgcmVxdWlyZShfZmVlQnVybmVyICE9IGFkZHJlc3MoMCkpOwogICAgICAgIHJlcXVpcmUoX2V4cGVjdGVkUmF0ZSAhPSBhZGRyZXNzKDApKTsKICAgICAgICB3aGl0ZUxpc3RDb250cmFjdCA9IF93aGl0ZUxpc3Q7CiAgICAgICAgZXhwZWN0ZWRSYXRlQ29udHJhY3QgPSBfZXhwZWN0ZWRSYXRlOwogICAgICAgIGZlZUJ1cm5lckNvbnRyYWN0ID0gX2ZlZUJ1cm5lcjsKICAgICAgICBtYXhHYXNQcmljZSA9IF9tYXhHYXNQcmljZTsKICAgICAgICBuZWdsaWdpYmxlUmF0ZURpZmYgPSBfbmVnbGlnaWJsZVJhdGVEaWZmOwogICAgfQoKICAgIGZ1bmN0aW9uIHNldEVuYWJsZShib29sIF9lbmFibGUpIHB1YmxpYyBvbmx5QWRtaW4gewogICAgICAgIGlmIChfZW5hYmxlKSB7CiAgICAgICAgICAgIHJlcXVpcmUod2hpdGVMaXN0Q29udHJhY3QgIT0gYWRkcmVzcygwKSk7CiAgICAgICAgICAgIHJlcXVpcmUoZmVlQnVybmVyQ29udHJhY3QgIT0gYWRkcmVzcygwKSk7CiAgICAgICAgICAgIHJlcXVpcmUoZXhwZWN0ZWRSYXRlQ29udHJhY3QgIT0gYWRkcmVzcygwKSk7CiAgICAgICAgfQogICAgICAgIGVuYWJsZWQgPSBfZW5hYmxlOwogICAgfQoKICAgIC8vLyBAZGV2IHJldHVybnMgbnVtYmVyIG9mIHJlc2VydmVzCiAgICAvLy8gQHJldHVybiBudW1iZXIgb2YgcmVzZXJ2ZXMKICAgIGZ1bmN0aW9uIGdldE51bVJlc2VydmVzKCkgcHVibGljIHZpZXcgcmV0dXJucyh1aW50KSB7CiAgICAgICAgcmV0dXJuIHJlc2VydmVzLmxlbmd0aDsKICAgIH0KCiAgICAvLy8gQG5vdGljZSBzaG91bGQgYmUgY2FsbGVkIG9mZiBjaGFpbiB3aXRoIGFzIG11Y2ggZ2FzIGFzIG5lZWRlZAogICAgLy8vIEBkZXYgZ2V0IGFuIGFycmF5IG9mIGFsbCByZXNlcnZlcwogICAgLy8vIEByZXR1cm4gQW4gYXJyYXkgb2YgYWxsIHJlc2VydmVzCiAgICBmdW5jdGlvbiBnZXRSZXNlcnZlcygpIHB1YmxpYyB2aWV3IHJldHVybnMoS3liZXJSZXNlcnZlW10pIHsKICAgICAgICByZXR1cm4gcmVzZXJ2ZXM7CiAgICB9CgogICAgLy8vIEBkZXYgZ2V0IHRoZSBiYWxhbmNlIG9mIGEgdXNlci4KICAgIC8vLyBAcGFyYW0gdG9rZW4gVGhlIHRva2VuIHR5cGUKICAgIC8vLyBAcmV0dXJuIFRoZSBiYWxhbmNlCiAgICBmdW5jdGlvbiBnZXRCYWxhbmNlKEVSQzIwIHRva2VuLCBhZGRyZXNzIHVzZXIpIHB1YmxpYyB2aWV3IHJldHVybnModWludCkgewogICAgICAgIGlmICh0b2tlbiA9PSBFVEhfVE9LRU5fQUREUkVTUykKICAgICAgICAgICAgcmV0dXJuIHVzZXIuYmFsYW5jZTsKICAgICAgICBlbHNlCiAgICAgICAgICAgIHJldHVybiB0b2tlbi5iYWxhbmNlT2YodXNlcik7CiAgICB9CgogICAgLy8vIEBub3RpY2UgdXNlIHRva2VuIGFkZHJlc3MgRVRIX1RPS0VOX0FERFJFU1MgZm9yIGV0aGVyCiAgICAvLy8gQGRldiBiZXN0IGNvbnZlcnNpb24gcmF0ZSBmb3IgYSBwYWlyIG9mIHRva2VucywgaWYgbnVtYmVyIG9mIHJlc2VydmVzIGhhdmUgc21hbGwgZGlmZmVyZW5jZXMuIHJhbmRvbWl6ZQogICAgLy8vIEBwYXJhbSBzcmMgU3JjIHRva2VuCiAgICAvLy8gQHBhcmFtIGRlc3QgRGVzdGluYXRpb24gdG9rZW4KICAgIC8qIHNvbGhpbnQtZGlzYWJsZSBjb2RlLWNvbXBsZXhpdHkgKi8KICAgIGZ1bmN0aW9uIGZpbmRCZXN0UmF0ZShFUkMyMCBzcmMsIEVSQzIwIGRlc3QsIHVpbnQgc3JjUXR5KSBwdWJsaWMgdmlldyByZXR1cm5zKHVpbnQsIHVpbnQpIHsKICAgICAgICB1aW50IGJlc3RSYXRlID0gMDsKICAgICAgICB1aW50IGJlc3RSZXNlcnZlID0gMDsKICAgICAgICB1aW50IG51bVJlbGV2YW50UmVzZXJ2ZXMgPSAwOwogICAgICAgIHVpbnQgbnVtUmVzZXJ2ZXMgPSByZXNlcnZlcy5sZW5ndGg7CiAgICAgICAgdWludFtdIG1lbW9yeSByYXRlcyA9IG5ldyB1aW50W10obnVtUmVzZXJ2ZXMpOwogICAgICAgIHVpbnRbXSBtZW1vcnkgcmVzZXJ2ZUNhbmRpZGF0ZXMgPSBuZXcgdWludFtdKG51bVJlc2VydmVzKTsKCiAgICAgICAgZm9yICh1aW50IGkgPSAwOyBpIDwgbnVtUmVzZXJ2ZXM7IGkrKykgewogICAgICAgICAgICAvL2xpc3QgYWxsIHJlc2VydmVzIHRoYXQgaGF2ZSB0aGlzIHRva2VuLgogICAgICAgICAgICBpZiAoIShwZXJSZXNlcnZlTGlzdGVkUGFpcnNbcmVzZXJ2ZXNbaV1dKVtrZWNjYWsyNTYoc3JjLCBkZXN0KV0pIGNvbnRpbnVlOwoKICAgICAgICAgICAgcmF0ZXNbaV0gPSByZXNlcnZlc1tpXS5nZXRDb252ZXJzaW9uUmF0ZShzcmMsIGRlc3QsIHNyY1F0eSwgYmxvY2subnVtYmVyKTsKCiAgICAgICAgICAgIGlmIChyYXRlc1tpXSA+IGJlc3RSYXRlKSB7CiAgICAgICAgICAgICAgICAvL2Jlc3QgcmF0ZSBpcyBoaWdoZXN0IHJhdGUKICAgICAgICAgICAgICAgIGJlc3RSYXRlID0gcmF0ZXNbaV07CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChiZXN0UmF0ZSA+IDApIHsKICAgICAgICAgICAgdWludCByYW5kb20gPSAwOwogICAgICAgICAgICB1aW50IHNtYWxsZXN0UmVsZXZhbnRSYXRlID0gKGJlc3RSYXRlICogMTAwMDApIC8gKDEwMDAwICsgbmVnbGlnaWJsZVJhdGVEaWZmKTsKCiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBudW1SZXNlcnZlczsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAocmF0ZXNbaV0gPj0gc21hbGxlc3RSZWxldmFudFJhdGUpIHsKICAgICAgICAgICAgICAgICAgICByZXNlcnZlQ2FuZGlkYXRlc1tudW1SZWxldmFudFJlc2VydmVzKytdID0gaTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKG51bVJlbGV2YW50UmVzZXJ2ZXMgPiAxKSB7CiAgICAgICAgICAgICAgICAvL3doZW4gZW5jb3VudGVyaW5nIHNtYWxsIHJhdGUgZGlmZiBmcm9tIGJlc3RSYXRlLiBkcmF3IGZyb20gcmVsZXZhbnQgcmVzZXJ2ZXMKICAgICAgICAgICAgICAgIHJhbmRvbSA9IHVpbnQoYmxvY2suYmxvY2toYXNoKGJsb2NrLm51bWJlci0xKSkgJSBudW1SZWxldmFudFJlc2VydmVzOwogICAgICAgICAgICB9CgogICAgICAgICAgICBiZXN0UmVzZXJ2ZSA9IHJlc2VydmVDYW5kaWRhdGVzW3JhbmRvbV07CiAgICAgICAgICAgIGJlc3RSYXRlID0gcmF0ZXNbYmVzdFJlc2VydmVdOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIChiZXN0UmVzZXJ2ZSwgYmVzdFJhdGUpOwogICAgfQogICAgLyogc29saGludC1lbmFibGUgY29kZS1jb21wbGV4aXR5ICovCgogICAgZnVuY3Rpb24gZ2V0RXhwZWN0ZWRSYXRlKEVSQzIwIHNyYywgRVJDMjAgZGVzdCwgdWludCBzcmNRdHkpCiAgICAgICAgcHVibGljIHZpZXcKICAgICAgICByZXR1cm5zICh1aW50IGV4cGVjdGVkUmF0ZSwgdWludCBzbGlwcGFnZVJhdGUpCiAgICB7CiAgICAgICAgcmVxdWlyZShleHBlY3RlZFJhdGVDb250cmFjdCAhPSBhZGRyZXNzKDApKTsKICAgICAgICByZXR1cm4gZXhwZWN0ZWRSYXRlQ29udHJhY3QuZ2V0RXhwZWN0ZWRSYXRlKHNyYywgZGVzdCwgc3JjUXR5KTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRVc2VyQ2FwSW5XZWkoYWRkcmVzcyB1c2VyKSBwdWJsaWMgdmlldyByZXR1cm5zKHVpbnQpIHsKICAgICAgICByZXR1cm4gd2hpdGVMaXN0Q29udHJhY3QuZ2V0VXNlckNhcEluV2VpKHVzZXIpOwogICAgfQoKICAgIGZ1bmN0aW9uIGRvVHJhZGUoCiAgICAgICAgRVJDMjAgc3JjLAogICAgICAgIHVpbnQgc3JjQW1vdW50LAogICAgICAgIEVSQzIwIGRlc3QsCiAgICAgICAgYWRkcmVzcyBkZXN0QWRkcmVzcywKICAgICAgICB1aW50IG1heERlc3RBbW91bnQsCiAgICAgICAgdWludCBtaW5Db252ZXJzaW9uUmF0ZSwKICAgICAgICBhZGRyZXNzIHdhbGxldElkCiAgICApCiAgICAgICAgaW50ZXJuYWwKICAgICAgICByZXR1cm5zKHVpbnQpCiAgICB7CiAgICAgICAgcmVxdWlyZSh0eC5nYXNwcmljZSA8PSBtYXhHYXNQcmljZSk7CiAgICAgICAgcmVxdWlyZSh2YWxpZGF0ZVRyYWRlSW5wdXQoc3JjLCBzcmNBbW91bnQsIGRlc3RBZGRyZXNzKSk7CgogICAgICAgIHVpbnQgcmVzZXJ2ZUluZDsKICAgICAgICB1aW50IHJhdGU7CgogICAgICAgIChyZXNlcnZlSW5kLCByYXRlKSA9IGZpbmRCZXN0UmF0ZShzcmMsIGRlc3QsIHNyY0Ftb3VudCk7CiAgICAgICAgS3liZXJSZXNlcnZlIHRoZVJlc2VydmUgPSByZXNlcnZlc1tyZXNlcnZlSW5kXTsKICAgICAgICByZXF1aXJlKHJhdGUgPiAwKTsKICAgICAgICByZXF1aXJlKHJhdGUgPCBNQVhfUkFURSk7CiAgICAgICAgcmVxdWlyZShyYXRlID49IG1pbkNvbnZlcnNpb25SYXRlKTsKCiAgICAgICAgdWludCBhY3R1YWxTcmNBbW91bnQgPSBzcmNBbW91bnQ7CiAgICAgICAgdWludCBhY3R1YWxEZXN0QW1vdW50ID0gY2FsY0Rlc3RBbW91bnQoc3JjLCBkZXN0LCBhY3R1YWxTcmNBbW91bnQsIHJhdGUpOwogICAgICAgIGlmIChhY3R1YWxEZXN0QW1vdW50ID4gbWF4RGVzdEFtb3VudCkgewogICAgICAgICAgICBhY3R1YWxEZXN0QW1vdW50ID0gbWF4RGVzdEFtb3VudDsKICAgICAgICAgICAgYWN0dWFsU3JjQW1vdW50ID0gY2FsY1NyY0Ftb3VudChzcmMsIGRlc3QsIGFjdHVhbERlc3RBbW91bnQsIHJhdGUpOwogICAgICAgICAgICByZXF1aXJlKGFjdHVhbFNyY0Ftb3VudCA8PSBzcmNBbW91bnQpOwogICAgICAgIH0KCiAgICAgICAgLy8gZG8gdGhlIHRyYWRlCiAgICAgICAgLy8gdmVyaWZ5IHRyYWRlIHNpemUgaXMgc21hbGxlciB0aGFuIHVzZXIgY2FwCiAgICAgICAgdWludCBldGhBbW91bnQ7CiAgICAgICAgaWYgKHNyYyA9PSBFVEhfVE9LRU5fQUREUkVTUykgewogICAgICAgICAgICBldGhBbW91bnQgPSBhY3R1YWxTcmNBbW91bnQ7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZXRoQW1vdW50ID0gYWN0dWFsRGVzdEFtb3VudDsKICAgICAgICB9CgogICAgICAgIHJlcXVpcmUoZXRoQW1vdW50IDw9IGdldFVzZXJDYXBJbldlaShtc2cuc2VuZGVyKSk7CiAgICAgICAgcmVxdWlyZShkb1Jlc2VydmVUcmFkZSgKICAgICAgICAgICAgICAgIHNyYywKICAgICAgICAgICAgICAgIGFjdHVhbFNyY0Ftb3VudCwKICAgICAgICAgICAgICAgIGRlc3QsCiAgICAgICAgICAgICAgICBkZXN0QWRkcmVzcywKICAgICAgICAgICAgICAgIGFjdHVhbERlc3RBbW91bnQsCiAgICAgICAgICAgICAgICB0aGVSZXNlcnZlLAogICAgICAgICAgICAgICAgcmF0ZSwKICAgICAgICAgICAgICAgIHRydWUpKTsKCiAgICAgICAgaWYgKChhY3R1YWxTcmNBbW91bnQgPCBzcmNBbW91bnQpICYmIChzcmMgPT0gRVRIX1RPS0VOX0FERFJFU1MpKSB7CiAgICAgICAgICAgIG1zZy5zZW5kZXIudHJhbnNmZXIoc3JjQW1vdW50IC0gYWN0dWFsU3JjQW1vdW50KTsKICAgICAgICB9CgogICAgICAgIHJlcXVpcmUoZmVlQnVybmVyQ29udHJhY3QuaGFuZGxlRmVlcyhldGhBbW91bnQsIHRoZVJlc2VydmUsIHdhbGxldElkKSk7CgogICAgICAgIEV4ZWN1dGVUcmFkZShtc2cuc2VuZGVyLCBzcmMsIGRlc3QsIGFjdHVhbFNyY0Ftb3VudCwgYWN0dWFsRGVzdEFtb3VudCk7CiAgICAgICAgcmV0dXJuIGFjdHVhbERlc3RBbW91bnQ7CiAgICB9CgogICAgLy8vIEBub3RpY2UgdXNlIHRva2VuIGFkZHJlc3MgRVRIX1RPS0VOX0FERFJFU1MgZm9yIGV0aGVyCiAgICAvLy8gQGRldiBkbyBvbmUgdHJhZGUgd2l0aCBhIHJlc2VydmUKICAgIC8vLyBAcGFyYW0gc3JjIFNyYyB0b2tlbgogICAgLy8vIEBwYXJhbSBhbW91bnQgYW1vdW50IG9mIHNyYyB0b2tlbnMKICAgIC8vLyBAcGFyYW0gZGVzdCAgIERlc3RpbmF0aW9uIHRva2VuCiAgICAvLy8gQHBhcmFtIGRlc3RBZGRyZXNzIEFkZHJlc3MgdG8gc2VuZCB0b2tlbnMgdG8KICAgIC8vLyBAcGFyYW0gcmVzZXJ2ZSBSZXNlcnZlIHRvIHVzZQogICAgLy8vIEBwYXJhbSB2YWxpZGF0ZSBJZiB0cnVlLCBhZGRpdGlvbmFsIHZhbGlkYXRpb25zIGFyZSBhcHBsaWNhYmxlCiAgICAvLy8gQHJldHVybiB0cnVlIGlmIHRyYWRlIGlzIHN1Y2Nlc3NmdWwKICAgIGZ1bmN0aW9uIGRvUmVzZXJ2ZVRyYWRlKAogICAgICAgIEVSQzIwIHNyYywKICAgICAgICB1aW50IGFtb3VudCwKICAgICAgICBFUkMyMCBkZXN0LAogICAgICAgIGFkZHJlc3MgZGVzdEFkZHJlc3MsCiAgICAgICAgdWludCBleHBlY3RlZERlc3RBbW91bnQsCiAgICAgICAgS3liZXJSZXNlcnZlIHJlc2VydmUsCiAgICAgICAgdWludCBjb252ZXJzaW9uUmF0ZSwKICAgICAgICBib29sIHZhbGlkYXRlCiAgICApCiAgICAgICAgaW50ZXJuYWwKICAgICAgICByZXR1cm5zKGJvb2wpCiAgICB7CiAgICAgICAgdWludCBjYWxsVmFsdWUgPSAwOwoKICAgICAgICBpZiAoc3JjID09IEVUSF9UT0tFTl9BRERSRVNTKSB7CiAgICAgICAgICAgIGNhbGxWYWx1ZSA9IGFtb3VudDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyB0YWtlIHNyYyB0b2tlbnMgdG8gdGhpcyBjb250cmFjdAogICAgICAgICAgICBzcmMudHJhbnNmZXJGcm9tKG1zZy5zZW5kZXIsIHRoaXMsIGFtb3VudCk7CiAgICAgICAgfQoKICAgICAgICAvLyByZXNlcnZlIHNlbmRzIHRva2Vucy9ldGggdG8gbmV0d29yay4gbmV0d29yayBzZW5kcyBpdCB0byBkZXN0aW5hdGlvbgogICAgICAgIHJlcXVpcmUocmVzZXJ2ZS50cmFkZS52YWx1ZShjYWxsVmFsdWUpKHNyYywgYW1vdW50LCBkZXN0LCB0aGlzLCBjb252ZXJzaW9uUmF0ZSwgdmFsaWRhdGUpKTsKCiAgICAgICAgaWYgKGRlc3QgPT0gRVRIX1RPS0VOX0FERFJFU1MpIHsKICAgICAgICAgICAgZGVzdEFkZHJlc3MudHJhbnNmZXIoZXhwZWN0ZWREZXN0QW1vdW50KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXF1aXJlKGRlc3QudHJhbnNmZXIoZGVzdEFkZHJlc3MsIGV4cGVjdGVkRGVzdEFtb3VudCkpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0RGVjaW1hbHMoRVJDMjAgdG9rZW4pIGludGVybmFsIHZpZXcgcmV0dXJucyh1aW50KSB7CiAgICAgICAgaWYgKHRva2VuID09IEVUSF9UT0tFTl9BRERSRVNTKSByZXR1cm4gMTg7CiAgICAgICAgcmV0dXJuIHRva2VuLmRlY2ltYWxzKCk7CiAgICB9CgogICAgZnVuY3Rpb24gY2FsY0Rlc3RBbW91bnQoRVJDMjAgc3JjLCBFUkMyMCBkZXN0LCB1aW50IHNyY0Ftb3VudCwgdWludCByYXRlKSBpbnRlcm5hbCB2aWV3IHJldHVybnModWludCkgewogICAgICAgIHJldHVybiBjYWxjRHN0UXR5KHNyY0Ftb3VudCwgZ2V0RGVjaW1hbHMoc3JjKSwgZ2V0RGVjaW1hbHMoZGVzdCksIHJhdGUpOwogICAgfQoKICAgIGZ1bmN0aW9uIGNhbGNTcmNBbW91bnQoRVJDMjAgc3JjLCBFUkMyMCBkZXN0LCB1aW50IGRlc3RBbW91bnQsIHVpbnQgcmF0ZSkgaW50ZXJuYWwgdmlldyByZXR1cm5zKHVpbnQpIHsKICAgICAgICByZXR1cm4gY2FsY1NyY1F0eShkZXN0QW1vdW50LCBnZXREZWNpbWFscyhzcmMpLCBnZXREZWNpbWFscyhkZXN0KSwgcmF0ZSk7CiAgICB9CgogICAgLy8vIEBub3RpY2UgdXNlIHRva2VuIGFkZHJlc3MgRVRIX1RPS0VOX0FERFJFU1MgZm9yIGV0aGVyCiAgICAvLy8gQGRldiBjaGVja3MgdGhhdCB1c2VyIHNlbnQgZXRoZXIvdG9rZW5zIHRvIGNvbnRyYWN0IGJlZm9yZSB0cmFkZQogICAgLy8vIEBwYXJhbSBzcmMgU3JjIHRva2VuCiAgICAvLy8gQHBhcmFtIHNyY0Ftb3VudCBhbW91bnQgb2Ygc3JjIHRva2VucwogICAgLy8vIEByZXR1cm4gdHJ1ZSBpZiBpbnB1dCBpcyB2YWxpZAogICAgZnVuY3Rpb24gdmFsaWRhdGVUcmFkZUlucHV0KEVSQzIwIHNyYywgdWludCBzcmNBbW91bnQsIGFkZHJlc3MgZGVzdEFkZHJlc3MpIGludGVybmFsIHZpZXcgcmV0dXJucyhib29sKSB7CiAgICAgICAgaWYgKChzcmNBbW91bnQgPj0gTUFYX1FUWSkgfHwgKHNyY0Ftb3VudCA9PSAwKSB8fCAoZGVzdEFkZHJlc3MgPT0gMCkpCiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKCiAgICAgICAgaWYgKHNyYyA9PSBFVEhfVE9LRU5fQUREUkVTUykgewogICAgICAgICAgICBpZiAobXNnLnZhbHVlICE9IHNyY0Ftb3VudCkKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoKG1zZy52YWx1ZSAhPSAwKSB8fCAoc3JjLmFsbG93YW5jZShtc2cuc2VuZGVyLCB0aGlzKSA8IHNyY0Ftb3VudCkpCiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KfQoKY29udHJhY3QgS3liZXJSZXNlcnZlIGlzIFdpdGhkcmF3YWJsZSwgVXRpbHMgewoKICAgIGFkZHJlc3MgcHVibGljIGt5YmVyTmV0d29yazsKICAgIGJvb2wgcHVibGljIHRyYWRlRW5hYmxlZDsKICAgIENvbnZlcnNpb25SYXRlcyBwdWJsaWMgY29udmVyc2lvblJhdGVzQ29udHJhY3Q7CiAgICBTYW5pdHlSYXRlc0ludGVyZmFjZSBwdWJsaWMgc2FuaXR5UmF0ZXNDb250cmFjdDsKICAgIG1hcHBpbmcoYnl0ZXMzMj0+Ym9vbCkgcHVibGljIGFwcHJvdmVkV2l0aGRyYXdBZGRyZXNzZXM7IC8vIHNoYTModG9rZW4sYWRkcmVzcyk9PmJvb2wKCiAgICBmdW5jdGlvbiBLeWJlclJlc2VydmUoYWRkcmVzcyBfa3liZXJOZXR3b3JrLCBDb252ZXJzaW9uUmF0ZXMgX3JhdGVzQ29udHJhY3QsIGFkZHJlc3MgX2FkbWluKSBwdWJsaWMgewogICAgICAgIHJlcXVpcmUoX2FkbWluICE9IGFkZHJlc3MoMCkpOwogICAgICAgIHJlcXVpcmUoX3JhdGVzQ29udHJhY3QgIT0gYWRkcmVzcygwKSk7CiAgICAgICAgcmVxdWlyZShfa3liZXJOZXR3b3JrICE9IGFkZHJlc3MoMCkpOwogICAgICAgIGt5YmVyTmV0d29yayA9IF9reWJlck5ldHdvcms7CiAgICAgICAgY29udmVyc2lvblJhdGVzQ29udHJhY3QgPSBfcmF0ZXNDb250cmFjdDsKICAgICAgICBhZG1pbiA9IF9hZG1pbjsKICAgICAgICB0cmFkZUVuYWJsZWQgPSB0cnVlOwogICAgfQoKICAgIGV2ZW50IERlcG9zaXRUb2tlbihFUkMyMCB0b2tlbiwgdWludCBhbW91bnQpOwoKICAgIGZ1bmN0aW9uKCkgcHVibGljIHBheWFibGUgewogICAgICAgIERlcG9zaXRUb2tlbihFVEhfVE9LRU5fQUREUkVTUywgbXNnLnZhbHVlKTsKICAgIH0KCiAgICBldmVudCBUcmFkZUV4ZWN1dGUoCiAgICAgICAgYWRkcmVzcyBpbmRleGVkIG9yaWdpbiwKICAgICAgICBhZGRyZXNzIHNyYywKICAgICAgICB1aW50IHNyY0Ftb3VudCwKICAgICAgICBhZGRyZXNzIGRlc3RUb2tlbiwKICAgICAgICB1aW50IGRlc3RBbW91bnQsCiAgICAgICAgYWRkcmVzcyBkZXN0QWRkcmVzcwogICAgKTsKCiAgICBmdW5jdGlvbiB0cmFkZSgKICAgICAgICBFUkMyMCBzcmNUb2tlbiwKICAgICAgICB1aW50IHNyY0Ftb3VudCwKICAgICAgICBFUkMyMCBkZXN0VG9rZW4sCiAgICAgICAgYWRkcmVzcyBkZXN0QWRkcmVzcywKICAgICAgICB1aW50IGNvbnZlcnNpb25SYXRlLAogICAgICAgIGJvb2wgdmFsaWRhdGUKICAgICkKICAgICAgICBwdWJsaWMKICAgICAgICBwYXlhYmxlCiAgICAgICAgcmV0dXJucyhib29sKQogICAgewogICAgICAgIHJlcXVpcmUodHJhZGVFbmFibGVkKTsKICAgICAgICByZXF1aXJlKG1zZy5zZW5kZXIgPT0ga3liZXJOZXR3b3JrKTsKCiAgICAgICAgcmVxdWlyZShkb1RyYWRlKHNyY1Rva2VuLCBzcmNBbW91bnQsIGRlc3RUb2tlbiwgZGVzdEFkZHJlc3MsIGNvbnZlcnNpb25SYXRlLCB2YWxpZGF0ZSkpOwoKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICBldmVudCBUcmFkZUVuYWJsZWQoYm9vbCBlbmFibGUpOwoKICAgIGZ1bmN0aW9uIGVuYWJsZVRyYWRlKCkgcHVibGljIG9ubHlBZG1pbiByZXR1cm5zKGJvb2wpIHsKICAgICAgICB0cmFkZUVuYWJsZWQgPSB0cnVlOwogICAgICAgIFRyYWRlRW5hYmxlZCh0cnVlKTsKCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgZnVuY3Rpb24gZGlzYWJsZVRyYWRlKCkgcHVibGljIG9ubHlBbGVydGVyIHJldHVybnMoYm9vbCkgewogICAgICAgIHRyYWRlRW5hYmxlZCA9IGZhbHNlOwogICAgICAgIFRyYWRlRW5hYmxlZChmYWxzZSk7CgogICAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIGV2ZW50IFdpdGhkcmF3QWRkcmVzc0FwcHJvdmVkKEVSQzIwIHRva2VuLCBhZGRyZXNzIGFkZHIsIGJvb2wgYXBwcm92ZSk7CgogICAgZnVuY3Rpb24gYXBwcm92ZVdpdGhkcmF3QWRkcmVzcyhFUkMyMCB0b2tlbiwgYWRkcmVzcyBhZGRyLCBib29sIGFwcHJvdmUpIHB1YmxpYyBvbmx5QWRtaW4gewogICAgICAgIGFwcHJvdmVkV2l0aGRyYXdBZGRyZXNzZXNba2VjY2FrMjU2KHRva2VuLCBhZGRyKV0gPSBhcHByb3ZlOwogICAgICAgIFdpdGhkcmF3QWRkcmVzc0FwcHJvdmVkKHRva2VuLCBhZGRyLCBhcHByb3ZlKTsKICAgIH0KCiAgICBldmVudCBXaXRoZHJhd0Z1bmRzKEVSQzIwIHRva2VuLCB1aW50IGFtb3VudCwgYWRkcmVzcyBkZXN0aW5hdGlvbik7CgogICAgZnVuY3Rpb24gd2l0aGRyYXcoRVJDMjAgdG9rZW4sIHVpbnQgYW1vdW50LCBhZGRyZXNzIGRlc3RpbmF0aW9uKSBwdWJsaWMgb25seU9wZXJhdG9yIHJldHVybnMoYm9vbCkgewogICAgICAgIHJlcXVpcmUoYXBwcm92ZWRXaXRoZHJhd0FkZHJlc3Nlc1trZWNjYWsyNTYodG9rZW4sIGRlc3RpbmF0aW9uKV0pOwoKICAgICAgICBpZiAodG9rZW4gPT0gRVRIX1RPS0VOX0FERFJFU1MpIHsKICAgICAgICAgICAgZGVzdGluYXRpb24udHJhbnNmZXIoYW1vdW50KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXF1aXJlKHRva2VuLnRyYW5zZmVyKGRlc3RpbmF0aW9uLCBhbW91bnQpKTsKICAgICAgICB9CgogICAgICAgIFdpdGhkcmF3RnVuZHModG9rZW4sIGFtb3VudCwgZGVzdGluYXRpb24pOwoKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICBldmVudCBTZXRDb250cmFjdEFkZHJlc3NlcyhhZGRyZXNzIG5ldHdvcmssIGFkZHJlc3MgcmF0ZSwgYWRkcmVzcyBzYW5pdHkpOwoKICAgIGZ1bmN0aW9uIHNldENvbnRyYWN0cyhhZGRyZXNzIF9reWJlck5ldHdvcmssIENvbnZlcnNpb25SYXRlcyBfY29udmVyc2lvblJhdGVzLCBTYW5pdHlSYXRlc0ludGVyZmFjZSBfc2FuaXR5UmF0ZXMpCiAgICAgICAgcHVibGljCiAgICAgICAgb25seUFkbWluCiAgICB7CiAgICAgICAgcmVxdWlyZShfa3liZXJOZXR3b3JrICE9IGFkZHJlc3MoMCkpOwogICAgICAgIHJlcXVpcmUoX2NvbnZlcnNpb25SYXRlcyAhPSBhZGRyZXNzKDApKTsKCiAgICAgICAga3liZXJOZXR3b3JrID0gX2t5YmVyTmV0d29yazsKICAgICAgICBjb252ZXJzaW9uUmF0ZXNDb250cmFjdCA9IF9jb252ZXJzaW9uUmF0ZXM7CiAgICAgICAgc2FuaXR5UmF0ZXNDb250cmFjdCA9IF9zYW5pdHlSYXRlczsKCiAgICAgICAgU2V0Q29udHJhY3RBZGRyZXNzZXMoa3liZXJOZXR3b3JrLCBjb252ZXJzaW9uUmF0ZXNDb250cmFjdCwgc2FuaXR5UmF0ZXNDb250cmFjdCk7CiAgICB9CgogICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgLy8vIHN0YXR1cyBmdW5jdGlvbnMgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgZnVuY3Rpb24gZ2V0QmFsYW5jZShFUkMyMCB0b2tlbikgcHVibGljIHZpZXcgcmV0dXJucyh1aW50KSB7CiAgICAgICAgaWYgKHRva2VuID09IEVUSF9UT0tFTl9BRERSRVNTKQogICAgICAgICAgICByZXR1cm4gdGhpcy5iYWxhbmNlOwogICAgICAgIGVsc2UKICAgICAgICAgICAgcmV0dXJuIHRva2VuLmJhbGFuY2VPZih0aGlzKTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXREZWNpbWFscyhFUkMyMCB0b2tlbikgcHVibGljIHZpZXcgcmV0dXJucyh1aW50KSB7CiAgICAgICAgaWYgKHRva2VuID09IEVUSF9UT0tFTl9BRERSRVNTKSByZXR1cm4gMTg7CiAgICAgICAgcmV0dXJuIHRva2VuLmRlY2ltYWxzKCk7CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0RGVzdFF0eShFUkMyMCBzcmMsIEVSQzIwIGRlc3QsIHVpbnQgc3JjUXR5LCB1aW50IHJhdGUpIHB1YmxpYyB2aWV3IHJldHVybnModWludCkgewogICAgICAgIHVpbnQgZHN0RGVjaW1hbHMgPSBnZXREZWNpbWFscyhkZXN0KTsKICAgICAgICB1aW50IHNyY0RlY2ltYWxzID0gZ2V0RGVjaW1hbHMoc3JjKTsKCiAgICAgICAgcmV0dXJuIGNhbGNEc3RRdHkoc3JjUXR5LCBzcmNEZWNpbWFscywgZHN0RGVjaW1hbHMsIHJhdGUpOwogICAgfQoKICAgIGZ1bmN0aW9uIGdldFNyY1F0eShFUkMyMCBzcmMsIEVSQzIwIGRlc3QsIHVpbnQgZHN0UXR5LCB1aW50IHJhdGUpIHB1YmxpYyB2aWV3IHJldHVybnModWludCkgewogICAgICAgIHVpbnQgZHN0RGVjaW1hbHMgPSBnZXREZWNpbWFscyhkZXN0KTsKICAgICAgICB1aW50IHNyY0RlY2ltYWxzID0gZ2V0RGVjaW1hbHMoc3JjKTsKCiAgICAgICAgcmV0dXJuIGNhbGNTcmNRdHkoZHN0UXR5LCBzcmNEZWNpbWFscywgZHN0RGVjaW1hbHMsIHJhdGUpOwogICAgfQoKICAgIGZ1bmN0aW9uIGdldENvbnZlcnNpb25SYXRlKEVSQzIwIHNyYywgRVJDMjAgZGVzdCwgdWludCBzcmNRdHksIHVpbnQgYmxvY2tOdW1iZXIpIHB1YmxpYyB2aWV3IHJldHVybnModWludCkgewogICAgICAgIEVSQzIwIHRva2VuOwogICAgICAgIGJvb2wgIGJ1eTsKCiAgICAgICAgaWYgKCF0cmFkZUVuYWJsZWQpIHJldHVybiAwOwoKICAgICAgICBpZiAoRVRIX1RPS0VOX0FERFJFU1MgPT0gc3JjKSB7CiAgICAgICAgICAgIGJ1eSA9IHRydWU7CiAgICAgICAgICAgIHRva2VuID0gZGVzdDsKICAgICAgICB9IGVsc2UgaWYgKEVUSF9UT0tFTl9BRERSRVNTID09IGRlc3QpIHsKICAgICAgICAgICAgYnV5ID0gZmFsc2U7CiAgICAgICAgICAgIHRva2VuID0gc3JjOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiAwOyAvLyBwYWlyIGlzIG5vdCBsaXN0ZWQKICAgICAgICB9CgogICAgICAgIHVpbnQgcmF0ZSA9IGNvbnZlcnNpb25SYXRlc0NvbnRyYWN0LmdldFJhdGUodG9rZW4sIGJsb2NrTnVtYmVyLCBidXksIHNyY1F0eSk7CiAgICAgICAgdWludCBkZXN0UXR5ID0gZ2V0RGVzdFF0eShzcmMsIGRlc3QsIHNyY1F0eSwgcmF0ZSk7CgogICAgICAgIGlmIChnZXRCYWxhbmNlKGRlc3QpIDwgZGVzdFF0eSkgcmV0dXJuIDA7CgogICAgICAgIGlmIChzYW5pdHlSYXRlc0NvbnRyYWN0ICE9IGFkZHJlc3MoMCkpIHsKICAgICAgICAgICAgdWludCBzYW5pdHlSYXRlID0gc2FuaXR5UmF0ZXNDb250cmFjdC5nZXRTYW5pdHlSYXRlKHNyYywgZGVzdCk7CiAgICAgICAgICAgIGlmIChyYXRlID4gc2FuaXR5UmF0ZSkgcmV0dXJuIDA7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcmF0ZTsKICAgIH0KCiAgICAvLy8gQGRldiBkbyBhIHRyYWRlCiAgICAvLy8gQHBhcmFtIHNyY1Rva2VuIFNyYyB0b2tlbgogICAgLy8vIEBwYXJhbSBzcmNBbW91bnQgQW1vdW50IG9mIHNyYyB0b2tlbgogICAgLy8vIEBwYXJhbSBkZXN0VG9rZW4gRGVzdGluYXRpb24gdG9rZW4KICAgIC8vLyBAcGFyYW0gZGVzdEFkZHJlc3MgRGVzdGluYXRpb24gYWRkcmVzcyB0byBzZW5kIHRva2VucyB0bwogICAgLy8vIEBwYXJhbSB2YWxpZGF0ZSBJZiB0cnVlLCBhZGRpdGlvbmFsIHZhbGlkYXRpb25zIGFyZSBhcHBsaWNhYmxlCiAgICAvLy8gQHJldHVybiB0cnVlIGlmZiB0cmFkZSBpcyBzdWNjZXNzZnVsCiAgICBmdW5jdGlvbiBkb1RyYWRlKAogICAgICAgIEVSQzIwIHNyY1Rva2VuLAogICAgICAgIHVpbnQgc3JjQW1vdW50LAogICAgICAgIEVSQzIwIGRlc3RUb2tlbiwKICAgICAgICBhZGRyZXNzIGRlc3RBZGRyZXNzLAogICAgICAgIHVpbnQgY29udmVyc2lvblJhdGUsCiAgICAgICAgYm9vbCB2YWxpZGF0ZQogICAgKQogICAgICAgIGludGVybmFsCiAgICAgICAgcmV0dXJucyhib29sKQogICAgewogICAgICAgIC8vIGNhbiBza2lwIHZhbGlkYXRpb24gaWYgZG9uZSBhdCBreWJlciBuZXR3b3JrIGxldmVsCiAgICAgICAgaWYgKHZhbGlkYXRlKSB7CiAgICAgICAgICAgIHJlcXVpcmUoY29udmVyc2lvblJhdGUgPiAwKTsKICAgICAgICAgICAgaWYgKHNyY1Rva2VuID09IEVUSF9UT0tFTl9BRERSRVNTKQogICAgICAgICAgICAgICAgcmVxdWlyZShtc2cudmFsdWUgPT0gc3JjQW1vdW50KTsKICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgcmVxdWlyZShtc2cudmFsdWUgPT0gMCk7CiAgICAgICAgfQoKICAgICAgICB1aW50IGRlc3RBbW91bnQgPSBnZXREZXN0UXR5KHNyY1Rva2VuLCBkZXN0VG9rZW4sIHNyY0Ftb3VudCwgY29udmVyc2lvblJhdGUpOwogICAgICAgIC8vIHNhbml0eSBjaGVjawogICAgICAgIHJlcXVpcmUoZGVzdEFtb3VudCA+IDApOwoKICAgICAgICAvLyBhZGQgdG8gaW1iYWxhbmNlCiAgICAgICAgRVJDMjAgdG9rZW47CiAgICAgICAgaW50IGJ1eTsKICAgICAgICBpZiAoc3JjVG9rZW4gPT0gRVRIX1RPS0VOX0FERFJFU1MpIHsKICAgICAgICAgICAgYnV5ID0gaW50KGRlc3RBbW91bnQpOwogICAgICAgICAgICB0b2tlbiA9IGRlc3RUb2tlbjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBidXkgPSAtMSAqIGludChzcmNBbW91bnQpOwogICAgICAgICAgICB0b2tlbiA9IHNyY1Rva2VuOwogICAgICAgIH0KCiAgICAgICAgY29udmVyc2lvblJhdGVzQ29udHJhY3QucmVjb3JkSW1iYWxhbmNlKAogICAgICAgICAgICB0b2tlbiwKICAgICAgICAgICAgYnV5LAogICAgICAgICAgICAwLAogICAgICAgICAgICBibG9jay5udW1iZXIKICAgICAgICApOwoKICAgICAgICAvLyBjb2xsZWN0IHNyYyB0b2tlbnMKICAgICAgICBpZiAoc3JjVG9rZW4gIT0gRVRIX1RPS0VOX0FERFJFU1MpIHsKICAgICAgICAgICAgcmVxdWlyZShzcmNUb2tlbi50cmFuc2ZlckZyb20obXNnLnNlbmRlciwgdGhpcywgc3JjQW1vdW50KSk7CiAgICAgICAgfQoKICAgICAgICAvLyBzZW5kIGRlc3QgdG9rZW5zCiAgICAgICAgaWYgKGRlc3RUb2tlbiA9PSBFVEhfVE9LRU5fQUREUkVTUykgewogICAgICAgICAgICBkZXN0QWRkcmVzcy50cmFuc2ZlcihkZXN0QW1vdW50KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXF1aXJlKGRlc3RUb2tlbi50cmFuc2ZlcihkZXN0QWRkcmVzcywgZGVzdEFtb3VudCkpOwogICAgICAgIH0KCiAgICAgICAgVHJhZGVFeGVjdXRlKG1zZy5zZW5kZXIsIHNyY1Rva2VuLCBzcmNBbW91bnQsIGRlc3RUb2tlbiwgZGVzdEFtb3VudCwgZGVzdEFkZHJlc3MpOwoKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KfQoKY29udHJhY3QgV2hpdGVMaXN0IGlzIFdpdGhkcmF3YWJsZSB7CgogICAgdWludCBwdWJsaWMgd2VpUGVyU2dkOyAvLyBhbW91bnQgb2Ygd2VpcyBpbiAxIHNpbmdhcG9yZSBkb2xsYXIKICAgIG1hcHBpbmcgKGFkZHJlc3M9PnVpbnQpIHB1YmxpYyB1c2VyQ2F0ZWdvcnk7IC8vIGVhY2ggdXNlciBoYXMgYSBjYXRlZ29yeSBkZWZpbmluZyBjYXAgb24gdHJhZGUuIDAgZm9yIHN0YW5kYXJkLgogICAgbWFwcGluZyAodWludD0+dWludCkgICAgcHVibGljIGNhdGVnb3J5Q2FwOyAgLy8gd2lsbCBkZWZpbmUgY2FwIG9uIHRyYWRlIGFtb3VudCBwZXIgY2F0ZWdvcnkgaW4gc2luZ2Fwb3JlIERvbGxhci4KCiAgICBmdW5jdGlvbiBXaGl0ZUxpc3QoYWRkcmVzcyBfYWRtaW4pIHB1YmxpYyB7CiAgICAgICAgcmVxdWlyZShfYWRtaW4gIT0gYWRkcmVzcygwKSk7CiAgICAgICAgYWRtaW4gPSBfYWRtaW47CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0VXNlckNhcEluV2VpKGFkZHJlc3MgdXNlcikgZXh0ZXJuYWwgdmlldyByZXR1cm5zICh1aW50IHVzZXJDYXBXZWkpIHsKICAgICAgICB1aW50IGNhdGVnb3J5ID0gdXNlckNhdGVnb3J5W3VzZXJdOwogICAgICAgIHJldHVybiAoY2F0ZWdvcnlDYXBbY2F0ZWdvcnldICogd2VpUGVyU2dkKTsKICAgIH0KCiAgICBldmVudCBVc2VyQ2F0ZWdvcnlTZXQoYWRkcmVzcyB1c2VyLCB1aW50IGNhdGVnb3J5KTsKCiAgICBmdW5jdGlvbiBzZXRVc2VyQ2F0ZWdvcnkoYWRkcmVzcyB1c2VyLCB1aW50IGNhdGVnb3J5KSBwdWJsaWMgb25seU9wZXJhdG9yIHsKICAgICAgICB1c2VyQ2F0ZWdvcnlbdXNlcl0gPSBjYXRlZ29yeTsKICAgICAgICBVc2VyQ2F0ZWdvcnlTZXQodXNlciwgY2F0ZWdvcnkpOwogICAgfQoKICAgIGV2ZW50IENhdGVnb3J5Q2FwU2V0ICh1aW50IGNhdGVnb3J5LCB1aW50IHNnZENhcCk7CgogICAgZnVuY3Rpb24gc2V0Q2F0ZWdvcnlDYXAodWludCBjYXRlZ29yeSwgdWludCBzZ2RDYXApIHB1YmxpYyBvbmx5T3BlcmF0b3IgewogICAgICAgIGNhdGVnb3J5Q2FwW2NhdGVnb3J5XSA9IHNnZENhcDsKICAgICAgICBDYXRlZ29yeUNhcFNldChjYXRlZ29yeSwgc2dkQ2FwKTsKICAgIH0KCiAgICBldmVudCBTZ2RUb1dlaVJhdGVTZXQgKHVpbnQgcmF0ZSk7CgogICAgZnVuY3Rpb24gc2V0U2dkVG9FdGhSYXRlKHVpbnQgX3NnZFRvV2VpUmF0ZSkgcHVibGljIG9ubHlPcGVyYXRvciB7CiAgICAgICAgd2VpUGVyU2dkID0gX3NnZFRvV2VpUmF0ZTsKICAgICAgICBTZ2RUb1dlaVJhdGVTZXQoX3NnZFRvV2VpUmF0ZSk7CiAgICB9Cn0KCmNvbnRyYWN0IEZlZUJ1cm5lciBpcyBXaXRoZHJhd2FibGUsIEZlZUJ1cm5lckludGVyZmFjZSB7CgogICAgbWFwcGluZyhhZGRyZXNzPT51aW50KSBwdWJsaWMgcmVzZXJ2ZUZlZXNJbkJwczsKICAgIG1hcHBpbmcoYWRkcmVzcz0+YWRkcmVzcykgcHVibGljIHJlc2VydmVLTkNXYWxsZXQ7CiAgICBtYXBwaW5nKGFkZHJlc3M9PnVpbnQpIHB1YmxpYyB3YWxsZXRGZWVzSW5CcHM7CiAgICBtYXBwaW5nKGFkZHJlc3M9PnVpbnQpIHB1YmxpYyByZXNlcnZlRmVlVG9CdXJuOwogICAgbWFwcGluZyhhZGRyZXNzPT5tYXBwaW5nKGFkZHJlc3M9PnVpbnQpKSBwdWJsaWMgcmVzZXJ2ZUZlZVRvV2FsbGV0OwoKICAgIEJ1cm5hYmxlVG9rZW4gcHVibGljIGtuYzsKICAgIGFkZHJlc3MgcHVibGljIGt5YmVyTmV0d29yazsKICAgIHVpbnQgcHVibGljIGtuY1BlckVUSFJhdGUgPSAzMDA7CgogICAgZnVuY3Rpb24gRmVlQnVybmVyKGFkZHJlc3MgX2FkbWluLCBCdXJuYWJsZVRva2VuIGtuY1Rva2VuKSBwdWJsaWMgewogICAgICAgIHJlcXVpcmUoX2FkbWluICE9IGFkZHJlc3MoMCkpOwogICAgICAgIHJlcXVpcmUoa25jVG9rZW4gIT0gYWRkcmVzcygwKSk7CiAgICAgICAgYWRtaW4gPSBfYWRtaW47CiAgICAgICAga25jID0ga25jVG9rZW47CiAgICB9CgogICAgZnVuY3Rpb24gc2V0UmVzZXJ2ZURhdGEoYWRkcmVzcyByZXNlcnZlLCB1aW50IGZlZXNJbkJwcywgYWRkcmVzcyBrbmNXYWxsZXQpIHB1YmxpYyBvbmx5QWRtaW4gewogICAgICAgIHJlcXVpcmUoZmVlc0luQnBzIDwgMTAwKTsgLy8gbWFrZSBzdXJlIGl0IGlzIGFsd2F5cyA8IDElCiAgICAgICAgcmVxdWlyZShrbmNXYWxsZXQgIT0gYWRkcmVzcygwKSk7CiAgICAgICAgcmVzZXJ2ZUZlZXNJbkJwc1tyZXNlcnZlXSA9IGZlZXNJbkJwczsKICAgICAgICByZXNlcnZlS05DV2FsbGV0W3Jlc2VydmVdID0ga25jV2FsbGV0OwogICAgfQoKICAgIGZ1bmN0aW9uIHNldFdhbGxldEZlZXMoYWRkcmVzcyB3YWxsZXQsIHVpbnQgZmVlc0luQnBzKSBwdWJsaWMgb25seUFkbWluIHsKICAgICAgICByZXF1aXJlKGZlZXNJbkJwcyA8IDEwMDAwKTsgLy8gdW5kZXIgMTAwJQogICAgICAgIHdhbGxldEZlZXNJbkJwc1t3YWxsZXRdID0gZmVlc0luQnBzOwogICAgfQoKICAgIGZ1bmN0aW9uIHNldEt5YmVyTmV0d29yayhhZGRyZXNzIF9reWJlck5ldHdvcmspIHB1YmxpYyBvbmx5QWRtaW4gewogICAgICAgIHJlcXVpcmUoX2t5YmVyTmV0d29yayAhPSBhZGRyZXNzKDApKTsKICAgICAgICBreWJlck5ldHdvcmsgPSBfa3liZXJOZXR3b3JrOwogICAgfQoKICAgIGZ1bmN0aW9uIHNldEtOQ1JhdGUodWludCByYXRlKSBwdWJsaWMgb25seUFkbWluIHsKICAgICAgICBrbmNQZXJFVEhSYXRlID0gcmF0ZTsKICAgIH0KCiAgICBldmVudCBBc3NpZ25GZWVUb1dhbGxldChhZGRyZXNzIHJlc2VydmUsIGFkZHJlc3Mgd2FsbGV0LCB1aW50IHdhbGxldEZlZSk7CiAgICBldmVudCBBc3NpZ25CdXJuRmVlcyhhZGRyZXNzIHJlc2VydmUsIHVpbnQgYnVybkZlZSk7CgogICAgZnVuY3Rpb24gaGFuZGxlRmVlcyh1aW50IHRyYWRlV2VpQW1vdW50LCBhZGRyZXNzIHJlc2VydmUsIGFkZHJlc3Mgd2FsbGV0KSBwdWJsaWMgcmV0dXJucyhib29sKSB7CiAgICAgICAgcmVxdWlyZShtc2cuc2VuZGVyID09IGt5YmVyTmV0d29yayk7CgogICAgICAgIHVpbnQga25jQW1vdW50ID0gdHJhZGVXZWlBbW91bnQgKiBrbmNQZXJFVEhSYXRlOwogICAgICAgIHVpbnQgZmVlID0ga25jQW1vdW50ICogcmVzZXJ2ZUZlZXNJbkJwc1tyZXNlcnZlXSAvIDEwMDAwOwoKICAgICAgICB1aW50IHdhbGxldEZlZSA9IGZlZSAqIHdhbGxldEZlZXNJbkJwc1t3YWxsZXRdIC8gMTAwMDA7CiAgICAgICAgcmVxdWlyZShmZWUgPj0gd2FsbGV0RmVlKTsKICAgICAgICB1aW50IGZlZVRvQnVybiA9IGZlZSAtIHdhbGxldEZlZTsKCiAgICAgICAgaWYgKHdhbGxldEZlZSA+IDApIHsKICAgICAgICAgICAgcmVzZXJ2ZUZlZVRvV2FsbGV0W3Jlc2VydmVdW3dhbGxldF0gKz0gd2FsbGV0RmVlOwogICAgICAgICAgICBBc3NpZ25GZWVUb1dhbGxldChyZXNlcnZlLCB3YWxsZXQsIHdhbGxldEZlZSk7CiAgICAgICAgfQoKICAgICAgICBpZiAoZmVlVG9CdXJuID4gMCkgewogICAgICAgICAgICBBc3NpZ25CdXJuRmVlcyhyZXNlcnZlLCBmZWVUb0J1cm4pOwogICAgICAgICAgICByZXNlcnZlRmVlVG9CdXJuW3Jlc2VydmVdICs9IGZlZVRvQnVybjsKICAgICAgICB9CgogICAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIC8vIHRoaXMgZnVuY3Rpb24gaXMgY2FsbGFibGUgYnkgYW55b25lCiAgICBldmVudCBCdXJuQXNzaWduZWRGZWVzKGFkZHJlc3MgaW5kZXhlZCByZXNlcnZlLCBhZGRyZXNzIHNlbmRlcik7CgogICAgZnVuY3Rpb24gYnVyblJlc2VydmVGZWVzKGFkZHJlc3MgcmVzZXJ2ZSkgcHVibGljIHsKICAgICAgICB1aW50IGJ1cm5BbW91bnQgPSByZXNlcnZlRmVlVG9CdXJuW3Jlc2VydmVdOwogICAgICAgIHJlcXVpcmUoYnVybkFtb3VudCA+IDEpOwogICAgICAgIHJlc2VydmVGZWVUb0J1cm5bcmVzZXJ2ZV0gPSAxOyAvLyBsZWF2ZSAxIHR3ZWkgdG8gYXZvaWQgc3Bpa2VzIGluIGdhcyBmZWUKICAgICAgICByZXF1aXJlKGtuYy5idXJuRnJvbShyZXNlcnZlS05DV2FsbGV0W3Jlc2VydmVdLCBidXJuQW1vdW50IC0gMSkpOwoKICAgICAgICBCdXJuQXNzaWduZWRGZWVzKHJlc2VydmUsIG1zZy5zZW5kZXIpOwogICAgfQoKICAgIGV2ZW50IFNlbmRXYWxsZXRGZWVzKGFkZHJlc3MgaW5kZXhlZCB3YWxsZXQsIGFkZHJlc3MgcmVzZXJ2ZSwgYWRkcmVzcyBzZW5kZXIpOwoKICAgIC8vIHRoaXMgZnVuY3Rpb24gaXMgY2FsbGFibGUgYnkgYW55b25lCiAgICBmdW5jdGlvbiBzZW5kRmVlVG9XYWxsZXQoYWRkcmVzcyB3YWxsZXQsIGFkZHJlc3MgcmVzZXJ2ZSkgcHVibGljIHsKICAgICAgICB1aW50IGZlZUFtb3VudCA9IHJlc2VydmVGZWVUb1dhbGxldFtyZXNlcnZlXVt3YWxsZXRdOwogICAgICAgIHJlcXVpcmUoZmVlQW1vdW50ID4gMSk7CiAgICAgICAgcmVzZXJ2ZUZlZVRvV2FsbGV0W3Jlc2VydmVdW3dhbGxldF0gPSAxOyAvLyBsZWF2ZSAxIHR3ZWkgdG8gYXZvaWQgc3Bpa2VzIGluIGdhcyBmZWUKICAgICAgICByZXF1aXJlKGtuYy50cmFuc2ZlckZyb20ocmVzZXJ2ZUtOQ1dhbGxldFtyZXNlcnZlXSwgd2FsbGV0LCBmZWVBbW91bnQgLSAxKSk7CgogICAgICAgIFNlbmRXYWxsZXRGZWVzKHdhbGxldCwgcmVzZXJ2ZSwgbXNnLnNlbmRlcik7CiAgICB9Cn0KCmNvbnRyYWN0IFNhbml0eVJhdGVzIGlzIFNhbml0eVJhdGVzSW50ZXJmYWNlLCBXaXRoZHJhd2FibGUsIFV0aWxzIHsKICAgIG1hcHBpbmcoYWRkcmVzcz0+dWludCkgcHVibGljIHRva2VuUmF0ZTsKICAgIG1hcHBpbmcoYWRkcmVzcz0+dWludCkgcHVibGljIHJlYXNvbmFibGVEaWZmSW5CcHM7CgogICAgZnVuY3Rpb24gU2FuaXR5UmF0ZXMoYWRkcmVzcyBfYWRtaW4pIHB1YmxpYyB7CiAgICAgICAgcmVxdWlyZShfYWRtaW4gIT0gYWRkcmVzcygwKSk7CiAgICAgICAgYWRtaW4gPSBfYWRtaW47CiAgICB9CgogICAgZnVuY3Rpb24gc2V0UmVhc29uYWJsZURpZmYoRVJDMjBbXSBzcmNzLCB1aW50W10gZGlmZikgcHVibGljIG9ubHlBZG1pbiB7CiAgICAgICAgcmVxdWlyZShzcmNzLmxlbmd0aCA9PSBkaWZmLmxlbmd0aCk7CiAgICAgICAgZm9yICh1aW50IGkgPSAwOyBpIDwgc3Jjcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICByZWFzb25hYmxlRGlmZkluQnBzW3NyY3NbaV1dID0gZGlmZltpXTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gc2V0U2FuaXR5UmF0ZXMoRVJDMjBbXSBzcmNzLCB1aW50W10gcmF0ZXMpIHB1YmxpYyBvbmx5T3BlcmF0b3IgewogICAgICAgIHJlcXVpcmUoc3Jjcy5sZW5ndGggPT0gcmF0ZXMubGVuZ3RoKTsKCiAgICAgICAgZm9yICh1aW50IGkgPSAwOyBpIDwgc3Jjcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB0b2tlblJhdGVbc3Jjc1tpXV0gPSByYXRlc1tpXTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0U2FuaXR5UmF0ZShFUkMyMCBzcmMsIEVSQzIwIGRlc3QpIHB1YmxpYyB2aWV3IHJldHVybnModWludCkgewogICAgICAgIGlmIChzcmMgIT0gRVRIX1RPS0VOX0FERFJFU1MgJiYgZGVzdCAhPSBFVEhfVE9LRU5fQUREUkVTUykgcmV0dXJuIDA7CgogICAgICAgIHVpbnQgcmF0ZTsKICAgICAgICBhZGRyZXNzIHRva2VuOwogICAgICAgIGlmIChzcmMgPT0gRVRIX1RPS0VOX0FERFJFU1MpIHsKICAgICAgICAgICAgcmF0ZSA9IChQUkVDSVNJT04qUFJFQ0lTSU9OKS90b2tlblJhdGVbZGVzdF07CiAgICAgICAgICAgIHRva2VuID0gZGVzdDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByYXRlID0gdG9rZW5SYXRlW3NyY107CiAgICAgICAgICAgIHRva2VuID0gc3JjOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHJhdGUgKiAoMTAwMDAgKyByZWFzb25hYmxlRGlmZkluQnBzW3Rva2VuXSkvMTAwMDA7CiAgICB9Cn0KCgpjb250cmFjdCBXcmFwcGVyIGlzIFV0aWxzIHsKCiAgICBmdW5jdGlvbiBnZXRCYWxhbmNlcyhhZGRyZXNzIHJlc2VydmUsIEVSQzIwW10gdG9rZW5zKSBwdWJsaWMgdmlldyByZXR1cm5zKHVpbnRbXSkgewogICAgICAgIHVpbnRbXSBtZW1vcnkgcmVzdWx0ID0gbmV3IHVpbnRbXSh0b2tlbnMubGVuZ3RoKTsKICAgICAgICBmb3IgKHVpbnQgaSA9IDA7IGkgPCB0b2tlbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdWludCBiYWxhbmNlID0gMDsKICAgICAgICAgICAgaWYgKHRva2Vuc1tpXSA9PSBFVEhfVE9LRU5fQUREUkVTUykgewogICAgICAgICAgICAgICAgYmFsYW5jZSA9IHJlc2VydmUuYmFsYW5jZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGJhbGFuY2UgPSB0b2tlbnNbaV0uYmFsYW5jZU9mKHJlc2VydmUpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXN1bHRbaV0gPSBiYWxhbmNlOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRCeXRlRnJvbUJ5dGVzMTQoYnl0ZXMxNCB4LCB1aW50IGJ5dGVJbmQpIHB1YmxpYyBwdXJlIHJldHVybnMoYnl0ZSkgewogICAgICAgIHJlcXVpcmUoYnl0ZUluZCA8PSAxMyk7CiAgICAgICAgcmV0dXJuIHhbYnl0ZUluZF07CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0SW50OEZyb21CeXRlKGJ5dGVzMTQgeCwgdWludCBieXRlSW5kKSBwdWJsaWMgcHVyZSByZXR1cm5zKGludDgpIHsKICAgICAgICByZXF1aXJlKGJ5dGVJbmQgPD0gMTMpOwogICAgICAgIHJldHVybiBpbnQ4KHhbYnl0ZUluZF0pOwogICAgfQoKLy8gICAgc3RydWN0IFRva2VuUmF0ZXNDb21wYWN0RGF0YSB7Ci8vICAgICAgICBieXRlczE0IGJ1eTsgIC8vIGNoYW5nZSBidXkgcmF0ZSBvZiB0b2tlbiBmcm9tIGJhc2VCdXlSYXRlIGluIDEwIGJwcwovLyAgICAgICAgYnl0ZXMxNCBzZWxsOyAvLyBjaGFuZ2Ugc2VsbCByYXRlIG9mIHRva2VuIGZyb20gYmFzZVNlbGxSYXRlIGluIDEwIGJwcwovLwovLyAgICAgICAgdWludDMyIGJsb2NrTnVtYmVyOwovLyAgICB9Ci8vCi8vICAgIGZ1bmN0aW9uIGdldERhdGFGcm9tQ29tcGFjdChUb2tlblJhdGVzQ29tcGFjdERhdGEgY29tcGFjdCwgdWludCBieXRlSW5kKSBwdWJsaWMgcHVyZQovLyAgICAgICAgcmV0dXJucyhpbnQ4IGJ1eUJ5dGUsIGludDggc2VsbEJ5dGUsIHVpbnQgYmxvY2tOdW1iZXIpCi8vICAgIHsKLy8gICAgICAgIGJsb2NrTnVtYmVyID0gdWludChjb21wYWN0LmJsb2NrTnVtYmVyKTsKLy8vLyAgICAgICAgcmV0dXJuIChjb21wYWN0LmJ1eVtieXRlSW5kXSwgY29tcGFjdC5zZWxsW2J5dGVJbmRdLCB1aW50KGNvbXBhY3QuYmxvY2tOdW1iZXIpKTsKLy8gICAgfQoKICAgIGZ1bmN0aW9uIGdldENvbXBhY3REYXRhKENvbnZlcnNpb25SYXRlcyByYXRlc0NvbnRyYWN0LCBFUkMyMCB0b2tlbikgaW50ZXJuYWwgdmlldyByZXR1cm5zKGludDgsaW50OCx1aW50KSB7CiAgICAgICAgdWludCBidWxrSW5kZXg7IHVpbnQgaW5kZXg7IGJ5dGUgYnV5OyBieXRlIHNlbGw7IHVpbnQgdXBkYXRlQmxvY2s7CiAgICAgICAgKGJ1bGtJbmRleCwgaW5kZXgsIGJ1eSwgc2VsbCkgPSByYXRlc0NvbnRyYWN0LmdldENvbXBhY3REYXRhKHRva2VuKTsKICAgICAgICB1cGRhdGVCbG9jayA9IHJhdGVzQ29udHJhY3QuZ2V0UmF0ZVVwZGF0ZUJsb2NrKHRva2VuKTsKCiAgICAgICAgcmV0dXJuIChpbnQ4KGJ1eSksIGludDgoc2VsbCksIHVwZGF0ZUJsb2NrKTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRUb2tlblJhdGVzKENvbnZlcnNpb25SYXRlcyByYXRlc0NvbnRyYWN0LCBFUkMyMFtdIHRva2VuTGlzdCkKICAgICAgICBwdWJsaWMgdmlldwogICAgICAgIHJldHVybnModWludFtdLCB1aW50W10sIGludDhbXSwgaW50OFtdLCB1aW50W10pCiAgICB7CiAgICAgICAgdWludFtdIG1lbW9yeSBidXlCYXNlcyA9IG5ldyB1aW50W10odG9rZW5MaXN0Lmxlbmd0aCk7CiAgICAgICAgdWludFtdIG1lbW9yeSBzZWxsQmFzZXMgPSBuZXcgdWludFtdKHRva2VuTGlzdC5sZW5ndGgpOwogICAgICAgIGludDhbXSBtZW1vcnkgY29tcGFjdEJ1eSA9IG5ldyBpbnQ4W10odG9rZW5MaXN0Lmxlbmd0aCk7CiAgICAgICAgaW50OFtdIG1lbW9yeSBjb21wYWN0U2VsbCA9IG5ldyBpbnQ4W10odG9rZW5MaXN0Lmxlbmd0aCk7CiAgICAgICAgdWludFtdIG1lbW9yeSB1cGRhdGVCbG9jayA9IG5ldyB1aW50W10odG9rZW5MaXN0Lmxlbmd0aCk7CgogICAgICAgIGZvciAodWludCBpID0gMDsgIGkgPCB0b2tlbkxpc3QubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgYnV5QmFzZXNbaV0gPSByYXRlc0NvbnRyYWN0LmdldEJhc2ljUmF0ZSh0b2tlbkxpc3RbaV0sIHRydWUpOwogICAgICAgICAgICBzZWxsQmFzZXNbaV0gPSByYXRlc0NvbnRyYWN0LmdldEJhc2ljUmF0ZSh0b2tlbkxpc3RbaV0sIGZhbHNlKTsKCiAgICAgICAgICAgIChjb21wYWN0QnV5W2ldLCBjb21wYWN0U2VsbFtpXSwgdXBkYXRlQmxvY2tbaV0pID0gZ2V0Q29tcGFjdERhdGEocmF0ZXNDb250cmFjdCwgdG9rZW5MaXN0W2ldKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiAoYnV5QmFzZXMsIHNlbGxCYXNlcywgY29tcGFjdEJ1eSwgY29tcGFjdFNlbGwsIHVwZGF0ZUJsb2NrKTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRUb2tlbkluZGljaWVzKENvbnZlcnNpb25SYXRlcyByYXRlc0NvbnRyYWN0LCBFUkMyMFtdIHRva2VuTGlzdCkgcHVibGljIHZpZXcgcmV0dXJucyh1aW50W10sIHVpbnRbXSkgewogICAgICAgIHVpbnRbXSBtZW1vcnkgYnVsa0luZGljZXMgPSBuZXcgdWludFtdKHRva2VuTGlzdC5sZW5ndGgpOwogICAgICAgIHVpbnRbXSBtZW1vcnkgdG9rZW5JbmRleEluQnVsayA9IG5ldyB1aW50W10odG9rZW5MaXN0Lmxlbmd0aCk7CgogICAgICAgIGZvciAodWludCBpID0gMDsgaSA8IHRva2VuTGlzdC5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB1aW50IGJ1bGtJbmRleDsgdWludCBpbmRleDsgYnl0ZSBidXk7IGJ5dGUgc2VsbDsKICAgICAgICAgICAgKGJ1bGtJbmRleCwgaW5kZXgsIGJ1eSwgc2VsbCkgPSByYXRlc0NvbnRyYWN0LmdldENvbXBhY3REYXRhKHRva2VuTGlzdFtpXSk7CgogICAgICAgICAgICBidWxrSW5kaWNlc1tpXSA9IGJ1bGtJbmRleDsKICAgICAgICAgICAgdG9rZW5JbmRleEluQnVsa1tpXSA9IGluZGV4OwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIChidWxrSW5kaWNlcyx0b2tlbkluZGV4SW5CdWxrKTsKICAgIH0KCgogICAgZnVuY3Rpb24gZ2V0RXhwZWN0ZWRSYXRlcyggS3liZXJOZXR3b3JrIG5ldHdvcmssIEVSQzIwW10gc3JjcywgRVJDMjBbXSBkZXN0cywgdWludFtdIHF0eSApCiAgICAgICAgcHVibGljIHZpZXcgcmV0dXJucyh1aW50W10sIHVpbnRbXSkKICAgIHsKICAgICAgICByZXF1aXJlKCBzcmNzLmxlbmd0aCA9PSBkZXN0cy5sZW5ndGggKTsKICAgICAgICByZXF1aXJlKCBzcmNzLmxlbmd0aCA9PSBxdHkubGVuZ3RoICk7CgogICAgICAgIHVpbnRbXSBtZW1vcnkgcmF0ZXMgPSBuZXcgdWludFtdKHNyY3MubGVuZ3RoKTsKICAgICAgICB1aW50W10gbWVtb3J5IHNsaXBwYWdlID0gbmV3IHVpbnRbXShzcmNzLmxlbmd0aCk7CiAgICAgICAgZm9yICggdWludCBpID0gMDsgaSA8IHNyY3MubGVuZ3RoOyBpKysgKSB7CiAgICAgICAgICAgIChyYXRlc1tpXSxzbGlwcGFnZVtpXSkgPSBuZXR3b3JrLmdldEV4cGVjdGVkUmF0ZShzcmNzW2ldLGRlc3RzW2ldLHF0eVtpXSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gKHJhdGVzLCBzbGlwcGFnZSk7CiAgICB9Cn0='.
	

]
