Class {
	#name : #SRTc5E0671844fBfCB9A91c53ABaee8FE6ED20F3Aab,
	#superclass : #SRTContracts,
	#category : #SolidityTestingResources
}

{ #category : #base64 }
SRTc5E0671844fBfCB9A91c53ABaee8FE6ED20F3Aab >> base64 [
	^ 'cHJhZ21hIHNvbGlkaXR5IF4wLjQuMjsKCi8vIDxPUkFDTElaRV9BUEk+Ci8qCkNvcHlyaWdodCAoYykgMjAxNS0yMDE2IE9yYWNsaXplIFNSTApDb3B5cmlnaHQgKGMpIDIwMTYgT3JhY2xpemUgTFRECgoKClBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHkKb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgIlNvZnR3YXJlIiksIHRvIGRlYWwKaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cwp0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsCmNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcwpmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOgoKCgpUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbgphbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KCgoKVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1IKSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksCkZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuICBJTiBOTyBFVkVOVCBTSEFMTCBUSEUKQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUgpMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLApPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOClRIRSBTT0ZUV0FSRS4KKi8KCmNvbnRyYWN0IE9yYWNsaXplSSB7CiAgICBhZGRyZXNzIHB1YmxpYyBjYkFkZHJlc3M7CiAgICBmdW5jdGlvbiBxdWVyeSh1aW50IF90aW1lc3RhbXAsIHN0cmluZyBfZGF0YXNvdXJjZSwgc3RyaW5nIF9hcmcpIHBheWFibGUgcmV0dXJucyAoYnl0ZXMzMiBfaWQpOwogICAgZnVuY3Rpb24gcXVlcnlfd2l0aEdhc0xpbWl0KHVpbnQgX3RpbWVzdGFtcCwgc3RyaW5nIF9kYXRhc291cmNlLCBzdHJpbmcgX2FyZywgdWludCBfZ2FzbGltaXQpIHBheWFibGUgcmV0dXJucyAoYnl0ZXMzMiBfaWQpOwogICAgZnVuY3Rpb24gcXVlcnkyKHVpbnQgX3RpbWVzdGFtcCwgc3RyaW5nIF9kYXRhc291cmNlLCBzdHJpbmcgX2FyZzEsIHN0cmluZyBfYXJnMikgcGF5YWJsZSByZXR1cm5zIChieXRlczMyIF9pZCk7CiAgICBmdW5jdGlvbiBxdWVyeTJfd2l0aEdhc0xpbWl0KHVpbnQgX3RpbWVzdGFtcCwgc3RyaW5nIF9kYXRhc291cmNlLCBzdHJpbmcgX2FyZzEsIHN0cmluZyBfYXJnMiwgdWludCBfZ2FzbGltaXQpIHBheWFibGUgcmV0dXJucyAoYnl0ZXMzMiBfaWQpOwogICAgZnVuY3Rpb24gcXVlcnlOKHVpbnQgX3RpbWVzdGFtcCwgc3RyaW5nIF9kYXRhc291cmNlLCBieXRlcyBfYXJnTikgcGF5YWJsZSByZXR1cm5zIChieXRlczMyIF9pZCk7CiAgICBmdW5jdGlvbiBxdWVyeU5fd2l0aEdhc0xpbWl0KHVpbnQgX3RpbWVzdGFtcCwgc3RyaW5nIF9kYXRhc291cmNlLCBieXRlcyBfYXJnTiwgdWludCBfZ2FzbGltaXQpIHBheWFibGUgcmV0dXJucyAoYnl0ZXMzMiBfaWQpOwogICAgZnVuY3Rpb24gZ2V0UHJpY2Uoc3RyaW5nIF9kYXRhc291cmNlKSByZXR1cm5zICh1aW50IF9kc3ByaWNlKTsKICAgIGZ1bmN0aW9uIGdldFByaWNlKHN0cmluZyBfZGF0YXNvdXJjZSwgdWludCBnYXNsaW1pdCkgcmV0dXJucyAodWludCBfZHNwcmljZSk7CiAgICBmdW5jdGlvbiB1c2VDb3Vwb24oc3RyaW5nIF9jb3Vwb24pOwogICAgZnVuY3Rpb24gc2V0UHJvb2ZUeXBlKGJ5dGUgX3Byb29mVHlwZSk7CiAgICBmdW5jdGlvbiBzZXRDb25maWcoYnl0ZXMzMiBfY29uZmlnKTsKICAgIGZ1bmN0aW9uIHNldEN1c3RvbUdhc1ByaWNlKHVpbnQgX2dhc1ByaWNlKTsKfQpjb250cmFjdCBPcmFjbGl6ZUFkZHJSZXNvbHZlckkgewogICAgZnVuY3Rpb24gZ2V0QWRkcmVzcygpIHJldHVybnMgKGFkZHJlc3MgX2FkZHIpOwp9CmNvbnRyYWN0IHVzaW5nT3JhY2xpemUgewogICAgdWludCBjb25zdGFudCBkYXkgPSA2MCo2MCoyNDsKICAgIHVpbnQgY29uc3RhbnQgd2VlayA9IDYwKjYwKjI0Kjc7CiAgICB1aW50IGNvbnN0YW50IG1vbnRoID0gNjAqNjAqMjQqMzA7CiAgICBieXRlIGNvbnN0YW50IHByb29mVHlwZV9OT05FID0gMHgwMDsKICAgIGJ5dGUgY29uc3RhbnQgcHJvb2ZUeXBlX1RMU05vdGFyeSA9IDB4MTA7CiAgICBieXRlIGNvbnN0YW50IHByb29mU3RvcmFnZV9JUEZTID0gMHgwMTsKICAgIHVpbnQ4IGNvbnN0YW50IG5ldHdvcmtJRF9hdXRvID0gMDsKICAgIHVpbnQ4IGNvbnN0YW50IG5ldHdvcmtJRF9tYWlubmV0ID0gMTsKICAgIHVpbnQ4IGNvbnN0YW50IG5ldHdvcmtJRF90ZXN0bmV0ID0gMjsKICAgIHVpbnQ4IGNvbnN0YW50IG5ldHdvcmtJRF9tb3JkZW4gPSAyOwogICAgdWludDggY29uc3RhbnQgbmV0d29ya0lEX2NvbnNlbnN5cyA9IDE2MTsKCiAgICBPcmFjbGl6ZUFkZHJSZXNvbHZlckkgT0FSOwoKICAgIE9yYWNsaXplSSBvcmFjbGl6ZTsKICAgIG1vZGlmaWVyIG9yYWNsaXplQVBJIHsKICAgICAgICBpZigoYWRkcmVzcyhPQVIpPT0wKXx8KGdldENvZGVTaXplKGFkZHJlc3MoT0FSKSk9PTApKSBvcmFjbGl6ZV9zZXROZXR3b3JrKG5ldHdvcmtJRF9hdXRvKTsKICAgICAgICBvcmFjbGl6ZSA9IE9yYWNsaXplSShPQVIuZ2V0QWRkcmVzcygpKTsKICAgICAgICBfOwogICAgfQogICAgbW9kaWZpZXIgY291cG9uKHN0cmluZyBjb2RlKXsKICAgICAgICBvcmFjbGl6ZSA9IE9yYWNsaXplSShPQVIuZ2V0QWRkcmVzcygpKTsKICAgICAgICBvcmFjbGl6ZS51c2VDb3Vwb24oY29kZSk7CiAgICAgICAgXzsKICAgIH0KCiAgICBmdW5jdGlvbiBvcmFjbGl6ZV9zZXROZXR3b3JrKHVpbnQ4IG5ldHdvcmtJRCkgaW50ZXJuYWwgcmV0dXJucyhib29sKXsKICAgICAgICBpZiAoZ2V0Q29kZVNpemUoMHgxZDNCMjYzOGE3Y0M5ZjJDQjNEMjk4QTNEQTdhOTBCNjdFNTUwNmVkKT4wKXsgLy9tYWlubmV0CiAgICAgICAgICAgIE9BUiA9IE9yYWNsaXplQWRkclJlc29sdmVySSgweDFkM0IyNjM4YTdjQzlmMkNCM0QyOThBM0RBN2E5MEI2N0U1NTA2ZWQpOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgaWYgKGdldENvZGVTaXplKDB4YzAzQTI2MTVENWVmYWY1RjQ5RjYwQjdCQjY1ODNlYWVjMjEyZmRmMSk+MCl7IC8vcm9wc3RlbiB0ZXN0bmV0CiAgICAgICAgICAgIE9BUiA9IE9yYWNsaXplQWRkclJlc29sdmVySSgweGMwM0EyNjE1RDVlZmFmNUY0OUY2MEI3QkI2NTgzZWFlYzIxMmZkZjEpOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgaWYgKGdldENvZGVTaXplKDB4QjdBMDdCY0YyQmEyZjI3MDNiMjRDMDY5MWI1Mjc4OTk5QzU5QUM3ZSk+MCl7IC8va292YW4gdGVzdG5ldAogICAgICAgICAgICBPQVIgPSBPcmFjbGl6ZUFkZHJSZXNvbHZlckkoMHhCN0EwN0JjRjJCYTJmMjcwM2IyNEMwNjkxYjUyNzg5OTlDNTlBQzdlKTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGlmIChnZXRDb2RlU2l6ZSgweDZmNDg1QzhCRjZmYzQzZUEyMTJFOTNCQkY4Y2UwNDZDN2YxY2I0NzUpPjApeyAvL2V0aGVyZXVtLWJyaWRnZQogICAgICAgICAgICBPQVIgPSBPcmFjbGl6ZUFkZHJSZXNvbHZlckkoMHg2ZjQ4NUM4QkY2ZmM0M2VBMjEyRTkzQkJGOGNlMDQ2QzdmMWNiNDc1KTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGlmIChnZXRDb2RlU2l6ZSgweDIwZTEyQTFGODU5QjNGZWFFNUZiMkEwQTMyQzE4RjVhNjU1NTViQkYpPjApeyAvL2V0aGVyLmNhbXAgaWRlCiAgICAgICAgICAgIE9BUiA9IE9yYWNsaXplQWRkclJlc29sdmVySSgweDIwZTEyQTFGODU5QjNGZWFFNUZiMkEwQTMyQzE4RjVhNjU1NTViQkYpOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgaWYgKGdldENvZGVTaXplKDB4NTFlZmFGNGM4QjNDOUFmQkQ1YUI5RjRiYkM4Mjc4NEFiNmVmOGZBQSk+MCl7IC8vYnJvd3Nlci1zb2xpZGl0eQogICAgICAgICAgICBPQVIgPSBPcmFjbGl6ZUFkZHJSZXNvbHZlckkoMHg1MWVmYUY0YzhCM0M5QWZCRDVhQjlGNGJiQzgyNzg0QWI2ZWY4ZkFBKTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICBmdW5jdGlvbiBfX2NhbGxiYWNrKGJ5dGVzMzIgbXlpZCwgc3RyaW5nIHJlc3VsdCkgewogICAgICAgIF9fY2FsbGJhY2sobXlpZCwgcmVzdWx0LCBuZXcgYnl0ZXMoMCkpOwogICAgfQogICAgZnVuY3Rpb24gX19jYWxsYmFjayhieXRlczMyIG15aWQsIHN0cmluZyByZXN1bHQsIGJ5dGVzIHByb29mKSB7CiAgICB9CgogICAgZnVuY3Rpb24gb3JhY2xpemVfZ2V0UHJpY2Uoc3RyaW5nIGRhdGFzb3VyY2UpIG9yYWNsaXplQVBJIGludGVybmFsIHJldHVybnMgKHVpbnQpewogICAgICAgIHJldHVybiBvcmFjbGl6ZS5nZXRQcmljZShkYXRhc291cmNlKTsKICAgIH0KCiAgICBmdW5jdGlvbiBvcmFjbGl6ZV9nZXRQcmljZShzdHJpbmcgZGF0YXNvdXJjZSwgdWludCBnYXNsaW1pdCkgb3JhY2xpemVBUEkgaW50ZXJuYWwgcmV0dXJucyAodWludCl7CiAgICAgICAgcmV0dXJuIG9yYWNsaXplLmdldFByaWNlKGRhdGFzb3VyY2UsIGdhc2xpbWl0KTsKICAgIH0KICAgIAogICAgZnVuY3Rpb24gb3JhY2xpemVfcXVlcnkoc3RyaW5nIGRhdGFzb3VyY2UsIHN0cmluZyBhcmcpIG9yYWNsaXplQVBJIGludGVybmFsIHJldHVybnMgKGJ5dGVzMzIgaWQpewogICAgICAgIHVpbnQgcHJpY2UgPSBvcmFjbGl6ZS5nZXRQcmljZShkYXRhc291cmNlKTsKICAgICAgICBpZiAocHJpY2UgPiAxIGV0aGVyICsgdHguZ2FzcHJpY2UqMjAwMDAwKSByZXR1cm4gMDsgLy8gdW5leHBlY3RlZGx5IGhpZ2ggcHJpY2UKICAgICAgICByZXR1cm4gb3JhY2xpemUucXVlcnkudmFsdWUocHJpY2UpKDAsIGRhdGFzb3VyY2UsIGFyZyk7CiAgICB9CiAgICBmdW5jdGlvbiBvcmFjbGl6ZV9xdWVyeSh1aW50IHRpbWVzdGFtcCwgc3RyaW5nIGRhdGFzb3VyY2UsIHN0cmluZyBhcmcpIG9yYWNsaXplQVBJIGludGVybmFsIHJldHVybnMgKGJ5dGVzMzIgaWQpewogICAgICAgIHVpbnQgcHJpY2UgPSBvcmFjbGl6ZS5nZXRQcmljZShkYXRhc291cmNlKTsKICAgICAgICBpZiAocHJpY2UgPiAxIGV0aGVyICsgdHguZ2FzcHJpY2UqMjAwMDAwKSByZXR1cm4gMDsgLy8gdW5leHBlY3RlZGx5IGhpZ2ggcHJpY2UKICAgICAgICByZXR1cm4gb3JhY2xpemUucXVlcnkudmFsdWUocHJpY2UpKHRpbWVzdGFtcCwgZGF0YXNvdXJjZSwgYXJnKTsKICAgIH0KICAgIGZ1bmN0aW9uIG9yYWNsaXplX3F1ZXJ5KHVpbnQgdGltZXN0YW1wLCBzdHJpbmcgZGF0YXNvdXJjZSwgc3RyaW5nIGFyZywgdWludCBnYXNsaW1pdCkgb3JhY2xpemVBUEkgaW50ZXJuYWwgcmV0dXJucyAoYnl0ZXMzMiBpZCl7CiAgICAgICAgdWludCBwcmljZSA9IG9yYWNsaXplLmdldFByaWNlKGRhdGFzb3VyY2UsIGdhc2xpbWl0KTsKICAgICAgICBpZiAocHJpY2UgPiAxIGV0aGVyICsgdHguZ2FzcHJpY2UqZ2FzbGltaXQpIHJldHVybiAwOyAvLyB1bmV4cGVjdGVkbHkgaGlnaCBwcmljZQogICAgICAgIHJldHVybiBvcmFjbGl6ZS5xdWVyeV93aXRoR2FzTGltaXQudmFsdWUocHJpY2UpKHRpbWVzdGFtcCwgZGF0YXNvdXJjZSwgYXJnLCBnYXNsaW1pdCk7CiAgICB9CiAgICBmdW5jdGlvbiBvcmFjbGl6ZV9xdWVyeShzdHJpbmcgZGF0YXNvdXJjZSwgc3RyaW5nIGFyZywgdWludCBnYXNsaW1pdCkgb3JhY2xpemVBUEkgaW50ZXJuYWwgcmV0dXJucyAoYnl0ZXMzMiBpZCl7CiAgICAgICAgdWludCBwcmljZSA9IG9yYWNsaXplLmdldFByaWNlKGRhdGFzb3VyY2UsIGdhc2xpbWl0KTsKICAgICAgICBpZiAocHJpY2UgPiAxIGV0aGVyICsgdHguZ2FzcHJpY2UqZ2FzbGltaXQpIHJldHVybiAwOyAvLyB1bmV4cGVjdGVkbHkgaGlnaCBwcmljZQogICAgICAgIHJldHVybiBvcmFjbGl6ZS5xdWVyeV93aXRoR2FzTGltaXQudmFsdWUocHJpY2UpKDAsIGRhdGFzb3VyY2UsIGFyZywgZ2FzbGltaXQpOwogICAgfQogICAgZnVuY3Rpb24gb3JhY2xpemVfcXVlcnkoc3RyaW5nIGRhdGFzb3VyY2UsIHN0cmluZyBhcmcxLCBzdHJpbmcgYXJnMikgb3JhY2xpemVBUEkgaW50ZXJuYWwgcmV0dXJucyAoYnl0ZXMzMiBpZCl7CiAgICAgICAgdWludCBwcmljZSA9IG9yYWNsaXplLmdldFByaWNlKGRhdGFzb3VyY2UpOwogICAgICAgIGlmIChwcmljZSA+IDEgZXRoZXIgKyB0eC5nYXNwcmljZSoyMDAwMDApIHJldHVybiAwOyAvLyB1bmV4cGVjdGVkbHkgaGlnaCBwcmljZQogICAgICAgIHJldHVybiBvcmFjbGl6ZS5xdWVyeTIudmFsdWUocHJpY2UpKDAsIGRhdGFzb3VyY2UsIGFyZzEsIGFyZzIpOwogICAgfQogICAgZnVuY3Rpb24gb3JhY2xpemVfcXVlcnkodWludCB0aW1lc3RhbXAsIHN0cmluZyBkYXRhc291cmNlLCBzdHJpbmcgYXJnMSwgc3RyaW5nIGFyZzIpIG9yYWNsaXplQVBJIGludGVybmFsIHJldHVybnMgKGJ5dGVzMzIgaWQpewogICAgICAgIHVpbnQgcHJpY2UgPSBvcmFjbGl6ZS5nZXRQcmljZShkYXRhc291cmNlKTsKICAgICAgICBpZiAocHJpY2UgPiAxIGV0aGVyICsgdHguZ2FzcHJpY2UqMjAwMDAwKSByZXR1cm4gMDsgLy8gdW5leHBlY3RlZGx5IGhpZ2ggcHJpY2UKICAgICAgICByZXR1cm4gb3JhY2xpemUucXVlcnkyLnZhbHVlKHByaWNlKSh0aW1lc3RhbXAsIGRhdGFzb3VyY2UsIGFyZzEsIGFyZzIpOwogICAgfQogICAgZnVuY3Rpb24gb3JhY2xpemVfcXVlcnkodWludCB0aW1lc3RhbXAsIHN0cmluZyBkYXRhc291cmNlLCBzdHJpbmcgYXJnMSwgc3RyaW5nIGFyZzIsIHVpbnQgZ2FzbGltaXQpIG9yYWNsaXplQVBJIGludGVybmFsIHJldHVybnMgKGJ5dGVzMzIgaWQpewogICAgICAgIHVpbnQgcHJpY2UgPSBvcmFjbGl6ZS5nZXRQcmljZShkYXRhc291cmNlLCBnYXNsaW1pdCk7CiAgICAgICAgaWYgKHByaWNlID4gMSBldGhlciArIHR4Lmdhc3ByaWNlKmdhc2xpbWl0KSByZXR1cm4gMDsgLy8gdW5leHBlY3RlZGx5IGhpZ2ggcHJpY2UKICAgICAgICByZXR1cm4gb3JhY2xpemUucXVlcnkyX3dpdGhHYXNMaW1pdC52YWx1ZShwcmljZSkodGltZXN0YW1wLCBkYXRhc291cmNlLCBhcmcxLCBhcmcyLCBnYXNsaW1pdCk7CiAgICB9CiAgICBmdW5jdGlvbiBvcmFjbGl6ZV9xdWVyeShzdHJpbmcgZGF0YXNvdXJjZSwgc3RyaW5nIGFyZzEsIHN0cmluZyBhcmcyLCB1aW50IGdhc2xpbWl0KSBvcmFjbGl6ZUFQSSBpbnRlcm5hbCByZXR1cm5zIChieXRlczMyIGlkKXsKICAgICAgICB1aW50IHByaWNlID0gb3JhY2xpemUuZ2V0UHJpY2UoZGF0YXNvdXJjZSwgZ2FzbGltaXQpOwogICAgICAgIGlmIChwcmljZSA+IDEgZXRoZXIgKyB0eC5nYXNwcmljZSpnYXNsaW1pdCkgcmV0dXJuIDA7IC8vIHVuZXhwZWN0ZWRseSBoaWdoIHByaWNlCiAgICAgICAgcmV0dXJuIG9yYWNsaXplLnF1ZXJ5Ml93aXRoR2FzTGltaXQudmFsdWUocHJpY2UpKDAsIGRhdGFzb3VyY2UsIGFyZzEsIGFyZzIsIGdhc2xpbWl0KTsKICAgIH0KICAgIGZ1bmN0aW9uIG9yYWNsaXplX3F1ZXJ5KHN0cmluZyBkYXRhc291cmNlLCBzdHJpbmdbXSBhcmdOKSBvcmFjbGl6ZUFQSSBpbnRlcm5hbCByZXR1cm5zIChieXRlczMyIGlkKXsKICAgICAgICB1aW50IHByaWNlID0gb3JhY2xpemUuZ2V0UHJpY2UoZGF0YXNvdXJjZSk7CiAgICAgICAgaWYgKHByaWNlID4gMSBldGhlciArIHR4Lmdhc3ByaWNlKjIwMDAwMCkgcmV0dXJuIDA7IC8vIHVuZXhwZWN0ZWRseSBoaWdoIHByaWNlCiAgICAgICAgYnl0ZXMgbWVtb3J5IGFyZ3MgPSBzdHJhMmNib3IoYXJnTik7CiAgICAgICAgcmV0dXJuIG9yYWNsaXplLnF1ZXJ5Ti52YWx1ZShwcmljZSkoMCwgZGF0YXNvdXJjZSwgYXJncyk7CiAgICB9CiAgICBmdW5jdGlvbiBvcmFjbGl6ZV9xdWVyeSh1aW50IHRpbWVzdGFtcCwgc3RyaW5nIGRhdGFzb3VyY2UsIHN0cmluZ1tdIGFyZ04pIG9yYWNsaXplQVBJIGludGVybmFsIHJldHVybnMgKGJ5dGVzMzIgaWQpewogICAgICAgIHVpbnQgcHJpY2UgPSBvcmFjbGl6ZS5nZXRQcmljZShkYXRhc291cmNlKTsKICAgICAgICBpZiAocHJpY2UgPiAxIGV0aGVyICsgdHguZ2FzcHJpY2UqMjAwMDAwKSByZXR1cm4gMDsgLy8gdW5leHBlY3RlZGx5IGhpZ2ggcHJpY2UKICAgICAgICBieXRlcyBtZW1vcnkgYXJncyA9IHN0cmEyY2JvcihhcmdOKTsKICAgICAgICByZXR1cm4gb3JhY2xpemUucXVlcnlOLnZhbHVlKHByaWNlKSh0aW1lc3RhbXAsIGRhdGFzb3VyY2UsIGFyZ3MpOwogICAgfQogICAgZnVuY3Rpb24gb3JhY2xpemVfcXVlcnkodWludCB0aW1lc3RhbXAsIHN0cmluZyBkYXRhc291cmNlLCBzdHJpbmdbXSBhcmdOLCB1aW50IGdhc2xpbWl0KSBvcmFjbGl6ZUFQSSBpbnRlcm5hbCByZXR1cm5zIChieXRlczMyIGlkKXsKICAgICAgICB1aW50IHByaWNlID0gb3JhY2xpemUuZ2V0UHJpY2UoZGF0YXNvdXJjZSwgZ2FzbGltaXQpOwogICAgICAgIGlmIChwcmljZSA+IDEgZXRoZXIgKyB0eC5nYXNwcmljZSpnYXNsaW1pdCkgcmV0dXJuIDA7IC8vIHVuZXhwZWN0ZWRseSBoaWdoIHByaWNlCiAgICAgICAgYnl0ZXMgbWVtb3J5IGFyZ3MgPSBzdHJhMmNib3IoYXJnTik7CiAgICAgICAgcmV0dXJuIG9yYWNsaXplLnF1ZXJ5Tl93aXRoR2FzTGltaXQudmFsdWUocHJpY2UpKHRpbWVzdGFtcCwgZGF0YXNvdXJjZSwgYXJncywgZ2FzbGltaXQpOwogICAgfQogICAgZnVuY3Rpb24gb3JhY2xpemVfcXVlcnkoc3RyaW5nIGRhdGFzb3VyY2UsIHN0cmluZ1tdIGFyZ04sIHVpbnQgZ2FzbGltaXQpIG9yYWNsaXplQVBJIGludGVybmFsIHJldHVybnMgKGJ5dGVzMzIgaWQpewogICAgICAgIHVpbnQgcHJpY2UgPSBvcmFjbGl6ZS5nZXRQcmljZShkYXRhc291cmNlLCBnYXNsaW1pdCk7CiAgICAgICAgaWYgKHByaWNlID4gMSBldGhlciArIHR4Lmdhc3ByaWNlKmdhc2xpbWl0KSByZXR1cm4gMDsgLy8gdW5leHBlY3RlZGx5IGhpZ2ggcHJpY2UKICAgICAgICBieXRlcyBtZW1vcnkgYXJncyA9IHN0cmEyY2JvcihhcmdOKTsKICAgICAgICByZXR1cm4gb3JhY2xpemUucXVlcnlOX3dpdGhHYXNMaW1pdC52YWx1ZShwcmljZSkoMCwgZGF0YXNvdXJjZSwgYXJncywgZ2FzbGltaXQpOwogICAgfQogICAgZnVuY3Rpb24gb3JhY2xpemVfcXVlcnkoc3RyaW5nIGRhdGFzb3VyY2UsIHN0cmluZ1sxXSBhcmdzKSBvcmFjbGl6ZUFQSSBpbnRlcm5hbCByZXR1cm5zIChieXRlczMyIGlkKSB7CiAgICAgICAgc3RyaW5nW10gbWVtb3J5IGR5bmFyZ3MgPSBuZXcgc3RyaW5nW10oMSk7CiAgICAgICAgZHluYXJnc1swXSA9IGFyZ3NbMF07CiAgICAgICAgcmV0dXJuIG9yYWNsaXplX3F1ZXJ5KGRhdGFzb3VyY2UsIGR5bmFyZ3MpOwogICAgfQogICAgZnVuY3Rpb24gb3JhY2xpemVfcXVlcnkodWludCB0aW1lc3RhbXAsIHN0cmluZyBkYXRhc291cmNlLCBzdHJpbmdbMV0gYXJncykgb3JhY2xpemVBUEkgaW50ZXJuYWwgcmV0dXJucyAoYnl0ZXMzMiBpZCkgewogICAgICAgIHN0cmluZ1tdIG1lbW9yeSBkeW5hcmdzID0gbmV3IHN0cmluZ1tdKDEpOwogICAgICAgIGR5bmFyZ3NbMF0gPSBhcmdzWzBdOwogICAgICAgIHJldHVybiBvcmFjbGl6ZV9xdWVyeSh0aW1lc3RhbXAsIGRhdGFzb3VyY2UsIGR5bmFyZ3MpOwogICAgfQogICAgZnVuY3Rpb24gb3JhY2xpemVfcXVlcnkodWludCB0aW1lc3RhbXAsIHN0cmluZyBkYXRhc291cmNlLCBzdHJpbmdbMV0gYXJncywgdWludCBnYXNsaW1pdCkgb3JhY2xpemVBUEkgaW50ZXJuYWwgcmV0dXJucyAoYnl0ZXMzMiBpZCkgewogICAgICAgIHN0cmluZ1tdIG1lbW9yeSBkeW5hcmdzID0gbmV3IHN0cmluZ1tdKDEpOwogICAgICAgIGR5bmFyZ3NbMF0gPSBhcmdzWzBdOwogICAgICAgIHJldHVybiBvcmFjbGl6ZV9xdWVyeSh0aW1lc3RhbXAsIGRhdGFzb3VyY2UsIGR5bmFyZ3MsIGdhc2xpbWl0KTsKICAgIH0KICAgIGZ1bmN0aW9uIG9yYWNsaXplX3F1ZXJ5KHN0cmluZyBkYXRhc291cmNlLCBzdHJpbmdbMV0gYXJncywgdWludCBnYXNsaW1pdCkgb3JhY2xpemVBUEkgaW50ZXJuYWwgcmV0dXJucyAoYnl0ZXMzMiBpZCkgewogICAgICAgIHN0cmluZ1tdIG1lbW9yeSBkeW5hcmdzID0gbmV3IHN0cmluZ1tdKDEpOwogICAgICAgIGR5bmFyZ3NbMF0gPSBhcmdzWzBdOyAgICAgICAKICAgICAgICByZXR1cm4gb3JhY2xpemVfcXVlcnkoZGF0YXNvdXJjZSwgZHluYXJncywgZ2FzbGltaXQpOwogICAgfQogICAgCiAgICBmdW5jdGlvbiBvcmFjbGl6ZV9xdWVyeShzdHJpbmcgZGF0YXNvdXJjZSwgc3RyaW5nWzJdIGFyZ3MpIG9yYWNsaXplQVBJIGludGVybmFsIHJldHVybnMgKGJ5dGVzMzIgaWQpIHsKICAgICAgICBzdHJpbmdbXSBtZW1vcnkgZHluYXJncyA9IG5ldyBzdHJpbmdbXSgyKTsKICAgICAgICBkeW5hcmdzWzBdID0gYXJnc1swXTsKICAgICAgICBkeW5hcmdzWzFdID0gYXJnc1sxXTsKICAgICAgICByZXR1cm4gb3JhY2xpemVfcXVlcnkoZGF0YXNvdXJjZSwgZHluYXJncyk7CiAgICB9CiAgICBmdW5jdGlvbiBvcmFjbGl6ZV9xdWVyeSh1aW50IHRpbWVzdGFtcCwgc3RyaW5nIGRhdGFzb3VyY2UsIHN0cmluZ1syXSBhcmdzKSBvcmFjbGl6ZUFQSSBpbnRlcm5hbCByZXR1cm5zIChieXRlczMyIGlkKSB7CiAgICAgICAgc3RyaW5nW10gbWVtb3J5IGR5bmFyZ3MgPSBuZXcgc3RyaW5nW10oMik7CiAgICAgICAgZHluYXJnc1swXSA9IGFyZ3NbMF07CiAgICAgICAgZHluYXJnc1sxXSA9IGFyZ3NbMV07CiAgICAgICAgcmV0dXJuIG9yYWNsaXplX3F1ZXJ5KHRpbWVzdGFtcCwgZGF0YXNvdXJjZSwgZHluYXJncyk7CiAgICB9CiAgICBmdW5jdGlvbiBvcmFjbGl6ZV9xdWVyeSh1aW50IHRpbWVzdGFtcCwgc3RyaW5nIGRhdGFzb3VyY2UsIHN0cmluZ1syXSBhcmdzLCB1aW50IGdhc2xpbWl0KSBvcmFjbGl6ZUFQSSBpbnRlcm5hbCByZXR1cm5zIChieXRlczMyIGlkKSB7CiAgICAgICAgc3RyaW5nW10gbWVtb3J5IGR5bmFyZ3MgPSBuZXcgc3RyaW5nW10oMik7CiAgICAgICAgZHluYXJnc1swXSA9IGFyZ3NbMF07CiAgICAgICAgZHluYXJnc1sxXSA9IGFyZ3NbMV07CiAgICAgICAgcmV0dXJuIG9yYWNsaXplX3F1ZXJ5KHRpbWVzdGFtcCwgZGF0YXNvdXJjZSwgZHluYXJncywgZ2FzbGltaXQpOwogICAgfQogICAgZnVuY3Rpb24gb3JhY2xpemVfcXVlcnkoc3RyaW5nIGRhdGFzb3VyY2UsIHN0cmluZ1syXSBhcmdzLCB1aW50IGdhc2xpbWl0KSBvcmFjbGl6ZUFQSSBpbnRlcm5hbCByZXR1cm5zIChieXRlczMyIGlkKSB7CiAgICAgICAgc3RyaW5nW10gbWVtb3J5IGR5bmFyZ3MgPSBuZXcgc3RyaW5nW10oMik7CiAgICAgICAgZHluYXJnc1swXSA9IGFyZ3NbMF07CiAgICAgICAgZHluYXJnc1sxXSA9IGFyZ3NbMV07CiAgICAgICAgcmV0dXJuIG9yYWNsaXplX3F1ZXJ5KGRhdGFzb3VyY2UsIGR5bmFyZ3MsIGdhc2xpbWl0KTsKICAgIH0KICAgIGZ1bmN0aW9uIG9yYWNsaXplX3F1ZXJ5KHN0cmluZyBkYXRhc291cmNlLCBzdHJpbmdbM10gYXJncykgb3JhY2xpemVBUEkgaW50ZXJuYWwgcmV0dXJucyAoYnl0ZXMzMiBpZCkgewogICAgICAgIHN0cmluZ1tdIG1lbW9yeSBkeW5hcmdzID0gbmV3IHN0cmluZ1tdKDMpOwogICAgICAgIGR5bmFyZ3NbMF0gPSBhcmdzWzBdOwogICAgICAgIGR5bmFyZ3NbMV0gPSBhcmdzWzFdOwogICAgICAgIGR5bmFyZ3NbMl0gPSBhcmdzWzJdOwogICAgICAgIHJldHVybiBvcmFjbGl6ZV9xdWVyeShkYXRhc291cmNlLCBkeW5hcmdzKTsKICAgIH0KICAgIGZ1bmN0aW9uIG9yYWNsaXplX3F1ZXJ5KHVpbnQgdGltZXN0YW1wLCBzdHJpbmcgZGF0YXNvdXJjZSwgc3RyaW5nWzNdIGFyZ3MpIG9yYWNsaXplQVBJIGludGVybmFsIHJldHVybnMgKGJ5dGVzMzIgaWQpIHsKICAgICAgICBzdHJpbmdbXSBtZW1vcnkgZHluYXJncyA9IG5ldyBzdHJpbmdbXSgzKTsKICAgICAgICBkeW5hcmdzWzBdID0gYXJnc1swXTsKICAgICAgICBkeW5hcmdzWzFdID0gYXJnc1sxXTsKICAgICAgICBkeW5hcmdzWzJdID0gYXJnc1syXTsKICAgICAgICByZXR1cm4gb3JhY2xpemVfcXVlcnkodGltZXN0YW1wLCBkYXRhc291cmNlLCBkeW5hcmdzKTsKICAgIH0KICAgIGZ1bmN0aW9uIG9yYWNsaXplX3F1ZXJ5KHVpbnQgdGltZXN0YW1wLCBzdHJpbmcgZGF0YXNvdXJjZSwgc3RyaW5nWzNdIGFyZ3MsIHVpbnQgZ2FzbGltaXQpIG9yYWNsaXplQVBJIGludGVybmFsIHJldHVybnMgKGJ5dGVzMzIgaWQpIHsKICAgICAgICBzdHJpbmdbXSBtZW1vcnkgZHluYXJncyA9IG5ldyBzdHJpbmdbXSgzKTsKICAgICAgICBkeW5hcmdzWzBdID0gYXJnc1swXTsKICAgICAgICBkeW5hcmdzWzFdID0gYXJnc1sxXTsKICAgICAgICBkeW5hcmdzWzJdID0gYXJnc1syXTsKICAgICAgICByZXR1cm4gb3JhY2xpemVfcXVlcnkodGltZXN0YW1wLCBkYXRhc291cmNlLCBkeW5hcmdzLCBnYXNsaW1pdCk7CiAgICB9CiAgICBmdW5jdGlvbiBvcmFjbGl6ZV9xdWVyeShzdHJpbmcgZGF0YXNvdXJjZSwgc3RyaW5nWzNdIGFyZ3MsIHVpbnQgZ2FzbGltaXQpIG9yYWNsaXplQVBJIGludGVybmFsIHJldHVybnMgKGJ5dGVzMzIgaWQpIHsKICAgICAgICBzdHJpbmdbXSBtZW1vcnkgZHluYXJncyA9IG5ldyBzdHJpbmdbXSgzKTsKICAgICAgICBkeW5hcmdzWzBdID0gYXJnc1swXTsKICAgICAgICBkeW5hcmdzWzFdID0gYXJnc1sxXTsKICAgICAgICBkeW5hcmdzWzJdID0gYXJnc1syXTsKICAgICAgICByZXR1cm4gb3JhY2xpemVfcXVlcnkoZGF0YXNvdXJjZSwgZHluYXJncywgZ2FzbGltaXQpOwogICAgfQogICAgCiAgICBmdW5jdGlvbiBvcmFjbGl6ZV9xdWVyeShzdHJpbmcgZGF0YXNvdXJjZSwgc3RyaW5nWzRdIGFyZ3MpIG9yYWNsaXplQVBJIGludGVybmFsIHJldHVybnMgKGJ5dGVzMzIgaWQpIHsKICAgICAgICBzdHJpbmdbXSBtZW1vcnkgZHluYXJncyA9IG5ldyBzdHJpbmdbXSg0KTsKICAgICAgICBkeW5hcmdzWzBdID0gYXJnc1swXTsKICAgICAgICBkeW5hcmdzWzFdID0gYXJnc1sxXTsKICAgICAgICBkeW5hcmdzWzJdID0gYXJnc1syXTsKICAgICAgICBkeW5hcmdzWzNdID0gYXJnc1szXTsKICAgICAgICByZXR1cm4gb3JhY2xpemVfcXVlcnkoZGF0YXNvdXJjZSwgZHluYXJncyk7CiAgICB9CiAgICBmdW5jdGlvbiBvcmFjbGl6ZV9xdWVyeSh1aW50IHRpbWVzdGFtcCwgc3RyaW5nIGRhdGFzb3VyY2UsIHN0cmluZ1s0XSBhcmdzKSBvcmFjbGl6ZUFQSSBpbnRlcm5hbCByZXR1cm5zIChieXRlczMyIGlkKSB7CiAgICAgICAgc3RyaW5nW10gbWVtb3J5IGR5bmFyZ3MgPSBuZXcgc3RyaW5nW10oNCk7CiAgICAgICAgZHluYXJnc1swXSA9IGFyZ3NbMF07CiAgICAgICAgZHluYXJnc1sxXSA9IGFyZ3NbMV07CiAgICAgICAgZHluYXJnc1syXSA9IGFyZ3NbMl07CiAgICAgICAgZHluYXJnc1szXSA9IGFyZ3NbM107CiAgICAgICAgcmV0dXJuIG9yYWNsaXplX3F1ZXJ5KHRpbWVzdGFtcCwgZGF0YXNvdXJjZSwgZHluYXJncyk7CiAgICB9CiAgICBmdW5jdGlvbiBvcmFjbGl6ZV9xdWVyeSh1aW50IHRpbWVzdGFtcCwgc3RyaW5nIGRhdGFzb3VyY2UsIHN0cmluZ1s0XSBhcmdzLCB1aW50IGdhc2xpbWl0KSBvcmFjbGl6ZUFQSSBpbnRlcm5hbCByZXR1cm5zIChieXRlczMyIGlkKSB7CiAgICAgICAgc3RyaW5nW10gbWVtb3J5IGR5bmFyZ3MgPSBuZXcgc3RyaW5nW10oNCk7CiAgICAgICAgZHluYXJnc1swXSA9IGFyZ3NbMF07CiAgICAgICAgZHluYXJnc1sxXSA9IGFyZ3NbMV07CiAgICAgICAgZHluYXJnc1syXSA9IGFyZ3NbMl07CiAgICAgICAgZHluYXJnc1szXSA9IGFyZ3NbM107CiAgICAgICAgcmV0dXJuIG9yYWNsaXplX3F1ZXJ5KHRpbWVzdGFtcCwgZGF0YXNvdXJjZSwgZHluYXJncywgZ2FzbGltaXQpOwogICAgfQogICAgZnVuY3Rpb24gb3JhY2xpemVfcXVlcnkoc3RyaW5nIGRhdGFzb3VyY2UsIHN0cmluZ1s0XSBhcmdzLCB1aW50IGdhc2xpbWl0KSBvcmFjbGl6ZUFQSSBpbnRlcm5hbCByZXR1cm5zIChieXRlczMyIGlkKSB7CiAgICAgICAgc3RyaW5nW10gbWVtb3J5IGR5bmFyZ3MgPSBuZXcgc3RyaW5nW10oNCk7CiAgICAgICAgZHluYXJnc1swXSA9IGFyZ3NbMF07CiAgICAgICAgZHluYXJnc1sxXSA9IGFyZ3NbMV07CiAgICAgICAgZHluYXJnc1syXSA9IGFyZ3NbMl07CiAgICAgICAgZHluYXJnc1szXSA9IGFyZ3NbM107CiAgICAgICAgcmV0dXJuIG9yYWNsaXplX3F1ZXJ5KGRhdGFzb3VyY2UsIGR5bmFyZ3MsIGdhc2xpbWl0KTsKICAgIH0KICAgIGZ1bmN0aW9uIG9yYWNsaXplX3F1ZXJ5KHN0cmluZyBkYXRhc291cmNlLCBzdHJpbmdbNV0gYXJncykgb3JhY2xpemVBUEkgaW50ZXJuYWwgcmV0dXJucyAoYnl0ZXMzMiBpZCkgewogICAgICAgIHN0cmluZ1tdIG1lbW9yeSBkeW5hcmdzID0gbmV3IHN0cmluZ1tdKDUpOwogICAgICAgIGR5bmFyZ3NbMF0gPSBhcmdzWzBdOwogICAgICAgIGR5bmFyZ3NbMV0gPSBhcmdzWzFdOwogICAgICAgIGR5bmFyZ3NbMl0gPSBhcmdzWzJdOwogICAgICAgIGR5bmFyZ3NbM10gPSBhcmdzWzNdOwogICAgICAgIGR5bmFyZ3NbNF0gPSBhcmdzWzRdOwogICAgICAgIHJldHVybiBvcmFjbGl6ZV9xdWVyeShkYXRhc291cmNlLCBkeW5hcmdzKTsKICAgIH0KICAgIGZ1bmN0aW9uIG9yYWNsaXplX3F1ZXJ5KHVpbnQgdGltZXN0YW1wLCBzdHJpbmcgZGF0YXNvdXJjZSwgc3RyaW5nWzVdIGFyZ3MpIG9yYWNsaXplQVBJIGludGVybmFsIHJldHVybnMgKGJ5dGVzMzIgaWQpIHsKICAgICAgICBzdHJpbmdbXSBtZW1vcnkgZHluYXJncyA9IG5ldyBzdHJpbmdbXSg1KTsKICAgICAgICBkeW5hcmdzWzBdID0gYXJnc1swXTsKICAgICAgICBkeW5hcmdzWzFdID0gYXJnc1sxXTsKICAgICAgICBkeW5hcmdzWzJdID0gYXJnc1syXTsKICAgICAgICBkeW5hcmdzWzNdID0gYXJnc1szXTsKICAgICAgICBkeW5hcmdzWzRdID0gYXJnc1s0XTsKICAgICAgICByZXR1cm4gb3JhY2xpemVfcXVlcnkodGltZXN0YW1wLCBkYXRhc291cmNlLCBkeW5hcmdzKTsKICAgIH0KICAgIGZ1bmN0aW9uIG9yYWNsaXplX3F1ZXJ5KHVpbnQgdGltZXN0YW1wLCBzdHJpbmcgZGF0YXNvdXJjZSwgc3RyaW5nWzVdIGFyZ3MsIHVpbnQgZ2FzbGltaXQpIG9yYWNsaXplQVBJIGludGVybmFsIHJldHVybnMgKGJ5dGVzMzIgaWQpIHsKICAgICAgICBzdHJpbmdbXSBtZW1vcnkgZHluYXJncyA9IG5ldyBzdHJpbmdbXSg1KTsKICAgICAgICBkeW5hcmdzWzBdID0gYXJnc1swXTsKICAgICAgICBkeW5hcmdzWzFdID0gYXJnc1sxXTsKICAgICAgICBkeW5hcmdzWzJdID0gYXJnc1syXTsKICAgICAgICBkeW5hcmdzWzNdID0gYXJnc1szXTsKICAgICAgICBkeW5hcmdzWzRdID0gYXJnc1s0XTsKICAgICAgICByZXR1cm4gb3JhY2xpemVfcXVlcnkodGltZXN0YW1wLCBkYXRhc291cmNlLCBkeW5hcmdzLCBnYXNsaW1pdCk7CiAgICB9CiAgICBmdW5jdGlvbiBvcmFjbGl6ZV9xdWVyeShzdHJpbmcgZGF0YXNvdXJjZSwgc3RyaW5nWzVdIGFyZ3MsIHVpbnQgZ2FzbGltaXQpIG9yYWNsaXplQVBJIGludGVybmFsIHJldHVybnMgKGJ5dGVzMzIgaWQpIHsKICAgICAgICBzdHJpbmdbXSBtZW1vcnkgZHluYXJncyA9IG5ldyBzdHJpbmdbXSg1KTsKICAgICAgICBkeW5hcmdzWzBdID0gYXJnc1swXTsKICAgICAgICBkeW5hcmdzWzFdID0gYXJnc1sxXTsKICAgICAgICBkeW5hcmdzWzJdID0gYXJnc1syXTsKICAgICAgICBkeW5hcmdzWzNdID0gYXJnc1szXTsKICAgICAgICBkeW5hcmdzWzRdID0gYXJnc1s0XTsKICAgICAgICByZXR1cm4gb3JhY2xpemVfcXVlcnkoZGF0YXNvdXJjZSwgZHluYXJncywgZ2FzbGltaXQpOwogICAgfQoKICAgIGZ1bmN0aW9uIG9yYWNsaXplX2NiQWRkcmVzcygpIG9yYWNsaXplQVBJIGludGVybmFsIHJldHVybnMgKGFkZHJlc3MpewogICAgICAgIHJldHVybiBvcmFjbGl6ZS5jYkFkZHJlc3MoKTsKICAgIH0KICAgIGZ1bmN0aW9uIG9yYWNsaXplX3NldFByb29mKGJ5dGUgcHJvb2ZQKSBvcmFjbGl6ZUFQSSBpbnRlcm5hbCB7CiAgICAgICAgcmV0dXJuIG9yYWNsaXplLnNldFByb29mVHlwZShwcm9vZlApOwogICAgfQogICAgZnVuY3Rpb24gb3JhY2xpemVfc2V0Q3VzdG9tR2FzUHJpY2UodWludCBnYXNQcmljZSkgb3JhY2xpemVBUEkgaW50ZXJuYWwgewogICAgICAgIHJldHVybiBvcmFjbGl6ZS5zZXRDdXN0b21HYXNQcmljZShnYXNQcmljZSk7CiAgICB9CiAgICBmdW5jdGlvbiBvcmFjbGl6ZV9zZXRDb25maWcoYnl0ZXMzMiBjb25maWcpIG9yYWNsaXplQVBJIGludGVybmFsIHsKICAgICAgICByZXR1cm4gb3JhY2xpemUuc2V0Q29uZmlnKGNvbmZpZyk7CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0Q29kZVNpemUoYWRkcmVzcyBfYWRkcikgY29uc3RhbnQgaW50ZXJuYWwgcmV0dXJucyh1aW50IF9zaXplKSB7CiAgICAgICAgYXNzZW1ibHkgewogICAgICAgICAgICBfc2l6ZSA6PSBleHRjb2Rlc2l6ZShfYWRkcikKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gcGFyc2VBZGRyKHN0cmluZyBfYSkgaW50ZXJuYWwgcmV0dXJucyAoYWRkcmVzcyl7CiAgICAgICAgYnl0ZXMgbWVtb3J5IHRtcCA9IGJ5dGVzKF9hKTsKICAgICAgICB1aW50MTYwIGlhZGRyID0gMDsKICAgICAgICB1aW50MTYwIGIxOwogICAgICAgIHVpbnQxNjAgYjI7CiAgICAgICAgZm9yICh1aW50IGk9MjsgaTwyKzIqMjA7IGkrPTIpewogICAgICAgICAgICBpYWRkciAqPSAyNTY7CiAgICAgICAgICAgIGIxID0gdWludDE2MCh0bXBbaV0pOwogICAgICAgICAgICBiMiA9IHVpbnQxNjAodG1wW2krMV0pOwogICAgICAgICAgICBpZiAoKGIxID49IDk3KSYmKGIxIDw9IDEwMikpIGIxIC09IDg3OwogICAgICAgICAgICBlbHNlIGlmICgoYjEgPj0gNjUpJiYoYjEgPD0gNzApKSBiMSAtPSA1NTsKICAgICAgICAgICAgZWxzZSBpZiAoKGIxID49IDQ4KSYmKGIxIDw9IDU3KSkgYjEgLT0gNDg7CiAgICAgICAgICAgIGlmICgoYjIgPj0gOTcpJiYoYjIgPD0gMTAyKSkgYjIgLT0gODc7CiAgICAgICAgICAgIGVsc2UgaWYgKChiMiA+PSA2NSkmJihiMiA8PSA3MCkpIGIyIC09IDU1OwogICAgICAgICAgICBlbHNlIGlmICgoYjIgPj0gNDgpJiYoYjIgPD0gNTcpKSBiMiAtPSA0ODsKICAgICAgICAgICAgaWFkZHIgKz0gKGIxKjE2K2IyKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGFkZHJlc3MoaWFkZHIpOwogICAgfQoKICAgIGZ1bmN0aW9uIHN0ckNvbXBhcmUoc3RyaW5nIF9hLCBzdHJpbmcgX2IpIGludGVybmFsIHJldHVybnMgKGludCkgewogICAgICAgIGJ5dGVzIG1lbW9yeSBhID0gYnl0ZXMoX2EpOwogICAgICAgIGJ5dGVzIG1lbW9yeSBiID0gYnl0ZXMoX2IpOwogICAgICAgIHVpbnQgbWluTGVuZ3RoID0gYS5sZW5ndGg7CiAgICAgICAgaWYgKGIubGVuZ3RoIDwgbWluTGVuZ3RoKSBtaW5MZW5ndGggPSBiLmxlbmd0aDsKICAgICAgICBmb3IgKHVpbnQgaSA9IDA7IGkgPCBtaW5MZW5ndGg7IGkgKyspCiAgICAgICAgICAgIGlmIChhW2ldIDwgYltpXSkKICAgICAgICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICAgICAgZWxzZSBpZiAoYVtpXSA+IGJbaV0pCiAgICAgICAgICAgICAgICByZXR1cm4gMTsKICAgICAgICBpZiAoYS5sZW5ndGggPCBiLmxlbmd0aCkKICAgICAgICAgICAgcmV0dXJuIC0xOwogICAgICAgIGVsc2UgaWYgKGEubGVuZ3RoID4gYi5sZW5ndGgpCiAgICAgICAgICAgIHJldHVybiAxOwogICAgICAgIGVsc2UKICAgICAgICAgICAgcmV0dXJuIDA7CiAgICB9CgogICAgZnVuY3Rpb24gaW5kZXhPZihzdHJpbmcgX2hheXN0YWNrLCBzdHJpbmcgX25lZWRsZSkgaW50ZXJuYWwgcmV0dXJucyAoaW50KSB7CiAgICAgICAgYnl0ZXMgbWVtb3J5IGggPSBieXRlcyhfaGF5c3RhY2spOwogICAgICAgIGJ5dGVzIG1lbW9yeSBuID0gYnl0ZXMoX25lZWRsZSk7CiAgICAgICAgaWYoaC5sZW5ndGggPCAxIHx8IG4ubGVuZ3RoIDwgMSB8fCAobi5sZW5ndGggPiBoLmxlbmd0aCkpCiAgICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICBlbHNlIGlmKGgubGVuZ3RoID4gKDIqKjEyOCAtMSkpCiAgICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB1aW50IHN1YmluZGV4ID0gMDsKICAgICAgICAgICAgZm9yICh1aW50IGkgPSAwOyBpIDwgaC5sZW5ndGg7IGkgKyspCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmIChoW2ldID09IG5bMF0pCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgc3ViaW5kZXggPSAxOwogICAgICAgICAgICAgICAgICAgIHdoaWxlKHN1YmluZGV4IDwgbi5sZW5ndGggJiYgKGkgKyBzdWJpbmRleCkgPCBoLmxlbmd0aCAmJiBoW2kgKyBzdWJpbmRleF0gPT0gbltzdWJpbmRleF0pCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBzdWJpbmRleCsrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZihzdWJpbmRleCA9PSBuLmxlbmd0aCkKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGludChpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gLTE7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIHN0ckNvbmNhdChzdHJpbmcgX2EsIHN0cmluZyBfYiwgc3RyaW5nIF9jLCBzdHJpbmcgX2QsIHN0cmluZyBfZSkgaW50ZXJuYWwgcmV0dXJucyAoc3RyaW5nKSB7CiAgICAgICAgYnl0ZXMgbWVtb3J5IF9iYSA9IGJ5dGVzKF9hKTsKICAgICAgICBieXRlcyBtZW1vcnkgX2JiID0gYnl0ZXMoX2IpOwogICAgICAgIGJ5dGVzIG1lbW9yeSBfYmMgPSBieXRlcyhfYyk7CiAgICAgICAgYnl0ZXMgbWVtb3J5IF9iZCA9IGJ5dGVzKF9kKTsKICAgICAgICBieXRlcyBtZW1vcnkgX2JlID0gYnl0ZXMoX2UpOwogICAgICAgIHN0cmluZyBtZW1vcnkgYWJjZGUgPSBuZXcgc3RyaW5nKF9iYS5sZW5ndGggKyBfYmIubGVuZ3RoICsgX2JjLmxlbmd0aCArIF9iZC5sZW5ndGggKyBfYmUubGVuZ3RoKTsKICAgICAgICBieXRlcyBtZW1vcnkgYmFiY2RlID0gYnl0ZXMoYWJjZGUpOwogICAgICAgIHVpbnQgayA9IDA7CiAgICAgICAgZm9yICh1aW50IGkgPSAwOyBpIDwgX2JhLmxlbmd0aDsgaSsrKSBiYWJjZGVbaysrXSA9IF9iYVtpXTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgX2JiLmxlbmd0aDsgaSsrKSBiYWJjZGVbaysrXSA9IF9iYltpXTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgX2JjLmxlbmd0aDsgaSsrKSBiYWJjZGVbaysrXSA9IF9iY1tpXTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgX2JkLmxlbmd0aDsgaSsrKSBiYWJjZGVbaysrXSA9IF9iZFtpXTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgX2JlLmxlbmd0aDsgaSsrKSBiYWJjZGVbaysrXSA9IF9iZVtpXTsKICAgICAgICByZXR1cm4gc3RyaW5nKGJhYmNkZSk7CiAgICB9CgogICAgZnVuY3Rpb24gc3RyQ29uY2F0KHN0cmluZyBfYSwgc3RyaW5nIF9iLCBzdHJpbmcgX2MsIHN0cmluZyBfZCkgaW50ZXJuYWwgcmV0dXJucyAoc3RyaW5nKSB7CiAgICAgICAgcmV0dXJuIHN0ckNvbmNhdChfYSwgX2IsIF9jLCBfZCwgIiIpOwogICAgfQoKICAgIGZ1bmN0aW9uIHN0ckNvbmNhdChzdHJpbmcgX2EsIHN0cmluZyBfYiwgc3RyaW5nIF9jKSBpbnRlcm5hbCByZXR1cm5zIChzdHJpbmcpIHsKICAgICAgICByZXR1cm4gc3RyQ29uY2F0KF9hLCBfYiwgX2MsICIiLCAiIik7CiAgICB9CgogICAgZnVuY3Rpb24gc3RyQ29uY2F0KHN0cmluZyBfYSwgc3RyaW5nIF9iKSBpbnRlcm5hbCByZXR1cm5zIChzdHJpbmcpIHsKICAgICAgICByZXR1cm4gc3RyQ29uY2F0KF9hLCBfYiwgIiIsICIiLCAiIik7CiAgICB9CgogICAgLy8gcGFyc2VJbnQKICAgIGZ1bmN0aW9uIHBhcnNlSW50KHN0cmluZyBfYSkgaW50ZXJuYWwgcmV0dXJucyAodWludCkgewogICAgICAgIHJldHVybiBwYXJzZUludChfYSwgMCk7CiAgICB9CgogICAgLy8gcGFyc2VJbnQocGFyc2VGbG9hdCoxMF5fYikKICAgIGZ1bmN0aW9uIHBhcnNlSW50KHN0cmluZyBfYSwgdWludCBfYikgaW50ZXJuYWwgcmV0dXJucyAodWludCkgewogICAgICAgIGJ5dGVzIG1lbW9yeSBicmVzdWx0ID0gYnl0ZXMoX2EpOwogICAgICAgIHVpbnQgbWludCA9IDA7CiAgICAgICAgYm9vbCBkZWNpbWFscyA9IGZhbHNlOwogICAgICAgIGZvciAodWludCBpPTA7IGk8YnJlc3VsdC5sZW5ndGg7IGkrKyl7CiAgICAgICAgICAgIGlmICgoYnJlc3VsdFtpXSA+PSA0OCkmJihicmVzdWx0W2ldIDw9IDU3KSl7CiAgICAgICAgICAgICAgICBpZiAoZGVjaW1hbHMpewogICAgICAgICAgICAgICAgICAgaWYgKF9iID09IDApIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGVsc2UgX2ItLTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG1pbnQgKj0gMTA7CiAgICAgICAgICAgICAgICBtaW50ICs9IHVpbnQoYnJlc3VsdFtpXSkgLSA0ODsKICAgICAgICAgICAgfSBlbHNlIGlmIChicmVzdWx0W2ldID09IDQ2KSBkZWNpbWFscyA9IHRydWU7CiAgICAgICAgfQogICAgICAgIGlmIChfYiA+IDApIG1pbnQgKj0gMTAqKl9iOwogICAgICAgIHJldHVybiBtaW50OwogICAgfQoKICAgIGZ1bmN0aW9uIHVpbnQyc3RyKHVpbnQgaSkgaW50ZXJuYWwgcmV0dXJucyAoc3RyaW5nKXsKICAgICAgICBpZiAoaSA9PSAwKSByZXR1cm4gIjAiOwogICAgICAgIHVpbnQgaiA9IGk7CiAgICAgICAgdWludCBsZW47CiAgICAgICAgd2hpbGUgKGogIT0gMCl7CiAgICAgICAgICAgIGxlbisrOwogICAgICAgICAgICBqIC89IDEwOwogICAgICAgIH0KICAgICAgICBieXRlcyBtZW1vcnkgYnN0ciA9IG5ldyBieXRlcyhsZW4pOwogICAgICAgIHVpbnQgayA9IGxlbiAtIDE7CiAgICAgICAgd2hpbGUgKGkgIT0gMCl7CiAgICAgICAgICAgIGJzdHJbay0tXSA9IGJ5dGUoNDggKyBpICUgMTApOwogICAgICAgICAgICBpIC89IDEwOwogICAgICAgIH0KICAgICAgICByZXR1cm4gc3RyaW5nKGJzdHIpOwogICAgfQoKICAgIGZ1bmN0aW9uIHN0cmEyY2JvcihzdHJpbmdbXSBhcnIpIGludGVybmFsIHJldHVybnMgKGJ5dGVzKSB7CiAgICAgICAgICAgIHVpbnQgYXJybGVuID0gYXJyLmxlbmd0aDsKCiAgICAgICAgICAgIC8vIGdldCBjb3JyZWN0IGNib3Igb3V0cHV0IGxlbmd0aAogICAgICAgICAgICB1aW50IG91dHB1dGxlbiA9IDA7CiAgICAgICAgICAgIGJ5dGVzW10gbWVtb3J5IGVsZW1BcnJheSA9IG5ldyBieXRlc1tdKGFycmxlbik7CiAgICAgICAgICAgIGZvciAodWludCBpID0gMDsgaSA8IGFycmxlbjsgaSsrKSB7CiAgICAgICAgICAgICAgICBlbGVtQXJyYXlbaV0gPSAoYnl0ZXMoYXJyW2ldKSk7CiAgICAgICAgICAgICAgICBvdXRwdXRsZW4gKz0gZWxlbUFycmF5W2ldLmxlbmd0aCArIChlbGVtQXJyYXlbaV0ubGVuZ3RoIC0gMSkvMjMgKyAzOyAvLyszIGFjY291bnRzIGZvciBwYWlyZWQgaWRlbnRpZmllciB0eXBlcwogICAgICAgICAgICB9CiAgICAgICAgICAgIHVpbnQgY3RyID0gMDsKICAgICAgICAgICAgdWludCBjYm9ybGVuID0gYXJybGVuICsgMHg4MDsKICAgICAgICAgICAgb3V0cHV0bGVuICs9IGJ5dGUoY2JvcmxlbikubGVuZ3RoOwogICAgICAgICAgICBieXRlcyBtZW1vcnkgcmVzID0gbmV3IGJ5dGVzKG91dHB1dGxlbik7CgogICAgICAgICAgICB3aGlsZSAoYnl0ZShjYm9ybGVuKS5sZW5ndGggPiBjdHIpIHsKICAgICAgICAgICAgICAgIHJlc1tjdHJdID0gYnl0ZShjYm9ybGVuKVtjdHJdOwogICAgICAgICAgICAgICAgY3RyKys7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGFycmxlbjsgaSsrKSB7CiAgICAgICAgICAgICAgICByZXNbY3RyXSA9IDB4NUY7CiAgICAgICAgICAgICAgICBjdHIrKzsKICAgICAgICAgICAgICAgIGZvciAodWludCB4ID0gMDsgeCA8IGVsZW1BcnJheVtpXS5sZW5ndGg7IHgrKykgewogICAgICAgICAgICAgICAgICAgIC8vIGlmIHRoZXJlJ3MgYSBidWcgd2l0aCBsYXJnZXIgc3RyaW5ncywgdGhpcyBtYXkgYmUgdGhlIGN1bHByaXQKICAgICAgICAgICAgICAgICAgICBpZiAoeCAlIDIzID09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgdWludCBlbGVtY2JvcmxlbiA9IGVsZW1BcnJheVtpXS5sZW5ndGggLSB4ID49IDI0ID8gMjMgOiBlbGVtQXJyYXlbaV0ubGVuZ3RoIC0geDsKICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWNib3JsZW4gKz0gMHg0MDsKICAgICAgICAgICAgICAgICAgICAgICAgdWludCBsY3RyID0gY3RyOwogICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAoYnl0ZShlbGVtY2JvcmxlbikubGVuZ3RoID4gY3RyIC0gbGN0cikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzW2N0cl0gPSBieXRlKGVsZW1jYm9ybGVuKVtjdHIgLSBsY3RyXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN0cisrOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJlc1tjdHJdID0gZWxlbUFycmF5W2ldW3hdOwogICAgICAgICAgICAgICAgICAgIGN0cisrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmVzW2N0cl0gPSAweEZGOwogICAgICAgICAgICAgICAgY3RyKys7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHJlczsKICAgICAgICB9Cn0KLy8gPC9PUkFDTElaRV9BUEk+CgovKgogKiBAdGl0bGUgU3RyaW5nICYgc2xpY2UgdXRpbGl0eSBsaWJyYXJ5IGZvciBTb2xpZGl0eSBjb250cmFjdHMuCiAqIEBhdXRob3IgTmljayBKb2huc29uIDw8YSBocmVmPSIvY2RuLWNnaS9sL2VtYWlsLXByb3RlY3Rpb24iIGNsYXNzPSJfX2NmX2VtYWlsX18iIGRhdGEtY2ZlbWFpbD0iMzI1MzQwNTM1MTVhNWM1YjU2NzI1YzVkNDY1NjVkNDYxYzVjNTc0NiI+W2VtYWlsJiMxNjA7cHJvdGVjdGVkXTwvYT4+CiAqCiAqIEBkZXYgRnVuY3Rpb25hbGl0eSBpbiB0aGlzIGxpYnJhcnkgaXMgbGFyZ2VseSBpbXBsZW1lbnRlZCB1c2luZyBhbgogKiAgICAgIGFic3RyYWN0aW9uIGNhbGxlZCBhICdzbGljZScuIEEgc2xpY2UgcmVwcmVzZW50cyBhIHBhcnQgb2YgYSBzdHJpbmcgLQogKiAgICAgIGFueXRoaW5nIGZyb20gdGhlIGVudGlyZSBzdHJpbmcgdG8gYSBzaW5nbGUgY2hhcmFjdGVyLCBvciBldmVuIG5vCiAqICAgICAgY2hhcmFjdGVycyBhdCBhbGwgKGEgMC1sZW5ndGggc2xpY2UpLiBTaW5jZSBhIHNsaWNlIG9ubHkgaGFzIHRvIHNwZWNpZnkKICogICAgICBhbiBvZmZzZXQgYW5kIGEgbGVuZ3RoLCBjb3B5aW5nIGFuZCBtYW5pcHVsYXRpbmcgc2xpY2VzIGlzIGEgbG90IGxlc3MKICogICAgICBleHBlbnNpdmUgdGhhbiBjb3B5aW5nIGFuZCBtYW5pcHVsYXRpbmcgdGhlIHN0cmluZ3MgdGhleSByZWZlcmVuY2UuCiAqCiAqICAgICAgVG8gZnVydGhlciByZWR1Y2UgZ2FzIGNvc3RzLCBtb3N0IGZ1bmN0aW9ucyBvbiBzbGljZSB0aGF0IG5lZWQgdG8gcmV0dXJuCiAqICAgICAgYSBzbGljZSBtb2RpZnkgdGhlIG9yaWdpbmFsIG9uZSBpbnN0ZWFkIG9mIGFsbG9jYXRpbmcgYSBuZXcgb25lOyBmb3IKICogICAgICBpbnN0YW5jZSwgYHMuc3BsaXQoIi4iKWAgd2lsbCByZXR1cm4gdGhlIHRleHQgdXAgdG8gdGhlIGZpcnN0ICcuJywKICogICAgICBtb2RpZnlpbmcgcyB0byBvbmx5IGNvbnRhaW4gdGhlIHJlbWFpbmRlciBvZiB0aGUgc3RyaW5nIGFmdGVyIHRoZSAnLicuCiAqICAgICAgSW4gc2l0dWF0aW9ucyB3aGVyZSB5b3UgZG8gbm90IHdhbnQgdG8gbW9kaWZ5IHRoZSBvcmlnaW5hbCBzbGljZSwgeW91CiAqICAgICAgY2FuIG1ha2UgYSBjb3B5IGZpcnN0IHdpdGggYC5jb3B5KClgLCBmb3IgZXhhbXBsZToKICogICAgICBgcy5jb3B5KCkuc3BsaXQoIi4iKWAuIFRyeSBhbmQgYXZvaWQgdXNpbmcgdGhpcyBpZGlvbSBpbiBsb29wczsgc2luY2UKICogICAgICBTb2xpZGl0eSBoYXMgbm8gbWVtb3J5IG1hbmFnZW1lbnQsIGl0IHdpbGwgcmVzdWx0IGluIGFsbG9jYXRpbmcgbWFueQogKiAgICAgIHNob3J0LWxpdmVkIHNsaWNlcyB0aGF0IGFyZSBsYXRlciBkaXNjYXJkZWQuCiAqCiAqICAgICAgRnVuY3Rpb25zIHRoYXQgcmV0dXJuIHR3byBzbGljZXMgY29tZSBpbiB0d28gdmVyc2lvbnM6IGEgbm9uLWFsbG9jYXRpbmcKICogICAgICB2ZXJzaW9uIHRoYXQgdGFrZXMgdGhlIHNlY29uZCBzbGljZSBhcyBhbiBhcmd1bWVudCwgbW9kaWZ5aW5nIGl0IGluCiAqICAgICAgcGxhY2UsIGFuZCBhbiBhbGxvY2F0aW5nIHZlcnNpb24gdGhhdCBhbGxvY2F0ZXMgYW5kIHJldHVybnMgdGhlIHNlY29uZAogKiAgICAgIHNsaWNlOyBzZWUgYG5leHRSdW5lYCBmb3IgZXhhbXBsZS4KICoKICogICAgICBGdW5jdGlvbnMgdGhhdCBoYXZlIHRvIGNvcHkgc3RyaW5nIGRhdGEgd2lsbCByZXR1cm4gc3RyaW5ncyByYXRoZXIgdGhhbgogKiAgICAgIHNsaWNlczsgdGhlc2UgY2FuIGJlIGNhc3QgYmFjayB0byBzbGljZXMgZm9yIGZ1cnRoZXIgcHJvY2Vzc2luZyBpZgogKiAgICAgIHJlcXVpcmVkLgogKgogKiAgICAgIEZvciBjb252ZW5pZW5jZSwgc29tZSBmdW5jdGlvbnMgYXJlIHByb3ZpZGVkIHdpdGggbm9uLW1vZGlmeWluZwogKiAgICAgIHZhcmlhbnRzIHRoYXQgY3JlYXRlIGEgbmV3IHNsaWNlIGFuZCByZXR1cm4gYm90aDsgZm9yIGluc3RhbmNlLAogKiAgICAgIGBzLnNwbGl0TmV3KCcuJylgIGxlYXZlcyBzIHVubW9kaWZpZWQsIGFuZCByZXR1cm5zIHR3byB2YWx1ZXMKICogICAgICBjb3JyZXNwb25kaW5nIHRvIHRoZSBsZWZ0IGFuZCByaWdodCBwYXJ0cyBvZiB0aGUgc3RyaW5nLgogKi8KbGlicmFyeSBzdHJpbmdzIHsKICAgIHN0cnVjdCBzbGljZSB7CiAgICAgICAgdWludCBfbGVuOwogICAgICAgIHVpbnQgX3B0cjsKICAgIH0KCiAgICBmdW5jdGlvbiBtZW1jcHkodWludCBkZXN0LCB1aW50IHNyYywgdWludCBsZW4pIHByaXZhdGUgewogICAgICAgIC8vIENvcHkgd29yZC1sZW5ndGggY2h1bmtzIHdoaWxlIHBvc3NpYmxlCiAgICAgICAgZm9yKDsgbGVuID49IDMyOyBsZW4gLT0gMzIpIHsKICAgICAgICAgICAgYXNzZW1ibHkgewogICAgICAgICAgICAgICAgbXN0b3JlKGRlc3QsIG1sb2FkKHNyYykpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVzdCArPSAzMjsKICAgICAgICAgICAgc3JjICs9IDMyOwogICAgICAgIH0KCiAgICAgICAgLy8gQ29weSByZW1haW5pbmcgYnl0ZXMKICAgICAgICB1aW50IG1hc2sgPSAyNTYgKiogKDMyIC0gbGVuKSAtIDE7CiAgICAgICAgYXNzZW1ibHkgewogICAgICAgICAgICBsZXQgc3JjcGFydCA6PSBhbmQobWxvYWQoc3JjKSwgbm90KG1hc2spKQogICAgICAgICAgICBsZXQgZGVzdHBhcnQgOj0gYW5kKG1sb2FkKGRlc3QpLCBtYXNrKQogICAgICAgICAgICBtc3RvcmUoZGVzdCwgb3IoZGVzdHBhcnQsIHNyY3BhcnQpKQogICAgICAgIH0KICAgIH0KCiAgICAvKgogICAgICogQGRldiBSZXR1cm5zIGEgc2xpY2UgY29udGFpbmluZyB0aGUgZW50aXJlIHN0cmluZy4KICAgICAqIEBwYXJhbSBzZWxmIFRoZSBzdHJpbmcgdG8gbWFrZSBhIHNsaWNlIGZyb20uCiAgICAgKiBAcmV0dXJuIEEgbmV3bHkgYWxsb2NhdGVkIHNsaWNlIGNvbnRhaW5pbmcgdGhlIGVudGlyZSBzdHJpbmcuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHRvU2xpY2Uoc3RyaW5nIHNlbGYpIGludGVybmFsIHJldHVybnMgKHNsaWNlKSB7CiAgICAgICAgdWludCBwdHI7CiAgICAgICAgYXNzZW1ibHkgewogICAgICAgICAgICBwdHIgOj0gYWRkKHNlbGYsIDB4MjApCiAgICAgICAgfQogICAgICAgIHJldHVybiBzbGljZShieXRlcyhzZWxmKS5sZW5ndGgsIHB0cik7CiAgICB9CgogICAgLyoKICAgICAqIEBkZXYgUmV0dXJucyB0aGUgbGVuZ3RoIG9mIGEgbnVsbC10ZXJtaW5hdGVkIGJ5dGVzMzIgc3RyaW5nLgogICAgICogQHBhcmFtIHNlbGYgVGhlIHZhbHVlIHRvIGZpbmQgdGhlIGxlbmd0aCBvZi4KICAgICAqIEByZXR1cm4gVGhlIGxlbmd0aCBvZiB0aGUgc3RyaW5nLCBmcm9tIDAgdG8gMzIuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGxlbihieXRlczMyIHNlbGYpIGludGVybmFsIHJldHVybnMgKHVpbnQpIHsKICAgICAgICB1aW50IHJldDsKICAgICAgICBpZiAoc2VsZiA9PSAwKQogICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICBpZiAoc2VsZiAmIDB4ZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmYgPT0gMCkgewogICAgICAgICAgICByZXQgKz0gMTY7CiAgICAgICAgICAgIHNlbGYgPSBieXRlczMyKHVpbnQoc2VsZikgLyAweDEwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMCk7CiAgICAgICAgfQogICAgICAgIGlmIChzZWxmICYgMHhmZmZmZmZmZmZmZmZmZmZmID09IDApIHsKICAgICAgICAgICAgcmV0ICs9IDg7CiAgICAgICAgICAgIHNlbGYgPSBieXRlczMyKHVpbnQoc2VsZikgLyAweDEwMDAwMDAwMDAwMDAwMDAwKTsKICAgICAgICB9CiAgICAgICAgaWYgKHNlbGYgJiAweGZmZmZmZmZmID09IDApIHsKICAgICAgICAgICAgcmV0ICs9IDQ7CiAgICAgICAgICAgIHNlbGYgPSBieXRlczMyKHVpbnQoc2VsZikgLyAweDEwMDAwMDAwMCk7CiAgICAgICAgfQogICAgICAgIGlmIChzZWxmICYgMHhmZmZmID09IDApIHsKICAgICAgICAgICAgcmV0ICs9IDI7CiAgICAgICAgICAgIHNlbGYgPSBieXRlczMyKHVpbnQoc2VsZikgLyAweDEwMDAwKTsKICAgICAgICB9CiAgICAgICAgaWYgKHNlbGYgJiAweGZmID09IDApIHsKICAgICAgICAgICAgcmV0ICs9IDE7CiAgICAgICAgfQogICAgICAgIHJldHVybiAzMiAtIHJldDsKICAgIH0KCiAgICAvKgogICAgICogQGRldiBSZXR1cm5zIGEgc2xpY2UgY29udGFpbmluZyB0aGUgZW50aXJlIGJ5dGVzMzIsIGludGVycHJldGVkIGFzIGEKICAgICAqICAgICAgbnVsbC10ZXJtaW50YWVkIHV0Zi04IHN0cmluZy4KICAgICAqIEBwYXJhbSBzZWxmIFRoZSBieXRlczMyIHZhbHVlIHRvIGNvbnZlcnQgdG8gYSBzbGljZS4KICAgICAqIEByZXR1cm4gQSBuZXcgc2xpY2UgY29udGFpbmluZyB0aGUgdmFsdWUgb2YgdGhlIGlucHV0IGFyZ3VtZW50IHVwIHRvIHRoZQogICAgICogICAgICAgICBmaXJzdCBudWxsLgogICAgICovCiAgICBmdW5jdGlvbiB0b1NsaWNlQjMyKGJ5dGVzMzIgc2VsZikgaW50ZXJuYWwgcmV0dXJucyAoc2xpY2UgcmV0KSB7CiAgICAgICAgLy8gQWxsb2NhdGUgc3BhY2UgZm9yIGBzZWxmYCBpbiBtZW1vcnksIGNvcHkgaXQgdGhlcmUsIGFuZCBwb2ludCByZXQgYXQgaXQKICAgICAgICBhc3NlbWJseSB7CiAgICAgICAgICAgIGxldCBwdHIgOj0gbWxvYWQoMHg0MCkKICAgICAgICAgICAgbXN0b3JlKDB4NDAsIGFkZChwdHIsIDB4MjApKQogICAgICAgICAgICBtc3RvcmUocHRyLCBzZWxmKQogICAgICAgICAgICBtc3RvcmUoYWRkKHJldCwgMHgyMCksIHB0cikKICAgICAgICB9CiAgICAgICAgcmV0Ll9sZW4gPSBsZW4oc2VsZik7CiAgICB9CgogICAgLyoKICAgICAqIEBkZXYgUmV0dXJucyBhIG5ldyBzbGljZSBjb250YWluaW5nIHRoZSBzYW1lIGRhdGEgYXMgdGhlIGN1cnJlbnQgc2xpY2UuCiAgICAgKiBAcGFyYW0gc2VsZiBUaGUgc2xpY2UgdG8gY29weS4KICAgICAqIEByZXR1cm4gQSBuZXcgc2xpY2UgY29udGFpbmluZyB0aGUgc2FtZSBkYXRhIGFzIGBzZWxmYC4KICAgICAqLwogICAgZnVuY3Rpb24gY29weShzbGljZSBzZWxmKSBpbnRlcm5hbCByZXR1cm5zIChzbGljZSkgewogICAgICAgIHJldHVybiBzbGljZShzZWxmLl9sZW4sIHNlbGYuX3B0cik7CiAgICB9CgogICAgLyoKICAgICAqIEBkZXYgQ29waWVzIGEgc2xpY2UgdG8gYSBuZXcgc3RyaW5nLgogICAgICogQHBhcmFtIHNlbGYgVGhlIHNsaWNlIHRvIGNvcHkuCiAgICAgKiBAcmV0dXJuIEEgbmV3bHkgYWxsb2NhdGVkIHN0cmluZyBjb250YWluaW5nIHRoZSBzbGljZSdzIHRleHQuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHRvU3RyaW5nKHNsaWNlIHNlbGYpIGludGVybmFsIHJldHVybnMgKHN0cmluZykgewogICAgICAgIHZhciByZXQgPSBuZXcgc3RyaW5nKHNlbGYuX2xlbik7CiAgICAgICAgdWludCByZXRwdHI7CiAgICAgICAgYXNzZW1ibHkgeyByZXRwdHIgOj0gYWRkKHJldCwgMzIpIH0KCiAgICAgICAgbWVtY3B5KHJldHB0ciwgc2VsZi5fcHRyLCBzZWxmLl9sZW4pOwogICAgICAgIHJldHVybiByZXQ7CiAgICB9CgogICAgLyoKICAgICAqIEBkZXYgUmV0dXJucyB0aGUgbGVuZ3RoIGluIHJ1bmVzIG9mIHRoZSBzbGljZS4gTm90ZSB0aGF0IHRoaXMgb3BlcmF0aW9uCiAgICAgKiAgICAgIHRha2VzIHRpbWUgcHJvcG9ydGlvbmFsIHRvIHRoZSBsZW5ndGggb2YgdGhlIHNsaWNlOyBhdm9pZCB1c2luZyBpdAogICAgICogICAgICBpbiBsb29wcywgYW5kIGNhbGwgYHNsaWNlLmVtcHR5KClgIGlmIHlvdSBvbmx5IG5lZWQgdG8ga25vdyB3aGV0aGVyCiAgICAgKiAgICAgIHRoZSBzbGljZSBpcyBlbXB0eSBvciBub3QuCiAgICAgKiBAcGFyYW0gc2VsZiBUaGUgc2xpY2UgdG8gb3BlcmF0ZSBvbi4KICAgICAqIEByZXR1cm4gVGhlIGxlbmd0aCBvZiB0aGUgc2xpY2UgaW4gcnVuZXMuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGxlbihzbGljZSBzZWxmKSBpbnRlcm5hbCByZXR1cm5zICh1aW50KSB7CiAgICAgICAgLy8gU3RhcnRpbmcgYXQgcHRyLTMxIG1lYW5zIHRoZSBMU0Igd2lsbCBiZSB0aGUgYnl0ZSB3ZSBjYXJlIGFib3V0CiAgICAgICAgdmFyIHB0ciA9IHNlbGYuX3B0ciAtIDMxOwogICAgICAgIHZhciBlbmQgPSBwdHIgKyBzZWxmLl9sZW47CiAgICAgICAgZm9yICh1aW50IGxlbiA9IDA7IHB0ciA8IGVuZDsgbGVuKyspIHsKICAgICAgICAgICAgdWludDggYjsKICAgICAgICAgICAgYXNzZW1ibHkgeyBiIDo9IGFuZChtbG9hZChwdHIpLCAweEZGKSB9CiAgICAgICAgICAgIGlmIChiIDwgMHg4MCkgewogICAgICAgICAgICAgICAgcHRyICs9IDE7CiAgICAgICAgICAgIH0gZWxzZSBpZihiIDwgMHhFMCkgewogICAgICAgICAgICAgICAgcHRyICs9IDI7CiAgICAgICAgICAgIH0gZWxzZSBpZihiIDwgMHhGMCkgewogICAgICAgICAgICAgICAgcHRyICs9IDM7CiAgICAgICAgICAgIH0gZWxzZSBpZihiIDwgMHhGOCkgewogICAgICAgICAgICAgICAgcHRyICs9IDQ7CiAgICAgICAgICAgIH0gZWxzZSBpZihiIDwgMHhGQykgewogICAgICAgICAgICAgICAgcHRyICs9IDU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBwdHIgKz0gNjsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gbGVuOwogICAgfQoKICAgIC8qCiAgICAgKiBAZGV2IFJldHVybnMgdHJ1ZSBpZiB0aGUgc2xpY2UgaXMgZW1wdHkgKGhhcyBhIGxlbmd0aCBvZiAwKS4KICAgICAqIEBwYXJhbSBzZWxmIFRoZSBzbGljZSB0byBvcGVyYXRlIG9uLgogICAgICogQHJldHVybiBUcnVlIGlmIHRoZSBzbGljZSBpcyBlbXB0eSwgRmFsc2Ugb3RoZXJ3aXNlLgogICAgICovCiAgICBmdW5jdGlvbiBlbXB0eShzbGljZSBzZWxmKSBpbnRlcm5hbCByZXR1cm5zIChib29sKSB7CiAgICAgICAgcmV0dXJuIHNlbGYuX2xlbiA9PSAwOwogICAgfQoKICAgIC8qCiAgICAgKiBAZGV2IFJldHVybnMgYSBwb3NpdGl2ZSBudW1iZXIgaWYgYG90aGVyYCBjb21lcyBsZXhpY29ncmFwaGljYWxseSBhZnRlcgogICAgICogICAgICBgc2VsZmAsIGEgbmVnYXRpdmUgbnVtYmVyIGlmIGl0IGNvbWVzIGJlZm9yZSwgb3IgemVybyBpZiB0aGUKICAgICAqICAgICAgY29udGVudHMgb2YgdGhlIHR3byBzbGljZXMgYXJlIGVxdWFsLiBDb21wYXJpc29uIGlzIGRvbmUgcGVyLXJ1bmUsCiAgICAgKiAgICAgIG9uIHVuaWNvZGUgY29kZXBvaW50cy4KICAgICAqIEBwYXJhbSBzZWxmIFRoZSBmaXJzdCBzbGljZSB0byBjb21wYXJlLgogICAgICogQHBhcmFtIG90aGVyIFRoZSBzZWNvbmQgc2xpY2UgdG8gY29tcGFyZS4KICAgICAqIEByZXR1cm4gVGhlIHJlc3VsdCBvZiB0aGUgY29tcGFyaXNvbi4KICAgICAqLwogICAgZnVuY3Rpb24gY29tcGFyZShzbGljZSBzZWxmLCBzbGljZSBvdGhlcikgaW50ZXJuYWwgcmV0dXJucyAoaW50KSB7CiAgICAgICAgdWludCBzaG9ydGVzdCA9IHNlbGYuX2xlbjsKICAgICAgICBpZiAob3RoZXIuX2xlbiA8IHNlbGYuX2xlbikKICAgICAgICAgICAgc2hvcnRlc3QgPSBvdGhlci5fbGVuOwoKICAgICAgICB2YXIgc2VsZnB0ciA9IHNlbGYuX3B0cjsKICAgICAgICB2YXIgb3RoZXJwdHIgPSBvdGhlci5fcHRyOwogICAgICAgIGZvciAodWludCBpZHggPSAwOyBpZHggPCBzaG9ydGVzdDsgaWR4ICs9IDMyKSB7CiAgICAgICAgICAgIHVpbnQgYTsKICAgICAgICAgICAgdWludCBiOwogICAgICAgICAgICBhc3NlbWJseSB7CiAgICAgICAgICAgICAgICBhIDo9IG1sb2FkKHNlbGZwdHIpCiAgICAgICAgICAgICAgICBiIDo9IG1sb2FkKG90aGVycHRyKQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChhICE9IGIpIHsKICAgICAgICAgICAgICAgIC8vIE1hc2sgb3V0IGlycmVsZXZhbnQgYnl0ZXMgYW5kIGNoZWNrIGFnYWluCiAgICAgICAgICAgICAgICB1aW50IG1hc2sgPSB+KDIgKiogKDggKiAoMzIgLSBzaG9ydGVzdCArIGlkeCkpIC0gMSk7CiAgICAgICAgICAgICAgICB2YXIgZGlmZiA9IChhICYgbWFzaykgLSAoYiAmIG1hc2spOwogICAgICAgICAgICAgICAgaWYgKGRpZmYgIT0gMCkKICAgICAgICAgICAgICAgICAgICByZXR1cm4gaW50KGRpZmYpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHNlbGZwdHIgKz0gMzI7CiAgICAgICAgICAgIG90aGVycHRyICs9IDMyOwogICAgICAgIH0KICAgICAgICByZXR1cm4gaW50KHNlbGYuX2xlbikgLSBpbnQob3RoZXIuX2xlbik7CiAgICB9CgogICAgLyoKICAgICAqIEBkZXYgUmV0dXJucyB0cnVlIGlmIHRoZSB0d28gc2xpY2VzIGNvbnRhaW4gdGhlIHNhbWUgdGV4dC4KICAgICAqIEBwYXJhbSBzZWxmIFRoZSBmaXJzdCBzbGljZSB0byBjb21wYXJlLgogICAgICogQHBhcmFtIHNlbGYgVGhlIHNlY29uZCBzbGljZSB0byBjb21wYXJlLgogICAgICogQHJldHVybiBUcnVlIGlmIHRoZSBzbGljZXMgYXJlIGVxdWFsLCBmYWxzZSBvdGhlcndpc2UuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGVxdWFscyhzbGljZSBzZWxmLCBzbGljZSBvdGhlcikgaW50ZXJuYWwgcmV0dXJucyAoYm9vbCkgewogICAgICAgIHJldHVybiBjb21wYXJlKHNlbGYsIG90aGVyKSA9PSAwOwogICAgfQoKICAgIC8qCiAgICAgKiBAZGV2IEV4dHJhY3RzIHRoZSBmaXJzdCBydW5lIGluIHRoZSBzbGljZSBpbnRvIGBydW5lYCwgYWR2YW5jaW5nIHRoZQogICAgICogICAgICBzbGljZSB0byBwb2ludCB0byB0aGUgbmV4dCBydW5lIGFuZCByZXR1cm5pbmcgYHNlbGZgLgogICAgICogQHBhcmFtIHNlbGYgVGhlIHNsaWNlIHRvIG9wZXJhdGUgb24uCiAgICAgKiBAcGFyYW0gcnVuZSBUaGUgc2xpY2UgdGhhdCB3aWxsIGNvbnRhaW4gdGhlIGZpcnN0IHJ1bmUuCiAgICAgKiBAcmV0dXJuIGBydW5lYC4KICAgICAqLwogICAgZnVuY3Rpb24gbmV4dFJ1bmUoc2xpY2Ugc2VsZiwgc2xpY2UgcnVuZSkgaW50ZXJuYWwgcmV0dXJucyAoc2xpY2UpIHsKICAgICAgICBydW5lLl9wdHIgPSBzZWxmLl9wdHI7CgogICAgICAgIGlmIChzZWxmLl9sZW4gPT0gMCkgewogICAgICAgICAgICBydW5lLl9sZW4gPSAwOwogICAgICAgICAgICByZXR1cm4gcnVuZTsKICAgICAgICB9CgogICAgICAgIHVpbnQgbGVuOwogICAgICAgIHVpbnQgYjsKICAgICAgICAvLyBMb2FkIHRoZSBmaXJzdCBieXRlIG9mIHRoZSBydW5lIGludG8gdGhlIExTQnMgb2YgYgogICAgICAgIGFzc2VtYmx5IHsgYiA6PSBhbmQobWxvYWQoc3ViKG1sb2FkKGFkZChzZWxmLCAzMikpLCAzMSkpLCAweEZGKSB9CiAgICAgICAgaWYgKGIgPCAweDgwKSB7CiAgICAgICAgICAgIGxlbiA9IDE7CiAgICAgICAgfSBlbHNlIGlmKGIgPCAweEUwKSB7CiAgICAgICAgICAgIGxlbiA9IDI7CiAgICAgICAgfSBlbHNlIGlmKGIgPCAweEYwKSB7CiAgICAgICAgICAgIGxlbiA9IDM7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbGVuID0gNDsKICAgICAgICB9CgogICAgICAgIC8vIENoZWNrIGZvciB0cnVuY2F0ZWQgY29kZXBvaW50cwogICAgICAgIGlmIChsZW4gPiBzZWxmLl9sZW4pIHsKICAgICAgICAgICAgcnVuZS5fbGVuID0gc2VsZi5fbGVuOwogICAgICAgICAgICBzZWxmLl9wdHIgKz0gc2VsZi5fbGVuOwogICAgICAgICAgICBzZWxmLl9sZW4gPSAwOwogICAgICAgICAgICByZXR1cm4gcnVuZTsKICAgICAgICB9CgogICAgICAgIHNlbGYuX3B0ciArPSBsZW47CiAgICAgICAgc2VsZi5fbGVuIC09IGxlbjsKICAgICAgICBydW5lLl9sZW4gPSBsZW47CiAgICAgICAgcmV0dXJuIHJ1bmU7CiAgICB9CgogICAgLyoKICAgICAqIEBkZXYgUmV0dXJucyB0aGUgZmlyc3QgcnVuZSBpbiB0aGUgc2xpY2UsIGFkdmFuY2luZyB0aGUgc2xpY2UgdG8gcG9pbnQKICAgICAqICAgICAgdG8gdGhlIG5leHQgcnVuZS4KICAgICAqIEBwYXJhbSBzZWxmIFRoZSBzbGljZSB0byBvcGVyYXRlIG9uLgogICAgICogQHJldHVybiBBIHNsaWNlIGNvbnRhaW5pbmcgb25seSB0aGUgZmlyc3QgcnVuZSBmcm9tIGBzZWxmYC4KICAgICAqLwogICAgZnVuY3Rpb24gbmV4dFJ1bmUoc2xpY2Ugc2VsZikgaW50ZXJuYWwgcmV0dXJucyAoc2xpY2UgcmV0KSB7CiAgICAgICAgbmV4dFJ1bmUoc2VsZiwgcmV0KTsKICAgIH0KCiAgICAvKgogICAgICogQGRldiBSZXR1cm5zIHRoZSBudW1iZXIgb2YgdGhlIGZpcnN0IGNvZGVwb2ludCBpbiB0aGUgc2xpY2UuCiAgICAgKiBAcGFyYW0gc2VsZiBUaGUgc2xpY2UgdG8gb3BlcmF0ZSBvbi4KICAgICAqIEByZXR1cm4gVGhlIG51bWJlciBvZiB0aGUgZmlyc3QgY29kZXBvaW50IGluIHRoZSBzbGljZS4KICAgICAqLwogICAgZnVuY3Rpb24gb3JkKHNsaWNlIHNlbGYpIGludGVybmFsIHJldHVybnMgKHVpbnQgcmV0KSB7CiAgICAgICAgaWYgKHNlbGYuX2xlbiA9PSAwKSB7CiAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgIH0KCiAgICAgICAgdWludCB3b3JkOwogICAgICAgIHVpbnQgbGVuOwogICAgICAgIHVpbnQgZGl2ID0gMiAqKiAyNDg7CgogICAgICAgIC8vIExvYWQgdGhlIHJ1bmUgaW50byB0aGUgTVNCcyBvZiBiCiAgICAgICAgYXNzZW1ibHkgeyB3b3JkOj0gbWxvYWQobWxvYWQoYWRkKHNlbGYsIDMyKSkpIH0KICAgICAgICB2YXIgYiA9IHdvcmQgLyBkaXY7CiAgICAgICAgaWYgKGIgPCAweDgwKSB7CiAgICAgICAgICAgIHJldCA9IGI7CiAgICAgICAgICAgIGxlbiA9IDE7CiAgICAgICAgfSBlbHNlIGlmKGIgPCAweEUwKSB7CiAgICAgICAgICAgIHJldCA9IGIgJiAweDFGOwogICAgICAgICAgICBsZW4gPSAyOwogICAgICAgIH0gZWxzZSBpZihiIDwgMHhGMCkgewogICAgICAgICAgICByZXQgPSBiICYgMHgwRjsKICAgICAgICAgICAgbGVuID0gMzsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXQgPSBiICYgMHgwNzsKICAgICAgICAgICAgbGVuID0gNDsKICAgICAgICB9CgogICAgICAgIC8vIENoZWNrIGZvciB0cnVuY2F0ZWQgY29kZXBvaW50cwogICAgICAgIGlmIChsZW4gPiBzZWxmLl9sZW4pIHsKICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgfQoKICAgICAgICBmb3IgKHVpbnQgaSA9IDE7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgICBkaXYgPSBkaXYgLyAyNTY7CiAgICAgICAgICAgIGIgPSAod29yZCAvIGRpdikgJiAweEZGOwogICAgICAgICAgICBpZiAoYiAmIDB4QzAgIT0gMHg4MCkgewogICAgICAgICAgICAgICAgLy8gSW52YWxpZCBVVEYtOCBzZXF1ZW5jZQogICAgICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0ID0gKHJldCAqIDY0KSB8IChiICYgMHgzRik7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcmV0OwogICAgfQoKICAgIC8qCiAgICAgKiBAZGV2IFJldHVybnMgdGhlIGtlY2Nhay0yNTYgaGFzaCBvZiB0aGUgc2xpY2UuCiAgICAgKiBAcGFyYW0gc2VsZiBUaGUgc2xpY2UgdG8gaGFzaC4KICAgICAqIEByZXR1cm4gVGhlIGhhc2ggb2YgdGhlIHNsaWNlLgogICAgICovCiAgICBmdW5jdGlvbiBrZWNjYWsoc2xpY2Ugc2VsZikgaW50ZXJuYWwgcmV0dXJucyAoYnl0ZXMzMiByZXQpIHsKICAgICAgICBhc3NlbWJseSB7CiAgICAgICAgICAgIHJldCA6PSBzaGEzKG1sb2FkKGFkZChzZWxmLCAzMikpLCBtbG9hZChzZWxmKSkKICAgICAgICB9CiAgICB9CgogICAgLyoKICAgICAqIEBkZXYgUmV0dXJucyB0cnVlIGlmIGBzZWxmYCBzdGFydHMgd2l0aCBgbmVlZGxlYC4KICAgICAqIEBwYXJhbSBzZWxmIFRoZSBzbGljZSB0byBvcGVyYXRlIG9uLgogICAgICogQHBhcmFtIG5lZWRsZSBUaGUgc2xpY2UgdG8gc2VhcmNoIGZvci4KICAgICAqIEByZXR1cm4gVHJ1ZSBpZiB0aGUgc2xpY2Ugc3RhcnRzIHdpdGggdGhlIHByb3ZpZGVkIHRleHQsIGZhbHNlIG90aGVyd2lzZS4KICAgICAqLwogICAgZnVuY3Rpb24gc3RhcnRzV2l0aChzbGljZSBzZWxmLCBzbGljZSBuZWVkbGUpIGludGVybmFsIHJldHVybnMgKGJvb2wpIHsKICAgICAgICBpZiAoc2VsZi5fbGVuIDwgbmVlZGxlLl9sZW4pIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgaWYgKHNlbGYuX3B0ciA9PSBuZWVkbGUuX3B0cikgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIGJvb2wgZXF1YWw7CiAgICAgICAgYXNzZW1ibHkgewogICAgICAgICAgICBsZXQgbGVuIDo9IG1sb2FkKG5lZWRsZSkKICAgICAgICAgICAgbGV0IHNlbGZwdHIgOj0gbWxvYWQoYWRkKHNlbGYsIDB4MjApKQogICAgICAgICAgICBsZXQgbmVlZGxlcHRyIDo9IG1sb2FkKGFkZChuZWVkbGUsIDB4MjApKQogICAgICAgICAgICBlcXVhbCA6PSBlcShzaGEzKHNlbGZwdHIsIGxlbiksIHNoYTMobmVlZGxlcHRyLCBsZW4pKQogICAgICAgIH0KICAgICAgICByZXR1cm4gZXF1YWw7CiAgICB9CgogICAgLyoKICAgICAqIEBkZXYgSWYgYHNlbGZgIHN0YXJ0cyB3aXRoIGBuZWVkbGVgLCBgbmVlZGxlYCBpcyByZW1vdmVkIGZyb20gdGhlCiAgICAgKiAgICAgIGJlZ2lubmluZyBvZiBgc2VsZmAuIE90aGVyd2lzZSwgYHNlbGZgIGlzIHVubW9kaWZpZWQuCiAgICAgKiBAcGFyYW0gc2VsZiBUaGUgc2xpY2UgdG8gb3BlcmF0ZSBvbi4KICAgICAqIEBwYXJhbSBuZWVkbGUgVGhlIHNsaWNlIHRvIHNlYXJjaCBmb3IuCiAgICAgKiBAcmV0dXJuIGBzZWxmYAogICAgICovCiAgICBmdW5jdGlvbiBiZXlvbmQoc2xpY2Ugc2VsZiwgc2xpY2UgbmVlZGxlKSBpbnRlcm5hbCByZXR1cm5zIChzbGljZSkgewogICAgICAgIGlmIChzZWxmLl9sZW4gPCBuZWVkbGUuX2xlbikgewogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICB9CgogICAgICAgIGJvb2wgZXF1YWwgPSB0cnVlOwogICAgICAgIGlmIChzZWxmLl9wdHIgIT0gbmVlZGxlLl9wdHIpIHsKICAgICAgICAgICAgYXNzZW1ibHkgewogICAgICAgICAgICAgICAgbGV0IGxlbiA6PSBtbG9hZChuZWVkbGUpCiAgICAgICAgICAgICAgICBsZXQgc2VsZnB0ciA6PSBtbG9hZChhZGQoc2VsZiwgMHgyMCkpCiAgICAgICAgICAgICAgICBsZXQgbmVlZGxlcHRyIDo9IG1sb2FkKGFkZChuZWVkbGUsIDB4MjApKQogICAgICAgICAgICAgICAgZXF1YWwgOj0gZXEoc2hhMyhzZWxmcHRyLCBsZW4pLCBzaGEzKG5lZWRsZXB0ciwgbGVuKSkKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKGVxdWFsKSB7CiAgICAgICAgICAgIHNlbGYuX2xlbiAtPSBuZWVkbGUuX2xlbjsKICAgICAgICAgICAgc2VsZi5fcHRyICs9IG5lZWRsZS5fbGVuOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHNlbGY7CiAgICB9CgogICAgLyoKICAgICAqIEBkZXYgUmV0dXJucyB0cnVlIGlmIHRoZSBzbGljZSBlbmRzIHdpdGggYG5lZWRsZWAuCiAgICAgKiBAcGFyYW0gc2VsZiBUaGUgc2xpY2UgdG8gb3BlcmF0ZSBvbi4KICAgICAqIEBwYXJhbSBuZWVkbGUgVGhlIHNsaWNlIHRvIHNlYXJjaCBmb3IuCiAgICAgKiBAcmV0dXJuIFRydWUgaWYgdGhlIHNsaWNlIHN0YXJ0cyB3aXRoIHRoZSBwcm92aWRlZCB0ZXh0LCBmYWxzZSBvdGhlcndpc2UuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGVuZHNXaXRoKHNsaWNlIHNlbGYsIHNsaWNlIG5lZWRsZSkgaW50ZXJuYWwgcmV0dXJucyAoYm9vbCkgewogICAgICAgIGlmIChzZWxmLl9sZW4gPCBuZWVkbGUuX2xlbikgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICB2YXIgc2VsZnB0ciA9IHNlbGYuX3B0ciArIHNlbGYuX2xlbiAtIG5lZWRsZS5fbGVuOwoKICAgICAgICBpZiAoc2VsZnB0ciA9PSBuZWVkbGUuX3B0cikgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIGJvb2wgZXF1YWw7CiAgICAgICAgYXNzZW1ibHkgewogICAgICAgICAgICBsZXQgbGVuIDo9IG1sb2FkKG5lZWRsZSkKICAgICAgICAgICAgbGV0IG5lZWRsZXB0ciA6PSBtbG9hZChhZGQobmVlZGxlLCAweDIwKSkKICAgICAgICAgICAgZXF1YWwgOj0gZXEoc2hhMyhzZWxmcHRyLCBsZW4pLCBzaGEzKG5lZWRsZXB0ciwgbGVuKSkKICAgICAgICB9CgogICAgICAgIHJldHVybiBlcXVhbDsKICAgIH0KCiAgICAvKgogICAgICogQGRldiBJZiBgc2VsZmAgZW5kcyB3aXRoIGBuZWVkbGVgLCBgbmVlZGxlYCBpcyByZW1vdmVkIGZyb20gdGhlCiAgICAgKiAgICAgIGVuZCBvZiBgc2VsZmAuIE90aGVyd2lzZSwgYHNlbGZgIGlzIHVubW9kaWZpZWQuCiAgICAgKiBAcGFyYW0gc2VsZiBUaGUgc2xpY2UgdG8gb3BlcmF0ZSBvbi4KICAgICAqIEBwYXJhbSBuZWVkbGUgVGhlIHNsaWNlIHRvIHNlYXJjaCBmb3IuCiAgICAgKiBAcmV0dXJuIGBzZWxmYAogICAgICovCiAgICBmdW5jdGlvbiB1bnRpbChzbGljZSBzZWxmLCBzbGljZSBuZWVkbGUpIGludGVybmFsIHJldHVybnMgKHNsaWNlKSB7CiAgICAgICAgaWYgKHNlbGYuX2xlbiA8IG5lZWRsZS5fbGVuKSB7CiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIH0KCiAgICAgICAgdmFyIHNlbGZwdHIgPSBzZWxmLl9wdHIgKyBzZWxmLl9sZW4gLSBuZWVkbGUuX2xlbjsKICAgICAgICBib29sIGVxdWFsID0gdHJ1ZTsKICAgICAgICBpZiAoc2VsZnB0ciAhPSBuZWVkbGUuX3B0cikgewogICAgICAgICAgICBhc3NlbWJseSB7CiAgICAgICAgICAgICAgICBsZXQgbGVuIDo9IG1sb2FkKG5lZWRsZSkKICAgICAgICAgICAgICAgIGxldCBuZWVkbGVwdHIgOj0gbWxvYWQoYWRkKG5lZWRsZSwgMHgyMCkpCiAgICAgICAgICAgICAgICBlcXVhbCA6PSBlcShzaGEzKHNlbGZwdHIsIGxlbiksIHNoYTMobmVlZGxlcHRyLCBsZW4pKQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoZXF1YWwpIHsKICAgICAgICAgICAgc2VsZi5fbGVuIC09IG5lZWRsZS5fbGVuOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHNlbGY7CiAgICB9CgogICAgLy8gUmV0dXJucyB0aGUgbWVtb3J5IGFkZHJlc3Mgb2YgdGhlIGZpcnN0IGJ5dGUgb2YgdGhlIGZpcnN0IG9jY3VycmVuY2Ugb2YKICAgIC8vIGBuZWVkbGVgIGluIGBzZWxmYCwgb3IgdGhlIGZpcnN0IGJ5dGUgYWZ0ZXIgYHNlbGZgIGlmIG5vdCBmb3VuZC4KICAgIGZ1bmN0aW9uIGZpbmRQdHIodWludCBzZWxmbGVuLCB1aW50IHNlbGZwdHIsIHVpbnQgbmVlZGxlbGVuLCB1aW50IG5lZWRsZXB0cikgcHJpdmF0ZSByZXR1cm5zICh1aW50KSB7CiAgICAgICAgdWludCBwdHI7CiAgICAgICAgdWludCBpZHg7CgogICAgICAgIGlmIChuZWVkbGVsZW4gPD0gc2VsZmxlbikgewogICAgICAgICAgICBpZiAobmVlZGxlbGVuIDw9IDMyKSB7CiAgICAgICAgICAgICAgICAvLyBPcHRpbWl6ZWQgYXNzZW1ibHkgZm9yIDY4IGdhcyBwZXIgYnl0ZSBvbiBzaG9ydCBzdHJpbmdzCiAgICAgICAgICAgICAgICBhc3NlbWJseSB7CiAgICAgICAgICAgICAgICAgICAgbGV0IG1hc2sgOj0gbm90KHN1YihleHAoMiwgbXVsKDgsIHN1YigzMiwgbmVlZGxlbGVuKSkpLCAxKSkKICAgICAgICAgICAgICAgICAgICBsZXQgbmVlZGxlZGF0YSA6PSBhbmQobWxvYWQobmVlZGxlcHRyKSwgbWFzaykKICAgICAgICAgICAgICAgICAgICBsZXQgZW5kIDo9IGFkZChzZWxmcHRyLCBzdWIoc2VsZmxlbiwgbmVlZGxlbGVuKSkKICAgICAgICAgICAgICAgICAgICBwdHIgOj0gc2VsZnB0cgogICAgICAgICAgICAgICAgICAgIGxvb3A6CiAgICAgICAgICAgICAgICAgICAganVtcGkoZXhpdCwgZXEoYW5kKG1sb2FkKHB0ciksIG1hc2spLCBuZWVkbGVkYXRhKSkKICAgICAgICAgICAgICAgICAgICBwdHIgOj0gYWRkKHB0ciwgMSkKICAgICAgICAgICAgICAgICAgICBqdW1waShsb29wLCBsdChzdWIocHRyLCAxKSwgZW5kKSkKICAgICAgICAgICAgICAgICAgICBwdHIgOj0gYWRkKHNlbGZwdHIsIHNlbGZsZW4pCiAgICAgICAgICAgICAgICAgICAgZXhpdDoKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBwdHI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBGb3IgbG9uZyBuZWVkbGVzLCB1c2UgaGFzaGluZwogICAgICAgICAgICAgICAgYnl0ZXMzMiBoYXNoOwogICAgICAgICAgICAgICAgYXNzZW1ibHkgeyBoYXNoIDo9IHNoYTMobmVlZGxlcHRyLCBuZWVkbGVsZW4pIH0KICAgICAgICAgICAgICAgIHB0ciA9IHNlbGZwdHI7CiAgICAgICAgICAgICAgICBmb3IgKGlkeCA9IDA7IGlkeCA8PSBzZWxmbGVuIC0gbmVlZGxlbGVuOyBpZHgrKykgewogICAgICAgICAgICAgICAgICAgIGJ5dGVzMzIgdGVzdEhhc2g7CiAgICAgICAgICAgICAgICAgICAgYXNzZW1ibHkgeyB0ZXN0SGFzaCA6PSBzaGEzKHB0ciwgbmVlZGxlbGVuKSB9CiAgICAgICAgICAgICAgICAgICAgaWYgKGhhc2ggPT0gdGVzdEhhc2gpCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBwdHI7CiAgICAgICAgICAgICAgICAgICAgcHRyICs9IDE7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHNlbGZwdHIgKyBzZWxmbGVuOwogICAgfQoKICAgIC8vIFJldHVybnMgdGhlIG1lbW9yeSBhZGRyZXNzIG9mIHRoZSBmaXJzdCBieXRlIGFmdGVyIHRoZSBsYXN0IG9jY3VycmVuY2Ugb2YKICAgIC8vIGBuZWVkbGVgIGluIGBzZWxmYCwgb3IgdGhlIGFkZHJlc3Mgb2YgYHNlbGZgIGlmIG5vdCBmb3VuZC4KICAgIGZ1bmN0aW9uIHJmaW5kUHRyKHVpbnQgc2VsZmxlbiwgdWludCBzZWxmcHRyLCB1aW50IG5lZWRsZWxlbiwgdWludCBuZWVkbGVwdHIpIHByaXZhdGUgcmV0dXJucyAodWludCkgewogICAgICAgIHVpbnQgcHRyOwoKICAgICAgICBpZiAobmVlZGxlbGVuIDw9IHNlbGZsZW4pIHsKICAgICAgICAgICAgaWYgKG5lZWRsZWxlbiA8PSAzMikgewogICAgICAgICAgICAgICAgLy8gT3B0aW1pemVkIGFzc2VtYmx5IGZvciA2OSBnYXMgcGVyIGJ5dGUgb24gc2hvcnQgc3RyaW5ncwogICAgICAgICAgICAgICAgYXNzZW1ibHkgewogICAgICAgICAgICAgICAgICAgIGxldCBtYXNrIDo9IG5vdChzdWIoZXhwKDIsIG11bCg4LCBzdWIoMzIsIG5lZWRsZWxlbikpKSwgMSkpCiAgICAgICAgICAgICAgICAgICAgbGV0IG5lZWRsZWRhdGEgOj0gYW5kKG1sb2FkKG5lZWRsZXB0ciksIG1hc2spCiAgICAgICAgICAgICAgICAgICAgcHRyIDo9IGFkZChzZWxmcHRyLCBzdWIoc2VsZmxlbiwgbmVlZGxlbGVuKSkKICAgICAgICAgICAgICAgICAgICBsb29wOgogICAgICAgICAgICAgICAgICAgIGp1bXBpKHJldCwgZXEoYW5kKG1sb2FkKHB0ciksIG1hc2spLCBuZWVkbGVkYXRhKSkKICAgICAgICAgICAgICAgICAgICBwdHIgOj0gc3ViKHB0ciwgMSkKICAgICAgICAgICAgICAgICAgICBqdW1waShsb29wLCBndChhZGQocHRyLCAxKSwgc2VsZnB0cikpCiAgICAgICAgICAgICAgICAgICAgcHRyIDo9IHNlbGZwdHIKICAgICAgICAgICAgICAgICAgICBqdW1wKGV4aXQpCiAgICAgICAgICAgICAgICAgICAgcmV0OgogICAgICAgICAgICAgICAgICAgIHB0ciA6PSBhZGQocHRyLCBuZWVkbGVsZW4pCiAgICAgICAgICAgICAgICAgICAgZXhpdDoKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBwdHI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBGb3IgbG9uZyBuZWVkbGVzLCB1c2UgaGFzaGluZwogICAgICAgICAgICAgICAgYnl0ZXMzMiBoYXNoOwogICAgICAgICAgICAgICAgYXNzZW1ibHkgeyBoYXNoIDo9IHNoYTMobmVlZGxlcHRyLCBuZWVkbGVsZW4pIH0KICAgICAgICAgICAgICAgIHB0ciA9IHNlbGZwdHIgKyAoc2VsZmxlbiAtIG5lZWRsZWxlbik7CiAgICAgICAgICAgICAgICB3aGlsZSAocHRyID49IHNlbGZwdHIpIHsKICAgICAgICAgICAgICAgICAgICBieXRlczMyIHRlc3RIYXNoOwogICAgICAgICAgICAgICAgICAgIGFzc2VtYmx5IHsgdGVzdEhhc2ggOj0gc2hhMyhwdHIsIG5lZWRsZWxlbikgfQogICAgICAgICAgICAgICAgICAgIGlmIChoYXNoID09IHRlc3RIYXNoKQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcHRyICsgbmVlZGxlbGVuOwogICAgICAgICAgICAgICAgICAgIHB0ciAtPSAxOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBzZWxmcHRyOwogICAgfQoKICAgIC8qCiAgICAgKiBAZGV2IE1vZGlmaWVzIGBzZWxmYCB0byBjb250YWluIGV2ZXJ5dGhpbmcgZnJvbSB0aGUgZmlyc3Qgb2NjdXJyZW5jZSBvZgogICAgICogICAgICBgbmVlZGxlYCB0byB0aGUgZW5kIG9mIHRoZSBzbGljZS4gYHNlbGZgIGlzIHNldCB0byB0aGUgZW1wdHkgc2xpY2UKICAgICAqICAgICAgaWYgYG5lZWRsZWAgaXMgbm90IGZvdW5kLgogICAgICogQHBhcmFtIHNlbGYgVGhlIHNsaWNlIHRvIHNlYXJjaCBhbmQgbW9kaWZ5LgogICAgICogQHBhcmFtIG5lZWRsZSBUaGUgdGV4dCB0byBzZWFyY2ggZm9yLgogICAgICogQHJldHVybiBgc2VsZmAuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGZpbmQoc2xpY2Ugc2VsZiwgc2xpY2UgbmVlZGxlKSBpbnRlcm5hbCByZXR1cm5zIChzbGljZSkgewogICAgICAgIHVpbnQgcHRyID0gZmluZFB0cihzZWxmLl9sZW4sIHNlbGYuX3B0ciwgbmVlZGxlLl9sZW4sIG5lZWRsZS5fcHRyKTsKICAgICAgICBzZWxmLl9sZW4gLT0gcHRyIC0gc2VsZi5fcHRyOwogICAgICAgIHNlbGYuX3B0ciA9IHB0cjsKICAgICAgICByZXR1cm4gc2VsZjsKICAgIH0KCiAgICAvKgogICAgICogQGRldiBNb2RpZmllcyBgc2VsZmAgdG8gY29udGFpbiB0aGUgcGFydCBvZiB0aGUgc3RyaW5nIGZyb20gdGhlIHN0YXJ0IG9mCiAgICAgKiAgICAgIGBzZWxmYCB0byB0aGUgZW5kIG9mIHRoZSBmaXJzdCBvY2N1cnJlbmNlIG9mIGBuZWVkbGVgLiBJZiBgbmVlZGxlYAogICAgICogICAgICBpcyBub3QgZm91bmQsIGBzZWxmYCBpcyBzZXQgdG8gdGhlIGVtcHR5IHNsaWNlLgogICAgICogQHBhcmFtIHNlbGYgVGhlIHNsaWNlIHRvIHNlYXJjaCBhbmQgbW9kaWZ5LgogICAgICogQHBhcmFtIG5lZWRsZSBUaGUgdGV4dCB0byBzZWFyY2ggZm9yLgogICAgICogQHJldHVybiBgc2VsZmAuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHJmaW5kKHNsaWNlIHNlbGYsIHNsaWNlIG5lZWRsZSkgaW50ZXJuYWwgcmV0dXJucyAoc2xpY2UpIHsKICAgICAgICB1aW50IHB0ciA9IHJmaW5kUHRyKHNlbGYuX2xlbiwgc2VsZi5fcHRyLCBuZWVkbGUuX2xlbiwgbmVlZGxlLl9wdHIpOwogICAgICAgIHNlbGYuX2xlbiA9IHB0ciAtIHNlbGYuX3B0cjsKICAgICAgICByZXR1cm4gc2VsZjsKICAgIH0KCiAgICAvKgogICAgICogQGRldiBTcGxpdHMgdGhlIHNsaWNlLCBzZXR0aW5nIGBzZWxmYCB0byBldmVyeXRoaW5nIGFmdGVyIHRoZSBmaXJzdAogICAgICogICAgICBvY2N1cnJlbmNlIG9mIGBuZWVkbGVgLCBhbmQgYHRva2VuYCB0byBldmVyeXRoaW5nIGJlZm9yZSBpdC4gSWYKICAgICAqICAgICAgYG5lZWRsZWAgZG9lcyBub3Qgb2NjdXIgaW4gYHNlbGZgLCBgc2VsZmAgaXMgc2V0IHRvIHRoZSBlbXB0eSBzbGljZSwKICAgICAqICAgICAgYW5kIGB0b2tlbmAgaXMgc2V0IHRvIHRoZSBlbnRpcmV0eSBvZiBgc2VsZmAuCiAgICAgKiBAcGFyYW0gc2VsZiBUaGUgc2xpY2UgdG8gc3BsaXQuCiAgICAgKiBAcGFyYW0gbmVlZGxlIFRoZSB0ZXh0IHRvIHNlYXJjaCBmb3IgaW4gYHNlbGZgLgogICAgICogQHBhcmFtIHRva2VuIEFuIG91dHB1dCBwYXJhbWV0ZXIgdG8gd2hpY2ggdGhlIGZpcnN0IHRva2VuIGlzIHdyaXR0ZW4uCiAgICAgKiBAcmV0dXJuIGB0b2tlbmAuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHNwbGl0KHNsaWNlIHNlbGYsIHNsaWNlIG5lZWRsZSwgc2xpY2UgdG9rZW4pIGludGVybmFsIHJldHVybnMgKHNsaWNlKSB7CiAgICAgICAgdWludCBwdHIgPSBmaW5kUHRyKHNlbGYuX2xlbiwgc2VsZi5fcHRyLCBuZWVkbGUuX2xlbiwgbmVlZGxlLl9wdHIpOwogICAgICAgIHRva2VuLl9wdHIgPSBzZWxmLl9wdHI7CiAgICAgICAgdG9rZW4uX2xlbiA9IHB0ciAtIHNlbGYuX3B0cjsKICAgICAgICBpZiAocHRyID09IHNlbGYuX3B0ciArIHNlbGYuX2xlbikgewogICAgICAgICAgICAvLyBOb3QgZm91bmQKICAgICAgICAgICAgc2VsZi5fbGVuID0gMDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzZWxmLl9sZW4gLT0gdG9rZW4uX2xlbiArIG5lZWRsZS5fbGVuOwogICAgICAgICAgICBzZWxmLl9wdHIgPSBwdHIgKyBuZWVkbGUuX2xlbjsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRva2VuOwogICAgfQoKICAgIC8qCiAgICAgKiBAZGV2IFNwbGl0cyB0aGUgc2xpY2UsIHNldHRpbmcgYHNlbGZgIHRvIGV2ZXJ5dGhpbmcgYWZ0ZXIgdGhlIGZpcnN0CiAgICAgKiAgICAgIG9jY3VycmVuY2Ugb2YgYG5lZWRsZWAsIGFuZCByZXR1cm5pbmcgZXZlcnl0aGluZyBiZWZvcmUgaXQuIElmCiAgICAgKiAgICAgIGBuZWVkbGVgIGRvZXMgbm90IG9jY3VyIGluIGBzZWxmYCwgYHNlbGZgIGlzIHNldCB0byB0aGUgZW1wdHkgc2xpY2UsCiAgICAgKiAgICAgIGFuZCB0aGUgZW50aXJldHkgb2YgYHNlbGZgIGlzIHJldHVybmVkLgogICAgICogQHBhcmFtIHNlbGYgVGhlIHNsaWNlIHRvIHNwbGl0LgogICAgICogQHBhcmFtIG5lZWRsZSBUaGUgdGV4dCB0byBzZWFyY2ggZm9yIGluIGBzZWxmYC4KICAgICAqIEByZXR1cm4gVGhlIHBhcnQgb2YgYHNlbGZgIHVwIHRvIHRoZSBmaXJzdCBvY2N1cnJlbmNlIG9mIGBkZWxpbWAuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHNwbGl0KHNsaWNlIHNlbGYsIHNsaWNlIG5lZWRsZSkgaW50ZXJuYWwgcmV0dXJucyAoc2xpY2UgdG9rZW4pIHsKICAgICAgICBzcGxpdChzZWxmLCBuZWVkbGUsIHRva2VuKTsKICAgIH0KCiAgICAvKgogICAgICogQGRldiBTcGxpdHMgdGhlIHNsaWNlLCBzZXR0aW5nIGBzZWxmYCB0byBldmVyeXRoaW5nIGJlZm9yZSB0aGUgbGFzdAogICAgICogICAgICBvY2N1cnJlbmNlIG9mIGBuZWVkbGVgLCBhbmQgYHRva2VuYCB0byBldmVyeXRoaW5nIGFmdGVyIGl0LiBJZgogICAgICogICAgICBgbmVlZGxlYCBkb2VzIG5vdCBvY2N1ciBpbiBgc2VsZmAsIGBzZWxmYCBpcyBzZXQgdG8gdGhlIGVtcHR5IHNsaWNlLAogICAgICogICAgICBhbmQgYHRva2VuYCBpcyBzZXQgdG8gdGhlIGVudGlyZXR5IG9mIGBzZWxmYC4KICAgICAqIEBwYXJhbSBzZWxmIFRoZSBzbGljZSB0byBzcGxpdC4KICAgICAqIEBwYXJhbSBuZWVkbGUgVGhlIHRleHQgdG8gc2VhcmNoIGZvciBpbiBgc2VsZmAuCiAgICAgKiBAcGFyYW0gdG9rZW4gQW4gb3V0cHV0IHBhcmFtZXRlciB0byB3aGljaCB0aGUgZmlyc3QgdG9rZW4gaXMgd3JpdHRlbi4KICAgICAqIEByZXR1cm4gYHRva2VuYC4KICAgICAqLwogICAgZnVuY3Rpb24gcnNwbGl0KHNsaWNlIHNlbGYsIHNsaWNlIG5lZWRsZSwgc2xpY2UgdG9rZW4pIGludGVybmFsIHJldHVybnMgKHNsaWNlKSB7CiAgICAgICAgdWludCBwdHIgPSByZmluZFB0cihzZWxmLl9sZW4sIHNlbGYuX3B0ciwgbmVlZGxlLl9sZW4sIG5lZWRsZS5fcHRyKTsKICAgICAgICB0b2tlbi5fcHRyID0gcHRyOwogICAgICAgIHRva2VuLl9sZW4gPSBzZWxmLl9sZW4gLSAocHRyIC0gc2VsZi5fcHRyKTsKICAgICAgICBpZiAocHRyID09IHNlbGYuX3B0cikgewogICAgICAgICAgICAvLyBOb3QgZm91bmQKICAgICAgICAgICAgc2VsZi5fbGVuID0gMDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzZWxmLl9sZW4gLT0gdG9rZW4uX2xlbiArIG5lZWRsZS5fbGVuOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdG9rZW47CiAgICB9CgogICAgLyoKICAgICAqIEBkZXYgU3BsaXRzIHRoZSBzbGljZSwgc2V0dGluZyBgc2VsZmAgdG8gZXZlcnl0aGluZyBiZWZvcmUgdGhlIGxhc3QKICAgICAqICAgICAgb2NjdXJyZW5jZSBvZiBgbmVlZGxlYCwgYW5kIHJldHVybmluZyBldmVyeXRoaW5nIGFmdGVyIGl0LiBJZgogICAgICogICAgICBgbmVlZGxlYCBkb2VzIG5vdCBvY2N1ciBpbiBgc2VsZmAsIGBzZWxmYCBpcyBzZXQgdG8gdGhlIGVtcHR5IHNsaWNlLAogICAgICogICAgICBhbmQgdGhlIGVudGlyZXR5IG9mIGBzZWxmYCBpcyByZXR1cm5lZC4KICAgICAqIEBwYXJhbSBzZWxmIFRoZSBzbGljZSB0byBzcGxpdC4KICAgICAqIEBwYXJhbSBuZWVkbGUgVGhlIHRleHQgdG8gc2VhcmNoIGZvciBpbiBgc2VsZmAuCiAgICAgKiBAcmV0dXJuIFRoZSBwYXJ0IG9mIGBzZWxmYCBhZnRlciB0aGUgbGFzdCBvY2N1cnJlbmNlIG9mIGBkZWxpbWAuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHJzcGxpdChzbGljZSBzZWxmLCBzbGljZSBuZWVkbGUpIGludGVybmFsIHJldHVybnMgKHNsaWNlIHRva2VuKSB7CiAgICAgICAgcnNwbGl0KHNlbGYsIG5lZWRsZSwgdG9rZW4pOwogICAgfQoKICAgIC8qCiAgICAgKiBAZGV2IENvdW50cyB0aGUgbnVtYmVyIG9mIG5vbm92ZXJsYXBwaW5nIG9jY3VycmVuY2VzIG9mIGBuZWVkbGVgIGluIGBzZWxmYC4KICAgICAqIEBwYXJhbSBzZWxmIFRoZSBzbGljZSB0byBzZWFyY2guCiAgICAgKiBAcGFyYW0gbmVlZGxlIFRoZSB0ZXh0IHRvIHNlYXJjaCBmb3IgaW4gYHNlbGZgLgogICAgICogQHJldHVybiBUaGUgbnVtYmVyIG9mIG9jY3VycmVuY2VzIG9mIGBuZWVkbGVgIGZvdW5kIGluIGBzZWxmYC4KICAgICAqLwogICAgZnVuY3Rpb24gY291bnQoc2xpY2Ugc2VsZiwgc2xpY2UgbmVlZGxlKSBpbnRlcm5hbCByZXR1cm5zICh1aW50IGNvdW50KSB7CiAgICAgICAgdWludCBwdHIgPSBmaW5kUHRyKHNlbGYuX2xlbiwgc2VsZi5fcHRyLCBuZWVkbGUuX2xlbiwgbmVlZGxlLl9wdHIpICsgbmVlZGxlLl9sZW47CiAgICAgICAgd2hpbGUgKHB0ciA8PSBzZWxmLl9wdHIgKyBzZWxmLl9sZW4pIHsKICAgICAgICAgICAgY291bnQrKzsKICAgICAgICAgICAgcHRyID0gZmluZFB0cihzZWxmLl9sZW4gLSAocHRyIC0gc2VsZi5fcHRyKSwgcHRyLCBuZWVkbGUuX2xlbiwgbmVlZGxlLl9wdHIpICsgbmVlZGxlLl9sZW47CiAgICAgICAgfQogICAgfQoKICAgIC8qCiAgICAgKiBAZGV2IFJldHVybnMgVHJ1ZSBpZiBgc2VsZmAgY29udGFpbnMgYG5lZWRsZWAuCiAgICAgKiBAcGFyYW0gc2VsZiBUaGUgc2xpY2UgdG8gc2VhcmNoLgogICAgICogQHBhcmFtIG5lZWRsZSBUaGUgdGV4dCB0byBzZWFyY2ggZm9yIGluIGBzZWxmYC4KICAgICAqIEByZXR1cm4gVHJ1ZSBpZiBgbmVlZGxlYCBpcyBmb3VuZCBpbiBgc2VsZmAsIGZhbHNlIG90aGVyd2lzZS4KICAgICAqLwogICAgZnVuY3Rpb24gY29udGFpbnMoc2xpY2Ugc2VsZiwgc2xpY2UgbmVlZGxlKSBpbnRlcm5hbCByZXR1cm5zIChib29sKSB7CiAgICAgICAgcmV0dXJuIHJmaW5kUHRyKHNlbGYuX2xlbiwgc2VsZi5fcHRyLCBuZWVkbGUuX2xlbiwgbmVlZGxlLl9wdHIpICE9IHNlbGYuX3B0cjsKICAgIH0KCiAgICAvKgogICAgICogQGRldiBSZXR1cm5zIGEgbmV3bHkgYWxsb2NhdGVkIHN0cmluZyBjb250YWluaW5nIHRoZSBjb25jYXRlbmF0aW9uIG9mCiAgICAgKiAgICAgIGBzZWxmYCBhbmQgYG90aGVyYC4KICAgICAqIEBwYXJhbSBzZWxmIFRoZSBmaXJzdCBzbGljZSB0byBjb25jYXRlbmF0ZS4KICAgICAqIEBwYXJhbSBvdGhlciBUaGUgc2Vjb25kIHNsaWNlIHRvIGNvbmNhdGVuYXRlLgogICAgICogQHJldHVybiBUaGUgY29uY2F0ZW5hdGlvbiBvZiB0aGUgdHdvIHN0cmluZ3MuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNvbmNhdChzbGljZSBzZWxmLCBzbGljZSBvdGhlcikgaW50ZXJuYWwgcmV0dXJucyAoc3RyaW5nKSB7CiAgICAgICAgdmFyIHJldCA9IG5ldyBzdHJpbmcoc2VsZi5fbGVuICsgb3RoZXIuX2xlbik7CiAgICAgICAgdWludCByZXRwdHI7CiAgICAgICAgYXNzZW1ibHkgeyByZXRwdHIgOj0gYWRkKHJldCwgMzIpIH0KICAgICAgICBtZW1jcHkocmV0cHRyLCBzZWxmLl9wdHIsIHNlbGYuX2xlbik7CiAgICAgICAgbWVtY3B5KHJldHB0ciArIHNlbGYuX2xlbiwgb3RoZXIuX3B0ciwgb3RoZXIuX2xlbik7CiAgICAgICAgcmV0dXJuIHJldDsKICAgIH0KCiAgICAvKgogICAgICogQGRldiBKb2lucyBhbiBhcnJheSBvZiBzbGljZXMsIHVzaW5nIGBzZWxmYCBhcyBhIGRlbGltaXRlciwgcmV0dXJuaW5nIGEKICAgICAqICAgICAgbmV3bHkgYWxsb2NhdGVkIHN0cmluZy4KICAgICAqIEBwYXJhbSBzZWxmIFRoZSBkZWxpbWl0ZXIgdG8gdXNlLgogICAgICogQHBhcmFtIHBhcnRzIEEgbGlzdCBvZiBzbGljZXMgdG8gam9pbi4KICAgICAqIEByZXR1cm4gQSBuZXdseSBhbGxvY2F0ZWQgc3RyaW5nIGNvbnRhaW5pbmcgYWxsIHRoZSBzbGljZXMgaW4gYHBhcnRzYCwKICAgICAqICAgICAgICAgam9pbmVkIHdpdGggYHNlbGZgLgogICAgICovCiAgICBmdW5jdGlvbiBqb2luKHNsaWNlIHNlbGYsIHNsaWNlW10gcGFydHMpIGludGVybmFsIHJldHVybnMgKHN0cmluZykgewogICAgICAgIGlmIChwYXJ0cy5sZW5ndGggPT0gMCkKICAgICAgICAgICAgcmV0dXJuICIiOwoKICAgICAgICB1aW50IGxlbiA9IHNlbGYuX2xlbiAqIChwYXJ0cy5sZW5ndGggLSAxKTsKICAgICAgICBmb3IodWludCBpID0gMDsgaSA8IHBhcnRzLmxlbmd0aDsgaSsrKQogICAgICAgICAgICBsZW4gKz0gcGFydHNbaV0uX2xlbjsKCiAgICAgICAgdmFyIHJldCA9IG5ldyBzdHJpbmcobGVuKTsKICAgICAgICB1aW50IHJldHB0cjsKICAgICAgICBhc3NlbWJseSB7IHJldHB0ciA6PSBhZGQocmV0LCAzMikgfQoKICAgICAgICBmb3IoaSA9IDA7IGkgPCBwYXJ0cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBtZW1jcHkocmV0cHRyLCBwYXJ0c1tpXS5fcHRyLCBwYXJ0c1tpXS5fbGVuKTsKICAgICAgICAgICAgcmV0cHRyICs9IHBhcnRzW2ldLl9sZW47CiAgICAgICAgICAgIGlmIChpIDwgcGFydHMubGVuZ3RoIC0gMSkgewogICAgICAgICAgICAgICAgbWVtY3B5KHJldHB0ciwgc2VsZi5fcHRyLCBzZWxmLl9sZW4pOwogICAgICAgICAgICAgICAgcmV0cHRyICs9IHNlbGYuX2xlbjsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHJldDsKICAgIH0KfQoKCmNvbnRyYWN0IERTU2FmZUFkZFN1YiB7CiAgICBmdW5jdGlvbiBzYWZlVG9BZGQodWludCBhLCB1aW50IGIpIGludGVybmFsIHJldHVybnMgKGJvb2wpIHsKICAgICAgICByZXR1cm4gKGEgKyBiID49IGEpOwogICAgfQogICAgZnVuY3Rpb24gc2FmZUFkZCh1aW50IGEsIHVpbnQgYikgaW50ZXJuYWwgcmV0dXJucyAodWludCkgewogICAgICAgIGlmICghc2FmZVRvQWRkKGEsIGIpKSB0aHJvdzsKICAgICAgICByZXR1cm4gYSArIGI7CiAgICB9CgogICAgZnVuY3Rpb24gc2FmZVRvU3VidHJhY3QodWludCBhLCB1aW50IGIpIGludGVybmFsIHJldHVybnMgKGJvb2wpIHsKICAgICAgICByZXR1cm4gKGIgPD0gYSk7CiAgICB9CgogICAgZnVuY3Rpb24gc2FmZVN1Yih1aW50IGEsIHVpbnQgYikgaW50ZXJuYWwgcmV0dXJucyAodWludCkgewogICAgICAgIGlmICghc2FmZVRvU3VidHJhY3QoYSwgYikpIHRocm93OwogICAgICAgIHJldHVybiBhIC0gYjsKICAgIH0gCn0KCgoKY29udHJhY3QgRXRoZXJvbGwgaXMgdXNpbmdPcmFjbGl6ZSwgRFNTYWZlQWRkU3ViIHsKICAgIAogICAgIHVzaW5nIHN0cmluZ3MgZm9yICo7CgogICAgLyoKICAgICAqIGNoZWNrcyBwbGF5ZXIgcHJvZml0LCBiZXQgc2l6ZSBhbmQgcGxheWVyIG51bWJlciBpcyB3aXRoaW4gcmFuZ2UKICAgICovCiAgICBtb2RpZmllciBiZXRJc1ZhbGlkKHVpbnQgX2JldFNpemUsIHVpbnQgX3BsYXllck51bWJlcikgeyAgICAgIAogICAgICAgIGlmKCgoKChfYmV0U2l6ZSAqICgxMDAtKHNhZmVTdWIoX3BsYXllck51bWJlciwxKSkpKSAvIChzYWZlU3ViKF9wbGF5ZXJOdW1iZXIsMSkpK19iZXRTaXplKSkqaG91c2VFZGdlL2hvdXNlRWRnZURpdmlzb3IpLV9iZXRTaXplID4gbWF4UHJvZml0IHx8IF9iZXRTaXplIDwgbWluQmV0IHx8IF9wbGF5ZXJOdW1iZXIgPCBtaW5OdW1iZXIgfHwgX3BsYXllck51bWJlciA+IG1heE51bWJlcikgdGhyb3c7ICAgICAgICAKCQlfOwogICAgfQoKICAgIC8qCiAgICAgKiBjaGVja3MgZ2FtZSBpcyBjdXJyZW50bHkgYWN0aXZlCiAgICAqLwogICAgbW9kaWZpZXIgZ2FtZUlzQWN0aXZlIHsKICAgICAgICBpZihnYW1lUGF1c2VkID09IHRydWUpIHRocm93OwoJCV87CiAgICB9ICAgIAoKICAgIC8qCiAgICAgKiBjaGVja3MgcGF5b3V0cyBhcmUgY3VycmVudGx5IGFjdGl2ZQogICAgKi8KICAgIG1vZGlmaWVyIHBheW91dHNBcmVBY3RpdmUgewogICAgICAgIGlmKHBheW91dHNQYXVzZWQgPT0gdHJ1ZSkgdGhyb3c7CgkJXzsKICAgIH0gICAgCgogICAgLyoKICAgICAqIGNoZWNrcyBvbmx5IE9yYWNsaXplIGFkZHJlc3MgaXMgY2FsbGluZwogICAgKi8KICAgIG1vZGlmaWVyIG9ubHlPcmFjbGl6ZSB7CiAgICAgICAgaWYgKG1zZy5zZW5kZXIgIT0gb3JhY2xpemVfY2JBZGRyZXNzKCkpIHRocm93OwogICAgICAgIF87CiAgICB9CgogICAgLyoKICAgICAqIGNoZWNrcyBvbmx5IG93bmVyIGFkZHJlc3MgaXMgY2FsbGluZwogICAgKi8KICAgIG1vZGlmaWVyIG9ubHlPd25lciB7CiAgICAgICAgIGlmIChtc2cuc2VuZGVyICE9IG93bmVyKSB0aHJvdzsKICAgICAgICAgXzsKICAgIH0KCiAgICAvKgogICAgICogY2hlY2tzIG9ubHkgdHJlYXN1cnkgYWRkcmVzcyBpcyBjYWxsaW5nCiAgICAqLwogICAgbW9kaWZpZXIgb25seVRyZWFzdXJ5IHsKICAgICAgICAgaWYgKG1zZy5zZW5kZXIgIT0gdHJlYXN1cnkpIHRocm93OwogICAgICAgICBfOwogICAgfSAgICAKCiAgICAvKgogICAgICogZ2FtZSB2YXJzCiAgICAqLyAKICAgIHVpbnQgY29uc3RhbnQgcHVibGljIG1heFByb2ZpdERpdmlzb3IgPSAxMDAwMDAwOwogICAgdWludCBjb25zdGFudCBwdWJsaWMgaG91c2VFZGdlRGl2aXNvciA9IDEwMDA7ICAgIAogICAgdWludCBjb25zdGFudCBwdWJsaWMgbWF4TnVtYmVyID0gOTk7IAogICAgdWludCBjb25zdGFudCBwdWJsaWMgbWluTnVtYmVyID0gMjsKCWJvb2wgcHVibGljIGdhbWVQYXVzZWQ7CiAgICB1aW50MzIgcHVibGljIGdhc0Zvck9yYWNsaXplOwogICAgYWRkcmVzcyBwdWJsaWMgb3duZXI7CiAgICBib29sIHB1YmxpYyBwYXlvdXRzUGF1c2VkOyAKICAgIGFkZHJlc3MgcHVibGljIHRyZWFzdXJ5OwogICAgdWludCBwdWJsaWMgY29udHJhY3RCYWxhbmNlOwogICAgdWludCBwdWJsaWMgaG91c2VFZGdlOyAgICAgCiAgICB1aW50IHB1YmxpYyBtYXhQcm9maXQ7ICAgCiAgICB1aW50IHB1YmxpYyBtYXhQcm9maXRBc1BlcmNlbnRPZkhvdXNlOyAgICAgICAgICAgICAgICAgICAgCiAgICB1aW50IHB1YmxpYyBtaW5CZXQ7ICAgICAgIAogICAgaW50IHB1YmxpYyB0b3RhbEJldHM7CiAgICB1aW50IHB1YmxpYyBtYXhQZW5kaW5nUGF5b3V0czsKICAgIHVpbnQgcHVibGljIGNvc3RUb0NhbGxPcmFjbGl6ZUluV2VpOwogICAgdWludCBwdWJsaWMgdG90YWxXZWlXb247CgogICAgLyoKICAgICAqIHBsYXllciB2YXJzCiAgICAqLwogICAgbWFwcGluZyAoYnl0ZXMzMiA9PiBhZGRyZXNzKSBwbGF5ZXJBZGRyZXNzOwogICAgbWFwcGluZyAoYnl0ZXMzMiA9PiBhZGRyZXNzKSBwbGF5ZXJUZW1wQWRkcmVzczsKICAgIG1hcHBpbmcgKGJ5dGVzMzIgPT4gYnl0ZXMzMikgcGxheWVyQmV0SWQ7CiAgICBtYXBwaW5nIChieXRlczMyID0+IHVpbnQpIHBsYXllckJldFZhbHVlOwogICAgbWFwcGluZyAoYnl0ZXMzMiA9PiB1aW50KSBwbGF5ZXJUZW1wQmV0VmFsdWU7ICAKICAgIG1hcHBpbmcgKGJ5dGVzMzIgPT4gdWludCkgcGxheWVyUmFuZG9tUmVzdWx0OyAgICAgCiAgICBtYXBwaW5nIChieXRlczMyID0+IHVpbnQpIHBsYXllckRpZVJlc3VsdDsKICAgIG1hcHBpbmcgKGJ5dGVzMzIgPT4gdWludCkgcGxheWVyTnVtYmVyOwogICAgbWFwcGluZyAoYWRkcmVzcyA9PiB1aW50KSBwbGF5ZXJQZW5kaW5nV2l0aGRyYXdhbHM7ICAgICAgCiAgICBtYXBwaW5nIChieXRlczMyID0+IHVpbnQpIHBsYXllclByb2ZpdDsKICAgIG1hcHBpbmcgKGJ5dGVzMzIgPT4gdWludCkgcGxheWVyVGVtcFJld2FyZDsgICAgCiAgICAgICAgCgogICAgLyoKICAgICAqIGV2ZW50cwogICAgKi8KICAgIC8qIGxvZyBiZXRzICsgb3V0cHV0IHRvIHdlYjMgZm9yIHByZWNpc2UgJ3BheW91dCBvbiB3aW4nIGZpZWxkIGluIFVJICovCiAgICBldmVudCBMb2dCZXQoYnl0ZXMzMiBpbmRleGVkIEJldElELCBhZGRyZXNzIGluZGV4ZWQgUGxheWVyQWRkcmVzcywgdWludCBpbmRleGVkIFJld2FyZFZhbHVlLCB1aW50IFByb2ZpdFZhbHVlLCB1aW50IEJldFZhbHVlLCB1aW50IFBsYXllck51bWJlcik7ICAgICAgCiAgICAvKiBvdXRwdXQgdG8gd2ViMyBVSSBvbiBiZXQgcmVzdWx0Ki8KICAgIC8qIFN0YXR1czogMD1sb3NlLCAxPXdpbiwgMj13aW4gKyBmYWlsZWQgc2VuZCwgMz1yZWZ1bmQsIDQ9cmVmdW5kICsgZmFpbGVkIHNlbmQqLwoJZXZlbnQgTG9nUmVzdWx0KHVpbnQgaW5kZXhlZCBSZXN1bHRTZXJpYWxOdW1iZXIsIGJ5dGVzMzIgaW5kZXhlZCBCZXRJRCwgYWRkcmVzcyBpbmRleGVkIFBsYXllckFkZHJlc3MsIHVpbnQgUGxheWVyTnVtYmVyLCB1aW50IERpY2VSZXN1bHQsIHVpbnQgVmFsdWUsIGludCBTdGF0dXMsIGJ5dGVzIFByb29mKTsgICAKICAgIC8qIGxvZyBtYW51YWwgcmVmdW5kcyAqLwogICAgZXZlbnQgTG9nUmVmdW5kKGJ5dGVzMzIgaW5kZXhlZCBCZXRJRCwgYWRkcmVzcyBpbmRleGVkIFBsYXllckFkZHJlc3MsIHVpbnQgaW5kZXhlZCBSZWZ1bmRWYWx1ZSk7CiAgICAvKiBsb2cgb3duZXIgdHJhbnNmZXJzICovCiAgICBldmVudCBMb2dPd25lclRyYW5zZmVyKGFkZHJlc3MgaW5kZXhlZCBTZW50VG9BZGRyZXNzLCB1aW50IGluZGV4ZWQgQW1vdW50VHJhbnNmZXJyZWQpOyAgICAgICAgICAgICAgIAoKCiAgICAvKgogICAgICogaW5pdAogICAgKi8KICAgIGZ1bmN0aW9uIEV0aGVyb2xsKCkgewoKICAgICAgICBvd25lciA9IG1zZy5zZW5kZXI7CiAgICAgICAgdHJlYXN1cnkgPSBtc2cuc2VuZGVyOwogICAgICAgIAogICAgICAgIG9yYWNsaXplX3NldE5ldHdvcmsobmV0d29ya0lEX2F1dG8pOyAgICAgICAgCiAgICAgICAgLyogdXNlIFRMU05vdGFyeSBmb3Igb3JhY2xpemUgY2FsbCAqLwoJCW9yYWNsaXplX3NldFByb29mKHByb29mVHlwZV9UTFNOb3RhcnkgfCBwcm9vZlN0b3JhZ2VfSVBGUyk7CiAgICAgICAgLyogaW5pdCA5OTAgPSA5OSUgKDElIGhvdXNlRWRnZSkqLwogICAgICAgIG93bmVyU2V0SG91c2VFZGdlKDk5MCk7CiAgICAgICAgLyogaW5pdCAxMCwwMDAgPSAxJSAgKi8KICAgICAgICBvd25lclNldE1heFByb2ZpdEFzUGVyY2VudE9mSG91c2UoMTAwMDApOwogICAgICAgIC8qIGluaXQgbWluIGJldCAoMC4xIGV0aGVyKSAqLwogICAgICAgIG93bmVyU2V0TWluQmV0KDEwMDAwMDAwMDAwMDAwMDAwMCk7ICAgICAgICAKICAgICAgICAvKiBpbml0IGdhcyBmb3Igb3JhY2xpemUgKi8gICAgICAgIAogICAgICAgIGdhc0Zvck9yYWNsaXplID0gMjUwMDAwOyAgICAgICAgCgogICAgfQoKICAgIC8qCiAgICAgKiBwdWJsaWMgZnVuY3Rpb24KICAgICAqIHBsYXllciBzdWJtaXQgYmV0CiAgICAgKiBvbmx5IGlmIGdhbWUgaXMgYWN0aXZlICYgYmV0IGlzIHZhbGlkIGNhbiBxdWVyeSBvcmFjbGl6ZSBhbmQgc2V0IHBsYXllciB2YXJzICAgICAKICAgICovCiAgICBmdW5jdGlvbiBwbGF5ZXJSb2xsRGljZSh1aW50IHJvbGxVbmRlcikgcHVibGljIAogICAgICAgIHBheWFibGUKICAgICAgICBnYW1lSXNBY3RpdmUKICAgICAgICBiZXRJc1ZhbGlkKG1zZy52YWx1ZSwgcm9sbFVuZGVyKQoJeyAgICAgICAgCiAgICAgICAgCiAgICAgICAgLyoKICAgICAgICAqIGFzc2lnbiBwYXJ0aWFsbHkgZW5jcnlwdGVkIHF1ZXJ5IHRvIG9yYWNsaXplCiAgICAgICAgKiBvbmx5IHRoZSBhcGlLZXkgaXMgZW5jcnlwdGVkIAogICAgICAgICogaW50ZWdlciBxdWVyeSBpcyBpbiBwbGFpbiB0ZXh0CiAgICAgICAgKi8KICAgICAgICBieXRlczMyIHJuZ0lkID0gb3JhY2xpemVfcXVlcnkoIm5lc3RlZCIsICJbVVJMXSBbJ2pzb24oaHR0cHM6Ly9hcGkucmFuZG9tLm9yZy9qc29uLXJwYy8xL2ludm9rZSkucmVzdWx0LnJhbmRvbVtcInNlcmlhbE51bWJlclwiLFwiZGF0YVwiXScsICdcXG57XCJqc29ucnBjXCI6XCIyLjBcIixcIm1ldGhvZFwiOlwiZ2VuZXJhdGVTaWduZWRJbnRlZ2Vyc1wiLFwicGFyYW1zXCI6e1wiYXBpS2V5XCI6JHtbZGVjcnlwdF0gQkErcytsVWhycGFndmRJSXNiN0diTjh4RTE5M1NIbHNKUTNYcXppM255VldZYktBelE0bmZKRGlOdmU5SUk2NzlaeDRoQjJCSG5Lc1ZkQllxaUtnQ1M5SDBkbFdlZDlsSEh0QW5GSVZ1TDgrdGpSVXZlbFBRVjBRWFFCbnp4ektzcWE3bkwxRHdIcVhteXBqUkYzSDRsL2lsd05OTEtjPX0sXCJuXCI6MSxcIm1pblwiOjEsXCJtYXhcIjoxMDAsXCJyZXBsYWNlbWVudFwiOnRydWUsXCJiYXNlXCI6MTAke1tpZGVudGl0eV0gXCJ9XCJ9LFwiaWRcIjoxJHtbaWRlbnRpdHldIFwifVwifSddIiwgZ2FzRm9yT3JhY2xpemUpOwogICAgICAgIAogICAgICAgIC8qIHNhZmVseSB1cGRhdGUgY29udHJhY3QgYmFsYW5jZSB0byBhY2NvdW50IGZvciBjb3N0IHRvIGNhbGwgb3JhY2xpemUqLwogICAgICAgIGNvbnRyYWN0QmFsYW5jZSA9IHNhZmVTdWIoY29udHJhY3RCYWxhbmNlLCBjb3N0VG9DYWxsT3JhY2xpemVJbldlaSk7CSAgICAgICAgCiAgICAgICAgLyogdG90YWwgbnVtYmVyIG9mIGJldHMgKi8KICAgICAgICB0b3RhbEJldHMgKz0gMTsKICAgICAgICAvKiBtYXAgYmV0IGlkIHRvIHRoaXMgb3JhY2xpemUgcXVlcnkgKi8KCQlwbGF5ZXJCZXRJZFtybmdJZF0gPSBybmdJZDsKICAgICAgICAvKiBtYXAgcGxheWVyIGx1Y2t5IG51bWJlciB0byB0aGlzIG9yYWNsaXplIHF1ZXJ5ICovCgkJcGxheWVyTnVtYmVyW3JuZ0lkXSA9IHJvbGxVbmRlcjsKICAgICAgICAvKiBtYXAgdmFsdWUgb2Ygd2FnZXIgdG8gdGhpcyBvcmFjbGl6ZSBxdWVyeSAqLwogICAgICAgIHBsYXllckJldFZhbHVlW3JuZ0lkXSA9IG1zZy52YWx1ZTsKICAgICAgICAvKiBtYXAgcGxheWVyIGFkZHJlc3MgdG8gdGhpcyBvcmFjbGl6ZSBxdWVyeSAqLwogICAgICAgIHBsYXllckFkZHJlc3Nbcm5nSWRdID0gbXNnLnNlbmRlcjsKICAgICAgICAvKiBzYWZlbHkgbWFwIHBsYXllciBwcm9maXQgdG8gdGhpcyBvcmFjbGl6ZSBxdWVyeSAqLyAgICAgICAgICAgICAgICAgICAgIAogICAgICAgIHBsYXllclByb2ZpdFtybmdJZF0gPSAoKCgobXNnLnZhbHVlICogKDEwMC0oc2FmZVN1Yihyb2xsVW5kZXIsMSkpKSkgLyAoc2FmZVN1Yihyb2xsVW5kZXIsMSkpK21zZy52YWx1ZSkpKmhvdXNlRWRnZS9ob3VzZUVkZ2VEaXZpc29yKS1tc2cudmFsdWU7ICAgICAgICAKICAgICAgICAvKiBzYWZlbHkgaW5jcmVhc2UgbWF4UGVuZGluZ1BheW91dHMgbGlhYmlsaXR5IC0gY2FsYyBhbGwgcGVuZGluZyBwYXlvdXRzIHVuZGVyIGFzc3VtcHRpb24gdGhleSB3aW4gKi8KICAgICAgICBtYXhQZW5kaW5nUGF5b3V0cyA9IHNhZmVBZGQobWF4UGVuZGluZ1BheW91dHMsIHBsYXllclByb2ZpdFtybmdJZF0pOwogICAgICAgIC8qIGNoZWNrIGNvbnRyYWN0IGNhbiBwYXlvdXQgb24gd2luICovCiAgICAgICAgaWYobWF4UGVuZGluZ1BheW91dHMgPj0gY29udHJhY3RCYWxhbmNlKSB0aHJvdzsKICAgICAgICAvKiBwcm92aWRlcyBhY2N1cmF0ZSBudW1iZXJzIGZvciB3ZWIzIGFuZCBhbGxvd3MgZm9yIG1hbnVhbCByZWZ1bmRzIGluIGNhc2Ugb2Ygbm8gb3JhY2xpemUgX19jYWxsYmFjayAqLwogICAgICAgIExvZ0JldChwbGF5ZXJCZXRJZFtybmdJZF0sIHBsYXllckFkZHJlc3Nbcm5nSWRdLCBzYWZlQWRkKHBsYXllckJldFZhbHVlW3JuZ0lkXSwgcGxheWVyUHJvZml0W3JuZ0lkXSksIHBsYXllclByb2ZpdFtybmdJZF0sIHBsYXllckJldFZhbHVlW3JuZ0lkXSwgcGxheWVyTnVtYmVyW3JuZ0lkXSk7ICAgICAgICAgIAoKICAgIH0gICAKICAgICAgICAgICAgIAoKICAgIC8qCiAgICAqIHNlbWktcHVibGljIGZ1bmN0aW9uIC0gb25seSBvcmFjbGl6ZSBjYW4gY2FsbAogICAgKi8KICAgIC8qVExTTm90YXJ5IGZvciBvcmFjbGl6ZSBjYWxsICovCglmdW5jdGlvbiBfX2NhbGxiYWNrKGJ5dGVzMzIgbXlpZCwgc3RyaW5nIHJlc3VsdCwgYnl0ZXMgcHJvb2YpIHB1YmxpYyAgIAoJCW9ubHlPcmFjbGl6ZQoJCXBheW91dHNBcmVBY3RpdmUKCXsgIAoKICAgICAgICAvKiBwbGF5ZXIgYWRkcmVzcyBtYXBwZWQgdG8gcXVlcnkgaWQgZG9lcyBub3QgZXhpc3QgKi8KICAgICAgICBpZiAocGxheWVyQWRkcmVzc1tteWlkXT09MHgwKSB0aHJvdzsKICAgICAgICAKICAgICAgICAvKiBrZWVwIG9yYWNsaXplIGhvbmVzdCBieSByZXRyaWV2aW5nIHRoZSBzZXJpYWxOdW1iZXIgZnJvbSByYW5kb20ub3JnIHJlc3VsdCAqLwogICAgICAgIHZhciBzbF9yZXN1bHQgPSByZXN1bHQudG9TbGljZSgpOwogICAgICAgIHNsX3Jlc3VsdC5iZXlvbmQoIlsiLnRvU2xpY2UoKSkudW50aWwoIl0iLnRvU2xpY2UoKSk7CiAgICAgICAgdWludCBzZXJpYWxOdW1iZXJPZlJlc3VsdCA9IHBhcnNlSW50KHNsX3Jlc3VsdC5zcGxpdCgnLCAnLnRvU2xpY2UoKSkudG9TdHJpbmcoKSk7ICAgICAgICAgIAoKCSAgICAvKiBtYXAgcmVzdWx0IHRvIHBsYXllciAqLwogICAgICAgIHBsYXllclJhbmRvbVJlc3VsdFtteWlkXSA9IHBhcnNlSW50KHNsX3Jlc3VsdC5iZXlvbmQoIlsiLnRvU2xpY2UoKSkudW50aWwoIl0iLnRvU2xpY2UoKSkudG9TdHJpbmcoKSk7CiAgICAgICAgCiAgICAgICAgLyogcHJvZHVjZSBpbnRlZ2VyIGJvdW5kZWQgdG8gMS0xMDAgaW5jbHVzaXZlCiAgICAgICAgKiAgdmlhIHNoYTMgcmVzdWx0IGZyb20gcmFuZG9tLm9yZyBhbmQgcHJvb2YgKElQRlMgYWRkcmVzcyBvZiBUTFNOb3RhcnkgcHJvb2YpCiAgICAgICAgKi8KICAgICAgICBwbGF5ZXJEaWVSZXN1bHRbbXlpZF0gPSB1aW50KHNoYTMocGxheWVyUmFuZG9tUmVzdWx0W215aWRdLCBwcm9vZikpICUgMTAwICsgMTsKICAgICAgICAKICAgICAgICAvKiBnZXQgdGhlIHBsYXllckFkZHJlc3MgZm9yIHRoaXMgcXVlcnkgaWQgKi8KICAgICAgICBwbGF5ZXJUZW1wQWRkcmVzc1tteWlkXSA9IHBsYXllckFkZHJlc3NbbXlpZF07CiAgICAgICAgLyogZGVsZXRlIHBsYXllckFkZHJlc3MgZm9yIHRoaXMgcXVlcnkgaWQgKi8KICAgICAgICBkZWxldGUgcGxheWVyQWRkcmVzc1tteWlkXTsKCiAgICAgICAgLyogbWFwIHRoZSBwbGF5ZXJQcm9maXQgZm9yIHRoaXMgcXVlcnkgaWQgKi8KICAgICAgICBwbGF5ZXJUZW1wUmV3YXJkW215aWRdID0gcGxheWVyUHJvZml0W215aWRdOwogICAgICAgIC8qIHNldCAgcGxheWVyUHJvZml0IGZvciB0aGlzIHF1ZXJ5IGlkIHRvIDAgKi8KICAgICAgICBwbGF5ZXJQcm9maXRbbXlpZF0gPSAwOyAKCiAgICAgICAgLyogc2FmZWx5IHJlZHVjZSBtYXhQZW5kaW5nUGF5b3V0cyBsaWFiaWxpdHkgKi8KICAgICAgICBtYXhQZW5kaW5nUGF5b3V0cyA9IHNhZmVTdWIobWF4UGVuZGluZ1BheW91dHMsIHBsYXllclRlbXBSZXdhcmRbbXlpZF0pOyAgICAgICAgIAoKICAgICAgICAvKiBtYXAgdGhlIHBsYXllckJldFZhbHVlIGZvciB0aGlzIHF1ZXJ5IGlkICovCiAgICAgICAgcGxheWVyVGVtcEJldFZhbHVlW215aWRdID0gcGxheWVyQmV0VmFsdWVbbXlpZF07CiAgICAgICAgLyogc2V0ICBwbGF5ZXJCZXRWYWx1ZSBmb3IgdGhpcyBxdWVyeSBpZCB0byAwICovCiAgICAgICAgcGxheWVyQmV0VmFsdWVbbXlpZF0gPSAwOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAoKICAgICAgICAvKgogICAgICAgICogcmVmdW5kCiAgICAgICAgKiBpZiByZXN1bHQgZnJvbSBvcmFjbGl6ZSBpcyAwIHJlZnVuZCBvbmx5IHRoZSBvcmlnaW5hbCBiZXQgdmFsdWUKICAgICAgICAqIGlmIHJlZnVuZCBmYWlscyBzYXZlIHJlZnVuZCB2YWx1ZSB0byBwbGF5ZXJQZW5kaW5nV2l0aGRyYXdhbHMKICAgICAgICAqLwogICAgICAgIGlmKHBsYXllckRpZVJlc3VsdFtteWlkXT09MCl7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKCiAgICAgICAgICAgICBMb2dSZXN1bHQoc2VyaWFsTnVtYmVyT2ZSZXN1bHQsIHBsYXllckJldElkW215aWRdLCBwbGF5ZXJUZW1wQWRkcmVzc1tteWlkXSwgcGxheWVyTnVtYmVyW215aWRdLCBwbGF5ZXJEaWVSZXN1bHRbbXlpZF0sIHBsYXllclRlbXBCZXRWYWx1ZVtteWlkXSwgMywgcHJvb2YpOyAgICAgICAgICAgIAoKICAgICAgICAgICAgLyoKICAgICAgICAgICAgKiBzZW5kIHJlZnVuZCAtIGV4dGVybmFsIGNhbGwgdG8gYW4gdW50cnVzdGVkIGNvbnRyYWN0CiAgICAgICAgICAgICogaWYgc2VuZCBmYWlscyBtYXAgcmVmdW5kIHZhbHVlIHRvIHBsYXllclBlbmRpbmdXaXRoZHJhd2Fsc1thZGRyZXNzXQogICAgICAgICAgICAqIGZvciB3aXRoZHJhd2FsIGxhdGVyIHZpYSBwbGF5ZXJXaXRoZHJhd1BlbmRpbmdUcmFuc2FjdGlvbnMKICAgICAgICAgICAgKi8KICAgICAgICAgICAgaWYoIXBsYXllclRlbXBBZGRyZXNzW215aWRdLnNlbmQocGxheWVyVGVtcEJldFZhbHVlW215aWRdKSl7CiAgICAgICAgICAgICAgICBMb2dSZXN1bHQoc2VyaWFsTnVtYmVyT2ZSZXN1bHQsIHBsYXllckJldElkW215aWRdLCBwbGF5ZXJUZW1wQWRkcmVzc1tteWlkXSwgcGxheWVyTnVtYmVyW215aWRdLCBwbGF5ZXJEaWVSZXN1bHRbbXlpZF0sIHBsYXllclRlbXBCZXRWYWx1ZVtteWlkXSwgNCwgcHJvb2YpOyAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvKiBpZiBzZW5kIGZhaWxlZCBsZXQgcGxheWVyIHdpdGhkcmF3IHZpYSBwbGF5ZXJXaXRoZHJhd1BlbmRpbmdUcmFuc2FjdGlvbnMgKi8KICAgICAgICAgICAgICAgIHBsYXllclBlbmRpbmdXaXRoZHJhd2Fsc1twbGF5ZXJUZW1wQWRkcmVzc1tteWlkXV0gPSBzYWZlQWRkKHBsYXllclBlbmRpbmdXaXRoZHJhd2Fsc1twbGF5ZXJUZW1wQWRkcmVzc1tteWlkXV0sIHBsYXllclRlbXBCZXRWYWx1ZVtteWlkXSk7ICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIC8qCiAgICAgICAgKiBwYXkgd2lubmVyCiAgICAgICAgKiB1cGRhdGUgY29udHJhY3QgYmFsYW5jZSB0byBjYWxjdWxhdGUgbmV3IG1heCBiZXQKICAgICAgICAqIHNlbmQgcmV3YXJkCiAgICAgICAgKiBpZiBzZW5kIG9mIHJld2FyZCBmYWlscyBzYXZlIHZhbHVlIHRvIHBsYXllclBlbmRpbmdXaXRoZHJhd2FscyAgICAgICAgCiAgICAgICAgKi8KICAgICAgICBpZihwbGF5ZXJEaWVSZXN1bHRbbXlpZF0gPCBwbGF5ZXJOdW1iZXJbbXlpZF0peyAKCiAgICAgICAgICAgIC8qIHNhZmVseSByZWR1Y2UgY29udHJhY3QgYmFsYW5jZSBieSBwbGF5ZXIgcHJvZml0ICovCiAgICAgICAgICAgIGNvbnRyYWN0QmFsYW5jZSA9IHNhZmVTdWIoY29udHJhY3RCYWxhbmNlLCBwbGF5ZXJUZW1wUmV3YXJkW215aWRdKTsgCgogICAgICAgICAgICAvKiB1cGRhdGUgdG90YWwgd2VpIHdvbiAqLwogICAgICAgICAgICB0b3RhbFdlaVdvbiA9IHNhZmVBZGQodG90YWxXZWlXb24sIHBsYXllclRlbXBSZXdhcmRbbXlpZF0pOyAgICAgICAgICAgICAgCgogICAgICAgICAgICAvKiBzYWZlbHkgY2FsY3VsYXRlIHBheW91dCB2aWEgcHJvZml0IHBsdXMgb3JpZ2luYWwgd2FnZXIgKi8KICAgICAgICAgICAgcGxheWVyVGVtcFJld2FyZFtteWlkXSA9IHNhZmVBZGQocGxheWVyVGVtcFJld2FyZFtteWlkXSwgcGxheWVyVGVtcEJldFZhbHVlW215aWRdKTsgCgogICAgICAgICAgICBMb2dSZXN1bHQoc2VyaWFsTnVtYmVyT2ZSZXN1bHQsIHBsYXllckJldElkW215aWRdLCBwbGF5ZXJUZW1wQWRkcmVzc1tteWlkXSwgcGxheWVyTnVtYmVyW215aWRdLCBwbGF5ZXJEaWVSZXN1bHRbbXlpZF0sIHBsYXllclRlbXBSZXdhcmRbbXlpZF0sIDEsIHByb29mKTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgCgogICAgICAgICAgICAvKiB1cGRhdGUgbWF4aW11bSBwcm9maXQgKi8KICAgICAgICAgICAgc2V0TWF4UHJvZml0KCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvKgogICAgICAgICAgICAqIHNlbmQgd2luIC0gZXh0ZXJuYWwgY2FsbCB0byBhbiB1bnRydXN0ZWQgY29udHJhY3QKICAgICAgICAgICAgKiBpZiBzZW5kIGZhaWxzIG1hcCByZXdhcmQgdmFsdWUgdG8gcGxheWVyUGVuZGluZ1dpdGhkcmF3YWxzW2FkZHJlc3NdCiAgICAgICAgICAgICogZm9yIHdpdGhkcmF3YWwgbGF0ZXIgdmlhIHBsYXllcldpdGhkcmF3UGVuZGluZ1RyYW5zYWN0aW9ucwogICAgICAgICAgICAqLwogICAgICAgICAgICBpZighcGxheWVyVGVtcEFkZHJlc3NbbXlpZF0uc2VuZChwbGF5ZXJUZW1wUmV3YXJkW215aWRdKSl7CiAgICAgICAgICAgICAgICBMb2dSZXN1bHQoc2VyaWFsTnVtYmVyT2ZSZXN1bHQsIHBsYXllckJldElkW215aWRdLCBwbGF5ZXJUZW1wQWRkcmVzc1tteWlkXSwgcGxheWVyTnVtYmVyW215aWRdLCBwbGF5ZXJEaWVSZXN1bHRbbXlpZF0sIHBsYXllclRlbXBSZXdhcmRbbXlpZF0sIDIsIHByb29mKTsgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvKiBpZiBzZW5kIGZhaWxlZCBsZXQgcGxheWVyIHdpdGhkcmF3IHZpYSBwbGF5ZXJXaXRoZHJhd1BlbmRpbmdUcmFuc2FjdGlvbnMgKi8KICAgICAgICAgICAgICAgIHBsYXllclBlbmRpbmdXaXRoZHJhd2Fsc1twbGF5ZXJUZW1wQWRkcmVzc1tteWlkXV0gPSBzYWZlQWRkKHBsYXllclBlbmRpbmdXaXRoZHJhd2Fsc1twbGF5ZXJUZW1wQWRkcmVzc1tteWlkXV0sIHBsYXllclRlbXBSZXdhcmRbbXlpZF0pOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuOwoKICAgICAgICB9CgogICAgICAgIC8qCiAgICAgICAgKiBubyB3aW4KICAgICAgICAqIHNlbmQgMSB3ZWkgdG8gYSBsb3NpbmcgYmV0CiAgICAgICAgKiB1cGRhdGUgY29udHJhY3QgYmFsYW5jZSB0byBjYWxjdWxhdGUgbmV3IG1heCBiZXQKICAgICAgICAqLwogICAgICAgIGlmKHBsYXllckRpZVJlc3VsdFtteWlkXSA+PSBwbGF5ZXJOdW1iZXJbbXlpZF0pewoKICAgICAgICAgICAgTG9nUmVzdWx0KHNlcmlhbE51bWJlck9mUmVzdWx0LCBwbGF5ZXJCZXRJZFtteWlkXSwgcGxheWVyVGVtcEFkZHJlc3NbbXlpZF0sIHBsYXllck51bWJlcltteWlkXSwgcGxheWVyRGllUmVzdWx0W215aWRdLCBwbGF5ZXJUZW1wQmV0VmFsdWVbbXlpZF0sIDAsIHByb29mKTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAoKICAgICAgICAgICAgLyogIAogICAgICAgICAgICAqICBzYWZlIGFkanVzdCBjb250cmFjdEJhbGFuY2UKICAgICAgICAgICAgKiAgc2V0TWF4UHJvZml0CiAgICAgICAgICAgICogIHNlbmQgMSB3ZWkgdG8gbG9zaW5nIGJldAogICAgICAgICAgICAqLwogICAgICAgICAgICBjb250cmFjdEJhbGFuY2UgPSBzYWZlQWRkKGNvbnRyYWN0QmFsYW5jZSwgKHBsYXllclRlbXBCZXRWYWx1ZVtteWlkXS0xKSk7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAoKICAgICAgICAgICAgLyogdXBkYXRlIG1heGltdW0gcHJvZml0ICovCiAgICAgICAgICAgIHNldE1heFByb2ZpdCgpOyAKCiAgICAgICAgICAgIC8qCiAgICAgICAgICAgICogc2VuZCAxIHdlaSAtIGV4dGVybmFsIGNhbGwgdG8gYW4gdW50cnVzdGVkIGNvbnRyYWN0ICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICovCiAgICAgICAgICAgIGlmKCFwbGF5ZXJUZW1wQWRkcmVzc1tteWlkXS5zZW5kKDEpKXsKICAgICAgICAgICAgICAgIC8qIGlmIHNlbmQgZmFpbGVkIGxldCBwbGF5ZXIgd2l0aGRyYXcgdmlhIHBsYXllcldpdGhkcmF3UGVuZGluZ1RyYW5zYWN0aW9ucyAqLyAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgcGxheWVyUGVuZGluZ1dpdGhkcmF3YWxzW3BsYXllclRlbXBBZGRyZXNzW215aWRdXSA9IHNhZmVBZGQocGxheWVyUGVuZGluZ1dpdGhkcmF3YWxzW3BsYXllclRlbXBBZGRyZXNzW215aWRdXSwgMSk7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgfSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCgogICAgICAgICAgICByZXR1cm47CgogICAgICAgIH0KCiAgICB9CiAgICAKICAgIC8qCiAgICAqIHB1YmxpYyBmdW5jdGlvbgogICAgKiBpbiBjYXNlIG9mIGEgZmFpbGVkIHJlZnVuZCBvciB3aW4gc2VuZAogICAgKi8KICAgIGZ1bmN0aW9uIHBsYXllcldpdGhkcmF3UGVuZGluZ1RyYW5zYWN0aW9ucygpIHB1YmxpYyAKICAgICAgICBwYXlvdXRzQXJlQWN0aXZlCiAgICAgICAgcmV0dXJucyAoYm9vbCkKICAgICB7CiAgICAgICAgdWludCB3aXRoZHJhd0Ftb3VudCA9IHBsYXllclBlbmRpbmdXaXRoZHJhd2Fsc1ttc2cuc2VuZGVyXTsKICAgICAgICBwbGF5ZXJQZW5kaW5nV2l0aGRyYXdhbHNbbXNnLnNlbmRlcl0gPSAwOwogICAgICAgIC8qIGV4dGVybmFsIGNhbGwgdG8gdW50cnVzdGVkIGNvbnRyYWN0ICovCiAgICAgICAgaWYgKG1zZy5zZW5kZXIuY2FsbC52YWx1ZSh3aXRoZHJhd0Ftb3VudCkoKSkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvKiBpZiBzZW5kIGZhaWxlZCByZXZlcnQgcGxheWVyUGVuZGluZ1dpdGhkcmF3YWxzW21zZy5zZW5kZXJdID0gMDsgKi8KICAgICAgICAgICAgLyogcGxheWVyIGNhbiB0cnkgdG8gd2l0aGRyYXcgYWdhaW4gbGF0ZXIgKi8KICAgICAgICAgICAgcGxheWVyUGVuZGluZ1dpdGhkcmF3YWxzW21zZy5zZW5kZXJdID0gd2l0aGRyYXdBbW91bnQ7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICB9CgogICAgLyogY2hlY2sgZm9yIHBlbmRpbmcgd2l0aGRyYXdhbHMgICovCiAgICBmdW5jdGlvbiBwbGF5ZXJHZXRQZW5kaW5nVHhCeUFkZHJlc3MoYWRkcmVzcyBhZGRyZXNzVG9DaGVjaykgcHVibGljIGNvbnN0YW50IHJldHVybnMgKHVpbnQpIHsKICAgICAgICByZXR1cm4gcGxheWVyUGVuZGluZ1dpdGhkcmF3YWxzW2FkZHJlc3NUb0NoZWNrXTsKICAgIH0KCiAgICAvKgogICAgKiBpbnRlcm5hbCBmdW5jdGlvbgogICAgKiBzZXRzIG1heCBwcm9maXQKICAgICovCiAgICBmdW5jdGlvbiBzZXRNYXhQcm9maXQoKSBpbnRlcm5hbCB7CiAgICAgICAgbWF4UHJvZml0ID0gKGNvbnRyYWN0QmFsYW5jZSptYXhQcm9maXRBc1BlcmNlbnRPZkhvdXNlKS9tYXhQcm9maXREaXZpc29yOyAgCiAgICB9ICAgCgogICAgLyoKICAgICogb3duZXIvdHJlYXN1cnkgYWRkcmVzcyBvbmx5IGZ1bmN0aW9ucwogICAgKi8KICAgIGZ1bmN0aW9uICgpCiAgICAgICAgcGF5YWJsZQogICAgICAgIG9ubHlUcmVhc3VyeQogICAgewogICAgICAgIC8qIHNhZmVseSB1cGRhdGUgY29udHJhY3QgYmFsYW5jZSAqLwogICAgICAgIGNvbnRyYWN0QmFsYW5jZSA9IHNhZmVBZGQoY29udHJhY3RCYWxhbmNlLCBtc2cudmFsdWUpOyAgICAgICAgCiAgICAgICAgLyogdXBkYXRlIHRoZSBtYXhpbXVtIHByb2ZpdCAqLwogICAgICAgIHNldE1heFByb2ZpdCgpOwogICAgfSAKCiAgICAvKiBzZXQgZ2FzIGZvciBvcmFjbGl6ZSBxdWVyeSAqLwogICAgZnVuY3Rpb24gb3duZXJTZXRPcmFjbGl6ZVNhZmVHYXModWludDMyIG5ld1NhZmVHYXNUb09yYWNsaXplKSBwdWJsaWMgCgkJb25seU93bmVyCgl7CiAgICAJZ2FzRm9yT3JhY2xpemUgPSBuZXdTYWZlR2FzVG9PcmFjbGl6ZTsKICAgIH0KCiAgICAvKiBzZXQgaG91c2UgY29zdCB0byBjYWxsIG9yYWNsaXplIHF1ZXJ5ICovCiAgICBmdW5jdGlvbiBvd25lclVwZGF0ZUNvc3RUb0NhbGxPcmFjbGl6ZSh1aW50IG5ld0Nvc3RUb0NhbGxPcmFjbGl6ZUluV2VpKSBwdWJsaWMgCgkJb25seU93bmVyCiAgICB7ICAgICAgICAKICAgICAgIGNvc3RUb0NhbGxPcmFjbGl6ZUluV2VpID0gbmV3Q29zdFRvQ2FsbE9yYWNsaXplSW5XZWk7CiAgICB9ICAgICAKCiAgICAvKiBvbmx5IG93bmVyIGFkZHJlc3MgY2FuIHNldCBob3VzZUVkZ2UgKi8KICAgIGZ1bmN0aW9uIG93bmVyU2V0SG91c2VFZGdlKHVpbnQgbmV3SG91c2VFZGdlKSBwdWJsaWMgCgkJb25seU93bmVyCiAgICB7CiAgICAgICAgaG91c2VFZGdlID0gbmV3SG91c2VFZGdlOwogICAgfQoKICAgIC8qIG9ubHkgb3duZXIgYWRkcmVzcyBjYW4gc2V0IG1heFByb2ZpdEFzUGVyY2VudE9mSG91c2UgKi8KICAgIGZ1bmN0aW9uIG93bmVyU2V0TWF4UHJvZml0QXNQZXJjZW50T2ZIb3VzZSh1aW50IG5ld01heFByb2ZpdEFzUGVyY2VudCkgcHVibGljIAoJCW9ubHlPd25lcgogICAgewogICAgICAgIC8qIHJlc3RyaWN0IGVhY2ggYmV0IHRvIGEgbWF4aW11bSBwcm9maXQgb2YgMSUgY29udHJhY3RCYWxhbmNlICovCiAgICAgICAgaWYobmV3TWF4UHJvZml0QXNQZXJjZW50ID4gMTAwMDApIHRocm93OwogICAgICAgIG1heFByb2ZpdEFzUGVyY2VudE9mSG91c2UgPSBuZXdNYXhQcm9maXRBc1BlcmNlbnQ7CiAgICAgICAgc2V0TWF4UHJvZml0KCk7CiAgICB9CgogICAgLyogb25seSBvd25lciBhZGRyZXNzIGNhbiBzZXQgbWluQmV0ICovCiAgICBmdW5jdGlvbiBvd25lclNldE1pbkJldCh1aW50IG5ld01pbmltdW1CZXQpIHB1YmxpYyAKCQlvbmx5T3duZXIKICAgIHsKICAgICAgICBtaW5CZXQgPSBuZXdNaW5pbXVtQmV0OwogICAgfSAgICAgICAKCiAgICAvKiBvbmx5IG93bmVyIGFkZHJlc3MgY2FuIHRyYW5zZmVyIGV0aGVyICovCiAgICBmdW5jdGlvbiBvd25lclRyYW5zZmVyRXRoZXIoYWRkcmVzcyBzZW5kVG8sIHVpbnQgYW1vdW50KSBwdWJsaWMgCgkJb25seU93bmVyCiAgICB7ICAgICAgICAKICAgICAgICAvKiBzYWZlbHkgdXBkYXRlIGNvbnRyYWN0IGJhbGFuY2Ugd2hlbiBzZW5kaW5nIG91dCBmdW5kcyovCiAgICAgICAgY29udHJhY3RCYWxhbmNlID0gc2FmZVN1Yihjb250cmFjdEJhbGFuY2UsIGFtb3VudCk7CQkKICAgICAgICAvKiB1cGRhdGUgbWF4IHByb2ZpdCAqLwogICAgICAgIHNldE1heFByb2ZpdCgpOwogICAgICAgIGlmKCFzZW5kVG8uc2VuZChhbW91bnQpKSB0aHJvdzsKICAgICAgICBMb2dPd25lclRyYW5zZmVyKHNlbmRUbywgYW1vdW50KTsgCiAgICB9CgogICAgLyogb25seSBvd25lciBhZGRyZXNzIGNhbiBkbyBtYW51YWwgcmVmdW5kCiAgICAqIHVzZWQgb25seSBpZiBiZXQgcGxhY2VkICsgb3JhY2xpemUgZmFpbGVkIHRvIF9fY2FsbGJhY2sKICAgICogZmlsdGVyIExvZ0JldCBieSBhZGRyZXNzIGFuZC9vciBwbGF5ZXJCZXRJZDoKICAgICogTG9nQmV0KHBsYXllckJldElkW3JuZ0lkXSwgcGxheWVyQWRkcmVzc1tybmdJZF0sIHNhZmVBZGQocGxheWVyQmV0VmFsdWVbcm5nSWRdLCBwbGF5ZXJQcm9maXRbcm5nSWRdKSwgcGxheWVyUHJvZml0W3JuZ0lkXSwgcGxheWVyQmV0VmFsdWVbcm5nSWRdLCBwbGF5ZXJOdW1iZXJbcm5nSWRdKTsKICAgICogY2hlY2sgdGhlIGZvbGxvd2luZyBsb2dzIGRvIG5vdCBleGlzdCBmb3IgcGxheWVyQmV0SWQgYW5kL29yIHBsYXllckFkZHJlc3Nbcm5nSWRdIGJlZm9yZSByZWZ1bmRpbmc6CiAgICAqIExvZ1Jlc3VsdCBvciBMb2dSZWZ1bmQKICAgICogaWYgTG9nUmVzdWx0IGV4aXN0cyBwbGF5ZXIgc2hvdWxkIHVzZSB0aGUgd2l0aGRyYXcgcGF0dGVybiBwbGF5ZXJXaXRoZHJhd1BlbmRpbmdUcmFuc2FjdGlvbnMgCiAgICAqLwogICAgZnVuY3Rpb24gb3duZXJSZWZ1bmRQbGF5ZXIoYnl0ZXMzMiBvcmlnaW5hbFBsYXllckJldElkLCBhZGRyZXNzIHNlbmRUbywgdWludCBvcmlnaW5hbFBsYXllclByb2ZpdCwgdWludCBvcmlnaW5hbFBsYXllckJldFZhbHVlKSBwdWJsaWMgCgkJb25seU93bmVyCiAgICB7ICAgICAgICAKICAgICAgICAvKiBzYWZlbHkgcmVkdWNlIHBlbmRpbmdQYXlvdXRzIGJ5IHBsYXllclByb2ZpdFtybmdJZF0gKi8KICAgICAgICBtYXhQZW5kaW5nUGF5b3V0cyA9IHNhZmVTdWIobWF4UGVuZGluZ1BheW91dHMsIG9yaWdpbmFsUGxheWVyUHJvZml0KTsKICAgICAgICAvKiBzZW5kIHJlZnVuZCAqLwogICAgICAgIGlmKCFzZW5kVG8uc2VuZChvcmlnaW5hbFBsYXllckJldFZhbHVlKSkgdGhyb3c7CiAgICAgICAgLyogbG9nIHJlZnVuZHMgKi8KICAgICAgICBMb2dSZWZ1bmQob3JpZ2luYWxQbGF5ZXJCZXRJZCwgc2VuZFRvLCBvcmlnaW5hbFBsYXllckJldFZhbHVlKTsgICAgICAgIAogICAgfSAgICAKCiAgICAvKiBvbmx5IG93bmVyIGFkZHJlc3MgY2FuIHNldCBlbWVyZ2VuY3kgcGF1c2UgIzEgKi8KICAgIGZ1bmN0aW9uIG93bmVyUGF1c2VHYW1lKGJvb2wgbmV3U3RhdHVzKSBwdWJsaWMgCgkJb25seU93bmVyCiAgICB7CgkJZ2FtZVBhdXNlZCA9IG5ld1N0YXR1czsKICAgIH0KCiAgICAvKiBvbmx5IG93bmVyIGFkZHJlc3MgY2FuIHNldCBlbWVyZ2VuY3kgcGF1c2UgIzIgKi8KICAgIGZ1bmN0aW9uIG93bmVyUGF1c2VQYXlvdXRzKGJvb2wgbmV3UGF5b3V0U3RhdHVzKSBwdWJsaWMgCgkJb25seU93bmVyCiAgICB7CgkJcGF5b3V0c1BhdXNlZCA9IG5ld1BheW91dFN0YXR1czsKICAgIH0gCgogICAgLyogb25seSBvd25lciBhZGRyZXNzIGNhbiBzZXQgdHJlYXN1cnkgYWRkcmVzcyAqLwogICAgZnVuY3Rpb24gb3duZXJTZXRUcmVhc3VyeShhZGRyZXNzIG5ld1RyZWFzdXJ5KSBwdWJsaWMgCgkJb25seU93bmVyCgl7CiAgICAgICAgdHJlYXN1cnkgPSBuZXdUcmVhc3VyeTsKICAgIH0gICAgICAgICAKCiAgICAvKiBvbmx5IG93bmVyIGFkZHJlc3MgY2FuIHNldCBvd25lciBhZGRyZXNzICovCiAgICBmdW5jdGlvbiBvd25lckNoYW5nZU93bmVyKGFkZHJlc3MgbmV3T3duZXIpIHB1YmxpYyAKCQlvbmx5T3duZXIKCXsKICAgICAgICBvd25lciA9IG5ld093bmVyOwogICAgfQoKICAgIC8qIG9ubHkgb3duZXIgYWRkcmVzcyBjYW4gc3VpY2lkZSAtIGVtZXJnZW5jeSAqLwogICAgZnVuY3Rpb24gb3duZXJraWxsKCkgcHVibGljIAoJCW9ubHlPd25lcgoJewoJCXN1aWNpZGUob3duZXIpOwoJfSAgICAKCgp9'.
	

]
