Class {
	#name : #SRT971e78e0C92392A4E39099835cF7E6aB535b2227,
	#superclass : #SRTContracts,
	#category : #SolidityTestingResources
}

{ #category : #base64 }
SRT971e78e0C92392A4E39099835cF7E6aB535b2227 >> base64 [
	^ 'LyoKLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KRklMRSBIRUFERVIKLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KCmZpbGU6ICAgICAgIEhhdnZlbkVzY3Jvdy5zb2wKdmVyc2lvbjogICAgMS4wCmF1dGhvcnM6ICAgIEFudG9uIEp1cmlzZXZpYwogICAgICAgICAgICBEb21pbmljIFJvbWFub3dza2kKICAgICAgICAgICAgTWlrZSBTcGFpbgoKZGF0ZTogICAgICAgMjAxOC0wMi0yOApjaGVja2VkOiAgICBNaWtlIFNwYWluCmFwcHJvdmVkOiAgIFNhbXVlbCBCcm9va3MKCnJlcG86ICAgICAgIGh0dHBzOi8vZ2l0aHViLmNvbS9IYXZ2ZW4vaGF2dmVuCmNvbW1pdDogICAgIDM0ZTY2MDA5Yjk4YWExODk3NjIyNmMxMzkyNzA5NzBkMTA1MDQ1ZTMKCi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiovCgpwcmFnbWEgc29saWRpdHkgXjAuNC4yMTsKCi8qCi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCkNPTlRSQUNUIERFU0NSSVBUSU9OCi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCgpBIGNvbnRyYWN0IHdpdGggYSBsaW1pdGVkIHNldHVwIHBlcmlvZC4gQW55IGZ1bmN0aW9uIG1vZGlmaWVkCndpdGggdGhlIHNldHVwIG1vZGlmaWVyIHdpbGwgY2Vhc2UgdG8gd29yayBhZnRlciB0aGUKY29uY2x1c2lvbiBvZiB0aGUgY29uZmlndXJhYmxlLWxlbmd0aCBwb3N0LWNvbnN0cnVjdGlvbiBzZXR1cCBwZXJpb2QuCgotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoqLwoKY29udHJhY3QgTGltaXRlZFNldHVwIHsKCiAgICB1aW50IGNvbnN0cnVjdGlvblRpbWU7CiAgICB1aW50IHNldHVwRHVyYXRpb247CgogICAgZnVuY3Rpb24gTGltaXRlZFNldHVwKHVpbnQgX3NldHVwRHVyYXRpb24pCiAgICAgICAgcHVibGljCiAgICB7CiAgICAgICAgY29uc3RydWN0aW9uVGltZSA9IG5vdzsKICAgICAgICBzZXR1cER1cmF0aW9uID0gX3NldHVwRHVyYXRpb247CiAgICB9CgogICAgbW9kaWZpZXIgc2V0dXBGdW5jdGlvbgogICAgewogICAgICAgIHJlcXVpcmUobm93IDwgY29uc3RydWN0aW9uVGltZSArIHNldHVwRHVyYXRpb24pOwogICAgICAgIF87CiAgICB9Cn0KCi8qCi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCkNPTlRSQUNUIERFU0NSSVBUSU9OCi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCgpBbiBPd25lZCBjb250cmFjdCwgdG8gYmUgaW5oZXJpdGVkIGJ5IG90aGVyIGNvbnRyYWN0cy4KUmVxdWlyZXMgaXRzIG93bmVyIHRvIGJlIGV4cGxpY2l0bHkgc2V0IGluIHRoZSBjb25zdHJ1Y3Rvci4KUHJvdmlkZXMgYW4gb25seU93bmVyIGFjY2VzcyBtb2RpZmllci4KClRvIGNoYW5nZSBvd25lciwgdGhlIGN1cnJlbnQgb3duZXIgbXVzdCBub21pbmF0ZSB0aGUgbmV4dCBvd25lciwKd2hvIHRoZW4gaGFzIHRvIGFjY2VwdCB0aGUgbm9taW5hdGlvbi4gVGhlIG5vbWluYXRpb24gY2FuIGJlCmNhbmNlbGxlZCBiZWZvcmUgaXQgaXMgYWNjZXB0ZWQgYnkgdGhlIG5ldyBvd25lciBieSBoYXZpbmcgdGhlCnByZXZpb3VzIG93bmVyIGNoYW5nZSB0aGUgbm9taW5hdGlvbiAoc2V0dGluZyBpdCB0byAwKS4KCi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiovCgpjb250cmFjdCBPd25lZCB7CiAgICBhZGRyZXNzIHB1YmxpYyBvd25lcjsKICAgIGFkZHJlc3MgcHVibGljIG5vbWluYXRlZE93bmVyOwoKICAgIGZ1bmN0aW9uIE93bmVkKGFkZHJlc3MgX293bmVyKQogICAgICAgIHB1YmxpYwogICAgewogICAgICAgIG93bmVyID0gX293bmVyOwogICAgfQoKICAgIGZ1bmN0aW9uIG5vbWluYXRlT3duZXIoYWRkcmVzcyBfb3duZXIpCiAgICAgICAgZXh0ZXJuYWwKICAgICAgICBvbmx5T3duZXIKICAgIHsKICAgICAgICBub21pbmF0ZWRPd25lciA9IF9vd25lcjsKICAgICAgICBlbWl0IE93bmVyTm9taW5hdGVkKF9vd25lcik7CiAgICB9CgogICAgZnVuY3Rpb24gYWNjZXB0T3duZXJzaGlwKCkKICAgICAgICBleHRlcm5hbAogICAgewogICAgICAgIHJlcXVpcmUobXNnLnNlbmRlciA9PSBub21pbmF0ZWRPd25lcik7CiAgICAgICAgZW1pdCBPd25lckNoYW5nZWQob3duZXIsIG5vbWluYXRlZE93bmVyKTsKICAgICAgICBvd25lciA9IG5vbWluYXRlZE93bmVyOwogICAgICAgIG5vbWluYXRlZE93bmVyID0gYWRkcmVzcygwKTsKICAgIH0KCiAgICBtb2RpZmllciBvbmx5T3duZXIKICAgIHsKICAgICAgICByZXF1aXJlKG1zZy5zZW5kZXIgPT0gb3duZXIpOwogICAgICAgIF87CiAgICB9CgogICAgZXZlbnQgT3duZXJOb21pbmF0ZWQoYWRkcmVzcyBuZXdPd25lcik7CiAgICBldmVudCBPd25lckNoYW5nZWQoYWRkcmVzcyBvbGRPd25lciwgYWRkcmVzcyBuZXdPd25lcik7Cn0KCi8qCi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCkNPTlRSQUNUIERFU0NSSVBUSU9OCi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCgpBIHByb3h5IGNvbnRyYWN0IHRoYXQsIGlmIGl0IGRvZXMgbm90IHJlY29nbmlzZSB0aGUgZnVuY3Rpb24KYmVpbmcgY2FsbGVkIG9uIGl0LCBwYXNzZXMgYWxsIHZhbHVlIGFuZCBjYWxsIGRhdGEgdG8gYW4KdW5kZXJseWluZyB0YXJnZXQgY29udHJhY3QuCgotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoqLwoKY29udHJhY3QgUHJveHkgaXMgT3duZWQgewogICAgUHJveHlhYmxlIHRhcmdldDsKCiAgICBmdW5jdGlvbiBQcm94eShQcm94eWFibGUgX3RhcmdldCwgYWRkcmVzcyBfb3duZXIpCiAgICAgICAgT3duZWQoX293bmVyKQogICAgICAgIHB1YmxpYwogICAgewogICAgICAgIHRhcmdldCA9IF90YXJnZXQ7CiAgICAgICAgZW1pdCBUYXJnZXRDaGFuZ2VkKF90YXJnZXQpOwogICAgfQoKICAgIGZ1bmN0aW9uIF9zZXRUYXJnZXQoYWRkcmVzcyBfdGFyZ2V0KSAKICAgICAgICBleHRlcm5hbAogICAgICAgIG9ubHlPd25lcgogICAgewogICAgICAgIHJlcXVpcmUoX3RhcmdldCAhPSBhZGRyZXNzKDApKTsKICAgICAgICB0YXJnZXQgPSBQcm94eWFibGUoX3RhcmdldCk7CiAgICAgICAgZW1pdCBUYXJnZXRDaGFuZ2VkKF90YXJnZXQpOwogICAgfQoKICAgIGZ1bmN0aW9uICgpIAogICAgICAgIHB1YmxpYwogICAgICAgIHBheWFibGUKICAgIHsKICAgICAgICB0YXJnZXQuc2V0TWVzc2FnZVNlbmRlcihtc2cuc2VuZGVyKTsKICAgICAgICBhc3NlbWJseSB7CiAgICAgICAgICAgIC8vIENvcHkgY2FsbCBkYXRhIGludG8gZnJlZSBtZW1vcnkgcmVnaW9uLgogICAgICAgICAgICBsZXQgZnJlZV9wdHIgOj0gbWxvYWQoMHg0MCkKICAgICAgICAgICAgY2FsbGRhdGFjb3B5KGZyZWVfcHRyLCAwLCBjYWxsZGF0YXNpemUpCgogICAgICAgICAgICAvLyBGb3J3YXJkIGFsbCBnYXMsIGV0aGVyLCBhbmQgZGF0YSB0byB0aGUgdGFyZ2V0IGNvbnRyYWN0LgogICAgICAgICAgICBsZXQgcmVzdWx0IDo9IGNhbGwoZ2FzLCBzbG9hZCh0YXJnZXRfc2xvdCksIGNhbGx2YWx1ZSwgZnJlZV9wdHIsIGNhbGxkYXRhc2l6ZSwgMCwgMCkKICAgICAgICAgICAgcmV0dXJuZGF0YWNvcHkoZnJlZV9wdHIsIDAsIHJldHVybmRhdGFzaXplKQoKICAgICAgICAgICAgLy8gUmV2ZXJ0IGlmIHRoZSBjYWxsIGZhaWxlZCwgb3RoZXJ3aXNlIHJldHVybiB0aGUgcmVzdWx0LgogICAgICAgICAgICBpZiBpc3plcm8ocmVzdWx0KSB7IHJldmVydChmcmVlX3B0ciwgY2FsbGRhdGFzaXplKSB9CiAgICAgICAgICAgIHJldHVybihmcmVlX3B0ciwgcmV0dXJuZGF0YXNpemUpCiAgICAgICAgfSAKICAgIH0KCiAgICBldmVudCBUYXJnZXRDaGFuZ2VkKGFkZHJlc3MgdGFyZ2V0QWRkcmVzcyk7Cn0KCi8qCi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCkNPTlRSQUNUIERFU0NSSVBUSU9OCi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCgpUaGlzIGNvbnRyYWN0IGNvbnRhaW5zIHRoZSBQcm94eWFibGUgaW50ZXJmYWNlLgpBbnkgY29udHJhY3QgdGhlIHByb3h5IHdyYXBzIG11c3QgaW1wbGVtZW50IHRoaXMsIGluIG9yZGVyCmZvciB0aGUgcHJveHkgdG8gYmUgYWJsZSB0byBwYXNzIG1zZy5zZW5kZXIgaW50byB0aGUgdW5kZXJseWluZwpjb250cmFjdCBhcyB0aGUgc3RhdGUgcGFyYW1ldGVyLCBtZXNzYWdlU2VuZGVyLgoKLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KKi8KCmNvbnRyYWN0IFByb3h5YWJsZSBpcyBPd25lZCB7CiAgICAvLyB0aGUgcHJveHkgdGhpcyBjb250cmFjdCBleGlzdHMgYmVoaW5kLgogICAgUHJveHkgcHVibGljIHByb3h5OwoKICAgIC8vIFRoZSBjYWxsZXIgb2YgdGhlIHByb3h5LCBwYXNzZWQgdGhyb3VnaCB0byB0aGlzIGNvbnRyYWN0LgogICAgLy8gTm90ZSB0aGF0IGV2ZXJ5IGZ1bmN0aW9uIHVzaW5nIHRoaXMgbWVtYmVyIG11c3QgYXBwbHkgdGhlIG9ubHlQcm94eSBvcgogICAgLy8gb3B0aW9uYWxQcm94eSBtb2RpZmllcnMsIG90aGVyd2lzZSB0aGVpciBpbnZvY2F0aW9ucyBjYW4gdXNlIHN0YWxlIHZhbHVlcy4KICAgIGFkZHJlc3MgbWVzc2FnZVNlbmRlcjsKCiAgICBmdW5jdGlvbiBQcm94eWFibGUoYWRkcmVzcyBfb3duZXIpCiAgICAgICAgT3duZWQoX293bmVyKQogICAgICAgIHB1YmxpYyB7IH0KCiAgICBmdW5jdGlvbiBzZXRQcm94eShQcm94eSBfcHJveHkpCiAgICAgICAgZXh0ZXJuYWwKICAgICAgICBvbmx5T3duZXIKICAgIHsKICAgICAgICBwcm94eSA9IF9wcm94eTsKICAgICAgICBlbWl0IFByb3h5Q2hhbmdlZChfcHJveHkpOwogICAgfQoKICAgIGZ1bmN0aW9uIHNldE1lc3NhZ2VTZW5kZXIoYWRkcmVzcyBzZW5kZXIpCiAgICAgICAgZXh0ZXJuYWwKICAgICAgICBvbmx5UHJveHkKICAgIHsKICAgICAgICBtZXNzYWdlU2VuZGVyID0gc2VuZGVyOwogICAgfQoKICAgIG1vZGlmaWVyIG9ubHlQcm94eQogICAgewogICAgICAgIHJlcXVpcmUoUHJveHkobXNnLnNlbmRlcikgPT0gcHJveHkpOwogICAgICAgIF87CiAgICB9CgogICAgbW9kaWZpZXIgb25seU93bmVyX1Byb3h5CiAgICB7CiAgICAgICAgcmVxdWlyZShtZXNzYWdlU2VuZGVyID09IG93bmVyKTsKICAgICAgICBfOwogICAgfQoKICAgIG1vZGlmaWVyIG9wdGlvbmFsUHJveHkKICAgIHsKICAgICAgICBpZiAoUHJveHkobXNnLnNlbmRlcikgIT0gcHJveHkpIHsKICAgICAgICAgICAgbWVzc2FnZVNlbmRlciA9IG1zZy5zZW5kZXI7CiAgICAgICAgfQogICAgICAgIF87CiAgICB9CgogICAgLy8gQ29tYmluZSB0aGUgb3B0aW9uYWxQcm94eSBhbmQgb25seU93bmVyX1Byb3h5IG1vZGlmaWVycy4KICAgIC8vIFRoaXMgaXMgc2xpZ2h0bHkgY2hlYXBlciBhbmQgc2FmZXIsIHNpbmNlIHRoZXJlIGlzIGFuIG9yZGVyaW5nIHJlcXVpcmVtZW50LgogICAgbW9kaWZpZXIgb3B0aW9uYWxQcm94eV9vbmx5T3duZXIKICAgIHsKICAgICAgICBpZiAoUHJveHkobXNnLnNlbmRlcikgIT0gcHJveHkpIHsKICAgICAgICAgICAgbWVzc2FnZVNlbmRlciA9IG1zZy5zZW5kZXI7CiAgICAgICAgfQogICAgICAgIHJlcXVpcmUobWVzc2FnZVNlbmRlciA9PSBvd25lcik7CiAgICAgICAgXzsKICAgIH0KCiAgICBldmVudCBQcm94eUNoYW5nZWQoYWRkcmVzcyBwcm94eUFkZHJlc3MpOwoKfQoKLyoKLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KQ09OVFJBQ1QgREVTQ1JJUFRJT04KLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KCkEgZml4ZWQgcG9pbnQgZGVjaW1hbCBsaWJyYXJ5IHRoYXQgcHJvdmlkZXMgYmFzaWMgbWF0aGVtYXRpY2FsCm9wZXJhdGlvbnMsIGFuZCBjaGVja3MgZm9yIHVuc2FmZSBhcmd1bWVudHMsIGZvciBleGFtcGxlIHRoYXQKd291bGQgbGVhZCB0byBvdmVyZmxvd3MuCgpFeGNlcHRpb25zIGFyZSB0aHJvd24gd2hlbmV2ZXIgdGhvc2UgdW5zYWZlIG9wZXJhdGlvbnMKb2NjdXIuCgotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoqLwoKY29udHJhY3QgU2FmZURlY2ltYWxNYXRoIHsKCiAgICAvLyBOdW1iZXIgb2YgZGVjaW1hbCBwbGFjZXMgaW4gdGhlIHJlcHJlc2VudGF0aW9uLgogICAgdWludDggcHVibGljIGNvbnN0YW50IGRlY2ltYWxzID0gMTg7CgogICAgLy8gVGhlIG51bWJlciByZXByZXNlbnRpbmcgMS4wLgogICAgdWludCBwdWJsaWMgY29uc3RhbnQgVU5JVCA9IDEwICoqIHVpbnQoZGVjaW1hbHMpOwoKICAgIC8qIFRydWUgaWZmIGFkZGluZyB4IGFuZCB5IHdpbGwgbm90IG92ZXJmbG93LiAqLwogICAgZnVuY3Rpb24gYWRkSXNTYWZlKHVpbnQgeCwgdWludCB5KQogICAgICAgIHB1cmUKICAgICAgICBpbnRlcm5hbAogICAgICAgIHJldHVybnMgKGJvb2wpCiAgICB7CiAgICAgICAgcmV0dXJuIHggKyB5ID49IHk7CiAgICB9CgogICAgLyogUmV0dXJuIHRoZSByZXN1bHQgb2YgYWRkaW5nIHggYW5kIHksIHRocm93aW5nIGFuIGV4Y2VwdGlvbiBpbiBjYXNlIG9mIG92ZXJmbG93LiAqLwogICAgZnVuY3Rpb24gc2FmZUFkZCh1aW50IHgsIHVpbnQgeSkKICAgICAgICBwdXJlCiAgICAgICAgaW50ZXJuYWwKICAgICAgICByZXR1cm5zICh1aW50KQogICAgewogICAgICAgIHJlcXVpcmUoeCArIHkgPj0geSk7CiAgICAgICAgcmV0dXJuIHggKyB5OwogICAgfQoKICAgIC8qIFRydWUgaWZmIHN1YnRyYWN0aW5nIHkgZnJvbSB4IHdpbGwgbm90IG92ZXJmbG93IGluIHRoZSBuZWdhdGl2ZSBkaXJlY3Rpb24uICovCiAgICBmdW5jdGlvbiBzdWJJc1NhZmUodWludCB4LCB1aW50IHkpCiAgICAgICAgcHVyZQogICAgICAgIGludGVybmFsCiAgICAgICAgcmV0dXJucyAoYm9vbCkKICAgIHsKICAgICAgICByZXR1cm4geSA8PSB4OwogICAgfQoKICAgIC8qIFJldHVybiB0aGUgcmVzdWx0IG9mIHN1YnRyYWN0aW5nIHkgZnJvbSB4LCB0aHJvd2luZyBhbiBleGNlcHRpb24gaW4gY2FzZSBvZiBvdmVyZmxvdy4gKi8KICAgIGZ1bmN0aW9uIHNhZmVTdWIodWludCB4LCB1aW50IHkpCiAgICAgICAgcHVyZQogICAgICAgIGludGVybmFsCiAgICAgICAgcmV0dXJucyAodWludCkKICAgIHsKICAgICAgICByZXF1aXJlKHkgPD0geCk7CiAgICAgICAgcmV0dXJuIHggLSB5OwogICAgfQoKICAgIC8qIFRydWUgaWZmIG11bHRpcGx5aW5nIHggYW5kIHkgd291bGQgbm90IG92ZXJmbG93LiAqLwogICAgZnVuY3Rpb24gbXVsSXNTYWZlKHVpbnQgeCwgdWludCB5KQogICAgICAgIHB1cmUKICAgICAgICBpbnRlcm5hbAogICAgICAgIHJldHVybnMgKGJvb2wpCiAgICB7CiAgICAgICAgaWYgKHggPT0gMCkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuICh4ICogeSkgLyB4ID09IHk7CiAgICB9CgogICAgLyogUmV0dXJuIHRoZSByZXN1bHQgb2YgbXVsdGlwbHlpbmcgeCBhbmQgeSwgdGhyb3dpbmcgYW4gZXhjZXB0aW9uIGluIGNhc2Ugb2Ygb3ZlcmZsb3cuKi8KICAgIGZ1bmN0aW9uIHNhZmVNdWwodWludCB4LCB1aW50IHkpCiAgICAgICAgcHVyZQogICAgICAgIGludGVybmFsCiAgICAgICAgcmV0dXJucyAodWludCkKICAgIHsKICAgICAgICBpZiAoeCA9PSAwKSB7CiAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgIH0KICAgICAgICB1aW50IHAgPSB4ICogeTsKICAgICAgICByZXF1aXJlKHAgLyB4ID09IHkpOwogICAgICAgIHJldHVybiBwOwogICAgfQoKICAgIC8qIFJldHVybiB0aGUgcmVzdWx0IG9mIG11bHRpcGx5aW5nIHggYW5kIHksIGludGVycHJldGluZyB0aGUgb3BlcmFuZHMgYXMgZml4ZWQtcG9pbnQKICAgICAqIGRlbWljaW1hbHMuIFRocm93cyBhbiBleGNlcHRpb24gaW4gY2FzZSBvZiBvdmVyZmxvdy4gQSB1bml0IGZhY3RvciBpcyBkaXZpZGVkIG91dAogICAgICogYWZ0ZXIgdGhlIHByb2R1Y3Qgb2YgeCBhbmQgeSBpcyBldmFsdWF0ZWQsIHNvIHRoYXQgcHJvZHVjdCBtdXN0IGJlIGxlc3MgdGhhbiAyKioyNTYuCiAgICAgKiAKICAgICAqIEluY2lkZW50YWxseSwgdGhlIGludGVybmFsIGRpdmlzaW9uIGFsd2F5cyByb3VuZHMgZG93bjogd2UgY291bGQgaGF2ZSByb3VuZGVkIHRvIHRoZSBuZWFyZXN0IGludGVnZXIsCiAgICAgKiBidXQgdGhlbiB3ZSB3b3VsZCBiZSBzcGVuZGluZyBhIHNpZ25pZmljYW50IGZyYWN0aW9uIG9mIGEgY2VudCAob2Ygb3JkZXIgYSBtaWNyb2V0aGVyCiAgICAgKiBhdCBwcmVzZW50IGdhcyBwcmljZXMpIGluIG9yZGVyIHRvIHNhdmUgbGVzcyB0aGFuIG9uZSBwYXJ0IGluIDAuNSAqIDEwXjE4IHBlciBvcGVyYXRpb24sIGlmIHRoZSBvcGVyYW5kcwogICAgICogY29udGFpbiBzbWFsbCBlbm91Z2ggZnJhY3Rpb25hbCBjb21wb25lbnRzLiBJdCB3b3VsZCBhbHNvIG1hcmdpbmFsbHkgZGltaW5pc2ggdGhlIAogICAgICogZG9tYWluIHRoaXMgZnVuY3Rpb24gaXMgZGVmaW5lZCB1cG9uLiAKICAgICAqLwogICAgZnVuY3Rpb24gc2FmZU11bF9kZWModWludCB4LCB1aW50IHkpCiAgICAgICAgcHVyZQogICAgICAgIGludGVybmFsCiAgICAgICAgcmV0dXJucyAodWludCkKICAgIHsKICAgICAgICAvLyBEaXZpZGUgYnkgVU5JVCB0byByZW1vdmUgdGhlIGV4dHJhIGZhY3RvciBpbnRyb2R1Y2VkIGJ5IHRoZSBwcm9kdWN0LgogICAgICAgIC8vIFVOSVQgYmUgMC4KICAgICAgICByZXR1cm4gc2FmZU11bCh4LCB5KSAvIFVOSVQ7CgogICAgfQoKICAgIC8qIFRydWUgaWZmIHRoZSBkZW5vbWluYXRvciBvZiB4L3kgaXMgbm9uemVyby4gKi8KICAgIGZ1bmN0aW9uIGRpdklzU2FmZSh1aW50IHgsIHVpbnQgeSkKICAgICAgICBwdXJlCiAgICAgICAgaW50ZXJuYWwKICAgICAgICByZXR1cm5zIChib29sKQogICAgewogICAgICAgIHJldHVybiB5ICE9IDA7CiAgICB9CgogICAgLyogUmV0dXJuIHRoZSByZXN1bHQgb2YgZGl2aWRpbmcgeCBieSB5LCB0aHJvd2luZyBhbiBleGNlcHRpb24gaWYgdGhlIGRpdmlzb3IgaXMgemVyby4gKi8KICAgIGZ1bmN0aW9uIHNhZmVEaXYodWludCB4LCB1aW50IHkpCiAgICAgICAgcHVyZQogICAgICAgIGludGVybmFsCiAgICAgICAgcmV0dXJucyAodWludCkKICAgIHsKICAgICAgICAvLyBBbHRob3VnaCBhIDAgZGVub21pbmF0b3IgYWxyZWFkeSB0aHJvd3MgYW4gZXhjZXB0aW9uLAogICAgICAgIC8vIGl0IGlzIGVxdWl2YWxlbnQgdG8gYSBUSFJPVyBvcGVyYXRpb24sIHdoaWNoIGNvbnN1bWVzIGFsbCBnYXMuCiAgICAgICAgLy8gQSByZXF1aXJlIHN0YXRlbWVudCBlbWl0cyBSRVZFUlQgaW5zdGVhZCwgd2hpY2ggcmVtaXRzIHJlbWFpbmluZyBnYXMuCiAgICAgICAgcmVxdWlyZSh5ICE9IDApOwogICAgICAgIHJldHVybiB4IC8geTsKICAgIH0KCiAgICAvKiBSZXR1cm4gdGhlIHJlc3VsdCBvZiBkaXZpZGluZyB4IGJ5IHksIGludGVycHJldGluZyB0aGUgb3BlcmFuZHMgYXMgZml4ZWQgcG9pbnQgZGVjaW1hbCBudW1iZXJzLgogICAgICogVGhyb3dzIGFuIGV4Y2VwdGlvbiBpbiBjYXNlIG9mIG92ZXJmbG93IG9yIHplcm8gZGl2aXNvcjsgeCBtdXN0IGJlIGxlc3MgdGhhbiAyXjI1NiAvIFVOSVQuCiAgICAgKiBJbnRlcm5hbCByb3VuZGluZyBpcyBkb3dud2FyZDogYSBzaW1pbGFyIGNhdmVhdCBob2xkcyBhcyB3aXRoIHNhZmVEZWNNdWwoKS4qLwogICAgZnVuY3Rpb24gc2FmZURpdl9kZWModWludCB4LCB1aW50IHkpCiAgICAgICAgcHVyZQogICAgICAgIGludGVybmFsCiAgICAgICAgcmV0dXJucyAodWludCkKICAgIHsKICAgICAgICAvLyBSZWludHJvZHVjZSB0aGUgVU5JVCBmYWN0b3IgdGhhdCB3aWxsIGJlIGRpdmlkZWQgb3V0IGJ5IHkuCiAgICAgICAgcmV0dXJuIHNhZmVEaXYoc2FmZU11bCh4LCBVTklUKSwgeSk7CiAgICB9CgogICAgLyogQ29udmVydCBhbiB1bnNpZ25lZCBpbnRlZ2VyIHRvIGEgdW5zaWduZWQgZml4ZWQtcG9pbnQgZGVjaW1hbC4KICAgICAqIFRocm93IGFuIGV4Y2VwdGlvbiBpZiB0aGUgcmVzdWx0IHdvdWxkIGJlIG91dCBvZiByYW5nZS4gKi8KICAgIGZ1bmN0aW9uIGludFRvRGVjKHVpbnQgaSkKICAgICAgICBwdXJlCiAgICAgICAgaW50ZXJuYWwKICAgICAgICByZXR1cm5zICh1aW50KQogICAgewogICAgICAgIHJldHVybiBzYWZlTXVsKGksIFVOSVQpOwogICAgfQp9CgovKgotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQpDT05UUkFDVCBERVNDUklQVElPTgotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoKVGhpcyBjb3VydCBwcm92aWRlcyB0aGUgbm9taW4gY29udHJhY3Qgd2l0aCBhIGNvbmZpc2NhdGlvbgpmYWNpbGl0eSwgaWYgZW5vdWdoIGhhdnZlbiBvd25lcnMgdm90ZSB0byBjb25maXNjYXRlIGEgdGFyZ2V0CmFjY291bnQncyBub21pbnMuCgpUaGlzIGlzIGRlc2lnbmVkIHRvIHByb3ZpZGUgYSBtZWNoYW5pc20gdG8gcmVzcG9uZCB0byBhYnVzaXZlCmNvbnRyYWN0cyBzdWNoIGFzIG5vbWluIHdyYXBwZXJzLCB3aGljaCB3b3VsZCBhbGxvdyB1c2VycyB0bwp0cmFkZSB3cmFwcGVkIG5vbWlucyB3aXRob3V0IGFjY3J1aW5nIGZlZXMgb24gdGhvc2UgdHJhbnNhY3Rpb25zLgoKSW4gb3JkZXIgdG8gcHJldmVudCB0eXJhbm55LCBhbiBhY2NvdW50IG1heSBvbmx5IGJlIGZyb3plbiBpZgp1c2VycyBjb250cm9sbGluZyBhdCBsZWFzdCAzMCUgb2YgdGhlIHZhbHVlIG9mIGhhdnZlbnMgcGFydGljaXBhdGUsCmFuZCBhIHR3byB0aGlyZHMgbWFqb3JpdHkgaXMgYXR0YWluZWQgaW4gdGhhdCB2b3RlLgpJbiBvcmRlciB0byBwcmV2ZW50IHR5cmFubnkgb2YgdGhlIG1ham9yaXR5IG9yIG1vYiBqdXN0aWNlLApjb25maXNjYXRpb24gbW90aW9ucyBhcmUgb25seSBhcHByb3ZlZCBpZiB0aGUgaGF2dmVuIGZvdW5kYXRpb24KYXBwcm92ZXMgdGhlIHJlc3VsdC4KVGhpcyBsYXR0ZXIgcmVxdWlyZW1lbnQgbWF5IGJlIGxpZnRlZCBpbiBmdXR1cmUgdmVyc2lvbnMuCgpUaGUgZm91bmRhdGlvbiwgb3IgYW55IHVzZXIgd2l0aCBhIHN1ZmZpY2llbnQgaGF2dmVuIGJhbGFuY2UgbWF5IGJyaW5nIGEKY29uZmlzY2F0aW9uIG1vdGlvbi4KQSBtb3Rpb24gbGFzdHMgZm9yIGEgZGVmYXVsdCBwZXJpb2Qgb2Ygb25lIHdlZWssIHdpdGggYSBmdXJ0aGVyIGNvbmZpcm1hdGlvbgpwZXJpb2QgaW4gd2hpY2ggdGhlIGZvdW5kYXRpb24gYXBwcm92ZXMgdGhlIHJlc3VsdC4KVGhlIGxhdHRlciBwZXJpb2QgbWF5IGNvbmNsdWRlIGVhcmx5IHVwb24gdGhlIGZvdW5kYXRpb24ncyBkZWNpc2lvbiB0byBlaXRoZXIKdmV0byBvciBhcHByb3ZlIHRoZSBtb290ZWQgY29uZmlzY2F0aW9uIG1vdGlvbi4KSWYgdGhlIGNvbmZpcm1hdGlvbiBwZXJpb2QgZWxhcHNlcyB3aXRob3V0IHRoZSBmb3VuZGF0aW9uIG1ha2luZyBhIGRlY2lzaW9uLAp0aGUgbW90aW9uIGZhaWxzLgoKVGhlIHdlaWdodCBvZiBhIGhhdnZlbiBob2xkZXIncyB2b3RlIGlzIGRldGVybWluZWQgYnkgZXhhbWluaW5nIHRoZWlyCmF2ZXJhZ2UgYmFsYW5jZSBvdmVyIHRoZSBsYXN0IGNvbXBsZXRlZCBmZWUgcGVyaW9kIHByaW9yIHRvIHRoZQpiZWdpbm5pbmcgb2YgYSBnaXZlbiBtb3Rpb24uClRodXMsIHNpbmNlIGEgZmVlIHBlcmlvZCBjYW4gcm9sbCBvdmVyIGluIHRoZSBtaWRkbGUgb2YgYSBtb3Rpb24sIHdlIG11c3QKYWxzbyB0cmFjayBhIHVzZXIncyBhdmVyYWdlIGJhbGFuY2Ugb2YgdGhlIGxhc3QgdHdvIHBlcmlvZHMuClRoaXMgc3lzdGVtIGlzIGRlc2lnbmVkIHN1Y2ggdGhhdCBpdCBjYW5ub3QgYmUgYXR0YWNrZWQgYnkgdXNlcnMgdHJhbnNmZXJyaW5nCmZ1bmRzIGJldHdlZW4gdGhlbXNlbHZlcywgd2hpbGUgYWxzbyBub3QgcmVxdWlyaW5nIHRoZW0gdG8gbG9jayB0aGVpciBoYXZ2ZW5zCmZvciB0aGUgZHVyYXRpb24gb2YgdGhlIHZvdGUuIFRoaXMgaXMgcG9zc2libGUgc2luY2UgYW55IHRyYW5zZmVyIHRoYXQgaW5jcmVhc2VzCnRoZSBhdmVyYWdlIGJhbGFuY2UgaW4gb25lIGFjY291bnQgd2lsbCBiZSByZWZsZWN0ZWQgYnkgYW4gZXF1aXZhbGVudCByZWR1Y3Rpb24KaW4gdGhlIHZvdGluZyB3ZWlnaHQgaW4gdGhlIG90aGVyLgpBdCBwcmVzZW50IGEgdXNlciBtYXkgY2FzdCBhIHZvdGUgb25seSBmb3Igb25lIG1vdGlvbiBhdCBhIHRpbWUsCmJ1dCBtYXkgY2FuY2VsIHRoZWlyIHZvdGUgYXQgYW55IHRpbWUgZXhjZXB0IGR1cmluZyB0aGUgY29uZmlybWF0aW9uIHBlcmlvZCwKd2hlbiB0aGUgdm90ZSB0YWxsaWVzIG11c3QgcmVtYWluIHN0YXRpYyB1bnRpbCB0aGUgbWF0dGVyIGhhcyBiZWVuIHNldHRsZWQuCgpBIG1vdGlvbiB0byBjb25maXNjYXRlIHRoZSBiYWxhbmNlIG9mIGEgZ2l2ZW4gYWRkcmVzcyBjb21wb3NlcwphIHN0YXRlIG1hY2hpbmUgYnVpbHQgb2YgdGhlIGZvbGxvd2luZyBzdGF0ZXM6CgoKV2FpdGluZzoKICAtIEEgdXNlciB3aXRoIHN0YW5kaW5nIGJyaW5ncyBhIG1vdGlvbjoKICAgIElmIHRoZSB0YXJnZXQgYWRkcmVzcyBpcyBub3QgZnJvemVuOwogICAgaW5pdGlhbGlzZSB2b3RlIHRhbGxpZXMgdG8gMDsKICAgIHRyYW5zaXRpb24gdG8gdGhlIFZvdGluZyBzdGF0ZS4KCiAgLSBBbiBhY2NvdW50IGNhbmNlbHMgYSBwcmV2aW91cyByZXNpZHVhbCB2b3RlOgogICAgcmVtYWluIGluIHRoZSBXYWl0aW5nIHN0YXRlLgoKVm90aW5nOgogIC0gVGhlIGZvdW5kYXRpb24gdmV0b2VzIHRoZSBpbi1wcm9ncmVzcyBtb3Rpb246CiAgICB0cmFuc2l0aW9uIHRvIHRoZSBXYWl0aW5nIHN0YXRlLgoKICAtIFRoZSB2b3RpbmcgcGVyaW9kIGVsYXBzZXM6CiAgICB0cmFuc2l0aW9uIHRvIHRoZSBDb25maXJtYXRpb24gc3RhdGUuCgogIC0gQW4gYWNjb3VudCB2b3RlcyAoZm9yIG9yIGFnYWluc3QgdGhlIG1vdGlvbik6CiAgICBpdHMgd2VpZ2h0IGlzIGFkZGVkIHRvIHRoZSBhcHByb3ByaWF0ZSB0YWxseTsKICAgIHJlbWFpbiBpbiB0aGUgVm90aW5nIHN0YXRlLgoKICAtIEFuIGFjY291bnQgY2FuY2VscyBpdHMgcHJldmlvdXMgdm90ZToKICAgIGl0cyB3ZWlnaHQgaXMgZGVkdWN0ZWQgZnJvbSB0aGUgYXBwcm9wcmlhdGUgdGFsbHkgKGlmIGFueSk7CiAgICByZW1haW4gaW4gdGhlIFZvdGluZyBzdGF0ZS4KCkNvbmZpcm1hdGlvbjoKICAtIFRoZSBmb3VuZGF0aW9uIHZldG9lcyB0aGUgY29tcGxldGVkIG1vdGlvbjoKICAgIHRyYW5zaXRpb24gdG8gdGhlIFdhaXRpbmcgc3RhdGUuCgogIC0gVGhlIGZvdW5kYXRpb24gYXBwcm92ZXMgY29uZmlzY2F0aW9uIG9mIHRoZSB0YXJnZXQgYWNjb3VudDoKICAgIGZyZWV6ZSB0aGUgdGFyZ2V0IGFjY291bnQsIHRyYW5zZmVyIGl0cyBub21pbiBiYWxhbmNlIHRvIHRoZSBmZWUgcG9vbDsKICAgIHRyYW5zaXRpb24gdG8gdGhlIFdhaXRpbmcgc3RhdGUuCgogIC0gVGhlIGNvbmZpcm1hdGlvbiBwZXJpb2QgZWxhcHNlczoKICAgIHRyYW5zaXRpb24gdG8gdGhlIFdhaXRpbmcgc3RhdGUuCgoKVXNlciB2b3RlcyBhcmUgbm90IGF1dG9tYXRpY2FsbHkgY2FuY2VsbGVkIHVwb24gdGhlIGNvbmNsdXNpb24gb2YgYSBtb3Rpb24uClRoZXJlZm9yZSwgYWZ0ZXIgYSBtb3Rpb24gY29tZXMgdG8gYSBjb25jbHVzaW9uLCBpZiBhIHVzZXIgd2lzaGVzIHRvIHZvdGUgCmluIGFub3RoZXIgbW90aW9uLCB0aGV5IG11c3QgbWFudWFsbHkgY2FuY2VsIHRoZWlyIHZvdGUgaW4gb3JkZXIgdG8gZG8gc28uCgpUaGlzIHByb2NlZHVyZSBpcyBkZXNpZ25lZCB0byBiZSByZWxhdGl2ZWx5IHNpbXBsZS4KVGhlcmUgYXJlIHNvbWUgdGhpbmdzIHRoYXQgY2FuIGJlIGFkZGVkIHRvIGVuaGFuY2UgdGhlIGZ1bmN0aW9uYWxpdHkKYXQgdGhlIGV4cGVuc2Ugb2Ygc2ltcGxpY2l0eSBhbmQgZWZmaWNpZW5jeToKICAKICAtIERlbW9jcmF0aWMgdW5mcmVlemluZyBvZiBub21pbiBhY2NvdW50cyAoaW5kdWNlcyBtdWx0aXBsZSBjYXRlZ29yaWVzIG9mIHZvdGUpCiAgLSBDb25maWd1cmFibGUgcGVyLXZvdGUgZHVyYXRpb25zOwogIC0gVm90ZSBzdGFuZGluZyBkZW5vbWluYXRlZCBpbiBhIGZpYXQgcXVhbnRpdHkgcmF0aGVyIHRoYW4gYSBxdWFudGl0eSBvZiBoYXZ2ZW5zOwogIC0gQ29uZmlzY2F0ZSBmcm9tIG11bHRpcGxlIGFkZHJlc3NlcyBpbiBhIHNpbmdsZSB2b3RlOwoKV2UgbWlnaHQgY29uc2lkZXIgdXBkYXRpbmcgdGhlIGNvbnRyYWN0IHdpdGggYW55IG9mIHRoZXNlIGZlYXR1cmVzIGF0IGEgbGF0ZXIgZGF0ZSBpZiBuZWNlc3NhcnkuCgotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoqLwoKY29udHJhY3QgQ291cnQgaXMgT3duZWQsIFNhZmVEZWNpbWFsTWF0aCB7CgogICAgLyogPT09PT09PT09PSBTVEFURSBWQVJJQUJMRVMgPT09PT09PT09PSAqLwoKICAgIC8vIFRoZSBhZGRyZXNzZXMgb2YgdGhlIHRva2VuIGNvbnRyYWN0cyB0aGlzIGNvbmZpc2NhdGlvbiBjb3VydCBpbnRlcmFjdHMgd2l0aC4KICAgIEhhdnZlbiBwdWJsaWMgaGF2dmVuOwogICAgRXRoZXJOb21pbiBwdWJsaWMgbm9taW47CgogICAgLy8gVGhlIG1pbmltdW0gaGF2dmVuIGJhbGFuY2UgcmVxdWlyZWQgdG8gYmUgY29uc2lkZXJlZCB0byBoYXZlIHN0YW5kaW5nCiAgICAvLyB0byBiZWdpbiBjb25maXNjYXRpb24gcHJvY2VlZGluZ3MuCiAgICB1aW50IHB1YmxpYyBtaW5TdGFuZGluZ0JhbGFuY2UgPSAxMDAgKiBVTklUOwoKICAgIC8vIFRoZSB2b3RpbmcgcGVyaW9kIGxhc3RzIGZvciB0aGlzIGR1cmF0aW9uLAogICAgLy8gYW5kIGlmIHNldCwgbXVzdCBmYWxsIHdpdGhpbiB0aGUgZ2l2ZW4gYm91bmRzLgogICAgdWludCBwdWJsaWMgdm90aW5nUGVyaW9kID0gMSB3ZWVrczsKICAgIHVpbnQgY29uc3RhbnQgTUlOX1ZPVElOR19QRVJJT0QgPSAzIGRheXM7CiAgICB1aW50IGNvbnN0YW50IE1BWF9WT1RJTkdfUEVSSU9EID0gNCB3ZWVrczsKCiAgICAvLyBEdXJhdGlvbiBvZiB0aGUgcGVyaW9kIGR1cmluZyB3aGljaCB0aGUgZm91bmRhdGlvbiBtYXkgY29uZmlybQogICAgLy8gb3IgdmV0byBhIG1vdGlvbiB0aGF0IGhhcyBjb25jbHVkZWQuCiAgICAvLyBJZiBzZXQsIHRoZSBjb25maXJtYXRpb24gZHVyYXRpb24gbXVzdCBmYWxsIHdpdGhpbiB0aGUgZ2l2ZW4gYm91bmRzLgogICAgdWludCBwdWJsaWMgY29uZmlybWF0aW9uUGVyaW9kID0gMSB3ZWVrczsKICAgIHVpbnQgY29uc3RhbnQgTUlOX0NPTkZJUk1BVElPTl9QRVJJT0QgPSAxIGRheXM7CiAgICB1aW50IGNvbnN0YW50IE1BWF9DT05GSVJNQVRJT05fUEVSSU9EID0gMiB3ZWVrczsKCiAgICAvLyBObyBmZXdlciB0aGFuIHRoaXMgZnJhY3Rpb24gb2YgaGF2dmVucyBtdXN0IHBhcnRpY2lwYXRlIGluIGEgbW90aW9uCiAgICAvLyBpbiBvcmRlciBmb3IgYSBxdW9ydW0gdG8gYmUgcmVhY2hlZC4KICAgIC8vIFRoZSBwYXJ0aWNpcGF0aW9uIGZyYWN0aW9uIHJlcXVpcmVkIG1heSBiZSBzZXQgbm8gbG93ZXIgdGhhbiAxMCUuCiAgICB1aW50IHB1YmxpYyByZXF1aXJlZFBhcnRpY2lwYXRpb24gPSAzICogVU5JVCAvIDEwOwogICAgdWludCBjb25zdGFudCBNSU5fUkVRVUlSRURfUEFSVElDSVBBVElPTiA9IFVOSVQgLyAxMDsKCiAgICAvLyBBdCBsZWFzdCB0aGlzIGZyYWN0aW9uIG9mIHBhcnRpY2lwYXRpbmcgdm90ZXMgbXVzdCBiZSBpbiBmYXZvdXIgb2YKICAgIC8vIGNvbmZpc2NhdGlvbiBmb3IgdGhlIG1vdGlvbiB0byBwYXNzLgogICAgLy8gVGhlIHJlcXVpcmVkIG1ham9yaXR5IG1heSBiZSBubyBsb3dlciB0aGFuIDUwJS4KICAgIHVpbnQgcHVibGljIHJlcXVpcmVkTWFqb3JpdHkgPSAoMiAqIFVOSVQpIC8gMzsKICAgIHVpbnQgY29uc3RhbnQgTUlOX1JFUVVJUkVEX01BSk9SSVRZID0gVU5JVCAvIDI7CgogICAgLy8gVGhlIG5leHQgSUQgdG8gdXNlIGZvciBvcGVuaW5nIGEgbW90aW9uLgogICAgdWludCBuZXh0TW90aW9uSUQgPSAxOwoKICAgIC8vIE1hcHBpbmcgZnJvbSBtb3Rpb24gSURzIHRvIHRhcmdldCBhZGRyZXNzZXMuCiAgICBtYXBwaW5nKHVpbnQgPT4gYWRkcmVzcykgcHVibGljIG1vdGlvblRhcmdldDsKCiAgICAvLyBUaGUgSUQgYSBtb3Rpb24gb24gYW4gYWRkcmVzcyBpcyBjdXJyZW50bHkgb3BlcmF0aW5nIGF0LgogICAgLy8gWmVybyBpZiBubyBzdWNoIG1vdGlvbiBpcyBydW5uaW5nLgogICAgbWFwcGluZyhhZGRyZXNzID0+IHVpbnQpIHB1YmxpYyB0YXJnZXRNb3Rpb25JRDsKCiAgICAvLyBUaGUgdGltZXN0YW1wIGF0IHdoaWNoIGEgbW90aW9uIGJlZ2FuLiBUaGlzIGlzIHVzZWQgdG8gZGV0ZXJtaW5lCiAgICAvLyB3aGV0aGVyIGEgbW90aW9uIGlzOiBydW5uaW5nLCBpbiB0aGUgY29uZmlybWF0aW9uIHBlcmlvZCwKICAgIC8vIG9yIGhhcyBjb25jbHVkZWQuCiAgICAvLyBBIG1vdGlvbiBydW5zIGZyb20gaXRzIHN0YXJ0IHRpbWUgdCB1bnRpbCAodCArIHZvdGluZ1BlcmlvZCksCiAgICAvLyBhbmQgdGhlbiB0aGUgY29uZmlybWF0aW9uIHBlcmlvZCB0ZXJtaW5hdGVzIG5vIGxhdGVyIHRoYW4KICAgIC8vICh0ICsgdm90aW5nUGVyaW9kICsgY29uZmlybWF0aW9uUGVyaW9kKS4KICAgIG1hcHBpbmcodWludCA9PiB1aW50KSBwdWJsaWMgbW90aW9uU3RhcnRUaW1lOwoKICAgIC8vIFRoZSB0YWxsaWVzIGZvciBhbmQgYWdhaW5zdCBjb25maXNjYXRpb24gb2YgYSBnaXZlbiBiYWxhbmNlLgogICAgLy8gVGhlc2UgYXJlIHNldCB0byB6ZXJvIGF0IHRoZSBzdGFydCBvZiBhIG1vdGlvbiwgYW5kIGFsc28gb24gY29uY2x1c2lvbiwKICAgIC8vIGp1c3QgdG8ga2VlcCB0aGUgc3RhdGUgY2xlYW4uCiAgICBtYXBwaW5nKHVpbnQgPT4gdWludCkgcHVibGljIHZvdGVzRm9yOwogICAgbWFwcGluZyh1aW50ID0+IHVpbnQpIHB1YmxpYyB2b3Rlc0FnYWluc3Q7CgogICAgLy8gVGhlIGxhc3QvcGVudWx0aW1hdGUgYXZlcmFnZSBiYWxhbmNlIG9mIGEgdXNlciBhdCB0aGUgdGltZSB0aGV5IHZvdGVkCiAgICAvLyBpbiBhIHBhcnRpY3VsYXIgbW90aW9uLgogICAgLy8gSWYgd2UgZGlkIG5vdCBzYXZlIHRoaXMgaW5mb3JtYXRpb24gdGhlbiB3ZSB3b3VsZCBoYXZlIHRvCiAgICAvLyBkaXNhbGxvdyB0cmFuc2ZlcnMgaW50byBhbiBhY2NvdW50IGxlc3QgaXQgY2FuY2VsIGEgdm90ZQogICAgLy8gd2l0aCBncmVhdGVyIHdlaWdodCB0aGFuIHRoYXQgd2l0aCB3aGljaCBpdCBvcmlnaW5hbGx5IHZvdGVkLAogICAgLy8gYW5kIHRoZSBmZWUgcGVyaW9kIHJvbGxlZCBvdmVyIGluIGJldHdlZW4uCiAgICBtYXBwaW5nKGFkZHJlc3MgPT4gbWFwcGluZyh1aW50ID0+IHVpbnQpKSB2b3RlV2VpZ2h0OwoKICAgIC8vIFRoZSBwb3NzaWJsZSB2b3RlIHR5cGVzLgogICAgLy8gQWJzdGVudGlvbjogbm90IHBhcnRpY2lwYXRpbmcgaW4gYSBtb3Rpb247IFRoaXMgaXMgdGhlIGRlZmF1bHQgdmFsdWUuCiAgICAvLyBZZWE6IHZvdGluZyBpbiBmYXZvdXIgb2YgYSBtb3Rpb24uCiAgICAvLyBOYXk6IHZvdGluZyBhZ2FpbnN0IGEgbW90aW9uLgogICAgZW51bSBWb3RlIHtBYnN0ZW50aW9uLCBZZWEsIE5heX0KCiAgICAvLyBBIGdpdmVuIGFjY291bnQncyB2b3RlIGluIHNvbWUgY29uZmlzY2F0aW9uIG1vdGlvbi4KICAgIC8vIFRoaXMgcmVxdWlyZXMgdGhlIGRlZmF1bHQgdmFsdWUgb2YgdGhlIFZvdGUgZW51bSB0byBjb3JyZXNwb25kIHRvIGFuIGFic3RlbnRpb24uCiAgICBtYXBwaW5nKGFkZHJlc3MgPT4gbWFwcGluZyh1aW50ID0+IFZvdGUpKSBwdWJsaWMgdm90ZTsKCiAgICAvKiA9PT09PT09PT09IENPTlNUUlVDVE9SID09PT09PT09PT0gKi8KCiAgICBmdW5jdGlvbiBDb3VydChIYXZ2ZW4gX2hhdnZlbiwgRXRoZXJOb21pbiBfbm9taW4sIGFkZHJlc3MgX293bmVyKQogICAgICAgIE93bmVkKF9vd25lcikKICAgICAgICBwdWJsaWMKICAgIHsKICAgICAgICBoYXZ2ZW4gPSBfaGF2dmVuOwogICAgICAgIG5vbWluID0gX25vbWluOwogICAgfQoKCiAgICAvKiA9PT09PT09PT09IFNFVFRFUlMgPT09PT09PT09PSAqLwoKICAgIGZ1bmN0aW9uIHNldE1pblN0YW5kaW5nQmFsYW5jZSh1aW50IGJhbGFuY2UpCiAgICAgICAgZXh0ZXJuYWwKICAgICAgICBvbmx5T3duZXIKICAgIHsKICAgICAgICAvLyBObyByZXF1aXJlbWVudCBvbiB0aGUgc3RhbmRpbmcgdGhyZXNob2xkIGhlcmU7CiAgICAgICAgLy8gdGhlIGZvdW5kYXRpb24gY2FuIHNldCB0aGlzIHZhbHVlIHN1Y2ggdGhhdAogICAgICAgIC8vIGFueW9uZSBvciBubyBvbmUgY2FuIGFjdHVhbGx5IHN0YXJ0IGEgbW90aW9uLgogICAgICAgIG1pblN0YW5kaW5nQmFsYW5jZSA9IGJhbGFuY2U7CiAgICB9CgogICAgZnVuY3Rpb24gc2V0Vm90aW5nUGVyaW9kKHVpbnQgZHVyYXRpb24pCiAgICAgICAgZXh0ZXJuYWwKICAgICAgICBvbmx5T3duZXIKICAgIHsKICAgICAgICByZXF1aXJlKE1JTl9WT1RJTkdfUEVSSU9EIDw9IGR1cmF0aW9uICYmCiAgICAgICAgICAgICAgICBkdXJhdGlvbiA8PSBNQVhfVk9USU5HX1BFUklPRCk7CiAgICAgICAgLy8gUmVxdWlyZSB0aGF0IHRoZSB2b3RpbmcgcGVyaW9kIGlzIG5vIGxvbmdlciB0aGFuIGEgc2luZ2xlIGZlZSBwZXJpb2QsCiAgICAgICAgLy8gU28gdGhhdCBhIHNpbmdsZSB2b3RlIGNhbiBzcGFuIGF0IG1vc3QgdHdvIGZlZSBwZXJpb2RzLgogICAgICAgIHJlcXVpcmUoZHVyYXRpb24gPD0gaGF2dmVuLnRhcmdldEZlZVBlcmlvZER1cmF0aW9uU2Vjb25kcygpKTsKICAgICAgICB2b3RpbmdQZXJpb2QgPSBkdXJhdGlvbjsKICAgIH0KCiAgICBmdW5jdGlvbiBzZXRDb25maXJtYXRpb25QZXJpb2QodWludCBkdXJhdGlvbikKICAgICAgICBleHRlcm5hbAogICAgICAgIG9ubHlPd25lcgogICAgewogICAgICAgIHJlcXVpcmUoTUlOX0NPTkZJUk1BVElPTl9QRVJJT0QgPD0gZHVyYXRpb24gJiYKICAgICAgICAgICAgICAgIGR1cmF0aW9uIDw9IE1BWF9DT05GSVJNQVRJT05fUEVSSU9EKTsKICAgICAgICBjb25maXJtYXRpb25QZXJpb2QgPSBkdXJhdGlvbjsKICAgIH0KCiAgICBmdW5jdGlvbiBzZXRSZXF1aXJlZFBhcnRpY2lwYXRpb24odWludCBmcmFjdGlvbikKICAgICAgICBleHRlcm5hbAogICAgICAgIG9ubHlPd25lcgogICAgewogICAgICAgIHJlcXVpcmUoTUlOX1JFUVVJUkVEX1BBUlRJQ0lQQVRJT04gPD0gZnJhY3Rpb24pOwogICAgICAgIHJlcXVpcmVkUGFydGljaXBhdGlvbiA9IGZyYWN0aW9uOwogICAgfQoKICAgIGZ1bmN0aW9uIHNldFJlcXVpcmVkTWFqb3JpdHkodWludCBmcmFjdGlvbikKICAgICAgICBleHRlcm5hbAogICAgICAgIG9ubHlPd25lcgogICAgewogICAgICAgIHJlcXVpcmUoTUlOX1JFUVVJUkVEX01BSk9SSVRZIDw9IGZyYWN0aW9uKTsKICAgICAgICByZXF1aXJlZE1ham9yaXR5ID0gZnJhY3Rpb247CiAgICB9CgoKICAgIC8qID09PT09PT09PT0gVklFVyBGVU5DVElPTlMgPT09PT09PT09PSAqLwoKICAgIC8qIFRoZXJlIGlzIGEgbW90aW9uIGluIHByb2dyZXNzIG9uIHRoZSBzcGVjaWZpZWQKICAgICAqIGFjY291bnQsIGFuZCB2b3RlcyBhcmUgYmVpbmcgYWNjZXB0ZWQgaW4gdGhhdCBtb3Rpb24uICovCiAgICBmdW5jdGlvbiBtb3Rpb25Wb3RpbmcodWludCBtb3Rpb25JRCkKICAgICAgICBwdWJsaWMKICAgICAgICB2aWV3CiAgICAgICAgcmV0dXJucyAoYm9vbCkKICAgIHsKICAgICAgICAvLyBObyBuZWVkIHRvIGNoZWNrIChzdGFydFRpbWUgPCBub3cpIGFzIHRoZXJlIGlzIG5vIHdheQogICAgICAgIC8vIHRvIHNldCBmdXR1cmUgc3RhcnQgdGltZXMgZm9yIHZvdGVzLgogICAgICAgIC8vIFRoZXNlIHZhbHVlcyBhcmUgdGltZXN0YW1wcywgdGhleSB3aWxsIG5vdCBvdmVyZmxvdwogICAgICAgIC8vIGFzIHRoZXkgY2FuIG9ubHkgZXZlciBiZSBpbml0aWFsaXNlZCB0byByZWxhdGl2ZWx5IHNtYWxsIHZhbHVlcy4KICAgICAgICByZXR1cm4gbm93IDwgbW90aW9uU3RhcnRUaW1lW21vdGlvbklEXSArIHZvdGluZ1BlcmlvZDsKICAgIH0KCiAgICAvKiBBIHZvdGUgb24gdGhlIHRhcmdldCBhY2NvdW50IGhhcyBjb25jbHVkZWQsIGJ1dCB0aGUgbW90aW9uCiAgICAgKiBoYXMgbm90IHlldCBiZWVuIGFwcHJvdmVkLCB2ZXRvZWQsIG9yIGNsb3NlZC4gKi8KICAgIGZ1bmN0aW9uIG1vdGlvbkNvbmZpcm1pbmcodWludCBtb3Rpb25JRCkKICAgICAgICBwdWJsaWMKICAgICAgICB2aWV3CiAgICAgICAgcmV0dXJucyAoYm9vbCkKICAgIHsKICAgICAgICAvLyBUaGVzZSB2YWx1ZXMgYXJlIHRpbWVzdGFtcHMsIHRoZXkgd2lsbCBub3Qgb3ZlcmZsb3cKICAgICAgICAvLyBhcyB0aGV5IGNhbiBvbmx5IGV2ZXIgYmUgaW5pdGlhbGlzZWQgdG8gcmVsYXRpdmVseSBzbWFsbCB2YWx1ZXMuCiAgICAgICAgdWludCBzdGFydFRpbWUgPSBtb3Rpb25TdGFydFRpbWVbbW90aW9uSURdOwogICAgICAgIHJldHVybiBzdGFydFRpbWUgKyB2b3RpbmdQZXJpb2QgPD0gbm93ICYmCiAgICAgICAgICAgICAgIG5vdyA8IHN0YXJ0VGltZSArIHZvdGluZ1BlcmlvZCArIGNvbmZpcm1hdGlvblBlcmlvZDsKICAgIH0KCiAgICAvKiBBIHZvdGUgbW90aW9uIGVpdGhlciBub3QgYmVndW4sIG9yIGl0IGhhcyBjb21wbGV0ZWx5IHRlcm1pbmF0ZWQuICovCiAgICBmdW5jdGlvbiBtb3Rpb25XYWl0aW5nKHVpbnQgbW90aW9uSUQpCiAgICAgICAgcHVibGljCiAgICAgICAgdmlldwogICAgICAgIHJldHVybnMgKGJvb2wpCiAgICB7CiAgICAgICAgLy8gVGhlc2UgdmFsdWVzIGFyZSB0aW1lc3RhbXBzLCB0aGV5IHdpbGwgbm90IG92ZXJmbG93CiAgICAgICAgLy8gYXMgdGhleSBjYW4gb25seSBldmVyIGJlIGluaXRpYWxpc2VkIHRvIHJlbGF0aXZlbHkgc21hbGwgdmFsdWVzLgogICAgICAgIHJldHVybiBtb3Rpb25TdGFydFRpbWVbbW90aW9uSURdICsgdm90aW5nUGVyaW9kICsgY29uZmlybWF0aW9uUGVyaW9kIDw9IG5vdzsKICAgIH0KCiAgICAvKiBJZiB0aGUgbW90aW9uIHdhcyB0byB0ZXJtaW5hdGUgYXQgdGhpcyBpbnN0YW50LCBpdCB3b3VsZCBwYXNzLgogICAgICogVGhhdCBpczogdGhlcmUgd2FzIHN1ZmZpY2llbnQgcGFydGljaXBhdGlvbiBhbmQgYSBzaXplYWJsZSBlbm91Z2ggbWFqb3JpdHkuICovCiAgICBmdW5jdGlvbiBtb3Rpb25QYXNzZXModWludCBtb3Rpb25JRCkKICAgICAgICBwdWJsaWMKICAgICAgICB2aWV3CiAgICAgICAgcmV0dXJucyAoYm9vbCkKICAgIHsKICAgICAgICB1aW50IHllYXMgPSB2b3Rlc0Zvclttb3Rpb25JRF07CiAgICAgICAgdWludCBuYXlzID0gdm90ZXNBZ2FpbnN0W21vdGlvbklEXTsKICAgICAgICB1aW50IHRvdGFsVm90ZXMgPSBzYWZlQWRkKHllYXMsIG5heXMpOwoKICAgICAgICBpZiAodG90YWxWb3RlcyA9PSAwKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIHVpbnQgcGFydGljaXBhdGlvbiA9IHNhZmVEaXZfZGVjKHRvdGFsVm90ZXMsIGhhdnZlbi50b3RhbFN1cHBseSgpKTsKICAgICAgICB1aW50IGZyYWN0aW9uSW5GYXZvdXIgPSBzYWZlRGl2X2RlYyh5ZWFzLCB0b3RhbFZvdGVzKTsKCiAgICAgICAgLy8gV2UgcmVxdWlyZSB0aGUgcmVzdWx0IHRvIGJlIHN0cmljdGx5IGdyZWF0ZXIgdGhhbiB0aGUgcmVxdWlyZW1lbnQKICAgICAgICAvLyB0byBlbmZvcmNlIGEgbWFqb3JpdHkgYmVpbmcgIjUwJSArIDEiLCBhbmQgc28gb24uCiAgICAgICAgcmV0dXJuIHBhcnRpY2lwYXRpb24gPiByZXF1aXJlZFBhcnRpY2lwYXRpb24gJiYKICAgICAgICAgICAgICAgZnJhY3Rpb25JbkZhdm91ciA+IHJlcXVpcmVkTWFqb3JpdHk7CiAgICB9CgogICAgZnVuY3Rpb24gaGFzVm90ZWQoYWRkcmVzcyBhY2NvdW50LCB1aW50IG1vdGlvbklEKQogICAgICAgIHB1YmxpYwogICAgICAgIHZpZXcKICAgICAgICByZXR1cm5zIChib29sKQogICAgewogICAgICAgIHJldHVybiB2b3RlW2FjY291bnRdW21vdGlvbklEXSAhPSBWb3RlLkFic3RlbnRpb247CiAgICB9CgoKICAgIC8qID09PT09PT09PT0gTVVUQVRJVkUgRlVOQ1RJT05TID09PT09PT09PT0gKi8KCiAgICAvKiBCZWdpbiBhIG1vdGlvbiB0byBjb25maXNjYXRlIHRoZSBmdW5kcyBpbiBhIGdpdmVuIG5vbWluIGFjY291bnQuCiAgICAgKiBPbmx5IHRoZSBmb3VuZGF0aW9uLCBvciBhY2NvdW50cyB3aXRoIHN1ZmZpY2llbnQgaGF2dmVuIGJhbGFuY2VzCiAgICAgKiBtYXkgZWxlY3QgdG8gc3RhcnQgc3VjaCBhIG1vdGlvbi4KICAgICAqIFJldHVybnMgdGhlIElEIG9mIHRoZSBtb3Rpb24gdGhhdCB3YXMgYmVndW4uICovCiAgICBmdW5jdGlvbiBiZWdpbk1vdGlvbihhZGRyZXNzIHRhcmdldCkKICAgICAgICBleHRlcm5hbAogICAgICAgIHJldHVybnMgKHVpbnQpCiAgICB7CiAgICAgICAgLy8gQSBjb25maXNjYXRpb24gbW90aW9uIG11c3QgYmUgbW9vdGVkIGJ5IHNvbWVvbmUgd2l0aCBzdGFuZGluZy4KICAgICAgICByZXF1aXJlKChoYXZ2ZW4uYmFsYW5jZU9mKG1zZy5zZW5kZXIpID49IG1pblN0YW5kaW5nQmFsYW5jZSkgfHwKICAgICAgICAgICAgICAgIG1zZy5zZW5kZXIgPT0gb3duZXIpOwoKICAgICAgICAvLyBSZXF1aXJlIHRoYXQgdGhlIHZvdGluZyBwZXJpb2QgaXMgbG9uZ2VyIHRoYW4gYSBzaW5nbGUgZmVlIHBlcmlvZCwKICAgICAgICAvLyBTbyB0aGF0IGEgc2luZ2xlIHZvdGUgY2FuIHNwYW4gYXQgbW9zdCB0d28gZmVlIHBlcmlvZHMuCiAgICAgICAgcmVxdWlyZSh2b3RpbmdQZXJpb2QgPD0gaGF2dmVuLnRhcmdldEZlZVBlcmlvZER1cmF0aW9uU2Vjb25kcygpKTsKCiAgICAgICAgLy8gVGhlcmUgbXVzdCBiZSBubyBjb25maXNjYXRpb24gbW90aW9uIGFscmVhZHkgcnVubmluZyBmb3IgdGhpcyBhY2NvdW50LgogICAgICAgIHJlcXVpcmUodGFyZ2V0TW90aW9uSURbdGFyZ2V0XSA9PSAwKTsKCiAgICAgICAgLy8gRGlzYWxsb3cgdm90ZXMgb24gYWNjb3VudHMgdGhhdCBoYXZlIHByZXZpb3VzbHkgYmVlbiBmcm96ZW4uCiAgICAgICAgcmVxdWlyZSghbm9taW4uZnJvemVuKHRhcmdldCkpOwoKICAgICAgICB1aW50IG1vdGlvbklEID0gbmV4dE1vdGlvbklEKys7CiAgICAgICAgbW90aW9uVGFyZ2V0W21vdGlvbklEXSA9IHRhcmdldDsKICAgICAgICB0YXJnZXRNb3Rpb25JRFt0YXJnZXRdID0gbW90aW9uSUQ7CgogICAgICAgIG1vdGlvblN0YXJ0VGltZVttb3Rpb25JRF0gPSBub3c7CiAgICAgICAgZW1pdCBNb3Rpb25CZWd1bihtc2cuc2VuZGVyLCBtc2cuc2VuZGVyLCB0YXJnZXQsIHRhcmdldCwgbW90aW9uSUQsIG1vdGlvbklEKTsKCiAgICAgICAgcmV0dXJuIG1vdGlvbklEOwogICAgfQoKICAgIC8qIFNoYXJlZCB2b3RlIHNldHVwIGZ1bmN0aW9uIGJldHdlZW4gdm90ZUZvciBhbmQgdm90ZUFnYWluc3QuCiAgICAgKiBSZXR1cm5zIHRoZSB2b3RlcidzIHZvdGUgd2VpZ2h0LiAqLwogICAgZnVuY3Rpb24gc2V0dXBWb3RlKHVpbnQgbW90aW9uSUQpCiAgICAgICAgaW50ZXJuYWwKICAgICAgICByZXR1cm5zICh1aW50KQogICAgewogICAgICAgIC8vIFRoZXJlIG11c3QgYmUgYW4gYWN0aXZlIHZvdGUgZm9yIHRoaXMgdGFyZ2V0IHJ1bm5pbmcuCiAgICAgICAgLy8gVm90ZSB0b3RhbHMgbXVzdCBvbmx5IGNoYW5nZSBkdXJpbmcgdGhlIHZvdGluZyBwaGFzZS4KICAgICAgICByZXF1aXJlKG1vdGlvblZvdGluZyhtb3Rpb25JRCkpOwoKICAgICAgICAvLyBUaGUgdm90ZXIgbXVzdCBub3QgaGF2ZSBhbiBhY3RpdmUgdm90ZSB0aGlzIG1vdGlvbi4KICAgICAgICByZXF1aXJlKCFoYXNWb3RlZChtc2cuc2VuZGVyLCBtb3Rpb25JRCkpOwoKICAgICAgICAvLyBUaGUgdm90ZXIgbWF5IG5vdCBjYXN0IHZvdGVzIG9uIHRoZW1zZWx2ZXMuCiAgICAgICAgcmVxdWlyZShtc2cuc2VuZGVyICE9IG1vdGlvblRhcmdldFttb3Rpb25JRF0pOwoKICAgICAgICAvLyBFbnN1cmUgdGhlIHZvdGVyJ3Mgdm90ZSB3ZWlnaHQgaXMgY3VycmVudC4KICAgICAgICBoYXZ2ZW4ucmVjb21wdXRlQWNjb3VudExhc3RBdmVyYWdlQmFsYW5jZShtc2cuc2VuZGVyKTsKCiAgICAgICAgdWludCB3ZWlnaHQ7CiAgICAgICAgLy8gV2UgdXNlIGEgZmVlIHBlcmlvZCBndWFyYW50ZWVkIHRvIGhhdmUgdGVybWluYXRlZCBiZWZvcmUKICAgICAgICAvLyB0aGUgc3RhcnQgb2YgdGhlIHZvdGUuIFNlbGVjdCB0aGUgcmlnaHQgcGVyaW9kIGlmCiAgICAgICAgLy8gYSBmZWUgcGVyaW9kIHJvbGxzIG92ZXIgaW4gdGhlIG1pZGRsZSBvZiB0aGUgdm90ZS4KICAgICAgICBpZiAobW90aW9uU3RhcnRUaW1lW21vdGlvbklEXSA8IGhhdnZlbi5mZWVQZXJpb2RTdGFydFRpbWUoKSkgewogICAgICAgICAgICB3ZWlnaHQgPSBoYXZ2ZW4ucGVudWx0aW1hdGVBdmVyYWdlQmFsYW5jZShtc2cuc2VuZGVyKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB3ZWlnaHQgPSBoYXZ2ZW4ubGFzdEF2ZXJhZ2VCYWxhbmNlKG1zZy5zZW5kZXIpOwogICAgICAgIH0KCiAgICAgICAgLy8gVXNlcnMgbXVzdCBoYXZlIGEgbm9uemVybyB2b3Rpbmcgd2VpZ2h0IHRvIHZvdGUuCiAgICAgICAgcmVxdWlyZSh3ZWlnaHQgPiAwKTsKCiAgICAgICAgdm90ZVdlaWdodFttc2cuc2VuZGVyXVttb3Rpb25JRF0gPSB3ZWlnaHQ7CgogICAgICAgIHJldHVybiB3ZWlnaHQ7CiAgICB9CgogICAgLyogVGhlIHNlbmRlciBjYXN0cyBhIHZvdGUgaW4gZmF2b3VyIG9mIGNvbmZpc2NhdGlvbiBvZiB0aGUKICAgICAqIHRhcmdldCBhY2NvdW50J3Mgbm9taW4gYmFsYW5jZS4gKi8KICAgIGZ1bmN0aW9uIHZvdGVGb3IodWludCBtb3Rpb25JRCkKICAgICAgICBleHRlcm5hbAogICAgewogICAgICAgIHVpbnQgd2VpZ2h0ID0gc2V0dXBWb3RlKG1vdGlvbklEKTsKICAgICAgICB2b3RlW21zZy5zZW5kZXJdW21vdGlvbklEXSA9IFZvdGUuWWVhOwogICAgICAgIHZvdGVzRm9yW21vdGlvbklEXSA9IHNhZmVBZGQodm90ZXNGb3JbbW90aW9uSURdLCB3ZWlnaHQpOwogICAgICAgIGVtaXQgVm90ZWRGb3IobXNnLnNlbmRlciwgbXNnLnNlbmRlciwgbW90aW9uSUQsIG1vdGlvbklELCB3ZWlnaHQpOwogICAgfQoKICAgIC8qIFRoZSBzZW5kZXIgY2FzdHMgYSB2b3RlIGFnYWluc3QgY29uZmlzY2F0aW9uIG9mIHRoZQogICAgICogdGFyZ2V0IGFjY291bnQncyBub21pbiBiYWxhbmNlLiAqLwogICAgZnVuY3Rpb24gdm90ZUFnYWluc3QodWludCBtb3Rpb25JRCkKICAgICAgICBleHRlcm5hbAogICAgewogICAgICAgIHVpbnQgd2VpZ2h0ID0gc2V0dXBWb3RlKG1vdGlvbklEKTsKICAgICAgICB2b3RlW21zZy5zZW5kZXJdW21vdGlvbklEXSA9IFZvdGUuTmF5OwogICAgICAgIHZvdGVzQWdhaW5zdFttb3Rpb25JRF0gPSBzYWZlQWRkKHZvdGVzQWdhaW5zdFttb3Rpb25JRF0sIHdlaWdodCk7CiAgICAgICAgZW1pdCBWb3RlZEFnYWluc3QobXNnLnNlbmRlciwgbXNnLnNlbmRlciwgbW90aW9uSUQsIG1vdGlvbklELCB3ZWlnaHQpOwogICAgfQoKICAgIC8qIENhbmNlbCBhbiBleGlzdGluZyB2b3RlIGJ5IHRoZSBzZW5kZXIgb24gYSBtb3Rpb24KICAgICAqIHRvIGNvbmZpc2NhdGUgdGhlIHRhcmdldCBiYWxhbmNlLiAqLwogICAgZnVuY3Rpb24gY2FuY2VsVm90ZSh1aW50IG1vdGlvbklEKQogICAgICAgIGV4dGVybmFsCiAgICB7CiAgICAgICAgLy8gQW4gYWNjb3VudCBtYXkgY2FuY2VsIGl0cyB2b3RlIGVpdGhlciBiZWZvcmUgdGhlIGNvbmZpcm1hdGlvbiBwaGFzZQogICAgICAgIC8vIHdoZW4gdGhlIG1vdGlvbiBpcyBzdGlsbCBvcGVuLCBvciBhZnRlciB0aGUgY29uZmlybWF0aW9uIHBoYXNlLAogICAgICAgIC8vIHdoZW4gdGhlIG1vdGlvbiBoYXMgY29uY2x1ZGVkLgogICAgICAgIC8vIEJ1dCB0aGUgdG90YWxzIG11c3Qgbm90IGNoYW5nZSBkdXJpbmcgdGhlIGNvbmZpcm1hdGlvbiBwaGFzZSBpdHNlbGYuCiAgICAgICAgcmVxdWlyZSghbW90aW9uQ29uZmlybWluZyhtb3Rpb25JRCkpOwoKICAgICAgICBWb3RlIHNlbmRlclZvdGUgPSB2b3RlW21zZy5zZW5kZXJdW21vdGlvbklEXTsKCiAgICAgICAgLy8gSWYgdGhlIHNlbmRlciBoYXMgbm90IHZvdGVkIHRoZW4gdGhlcmUgaXMgbm8gbmVlZCB0byB1cGRhdGUgYW55dGhpbmcuCiAgICAgICAgcmVxdWlyZShzZW5kZXJWb3RlICE9IFZvdGUuQWJzdGVudGlvbik7CgogICAgICAgIC8vIElmIHdlIGFyZSBub3Qgdm90aW5nLCB0aGVyZSBpcyBubyByZWFzb24gdG8gdXBkYXRlIHRoZSB2b3RlIHRvdGFscy4KICAgICAgICBpZiAobW90aW9uVm90aW5nKG1vdGlvbklEKSkgewogICAgICAgICAgICBpZiAoc2VuZGVyVm90ZSA9PSBWb3RlLlllYSkgewogICAgICAgICAgICAgICAgdm90ZXNGb3JbbW90aW9uSURdID0gc2FmZVN1Yih2b3Rlc0Zvclttb3Rpb25JRF0sIHZvdGVXZWlnaHRbbXNnLnNlbmRlcl1bbW90aW9uSURdKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIFNpbmNlIHdlIGFscmVhZHkgZW5zdXJlZCB0aGF0IHRoZSB2b3RlIGlzIG5vdCBhbiBhYnN0ZW50aW9uLAogICAgICAgICAgICAgICAgLy8gdGhlIG9ubHkgb3B0aW9uIHJlbWFpbmluZyBpcyBWb3RlLk5heS4KICAgICAgICAgICAgICAgIHZvdGVzQWdhaW5zdFttb3Rpb25JRF0gPSBzYWZlU3ViKHZvdGVzQWdhaW5zdFttb3Rpb25JRF0sIHZvdGVXZWlnaHRbbXNnLnNlbmRlcl1bbW90aW9uSURdKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBBIGNhbmNlbGxlZCB2b3RlIGlzIG9ubHkgbWVhbmluZ2Z1bCBpZiBhIHZvdGUgaXMgcnVubmluZwogICAgICAgICAgICBlbWl0IFZvdGVDYW5jZWxsZWQobXNnLnNlbmRlciwgbXNnLnNlbmRlciwgbW90aW9uSUQsIG1vdGlvbklEKTsKICAgICAgICB9CgogICAgICAgIGRlbGV0ZSB2b3RlV2VpZ2h0W21zZy5zZW5kZXJdW21vdGlvbklEXTsKICAgICAgICBkZWxldGUgdm90ZVttc2cuc2VuZGVyXVttb3Rpb25JRF07CiAgICB9CgogICAgZnVuY3Rpb24gX2Nsb3NlTW90aW9uKHVpbnQgbW90aW9uSUQpCiAgICAgICAgaW50ZXJuYWwKICAgIHsKICAgICAgICBkZWxldGUgdGFyZ2V0TW90aW9uSURbbW90aW9uVGFyZ2V0W21vdGlvbklEXV07CiAgICAgICAgZGVsZXRlIG1vdGlvblRhcmdldFttb3Rpb25JRF07CiAgICAgICAgZGVsZXRlIG1vdGlvblN0YXJ0VGltZVttb3Rpb25JRF07CiAgICAgICAgZGVsZXRlIHZvdGVzRm9yW21vdGlvbklEXTsKICAgICAgICBkZWxldGUgdm90ZXNBZ2FpbnN0W21vdGlvbklEXTsKICAgICAgICBlbWl0IE1vdGlvbkNsb3NlZChtb3Rpb25JRCwgbW90aW9uSUQpOwogICAgfQoKICAgIC8qIElmIGEgbW90aW9uIGhhcyBjb25jbHVkZWQsIG9yIGlmIGl0IGxhc3RlZCBpdHMgZnVsbCBkdXJhdGlvbiBidXQgbm90IHBhc3NlZCwKICAgICAqIHRoZW4gYW55b25lIG1heSBjbG9zZSBpdC4gKi8KICAgIGZ1bmN0aW9uIGNsb3NlTW90aW9uKHVpbnQgbW90aW9uSUQpCiAgICAgICAgZXh0ZXJuYWwKICAgIHsKICAgICAgICByZXF1aXJlKChtb3Rpb25Db25maXJtaW5nKG1vdGlvbklEKSAmJiAhbW90aW9uUGFzc2VzKG1vdGlvbklEKSkgfHwgbW90aW9uV2FpdGluZyhtb3Rpb25JRCkpOwogICAgICAgIF9jbG9zZU1vdGlvbihtb3Rpb25JRCk7CiAgICB9CgogICAgLyogVGhlIGZvdW5kYXRpb24gbWF5IG9ubHkgY29uZmlzY2F0ZSBhIGJhbGFuY2UgZHVyaW5nIHRoZSBjb25maXJtYXRpb24KICAgICAqIHBlcmlvZCBhZnRlciBhIG1vdGlvbiBoYXMgcGFzc2VkLiAqLwogICAgZnVuY3Rpb24gYXBwcm92ZU1vdGlvbih1aW50IG1vdGlvbklEKQogICAgICAgIGV4dGVybmFsCiAgICAgICAgb25seU93bmVyCiAgICB7CiAgICAgICAgcmVxdWlyZShtb3Rpb25Db25maXJtaW5nKG1vdGlvbklEKSAmJiBtb3Rpb25QYXNzZXMobW90aW9uSUQpKTsKICAgICAgICBhZGRyZXNzIHRhcmdldCA9IG1vdGlvblRhcmdldFttb3Rpb25JRF07CiAgICAgICAgbm9taW4uY29uZmlzY2F0ZUJhbGFuY2UodGFyZ2V0KTsKICAgICAgICBfY2xvc2VNb3Rpb24obW90aW9uSUQpOwogICAgICAgIGVtaXQgTW90aW9uQXBwcm92ZWQobW90aW9uSUQsIG1vdGlvbklEKTsKICAgIH0KCiAgICAvKiBUaGUgZm91bmRhdGlvbiBtYXkgdmV0byBhIG1vdGlvbiBhdCBhbnkgdGltZS4gKi8KICAgIGZ1bmN0aW9uIHZldG9Nb3Rpb24odWludCBtb3Rpb25JRCkKICAgICAgICBleHRlcm5hbAogICAgICAgIG9ubHlPd25lcgogICAgewogICAgICAgIHJlcXVpcmUoIW1vdGlvbldhaXRpbmcobW90aW9uSUQpKTsKICAgICAgICBfY2xvc2VNb3Rpb24obW90aW9uSUQpOwogICAgICAgIGVtaXQgTW90aW9uVmV0b2VkKG1vdGlvbklELCBtb3Rpb25JRCk7CiAgICB9CgoKICAgIC8qID09PT09PT09PT0gRVZFTlRTID09PT09PT09PT0gKi8KCiAgICBldmVudCBNb3Rpb25CZWd1bihhZGRyZXNzIGluaXRpYXRvciwgYWRkcmVzcyBpbmRleGVkIGluaXRpYXRvckluZGV4LCBhZGRyZXNzIHRhcmdldCwgYWRkcmVzcyBpbmRleGVkIHRhcmdldEluZGV4LCB1aW50IG1vdGlvbklELCB1aW50IGluZGV4ZWQgbW90aW9uSURJbmRleCk7CgogICAgZXZlbnQgVm90ZWRGb3IoYWRkcmVzcyB2b3RlciwgYWRkcmVzcyBpbmRleGVkIHZvdGVySW5kZXgsIHVpbnQgbW90aW9uSUQsIHVpbnQgaW5kZXhlZCBtb3Rpb25JREluZGV4LCB1aW50IHdlaWdodCk7CgogICAgZXZlbnQgVm90ZWRBZ2FpbnN0KGFkZHJlc3Mgdm90ZXIsIGFkZHJlc3MgaW5kZXhlZCB2b3RlckluZGV4LCB1aW50IG1vdGlvbklELCB1aW50IGluZGV4ZWQgbW90aW9uSURJbmRleCwgdWludCB3ZWlnaHQpOwoKICAgIGV2ZW50IFZvdGVDYW5jZWxsZWQoYWRkcmVzcyB2b3RlciwgYWRkcmVzcyBpbmRleGVkIHZvdGVySW5kZXgsIHVpbnQgbW90aW9uSUQsIHVpbnQgaW5kZXhlZCBtb3Rpb25JREluZGV4KTsKCiAgICBldmVudCBNb3Rpb25DbG9zZWQodWludCBtb3Rpb25JRCwgdWludCBpbmRleGVkIG1vdGlvbklESW5kZXgpOwoKICAgIGV2ZW50IE1vdGlvblZldG9lZCh1aW50IG1vdGlvbklELCB1aW50IGluZGV4ZWQgbW90aW9uSURJbmRleCk7CgogICAgZXZlbnQgTW90aW9uQXBwcm92ZWQodWludCBtb3Rpb25JRCwgdWludCBpbmRleGVkIG1vdGlvbklESW5kZXgpOwp9CgovKgotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQpDT05UUkFDVCBERVNDUklQVElPTgotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoKQSB0b2tlbiB3aGljaCBhbHNvIGhhcyBhIGNvbmZpZ3VyYWJsZSBmZWUgcmF0ZQpjaGFyZ2VkIG9uIGl0cyB0cmFuc2ZlcnMuIFRoaXMgaXMgZGVzaWduZWQgdG8gYmUgb3ZlcnJpZGRlbiBpbgpvcmRlciB0byBwcm9kdWNlIGFuIEVSQzIwLWNvbXBsaWFudCB0b2tlbi4KClRoZXNlIGZlZXMgYWNjcnVlIGludG8gYSBwb29sLCBmcm9tIHdoaWNoIGEgbm9taW5hdGVkIGF1dGhvcml0eQptYXkgd2l0aGRyYXcuCgpUaGlzIGNvbnRyYWN0IHV0aWxpc2VzIGEgc3RhdGUgZm9yIHVwZ3JhZGFiaWxpdHkgcHVycG9zZXMuCkl0IHJlbGllcyBvbiBiZWluZyBjYWxsZWQgdW5kZXJuZWF0aCBhIHByb3h5IGNvbnRyYWN0LCBhcwppbmNsdWRlZCBpbiBQcm94eS5zb2wuCgotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoqLwoKY29udHJhY3QgRXh0ZXJuU3RhdGVQcm94eUZlZVRva2VuIGlzIFByb3h5YWJsZSwgU2FmZURlY2ltYWxNYXRoIHsKCiAgICAvKiA9PT09PT09PT09IFNUQVRFIFZBUklBQkxFUyA9PT09PT09PT09ICovCgogICAgLy8gU3RvcmVzIGJhbGFuY2VzIGFuZCBhbGxvd2FuY2VzLgogICAgVG9rZW5TdGF0ZSBwdWJsaWMgc3RhdGU7CgogICAgLy8gT3RoZXIgRVJDMjAgZmllbGRzCiAgICBzdHJpbmcgcHVibGljIG5hbWU7CiAgICBzdHJpbmcgcHVibGljIHN5bWJvbDsKICAgIHVpbnQgcHVibGljIHRvdGFsU3VwcGx5OwoKICAgIC8vIEEgcGVyY2VudGFnZSBmZWUgY2hhcmdlZCBvbiBlYWNoIHRyYW5zZmVyLgogICAgdWludCBwdWJsaWMgdHJhbnNmZXJGZWVSYXRlOwogICAgLy8gRmVlIG1heSBub3QgZXhjZWVkIDEwJS4KICAgIHVpbnQgY29uc3RhbnQgTUFYX1RSQU5TRkVSX0ZFRV9SQVRFID0gVU5JVCAvIDEwOwogICAgLy8gVGhlIGFkZHJlc3Mgd2l0aCB0aGUgYXV0aG9yaXR5IHRvIGRpc3RyaWJ1dGUgZmVlcy4KICAgIGFkZHJlc3MgcHVibGljIGZlZUF1dGhvcml0eTsKCgogICAgLyogPT09PT09PT09PSBDT05TVFJVQ1RPUiA9PT09PT09PT09ICovCgogICAgZnVuY3Rpb24gRXh0ZXJuU3RhdGVQcm94eUZlZVRva2VuKHN0cmluZyBfbmFtZSwgc3RyaW5nIF9zeW1ib2wsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdWludCBfdHJhbnNmZXJGZWVSYXRlLCBhZGRyZXNzIF9mZWVBdXRob3JpdHksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgVG9rZW5TdGF0ZSBfc3RhdGUsIGFkZHJlc3MgX293bmVyKQogICAgICAgIFByb3h5YWJsZShfb3duZXIpCiAgICAgICAgcHVibGljCiAgICB7CiAgICAgICAgaWYgKF9zdGF0ZSA9PSBUb2tlblN0YXRlKDApKSB7CiAgICAgICAgICAgIHN0YXRlID0gbmV3IFRva2VuU3RhdGUoX293bmVyLCBhZGRyZXNzKHRoaXMpKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzdGF0ZSA9IF9zdGF0ZTsKICAgICAgICB9CgogICAgICAgIG5hbWUgPSBfbmFtZTsKICAgICAgICBzeW1ib2wgPSBfc3ltYm9sOwogICAgICAgIHRyYW5zZmVyRmVlUmF0ZSA9IF90cmFuc2ZlckZlZVJhdGU7CiAgICAgICAgZmVlQXV0aG9yaXR5ID0gX2ZlZUF1dGhvcml0eTsKICAgIH0KCiAgICAvKiA9PT09PT09PT09IFNFVFRFUlMgPT09PT09PT09PSAqLwoKICAgIGZ1bmN0aW9uIHNldFRyYW5zZmVyRmVlUmF0ZSh1aW50IF90cmFuc2ZlckZlZVJhdGUpCiAgICAgICAgZXh0ZXJuYWwKICAgICAgICBvcHRpb25hbFByb3h5X29ubHlPd25lcgogICAgewogICAgICAgIHJlcXVpcmUoX3RyYW5zZmVyRmVlUmF0ZSA8PSBNQVhfVFJBTlNGRVJfRkVFX1JBVEUpOwogICAgICAgIHRyYW5zZmVyRmVlUmF0ZSA9IF90cmFuc2ZlckZlZVJhdGU7CiAgICAgICAgZW1pdCBUcmFuc2ZlckZlZVJhdGVVcGRhdGVkKF90cmFuc2ZlckZlZVJhdGUpOwogICAgfQoKICAgIGZ1bmN0aW9uIHNldEZlZUF1dGhvcml0eShhZGRyZXNzIF9mZWVBdXRob3JpdHkpCiAgICAgICAgZXh0ZXJuYWwKICAgICAgICBvcHRpb25hbFByb3h5X29ubHlPd25lcgogICAgewogICAgICAgIGZlZUF1dGhvcml0eSA9IF9mZWVBdXRob3JpdHk7CiAgICAgICAgZW1pdCBGZWVBdXRob3JpdHlVcGRhdGVkKF9mZWVBdXRob3JpdHkpOwogICAgfQoKICAgIGZ1bmN0aW9uIHNldFN0YXRlKFRva2VuU3RhdGUgX3N0YXRlKQogICAgICAgIGV4dGVybmFsCiAgICAgICAgb3B0aW9uYWxQcm94eV9vbmx5T3duZXIKICAgIHsKICAgICAgICBzdGF0ZSA9IF9zdGF0ZTsKICAgICAgICBlbWl0IFN0YXRlVXBkYXRlZChfc3RhdGUpOwogICAgfQoKICAgIC8qID09PT09PT09PT0gVklFV1MgPT09PT09PT09PSAqLwoKICAgIGZ1bmN0aW9uIGJhbGFuY2VPZihhZGRyZXNzIGFjY291bnQpCiAgICAgICAgcHVibGljCiAgICAgICAgdmlldwogICAgICAgIHJldHVybnMgKHVpbnQpCiAgICB7CiAgICAgICAgcmV0dXJuIHN0YXRlLmJhbGFuY2VPZihhY2NvdW50KTsKICAgIH0KCiAgICBmdW5jdGlvbiBhbGxvd2FuY2UoYWRkcmVzcyBmcm9tLCBhZGRyZXNzIHRvKQogICAgICAgIHB1YmxpYwogICAgICAgIHZpZXcKICAgICAgICByZXR1cm5zICh1aW50KQogICAgewogICAgICAgIHJldHVybiBzdGF0ZS5hbGxvd2FuY2UoZnJvbSwgdG8pOwogICAgfQoKICAgIC8vIFJldHVybiB0aGUgZmVlIGNoYXJnZWQgb24gdG9wIGluIG9yZGVyIHRvIHRyYW5zZmVyIF92YWx1ZSB3b3J0aCBvZiB0b2tlbnMuCiAgICBmdW5jdGlvbiB0cmFuc2ZlckZlZUluY3VycmVkKHVpbnQgdmFsdWUpCiAgICAgICAgcHVibGljCiAgICAgICAgdmlldwogICAgICAgIHJldHVybnMgKHVpbnQpCiAgICB7CiAgICAgICAgcmV0dXJuIHNhZmVNdWxfZGVjKHZhbHVlLCB0cmFuc2ZlckZlZVJhdGUpOwogICAgICAgIC8vIFRyYW5zZmVycyBsZXNzIHRoYW4gdGhlIHJlY2lwcm9jYWwgb2YgdHJhbnNmZXJGZWVSYXRlIHNob3VsZCBiZSBjb21wbGV0ZWx5IGVhdGVuIHVwIGJ5IGZlZXMuCiAgICAgICAgLy8gVGhpcyBpcyBvbiB0aGUgYmFzaXMgdGhhdCB0cmFuc2ZlcnMgbGVzcyB0aGFuIHRoaXMgdmFsdWUgd2lsbCByZXN1bHQgaW4gYSBuaWwgZmVlLgogICAgICAgIC8vIFByb2JhYmx5IHRvbyBpbnNpZ25pZmljYW50IHRvIHdvcnJ5IGFib3V0LCBidXQgdGhlIGZvbGxvd2luZyBjb2RlIHdpbGwgYWNoaWV2ZSBpdC4KICAgICAgICAvLyAgICAgIGlmIChmZWUgPT0gMCAmJiB0cmFuc2ZlckZlZVJhdGUgIT0gMCkgewogICAgICAgIC8vICAgICAgICAgIHJldHVybiBfdmFsdWU7CiAgICAgICAgLy8gICAgICB9CiAgICAgICAgLy8gICAgICByZXR1cm4gZmVlOwogICAgfQoKICAgIC8vIFRoZSB2YWx1ZSB0aGF0IHlvdSB3b3VsZCBuZWVkIHRvIHNlbmQgc28gdGhhdCB0aGUgcmVjaXBpZW50IHJlY2VpdmVzCiAgICAvLyBhIHNwZWNpZmllZCB2YWx1ZS4KICAgIGZ1bmN0aW9uIHRyYW5zZmVyUGx1c0ZlZSh1aW50IHZhbHVlKQogICAgICAgIGV4dGVybmFsCiAgICAgICAgdmlldwogICAgICAgIHJldHVybnMgKHVpbnQpCiAgICB7CiAgICAgICAgcmV0dXJuIHNhZmVBZGQodmFsdWUsIHRyYW5zZmVyRmVlSW5jdXJyZWQodmFsdWUpKTsKICAgIH0KCiAgICAvLyBUaGUgcXVhbnRpdHkgdG8gc2VuZCBpbiBvcmRlciB0aGF0IHRoZSBzZW5kZXIgc3BlbmRzIGEgY2VydGFpbiB2YWx1ZSBvZiB0b2tlbnMuCiAgICBmdW5jdGlvbiBwcmljZVRvU3BlbmQodWludCB2YWx1ZSkKICAgICAgICBleHRlcm5hbAogICAgICAgIHZpZXcKICAgICAgICByZXR1cm5zICh1aW50KQogICAgewogICAgICAgIHJldHVybiBzYWZlRGl2X2RlYyh2YWx1ZSwgc2FmZUFkZChVTklULCB0cmFuc2ZlckZlZVJhdGUpKTsKICAgIH0KCiAgICAvLyBUaGUgYmFsYW5jZSBvZiB0aGUgbm9taW4gY29udHJhY3QgaXRzZWxmIGlzIHRoZSBmZWUgcG9vbC4KICAgIC8vIENvbGxlY3RlZCBmZWVzIHNpdCBoZXJlIHVudGlsIHRoZXkgYXJlIGRpc3RyaWJ1dGVkLgogICAgZnVuY3Rpb24gZmVlUG9vbCgpCiAgICAgICAgZXh0ZXJuYWwKICAgICAgICB2aWV3CiAgICAgICAgcmV0dXJucyAodWludCkKICAgIHsKICAgICAgICByZXR1cm4gc3RhdGUuYmFsYW5jZU9mKGFkZHJlc3ModGhpcykpOwogICAgfQoKCiAgICAvKiA9PT09PT09PT09IE1VVEFUSVZFIEZVTkNUSU9OUyA9PT09PT09PT09ICovCgogICAgLyogV2hhdGV2ZXIgY2FsbHMgdGhpcyBzaG91bGQgaGF2ZSBlaXRoZXIgdGhlIG9wdGlvbmFsUHJveHkgb3Igb25seVByb3h5IG1vZGlmaWVyLAogICAgICogYW5kIHBhc3MgaW4gbWVzc2FnZVNlbmRlci4gKi8KICAgIGZ1bmN0aW9uIF90cmFuc2Zlcl9ieVByb3h5KGFkZHJlc3Mgc2VuZGVyLCBhZGRyZXNzIHRvLCB1aW50IHZhbHVlKQogICAgICAgIGludGVybmFsCiAgICAgICAgcmV0dXJucyAoYm9vbCkKICAgIHsKICAgICAgICByZXF1aXJlKHRvICE9IGFkZHJlc3MoMCkpOwoKICAgICAgICAvLyBUaGUgZmVlIGlzIGRlZHVjdGVkIGZyb20gdGhlIHNlbmRlcidzIGJhbGFuY2UsIGluIGFkZGl0aW9uIHRvCiAgICAgICAgLy8gdGhlIHRyYW5zZmVycmVkIHF1YW50aXR5LgogICAgICAgIHVpbnQgZmVlID0gdHJhbnNmZXJGZWVJbmN1cnJlZCh2YWx1ZSk7CiAgICAgICAgdWludCB0b3RhbENoYXJnZSA9IHNhZmVBZGQodmFsdWUsIGZlZSk7CgogICAgICAgIC8vIEluc3VmZmljaWVudCBiYWxhbmNlIHdpbGwgYmUgaGFuZGxlZCBieSB0aGUgc2FmZSBzdWJ0cmFjdGlvbi4KICAgICAgICBzdGF0ZS5zZXRCYWxhbmNlT2Yoc2VuZGVyLCBzYWZlU3ViKHN0YXRlLmJhbGFuY2VPZihzZW5kZXIpLCB0b3RhbENoYXJnZSkpOwogICAgICAgIHN0YXRlLnNldEJhbGFuY2VPZih0bywgc2FmZUFkZChzdGF0ZS5iYWxhbmNlT2YodG8pLCB2YWx1ZSkpOwogICAgICAgIHN0YXRlLnNldEJhbGFuY2VPZihhZGRyZXNzKHRoaXMpLCBzYWZlQWRkKHN0YXRlLmJhbGFuY2VPZihhZGRyZXNzKHRoaXMpKSwgZmVlKSk7CgogICAgICAgIGVtaXQgVHJhbnNmZXIoc2VuZGVyLCB0bywgdmFsdWUpOwogICAgICAgIGVtaXQgVHJhbnNmZXJGZWVQYWlkKHNlbmRlciwgZmVlKTsKICAgICAgICBlbWl0IFRyYW5zZmVyKHNlbmRlciwgYWRkcmVzcyh0aGlzKSwgZmVlKTsKCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgLyogV2hhdGV2ZXIgY2FsbHMgdGhpcyBzaG91bGQgaGF2ZSBlaXRoZXIgdGhlIG9wdGlvbmFsUHJveHkgb3Igb25seVByb3h5IG1vZGlmaWVyLAogICAgICogYW5kIHBhc3MgaW4gbWVzc2FnZVNlbmRlci4gKi8KICAgIGZ1bmN0aW9uIF90cmFuc2ZlckZyb21fYnlQcm94eShhZGRyZXNzIHNlbmRlciwgYWRkcmVzcyBmcm9tLCBhZGRyZXNzIHRvLCB1aW50IHZhbHVlKQogICAgICAgIGludGVybmFsCiAgICAgICAgcmV0dXJucyAoYm9vbCkKICAgIHsKICAgICAgICByZXF1aXJlKHRvICE9IGFkZHJlc3MoMCkpOwoKICAgICAgICAvLyBUaGUgZmVlIGlzIGRlZHVjdGVkIGZyb20gdGhlIHNlbmRlcidzIGJhbGFuY2UsIGluIGFkZGl0aW9uIHRvCiAgICAgICAgLy8gdGhlIHRyYW5zZmVycmVkIHF1YW50aXR5LgogICAgICAgIHVpbnQgZmVlID0gdHJhbnNmZXJGZWVJbmN1cnJlZCh2YWx1ZSk7CiAgICAgICAgdWludCB0b3RhbENoYXJnZSA9IHNhZmVBZGQodmFsdWUsIGZlZSk7CgogICAgICAgIC8vIEluc3VmZmljaWVudCBiYWxhbmNlIHdpbGwgYmUgaGFuZGxlZCBieSB0aGUgc2FmZSBzdWJ0cmFjdGlvbi4KICAgICAgICBzdGF0ZS5zZXRCYWxhbmNlT2YoZnJvbSwgc2FmZVN1YihzdGF0ZS5iYWxhbmNlT2YoZnJvbSksIHRvdGFsQ2hhcmdlKSk7CiAgICAgICAgc3RhdGUuc2V0QWxsb3dhbmNlKGZyb20sIHNlbmRlciwgc2FmZVN1YihzdGF0ZS5hbGxvd2FuY2UoZnJvbSwgc2VuZGVyKSwgdG90YWxDaGFyZ2UpKTsKICAgICAgICBzdGF0ZS5zZXRCYWxhbmNlT2YodG8sIHNhZmVBZGQoc3RhdGUuYmFsYW5jZU9mKHRvKSwgdmFsdWUpKTsKICAgICAgICBzdGF0ZS5zZXRCYWxhbmNlT2YoYWRkcmVzcyh0aGlzKSwgc2FmZUFkZChzdGF0ZS5iYWxhbmNlT2YoYWRkcmVzcyh0aGlzKSksIGZlZSkpOwoKICAgICAgICBlbWl0IFRyYW5zZmVyKGZyb20sIHRvLCB2YWx1ZSk7CiAgICAgICAgZW1pdCBUcmFuc2ZlckZlZVBhaWQoc2VuZGVyLCBmZWUpOwogICAgICAgIGVtaXQgVHJhbnNmZXIoZnJvbSwgYWRkcmVzcyh0aGlzKSwgZmVlKTsKCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgZnVuY3Rpb24gYXBwcm92ZShhZGRyZXNzIHNwZW5kZXIsIHVpbnQgdmFsdWUpCiAgICAgICAgZXh0ZXJuYWwKICAgICAgICBvcHRpb25hbFByb3h5CiAgICAgICAgcmV0dXJucyAoYm9vbCkKICAgIHsKICAgICAgICBhZGRyZXNzIHNlbmRlciA9IG1lc3NhZ2VTZW5kZXI7CiAgICAgICAgc3RhdGUuc2V0QWxsb3dhbmNlKHNlbmRlciwgc3BlbmRlciwgdmFsdWUpOwoKICAgICAgICBlbWl0IEFwcHJvdmFsKHNlbmRlciwgc3BlbmRlciwgdmFsdWUpOwoKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICAvKiBXaXRoZHJhdyB0b2tlbnMgZnJvbSB0aGUgZmVlIHBvb2wgaW50byBhIGdpdmVuIGFjY291bnQuICovCiAgICBmdW5jdGlvbiB3aXRoZHJhd0ZlZShhZGRyZXNzIGFjY291bnQsIHVpbnQgdmFsdWUpCiAgICAgICAgZXh0ZXJuYWwKICAgICAgICByZXR1cm5zIChib29sKQogICAgewogICAgICAgIHJlcXVpcmUobXNnLnNlbmRlciA9PSBmZWVBdXRob3JpdHkgJiYgYWNjb3VudCAhPSBhZGRyZXNzKDApKTsKICAgICAgICAKICAgICAgICAvLyAwLXZhbHVlIHdpdGhkcmF3YWxzIGRvIG5vdGhpbmcuCiAgICAgICAgaWYgKHZhbHVlID09IDApIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgLy8gU2FmZSBzdWJ0cmFjdGlvbiBlbnN1cmVzIGFuIGV4Y2VwdGlvbiBpcyB0aHJvd24gaWYgdGhlIGJhbGFuY2UgaXMgaW5zdWZmaWNpZW50LgogICAgICAgIHN0YXRlLnNldEJhbGFuY2VPZihhZGRyZXNzKHRoaXMpLCBzYWZlU3ViKHN0YXRlLmJhbGFuY2VPZihhZGRyZXNzKHRoaXMpKSwgdmFsdWUpKTsKICAgICAgICBzdGF0ZS5zZXRCYWxhbmNlT2YoYWNjb3VudCwgc2FmZUFkZChzdGF0ZS5iYWxhbmNlT2YoYWNjb3VudCksIHZhbHVlKSk7CgogICAgICAgIGVtaXQgRmVlc1dpdGhkcmF3bihhY2NvdW50LCBhY2NvdW50LCB2YWx1ZSk7CiAgICAgICAgZW1pdCBUcmFuc2ZlcihhZGRyZXNzKHRoaXMpLCBhY2NvdW50LCB2YWx1ZSk7CgogICAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIC8qIERvbmF0ZSB0b2tlbnMgZnJvbSB0aGUgc2VuZGVyJ3MgYmFsYW5jZSBpbnRvIHRoZSBmZWUgcG9vbC4gKi8KICAgIGZ1bmN0aW9uIGRvbmF0ZVRvRmVlUG9vbCh1aW50IG4pCiAgICAgICAgZXh0ZXJuYWwKICAgICAgICBvcHRpb25hbFByb3h5CiAgICAgICAgcmV0dXJucyAoYm9vbCkKICAgIHsKICAgICAgICBhZGRyZXNzIHNlbmRlciA9IG1lc3NhZ2VTZW5kZXI7CgogICAgICAgIC8vIEVtcHR5IGRvbmF0aW9ucyBhcmUgZGlzYWxsb3dlZC4KICAgICAgICB1aW50IGJhbGFuY2UgPSBzdGF0ZS5iYWxhbmNlT2Yoc2VuZGVyKTsKICAgICAgICByZXF1aXJlKGJhbGFuY2UgIT0gMCk7CgogICAgICAgIC8vIHNhZmVTdWIgZW5zdXJlcyB0aGUgZG9ub3IgaGFzIHN1ZmZpY2llbnQgYmFsYW5jZS4KICAgICAgICBzdGF0ZS5zZXRCYWxhbmNlT2Yoc2VuZGVyLCBzYWZlU3ViKGJhbGFuY2UsIG4pKTsKICAgICAgICBzdGF0ZS5zZXRCYWxhbmNlT2YoYWRkcmVzcyh0aGlzKSwgc2FmZUFkZChzdGF0ZS5iYWxhbmNlT2YoYWRkcmVzcyh0aGlzKSksIG4pKTsKCiAgICAgICAgZW1pdCBGZWVzRG9uYXRlZChzZW5kZXIsIHNlbmRlciwgbik7CiAgICAgICAgZW1pdCBUcmFuc2ZlcihzZW5kZXIsIGFkZHJlc3ModGhpcyksIG4pOwoKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICAvKiA9PT09PT09PT09IEVWRU5UUyA9PT09PT09PT09ICovCgogICAgZXZlbnQgVHJhbnNmZXIoYWRkcmVzcyBpbmRleGVkIGZyb20sIGFkZHJlc3MgaW5kZXhlZCB0bywgdWludCB2YWx1ZSk7CgogICAgZXZlbnQgVHJhbnNmZXJGZWVQYWlkKGFkZHJlc3MgaW5kZXhlZCBhY2NvdW50LCB1aW50IHZhbHVlKTsKCiAgICBldmVudCBBcHByb3ZhbChhZGRyZXNzIGluZGV4ZWQgb3duZXIsIGFkZHJlc3MgaW5kZXhlZCBzcGVuZGVyLCB1aW50IHZhbHVlKTsKCiAgICBldmVudCBUcmFuc2ZlckZlZVJhdGVVcGRhdGVkKHVpbnQgbmV3RmVlUmF0ZSk7CgogICAgZXZlbnQgRmVlQXV0aG9yaXR5VXBkYXRlZChhZGRyZXNzIGZlZUF1dGhvcml0eSk7CgogICAgZXZlbnQgU3RhdGVVcGRhdGVkKGFkZHJlc3MgbmV3U3RhdGUpOwoKICAgIGV2ZW50IEZlZXNXaXRoZHJhd24oYWRkcmVzcyBhY2NvdW50LCBhZGRyZXNzIGluZGV4ZWQgYWNjb3VudEluZGV4LCB1aW50IHZhbHVlKTsKCiAgICBldmVudCBGZWVzRG9uYXRlZChhZGRyZXNzIGRvbm9yLCBhZGRyZXNzIGluZGV4ZWQgZG9ub3JJbmRleCwgdWludCB2YWx1ZSk7Cn0KCi8qCi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCkNPTlRSQUNUIERFU0NSSVBUSU9OCi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCgpFdGhlci1iYWNrZWQgbm9taW4gc3RhYmxlY29pbiBjb250cmFjdC4KClRoaXMgY29udHJhY3QgaXNzdWVzIG5vbWlucywgd2hpY2ggYXJlIHRva2VucyB3b3J0aCAxIFVTRCBlYWNoLiBUaGV5IGFyZSBiYWNrZWQKYnkgYSBwb29sIG9mIGV0aGVyIGNvbGxhdGVyYWwsIHNvIHRoYXQgaWYgYSB1c2VyIGhhcyBub21pbnMsIHRoZXkgbWF5CnJlZGVlbSB0aGVtIGZvciBldGhlciBmcm9tIHRoZSBwb29sLCBvciBpZiB0aGV5IHdhbnQgdG8gb2J0YWluIG5vbWlucywKdGhleSBtYXkgcGF5IGV0aGVyIGludG8gdGhlIHBvb2wgaW4gb3JkZXIgdG8gZG8gc28uCgpUaGUgc3VwcGx5IG9mIG5vbWlucyB0aGF0IG1heSBiZSBpbiBjaXJjdWxhdGlvbiBhdCBhbnkgdGltZSBpcyBsaW1pdGVkLgpUaGUgY29udHJhY3Qgb3duZXIgbWF5IGluY3JlYXNlIHRoaXMgcXVhbnRpdHksIGJ1dCBvbmx5IGlmIHRoZXkgcHJvdmlkZQpldGhlciB0byBiYWNrIGl0LiBUaGUgYmFja2luZyB0aGUgb3duZXIgcHJvdmlkZXMgYXQgaXNzdWFuY2UgbXVzdAprZWVwIGVhY2ggbm9taW4gYXQgbGVhc3QgdHdpY2Ugb3ZlcmNvbGxhdGVyYWxpc2VkLgpUaGUgb3duZXIgbWF5IGFsc28gZGVzdHJveSBub21pbnMgaW4gdGhlIHBvb2wsIHdoaWNoIGlzIHBvdGVudGlhbCBhdmVudWUKYnkgd2hpY2ggdG8gbWFpbnRhaW4gaGVhbHRoeSBjb2xsYXRlcmFsaXNhdGlvbiBsZXZlbHMsIGFzIGl0IHJlZHVjZXMKc3VwcGx5IHdpdGhvdXQgd2l0aGRyYXdpbmcgZXRoZXIgY29sbGF0ZXJhbC4KCkEgY29uZmlndXJhYmxlIGZlZSBpcyBjaGFyZ2VkIG9uIG5vbWluIHRyYW5zZmVycyBhbmQgZGVwb3NpdGVkCmludG8gYSBjb21tb24gcG90LCB3aGljaCBoYXZ2ZW4gaG9sZGVycyBtYXkgd2l0aGRyYXcgZnJvbSBvbmNlIHBlcgpmZWUgcGVyaW9kLgoKRXRoZXIgcHJpY2UgaXMgY29udGludWFsbHkgdXBkYXRlZCBieSBhbiBleHRlcm5hbCBvcmFjbGUsIGFuZCB0aGUgdmFsdWUKb2YgdGhlIGJhY2tpbmcgaXMgY29tcHV0ZWQgb24gdGhpcyBiYXNpcy4gVG8gZW5zdXJlIHRoZSBpbnRlZ3JpdHkgb2YKdGhpcyBzeXN0ZW0sIGlmIHRoZSBjb250cmFjdCdzIHByaWNlIGhhcyBub3QgYmVlbiB1cGRhdGVkIHJlY2VudGx5IGVub3VnaCwKaXQgd2lsbCB0ZW1wb3JhcmlseSBkaXNhYmxlIGl0c2VsZiB1bnRpbCBpdCByZWNlaXZlcyBtb3JlIHByaWNlIGluZm9ybWF0aW9uLgoKVGhlIGNvbnRyYWN0IG93bmVyIG1heSBhdCBhbnkgdGltZSBpbml0aWF0ZSBjb250cmFjdCBsaXF1aWRhdGlvbi4KRHVyaW5nIHRoZSBsaXF1aWRhdGlvbiBwZXJpb2QsIG1vc3QgY29udHJhY3QgZnVuY3Rpb25zIHdpbGwgYmUgZGVhY3RpdmF0ZWQuCk5vIG5ldyBub21pbnMgbWF5IGJlIGlzc3VlZCBvciBib3VnaHQsIGJ1dCB1c2VycyBtYXkgc2VsbCBub21pbnMgYmFjawp0byB0aGUgc3lzdGVtLgpJZiB0aGUgc3lzdGVtJ3MgY29sbGF0ZXJhbCBmYWxscyBiZWxvdyBhIHNwZWNpZmllZCBsZXZlbCwgdGhlbiBhbnlvbmUKbWF5IGluaXRpYXRlIGxpcXVpZGF0aW9uLgoKQWZ0ZXIgdGhlIGxpcXVpZGF0aW9uIHBlcmlvZCBoYXMgZWxhcHNlZCwgd2hpY2ggaXMgaW5pdGlhbGx5IDkwIGRheXMsCnRoZSBvd25lciBtYXkgZGVzdHJveSB0aGUgY29udHJhY3QsIHRyYW5zZmVycmluZyBhbnkgcmVtYWluaW5nIGNvbGxhdGVyYWwKdG8gYSBub21pbmF0ZWQgYmVuZWZpY2lhcnkgYWRkcmVzcy4KVGhpcyBsaXF1aWRhdGlvbiBwZXJpb2QgbWF5IGJlIGV4dGVuZGVkIHVwIHRvIGEgbWF4aW11bSBvZiAxODAgZGF5cy4KSWYgdGhlIGNvbnRyYWN0IGlzIHJlY29sbGF0ZXJhbGlzZWQsIHRoZSBvd25lciBtYXkgdGVybWluYXRlIGxpcXVpZGF0aW9uLgoKLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KKi8KCmNvbnRyYWN0IEV0aGVyTm9taW4gaXMgRXh0ZXJuU3RhdGVQcm94eUZlZVRva2VuIHsKCiAgICAvKiA9PT09PT09PT09IFNUQVRFIFZBUklBQkxFUyA9PT09PT09PT09ICovCgogICAgLy8gVGhlIG9yYWNsZSBwcm92aWRlcyBwcmljZSBpbmZvcm1hdGlvbiB0byB0aGlzIGNvbnRyYWN0LgogICAgLy8gSXQgbWF5IG9ubHkgY2FsbCB0aGUgdXBkYXRlUHJpY2UoKSBmdW5jdGlvbi4KICAgIGFkZHJlc3MgcHVibGljIG9yYWNsZTsKCiAgICAvLyBUaGUgYWRkcmVzcyBvZiB0aGUgY29udHJhY3Qgd2hpY2ggbWFuYWdlcyBjb25maXNjYXRpb24gdm90ZXMuCiAgICBDb3VydCBwdWJsaWMgY291cnQ7CgogICAgLy8gRm91bmRhdGlvbiB3YWxsZXQgZm9yIGZ1bmRzIHRvIGdvIHRvIHBvc3QgbGlxdWlkYXRpb24uCiAgICBhZGRyZXNzIHB1YmxpYyBiZW5lZmljaWFyeTsKCiAgICAvLyBOb21pbnMgaW4gdGhlIHBvb2wgcmVhZHkgdG8gYmUgc29sZC4KICAgIHVpbnQgcHVibGljIG5vbWluUG9vbDsKCiAgICAvLyBJbXBvc2UgYSA1MCBiYXNpcy1wb2ludCBmZWUgZm9yIGJ1eWluZyBmcm9tIGFuZCBzZWxsaW5nIHRvIHRoZSBub21pbiBwb29sLgogICAgdWludCBwdWJsaWMgcG9vbEZlZVJhdGUgPSBVTklUIC8gMjAwOwoKICAgIC8vIFRoZSBtaW5pbXVtIHB1cmNoYXNhYmxlIHF1YW50aXR5IG9mIG5vbWlucyBpcyAxIGNlbnQuCiAgICB1aW50IGNvbnN0YW50IE1JTklNVU1fUFVSQ0hBU0UgPSBVTklUIC8gMTAwOwoKICAgIC8vIFdoZW4gaXNzdWluZywgbm9taW5zIG11c3QgYmUgb3ZlcmNvbGxhdGVyYWxpc2VkIGJ5IHRoaXMgcmF0aW8uCiAgICB1aW50IGNvbnN0YW50IE1JTklNVU1fSVNTVUFOQ0VfUkFUSU8gPSAgMiAqIFVOSVQ7CgogICAgLy8gSWYgdGhlIGNvbGxhdGVyYWxpc2F0aW9uIHJhdGlvIG9mIHRoZSBjb250cmFjdCBmYWxscyBiZWxvdyB0aGlzIGxldmVsLAogICAgLy8gaW1tZWRpYXRlbHkgYmVnaW4gbGlxdWlkYXRpb24uCiAgICB1aW50IGNvbnN0YW50IEFVVE9fTElRVUlEQVRJT05fUkFUSU8gPSBVTklUOwoKICAgIC8vIFRoZSBsaXF1aWRhdGlvbiBwZXJpb2QgaXMgdGhlIGR1cmF0aW9uIHRoYXQgbXVzdCBwYXNzIGJlZm9yZSB0aGUgbGlxdWlkYXRpb24gcGVyaW9kIGlzIGNvbXBsZXRlLgogICAgLy8gSXQgY2FuIGJlIGV4dGVuZGVkIHVwIHRvIGEgZ2l2ZW4gZHVyYXRpb24uCiAgICB1aW50IGNvbnN0YW50IERFRkFVTFRfTElRVUlEQVRJT05fUEVSSU9EID0gOTAgZGF5czsKICAgIHVpbnQgY29uc3RhbnQgTUFYX0xJUVVJREFUSU9OX1BFUklPRCA9IDE4MCBkYXlzOwogICAgdWludCBwdWJsaWMgbGlxdWlkYXRpb25QZXJpb2QgPSBERUZBVUxUX0xJUVVJREFUSU9OX1BFUklPRDsKCiAgICAvLyBUaGUgdGltZXN0YW1wIHdoZW4gbGlxdWlkYXRpb24gd2FzIGFjdGl2YXRlZC4gV2UgaW5pdGlhbGlzZSB0aGlzIHRvCiAgICAvLyB1aW50IG1heCwgc28gdGhhdCB3ZSBrbm93IHRoYXQgd2UgYXJlIHVuZGVyIGxpcXVpZGF0aW9uIGlmIHRoZQogICAgLy8gbGlxdWlkYXRpb24gdGltZXN0YW1wIGlzIGluIHRoZSBwYXN0LgogICAgdWludCBwdWJsaWMgbGlxdWlkYXRpb25UaW1lc3RhbXAgPSB+dWludCgwKTsKCiAgICAvLyBFdGhlciBwcmljZSBmcm9tIG9yYWNsZSAoZmlhdCBwZXIgZXRoZXIpLgogICAgdWludCBwdWJsaWMgZXRoZXJQcmljZTsKCiAgICAvLyBMYXN0IHRpbWUgdGhlIHByaWNlIHdhcyB1cGRhdGVkLgogICAgdWludCBwdWJsaWMgbGFzdFByaWNlVXBkYXRlOwoKICAgIC8vIFRoZSBwZXJpb2QgaXQgdGFrZXMgZm9yIHRoZSBwcmljZSB0byBiZSBjb25zaWRlcmVkIHN0YWxlLgogICAgLy8gSWYgdGhlIHByaWNlIGlzIHN0YWxlLCBmdW5jdGlvbnMgdGhhdCByZXF1aXJlIHRoZSBwcmljZSBhcmUgZGlzYWJsZWQuCiAgICB1aW50IHB1YmxpYyBzdGFsZVBlcmlvZCA9IDIgZGF5czsKCiAgICAvLyBBY2NvdW50cyB3aGljaCBoYXZlIGxvc3QgdGhlIHByaXZpbGVnZSB0byB0cmFuc2FjdCBpbiBub21pbnMuCiAgICBtYXBwaW5nKGFkZHJlc3MgPT4gYm9vbCkgcHVibGljIGZyb3plbjsKCgogICAgLyogPT09PT09PT09PSBDT05TVFJVQ1RPUiA9PT09PT09PT09ICovCgogICAgZnVuY3Rpb24gRXRoZXJOb21pbihhZGRyZXNzIF9oYXZ2ZW4sIGFkZHJlc3MgX29yYWNsZSwKICAgICAgICAgICAgICAgICAgICAgICAgYWRkcmVzcyBfYmVuZWZpY2lhcnksCiAgICAgICAgICAgICAgICAgICAgICAgIHVpbnQgaW5pdGlhbEV0aGVyUHJpY2UsCiAgICAgICAgICAgICAgICAgICAgICAgIGFkZHJlc3MgX293bmVyLCBUb2tlblN0YXRlIGluaXRpYWxTdGF0ZSkKICAgICAgICBFeHRlcm5TdGF0ZVByb3h5RmVlVG9rZW4oIkV0aGVyLUJhY2tlZCBVU0QgTm9taW5zIiwgImVVU0QiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAxNSAqIFVOSVQgLyAxMDAwMCwgLy8gbm9taW4gdHJhbnNmZXJzIGluY3VyIGEgMTUgYnAgZmVlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9oYXZ2ZW4sIC8vIHRoZSBoYXZ2ZW4gY29udHJhY3QgaXMgdGhlIGZlZSBhdXRob3JpdHkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5pdGlhbFN0YXRlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfb3duZXIpCiAgICAgICAgcHVibGljCiAgICB7CiAgICAgICAgb3JhY2xlID0gX29yYWNsZTsKICAgICAgICBiZW5lZmljaWFyeSA9IF9iZW5lZmljaWFyeTsKCiAgICAgICAgZXRoZXJQcmljZSA9IGluaXRpYWxFdGhlclByaWNlOwogICAgICAgIGxhc3RQcmljZVVwZGF0ZSA9IG5vdzsKICAgICAgICBlbWl0IFByaWNlVXBkYXRlZChldGhlclByaWNlKTsKCiAgICAgICAgLy8gSXQgc2hvdWxkIG5vdCBiZSBwb3NzaWJsZSB0byB0cmFuc2ZlciB0byB0aGUgbm9taW4gY29udHJhY3QgaXRzZWxmLgogICAgICAgIGZyb3plblt0aGlzXSA9IHRydWU7CiAgICB9CgoKICAgIC8qID09PT09PT09PT0gU0VUVEVSUyA9PT09PT09PT09ICovCgogICAgZnVuY3Rpb24gc2V0T3JhY2xlKGFkZHJlc3MgX29yYWNsZSkKICAgICAgICBleHRlcm5hbAogICAgICAgIG9wdGlvbmFsUHJveHlfb25seU93bmVyCiAgICB7CiAgICAgICAgb3JhY2xlID0gX29yYWNsZTsKICAgICAgICBlbWl0IE9yYWNsZVVwZGF0ZWQoX29yYWNsZSk7CiAgICB9CgogICAgZnVuY3Rpb24gc2V0Q291cnQoQ291cnQgX2NvdXJ0KQogICAgICAgIGV4dGVybmFsCiAgICAgICAgb3B0aW9uYWxQcm94eV9vbmx5T3duZXIKICAgIHsKICAgICAgICBjb3VydCA9IF9jb3VydDsKICAgICAgICBlbWl0IENvdXJ0VXBkYXRlZChfY291cnQpOwogICAgfQoKICAgIGZ1bmN0aW9uIHNldEJlbmVmaWNpYXJ5KGFkZHJlc3MgX2JlbmVmaWNpYXJ5KQogICAgICAgIGV4dGVybmFsCiAgICAgICAgb3B0aW9uYWxQcm94eV9vbmx5T3duZXIKICAgIHsKICAgICAgICBiZW5lZmljaWFyeSA9IF9iZW5lZmljaWFyeTsKICAgICAgICBlbWl0IEJlbmVmaWNpYXJ5VXBkYXRlZChfYmVuZWZpY2lhcnkpOwogICAgfQoKICAgIGZ1bmN0aW9uIHNldFBvb2xGZWVSYXRlKHVpbnQgX3Bvb2xGZWVSYXRlKQogICAgICAgIGV4dGVybmFsCiAgICAgICAgb3B0aW9uYWxQcm94eV9vbmx5T3duZXIKICAgIHsKICAgICAgICByZXF1aXJlKF9wb29sRmVlUmF0ZSA8PSBVTklUKTsKICAgICAgICBwb29sRmVlUmF0ZSA9IF9wb29sRmVlUmF0ZTsKICAgICAgICBlbWl0IFBvb2xGZWVSYXRlVXBkYXRlZChfcG9vbEZlZVJhdGUpOwogICAgfQoKICAgIGZ1bmN0aW9uIHNldFN0YWxlUGVyaW9kKHVpbnQgX3N0YWxlUGVyaW9kKQogICAgICAgIGV4dGVybmFsCiAgICAgICAgb3B0aW9uYWxQcm94eV9vbmx5T3duZXIKICAgIHsKICAgICAgICBzdGFsZVBlcmlvZCA9IF9zdGFsZVBlcmlvZDsKICAgICAgICBlbWl0IFN0YWxlUGVyaW9kVXBkYXRlZChfc3RhbGVQZXJpb2QpOwogICAgfQogCgogICAgLyogPT09PT09PT09PSBWSUVXIEZVTkNUSU9OUyA9PT09PT09PT09ICovIAoKICAgIC8qIFJldHVybiB0aGUgZXF1aXZhbGVudCBmaWF0IHZhbHVlIG9mIHRoZSBnaXZlbiBxdWFudGl0eQogICAgICogb2YgZXRoZXIgYXQgdGhlIGN1cnJlbnQgcHJpY2UuCiAgICAgKiBSZXZlcnRzIGlmIHRoZSBwcmljZSBpcyBzdGFsZS4gKi8KICAgIGZ1bmN0aW9uIGZpYXRWYWx1ZSh1aW50IGV0aCkKICAgICAgICBwdWJsaWMKICAgICAgICB2aWV3CiAgICAgICAgcHJpY2VOb3RTdGFsZQogICAgICAgIHJldHVybnMgKHVpbnQpCiAgICB7CiAgICAgICAgcmV0dXJuIHNhZmVNdWxfZGVjKGV0aCwgZXRoZXJQcmljZSk7CiAgICB9CgogICAgLyogUmV0dXJuIHRoZSBjdXJyZW50IGZpYXQgdmFsdWUgb2YgdGhlIGNvbnRyYWN0J3MgYmFsYW5jZS4KICAgICAqIFJldmVydHMgaWYgdGhlIHByaWNlIGlzIHN0YWxlLiAqLwogICAgZnVuY3Rpb24gZmlhdEJhbGFuY2UoKQogICAgICAgIHB1YmxpYwogICAgICAgIHZpZXcKICAgICAgICByZXR1cm5zICh1aW50KQogICAgewogICAgICAgIC8vIFByaWNlIHN0YWxlbmVzcyBjaGVjayBvY2N1cnMgaW5zaWRlIHRoZSBjYWxsIHRvIGZpYXRWYWx1ZS4KICAgICAgICByZXR1cm4gZmlhdFZhbHVlKGFkZHJlc3ModGhpcykuYmFsYW5jZSk7CiAgICB9CgogICAgLyogUmV0dXJuIHRoZSBlcXVpdmFsZW50IGV0aGVyIHZhbHVlIG9mIHRoZSBnaXZlbiBxdWFudGl0eQogICAgICogb2YgZmlhdCBhdCB0aGUgY3VycmVudCBwcmljZS4KICAgICAqIFJldmVydHMgaWYgdGhlIHByaWNlIGlzIHN0YWxlLiAqLwogICAgZnVuY3Rpb24gZXRoZXJWYWx1ZSh1aW50IGZpYXQpCiAgICAgICAgcHVibGljCiAgICAgICAgdmlldwogICAgICAgIHByaWNlTm90U3RhbGUKICAgICAgICByZXR1cm5zICh1aW50KQogICAgewogICAgICAgIHJldHVybiBzYWZlRGl2X2RlYyhmaWF0LCBldGhlclByaWNlKTsKICAgIH0KCiAgICAvKiBUaGUgc2FtZSBhcyBldGhlclZhbHVlKCksIGJ1dCB3aXRob3V0IHRoZSBzdGFsZSBwcmljZSBjaGVjay4gKi8KICAgIGZ1bmN0aW9uIGV0aGVyVmFsdWVBbGxvd1N0YWxlKHVpbnQgZmlhdCkgCiAgICAgICAgaW50ZXJuYWwKICAgICAgICB2aWV3CiAgICAgICAgcmV0dXJucyAodWludCkKICAgIHsKICAgICAgICByZXR1cm4gc2FmZURpdl9kZWMoZmlhdCwgZXRoZXJQcmljZSk7CiAgICB9CgogICAgLyogUmV0dXJuIHRoZSB1bml0cyBvZiBmaWF0IHBlciBub21pbiBpbiB0aGUgc3VwcGx5LgogICAgICogUmV2ZXJ0cyBpZiB0aGUgcHJpY2UgaXMgc3RhbGUuICovCiAgICBmdW5jdGlvbiBjb2xsYXRlcmFsaXNhdGlvblJhdGlvKCkKICAgICAgICBwdWJsaWMKICAgICAgICB2aWV3CiAgICAgICAgcmV0dXJucyAodWludCkKICAgIHsKICAgICAgICByZXR1cm4gc2FmZURpdl9kZWMoZmlhdEJhbGFuY2UoKSwgX25vbWluQ2FwKCkpOwogICAgfQoKICAgIC8qIFJldHVybiB0aGUgbWF4aW11bSBudW1iZXIgb2YgZXh0YW50IG5vbWlucywKICAgICAqIGVxdWFsIHRvIHRoZSBub21pbiBwb29sIHBsdXMgdG90YWwgKGNpcmN1bGF0aW5nKSBzdXBwbHkuICovCiAgICBmdW5jdGlvbiBfbm9taW5DYXAoKQogICAgICAgIGludGVybmFsCiAgICAgICAgdmlldwogICAgICAgIHJldHVybnMgKHVpbnQpCiAgICB7CiAgICAgICAgcmV0dXJuIHNhZmVBZGQobm9taW5Qb29sLCB0b3RhbFN1cHBseSk7CiAgICB9CgogICAgLyogUmV0dXJuIHRoZSBmZWUgY2hhcmdlZCBvbiBhIHB1cmNoYXNlIG9yIHNhbGUgb2YgbiBub21pbnMuICovCiAgICBmdW5jdGlvbiBwb29sRmVlSW5jdXJyZWQodWludCBuKQogICAgICAgIHB1YmxpYwogICAgICAgIHZpZXcKICAgICAgICByZXR1cm5zICh1aW50KQogICAgewogICAgICAgIHJldHVybiBzYWZlTXVsX2RlYyhuLCBwb29sRmVlUmF0ZSk7CiAgICB9CgogICAgLyogUmV0dXJuIHRoZSBmaWF0IGNvc3QgKGluY2x1ZGluZyBmZWUpIG9mIHB1cmNoYXNpbmcgbiBub21pbnMuCiAgICAgKiBOb21pbnMgYXJlIHB1cmNoYXNlZCBmb3IgJDEsIHBsdXMgdGhlIGZlZS4gKi8KICAgIGZ1bmN0aW9uIHB1cmNoYXNlQ29zdEZpYXQodWludCBuKQogICAgICAgIHB1YmxpYwogICAgICAgIHZpZXcKICAgICAgICByZXR1cm5zICh1aW50KQogICAgewogICAgICAgIHJldHVybiBzYWZlQWRkKG4sIHBvb2xGZWVJbmN1cnJlZChuKSk7CiAgICB9CgogICAgLyogUmV0dXJuIHRoZSBldGhlciBjb3N0IChpbmNsdWRpbmcgZmVlKSBvZiBwdXJjaGFzaW5nIG4gbm9taW5zLgogICAgICogUmV2ZXJ0cyBpZiB0aGUgcHJpY2UgaXMgc3RhbGUuICovCiAgICBmdW5jdGlvbiBwdXJjaGFzZUNvc3RFdGhlcih1aW50IG4pCiAgICAgICAgcHVibGljCiAgICAgICAgdmlldwogICAgICAgIHJldHVybnMgKHVpbnQpCiAgICB7CiAgICAgICAgLy8gUHJpY2Ugc3RhbGVuZXNzIGNoZWNrIG9jY3VycyBpbnNpZGUgdGhlIGNhbGwgdG8gZXRoZXJWYWx1ZS4KICAgICAgICByZXR1cm4gZXRoZXJWYWx1ZShwdXJjaGFzZUNvc3RGaWF0KG4pKTsKICAgIH0KCiAgICAvKiBSZXR1cm4gdGhlIGZpYXQgcHJvY2VlZHMgKGxlc3MgdGhlIGZlZSkgb2Ygc2VsbGluZyBuIG5vbWlucy4KICAgICAqIE5vbWlucyBhcmUgc29sZCBmb3IgJDEsIG1pbnVzIHRoZSBmZWUuICovCiAgICBmdW5jdGlvbiBzYWxlUHJvY2VlZHNGaWF0KHVpbnQgbikKICAgICAgICBwdWJsaWMKICAgICAgICB2aWV3CiAgICAgICAgcmV0dXJucyAodWludCkKICAgIHsKICAgICAgICByZXR1cm4gc2FmZVN1YihuLCBwb29sRmVlSW5jdXJyZWQobikpOwogICAgfQoKICAgIC8qIFJldHVybiB0aGUgZXRoZXIgcHJvY2VlZHMgKGxlc3MgdGhlIGZlZSkgb2Ygc2VsbGluZyBuCiAgICAgKiBub21pbnMuCiAgICAgKiBSZXZlcnRzIGlmIHRoZSBwcmljZSBpcyBzdGFsZS4gKi8KICAgIGZ1bmN0aW9uIHNhbGVQcm9jZWVkc0V0aGVyKHVpbnQgbikKICAgICAgICBwdWJsaWMKICAgICAgICB2aWV3CiAgICAgICAgcmV0dXJucyAodWludCkKICAgIHsKICAgICAgICAvLyBQcmljZSBzdGFsZW5lc3MgY2hlY2sgb2NjdXJzIGluc2lkZSB0aGUgY2FsbCB0byBldGhlclZhbHVlLgogICAgICAgIHJldHVybiBldGhlclZhbHVlKHNhbGVQcm9jZWVkc0ZpYXQobikpOwogICAgfQoKICAgIC8qIFRoZSBzYW1lIGFzIHNhbGVQcm9jZWVkc0V0aGVyKCksIGJ1dCB3aXRob3V0IHRoZSBzdGFsZSBwcmljZSBjaGVjay4gKi8KICAgIGZ1bmN0aW9uIHNhbGVQcm9jZWVkc0V0aGVyQWxsb3dTdGFsZSh1aW50IG4pCiAgICAgICAgaW50ZXJuYWwKICAgICAgICB2aWV3CiAgICAgICAgcmV0dXJucyAodWludCkKICAgIHsKICAgICAgICByZXR1cm4gZXRoZXJWYWx1ZUFsbG93U3RhbGUoc2FsZVByb2NlZWRzRmlhdChuKSk7CiAgICB9CgogICAgLyogVHJ1ZSBpZmYgdGhlIGN1cnJlbnQgYmxvY2sgdGltZXN0YW1wIGlzIGxhdGVyIHRoYW4gdGhlIHRpbWUKICAgICAqIHRoZSBwcmljZSB3YXMgbGFzdCB1cGRhdGVkLCBwbHVzIHRoZSBzdGFsZSBwZXJpb2QuICovCiAgICBmdW5jdGlvbiBwcmljZUlzU3RhbGUoKQogICAgICAgIHB1YmxpYwogICAgICAgIHZpZXcKICAgICAgICByZXR1cm5zIChib29sKQogICAgewogICAgICAgIHJldHVybiBzYWZlQWRkKGxhc3RQcmljZVVwZGF0ZSwgc3RhbGVQZXJpb2QpIDwgbm93OwogICAgfQoKICAgIGZ1bmN0aW9uIGlzTGlxdWlkYXRpbmcoKQogICAgICAgIHB1YmxpYwogICAgICAgIHZpZXcKICAgICAgICByZXR1cm5zIChib29sKQogICAgewogICAgICAgIHJldHVybiBsaXF1aWRhdGlvblRpbWVzdGFtcCA8PSBub3c7CiAgICB9CgogICAgLyogVHJ1ZSBpZiB0aGUgY29udHJhY3QgaXMgc2VsZi1kZXN0cnVjdGlibGUuIAogICAgICogVGhpcyBpcyB0cnVlIGlmIGVpdGhlciB0aGUgY29tcGxldGUgbGlxdWlkYXRpb24gcGVyaW9kIGhhcyBlbGFwc2VkLAogICAgICogb3IgaWYgYWxsIHRva2VucyBoYXZlIGJlZW4gcmV0dXJuZWQgdG8gdGhlIGNvbnRyYWN0IGFuZCBpdCBoYXMgYmVlbgogICAgICogaW4gbGlxdWlkYXRpb24gZm9yIGF0IGxlYXN0IGEgd2Vlay4KICAgICAqIFNpbmNlIHRoZSBjb250cmFjdCBpcyBvbmx5IGRlc3RydWN0aWJsZSBhZnRlciB0aGUgbGlxdWlkYXRpb25UaW1lc3RhbXAsCiAgICAgKiBhIGZvcnRpb3JpIGNhblNlbGZEZXN0cnVjdCgpIGltcGxpZXMgaXNMaXF1aWRhdGluZygpLiAqLwogICAgZnVuY3Rpb24gY2FuU2VsZkRlc3RydWN0KCkKICAgICAgICBwdWJsaWMKICAgICAgICB2aWV3CiAgICAgICAgcmV0dXJucyAoYm9vbCkKICAgIHsKICAgICAgICAvLyBOb3QgYmVpbmcgaW4gbGlxdWlkYXRpb24gaW1wbGllcyB0aGUgdGltZXN0YW1wIGlzIHVpbnQgbWF4LCBzbyBpdCB3b3VsZCByb2xsIG92ZXIuCiAgICAgICAgLy8gV2UgbmVlZCB0byBjaGVjayB3aGV0aGVyIHdlJ3JlIGluIGxpcXVpZGF0aW9uIGZpcnN0LgogICAgICAgIGlmIChpc0xpcXVpZGF0aW5nKCkpIHsKICAgICAgICAgICAgLy8gVGhlc2UgdGltZXN0YW1wcyBhbmQgZHVyYXRpb25zIGhhdmUgdmFsdWVzIGNsYW1wZWQgd2l0aGluIHJlYXNvbmFibGUgdmFsdWVzIGFuZAogICAgICAgICAgICAvLyBjYW5ub3Qgb3ZlcmZsb3cuCiAgICAgICAgICAgIGJvb2wgdG90YWxQZXJpb2RFbGFwc2VkID0gbGlxdWlkYXRpb25UaW1lc3RhbXAgKyBsaXF1aWRhdGlvblBlcmlvZCA8IG5vdzsKICAgICAgICAgICAgLy8gVG90YWwgc3VwcGx5IG9mIDAgbWVhbnMgYWxsIHRva2VucyBoYXZlIHJldHVybmVkIHRvIHRoZSBwb29sLgogICAgICAgICAgICBib29sIGFsbFRva2Vuc1JldHVybmVkID0gKGxpcXVpZGF0aW9uVGltZXN0YW1wICsgMSB3ZWVrcyA8IG5vdykgJiYgKHRvdGFsU3VwcGx5ID09IDApOwogICAgICAgICAgICByZXR1cm4gdG90YWxQZXJpb2RFbGFwc2VkIHx8IGFsbFRva2Vuc1JldHVybmVkOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgoKICAgIC8qID09PT09PT09PT0gTVVUQVRJVkUgRlVOQ1RJT05TID09PT09PT09PT0gKi8KCiAgICAvKiBPdmVycmlkZSBFUkMyMCB0cmFuc2ZlciBmdW5jdGlvbiBpbiBvcmRlciB0byBjaGVjawogICAgICogd2hldGhlciB0aGUgcmVjaXBpZW50IGFjY291bnQgaXMgZnJvemVuLiBOb3RlIHRoYXQgdGhlcmUgaXMKICAgICAqIG5vIG5lZWQgdG8gY2hlY2sgd2hldGhlciB0aGUgc2VuZGVyIGhhcyBhIGZyb3plbiBhY2NvdW50LAogICAgICogc2luY2UgdGhlaXIgZnVuZHMgaGF2ZSBhbHJlYWR5IGJlZW4gY29uZmlzY2F0ZWQsCiAgICAgKiBhbmQgbm8gbmV3IGZ1bmRzIGNhbiBiZSB0cmFuc2ZlcnJlZCB0byBpdC4qLwogICAgZnVuY3Rpb24gdHJhbnNmZXIoYWRkcmVzcyB0bywgdWludCB2YWx1ZSkKICAgICAgICBwdWJsaWMKICAgICAgICBvcHRpb25hbFByb3h5CiAgICAgICAgcmV0dXJucyAoYm9vbCkKICAgIHsKICAgICAgICByZXF1aXJlKCFmcm96ZW5bdG9dKTsKICAgICAgICByZXR1cm4gX3RyYW5zZmVyX2J5UHJveHkobWVzc2FnZVNlbmRlciwgdG8sIHZhbHVlKTsKICAgIH0KCiAgICAvKiBPdmVycmlkZSBFUkMyMCB0cmFuc2ZlckZyb20gZnVuY3Rpb24gaW4gb3JkZXIgdG8gY2hlY2sKICAgICAqIHdoZXRoZXIgdGhlIHJlY2lwaWVudCBhY2NvdW50IGlzIGZyb3plbi4gKi8KICAgIGZ1bmN0aW9uIHRyYW5zZmVyRnJvbShhZGRyZXNzIGZyb20sIGFkZHJlc3MgdG8sIHVpbnQgdmFsdWUpCiAgICAgICAgcHVibGljCiAgICAgICAgb3B0aW9uYWxQcm94eQogICAgICAgIHJldHVybnMgKGJvb2wpCiAgICB7CiAgICAgICAgcmVxdWlyZSghZnJvemVuW3RvXSk7CiAgICAgICAgcmV0dXJuIF90cmFuc2ZlckZyb21fYnlQcm94eShtZXNzYWdlU2VuZGVyLCBmcm9tLCB0bywgdmFsdWUpOwogICAgfQoKICAgIC8qIFVwZGF0ZSB0aGUgY3VycmVudCBldGhlciBwcmljZSBhbmQgdXBkYXRlIHRoZSBsYXN0IHVwZGF0ZWQgdGltZSwKICAgICAqIHJlZnJlc2hpbmcgdGhlIHByaWNlIHN0YWxlbmVzcy4KICAgICAqIEFsc28gY2hlY2tzIHdoZXRoZXIgdGhlIGNvbnRyYWN0J3MgY29sbGF0ZXJhbCBsZXZlbHMgaGF2ZSBmYWxsZW4gdG8gbG93LAogICAgICogYW5kIGluaXRpYXRlcyBsaXF1aWRhdGlvbiBpZiB0aGF0IGlzIHRoZSBjYXNlLgogICAgICogRXhjZXB0aW9uYWwgY29uZGl0aW9uczoKICAgICAqICAgICBOb3QgY2FsbGVkIGJ5IHRoZSBvcmFjbGUuCiAgICAgKiAgICAgTm90IHRoZSBtb3N0IHJlY2VudGx5IHNlbnQgcHJpY2UuICovCiAgICBmdW5jdGlvbiB1cGRhdGVQcmljZSh1aW50IHByaWNlLCB1aW50IHRpbWVTZW50KQogICAgICAgIGV4dGVybmFsCiAgICAgICAgcG9zdENoZWNrQXV0b0xpcXVpZGF0ZQogICAgewogICAgICAgIC8vIFNob3VsZCBiZSBjYWxsYWJsZSBvbmx5IGJ5IHRoZSBvcmFjbGUuCiAgICAgICAgcmVxdWlyZShtc2cuc2VuZGVyID09IG9yYWNsZSk7CiAgICAgICAgLy8gTXVzdCBiZSB0aGUgbW9zdCByZWNlbnRseSBzZW50IHByaWNlLCBidXQgbm90IHRvbyBmYXIgaW4gdGhlIGZ1dHVyZS4KICAgICAgICAvLyAoc28gd2UgY2FuJ3QgbG9jayBvdXJzZWx2ZXMgb3V0IG9mIHVwZGF0aW5nIHRoZSBvcmFjbGUgZm9yIGxvbmdlciB0aGFuIHRoaXMpCiAgICAgICAgcmVxdWlyZShsYXN0UHJpY2VVcGRhdGUgPCB0aW1lU2VudCAmJiB0aW1lU2VudCA8IG5vdyArIDEwIG1pbnV0ZXMpOwoKICAgICAgICBldGhlclByaWNlID0gcHJpY2U7CiAgICAgICAgbGFzdFByaWNlVXBkYXRlID0gdGltZVNlbnQ7CiAgICAgICAgZW1pdCBQcmljZVVwZGF0ZWQocHJpY2UpOwogICAgfQoKICAgIC8qIElzc3VlcyBuIG5vbWlucyBpbnRvIHRoZSBwb29sIGF2YWlsYWJsZSB0byBiZSBib3VnaHQgYnkgdXNlcnMuCiAgICAgKiBNdXN0IGJlIGFjY29tcGFuaWVkIGJ5ICRuIHdvcnRoIG9mIGV0aGVyLgogICAgICogRXhjZXB0aW9uYWwgY29uZGl0aW9uczoKICAgICAqICAgICBOb3QgY2FsbGVkIGJ5IGNvbnRyYWN0IG93bmVyLgogICAgICogICAgIEluc3VmZmljaWVudCBiYWNraW5nIGZ1bmRzIHByb3ZpZGVkIChwb3N0LWlzc3VhbmNlIGNvbGxhdGVyYWxpc2F0aW9uIGJlbG93IG1pbmltdW0gcmVxdWlyZW1lbnQpLgogICAgICogICAgIFByaWNlIGlzIHN0YWxlLiAqLwogICAgZnVuY3Rpb24gcmVwbGVuaXNoUG9vbCh1aW50IG4pCiAgICAgICAgZXh0ZXJuYWwKICAgICAgICBwYXlhYmxlCiAgICAgICAgbm90TGlxdWlkYXRpbmcKICAgICAgICBvcHRpb25hbFByb3h5X29ubHlPd25lcgogICAgewogICAgICAgIC8vIFByaWNlIHN0YWxlbmVzcyBjaGVjayBvY2N1cnMgaW5zaWRlIHRoZSBjYWxsIHRvIGZpYXRCYWxhbmNlLgogICAgICAgIC8vIFNhZmUgYWRkaXRpb25zIGFyZSB1bm5lY2Vzc2FyeSBoZXJlLCBhcyBlaXRoZXIgdGhlIGFkZGl0aW9uIGlzIGNoZWNrZWQgb24gdGhlIGZvbGxvd2luZyBsaW5lCiAgICAgICAgLy8gb3IgdGhlIG92ZXJmbG93IHdvdWxkIGNhdXNlIHRoZSByZXF1aXJlbWVudCBub3QgdG8gYmUgc2F0aXNmaWVkLgogICAgICAgIHJlcXVpcmUoZmlhdEJhbGFuY2UoKSA+PSBzYWZlTXVsX2RlYyhzYWZlQWRkKF9ub21pbkNhcCgpLCBuKSwgTUlOSU1VTV9JU1NVQU5DRV9SQVRJTykpOwogICAgICAgIG5vbWluUG9vbCA9IHNhZmVBZGQobm9taW5Qb29sLCBuKTsKICAgICAgICBlbWl0IFBvb2xSZXBsZW5pc2hlZChuLCBtc2cudmFsdWUpOwogICAgfQoKICAgIC8qIEJ1cm5zIG4gbm9taW5zIGZyb20gdGhlIHBvb2wuCiAgICAgKiBFeGNlcHRpb25hbCBjb25kaXRpb25zOgogICAgICogICAgIE5vdCBjYWxsZWQgYnkgY29udHJhY3Qgb3duZXIuCiAgICAgKiAgICAgVGhlcmUgYXJlIGZld2VyIHRoYW4gbiBub21pbnMgaW4gdGhlIHBvb2wuICovCiAgICBmdW5jdGlvbiBkaW1pbmlzaFBvb2wodWludCBuKQogICAgICAgIGV4dGVybmFsCiAgICAgICAgb3B0aW9uYWxQcm94eV9vbmx5T3duZXIKICAgIHsKICAgICAgICAvLyBSZXF1aXJlIHRoYXQgdGhlcmUgYXJlIGVub3VnaCBub21pbnMgaW4gdGhlIGFjY2Vzc2libGUgcG9vbCB0byBidXJuCiAgICAgICAgcmVxdWlyZShub21pblBvb2wgPj0gbik7CiAgICAgICAgbm9taW5Qb29sID0gc2FmZVN1Yihub21pblBvb2wsIG4pOwogICAgICAgIGVtaXQgUG9vbERpbWluaXNoZWQobik7CiAgICB9CgogICAgLyogU2VuZHMgbiBub21pbnMgdG8gdGhlIHNlbmRlciBmcm9tIHRoZSBwb29sLCBpbiBleGNoYW5nZSBmb3IKICAgICAqICRuIHBsdXMgdGhlIGZlZSB3b3J0aCBvZiBldGhlci4KICAgICAqIEV4Y2VwdGlvbmFsIGNvbmRpdGlvbnM6CiAgICAgKiAgICAgSW5zdWZmaWNpZW50IG9yIHRvbyBtYW55IGZ1bmRzIHByb3ZpZGVkLgogICAgICogICAgIE1vcmUgbm9taW5zIHJlcXVlc3RlZCB0aGFuIGFyZSBpbiB0aGUgcG9vbC4KICAgICAqICAgICBuIGJlbG93IHRoZSBwdXJjaGFzZSBtaW5pbXVtICgxIGNlbnQpLgogICAgICogICAgIGNvbnRyYWN0IGluIGxpcXVpZGF0aW9uLgogICAgICogICAgIFByaWNlIGlzIHN0YWxlLiAqLwogICAgZnVuY3Rpb24gYnV5KHVpbnQgbikKICAgICAgICBleHRlcm5hbAogICAgICAgIHBheWFibGUKICAgICAgICBub3RMaXF1aWRhdGluZwogICAgICAgIG9wdGlvbmFsUHJveHkKICAgIHsKICAgICAgICAvLyBQcmljZSBzdGFsZW5lc3MgY2hlY2sgb2NjdXJzIGluc2lkZSB0aGUgY2FsbCB0byBwdXJjaGFzZUV0aGVyQ29zdC4KICAgICAgICByZXF1aXJlKG4gPj0gTUlOSU1VTV9QVVJDSEFTRSAmJgogICAgICAgICAgICAgICAgbXNnLnZhbHVlID09IHB1cmNoYXNlQ29zdEV0aGVyKG4pKTsKICAgICAgICBhZGRyZXNzIHNlbmRlciA9IG1lc3NhZ2VTZW5kZXI7CiAgICAgICAgLy8gc3ViIHJlcXVpcmVzIHRoYXQgbm9taW5Qb29sID49IG4KICAgICAgICBub21pblBvb2wgPSBzYWZlU3ViKG5vbWluUG9vbCwgbik7CiAgICAgICAgc3RhdGUuc2V0QmFsYW5jZU9mKHNlbmRlciwgc2FmZUFkZChzdGF0ZS5iYWxhbmNlT2Yoc2VuZGVyKSwgbikpOwogICAgICAgIGVtaXQgUHVyY2hhc2VkKHNlbmRlciwgc2VuZGVyLCBuLCBtc2cudmFsdWUpOwogICAgICAgIGVtaXQgVHJhbnNmZXIoMCwgc2VuZGVyLCBuKTsKICAgICAgICB0b3RhbFN1cHBseSA9IHNhZmVBZGQodG90YWxTdXBwbHksIG4pOwogICAgfQoKICAgIC8qIFNlbmRzIG4gbm9taW5zIHRvIHRoZSBwb29sIGZyb20gdGhlIHNlbmRlciwgaW4gZXhjaGFuZ2UgZm9yCiAgICAgKiAkbiBtaW51cyB0aGUgZmVlIHdvcnRoIG9mIGV0aGVyLgogICAgICogRXhjZXB0aW9uYWwgY29uZGl0aW9uczoKICAgICAqICAgICBJbnN1ZmZpY2llbnQgbm9taW5zIGluIHNlbmRlcidzIHdhbGxldC4KICAgICAqICAgICBJbnN1ZmZpY2llbnQgZnVuZHMgaW4gdGhlIHBvb2wgdG8gcGF5IHNlbmRlci4KICAgICAqICAgICBQcmljZSBpcyBzdGFsZSBpZiBub3QgaW4gbGlxdWlkYXRpb24uICovCiAgICBmdW5jdGlvbiBzZWxsKHVpbnQgbikKICAgICAgICBleHRlcm5hbAogICAgICAgIG9wdGlvbmFsUHJveHkKICAgIHsKCiAgICAgICAgLy8gUHJpY2Ugc3RhbGVuZXNzIGNoZWNrIG9jY3VycyBpbnNpZGUgdGhlIGNhbGwgdG8gc2FsZVByb2NlZWRzRXRoZXIsCiAgICAgICAgLy8gYnV0IHdlIGFsbG93IHBlb3BsZSB0byBzZWxsIHRoZWlyIG5vbWlucyBiYWNrIHRvIHRoZSBzeXN0ZW0KICAgICAgICAvLyBpZiB3ZSdyZSBpbiBsaXF1aWRhdGlvbiwgcmVnYXJkbGVzcy4KICAgICAgICB1aW50IHByb2NlZWRzOwogICAgICAgIGlmIChpc0xpcXVpZGF0aW5nKCkpIHsKICAgICAgICAgICAgcHJvY2VlZHMgPSBzYWxlUHJvY2VlZHNFdGhlckFsbG93U3RhbGUobik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcHJvY2VlZHMgPSBzYWxlUHJvY2VlZHNFdGhlcihuKTsKICAgICAgICB9CgogICAgICAgIHJlcXVpcmUoYWRkcmVzcyh0aGlzKS5iYWxhbmNlID49IHByb2NlZWRzKTsKCiAgICAgICAgYWRkcmVzcyBzZW5kZXIgPSBtZXNzYWdlU2VuZGVyOwogICAgICAgIC8vIHN1YiByZXF1aXJlcyB0aGF0IHRoZSBiYWxhbmNlIGlzIGdyZWF0ZXIgdGhhbiBuCiAgICAgICAgc3RhdGUuc2V0QmFsYW5jZU9mKHNlbmRlciwgc2FmZVN1YihzdGF0ZS5iYWxhbmNlT2Yoc2VuZGVyKSwgbikpOwogICAgICAgIG5vbWluUG9vbCA9IHNhZmVBZGQobm9taW5Qb29sLCBuKTsKICAgICAgICBlbWl0IFNvbGQoc2VuZGVyLCBzZW5kZXIsIG4sIHByb2NlZWRzKTsKICAgICAgICBlbWl0IFRyYW5zZmVyKHNlbmRlciwgMCwgbik7CiAgICAgICAgdG90YWxTdXBwbHkgPSBzYWZlU3ViKHRvdGFsU3VwcGx5LCBuKTsKICAgICAgICBzZW5kZXIudHJhbnNmZXIocHJvY2VlZHMpOwogICAgfQoKICAgIC8qIExvY2sgbm9taW4gcHVyY2hhc2UgZnVuY3Rpb24gaW4gcHJlcGFyYXRpb24gZm9yIGRlc3Ryb3lpbmcgdGhlIGNvbnRyYWN0LgogICAgICogV2hpbGUgdGhlIGNvbnRyYWN0IGlzIHVuZGVyIGxpcXVpZGF0aW9uLCB1c2VycyBtYXkgc2VsbCBub21pbnMgYmFjayB0byB0aGUgc3lzdGVtLgogICAgICogQWZ0ZXIgbGlxdWlkYXRpb24gcGVyaW9kIGhhcyB0ZXJtaW5hdGVkLCB0aGUgY29udHJhY3QgbWF5IGJlIHNlbGYtZGVzdHJ1Y3RlZCwKICAgICAqIHJldHVybmluZyBhbGwgcmVtYWluaW5nIGV0aGVyIHRvIHRoZSBiZW5lZmljaWFyeSBhZGRyZXNzLgogICAgICogRXhjZXB0aW9uYWwgY2FzZXM6CiAgICAgKiAgICAgTm90IGNhbGxlZCBieSBjb250cmFjdCBvd25lcjsKICAgICAqICAgICBjb250cmFjdCBhbHJlYWR5IGluIGxpcXVpZGF0aW9uOyAqLwogICAgZnVuY3Rpb24gZm9yY2VMaXF1aWRhdGlvbigpCiAgICAgICAgZXh0ZXJuYWwKICAgICAgICBub3RMaXF1aWRhdGluZwogICAgICAgIG9wdGlvbmFsUHJveHlfb25seU93bmVyCiAgICB7CiAgICAgICAgYmVnaW5MaXF1aWRhdGlvbigpOwogICAgfQoKICAgIGZ1bmN0aW9uIGJlZ2luTGlxdWlkYXRpb24oKQogICAgICAgIGludGVybmFsCiAgICB7CiAgICAgICAgbGlxdWlkYXRpb25UaW1lc3RhbXAgPSBub3c7CiAgICAgICAgZW1pdCBMaXF1aWRhdGlvbkJlZ3VuKGxpcXVpZGF0aW9uUGVyaW9kKTsKICAgIH0KCiAgICAvKiBJZiB0aGUgY29udHJhY3QgaXMgbGlxdWlkYXRpbmcsIHRoZSBvd25lciBtYXkgZXh0ZW5kIHRoZSBsaXF1aWRhdGlvbiBwZXJpb2QuCiAgICAgKiBJdCBtYXkgb25seSBnZXQgbG9uZ2VyLCBub3Qgc2hvcnRlciwgYW5kIGl0IG1heSBub3QgYmUgZXh0ZW5kZWQgcGFzdAogICAgICogdGhlIGxpcXVpZGF0aW9uIG1heC4gKi8KICAgIGZ1bmN0aW9uIGV4dGVuZExpcXVpZGF0aW9uUGVyaW9kKHVpbnQgZXh0ZW5zaW9uKQogICAgICAgIGV4dGVybmFsCiAgICAgICAgb3B0aW9uYWxQcm94eV9vbmx5T3duZXIKICAgIHsKICAgICAgICByZXF1aXJlKGlzTGlxdWlkYXRpbmcoKSk7CiAgICAgICAgdWludCBzdW0gPSBzYWZlQWRkKGxpcXVpZGF0aW9uUGVyaW9kLCBleHRlbnNpb24pOwogICAgICAgIHJlcXVpcmUoc3VtIDw9IE1BWF9MSVFVSURBVElPTl9QRVJJT0QpOwogICAgICAgIGxpcXVpZGF0aW9uUGVyaW9kID0gc3VtOwogICAgICAgIGVtaXQgTGlxdWlkYXRpb25FeHRlbmRlZChleHRlbnNpb24pOwogICAgfQoKICAgIC8qIExpcXVpZGF0aW9uIGNhbiBvbmx5IGJlIHN0b3BwZWQgaWYgdGhlIGNvbGxhdGVyYWxpc2F0aW9uIHJhdGlvCiAgICAgKiBvZiB0aGlzIGNvbnRyYWN0IGhhcyByZWNvdmVyZWQgYWJvdmUgdGhlIGF1dG9tYXRpYyBsaXF1aWRhdGlvbgogICAgICogdGhyZXNob2xkLCBmb3IgZXhhbXBsZSBpZiB0aGUgZXRoZXIgcHJpY2UgaGFzIGluY3JlYXNlZCwKICAgICAqIG9yIGJ5IGluY2x1ZGluZyBlbm91Z2ggZXRoZXIgaW4gdGhpcyB0cmFuc2FjdGlvbi4gKi8KICAgIGZ1bmN0aW9uIHRlcm1pbmF0ZUxpcXVpZGF0aW9uKCkKICAgICAgICBleHRlcm5hbAogICAgICAgIHBheWFibGUKICAgICAgICBwcmljZU5vdFN0YWxlCiAgICAgICAgb3B0aW9uYWxQcm94eV9vbmx5T3duZXIKICAgIHsKICAgICAgICByZXF1aXJlKGlzTGlxdWlkYXRpbmcoKSk7CiAgICAgICAgcmVxdWlyZShfbm9taW5DYXAoKSA9PSAwIHx8IGNvbGxhdGVyYWxpc2F0aW9uUmF0aW8oKSA+PSBBVVRPX0xJUVVJREFUSU9OX1JBVElPKTsKICAgICAgICBsaXF1aWRhdGlvblRpbWVzdGFtcCA9IH51aW50KDApOwogICAgICAgIGxpcXVpZGF0aW9uUGVyaW9kID0gREVGQVVMVF9MSVFVSURBVElPTl9QRVJJT0Q7CiAgICAgICAgZW1pdCBMaXF1aWRhdGlvblRlcm1pbmF0ZWQoKTsKICAgIH0KCiAgICAvKiBUaGUgb3duZXIgbWF5IGRlc3Ryb3kgdGhpcyBjb250cmFjdCwgcmV0dXJuaW5nIGFsbCBmdW5kcyBiYWNrIHRvIHRoZSBiZW5lZmljaWFyeQogICAgICogd2FsbGV0LCBtYXkgb25seSBiZSBjYWxsZWQgYWZ0ZXIgdGhlIGNvbnRyYWN0IGhhcyBiZWVuIGluCiAgICAgKiBsaXF1aWRhdGlvbiBmb3IgYXQgbGVhc3QgbGlxdWlkYXRpb25QZXJpb2QsIG9yIGFsbCBjaXJjdWxhdGluZwogICAgICogbm9taW5zIGhhdmUgYmVlbiBzb2xkIGJhY2sgaW50byB0aGUgcG9vbC4gKi8KICAgIGZ1bmN0aW9uIHNlbGZEZXN0cnVjdCgpCiAgICAgICAgZXh0ZXJuYWwKICAgICAgICBvcHRpb25hbFByb3h5X29ubHlPd25lcgogICAgewogICAgICAgIHJlcXVpcmUoY2FuU2VsZkRlc3RydWN0KCkpOwogICAgICAgIGVtaXQgU2VsZkRlc3RydWN0ZWQoYmVuZWZpY2lhcnkpOwogICAgICAgIHNlbGZkZXN0cnVjdChiZW5lZmljaWFyeSk7CiAgICB9CgogICAgLyogSWYgYSBjb25maXNjYXRpb24gY291cnQgbW90aW9uIGhhcyBwYXNzZWQgYW5kIHJlYWNoZWQgdGhlIGNvbmZpcm1hdGlvbgogICAgICogc3RhdGUsIHRoZSBjb3VydCBtYXkgdHJhbnNmZXIgdGhlIHRhcmdldCBhY2NvdW50J3MgYmFsYW5jZSB0byB0aGUgZmVlIHBvb2wKICAgICAqIGFuZCBmcmVlemUgaXRzIHBhcnRpY2lwYXRpb24gaW4gZnVydGhlciB0cmFuc2FjdGlvbnMuICovCiAgICBmdW5jdGlvbiBjb25maXNjYXRlQmFsYW5jZShhZGRyZXNzIHRhcmdldCkKICAgICAgICBleHRlcm5hbAogICAgewogICAgICAgIC8vIFNob3VsZCBiZSBjYWxsYWJsZSBvbmx5IGJ5IHRoZSBjb25maXNjYXRpb24gY291cnQuCiAgICAgICAgcmVxdWlyZShDb3VydChtc2cuc2VuZGVyKSA9PSBjb3VydCk7CiAgICAgICAgCiAgICAgICAgLy8gQSBtb3Rpb24gbXVzdCBhY3R1YWxseSBiZSB1bmRlcndheS4KICAgICAgICB1aW50IG1vdGlvbklEID0gY291cnQudGFyZ2V0TW90aW9uSUQodGFyZ2V0KTsKICAgICAgICByZXF1aXJlKG1vdGlvbklEICE9IDApOwoKICAgICAgICAvLyBUaGVzZSBjaGVja3MgYXJlIHN0cmljdGx5IHVubmVjZXNzYXJ5LAogICAgICAgIC8vIHNpbmNlIHRoZXkgYXJlIGFscmVhZHkgY2hlY2tlZCBpbiB0aGUgY291cnQgY29udHJhY3QgaXRzZWxmLgogICAgICAgIC8vIEkgbGVhdmUgdGhlbSBpbiBvdXQgb2YgcGFyYW5vaWEuCiAgICAgICAgcmVxdWlyZShjb3VydC5tb3Rpb25Db25maXJtaW5nKG1vdGlvbklEKSk7CiAgICAgICAgcmVxdWlyZShjb3VydC5tb3Rpb25QYXNzZXMobW90aW9uSUQpKTsKICAgICAgICByZXF1aXJlKCFmcm96ZW5bdGFyZ2V0XSk7CgogICAgICAgIC8vIENvbmZpc2NhdGUgdGhlIGJhbGFuY2UgaW4gdGhlIGFjY291bnQgYW5kIGZyZWV6ZSBpdC4KICAgICAgICB1aW50IGJhbGFuY2UgPSBzdGF0ZS5iYWxhbmNlT2YodGFyZ2V0KTsKICAgICAgICBzdGF0ZS5zZXRCYWxhbmNlT2YoYWRkcmVzcyh0aGlzKSwgc2FmZUFkZChzdGF0ZS5iYWxhbmNlT2YoYWRkcmVzcyh0aGlzKSksIGJhbGFuY2UpKTsKICAgICAgICBzdGF0ZS5zZXRCYWxhbmNlT2YodGFyZ2V0LCAwKTsKICAgICAgICBmcm96ZW5bdGFyZ2V0XSA9IHRydWU7CiAgICAgICAgZW1pdCBBY2NvdW50RnJvemVuKHRhcmdldCwgdGFyZ2V0LCBiYWxhbmNlKTsKICAgICAgICBlbWl0IFRyYW5zZmVyKHRhcmdldCwgYWRkcmVzcyh0aGlzKSwgYmFsYW5jZSk7CiAgICB9CgogICAgLyogVGhlIG93bmVyIG1heSBhbGxvdyBhIHByZXZpb3VzbHktZnJvemVuIGNvbnRyYWN0IHRvIG9uY2UKICAgICAqIGFnYWluIGFjY2VwdCBhbmQgdHJhbnNmZXIgbm9taW5zLiAqLwogICAgZnVuY3Rpb24gdW5mcmVlemVBY2NvdW50KGFkZHJlc3MgdGFyZ2V0KQogICAgICAgIGV4dGVybmFsCiAgICAgICAgb3B0aW9uYWxQcm94eV9vbmx5T3duZXIKICAgIHsKICAgICAgICBpZiAoZnJvemVuW3RhcmdldF0gJiYgRXRoZXJOb21pbih0YXJnZXQpICE9IHRoaXMpIHsKICAgICAgICAgICAgZnJvemVuW3RhcmdldF0gPSBmYWxzZTsKICAgICAgICAgICAgZW1pdCBBY2NvdW50VW5mcm96ZW4odGFyZ2V0LCB0YXJnZXQpOwogICAgICAgIH0KICAgIH0KCiAgICAvKiBGYWxsYmFjayBmdW5jdGlvbiBhbGxvd3MgY29udmVuaWVudCBjb2xsYXRlcmFsaXNhdGlvbiBvZiB0aGUgY29udHJhY3QsCiAgICAgKiBpbmNsdWRpbmcgYnkgbm9uLWZvdW5kYXRpb24gcGFydGllcy4gKi8KICAgIGZ1bmN0aW9uKCkgcHVibGljIHBheWFibGUge30KCgogICAgLyogPT09PT09PT09PSBNT0RJRklFUlMgPT09PT09PT09PSAqLwoKICAgIG1vZGlmaWVyIG5vdExpcXVpZGF0aW5nCiAgICB7CiAgICAgICAgcmVxdWlyZSghaXNMaXF1aWRhdGluZygpKTsKICAgICAgICBfOwogICAgfQoKICAgIG1vZGlmaWVyIHByaWNlTm90U3RhbGUKICAgIHsKICAgICAgICByZXF1aXJlKCFwcmljZUlzU3RhbGUoKSk7CiAgICAgICAgXzsKICAgIH0KCiAgICAvKiBBbnkgZnVuY3Rpb24gbW9kaWZpZWQgYnkgdGhpcyB3aWxsIGF1dG9tYXRpY2FsbHkgbGlxdWlkYXRlCiAgICAgKiB0aGUgc3lzdGVtIGlmIHRoZSBjb2xsYXRlcmFsIGxldmVscyBhcmUgdG9vIGxvdy4KICAgICAqIFRoaXMgaXMgY2FsbGVkIG9uIGNvbGxhdGVyYWwtdmFsdWUvbm9taW4tc3VwcGx5IG1vZGlmeWluZyBmdW5jdGlvbnMgdGhhdCBjYW4KICAgICAqIGFjdHVhbGx5IG1vdmUgdGhlIGNvbnRyYWN0IGludG8gbGlxdWlkYXRpb24uIFRoaXMgaXMgcmVhbGx5IG9ubHkKICAgICAqIHRoZSBwcmljZSB1cGRhdGUsIHNpbmNlIGlzc3VhbmNlIHJlcXVpcmVzIHRoYXQgdGhlIGNvbnRyYWN0IGlzIG92ZXJjb2xsYXRlcmFsaXNlZCwKICAgICAqIGJ1cm5pbmcgY2FuIG9ubHkgZGVzdHJveSB0b2tlbnMgd2l0aG91dCB3aXRoZHJhd2luZyBiYWNraW5nLCBidXlpbmcgZnJvbSB0aGUgcG9vbCBjYW4gb25seQogICAgICogYXN5bXB0b3RlIHRvIGEgY29sbGF0ZXJhbGlzYXRpb24gbGV2ZWwgb2YgdW5pdHksIHdoaWxlIHNlbGxpbmcgaW50byB0aGUgcG9vbCBjYW4gb25seSAKICAgICAqIGluY3JlYXNlIHRoZSBjb2xsYXRlcmFsaXNhdGlvbiByYXRpby4KICAgICAqIEFkZGl0aW9uYWxseSwgcHJpY2UgdXBkYXRlIGNoZWNrcyBzaG91bGQvd2lsbCBvY2N1ciBmcmVxdWVudGx5LiAqLwogICAgbW9kaWZpZXIgcG9zdENoZWNrQXV0b0xpcXVpZGF0ZQogICAgewogICAgICAgIF87CiAgICAgICAgaWYgKCFpc0xpcXVpZGF0aW5nKCkgJiYgX25vbWluQ2FwKCkgIT0gMCAmJiBjb2xsYXRlcmFsaXNhdGlvblJhdGlvKCkgPCBBVVRPX0xJUVVJREFUSU9OX1JBVElPKSB7CiAgICAgICAgICAgIGJlZ2luTGlxdWlkYXRpb24oKTsKICAgICAgICB9CiAgICB9CgoKICAgIC8qID09PT09PT09PT0gRVZFTlRTID09PT09PT09PT0gKi8KCiAgICBldmVudCBQb29sUmVwbGVuaXNoZWQodWludCBub21pbnNDcmVhdGVkLCB1aW50IGNvbGxhdGVyYWxEZXBvc2l0ZWQpOwoKICAgIGV2ZW50IFBvb2xEaW1pbmlzaGVkKHVpbnQgbm9taW5zRGVzdHJveWVkKTsKCiAgICBldmVudCBQdXJjaGFzZWQoYWRkcmVzcyBidXllciwgYWRkcmVzcyBpbmRleGVkIGJ1eWVySW5kZXgsIHVpbnQgbm9taW5zLCB1aW50IGV0aCk7CgogICAgZXZlbnQgU29sZChhZGRyZXNzIHNlbGxlciwgYWRkcmVzcyBpbmRleGVkIHNlbGxlckluZGV4LCB1aW50IG5vbWlucywgdWludCBldGgpOwoKICAgIGV2ZW50IFByaWNlVXBkYXRlZCh1aW50IG5ld1ByaWNlKTsKCiAgICBldmVudCBTdGFsZVBlcmlvZFVwZGF0ZWQodWludCBuZXdQZXJpb2QpOwoKICAgIGV2ZW50IE9yYWNsZVVwZGF0ZWQoYWRkcmVzcyBuZXdPcmFjbGUpOwoKICAgIGV2ZW50IENvdXJ0VXBkYXRlZChhZGRyZXNzIG5ld0NvdXJ0KTsKCiAgICBldmVudCBCZW5lZmljaWFyeVVwZGF0ZWQoYWRkcmVzcyBuZXdCZW5lZmljaWFyeSk7CgogICAgZXZlbnQgTGlxdWlkYXRpb25CZWd1bih1aW50IGR1cmF0aW9uKTsKCiAgICBldmVudCBMaXF1aWRhdGlvblRlcm1pbmF0ZWQoKTsKCiAgICBldmVudCBMaXF1aWRhdGlvbkV4dGVuZGVkKHVpbnQgZXh0ZW5zaW9uKTsKCiAgICBldmVudCBQb29sRmVlUmF0ZVVwZGF0ZWQodWludCBuZXdGZWVSYXRlKTsKCiAgICBldmVudCBTZWxmRGVzdHJ1Y3RlZChhZGRyZXNzIGJlbmVmaWNpYXJ5KTsKCiAgICBldmVudCBBY2NvdW50RnJvemVuKGFkZHJlc3MgdGFyZ2V0LCBhZGRyZXNzIGluZGV4ZWQgdGFyZ2V0SW5kZXgsIHVpbnQgYmFsYW5jZSk7CgogICAgZXZlbnQgQWNjb3VudFVuZnJvemVuKGFkZHJlc3MgdGFyZ2V0LCBhZGRyZXNzIGluZGV4ZWQgdGFyZ2V0SW5kZXgpOwp9CgovKgotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQpDT05UUkFDVCBERVNDUklQVElPTgotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoKQSB0b2tlbiBpbnRlcmZhY2UgdG8gYmUgb3ZlcnJpZGRlbiB0byBwcm9kdWNlIGFuIEVSQzIwLWNvbXBsaWFudAp0b2tlbiBjb250cmFjdC4gSXQgcmVsaWVzIG9uIGJlaW5nIGNhbGxlZCB1bmRlcm5lYXRoIGEgcHJveHksCmFzIGRlc2NyaWJlZCBpbiBQcm94eS5zb2wuCgpUaGlzIGNvbnRyYWN0IHV0aWxpc2VzIGEgc3RhdGUgZm9yIHVwZ3JhZGFiaWxpdHkgcHVycG9zZXMuCgotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoqLwoKY29udHJhY3QgRXh0ZXJuU3RhdGVQcm94eVRva2VuIGlzIFNhZmVEZWNpbWFsTWF0aCwgUHJveHlhYmxlIHsKCiAgICAvKiA9PT09PT09PT09IFNUQVRFIFZBUklBQkxFUyA9PT09PT09PT09ICovCgogICAgLy8gU3RvcmVzIGJhbGFuY2VzIGFuZCBhbGxvd2FuY2VzLgogICAgVG9rZW5TdGF0ZSBwdWJsaWMgc3RhdGU7CgogICAgLy8gT3RoZXIgRVJDMjAgZmllbGRzCiAgICBzdHJpbmcgcHVibGljIG5hbWU7CiAgICBzdHJpbmcgcHVibGljIHN5bWJvbDsKICAgIHVpbnQgcHVibGljIHRvdGFsU3VwcGx5OwoKCiAgICAvKiA9PT09PT09PT09IENPTlNUUlVDVE9SID09PT09PT09PT0gKi8KCiAgICBmdW5jdGlvbiBFeHRlcm5TdGF0ZVByb3h5VG9rZW4oc3RyaW5nIF9uYW1lLCBzdHJpbmcgX3N5bWJvbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1aW50IGluaXRpYWxTdXBwbHksIGFkZHJlc3MgaW5pdGlhbEJlbmVmaWNpYXJ5LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFRva2VuU3RhdGUgX3N0YXRlLCBhZGRyZXNzIF9vd25lcikKICAgICAgICBQcm94eWFibGUoX293bmVyKQogICAgICAgIHB1YmxpYwogICAgewogICAgICAgIG5hbWUgPSBfbmFtZTsKICAgICAgICBzeW1ib2wgPSBfc3ltYm9sOwogICAgICAgIHRvdGFsU3VwcGx5ID0gaW5pdGlhbFN1cHBseTsKCiAgICAgICAgLy8gaWYgdGhlIHN0YXRlIGlzbid0IHNldCwgY3JlYXRlIGEgbmV3IG9uZQogICAgICAgIGlmIChfc3RhdGUgPT0gVG9rZW5TdGF0ZSgwKSkgewogICAgICAgICAgICBzdGF0ZSA9IG5ldyBUb2tlblN0YXRlKF9vd25lciwgYWRkcmVzcyh0aGlzKSk7CiAgICAgICAgICAgIHN0YXRlLnNldEJhbGFuY2VPZihpbml0aWFsQmVuZWZpY2lhcnksIHRvdGFsU3VwcGx5KTsKICAgICAgICAgICAgZW1pdCBUcmFuc2ZlcihhZGRyZXNzKDApLCBpbml0aWFsQmVuZWZpY2lhcnksIGluaXRpYWxTdXBwbHkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHN0YXRlID0gX3N0YXRlOwogICAgICAgIH0KICAgfQoKICAgIC8qID09PT09PT09PT0gVklFV1MgPT09PT09PT09PSAqLwoKICAgIGZ1bmN0aW9uIGFsbG93YW5jZShhZGRyZXNzIHRva2VuT3duZXIsIGFkZHJlc3Mgc3BlbmRlcikKICAgICAgICBwdWJsaWMKICAgICAgICB2aWV3CiAgICAgICAgcmV0dXJucyAodWludCkKICAgIHsKICAgICAgICByZXR1cm4gc3RhdGUuYWxsb3dhbmNlKHRva2VuT3duZXIsIHNwZW5kZXIpOwogICAgfQoKICAgIGZ1bmN0aW9uIGJhbGFuY2VPZihhZGRyZXNzIGFjY291bnQpCiAgICAgICAgcHVibGljCiAgICAgICAgdmlldwogICAgICAgIHJldHVybnMgKHVpbnQpCiAgICB7CiAgICAgICAgcmV0dXJuIHN0YXRlLmJhbGFuY2VPZihhY2NvdW50KTsKICAgIH0KCiAgICAvKiA9PT09PT09PT09IE1VVEFUSVZFIEZVTkNUSU9OUyA9PT09PT09PT09ICovCgogICAgZnVuY3Rpb24gc2V0U3RhdGUoVG9rZW5TdGF0ZSBfc3RhdGUpCiAgICAgICAgZXh0ZXJuYWwKICAgICAgICBvcHRpb25hbFByb3h5X29ubHlPd25lcgogICAgewogICAgICAgIHN0YXRlID0gX3N0YXRlOwogICAgICAgIGVtaXQgU3RhdGVVcGRhdGVkKF9zdGF0ZSk7CiAgICB9IAoKICAgIC8qIEFueXRoaW5nIGNhbGxpbmcgdGhpcyBtdXN0IGFwcGx5IHRoZSBvbmx5UHJveHkgb3Igb3B0aW9uYWxQcm94eSBtb2RpZmllcnMuKi8KICAgIGZ1bmN0aW9uIF90cmFuc2Zlcl9ieVByb3h5KGFkZHJlc3Mgc2VuZGVyLCBhZGRyZXNzIHRvLCB1aW50IHZhbHVlKQogICAgICAgIGludGVybmFsCiAgICAgICAgcmV0dXJucyAoYm9vbCkKICAgIHsKICAgICAgICByZXF1aXJlKHRvICE9IGFkZHJlc3MoMCkpOwoKICAgICAgICAvLyBJbnN1ZmZpY2llbnQgYmFsYW5jZSB3aWxsIGJlIGhhbmRsZWQgYnkgdGhlIHNhZmUgc3VidHJhY3Rpb24uCiAgICAgICAgc3RhdGUuc2V0QmFsYW5jZU9mKHNlbmRlciwgc2FmZVN1YihzdGF0ZS5iYWxhbmNlT2Yoc2VuZGVyKSwgdmFsdWUpKTsKICAgICAgICBzdGF0ZS5zZXRCYWxhbmNlT2YodG8sIHNhZmVBZGQoc3RhdGUuYmFsYW5jZU9mKHRvKSwgdmFsdWUpKTsKCiAgICAgICAgZW1pdCBUcmFuc2ZlcihzZW5kZXIsIHRvLCB2YWx1ZSk7CgogICAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIC8qIEFueXRoaW5nIGNhbGxpbmcgdGhpcyBtdXN0IGFwcGx5IHRoZSBvbmx5UHJveHkgb3Igb3B0aW9uYWxQcm94eSBtb2RpZmllcnMuKi8KICAgIGZ1bmN0aW9uIF90cmFuc2ZlckZyb21fYnlQcm94eShhZGRyZXNzIHNlbmRlciwgYWRkcmVzcyBmcm9tLCBhZGRyZXNzIHRvLCB1aW50IHZhbHVlKQogICAgICAgIGludGVybmFsCiAgICAgICAgcmV0dXJucyAoYm9vbCkKICAgIHsKICAgICAgICByZXF1aXJlKGZyb20gIT0gYWRkcmVzcygwKSAmJiB0byAhPSBhZGRyZXNzKDApKTsKCiAgICAgICAgLy8gSW5zdWZmaWNpZW50IGJhbGFuY2Ugd2lsbCBiZSBoYW5kbGVkIGJ5IHRoZSBzYWZlIHN1YnRyYWN0aW9uLgogICAgICAgIHN0YXRlLnNldEJhbGFuY2VPZihmcm9tLCBzYWZlU3ViKHN0YXRlLmJhbGFuY2VPZihmcm9tKSwgdmFsdWUpKTsKICAgICAgICBzdGF0ZS5zZXRBbGxvd2FuY2UoZnJvbSwgc2VuZGVyLCBzYWZlU3ViKHN0YXRlLmFsbG93YW5jZShmcm9tLCBzZW5kZXIpLCB2YWx1ZSkpOwogICAgICAgIHN0YXRlLnNldEJhbGFuY2VPZih0bywgc2FmZUFkZChzdGF0ZS5iYWxhbmNlT2YodG8pLCB2YWx1ZSkpOwoKICAgICAgICBlbWl0IFRyYW5zZmVyKGZyb20sIHRvLCB2YWx1ZSk7CgogICAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIGZ1bmN0aW9uIGFwcHJvdmUoYWRkcmVzcyBzcGVuZGVyLCB1aW50IHZhbHVlKQogICAgICAgIGV4dGVybmFsCiAgICAgICAgb3B0aW9uYWxQcm94eQogICAgICAgIHJldHVybnMgKGJvb2wpCiAgICB7CiAgICAgICAgYWRkcmVzcyBzZW5kZXIgPSBtZXNzYWdlU2VuZGVyOwogICAgICAgIHN0YXRlLnNldEFsbG93YW5jZShzZW5kZXIsIHNwZW5kZXIsIHZhbHVlKTsKICAgICAgICBlbWl0IEFwcHJvdmFsKHNlbmRlciwgc3BlbmRlciwgdmFsdWUpOwogICAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIC8qID09PT09PT09PT0gRVZFTlRTID09PT09PT09PT0gKi8KCiAgICBldmVudCBUcmFuc2ZlcihhZGRyZXNzIGluZGV4ZWQgZnJvbSwgYWRkcmVzcyBpbmRleGVkIHRvLCB1aW50IHZhbHVlKTsKCiAgICBldmVudCBBcHByb3ZhbChhZGRyZXNzIGluZGV4ZWQgb3duZXIsIGFkZHJlc3MgaW5kZXhlZCBzcGVuZGVyLCB1aW50IHZhbHVlKTsKCiAgICBldmVudCBTdGF0ZVVwZGF0ZWQoYWRkcmVzcyBuZXdTdGF0ZSk7Cn0KCi8qCi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCkNPTlRSQUNUIERFU0NSSVBUSU9OCi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCgpUaGlzIGNvbnRyYWN0IGFsbG93cyB0aGUgZm91bmRhdGlvbiB0byBhcHBseSB1bmlxdWUgdmVzdGluZwpzY2hlZHVsZXMgdG8gaGF2dmVuIGZ1bmRzIHNvbGQgYXQgdmFyaW91cyBkaXNjb3VudHMgaW4gdGhlIHRva2VuCnNhbGUuIEhhdnZlbkVzY3JvdyBnaXZlcyB1c2VycyB0aGUgYWJpbGl0eSB0byBpbnNwZWN0IHRoZWlyCnZlc3RlZCBmdW5kcywgdGhlaXIgcXVhbnRpdGllcyBhbmQgdmVzdGluZyBkYXRlcywgYW5kIHRvIHdpdGhkcmF3CnRoZSBmZWVzIHRoYXQgYWNjcnVlIG9uIHRob3NlIGZ1bmRzLgoKVGhlIGZlZXMgYXJlIGhhbmRsZWQgYnkgd2l0aGRyYXdpbmcgdGhlIGVudGlyZSBmZWUgYWxsb2NhdGlvbgpmb3IgYWxsIGhhdnZlbnMgaW5zaWRlIHRoZSBlc2Nyb3cgY29udHJhY3QsIGFuZCB0aGVuIGFsbG93aW5nCnRoZSBjb250cmFjdCBpdHNlbGYgdG8gc3ViZGl2aWRlIHRoYXQgcG9vbCB1cCBwcm9wb3J0aW9uYWxseSB3aXRoaW4KaXRzZWxmLiBFdmVyeSB0aW1lIHRoZSBmZWUgcGVyaW9kIHJvbGxzIG92ZXIgaW4gdGhlIG1haW4gSGF2dmVuCmNvbnRyYWN0LCB0aGUgSGF2dmVuRXNjcm93IGZlZSBwb29sIGlzIHJlbWl0dGVkIGJhY2sgaW50byB0aGUgCm1haW4gZmVlIHBvb2wgdG8gYmUgcmVkaXN0cmlidXRlZCBpbiB0aGUgbmV4dCBmZWUgcGVyaW9kLgoKLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KCiovCgpjb250cmFjdCBIYXZ2ZW5Fc2Nyb3cgaXMgT3duZWQsIExpbWl0ZWRTZXR1cCg4IHdlZWtzKSwgU2FmZURlY2ltYWxNYXRoIHsgICAgCiAgICAvLyBUaGUgY29ycmVzcG9uZGluZyBIYXZ2ZW4gY29udHJhY3QuCiAgICBIYXZ2ZW4gcHVibGljIGhhdnZlbjsKCiAgICAvLyBMaXN0cyBvZiAodGltZXN0YW1wLCBxdWFudGl0eSkgcGFpcnMgcGVyIGFjY291bnQsIHNvcnRlZCBpbiBhc2NlbmRpbmcgdGltZSBvcmRlci4KICAgIC8vIFRoZXNlIGFyZSB0aGUgdGltZXMgYXQgd2hpY2ggZWFjaCBnaXZlbiBxdWFudGl0eSBvZiBoYXZ2ZW5zIHZlc3RzLgogICAgbWFwcGluZyhhZGRyZXNzID0+IHVpbnRbMl1bXSkgcHVibGljIHZlc3RpbmdTY2hlZHVsZXM7CgogICAgLy8gQW4gYWNjb3VudCdzIHRvdGFsIHZlc3RlZCBoYXZ2ZW4gYmFsYW5jZSB0byBzYXZlIHJlY29tcHV0aW5nIHRoaXMgZm9yIGZlZSBleHRyYWN0aW9uIHB1cnBvc2VzLgogICAgbWFwcGluZyhhZGRyZXNzID0+IHVpbnQpIHB1YmxpYyB0b3RhbFZlc3RlZEFjY291bnRCYWxhbmNlOwoKICAgIC8vIFRoZSB0b3RhbCByZW1haW5pbmcgdmVzdGVkIGJhbGFuY2UsIGZvciB2ZXJpZnlpbmcgdGhlIGFjdHVhbCBoYXZ2ZW4gYmFsYW5jZSBvZiB0aGlzIGNvbnRyYWN0IGFnYWluc3QuCiAgICB1aW50IHB1YmxpYyB0b3RhbFZlc3RlZEJhbGFuY2U7CgoKICAgIC8qID09PT09PT09PT0gQ09OU1RSVUNUT1IgPT09PT09PT09PSAqLwoKICAgIGZ1bmN0aW9uIEhhdnZlbkVzY3JvdyhhZGRyZXNzIF9vd25lciwgSGF2dmVuIF9oYXZ2ZW4pCiAgICAgICAgT3duZWQoX293bmVyKQogICAgICAgIHB1YmxpYwogICAgewogICAgICAgIGhhdnZlbiA9IF9oYXZ2ZW47CiAgICB9CgoKICAgIC8qID09PT09PT09PT0gU0VUVEVSUyA9PT09PT09PT09ICovCgogICAgZnVuY3Rpb24gc2V0SGF2dmVuKEhhdnZlbiBfaGF2dmVuKQogICAgICAgIGV4dGVybmFsCiAgICAgICAgb25seU93bmVyCiAgICB7CiAgICAgICAgaGF2dmVuID0gX2hhdnZlbjsKICAgICAgICBlbWl0IEhhdnZlblVwZGF0ZWQoX2hhdnZlbik7CiAgICB9CgoKICAgIC8qID09PT09PT09PT0gVklFVyBGVU5DVElPTlMgPT09PT09PT09PSAqLwoKICAgIC8qIEEgc2ltcGxlIGFsaWFzIHRvIHRvdGFsVmVzdGVkQWNjb3VudEJhbGFuY2U6IHByb3ZpZGVzIEVSQzIwIGJhbGFuY2UgaW50ZWdyYXRpb24uICovCiAgICBmdW5jdGlvbiBiYWxhbmNlT2YoYWRkcmVzcyBhY2NvdW50KQogICAgICAgIHB1YmxpYwogICAgICAgIHZpZXcKICAgICAgICByZXR1cm5zICh1aW50KQogICAgewogICAgICAgIHJldHVybiB0b3RhbFZlc3RlZEFjY291bnRCYWxhbmNlW2FjY291bnRdOwogICAgfQoKICAgIC8qIFRoZSBudW1iZXIgb2YgdmVzdGluZyBkYXRlcyBpbiBhbiBhY2NvdW50J3Mgc2NoZWR1bGUuICovCiAgICBmdW5jdGlvbiBudW1WZXN0aW5nRW50cmllcyhhZGRyZXNzIGFjY291bnQpCiAgICAgICAgcHVibGljCiAgICAgICAgdmlldwogICAgICAgIHJldHVybnMgKHVpbnQpCiAgICB7CiAgICAgICAgcmV0dXJuIHZlc3RpbmdTY2hlZHVsZXNbYWNjb3VudF0ubGVuZ3RoOwogICAgfQoKICAgIC8qIEdldCBhIHBhcnRpY3VsYXIgc2NoZWR1bGUgZW50cnkgZm9yIGFuIGFjY291bnQuCiAgICAgKiBUaGUgcmV0dXJuIHZhbHVlIGlzIGEgcGFpciAodGltZXN0YW1wLCBoYXZ2ZW4gcXVhbnRpdHkpICovCiAgICBmdW5jdGlvbiBnZXRWZXN0aW5nU2NoZWR1bGVFbnRyeShhZGRyZXNzIGFjY291bnQsIHVpbnQgaW5kZXgpCiAgICAgICAgcHVibGljCiAgICAgICAgdmlldwogICAgICAgIHJldHVybnMgKHVpbnRbMl0pCiAgICB7CiAgICAgICAgcmV0dXJuIHZlc3RpbmdTY2hlZHVsZXNbYWNjb3VudF1baW5kZXhdOwogICAgfQoKICAgIC8qIEdldCB0aGUgdGltZSBhdCB3aGljaCBhIGdpdmVuIHNjaGVkdWxlIGVudHJ5IHdpbGwgdmVzdC4gKi8KICAgIGZ1bmN0aW9uIGdldFZlc3RpbmdUaW1lKGFkZHJlc3MgYWNjb3VudCwgdWludCBpbmRleCkKICAgICAgICBwdWJsaWMKICAgICAgICB2aWV3CiAgICAgICAgcmV0dXJucyAodWludCkKICAgIHsKICAgICAgICByZXR1cm4gdmVzdGluZ1NjaGVkdWxlc1thY2NvdW50XVtpbmRleF1bMF07CiAgICB9CgogICAgLyogR2V0IHRoZSBxdWFudGl0eSBvZiBoYXZ2ZW5zIGFzc29jaWF0ZWQgd2l0aCBhIGdpdmVuIHNjaGVkdWxlIGVudHJ5LiAqLwogICAgZnVuY3Rpb24gZ2V0VmVzdGluZ1F1YW50aXR5KGFkZHJlc3MgYWNjb3VudCwgdWludCBpbmRleCkKICAgICAgICBwdWJsaWMKICAgICAgICB2aWV3CiAgICAgICAgcmV0dXJucyAodWludCkKICAgIHsKICAgICAgICByZXR1cm4gdmVzdGluZ1NjaGVkdWxlc1thY2NvdW50XVtpbmRleF1bMV07CiAgICB9CgogICAgLyogT2J0YWluIHRoZSBpbmRleCBvZiB0aGUgbmV4dCBzY2hlZHVsZSBlbnRyeSB0aGF0IHdpbGwgdmVzdCBmb3IgYSBnaXZlbiB1c2VyLiAqLwogICAgZnVuY3Rpb24gZ2V0TmV4dFZlc3RpbmdJbmRleChhZGRyZXNzIGFjY291bnQpCiAgICAgICAgcHVibGljCiAgICAgICAgdmlldwogICAgICAgIHJldHVybnMgKHVpbnQpCiAgICB7CiAgICAgICAgdWludCBsZW4gPSBudW1WZXN0aW5nRW50cmllcyhhY2NvdW50KTsKICAgICAgICBmb3IgKHVpbnQgaSA9IDA7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgICBpZiAoZ2V0VmVzdGluZ1RpbWUoYWNjb3VudCwgaSkgIT0gMCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGxlbjsKICAgIH0KCiAgICAvKiBPYnRhaW4gdGhlIG5leHQgc2NoZWR1bGUgZW50cnkgdGhhdCB3aWxsIHZlc3QgZm9yIGEgZ2l2ZW4gdXNlci4KICAgICAqIFRoZSByZXR1cm4gdmFsdWUgaXMgYSBwYWlyICh0aW1lc3RhbXAsIGhhdnZlbiBxdWFudGl0eSkgKi8KICAgIGZ1bmN0aW9uIGdldE5leHRWZXN0aW5nRW50cnkoYWRkcmVzcyBhY2NvdW50KQogICAgICAgIGV4dGVybmFsCiAgICAgICAgdmlldwogICAgICAgIHJldHVybnMgKHVpbnRbMl0pCiAgICB7CiAgICAgICAgdWludCBpbmRleCA9IGdldE5leHRWZXN0aW5nSW5kZXgoYWNjb3VudCk7CiAgICAgICAgaWYgKGluZGV4ID09IG51bVZlc3RpbmdFbnRyaWVzKGFjY291bnQpKSB7CiAgICAgICAgICAgIHJldHVybiBbdWludCgwKSwgMF07CiAgICAgICAgfQogICAgICAgIHJldHVybiBnZXRWZXN0aW5nU2NoZWR1bGVFbnRyeShhY2NvdW50LCBpbmRleCk7CiAgICB9CgogICAgLyogT2J0YWluIHRoZSB0aW1lIGF0IHdoaWNoIHRoZSBuZXh0IHNjaGVkdWxlIGVudHJ5IHdpbGwgdmVzdCBmb3IgYSBnaXZlbiB1c2VyLiAqLwogICAgZnVuY3Rpb24gZ2V0TmV4dFZlc3RpbmdUaW1lKGFkZHJlc3MgYWNjb3VudCkKICAgICAgICBleHRlcm5hbAogICAgICAgIHZpZXcKICAgICAgICByZXR1cm5zICh1aW50KQogICAgewogICAgICAgIHVpbnQgaW5kZXggPSBnZXROZXh0VmVzdGluZ0luZGV4KGFjY291bnQpOwogICAgICAgIGlmIChpbmRleCA9PSBudW1WZXN0aW5nRW50cmllcyhhY2NvdW50KSkgewogICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGdldFZlc3RpbmdUaW1lKGFjY291bnQsIGluZGV4KTsKICAgIH0KCiAgICAvKiBPYnRhaW4gdGhlIHF1YW50aXR5IHdoaWNoIHRoZSBuZXh0IHNjaGVkdWxlIGVudHJ5IHdpbGwgdmVzdCBmb3IgYSBnaXZlbiB1c2VyLiAqLwogICAgZnVuY3Rpb24gZ2V0TmV4dFZlc3RpbmdRdWFudGl0eShhZGRyZXNzIGFjY291bnQpCiAgICAgICAgZXh0ZXJuYWwKICAgICAgICB2aWV3CiAgICAgICAgcmV0dXJucyAodWludCkKICAgIHsKICAgICAgICB1aW50IGluZGV4ID0gZ2V0TmV4dFZlc3RpbmdJbmRleChhY2NvdW50KTsKICAgICAgICBpZiAoaW5kZXggPT0gbnVtVmVzdGluZ0VudHJpZXMoYWNjb3VudCkpIHsKICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgfQogICAgICAgIHJldHVybiBnZXRWZXN0aW5nUXVhbnRpdHkoYWNjb3VudCwgaW5kZXgpOwogICAgfQoKCiAgICAvKiA9PT09PT09PT09IE1VVEFUSVZFIEZVTkNUSU9OUyA9PT09PT09PT09ICovCgogICAgLyogV2l0aGRyYXdzIGEgcXVhbnRpdHkgb2YgaGF2dmVucyBiYWNrIHRvIHRoZSBoYXZ2ZW4gY29udHJhY3QuICovCiAgICBmdW5jdGlvbiB3aXRoZHJhd0hhdnZlbnModWludCBxdWFudGl0eSkKICAgICAgICBleHRlcm5hbAogICAgICAgIG9ubHlPd25lcgogICAgICAgIHNldHVwRnVuY3Rpb24KICAgIHsKICAgICAgICBoYXZ2ZW4udHJhbnNmZXIoaGF2dmVuLCBxdWFudGl0eSk7CiAgICB9CgogICAgLyogRGVzdHJveSB0aGUgdmVzdGluZyBpbmZvcm1hdGlvbiBhc3NvY2lhdGVkIHdpdGggYW4gYWNjb3VudC4gKi8KICAgIGZ1bmN0aW9uIHB1cmdlQWNjb3VudChhZGRyZXNzIGFjY291bnQpCiAgICAgICAgZXh0ZXJuYWwKICAgICAgICBvbmx5T3duZXIKICAgICAgICBzZXR1cEZ1bmN0aW9uCiAgICB7CiAgICAgICAgZGVsZXRlIHZlc3RpbmdTY2hlZHVsZXNbYWNjb3VudF07CiAgICAgICAgdG90YWxWZXN0ZWRCYWxhbmNlID0gc2FmZVN1Yih0b3RhbFZlc3RlZEJhbGFuY2UsIHRvdGFsVmVzdGVkQWNjb3VudEJhbGFuY2VbYWNjb3VudF0pOwogICAgICAgIGRlbGV0ZSB0b3RhbFZlc3RlZEFjY291bnRCYWxhbmNlW2FjY291bnRdOwogICAgfQoKICAgIC8qIEFkZCBhIG5ldyB2ZXN0aW5nIGVudHJ5IGF0IGEgZ2l2ZW4gdGltZSBhbmQgcXVhbnRpdHkgdG8gYW4gYWNjb3VudCdzIHNjaGVkdWxlLgogICAgICogQSBjYWxsIHRvIHRoaXMgc2hvdWxkIGJlIGFjY29tcGFuaWVkIGJ5IGVpdGhlciBlbm91Z2ggYmFsYW5jZSBhbHJlYWR5IGF2YWlsYWJsZQogICAgICogaW4gdGhpcyBjb250cmFjdCwgb3IgYSBjb3JyZXNwb25kaW5nIGNhbGwgdG8gaGF2dmVuLmVuZG93KCksIHRvIGVuc3VyZSB0aGF0IHdoZW4KICAgICAqIHRoZSBmdW5kcyBhcmUgd2l0aGRyYXduLCB0aGVyZSBpcyBlbm91Z2ggYmFsYW5jZSwgYXMgd2VsbCBhcyBjb3JyZWN0bHkgY2FsY3VsYXRpbmcKICAgICAqIHRoZSBmZWVzLgogICAgICogTm90ZTsgYWx0aG91Z2ggdGhpcyBmdW5jdGlvbiBjb3VsZCB0ZWNobmljYWxseSBiZSB1c2VkIHRvIHByb2R1Y2UgdW5ib3VuZGVkCiAgICAgKiBhcnJheXMsIGl0J3Mgb25seSBpbiB0aGUgZm91bmRhdGlvbidzIGNvbW1hbmQgdG8gYWRkIHRvIHRoZXNlIGxpc3RzLiAqLwogICAgZnVuY3Rpb24gYXBwZW5kVmVzdGluZ0VudHJ5KGFkZHJlc3MgYWNjb3VudCwgdWludCB0aW1lLCB1aW50IHF1YW50aXR5KQogICAgICAgIHB1YmxpYwogICAgICAgIG9ubHlPd25lcgogICAgICAgIHNldHVwRnVuY3Rpb24KICAgIHsKICAgICAgICAvLyBObyBlbXB0eSBvciBhbHJlYWR5LXBhc3NlZCB2ZXN0aW5nIGVudHJpZXMgYWxsb3dlZC4KICAgICAgICByZXF1aXJlKG5vdyA8IHRpbWUpOwogICAgICAgIHJlcXVpcmUocXVhbnRpdHkgIT0gMCk7CiAgICAgICAgdG90YWxWZXN0ZWRCYWxhbmNlID0gc2FmZUFkZCh0b3RhbFZlc3RlZEJhbGFuY2UsIHF1YW50aXR5KTsKICAgICAgICByZXF1aXJlKHRvdGFsVmVzdGVkQmFsYW5jZSA8PSBoYXZ2ZW4uYmFsYW5jZU9mKHRoaXMpKTsKCiAgICAgICAgaWYgKHZlc3RpbmdTY2hlZHVsZXNbYWNjb3VudF0ubGVuZ3RoID09IDApIHsKICAgICAgICAgICAgdG90YWxWZXN0ZWRBY2NvdW50QmFsYW5jZVthY2NvdW50XSA9IHF1YW50aXR5OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIERpc2FsbG93IGFkZGluZyBuZXcgdmVzdGVkIGhhdnZlbnMgZWFybGllciB0aGFuIHRoZSBsYXN0IG9uZS4KICAgICAgICAgICAgLy8gU2luY2UgZW50cmllcyBhcmUgb25seSBhcHBlbmRlZCwgdGhpcyBtZWFucyB0aGF0IG5vIHZlc3RpbmcgZGF0ZSBjYW4gYmUgcmVwZWF0ZWQuCiAgICAgICAgICAgIHJlcXVpcmUoZ2V0VmVzdGluZ1RpbWUoYWNjb3VudCwgbnVtVmVzdGluZ0VudHJpZXMoYWNjb3VudCkgLSAxKSA8IHRpbWUpOwogICAgICAgICAgICB0b3RhbFZlc3RlZEFjY291bnRCYWxhbmNlW2FjY291bnRdID0gc2FmZUFkZCh0b3RhbFZlc3RlZEFjY291bnRCYWxhbmNlW2FjY291bnRdLCBxdWFudGl0eSk7CiAgICAgICAgfQoKICAgICAgICB2ZXN0aW5nU2NoZWR1bGVzW2FjY291bnRdLnB1c2goW3RpbWUsIHF1YW50aXR5XSk7CiAgICB9CgogICAgLyogQ29uc3RydWN0IGEgdmVzdGluZyBzY2hlZHVsZSB0byByZWxlYXNlIGEgcXVhbnRpdGllcyBvZiBoYXZ2ZW5zCiAgICAgKiBvdmVyIGEgc2VyaWVzIG9mIGludGVydmFscy4gQXNzdW1lcyB0aGF0IHRoZSBxdWFudGl0aWVzIGFyZSBub256ZXJvCiAgICAgKiBhbmQgdGhhdCB0aGUgc2VxdWVuY2Ugb2YgdGltZXN0YW1wcyBpcyBzdHJpY3RseSBpbmNyZWFzaW5nLiAqLwogICAgZnVuY3Rpb24gYWRkVmVzdGluZ1NjaGVkdWxlKGFkZHJlc3MgYWNjb3VudCwgdWludFtdIHRpbWVzLCB1aW50W10gcXVhbnRpdGllcykKICAgICAgICBleHRlcm5hbAogICAgICAgIG9ubHlPd25lcgogICAgICAgIHNldHVwRnVuY3Rpb24KICAgIHsKICAgICAgICBmb3IgKHVpbnQgaSA9IDA7IGkgPCB0aW1lcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBhcHBlbmRWZXN0aW5nRW50cnkoYWNjb3VudCwgdGltZXNbaV0sIHF1YW50aXRpZXNbaV0pOwogICAgICAgIH0KCiAgICB9CgogICAgLyogQWxsb3cgYSB1c2VyIHRvIHdpdGhkcmF3IGFueSB0b2tlbnMgdGhhdCBoYXZlIHZlc3RlZC4gKi8KICAgIGZ1bmN0aW9uIHZlc3QoKSAKICAgICAgICBleHRlcm5hbAogICAgewogICAgICAgIHVpbnQgdG90YWw7CiAgICAgICAgZm9yICh1aW50IGkgPSAwOyBpIDwgbnVtVmVzdGluZ0VudHJpZXMobXNnLnNlbmRlcik7IGkrKykgewogICAgICAgICAgICB1aW50IHRpbWUgPSBnZXRWZXN0aW5nVGltZShtc2cuc2VuZGVyLCBpKTsKICAgICAgICAgICAgLy8gVGhlIGxpc3QgaXMgc29ydGVkOyB3aGVuIHdlIHJlYWNoIHRoZSBmaXJzdCBmdXR1cmUgdGltZSwgYmFpbCBvdXQuCiAgICAgICAgICAgIGlmICh0aW1lID4gbm93KSB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICB1aW50IHF0eSA9IGdldFZlc3RpbmdRdWFudGl0eShtc2cuc2VuZGVyLCBpKTsKICAgICAgICAgICAgaWYgKHF0eSA9PSAwKSB7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmVzdGluZ1NjaGVkdWxlc1ttc2cuc2VuZGVyXVtpXSA9IFswLCAwXTsKICAgICAgICAgICAgdG90YWwgPSBzYWZlQWRkKHRvdGFsLCBxdHkpOwogICAgICAgICAgICB0b3RhbFZlc3RlZEFjY291bnRCYWxhbmNlW21zZy5zZW5kZXJdID0gc2FmZVN1Yih0b3RhbFZlc3RlZEFjY291bnRCYWxhbmNlW21zZy5zZW5kZXJdLCBxdHkpOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRvdGFsICE9IDApIHsKICAgICAgICAgICAgdG90YWxWZXN0ZWRCYWxhbmNlID0gc2FmZVN1Yih0b3RhbFZlc3RlZEJhbGFuY2UsIHRvdGFsKTsKICAgICAgICAgICAgaGF2dmVuLnRyYW5zZmVyKG1zZy5zZW5kZXIsIHRvdGFsKTsKICAgICAgICAgICAgZW1pdCBWZXN0ZWQobXNnLnNlbmRlciwgbXNnLnNlbmRlciwKICAgICAgICAgICAgICAgICAgIG5vdywgdG90YWwpOwogICAgICAgIH0KICAgIH0KCgogICAgLyogPT09PT09PT09PSBFVkVOVFMgPT09PT09PT09PSAqLwoKICAgIGV2ZW50IEhhdnZlblVwZGF0ZWQoYWRkcmVzcyBuZXdIYXZ2ZW4pOwoKICAgIGV2ZW50IFZlc3RlZChhZGRyZXNzIGJlbmVmaWNpYXJ5LCBhZGRyZXNzIGluZGV4ZWQgYmVuZWZpY2lhcnlJbmRleCwgdWludCB0aW1lLCB1aW50IHZhbHVlKTsKfQoKLyoKLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KQ09OVFJBQ1QgREVTQ1JJUFRJT04KLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KClRoaXMgY29udHJhY3QgYWxsb3dzIGFuIGluaGVyaXRpbmcgY29udHJhY3QgdG8gYmUgZGVzdHJveWVkIGFmdGVyCml0cyBvd25lciBpbmRpY2F0ZXMgYW4gaW50ZW50aW9uIGFuZCB0aGVuIHdhaXRzIGZvciBhIHBlcmlvZAp3aXRob3V0IGNoYW5naW5nIHRoZWlyIG1pbmQuCgotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoqLwoKY29udHJhY3QgU2VsZkRlc3RydWN0aWJsZSBpcyBPd25lZCB7CgkKCXVpbnQgcHVibGljIGluaXRpYXRpb25UaW1lID0gfnVpbnQoMCk7Cgl1aW50IGNvbnN0YW50IFNEX0RVUkFUSU9OID0gMyBkYXlzOwoJYWRkcmVzcyBwdWJsaWMgYmVuZWZpY2lhcnk7CgoJZnVuY3Rpb24gU2VsZkRlc3RydWN0aWJsZShhZGRyZXNzIF9vd25lciwgYWRkcmVzcyBfYmVuZWZpY2lhcnkpCgkJcHVibGljCgkJT3duZWQoX293bmVyKQoJewoJCWJlbmVmaWNpYXJ5ID0gX2JlbmVmaWNpYXJ5OwoJfQoKCWZ1bmN0aW9uIHNldEJlbmVmaWNpYXJ5KGFkZHJlc3MgX2JlbmVmaWNpYXJ5KQoJCWV4dGVybmFsCgkJb25seU93bmVyCgl7CgkJYmVuZWZpY2lhcnkgPSBfYmVuZWZpY2lhcnk7CgkJZW1pdCBTZWxmRGVzdHJ1Y3RCZW5lZmljaWFyeVVwZGF0ZWQoX2JlbmVmaWNpYXJ5KTsKCX0KCglmdW5jdGlvbiBpbml0aWF0ZVNlbGZEZXN0cnVjdCgpCgkJZXh0ZXJuYWwKCQlvbmx5T3duZXIKCXsKCQlpbml0aWF0aW9uVGltZSA9IG5vdzsKCQllbWl0IFNlbGZEZXN0cnVjdEluaXRpYXRlZChTRF9EVVJBVElPTik7Cgl9CgoJZnVuY3Rpb24gdGVybWluYXRlU2VsZkRlc3RydWN0KCkKCQlleHRlcm5hbAoJCW9ubHlPd25lcgoJewoJCWluaXRpYXRpb25UaW1lID0gfnVpbnQoMCk7CgkJZW1pdCBTZWxmRGVzdHJ1Y3RUZXJtaW5hdGVkKCk7Cgl9CgoJZnVuY3Rpb24gc2VsZkRlc3RydWN0KCkKCQlleHRlcm5hbAoJCW9ubHlPd25lcgoJewoJCXJlcXVpcmUoaW5pdGlhdGlvblRpbWUgKyBTRF9EVVJBVElPTiA8IG5vdyk7CgkJZW1pdCBTZWxmRGVzdHJ1Y3RlZChiZW5lZmljaWFyeSk7CgkJc2VsZmRlc3RydWN0KGJlbmVmaWNpYXJ5KTsKCX0KCglldmVudCBTZWxmRGVzdHJ1Y3RCZW5lZmljaWFyeVVwZGF0ZWQoYWRkcmVzcyBuZXdCZW5lZmljaWFyeSk7CgoJZXZlbnQgU2VsZkRlc3RydWN0SW5pdGlhdGVkKHVpbnQgZHVyYXRpb24pOwoKCWV2ZW50IFNlbGZEZXN0cnVjdFRlcm1pbmF0ZWQoKTsKCglldmVudCBTZWxmRGVzdHJ1Y3RlZChhZGRyZXNzIGJlbmVmaWNpYXJ5KTsKfQoKLyoKLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KQ09OVFJBQ1QgREVTQ1JJUFRJT04KLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KCkhhdnZlbiB0b2tlbiBjb250cmFjdC4gSGF2dmVucyBhcmUgdHJhbnNmZXJhYmxlIEVSQzIwIHRva2VucywKYW5kIGFsc28gZ2l2ZSB0aGVpciBob2xkZXJzIHRoZSBmb2xsb3dpbmcgcHJpdmlsZWdlcy4KQW4gb3duZXIgb2YgaGF2dmVucyBpcyBlbnRpdGxlZCB0byBhIHNoYXJlIGluIHRoZSBmZWVzIGxldmllZCBvbgpub21pbiB0cmFuc2FjdGlvbnMsIGFuZCBhZGRpdGlvbmFsbHkgbWF5IHBhcnRpY2lwYXRlIGluIG5vbWluCmNvbmZpc2NhdGlvbiB2b3Rlcy4KCkFmdGVyIGEgZmVlIHBlcmlvZCB0ZXJtaW5hdGVzLCB0aGUgZHVyYXRpb24gYW5kIGZlZXMgY29sbGVjdGVkIGZvciB0aGF0CnBlcmlvZCBhcmUgY29tcHV0ZWQsIGFuZCB0aGUgbmV4dCBwZXJpb2QgYmVnaW5zLgpUaHVzIGFuIGFjY291bnQgbWF5IG9ubHkgd2l0aGRyYXcgdGhlIGZlZXMgb3dlZCB0byB0aGVtIGZvciB0aGUgcHJldmlvdXMKcGVyaW9kLCBhbmQgbWF5IG9ubHkgZG8gc28gb25jZSBwZXIgcGVyaW9kLgpBbnkgdW5jbGFpbWVkIGZlZXMgcm9sbCBvdmVyIGludG8gdGhlIGNvbW1vbiBwb3QgZm9yIHRoZSBuZXh0IHBlcmlvZC4KClRoZSBmZWUgZW50aXRsZW1lbnQgb2YgYSBoYXZ2ZW4gaG9sZGVyIGlzIHByb3BvcnRpb25hbCB0byB0aGVpciBhdmVyYWdlCmhhdnZlbiBiYWxhbmNlIG92ZXIgdGhlIGxhc3QgZmVlIHBlcmlvZC4gVGhpcyBpcyBjb21wdXRlZCBieSBtZWFzdXJpbmcgdGhlCmFyZWEgdW5kZXIgdGhlIGdyYXBoIG9mIGEgdXNlcidzIGJhbGFuY2Ugb3ZlciB0aW1lLCBhbmQgdGhlbiB3aGVuIGZlZXMgYXJlCmRpc3RyaWJ1dGVkLCBkaXZpZGluZyB0aHJvdWdoIGJ5IHRoZSBkdXJhdGlvbiBvZiB0aGUgZmVlIHBlcmlvZC4KCldlIG5lZWQgb25seSB1cGRhdGUgZmVlIGVudGl0bGVtZW50IG9uIHRyYW5zZmVyIHdoZW4gdGhlIGhhdnZlbiBiYWxhbmNlcyBvZiB0aGUgc2VuZGVyCmFuZCByZWNpcGllbnQgYXJlIG1vZGlmaWVkLiBUaGlzIGlzIGZvciBlZmZpY2llbmN5LCBhbmQgYWRkcyBhbiBpbXBsaWNpdCBmcmljdGlvbiB0bwp0cmFkaW5nIGluIHRoZSBoYXZ2ZW4gbWFya2V0LiBBIGhhdnZlbiBob2xkZXIgcGF5cyBmb3IgaGlzIG93biByZWNvbXB1dGF0aW9uIHdoZW5ldmVyCmhlIHdhbnRzIHRvIGNoYW5nZSBoaXMgcG9zaXRpb24sIHdoaWNoIHNhdmVzIHRoZSBmb3VuZGF0aW9uIGhhdmluZyB0byBtYWludGFpbiBhIHBvdApkZWRpY2F0ZWQgdG8gcmVzb3VyY2luZyB0aGlzLgoKQSBoeXBvdGhldGljYWwgdXNlcidzIGJhbGFuY2UgaGlzdG9yeSBvdmVyIG9uZSBmZWUgcGVyaW9kLCBwaWN0b3JpYWxseToKCiAgICAgIHMgX19fXwogICAgICAgfCAgICB8CiAgICAgICB8ICAgIHxfX18gcAogICAgICAgfF9fX198X19ffF9fXyBfXyBfICBfCiAgICAgICBmICAgIHQgICBuCgpIZXJlLCB0aGUgYmFsYW5jZSB3YXMgcyBiZXR3ZWVuIHRpbWVzIGYgYW5kIHQsIGF0IHdoaWNoIHRpbWUgYSB0cmFuc2ZlcgpvY2N1cnJlZCwgdXBkYXRpbmcgdGhlIGJhbGFuY2UgdG8gcCwgdW50aWwgbiwgd2hlbiB0aGUgcHJlc2VudCB0cmFuc2ZlciBvY2N1cnMuCldoZW4gYSBuZXcgdHJhbnNmZXIgb2NjdXJzIGF0IHRpbWUgbiwgdGhlIGJhbGFuY2UgYmVpbmcgcCwKd2UgbXVzdDoKCiAgLSBBZGQgdGhlIGFyZWEgcCAqIChuIC0gdCkgdG8gdGhlIHRvdGFsIGFyZWEgcmVjb3JkZWQgc28gZmFyCiAgLSBVcGRhdGUgdGhlIGxhc3QgdHJhbnNmZXIgdGltZSB0byBwCgpTbyBpZiB0aGlzIGdyYXBoIHJlcHJlc2VudHMgdGhlIGVudGlyZSBjdXJyZW50IGZlZSBwZXJpb2QsCnRoZSBhdmVyYWdlIGhhdnZlbnMgaGVsZCBzbyBmYXIgaXMgKCh0LWYpKnMgKyAobi10KSpwKSAvIChuLWYpLgpUaGUgY29tcGxlbWVudGFyeSBjb21wdXRhdGlvbnMgbXVzdCBiZSBwZXJmb3JtZWQgZm9yIGJvdGggc2VuZGVyIGFuZApyZWNpcGllbnQuCgpOb3RlIHRoYXQgYSB0cmFuc2ZlciBrZWVwcyBnbG9iYWwgc3VwcGx5IG9mIGhhdnZlbnMgaW52YXJpYW50LgpUaGUgc3VtIG9mIGFsbCBiYWxhbmNlcyBpcyBjb25zdGFudCwgYW5kIHVubW9kaWZpZWQgYnkgYW55IHRyYW5zZmVyLgpTbyB0aGUgc3VtIG9mIGFsbCBiYWxhbmNlcyBtdWx0aXBsaWVkIGJ5IHRoZSBkdXJhdGlvbiBvZiBhIGZlZSBwZXJpb2QgaXMgYWxzbwpjb25zdGFudCwgYW5kIHRoaXMgaXMgZXF1aXZhbGVudCB0byB0aGUgc3VtIG9mIHRoZSBhcmVhIG9mIGV2ZXJ5IHVzZXIncwp0aW1lL2JhbGFuY2UgZ3JhcGguIERpdmlkaW5nIHRocm91Z2ggYnkgdGhhdCBkdXJhdGlvbiB5aWVsZHMgYmFjayB0aGUgdG90YWwKaGF2dmVuIHN1cHBseS4gU28sIGF0IHRoZSBlbmQgb2YgYSBmZWUgcGVyaW9kLCB3ZSByZWFsbHkgZG8geWllbGQgYSB1c2VyJ3MKYXZlcmFnZSBzaGFyZSBpbiB0aGUgaGF2dmVuIHN1cHBseSBvdmVyIHRoYXQgcGVyaW9kLgoKQSBzbGlnaHQgd3JpbmtsZSBpcyBpbnRyb2R1Y2VkIGlmIHdlIGNvbnNpZGVyIHRoZSB0aW1lIHIgd2hlbiB0aGUgZmVlIHBlcmlvZApyb2xscyBvdmVyLiBUaGVuIHRoZSBwcmV2aW91cyBmZWUgcGVyaW9kIGstMSBpcyBiZWZvcmUgciwgYW5kIHRoZSBjdXJyZW50IGZlZQpwZXJpb2QgayBpcyBhZnRlcndhcmRzLiBJZiB0aGUgbGFzdCB0cmFuc2ZlciB0b29rIHBsYWNlIGJlZm9yZSByLApidXQgdGhlIGxhdGVzdCB0cmFuc2ZlciBvY2N1cnJlZCBhZnRlcndhcmRzOgoKay0xICAgICAgIHwgICAgICAgIGsKICAgICAgcyBfX3xfCiAgICAgICB8ICB8IHwKICAgICAgIHwgIHwgfF9fX18gcAogICAgICAgfF9ffF98X19fX3xfX18gX18gXyAgXwogICAgICAgICAgfAogICAgICAgZiAgfCB0ICAgIG4KICAgICAgICAgIHIKCkluIHRoaXMgc2l0dWF0aW9uIHRoZSBhcmVhIChyLWYpKnMgY29udHJpYnV0ZXMgdG8gZmVlIHBlcmlvZCBrLTEsIHdoaWxlCnRoZSBhcmVhICh0LXIpKnMgY29udHJpYnV0ZXMgdG8gZmVlIHBlcmlvZCBrLiBXZSB3aWxsIGltcGxpY2l0bHkgY29uc2lkZXIgYQp6ZXJvLXZhbHVlIHRyYW5zZmVyIHRvIGhhdmUgb2NjdXJyZWQgYXQgdGltZSByLiBUaGVpciBmZWUgZW50aXRsZW1lbnQgZm9yIHRoZQpwcmV2aW91cyBwZXJpb2Qgd2lsbCBiZSBmaW5hbGlzZWQgYXQgdGhlIHRpbWUgb2YgdGhlaXIgZmlyc3QgdHJhbnNmZXIgZHVyaW5nIHRoZQpjdXJyZW50IGZlZSBwZXJpb2QsIG9yIHdoZW4gdGhleSBxdWVyeSBvciB3aXRoZHJhdyB0aGVpciBmZWUgZW50aXRsZW1lbnQuCgpJbiB0aGUgaW1wbGVtZW50YXRpb24sIHRoZSBkdXJhdGlvbiBvZiBkaWZmZXJlbnQgZmVlIHBlcmlvZHMgbWF5IGJlIHNsaWdodGx5IGlycmVndWxhciwKYXMgdGhlIGNoZWNrIHRoYXQgdGhleSBoYXZlIHJvbGxlZCBvdmVyIG9jY3VycyBvbmx5IHdoZW4gc3RhdGUtY2hhbmdpbmcgaGF2dmVuCm9wZXJhdGlvbnMgYXJlIHBlcmZvcm1lZC4KCkFkZGl0aW9uYWxseSwgd2Uga2VlcCB0cmFjayBhbHNvIG9mIHRoZSBwZW51bHRpbWF0ZSBhbmQgbm90IGp1c3QgdGhlIGxhc3QKYXZlcmFnZSBiYWxhbmNlLCBpbiBvcmRlciB0byBzdXBwb3J0IHRoZSB2b3RpbmcgZnVuY3Rpb25hbGl0eSBkZXRhaWxlZCBpbiBDb3VydC5zb2wuCgotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoKKi8KCmNvbnRyYWN0IEhhdnZlbiBpcyBFeHRlcm5TdGF0ZVByb3h5VG9rZW4sIFNlbGZEZXN0cnVjdGlibGUgewoKICAgIC8qID09PT09PT09PT0gU1RBVEUgVkFSSUFCTEVTID09PT09PT09PT0gKi8KCiAgICAvLyBTdW1zIG9mIGJhbGFuY2VzKmR1cmF0aW9uIGluIHRoZSBjdXJyZW50IGZlZSBwZXJpb2QuCiAgICAvLyByYW5nZTogZGVjaW1hbHM7IHVuaXRzOiBoYXZ2ZW4tc2Vjb25kcwogICAgbWFwcGluZyhhZGRyZXNzID0+IHVpbnQpIHB1YmxpYyBjdXJyZW50QmFsYW5jZVN1bTsKCiAgICAvLyBBdmVyYWdlIGFjY291bnQgYmFsYW5jZXMgaW4gdGhlIGxhc3QgY29tcGxldGVkIGZlZSBwZXJpb2QuIFRoaXMgaXMgcHJvcG9ydGlvbmFsCiAgICAvLyB0byB0aGF0IGFjY291bnQncyBsYXN0IHBlcmlvZCBmZWUgZW50aXRsZW1lbnQuCiAgICAvLyAoaS5lLiBjdXJyZW50QmFsYW5jZVN1bSBmb3IgdGhlIHByZXZpb3VzIHBlcmlvZCBkaXZpZGVkIHRocm91Z2ggYnkgZHVyYXRpb24pCiAgICAvLyBXQVJOSU5HOiBUaGlzIG1heSBub3QgaGF2ZSBiZWVuIHVwZGF0ZWQgZm9yIHRoZSBsYXRlc3QgZmVlIHBlcmlvZCBhdCB0aGUKICAgIC8vICAgICAgICAgIHRpbWUgaXQgaXMgcXVlcmllZC4KICAgIC8vIHJhbmdlOiBkZWNpbWFsczsgdW5pdHM6IGhhdnZlbnMKICAgIG1hcHBpbmcoYWRkcmVzcyA9PiB1aW50KSBwdWJsaWMgbGFzdEF2ZXJhZ2VCYWxhbmNlOwoKICAgIC8vIFRoZSBhdmVyYWdlIGFjY291bnQgYmFsYW5jZXMgaW4gdGhlIHBlcmlvZCBiZWZvcmUgdGhlIGxhc3QgY29tcGxldGVkIGZlZSBwZXJpb2QuCiAgICAvLyBUaGlzIGlzIHVzZWQgYXMgYSBwZXJzb24ncyB3ZWlnaHQgaW4gYSBjb25maXNjYXRpb24gdm90ZSwgc28gaXQgaW1wbGllcyB0aGF0CiAgICAvLyB0aGUgdm90ZSBkdXJhdGlvbiBtdXN0IGJlIG5vIGxvbmdlciB0aGFuIHRoZSBmZWUgcGVyaW9kIGluIG9yZGVyIHRvIGd1YXJhbnRlZSB0aGF0IAogICAgLy8gbm8gcG9ydGlvbiBvZiBhIGZlZSBwZXJpb2QgdXNlZCBmb3IgZGV0ZXJtaW5pbmcgdm90ZSB3ZWlnaHRzIGZhbGxzIHdpdGhpbiB0aGUKICAgIC8vIGR1cmF0aW9uIG9mIGEgdm90ZSBpdCBjb250cmlidXRlcyB0by4KICAgIC8vIFdBUk5JTkc6IFRoaXMgbWF5IG5vdCBoYXZlIGJlZW4gdXBkYXRlZCBmb3IgdGhlIGxhdGVzdCBmZWUgcGVyaW9kIGF0IHRoZQogICAgLy8gICAgICAgICAgdGltZSBpdCBpcyBxdWVyaWVkLgogICAgbWFwcGluZyhhZGRyZXNzID0+IHVpbnQpIHB1YmxpYyBwZW51bHRpbWF0ZUF2ZXJhZ2VCYWxhbmNlOwoKICAgIC8vIFRoZSB0aW1lIGFuIGFjY291bnQgbGFzdCBtYWRlIGEgdHJhbnNmZXIuCiAgICAvLyByYW5nZTogbmF0dXJhbHMKICAgIG1hcHBpbmcoYWRkcmVzcyA9PiB1aW50KSBwdWJsaWMgbGFzdFRyYW5zZmVyVGltZXN0YW1wOwoKICAgIC8vIFRoZSB0aW1lIHRoZSBjdXJyZW50IGZlZSBwZXJpb2QgYmVnYW4uCiAgICB1aW50IHB1YmxpYyBmZWVQZXJpb2RTdGFydFRpbWUgPSAzOwogICAgLy8gVGhlIGFjdHVhbCBzdGFydCBvZiB0aGUgbGFzdCBmZWUgcGVyaW9kIChzZWNvbmRzKS4KICAgIC8vIFRoaXMsIGFuZCB0aGUgcGVudWx0aW1hdGUgZmVlIHBlcmlvZCBjYW4gYmUgaW5pdGlhbGx5IHNldCB0byBhbnkgdmFsdWUKICAgIC8vICAgMCA8IHZhbCA8IG5vdywgYXMgZXZlcnlvbmUncyBpbmRpdmlkdWFsIGxhc3RUcmFuc2ZlclRpbWUgd2lsbCBiZSAwCiAgICAvLyAgIGFuZCBhcyBzdWNoLCB0aGVpciBsYXN0QXZnQmFsL3BlbnVsdGltYXRlQXZnQmFsIHdpbGwgYmUgc2V0IHRvIHRoYXQgdmFsdWUKICAgIC8vICAgYXBhcnQgZnJvbSB0aGUgY29udHJhY3QsIHdoaWNoIHdpbGwgaGF2ZSB0b3RhbFN1cHBseQogICAgdWludCBwdWJsaWMgbGFzdEZlZVBlcmlvZFN0YXJ0VGltZSA9IDI7CiAgICAvLyBUaGUgYWN0dWFsIHN0YXJ0IG9mIHRoZSBwZW51bHRpbWF0ZSBmZWUgcGVyaW9kIChzZWNvbmRzKS4KICAgIHVpbnQgcHVibGljIHBlbnVsdGltYXRlRmVlUGVyaW9kU3RhcnRUaW1lID0gMTsKCiAgICAvLyBGZWUgcGVyaW9kcyB3aWxsIHJvbGwgb3ZlciBpbiBubyBzaG9ydGVyIGEgdGltZSB0aGFuIHRoaXMuCiAgICB1aW50IHB1YmxpYyB0YXJnZXRGZWVQZXJpb2REdXJhdGlvblNlY29uZHMgPSA0IHdlZWtzOwogICAgLy8gQW5kIG1heSBub3QgYmUgc2V0IHRvIGJlIHNob3J0ZXIgdGhhbiBhIGRheS4KICAgIHVpbnQgY29uc3RhbnQgTUlOX0ZFRV9QRVJJT0RfRFVSQVRJT05fU0VDT05EUyA9IDEgZGF5czsKICAgIC8vIEFuZCBtYXkgbm90IGJlIHNldCB0byBiZSBsb25nZXIgdGhhbiBzaXggbW9udGhzLgogICAgdWludCBjb25zdGFudCBNQVhfRkVFX1BFUklPRF9EVVJBVElPTl9TRUNPTkRTID0gMjYgd2Vla3M7CgogICAgLy8gVGhlIHF1YW50aXR5IG9mIG5vbWlucyB0aGF0IHdlcmUgaW4gdGhlIGZlZSBwb3QgYXQgdGhlIHRpbWUKICAgIC8vIG9mIHRoZSBsYXN0IGZlZSByb2xsb3ZlciAoZmVlUGVyaW9kU3RhcnRUaW1lKS4KICAgIHVpbnQgcHVibGljIGxhc3RGZWVzQ29sbGVjdGVkOwoKICAgIG1hcHBpbmcoYWRkcmVzcyA9PiBib29sKSBwdWJsaWMgaGFzV2l0aGRyYXduTGFzdFBlcmlvZEZlZXM7CgogICAgRXRoZXJOb21pbiBwdWJsaWMgbm9taW47CiAgICBIYXZ2ZW5Fc2Nyb3cgcHVibGljIGVzY3JvdzsKCgogICAgLyogPT09PT09PT09PSBDT05TVFJVQ1RPUiA9PT09PT09PT09ICovCgogICAgZnVuY3Rpb24gSGF2dmVuKFRva2VuU3RhdGUgaW5pdGlhbFN0YXRlLCBhZGRyZXNzIF9vd25lcikKICAgICAgICBFeHRlcm5TdGF0ZVByb3h5VG9rZW4oIkhhdnZlbiIsICJIQVYiLCAxZTggKiBVTklULCBhZGRyZXNzKHRoaXMpLCBpbml0aWFsU3RhdGUsIF9vd25lcikKICAgICAgICBTZWxmRGVzdHJ1Y3RpYmxlKF9vd25lciwgX293bmVyKQogICAgICAgIC8vIE93bmVkIGlzIGluaXRpYWxpc2VkIGluIEV4dGVyblN0YXRlUHJveHlUb2tlbgogICAgICAgIHB1YmxpYwogICAgewogICAgICAgIGxhc3RUcmFuc2ZlclRpbWVzdGFtcFt0aGlzXSA9IG5vdzsKICAgICAgICBmZWVQZXJpb2RTdGFydFRpbWUgPSBub3c7CiAgICAgICAgbGFzdEZlZVBlcmlvZFN0YXJ0VGltZSA9IG5vdyAtIHRhcmdldEZlZVBlcmlvZER1cmF0aW9uU2Vjb25kczsKICAgICAgICBwZW51bHRpbWF0ZUZlZVBlcmlvZFN0YXJ0VGltZSA9IG5vdyAtIDIqdGFyZ2V0RmVlUGVyaW9kRHVyYXRpb25TZWNvbmRzOwogICAgfQoKCiAgICAvKiA9PT09PT09PT09IFNFVFRFUlMgPT09PT09PT09PSAqLwoKICAgIGZ1bmN0aW9uIHNldE5vbWluKEV0aGVyTm9taW4gX25vbWluKSAKICAgICAgICBleHRlcm5hbAogICAgICAgIG9wdGlvbmFsUHJveHlfb25seU93bmVyCiAgICB7CiAgICAgICAgbm9taW4gPSBfbm9taW47CiAgICB9CgogICAgZnVuY3Rpb24gc2V0RXNjcm93KEhhdnZlbkVzY3JvdyBfZXNjcm93KQogICAgICAgIGV4dGVybmFsCiAgICAgICAgb3B0aW9uYWxQcm94eV9vbmx5T3duZXIKICAgIHsKICAgICAgICBlc2Nyb3cgPSBfZXNjcm93OwogICAgfQoKICAgIGZ1bmN0aW9uIHNldFRhcmdldEZlZVBlcmlvZER1cmF0aW9uKHVpbnQgZHVyYXRpb24pCiAgICAgICAgZXh0ZXJuYWwKICAgICAgICBwb3N0Q2hlY2tGZWVQZXJpb2RSb2xsb3ZlcgogICAgICAgIG9wdGlvbmFsUHJveHlfb25seU93bmVyCiAgICB7CiAgICAgICAgcmVxdWlyZShNSU5fRkVFX1BFUklPRF9EVVJBVElPTl9TRUNPTkRTIDw9IGR1cmF0aW9uICYmCiAgICAgICAgICAgICAgICBkdXJhdGlvbiA8PSBNQVhfRkVFX1BFUklPRF9EVVJBVElPTl9TRUNPTkRTKTsKICAgICAgICB0YXJnZXRGZWVQZXJpb2REdXJhdGlvblNlY29uZHMgPSBkdXJhdGlvbjsKICAgICAgICBlbWl0IEZlZVBlcmlvZER1cmF0aW9uVXBkYXRlZChkdXJhdGlvbik7CiAgICB9CgoKICAgIC8qID09PT09PT09PT0gTVVUQVRJVkUgRlVOQ1RJT05TID09PT09PT09PT0gKi8KCiAgICAvKiBBbGxvdyB0aGUgb3duZXIgb2YgdGhpcyBjb250cmFjdCB0byBlbmRvdyBhbnkgYWRkcmVzcyB3aXRoIGhhdnZlbnMKICAgICAqIGZyb20gdGhlIGluaXRpYWwgc3VwcGx5LiBTaW5jZSB0aGUgZW50aXJlIGluaXRpYWwgc3VwcGx5IHJlc2lkZXMKICAgICAqIGluIHRoZSBoYXZ2ZW4gY29udHJhY3QsIHRoaXMgZGlzYWxsb3dzIHRoZSBmb3VuZGF0aW9uIGZyb20gd2l0aGRyYXdpbmcKICAgICAqIGZlZXMgb24gdW5kaXN0cmlidXRlZCBiYWxhbmNlcy4gVGhpcyBmdW5jdGlvbiBjYW4gYWxzbyBiZSB1c2VkCiAgICAgKiB0byByZXRyaWV2ZSBhbnkgaGF2dmVucyBzZW50IHRvIHRoZSBIYXZ2ZW4gY29udHJhY3QgaXRzZWxmLiAqLwogICAgZnVuY3Rpb24gZW5kb3coYWRkcmVzcyBhY2NvdW50LCB1aW50IHZhbHVlKQogICAgICAgIGV4dGVybmFsCiAgICAgICAgb3B0aW9uYWxQcm94eV9vbmx5T3duZXIKICAgICAgICByZXR1cm5zIChib29sKQogICAgewoKICAgICAgICAvLyBVc2UgInRoaXMiIGluIG9yZGVyIHRoYXQgdGhlIGhhdnZlbiBhY2NvdW50IGlzIHRoZSBzZW5kZXIuCiAgICAgICAgLy8gVGhhdCB0aGlzIGlzIGFuIGV4cGxpY2l0IHRyYW5zZmVyIGFsc28gaW5pdGlhbGlzZXMgZmVlIGVudGl0bGVtZW50IGluZm9ybWF0aW9uLgogICAgICAgIHJldHVybiBfdHJhbnNmZXIodGhpcywgYWNjb3VudCwgdmFsdWUpOwogICAgfQoKICAgIC8qIEFsbG93IHRoZSBvd25lciBvZiB0aGlzIGNvbnRyYWN0IHRvIGVtaXQgdHJhbnNmZXIgZXZlbnRzIGZvcgogICAgICogY29udHJhY3Qgc2V0dXAgcHVycG9zZXMuICovCiAgICBmdW5jdGlvbiBlbWl0VHJhbnNmZXJFdmVudHMoYWRkcmVzcyBzZW5kZXIsIGFkZHJlc3NbXSByZWNpcGllbnRzLCB1aW50W10gdmFsdWVzKQogICAgICAgIGV4dGVybmFsCiAgICAgICAgb25seU93bmVyCiAgICB7CiAgICAgICAgZm9yICh1aW50IGkgPSAwOyBpIDwgcmVjaXBpZW50cy5sZW5ndGg7ICsraSkgewogICAgICAgICAgICBlbWl0IFRyYW5zZmVyKHNlbmRlciwgcmVjaXBpZW50c1tpXSwgdmFsdWVzW2ldKTsKICAgICAgICB9CiAgICB9CgogICAgLyogT3ZlcnJpZGUgRVJDMjAgdHJhbnNmZXIgZnVuY3Rpb24gaW4gb3JkZXIgdG8gcGVyZm9ybQogICAgICogZmVlIGVudGl0bGVtZW50IHJlY29tcHV0YXRpb24gd2hlbmV2ZXIgYmFsYW5jZXMgYXJlIHVwZGF0ZWQuICovCiAgICBmdW5jdGlvbiB0cmFuc2ZlcihhZGRyZXNzIHRvLCB1aW50IHZhbHVlKQogICAgICAgIGV4dGVybmFsCiAgICAgICAgb3B0aW9uYWxQcm94eQogICAgICAgIHJldHVybnMgKGJvb2wpCiAgICB7CiAgICAgICAgcmV0dXJuIF90cmFuc2ZlcihtZXNzYWdlU2VuZGVyLCB0bywgdmFsdWUpOwogICAgfQoKICAgIC8qIEFueXRoaW5nIGNhbGxpbmcgdGhpcyBtdXN0IGFwcGx5IHRoZSBvcHRpb25hbFByb3h5IG9yIG9ubHlQcm94eSBtb2RpZmllci4gKi8KICAgIGZ1bmN0aW9uIF90cmFuc2ZlcihhZGRyZXNzIHNlbmRlciwgYWRkcmVzcyB0bywgdWludCB2YWx1ZSkKICAgICAgICBpbnRlcm5hbAogICAgICAgIHByZUNoZWNrRmVlUGVyaW9kUm9sbG92ZXIKICAgICAgICByZXR1cm5zIChib29sKQogICAgewoKICAgICAgICB1aW50IHNlbmRlclByZUJhbGFuY2UgPSBzdGF0ZS5iYWxhbmNlT2Yoc2VuZGVyKTsKICAgICAgICB1aW50IHJlY2lwaWVudFByZUJhbGFuY2UgPSBzdGF0ZS5iYWxhbmNlT2YodG8pOwoKICAgICAgICAvLyBQZXJmb3JtIHRoZSB0cmFuc2ZlcjogaWYgdGhlcmUgaXMgYSBwcm9ibGVtLAogICAgICAgIC8vIGFuIGV4Y2VwdGlvbiB3aWxsIGJlIHRocm93biBpbiB0aGlzIGNhbGwuCiAgICAgICAgX3RyYW5zZmVyX2J5UHJveHkoc2VuZGVyLCB0bywgdmFsdWUpOwoKICAgICAgICAvLyBaZXJvLXZhbHVlIHRyYW5zZmVycyBzdGlsbCB1cGRhdGUgZmVlIGVudGl0bGVtZW50IGluZm9ybWF0aW9uLAogICAgICAgIC8vIGFuZCBtYXkgcm9sbCBvdmVyIHRoZSBmZWUgcGVyaW9kLgogICAgICAgIGFkanVzdEZlZUVudGl0bGVtZW50KHNlbmRlciwgc2VuZGVyUHJlQmFsYW5jZSk7CiAgICAgICAgYWRqdXN0RmVlRW50aXRsZW1lbnQodG8sIHJlY2lwaWVudFByZUJhbGFuY2UpOwoKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICAvKiBPdmVycmlkZSBFUkMyMCB0cmFuc2ZlckZyb20gZnVuY3Rpb24gaW4gb3JkZXIgdG8gcGVyZm9ybQogICAgICogZmVlIGVudGl0bGVtZW50IHJlY29tcHV0YXRpb24gd2hlbmV2ZXIgYmFsYW5jZXMgYXJlIHVwZGF0ZWQuICovCiAgICBmdW5jdGlvbiB0cmFuc2ZlckZyb20oYWRkcmVzcyBmcm9tLCBhZGRyZXNzIHRvLCB1aW50IHZhbHVlKQogICAgICAgIGV4dGVybmFsCiAgICAgICAgcHJlQ2hlY2tGZWVQZXJpb2RSb2xsb3ZlcgogICAgICAgIG9wdGlvbmFsUHJveHkKICAgICAgICByZXR1cm5zIChib29sKQogICAgewogICAgICAgIHVpbnQgc2VuZGVyUHJlQmFsYW5jZSA9IHN0YXRlLmJhbGFuY2VPZihmcm9tKTsKICAgICAgICB1aW50IHJlY2lwaWVudFByZUJhbGFuY2UgPSBzdGF0ZS5iYWxhbmNlT2YodG8pOwoKICAgICAgICAvLyBQZXJmb3JtIHRoZSB0cmFuc2ZlcjogaWYgdGhlcmUgaXMgYSBwcm9ibGVtLAogICAgICAgIC8vIGFuIGV4Y2VwdGlvbiB3aWxsIGJlIHRocm93biBpbiB0aGlzIGNhbGwuCiAgICAgICAgX3RyYW5zZmVyRnJvbV9ieVByb3h5KG1lc3NhZ2VTZW5kZXIsIGZyb20sIHRvLCB2YWx1ZSk7CgogICAgICAgIC8vIFplcm8tdmFsdWUgdHJhbnNmZXJzIHN0aWxsIHVwZGF0ZSBmZWUgZW50aXRsZW1lbnQgaW5mb3JtYXRpb24sCiAgICAgICAgLy8gYW5kIG1heSByb2xsIG92ZXIgdGhlIGZlZSBwZXJpb2QuCiAgICAgICAgYWRqdXN0RmVlRW50aXRsZW1lbnQoZnJvbSwgc2VuZGVyUHJlQmFsYW5jZSk7CiAgICAgICAgYWRqdXN0RmVlRW50aXRsZW1lbnQodG8sIHJlY2lwaWVudFByZUJhbGFuY2UpOwoKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICAvKiBDb21wdXRlIHRoZSBsYXN0IHBlcmlvZCdzIGZlZSBlbnRpdGxlbWVudCBmb3IgdGhlIG1lc3NhZ2Ugc2VuZGVyCiAgICAgKiBhbmQgdGhlbiBkZXBvc2l0IGl0IGludG8gdGhlaXIgbm9taW4gYWNjb3VudC4gKi8KICAgIGZ1bmN0aW9uIHdpdGhkcmF3RmVlRW50aXRsZW1lbnQoKQogICAgICAgIHB1YmxpYwogICAgICAgIHByZUNoZWNrRmVlUGVyaW9kUm9sbG92ZXIKICAgICAgICBvcHRpb25hbFByb3h5CiAgICB7CiAgICAgICAgYWRkcmVzcyBzZW5kZXIgPSBtZXNzYWdlU2VuZGVyOwoKICAgICAgICAvLyBEbyBub3QgZGVwb3NpdCBmZWVzIGludG8gZnJvemVuIGFjY291bnRzLgogICAgICAgIHJlcXVpcmUoIW5vbWluLmZyb3plbihzZW5kZXIpKTsKCiAgICAgICAgLy8gY2hlY2sgdGhlIHBlcmlvZCBoYXMgcm9sbGVkIG92ZXIgZmlyc3QKICAgICAgICByb2xsb3ZlckZlZShzZW5kZXIsIGxhc3RUcmFuc2ZlclRpbWVzdGFtcFtzZW5kZXJdLCBzdGF0ZS5iYWxhbmNlT2Yoc2VuZGVyKSk7CgogICAgICAgIC8vIE9ubHkgYWxsb3cgYWNjb3VudHMgdG8gd2l0aGRyYXcgZmVlcyBvbmNlIHBlciBwZXJpb2QuCiAgICAgICAgcmVxdWlyZSghaGFzV2l0aGRyYXduTGFzdFBlcmlvZEZlZXNbc2VuZGVyXSk7CgogICAgICAgIHVpbnQgZmVlc093ZWQ7CgogICAgICAgIGlmIChlc2Nyb3cgIT0gSGF2dmVuRXNjcm93KDApKSB7CiAgICAgICAgICAgIGZlZXNPd2VkID0gZXNjcm93LnRvdGFsVmVzdGVkQWNjb3VudEJhbGFuY2Uoc2VuZGVyKTsKICAgICAgICB9CgogICAgICAgIGZlZXNPd2VkID0gc2FmZURpdl9kZWMoc2FmZU11bF9kZWMoc2FmZUFkZChmZWVzT3dlZCwgbGFzdEF2ZXJhZ2VCYWxhbmNlW3NlbmRlcl0pLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdEZlZXNDb2xsZWN0ZWQpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG90YWxTdXBwbHkpOwoKICAgICAgICBoYXNXaXRoZHJhd25MYXN0UGVyaW9kRmVlc1tzZW5kZXJdID0gdHJ1ZTsKICAgICAgICBpZiAoZmVlc093ZWQgIT0gMCkgewogICAgICAgICAgICBub21pbi53aXRoZHJhd0ZlZShzZW5kZXIsIGZlZXNPd2VkKTsKICAgICAgICAgICAgZW1pdCBGZWVzV2l0aGRyYXduKHNlbmRlciwgc2VuZGVyLCBmZWVzT3dlZCk7CiAgICAgICAgfQogICAgfQoKICAgIC8qIFVwZGF0ZSB0aGUgZmVlIGVudGl0bGVtZW50IHNpbmNlIHRoZSBsYXN0IHRyYW5zZmVyIG9yIGVudGl0bGVtZW50CiAgICAgKiBhZGp1c3RtZW50LiBTaW5jZSB0aGlzIHVwZGF0ZXMgdGhlIGxhc3QgdHJhbnNmZXIgdGltZXN0YW1wLCBpZiBpbnZva2VkCiAgICAgKiBjb25zZWN1dGl2ZWx5LCB0aGlzIGZ1bmN0aW9uIHdpbGwgZG8gbm90aGluZyBhZnRlciB0aGUgZmlyc3QgY2FsbC4gKi8KICAgIGZ1bmN0aW9uIGFkanVzdEZlZUVudGl0bGVtZW50KGFkZHJlc3MgYWNjb3VudCwgdWludCBwcmVCYWxhbmNlKQogICAgICAgIGludGVybmFsCiAgICB7CiAgICAgICAgLy8gVGhlIHRpbWUgc2luY2UgdGhlIGxhc3QgdHJhbnNmZXIgY2xhbXBzIGF0IHRoZSBsYXN0IGZlZSByb2xsb3ZlciB0aW1lIGlmIHRoZSBsYXN0IHRyYW5zZmVyCiAgICAgICAgLy8gd2FzIGVhcmxpZXIgdGhhbiB0aGF0LgogICAgICAgIHJvbGxvdmVyRmVlKGFjY291bnQsIGxhc3RUcmFuc2ZlclRpbWVzdGFtcFthY2NvdW50XSwgcHJlQmFsYW5jZSk7CgogICAgICAgIGN1cnJlbnRCYWxhbmNlU3VtW2FjY291bnRdID0gc2FmZUFkZCgKICAgICAgICAgICAgY3VycmVudEJhbGFuY2VTdW1bYWNjb3VudF0sCiAgICAgICAgICAgIHNhZmVNdWwocHJlQmFsYW5jZSwgbm93IC0gbGFzdFRyYW5zZmVyVGltZXN0YW1wW2FjY291bnRdKQogICAgICAgICk7CgogICAgICAgIC8vIFVwZGF0ZSB0aGUgbGFzdCB0aW1lIHRoaXMgdXNlcidzIGJhbGFuY2UgY2hhbmdlZC4KICAgICAgICBsYXN0VHJhbnNmZXJUaW1lc3RhbXBbYWNjb3VudF0gPSBub3c7CiAgICB9CgogICAgLyogVXBkYXRlIHRoZSBnaXZlbiBhY2NvdW50J3MgcHJldmlvdXMgcGVyaW9kIGZlZSBlbnRpdGxlbWVudCB2YWx1ZS4KICAgICAqIERvIG5vdGhpbmcgaWYgdGhlIGxhc3QgdHJhbnNmZXIgb2NjdXJyZWQgc2luY2UgdGhlIGZlZSBwZXJpb2Qgcm9sbGVkIG92ZXIuCiAgICAgKiBJZiB0aGUgZW50aXRsZW1lbnQgd2FzIHVwZGF0ZWQsIGFsc28gdXBkYXRlIHRoZSBsYXN0IHRyYW5zZmVyIHRpbWUgdG8gYmUKICAgICAqIGF0IHRoZSB0aW1lc3RhbXAgb2YgdGhlIHJvbGxvdmVyLCBzbyBpZiB0aGlzIHNob3VsZCBkbyBub3RoaW5nIGlmIGNhbGxlZCBtb3JlCiAgICAgKiB0aGFuIG9uY2UgZHVyaW5nIGEgZ2l2ZW4gcGVyaW9kLgogICAgICoKICAgICAqIENvbnNpZGVyIHRoZSBjYXNlIHdoZXJlIHRoZSBlbnRpdGxlbWVudCBpcyB1cGRhdGVkLiBJZiB0aGUgbGFzdCB0cmFuc2ZlcgogICAgICogb2NjdXJyZWQgYXQgdGltZSB0IGluIHRoZSBsYXN0IHBlcmlvZCwgdGhlbiB0aGUgc3RhcnJlZCByZWdpb24gaXMgYWRkZWQgdG8gdGhlCiAgICAgKiBlbnRpdGxlbWVudCwgdGhlIGxhc3QgdHJhbnNmZXIgdGltZXN0YW1wIGlzIG1vdmVkIHRvIHIsIGFuZCB0aGUgZmVlIHBlcmlvZCBpcwogICAgICogcm9sbGVkIG92ZXIgZnJvbSBrLTEgdG8gayBzbyB0aGF0IHRoZSBuZXcgZmVlIHBlcmlvZCBzdGFydCB0aW1lIGlzIGF0IHRpbWUgci4KICAgICAqIAogICAgICogICBrLTEgICAgICAgfCAgICAgICAgawogICAgICogICAgICAgICBzIF9ffAogICAgICogIF8gIF8gX19ffCoqfAogICAgICogICAgICAgICAgfCoqfAogICAgICogIF8gIF8gX19ffCoqfF9fXyBfXyBfICBfCiAgICAgKiAgICAgICAgICAgICB8CiAgICAgKiAgICAgICAgICB0ICB8CiAgICAgKiAgICAgICAgICAgICByCiAgICAgKiAKICAgICAqIFNpbWlsYXIgY29tcHV0YXRpb25zIGFyZSBwZXJmb3JtZWQgYWNjb3JkaW5nIHRvIHRoZSBmZWUgcGVyaW9kIGluIHdoaWNoIHRoZQogICAgICogbGFzdCB0cmFuc2ZlciBvY2N1cnJlZC4KICAgICAqLwogICAgZnVuY3Rpb24gcm9sbG92ZXJGZWUoYWRkcmVzcyBhY2NvdW50LCB1aW50IGxhc3RUcmFuc2ZlclRpbWUsIHVpbnQgcHJlQmFsYW5jZSkKICAgICAgICBpbnRlcm5hbAogICAgewogICAgICAgIGlmIChsYXN0VHJhbnNmZXJUaW1lIDwgZmVlUGVyaW9kU3RhcnRUaW1lKSB7CiAgICAgICAgICAgIGlmIChsYXN0VHJhbnNmZXJUaW1lIDwgbGFzdEZlZVBlcmlvZFN0YXJ0VGltZSkgewogICAgICAgICAgICAgICAgLy8gVGhlIGxhc3QgdHJhbnNmZXIgcHJlZGF0ZWQgdGhlIHByZXZpb3VzIHR3byBmZWUgcGVyaW9kcy4KICAgICAgICAgICAgICAgIGlmIChsYXN0VHJhbnNmZXJUaW1lIDwgcGVudWx0aW1hdGVGZWVQZXJpb2RTdGFydFRpbWUpIHsKICAgICAgICAgICAgICAgICAgICAvLyBUaGUgYmFsYW5jZSBkaWQgbm90aGluZyBpbiB0aGUgcGVudWx0aW1hdGUgZmVlIHBlcmlvZCwgc28gdGhlIGF2ZXJhZ2UgYmFsYW5jZQogICAgICAgICAgICAgICAgICAgIC8vIGluIHRoaXMgcGVyaW9kIGlzIHRoZWlyIHByZS10cmFuc2ZlciBiYWxhbmNlLgogICAgICAgICAgICAgICAgICAgIHBlbnVsdGltYXRlQXZlcmFnZUJhbGFuY2VbYWNjb3VudF0gPSBwcmVCYWxhbmNlOwogICAgICAgICAgICAgICAgLy8gVGhlIGxhc3QgdHJhbnNmZXIgb2NjdXJyZWQgd2l0aGluIHRoZSBvbmUtYmVmb3JlLXRoZS1sYXN0IGZlZSBwZXJpb2QuCiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIC8vIE5vIG92ZXJmbG93IHJpc2sgaGVyZTogdGhlIGZhaWxlZCBndWFyZCBpbXBsaWVzIChwZW51bHRpbWF0ZUZlZVBlcmlvZFN0YXJ0VGltZSA8PSBsYXN0VHJhbnNmZXJUaW1lKS4KICAgICAgICAgICAgICAgICAgICBwZW51bHRpbWF0ZUF2ZXJhZ2VCYWxhbmNlW2FjY291bnRdID0gc2FmZURpdigKICAgICAgICAgICAgICAgICAgICAgICAgc2FmZUFkZChjdXJyZW50QmFsYW5jZVN1bVthY2NvdW50XSwgc2FmZU11bChwcmVCYWxhbmNlLCAobGFzdEZlZVBlcmlvZFN0YXJ0VGltZSAtIGxhc3RUcmFuc2ZlclRpbWUpKSksCiAgICAgICAgICAgICAgICAgICAgICAgIChsYXN0RmVlUGVyaW9kU3RhcnRUaW1lIC0gcGVudWx0aW1hdGVGZWVQZXJpb2RTdGFydFRpbWUpCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBUaGUgYmFsYW5jZSBkaWQgbm90aGluZyBpbiB0aGUgbGFzdCBmZWUgcGVyaW9kLCBzbyB0aGUgYXZlcmFnZSBiYWxhbmNlCiAgICAgICAgICAgICAgICAvLyBpbiB0aGlzIHBlcmlvZCBpcyB0aGVpciBwcmUtdHJhbnNmZXIgYmFsYW5jZS4KICAgICAgICAgICAgICAgIGxhc3RBdmVyYWdlQmFsYW5jZVthY2NvdW50XSA9IHByZUJhbGFuY2U7CgogICAgICAgICAgICAvLyBUaGUgbGFzdCB0cmFuc2ZlciBvY2N1cnJlZCB3aXRoaW4gdGhlIGxhc3QgZmVlIHBlcmlvZC4KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIFRoZSBwcmV2aW91c2x5LWxhc3QgYXZlcmFnZSBiYWxhbmNlIGJlY29tZXMgdGhlIHBlbnVsdGltYXRlIGJhbGFuY2UuCiAgICAgICAgICAgICAgICBwZW51bHRpbWF0ZUF2ZXJhZ2VCYWxhbmNlW2FjY291bnRdID0gbGFzdEF2ZXJhZ2VCYWxhbmNlW2FjY291bnRdOwoKICAgICAgICAgICAgICAgIC8vIE5vIG92ZXJmbG93IHJpc2sgaGVyZTogdGhlIGZhaWxlZCBndWFyZCBpbXBsaWVzIChsYXN0RmVlUGVyaW9kU3RhcnRUaW1lIDw9IGxhc3RUcmFuc2ZlclRpbWUpLgogICAgICAgICAgICAgICAgbGFzdEF2ZXJhZ2VCYWxhbmNlW2FjY291bnRdID0gc2FmZURpdigKICAgICAgICAgICAgICAgICAgICBzYWZlQWRkKGN1cnJlbnRCYWxhbmNlU3VtW2FjY291bnRdLCBzYWZlTXVsKHByZUJhbGFuY2UsIChmZWVQZXJpb2RTdGFydFRpbWUgLSBsYXN0VHJhbnNmZXJUaW1lKSkpLAogICAgICAgICAgICAgICAgICAgIChmZWVQZXJpb2RTdGFydFRpbWUgLSBsYXN0RmVlUGVyaW9kU3RhcnRUaW1lKQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gUm9sbCBvdmVyIHRvIHRoZSBuZXh0IGZlZSBwZXJpb2QuCiAgICAgICAgICAgIGN1cnJlbnRCYWxhbmNlU3VtW2FjY291bnRdID0gMDsKICAgICAgICAgICAgaGFzV2l0aGRyYXduTGFzdFBlcmlvZEZlZXNbYWNjb3VudF0gPSBmYWxzZTsKICAgICAgICAgICAgbGFzdFRyYW5zZmVyVGltZXN0YW1wW2FjY291bnRdID0gZmVlUGVyaW9kU3RhcnRUaW1lOwogICAgICAgIH0KICAgIH0KCiAgICAvKiBSZWNvbXB1dGUgYW5kIHJldHVybiB0aGUgZ2l2ZW4gYWNjb3VudCdzIGF2ZXJhZ2UgYmFsYW5jZSBpbmZvcm1hdGlvbi4KICAgICAqIFRoaXMgYWxzbyByb2xscyBvdmVyIHRoZSBmZWUgcGVyaW9kIGlmIG5lY2Vzc2FyeSwgYW5kIGJyaW5ncwogICAgICogdGhlIGFjY291bnQncyBjdXJyZW50IGJhbGFuY2Ugc3VtIHVwIHRvIGRhdGUuICovCiAgICBmdW5jdGlvbiBfcmVjb21wdXRlQWNjb3VudExhc3RBdmVyYWdlQmFsYW5jZShhZGRyZXNzIGFjY291bnQpCiAgICAgICAgaW50ZXJuYWwKICAgICAgICBwcmVDaGVja0ZlZVBlcmlvZFJvbGxvdmVyCiAgICAgICAgcmV0dXJucyAodWludCkKICAgIHsKICAgICAgICBhZGp1c3RGZWVFbnRpdGxlbWVudChhY2NvdW50LCBzdGF0ZS5iYWxhbmNlT2YoYWNjb3VudCkpOwogICAgICAgIHJldHVybiBsYXN0QXZlcmFnZUJhbGFuY2VbYWNjb3VudF07CiAgICB9CgogICAgLyogUmVjb21wdXRlIGFuZCByZXR1cm4gdGhlIHNlbmRlcidzIGF2ZXJhZ2UgYmFsYW5jZSBpbmZvcm1hdGlvbi4gKi8KICAgIGZ1bmN0aW9uIHJlY29tcHV0ZUxhc3RBdmVyYWdlQmFsYW5jZSgpCiAgICAgICAgZXh0ZXJuYWwKICAgICAgICBvcHRpb25hbFByb3h5CiAgICAgICAgcmV0dXJucyAodWludCkKICAgIHsKICAgICAgICByZXR1cm4gX3JlY29tcHV0ZUFjY291bnRMYXN0QXZlcmFnZUJhbGFuY2UobWVzc2FnZVNlbmRlcik7CiAgICB9CgogICAgLyogUmVjb21wdXRlIGFuZCByZXR1cm4gdGhlIGdpdmVuIGFjY291bnQncyBhdmVyYWdlIGJhbGFuY2UgaW5mb3JtYXRpb24uICovCiAgICBmdW5jdGlvbiByZWNvbXB1dGVBY2NvdW50TGFzdEF2ZXJhZ2VCYWxhbmNlKGFkZHJlc3MgYWNjb3VudCkKICAgICAgICBleHRlcm5hbAogICAgICAgIHJldHVybnMgKHVpbnQpCiAgICB7CiAgICAgICAgcmV0dXJuIF9yZWNvbXB1dGVBY2NvdW50TGFzdEF2ZXJhZ2VCYWxhbmNlKGFjY291bnQpOwogICAgfQoKICAgIGZ1bmN0aW9uIHJvbGxvdmVyRmVlUGVyaW9kKCkKICAgICAgICBwdWJsaWMKICAgIHsKICAgICAgICBjaGVja0ZlZVBlcmlvZFJvbGxvdmVyKCk7CiAgICB9CgoKICAgIC8qID09PT09PT09PT0gTU9ESUZJRVJTID09PT09PT09PT0gKi8KCiAgICAvKiBJZiB0aGUgZmVlIHBlcmlvZCBoYXMgcm9sbGVkIG92ZXIsIHRoZW4KICAgICAqIHNhdmUgdGhlIHN0YXJ0IHRpbWVzIG9mIHRoZSBsYXN0IGZlZSBwZXJpb2QsCiAgICAgKiBhcyB3ZWxsIGFzIHRoZSBwZW51bHRpbWF0ZSBmZWUgcGVyaW9kLgogICAgICovCiAgICBmdW5jdGlvbiBjaGVja0ZlZVBlcmlvZFJvbGxvdmVyKCkKICAgICAgICBpbnRlcm5hbAogICAgewogICAgICAgIC8vIElmIHRoZSBmZWUgcGVyaW9kIGhhcyByb2xsZWQgb3Zlci4uLgogICAgICAgIGlmIChmZWVQZXJpb2RTdGFydFRpbWUgKyB0YXJnZXRGZWVQZXJpb2REdXJhdGlvblNlY29uZHMgPD0gbm93KSB7CiAgICAgICAgICAgIGxhc3RGZWVzQ29sbGVjdGVkID0gbm9taW4uZmVlUG9vbCgpOwoKICAgICAgICAgICAgLy8gU2hpZnQgdGhlIHRocmVlIHBlcmlvZCBzdGFydCB0aW1lcyBiYWNrIG9uZSBwbGFjZQogICAgICAgICAgICBwZW51bHRpbWF0ZUZlZVBlcmlvZFN0YXJ0VGltZSA9IGxhc3RGZWVQZXJpb2RTdGFydFRpbWU7CiAgICAgICAgICAgIGxhc3RGZWVQZXJpb2RTdGFydFRpbWUgPSBmZWVQZXJpb2RTdGFydFRpbWU7CiAgICAgICAgICAgIGZlZVBlcmlvZFN0YXJ0VGltZSA9IG5vdzsKICAgICAgICAgICAgCiAgICAgICAgICAgIGVtaXQgRmVlUGVyaW9kUm9sbG92ZXIobm93KTsKICAgICAgICB9CiAgICB9CgogICAgbW9kaWZpZXIgcG9zdENoZWNrRmVlUGVyaW9kUm9sbG92ZXIKICAgIHsKICAgICAgICBfOwogICAgICAgIGNoZWNrRmVlUGVyaW9kUm9sbG92ZXIoKTsKICAgIH0KCiAgICBtb2RpZmllciBwcmVDaGVja0ZlZVBlcmlvZFJvbGxvdmVyCiAgICB7CiAgICAgICAgY2hlY2tGZWVQZXJpb2RSb2xsb3ZlcigpOwogICAgICAgIF87CiAgICB9CgoKICAgIC8qID09PT09PT09PT0gRVZFTlRTID09PT09PT09PT0gKi8KCiAgICBldmVudCBGZWVQZXJpb2RSb2xsb3Zlcih1aW50IHRpbWVzdGFtcCk7CgogICAgZXZlbnQgRmVlUGVyaW9kRHVyYXRpb25VcGRhdGVkKHVpbnQgZHVyYXRpb24pOwoKICAgIGV2ZW50IEZlZXNXaXRoZHJhd24oYWRkcmVzcyBhY2NvdW50LCBhZGRyZXNzIGluZGV4ZWQgYWNjb3VudEluZGV4LCB1aW50IHZhbHVlKTsKfQoKLyoKLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KQ09OVFJBQ1QgREVTQ1JJUFRJT04KLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KCkEgY29udHJhY3QgdGhhdCBob2xkcyB0aGUgc3RhdGUgb2YgYW4gRVJDMjAgY29tcGxpYW50IHRva2VuLgoKVGhpcyBjb250cmFjdCBpcyB1c2VkIHNpZGUgYnkgc2lkZSB3aXRoIGV4dGVybmFsIHN0YXRlIHRva2VuCmNvbnRyYWN0cywgc3VjaCBhcyBIYXZ2ZW4gYW5kIEV0aGVyTm9taW4uCkl0IHByb3ZpZGVzIGFuIGVhc3kgd2F5IHRvIHVwZ3JhZGUgY29udHJhY3QgbG9naWMgd2hpbGUKbWFpbnRhaW5pbmcgYWxsIHVzZXIgYmFsYW5jZXMgYW5kIGFsbG93YW5jZXMuIFRoaXMgaXMgZGVzaWduZWQKdG8gdG8gbWFrZSB0aGUgY2hhbmdlb3ZlciBhcyBlYXN5IGFzIHBvc3NpYmxlLCBzaW5jZSBtYXBwaW5ncwphcmUgbm90IHNvIGNoZWFwIG9yIHN0cmFpZ2h0Zm9yd2FyZCB0byBtaWdyYXRlLgoKVGhlIGZpcnN0IGRlcGxveWVkIGNvbnRyYWN0IHdvdWxkIGNyZWF0ZSB0aGlzIHN0YXRlIGNvbnRyYWN0LAp1c2luZyBpdCBhcyBpdHMgc3RvcmUgb2YgYmFsYW5jZXMuCldoZW4gYSBuZXcgY29udHJhY3QgaXMgZGVwbG95ZWQsIGl0IGxpbmtzIHRvIHRoZSBleGlzdGluZwpzdGF0ZSBjb250cmFjdCwgd2hvc2Ugb3duZXIgd291bGQgdGhlbiBjaGFuZ2UgaXRzIGFzc29jaWF0ZWQKY29udHJhY3QgdG8gdGhlIG5ldyBvbmUuCgotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoqLwoKY29udHJhY3QgVG9rZW5TdGF0ZSBpcyBPd25lZCB7CgogICAgLy8gdGhlIGFkZHJlc3Mgb2YgdGhlIGNvbnRyYWN0IHRoYXQgY2FuIG1vZGlmeSBiYWxhbmNlcyBhbmQgYWxsb3dhbmNlcwogICAgLy8gdGhpcyBjYW4gb25seSBiZSBjaGFuZ2VkIGJ5IHRoZSBvd25lciBvZiB0aGlzIGNvbnRyYWN0CiAgICBhZGRyZXNzIHB1YmxpYyBhc3NvY2lhdGVkQ29udHJhY3Q7CgogICAgLy8gRVJDMjAgZmllbGRzLgogICAgbWFwcGluZyhhZGRyZXNzID0+IHVpbnQpIHB1YmxpYyBiYWxhbmNlT2Y7CiAgICBtYXBwaW5nKGFkZHJlc3MgPT4gbWFwcGluZyhhZGRyZXNzID0+IHVpbnQyNTYpKSBwdWJsaWMgYWxsb3dhbmNlOwoKICAgIGZ1bmN0aW9uIFRva2VuU3RhdGUoYWRkcmVzcyBfb3duZXIsIGFkZHJlc3MgX2Fzc29jaWF0ZWRDb250cmFjdCkKICAgICAgICBPd25lZChfb3duZXIpCiAgICAgICAgcHVibGljCiAgICB7CiAgICAgICAgYXNzb2NpYXRlZENvbnRyYWN0ID0gX2Fzc29jaWF0ZWRDb250cmFjdDsKICAgICAgICBlbWl0IEFzc29jaWF0ZWRDb250cmFjdFVwZGF0ZWQoX2Fzc29jaWF0ZWRDb250cmFjdCk7CiAgICB9CgogICAgLyogPT09PT09PT09PSBTRVRURVJTID09PT09PT09PT0gKi8KCiAgICAvLyBDaGFuZ2UgdGhlIGFzc29jaWF0ZWQgY29udHJhY3QgdG8gYSBuZXcgYWRkcmVzcwogICAgZnVuY3Rpb24gc2V0QXNzb2NpYXRlZENvbnRyYWN0KGFkZHJlc3MgX2Fzc29jaWF0ZWRDb250cmFjdCkKICAgICAgICBleHRlcm5hbAogICAgICAgIG9ubHlPd25lcgogICAgewogICAgICAgIGFzc29jaWF0ZWRDb250cmFjdCA9IF9hc3NvY2lhdGVkQ29udHJhY3Q7CiAgICAgICAgZW1pdCBBc3NvY2lhdGVkQ29udHJhY3RVcGRhdGVkKF9hc3NvY2lhdGVkQ29udHJhY3QpOwogICAgfQoKICAgIGZ1bmN0aW9uIHNldEFsbG93YW5jZShhZGRyZXNzIHRva2VuT3duZXIsIGFkZHJlc3Mgc3BlbmRlciwgdWludCB2YWx1ZSkKICAgICAgICBleHRlcm5hbAogICAgICAgIG9ubHlBc3NvY2lhdGVkQ29udHJhY3QKICAgIHsKICAgICAgICBhbGxvd2FuY2VbdG9rZW5Pd25lcl1bc3BlbmRlcl0gPSB2YWx1ZTsKICAgIH0KCiAgICBmdW5jdGlvbiBzZXRCYWxhbmNlT2YoYWRkcmVzcyBhY2NvdW50LCB1aW50IHZhbHVlKQogICAgICAgIGV4dGVybmFsCiAgICAgICAgb25seUFzc29jaWF0ZWRDb250cmFjdAogICAgewogICAgICAgIGJhbGFuY2VPZlthY2NvdW50XSA9IHZhbHVlOwogICAgfQoKCiAgICAvKiA9PT09PT09PT09IE1PRElGSUVSUyA9PT09PT09PT09ICovCgogICAgbW9kaWZpZXIgb25seUFzc29jaWF0ZWRDb250cmFjdAogICAgewogICAgICAgIHJlcXVpcmUobXNnLnNlbmRlciA9PSBhc3NvY2lhdGVkQ29udHJhY3QpOwogICAgICAgIF87CiAgICB9CgogICAgLyogPT09PT09PT09PSBFVkVOVFMgPT09PT09PT09PSAqLwoKICAgIGV2ZW50IEFzc29jaWF0ZWRDb250cmFjdFVwZGF0ZWQoYWRkcmVzcyBfYXNzb2NpYXRlZENvbnRyYWN0KTsKfQoKLyoKTUlUIExpY2Vuc2UKCkNvcHlyaWdodCAoYykgMjAxOCBIYXZ2ZW4KClBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHkKb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgIlNvZnR3YXJlIiksIHRvIGRlYWwKaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cwp0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsCmNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcwpmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOgoKVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW4gYWxsCmNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCgpUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUgpJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSwKRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFCkFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIKTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwKT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTiBUSEUKU09GVFdBUkUuCiov'.
	

]
