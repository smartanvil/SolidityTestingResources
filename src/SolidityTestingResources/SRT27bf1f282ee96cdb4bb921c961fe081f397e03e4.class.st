Class {
	#name : #SRT27bf1f282ee96cdb4bb921c961fe081f397e03e4,
	#superclass : #SRTContracts,
	#category : #SolidityTestingResources
}

{ #category : #base64 }
SRT27bf1f282ee96cdb4bb921c961fe081f397e03e4 >> base64 [
	^ 'cHJhZ21hIHNvbGlkaXR5IF4wLjQuMTk7CgpwcmFnbWEgc29saWRpdHkgXjAuNC4xOTsKCi8qKgogKiBAdGl0bGUgU2FmZU1hdGgKICogQGRldiBNYXRoIG9wZXJhdGlvbnMgd2l0aCBzYWZldHkgY2hlY2tzIHRoYXQgdGhyb3cgb24gZXJyb3IKICovCmxpYnJhcnkgU2FmZU1hdGggewogIGZ1bmN0aW9uIG11bCh1aW50MjU2IGEsIHVpbnQyNTYgYikgaW50ZXJuYWwgcHVyZSByZXR1cm5zICh1aW50MjU2KSB7CiAgICBpZiAoYSA9PSAwKSB7CiAgICAgIHJldHVybiAwOwogICAgfQogICAgdWludDI1NiBjID0gYSAqIGI7CiAgICBhc3NlcnQoYyAvIGEgPT0gYik7CiAgICByZXR1cm4gYzsKICB9CgogIGZ1bmN0aW9uIGRpdih1aW50MjU2IGEsIHVpbnQyNTYgYikgaW50ZXJuYWwgcHVyZSByZXR1cm5zICh1aW50MjU2KSB7CiAgICAvLyBhc3NlcnQoYiA+IDApOyAvLyBTb2xpZGl0eSBhdXRvbWF0aWNhbGx5IHRocm93cyB3aGVuIGRpdmlkaW5nIGJ5IDAKICAgIHVpbnQyNTYgYyA9IGEgLyBiOwogICAgLy8gYXNzZXJ0KGEgPT0gYiAqIGMgKyBhICUgYik7IC8vIFRoZXJlIGlzIG5vIGNhc2UgaW4gd2hpY2ggdGhpcyBkb2Vzbid0IGhvbGQKICAgIHJldHVybiBjOwogIH0KCiAgZnVuY3Rpb24gc3ViKHVpbnQyNTYgYSwgdWludDI1NiBiKSBpbnRlcm5hbCBwdXJlIHJldHVybnMgKHVpbnQyNTYpIHsKICAgIGFzc2VydChiIDw9IGEpOwogICAgcmV0dXJuIGEgLSBiOwogIH0KCiAgZnVuY3Rpb24gYWRkKHVpbnQyNTYgYSwgdWludDI1NiBiKSBpbnRlcm5hbCBwdXJlIHJldHVybnMgKHVpbnQyNTYpIHsKICAgIHVpbnQyNTYgYyA9IGEgKyBiOwogICAgYXNzZXJ0KGMgPj0gYSk7CiAgICByZXR1cm4gYzsKICB9Cn0KCi8qKgogKiBAdGl0bGUgTWF0aAogKiBAZGV2IEFzc29ydGVkIG1hdGggb3BlcmF0aW9ucwogKi8KCmxpYnJhcnkgTWF0aCB7CiAgZnVuY3Rpb24gbWF4NjQodWludDY0IGEsIHVpbnQ2NCBiKSBpbnRlcm5hbCBwdXJlIHJldHVybnMgKHVpbnQ2NCkgewogICAgcmV0dXJuIGEgPj0gYiA/IGEgOiBiOwogIH0KCiAgZnVuY3Rpb24gbWluNjQodWludDY0IGEsIHVpbnQ2NCBiKSBpbnRlcm5hbCBwdXJlIHJldHVybnMgKHVpbnQ2NCkgewogICAgcmV0dXJuIGEgPCBiID8gYSA6IGI7CiAgfQoKICBmdW5jdGlvbiBtYXgyNTYodWludDI1NiBhLCB1aW50MjU2IGIpIGludGVybmFsIHB1cmUgcmV0dXJucyAodWludDI1NikgewogICAgcmV0dXJuIGEgPj0gYiA/IGEgOiBiOwogIH0KCiAgZnVuY3Rpb24gbWluMjU2KHVpbnQyNTYgYSwgdWludDI1NiBiKSBpbnRlcm5hbCBwdXJlIHJldHVybnMgKHVpbnQyNTYpIHsKICAgIHJldHVybiBhIDwgYiA/IGEgOiBiOwogIH0KfQoKCi8vIFNsaWdodGx5IG1vZGlmaWVkIFplcHBlbGluJ3MgVmVzdGVkIFRva2VuIGRlcml2aW5nIE1pbmlNZVRva2VuCgovKgogICAgQ29weXJpZ2h0IDIwMTgsIEtvbnN0YW50aW4gVmlrdG9yb3YgKEVzY3Jvd0Jsb2NrIEZvdW5kYXRpb24pCiAgICBDb3B5cmlnaHQgMjAxNywgSm9yZ2UgSXpxdWllcmRvIChBcmFnb24gRm91bmRhdGlvbikKICAgIENvcHlyaWdodCAyMDE3LCBKb3JkaSBCYXlsaW5hIChHaXZldGgpCgogICAgQmFzZWQgb24gTWluaU1lVG9rZW4uc29sIGZyb20gaHR0cHM6Ly9naXRodWIuY29tL0dpdmV0aC9taW5pbWUKKi8KCmNvbnRyYWN0IEFwcHJvdmVBbmRDYWxsRmFsbEJhY2sgewogICAgZnVuY3Rpb24gcmVjZWl2ZUFwcHJvdmFsKGFkZHJlc3MgZnJvbSwgdWludDI1NiBfYW1vdW50LCBhZGRyZXNzIF90b2tlbiwgYnl0ZXMgX2RhdGEpOwp9CgovKgogICAgQ29weXJpZ2h0IDIwMTgsIEtvbnN0YW50aW4gVmlrdG9yb3YgKEVzY3Jvd0Jsb2NrIEZvdW5kYXRpb24pCiAgICBDb3B5cmlnaHQgMjAxNywgSm9yZ2UgSXpxdWllcmRvIChBcmFnb24gRm91bmRhdGlvbikKICAgIENvcHlyaWdodCAyMDE3LCBKb3JkaSBCYXlsaW5hIChHaXZldGgpCgogICAgQmFzZWQgb24gTWluaU1lVG9rZW4uc29sIGZyb20gaHR0cHM6Ly9naXRodWIuY29tL0dpdmV0aC9taW5pbWUKICovCgpjb250cmFjdCBDb250cm9sbGVkIHsKICAgIGFkZHJlc3MgcHVibGljIGNvbnRyb2xsZXI7CgogICAgZnVuY3Rpb24gQ29udHJvbGxlZCgpIHsKICAgICAgICAgY29udHJvbGxlciA9IG1zZy5zZW5kZXI7CiAgICB9CgogICAgLy8vIEBub3RpY2UgVGhlIGFkZHJlc3Mgb2YgdGhlIGNvbnRyb2xsZXIgaXMgdGhlIG9ubHkgYWRkcmVzcyB0aGF0IGNhbiBjYWxsCiAgICAvLy8gICAgYSBmdW5jdGlvbiB3aXRoIHRoaXMgbW9kaWZpZXIKICAgIG1vZGlmaWVyIG9ubHlDb250cm9sbGVyIHsKICAgICAgICByZXF1aXJlKG1zZy5zZW5kZXIgPT0gY29udHJvbGxlcik7CiAgICAgICAgXzsKICAgIH0KCiAgICAvLy8gQG5vdGljZSBDaGFuZ2VzIHRoZSBjb250cm9sbGVyIG9mIHRoZSBjb250cmFjdAogICAgLy8vIEBwYXJhbSBfbmV3Q29udHJvbGxlciBUaGUgbmV3IGNvbnRyb2xsZXIgb2YgdGhlIGNvbnRyYWN0CiAgICBmdW5jdGlvbiBjaGFuZ2VDb250cm9sbGVyKGFkZHJlc3MgX25ld0NvbnRyb2xsZXIpIG9ubHlDb250cm9sbGVyIHsKICAgICAgICBjb250cm9sbGVyID0gX25ld0NvbnRyb2xsZXI7CiAgICB9Cn0KCi8qCiAgICBDb3B5cmlnaHQgMjAxOCwgS29uc3RhbnRpbiBWaWt0b3JvdiAoRXNjcm93QmxvY2sgRm91bmRhdGlvbikKICAgIENvcHlyaWdodCAyMDE3LCBKb3JnZSBJenF1aWVyZG8gKEFyYWdvbiBGb3VuZGF0aW9uKQogICAgQ29weXJpZ2h0IDIwMTcsIEpvcmRpIEJheWxpbmEgKEdpdmV0aCkKCiAgICBCYXNlZCBvbiBNaW5pTWVUb2tlbi5zb2wgZnJvbSBodHRwczovL2dpdGh1Yi5jb20vR2l2ZXRoL21pbmltZQogKi8KCi8vLyBAZGV2IFRoZSB0b2tlbiBjb250cm9sbGVyIGNvbnRyYWN0IG11c3QgaW1wbGVtZW50IHRoZXNlIGZ1bmN0aW9ucwpjb250cmFjdCBUb2tlbkNvbnRyb2xsZXIgewogICAgLy8vIEBub3RpY2UgQ2FsbGVkIHdoZW4gYF9vd25lcmAgc2VuZHMgZXRoZXIgdG8gdGhlIE1pbmlNZSBUb2tlbiBjb250cmFjdAogICAgLy8vIEBwYXJhbSBfb3duZXIgVGhlIGFkZHJlc3MgdGhhdCBzZW50IHRoZSBldGhlciB0byBjcmVhdGUgdG9rZW5zCiAgICAvLy8gQHJldHVybiBUcnVlIGlmIHRoZSBldGhlciBpcyBhY2NlcHRlZCwgZmFsc2UgaWYgaXQgdGhyb3dzCiAgICBmdW5jdGlvbiBwcm94eVBheW1lbnQoYWRkcmVzcyBfb3duZXIpIHBheWFibGUgcmV0dXJucyhib29sKTsKCiAgICAvLy8gQG5vdGljZSBOb3RpZmllcyB0aGUgY29udHJvbGxlciBhYm91dCBhIHRva2VuIHRyYW5zZmVyIGFsbG93aW5nIHRoZQogICAgLy8vICAgIGNvbnRyb2xsZXIgdG8gcmVhY3QgaWYgZGVzaXJlZAogICAgLy8vIEBwYXJhbSBfZnJvbSBUaGUgb3JpZ2luIG9mIHRoZSB0cmFuc2ZlcgogICAgLy8vIEBwYXJhbSBfdG8gVGhlIGRlc3RpbmF0aW9uIG9mIHRoZSB0cmFuc2ZlcgogICAgLy8vIEBwYXJhbSBfYW1vdW50IFRoZSBhbW91bnQgb2YgdGhlIHRyYW5zZmVyCiAgICAvLy8gQHJldHVybiBGYWxzZSBpZiB0aGUgY29udHJvbGxlciBkb2VzIG5vdCBhdXRob3JpemUgdGhlIHRyYW5zZmVyCiAgICBmdW5jdGlvbiBvblRyYW5zZmVyKGFkZHJlc3MgX2Zyb20sIGFkZHJlc3MgX3RvLCB1aW50IF9hbW91bnQpIHJldHVybnMoYm9vbCk7CgogICAgLy8vIEBub3RpY2UgTm90aWZpZXMgdGhlIGNvbnRyb2xsZXIgYWJvdXQgYW4gYXBwcm92YWwgYWxsb3dpbmcgdGhlCiAgICAvLy8gICAgY29udHJvbGxlciB0byByZWFjdCBpZiBkZXNpcmVkCiAgICAvLy8gQHBhcmFtIF9vd25lciBUaGUgYWRkcmVzcyB0aGF0IGNhbGxzIGBhcHByb3ZlKClgCiAgICAvLy8gQHBhcmFtIF9zcGVuZGVyIFRoZSBzcGVuZGVyIGluIHRoZSBgYXBwcm92ZSgpYCBjYWxsCiAgICAvLy8gQHBhcmFtIF9hbW91bnQgVGhlIGFtb3VudCBpbiB0aGUgYGFwcHJvdmUoKWAgY2FsbAogICAgLy8vIEByZXR1cm4gRmFsc2UgaWYgdGhlIGNvbnRyb2xsZXIgZG9lcyBub3QgYXV0aG9yaXplIHRoZSBhcHByb3ZhbAogICAgZnVuY3Rpb24gb25BcHByb3ZlKGFkZHJlc3MgX293bmVyLCBhZGRyZXNzIF9zcGVuZGVyLCB1aW50IF9hbW91bnQpIHJldHVybnMoYm9vbCk7Cn0KCi8qCiAgICBDb3B5cmlnaHQgMjAxNiwgSm9yZGkgQmF5bGluYQoKICAgIFRoaXMgcHJvZ3JhbSBpcyBmcmVlIHNvZnR3YXJlOiB5b3UgY2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3IgbW9kaWZ5CiAgICBpdCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFzIHB1Ymxpc2hlZCBieQogICAgdGhlIEZyZWUgU29mdHdhcmUgRm91bmRhdGlvbiwgZWl0aGVyIHZlcnNpb24gMyBvZiB0aGUgTGljZW5zZSwgb3IKICAgIChhdCB5b3VyIG9wdGlvbikgYW55IGxhdGVyIHZlcnNpb24uCgogICAgVGhpcyBwcm9ncmFtIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsCiAgICBidXQgV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZgogICAgTUVSQ0hBTlRBQklMSVRZIG9yIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFLiAgICBTZWUgdGhlCiAgICBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLgoKICAgIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlCiAgICBhbG9uZyB3aXRoIHRoaXMgcHJvZ3JhbS4gICAgSWYgbm90LCBzZWUgPGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8+LgogKi8KCi8vLyBAdGl0bGUgTWluaU1lVG9rZW4gQ29udHJhY3QKLy8vIEBhdXRob3IgSm9yZGkgQmF5bGluYQovLy8gQGRldiBUaGlzIHRva2VuIGNvbnRyYWN0J3MgZ29hbCBpcyB0byBtYWtlIGl0IGVhc3kgZm9yIGFueW9uZSB0byBjbG9uZSB0aGlzCi8vLyAgICB0b2tlbiB1c2luZyB0aGUgdG9rZW4gZGlzdHJpYnV0aW9uIGF0IGEgZ2l2ZW4gYmxvY2ssIHRoaXMgd2lsbCBhbGxvdyBEQU8ncwovLy8gICAgYW5kIERBcHBzIHRvIHVwZ3JhZGUgdGhlaXIgZmVhdHVyZXMgaW4gYSBkZWNlbnRyYWxpemVkIG1hbm5lciB3aXRob3V0Ci8vLyAgICBhZmZlY3RpbmcgdGhlIG9yaWdpbmFsIHRva2VuCi8vLyBAZGV2IEl0IGlzIEVSQzIwIGNvbXBsaWFudCwgYnV0IHN0aWxsIG5lZWRzIHRvIHVuZGVyIGdvIGZ1cnRoZXIgdGVzdGluZy4KCi8vLyBAZGV2IFRoZSBhY3R1YWwgdG9rZW4gY29udHJhY3QsIHRoZSBkZWZhdWx0IGNvbnRyb2xsZXIgaXMgdGhlIG1zZy5zZW5kZXIKLy8vICAgIHRoYXQgZGVwbG95cyB0aGUgY29udHJhY3QsIHNvIHVzdWFsbHkgdGhpcyB0b2tlbiB3aWxsIGJlIGRlcGxveWVkIGJ5IGEKLy8vICAgIHRva2VuIGNvbnRyb2xsZXIgY29udHJhY3QsIHdoaWNoIEdpdmV0aCB3aWxsIGNhbGwgYSAiQ2FtcGFpZ24iCmNvbnRyYWN0IE1pbmlNZVRva2VuIGlzIENvbnRyb2xsZWQgewoKICAgIHN0cmluZyBwdWJsaWMgbmFtZTsgICAgICAgICAgICAgICAvL1RoZSBUb2tlbidzIG5hbWU6IGUuZy4gRGlnaXhEQU8gVG9rZW5zCiAgICB1aW50OCBwdWJsaWMgZGVjaW1hbHM7ICAgICAgICAgICAgIC8vTnVtYmVyIG9mIGRlY2ltYWxzIG9mIHRoZSBzbWFsbGVzdCB1bml0CiAgICBzdHJpbmcgcHVibGljIHN5bWJvbDsgICAgICAgICAgICAgICAvL0FuIGlkZW50aWZpZXI6IGUuZy4gUkVQCiAgICBzdHJpbmcgcHVibGljIHZlcnNpb24gPSAiTU1UXzAuMSI7IC8vQW4gYXJiaXRyYXJ5IHZlcnNpb25pbmcgc2NoZW1lCgoKICAgIC8vLyBAZGV2IGBDaGVja3BvaW50YCBpcyB0aGUgc3RydWN0dXJlIHRoYXQgYXR0YWNoZXMgYSBibG9jayBudW1iZXIgdG8gYQogICAgLy8vICAgIGdpdmVuIHZhbHVlLCB0aGUgYmxvY2sgbnVtYmVyIGF0dGFjaGVkIGlzIHRoZSBvbmUgdGhhdCBsYXN0IGNoYW5nZWQgdGhlCiAgICAvLy8gICAgdmFsdWUKICAgIHN0cnVjdCAgICBDaGVja3BvaW50IHsKCiAgICAgICAgLy8gYGZyb21CbG9ja2AgaXMgdGhlIGJsb2NrIG51bWJlciB0aGF0IHRoZSB2YWx1ZSB3YXMgZ2VuZXJhdGVkIGZyb20KICAgICAgICB1aW50MTI4IGZyb21CbG9jazsKCiAgICAgICAgLy8gYHZhbHVlYCBpcyB0aGUgYW1vdW50IG9mIHRva2VucyBhdCBhIHNwZWNpZmljIGJsb2NrIG51bWJlcgogICAgICAgIHVpbnQxMjggdmFsdWU7CiAgICB9CgogICAgLy8gYHBhcmVudFRva2VuYCBpcyB0aGUgVG9rZW4gYWRkcmVzcyB0aGF0IHdhcyBjbG9uZWQgdG8gcHJvZHVjZSB0aGlzIHRva2VuOwogICAgLy8gICAgaXQgd2lsbCBiZSAweDAgZm9yIGEgdG9rZW4gdGhhdCB3YXMgbm90IGNsb25lZAogICAgTWluaU1lVG9rZW4gcHVibGljIHBhcmVudFRva2VuOwoKICAgIC8vIGBwYXJlbnRTbmFwU2hvdEJsb2NrYCBpcyB0aGUgYmxvY2sgbnVtYmVyIGZyb20gdGhlIFBhcmVudCBUb2tlbiB0aGF0IHdhcwogICAgLy8gICAgdXNlZCB0byBkZXRlcm1pbmUgdGhlIGluaXRpYWwgZGlzdHJpYnV0aW9uIG9mIHRoZSBDbG9uZSBUb2tlbgogICAgdWludCBwdWJsaWMgcGFyZW50U25hcFNob3RCbG9jazsKCiAgICAvLyBgY3JlYXRpb25CbG9ja2AgaXMgdGhlIGJsb2NrIG51bWJlciB0aGF0IHRoZSBDbG9uZSBUb2tlbiB3YXMgY3JlYXRlZAogICAgdWludCBwdWJsaWMgY3JlYXRpb25CbG9jazsKCiAgICAvLyBgYmFsYW5jZXNgIGlzIHRoZSBtYXAgdGhhdCB0cmFja3MgdGhlIGJhbGFuY2Ugb2YgZWFjaCBhZGRyZXNzLCBpbiB0aGlzCiAgICAvLyAgICBjb250cmFjdCB3aGVuIHRoZSBiYWxhbmNlIGNoYW5nZXMgdGhlIGJsb2NrIG51bWJlciB0aGF0IHRoZSBjaGFuZ2UKICAgIC8vICAgIG9jY3VycmVkIGlzIGFsc28gaW5jbHVkZWQgaW4gdGhlIG1hcAogICAgbWFwcGluZyAoYWRkcmVzcyA9PiBDaGVja3BvaW50W10pIGJhbGFuY2VzOwoKICAgIC8vIGBhbGxvd2VkYCB0cmFja3MgYW55IGV4dHJhIHRyYW5zZmVyIHJpZ2h0cyBhcyBpbiBhbGwgRVJDMjAgdG9rZW5zCiAgICBtYXBwaW5nIChhZGRyZXNzID0+IG1hcHBpbmcgKGFkZHJlc3MgPT4gdWludDI1NikpIGFsbG93ZWQ7CgogICAgLy8gVHJhY2tzIHRoZSBoaXN0b3J5IG9mIHRoZSBgdG90YWxTdXBwbHlgIG9mIHRoZSB0b2tlbgogICAgQ2hlY2twb2ludFtdIHRvdGFsU3VwcGx5SGlzdG9yeTsKCiAgICAvLyBGbGFnIHRoYXQgZGV0ZXJtaW5lcyBpZiB0aGUgdG9rZW4gaXMgdHJhbnNmZXJhYmxlIG9yIG5vdC4KICAgIGJvb2wgcHVibGljIHRyYW5zZmVyc0VuYWJsZWQ7CgogICAgLy8gVGhlIGZhY3RvcnkgdXNlZCB0byBjcmVhdGUgbmV3IGNsb25lIHRva2VucwogICAgTWluaU1lVG9rZW5GYWN0b3J5IHB1YmxpYyB0b2tlbkZhY3Rvcnk7CgovLy8vLy8vLy8vLy8vLy8vCi8vIENvbnN0cnVjdG9yCi8vLy8vLy8vLy8vLy8vLy8KCiAgICAvLy8gQG5vdGljZSBDb25zdHJ1Y3RvciB0byBjcmVhdGUgYSBNaW5pTWVUb2tlbgogICAgLy8vIEBwYXJhbSBfdG9rZW5GYWN0b3J5IFRoZSBhZGRyZXNzIG9mIHRoZSBNaW5pTWVUb2tlbkZhY3RvcnkgY29udHJhY3QgdGhhdAogICAgLy8vICAgIHdpbGwgY3JlYXRlIHRoZSBDbG9uZSB0b2tlbiBjb250cmFjdHMsIHRoZSB0b2tlbiBmYWN0b3J5IG5lZWRzIHRvIGJlCiAgICAvLy8gICAgZGVwbG95ZWQgZmlyc3QKICAgIC8vLyBAcGFyYW0gX3BhcmVudFRva2VuIEFkZHJlc3Mgb2YgdGhlIHBhcmVudCB0b2tlbiwgc2V0IHRvIDB4MCBpZiBpdCBpcyBhCiAgICAvLy8gICAgbmV3IHRva2VuCiAgICAvLy8gQHBhcmFtIF9wYXJlbnRTbmFwU2hvdEJsb2NrIEJsb2NrIG9mIHRoZSBwYXJlbnQgdG9rZW4gdGhhdCB3aWxsCiAgICAvLy8gICAgZGV0ZXJtaW5lIHRoZSBpbml0aWFsIGRpc3RyaWJ1dGlvbiBvZiB0aGUgY2xvbmUgdG9rZW4sIHNldCB0byAwIGlmIGl0CiAgICAvLy8gICAgaXMgYSBuZXcgdG9rZW4KICAgIC8vLyBAcGFyYW0gX3Rva2VuTmFtZSBOYW1lIG9mIHRoZSBuZXcgdG9rZW4KICAgIC8vLyBAcGFyYW0gX2RlY2ltYWxVbml0cyBOdW1iZXIgb2YgZGVjaW1hbHMgb2YgdGhlIG5ldyB0b2tlbgogICAgLy8vIEBwYXJhbSBfdG9rZW5TeW1ib2wgVG9rZW4gU3ltYm9sIGZvciB0aGUgbmV3IHRva2VuCiAgICAvLy8gQHBhcmFtIF90cmFuc2ZlcnNFbmFibGVkIElmIHRydWUsIHRva2VucyB3aWxsIGJlIGFibGUgdG8gYmUgdHJhbnNmZXJyZWQKICAgIGZ1bmN0aW9uIE1pbmlNZVRva2VuKAogICAgICAgIGFkZHJlc3MgX3Rva2VuRmFjdG9yeSwKICAgICAgICBhZGRyZXNzIF9wYXJlbnRUb2tlbiwKICAgICAgICB1aW50IF9wYXJlbnRTbmFwU2hvdEJsb2NrLAogICAgICAgIHN0cmluZyBfdG9rZW5OYW1lLAogICAgICAgIHVpbnQ4IF9kZWNpbWFsVW5pdHMsCiAgICAgICAgc3RyaW5nIF90b2tlblN5bWJvbCwKICAgICAgICBib29sIF90cmFuc2ZlcnNFbmFibGVkCiAgICApIHsKICAgICAgICB0b2tlbkZhY3RvcnkgPSBNaW5pTWVUb2tlbkZhY3RvcnkoX3Rva2VuRmFjdG9yeSk7CiAgICAgICAgbmFtZSA9IF90b2tlbk5hbWU7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBTZXQgdGhlIG5hbWUKICAgICAgICBkZWNpbWFscyA9IF9kZWNpbWFsVW5pdHM7ICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNldCB0aGUgZGVjaW1hbHMKICAgICAgICBzeW1ib2wgPSBfdG9rZW5TeW1ib2w7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBTZXQgdGhlIHN5bWJvbAogICAgICAgIHBhcmVudFRva2VuID0gTWluaU1lVG9rZW4oX3BhcmVudFRva2VuKTsKICAgICAgICBwYXJlbnRTbmFwU2hvdEJsb2NrID0gX3BhcmVudFNuYXBTaG90QmxvY2s7CiAgICAgICAgdHJhbnNmZXJzRW5hYmxlZCA9IF90cmFuc2ZlcnNFbmFibGVkOwogICAgICAgIGNyZWF0aW9uQmxvY2sgPSBibG9jay5udW1iZXI7CiAgICB9CgoKLy8vLy8vLy8vLy8vLy8vLy8vLwovLyBFUkMyMCBNZXRob2RzCi8vLy8vLy8vLy8vLy8vLy8vLy8KCiAgICAvLy8gQG5vdGljZSBTZW5kIGBfYW1vdW50YCB0b2tlbnMgdG8gYF90b2AgZnJvbSBgbXNnLnNlbmRlcmAKICAgIC8vLyBAcGFyYW0gX3RvIFRoZSBhZGRyZXNzIG9mIHRoZSByZWNpcGllbnQKICAgIC8vLyBAcGFyYW0gX2Ftb3VudCBUaGUgYW1vdW50IG9mIHRva2VucyB0byBiZSB0cmFuc2ZlcnJlZAogICAgLy8vIEByZXR1cm4gV2hldGhlciB0aGUgdHJhbnNmZXIgd2FzIHN1Y2Nlc3NmdWwgb3Igbm90CiAgICBmdW5jdGlvbiB0cmFuc2ZlcihhZGRyZXNzIF90bywgdWludDI1NiBfYW1vdW50KSByZXR1cm5zIChib29sIHN1Y2Nlc3MpIHsKICAgICAgICByZXF1aXJlKHRyYW5zZmVyc0VuYWJsZWQpOwogICAgICAgIGRvVHJhbnNmZXIobXNnLnNlbmRlciwgX3RvLCBfYW1vdW50KTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICAvLy8gQG5vdGljZSBTZW5kIGBfYW1vdW50YCB0b2tlbnMgdG8gYF90b2AgZnJvbSBgX2Zyb21gIG9uIHRoZSBjb25kaXRpb24gaXQKICAgIC8vLyAgICBpcyBhcHByb3ZlZCBieSBgX2Zyb21gCiAgICAvLy8gQHBhcmFtIF9mcm9tIFRoZSBhZGRyZXNzIGhvbGRpbmcgdGhlIHRva2VucyBiZWluZyB0cmFuc2ZlcnJlZAogICAgLy8vIEBwYXJhbSBfdG8gVGhlIGFkZHJlc3Mgb2YgdGhlIHJlY2lwaWVudAogICAgLy8vIEBwYXJhbSBfYW1vdW50IFRoZSBhbW91bnQgb2YgdG9rZW5zIHRvIGJlIHRyYW5zZmVycmVkCiAgICAvLy8gQHJldHVybiBUcnVlIGlmIHRoZSB0cmFuc2ZlciB3YXMgc3VjY2Vzc2Z1bAogICAgZnVuY3Rpb24gdHJhbnNmZXJGcm9tKGFkZHJlc3MgX2Zyb20sIGFkZHJlc3MgX3RvLCB1aW50MjU2IF9hbW91bnQKICAgICkgcmV0dXJucyAoYm9vbCBzdWNjZXNzKSB7CgogICAgICAgIC8vIFRoZSBjb250cm9sbGVyIG9mIHRoaXMgY29udHJhY3QgY2FuIG1vdmUgdG9rZW5zIGFyb3VuZCBhdCB3aWxsLAogICAgICAgIC8vICAgIHRoaXMgaXMgaW1wb3J0YW50IHRvIHJlY29nbml6ZSEgQ29uZmlybSB0aGF0IHlvdSB0cnVzdCB0aGUKICAgICAgICAvLyAgICBjb250cm9sbGVyIG9mIHRoaXMgY29udHJhY3QsIHdoaWNoIGluIG1vc3Qgc2l0dWF0aW9ucyBzaG91bGQgYmUKICAgICAgICAvLyAgICBhbm90aGVyIG9wZW4gc291cmNlIHNtYXJ0IGNvbnRyYWN0IG9yIDB4MAogICAgICAgIGlmIChtc2cuc2VuZGVyICE9IGNvbnRyb2xsZXIpIHsKICAgICAgICAgICAgcmVxdWlyZSh0cmFuc2ZlcnNFbmFibGVkKTsKCiAgICAgICAgICAgIC8vIFRoZSBzdGFuZGFyZCBFUkMgMjAgdHJhbnNmZXJGcm9tIGZ1bmN0aW9uYWxpdHkKICAgICAgICAgICAgcmVxdWlyZShhbGxvd2VkW19mcm9tXVttc2cuc2VuZGVyXSA+PSBfYW1vdW50KTsKICAgICAgICAgICAgYWxsb3dlZFtfZnJvbV1bbXNnLnNlbmRlcl0gLT0gX2Ftb3VudDsKICAgICAgICB9CiAgICAgICAgZG9UcmFuc2ZlcihfZnJvbSwgX3RvLCBfYW1vdW50KTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICAvLy8gQGRldiBUaGlzIGlzIHRoZSBhY3R1YWwgdHJhbnNmZXIgZnVuY3Rpb24gaW4gdGhlIHRva2VuIGNvbnRyYWN0LCBpdCBjYW4KICAgIC8vLyAgICBvbmx5IGJlIGNhbGxlZCBieSBvdGhlciBmdW5jdGlvbnMgaW4gdGhpcyBjb250cmFjdC4KICAgIC8vLyBAcGFyYW0gX2Zyb20gVGhlIGFkZHJlc3MgaG9sZGluZyB0aGUgdG9rZW5zIGJlaW5nIHRyYW5zZmVycmVkCiAgICAvLy8gQHBhcmFtIF90byBUaGUgYWRkcmVzcyBvZiB0aGUgcmVjaXBpZW50CiAgICAvLy8gQHBhcmFtIF9hbW91bnQgVGhlIGFtb3VudCBvZiB0b2tlbnMgdG8gYmUgdHJhbnNmZXJyZWQKICAgIC8vLyBAcmV0dXJuIFRydWUgaWYgdGhlIHRyYW5zZmVyIHdhcyBzdWNjZXNzZnVsCiAgICBmdW5jdGlvbiBkb1RyYW5zZmVyKGFkZHJlc3MgX2Zyb20sIGFkZHJlc3MgX3RvLCB1aW50IF9hbW91bnQKICAgICkgaW50ZXJuYWwgewoKICAgICAgICAgICAgIGlmIChfYW1vdW50ID09IDApIHsKICAgICAgICAgICAgIFRyYW5zZmVyKF9mcm9tLCBfdG8sIF9hbW91bnQpOyAgICAvLyBGb2xsb3cgdGhlIHNwZWMgdG8gaXNzdWUgdGhlIGV2ZW50IHdoZW4gdHJhbnNmZXIgMAogICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgfQoKICAgICAgICAgICAgIHJlcXVpcmUocGFyZW50U25hcFNob3RCbG9jayA8IGJsb2NrLm51bWJlcik7CgogICAgICAgICAgICAgLy8gRG8gbm90IGFsbG93IHRyYW5zZmVyIHRvIDB4MCBvciB0aGUgdG9rZW4gY29udHJhY3QgaXRzZWxmCiAgICAgICAgICAgICByZXF1aXJlKChfdG8gIT0gMCkgJiYgKF90byAhPSBhZGRyZXNzKHRoaXMpKSk7CgogICAgICAgICAgICAgLy8gSWYgdGhlIGFtb3VudCBiZWluZyB0cmFuc2ZlcmVkIGlzIG1vcmUgdGhhbiB0aGUgYmFsYW5jZSBvZiB0aGUKICAgICAgICAgICAgIC8vICAgIGFjY291bnQgdGhlIHRyYW5zZmVyIHRocm93cwogICAgICAgICAgICAgdWludDI1NiBwcmV2aW91c0JhbGFuY2VGcm9tID0gYmFsYW5jZU9mQXQoX2Zyb20sIGJsb2NrLm51bWJlcik7CiAgICAgICAgICAgICByZXF1aXJlKHByZXZpb3VzQmFsYW5jZUZyb20gPj0gX2Ftb3VudCk7CgogICAgICAgICAgICAgLy8gQWxlcnRzIHRoZSB0b2tlbiBjb250cm9sbGVyIG9mIHRoZSB0cmFuc2ZlcgogICAgICAgICAgICAgaWYgKGlzQ29udHJhY3QoY29udHJvbGxlcikpIHsKICAgICAgICAgICAgICAgICByZXF1aXJlKFRva2VuQ29udHJvbGxlcihjb250cm9sbGVyKS5vblRyYW5zZmVyKF9mcm9tLCBfdG8sIF9hbW91bnQpKTsKICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAvLyBGaXJzdCB1cGRhdGUgdGhlIGJhbGFuY2UgYXJyYXkgd2l0aCB0aGUgbmV3IHZhbHVlIGZvciB0aGUgYWRkcmVzcwogICAgICAgICAgICAgLy8gICAgc2VuZGluZyB0aGUgdG9rZW5zCiAgICAgICAgICAgICB1cGRhdGVWYWx1ZUF0Tm93KGJhbGFuY2VzW19mcm9tXSwgcHJldmlvdXNCYWxhbmNlRnJvbSAtIF9hbW91bnQpOwoKICAgICAgICAgICAgIC8vIFRoZW4gdXBkYXRlIHRoZSBiYWxhbmNlIGFycmF5IHdpdGggdGhlIG5ldyB2YWx1ZSBmb3IgdGhlIGFkZHJlc3MKICAgICAgICAgICAgIC8vICAgIHJlY2VpdmluZyB0aGUgdG9rZW5zCiAgICAgICAgICAgICB1aW50MjU2IHByZXZpb3VzQmFsYW5jZVRvID0gYmFsYW5jZU9mQXQoX3RvLCBibG9jay5udW1iZXIpOwogICAgICAgICAgICAgcmVxdWlyZShwcmV2aW91c0JhbGFuY2VUbyArIF9hbW91bnQgPj0gcHJldmlvdXNCYWxhbmNlVG8pOyAvLyBDaGVjayBmb3Igb3ZlcmZsb3cKICAgICAgICAgICAgIHVwZGF0ZVZhbHVlQXROb3coYmFsYW5jZXNbX3RvXSwgcHJldmlvdXNCYWxhbmNlVG8gKyBfYW1vdW50KTsKCiAgICAgICAgICAgICAvLyBBbiBldmVudCB0byBtYWtlIHRoZSB0cmFuc2ZlciBlYXN5IHRvIGZpbmQgb24gdGhlIGJsb2NrY2hhaW4KICAgICAgICAgICAgIFRyYW5zZmVyKF9mcm9tLCBfdG8sIF9hbW91bnQpOwoKICAgIH0KCiAgICAvLy8gQHBhcmFtIF9vd25lciBUaGUgYWRkcmVzcyB0aGF0J3MgYmFsYW5jZSBpcyBiZWluZyByZXF1ZXN0ZWQKICAgIC8vLyBAcmV0dXJuIFRoZSBiYWxhbmNlIG9mIGBfb3duZXJgIGF0IHRoZSBjdXJyZW50IGJsb2NrCiAgICBmdW5jdGlvbiBiYWxhbmNlT2YoYWRkcmVzcyBfb3duZXIpIHB1YmxpYyB2aWV3IHJldHVybnMgKHVpbnQyNTYgYmFsYW5jZSkgewogICAgICAgIHJldHVybiBiYWxhbmNlT2ZBdChfb3duZXIsIGJsb2NrLm51bWJlcik7CiAgICB9CgogICAgLy8vIEBub3RpY2UgYG1zZy5zZW5kZXJgIGFwcHJvdmVzIGBfc3BlbmRlcmAgdG8gc3BlbmQgYF9hbW91bnRgIHRva2VucyBvbgogICAgLy8vICAgIGl0cyBiZWhhbGYuIFRoaXMgaXMgYSBtb2RpZmllZCB2ZXJzaW9uIG9mIHRoZSBFUkMyMCBhcHByb3ZlIGZ1bmN0aW9uCiAgICAvLy8gICAgdG8gYmUgYSBsaXR0bGUgYml0IHNhZmVyCiAgICAvLy8gQHBhcmFtIF9zcGVuZGVyIFRoZSBhZGRyZXNzIG9mIHRoZSBhY2NvdW50IGFibGUgdG8gdHJhbnNmZXIgdGhlIHRva2VucwogICAgLy8vIEBwYXJhbSBfYW1vdW50IFRoZSBhbW91bnQgb2YgdG9rZW5zIHRvIGJlIGFwcHJvdmVkIGZvciB0cmFuc2ZlcgogICAgLy8vIEByZXR1cm4gVHJ1ZSBpZiB0aGUgYXBwcm92YWwgd2FzIHN1Y2Nlc3NmdWwKICAgIGZ1bmN0aW9uIGFwcHJvdmUoYWRkcmVzcyBfc3BlbmRlciwgdWludDI1NiBfYW1vdW50KSByZXR1cm5zIChib29sIHN1Y2Nlc3MpIHsKICAgICAgICByZXF1aXJlKHRyYW5zZmVyc0VuYWJsZWQpOwoKICAgICAgICAvLyBUbyBjaGFuZ2UgdGhlIGFwcHJvdmUgYW1vdW50IHlvdSBmaXJzdCBoYXZlIHRvIHJlZHVjZSB0aGUgYWRkcmVzc2VzYAogICAgICAgIC8vICAgIGFsbG93YW5jZSB0byB6ZXJvIGJ5IGNhbGxpbmcgYGFwcHJvdmUoX3NwZW5kZXIsMClgIGlmIGl0IGlzIG5vdAogICAgICAgIC8vICAgIGFscmVhZHkgMCB0byBtaXRpZ2F0ZSB0aGUgcmFjZSBjb25kaXRpb24gZGVzY3JpYmVkIGhlcmU6CiAgICAgICAgLy8gICAgaHR0cHM6Ly9naXRodWIuY29tL2V0aGVyZXVtL0VJUHMvaXNzdWVzLzIwI2lzc3VlY29tbWVudC0yNjM1MjQ3MjkKICAgICAgICByZXF1aXJlKChfYW1vdW50ID09IDApIHx8IChhbGxvd2VkW21zZy5zZW5kZXJdW19zcGVuZGVyXSA9PSAwKSk7CgogICAgICAgIC8vIEFsZXJ0cyB0aGUgdG9rZW4gY29udHJvbGxlciBvZiB0aGUgYXBwcm92ZSBmdW5jdGlvbiBjYWxsCiAgICAgICAgaWYgKGlzQ29udHJhY3QoY29udHJvbGxlcikpIHsKICAgICAgICAgICAgcmVxdWlyZShUb2tlbkNvbnRyb2xsZXIoY29udHJvbGxlcikub25BcHByb3ZlKG1zZy5zZW5kZXIsIF9zcGVuZGVyLCBfYW1vdW50KSk7CiAgICAgICAgfQoKICAgICAgICBhbGxvd2VkW21zZy5zZW5kZXJdW19zcGVuZGVyXSA9IF9hbW91bnQ7CiAgICAgICAgQXBwcm92YWwobXNnLnNlbmRlciwgX3NwZW5kZXIsIF9hbW91bnQpOwogICAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIC8vLyBAZGV2IFRoaXMgZnVuY3Rpb24gbWFrZXMgaXQgZWFzeSB0byByZWFkIHRoZSBgYWxsb3dlZFtdYCBtYXAKICAgIC8vLyBAcGFyYW0gX293bmVyIFRoZSBhZGRyZXNzIG9mIHRoZSBhY2NvdW50IHRoYXQgb3ducyB0aGUgdG9rZW4KICAgIC8vLyBAcGFyYW0gX3NwZW5kZXIgVGhlIGFkZHJlc3Mgb2YgdGhlIGFjY291bnQgYWJsZSB0byB0cmFuc2ZlciB0aGUgdG9rZW5zCiAgICAvLy8gQHJldHVybiBBbW91bnQgb2YgcmVtYWluaW5nIHRva2VucyBvZiBfb3duZXIgdGhhdCBfc3BlbmRlciBpcyBhbGxvd2VkCiAgICAvLy8gICAgdG8gc3BlbmQKICAgIGZ1bmN0aW9uIGFsbG93YW5jZShhZGRyZXNzIF9vd25lciwgYWRkcmVzcyBfc3BlbmRlcgogICAgKSBwdWJsaWMgdmlldyByZXR1cm5zICh1aW50MjU2IHJlbWFpbmluZykgewogICAgICAgIHJldHVybiBhbGxvd2VkW19vd25lcl1bX3NwZW5kZXJdOwogICAgfQoKICAgIC8vLyBAbm90aWNlIGBtc2cuc2VuZGVyYCBhcHByb3ZlcyBgX3NwZW5kZXJgIHRvIHNlbmQgYF9hbW91bnRgIHRva2VucyBvbgogICAgLy8vICAgIGl0cyBiZWhhbGYsIGFuZCB0aGVuIGEgZnVuY3Rpb24gaXMgdHJpZ2dlcmVkIGluIHRoZSBjb250cmFjdCB0aGF0IGlzCiAgICAvLy8gICAgYmVpbmcgYXBwcm92ZWQsIGBfc3BlbmRlcmAuIFRoaXMgYWxsb3dzIHVzZXJzIHRvIHVzZSB0aGVpciB0b2tlbnMgdG8KICAgIC8vLyAgICBpbnRlcmFjdCB3aXRoIGNvbnRyYWN0cyBpbiBvbmUgZnVuY3Rpb24gY2FsbCBpbnN0ZWFkIG9mIHR3bwogICAgLy8vIEBwYXJhbSBfc3BlbmRlciBUaGUgYWRkcmVzcyBvZiB0aGUgY29udHJhY3QgYWJsZSB0byB0cmFuc2ZlciB0aGUgdG9rZW5zCiAgICAvLy8gQHBhcmFtIF9hbW91bnQgVGhlIGFtb3VudCBvZiB0b2tlbnMgdG8gYmUgYXBwcm92ZWQgZm9yIHRyYW5zZmVyCiAgICAvLy8gQHJldHVybiBUcnVlIGlmIHRoZSBmdW5jdGlvbiBjYWxsIHdhcyBzdWNjZXNzZnVsCiAgICBmdW5jdGlvbiBhcHByb3ZlQW5kQ2FsbChhZGRyZXNzIF9zcGVuZGVyLCB1aW50MjU2IF9hbW91bnQsIGJ5dGVzIF9leHRyYURhdGEKICAgICkgcHVibGljIHJldHVybnMgKGJvb2wgc3VjY2VzcykgewogICAgICAgIHJlcXVpcmUoYXBwcm92ZShfc3BlbmRlciwgX2Ftb3VudCkpOwoKICAgICAgICBBcHByb3ZlQW5kQ2FsbEZhbGxCYWNrKF9zcGVuZGVyKS5yZWNlaXZlQXBwcm92YWwoCiAgICAgICAgICAgIG1zZy5zZW5kZXIsCiAgICAgICAgICAgIF9hbW91bnQsCiAgICAgICAgICAgIHRoaXMsCiAgICAgICAgICAgIF9leHRyYURhdGEKICAgICAgICApOwoKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICAvLy8gQGRldiBUaGlzIGZ1bmN0aW9uIG1ha2VzIGl0IGVhc3kgdG8gZ2V0IHRoZSB0b3RhbCBudW1iZXIgb2YgdG9rZW5zCiAgICAvLy8gQHJldHVybiBUaGUgdG90YWwgbnVtYmVyIG9mIHRva2VucwogICAgZnVuY3Rpb24gdG90YWxTdXBwbHkoKSBjb25zdGFudCByZXR1cm5zICh1aW50KSB7CiAgICAgICAgcmV0dXJuIHRvdGFsU3VwcGx5QXQoYmxvY2subnVtYmVyKTsKICAgIH0KCgovLy8vLy8vLy8vLy8vLy8vCi8vIFF1ZXJ5IGJhbGFuY2UgYW5kIHRvdGFsU3VwcGx5IGluIEhpc3RvcnkKLy8vLy8vLy8vLy8vLy8vLwoKICAgIC8vLyBAZGV2IFF1ZXJpZXMgdGhlIGJhbGFuY2Ugb2YgYF9vd25lcmAgYXQgYSBzcGVjaWZpYyBgX2Jsb2NrTnVtYmVyYAogICAgLy8vIEBwYXJhbSBfb3duZXIgVGhlIGFkZHJlc3MgZnJvbSB3aGljaCB0aGUgYmFsYW5jZSB3aWxsIGJlIHJldHJpZXZlZAogICAgLy8vIEBwYXJhbSBfYmxvY2tOdW1iZXIgVGhlIGJsb2NrIG51bWJlciB3aGVuIHRoZSBiYWxhbmNlIGlzIHF1ZXJpZWQKICAgIC8vLyBAcmV0dXJuIFRoZSBiYWxhbmNlIGF0IGBfYmxvY2tOdW1iZXJgCiAgICBmdW5jdGlvbiBiYWxhbmNlT2ZBdChhZGRyZXNzIF9vd25lciwgdWludCBfYmxvY2tOdW1iZXIpIHB1YmxpYyB2aWV3CiAgICAgICAgcmV0dXJucyAodWludCkgewoKICAgICAgICAvLyBUaGVzZSBuZXh0IGZldyBsaW5lcyBhcmUgdXNlZCB3aGVuIHRoZSBiYWxhbmNlIG9mIHRoZSB0b2tlbiBpcwogICAgICAgIC8vICAgIHJlcXVlc3RlZCBiZWZvcmUgYSBjaGVjayBwb2ludCB3YXMgZXZlciBjcmVhdGVkIGZvciB0aGlzIHRva2VuLCBpdAogICAgICAgIC8vICAgIHJlcXVpcmVzIHRoYXQgdGhlIGBwYXJlbnRUb2tlbi5iYWxhbmNlT2ZBdGAgYmUgcXVlcmllZCBhdCB0aGUKICAgICAgICAvLyAgICBnZW5lc2lzIGJsb2NrIGZvciB0aGF0IHRva2VuIGFzIHRoaXMgY29udGFpbnMgaW5pdGlhbCBiYWxhbmNlIG9mCiAgICAgICAgLy8gICAgdGhpcyB0b2tlbgogICAgICAgIGlmICgoYmFsYW5jZXNbX293bmVyXS5sZW5ndGggPT0gMCkKICAgICAgICAgICAgfHwgKGJhbGFuY2VzW19vd25lcl1bMF0uZnJvbUJsb2NrID4gX2Jsb2NrTnVtYmVyKSkgewogICAgICAgICAgICBpZiAoYWRkcmVzcyhwYXJlbnRUb2tlbikgIT0gMCkgewogICAgICAgICAgICAgICByZXR1cm4gcGFyZW50VG9rZW4uYmFsYW5jZU9mQXQoX293bmVyLCBtaW4oX2Jsb2NrTnVtYmVyLCBwYXJlbnRTbmFwU2hvdEJsb2NrKSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgIC8vIEhhcyBubyBwYXJlbnQKICAgICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgICAgIH0KCiAgICAgICAgLy8gVGhpcyB3aWxsIHJldHVybiB0aGUgZXhwZWN0ZWQgYmFsYW5jZSBkdXJpbmcgbm9ybWFsIHNpdHVhdGlvbnMKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gZ2V0VmFsdWVBdChiYWxhbmNlc1tfb3duZXJdLCBfYmxvY2tOdW1iZXIpOwogICAgICAgIH0KICAgIH0KCiAgICAvLy8gQG5vdGljZSBUb3RhbCBhbW91bnQgb2YgdG9rZW5zIGF0IGEgc3BlY2lmaWMgYF9ibG9ja051bWJlcmAuCiAgICAvLy8gQHBhcmFtIF9ibG9ja051bWJlciBUaGUgYmxvY2sgbnVtYmVyIHdoZW4gdGhlIHRvdGFsU3VwcGx5IGlzIHF1ZXJpZWQKICAgIC8vLyBAcmV0dXJuIFRoZSB0b3RhbCBhbW91bnQgb2YgdG9rZW5zIGF0IGBfYmxvY2tOdW1iZXJgCiAgICBmdW5jdGlvbiB0b3RhbFN1cHBseUF0KHVpbnQgX2Jsb2NrTnVtYmVyKSBwdWJsaWMgdmlldyByZXR1cm5zKHVpbnQpIHsKCiAgICAgICAgLy8gVGhlc2UgbmV4dCBmZXcgbGluZXMgYXJlIHVzZWQgd2hlbiB0aGUgdG90YWxTdXBwbHkgb2YgdGhlIHRva2VuIGlzCiAgICAgICAgLy8gICAgcmVxdWVzdGVkIGJlZm9yZSBhIGNoZWNrIHBvaW50IHdhcyBldmVyIGNyZWF0ZWQgZm9yIHRoaXMgdG9rZW4sIGl0CiAgICAgICAgLy8gICAgcmVxdWlyZXMgdGhhdCB0aGUgYHBhcmVudFRva2VuLnRvdGFsU3VwcGx5QXRgIGJlIHF1ZXJpZWQgYXQgdGhlCiAgICAgICAgLy8gICAgZ2VuZXNpcyBibG9jayBmb3IgdGhpcyB0b2tlbiBhcyB0aGF0IGNvbnRhaW5zIHRvdGFsU3VwcGx5IG9mIHRoaXMKICAgICAgICAvLyAgICB0b2tlbiBhdCB0aGlzIGJsb2NrIG51bWJlci4KICAgICAgICBpZiAoKHRvdGFsU3VwcGx5SGlzdG9yeS5sZW5ndGggPT0gMCkKICAgICAgICAgICAgfHwgKHRvdGFsU3VwcGx5SGlzdG9yeVswXS5mcm9tQmxvY2sgPiBfYmxvY2tOdW1iZXIpKSB7CiAgICAgICAgICAgIGlmIChhZGRyZXNzKHBhcmVudFRva2VuKSAhPSAwKSB7CiAgICAgICAgICAgICAgIHJldHVybiBwYXJlbnRUb2tlbi50b3RhbFN1cHBseUF0KG1pbihfYmxvY2tOdW1iZXIsIHBhcmVudFNuYXBTaG90QmxvY2spKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgICAgIH0KCiAgICAgICAgLy8gVGhpcyB3aWxsIHJldHVybiB0aGUgZXhwZWN0ZWQgdG90YWxTdXBwbHkgZHVyaW5nIG5vcm1hbCBzaXR1YXRpb25zCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIGdldFZhbHVlQXQodG90YWxTdXBwbHlIaXN0b3J5LCBfYmxvY2tOdW1iZXIpOwogICAgICAgIH0KICAgIH0KCi8vLy8vLy8vLy8vLy8vLy8KLy8gQ2xvbmUgVG9rZW4gTWV0aG9kCi8vLy8vLy8vLy8vLy8vLy8KCiAgICAvLy8gQG5vdGljZSBDcmVhdGVzIGEgbmV3IGNsb25lIHRva2VuIHdpdGggdGhlIGluaXRpYWwgZGlzdHJpYnV0aW9uIGJlaW5nCiAgICAvLy8gICAgdGhpcyB0b2tlbiBhdCBgX3NuYXBzaG90QmxvY2tgCiAgICAvLy8gQHBhcmFtIF9jbG9uZVRva2VuTmFtZSBOYW1lIG9mIHRoZSBjbG9uZSB0b2tlbgogICAgLy8vIEBwYXJhbSBfY2xvbmVEZWNpbWFsVW5pdHMgTnVtYmVyIG9mIGRlY2ltYWxzIG9mIHRoZSBzbWFsbGVzdCB1bml0CiAgICAvLy8gQHBhcmFtIF9jbG9uZVRva2VuU3ltYm9sIFN5bWJvbCBvZiB0aGUgY2xvbmUgdG9rZW4KICAgIC8vLyBAcGFyYW0gX3NuYXBzaG90QmxvY2sgQmxvY2sgd2hlbiB0aGUgZGlzdHJpYnV0aW9uIG9mIHRoZSBwYXJlbnQgdG9rZW4gaXMKICAgIC8vLyAgICBjb3BpZWQgdG8gc2V0IHRoZSBpbml0aWFsIGRpc3RyaWJ1dGlvbiBvZiB0aGUgbmV3IGNsb25lIHRva2VuOwogICAgLy8vICAgIGlmIHRoZSBibG9jayBpcyB6ZXJvIHRoYW4gdGhlIGFjdHVhbCBibG9jaywgdGhlIGN1cnJlbnQgYmxvY2sgaXMgdXNlZAogICAgLy8vIEBwYXJhbSBfdHJhbnNmZXJzRW5hYmxlZCBUcnVlIGlmIHRyYW5zZmVycyBhcmUgYWxsb3dlZCBpbiB0aGUgY2xvbmUKICAgIC8vLyBAcmV0dXJuIFRoZSBhZGRyZXNzIG9mIHRoZSBuZXcgTWluaU1lVG9rZW4gQ29udHJhY3QKICAgIGZ1bmN0aW9uIGNyZWF0ZUNsb25lVG9rZW4oCiAgICAgICAgc3RyaW5nIF9jbG9uZVRva2VuTmFtZSwKICAgICAgICB1aW50OCBfY2xvbmVEZWNpbWFsVW5pdHMsCiAgICAgICAgc3RyaW5nIF9jbG9uZVRva2VuU3ltYm9sLAogICAgICAgIHVpbnQgX3NuYXBzaG90QmxvY2ssCiAgICAgICAgYm9vbCBfdHJhbnNmZXJzRW5hYmxlZAogICAgICAgICkgcmV0dXJucyhhZGRyZXNzKSB7CiAgICAgICAgaWYgKF9zbmFwc2hvdEJsb2NrID09IDApIF9zbmFwc2hvdEJsb2NrID0gYmxvY2subnVtYmVyOwogICAgICAgIE1pbmlNZVRva2VuIGNsb25lVG9rZW4gPSB0b2tlbkZhY3RvcnkuY3JlYXRlQ2xvbmVUb2tlbigKICAgICAgICAgICAgdGhpcywKICAgICAgICAgICAgX3NuYXBzaG90QmxvY2ssCiAgICAgICAgICAgIF9jbG9uZVRva2VuTmFtZSwKICAgICAgICAgICAgX2Nsb25lRGVjaW1hbFVuaXRzLAogICAgICAgICAgICBfY2xvbmVUb2tlblN5bWJvbCwKICAgICAgICAgICAgX3RyYW5zZmVyc0VuYWJsZWQKICAgICAgICAgICAgKTsKCiAgICAgICAgY2xvbmVUb2tlbi5jaGFuZ2VDb250cm9sbGVyKG1zZy5zZW5kZXIpOwoKICAgICAgICAvLyBBbiBldmVudCB0byBtYWtlIHRoZSB0b2tlbiBlYXN5IHRvIGZpbmQgb24gdGhlIGJsb2NrY2hhaW4KICAgICAgICBOZXdDbG9uZVRva2VuKGFkZHJlc3MoY2xvbmVUb2tlbiksIF9zbmFwc2hvdEJsb2NrKTsKICAgICAgICByZXR1cm4gYWRkcmVzcyhjbG9uZVRva2VuKTsKICAgIH0KCi8vLy8vLy8vLy8vLy8vLy8KLy8gR2VuZXJhdGUgYW5kIGRlc3Ryb3kgdG9rZW5zCi8vLy8vLy8vLy8vLy8vLy8KCiAgICAvLy8gQG5vdGljZSBHZW5lcmF0ZXMgYF9hbW91bnRgIHRva2VucyB0aGF0IGFyZSBhc3NpZ25lZCB0byBgX293bmVyYAogICAgLy8vIEBwYXJhbSBfb3duZXIgVGhlIGFkZHJlc3MgdGhhdCB3aWxsIGJlIGFzc2lnbmVkIHRoZSBuZXcgdG9rZW5zCiAgICAvLy8gQHBhcmFtIF9hbW91bnQgVGhlIHF1YW50aXR5IG9mIHRva2VucyBnZW5lcmF0ZWQKICAgIC8vLyBAcmV0dXJuIFRydWUgaWYgdGhlIHRva2VucyBhcmUgZ2VuZXJhdGVkIGNvcnJlY3RseQogICAgZnVuY3Rpb24gZ2VuZXJhdGVUb2tlbnMoYWRkcmVzcyBfb3duZXIsIHVpbnQgX2Ftb3VudAogICAgKSBvbmx5Q29udHJvbGxlciByZXR1cm5zIChib29sKSB7CiAgICAgICAgdWludCBjdXJUb3RhbFN1cHBseSA9IHRvdGFsU3VwcGx5KCk7CiAgICAgICAgcmVxdWlyZShjdXJUb3RhbFN1cHBseSArIF9hbW91bnQgPj0gY3VyVG90YWxTdXBwbHkpOyAvLyBDaGVjayBmb3Igb3ZlcmZsb3cKICAgICAgICB1aW50IHByZXZpb3VzQmFsYW5jZVRvID0gYmFsYW5jZU9mKF9vd25lcik7CiAgICAgICAgcmVxdWlyZShwcmV2aW91c0JhbGFuY2VUbyArIF9hbW91bnQgPj0gcHJldmlvdXNCYWxhbmNlVG8pOyAvLyBDaGVjayBmb3Igb3ZlcmZsb3cKICAgICAgICB1cGRhdGVWYWx1ZUF0Tm93KHRvdGFsU3VwcGx5SGlzdG9yeSwgY3VyVG90YWxTdXBwbHkgKyBfYW1vdW50KTsKICAgICAgICB1cGRhdGVWYWx1ZUF0Tm93KGJhbGFuY2VzW19vd25lcl0sIHByZXZpb3VzQmFsYW5jZVRvICsgX2Ftb3VudCk7CiAgICAgICAgVHJhbnNmZXIoMCwgX293bmVyLCBfYW1vdW50KTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCgogICAgLy8vIEBub3RpY2UgQnVybnMgYF9hbW91bnRgIHRva2VucyBmcm9tIGBfb3duZXJgCiAgICAvLy8gQHBhcmFtIF9vd25lciBUaGUgYWRkcmVzcyB0aGF0IHdpbGwgbG9zZSB0aGUgdG9rZW5zCiAgICAvLy8gQHBhcmFtIF9hbW91bnQgVGhlIHF1YW50aXR5IG9mIHRva2VucyB0byBidXJuCiAgICAvLy8gQHJldHVybiBUcnVlIGlmIHRoZSB0b2tlbnMgYXJlIGJ1cm5lZCBjb3JyZWN0bHkKICAgIGZ1bmN0aW9uIGRlc3Ryb3lUb2tlbnMoYWRkcmVzcyBfb3duZXIsIHVpbnQyNTYgX2Ftb3VudAogICAgKSBvbmx5Q29udHJvbGxlciByZXR1cm5zIChib29sKSB7CiAgICAgICAgdWludDI1NiBjdXJUb3RhbFN1cHBseSA9IHRvdGFsU3VwcGx5KCk7CiAgICAgICAgcmVxdWlyZShjdXJUb3RhbFN1cHBseSA+PSBfYW1vdW50KTsKICAgICAgICB1aW50MjU2IHByZXZpb3VzQmFsYW5jZUZyb20gPSBiYWxhbmNlT2YoX293bmVyKTsKICAgICAgICByZXF1aXJlKHByZXZpb3VzQmFsYW5jZUZyb20gPj0gX2Ftb3VudCk7CiAgICAgICAgdXBkYXRlVmFsdWVBdE5vdyh0b3RhbFN1cHBseUhpc3RvcnksIGN1clRvdGFsU3VwcGx5IC0gX2Ftb3VudCk7CiAgICAgICAgdXBkYXRlVmFsdWVBdE5vdyhiYWxhbmNlc1tfb3duZXJdLCBwcmV2aW91c0JhbGFuY2VGcm9tIC0gX2Ftb3VudCk7CiAgICAgICAgVHJhbnNmZXIoX293bmVyLCAwLCBfYW1vdW50KTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCi8vLy8vLy8vLy8vLy8vLy8KLy8gRW5hYmxlIHRva2VucyB0cmFuc2ZlcnMKLy8vLy8vLy8vLy8vLy8vLwoKCiAgICAvLy8gQG5vdGljZSBFbmFibGVzIHRva2VuIGhvbGRlcnMgdG8gdHJhbnNmZXIgdGhlaXIgdG9rZW5zIGZyZWVseSBpZiB0cnVlCiAgICAvLy8gQHBhcmFtIF90cmFuc2ZlcnNFbmFibGVkIFRydWUgaWYgdHJhbnNmZXJzIGFyZSBhbGxvd2VkIGluIHRoZSBjbG9uZQogICAgZnVuY3Rpb24gZW5hYmxlVHJhbnNmZXJzKGJvb2wgX3RyYW5zZmVyc0VuYWJsZWQpIG9ubHlDb250cm9sbGVyIHsKICAgICAgICB0cmFuc2ZlcnNFbmFibGVkID0gX3RyYW5zZmVyc0VuYWJsZWQ7CiAgICB9CgovLy8vLy8vLy8vLy8vLy8vCi8vIEludGVybmFsIGhlbHBlciBmdW5jdGlvbnMgdG8gcXVlcnkgYW5kIHNldCBhIHZhbHVlIGluIGEgc25hcHNob3QgYXJyYXkKLy8vLy8vLy8vLy8vLy8vLwoKICAgIC8vLyBAZGV2IGBnZXRWYWx1ZUF0YCByZXRyaWV2ZXMgdGhlIG51bWJlciBvZiB0b2tlbnMgYXQgYSBnaXZlbiBibG9jayBudW1iZXIKICAgIC8vLyBAcGFyYW0gY2hlY2twb2ludHMgVGhlIGhpc3Rvcnkgb2YgdmFsdWVzIGJlaW5nIHF1ZXJpZWQKICAgIC8vLyBAcGFyYW0gX2Jsb2NrIFRoZSBibG9jayBudW1iZXIgdG8gcmV0cmlldmUgdGhlIHZhbHVlIGF0CiAgICAvLy8gQHJldHVybiBUaGUgbnVtYmVyIG9mIHRva2VucyBiZWluZyBxdWVyaWVkCiAgICBmdW5jdGlvbiBnZXRWYWx1ZUF0KENoZWNrcG9pbnRbXSBzdG9yYWdlIGNoZWNrcG9pbnRzLCB1aW50IF9ibG9jawogICAgKSBpbnRlcm5hbCB2aWV3IHJldHVybnMgKHVpbnQpIHsKICAgICAgICBpZiAoY2hlY2twb2ludHMubGVuZ3RoID09IDApIHJldHVybiAwOwoKICAgICAgICAvLyBTaG9ydGN1dCBmb3IgdGhlIGFjdHVhbCB2YWx1ZQogICAgICAgIGlmIChfYmxvY2sgPj0gY2hlY2twb2ludHNbY2hlY2twb2ludHMubGVuZ3RoLTFdLmZyb21CbG9jaykKICAgICAgICAgICAgcmV0dXJuIGNoZWNrcG9pbnRzW2NoZWNrcG9pbnRzLmxlbmd0aC0xXS52YWx1ZTsKICAgICAgICBpZiAoX2Jsb2NrIDwgY2hlY2twb2ludHNbMF0uZnJvbUJsb2NrKSByZXR1cm4gMDsKCiAgICAgICAgLy8gQmluYXJ5IHNlYXJjaCBvZiB0aGUgdmFsdWUgaW4gdGhlIGFycmF5CiAgICAgICAgdWludCBtaW4gPSAwOwogICAgICAgIHVpbnQgbWF4ID0gY2hlY2twb2ludHMubGVuZ3RoLTE7CiAgICAgICAgd2hpbGUgKG1heCA+IG1pbikgewogICAgICAgICAgICB1aW50IG1pZCA9IChtYXggKyBtaW4gKyAxKS8gMjsKICAgICAgICAgICAgaWYgKGNoZWNrcG9pbnRzW21pZF0uZnJvbUJsb2NrPD1fYmxvY2spIHsKICAgICAgICAgICAgICAgbWluID0gbWlkOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICBtYXggPSBtaWQtMTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gY2hlY2twb2ludHNbbWluXS52YWx1ZTsKICAgIH0KCiAgICAvLy8gQGRldiBgdXBkYXRlVmFsdWVBdE5vd2AgdXNlZCB0byB1cGRhdGUgdGhlIGBiYWxhbmNlc2AgbWFwIGFuZCB0aGUKICAgIC8vLyAgICBgdG90YWxTdXBwbHlIaXN0b3J5YAogICAgLy8vIEBwYXJhbSBjaGVja3BvaW50cyBUaGUgaGlzdG9yeSBvZiBkYXRhIGJlaW5nIHVwZGF0ZWQKICAgIC8vLyBAcGFyYW0gX3ZhbHVlIFRoZSBuZXcgbnVtYmVyIG9mIHRva2VucwogICAgZnVuY3Rpb24gdXBkYXRlVmFsdWVBdE5vdyhDaGVja3BvaW50W10gc3RvcmFnZSBjaGVja3BvaW50cywgdWludCBfdmFsdWUKICAgICkgaW50ZXJuYWwgICAgewogICAgICAgIGlmICgoY2hlY2twb2ludHMubGVuZ3RoID09IDApCiAgICAgICAgfHwgKGNoZWNrcG9pbnRzW2NoZWNrcG9pbnRzLmxlbmd0aCAtMV0uZnJvbUJsb2NrIDwgYmxvY2subnVtYmVyKSkgewogICAgICAgICAgICAgICAgIENoZWNrcG9pbnQgc3RvcmFnZSBuZXdDaGVja1BvaW50ID0gY2hlY2twb2ludHNbIGNoZWNrcG9pbnRzLmxlbmd0aCsrIF07CiAgICAgICAgICAgICAgICAgbmV3Q2hlY2tQb2ludC5mcm9tQmxvY2sgPSAgICB1aW50MTI4KGJsb2NrLm51bWJlcik7CiAgICAgICAgICAgICAgICAgbmV3Q2hlY2tQb2ludC52YWx1ZSA9IHVpbnQxMjgoX3ZhbHVlKTsKICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgQ2hlY2twb2ludCBzdG9yYWdlIG9sZENoZWNrUG9pbnQgPSBjaGVja3BvaW50c1tjaGVja3BvaW50cy5sZW5ndGgtMV07CiAgICAgICAgICAgICAgICAgb2xkQ2hlY2tQb2ludC52YWx1ZSA9IHVpbnQxMjgoX3ZhbHVlKTsKICAgICAgICAgICAgIH0KICAgIH0KCiAgICAvLy8gQGRldiBJbnRlcm5hbCBmdW5jdGlvbiB0byBkZXRlcm1pbmUgaWYgYW4gYWRkcmVzcyBpcyBhIGNvbnRyYWN0CiAgICAvLy8gQHBhcmFtIF9hZGRyIFRoZSBhZGRyZXNzIGJlaW5nIHF1ZXJpZWQKICAgIC8vLyBAcmV0dXJuIFRydWUgaWYgYF9hZGRyYCBpcyBhIGNvbnRyYWN0CiAgICBmdW5jdGlvbiBpc0NvbnRyYWN0KGFkZHJlc3MgX2FkZHIpIGludGVybmFsIHZpZXcgcmV0dXJucyhib29sKSB7CiAgICAgICAgdWludCBzaXplOwogICAgICAgIGlmIChfYWRkciA9PSAwKSByZXR1cm4gZmFsc2U7CiAgICAgICAgYXNzZW1ibHkgewogICAgICAgICAgICBzaXplIDo9IGV4dGNvZGVzaXplKF9hZGRyKQogICAgICAgIH0KICAgICAgICByZXR1cm4gc2l6ZSA+IDA7CiAgICB9CgogICAgLy8vIEBkZXYgSGVscGVyIGZ1bmN0aW9uIHRvIHJldHVybiBhIG1pbiBiZXR3ZW4gdGhlIHR3byB1aW50cwogICAgZnVuY3Rpb24gbWluKHVpbnQgYSwgdWludCBiKSBpbnRlcm5hbCBwdXJlIHJldHVybnMgKHVpbnQpIHsKICAgICAgICByZXR1cm4gYSA8IGIgPyBhIDogYjsKICAgIH0KCiAgICAvLy8gQG5vdGljZSBUaGUgZmFsbGJhY2sgZnVuY3Rpb246IElmIHRoZSBjb250cmFjdCdzIGNvbnRyb2xsZXIgaGFzIG5vdCBiZWVuCiAgICAvLy8gICAgc2V0IHRvIDAsIHRoZW4gdGhlIGBwcm94eVBheW1lbnRgIG1ldGhvZCBpcyBjYWxsZWQgd2hpY2ggcmVsYXlzIHRoZQogICAgLy8vICAgIGV0aGVyIGFuZCBjcmVhdGVzIHRva2VucyBhcyBkZXNjcmliZWQgaW4gdGhlIHRva2VuIGNvbnRyb2xsZXIgY29udHJhY3QKICAgIGZ1bmN0aW9uICgpICAgIHBheWFibGUgewogICAgICAgIHJlcXVpcmUoaXNDb250cmFjdChjb250cm9sbGVyKSk7CiAgICAgICAgcmVxdWlyZShUb2tlbkNvbnRyb2xsZXIoY29udHJvbGxlcikucHJveHlQYXltZW50LnZhbHVlKG1zZy52YWx1ZSkobXNnLnNlbmRlcikpOwogICAgfQoKLy8vLy8vLy8vLwovLyBTYWZldHkgTWV0aG9kcwovLy8vLy8vLy8vCgogICAgLy8vIEBub3RpY2UgVGhpcyBtZXRob2QgY2FuIGJlIHVzZWQgYnkgdGhlIGNvbnRyb2xsZXIgdG8gZXh0cmFjdCBtaXN0YWtlbmx5CiAgICAvLy8gICAgc2VudCB0b2tlbnMgdG8gdGhpcyBjb250cmFjdC4KICAgIC8vLyBAcGFyYW0gX3Rva2VuIFRoZSBhZGRyZXNzIG9mIHRoZSB0b2tlbiBjb250cmFjdCB0aGF0IHlvdSB3YW50IHRvIHJlY292ZXIKICAgIC8vLyAgICBzZXQgdG8gMCBpbiBjYXNlIHlvdSB3YW50IHRvIGV4dHJhY3QgZXRoZXIuCiAgICBmdW5jdGlvbiBjbGFpbVRva2VucyhhZGRyZXNzIF90b2tlbikgb25seUNvbnRyb2xsZXIgewogICAgICAgIGlmIChfdG9rZW4gPT0gMHgwKSB7CiAgICAgICAgICAgIGNvbnRyb2xsZXIudHJhbnNmZXIodGhpcy5iYWxhbmNlKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgTWluaU1lVG9rZW4gdG9rZW4gPSBNaW5pTWVUb2tlbihfdG9rZW4pOwogICAgICAgIHVpbnQgYmFsYW5jZSA9IHRva2VuLmJhbGFuY2VPZih0aGlzKTsKICAgICAgICB0b2tlbi50cmFuc2Zlcihjb250cm9sbGVyLCBiYWxhbmNlKTsKICAgICAgICBDbGFpbWVkVG9rZW5zKF90b2tlbiwgY29udHJvbGxlciwgYmFsYW5jZSk7CiAgICB9CgovLy8vLy8vLy8vLy8vLy8vCi8vIEV2ZW50cwovLy8vLy8vLy8vLy8vLy8vCiAgICBldmVudCBDbGFpbWVkVG9rZW5zKGFkZHJlc3MgaW5kZXhlZCBfdG9rZW4sIGFkZHJlc3MgaW5kZXhlZCBfY29udHJvbGxlciwgdWludCBfYW1vdW50KTsKICAgIGV2ZW50IFRyYW5zZmVyKGFkZHJlc3MgaW5kZXhlZCBfZnJvbSwgYWRkcmVzcyBpbmRleGVkIF90bywgdWludDI1NiBfYW1vdW50KTsKICAgIGV2ZW50IE5ld0Nsb25lVG9rZW4oYWRkcmVzcyBpbmRleGVkIF9jbG9uZVRva2VuLCB1aW50IF9zbmFwc2hvdEJsb2NrKTsKICAgIGV2ZW50IEFwcHJvdmFsKAogICAgICAgIGFkZHJlc3MgaW5kZXhlZCBfb3duZXIsCiAgICAgICAgYWRkcmVzcyBpbmRleGVkIF9zcGVuZGVyLAogICAgICAgIHVpbnQyNTYgX2Ftb3VudAogICAgICAgICk7Cgp9CgoKLy8vLy8vLy8vLy8vLy8vLwovLyBNaW5pTWVUb2tlbkZhY3RvcnkKLy8vLy8vLy8vLy8vLy8vLwoKLy8vIEBkZXYgVGhpcyBjb250cmFjdCBpcyB1c2VkIHRvIGdlbmVyYXRlIGNsb25lIGNvbnRyYWN0cyBmcm9tIGEgY29udHJhY3QuCi8vLyAgICBJbiBzb2xpZGl0eSB0aGlzIGlzIHRoZSB3YXkgdG8gY3JlYXRlIGEgY29udHJhY3QgZnJvbSBhIGNvbnRyYWN0IG9mIHRoZQovLy8gICAgc2FtZSBjbGFzcwpjb250cmFjdCBNaW5pTWVUb2tlbkZhY3RvcnkgewoKICAgIC8vLyBAbm90aWNlIFVwZGF0ZSB0aGUgREFwcCBieSBjcmVhdGluZyBhIG5ldyB0b2tlbiB3aXRoIG5ldyBmdW5jdGlvbmFsaXRpZXMKICAgIC8vLyAgICB0aGUgbXNnLnNlbmRlciBiZWNvbWVzIHRoZSBjb250cm9sbGVyIG9mIHRoaXMgY2xvbmUgdG9rZW4KICAgIC8vLyBAcGFyYW0gX3BhcmVudFRva2VuIEFkZHJlc3Mgb2YgdGhlIHRva2VuIGJlaW5nIGNsb25lZAogICAgLy8vIEBwYXJhbSBfc25hcHNob3RCbG9jayBCbG9jayBvZiB0aGUgcGFyZW50IHRva2VuIHRoYXQgd2lsbAogICAgLy8vICAgIGRldGVybWluZSB0aGUgaW5pdGlhbCBkaXN0cmlidXRpb24gb2YgdGhlIGNsb25lIHRva2VuCiAgICAvLy8gQHBhcmFtIF90b2tlbk5hbWUgTmFtZSBvZiB0aGUgbmV3IHRva2VuCiAgICAvLy8gQHBhcmFtIF9kZWNpbWFsVW5pdHMgTnVtYmVyIG9mIGRlY2ltYWxzIG9mIHRoZSBuZXcgdG9rZW4KICAgIC8vLyBAcGFyYW0gX3Rva2VuU3ltYm9sIFRva2VuIFN5bWJvbCBmb3IgdGhlIG5ldyB0b2tlbgogICAgLy8vIEBwYXJhbSBfdHJhbnNmZXJzRW5hYmxlZCBJZiB0cnVlLCB0b2tlbnMgd2lsbCBiZSBhYmxlIHRvIGJlIHRyYW5zZmVycmVkCiAgICAvLy8gQHJldHVybiBUaGUgYWRkcmVzcyBvZiB0aGUgbmV3IHRva2VuIGNvbnRyYWN0CiAgICBmdW5jdGlvbiBjcmVhdGVDbG9uZVRva2VuKAogICAgICAgIGFkZHJlc3MgX3BhcmVudFRva2VuLAogICAgICAgIHVpbnQgX3NuYXBzaG90QmxvY2ssCiAgICAgICAgc3RyaW5nIF90b2tlbk5hbWUsCiAgICAgICAgdWludDggX2RlY2ltYWxVbml0cywKICAgICAgICBzdHJpbmcgX3Rva2VuU3ltYm9sLAogICAgICAgIGJvb2wgX3RyYW5zZmVyc0VuYWJsZWQKICAgICkgcmV0dXJucyAoTWluaU1lVG9rZW4pIHsKICAgICAgICBNaW5pTWVUb2tlbiBuZXdUb2tlbiA9IG5ldyBNaW5pTWVUb2tlbigKICAgICAgICAgICAgdGhpcywKICAgICAgICAgICAgX3BhcmVudFRva2VuLAogICAgICAgICAgICBfc25hcHNob3RCbG9jaywKICAgICAgICAgICAgX3Rva2VuTmFtZSwKICAgICAgICAgICAgX2RlY2ltYWxVbml0cywKICAgICAgICAgICAgX3Rva2VuU3ltYm9sLAogICAgICAgICAgICBfdHJhbnNmZXJzRW5hYmxlZAogICAgICAgICAgICApOwoKICAgICAgICBuZXdUb2tlbi5jaGFuZ2VDb250cm9sbGVyKG1zZy5zZW5kZXIpOwogICAgICAgIHJldHVybiBuZXdUb2tlbjsKICAgIH0KfQoKLyoqCiAgICAqIENvcHlyaWdodCAyMDE4LCBLb25zdGFudGluIFZpa3Rvcm92IChFc2Nyb3dCbG9jayBGb3VuZGF0aW9uKQogICAgKiBDb3B5cmlnaHQgMjAxNywgSm9yZ2UgSXpxdWllcmRvIChBcmFnb24gRm91bmRhdGlvbikKICAgICoKICAgICogQmFzZWQgb24gVmVzdGVkVG9rZW4uc29sIGZyb20gaHR0cHM6Ly9naXRodWIuY29tL09wZW5aZXBwZWxpbi96ZXBwZWxpbi1zb2xpZGl0eQogICAgKgogICAgKiBNYXRoIOKAkyBDb3B5cmlnaHQgKGMpIDIwMTYgU21hcnQgQ29udHJhY3QgU29sdXRpb25zLCBJbmMuCiAgICAqIFNhZmVNYXRoIOKAkyBDb3B5cmlnaHQgKGMpIDIwMTYgU21hcnQgQ29udHJhY3QgU29sdXRpb25zLCBJbmMuCiAgICAqIE1pbmlNZVRva2VuIOKAkyBDb3B5cmlnaHQgMjAxNywgSm9yZGkgQmF5bGluYSAoR2l2ZXRoKQogICAgKiovCgovLyBAZGV2IE1pbmlNZUlycmV2b2NhYmxlVmVzdGVkVG9rZW4gaXMgYSBkZXJpdmVkIHZlcnNpb24gb2YgTWluaU1lVG9rZW4gYWRkaW5nIHRoZQovLyBhYmlsaXR5IHRvIGNyZWF0ZVRva2VuR3JhbnRzIHdoaWNoIGFyZSBiYXNpY2FsbHkgYSB0cmFuc2ZlciB0aGF0IGxpbWl0cyB0aGUKLy8gcmVjZWl2ZXIgb2YgdGhlIHRva2VucyBob3cgY2FuIGhlIHNwZW5kIHRoZW0gb3ZlciB0aW1lLgoKLy8gRm9yIHNpbXBsaWNpdHksIHRva2VuIGdyYW50cyBhcmUgbm90IHNhdmVkIGluIE1pbmlNZSB0eXBlIGNoZWNrcG9pbnRzLgovLyBWYW5pbGxhIGNsb25pbmcgRVNDQkNvaW4gd2lsbCBjbG9uZSBpdCBpbnRvIGEgTWluaU1lVG9rZW4gd2l0aG91dCB2ZXN0aW5nLgovLyBNb3JlIGNvbXBsZXggY2xvbmluZyBjb3VsZCBhY2NvdW50IGZvciBwYXN0IHZlc3RpbmcgY2FsZW5kYXJzLgoKY29udHJhY3QgTWluaU1lSXJyZXZvY2FibGVWZXN0ZWRUb2tlbiBpcyBNaW5pTWVUb2tlbiB7CgogICAgdXNpbmcgU2FmZU1hdGggZm9yIHVpbnQyNTY7CgogICAgdWludDI1NiBNQVhfR1JBTlRTX1BFUl9BRERSRVNTID0gMjA7CiAgICAvLyBLZWVwIHRoZSBzdHJ1Y3QgYXQgMiBzdG9yZXMgKDEgc2xvdCBmb3IgdmFsdWUgKyA2NCAqIDMgKGRhdGVzKSArIDIwIChhZGRyZXNzKSA9IDIgc2xvdHMKICAgIC8vICgybmQgc2xvdCBpcyAyMTIgYnl0ZXMsIGxvd2VyIHRoYW4gMjU2KSkKICAgIHN0cnVjdCBUb2tlbkdyYW50IHsKICAgIGFkZHJlc3MgZ3JhbnRlcjsgICAgLy8gMjAgYnl0ZXMKICAgIHVpbnQyNTYgdmFsdWU7ICAgICAgICAgLy8gMzIgYnl0ZXMKICAgIHVpbnQ2NCBjbGlmZjsKICAgIHVpbnQ2NCB2ZXN0aW5nOwogICAgdWludDY0IHN0YXJ0OyAgICAgICAgLy8gMyAqIDggPSAyNCBieXRlcwogICAgYm9vbCByZXZva2FibGU7CiAgICBib29sIGJ1cm5zT25SZXZva2U7ICAgIC8vIDIgKiAxID0gMiBiaXRzPyBvciAyIGJ5dGVzPwogICAgfSAvLyB0b3RhbCA3OCBieXRlcyA9IDMgc3N0b3JlIHBlciBvcGVyYXRpb24gKDMyIHBlciBzc3RvcmUpCgogICAgbWFwcGluZyAoYWRkcmVzcyA9PiBUb2tlbkdyYW50W10pIHB1YmxpYyBncmFudHM7CgogICAgZXZlbnQgTmV3VG9rZW5HcmFudChhZGRyZXNzIGluZGV4ZWQgZnJvbSwgYWRkcmVzcyBpbmRleGVkIHRvLCB1aW50MjU2IHZhbHVlLCB1aW50NjQgc3RhcnQsIHVpbnQ2NCBjbGlmZiwgdWludDY0IHZlc3RpbmcsIHVpbnQyNTYgZ3JhbnRJZCk7CgogICAgbWFwcGluZyAoYWRkcmVzcyA9PiBib29sKSBjYW5DcmVhdGVHcmFudHM7CiAgICBhZGRyZXNzIHZlc3RpbmdXaGl0ZWxpc3RlcjsKCiAgICBtb2RpZmllciBjYW5UcmFuc2ZlcihhZGRyZXNzIF9zZW5kZXIsIHVpbnQgX3ZhbHVlKSB7CiAgICByZXF1aXJlKF92YWx1ZSA8PSBzcGVuZGFibGVCYWxhbmNlT2YoX3NlbmRlcikpOwogICAgXzsKICAgIH0KCiAgICBtb2RpZmllciBvbmx5VmVzdGluZ1doaXRlbGlzdGVyIHsKICAgIHJlcXVpcmUobXNnLnNlbmRlciA9PSB2ZXN0aW5nV2hpdGVsaXN0ZXIpOwogICAgXzsKICAgIH0KCiAgICBmdW5jdGlvbiBNaW5pTWVJcnJldm9jYWJsZVZlc3RlZFRva2VuICgKICAgICAgICBhZGRyZXNzIF90b2tlbkZhY3RvcnksCiAgICAgICAgYWRkcmVzcyBfcGFyZW50VG9rZW4sCiAgICAgICAgdWludCBfcGFyZW50U25hcFNob3RCbG9jaywKICAgICAgICBzdHJpbmcgX3Rva2VuTmFtZSwKICAgICAgICB1aW50OCBfZGVjaW1hbFVuaXRzLAogICAgICAgIHN0cmluZyBfdG9rZW5TeW1ib2wsCiAgICAgICAgYm9vbCBfdHJhbnNmZXJzRW5hYmxlZAogICAgKSBwdWJsaWMgTWluaU1lVG9rZW4oX3Rva2VuRmFjdG9yeSwgX3BhcmVudFRva2VuLCBfcGFyZW50U25hcFNob3RCbG9jaywgX3Rva2VuTmFtZSwgX2RlY2ltYWxVbml0cywgX3Rva2VuU3ltYm9sLCBfdHJhbnNmZXJzRW5hYmxlZCkgewogICAgdmVzdGluZ1doaXRlbGlzdGVyID0gbXNnLnNlbmRlcjsKICAgIGRvU2V0Q2FuQ3JlYXRlR3JhbnRzKHZlc3RpbmdXaGl0ZWxpc3RlciwgdHJ1ZSk7CiAgICB9CgogICAgLy8gQGRldiBBZGQgY2FuVHJhbnNmZXIgbW9kaWZpZXIgYmVmb3JlIGFsbG93aW5nIHRyYW5zZmVyIGFuZCB0cmFuc2ZlckZyb20gdG8gZ28gdGhyb3VnaAogICAgZnVuY3Rpb24gdHJhbnNmZXIoYWRkcmVzcyBfdG8sIHVpbnQgX3ZhbHVlKQogICAgICAgICAgICAgY2FuVHJhbnNmZXIobXNnLnNlbmRlciwgX3ZhbHVlKQogICAgICAgICAgICAgcHVibGljCiAgICAgICAgICAgICByZXR1cm5zIChib29sIHN1Y2Nlc3MpIHsKICAgIHJldHVybiBzdXBlci50cmFuc2ZlcihfdG8sIF92YWx1ZSk7CiAgICB9CgogICAgZnVuY3Rpb24gdHJhbnNmZXJGcm9tKGFkZHJlc3MgX2Zyb20sIGFkZHJlc3MgX3RvLCB1aW50IF92YWx1ZSkKICAgICAgICAgICAgIGNhblRyYW5zZmVyKF9mcm9tLCBfdmFsdWUpCiAgICAgICAgICAgICBwdWJsaWMKICAgICAgICAgICAgIHJldHVybnMgKGJvb2wgc3VjY2VzcykgewogICAgcmV0dXJuIHN1cGVyLnRyYW5zZmVyRnJvbShfZnJvbSwgX3RvLCBfdmFsdWUpOwogICAgfQoKICAgIGZ1bmN0aW9uIHNwZW5kYWJsZUJhbGFuY2VPZihhZGRyZXNzIF9ob2xkZXIpIGNvbnN0YW50IHB1YmxpYyByZXR1cm5zICh1aW50KSB7CiAgICByZXR1cm4gdHJhbnNmZXJhYmxlVG9rZW5zKF9ob2xkZXIsIHVpbnQ2NChub3cpKTsKICAgIH0KCiAgICAvKioKICAgICogQGRldiBHcmFudCB0b2tlbnMgdG8gYSBzcGVjaWZpZWQgYWRkcmVzcwogICAgKiBAcGFyYW0gX3RvIGFkZHJlc3MgVGhlIGFkZHJlc3Mgd2hpY2ggdGhlIHRva2VucyB3aWxsIGJlIGdyYW50ZWQgdG8uCiAgICAqIEBwYXJhbSBfdmFsdWUgdWludDI1NiBUaGUgYW1vdW50IG9mIHRva2VucyB0byBiZSBncmFudGVkLgogICAgKiBAcGFyYW0gX3N0YXJ0IHVpbnQ2NCBUaW1lIG9mIHRoZSBiZWdpbm5pbmcgb2YgdGhlIGdyYW50LgogICAgKiBAcGFyYW0gX2NsaWZmIHVpbnQ2NCBUaW1lIG9mIHRoZSBjbGlmZiBwZXJpb2QuCiAgICAqIEBwYXJhbSBfdmVzdGluZyB1aW50NjQgVGhlIHZlc3RpbmcgcGVyaW9kLgogICAgKiBAcGFyYW0gX3Jldm9rYWJsZSBib29sIFRva2VuIGNhbiBiZSByZXZva2VkIHdpdGggc2VuZCBhbW91bnQgdG8gYmFjay4KICAgICogQHBhcmFtIF9idXJuc09uUmV2b2tlIGJvb2wgVG9rZW4gY2FuIGJlIHJldm9rZWQgd2l0aCBzZW5kIGFtb3VudCB0byBiYWNrIGFuZCBkZXN0cm95ZWQuCiAgICAqLwogICAgZnVuY3Rpb24gZ3JhbnRWZXN0ZWRUb2tlbnMoCiAgICBhZGRyZXNzIF90bywKICAgIHVpbnQyNTYgX3ZhbHVlLAogICAgdWludDY0IF9zdGFydCwKICAgIHVpbnQ2NCBfY2xpZmYsCiAgICB1aW50NjQgX3Zlc3RpbmcsCiAgICBib29sIF9yZXZva2FibGUsCiAgICBib29sIF9idXJuc09uUmV2b2tlCiAgICApIHB1YmxpYyB7CgogICAgLy8gQ2hlY2sgZm9yIGRhdGUgaW5jb25zaXN0ZW5jaWVzIHRoYXQgbWF5IGNhdXNlIHVuZXhwZWN0ZWQgYmVoYXZpb3IKICAgIHJlcXVpcmUoX2NsaWZmID49IF9zdGFydCAmJiBfdmVzdGluZyA+PSBfY2xpZmYpOwogICAgcmVxdWlyZShjYW5DcmVhdGVHcmFudHNbbXNnLnNlbmRlcl0pOwoKICAgIHJlcXVpcmUodG9rZW5HcmFudHNDb3VudChfdG8pIDwgTUFYX0dSQU5UU19QRVJfQUREUkVTUyk7ICAgIC8vIFRvIHByZXZlbnQgYSB1c2VyIGJlaW5nIHNwYW1tZWQgYW5kIGhhdmUgaGlzIGJhbGFuY2UgbG9ja2VkIChvdXQgb2YgZ2FzIGF0dGFjayB3aGVuIGNhbGN1bGF0aW5nIHZlc3RpbmcpLgoKICAgIHVpbnQyNTYgY291bnQgPSBncmFudHNbX3RvXS5wdXNoKAogICAgICAgICAgICAgICBUb2tlbkdyYW50KAogICAgICAgICAgICAgICAgICAgX3Jldm9rYWJsZSA/IG1zZy5zZW5kZXIgOiAwLCAvLyBhdm9pZCBzdG9yaW5nIGFuIGV4dHJhIDIwIGJ5dGVzIHdoZW4gaXQgaXMgbm9uLXJldm9rYWJsZQogICAgICAgICAgICAgICAgICAgX3ZhbHVlLAogICAgICAgICAgICAgICAgICAgX2NsaWZmLAogICAgICAgICAgICAgICAgICAgX3Zlc3RpbmcsCiAgICAgICAgICAgICAgICAgICBfc3RhcnQsCiAgICAgICAgICAgICAgICAgICBfcmV2b2thYmxlLAogICAgICAgICAgICAgICAgICAgX2J1cm5zT25SZXZva2UKICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICApOwoKICAgIHRyYW5zZmVyKF90bywgX3ZhbHVlKTsKCiAgICBOZXdUb2tlbkdyYW50KG1zZy5zZW5kZXIsIF90bywgX3ZhbHVlLCBfY2xpZmYsIF92ZXN0aW5nLCBfc3RhcnQsIGNvdW50IC0gMSk7CiAgICB9CgogICAgZnVuY3Rpb24gc2V0Q2FuQ3JlYXRlR3JhbnRzKGFkZHJlc3MgX2FkZHIsIGJvb2wgX2FsbG93ZWQpIG9ubHlWZXN0aW5nV2hpdGVsaXN0ZXIgcHVibGljIHsKICAgIGRvU2V0Q2FuQ3JlYXRlR3JhbnRzKF9hZGRyLCBfYWxsb3dlZCk7CiAgICB9CgogICAgZnVuY3Rpb24gZG9TZXRDYW5DcmVhdGVHcmFudHMoYWRkcmVzcyBfYWRkciwgYm9vbCBfYWxsb3dlZCkgaW50ZXJuYWwgewogICAgY2FuQ3JlYXRlR3JhbnRzW19hZGRyXSA9IF9hbGxvd2VkOwogICAgfQoKICAgIGZ1bmN0aW9uIGNoYW5nZVZlc3RpbmdXaGl0ZWxpc3RlcihhZGRyZXNzIF9uZXdXaGl0ZWxpc3Rlcikgb25seVZlc3RpbmdXaGl0ZWxpc3RlciBwdWJsaWMgewogICAgZG9TZXRDYW5DcmVhdGVHcmFudHModmVzdGluZ1doaXRlbGlzdGVyLCBmYWxzZSk7CiAgICB2ZXN0aW5nV2hpdGVsaXN0ZXIgPSBfbmV3V2hpdGVsaXN0ZXI7CiAgICBkb1NldENhbkNyZWF0ZUdyYW50cyh2ZXN0aW5nV2hpdGVsaXN0ZXIsIHRydWUpOwogICAgfQoKICAgIC8qKgogICAgKiBAZGV2IFJldm9rZSB0aGUgZ3JhbnQgb2YgdG9rZW5zIG9mIGEgc3BlY2lmZWQgYWRkcmVzcy4KICAgICogQHBhcmFtIF9ob2xkZXIgVGhlIGFkZHJlc3Mgd2hpY2ggd2lsbCBoYXZlIGl0cyB0b2tlbnMgcmV2b2tlZC4KICAgICogQHBhcmFtIF9ncmFudElkIFRoZSBpZCBvZiB0aGUgdG9rZW4gZ3JhbnQuCiAgICAqLwogICAgZnVuY3Rpb24gcmV2b2tlVG9rZW5HcmFudChhZGRyZXNzIF9ob2xkZXIsIHVpbnQyNTYgX2dyYW50SWQpIHB1YmxpYyB7CiAgICBUb2tlbkdyYW50IHN0b3JhZ2UgZ3JhbnQgPSBncmFudHNbX2hvbGRlcl1bX2dyYW50SWRdOwoKICAgIHJlcXVpcmUoZ3JhbnQucmV2b2thYmxlKTsKICAgIHJlcXVpcmUoZ3JhbnQuZ3JhbnRlciA9PSBtc2cuc2VuZGVyKTsgLy8gT25seSBncmFudGVyIGNhbiByZXZva2UgaXQKCiAgICBhZGRyZXNzIHJlY2VpdmVyID0gZ3JhbnQuYnVybnNPblJldm9rZSA/IDB4ZGVhZCA6IG1zZy5zZW5kZXI7CgogICAgdWludDI1NiBub25WZXN0ZWQgPSBub25WZXN0ZWRUb2tlbnMoZ3JhbnQsIHVpbnQ2NChub3cpKTsKCiAgICAvLyByZW1vdmUgZ3JhbnQgZnJvbSBhcnJheQogICAgZGVsZXRlIGdyYW50c1tfaG9sZGVyXVtfZ3JhbnRJZF07CiAgICBncmFudHNbX2hvbGRlcl1bX2dyYW50SWRdID0gZ3JhbnRzW19ob2xkZXJdW2dyYW50c1tfaG9sZGVyXS5sZW5ndGguc3ViKDEpXTsKICAgIGdyYW50c1tfaG9sZGVyXS5sZW5ndGggLT0gMTsKCiAgICB2YXIgcHJldmlvdXNCYWxhbmNlUmVjZWl2ZXIgPSBiYWxhbmNlT2ZBdChyZWNlaXZlciwgYmxvY2subnVtYmVyKTsKCiAgICAvL2JhbGFuY2VzW3JlY2VpdmVyXSA9IGJhbGFuY2VzW3JlY2VpdmVyXS5hZGQobm9uVmVzdGVkKTsKICAgIHVwZGF0ZVZhbHVlQXROb3coYmFsYW5jZXNbcmVjZWl2ZXJdLCBwcmV2aW91c0JhbGFuY2VSZWNlaXZlciArIG5vblZlc3RlZCk7CgogICAgdmFyIHByZXZpb3VzQmFsYW5jZV9ob2xkZXIgPSBiYWxhbmNlT2ZBdChfaG9sZGVyLCBibG9jay5udW1iZXIpOwoKICAgIC8vYmFsYW5jZXNbX2hvbGRlcl0gPSBiYWxhbmNlc1tfaG9sZGVyXS5zdWIobm9uVmVzdGVkKTsKICAgIHVwZGF0ZVZhbHVlQXROb3coYmFsYW5jZXNbX2hvbGRlcl0sIHByZXZpb3VzQmFsYW5jZV9ob2xkZXIgLSBub25WZXN0ZWQpOwoKICAgIFRyYW5zZmVyKF9ob2xkZXIsIHJlY2VpdmVyLCBub25WZXN0ZWQpOwogICAgfQoKICAgIC8qKgogICAgKiBAZGV2IENhbGN1bGF0ZSB0aGUgdG90YWwgYW1vdW50IG9mIHRyYW5zZmVyYWJsZSB0b2tlbnMgb2YgYSBob2xkZXIgYXQgYSBnaXZlbiB0aW1lCiAgICAqIEBwYXJhbSBob2xkZXIgYWRkcmVzcyBUaGUgYWRkcmVzcyBvZiB0aGUgaG9sZGVyCiAgICAqIEBwYXJhbSB0aW1lIHVpbnQ2NCBUaGUgc3BlY2lmaWMgdGltZS4KICAgICogQHJldHVybiBBbiB1aW50MjU2IHJlcHJlc2VudGluZyBhIGhvbGRlcidzIHRvdGFsIGFtb3VudCBvZiB0cmFuc2ZlcmFibGUgdG9rZW5zLgogICAgKi8KICAgIGZ1bmN0aW9uIHRyYW5zZmVyYWJsZVRva2VucyhhZGRyZXNzIGhvbGRlciwgdWludDY0IHRpbWUpIHB1YmxpYyB2aWV3IHJldHVybnMgKHVpbnQyNTYpIHsKICAgIHVpbnQyNTYgZ3JhbnRJbmRleCA9IHRva2VuR3JhbnRzQ291bnQoaG9sZGVyKTsKCiAgICBpZiAoZ3JhbnRJbmRleCA9PSAwKSByZXR1cm4gYmFsYW5jZU9mKGhvbGRlcik7IC8vIHNob3J0Y3V0IGZvciBob2xkZXIgd2l0aG91dCBncmFudHMKCiAgICAvLyBJdGVyYXRlIHRocm91Z2ggYWxsIHRoZSBncmFudHMgdGhlIGhvbGRlciBoYXMsIGFuZCBhZGQgYWxsIG5vbi12ZXN0ZWQgdG9rZW5zCiAgICB1aW50MjU2IG5vblZlc3RlZCA9IDA7CiAgICBmb3IgKHVpbnQyNTYgaSA9IDA7IGkgPCBncmFudEluZGV4OyBpKyspIHsKICAgICAgICBub25WZXN0ZWQgPSBTYWZlTWF0aC5hZGQobm9uVmVzdGVkLCBub25WZXN0ZWRUb2tlbnMoZ3JhbnRzW2hvbGRlcl1baV0sIHRpbWUpKTsKICAgIH0KCiAgICAvLyBCYWxhbmNlIC0gdG90YWxOb25WZXN0ZWQgaXMgdGhlIGFtb3VudCBvZiB0b2tlbnMgYSBob2xkZXIgY2FuIHRyYW5zZmVyIGF0IGFueSBnaXZlbiB0aW1lCiAgICB1aW50MjU2IHZlc3RlZFRyYW5zZmVyYWJsZSA9IFNhZmVNYXRoLnN1YihiYWxhbmNlT2YoaG9sZGVyKSwgbm9uVmVzdGVkKTsKCiAgICAvLyBSZXR1cm4gdGhlIG1pbmltdW0gb2YgaG93IG1hbnkgdmVzdGVkIGNhbiB0cmFuc2ZlciBhbmQgb3RoZXIgdmFsdWUKICAgIC8vIGluIGNhc2UgdGhlcmUgYXJlIG90aGVyIGxpbWl0aW5nIHRyYW5zZmVyYWJpbGl0eSBmYWN0b3JzIChkZWZhdWx0IGlzIGJhbGFuY2VPZikKICAgIHJldHVybiBNYXRoLm1pbjI1Nih2ZXN0ZWRUcmFuc2ZlcmFibGUsIGJhbGFuY2VPZihob2xkZXIpKTsKICAgIH0KCiAgICAvKioKICAgICogQGRldiBDaGVjayB0aGUgYW1vdW50IG9mIGdyYW50cyB0aGF0IGFuIGFkZHJlc3MgaGFzLgogICAgKiBAcGFyYW0gX2hvbGRlciBUaGUgaG9sZGVyIG9mIHRoZSBncmFudHMuCiAgICAqIEByZXR1cm4gQSB1aW50MjU2IHJlcHJlc2VudGluZyB0aGUgdG90YWwgYW1vdW50IG9mIGdyYW50cy4KICAgICovCiAgICBmdW5jdGlvbiB0b2tlbkdyYW50c0NvdW50KGFkZHJlc3MgX2hvbGRlcikgcHVibGljIHZpZXcgcmV0dXJucyAodWludDI1NiBpbmRleCkgewogICAgcmV0dXJuIGdyYW50c1tfaG9sZGVyXS5sZW5ndGg7CiAgICB9CgogICAgLyoqCiAgICAqIEBkZXYgQ2FsY3VsYXRlIGFtb3VudCBvZiB2ZXN0ZWQgdG9rZW5zIGF0IGEgc3BlY2lmYyB0aW1lLgogICAgKiBAcGFyYW0gdG9rZW5zIHVpbnQyNTYgVGhlIGFtb3VudCBvZiB0b2tlbnMgZ3JhbnR0ZWQuCiAgICAqIEBwYXJhbSB0aW1lIHVpbnQ2NCBUaGUgdGltZSB0byBiZSBjaGVja2VkCiAgICAqIEBwYXJhbSBzdGFydCB1aW50NjQgQSB0aW1lIHJlcHJlc2VudGluZyB0aGUgYmVnaW5pbmcgb2YgdGhlIGdyYW50CiAgICAqIEBwYXJhbSBjbGlmZiB1aW50NjQgVGhlIGNsaWZmIHBlcmlvZC4KICAgICogQHBhcmFtIHZlc3RpbmcgdWludDY0IFRoZSB2ZXN0aW5nIHBlcmlvZC4KICAgICogQHJldHVybiBBbiB1aW50MjU2IHJlcHJlc2VudGluZyB0aGUgYW1vdW50IG9mIHZlc3RlZCB0b2tlbnNvZiBhIHNwZWNpZiBncmFudC4KICAgICogICAgdHJhbnNmZXJhYmxlVG9rZW5zCiAgICAqICAgIHwgICAgICAgICAgICAgICAgICAgICAgICBfLy0tLS0tLS0tICAgIHZlc3RlZFRva2VucyByZWN0CiAgICAqICAgIHwgICAgICAgICAgICAgICAgICAgICAgICBfLwogICAgKiAgICB8ICAgICAgICAgICAgICAgICAgICBfLwogICAgKiAgICB8ICAgICAgICAgICAgICAgICAgICBfLwogICAgKiAgICB8ICAgICAgICAgICAgICAgICBfLwogICAgKiAgICB8ICAgICAgICAgICAgICAgLwogICAgKiAgICB8ICAgICAgICAgICAgICAgLnwKICAgICogICAgfCAgICAgICAgICAgIC4gICAgfAogICAgKiAgICB8ICAgICAgICAgICAgLiAgICB8CiAgICAqICAgIHwgICAgICAgIC4gICAgICAgIHwKICAgICogICAgfCAgICAgICAgLiAgICAgICAgfAogICAgKiAgICB8ICAgIC4gICAgICAgICAgICB8CiAgICAqICAgICs9PT0rPT09PT09PT09PT0rLS0tLS0tLS0tKy0tLS0tLS0tLS0+IHRpbWUKICAgICogICAgICAgIFN0YXJ0ICAgICAgICAgQ2xpZnQgICAgVmVzdGluZwogICAgKi8KICAgIGZ1bmN0aW9uIGNhbGN1bGF0ZVZlc3RlZFRva2VucygKICAgIHVpbnQyNTYgdG9rZW5zLAogICAgdWludDI1NiB0aW1lLAogICAgdWludDI1NiBzdGFydCwKICAgIHVpbnQyNTYgY2xpZmYsCiAgICB1aW50MjU2IHZlc3RpbmcpIGludGVybmFsIHZpZXcgcmV0dXJucyAodWludDI1NikKICAgIHsKICAgICAgICAvLyBTaG9ydGN1dHMgZm9yIGJlZm9yZSBjbGlmZiBhbmQgYWZ0ZXIgdmVzdGluZyBjYXNlcy4KICAgICAgICBpZiAodGltZSA8IGNsaWZmKSByZXR1cm4gMDsKICAgICAgICBpZiAodGltZSA+PSB2ZXN0aW5nKSByZXR1cm4gdG9rZW5zOwoKICAgICAgICAvLyBJbnRlcnBvbGF0ZSBhbGwgdmVzdGVkIHRva2Vucy4KICAgICAgICAvLyBBcyBiZWZvcmUgY2xpZmYgdGhlIHNob3J0Y3V0IHJldHVybnMgMCwgd2UgY2FuIHVzZSBqdXN0IGNhbGN1bGF0ZSBhIHZhbHVlCiAgICAgICAgLy8gaW4gdGhlIHZlc3RpbmcgcmVjdCAoYXMgc2hvd24gaW4gYWJvdmUncyBmaWd1cmUpCgogICAgICAgIC8vIHZlc3RlZFRva2VucyA9IHRva2VucyAqICh0aW1lIC0gc3RhcnQpIC8gKHZlc3RpbmcgLSBzdGFydCkKICAgICAgICB1aW50MjU2IHZlc3RlZFRva2VucyA9IFNhZmVNYXRoLmRpdigKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgU2FmZU1hdGgubXVsKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b2tlbnMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFNhZmVNYXRoLnN1Yih0aW1lLCBzdGFydCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgU2FmZU1hdGguc3ViKHZlc3RpbmcsIHN0YXJ0KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApOwoKICAgICAgICByZXR1cm4gdmVzdGVkVG9rZW5zOwogICAgfQoKICAgIC8qKgogICAgKiBAZGV2IEdldCBhbGwgaW5mb3JtYXRpb24gYWJvdXQgYSBzcGVjaWZjIGdyYW50LgogICAgKiBAcGFyYW0gX2hvbGRlciBUaGUgYWRkcmVzcyB3aGljaCB3aWxsIGhhdmUgaXRzIHRva2VucyByZXZva2VkLgogICAgKiBAcGFyYW0gX2dyYW50SWQgVGhlIGlkIG9mIHRoZSB0b2tlbiBncmFudC4KICAgICogQHJldHVybiBSZXR1cm5zIGFsbCB0aGUgdmFsdWVzIHRoYXQgcmVwcmVzZW50IGEgVG9rZW5HcmFudChhZGRyZXNzLCB2YWx1ZSwgc3RhcnQsIGNsaWZmLAogICAgKiByZXZva2FiaWxpdHksIGJ1cm5zT25SZXZva2UsIGFuZCB2ZXN0aW5nKSBwbHVzIHRoZSB2ZXN0ZWQgdmFsdWUgYXQgdGhlIGN1cnJlbnQgdGltZS4KICAgICovCiAgICBmdW5jdGlvbiB0b2tlbkdyYW50KGFkZHJlc3MgX2hvbGRlciwgdWludDI1NiBfZ3JhbnRJZCkgcHVibGljIHZpZXcgcmV0dXJucyAoYWRkcmVzcyBncmFudGVyLCB1aW50MjU2IHZhbHVlLCB1aW50MjU2IHZlc3RlZCwgdWludDY0IHN0YXJ0LCB1aW50NjQgY2xpZmYsIHVpbnQ2NCB2ZXN0aW5nLCBib29sIHJldm9rYWJsZSwgYm9vbCBidXJuc09uUmV2b2tlKSB7CiAgICBUb2tlbkdyYW50IHN0b3JhZ2UgZ3JhbnQgPSBncmFudHNbX2hvbGRlcl1bX2dyYW50SWRdOwoKICAgIGdyYW50ZXIgPSBncmFudC5ncmFudGVyOwogICAgdmFsdWUgPSBncmFudC52YWx1ZTsKICAgIHN0YXJ0ID0gZ3JhbnQuc3RhcnQ7CiAgICBjbGlmZiA9IGdyYW50LmNsaWZmOwogICAgdmVzdGluZyA9IGdyYW50LnZlc3Rpbmc7CiAgICByZXZva2FibGUgPSBncmFudC5yZXZva2FibGU7CiAgICBidXJuc09uUmV2b2tlID0gZ3JhbnQuYnVybnNPblJldm9rZTsKCiAgICB2ZXN0ZWQgPSB2ZXN0ZWRUb2tlbnMoZ3JhbnQsIHVpbnQ2NChub3cpKTsKICAgIH0KCiAgICAvKioKICAgICogQGRldiBHZXQgdGhlIGFtb3VudCBvZiB2ZXN0ZWQgdG9rZW5zIGF0IGEgc3BlY2lmaWMgdGltZS4KICAgICogQHBhcmFtIGdyYW50IFRva2VuR3JhbnQgVGhlIGdyYW50IHRvIGJlIGNoZWNrZWQuCiAgICAqIEBwYXJhbSB0aW1lIFRoZSB0aW1lIHRvIGJlIGNoZWNrZWQKICAgICogQHJldHVybiBBbiB1aW50MjU2IHJlcHJlc2VudGluZyB0aGUgYW1vdW50IG9mIHZlc3RlZCB0b2tlbnMgb2YgYSBzcGVjaWZpYyBncmFudCBhdCBhIHNwZWNpZmljIHRpbWUuCiAgICAqLwogICAgZnVuY3Rpb24gdmVzdGVkVG9rZW5zKFRva2VuR3JhbnQgZ3JhbnQsIHVpbnQ2NCB0aW1lKSBwcml2YXRlIGNvbnN0YW50IHJldHVybnMgKHVpbnQyNTYpIHsKICAgIHJldHVybiBjYWxjdWxhdGVWZXN0ZWRUb2tlbnMoCiAgICAgICAgZ3JhbnQudmFsdWUsCiAgICAgICAgdWludDI1Nih0aW1lKSwKICAgICAgICB1aW50MjU2KGdyYW50LnN0YXJ0KSwKICAgICAgICB1aW50MjU2KGdyYW50LmNsaWZmKSwKICAgICAgICB1aW50MjU2KGdyYW50LnZlc3RpbmcpCiAgICApOwogICAgfQoKICAgIC8qKgogICAgKiBAZGV2IENhbGN1bGF0ZSB0aGUgYW1vdW50IG9mIG5vbiB2ZXN0ZWQgdG9rZW5zIGF0IGEgc3BlY2lmaWMgdGltZS4KICAgICogQHBhcmFtIGdyYW50IFRva2VuR3JhbnQgVGhlIGdyYW50IHRvIGJlIGNoZWNrZWQuCiAgICAqIEBwYXJhbSB0aW1lIHVpbnQ2NCBUaGUgdGltZSB0byBiZSBjaGVja2VkCiAgICAqIEByZXR1cm4gQW4gdWludDI1NiByZXByZXNlbnRpbmcgdGhlIGFtb3VudCBvZiBub24gdmVzdGVkIHRva2VucyBvZiBhIHNwZWNpZmMgZ3JhbnQgb24gdGhlCiAgICAqIHBhc3NlZCB0aW1lIGZyYW1lLgogICAgKi8KICAgIGZ1bmN0aW9uIG5vblZlc3RlZFRva2VucyhUb2tlbkdyYW50IGdyYW50LCB1aW50NjQgdGltZSkgcHJpdmF0ZSBjb25zdGFudCByZXR1cm5zICh1aW50MjU2KSB7CiAgICAvLyBPZiBhbGwgdGhlIHRva2VucyBvZiB0aGUgZ3JhbnQsIGhvdyBtYW55IG9mIHRoZW0gYXJlIG5vdCB2ZXN0ZWQ/CiAgICAvLyBncmFudFZhbHVlIC0gdmVzdGVkVG9rZW5zCiAgICByZXR1cm4gZ3JhbnQudmFsdWUuc3ViKHZlc3RlZFRva2VucyhncmFudCwgdGltZSkpOwogICAgfQoKICAgIC8qKgogICAgKiBAZGV2IENhbGN1bGF0ZSB0aGUgZGF0ZSB3aGVuIHRoZSBob2xkZXIgY2FuIHRyYXNmZXIgYWxsIGl0cyB0b2tlbnMKICAgICogQHBhcmFtIGhvbGRlciBhZGRyZXNzIFRoZSBhZGRyZXNzIG9mIHRoZSBob2xkZXIKICAgICogQHJldHVybiBBbiB1aW50MjU2IHJlcHJlc2VudGluZyB0aGUgZGF0ZSBvZiB0aGUgbGFzdCB0cmFuc2ZlcmFibGUgdG9rZW5zLgogICAgKi8KICAgIGZ1bmN0aW9uIGxhc3RUb2tlbklzVHJhbnNmZXJhYmxlRGF0ZShhZGRyZXNzIGhvbGRlcikgY29uc3RhbnQgcHVibGljIHJldHVybnMgKHVpbnQ2NCBkYXRlKSB7CiAgICBkYXRlID0gdWludDY0KG5vdyk7CiAgICB1aW50MjU2IGdyYW50SW5kZXggPSBncmFudHNbaG9sZGVyXS5sZW5ndGg7CiAgICBmb3IgKHVpbnQyNTYgaSA9IDA7IGkgPCBncmFudEluZGV4OyBpKyspIHsKICAgICAgICBkYXRlID0gTWF0aC5tYXg2NChncmFudHNbaG9sZGVyXVtpXS52ZXN0aW5nLCBkYXRlKTsKICAgIH0KICAgIH0KCn0KCi8qKgogKiBEaXZpZGVuZHMKICogQ29weXJpZ2h0IDIwMTgsIEtvbnN0YW50aW4gVmlrdG9yb3YgKEVzY3Jvd0Jsb2NrIEZvdW5kYXRpb24pCiAqIENvcHlyaWdodCAyMDE3LCBBZGFtIERvc3NhCiAqIEJhc2VkIG9uIFByb2ZpdFNoYXJpbmdDb250cmFjdC5zb2wgZnJvbSBodHRwczovL2dpdGh1Yi5jb20vYWRhbWRvc3NhL1Byb2ZpdFNoYXJpbmdDb250cmFjdAogKiovCgpjb250cmFjdCBNaW5pTWVJcnJWZXNEaXZUb2tlbiBpcyBNaW5pTWVJcnJldm9jYWJsZVZlc3RlZFRva2VuIHsKCiAgICBldmVudCBEaXZpZGVuZERlcG9zaXRlZChhZGRyZXNzIGluZGV4ZWQgX2RlcG9zaXRvciwgdWludDI1NiBfYmxvY2tOdW1iZXIsIHVpbnQyNTYgX3RpbWVzdGFtcCwgdWludDI1NiBfYW1vdW50LCB1aW50MjU2IF90b3RhbFN1cHBseSwgdWludDI1NiBfZGl2aWRlbmRJbmRleCk7CiAgICBldmVudCBEaXZpZGVuZENsYWltZWQoYWRkcmVzcyBpbmRleGVkIF9jbGFpbWVyLCB1aW50MjU2IF9kaXZpZGVuZEluZGV4LCB1aW50MjU2IF9jbGFpbSk7CiAgICBldmVudCBEaXZpZGVuZFJlY3ljbGVkKGFkZHJlc3MgaW5kZXhlZCBfcmVjeWNsZXIsIHVpbnQyNTYgX2Jsb2NrTnVtYmVyLCB1aW50MjU2IF90aW1lc3RhbXAsIHVpbnQyNTYgX2Ftb3VudCwgdWludDI1NiBfdG90YWxTdXBwbHksIHVpbnQyNTYgX2RpdmlkZW5kSW5kZXgpOwoKICAgIHVpbnQyNTYgcHVibGljIFJFQ1lDTEVfVElNRSA9IDEgeWVhcnM7CgogICAgZnVuY3Rpb24gTWluaU1lSXJyVmVzRGl2VG9rZW4gKAogICAgICAgICBhZGRyZXNzIF90b2tlbkZhY3RvcnksCiAgICAgICAgIGFkZHJlc3MgX3BhcmVudFRva2VuLAogICAgICAgICB1aW50IF9wYXJlbnRTbmFwU2hvdEJsb2NrLAogICAgICAgICBzdHJpbmcgX3Rva2VuTmFtZSwKICAgICAgICAgdWludDggX2RlY2ltYWxVbml0cywKICAgICAgICAgc3RyaW5nIF90b2tlblN5bWJvbCwKICAgICAgICAgYm9vbCBfdHJhbnNmZXJzRW5hYmxlZAogICAgKSBwdWJsaWMgTWluaU1lSXJyZXZvY2FibGVWZXN0ZWRUb2tlbihfdG9rZW5GYWN0b3J5LCBfcGFyZW50VG9rZW4sIF9wYXJlbnRTbmFwU2hvdEJsb2NrLCBfdG9rZW5OYW1lLCBfZGVjaW1hbFVuaXRzLCBfdG9rZW5TeW1ib2wsIF90cmFuc2ZlcnNFbmFibGVkKSB7fQoKICAgIHN0cnVjdCBEaXZpZGVuZCB7CiAgICB1aW50MjU2IGJsb2NrTnVtYmVyOwogICAgdWludDI1NiB0aW1lc3RhbXA7CiAgICB1aW50MjU2IGFtb3VudDsKICAgIHVpbnQyNTYgY2xhaW1lZEFtb3VudDsKICAgIHVpbnQyNTYgdG90YWxTdXBwbHk7CiAgICBib29sIHJlY3ljbGVkOwogICAgbWFwcGluZyAoYWRkcmVzcyA9PiBib29sKSBjbGFpbWVkOwogICAgfQoKICAgIERpdmlkZW5kW10gcHVibGljIGRpdmlkZW5kczsKCiAgICBtYXBwaW5nIChhZGRyZXNzID0+IHVpbnQyNTYpIGRpdmlkZW5kc0NsYWltZWQ7CgogICAgbW9kaWZpZXIgdmFsaWREaXZpZGVuZEluZGV4KHVpbnQyNTYgX2RpdmlkZW5kSW5kZXgpIHsKICAgIHJlcXVpcmUoX2RpdmlkZW5kSW5kZXggPCBkaXZpZGVuZHMubGVuZ3RoKTsKICAgIF87CiAgICB9CgogICAgZnVuY3Rpb24gZGVwb3NpdERpdmlkZW5kKCkgcHVibGljIHBheWFibGUKICAgIG9ubHlDb250cm9sbGVyCiAgICB7CiAgICB1aW50MjU2IGN1cnJlbnRTdXBwbHkgPSBzdXBlci50b3RhbFN1cHBseUF0KGJsb2NrLm51bWJlcik7CiAgICB1aW50MjU2IGRpdmlkZW5kSW5kZXggPSBkaXZpZGVuZHMubGVuZ3RoOwogICAgdWludDI1NiBibG9ja051bWJlciA9IFNhZmVNYXRoLnN1YihibG9jay5udW1iZXIsIDEpOwogICAgZGl2aWRlbmRzLnB1c2goCiAgICAgICAgIERpdmlkZW5kKAogICAgICAgICBibG9ja051bWJlciwKICAgICAgICAgZ2V0Tm93KCksCiAgICAgICAgIG1zZy52YWx1ZSwKICAgICAgICAgMCwKICAgICAgICAgY3VycmVudFN1cHBseSwKICAgICAgICAgZmFsc2UKICAgICAgICAgKQogICAgKTsKICAgIERpdmlkZW5kRGVwb3NpdGVkKG1zZy5zZW5kZXIsIGJsb2NrTnVtYmVyLCBnZXROb3coKSwgbXNnLnZhbHVlLCBjdXJyZW50U3VwcGx5LCBkaXZpZGVuZEluZGV4KTsKICAgIH0KCiAgICBmdW5jdGlvbiBjbGFpbURpdmlkZW5kKHVpbnQyNTYgX2RpdmlkZW5kSW5kZXgpIHB1YmxpYwogICAgdmFsaWREaXZpZGVuZEluZGV4KF9kaXZpZGVuZEluZGV4KQogICAgewogICAgRGl2aWRlbmQgc3RvcmFnZSBkaXZpZGVuZCA9IGRpdmlkZW5kc1tfZGl2aWRlbmRJbmRleF07CiAgICByZXF1aXJlKGRpdmlkZW5kLmNsYWltZWRbbXNnLnNlbmRlcl0gPT0gZmFsc2UpOwogICAgcmVxdWlyZShkaXZpZGVuZC5yZWN5Y2xlZCA9PSBmYWxzZSk7CiAgICB1aW50MjU2IGJhbGFuY2UgPSBzdXBlci5iYWxhbmNlT2ZBdChtc2cuc2VuZGVyLCBkaXZpZGVuZC5ibG9ja051bWJlcik7CiAgICB1aW50MjU2IGNsYWltID0gYmFsYW5jZS5tdWwoZGl2aWRlbmQuYW1vdW50KS5kaXYoZGl2aWRlbmQudG90YWxTdXBwbHkpOwogICAgZGl2aWRlbmQuY2xhaW1lZFttc2cuc2VuZGVyXSA9IHRydWU7CiAgICBkaXZpZGVuZC5jbGFpbWVkQW1vdW50ID0gU2FmZU1hdGguYWRkKGRpdmlkZW5kLmNsYWltZWRBbW91bnQsIGNsYWltKTsKICAgIGlmIChjbGFpbSA+IDApIHsKICAgICAgICAgbXNnLnNlbmRlci50cmFuc2ZlcihjbGFpbSk7CiAgICAgICAgIERpdmlkZW5kQ2xhaW1lZChtc2cuc2VuZGVyLCBfZGl2aWRlbmRJbmRleCwgY2xhaW0pOwogICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGNsYWltRGl2aWRlbmRBbGwoKSBwdWJsaWMgewogICAgcmVxdWlyZShkaXZpZGVuZHNDbGFpbWVkW21zZy5zZW5kZXJdIDwgZGl2aWRlbmRzLmxlbmd0aCk7CiAgICBmb3IgKHVpbnQgaSA9IGRpdmlkZW5kc0NsYWltZWRbbXNnLnNlbmRlcl07IGkgPCBkaXZpZGVuZHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgaWYgKChkaXZpZGVuZHNbaV0uY2xhaW1lZFttc2cuc2VuZGVyXSA9PSBmYWxzZSkgJiYgKGRpdmlkZW5kc1tpXS5yZWN5Y2xlZCA9PSBmYWxzZSkpIHsKICAgICAgICAgZGl2aWRlbmRzQ2xhaW1lZFttc2cuc2VuZGVyXSA9IFNhZmVNYXRoLmFkZChpLCAxKTsKICAgICAgICAgY2xhaW1EaXZpZGVuZChpKTsKICAgICAgICAgfQogICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIHJlY3ljbGVEaXZpZGVuZCh1aW50MjU2IF9kaXZpZGVuZEluZGV4KSBwdWJsaWMKICAgIG9ubHlDb250cm9sbGVyCiAgICB2YWxpZERpdmlkZW5kSW5kZXgoX2RpdmlkZW5kSW5kZXgpCiAgICB7CiAgICBEaXZpZGVuZCBzdG9yYWdlIGRpdmlkZW5kID0gZGl2aWRlbmRzW19kaXZpZGVuZEluZGV4XTsKICAgIHJlcXVpcmUoZGl2aWRlbmQucmVjeWNsZWQgPT0gZmFsc2UpOwogICAgcmVxdWlyZShkaXZpZGVuZC50aW1lc3RhbXAgPCBTYWZlTWF0aC5zdWIoZ2V0Tm93KCksIFJFQ1lDTEVfVElNRSkpOwogICAgZGl2aWRlbmRzW19kaXZpZGVuZEluZGV4XS5yZWN5Y2xlZCA9IHRydWU7CiAgICB1aW50MjU2IGN1cnJlbnRTdXBwbHkgPSBzdXBlci50b3RhbFN1cHBseUF0KGJsb2NrLm51bWJlcik7CiAgICB1aW50MjU2IHJlbWFpbmluZ0Ftb3VudCA9IFNhZmVNYXRoLnN1YihkaXZpZGVuZC5hbW91bnQsIGRpdmlkZW5kLmNsYWltZWRBbW91bnQpOwogICAgdWludDI1NiBkaXZpZGVuZEluZGV4ID0gZGl2aWRlbmRzLmxlbmd0aDsKICAgIHVpbnQyNTYgYmxvY2tOdW1iZXIgPSBTYWZlTWF0aC5zdWIoYmxvY2subnVtYmVyLCAxKTsKICAgIGRpdmlkZW5kcy5wdXNoKAogICAgICAgICBEaXZpZGVuZCgKICAgICAgICAgYmxvY2tOdW1iZXIsCiAgICAgICAgIGdldE5vdygpLAogICAgICAgICByZW1haW5pbmdBbW91bnQsCiAgICAgICAgIDAsCiAgICAgICAgIGN1cnJlbnRTdXBwbHksCiAgICAgICAgIGZhbHNlCiAgICAgICAgICkKICAgICk7CiAgICBEaXZpZGVuZFJlY3ljbGVkKG1zZy5zZW5kZXIsIGJsb2NrTnVtYmVyLCBnZXROb3coKSwgcmVtYWluaW5nQW1vdW50LCBjdXJyZW50U3VwcGx5LCBkaXZpZGVuZEluZGV4KTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXROb3coKSBpbnRlcm5hbCBjb25zdGFudCByZXR1cm5zICh1aW50MjU2KSB7CiAgICByZXR1cm4gbm93OwogICAgfQp9CgovKioKICogQ29weXJpZ2h0IDIwMTgsIEtvbnN0YW50aW4gVmlrdG9yb3YgKEVzY3Jvd0Jsb2NrIEZvdW5kYXRpb24pCiAqKi8KCmNvbnRyYWN0IEVTQ0JDb2luIGlzIE1pbmlNZUlyclZlc0RpdlRva2VuIHsKICAvLyBAZGV2IEVTQ0JDb2luIGNvbnN0cnVjdG9yIGp1c3QgcGFyYW1ldHJpemVzIHRoZSBNaW5pTWVJcnJWZXNEaXZUb2tlbiBjb25zdHJ1Y3RvcgogIGZ1bmN0aW9uIEVTQ0JDb2luICgKICAgIGFkZHJlc3MgX3Rva2VuRmFjdG9yeQogICkgcHVibGljIE1pbmlNZUlyclZlc0RpdlRva2VuKAogICAgX3Rva2VuRmFjdG9yeSwKICAgIDB4MCwgICAgICAgICAgICAvLyBubyBwYXJlbnQgdG9rZW4KICAgIDAsICAgICAgICAgICAgICAvLyBubyBzbmFwc2hvdCBibG9jayBudW1iZXIgZnJvbSBwYXJlbnQKICAgICJFU0NCIHRva2VuIiwgICAvLyBUb2tlbiBuYW1lCiAgICAxOCwgICAgICAgICAgICAgLy8gRGVjaW1hbHMKICAgICJFU0NCIiwgICAgICAgICAvLyBTeW1ib2wKICAgIHRydWUgICAgICAgICAgICAvLyBFbmFibGUgdHJhbnNmZXJzCiAgICApIHt9Cn0='.
	

]
