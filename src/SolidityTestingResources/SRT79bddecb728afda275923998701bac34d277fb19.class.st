Class {
	#name : #SRT79bddecb728afda275923998701bac34d277fb19,
	#superclass : #SRTContracts,
	#category : #SolidityTestingResources
}

{ #category : #base64 }
SRT79bddecb728afda275923998701bac34d277fb19 >> base64 [
	^ 'Ly9GaWxlOiBub2RlX21vZHVsZXMvZ2l2ZXRoLWxpcXVpZHBsZWRnaW5nL2NvbnRyYWN0cy9JTGlxdWlkUGxlZGdpbmdQbHVnaW4uc29sCnByYWdtYSBzb2xpZGl0eSBeMC40LjExOwoKLyoKICAgIENvcHlyaWdodCAyMDE3LCBKb3JkaSBCYXlsaW5hCiAgICBDb250cmlidXRvcnM6IEFkcmkmIzIyNDsgTWFzc2FuZXQgPDxzcGFuIGNsYXNzPSJfX2NmX2VtYWlsX18iIGRhdGEtY2ZlbWFpbD0iZTc4NjgzOTU4ZTg2YTc4NDg4ODM4Mjg0ODg4OTkzODI5ZjkzYzk4ZTg4Ij5bZW1haWwmIzE2MDtwcm90ZWN0ZWRdPC9zcGFuPj4sIFJKIEV3aW5nLCBHcmlmZgogICAgR3JlZW4sIEFydGh1ciBMdW5uCgogICAgVGhpcyBwcm9ncmFtIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnkKICAgIGl0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXMgcHVibGlzaGVkIGJ5CiAgICB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uLCBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLCBvcgogICAgKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi4KCiAgICBUaGlzIHByb2dyYW0gaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCwKICAgIGJ1dCBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dCBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mCiAgICBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlCiAgICBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLgoKICAgIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlCiAgICBhbG9uZyB3aXRoIHRoaXMgcHJvZ3JhbS4gIElmIG5vdCwgc2VlIDxodHRwOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvPi4KKi8KCgovLy8gQGRldiBgSUxpcXVpZFBsZWRnaW5nUGx1Z2luYCBpcyB0aGUgYmFzaWMgaW50ZXJmYWNlIGZvciBhbnkKLy8vICBsaXF1aWQgcGxlZGdpbmcgcGx1Z2luCmNvbnRyYWN0IElMaXF1aWRQbGVkZ2luZ1BsdWdpbiB7CgogICAgLy8vIEBub3RpY2UgUGx1Z2lucyBhcmUgdXNlZCAobXVjaCBsaWtlIHdlYiBob29rcykgdG8gaW5pdGlhdGUgYW4gYWN0aW9uCiAgICAvLy8gIHVwb24gYW55IGRvbmF0aW9uLCBkZWxlZ2F0aW9uLCBvciB0cmFuc2ZlcjsgdGhpcyBpcyBhbiBvcHRpb25hbCBmZWF0dXJlCiAgICAvLy8gIGFuZCBhbGxvd3MgZm9yIGV4dHJlbWUgY3VzdG9taXphdGlvbiBvZiB0aGUgY29udHJhY3QuIFRoaXMgZnVuY3Rpb24KICAgIC8vLyAgaW1wbGVtZW50cyBhbnkgYWN0aW9uIHRoYXQgc2hvdWxkIGJlIGluaXRpYXRlZCBiZWZvcmUgYSB0cmFuc2Zlci4KICAgIC8vLyBAcGFyYW0gcGxlZGdlTWFuYWdlciBUaGUgYWRtaW4gb3IgY3VycmVudCBtYW5hZ2VyIG9mIHRoZSBwbGVkZ2UKICAgIC8vLyBAcGFyYW0gcGxlZGdlRnJvbSBUaGlzIGlzIHRoZSBJZCBmcm9tIHdoaWNoIHZhbHVlIHdpbGwgYmUgdHJhbnNmZXJlZC4KICAgIC8vLyBAcGFyYW0gcGxlZGdlVG8gVGhpcyBpcyB0aGUgSWQgdGhhdCB2YWx1ZSB3aWxsIGJlIHRyYW5zZmVyZWQgdG8uICAgIAogICAgLy8vIEBwYXJhbSBjb250ZXh0IFRoZSBzaXR1YXRpb24gdGhhdCBpcyB0cmlnZ2VyaW5nIHRoZSBwbHVnaW46CiAgICAvLy8gIDAgLT4gUGx1Z2luIGZvciB0aGUgb3duZXIgdHJhbnNmZXJyaW5nIHBsZWRnZSB0byBhbm90aGVyIHBhcnR5CiAgICAvLy8gIDEgLT4gUGx1Z2luIGZvciB0aGUgZmlyc3QgZGVsZWdhdGUgdHJhbnNmZXJyaW5nIHBsZWRnZSB0byBhbm90aGVyIHBhcnR5CiAgICAvLy8gIDIgLT4gUGx1Z2luIGZvciB0aGUgc2Vjb25kIGRlbGVnYXRlIHRyYW5zZmVycmluZyBwbGVkZ2UgdG8gYW5vdGhlciBwYXJ0eQogICAgLy8vICAuLi4KICAgIC8vLyAgMjU1IC0+IFBsdWdpbiBmb3IgdGhlIGludGVuZGVkUHJvamVjdCB0cmFuc2ZlcnJpbmcgcGxlZGdlIHRvIGFub3RoZXIgcGFydHkKICAgIC8vLwogICAgLy8vICAyNTYgLT4gUGx1Z2luIGZvciB0aGUgb3duZXIgcmVjZWl2aW5nIHBsZWRnZSB0byBhbm90aGVyIHBhcnR5CiAgICAvLy8gIDI1NyAtPiBQbHVnaW4gZm9yIHRoZSBmaXJzdCBkZWxlZ2F0ZSByZWNlaXZpbmcgcGxlZGdlIHRvIGFub3RoZXIgcGFydHkKICAgIC8vLyAgMjU4IC0+IFBsdWdpbiBmb3IgdGhlIHNlY29uZCBkZWxlZ2F0ZSByZWNlaXZpbmcgcGxlZGdlIHRvIGFub3RoZXIgcGFydHkKICAgIC8vLyAgLi4uCiAgICAvLy8gIDUxMSAtPiBQbHVnaW4gZm9yIHRoZSBpbnRlbmRlZFByb2plY3QgcmVjZWl2aW5nIHBsZWRnZSB0byBhbm90aGVyIHBhcnR5CiAgICAvLy8gQHBhcmFtIGFtb3VudCBUaGUgYW1vdW50IG9mIHZhbHVlIHRoYXQgd2lsbCBiZSB0cmFuc2ZlcmVkLgogICAgZnVuY3Rpb24gYmVmb3JlVHJhbnNmZXIoCiAgICAgICAgdWludDY0IHBsZWRnZU1hbmFnZXIsCiAgICAgICAgdWludDY0IHBsZWRnZUZyb20sCiAgICAgICAgdWludDY0IHBsZWRnZVRvLAogICAgICAgIHVpbnQ2NCBjb250ZXh0LAogICAgICAgIHVpbnQgYW1vdW50ICkgcmV0dXJucyAodWludCBtYXhBbGxvd2VkKTsKCiAgICAvLy8gQG5vdGljZSBQbHVnaW5zIGFyZSB1c2VkIChtdWNoIGxpa2Ugd2ViIGhvb2tzKSB0byBpbml0aWF0ZSBhbiBhY3Rpb24KICAgIC8vLyAgdXBvbiBhbnkgZG9uYXRpb24sIGRlbGVnYXRpb24sIG9yIHRyYW5zZmVyOyB0aGlzIGlzIGFuIG9wdGlvbmFsIGZlYXR1cmUKICAgIC8vLyAgYW5kIGFsbG93cyBmb3IgZXh0cmVtZSBjdXN0b21pemF0aW9uIG9mIHRoZSBjb250cmFjdC4gVGhpcyBmdW5jdGlvbgogICAgLy8vICBpbXBsZW1lbnRzIGFueSBhY3Rpb24gdGhhdCBzaG91bGQgYmUgaW5pdGlhdGVkIGFmdGVyIGEgdHJhbnNmZXIuCiAgICAvLy8gQHBhcmFtIHBsZWRnZU1hbmFnZXIgVGhlIGFkbWluIG9yIGN1cnJlbnQgbWFuYWdlciBvZiB0aGUgcGxlZGdlCiAgICAvLy8gQHBhcmFtIHBsZWRnZUZyb20gVGhpcyBpcyB0aGUgSWQgZnJvbSB3aGljaCB2YWx1ZSB3aWxsIGJlIHRyYW5zZmVyZWQuCiAgICAvLy8gQHBhcmFtIHBsZWRnZVRvIFRoaXMgaXMgdGhlIElkIHRoYXQgdmFsdWUgd2lsbCBiZSB0cmFuc2ZlcmVkIHRvLiAgICAKICAgIC8vLyBAcGFyYW0gY29udGV4dCBUaGUgc2l0dWF0aW9uIHRoYXQgaXMgdHJpZ2dlcmluZyB0aGUgcGx1Z2luOgogICAgLy8vICAwIC0+IFBsdWdpbiBmb3IgdGhlIG93bmVyIHRyYW5zZmVycmluZyBwbGVkZ2UgdG8gYW5vdGhlciBwYXJ0eQogICAgLy8vICAxIC0+IFBsdWdpbiBmb3IgdGhlIGZpcnN0IGRlbGVnYXRlIHRyYW5zZmVycmluZyBwbGVkZ2UgdG8gYW5vdGhlciBwYXJ0eQogICAgLy8vICAyIC0+IFBsdWdpbiBmb3IgdGhlIHNlY29uZCBkZWxlZ2F0ZSB0cmFuc2ZlcnJpbmcgcGxlZGdlIHRvIGFub3RoZXIgcGFydHkKICAgIC8vLyAgLi4uCiAgICAvLy8gIDI1NSAtPiBQbHVnaW4gZm9yIHRoZSBpbnRlbmRlZFByb2plY3QgdHJhbnNmZXJyaW5nIHBsZWRnZSB0byBhbm90aGVyIHBhcnR5CiAgICAvLy8KICAgIC8vLyAgMjU2IC0+IFBsdWdpbiBmb3IgdGhlIG93bmVyIHJlY2VpdmluZyBwbGVkZ2UgdG8gYW5vdGhlciBwYXJ0eQogICAgLy8vICAyNTcgLT4gUGx1Z2luIGZvciB0aGUgZmlyc3QgZGVsZWdhdGUgcmVjZWl2aW5nIHBsZWRnZSB0byBhbm90aGVyIHBhcnR5CiAgICAvLy8gIDI1OCAtPiBQbHVnaW4gZm9yIHRoZSBzZWNvbmQgZGVsZWdhdGUgcmVjZWl2aW5nIHBsZWRnZSB0byBhbm90aGVyIHBhcnR5CiAgICAvLy8gIC4uLgogICAgLy8vICA1MTEgLT4gUGx1Z2luIGZvciB0aGUgaW50ZW5kZWRQcm9qZWN0IHJlY2VpdmluZyBwbGVkZ2UgdG8gYW5vdGhlciBwYXJ0eQogICAgLy8vICBAcGFyYW0gYW1vdW50IFRoZSBhbW91bnQgb2YgdmFsdWUgdGhhdCB3aWxsIGJlIHRyYW5zZmVyZWQuCiAgICBmdW5jdGlvbiBhZnRlclRyYW5zZmVyKAogICAgICAgIHVpbnQ2NCBwbGVkZ2VNYW5hZ2VyLAogICAgICAgIHVpbnQ2NCBwbGVkZ2VGcm9tLAogICAgICAgIHVpbnQ2NCBwbGVkZ2VUbywKICAgICAgICB1aW50NjQgY29udGV4dCwKICAgICAgICB1aW50IGFtb3VudAogICAgKTsKfQoKLy9GaWxlOiBub2RlX21vZHVsZXMvZ2l2ZXRoLWNvbW1vbi1jb250cmFjdHMvY29udHJhY3RzL093bmVkLnNvbApwcmFnbWEgc29saWRpdHkgXjAuNC4xNTsKCgovLy8gQHRpdGxlIE93bmVkCi8vLyBAYXV0aG9yIEFkcmkmIzIyNDsgTWFzc2FuZXQgPDxzcGFuIGNsYXNzPSJfX2NmX2VtYWlsX18iIGRhdGEtY2ZlbWFpbD0iOGJlYWVmZjllMmVhY2JlOGU0ZWZlZWU4ZTRlNWZmZWVmM2ZmYTVlMmU0Ij5bZW1haWwmIzE2MDtwcm90ZWN0ZWRdPC9zcGFuPj4KLy8vIEBub3RpY2UgVGhlIE93bmVkIGNvbnRyYWN0IGhhcyBhbiBvd25lciBhZGRyZXNzLCBhbmQgcHJvdmlkZXMgYmFzaWMgCi8vLyAgYXV0aG9yaXphdGlvbiBjb250cm9sIGZ1bmN0aW9ucywgdGhpcyBzaW1wbGlmaWVzICYgdGhlIGltcGxlbWVudGF0aW9uIG9mCi8vLyAgdXNlciBwZXJtaXNzaW9uczsgdGhpcyBjb250cmFjdCBoYXMgdGhyZWUgd29yayBmbG93cyBmb3IgYSBjaGFuZ2UgaW4KLy8vICBvd25lcnNoaXAsIHRoZSBmaXJzdCByZXF1aXJlcyB0aGUgbmV3IG93bmVyIHRvIHZhbGlkYXRlIHRoYXQgdGhleSBoYXZlIHRoZQovLy8gIGFiaWxpdHkgdG8gYWNjZXB0IG93bmVyc2hpcCwgdGhlIHNlY29uZCBhbGxvd3MgdGhlIG93bmVyc2hpcCB0byBiZQovLy8gIGRpcmVjdGx5IHRyYW5zZmVyZWQgd2l0aG91dCByZXF1aXJpbmcgYWNjZXB0YW5jZSwgYW5kIHRoZSB0aGlyZCBhbGxvd3MgZm9yCi8vLyAgdGhlIG93bmVyc2hpcCB0byBiZSByZW1vdmVkIHRvIGFsbG93IGZvciBkZWNlbnRyYWxpemF0aW9uIApjb250cmFjdCBPd25lZCB7CgogICAgYWRkcmVzcyBwdWJsaWMgb3duZXI7CiAgICBhZGRyZXNzIHB1YmxpYyBuZXdPd25lckNhbmRpZGF0ZTsKCiAgICBldmVudCBPd25lcnNoaXBSZXF1ZXN0ZWQoYWRkcmVzcyBpbmRleGVkIGJ5LCBhZGRyZXNzIGluZGV4ZWQgdG8pOwogICAgZXZlbnQgT3duZXJzaGlwVHJhbnNmZXJyZWQoYWRkcmVzcyBpbmRleGVkIGZyb20sIGFkZHJlc3MgaW5kZXhlZCB0byk7CiAgICBldmVudCBPd25lcnNoaXBSZW1vdmVkKCk7CgogICAgLy8vIEBkZXYgVGhlIGNvbnN0cnVjdG9yIHNldHMgdGhlIGBtc2cuc2VuZGVyYCBhcyB0aGVgb3duZXJgIG9mIHRoZSBjb250cmFjdAogICAgZnVuY3Rpb24gT3duZWQoKSBwdWJsaWMgewogICAgICAgIG93bmVyID0gbXNnLnNlbmRlcjsKICAgIH0KCiAgICAvLy8gQGRldiBgb3duZXJgIGlzIHRoZSBvbmx5IGFkZHJlc3MgdGhhdCBjYW4gY2FsbCBhIGZ1bmN0aW9uIHdpdGggdGhpcwogICAgLy8vIG1vZGlmaWVyCiAgICBtb2RpZmllciBvbmx5T3duZXIoKSB7CiAgICAgICAgcmVxdWlyZSAobXNnLnNlbmRlciA9PSBvd25lcik7CiAgICAgICAgXzsKICAgIH0KICAgIAogICAgLy8vIEBkZXYgSW4gdGhpcyAxc3Qgb3B0aW9uIGZvciBvd25lcnNoaXAgdHJhbnNmZXIgYHByb3Bvc2VPd25lcnNoaXAoKWAgbXVzdAogICAgLy8vICBiZSBjYWxsZWQgZmlyc3QgYnkgdGhlIGN1cnJlbnQgYG93bmVyYCB0aGVuIGBhY2NlcHRPd25lcnNoaXAoKWAgbXVzdCBiZQogICAgLy8vICBjYWxsZWQgYnkgdGhlIGBuZXdPd25lckNhbmRpZGF0ZWAKICAgIC8vLyBAbm90aWNlIGBvbmx5T3duZXJgIFByb3Bvc2VzIHRvIHRyYW5zZmVyIGNvbnRyb2wgb2YgdGhlIGNvbnRyYWN0IHRvIGEKICAgIC8vLyAgbmV3IG93bmVyCiAgICAvLy8gQHBhcmFtIF9uZXdPd25lckNhbmRpZGF0ZSBUaGUgYWRkcmVzcyBiZWluZyBwcm9wb3NlZCBhcyB0aGUgbmV3IG93bmVyCiAgICBmdW5jdGlvbiBwcm9wb3NlT3duZXJzaGlwKGFkZHJlc3MgX25ld093bmVyQ2FuZGlkYXRlKSBwdWJsaWMgb25seU93bmVyIHsKICAgICAgICBuZXdPd25lckNhbmRpZGF0ZSA9IF9uZXdPd25lckNhbmRpZGF0ZTsKICAgICAgICBPd25lcnNoaXBSZXF1ZXN0ZWQobXNnLnNlbmRlciwgbmV3T3duZXJDYW5kaWRhdGUpOwogICAgfQoKICAgIC8vLyBAbm90aWNlIENhbiBvbmx5IGJlIGNhbGxlZCBieSB0aGUgYG5ld093bmVyQ2FuZGlkYXRlYCwgYWNjZXB0cyB0aGUKICAgIC8vLyAgdHJhbnNmZXIgb2Ygb3duZXJzaGlwCiAgICBmdW5jdGlvbiBhY2NlcHRPd25lcnNoaXAoKSBwdWJsaWMgewogICAgICAgIHJlcXVpcmUobXNnLnNlbmRlciA9PSBuZXdPd25lckNhbmRpZGF0ZSk7CgogICAgICAgIGFkZHJlc3Mgb2xkT3duZXIgPSBvd25lcjsKICAgICAgICBvd25lciA9IG5ld093bmVyQ2FuZGlkYXRlOwogICAgICAgIG5ld093bmVyQ2FuZGlkYXRlID0gMHgwOwoKICAgICAgICBPd25lcnNoaXBUcmFuc2ZlcnJlZChvbGRPd25lciwgb3duZXIpOwogICAgfQoKICAgIC8vLyBAZGV2IEluIHRoaXMgMm5kIG9wdGlvbiBmb3Igb3duZXJzaGlwIHRyYW5zZmVyIGBjaGFuZ2VPd25lcnNoaXAoKWAgY2FuCiAgICAvLy8gIGJlIGNhbGxlZCBhbmQgaXQgd2lsbCBpbW1lZGlhdGVseSBhc3NpZ24gb3duZXJzaGlwIHRvIHRoZSBgbmV3T3duZXJgCiAgICAvLy8gQG5vdGljZSBgb3duZXJgIGNhbiBzdGVwIGRvd24gYW5kIGFzc2lnbiBzb21lIG90aGVyIGFkZHJlc3MgdG8gdGhpcyByb2xlCiAgICAvLy8gQHBhcmFtIF9uZXdPd25lciBUaGUgYWRkcmVzcyBvZiB0aGUgbmV3IG93bmVyCiAgICBmdW5jdGlvbiBjaGFuZ2VPd25lcnNoaXAoYWRkcmVzcyBfbmV3T3duZXIpIHB1YmxpYyBvbmx5T3duZXIgewogICAgICAgIHJlcXVpcmUoX25ld093bmVyICE9IDB4MCk7CgogICAgICAgIGFkZHJlc3Mgb2xkT3duZXIgPSBvd25lcjsKICAgICAgICBvd25lciA9IF9uZXdPd25lcjsKICAgICAgICBuZXdPd25lckNhbmRpZGF0ZSA9IDB4MDsKCiAgICAgICAgT3duZXJzaGlwVHJhbnNmZXJyZWQob2xkT3duZXIsIG93bmVyKTsKICAgIH0KCiAgICAvLy8gQGRldiBJbiB0aGlzIDNyZCBvcHRpb24gZm9yIG93bmVyc2hpcCB0cmFuc2ZlciBgcmVtb3ZlT3duZXJzaGlwKClgIGNhbgogICAgLy8vICBiZSBjYWxsZWQgYW5kIGl0IHdpbGwgaW1tZWRpYXRlbHkgYXNzaWduIG93bmVyc2hpcCB0byB0aGUgMHgwIGFkZHJlc3M7CiAgICAvLy8gIGl0IHJlcXVpcmVzIGEgMHhkZWNlIGJlIGlucHV0IGFzIGEgcGFyYW1ldGVyIHRvIHByZXZlbnQgYWNjaWRlbnRhbCB1c2UKICAgIC8vLyBAbm90aWNlIERlY2VudHJhbGl6ZXMgdGhlIGNvbnRyYWN0LCB0aGlzIG9wZXJhdGlvbiBjYW5ub3QgYmUgdW5kb25lIAogICAgLy8vIEBwYXJhbSBfZGFjIGAweGRhY2AgaGFzIHRvIGJlIGVudGVyZWQgZm9yIHRoaXMgZnVuY3Rpb24gdG8gd29yawogICAgZnVuY3Rpb24gcmVtb3ZlT3duZXJzaGlwKGFkZHJlc3MgX2RhYykgcHVibGljIG9ubHlPd25lciB7CiAgICAgICAgcmVxdWlyZShfZGFjID09IDB4ZGFjKTsKICAgICAgICBvd25lciA9IDB4MDsKICAgICAgICBuZXdPd25lckNhbmRpZGF0ZSA9IDB4MDsKICAgICAgICBPd25lcnNoaXBSZW1vdmVkKCk7ICAgICAKICAgIH0KfSAKCi8vRmlsZTogbm9kZV9tb2R1bGVzL2dpdmV0aC1jb21tb24tY29udHJhY3RzL2NvbnRyYWN0cy9FUkMyMC5zb2wKcHJhZ21hIHNvbGlkaXR5IF4wLjQuMTU7CgoKLyoqCiAqIEB0aXRsZSBFUkMyMAogKiBAZGV2IEEgc3RhbmRhcmQgaW50ZXJmYWNlIGZvciB0b2tlbnMuCiAqIEBkZXYgaHR0cHM6Ly9naXRodWIuY29tL2V0aGVyZXVtL0VJUHMvYmxvYi9tYXN0ZXIvRUlQUy9laXAtMjAtdG9rZW4tc3RhbmRhcmQubWQKICovCmNvbnRyYWN0IEVSQzIwIHsKICAKICAgIC8vLyBAZGV2IFJldHVybnMgdGhlIHRvdGFsIHRva2VuIHN1cHBseQogICAgZnVuY3Rpb24gdG90YWxTdXBwbHkoKSBwdWJsaWMgY29uc3RhbnQgcmV0dXJucyAodWludDI1NiBzdXBwbHkpOwoKICAgIC8vLyBAZGV2IFJldHVybnMgdGhlIGFjY291bnQgYmFsYW5jZSBvZiB0aGUgYWNjb3VudCB3aXRoIGFkZHJlc3MgX293bmVyCiAgICBmdW5jdGlvbiBiYWxhbmNlT2YoYWRkcmVzcyBfb3duZXIpIHB1YmxpYyBjb25zdGFudCByZXR1cm5zICh1aW50MjU2IGJhbGFuY2UpOwoKICAgIC8vLyBAZGV2IFRyYW5zZmVycyBfdmFsdWUgbnVtYmVyIG9mIHRva2VucyB0byBhZGRyZXNzIF90bwogICAgZnVuY3Rpb24gdHJhbnNmZXIoYWRkcmVzcyBfdG8sIHVpbnQyNTYgX3ZhbHVlKSBwdWJsaWMgcmV0dXJucyAoYm9vbCBzdWNjZXNzKTsKCiAgICAvLy8gQGRldiBUcmFuc2ZlcnMgX3ZhbHVlIG51bWJlciBvZiB0b2tlbnMgZnJvbSBhZGRyZXNzIF9mcm9tIHRvIGFkZHJlc3MgX3RvCiAgICBmdW5jdGlvbiB0cmFuc2ZlckZyb20oYWRkcmVzcyBfZnJvbSwgYWRkcmVzcyBfdG8sIHVpbnQyNTYgX3ZhbHVlKSBwdWJsaWMgcmV0dXJucyAoYm9vbCBzdWNjZXNzKTsKCiAgICAvLy8gQGRldiBBbGxvd3MgX3NwZW5kZXIgdG8gd2l0aGRyYXcgZnJvbSB0aGUgbXNnLnNlbmRlcidzIGFjY291bnQgdXAgdG8gdGhlIF92YWx1ZSBhbW91bnQKICAgIGZ1bmN0aW9uIGFwcHJvdmUoYWRkcmVzcyBfc3BlbmRlciwgdWludDI1NiBfdmFsdWUpIHB1YmxpYyByZXR1cm5zIChib29sIHN1Y2Nlc3MpOwoKICAgIC8vLyBAZGV2IFJldHVybnMgdGhlIGFtb3VudCB3aGljaCBfc3BlbmRlciBpcyBzdGlsbCBhbGxvd2VkIHRvIHdpdGhkcmF3IGZyb20gX293bmVyCiAgICBmdW5jdGlvbiBhbGxvd2FuY2UoYWRkcmVzcyBfb3duZXIsIGFkZHJlc3MgX3NwZW5kZXIpIHB1YmxpYyBjb25zdGFudCByZXR1cm5zICh1aW50MjU2IHJlbWFpbmluZyk7CgogICAgZXZlbnQgVHJhbnNmZXIoYWRkcmVzcyBpbmRleGVkIF9mcm9tLCBhZGRyZXNzIGluZGV4ZWQgX3RvLCB1aW50MjU2IF92YWx1ZSk7CiAgICBldmVudCBBcHByb3ZhbChhZGRyZXNzIGluZGV4ZWQgX293bmVyLCBhZGRyZXNzIGluZGV4ZWQgX3NwZW5kZXIsIHVpbnQyNTYgX3ZhbHVlKTsKCn0KCi8vRmlsZTogbm9kZV9tb2R1bGVzL2dpdmV0aC1jb21tb24tY29udHJhY3RzL2NvbnRyYWN0cy9Fc2NhcGFibGUuc29sCnByYWdtYSBzb2xpZGl0eSBeMC40LjE1OwovKgogICAgQ29weXJpZ2h0IDIwMTYsIEpvcmRpIEJheWxpbmEKICAgIENvbnRyaWJ1dG9yOiBBZHJpJiMyMjQ7IE1hc3NhbmV0IDw8c3BhbiBjbGFzcz0iX19jZl9lbWFpbF9fIiBkYXRhLWNmZW1haWw9IjFlN2Y3YTZjNzc3ZjVlN2Q3MTdhN2I3ZDcxNzA2YTdiNjY2YTMwNzc3MSI+W2VtYWlsJiMxNjA7cHJvdGVjdGVkXTwvc3Bhbj4+CgogICAgVGhpcyBwcm9ncmFtIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnkKICAgIGl0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXMgcHVibGlzaGVkIGJ5CiAgICB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uLCBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLCBvcgogICAgKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi4KCiAgICBUaGlzIHByb2dyYW0gaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCwKICAgIGJ1dCBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dCBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mCiAgICBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlCiAgICBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLgoKICAgIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlCiAgICBhbG9uZyB3aXRoIHRoaXMgcHJvZ3JhbS4gIElmIG5vdCwgc2VlIDxodHRwOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvPi4KKi8KCgoKCgovLy8gQGRldiBgRXNjYXBhYmxlYCBpcyBhIGJhc2UgbGV2ZWwgY29udHJhY3QgYnVpbHQgb2ZmIG9mIHRoZSBgT3duZWRgCi8vLyAgY29udHJhY3Q7IGl0IGNyZWF0ZXMgYW4gZXNjYXBlIGhhdGNoIGZ1bmN0aW9uIHRoYXQgY2FuIGJlIGNhbGxlZCBpbiBhbgovLy8gIGVtZXJnZW5jeSB0aGF0IHdpbGwgYWxsb3cgZGVzaWduYXRlZCBhZGRyZXNzZXMgdG8gc2VuZCBhbnkgZXRoZXIgb3IgdG9rZW5zCi8vLyAgaGVsZCBpbiB0aGUgY29udHJhY3QgdG8gYW4gYGVzY2FwZUhhdGNoRGVzdGluYXRpb25gIGFzIGxvbmcgYXMgdGhleSB3ZXJlCi8vLyAgbm90IGJsYWNrbGlzdGVkCmNvbnRyYWN0IEVzY2FwYWJsZSBpcyBPd25lZCB7CiAgICBhZGRyZXNzIHB1YmxpYyBlc2NhcGVIYXRjaENhbGxlcjsKICAgIGFkZHJlc3MgcHVibGljIGVzY2FwZUhhdGNoRGVzdGluYXRpb247CiAgICBtYXBwaW5nIChhZGRyZXNzPT5ib29sKSBwcml2YXRlIGVzY2FwZUJsYWNrbGlzdDsgLy8gVG9rZW4gY29udHJhY3QgYWRkcmVzc2VzCgogICAgLy8vIEBub3RpY2UgVGhlIENvbnN0cnVjdG9yIGFzc2lnbnMgdGhlIGBlc2NhcGVIYXRjaERlc3RpbmF0aW9uYCBhbmQgdGhlCiAgICAvLy8gIGBlc2NhcGVIYXRjaENhbGxlcmAKICAgIC8vLyBAcGFyYW0gX2VzY2FwZUhhdGNoQ2FsbGVyIFRoZSBhZGRyZXNzIG9mIGEgdHJ1c3RlZCBhY2NvdW50IG9yIGNvbnRyYWN0CiAgICAvLy8gIHRvIGNhbGwgYGVzY2FwZUhhdGNoKClgIHRvIHNlbmQgdGhlIGV0aGVyIGluIHRoaXMgY29udHJhY3QgdG8gdGhlCiAgICAvLy8gIGBlc2NhcGVIYXRjaERlc3RpbmF0aW9uYCBpdCB3b3VsZCBiZSBpZGVhbCB0aGF0IGBlc2NhcGVIYXRjaENhbGxlcmAKICAgIC8vLyAgY2Fubm90IG1vdmUgZnVuZHMgb3V0IG9mIGBlc2NhcGVIYXRjaERlc3RpbmF0aW9uYAogICAgLy8vIEBwYXJhbSBfZXNjYXBlSGF0Y2hEZXN0aW5hdGlvbiBUaGUgYWRkcmVzcyBvZiBhIHNhZmUgbG9jYXRpb24gKHVzdSBhCiAgICAvLy8gIE11bHRpc2lnKSB0byBzZW5kIHRoZSBldGhlciBoZWxkIGluIHRoaXMgY29udHJhY3Q7IGlmIGEgbmV1dHJhbCBhZGRyZXNzCiAgICAvLy8gIGlzIHJlcXVpcmVkLCB0aGUgV0hHIE11bHRpc2lnIGlzIGFuIG9wdGlvbjoKICAgIC8vLyAgMHg4RmY5MjAwMjBjOEFENjczNjYxYzgxMTdmMjg1NUMzODQ3NThDNTcyIAogICAgZnVuY3Rpb24gRXNjYXBhYmxlKGFkZHJlc3MgX2VzY2FwZUhhdGNoQ2FsbGVyLCBhZGRyZXNzIF9lc2NhcGVIYXRjaERlc3RpbmF0aW9uKSBwdWJsaWMgewogICAgICAgIGVzY2FwZUhhdGNoQ2FsbGVyID0gX2VzY2FwZUhhdGNoQ2FsbGVyOwogICAgICAgIGVzY2FwZUhhdGNoRGVzdGluYXRpb24gPSBfZXNjYXBlSGF0Y2hEZXN0aW5hdGlvbjsKICAgIH0KCiAgICAvLy8gQGRldiBUaGUgYWRkcmVzc2VzIHByZWFzc2lnbmVkIGFzIGBlc2NhcGVIYXRjaENhbGxlcmAgb3IgYG93bmVyYAogICAgLy8vICBhcmUgdGhlIG9ubHkgYWRkcmVzc2VzIHRoYXQgY2FuIGNhbGwgYSBmdW5jdGlvbiB3aXRoIHRoaXMgbW9kaWZpZXIKICAgIG1vZGlmaWVyIG9ubHlFc2NhcGVIYXRjaENhbGxlck9yT3duZXIgewogICAgICAgIHJlcXVpcmUgKChtc2cuc2VuZGVyID09IGVzY2FwZUhhdGNoQ2FsbGVyKXx8KG1zZy5zZW5kZXIgPT0gb3duZXIpKTsKICAgICAgICBfOwogICAgfQoKICAgIC8vLyBAbm90aWNlIENyZWF0ZXMgdGhlIGJsYWNrbGlzdCBvZiB0b2tlbnMgdGhhdCBhcmUgbm90IGFibGUgdG8gYmUgdGFrZW4KICAgIC8vLyAgb3V0IG9mIHRoZSBjb250cmFjdDsgY2FuIG9ubHkgYmUgZG9uZSBhdCB0aGUgZGVwbG95bWVudCwgYW5kIHRoZSBsb2dpYwogICAgLy8vICB0byBhZGQgdG8gdGhlIGJsYWNrbGlzdCB3aWxsIGJlIGluIHRoZSBjb25zdHJ1Y3RvciBvZiBhIGNoaWxkIGNvbnRyYWN0CiAgICAvLy8gQHBhcmFtIF90b2tlbiB0aGUgdG9rZW4gY29udHJhY3QgYWRkcmVzcyB0aGF0IGlzIHRvIGJlIGJsYWNrbGlzdGVkIAogICAgZnVuY3Rpb24gYmxhY2tsaXN0RXNjYXBlVG9rZW4oYWRkcmVzcyBfdG9rZW4pIGludGVybmFsIHsKICAgICAgICBlc2NhcGVCbGFja2xpc3RbX3Rva2VuXSA9IHRydWU7CiAgICAgICAgRXNjYXBlSGF0Y2hCbGFja2lzdGVkVG9rZW4oX3Rva2VuKTsKICAgIH0KCiAgICAvLy8gQG5vdGljZSBDaGVja3MgdG8gc2VlIGlmIGBfdG9rZW5gIGlzIGluIHRoZSBibGFja2xpc3Qgb2YgdG9rZW5zCiAgICAvLy8gQHBhcmFtIF90b2tlbiB0aGUgdG9rZW4gYWRkcmVzcyBiZWluZyBxdWVyaWVkCiAgICAvLy8gQHJldHVybiBGYWxzZSBpZiBgX3Rva2VuYCBpcyBpbiB0aGUgYmxhY2tsaXN0IGFuZCBjYW4ndCBiZSB0YWtlbiBvdXQgb2YKICAgIC8vLyAgdGhlIGNvbnRyYWN0IHZpYSB0aGUgYGVzY2FwZUhhdGNoKClgCiAgICBmdW5jdGlvbiBpc1Rva2VuRXNjYXBhYmxlKGFkZHJlc3MgX3Rva2VuKSBjb25zdGFudCBwdWJsaWMgcmV0dXJucyAoYm9vbCkgewogICAgICAgIHJldHVybiAhZXNjYXBlQmxhY2tsaXN0W190b2tlbl07CiAgICB9CgogICAgLy8vIEBub3RpY2UgVGhlIGBlc2NhcGVIYXRjaCgpYCBzaG91bGQgb25seSBiZSBjYWxsZWQgYXMgYSBsYXN0IHJlc29ydCBpZiBhCiAgICAvLy8gc2VjdXJpdHkgaXNzdWUgaXMgdW5jb3ZlcmVkIG9yIHNvbWV0aGluZyB1bmV4cGVjdGVkIGhhcHBlbmVkCiAgICAvLy8gQHBhcmFtIF90b2tlbiB0byB0cmFuc2ZlciwgdXNlIDB4MCBmb3IgZXRoZXIKICAgIGZ1bmN0aW9uIGVzY2FwZUhhdGNoKGFkZHJlc3MgX3Rva2VuKSBwdWJsaWMgb25seUVzY2FwZUhhdGNoQ2FsbGVyT3JPd25lciB7ICAgCiAgICAgICAgcmVxdWlyZShlc2NhcGVCbGFja2xpc3RbX3Rva2VuXT09ZmFsc2UpOwoKICAgICAgICB1aW50MjU2IGJhbGFuY2U7CgogICAgICAgIC8vLyBAZGV2IExvZ2ljIGZvciBldGhlcgogICAgICAgIGlmIChfdG9rZW4gPT0gMHgwKSB7CiAgICAgICAgICAgIGJhbGFuY2UgPSB0aGlzLmJhbGFuY2U7CiAgICAgICAgICAgIGVzY2FwZUhhdGNoRGVzdGluYXRpb24udHJhbnNmZXIoYmFsYW5jZSk7CiAgICAgICAgICAgIEVzY2FwZUhhdGNoQ2FsbGVkKF90b2tlbiwgYmFsYW5jZSk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgLy8vIEBkZXYgTG9naWMgZm9yIHRva2VucwogICAgICAgIEVSQzIwIHRva2VuID0gRVJDMjAoX3Rva2VuKTsKICAgICAgICBiYWxhbmNlID0gdG9rZW4uYmFsYW5jZU9mKHRoaXMpOwogICAgICAgIHJlcXVpcmUodG9rZW4udHJhbnNmZXIoZXNjYXBlSGF0Y2hEZXN0aW5hdGlvbiwgYmFsYW5jZSkpOwogICAgICAgIEVzY2FwZUhhdGNoQ2FsbGVkKF90b2tlbiwgYmFsYW5jZSk7CiAgICB9CgogICAgLy8vIEBub3RpY2UgQ2hhbmdlcyB0aGUgYWRkcmVzcyBhc3NpZ25lZCB0byBjYWxsIGBlc2NhcGVIYXRjaCgpYAogICAgLy8vIEBwYXJhbSBfbmV3RXNjYXBlSGF0Y2hDYWxsZXIgVGhlIGFkZHJlc3Mgb2YgYSB0cnVzdGVkIGFjY291bnQgb3IKICAgIC8vLyAgY29udHJhY3QgdG8gY2FsbCBgZXNjYXBlSGF0Y2goKWAgdG8gc2VuZCB0aGUgdmFsdWUgaW4gdGhpcyBjb250cmFjdCB0bwogICAgLy8vICB0aGUgYGVzY2FwZUhhdGNoRGVzdGluYXRpb25gOyBpdCB3b3VsZCBiZSBpZGVhbCB0aGF0IGBlc2NhcGVIYXRjaENhbGxlcmAKICAgIC8vLyAgY2Fubm90IG1vdmUgZnVuZHMgb3V0IG9mIGBlc2NhcGVIYXRjaERlc3RpbmF0aW9uYAogICAgZnVuY3Rpb24gY2hhbmdlSGF0Y2hFc2NhcGVDYWxsZXIoYWRkcmVzcyBfbmV3RXNjYXBlSGF0Y2hDYWxsZXIpIHB1YmxpYyBvbmx5RXNjYXBlSGF0Y2hDYWxsZXJPck93bmVyIHsKICAgICAgICBlc2NhcGVIYXRjaENhbGxlciA9IF9uZXdFc2NhcGVIYXRjaENhbGxlcjsKICAgIH0KCiAgICBldmVudCBFc2NhcGVIYXRjaEJsYWNraXN0ZWRUb2tlbihhZGRyZXNzIHRva2VuKTsKICAgIGV2ZW50IEVzY2FwZUhhdGNoQ2FsbGVkKGFkZHJlc3MgdG9rZW4sIHVpbnQgYW1vdW50KTsKfQoKLy9GaWxlOiBub2RlX21vZHVsZXMvZ2l2ZXRoLWxpcXVpZHBsZWRnaW5nL2NvbnRyYWN0cy9MaXF1aWRQbGVkZ2luZ0Jhc2Uuc29sCnByYWdtYSBzb2xpZGl0eSBeMC40LjExOwovKgogICAgQ29weXJpZ2h0IDIwMTcsIEpvcmRpIEJheWxpbmEKICAgIENvbnRyaWJ1dG9yczogQWRyaSYjMjI0OyBNYXNzYW5ldCA8PHNwYW4gY2xhc3M9Il9fY2ZfZW1haWxfXyIgZGF0YS1jZmVtYWlsPSJmZjllOWI4ZDk2OWViZjljOTA5YjlhOWM5MDkxOGI5YTg3OGJkMTk2OTAiPltlbWFpbCYjMTYwO3Byb3RlY3RlZF08L3NwYW4+PiwgUkogRXdpbmcsIEdyaWZmCiAgICBHcmVlbiwgQXJ0aHVyIEx1bm4KCiAgICBUaGlzIHByb2dyYW0gaXMgZnJlZSBzb2Z0d2FyZTogeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yIG1vZGlmeQogICAgaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhcyBwdWJsaXNoZWQgYnkKICAgIHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb24sIGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlIExpY2Vuc2UsIG9yCiAgICAoYXQgeW91ciBvcHRpb24pIGFueSBsYXRlciB2ZXJzaW9uLgoKICAgIFRoaXMgcHJvZ3JhbSBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0IGl0IHdpbGwgYmUgdXNlZnVsLAogICAgYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2YKICAgIE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gIFNlZSB0aGUKICAgIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuCgogICAgWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UKICAgIGFsb25nIHdpdGggdGhpcyBwcm9ncmFtLiAgSWYgbm90LCBzZWUgPGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8+LgoqLwoKCgoKLy8vIEBkZXYgVGhpcyBpcyBhbiBpbnRlcmZhY2UgZm9yIGBMUFZhdWx0YCB3aGljaCBzZXJ2ZXMgYXMgYSBzZWN1cmUgc3RvcmFnZSBmb3IKLy8vICB0aGUgRVRIIHRoYXQgYmFja3MgdGhlIFBsZWRnZXMsIG9ubHkgYWZ0ZXIgYExpcXVpZFBsZWRnaW5nYCBhdXRob3JpemVzCi8vLyAgcGF5bWVudHMgY2FuIFBsZWRnZXMgYmUgY29udmVydGVkIGZvciBFVEgKaW50ZXJmYWNlIExQVmF1bHQgewogICAgZnVuY3Rpb24gYXV0aG9yaXplUGF5bWVudChieXRlczMyIF9yZWYsIGFkZHJlc3MgX2Rlc3QsIHVpbnQgX2Ftb3VudCk7CiAgICBmdW5jdGlvbiAoKSBwYXlhYmxlOwp9CgovLy8gQGRldiBgTGlxdWlkUGxlZGdpbmdCYXNlYCBpcyB0aGUgYmFzZSBsZXZlbCBjb250cmFjdCB1c2VkIHRvIGNhcnJ5IG91dAovLy8gIGxpcXVpZFBsZWRnaW5nJ3MgbW9zdCBiYXNpYyBmdW5jdGlvbnMsIG1vc3RseSBoYW5kbGluZyBhbmQgc2VhcmNoaW5nIHRoZQovLy8gIGRhdGEgc3RydWN0dXJlcwpjb250cmFjdCBMaXF1aWRQbGVkZ2luZ0Jhc2UgaXMgRXNjYXBhYmxlIHsKCiAgICAvLyBMaW1pdHMgaW5zZXJ0ZWQgdG8gcHJldmVudCBsYXJnZSBsb29wcyB0aGF0IGNvdWxkIHByZXZlbnQgY2FuY2VsaW5nCiAgICB1aW50IGNvbnN0YW50IE1BWF9ERUxFR0FURVMgPSAxMDsKICAgIHVpbnQgY29uc3RhbnQgTUFYX1NVQlBST0pFQ1RfTEVWRUwgPSAyMDsKICAgIHVpbnQgY29uc3RhbnQgTUFYX0lOVEVSUFJPSkVDVF9MRVZFTCA9IDIwOwoKICAgIGVudW0gUGxlZGdlQWRtaW5UeXBlIHsgR2l2ZXIsIERlbGVnYXRlLCBQcm9qZWN0IH0KICAgIGVudW0gUGxlZGdlU3RhdGUgeyBQbGVkZ2VkLCBQYXlpbmcsIFBhaWQgfQoKICAgIC8vLyBAZGV2IFRoaXMgc3RydWN0IGRlZmluZXMgdGhlIGRldGFpbHMgb2YgYSBgUGxlZGdlQWRtaW5gIHdoaWNoIGFyZSAKICAgIC8vLyAgY29tbW9ubHkgcmVmZXJlbmNlZCBieSB0aGVpciBpbmRleCBpbiB0aGUgYGFkbWluc2AgYXJyYXkKICAgIC8vLyAgYW5kIGNhbiBvd24gcGxlZGdlcyBhbmQgYWN0IGFzIGRlbGVnYXRlcwogICAgc3RydWN0IFBsZWRnZUFkbWluIHsgCiAgICAgICAgUGxlZGdlQWRtaW5UeXBlIGFkbWluVHlwZTsgLy8gR2l2ZXIsIERlbGVnYXRlIG9yIFByb2plY3QKICAgICAgICBhZGRyZXNzIGFkZHI7IC8vIEFjY291bnQgb3IgY29udHJhY3QgYWRkcmVzcyBmb3IgYWRtaW4KICAgICAgICBzdHJpbmcgbmFtZTsKICAgICAgICBzdHJpbmcgdXJsOyAgLy8gQ2FuIGJlIElQRlMgaGFzaAogICAgICAgIHVpbnQ2NCBjb21taXRUaW1lOyAgLy8gSW4gc2Vjb25kcywgdXNlZCBmb3IgR2l2ZXJzJyAmIERlbGVnYXRlcycgdmV0b3MKICAgICAgICB1aW50NjQgcGFyZW50UHJvamVjdDsgIC8vIE9ubHkgZm9yIHByb2plY3RzCiAgICAgICAgYm9vbCBjYW5jZWxlZDsgICAgICAvL0Fsd2F5cyBmYWxzZSBleGNlcHQgZm9yIGNhbmNlbGVkIHByb2plY3RzCgogICAgICAgIC8vLyBAZGV2IGlmIHRoZSBwbHVnaW4gaXMgMHgwIHRoZW4gbm90aGluZyBoYXBwZW5zLCBpZiBpdHMgYW4gYWRkcmVzcwogICAgICAgIC8vIHRoYW4gdGhhdCBzbWFydCBjb250cmFjdCBpcyBjYWxsZWQgd2hlbiBhcHByb3ByaWF0ZQogICAgICAgIElMaXF1aWRQbGVkZ2luZ1BsdWdpbiBwbHVnaW47IAogICAgfQoKICAgIHN0cnVjdCBQbGVkZ2UgewogICAgICAgIHVpbnQgYW1vdW50OwogICAgICAgIHVpbnQ2NCBvd25lcjsgLy8gUGxlZGdlQWRtaW4KICAgICAgICB1aW50NjRbXSBkZWxlZ2F0aW9uQ2hhaW47IC8vIExpc3Qgb2YgZGVsZWdhdGVzIGluIG9yZGVyIG9mIGF1dGhvcml0eQogICAgICAgIHVpbnQ2NCBpbnRlbmRlZFByb2plY3Q7IC8vIFVzZWQgd2hlbiBkZWxlZ2F0ZXMgYXJlIHNlbmRpbmcgdG8gcHJvamVjdHMKICAgICAgICB1aW50NjQgY29tbWl0VGltZTsgIC8vIFdoZW4gdGhlIGludGVuZGVkUHJvamVjdCB3aWxsIGJlY29tZSB0aGUgb3duZXIgIAogICAgICAgIHVpbnQ2NCBvbGRQbGVkZ2U7IC8vIFBvaW50cyB0byB0aGUgaWQgdGhhdCB0aGlzIFBsZWRnZSB3YXMgZGVyaXZlZCBmcm9tCiAgICAgICAgUGxlZGdlU3RhdGUgcGxlZGdlU3RhdGU7IC8vICBQbGVkZ2VkLCBQYXlpbmcsIFBhaWQKICAgIH0KCiAgICBQbGVkZ2VbXSBwbGVkZ2VzOwogICAgUGxlZGdlQWRtaW5bXSBhZG1pbnM7IC8vVGhlIGxpc3Qgb2YgcGxlZGdlQWRtaW5zIDAgbWVhbnMgdGhlcmUgaXMgbm8gYWRtaW4KICAgIExQVmF1bHQgcHVibGljIHZhdWx0OwoKICAgIC8vLyBAZGV2IHRoaXMgbWFwcGluZyBhbGxvd3MgeW91IHRvIHNlYXJjaCBmb3IgYSBzcGVjaWZpYyBwbGVkZ2UncyAKICAgIC8vLyAgaW5kZXggbnVtYmVyIGJ5IHRoZSBoYXNoIG9mIHRoYXQgcGxlZGdlCiAgICBtYXBwaW5nIChieXRlczMyID0+IHVpbnQ2NCkgaFBsZWRnZTJpZHg7CiAgICBtYXBwaW5nIChieXRlczMyID0+IGJvb2wpIHBsdWdpbldoaXRlbGlzdDsKICAgIAogICAgYm9vbCBwdWJsaWMgdXNlUGx1Z2luV2hpdGVsaXN0ID0gdHJ1ZTsKCi8vLy8vLy8vLy8vLy8KLy8gTW9kaWZpZXJzCi8vLy8vLy8vLy8vLy8KCgogICAgLy8vIEBkZXYgVGhlIGB2YXVsdGBpcyB0aGUgb25seSBhZGRyZXNzZXMgdGhhdCBjYW4gY2FsbCBhIGZ1bmN0aW9uIHdpdGggdGhpcwogICAgLy8vICBtb2RpZmllcgogICAgbW9kaWZpZXIgb25seVZhdWx0KCkgewogICAgICAgIHJlcXVpcmUobXNnLnNlbmRlciA9PSBhZGRyZXNzKHZhdWx0KSk7CiAgICAgICAgXzsKICAgIH0KCgovLy8vLy8vLy8vLy8vLy8KLy8gQ29uc3RydWN0b3IKLy8vLy8vLy8vLy8vLy8vCgogICAgLy8vIEBub3RpY2UgVGhlIENvbnN0cnVjdG9yIGNyZWF0ZXMgYExpcXVpZFBsZWRnaW5nQmFzZWAgb24gdGhlIGJsb2NrY2hhaW4KICAgIC8vLyBAcGFyYW0gX3ZhdWx0IFRoZSB2YXVsdCB3aGVyZSB0aGUgRVRIIGJhY2tpbmcgdGhlIHBsZWRnZXMgaXMgc3RvcmVkCiAgICBmdW5jdGlvbiBMaXF1aWRQbGVkZ2luZ0Jhc2UoCiAgICAgICAgYWRkcmVzcyBfdmF1bHQsCiAgICAgICAgYWRkcmVzcyBfZXNjYXBlSGF0Y2hDYWxsZXIsCiAgICAgICAgYWRkcmVzcyBfZXNjYXBlSGF0Y2hEZXN0aW5hdGlvbgogICAgKSBFc2NhcGFibGUoX2VzY2FwZUhhdGNoQ2FsbGVyLCBfZXNjYXBlSGF0Y2hEZXN0aW5hdGlvbikgcHVibGljIHsKICAgICAgICBhZG1pbnMubGVuZ3RoID0gMTsgLy8gd2UgcmVzZXJ2ZSB0aGUgMCBhZG1pbgogICAgICAgIHBsZWRnZXMubGVuZ3RoID0gMTsgLy8gd2UgcmVzZXJ2ZSB0aGUgMCBwbGVkZ2UKICAgICAgICB2YXVsdCA9IExQVmF1bHQoX3ZhdWx0KTsgLy8gQXNzaWducyB0aGUgc3BlY2lmaWVkIHZhdWx0CiAgICB9CgoKLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwovLyBQbGVkZ2VBZG1pbiBmdW5jdGlvbnMKLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKICAgIC8vLyBAbm90aWNlIENyZWF0ZXMgYSBHaXZlciBBZG1pbiB3aXRoIHRoZSBgbXNnLnNlbmRlcmAgYXMgdGhlIEFkbWluIGFkZHJlc3MKICAgIC8vLyBAcGFyYW0gbmFtZSBUaGUgbmFtZSB1c2VkIHRvIGlkZW50aWZ5IHRoZSBHaXZlcgogICAgLy8vIEBwYXJhbSB1cmwgVGhlIGxpbmsgdG8gdGhlIEdpdmVyJ3MgcHJvZmlsZSBvZnRlbiBhbiBJUEZTIGhhc2gKICAgIC8vLyBAcGFyYW0gY29tbWl0VGltZSBUaGUgbGVuZ3RoIG9mIHRpbWUgaW4gc2Vjb25kcyB0aGUgR2l2ZXIgaGFzIHRvCiAgICAvLy8gICB2ZXRvIHdoZW4gdGhlIEdpdmVyJ3MgZGVsZWdhdGVzIFBsZWRnZSBmdW5kcyB0byBhIHByb2plY3QKICAgIC8vLyBAcGFyYW0gcGx1Z2luIFRoaXMgaXMgR2l2ZXIncyBsaXF1aWQgcGxlZGdlIHBsdWdpbiBhbGxvd2luZyBmb3IgCiAgICAvLy8gIGV4dGVuZGVkIGZ1bmN0aW9uYWxpdHkKICAgIC8vLyBAcmV0dXJuIGlkR2l2ZXIgVGhlIGlkIG51bWJlciB1c2VkIHRvIHJlZmVyZW5jZSB0aGlzIEFkbWluCiAgICBmdW5jdGlvbiBhZGRHaXZlcigKICAgICAgICBzdHJpbmcgbmFtZSwKICAgICAgICBzdHJpbmcgdXJsLAogICAgICAgIHVpbnQ2NCBjb21taXRUaW1lLAogICAgICAgIElMaXF1aWRQbGVkZ2luZ1BsdWdpbiBwbHVnaW4KICAgICkgcmV0dXJucyAodWludDY0IGlkR2l2ZXIpIHsKCiAgICAgICAgcmVxdWlyZShpc1ZhbGlkUGx1Z2luKHBsdWdpbikpOyAvLyBQbHVnaW4gY2hlY2sKCiAgICAgICAgaWRHaXZlciA9IHVpbnQ2NChhZG1pbnMubGVuZ3RoKTsKCiAgICAgICAgYWRtaW5zLnB1c2goUGxlZGdlQWRtaW4oCiAgICAgICAgICAgIFBsZWRnZUFkbWluVHlwZS5HaXZlciwKICAgICAgICAgICAgbXNnLnNlbmRlciwKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgdXJsLAogICAgICAgICAgICBjb21taXRUaW1lLAogICAgICAgICAgICAwLAogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgcGx1Z2luKSk7CgogICAgICAgIEdpdmVyQWRkZWQoaWRHaXZlcik7CiAgICB9CgogICAgZXZlbnQgR2l2ZXJBZGRlZCh1aW50NjQgaW5kZXhlZCBpZEdpdmVyKTsKCiAgICAvLy8gQG5vdGljZSBVcGRhdGVzIGEgR2l2ZXIncyBpbmZvIHRvIGNoYW5nZSB0aGUgYWRkcmVzcywgbmFtZSwgdXJsLCBvciAKICAgIC8vLyAgY29tbWl0VGltZSwgaXQgY2Fubm90IGJlIHVzZWQgdG8gY2hhbmdlIGEgcGx1Z2luLCBhbmQgaXQgbXVzdCBiZSBjYWxsZWQKICAgIC8vLyAgYnkgdGhlIGN1cnJlbnQgYWRkcmVzcyBvZiB0aGUgR2l2ZXIKICAgIC8vLyBAcGFyYW0gaWRHaXZlciBUaGlzIGlzIHRoZSBBZG1pbiBpZCBudW1iZXIgdXNlZCB0byBzcGVjaWZ5IHRoZSBHaXZlcgogICAgLy8vIEBwYXJhbSBuZXdBZGRyIFRoZSBuZXcgYWRkcmVzcyB0aGF0IHJlcHJlc2VudHMgdGhpcyBHaXZlcgogICAgLy8vIEBwYXJhbSBuZXdOYW1lIFRoZSBuZXcgbmFtZSB1c2VkIHRvIGlkZW50aWZ5IHRoZSBHaXZlcgogICAgLy8vIEBwYXJhbSBuZXdVcmwgVGhlIG5ldyBsaW5rIHRvIHRoZSBHaXZlcidzIHByb2ZpbGUgb2Z0ZW4gYW4gSVBGUyBoYXNoCiAgICAvLy8gQHBhcmFtIG5ld0NvbW1pdFRpbWUgU2V0cyB0aGUgbGVuZ3RoIG9mIHRpbWUgaW4gc2Vjb25kcyB0aGUgR2l2ZXIgaGFzIHRvCiAgICAvLy8gICB2ZXRvIHdoZW4gdGhlIEdpdmVyJ3MgZGVsZWdhdGVzIFBsZWRnZSBmdW5kcyB0byBhIHByb2plY3QKICAgIGZ1bmN0aW9uIHVwZGF0ZUdpdmVyKAogICAgICAgIHVpbnQ2NCBpZEdpdmVyLAogICAgICAgIGFkZHJlc3MgbmV3QWRkciwKICAgICAgICBzdHJpbmcgbmV3TmFtZSwKICAgICAgICBzdHJpbmcgbmV3VXJsLAogICAgICAgIHVpbnQ2NCBuZXdDb21taXRUaW1lKQogICAgewogICAgICAgIFBsZWRnZUFkbWluIHN0b3JhZ2UgZ2l2ZXIgPSBmaW5kQWRtaW4oaWRHaXZlcik7CiAgICAgICAgcmVxdWlyZShnaXZlci5hZG1pblR5cGUgPT0gUGxlZGdlQWRtaW5UeXBlLkdpdmVyKTsgLy8gTXVzdCBiZSBhIEdpdmVyCiAgICAgICAgcmVxdWlyZShnaXZlci5hZGRyID09IG1zZy5zZW5kZXIpOyAvLyBDdXJyZW50IGFkZHIgaGFkIHRvIHNlbmQgdGhpcyB0eAogICAgICAgIGdpdmVyLmFkZHIgPSBuZXdBZGRyOwogICAgICAgIGdpdmVyLm5hbWUgPSBuZXdOYW1lOwogICAgICAgIGdpdmVyLnVybCA9IG5ld1VybDsKICAgICAgICBnaXZlci5jb21taXRUaW1lID0gbmV3Q29tbWl0VGltZTsKICAgICAgICBHaXZlclVwZGF0ZWQoaWRHaXZlcik7CiAgICB9CgogICAgZXZlbnQgR2l2ZXJVcGRhdGVkKHVpbnQ2NCBpbmRleGVkIGlkR2l2ZXIpOwoKICAgIC8vLyBAbm90aWNlIENyZWF0ZXMgYSBEZWxlZ2F0ZSBBZG1pbiB3aXRoIHRoZSBgbXNnLnNlbmRlcmAgYXMgdGhlIEFkbWluIGFkZHIKICAgIC8vLyBAcGFyYW0gbmFtZSBUaGUgbmFtZSB1c2VkIHRvIGlkZW50aWZ5IHRoZSBEZWxlZ2F0ZQogICAgLy8vIEBwYXJhbSB1cmwgVGhlIGxpbmsgdG8gdGhlIERlbGVnYXRlJ3MgcHJvZmlsZSBvZnRlbiBhbiBJUEZTIGhhc2gKICAgIC8vLyBAcGFyYW0gY29tbWl0VGltZSBTZXRzIHRoZSBsZW5ndGggb2YgdGltZSBpbiBzZWNvbmRzIHRoYXQgdGhpcyBkZWxlZ2F0ZQogICAgLy8vICBjYW4gYmUgdmV0b2VkLiBXaGVuZXZlciB0aGlzIGRlbGVnYXRlIGlzIGluIGEgZGVsZWdhdGUgY2hhaW4gdGhlIHRpbWUKICAgIC8vLyAgYWxsb3dlZCB0byB2ZXRvIGFueSBldmVudCBtdXN0IGJlIGdyZWF0ZXIgdGhhbiBvciBlcXVhbCB0byB0aGlzIHRpbWUuCiAgICAvLy8gQHBhcmFtIHBsdWdpbiBUaGlzIGlzIERlbGVnYXRlJ3MgbGlxdWlkIHBsZWRnZSBwbHVnaW4gYWxsb3dpbmcgZm9yIAogICAgLy8vICBleHRlbmRlZCBmdW5jdGlvbmFsaXR5CiAgICAvLy8gQHJldHVybiBpZHhEZWxlZ2F0ZSBUaGUgaWQgbnVtYmVyIHVzZWQgdG8gcmVmZXJlbmNlIHRoaXMgRGVsZWdhdGUgd2l0aGluCiAgICAvLy8gIHRoZSBhZG1pbnMgYXJyYXkKICAgIGZ1bmN0aW9uIGFkZERlbGVnYXRlKAogICAgICAgIHN0cmluZyBuYW1lLAogICAgICAgIHN0cmluZyB1cmwsCiAgICAgICAgdWludDY0IGNvbW1pdFRpbWUsCiAgICAgICAgSUxpcXVpZFBsZWRnaW5nUGx1Z2luIHBsdWdpbgogICAgKSByZXR1cm5zICh1aW50NjQgaWREZWxlZ2F0ZSkgeyAKCiAgICAgICAgcmVxdWlyZShpc1ZhbGlkUGx1Z2luKHBsdWdpbikpOyAvLyBQbHVnaW4gY2hlY2sKCiAgICAgICAgaWREZWxlZ2F0ZSA9IHVpbnQ2NChhZG1pbnMubGVuZ3RoKTsKCiAgICAgICAgYWRtaW5zLnB1c2goUGxlZGdlQWRtaW4oCiAgICAgICAgICAgIFBsZWRnZUFkbWluVHlwZS5EZWxlZ2F0ZSwKICAgICAgICAgICAgbXNnLnNlbmRlciwKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgdXJsLAogICAgICAgICAgICBjb21taXRUaW1lLAogICAgICAgICAgICAwLAogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgcGx1Z2luKSk7CgogICAgICAgIERlbGVnYXRlQWRkZWQoaWREZWxlZ2F0ZSk7CiAgICB9CgogICAgZXZlbnQgRGVsZWdhdGVBZGRlZCh1aW50NjQgaW5kZXhlZCBpZERlbGVnYXRlKTsKCiAgICAvLy8gQG5vdGljZSBVcGRhdGVzIGEgRGVsZWdhdGUncyBpbmZvIHRvIGNoYW5nZSB0aGUgYWRkcmVzcywgbmFtZSwgdXJsLCBvciAKICAgIC8vLyAgY29tbWl0VGltZSwgaXQgY2Fubm90IGJlIHVzZWQgdG8gY2hhbmdlIGEgcGx1Z2luLCBhbmQgaXQgbXVzdCBiZSBjYWxsZWQKICAgIC8vLyAgYnkgdGhlIGN1cnJlbnQgYWRkcmVzcyBvZiB0aGUgRGVsZWdhdGUKICAgIC8vLyBAcGFyYW0gaWREZWxlZ2F0ZSBUaGUgQWRtaW4gaWQgbnVtYmVyIHVzZWQgdG8gc3BlY2lmeSB0aGUgRGVsZWdhdGUKICAgIC8vLyBAcGFyYW0gbmV3QWRkciBUaGUgbmV3IGFkZHJlc3MgdGhhdCByZXByZXNlbnRzIHRoaXMgRGVsZWdhdGUKICAgIC8vLyBAcGFyYW0gbmV3TmFtZSBUaGUgbmV3IG5hbWUgdXNlZCB0byBpZGVudGlmeSB0aGUgRGVsZWdhdGUKICAgIC8vLyBAcGFyYW0gbmV3VXJsIFRoZSBuZXcgbGluayB0byB0aGUgRGVsZWdhdGUncyBwcm9maWxlIG9mdGVuIGFuIElQRlMgaGFzaAogICAgLy8vIEBwYXJhbSBuZXdDb21taXRUaW1lIFNldHMgdGhlIGxlbmd0aCBvZiB0aW1lIGluIHNlY29uZHMgdGhhdCB0aGlzIAogICAgLy8vICBkZWxlZ2F0ZSBjYW4gYmUgdmV0b2VkLiBXaGVuZXZlciB0aGlzIGRlbGVnYXRlIGlzIGluIGEgZGVsZWdhdGUgY2hhaW4gCiAgICAvLy8gIHRoZSB0aW1lIGFsbG93ZWQgdG8gdmV0byBhbnkgZXZlbnQgbXVzdCBiZSBncmVhdGVyIHRoYW4gb3IgZXF1YWwgdG8KICAgIC8vLyAgdGhpcyB0aW1lLgogICAgZnVuY3Rpb24gdXBkYXRlRGVsZWdhdGUoCiAgICAgICAgdWludDY0IGlkRGVsZWdhdGUsCiAgICAgICAgYWRkcmVzcyBuZXdBZGRyLAogICAgICAgIHN0cmluZyBuZXdOYW1lLAogICAgICAgIHN0cmluZyBuZXdVcmwsCiAgICAgICAgdWludDY0IG5ld0NvbW1pdFRpbWUpIHsKICAgICAgICBQbGVkZ2VBZG1pbiBzdG9yYWdlIGRlbGVnYXRlID0gZmluZEFkbWluKGlkRGVsZWdhdGUpOwogICAgICAgIHJlcXVpcmUoZGVsZWdhdGUuYWRtaW5UeXBlID09IFBsZWRnZUFkbWluVHlwZS5EZWxlZ2F0ZSk7CiAgICAgICAgcmVxdWlyZShkZWxlZ2F0ZS5hZGRyID09IG1zZy5zZW5kZXIpOy8vIEN1cnJlbnQgYWRkciBoYWQgdG8gc2VuZCB0aGlzIHR4CiAgICAgICAgZGVsZWdhdGUuYWRkciA9IG5ld0FkZHI7CiAgICAgICAgZGVsZWdhdGUubmFtZSA9IG5ld05hbWU7CiAgICAgICAgZGVsZWdhdGUudXJsID0gbmV3VXJsOwogICAgICAgIGRlbGVnYXRlLmNvbW1pdFRpbWUgPSBuZXdDb21taXRUaW1lOwogICAgICAgIERlbGVnYXRlVXBkYXRlZChpZERlbGVnYXRlKTsKICAgIH0KCiAgICBldmVudCBEZWxlZ2F0ZVVwZGF0ZWQodWludDY0IGluZGV4ZWQgaWREZWxlZ2F0ZSk7CgogICAgLy8vIEBub3RpY2UgQ3JlYXRlcyBhIFByb2plY3QgQWRtaW4gd2l0aCB0aGUgYG1zZy5zZW5kZXJgIGFzIHRoZSBBZG1pbiBhZGRyCiAgICAvLy8gQHBhcmFtIG5hbWUgVGhlIG5hbWUgdXNlZCB0byBpZGVudGlmeSB0aGUgUHJvamVjdAogICAgLy8vIEBwYXJhbSB1cmwgVGhlIGxpbmsgdG8gdGhlIFByb2plY3QncyBwcm9maWxlIG9mdGVuIGFuIElQRlMgaGFzaAogICAgLy8vIEBwYXJhbSBwcm9qZWN0QWRtaW4gVGhlIGFkZHJlc3MgZm9yIHRoZSB0cnVzdGVkIHByb2plY3QgbWFuYWdlciAKICAgIC8vLyBAcGFyYW0gcGFyZW50UHJvamVjdCBUaGUgQWRtaW4gaWQgbnVtYmVyIGZvciB0aGUgcGFyZW50IHByb2plY3Qgb3IgMCBpZgogICAgLy8vICB0aGVyZSBpcyBubyBwYXJlbnRQcm9qZWN0CiAgICAvLy8gQHBhcmFtIGNvbW1pdFRpbWUgU2V0cyB0aGUgbGVuZ3RoIG9mIHRpbWUgaW4gc2Vjb25kcyB0aGUgUHJvamVjdCBoYXMgdG8KICAgIC8vLyAgIHZldG8gd2hlbiB0aGUgUHJvamVjdCBkZWxlZ2F0ZXMgdG8gYW5vdGhlciBEZWxlZ2F0ZSBhbmQgdGhleSBwbGVkZ2UgCiAgICAvLy8gICB0aG9zZSBmdW5kcyB0byBhIHByb2plY3QKICAgIC8vLyBAcGFyYW0gcGx1Z2luIFRoaXMgaXMgUHJvamVjdCdzIGxpcXVpZCBwbGVkZ2UgcGx1Z2luIGFsbG93aW5nIGZvciAKICAgIC8vLyAgZXh0ZW5kZWQgZnVuY3Rpb25hbGl0eQogICAgLy8vIEByZXR1cm4gaWRQcm9qZWN0IFRoZSBpZCBudW1iZXIgdXNlZCB0byByZWZlcmVuY2UgdGhpcyBBZG1pbgogICAgZnVuY3Rpb24gYWRkUHJvamVjdCgKICAgICAgICBzdHJpbmcgbmFtZSwKICAgICAgICBzdHJpbmcgdXJsLAogICAgICAgIGFkZHJlc3MgcHJvamVjdEFkbWluLAogICAgICAgIHVpbnQ2NCBwYXJlbnRQcm9qZWN0LAogICAgICAgIHVpbnQ2NCBjb21taXRUaW1lLAogICAgICAgIElMaXF1aWRQbGVkZ2luZ1BsdWdpbiBwbHVnaW4KICAgICkgcmV0dXJucyAodWludDY0IGlkUHJvamVjdCkgewogICAgICAgIHJlcXVpcmUoaXNWYWxpZFBsdWdpbihwbHVnaW4pKTsKCiAgICAgICAgaWYgKHBhcmVudFByb2plY3QgIT0gMCkgewogICAgICAgICAgICBQbGVkZ2VBZG1pbiBzdG9yYWdlIHBhID0gZmluZEFkbWluKHBhcmVudFByb2plY3QpOwogICAgICAgICAgICByZXF1aXJlKHBhLmFkbWluVHlwZSA9PSBQbGVkZ2VBZG1pblR5cGUuUHJvamVjdCk7CiAgICAgICAgICAgIHJlcXVpcmUoZ2V0UHJvamVjdExldmVsKHBhKSA8IE1BWF9TVUJQUk9KRUNUX0xFVkVMKTsKICAgICAgICB9CgogICAgICAgIGlkUHJvamVjdCA9IHVpbnQ2NChhZG1pbnMubGVuZ3RoKTsKCiAgICAgICAgYWRtaW5zLnB1c2goUGxlZGdlQWRtaW4oCiAgICAgICAgICAgIFBsZWRnZUFkbWluVHlwZS5Qcm9qZWN0LAogICAgICAgICAgICBwcm9qZWN0QWRtaW4sCiAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgIHVybCwKICAgICAgICAgICAgY29tbWl0VGltZSwKICAgICAgICAgICAgcGFyZW50UHJvamVjdCwKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIHBsdWdpbikpOwoKCiAgICAgICAgUHJvamVjdEFkZGVkKGlkUHJvamVjdCk7CiAgICB9CgogICAgZXZlbnQgUHJvamVjdEFkZGVkKHVpbnQ2NCBpbmRleGVkIGlkUHJvamVjdCk7CgoKICAgIC8vLyBAbm90aWNlIFVwZGF0ZXMgYSBQcm9qZWN0J3MgaW5mbyB0byBjaGFuZ2UgdGhlIGFkZHJlc3MsIG5hbWUsIHVybCwgb3IgCiAgICAvLy8gIGNvbW1pdFRpbWUsIGl0IGNhbm5vdCBiZSB1c2VkIHRvIGNoYW5nZSBhIHBsdWdpbiBvciBhIHBhcmVudFByb2plY3QsCiAgICAvLy8gIGFuZCBpdCBtdXN0IGJlIGNhbGxlZCBieSB0aGUgY3VycmVudCBhZGRyZXNzIG9mIHRoZSBQcm9qZWN0CiAgICAvLy8gQHBhcmFtIGlkUHJvamVjdCBUaGUgQWRtaW4gaWQgbnVtYmVyIHVzZWQgdG8gc3BlY2lmeSB0aGUgUHJvamVjdAogICAgLy8vIEBwYXJhbSBuZXdBZGRyIFRoZSBuZXcgYWRkcmVzcyB0aGF0IHJlcHJlc2VudHMgdGhpcyBQcm9qZWN0CiAgICAvLy8gQHBhcmFtIG5ld05hbWUgVGhlIG5ldyBuYW1lIHVzZWQgdG8gaWRlbnRpZnkgdGhlIFByb2plY3QKICAgIC8vLyBAcGFyYW0gbmV3VXJsIFRoZSBuZXcgbGluayB0byB0aGUgUHJvamVjdCdzIHByb2ZpbGUgb2Z0ZW4gYW4gSVBGUyBoYXNoCiAgICAvLy8gQHBhcmFtIG5ld0NvbW1pdFRpbWUgU2V0cyB0aGUgbGVuZ3RoIG9mIHRpbWUgaW4gc2Vjb25kcyB0aGUgUHJvamVjdCBoYXMKICAgIC8vLyAgdG8gdmV0byB3aGVuIHRoZSBQcm9qZWN0IGRlbGVnYXRlcyB0byBhIERlbGVnYXRlIGFuZCB0aGV5IHBsZWRnZSB0aG9zZQogICAgLy8vICBmdW5kcyB0byBhIHByb2plY3QKICAgIGZ1bmN0aW9uIHVwZGF0ZVByb2plY3QoCiAgICAgICAgdWludDY0IGlkUHJvamVjdCwKICAgICAgICBhZGRyZXNzIG5ld0FkZHIsCiAgICAgICAgc3RyaW5nIG5ld05hbWUsCiAgICAgICAgc3RyaW5nIG5ld1VybCwKICAgICAgICB1aW50NjQgbmV3Q29tbWl0VGltZSkKICAgIHsKICAgICAgICBQbGVkZ2VBZG1pbiBzdG9yYWdlIHByb2plY3QgPSBmaW5kQWRtaW4oaWRQcm9qZWN0KTsKICAgICAgICByZXF1aXJlKHByb2plY3QuYWRtaW5UeXBlID09IFBsZWRnZUFkbWluVHlwZS5Qcm9qZWN0KTsKICAgICAgICByZXF1aXJlKHByb2plY3QuYWRkciA9PSBtc2cuc2VuZGVyKTsKICAgICAgICBwcm9qZWN0LmFkZHIgPSBuZXdBZGRyOwogICAgICAgIHByb2plY3QubmFtZSA9IG5ld05hbWU7CiAgICAgICAgcHJvamVjdC51cmwgPSBuZXdVcmw7CiAgICAgICAgcHJvamVjdC5jb21taXRUaW1lID0gbmV3Q29tbWl0VGltZTsKICAgICAgICBQcm9qZWN0VXBkYXRlZChpZFByb2plY3QpOwogICAgfQoKICAgIGV2ZW50IFByb2plY3RVcGRhdGVkKHVpbnQ2NCBpbmRleGVkIGlkQWRtaW4pOwoKCi8vLy8vLy8vLy8KLy8gUHVibGljIGNvbnN0YW50IGZ1bmN0aW9ucwovLy8vLy8vLy8vCgogICAgLy8vIEBub3RpY2UgQSBjb25zdGFudCBnZXR0ZXIgdGhhdCByZXR1cm5zIHRoZSB0b3RhbCBudW1iZXIgb2YgcGxlZGdlcwogICAgLy8vIEByZXR1cm4gVGhlIHRvdGFsIG51bWJlciBvZiBQbGVkZ2VzIGluIHRoZSBzeXN0ZW0KICAgIGZ1bmN0aW9uIG51bWJlck9mUGxlZGdlcygpIGNvbnN0YW50IHJldHVybnMgKHVpbnQpIHsKICAgICAgICByZXR1cm4gcGxlZGdlcy5sZW5ndGggLSAxOwogICAgfQoKICAgIC8vLyBAbm90aWNlIEEgZ2V0dGVyIHRoYXQgcmV0dXJucyB0aGUgZGV0YWlscyBvZiB0aGUgc3BlY2lmaWVkIHBsZWRnZQogICAgLy8vIEBwYXJhbSBpZFBsZWRnZSB0aGUgaWQgbnVtYmVyIG9mIHRoZSBwbGVkZ2UgYmVpbmcgcXVlcmllZAogICAgLy8vIEByZXR1cm4gdGhlIGFtb3VudCwgb3duZXIsIHRoZSBudW1iZXIgb2YgZGVsZWdhdGVzIChidXQgbm90IHRoZSBhY3R1YWwKICAgIC8vLyAgZGVsZWdhdGVzLCB0aGUgaW50ZW5kZWRQcm9qZWN0IChpZiBhbnkpLCB0aGUgY3VycmVudCBjb21taXQgdGltZSBhbmQKICAgIC8vLyAgdGhlIHByZXZpb3VzIHBsZWRnZSB0aGlzIHBsZWRnZSB3YXMgZGVyaXZlZCBmcm9tCiAgICBmdW5jdGlvbiBnZXRQbGVkZ2UodWludDY0IGlkUGxlZGdlKSBjb25zdGFudCByZXR1cm5zKAogICAgICAgIHVpbnQgYW1vdW50LAogICAgICAgIHVpbnQ2NCBvd25lciwKICAgICAgICB1aW50NjQgbkRlbGVnYXRlcywKICAgICAgICB1aW50NjQgaW50ZW5kZWRQcm9qZWN0LAogICAgICAgIHVpbnQ2NCBjb21taXRUaW1lLAogICAgICAgIHVpbnQ2NCBvbGRQbGVkZ2UsCiAgICAgICAgUGxlZGdlU3RhdGUgcGxlZGdlU3RhdGUKICAgICkgewogICAgICAgIFBsZWRnZSBzdG9yYWdlIHAgPSBmaW5kUGxlZGdlKGlkUGxlZGdlKTsKICAgICAgICBhbW91bnQgPSBwLmFtb3VudDsKICAgICAgICBvd25lciA9IHAub3duZXI7CiAgICAgICAgbkRlbGVnYXRlcyA9IHVpbnQ2NChwLmRlbGVnYXRpb25DaGFpbi5sZW5ndGgpOwogICAgICAgIGludGVuZGVkUHJvamVjdCA9IHAuaW50ZW5kZWRQcm9qZWN0OwogICAgICAgIGNvbW1pdFRpbWUgPSBwLmNvbW1pdFRpbWU7CiAgICAgICAgb2xkUGxlZGdlID0gcC5vbGRQbGVkZ2U7CiAgICAgICAgcGxlZGdlU3RhdGUgPSBwLnBsZWRnZVN0YXRlOwogICAgfQoKICAgIC8vLyBAbm90aWNlIEdldHRlciB0byBmaW5kIERlbGVnYXRlIHcvIHRoZSBQbGVkZ2UgSUQgJiB0aGUgRGVsZWdhdGUgaW5kZXgKICAgIC8vLyBAcGFyYW0gaWRQbGVkZ2UgVGhlIGlkIG51bWJlciByZXByZXNlbnRpbmcgdGhlIHBsZWRnZSBiZWluZyBxdWVyaWVkCiAgICAvLy8gQHBhcmFtIGlkeERlbGVnYXRlIFRoZSBpbmRleCBudW1iZXIgZm9yIHRoZSBkZWxlZ2F0ZSBpbiB0aGlzIFBsZWRnZSAKICAgIGZ1bmN0aW9uIGdldFBsZWRnZURlbGVnYXRlKHVpbnQ2NCBpZFBsZWRnZSwgdWludCBpZHhEZWxlZ2F0ZSkgY29uc3RhbnQgcmV0dXJucygKICAgICAgICB1aW50NjQgaWREZWxlZ2F0ZSwKICAgICAgICBhZGRyZXNzIGFkZHIsCiAgICAgICAgc3RyaW5nIG5hbWUKICAgICkgewogICAgICAgIFBsZWRnZSBzdG9yYWdlIHAgPSBmaW5kUGxlZGdlKGlkUGxlZGdlKTsKICAgICAgICBpZERlbGVnYXRlID0gcC5kZWxlZ2F0aW9uQ2hhaW5baWR4RGVsZWdhdGUgLSAxXTsKICAgICAgICBQbGVkZ2VBZG1pbiBzdG9yYWdlIGRlbGVnYXRlID0gZmluZEFkbWluKGlkRGVsZWdhdGUpOwogICAgICAgIGFkZHIgPSBkZWxlZ2F0ZS5hZGRyOwogICAgICAgIG5hbWUgPSBkZWxlZ2F0ZS5uYW1lOwogICAgfQoKICAgIC8vLyBAbm90aWNlIEEgY29uc3RhbnQgZ2V0dGVyIHVzZWQgdG8gY2hlY2sgaG93IG1hbnkgdG90YWwgQWRtaW5zIGV4aXN0CiAgICAvLy8gQHJldHVybiBUaGUgdG90YWwgbnVtYmVyIG9mIGFkbWlucyAoR2l2ZXJzLCBEZWxlZ2F0ZXMgYW5kIFByb2plY3RzKSAuCiAgICBmdW5jdGlvbiBudW1iZXJPZlBsZWRnZUFkbWlucygpIGNvbnN0YW50IHJldHVybnModWludCkgewogICAgICAgIHJldHVybiBhZG1pbnMubGVuZ3RoIC0gMTsKICAgIH0KCiAgICAvLy8gQG5vdGljZSBBIGNvbnN0YW50IGdldHRlciB0byBjaGVjayB0aGUgZGV0YWlscyBvZiBhIHNwZWNpZmllZCBBZG1pbiAgCiAgICAvLy8gQHJldHVybiBhZGRyIEFjY291bnQgb3IgY29udHJhY3QgYWRkcmVzcyBmb3IgYWRtaW4KICAgIC8vLyBAcmV0dXJuIG5hbWUgTmFtZSBvZiB0aGUgcGxlZGdlQWRtaW4KICAgIC8vLyBAcmV0dXJuIHVybCBUaGUgbGluayB0byB0aGUgUHJvamVjdCdzIHByb2ZpbGUgb2Z0ZW4gYW4gSVBGUyBoYXNoCiAgICAvLy8gQHJldHVybiBjb21taXRUaW1lIFRoZSBsZW5ndGggb2YgdGltZSBpbiBzZWNvbmRzIHRoZSBBZG1pbiBoYXMgdG8gdmV0bwogICAgLy8vICAgd2hlbiB0aGUgQWRtaW4gZGVsZWdhdGVzIHRvIGEgRGVsZWdhdGUgYW5kIHRoYXQgRGVsZWdhdGUgcGxlZGdlcyB0aG9zZQogICAgLy8vICAgZnVuZHMgdG8gYSBwcm9qZWN0CiAgICAvLy8gQHJldHVybiBwYXJlbnRQcm9qZWN0IFRoZSBBZG1pbiBpZCBudW1iZXIgZm9yIHRoZSBwYXJlbnQgcHJvamVjdCBvciAwCiAgICAvLy8gIGlmIHRoZXJlIGlzIG5vIHBhcmVudFByb2plY3QKICAgIC8vLyBAcmV0dXJuIGNhbmNlbGVkIDAgZm9yIERlbGVnYXRlcyAmIEdpdmVycywgdHJ1ZSBpZiBhIFByb2plY3QgaGFzIGJlZW4gCiAgICAvLy8gIGNhbmNlbGVkCiAgICAvLy8gQHJldHVybiBwbHVnaW4gVGhpcyBpcyBQcm9qZWN0J3MgbGlxdWlkUGxlZGdpbmcgcGx1Z2luIGFsbG93aW5nIGZvciAKICAgIC8vLyAgZXh0ZW5kZWQgZnVuY3Rpb25hbGl0eQogICAgZnVuY3Rpb24gZ2V0UGxlZGdlQWRtaW4odWludDY0IGlkQWRtaW4pIGNvbnN0YW50IHJldHVybnMgKAogICAgICAgIFBsZWRnZUFkbWluVHlwZSBhZG1pblR5cGUsCiAgICAgICAgYWRkcmVzcyBhZGRyLAogICAgICAgIHN0cmluZyBuYW1lLAogICAgICAgIHN0cmluZyB1cmwsCiAgICAgICAgdWludDY0IGNvbW1pdFRpbWUsCiAgICAgICAgdWludDY0IHBhcmVudFByb2plY3QsCiAgICAgICAgYm9vbCBjYW5jZWxlZCwKICAgICAgICBhZGRyZXNzIHBsdWdpbikKICAgIHsKICAgICAgICBQbGVkZ2VBZG1pbiBzdG9yYWdlIG0gPSBmaW5kQWRtaW4oaWRBZG1pbik7CiAgICAgICAgYWRtaW5UeXBlID0gbS5hZG1pblR5cGU7CiAgICAgICAgYWRkciA9IG0uYWRkcjsKICAgICAgICBuYW1lID0gbS5uYW1lOwogICAgICAgIHVybCA9IG0udXJsOwogICAgICAgIGNvbW1pdFRpbWUgPSBtLmNvbW1pdFRpbWU7CiAgICAgICAgcGFyZW50UHJvamVjdCA9IG0ucGFyZW50UHJvamVjdDsKICAgICAgICBjYW5jZWxlZCA9IG0uY2FuY2VsZWQ7CiAgICAgICAgcGx1Z2luID0gYWRkcmVzcyhtLnBsdWdpbik7CiAgICB9CgovLy8vLy8vLwovLyBQcml2YXRlIG1ldGhvZHMKLy8vLy8vLwoKICAgIC8vLyBAbm90aWNlIFRoaXMgY3JlYXRlcyBhIFBsZWRnZSB3aXRoIGFuIGluaXRpYWwgYW1vdW50IG9mIDAgaWYgb25lIGlzIG5vdAogICAgLy8vICBjcmVhdGVkIGFscmVhZHk7IG90aGVyd2lzZSBpdCBmaW5kcyB0aGUgcGxlZGdlIHdpdGggdGhlIHNwZWNpZmllZAogICAgLy8vICBhdHRyaWJ1dGVzOyBhbGwgcGxlZGdlcyB0ZWNobmljYWxseSBleGlzdCwgaWYgdGhlIHBsZWRnZSBoYXNuJ3QgYmVlbgogICAgLy8vICBjcmVhdGVkIGluIHRoaXMgc3lzdGVtIHlldCBpdCBzaW1wbHkgaXNuJ3QgaW4gdGhlIGhhc2ggYXJyYXkKICAgIC8vLyAgaFBsZWRnZTJpZHhbXSB5ZXQKICAgIC8vLyBAcGFyYW0gb3duZXIgVGhlIG93bmVyIG9mIHRoZSBwbGVkZ2UgYmVpbmcgbG9va2VkIHVwCiAgICAvLy8gQHBhcmFtIGRlbGVnYXRpb25DaGFpbiBUaGUgbGlzdCBvZiBkZWxlZ2F0ZXMgaW4gb3JkZXIgb2YgYXV0aG9yaXR5CiAgICAvLy8gQHBhcmFtIGludGVuZGVkUHJvamVjdCBUaGUgcHJvamVjdCB0aGlzIHBsZWRnZSB3aWxsIEZ1bmQgYWZ0ZXIgdGhlCiAgICAvLy8gIGNvbW1pdFRpbWUgaGFzIHBhc3NlZAogICAgLy8vIEBwYXJhbSBjb21taXRUaW1lIFRoZSBsZW5ndGggb2YgdGltZSBpbiBzZWNvbmRzIHRoZSBHaXZlciBoYXMgdG8KICAgIC8vLyAgIHZldG8gd2hlbiB0aGUgR2l2ZXIncyBkZWxlZ2F0ZXMgUGxlZGdlIGZ1bmRzIHRvIGEgcHJvamVjdAogICAgLy8vIEBwYXJhbSBvbGRQbGVkZ2UgVGhpcyB2YWx1ZSBpcyB1c2VkIHRvIHN0b3JlIHRoZSBwbGVkZ2UgdGhlIGN1cnJlbnQKICAgIC8vLyAgcGxlZGdlIHdhcyBjYW1lIGZyb20sIGFuZCBpbiB0aGUgY2FzZSBhIFByb2plY3QgaXMgY2FuY2VsZWQsIHRoZSBQbGVkZ2UKICAgIC8vLyAgd2lsbCByZXZlcnQgYmFjayB0byBpdCdzIHByZXZpb3VzIHN0YXRlCiAgICAvLy8gQHBhcmFtIHN0YXRlIFRoZSBwbGVkZ2Ugc3RhdGU6IFBsZWRnZWQsIFBheWluZywgb3Igc3RhdGUKICAgIC8vLyBAcmV0dXJuIFRoZSBoUGxlZGdlMmlkeCBpbmRleCBudW1iZXIKICAgIGZ1bmN0aW9uIGZpbmRPckNyZWF0ZVBsZWRnZSgKICAgICAgICB1aW50NjQgb3duZXIsCiAgICAgICAgdWludDY0W10gZGVsZWdhdGlvbkNoYWluLAogICAgICAgIHVpbnQ2NCBpbnRlbmRlZFByb2plY3QsCiAgICAgICAgdWludDY0IGNvbW1pdFRpbWUsCiAgICAgICAgdWludDY0IG9sZFBsZWRnZSwKICAgICAgICBQbGVkZ2VTdGF0ZSBzdGF0ZQogICAgICAgICkgaW50ZXJuYWwgcmV0dXJucyAodWludDY0KQogICAgewogICAgICAgIGJ5dGVzMzIgaFBsZWRnZSA9IHNoYTMoCiAgICAgICAgICAgIG93bmVyLCBkZWxlZ2F0aW9uQ2hhaW4sIGludGVuZGVkUHJvamVjdCwgY29tbWl0VGltZSwgb2xkUGxlZGdlLCBzdGF0ZSk7CiAgICAgICAgdWludDY0IGlkeCA9IGhQbGVkZ2UyaWR4W2hQbGVkZ2VdOwogICAgICAgIGlmIChpZHggPiAwKSByZXR1cm4gaWR4OwogICAgICAgIGlkeCA9IHVpbnQ2NChwbGVkZ2VzLmxlbmd0aCk7CiAgICAgICAgaFBsZWRnZTJpZHhbaFBsZWRnZV0gPSBpZHg7CiAgICAgICAgcGxlZGdlcy5wdXNoKFBsZWRnZSgKICAgICAgICAgICAgMCwgb3duZXIsIGRlbGVnYXRpb25DaGFpbiwgaW50ZW5kZWRQcm9qZWN0LCBjb21taXRUaW1lLCBvbGRQbGVkZ2UsIHN0YXRlKSk7CiAgICAgICAgcmV0dXJuIGlkeDsKICAgIH0KCiAgICAvLy8gQG5vdGljZSBBIGdldHRlciB0byBsb29rIHVwIGEgQWRtaW4ncyBkZXRhaWxzCiAgICAvLy8gQHBhcmFtIGlkQWRtaW4gVGhlIGlkIGZvciB0aGUgQWRtaW4gdG8gbG9va3VwCiAgICAvLy8gQHJldHVybiBUaGUgUGxlZGdlQWRtaW4gc3RydWN0IGZvciB0aGUgc3BlY2lmaWVkIEFkbWluCiAgICBmdW5jdGlvbiBmaW5kQWRtaW4odWludDY0IGlkQWRtaW4pIGludGVybmFsIHJldHVybnMgKFBsZWRnZUFkbWluIHN0b3JhZ2UpIHsKICAgICAgICByZXF1aXJlKGlkQWRtaW4gPCBhZG1pbnMubGVuZ3RoKTsKICAgICAgICByZXR1cm4gYWRtaW5zW2lkQWRtaW5dOwogICAgfQoKICAgIC8vLyBAbm90aWNlIEEgZ2V0dGVyIHRvIGxvb2sgdXAgYSBQbGVkZ2UncyBkZXRhaWxzCiAgICAvLy8gQHBhcmFtIGlkUGxlZGdlIFRoZSBpZCBmb3IgdGhlIFBsZWRnZSB0byBsb29rdXAKICAgIC8vLyBAcmV0dXJuIFRoZSBQbGVkZ2VBIHN0cnVjdCBmb3IgdGhlIHNwZWNpZmllZCBQbGVkZ2UKICAgIGZ1bmN0aW9uIGZpbmRQbGVkZ2UodWludDY0IGlkUGxlZGdlKSBpbnRlcm5hbCByZXR1cm5zIChQbGVkZ2Ugc3RvcmFnZSkgewogICAgICAgIHJlcXVpcmUoaWRQbGVkZ2UgPCBwbGVkZ2VzLmxlbmd0aCk7CiAgICAgICAgcmV0dXJuIHBsZWRnZXNbaWRQbGVkZ2VdOwogICAgfQoKICAgIC8vIGEgY29uc3RhbnQgZm9yIHdoZW4gYSBkZWxlZ2F0ZSBpcyByZXF1ZXN0ZWQgdGhhdCBpcyBub3QgaW4gdGhlIHN5c3RlbQogICAgdWludDY0IGNvbnN0YW50ICBOT1RGT1VORCA9IDB4RkZGRkZGRkZGRkZGRkZGRjsKCiAgICAvLy8gQG5vdGljZSBBIGdldHRlciB0aGF0IHNlYXJjaGVzIHRoZSBkZWxlZ2F0aW9uQ2hhaW4gZm9yIHRoZSBsZXZlbCBvZgogICAgLy8vICBhdXRob3JpdHkgYSBzcGVjaWZpYyBkZWxlZ2F0ZSBoYXMgd2l0aGluIGEgUGxlZGdlCiAgICAvLy8gQHBhcmFtIHAgVGhlIFBsZWRnZSB0aGF0IHdpbGwgYmUgc2VhcmNoZWQKICAgIC8vLyBAcGFyYW0gaWREZWxlZ2F0ZSBUaGUgc3BlY2lmaWVkIGRlbGVnYXRlIHRoYXQncyBzZWFyY2hlZCBmb3IKICAgIC8vLyBAcmV0dXJuIElmIHRoZSBkZWxlZ2F0ZSBjaGFpbiBjb250YWlucyB0aGUgZGVsZWdhdGUgd2l0aCB0aGUKICAgIC8vLyAgYGFkbWluc2AgYXJyYXkgaW5kZXggYGlkRGVsZWdhdGVgIHRoaXMgcmV0dXJucyB0aGF0IGRlbGVnYXRlcwogICAgLy8vICBjb3JyZXNwb25kaW5nIGluZGV4IGluIHRoZSBkZWxlZ2F0aW9uQ2hhaW4uIE90aGVyd2lzZSBpdCByZXR1cm5zCiAgICAvLy8gIHRoZSBOT1RGT1VORCBjb25zdGFudAogICAgZnVuY3Rpb24gZ2V0RGVsZWdhdGVJZHgoUGxlZGdlIHAsIHVpbnQ2NCBpZERlbGVnYXRlKSBpbnRlcm5hbCByZXR1cm5zKHVpbnQ2NCkgewogICAgICAgIGZvciAodWludCBpPTA7IGkgPCBwLmRlbGVnYXRpb25DaGFpbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBpZiAocC5kZWxlZ2F0aW9uQ2hhaW5baV0gPT0gaWREZWxlZ2F0ZSkgcmV0dXJuIHVpbnQ2NChpKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIE5PVEZPVU5EOwogICAgfQoKICAgIC8vLyBAbm90aWNlIEEgZ2V0dGVyIHRvIGZpbmQgaG93IG1hbnkgb2xkICJwYXJlbnQiIHBsZWRnZXMgYSBzcGVjaWZpYyBQbGVkZ2UKICAgIC8vLyAgaGFkIHVzaW5nIGEgc2VsZi1yZWZlcmVudGlhbCBsb29wCiAgICAvLy8gQHBhcmFtIHAgVGhlIFBsZWRnZSBiZWluZyBxdWVyaWVkCiAgICAvLy8gQHJldHVybiBUaGUgbnVtYmVyIG9mIG9sZCAicGFyZW50IiBwbGVkZ2VzIGEgc3BlY2lmaWMgUGxlZGdlIGhhZAogICAgZnVuY3Rpb24gZ2V0UGxlZGdlTGV2ZWwoUGxlZGdlIHApIGludGVybmFsIHJldHVybnModWludCkgewogICAgICAgIGlmIChwLm9sZFBsZWRnZSA9PSAwKSByZXR1cm4gMDsKICAgICAgICBQbGVkZ2Ugc3RvcmFnZSBvbGROID0gZmluZFBsZWRnZShwLm9sZFBsZWRnZSk7CiAgICAgICAgcmV0dXJuIGdldFBsZWRnZUxldmVsKG9sZE4pICsgMTsgLy8gYSBsb29wIGxvb2t1cAogICAgfQoKICAgIC8vLyBAbm90aWNlIEEgZ2V0dGVyIHRvIGZpbmQgdGhlIGxvbmdlc3QgY29tbWl0VGltZSBvdXQgb2YgdGhlIG93bmVyIGFuZCBhbGwKICAgIC8vLyAgdGhlIGRlbGVnYXRlcyBmb3IgYSBzcGVjaWZpZWQgcGxlZGdlCiAgICAvLy8gQHBhcmFtIHAgVGhlIFBsZWRnZSBiZWluZyBxdWVyaWVkCiAgICAvLy8gQHJldHVybiBUaGUgbWF4aW11bSBjb21taXRUaW1lIG91dCBvZiB0aGUgb3duZXIgYW5kIGFsbCB0aGUgZGVsZWdhdGVzCiAgICBmdW5jdGlvbiBtYXhDb21taXRUaW1lKFBsZWRnZSBwKSBpbnRlcm5hbCByZXR1cm5zKHVpbnQgY29tbWl0VGltZSkgewogICAgICAgIFBsZWRnZUFkbWluIHN0b3JhZ2UgbSA9IGZpbmRBZG1pbihwLm93bmVyKTsKICAgICAgICBjb21taXRUaW1lID0gbS5jb21taXRUaW1lOyAvLyBzdGFydCB3aXRoIHRoZSBvd25lcidzIGNvbW1pdFRpbWUKCiAgICAgICAgZm9yICh1aW50IGk9MDsgaTxwLmRlbGVnYXRpb25DaGFpbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBtID0gZmluZEFkbWluKHAuZGVsZWdhdGlvbkNoYWluW2ldKTsKCiAgICAgICAgICAgIC8vIElmIGEgZGVsZWdhdGUncyBjb21taXRUaW1lIGlzIGxvbmdlciwgbWFrZSBpdCB0aGUgbmV3IGNvbW1pdFRpbWUKICAgICAgICAgICAgaWYgKG0uY29tbWl0VGltZSA+IGNvbW1pdFRpbWUpIGNvbW1pdFRpbWUgPSBtLmNvbW1pdFRpbWU7CiAgICAgICAgfQogICAgfQoKICAgIC8vLyBAbm90aWNlIEEgZ2V0dGVyIHRvIGZpbmQgdGhlIGxldmVsIG9mIGF1dGhvcml0eSBhIHNwZWNpZmljIFByb2plY3QgaGFzCiAgICAvLy8gIHVzaW5nIGEgc2VsZi1yZWZlcmVudGlhbCBsb29wCiAgICAvLy8gQHBhcmFtIG0gVGhlIFByb2plY3QgYmVpbmcgcXVlcmllZAogICAgLy8vIEByZXR1cm4gVGhlIGxldmVsIG9mIGF1dGhvcml0eSBhIHNwZWNpZmljIFByb2plY3QgaGFzCiAgICBmdW5jdGlvbiBnZXRQcm9qZWN0TGV2ZWwoUGxlZGdlQWRtaW4gbSkgaW50ZXJuYWwgcmV0dXJucyh1aW50KSB7CiAgICAgICAgYXNzZXJ0KG0uYWRtaW5UeXBlID09IFBsZWRnZUFkbWluVHlwZS5Qcm9qZWN0KTsKICAgICAgICBpZiAobS5wYXJlbnRQcm9qZWN0ID09IDApIHJldHVybigxKTsKICAgICAgICBQbGVkZ2VBZG1pbiBzdG9yYWdlIHBhcmVudE5NID0gZmluZEFkbWluKG0ucGFyZW50UHJvamVjdCk7CiAgICAgICAgcmV0dXJuIGdldFByb2plY3RMZXZlbChwYXJlbnROTSkgKyAxOwogICAgfQoKICAgIC8vLyBAbm90aWNlIEEgZ2V0dGVyIHRvIGZpbmQgaWYgYSBzcGVjaWZpZWQgUHJvamVjdCBoYXMgYmVlbiBjYW5jZWxlZAogICAgLy8vIEBwYXJhbSBwcm9qZWN0SWQgVGhlIEFkbWluIGlkIG51bWJlciB1c2VkIHRvIHNwZWNpZnkgdGhlIFByb2plY3QKICAgIC8vLyBAcmV0dXJuIFRydWUgaWYgdGhlIFByb2plY3QgaGFzIGJlZW4gY2FuY2VsZWQKICAgIGZ1bmN0aW9uIGlzUHJvamVjdENhbmNlbGVkKHVpbnQ2NCBwcm9qZWN0SWQpIGNvbnN0YW50IHJldHVybnMgKGJvb2wpIHsKICAgICAgICBQbGVkZ2VBZG1pbiBzdG9yYWdlIG0gPSBmaW5kQWRtaW4ocHJvamVjdElkKTsKICAgICAgICBpZiAobS5hZG1pblR5cGUgPT0gUGxlZGdlQWRtaW5UeXBlLkdpdmVyKSByZXR1cm4gZmFsc2U7CiAgICAgICAgYXNzZXJ0KG0uYWRtaW5UeXBlID09IFBsZWRnZUFkbWluVHlwZS5Qcm9qZWN0KTsKICAgICAgICBpZiAobS5jYW5jZWxlZCkgcmV0dXJuIHRydWU7CiAgICAgICAgaWYgKG0ucGFyZW50UHJvamVjdCA9PSAwKSByZXR1cm4gZmFsc2U7CiAgICAgICAgcmV0dXJuIGlzUHJvamVjdENhbmNlbGVkKG0ucGFyZW50UHJvamVjdCk7CiAgICB9CgogICAgLy8vIEBub3RpY2UgQSBnZXR0ZXIgdG8gZmluZCB0aGUgb2xkZXN0IHBsZWRnZSB0aGF0IGhhc24ndCBiZWVuIGNhbmNlbGVkCiAgICAvLy8gQHBhcmFtIGlkUGxlZGdlIFRoZSBzdGFydGluZyBwbGFjZSB0byBsb29rdXAgdGhlIHBsZWRnZXMgCiAgICAvLy8gQHJldHVybiBUaGUgb2xkZXN0IGlkUGxlZGdlIHRoYXQgaGFzbid0IGJlZW4gY2FuY2VsZWQgKERVSCEpCiAgICBmdW5jdGlvbiBnZXRPbGRlc3RQbGVkZ2VOb3RDYW5jZWxlZCh1aW50NjQgaWRQbGVkZ2UKICAgICAgICApIGludGVybmFsIGNvbnN0YW50IHJldHVybnModWludDY0KSB7CiAgICAgICAgaWYgKGlkUGxlZGdlID09IDApIHJldHVybiAwOwogICAgICAgIFBsZWRnZSBzdG9yYWdlIHAgPSBmaW5kUGxlZGdlKGlkUGxlZGdlKTsKICAgICAgICBQbGVkZ2VBZG1pbiBzdG9yYWdlIGFkbWluID0gZmluZEFkbWluKHAub3duZXIpOwogICAgICAgIGlmIChhZG1pbi5hZG1pblR5cGUgPT0gUGxlZGdlQWRtaW5UeXBlLkdpdmVyKSByZXR1cm4gaWRQbGVkZ2U7CgogICAgICAgIGFzc2VydChhZG1pbi5hZG1pblR5cGUgPT0gUGxlZGdlQWRtaW5UeXBlLlByb2plY3QpOwoKICAgICAgICBpZiAoIWlzUHJvamVjdENhbmNlbGVkKHAub3duZXIpKSByZXR1cm4gaWRQbGVkZ2U7CgogICAgICAgIHJldHVybiBnZXRPbGRlc3RQbGVkZ2VOb3RDYW5jZWxlZChwLm9sZFBsZWRnZSk7CiAgICB9CgogICAgLy8vIEBub3RpY2UgQSBjaGVjayB0byBzZWUgaWYgdGhlIG1zZy5zZW5kZXIgaXMgdGhlIG93bmVyIG9yIHRoZQogICAgLy8vICBwbHVnaW4gY29udHJhY3QgZm9yIGEgc3BlY2lmaWMgQWRtaW4KICAgIC8vLyBAcGFyYW0gbSBUaGUgQWRtaW4gYmVpbmcgY2hlY2tlZAogICAgZnVuY3Rpb24gY2hlY2tBZG1pbk93bmVyKFBsZWRnZUFkbWluIG0pIGludGVybmFsIGNvbnN0YW50IHsKICAgICAgICByZXF1aXJlKChtc2cuc2VuZGVyID09IG0uYWRkcikgfHwgKG1zZy5zZW5kZXIgPT0gYWRkcmVzcyhtLnBsdWdpbikpKTsKICAgIH0KLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCi8vIFBsdWdpbiBXaGl0ZWxpc3QgTWV0aG9kcwovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCiAgICBmdW5jdGlvbiBhZGRWYWxpZFBsdWdpbihieXRlczMyIGNvbnRyYWN0SGFzaCkgZXh0ZXJuYWwgb25seU93bmVyIHsKICAgICAgICBwbHVnaW5XaGl0ZWxpc3RbY29udHJhY3RIYXNoXSA9IHRydWU7CiAgICB9CgogICAgZnVuY3Rpb24gcmVtb3ZlVmFsaWRQbHVnaW4oYnl0ZXMzMiBjb250cmFjdEhhc2gpIGV4dGVybmFsIG9ubHlPd25lciB7CiAgICAgICAgcGx1Z2luV2hpdGVsaXN0W2NvbnRyYWN0SGFzaF0gPSBmYWxzZTsKICAgIH0KCiAgICBmdW5jdGlvbiB1c2VXaGl0ZWxpc3QoYm9vbCB1c2VXaGl0ZWxpc3QpIGV4dGVybmFsIG9ubHlPd25lciB7CiAgICAgICAgdXNlUGx1Z2luV2hpdGVsaXN0ID0gdXNlV2hpdGVsaXN0OwogICAgfQoKICAgIGZ1bmN0aW9uIGlzVmFsaWRQbHVnaW4oYWRkcmVzcyBhZGRyKSBwdWJsaWMgcmV0dXJucyhib29sKSB7CiAgICAgICAgaWYgKCF1c2VQbHVnaW5XaGl0ZWxpc3QgfHwgYWRkciA9PSAweDApIHJldHVybiB0cnVlOwoKICAgICAgICBieXRlczMyIGNvbnRyYWN0SGFzaCA9IGdldENvZGVIYXNoKGFkZHIpOwoKICAgICAgICByZXR1cm4gcGx1Z2luV2hpdGVsaXN0W2NvbnRyYWN0SGFzaF07CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0Q29kZUhhc2goYWRkcmVzcyBhZGRyKSBwdWJsaWMgcmV0dXJucyhieXRlczMyKSB7CiAgICAgICAgYnl0ZXMgbWVtb3J5IG9fY29kZTsKICAgICAgICBhc3NlbWJseSB7CiAgICAgICAgICAgIC8vIHJldHJpZXZlIHRoZSBzaXplIG9mIHRoZSBjb2RlLCB0aGlzIG5lZWRzIGFzc2VtYmx5CiAgICAgICAgICAgIGxldCBzaXplIDo9IGV4dGNvZGVzaXplKGFkZHIpCiAgICAgICAgICAgIC8vIGFsbG9jYXRlIG91dHB1dCBieXRlIGFycmF5IC0gdGhpcyBjb3VsZCBhbHNvIGJlIGRvbmUgd2l0aG91dCBhc3NlbWJseQogICAgICAgICAgICAvLyBieSB1c2luZyBvX2NvZGUgPSBuZXcgYnl0ZXMoc2l6ZSkKICAgICAgICAgICAgb19jb2RlIDo9IG1sb2FkKDB4NDApCiAgICAgICAgICAgIC8vIG5ldyAibWVtb3J5IGVuZCIgaW5jbHVkaW5nIHBhZGRpbmcKICAgICAgICAgICAgbXN0b3JlKDB4NDAsIGFkZChvX2NvZGUsIGFuZChhZGQoYWRkKHNpemUsIDB4MjApLCAweDFmKSwgbm90KDB4MWYpKSkpCiAgICAgICAgICAgIC8vIHN0b3JlIGxlbmd0aCBpbiBtZW1vcnkKICAgICAgICAgICAgbXN0b3JlKG9fY29kZSwgc2l6ZSkKICAgICAgICAgICAgLy8gYWN0dWFsbHkgcmV0cmlldmUgdGhlIGNvZGUsIHRoaXMgbmVlZHMgYXNzZW1ibHkKICAgICAgICAgICAgZXh0Y29kZWNvcHkoYWRkciwgYWRkKG9fY29kZSwgMHgyMCksIDAsIHNpemUpCiAgICAgICAgfQogICAgICAgIHJldHVybiBrZWNjYWsyNTYob19jb2RlKTsKICAgIH0KfQoKLy9GaWxlOiBub2RlX21vZHVsZXMvZ2l2ZXRoLWxpcXVpZHBsZWRnaW5nL2NvbnRyYWN0cy9MaXF1aWRQbGVkZ2luZy5zb2wKcHJhZ21hIHNvbGlkaXR5IF4wLjQuMTE7CgovKgogICAgQ29weXJpZ2h0IDIwMTcsIEpvcmRpIEJheWxpbmEKICAgIENvbnRyaWJ1dG9yczogQWRyaSYjMjI0OyBNYXNzYW5ldCA8PHNwYW4gY2xhc3M9Il9fY2ZfZW1haWxfXyIgZGF0YS1jZmVtYWlsPSJlOTg4OGQ5YjgwODhhOThhODY4ZDhjOGE4Njg3OWQ4YzkxOWRjNzgwODYiPltlbWFpbCYjMTYwO3Byb3RlY3RlZF08L3NwYW4+PiwgUkogRXdpbmcsIEdyaWZmCiAgICBHcmVlbiwgQXJ0aHVyIEx1bm4KCiAgICBUaGlzIHByb2dyYW0gaXMgZnJlZSBzb2Z0d2FyZTogeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yIG1vZGlmeQogICAgaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhcyBwdWJsaXNoZWQgYnkKICAgIHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb24sIGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlIExpY2Vuc2UsIG9yCiAgICAoYXQgeW91ciBvcHRpb24pIGFueSBsYXRlciB2ZXJzaW9uLgoKICAgIFRoaXMgcHJvZ3JhbSBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0IGl0IHdpbGwgYmUgdXNlZnVsLAogICAgYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2YKICAgIE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gIFNlZSB0aGUKICAgIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuCgogICAgWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UKICAgIGFsb25nIHdpdGggdGhpcyBwcm9ncmFtLiAgSWYgbm90LCBzZWUgPGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8+LgoqLwoKCgovLy8gQGRldiBgTGlxdWlkUGxlZGluZ2AgYWxsb3dzIGZvciBsaXF1aWQgcGxlZGdpbmcgdGhyb3VnaCB0aGUgdXNlIG9mCi8vLyAgaW50ZXJuYWwgaWQgc3RydWN0dXJlcyBhbmQgZGVsZWdhdGUgY2hhaW5pbmcuIEFsbCBiYXNpYyBvcGVyYXRpb25zIGZvcgovLy8gIGhhbmRsaW5nIGxpcXVpZCBwbGVkZ2luZyBhcmUgc3VwcGxpZWQgYXMgd2VsbCBhcyBwbHVnaW4gZmVhdHVyZXMKLy8vICB0byBhbGxvdyBmb3IgZXhwYW5kZWQgZnVuY3Rpb25hbGl0eS4KY29udHJhY3QgTGlxdWlkUGxlZGdpbmcgaXMgTGlxdWlkUGxlZGdpbmdCYXNlIHsKCgovLy8vLy8KLy8gQ29uc3RydWN0b3IKLy8vLy8vCgogICAgLy8vIEBub3RpY2UgQmFzaWMgY29uc3RydWN0b3IgZm9yIExpcXVpZFBsZWRpbmcsIGFsc28gY2FsbHMgdGhlCiAgICAvLy8gIExpcXVpZFBsZWRnaW5nQmFzZSBjb250cmFjdAogICAgLy8vIEBkZXYgVGhpcyBjb25zdHJ1Y3RvciAgYWxzbyBjYWxscyB0aGUgY29uc3RydWN0b3IgCiAgICAvLy8gIGZvciBgTGlxdWlkUGxlZGdpbmdCYXNlYAogICAgLy8vIEBwYXJhbSBfdmF1bHQgVGhlIHZhdWx0IHdoZXJlIEVUSCBiYWNraW5nIHRoaXMgcGxlZGdlIGlzIHN0b3JlZAogICAgZnVuY3Rpb24gTGlxdWlkUGxlZGdpbmcoCiAgICAgICAgYWRkcmVzcyBfdmF1bHQsCiAgICAgICAgYWRkcmVzcyBfZXNjYXBlSGF0Y2hDYWxsZXIsCiAgICAgICAgYWRkcmVzcyBfZXNjYXBlSGF0Y2hEZXN0aW5hdGlvbgogICAgKSBMaXF1aWRQbGVkZ2luZ0Jhc2UoX3ZhdWx0LCBfZXNjYXBlSGF0Y2hDYWxsZXIsIF9lc2NhcGVIYXRjaERlc3RpbmF0aW9uKSB7CgogICAgfQoKICAgIC8vLyBAbm90aWNlIFRoaXMgaXMgaG93IHZhbHVlIGVudGVycyB0aGUgc3lzdGVtIGFuZCBob3cgcGxlZGdlcyBhcmUgY3JlYXRlZDsKICAgIC8vLyAgdGhlIGV0aGVyIGlzIHNlbnQgdG8gdGhlIHZhdWx0LCBhbiBwbGVkZ2UgZm9yIHRoZSBHaXZlciBpcyBjcmVhdGVkIChvcgogICAgLy8vICBmb3VuZCksIHRoZSBhbW91bnQgb2YgRVRIIGRvbmF0ZWQgaW4gd2VpIGlzIGFkZGVkIHRvIHRoZSBgYW1vdW50YCBpbgogICAgLy8vICB0aGUgR2l2ZXIncyBQbGVkZ2UsIGFuZCBhbiBMUCB0cmFuc2ZlciBpcyBkb25lIHRvIHRoZSBpZFJlY2VpdmVyIGZvcgogICAgLy8vICB0aGUgZnVsbCBhbW91bnQKICAgIC8vLyBAcGFyYW0gaWRHaXZlciBUaGUgaWQgb2YgdGhlIEdpdmVyIGRvbmF0aW5nOyBpZiAwLCBhIG5ldyBpZCBpcyBjcmVhdGVkCiAgICAvLy8gQHBhcmFtIGlkUmVjZWl2ZXIgVGhlIEFkbWluIHJlY2VpdmluZyB0aGUgZG9uYXRpb247IGNhbiBiZSBhbnkgQWRtaW46CiAgICAvLy8gIHRoZSBHaXZlciB0aGVtc2VsdmVzLCBhbm90aGVyIEdpdmVyLCBhIERlbGVnYXRlIG9yIGEgUHJvamVjdAogICAgZnVuY3Rpb24gZG9uYXRlKHVpbnQ2NCBpZEdpdmVyLCB1aW50NjQgaWRSZWNlaXZlcikgcGF5YWJsZSB7CiAgICAgICAgaWYgKGlkR2l2ZXIgPT0gMCkgewoKICAgICAgICAgICAgLy8gZGVmYXVsdCB0byBhIDMgZGF5ICgyNTkyMDAgc2Vjb25kcykgY29tbWl0VGltZQogICAgICAgICAgICBpZEdpdmVyID0gYWRkR2l2ZXIoIiIsICIiLCAyNTkyMDAsIElMaXF1aWRQbGVkZ2luZ1BsdWdpbigweDApKTsKICAgICAgICB9CgogICAgICAgIFBsZWRnZUFkbWluIHN0b3JhZ2Ugc2VuZGVyID0gZmluZEFkbWluKGlkR2l2ZXIpOwogICAgICAgIGNoZWNrQWRtaW5Pd25lcihzZW5kZXIpOwogICAgICAgIHJlcXVpcmUoc2VuZGVyLmFkbWluVHlwZSA9PSBQbGVkZ2VBZG1pblR5cGUuR2l2ZXIpOwogICAgICAgIHVpbnQgYW1vdW50ID0gbXNnLnZhbHVlOwogICAgICAgIHJlcXVpcmUoYW1vdW50ID4gMCk7CiAgICAgICAgdmF1bHQudHJhbnNmZXIoYW1vdW50KTsgLy8gU2VuZHMgdGhlIGBtc2cudmFsdWVgIChpbiB3ZWkpIHRvIHRoZSBgdmF1bHRgCiAgICAgICAgdWludDY0IGlkUGxlZGdlID0gZmluZE9yQ3JlYXRlUGxlZGdlKAogICAgICAgICAgICBpZEdpdmVyLAogICAgICAgICAgICBuZXcgdWludDY0W10oMCksIC8vIENyZWF0ZXMgZW1wdHkgYXJyYXkgZm9yIGRlbGVnYXRpb25DaGFpbgogICAgICAgICAgICAwLAogICAgICAgICAgICAwLAogICAgICAgICAgICAwLAogICAgICAgICAgICBQbGVkZ2VTdGF0ZS5QbGVkZ2VkCiAgICAgICAgKTsKCgogICAgICAgIFBsZWRnZSBzdG9yYWdlIG5UbyA9IGZpbmRQbGVkZ2UoaWRQbGVkZ2UpOwogICAgICAgIG5Uby5hbW91bnQgKz0gYW1vdW50OwoKICAgICAgICBUcmFuc2ZlcigwLCBpZFBsZWRnZSwgYW1vdW50KTsgLy8gQW4gZXZlbnQKCiAgICAgICAgdHJhbnNmZXIoaWRHaXZlciwgaWRQbGVkZ2UsIGFtb3VudCwgaWRSZWNlaXZlcik7IC8vIExQIGFjY291bnRpbmcKICAgIH0KCiAgICAvLy8gQG5vdGljZSBUcmFuc2ZlcnMgYW1vdW50cyBiZXR3ZWVuIHBsZWRnZXMgZm9yIGludGVybmFsIGFjY291bnRpbmcgCiAgICAvLy8gQHBhcmFtIGlkU2VuZGVyIElkIG9mIHRoZSBBZG1pbiB0aGF0IGlzIHRyYW5zZmVycmluZyB0aGUgYW1vdW50IGZyb20KICAgIC8vLyAgUGxlZGdlIHRvIFBsZWRnZTsgdGhpcyBhZG1pbiBtdXN0IGhhdmUgcGVybWlzc2lvbnMgdG8gbW92ZSB0aGUgdmFsdWUKICAgIC8vLyBAcGFyYW0gaWRQbGVkZ2UgSWQgb2YgdGhlIHBsZWRnZSB0aGF0J3MgbW92aW5nIHRoZSB2YWx1ZQogICAgLy8vIEBwYXJhbSBhbW91bnQgUXVhbnRpdHkgb2YgRVRIIChpbiB3ZWkpIHRoYXQgdGhpcyBwbGVkZ2UgaXMgdHJhbnNmZXJyaW5nIAogICAgLy8vICB0aGUgYXV0aG9yaXR5IHRvIHdpdGhkcmF3IGZyb20gdGhlIHZhdWx0CiAgICAvLy8gQHBhcmFtIGlkUmVjZWl2ZXIgRGVzdGluYXRpb24gb2YgdGhlIGBhbW91bnRgLCBjYW4gYmUgYSBHaXZlci9Qcm9qZWN0IHNlbmRpbmcKICAgIC8vLyAgdG8gYSBHaXZlciwgYSBEZWxlZ2F0ZSBvciBhIFByb2plY3Q7IGEgRGVsZWdhdGUgc2VuZGluZyB0byBhbm90aGVyCiAgICAvLy8gIERlbGVnYXRlLCBvciBhIERlbGVnYXRlIHByZS1jb21taXRpbmcgaXQgdG8gYSBQcm9qZWN0IAogICAgZnVuY3Rpb24gdHJhbnNmZXIoIAogICAgICAgIHVpbnQ2NCBpZFNlbmRlciwKICAgICAgICB1aW50NjQgaWRQbGVkZ2UsCiAgICAgICAgdWludCBhbW91bnQsCiAgICAgICAgdWludDY0IGlkUmVjZWl2ZXIKICAgICl7CgogICAgICAgIGlkUGxlZGdlID0gbm9ybWFsaXplUGxlZGdlKGlkUGxlZGdlKTsKCiAgICAgICAgUGxlZGdlIHN0b3JhZ2UgcCA9IGZpbmRQbGVkZ2UoaWRQbGVkZ2UpOwogICAgICAgIFBsZWRnZUFkbWluIHN0b3JhZ2UgcmVjZWl2ZXIgPSBmaW5kQWRtaW4oaWRSZWNlaXZlcik7CiAgICAgICAgUGxlZGdlQWRtaW4gc3RvcmFnZSBzZW5kZXIgPSBmaW5kQWRtaW4oaWRTZW5kZXIpOwoKICAgICAgICBjaGVja0FkbWluT3duZXIoc2VuZGVyKTsKICAgICAgICByZXF1aXJlKHAucGxlZGdlU3RhdGUgPT0gUGxlZGdlU3RhdGUuUGxlZGdlZCk7CgogICAgICAgIC8vIElmIHRoZSBzZW5kZXIgaXMgdGhlIG93bmVyIG9mIHRoZSBQbGVkZ2UKICAgICAgICBpZiAocC5vd25lciA9PSBpZFNlbmRlcikgewoKICAgICAgICAgICAgaWYgKHJlY2VpdmVyLmFkbWluVHlwZSA9PSBQbGVkZ2VBZG1pblR5cGUuR2l2ZXIpIHsKICAgICAgICAgICAgICAgIHRyYW5zZmVyT3duZXJzaGlwVG9HaXZlcihpZFBsZWRnZSwgYW1vdW50LCBpZFJlY2VpdmVyKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChyZWNlaXZlci5hZG1pblR5cGUgPT0gUGxlZGdlQWRtaW5UeXBlLlByb2plY3QpIHsKICAgICAgICAgICAgICAgIHRyYW5zZmVyT3duZXJzaGlwVG9Qcm9qZWN0KGlkUGxlZGdlLCBhbW91bnQsIGlkUmVjZWl2ZXIpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHJlY2VpdmVyLmFkbWluVHlwZSA9PSBQbGVkZ2VBZG1pblR5cGUuRGVsZWdhdGUpIHsKCiAgICAgICAgICAgICAgICB1aW50IHJlY2lldmVyRElkeCA9IGdldERlbGVnYXRlSWR4KHAsIGlkUmVjZWl2ZXIpOwogICAgICAgICAgICAgICAgaWYgKHAuaW50ZW5kZWRQcm9qZWN0ID4gMCAmJiByZWNpZXZlckRJZHggIT0gTk9URk9VTkQpIHsKICAgICAgICAgICAgICAgICAgICAvLyBpZiB0aGVyZSBpcyBhbiBpbnRlbmRlZFByb2plY3QgYW5kIHRoZSByZWNlaXZlciBpcyBpbiB0aGUgZGVsZWdhdGlvbkNoYWluLAogICAgICAgICAgICAgICAgICAgIC8vIHRoZW4gd2Ugd2FudCB0byBwcmVzZXJ2ZSB0aGUgZGVsZWdhdGlvbkNoYWluIGFzIHRoaXMgaXMgYSB2ZXRvIG9mIHRoZQogICAgICAgICAgICAgICAgICAgIC8vIGludGVuZGVkUHJvamVjdCBieSB0aGUgb3duZXIKCiAgICAgICAgICAgICAgICAgICAgaWYgKHJlY2lldmVyRElkeCA9PSBwLmRlbGVnYXRpb25DaGFpbi5sZW5ndGggLSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHVpbnQ2NCB0b1BsZWRnZSA9IGZpbmRPckNyZWF0ZVBsZWRnZSgKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHAub3duZXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwLmRlbGVnYXRpb25DaGFpbiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIDAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAwLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcC5vbGRQbGVkZ2UsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBQbGVkZ2VTdGF0ZS5QbGVkZ2VkKTsKICAgICAgICAgICAgICAgICAgICAgICAgZG9UcmFuc2ZlcihpZFBsZWRnZSwgdG9QbGVkZ2UsIGFtb3VudCk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdW5kZWxlZ2F0ZShpZFBsZWRnZSwgYW1vdW50LCBwLmRlbGVnYXRpb25DaGFpbi5sZW5ndGggLSByZWNlaXZlckRJZHggLSAxKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIC8vIG93bmVyIGlzIG5vdCB2ZXRvaW5nIGFuIGludGVuZGVkUHJvamVjdCBhbmQgaXMgdHJhbnNmZXJyaW5nIHRoZSBwbGVkZ2UgdG8gYSBkZWxlZ2F0ZSwKICAgICAgICAgICAgICAgICAgICAvLyBzbyB3ZSB3YW50IHRvIHJlc2V0IHRoZSBkZWxlZ2F0aW9uQ2hhaW4KICAgICAgICAgICAgICAgICAgICBpZFBsZWRnZSA9IHVuZGVsZWdhdGUoCiAgICAgICAgICAgICAgICAgICAgICAgIGlkUGxlZGdlLAogICAgICAgICAgICAgICAgICAgICAgICBhbW91bnQsCiAgICAgICAgICAgICAgICAgICAgICAgIHAuZGVsZWdhdGlvbkNoYWluLmxlbmd0aAogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgYXBwZW5kRGVsZWdhdGUoaWRQbGVkZ2UsIGFtb3VudCwgaWRSZWNlaXZlcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIFRoaXMgc2hvdWxkIG5ldmVyIGJlIHJlYWNoZWQgYXMgdGhlIHJlY2lldmVyLmFkbWluVHlwZQogICAgICAgICAgICAgICAgLy8gc2hvdWxkIGFsd2F5cyBiZSBlaXRoZXIgYSBHaXZlciwgUHJvamVjdCwgb3IgRGVsZWdhdGUKICAgICAgICAgICAgICAgIGFzc2VydChmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgLy8gSWYgdGhlIHNlbmRlciBpcyBhIERlbGVnYXRlCiAgICAgICAgdWludCBzZW5kZXJESWR4ID0gZ2V0RGVsZWdhdGVJZHgocCwgaWRTZW5kZXIpOwogICAgICAgIGlmIChzZW5kZXJESWR4ICE9IE5PVEZPVU5EKSB7CgogICAgICAgICAgICAvLyBBbmQgdGhlIHJlY2VpdmVyIGlzIGFub3RoZXIgR2l2ZXIKICAgICAgICAgICAgaWYgKHJlY2VpdmVyLmFkbWluVHlwZSA9PSBQbGVkZ2VBZG1pblR5cGUuR2l2ZXIpIHsKICAgICAgICAgICAgICAgIC8vIE9ubHkgdHJhbnNmZXIgdG8gdGhlIEdpdmVyIHdobyBvd25zIHRoZSBwbGRlZ2UKICAgICAgICAgICAgICAgIGFzc2VydChwLm93bmVyID09IGlkUmVjZWl2ZXIpOwogICAgICAgICAgICAgICAgdW5kZWxlZ2F0ZShpZFBsZWRnZSwgYW1vdW50LCBwLmRlbGVnYXRpb25DaGFpbi5sZW5ndGgpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBBbmQgdGhlIHJlY2VpdmVyIGlzIGFub3RoZXIgRGVsZWdhdGUKICAgICAgICAgICAgaWYgKHJlY2VpdmVyLmFkbWluVHlwZSA9PSBQbGVkZ2VBZG1pblR5cGUuRGVsZWdhdGUpIHsKICAgICAgICAgICAgICAgIHVpbnQgcmVjZWl2ZXJESWR4ID0gZ2V0RGVsZWdhdGVJZHgocCwgaWRSZWNlaXZlcik7CgogICAgICAgICAgICAgICAgLy8gQW5kIG5vdCBpbiB0aGUgZGVsZWdhdGlvbkNoYWluCiAgICAgICAgICAgICAgICBpZiAocmVjZWl2ZXJESWR4ID09IE5PVEZPVU5EKSB7CiAgICAgICAgICAgICAgICAgICAgaWRQbGVkZ2UgPSB1bmRlbGVnYXRlKAogICAgICAgICAgICAgICAgICAgICAgICBpZFBsZWRnZSwKICAgICAgICAgICAgICAgICAgICAgICAgYW1vdW50LAogICAgICAgICAgICAgICAgICAgICAgICBwLmRlbGVnYXRpb25DaGFpbi5sZW5ndGggLSBzZW5kZXJESWR4IC0gMQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgYXBwZW5kRGVsZWdhdGUoaWRQbGVkZ2UsIGFtb3VudCwgaWRSZWNlaXZlcik7CgogICAgICAgICAgICAgICAgLy8gQW5kIHBhcnQgb2YgdGhlIGRlbGVnYXRpb25DaGFpbiBhbmQgaXMgYWZ0ZXIgdGhlIHNlbmRlciwgdGhlbgogICAgICAgICAgICAgICAgLy8gIGFsbCBvZiB0aGUgb3RoZXIgZGVsZWdhdGVzIGFmdGVyIHRoZSBzZW5kZXIgYXJlIHJlbW92ZWQgYW5kCiAgICAgICAgICAgICAgICAvLyAgdGhlIHJlY2VpdmVyIGlzIGFwcGVuZGVkIGF0IHRoZSBlbmQgb2YgdGhlIGRlbGVnYXRpb25DaGFpbgogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChyZWNlaXZlckRJZHggPiBzZW5kZXJESWR4KSB7CiAgICAgICAgICAgICAgICAgICAgaWRQbGVkZ2UgPSB1bmRlbGVnYXRlKAogICAgICAgICAgICAgICAgICAgICAgICBpZFBsZWRnZSwKICAgICAgICAgICAgICAgICAgICAgICAgYW1vdW50LAogICAgICAgICAgICAgICAgICAgICAgICBwLmRlbGVnYXRpb25DaGFpbi5sZW5ndGggLSBzZW5kZXJESWR4IC0gMQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgYXBwZW5kRGVsZWdhdGUoaWRQbGVkZ2UsIGFtb3VudCwgaWRSZWNlaXZlcik7CgogICAgICAgICAgICAgICAgLy8gQW5kIGlzIGFscmVhZHkgcGFydCBvZiB0aGUgZGVsZWdhdGUgY2hhaW4gYnV0IGlzIGJlZm9yZSB0aGUKICAgICAgICAgICAgICAgIC8vICBzZW5kZXIsIHRoZW4gdGhlIHNlbmRlciBhbmQgYWxsIG9mIHRoZSBvdGhlciBkZWxlZ2F0ZXMgYWZ0ZXIKICAgICAgICAgICAgICAgIC8vICB0aGUgUkVDRUlWRVIgYXJlIHJlbW92ZWQgZnJvbSB0aGUgZGVsZWdhdGlvbkNoYWluIAogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChyZWNlaXZlckRJZHggPD0gc2VuZGVyRElkeCkgey8vVE9ETyBDaGVjayBmb3IgR2FtZSBUaGVvcnkgaXNzdWVzIChmcm9tIEFydGh1cikgdGhpcyBhbGxvd3MgdGhlIHNlbmRlciB0byBzb3J0IG9mIGdvIGtvbWFrb3NpIGFuZCByZW1vdmUgaGltc2VsZiBhbmQgdGhlIGRlbGVnYXRlcyBiZXR3ZWVuIGhpbXNlbGYgYW5kIHRoZSByZWNlaXZlci4uLiBzaG91bGQgdGhpcyBhdXRob3JpdHkgYmUgYWxsb3dlZD8gCiAgICAgICAgICAgICAgICAgICAgdW5kZWxlZ2F0ZSgKICAgICAgICAgICAgICAgICAgICAgICAgaWRQbGVkZ2UsCiAgICAgICAgICAgICAgICAgICAgICAgIGFtb3VudCwKICAgICAgICAgICAgICAgICAgICAgICAgcC5kZWxlZ2F0aW9uQ2hhaW4ubGVuZ3RoIC0gcmVjZWl2ZXJESWR4IC0gMQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEFuZCB0aGUgcmVjZWl2ZXIgaXMgYSBQcm9qZWN0LCBhbGwgdGhlIGRlbGVnYXRlcyBhZnRlciB0aGUgc2VuZGVyCiAgICAgICAgICAgIC8vICBhcmUgcmVtb3ZlZCBhbmQgdGhlIGFtb3VudCBpcyBwcmUtY29tbWl0dGVkIHRvIHRoZSBwcm9qZWN0CiAgICAgICAgICAgIGlmIChyZWNlaXZlci5hZG1pblR5cGUgPT0gUGxlZGdlQWRtaW5UeXBlLlByb2plY3QpIHsKICAgICAgICAgICAgICAgIGlkUGxlZGdlID0gdW5kZWxlZ2F0ZSgKICAgICAgICAgICAgICAgICAgICBpZFBsZWRnZSwKICAgICAgICAgICAgICAgICAgICBhbW91bnQsCiAgICAgICAgICAgICAgICAgICAgcC5kZWxlZ2F0aW9uQ2hhaW4ubGVuZ3RoIC0gc2VuZGVyRElkeCAtIDEKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBwcm9wb3NlQXNzaWduUHJvamVjdChpZFBsZWRnZSwgYW1vdW50LCBpZFJlY2VpdmVyKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBhc3NlcnQoZmFsc2UpOyAgLy8gV2hlbiB0aGUgc2VuZGVyIGlzIG5vdCBhbiBvd25lciBvciBhIGRlbGVnYXRlIAogICAgfQoKICAgIC8vLyBAbm90aWNlIEF1dGhvcml6ZXMgYSBwYXltZW50IGJlIG1hZGUgZnJvbSB0aGUgYHZhdWx0YCBjYW4gYmUgdXNlZCBieSB0aGUKICAgIC8vLyAgR2l2ZXIgdG8gdmV0byBhIHByZS1jb21taXR0ZWQgZG9uYXRpb24gZnJvbSBhIERlbGVnYXRlIHRvIGFuCiAgICAvLy8gIGludGVuZGVkUHJvamVjdAogICAgLy8vIEBwYXJhbSBpZFBsZWRnZSBJZCBvZiB0aGUgcGxlZGdlIHRoYXQgaXMgdG8gYmUgcmVkZWVtZWQgaW50byBldGhlcgogICAgLy8vIEBwYXJhbSBhbW91bnQgUXVhbnRpdHkgb2YgZXRoZXIgKGluIHdlaSkgdG8gYmUgYXV0aG9yaXplZAogICAgZnVuY3Rpb24gd2l0aGRyYXcodWludDY0IGlkUGxlZGdlLCB1aW50IGFtb3VudCkgewogICAgICAgIGlkUGxlZGdlID0gbm9ybWFsaXplUGxlZGdlKGlkUGxlZGdlKTsgLy8gVXBkYXRlcyBwbGVkZ2UgaW5mbyAKICAgICAgICBQbGVkZ2Ugc3RvcmFnZSBwID0gZmluZFBsZWRnZShpZFBsZWRnZSk7CiAgICAgICAgcmVxdWlyZShwLnBsZWRnZVN0YXRlID09IFBsZWRnZVN0YXRlLlBsZWRnZWQpOwogICAgICAgIFBsZWRnZUFkbWluIHN0b3JhZ2Ugb3duZXIgPSBmaW5kQWRtaW4ocC5vd25lcik7CiAgICAgICAgY2hlY2tBZG1pbk93bmVyKG93bmVyKTsKCiAgICAgICAgdWludDY0IGlkTmV3UGxlZGdlID0gZmluZE9yQ3JlYXRlUGxlZGdlKAogICAgICAgICAgICBwLm93bmVyLAogICAgICAgICAgICBwLmRlbGVnYXRpb25DaGFpbiwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgcC5vbGRQbGVkZ2UsCiAgICAgICAgICAgIFBsZWRnZVN0YXRlLlBheWluZwogICAgICAgICk7CgogICAgICAgIGRvVHJhbnNmZXIoaWRQbGVkZ2UsIGlkTmV3UGxlZGdlLCBhbW91bnQpOwoKICAgICAgICB2YXVsdC5hdXRob3JpemVQYXltZW50KGJ5dGVzMzIoaWROZXdQbGVkZ2UpLCBvd25lci5hZGRyLCBhbW91bnQpOwogICAgfQoKICAgIC8vLyBAbm90aWNlIGBvbmx5VmF1bHRgIENvbmZpcm1zIGEgd2l0aGRyYXcgcmVxdWVzdCBjaGFuZ2luZyB0aGUgUGxlZGdlU3RhdGUKICAgIC8vLyAgZnJvbSBQYXlpbmcgdG8gUGFpZAogICAgLy8vIEBwYXJhbSBpZFBsZWRnZSBJZCBvZiB0aGUgcGxlZGdlIHRoYXQgaXMgdG8gYmUgd2l0aGRyYXduCiAgICAvLy8gQHBhcmFtIGFtb3VudCBRdWFudGl0eSBvZiBldGhlciAoaW4gd2VpKSB0byBiZSB3aXRoZHJhd24KICAgIGZ1bmN0aW9uIGNvbmZpcm1QYXltZW50KHVpbnQ2NCBpZFBsZWRnZSwgdWludCBhbW91bnQpIG9ubHlWYXVsdCB7CiAgICAgICAgUGxlZGdlIHN0b3JhZ2UgcCA9IGZpbmRQbGVkZ2UoaWRQbGVkZ2UpOwoKICAgICAgICByZXF1aXJlKHAucGxlZGdlU3RhdGUgPT0gUGxlZGdlU3RhdGUuUGF5aW5nKTsKCiAgICAgICAgdWludDY0IGlkTmV3UGxlZGdlID0gZmluZE9yQ3JlYXRlUGxlZGdlKAogICAgICAgICAgICBwLm93bmVyLAogICAgICAgICAgICBwLmRlbGVnYXRpb25DaGFpbiwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgcC5vbGRQbGVkZ2UsCiAgICAgICAgICAgIFBsZWRnZVN0YXRlLlBhaWQKICAgICAgICApOwoKICAgICAgICBkb1RyYW5zZmVyKGlkUGxlZGdlLCBpZE5ld1BsZWRnZSwgYW1vdW50KTsKICAgIH0KCiAgICAvLy8gQG5vdGljZSBgb25seVZhdWx0YCBDYW5jZWxzIGEgd2l0aGRyYXcgcmVxdWVzdCwgY2hhbmdpbmcgdGhlIFBsZWRnZVN0YXRlIAogICAgLy8vICBmcm9tIFBheWluZyBiYWNrIHRvIFBsZWRnZWQKICAgIC8vLyBAcGFyYW0gaWRQbGVkZ2UgSWQgb2YgdGhlIHBsZWRnZSB0aGF0J3Mgd2l0aGRyYXcgaXMgdG8gYmUgY2FuY2VsZWQKICAgIC8vLyBAcGFyYW0gYW1vdW50IFF1YW50aXR5IG9mIGV0aGVyIChpbiB3ZWkpIHRvIGJlIGNhbmNlbGVkCiAgICBmdW5jdGlvbiBjYW5jZWxQYXltZW50KHVpbnQ2NCBpZFBsZWRnZSwgdWludCBhbW91bnQpIG9ubHlWYXVsdCB7CiAgICAgICAgUGxlZGdlIHN0b3JhZ2UgcCA9IGZpbmRQbGVkZ2UoaWRQbGVkZ2UpOwoKICAgICAgICByZXF1aXJlKHAucGxlZGdlU3RhdGUgPT0gUGxlZGdlU3RhdGUuUGF5aW5nKTsgLy9UT0RPIGNoYW5nZSB0byByZXZlcnQ/Pz8/Pz8/Pz8/Pz8/Pz8/Pz8/Pz8/Pz8/Pz8/CgogICAgICAgIC8vIFdoZW4gYSBwYXltZW50IGlzIGNhbmNlbGVkLCBuZXZlciBpcyBhc3NpZ25lZCB0byBhIHByb2plY3QuCiAgICAgICAgdWludDY0IG9sZFBsZWRnZSA9IGZpbmRPckNyZWF0ZVBsZWRnZSgKICAgICAgICAgICAgcC5vd25lciwKICAgICAgICAgICAgcC5kZWxlZ2F0aW9uQ2hhaW4sCiAgICAgICAgICAgIDAsCiAgICAgICAgICAgIDAsCiAgICAgICAgICAgIHAub2xkUGxlZGdlLAogICAgICAgICAgICBQbGVkZ2VTdGF0ZS5QbGVkZ2VkCiAgICAgICAgKTsKCiAgICAgICAgb2xkUGxlZGdlID0gbm9ybWFsaXplUGxlZGdlKG9sZFBsZWRnZSk7CgogICAgICAgIGRvVHJhbnNmZXIoaWRQbGVkZ2UsIG9sZFBsZWRnZSwgYW1vdW50KTsKICAgIH0KCiAgICAvLy8gQG5vdGljZSBDaGFuZ2VzIHRoZSBgcHJvamVjdC5jYW5jZWxlZGAgZmxhZyB0byBgdHJ1ZWA7IGNhbm5vdCBiZSB1bmRvbmUKICAgIC8vLyBAcGFyYW0gaWRQcm9qZWN0IElkIG9mIHRoZSBwcm9qZWN0IHRoYXQgaXMgdG8gYmUgY2FuY2VsZWQKICAgIGZ1bmN0aW9uIGNhbmNlbFByb2plY3QodWludDY0IGlkUHJvamVjdCkgeyAKICAgICAgICBQbGVkZ2VBZG1pbiBzdG9yYWdlIHByb2plY3QgPSBmaW5kQWRtaW4oaWRQcm9qZWN0KTsKICAgICAgICBjaGVja0FkbWluT3duZXIocHJvamVjdCk7CiAgICAgICAgcHJvamVjdC5jYW5jZWxlZCA9IHRydWU7CgogICAgICAgIENhbmNlbFByb2plY3QoaWRQcm9qZWN0KTsKICAgIH0KCiAgICAvLy8gQG5vdGljZSBUcmFuc2ZlcnMgYGFtb3VudGAgaW4gYGlkUGxlZGdlYCBiYWNrIHRvIHRoZSBgb2xkUGxlZGdlYCB0aGF0CiAgICAvLy8gIHRoYXQgc2VudCBpdCB0aGVyZSBpbiB0aGUgZmlyc3QgcGxhY2UsIGEgQ3RybC16IAogICAgLy8vIEBwYXJhbSBpZFBsZWRnZSBJZCBvZiB0aGUgcGxlZGdlIHRoYXQgaXMgdG8gYmUgY2FuY2VsZWQKICAgIC8vLyBAcGFyYW0gYW1vdW50IFF1YW50aXR5IG9mIGV0aGVyIChpbiB3ZWkpIHRvIGJlIHRyYW5zZmVyZWQgdG8gdGhlIAogICAgLy8vICBgb2xkUGxlZGdlYAogICAgZnVuY3Rpb24gY2FuY2VsUGxlZGdlKHVpbnQ2NCBpZFBsZWRnZSwgdWludCBhbW91bnQpIHsgCiAgICAgICAgaWRQbGVkZ2UgPSBub3JtYWxpemVQbGVkZ2UoaWRQbGVkZ2UpOwoKICAgICAgICBQbGVkZ2Ugc3RvcmFnZSBwID0gZmluZFBsZWRnZShpZFBsZWRnZSk7CiAgICAgICAgcmVxdWlyZShwLm9sZFBsZWRnZSAhPSAwKTsKCiAgICAgICAgUGxlZGdlQWRtaW4gc3RvcmFnZSBtID0gZmluZEFkbWluKHAub3duZXIpOwogICAgICAgIGNoZWNrQWRtaW5Pd25lcihtKTsKCiAgICAgICAgdWludDY0IG9sZFBsZWRnZSA9IGdldE9sZGVzdFBsZWRnZU5vdENhbmNlbGVkKHAub2xkUGxlZGdlKTsKICAgICAgICBkb1RyYW5zZmVyKGlkUGxlZGdlLCBvbGRQbGVkZ2UsIGFtb3VudCk7CiAgICB9CgoKLy8vLy8vLy8KLy8gTXVsdGkgcGxlZGdlIG1ldGhvZHMKLy8vLy8vLy8KCiAgICAvLyBAZGV2IFRoaXMgc2V0IG9mIGZ1bmN0aW9ucyBtYWtlcyBtb3ZpbmcgYSBsb3Qgb2YgcGxlZGdlcyBhcm91bmQgbXVjaCBtb3JlCiAgICAvLyBlZmZpY2llbnQgKHNhdmVzIGdhcykgdGhhbiBjYWxsaW5nIHRoZXNlIGZ1bmN0aW9ucyBpbiBzZXJpZXMKICAgIAogICAgCiAgICAvLy8gQGRldiBCaXRtYXNrIHVzZWQgZm9yIGRpdmlkaW5nIHBsZWRnZSBhbW91bnRzIGluIE11bHRpIHBsZWRnZSBtZXRob2RzCiAgICB1aW50IGNvbnN0YW50IEQ2NCA9IDB4MTAwMDAwMDAwMDAwMDAwMDA7CgogICAgLy8vIEBub3RpY2UgVHJhbnNmZXJzIG11bHRpcGxlIGFtb3VudHMgd2l0aGluIG11bHRpcGxlIFBsZWRnZXMgaW4gYW4KICAgIC8vLyAgZWZmaWNpZW50IHNpbmdsZSBjYWxsIAogICAgLy8vIEBwYXJhbSBpZFNlbmRlciBJZCBvZiB0aGUgQWRtaW4gdGhhdCBpcyB0cmFuc2ZlcnJpbmcgdGhlIGFtb3VudHMgZnJvbQogICAgLy8vICBhbGwgdGhlIFBsZWRnZXM7IHRoaXMgYWRtaW4gbXVzdCBoYXZlIHBlcm1pc3Npb25zIHRvIG1vdmUgdGhlIHZhbHVlCiAgICAvLy8gQHBhcmFtIHBsZWRnZXNBbW91bnRzIEFuIGFycmF5IG9mIFBsZWRnZSBhbW91bnRzIGFuZCB0aGUgaWRQbGVkZ2VzIHdpdGggCiAgICAvLy8gIHdoaWNoIHRoZSBhbW91bnRzIGFyZSBhc3NvY2lhdGVkOyB0aGVzZSBhcmUgZXh0cmFwb2xhdGVkIHVzaW5nIHRoZSBENjQKICAgIC8vLyAgYml0bWFzawogICAgLy8vIEBwYXJhbSBpZFJlY2VpdmVyIERlc3RpbmF0aW9uIG9mIHRoZSBgcGxlZGVzQW1vdW50c2AsIGNhbiBiZSBhIEdpdmVyIG9yIAogICAgLy8vICBQcm9qZWN0IHNlbmRpbmcgdG8gYSBHaXZlciwgYSBEZWxlZ2F0ZSBvciBhIFByb2plY3Q7IGEgRGVsZWdhdGUgc2VuZGluZwogICAgLy8vICB0byBhbm90aGVyIERlbGVnYXRlLCBvciBhIERlbGVnYXRlIHByZS1jb21taXRpbmcgaXQgdG8gYSBQcm9qZWN0IAogICAgZnVuY3Rpb24gbVRyYW5zZmVyKAogICAgICAgIHVpbnQ2NCBpZFNlbmRlciwKICAgICAgICB1aW50W10gcGxlZGdlc0Ftb3VudHMsCiAgICAgICAgdWludDY0IGlkUmVjZWl2ZXIKICAgICkgewogICAgICAgIGZvciAodWludCBpID0gMDsgaSA8IHBsZWRnZXNBbW91bnRzLmxlbmd0aDsgaSsrICkgewogICAgICAgICAgICB1aW50NjQgaWRQbGVkZ2UgPSB1aW50NjQoIHBsZWRnZXNBbW91bnRzW2ldICYgKEQ2NC0xKSApOwogICAgICAgICAgICB1aW50IGFtb3VudCA9IHBsZWRnZXNBbW91bnRzW2ldIC8gRDY0OwoKICAgICAgICAgICAgdHJhbnNmZXIoaWRTZW5kZXIsIGlkUGxlZGdlLCBhbW91bnQsIGlkUmVjZWl2ZXIpOwogICAgICAgIH0KICAgIH0KCiAgICAvLy8gQG5vdGljZSBBdXRob3JpemVzIG11bHRpcGxlIGFtb3VudHMgd2l0aGluIG11bHRpcGxlIFBsZWRnZXMgdG8gYmUKICAgIC8vLyAgd2l0aGRyYXduIGZyb20gdGhlIGB2YXVsdGAgaW4gYW4gZWZmaWNpZW50IHNpbmdsZSBjYWxsIAogICAgLy8vIEBwYXJhbSBwbGVkZ2VzQW1vdW50cyBBbiBhcnJheSBvZiBQbGVkZ2UgYW1vdW50cyBhbmQgdGhlIGlkUGxlZGdlcyB3aXRoIAogICAgLy8vICB3aGljaCB0aGUgYW1vdW50cyBhcmUgYXNzb2NpYXRlZDsgdGhlc2UgYXJlIGV4dHJhcG9sYXRlZCB1c2luZyB0aGUgRDY0CiAgICAvLy8gIGJpdG1hc2sKICAgIGZ1bmN0aW9uIG1XaXRoZHJhdyh1aW50W10gcGxlZGdlc0Ftb3VudHMpIHsKICAgICAgICBmb3IgKHVpbnQgaSA9IDA7IGkgPCBwbGVkZ2VzQW1vdW50cy5sZW5ndGg7IGkrKyApIHsKICAgICAgICAgICAgdWludDY0IGlkUGxlZGdlID0gdWludDY0KCBwbGVkZ2VzQW1vdW50c1tpXSAmIChENjQtMSkgKTsKICAgICAgICAgICAgdWludCBhbW91bnQgPSBwbGVkZ2VzQW1vdW50c1tpXSAvIEQ2NDsKCiAgICAgICAgICAgIHdpdGhkcmF3KGlkUGxlZGdlLCBhbW91bnQpOwogICAgICAgIH0KICAgIH0KCiAgICAvLy8gQG5vdGljZSBgbUNvbmZpcm1QYXltZW50YCBhbGxvd3MgZm9yIG11bHRpcGxlIHBsZWRnZXMgdG8gYmUgY29uZmlybWVkCiAgICAvLy8gIGVmZmljaWVudGx5CiAgICAvLy8gQHBhcmFtIHBsZWRnZXNBbW91bnRzIEFuIGFycmF5IG9mIHBsZWRnZSBhbW91bnRzIGFuZCBJRHMgd2hpY2ggYXJlIGV4dHJhcG9sYXRlZAogICAgLy8vICB1c2luZyB0aGUgRDY0IGJpdG1hc2sKICAgIGZ1bmN0aW9uIG1Db25maXJtUGF5bWVudCh1aW50W10gcGxlZGdlc0Ftb3VudHMpIHsKICAgICAgICBmb3IgKHVpbnQgaSA9IDA7IGkgPCBwbGVkZ2VzQW1vdW50cy5sZW5ndGg7IGkrKyApIHsKICAgICAgICAgICAgdWludDY0IGlkUGxlZGdlID0gdWludDY0KCBwbGVkZ2VzQW1vdW50c1tpXSAmIChENjQtMSkgKTsKICAgICAgICAgICAgdWludCBhbW91bnQgPSBwbGVkZ2VzQW1vdW50c1tpXSAvIEQ2NDsKCiAgICAgICAgICAgIGNvbmZpcm1QYXltZW50KGlkUGxlZGdlLCBhbW91bnQpOwogICAgICAgIH0KICAgIH0KCiAgICAvLy8gQG5vdGljZSBgbUNhbmNlbFBheW1lbnRgIGFsbG93cyBmb3IgbXVsdGlwbGUgcGxlZGdlcyB0byBiZSBjYW5jZWxlZAogICAgLy8vICBlZmZpY2llbnRseQogICAgLy8vIEBwYXJhbSBwbGVkZ2VzQW1vdW50cyBBbiBhcnJheSBvZiBwbGVkZ2UgYW1vdW50cyBhbmQgSURzIHdoaWNoIGFyZSBleHRyYXBvbGF0ZWQKICAgIC8vLyAgdXNpbmcgdGhlIEQ2NCBiaXRtYXNrCiAgICBmdW5jdGlvbiBtQ2FuY2VsUGF5bWVudCh1aW50W10gcGxlZGdlc0Ftb3VudHMpIHsKICAgICAgICBmb3IgKHVpbnQgaSA9IDA7IGkgPCBwbGVkZ2VzQW1vdW50cy5sZW5ndGg7IGkrKyApIHsKICAgICAgICAgICAgdWludDY0IGlkUGxlZGdlID0gdWludDY0KCBwbGVkZ2VzQW1vdW50c1tpXSAmIChENjQtMSkgKTsKICAgICAgICAgICAgdWludCBhbW91bnQgPSBwbGVkZ2VzQW1vdW50c1tpXSAvIEQ2NDsKCiAgICAgICAgICAgIGNhbmNlbFBheW1lbnQoaWRQbGVkZ2UsIGFtb3VudCk7CiAgICAgICAgfQogICAgfQoKICAgIC8vLyBAbm90aWNlIGBtTm9ybWFsaXplUGxlZGdlYCBhbGxvd3MgZm9yIG11bHRpcGxlIHBsZWRnZXMgdG8gYmUKICAgIC8vLyAgbm9ybWFsaXplZCBlZmZpY2llbnRseQogICAgLy8vIEBwYXJhbSBwbGVkZ2VzIEFuIGFycmF5IG9mIHBsZWRnZSBJRHMKICAgIGZ1bmN0aW9uIG1Ob3JtYWxpemVQbGVkZ2UodWludDY0W10gcGxlZGdlcykgewogICAgICAgIGZvciAodWludCBpID0gMDsgaSA8IHBsZWRnZXMubGVuZ3RoOyBpKysgKSB7CiAgICAgICAgICAgIG5vcm1hbGl6ZVBsZWRnZSggcGxlZGdlc1tpXSApOwogICAgICAgIH0KICAgIH0KCi8vLy8vLy8vCi8vIFByaXZhdGUgbWV0aG9kcwovLy8vLy8vCgogICAgLy8vIEBub3RpY2UgYHRyYW5zZmVyT3duZXJzaGlwVG9Qcm9qZWN0YCBhbGxvd3MgZm9yIHRoZSB0cmFuc2ZlciBvZgogICAgLy8vICBvd25lcnNoaXAgdG8gdGhlIHByb2plY3QsIGJ1dCBpdCBjYW4gYWxzbyBiZSBjYWxsZWQgYnkgYSBwcm9qZWN0CiAgICAvLy8gIHRvIHVuLWRlbGVnYXRlIGV2ZXJ5b25lIGJ5IHNldHRpbmcgb25lJ3Mgb3duIGlkIGZvciB0aGUgaWRSZWNlaXZlcgogICAgLy8vIEBwYXJhbSBpZFBsZWRnZSBJZCBvZiB0aGUgcGxlZGdlIHRvIGJlIHRyYW5zZmVyZWQuCiAgICAvLy8gQHBhcmFtIGFtb3VudCBRdWFudGl0eSBvZiB2YWx1ZSB0aGF0J3MgYmVpbmcgdHJhbnNmZXJlZAogICAgLy8vIEBwYXJhbSBpZFJlY2VpdmVyIFRoZSBuZXcgb3duZXIgb2YgdGhlIHByb2plY3QgKG9yIHNlbGYgdG8gdW4tZGVsZWdhdGUpCiAgICBmdW5jdGlvbiB0cmFuc2Zlck93bmVyc2hpcFRvUHJvamVjdCgKICAgICAgICB1aW50NjQgaWRQbGVkZ2UsCiAgICAgICAgdWludCBhbW91bnQsCiAgICAgICAgdWludDY0IGlkUmVjZWl2ZXIKICAgICkgaW50ZXJuYWwgewogICAgICAgIFBsZWRnZSBzdG9yYWdlIHAgPSBmaW5kUGxlZGdlKGlkUGxlZGdlKTsKCiAgICAgICAgLy8gRW5zdXJlIHRoYXQgdGhlIHBsZWRnZSBpcyBub3QgYWxyZWFkeSBhdCBtYXggcGxlZGdlIGRlcHRoCiAgICAgICAgLy8gYW5kIHRoZSBwcm9qZWN0IGhhcyBub3QgYmVlbiBjYW5jZWxlZAogICAgICAgIHJlcXVpcmUoZ2V0UGxlZGdlTGV2ZWwocCkgPCBNQVhfSU5URVJQUk9KRUNUX0xFVkVMKTsKICAgICAgICByZXF1aXJlKCFpc1Byb2plY3RDYW5jZWxlZChpZFJlY2VpdmVyKSk7CgogICAgICAgIHVpbnQ2NCBvbGRQbGVkZ2UgPSBmaW5kT3JDcmVhdGVQbGVkZ2UoCiAgICAgICAgICAgIHAub3duZXIsCiAgICAgICAgICAgIHAuZGVsZWdhdGlvbkNoYWluLAogICAgICAgICAgICAwLAogICAgICAgICAgICAwLAogICAgICAgICAgICBwLm9sZFBsZWRnZSwKICAgICAgICAgICAgUGxlZGdlU3RhdGUuUGxlZGdlZAogICAgICAgICk7CiAgICAgICAgdWludDY0IHRvUGxlZGdlID0gZmluZE9yQ3JlYXRlUGxlZGdlKAogICAgICAgICAgICBpZFJlY2VpdmVyLCAgICAgICAgICAgICAgICAgICAgIC8vIFNldCB0aGUgbmV3IG93bmVyCiAgICAgICAgICAgIG5ldyB1aW50NjRbXSgwKSwgICAgICAgICAgICAgICAgLy8gY2xlYXIgdGhlIGRlbGVnYXRpb24gY2hhaW4KICAgICAgICAgICAgMCwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgb2xkUGxlZGdlLAogICAgICAgICAgICBQbGVkZ2VTdGF0ZS5QbGVkZ2VkCiAgICAgICAgKTsKICAgICAgICBkb1RyYW5zZmVyKGlkUGxlZGdlLCB0b1BsZWRnZSwgYW1vdW50KTsKICAgIH0gICAKCgogICAgLy8vIEBub3RpY2UgYHRyYW5zZmVyT3duZXJzaGlwVG9HaXZlcmAgYWxsb3dzIGZvciB0aGUgdHJhbnNmZXIgb2YKICAgIC8vLyAgdmFsdWUgYmFjayB0byB0aGUgR2l2ZXIsIHZhbHVlIGlzIHBsYWNlZCBpbiBhIHBsZWRnZWQgc3RhdGUKICAgIC8vLyAgd2l0aG91dCBiZWluZyBhdHRhY2hlZCB0byBhIHByb2plY3QsIGRlbGVnYXRpb24gY2hhaW4sIG9yIHRpbWUgbGluZS4KICAgIC8vLyBAcGFyYW0gaWRQbGVkZ2UgSWQgb2YgdGhlIHBsZWRnZSB0byBiZSB0cmFuc2ZlcmVkLgogICAgLy8vIEBwYXJhbSBhbW91bnQgUXVhbnRpdHkgb2YgdmFsdWUgdGhhdCdzIGJlaW5nIHRyYW5zZmVyZWQKICAgIC8vLyBAcGFyYW0gaWRSZWNlaXZlciBUaGUgbmV3IG93bmVyIG9mIHRoZSBwbGVkZ2UKICAgIGZ1bmN0aW9uIHRyYW5zZmVyT3duZXJzaGlwVG9HaXZlcigKICAgICAgICB1aW50NjQgaWRQbGVkZ2UsCiAgICAgICAgdWludCBhbW91bnQsCiAgICAgICAgdWludDY0IGlkUmVjZWl2ZXIKICAgICkgaW50ZXJuYWwgewogICAgICAgIHVpbnQ2NCB0b1BsZWRnZSA9IGZpbmRPckNyZWF0ZVBsZWRnZSgKICAgICAgICAgICAgaWRSZWNlaXZlciwKICAgICAgICAgICAgbmV3IHVpbnQ2NFtdKDApLAogICAgICAgICAgICAwLAogICAgICAgICAgICAwLAogICAgICAgICAgICAwLAogICAgICAgICAgICBQbGVkZ2VTdGF0ZS5QbGVkZ2VkCiAgICAgICAgKTsKICAgICAgICBkb1RyYW5zZmVyKGlkUGxlZGdlLCB0b1BsZWRnZSwgYW1vdW50KTsKICAgIH0KCiAgICAvLy8gQG5vdGljZSBgYXBwZW5kRGVsZWdhdGVgIGFsbG93cyBmb3IgYSBkZWxlZ2F0ZSB0byBiZSBhZGRlZCBvbnRvIHRoZQogICAgLy8vICBlbmQgb2YgdGhlIGRlbGVnYXRlIGNoYWluIGZvciBhIGdpdmVuIFBsZWRnZS4KICAgIC8vLyBAcGFyYW0gaWRQbGVkZ2UgSWQgb2YgdGhlIHBsZWRnZSB0aGF0cyBkZWxlZ2F0ZSBjaGFpbiB3aWxsIGJlIG1vZGlmaWVkLgogICAgLy8vIEBwYXJhbSBhbW91bnQgUXVhbnRpdHkgb2YgdmFsdWUgdGhhdCdzIGJlaW5nIGNoYWluZWQuCiAgICAvLy8gQHBhcmFtIGlkUmVjZWl2ZXIgVGhlIGRlbGVnYXRlIHRvIGJlIGFkZGVkIGF0IHRoZSBlbmQgb2YgdGhlIGNoYWluCiAgICBmdW5jdGlvbiBhcHBlbmREZWxlZ2F0ZSgKICAgICAgICB1aW50NjQgaWRQbGVkZ2UsCiAgICAgICAgdWludCBhbW91bnQsCiAgICAgICAgdWludDY0IGlkUmVjZWl2ZXIKICAgICkgaW50ZXJuYWwgewogICAgICAgIFBsZWRnZSBzdG9yYWdlIHAgPSBmaW5kUGxlZGdlKGlkUGxlZGdlKTsKCiAgICAgICAgcmVxdWlyZShwLmRlbGVnYXRpb25DaGFpbi5sZW5ndGggPCBNQVhfREVMRUdBVEVTKTsKICAgICAgICB1aW50NjRbXSBtZW1vcnkgbmV3RGVsZWdhdGlvbkNoYWluID0gbmV3IHVpbnQ2NFtdKAogICAgICAgICAgICBwLmRlbGVnYXRpb25DaGFpbi5sZW5ndGggKyAxCiAgICAgICAgKTsKICAgICAgICBmb3IgKHVpbnQgaSA9IDA7IGk8cC5kZWxlZ2F0aW9uQ2hhaW4ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgbmV3RGVsZWdhdGlvbkNoYWluW2ldID0gcC5kZWxlZ2F0aW9uQ2hhaW5baV07CiAgICAgICAgfQoKICAgICAgICAvLyBNYWtlIHRoZSBsYXN0IGl0ZW0gaW4gdGhlIGFycmF5IHRoZSBpZFJlY2VpdmVyCiAgICAgICAgbmV3RGVsZWdhdGlvbkNoYWluW3AuZGVsZWdhdGlvbkNoYWluLmxlbmd0aF0gPSBpZFJlY2VpdmVyOwoKICAgICAgICB1aW50NjQgdG9QbGVkZ2UgPSBmaW5kT3JDcmVhdGVQbGVkZ2UoCiAgICAgICAgICAgIHAub3duZXIsCiAgICAgICAgICAgIG5ld0RlbGVnYXRpb25DaGFpbiwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgcC5vbGRQbGVkZ2UsCiAgICAgICAgICAgIFBsZWRnZVN0YXRlLlBsZWRnZWQKICAgICAgICApOwogICAgICAgIGRvVHJhbnNmZXIoaWRQbGVkZ2UsIHRvUGxlZGdlLCBhbW91bnQpOwogICAgfQoKICAgIC8vLyBAbm90aWNlIGBhcHBlbmREZWxlZ2F0ZWAgYWxsb3dzIGZvciBhIGRlbGVnYXRlIHRvIGJlIGFkZGVkIG9udG8gdGhlCiAgICAvLy8gIGVuZCBvZiB0aGUgZGVsZWdhdGUgY2hhaW4gZm9yIGEgZ2l2ZW4gUGxlZGdlLgogICAgLy8vIEBwYXJhbSBpZFBsZWRnZSBJZCBvZiB0aGUgcGxlZGdlIHRoYXRzIGRlbGVnYXRlIGNoYWluIHdpbGwgYmUgbW9kaWZpZWQuCiAgICAvLy8gQHBhcmFtIGFtb3VudCBRdWFudGl0eSBvZiB2YWx1ZSB0aGF0J3Mgc2hpZnRlZCBmcm9tIGRlbGVnYXRlcy4KICAgIC8vLyBAcGFyYW0gcSBOdW1iZXIgKG9yIGRlcHRoKSBvZiBkZWxlZ2F0ZXMgdG8gcmVtb3ZlCiAgICAvLy8gQHJldHVybiB0b1BsZWRnZSBUaGUgaWQgZm9yIHRoZSBwbGVkZ2UgYmVpbmcgYWRqdXN0ZWQgb3IgY3JlYXRlZAogICAgZnVuY3Rpb24gdW5kZWxlZ2F0ZSgKICAgICAgICB1aW50NjQgaWRQbGVkZ2UsCiAgICAgICAgdWludCBhbW91bnQsCiAgICAgICAgdWludCBxCiAgICApIGludGVybmFsIHJldHVybnMgKHVpbnQ2NCkKICAgIHsKICAgICAgICBQbGVkZ2Ugc3RvcmFnZSBwID0gZmluZFBsZWRnZShpZFBsZWRnZSk7CiAgICAgICAgdWludDY0W10gbWVtb3J5IG5ld0RlbGVnYXRpb25DaGFpbiA9IG5ldyB1aW50NjRbXSgKICAgICAgICAgICAgcC5kZWxlZ2F0aW9uQ2hhaW4ubGVuZ3RoIC0gcQogICAgICAgICk7CgogICAgICAgIGZvciAodWludCBpPTA7IGk8cC5kZWxlZ2F0aW9uQ2hhaW4ubGVuZ3RoIC0gcTsgaSsrKSB7CiAgICAgICAgICAgIG5ld0RlbGVnYXRpb25DaGFpbltpXSA9IHAuZGVsZWdhdGlvbkNoYWluW2ldOwogICAgICAgIH0KICAgICAgICB1aW50NjQgdG9QbGVkZ2UgPSBmaW5kT3JDcmVhdGVQbGVkZ2UoCiAgICAgICAgICAgIHAub3duZXIsCiAgICAgICAgICAgIG5ld0RlbGVnYXRpb25DaGFpbiwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgcC5vbGRQbGVkZ2UsCiAgICAgICAgICAgIFBsZWRnZVN0YXRlLlBsZWRnZWQKICAgICAgICApOwogICAgICAgIGRvVHJhbnNmZXIoaWRQbGVkZ2UsIHRvUGxlZGdlLCBhbW91bnQpOwoKICAgICAgICByZXR1cm4gdG9QbGVkZ2U7CiAgICB9CgogICAgLy8vIEBub3RpY2UgYHByb3Bvc2VBc3NpZ25Qcm9qZWN0YCBwcm9wb3NlcyB0aGUgYXNzaWdubWVudCBvZiBhIHBsZWRnZQogICAgLy8vICB0byBhIHNwZWNpZmljIHByb2plY3QuCiAgICAvLy8gQGRldiBUaGlzIGZ1bmN0aW9uIHNob3VsZCBwb3RlbnRpYWxseSBiZSBuYW1lZCBtb3JlIHNwZWNpZmljYWxseS4KICAgIC8vLyBAcGFyYW0gaWRQbGVkZ2UgSWQgb2YgdGhlIHBsZWRnZSB0aGF0IHdpbGwgYmUgYXNzaWduZWQuCiAgICAvLy8gQHBhcmFtIGFtb3VudCBRdWFudGl0eSBvZiB2YWx1ZSB0aGlzIHBsZWRnZSBsZWFkZXIgd291bGQgYmUgYXNzaWduZWQuCiAgICAvLy8gQHBhcmFtIGlkUmVjZWl2ZXIgVGhlIHByb2plY3QgdGhpcyBwbGVkZ2Ugd2lsbCBwb3RlbnRpYWxseSAKICAgIC8vLyAgYmUgYXNzaWduZWQgdG8uCiAgICBmdW5jdGlvbiBwcm9wb3NlQXNzaWduUHJvamVjdCgKICAgICAgICB1aW50NjQgaWRQbGVkZ2UsCiAgICAgICAgdWludCBhbW91bnQsCiAgICAgICAgdWludDY0IGlkUmVjZWl2ZXIKICAgICkgaW50ZXJuYWwgewogICAgICAgIFBsZWRnZSBzdG9yYWdlIHAgPSBmaW5kUGxlZGdlKGlkUGxlZGdlKTsKCiAgICAgICAgcmVxdWlyZShnZXRQbGVkZ2VMZXZlbChwKSA8IE1BWF9JTlRFUlBST0pFQ1RfTEVWRUwpOwogICAgICAgIHJlcXVpcmUoIWlzUHJvamVjdENhbmNlbGVkKGlkUmVjZWl2ZXIpKTsKCiAgICAgICAgdWludDY0IHRvUGxlZGdlID0gZmluZE9yQ3JlYXRlUGxlZGdlKAogICAgICAgICAgICBwLm93bmVyLAogICAgICAgICAgICBwLmRlbGVnYXRpb25DaGFpbiwKICAgICAgICAgICAgaWRSZWNlaXZlciwKICAgICAgICAgICAgdWludDY0KGdldFRpbWUoKSArIG1heENvbW1pdFRpbWUocCkpLAogICAgICAgICAgICBwLm9sZFBsZWRnZSwKICAgICAgICAgICAgUGxlZGdlU3RhdGUuUGxlZGdlZAogICAgICAgICk7CiAgICAgICAgZG9UcmFuc2ZlcihpZFBsZWRnZSwgdG9QbGVkZ2UsIGFtb3VudCk7CiAgICB9CgogICAgLy8vIEBub3RpY2UgYGRvVHJhbnNmZXJgIGlzIGRlc2lnbmVkIHRvIGFsbG93IGZvciBwbGVkZ2UgYW1vdW50cyB0byBiZSAKICAgIC8vLyAgc2hpZnRlZCBhcm91bmQgaW50ZXJuYWxseS4KICAgIC8vLyBAcGFyYW0gZnJvbSBUaGlzIGlzIHRoZSBJZCBmcm9tIHdoaWNoIHZhbHVlIHdpbGwgYmUgdHJhbnNmZXJlZC4KICAgIC8vLyBAcGFyYW0gdG8gVGhpcyBpcyB0aGUgSWQgdGhhdCB2YWx1ZSB3aWxsIGJlIHRyYW5zZmVyZWQgdG8uCiAgICAvLy8gQHBhcmFtIF9hbW91bnQgVGhlIGFtb3VudCBvZiB2YWx1ZSB0aGF0IHdpbGwgYmUgdHJhbnNmZXJlZC4KICAgIGZ1bmN0aW9uIGRvVHJhbnNmZXIodWludDY0IGZyb20sIHVpbnQ2NCB0bywgdWludCBfYW1vdW50KSBpbnRlcm5hbCB7CiAgICAgICAgdWludCBhbW91bnQgPSBjYWxsUGx1Z2lucyh0cnVlLCBmcm9tLCB0bywgX2Ftb3VudCk7CiAgICAgICAgaWYgKGZyb20gPT0gdG8pIHsgCiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYgKGFtb3VudCA9PSAwKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgUGxlZGdlIHN0b3JhZ2UgbkZyb20gPSBmaW5kUGxlZGdlKGZyb20pOwogICAgICAgIFBsZWRnZSBzdG9yYWdlIG5UbyA9IGZpbmRQbGVkZ2UodG8pOwogICAgICAgIHJlcXVpcmUobkZyb20uYW1vdW50ID49IGFtb3VudCk7CiAgICAgICAgbkZyb20uYW1vdW50IC09IGFtb3VudDsKICAgICAgICBuVG8uYW1vdW50ICs9IGFtb3VudDsKCiAgICAgICAgVHJhbnNmZXIoZnJvbSwgdG8sIGFtb3VudCk7CiAgICAgICAgY2FsbFBsdWdpbnMoZmFsc2UsIGZyb20sIHRvLCBhbW91bnQpOwogICAgfQoKICAgIC8vLyBAbm90aWNlIE9ubHkgYWZmZWN0cyBwbGVkZ2VzIHdpdGggdGhlIFBsZWRnZWQgUGxlZGdlU3RhdGUgZm9yIDIgdGhpbmdzOgogICAgLy8vICAgIzE6IENoZWNrcyBpZiB0aGUgcGxlZGdlIHNob3VsZCBiZSBjb21taXR0ZWQuIFRoaXMgbWVhbnMgdGhhdAogICAgLy8vICAgICAgIGlmIHRoZSBwbGVkZ2UgaGFzIGFuIGludGVuZGVkUHJvamVjdCBhbmQgaXQgaXMgcGFzdCB0aGUKICAgIC8vLyAgICAgICBjb21taXRUaW1lLCBpdCBjaGFuZ2VzIHRoZSBvd25lciB0byBiZSB0aGUgcHJvcG9zZWQgcHJvamVjdAogICAgLy8vICAgICAgIChUaGUgVUkgd2lsbCBoYXZlIHRvIHJlYWQgdGhlIGNvbW1pdCB0aW1lIGFuZCBtYW51YWxseSBkbyB3aGF0CiAgICAvLy8gICAgICAgdGhpcyBmdW5jdGlvbiBkb2VzIHRvIHRoZSBwbGVkZ2UgZm9yIHRoZSBlbmQgdXNlcgogICAgLy8vICAgICAgIGF0IHRoZSBleHBpcmF0aW9uIG9mIHRoZSBjb21taXRUaW1lKQogICAgLy8vCiAgICAvLy8gICAjMjogQ2hlY2tzIHRvIG1ha2Ugc3VyZSB0aGF0IGlmIHRoZXJlIGhhcyBiZWVuIGEgY2FuY2VsbGF0aW9uIGluIHRoZQogICAgLy8vICAgICAgIGNoYWluIG9mIHByb2plY3RzLCB0aGUgcGxlZGdlJ3Mgb3duZXIgaGFzIGJlZW4gY2hhbmdlZAogICAgLy8vICAgICAgIGFwcHJvcHJpYXRlbHkuCiAgICAvLy8KICAgIC8vLyBUaGlzIGZ1bmN0aW9uIGNhbiBiZSBjYWxsZWQgYnkgYW55Ym9keSBhdCBhbnl0aW1lIG9uIGFueSBwbGVkZ2UuCiAgICAvLy8gIEluIGdlbmVyYWwgaXQgY2FuIGJlIGNhbGxlZCB0byBmb3JjZSB0aGUgY2FsbHMgb2YgdGhlIGFmZmVjdGVkIAogICAgLy8vICBwbHVnaW5zLCB3aGljaCBhbHNvIG5lZWQgdG8gYmUgcHJlZGljdGVkIGJ5IHRoZSBVSQogICAgLy8vIEBwYXJhbSBpZFBsZWRnZSBUaGlzIGlzIHRoZSBpZCBvZiB0aGUgcGxlZGdlIHRoYXQgd2lsbCBiZSBub3JtYWxpemVkCiAgICAvLy8gQHJldHVybiBUaGUgbm9ybWFsaXplZCBQbGVkZ2UhCiAgICBmdW5jdGlvbiBub3JtYWxpemVQbGVkZ2UodWludDY0IGlkUGxlZGdlKSByZXR1cm5zKHVpbnQ2NCkgewoKICAgICAgICBQbGVkZ2Ugc3RvcmFnZSBwID0gZmluZFBsZWRnZShpZFBsZWRnZSk7CgogICAgICAgIC8vIENoZWNrIHRvIG1ha2Ugc3VyZSB0aGlzIHBsZWRnZSBoYXNuJ3QgYWxyZWFkeSBiZWVuIHVzZWQgCiAgICAgICAgLy8gb3IgaXMgaW4gdGhlIHByb2Nlc3Mgb2YgYmVpbmcgdXNlZAogICAgICAgIGlmIChwLnBsZWRnZVN0YXRlICE9IFBsZWRnZVN0YXRlLlBsZWRnZWQpIHsKICAgICAgICAgICAgcmV0dXJuIGlkUGxlZGdlOwogICAgICAgIH0KCiAgICAgICAgLy8gRmlyc3Qgc2VuZCB0byBhIHByb2plY3QgaWYgaXQncyBwcm9wb3NlZCBhbmQgY29tbWl0dGVkCiAgICAgICAgaWYgKChwLmludGVuZGVkUHJvamVjdCA+IDApICYmICggZ2V0VGltZSgpID4gcC5jb21taXRUaW1lKSkgewogICAgICAgICAgICB1aW50NjQgb2xkUGxlZGdlID0gZmluZE9yQ3JlYXRlUGxlZGdlKAogICAgICAgICAgICAgICAgcC5vd25lciwKICAgICAgICAgICAgICAgIHAuZGVsZWdhdGlvbkNoYWluLAogICAgICAgICAgICAgICAgMCwKICAgICAgICAgICAgICAgIDAsCiAgICAgICAgICAgICAgICBwLm9sZFBsZWRnZSwKICAgICAgICAgICAgICAgIFBsZWRnZVN0YXRlLlBsZWRnZWQKICAgICAgICAgICAgKTsKICAgICAgICAgICAgdWludDY0IHRvUGxlZGdlID0gZmluZE9yQ3JlYXRlUGxlZGdlKAogICAgICAgICAgICAgICAgcC5pbnRlbmRlZFByb2plY3QsCiAgICAgICAgICAgICAgICBuZXcgdWludDY0W10oMCksCiAgICAgICAgICAgICAgICAwLAogICAgICAgICAgICAgICAgMCwKICAgICAgICAgICAgICAgIG9sZFBsZWRnZSwKICAgICAgICAgICAgICAgIFBsZWRnZVN0YXRlLlBsZWRnZWQKICAgICAgICAgICAgKTsKICAgICAgICAgICAgZG9UcmFuc2ZlcihpZFBsZWRnZSwgdG9QbGVkZ2UsIHAuYW1vdW50KTsKICAgICAgICAgICAgaWRQbGVkZ2UgPSB0b1BsZWRnZTsKICAgICAgICAgICAgcCA9IGZpbmRQbGVkZ2UoaWRQbGVkZ2UpOwogICAgICAgIH0KCiAgICAgICAgdG9QbGVkZ2UgPSBnZXRPbGRlc3RQbGVkZ2VOb3RDYW5jZWxlZChpZFBsZWRnZSk7CiAgICAgICAgaWYgKHRvUGxlZGdlICE9IGlkUGxlZGdlKSB7CiAgICAgICAgICAgIGRvVHJhbnNmZXIoaWRQbGVkZ2UsIHRvUGxlZGdlLCBwLmFtb3VudCk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdG9QbGVkZ2U7CiAgICB9CgovLy8vLy8vLy8vLy8vCi8vIFBsdWdpbnMKLy8vLy8vLy8vLy8vLwoKICAgIC8vLyBAbm90aWNlIGBjYWxsUGx1Z2luYCBpcyB1c2VkIHRvIHRyaWdnZXIgdGhlIGdlbmVyYWwgZnVuY3Rpb25zIGluIHRoZQogICAgLy8vICBwbHVnaW4gZm9yIGFueSBhY3Rpb25zIG5lZWRlZCBiZWZvcmUgYW5kIGFmdGVyIGEgdHJhbnNmZXIgaGFwcGVucy4KICAgIC8vLyAgU3BlY2lmaWNhbGx5IHdoYXQgdGhpcyBkb2VzIGluIHJlbGF0aW9uIHRvIHRoZSBwbHVnaW4gaXMgc29tZXRoaW5nCiAgICAvLy8gIHRoYXQgbGFyZ2VseSBkZXBlbmRzIG9uIHRoZSBmdW5jdGlvbnMgb2YgdGhhdCBwbHVnaW4uIFRoaXMgZnVuY3Rpb24KICAgIC8vLyAgaXMgZ2VuZXJhbGx5IGNhbGxlZCBpbiBwYWlycywgb25jZSBiZWZvcmUsIGFuZCBvbmNlIGFmdGVyIGEgdHJhbnNmZXIuCiAgICAvLy8gQHBhcmFtIGJlZm9yZSBUaGlzIHRvZ2dsZSBkZXRlcm1pbmVzIHdoZXRoZXIgdGhlIHBsdWdpbiBjYWxsIGlzIG9jY3VycmluZwogICAgLy8vICBiZWZvcmUgb3IgYWZ0ZXIgYSB0cmFuc2Zlci4KICAgIC8vLyBAcGFyYW0gYWRtaW5JZCBUaGlzIHNob3VsZCBiZSB0aGUgSWQgb2YgdGhlICp0cnVzdGVkKiBpbmRpdmlkdWFsCiAgICAvLy8gIHdobyBoYXMgY29udHJvbCBvdmVyIHRoaXMgcGx1Z2luLgogICAgLy8vIEBwYXJhbSBmcm9tUGxlZGdlIFRoaXMgaXMgdGhlIElkIGZyb20gd2hpY2ggdmFsdWUgaXMgYmVpbmcgdHJhbnNmZXJlZC4KICAgIC8vLyBAcGFyYW0gdG9QbGVkZ2UgVGhpcyBpcyB0aGUgSWQgdGhhdCB2YWx1ZSBpcyBiZWluZyB0cmFuc2ZlcmVkIHRvLgogICAgLy8vIEBwYXJhbSBjb250ZXh0IFRoZSBzaXR1YXRpb24gdGhhdCBpcyB0cmlnZ2VyaW5nIHRoZSBwbHVnaW4uIFNlZSBwbHVnaW4KICAgIC8vLyAgZm9yIGEgZnVsbCBkZXNjcmlwdGlvbiBvZiBjb250ZXh0cy4KICAgIC8vLyBAcGFyYW0gYW1vdW50IFRoZSBhbW91bnQgb2YgdmFsdWUgdGhhdCBpcyBiZWluZyB0cmFuc2ZlcmVkLgogICAgZnVuY3Rpb24gY2FsbFBsdWdpbigKICAgICAgICBib29sIGJlZm9yZSwKICAgICAgICB1aW50NjQgYWRtaW5JZCwKICAgICAgICB1aW50NjQgZnJvbVBsZWRnZSwKICAgICAgICB1aW50NjQgdG9QbGVkZ2UsCiAgICAgICAgdWludDY0IGNvbnRleHQsCiAgICAgICAgdWludCBhbW91bnQKICAgICkgaW50ZXJuYWwgcmV0dXJucyAodWludCBhbGxvd2VkQW1vdW50KSB7CgogICAgICAgIHVpbnQgbmV3QW1vdW50OwogICAgICAgIGFsbG93ZWRBbW91bnQgPSBhbW91bnQ7CiAgICAgICAgUGxlZGdlQWRtaW4gc3RvcmFnZSBhZG1pbiA9IGZpbmRBZG1pbihhZG1pbklkKTsKICAgICAgICAvLyBDaGVja3MgYWRtaW4gaGFzIGEgcGx1Z2luIGFzc2lnbmVkIGFuZCBhIG5vbi16ZXJvIGFtb3VudCBpcyByZXF1ZXN0ZWQKICAgICAgICBpZiAoKGFkZHJlc3MoYWRtaW4ucGx1Z2luKSAhPSAwKSAmJiAoYWxsb3dlZEFtb3VudCA+IDApKSB7CiAgICAgICAgICAgIC8vIFRoZXJlIGFyZSB0d28gc2VwZXJhdGUgZnVuY3Rpb25zIGNhbGxlZCBpbiB0aGUgcGx1Z2luLgogICAgICAgICAgICAvLyBPbmUgaXMgY2FsbGVkIGJlZm9yZSB0aGUgdHJhbnNmZXIgYW5kIG9uZSBhZnRlcgogICAgICAgICAgICBpZiAoYmVmb3JlKSB7CiAgICAgICAgICAgICAgICBuZXdBbW91bnQgPSBhZG1pbi5wbHVnaW4uYmVmb3JlVHJhbnNmZXIoCiAgICAgICAgICAgICAgICAgICAgYWRtaW5JZCwKICAgICAgICAgICAgICAgICAgICBmcm9tUGxlZGdlLAogICAgICAgICAgICAgICAgICAgIHRvUGxlZGdlLAogICAgICAgICAgICAgICAgICAgIGNvbnRleHQsCiAgICAgICAgICAgICAgICAgICAgYW1vdW50CiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgcmVxdWlyZShuZXdBbW91bnQgPD0gYWxsb3dlZEFtb3VudCk7CiAgICAgICAgICAgICAgICBhbGxvd2VkQW1vdW50ID0gbmV3QW1vdW50OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgYWRtaW4ucGx1Z2luLmFmdGVyVHJhbnNmZXIoCiAgICAgICAgICAgICAgICAgICAgYWRtaW5JZCwKICAgICAgICAgICAgICAgICAgICBmcm9tUGxlZGdlLAogICAgICAgICAgICAgICAgICAgIHRvUGxlZGdlLAogICAgICAgICAgICAgICAgICAgIGNvbnRleHQsCiAgICAgICAgICAgICAgICAgICAgYW1vdW50CiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIC8vLyBAbm90aWNlIGBjYWxsUGx1Z2luc1BsZWRnZWAgaXMgdXNlZCB0byBhcHBseSBwbHVnaW4gY2FsbHMgdG8KICAgIC8vLyAgdGhlIGRlbGVnYXRlIGNoYWluIGFuZCB0aGUgaW50ZW5kZWQgcHJvamVjdCBpZiB0aGVyZSBpcyBvbmUuCiAgICAvLy8gIEl0IGRvZXMgc28gaW4gZWl0aGVyIGEgdHJhbnNmZXJyaW5nIG9yIHJlY2VpdmluZyBjb250ZXh0IGJhc2VkCiAgICAvLy8gIG9uIHRoZSBgaWRQbGVkZ2VgIGFuZCAgYGZyb21QbGVkZ2VgIHBhcmFtZXRlcnMuCiAgICAvLy8gQHBhcmFtIGJlZm9yZSBUaGlzIHRvZ2dsZSBkZXRlcm1pbmVzIHdoZXRoZXIgdGhlIHBsdWdpbiBjYWxsIGlzIG9jY3VyaW5nCiAgICAvLy8gIGJlZm9yZSBvciBhZnRlciBhIHRyYW5zZmVyLgogICAgLy8vIEBwYXJhbSBpZFBsZWRnZSBUaGlzIGlzIHRoZSBJZCBvZiB0aGUgcGxlZGdlIG9uIHdoaWNoIHRoaXMgcGx1Z2luCiAgICAvLy8gIGlzIGJlaW5nIGNhbGxlZC4KICAgIC8vLyBAcGFyYW0gZnJvbVBsZWRnZSBUaGlzIGlzIHRoZSBJZCBmcm9tIHdoaWNoIHZhbHVlIGlzIGJlaW5nIHRyYW5zZmVyZWQuCiAgICAvLy8gQHBhcmFtIHRvUGxlZGdlIFRoaXMgaXMgdGhlIElkIHRoYXQgdmFsdWUgaXMgYmVpbmcgdHJhbnNmZXJlZCB0by4KICAgIC8vLyBAcGFyYW0gYW1vdW50IFRoZSBhbW91bnQgb2YgdmFsdWUgdGhhdCBpcyBiZWluZyB0cmFuc2ZlcmVkLgogICAgZnVuY3Rpb24gY2FsbFBsdWdpbnNQbGVkZ2UoCiAgICAgICAgYm9vbCBiZWZvcmUsCiAgICAgICAgdWludDY0IGlkUGxlZGdlLAogICAgICAgIHVpbnQ2NCBmcm9tUGxlZGdlLAogICAgICAgIHVpbnQ2NCB0b1BsZWRnZSwKICAgICAgICB1aW50IGFtb3VudAogICAgKSBpbnRlcm5hbCByZXR1cm5zICh1aW50IGFsbG93ZWRBbW91bnQpIHsKICAgICAgICAvLyBEZXRlcm1pbmUgaWYgY2FsbFBsdWdpbiBpcyBiZWluZyBhcHBsaWVkIGluIGEgcmVjZWl2aW5nCiAgICAgICAgLy8gb3IgdHJhbnNmZXJyaW5nIGNvbnRleHQKICAgICAgICB1aW50NjQgb2Zmc2V0ID0gaWRQbGVkZ2UgPT0gZnJvbVBsZWRnZSA/IDAgOiAyNTY7CiAgICAgICAgYWxsb3dlZEFtb3VudCA9IGFtb3VudDsKICAgICAgICBQbGVkZ2Ugc3RvcmFnZSBwID0gZmluZFBsZWRnZShpZFBsZWRnZSk7CgogICAgICAgIC8vIEFsd2F5cyBjYWxsIHRoZSBwbHVnaW4gb24gdGhlIG93bmVyCiAgICAgICAgYWxsb3dlZEFtb3VudCA9IGNhbGxQbHVnaW4oCiAgICAgICAgICAgIGJlZm9yZSwKICAgICAgICAgICAgcC5vd25lciwKICAgICAgICAgICAgZnJvbVBsZWRnZSwKICAgICAgICAgICAgdG9QbGVkZ2UsCiAgICAgICAgICAgIG9mZnNldCwKICAgICAgICAgICAgYWxsb3dlZEFtb3VudAogICAgICAgICk7CgogICAgICAgIC8vIEFwcGx5IGNhbGwgcGx1Z2luIHRvIGFsbCBkZWxlZ2F0ZXMKICAgICAgICBmb3IgKHVpbnQ2NCBpPTA7IGk8cC5kZWxlZ2F0aW9uQ2hhaW4ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgYWxsb3dlZEFtb3VudCA9IGNhbGxQbHVnaW4oCiAgICAgICAgICAgICAgICBiZWZvcmUsCiAgICAgICAgICAgICAgICBwLmRlbGVnYXRpb25DaGFpbltpXSwKICAgICAgICAgICAgICAgIGZyb21QbGVkZ2UsCiAgICAgICAgICAgICAgICB0b1BsZWRnZSwKICAgICAgICAgICAgICAgIG9mZnNldCArIGkrMSwKICAgICAgICAgICAgICAgIGFsbG93ZWRBbW91bnQKICAgICAgICAgICAgKTsKICAgICAgICB9CgogICAgICAgIC8vIElmIHRoZXJlIGlzIGFuIGludGVuZGVkIHByb2plY3QgYWxzbyBjYWxsIHRoZSBwbHVnaW4gaW4KICAgICAgICAvLyBlaXRoZXIgYSB0cmFuc2ZlcnJpbmcgb3IgcmVjZWl2aW5nIGNvbnRleHQgYmFzZWQgb24gb2Zmc2V0CiAgICAgICAgLy8gb24gdGhlIGludGVuZGVkIHByb2plY3QKICAgICAgICBpZiAocC5pbnRlbmRlZFByb2plY3QgPiAwKSB7CiAgICAgICAgICAgIGFsbG93ZWRBbW91bnQgPSBjYWxsUGx1Z2luKAogICAgICAgICAgICAgICAgYmVmb3JlLAogICAgICAgICAgICAgICAgcC5pbnRlbmRlZFByb2plY3QsCiAgICAgICAgICAgICAgICBmcm9tUGxlZGdlLAogICAgICAgICAgICAgICAgdG9QbGVkZ2UsCiAgICAgICAgICAgICAgICBvZmZzZXQgKyAyNTUsCiAgICAgICAgICAgICAgICBhbGxvd2VkQW1vdW50CiAgICAgICAgICAgICk7CiAgICAgICAgfQogICAgfQoKCiAgICAvLy8gQG5vdGljZSBgY2FsbFBsdWdpbnNgIGNhbGxzIGBjYWxsUGx1Z2luc1BsZWRnZWAgb25jZSBmb3IgdGhlIHRyYW5zZmVyCiAgICAvLy8gIGNvbnRleHQgYW5kIG9uY2UgZm9yIHRoZSByZWNlaXZpbmcgY29udGV4dC4gVGhlIGFnZ3JlZ2F0ZWQgCiAgICAvLy8gIGFsbG93ZWQgYW1vdW50IGlzIHRoZW4gcmV0dXJuZWQuCiAgICAvLy8gQHBhcmFtIGJlZm9yZSBUaGlzIHRvZ2dsZSBkZXRlcm1pbmVzIHdoZXRoZXIgdGhlIHBsdWdpbiBjYWxsIGlzIG9jY3VycmluZwogICAgLy8vICBiZWZvcmUgb3IgYWZ0ZXIgYSB0cmFuc2Zlci4KICAgIC8vLyBAcGFyYW0gZnJvbVBsZWRnZSBUaGlzIGlzIHRoZSBJZCBmcm9tIHdoaWNoIHZhbHVlIGlzIGJlaW5nIHRyYW5zZmVycmVkLgogICAgLy8vIEBwYXJhbSB0b1BsZWRnZSBUaGlzIGlzIHRoZSBJZCB0aGF0IHZhbHVlIGlzIGJlaW5nIHRyYW5zZmVycmVkIHRvLgogICAgLy8vIEBwYXJhbSBhbW91bnQgVGhlIGFtb3VudCBvZiB2YWx1ZSB0aGF0IGlzIGJlaW5nIHRyYW5zZmVycmVkLgogICAgZnVuY3Rpb24gY2FsbFBsdWdpbnMoCiAgICAgICAgYm9vbCBiZWZvcmUsCiAgICAgICAgdWludDY0IGZyb21QbGVkZ2UsCiAgICAgICAgdWludDY0IHRvUGxlZGdlLAogICAgICAgIHVpbnQgYW1vdW50CiAgICApIGludGVybmFsIHJldHVybnMgKHVpbnQgYWxsb3dlZEFtb3VudCkgewogICAgICAgIGFsbG93ZWRBbW91bnQgPSBhbW91bnQ7CgogICAgICAgIC8vIENhbGwgdGhlIHBsZWRnZXMgcGx1Z2lucyBpbiB0aGUgdHJhbnNmZXIgY29udGV4dAogICAgICAgIGFsbG93ZWRBbW91bnQgPSBjYWxsUGx1Z2luc1BsZWRnZSgKICAgICAgICAgICAgYmVmb3JlLAogICAgICAgICAgICBmcm9tUGxlZGdlLAogICAgICAgICAgICBmcm9tUGxlZGdlLAogICAgICAgICAgICB0b1BsZWRnZSwKICAgICAgICAgICAgYWxsb3dlZEFtb3VudAogICAgICAgICk7CgogICAgICAgIC8vIENhbGwgdGhlIHBsZWRnZXMgcGx1Z2lucyBpbiB0aGUgcmVjZWl2ZSBjb250ZXh0CiAgICAgICAgYWxsb3dlZEFtb3VudCA9IGNhbGxQbHVnaW5zUGxlZGdlKAogICAgICAgICAgICBiZWZvcmUsCiAgICAgICAgICAgIHRvUGxlZGdlLAogICAgICAgICAgICBmcm9tUGxlZGdlLAogICAgICAgICAgICB0b1BsZWRnZSwKICAgICAgICAgICAgYWxsb3dlZEFtb3VudAogICAgICAgICk7CiAgICB9CgovLy8vLy8vLy8vLy8vCi8vIFRlc3QgZnVuY3Rpb25zCi8vLy8vLy8vLy8vLy8KCiAgICAvLy8gQG5vdGljZSBCYXNpYyBoZWxwZXIgZnVuY3Rpb24gdG8gcmV0dXJuIHRoZSBjdXJyZW50IHRpbWUKICAgIGZ1bmN0aW9uIGdldFRpbWUoKSBpbnRlcm5hbCByZXR1cm5zICh1aW50KSB7CiAgICAgICAgcmV0dXJuIG5vdzsKICAgIH0KCiAgICAvLyBFdmVudCBEZWxjZXJhdGlvbnMKICAgIGV2ZW50IFRyYW5zZmVyKHVpbnQ2NCBpbmRleGVkIGZyb20sIHVpbnQ2NCBpbmRleGVkIHRvLCB1aW50IGFtb3VudCk7CiAgICBldmVudCBDYW5jZWxQcm9qZWN0KHVpbnQ2NCBpbmRleGVkIGlkUHJvamVjdCk7Cgp9CgovL0ZpbGU6IG5vZGVfbW9kdWxlcy9taW5pbWV0b2tlbi9jb250cmFjdHMvQ29udHJvbGxlZC5zb2wKcHJhZ21hIHNvbGlkaXR5IF4wLjQuMTg7Cgpjb250cmFjdCBDb250cm9sbGVkIHsKICAgIC8vLyBAbm90aWNlIFRoZSBhZGRyZXNzIG9mIHRoZSBjb250cm9sbGVyIGlzIHRoZSBvbmx5IGFkZHJlc3MgdGhhdCBjYW4gY2FsbAogICAgLy8vICBhIGZ1bmN0aW9uIHdpdGggdGhpcyBtb2RpZmllcgogICAgbW9kaWZpZXIgb25seUNvbnRyb2xsZXIgeyByZXF1aXJlKG1zZy5zZW5kZXIgPT0gY29udHJvbGxlcik7IF87IH0KCiAgICBhZGRyZXNzIHB1YmxpYyBjb250cm9sbGVyOwoKICAgIGZ1bmN0aW9uIENvbnRyb2xsZWQoKSBwdWJsaWMgeyBjb250cm9sbGVyID0gbXNnLnNlbmRlcjt9CgogICAgLy8vIEBub3RpY2UgQ2hhbmdlcyB0aGUgY29udHJvbGxlciBvZiB0aGUgY29udHJhY3QKICAgIC8vLyBAcGFyYW0gX25ld0NvbnRyb2xsZXIgVGhlIG5ldyBjb250cm9sbGVyIG9mIHRoZSBjb250cmFjdAogICAgZnVuY3Rpb24gY2hhbmdlQ29udHJvbGxlcihhZGRyZXNzIF9uZXdDb250cm9sbGVyKSBwdWJsaWMgb25seUNvbnRyb2xsZXIgewogICAgICAgIGNvbnRyb2xsZXIgPSBfbmV3Q29udHJvbGxlcjsKICAgIH0KfQoKLy9GaWxlOiBub2RlX21vZHVsZXMvbWluaW1ldG9rZW4vY29udHJhY3RzL1Rva2VuQ29udHJvbGxlci5zb2wKcHJhZ21hIHNvbGlkaXR5IF4wLjQuMTg7CgovLy8gQGRldiBUaGUgdG9rZW4gY29udHJvbGxlciBjb250cmFjdCBtdXN0IGltcGxlbWVudCB0aGVzZSBmdW5jdGlvbnMKY29udHJhY3QgVG9rZW5Db250cm9sbGVyIHsKICAgIC8vLyBAbm90aWNlIENhbGxlZCB3aGVuIGBfb3duZXJgIHNlbmRzIGV0aGVyIHRvIHRoZSBNaW5pTWUgVG9rZW4gY29udHJhY3QKICAgIC8vLyBAcGFyYW0gX293bmVyIFRoZSBhZGRyZXNzIHRoYXQgc2VudCB0aGUgZXRoZXIgdG8gY3JlYXRlIHRva2VucwogICAgLy8vIEByZXR1cm4gVHJ1ZSBpZiB0aGUgZXRoZXIgaXMgYWNjZXB0ZWQsIGZhbHNlIGlmIGl0IHRocm93cwogICAgZnVuY3Rpb24gcHJveHlQYXltZW50KGFkZHJlc3MgX293bmVyKSBwdWJsaWMgcGF5YWJsZSByZXR1cm5zKGJvb2wpOwoKICAgIC8vLyBAbm90aWNlIE5vdGlmaWVzIHRoZSBjb250cm9sbGVyIGFib3V0IGEgdG9rZW4gdHJhbnNmZXIgYWxsb3dpbmcgdGhlCiAgICAvLy8gIGNvbnRyb2xsZXIgdG8gcmVhY3QgaWYgZGVzaXJlZAogICAgLy8vIEBwYXJhbSBfZnJvbSBUaGUgb3JpZ2luIG9mIHRoZSB0cmFuc2ZlcgogICAgLy8vIEBwYXJhbSBfdG8gVGhlIGRlc3RpbmF0aW9uIG9mIHRoZSB0cmFuc2ZlcgogICAgLy8vIEBwYXJhbSBfYW1vdW50IFRoZSBhbW91bnQgb2YgdGhlIHRyYW5zZmVyCiAgICAvLy8gQHJldHVybiBGYWxzZSBpZiB0aGUgY29udHJvbGxlciBkb2VzIG5vdCBhdXRob3JpemUgdGhlIHRyYW5zZmVyCiAgICBmdW5jdGlvbiBvblRyYW5zZmVyKGFkZHJlc3MgX2Zyb20sIGFkZHJlc3MgX3RvLCB1aW50IF9hbW91bnQpIHB1YmxpYyByZXR1cm5zKGJvb2wpOwoKICAgIC8vLyBAbm90aWNlIE5vdGlmaWVzIHRoZSBjb250cm9sbGVyIGFib3V0IGFuIGFwcHJvdmFsIGFsbG93aW5nIHRoZQogICAgLy8vICBjb250cm9sbGVyIHRvIHJlYWN0IGlmIGRlc2lyZWQKICAgIC8vLyBAcGFyYW0gX293bmVyIFRoZSBhZGRyZXNzIHRoYXQgY2FsbHMgYGFwcHJvdmUoKWAKICAgIC8vLyBAcGFyYW0gX3NwZW5kZXIgVGhlIHNwZW5kZXIgaW4gdGhlIGBhcHByb3ZlKClgIGNhbGwKICAgIC8vLyBAcGFyYW0gX2Ftb3VudCBUaGUgYW1vdW50IGluIHRoZSBgYXBwcm92ZSgpYCBjYWxsCiAgICAvLy8gQHJldHVybiBGYWxzZSBpZiB0aGUgY29udHJvbGxlciBkb2VzIG5vdCBhdXRob3JpemUgdGhlIGFwcHJvdmFsCiAgICBmdW5jdGlvbiBvbkFwcHJvdmUoYWRkcmVzcyBfb3duZXIsIGFkZHJlc3MgX3NwZW5kZXIsIHVpbnQgX2Ftb3VudCkgcHVibGljCiAgICAgICAgcmV0dXJucyhib29sKTsKfQoKLy9GaWxlOiBub2RlX21vZHVsZXMvbWluaW1ldG9rZW4vY29udHJhY3RzL01pbmlNZVRva2VuLnNvbApwcmFnbWEgc29saWRpdHkgXjAuNC4xODsKCi8qCiAgICBDb3B5cmlnaHQgMjAxNiwgSm9yZGkgQmF5bGluYQoKICAgIFRoaXMgcHJvZ3JhbSBpcyBmcmVlIHNvZnR3YXJlOiB5b3UgY2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3IgbW9kaWZ5CiAgICBpdCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFzIHB1Ymxpc2hlZCBieQogICAgdGhlIEZyZWUgU29mdHdhcmUgRm91bmRhdGlvbiwgZWl0aGVyIHZlcnNpb24gMyBvZiB0aGUgTGljZW5zZSwgb3IKICAgIChhdCB5b3VyIG9wdGlvbikgYW55IGxhdGVyIHZlcnNpb24uCgogICAgVGhpcyBwcm9ncmFtIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsCiAgICBidXQgV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZgogICAgTUVSQ0hBTlRBQklMSVRZIG9yIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFLiAgU2VlIHRoZQogICAgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmUgZGV0YWlscy4KCiAgICBZb3Ugc2hvdWxkIGhhdmUgcmVjZWl2ZWQgYSBjb3B5IG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZQogICAgYWxvbmcgd2l0aCB0aGlzIHByb2dyYW0uICBJZiBub3QsIHNlZSA8aHR0cDovL3d3dy5nbnUub3JnL2xpY2Vuc2VzLz4uCiAqLwoKLy8vIEB0aXRsZSBNaW5pTWVUb2tlbiBDb250cmFjdAovLy8gQGF1dGhvciBKb3JkaSBCYXlsaW5hCi8vLyBAZGV2IFRoaXMgdG9rZW4gY29udHJhY3QncyBnb2FsIGlzIHRvIG1ha2UgaXQgZWFzeSBmb3IgYW55b25lIHRvIGNsb25lIHRoaXMKLy8vICB0b2tlbiB1c2luZyB0aGUgdG9rZW4gZGlzdHJpYnV0aW9uIGF0IGEgZ2l2ZW4gYmxvY2ssIHRoaXMgd2lsbCBhbGxvdyBEQU8ncwovLy8gIGFuZCBEQXBwcyB0byB1cGdyYWRlIHRoZWlyIGZlYXR1cmVzIGluIGEgZGVjZW50cmFsaXplZCBtYW5uZXIgd2l0aG91dAovLy8gIGFmZmVjdGluZyB0aGUgb3JpZ2luYWwgdG9rZW4KLy8vIEBkZXYgSXQgaXMgRVJDMjAgY29tcGxpYW50LCBidXQgc3RpbGwgbmVlZHMgdG8gdW5kZXIgZ28gZnVydGhlciB0ZXN0aW5nLgoKCgoKY29udHJhY3QgQXBwcm92ZUFuZENhbGxGYWxsQmFjayB7CiAgICBmdW5jdGlvbiByZWNlaXZlQXBwcm92YWwoYWRkcmVzcyBmcm9tLCB1aW50MjU2IF9hbW91bnQsIGFkZHJlc3MgX3Rva2VuLCBieXRlcyBfZGF0YSkgcHVibGljOwp9CgovLy8gQGRldiBUaGUgYWN0dWFsIHRva2VuIGNvbnRyYWN0LCB0aGUgZGVmYXVsdCBjb250cm9sbGVyIGlzIHRoZSBtc2cuc2VuZGVyCi8vLyAgdGhhdCBkZXBsb3lzIHRoZSBjb250cmFjdCwgc28gdXN1YWxseSB0aGlzIHRva2VuIHdpbGwgYmUgZGVwbG95ZWQgYnkgYQovLy8gIHRva2VuIGNvbnRyb2xsZXIgY29udHJhY3QsIHdoaWNoIEdpdmV0aCB3aWxsIGNhbGwgYSAiQ2FtcGFpZ24iCmNvbnRyYWN0IE1pbmlNZVRva2VuIGlzIENvbnRyb2xsZWQgewoKICAgIHN0cmluZyBwdWJsaWMgbmFtZTsgICAgICAgICAgICAgICAgLy9UaGUgVG9rZW4ncyBuYW1lOiBlLmcuIERpZ2l4REFPIFRva2VucwogICAgdWludDggcHVibGljIGRlY2ltYWxzOyAgICAgICAgICAgICAvL051bWJlciBvZiBkZWNpbWFscyBvZiB0aGUgc21hbGxlc3QgdW5pdAogICAgc3RyaW5nIHB1YmxpYyBzeW1ib2w7ICAgICAgICAgICAgICAvL0FuIGlkZW50aWZpZXI6IGUuZy4gUkVQCiAgICBzdHJpbmcgcHVibGljIHZlcnNpb24gPSAnTU1UXzAuMic7IC8vQW4gYXJiaXRyYXJ5IHZlcnNpb25pbmcgc2NoZW1lCgoKICAgIC8vLyBAZGV2IGBDaGVja3BvaW50YCBpcyB0aGUgc3RydWN0dXJlIHRoYXQgYXR0YWNoZXMgYSBibG9jayBudW1iZXIgdG8gYQogICAgLy8vICBnaXZlbiB2YWx1ZSwgdGhlIGJsb2NrIG51bWJlciBhdHRhY2hlZCBpcyB0aGUgb25lIHRoYXQgbGFzdCBjaGFuZ2VkIHRoZQogICAgLy8vICB2YWx1ZQogICAgc3RydWN0ICBDaGVja3BvaW50IHsKCiAgICAgICAgLy8gYGZyb21CbG9ja2AgaXMgdGhlIGJsb2NrIG51bWJlciB0aGF0IHRoZSB2YWx1ZSB3YXMgZ2VuZXJhdGVkIGZyb20KICAgICAgICB1aW50MTI4IGZyb21CbG9jazsKCiAgICAgICAgLy8gYHZhbHVlYCBpcyB0aGUgYW1vdW50IG9mIHRva2VucyBhdCBhIHNwZWNpZmljIGJsb2NrIG51bWJlcgogICAgICAgIHVpbnQxMjggdmFsdWU7CiAgICB9CgogICAgLy8gYHBhcmVudFRva2VuYCBpcyB0aGUgVG9rZW4gYWRkcmVzcyB0aGF0IHdhcyBjbG9uZWQgdG8gcHJvZHVjZSB0aGlzIHRva2VuOwogICAgLy8gIGl0IHdpbGwgYmUgMHgwIGZvciBhIHRva2VuIHRoYXQgd2FzIG5vdCBjbG9uZWQKICAgIE1pbmlNZVRva2VuIHB1YmxpYyBwYXJlbnRUb2tlbjsKCiAgICAvLyBgcGFyZW50U25hcFNob3RCbG9ja2AgaXMgdGhlIGJsb2NrIG51bWJlciBmcm9tIHRoZSBQYXJlbnQgVG9rZW4gdGhhdCB3YXMKICAgIC8vICB1c2VkIHRvIGRldGVybWluZSB0aGUgaW5pdGlhbCBkaXN0cmlidXRpb24gb2YgdGhlIENsb25lIFRva2VuCiAgICB1aW50IHB1YmxpYyBwYXJlbnRTbmFwU2hvdEJsb2NrOwoKICAgIC8vIGBjcmVhdGlvbkJsb2NrYCBpcyB0aGUgYmxvY2sgbnVtYmVyIHRoYXQgdGhlIENsb25lIFRva2VuIHdhcyBjcmVhdGVkCiAgICB1aW50IHB1YmxpYyBjcmVhdGlvbkJsb2NrOwoKICAgIC8vIGBiYWxhbmNlc2AgaXMgdGhlIG1hcCB0aGF0IHRyYWNrcyB0aGUgYmFsYW5jZSBvZiBlYWNoIGFkZHJlc3MsIGluIHRoaXMKICAgIC8vICBjb250cmFjdCB3aGVuIHRoZSBiYWxhbmNlIGNoYW5nZXMgdGhlIGJsb2NrIG51bWJlciB0aGF0IHRoZSBjaGFuZ2UKICAgIC8vICBvY2N1cnJlZCBpcyBhbHNvIGluY2x1ZGVkIGluIHRoZSBtYXAKICAgIG1hcHBpbmcgKGFkZHJlc3MgPT4gQ2hlY2twb2ludFtdKSBiYWxhbmNlczsKCiAgICAvLyBgYWxsb3dlZGAgdHJhY2tzIGFueSBleHRyYSB0cmFuc2ZlciByaWdodHMgYXMgaW4gYWxsIEVSQzIwIHRva2VucwogICAgbWFwcGluZyAoYWRkcmVzcyA9PiBtYXBwaW5nIChhZGRyZXNzID0+IHVpbnQyNTYpKSBhbGxvd2VkOwoKICAgIC8vIFRyYWNrcyB0aGUgaGlzdG9yeSBvZiB0aGUgYHRvdGFsU3VwcGx5YCBvZiB0aGUgdG9rZW4KICAgIENoZWNrcG9pbnRbXSB0b3RhbFN1cHBseUhpc3Rvcnk7CgogICAgLy8gRmxhZyB0aGF0IGRldGVybWluZXMgaWYgdGhlIHRva2VuIGlzIHRyYW5zZmVyYWJsZSBvciBub3QuCiAgICBib29sIHB1YmxpYyB0cmFuc2ZlcnNFbmFibGVkOwoKICAgIC8vIFRoZSBmYWN0b3J5IHVzZWQgdG8gY3JlYXRlIG5ldyBjbG9uZSB0b2tlbnMKICAgIE1pbmlNZVRva2VuRmFjdG9yeSBwdWJsaWMgdG9rZW5GYWN0b3J5OwoKLy8vLy8vLy8vLy8vLy8vLwovLyBDb25zdHJ1Y3RvcgovLy8vLy8vLy8vLy8vLy8vCgogICAgLy8vIEBub3RpY2UgQ29uc3RydWN0b3IgdG8gY3JlYXRlIGEgTWluaU1lVG9rZW4KICAgIC8vLyBAcGFyYW0gX3Rva2VuRmFjdG9yeSBUaGUgYWRkcmVzcyBvZiB0aGUgTWluaU1lVG9rZW5GYWN0b3J5IGNvbnRyYWN0IHRoYXQKICAgIC8vLyAgd2lsbCBjcmVhdGUgdGhlIENsb25lIHRva2VuIGNvbnRyYWN0cywgdGhlIHRva2VuIGZhY3RvcnkgbmVlZHMgdG8gYmUKICAgIC8vLyAgZGVwbG95ZWQgZmlyc3QKICAgIC8vLyBAcGFyYW0gX3BhcmVudFRva2VuIEFkZHJlc3Mgb2YgdGhlIHBhcmVudCB0b2tlbiwgc2V0IHRvIDB4MCBpZiBpdCBpcyBhCiAgICAvLy8gIG5ldyB0b2tlbgogICAgLy8vIEBwYXJhbSBfcGFyZW50U25hcFNob3RCbG9jayBCbG9jayBvZiB0aGUgcGFyZW50IHRva2VuIHRoYXQgd2lsbAogICAgLy8vICBkZXRlcm1pbmUgdGhlIGluaXRpYWwgZGlzdHJpYnV0aW9uIG9mIHRoZSBjbG9uZSB0b2tlbiwgc2V0IHRvIDAgaWYgaXQKICAgIC8vLyAgaXMgYSBuZXcgdG9rZW4KICAgIC8vLyBAcGFyYW0gX3Rva2VuTmFtZSBOYW1lIG9mIHRoZSBuZXcgdG9rZW4KICAgIC8vLyBAcGFyYW0gX2RlY2ltYWxVbml0cyBOdW1iZXIgb2YgZGVjaW1hbHMgb2YgdGhlIG5ldyB0b2tlbgogICAgLy8vIEBwYXJhbSBfdG9rZW5TeW1ib2wgVG9rZW4gU3ltYm9sIGZvciB0aGUgbmV3IHRva2VuCiAgICAvLy8gQHBhcmFtIF90cmFuc2ZlcnNFbmFibGVkIElmIHRydWUsIHRva2VucyB3aWxsIGJlIGFibGUgdG8gYmUgdHJhbnNmZXJyZWQKICAgIGZ1bmN0aW9uIE1pbmlNZVRva2VuKAogICAgICAgIGFkZHJlc3MgX3Rva2VuRmFjdG9yeSwKICAgICAgICBhZGRyZXNzIF9wYXJlbnRUb2tlbiwKICAgICAgICB1aW50IF9wYXJlbnRTbmFwU2hvdEJsb2NrLAogICAgICAgIHN0cmluZyBfdG9rZW5OYW1lLAogICAgICAgIHVpbnQ4IF9kZWNpbWFsVW5pdHMsCiAgICAgICAgc3RyaW5nIF90b2tlblN5bWJvbCwKICAgICAgICBib29sIF90cmFuc2ZlcnNFbmFibGVkCiAgICApIHB1YmxpYyB7CiAgICAgICAgdG9rZW5GYWN0b3J5ID0gTWluaU1lVG9rZW5GYWN0b3J5KF90b2tlbkZhY3RvcnkpOwogICAgICAgIG5hbWUgPSBfdG9rZW5OYW1lOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNldCB0aGUgbmFtZQogICAgICAgIGRlY2ltYWxzID0gX2RlY2ltYWxVbml0czsgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNldCB0aGUgZGVjaW1hbHMKICAgICAgICBzeW1ib2wgPSBfdG9rZW5TeW1ib2w7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBTZXQgdGhlIHN5bWJvbAogICAgICAgIHBhcmVudFRva2VuID0gTWluaU1lVG9rZW4oX3BhcmVudFRva2VuKTsKICAgICAgICBwYXJlbnRTbmFwU2hvdEJsb2NrID0gX3BhcmVudFNuYXBTaG90QmxvY2s7CiAgICAgICAgdHJhbnNmZXJzRW5hYmxlZCA9IF90cmFuc2ZlcnNFbmFibGVkOwogICAgICAgIGNyZWF0aW9uQmxvY2sgPSBibG9jay5udW1iZXI7CiAgICB9CgoKLy8vLy8vLy8vLy8vLy8vLy8vLwovLyBFUkMyMCBNZXRob2RzCi8vLy8vLy8vLy8vLy8vLy8vLy8KCiAgICAvLy8gQG5vdGljZSBTZW5kIGBfYW1vdW50YCB0b2tlbnMgdG8gYF90b2AgZnJvbSBgbXNnLnNlbmRlcmAKICAgIC8vLyBAcGFyYW0gX3RvIFRoZSBhZGRyZXNzIG9mIHRoZSByZWNpcGllbnQKICAgIC8vLyBAcGFyYW0gX2Ftb3VudCBUaGUgYW1vdW50IG9mIHRva2VucyB0byBiZSB0cmFuc2ZlcnJlZAogICAgLy8vIEByZXR1cm4gV2hldGhlciB0aGUgdHJhbnNmZXIgd2FzIHN1Y2Nlc3NmdWwgb3Igbm90CiAgICBmdW5jdGlvbiB0cmFuc2ZlcihhZGRyZXNzIF90bywgdWludDI1NiBfYW1vdW50KSBwdWJsaWMgcmV0dXJucyAoYm9vbCBzdWNjZXNzKSB7CiAgICAgICAgcmVxdWlyZSh0cmFuc2ZlcnNFbmFibGVkKTsKICAgICAgICByZXR1cm4gZG9UcmFuc2Zlcihtc2cuc2VuZGVyLCBfdG8sIF9hbW91bnQpOwogICAgfQoKICAgIC8vLyBAbm90aWNlIFNlbmQgYF9hbW91bnRgIHRva2VucyB0byBgX3RvYCBmcm9tIGBfZnJvbWAgb24gdGhlIGNvbmRpdGlvbiBpdAogICAgLy8vICBpcyBhcHByb3ZlZCBieSBgX2Zyb21gCiAgICAvLy8gQHBhcmFtIF9mcm9tIFRoZSBhZGRyZXNzIGhvbGRpbmcgdGhlIHRva2VucyBiZWluZyB0cmFuc2ZlcnJlZAogICAgLy8vIEBwYXJhbSBfdG8gVGhlIGFkZHJlc3Mgb2YgdGhlIHJlY2lwaWVudAogICAgLy8vIEBwYXJhbSBfYW1vdW50IFRoZSBhbW91bnQgb2YgdG9rZW5zIHRvIGJlIHRyYW5zZmVycmVkCiAgICAvLy8gQHJldHVybiBUcnVlIGlmIHRoZSB0cmFuc2ZlciB3YXMgc3VjY2Vzc2Z1bAogICAgZnVuY3Rpb24gdHJhbnNmZXJGcm9tKGFkZHJlc3MgX2Zyb20sIGFkZHJlc3MgX3RvLCB1aW50MjU2IF9hbW91bnQKICAgICkgcHVibGljIHJldHVybnMgKGJvb2wgc3VjY2VzcykgewoKICAgICAgICAvLyBUaGUgY29udHJvbGxlciBvZiB0aGlzIGNvbnRyYWN0IGNhbiBtb3ZlIHRva2VucyBhcm91bmQgYXQgd2lsbCwKICAgICAgICAvLyAgdGhpcyBpcyBpbXBvcnRhbnQgdG8gcmVjb2duaXplISBDb25maXJtIHRoYXQgeW91IHRydXN0IHRoZQogICAgICAgIC8vICBjb250cm9sbGVyIG9mIHRoaXMgY29udHJhY3QsIHdoaWNoIGluIG1vc3Qgc2l0dWF0aW9ucyBzaG91bGQgYmUKICAgICAgICAvLyAgYW5vdGhlciBvcGVuIHNvdXJjZSBzbWFydCBjb250cmFjdCBvciAweDAKICAgICAgICBpZiAobXNnLnNlbmRlciAhPSBjb250cm9sbGVyKSB7CiAgICAgICAgICAgIHJlcXVpcmUodHJhbnNmZXJzRW5hYmxlZCk7CgogICAgICAgICAgICAvLyBUaGUgc3RhbmRhcmQgRVJDIDIwIHRyYW5zZmVyRnJvbSBmdW5jdGlvbmFsaXR5CiAgICAgICAgICAgIGlmIChhbGxvd2VkW19mcm9tXVttc2cuc2VuZGVyXSA8IF9hbW91bnQpIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgYWxsb3dlZFtfZnJvbV1bbXNnLnNlbmRlcl0gLT0gX2Ftb3VudDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGRvVHJhbnNmZXIoX2Zyb20sIF90bywgX2Ftb3VudCk7CiAgICB9CgogICAgLy8vIEBkZXYgVGhpcyBpcyB0aGUgYWN0dWFsIHRyYW5zZmVyIGZ1bmN0aW9uIGluIHRoZSB0b2tlbiBjb250cmFjdCwgaXQgY2FuCiAgICAvLy8gIG9ubHkgYmUgY2FsbGVkIGJ5IG90aGVyIGZ1bmN0aW9ucyBpbiB0aGlzIGNvbnRyYWN0LgogICAgLy8vIEBwYXJhbSBfZnJvbSBUaGUgYWRkcmVzcyBob2xkaW5nIHRoZSB0b2tlbnMgYmVpbmcgdHJhbnNmZXJyZWQKICAgIC8vLyBAcGFyYW0gX3RvIFRoZSBhZGRyZXNzIG9mIHRoZSByZWNpcGllbnQKICAgIC8vLyBAcGFyYW0gX2Ftb3VudCBUaGUgYW1vdW50IG9mIHRva2VucyB0byBiZSB0cmFuc2ZlcnJlZAogICAgLy8vIEByZXR1cm4gVHJ1ZSBpZiB0aGUgdHJhbnNmZXIgd2FzIHN1Y2Nlc3NmdWwKICAgIGZ1bmN0aW9uIGRvVHJhbnNmZXIoYWRkcmVzcyBfZnJvbSwgYWRkcmVzcyBfdG8sIHVpbnQgX2Ftb3VudAogICAgKSBpbnRlcm5hbCByZXR1cm5zKGJvb2wpIHsKCiAgICAgICAgICAgaWYgKF9hbW91bnQgPT0gMCkgewogICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICB9CgogICAgICAgICAgIHJlcXVpcmUocGFyZW50U25hcFNob3RCbG9jayA8IGJsb2NrLm51bWJlcik7CgogICAgICAgICAgIC8vIERvIG5vdCBhbGxvdyB0cmFuc2ZlciB0byAweDAgb3IgdGhlIHRva2VuIGNvbnRyYWN0IGl0c2VsZgogICAgICAgICAgIHJlcXVpcmUoKF90byAhPSAwKSAmJiAoX3RvICE9IGFkZHJlc3ModGhpcykpKTsKCiAgICAgICAgICAgLy8gSWYgdGhlIGFtb3VudCBiZWluZyB0cmFuc2ZlcmVkIGlzIG1vcmUgdGhhbiB0aGUgYmFsYW5jZSBvZiB0aGUKICAgICAgICAgICAvLyAgYWNjb3VudCB0aGUgdHJhbnNmZXIgcmV0dXJucyBmYWxzZQogICAgICAgICAgIHZhciBwcmV2aW91c0JhbGFuY2VGcm9tID0gYmFsYW5jZU9mQXQoX2Zyb20sIGJsb2NrLm51bWJlcik7CiAgICAgICAgICAgaWYgKHByZXZpb3VzQmFsYW5jZUZyb20gPCBfYW1vdW50KSB7CiAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICB9CgogICAgICAgICAgIC8vIEFsZXJ0cyB0aGUgdG9rZW4gY29udHJvbGxlciBvZiB0aGUgdHJhbnNmZXIKICAgICAgICAgICBpZiAoaXNDb250cmFjdChjb250cm9sbGVyKSkgewogICAgICAgICAgICAgICByZXF1aXJlKFRva2VuQ29udHJvbGxlcihjb250cm9sbGVyKS5vblRyYW5zZmVyKF9mcm9tLCBfdG8sIF9hbW91bnQpKTsKICAgICAgICAgICB9CgogICAgICAgICAgIC8vIEZpcnN0IHVwZGF0ZSB0aGUgYmFsYW5jZSBhcnJheSB3aXRoIHRoZSBuZXcgdmFsdWUgZm9yIHRoZSBhZGRyZXNzCiAgICAgICAgICAgLy8gIHNlbmRpbmcgdGhlIHRva2VucwogICAgICAgICAgIHVwZGF0ZVZhbHVlQXROb3coYmFsYW5jZXNbX2Zyb21dLCBwcmV2aW91c0JhbGFuY2VGcm9tIC0gX2Ftb3VudCk7CgogICAgICAgICAgIC8vIFRoZW4gdXBkYXRlIHRoZSBiYWxhbmNlIGFycmF5IHdpdGggdGhlIG5ldyB2YWx1ZSBmb3IgdGhlIGFkZHJlc3MKICAgICAgICAgICAvLyAgcmVjZWl2aW5nIHRoZSB0b2tlbnMKICAgICAgICAgICB2YXIgcHJldmlvdXNCYWxhbmNlVG8gPSBiYWxhbmNlT2ZBdChfdG8sIGJsb2NrLm51bWJlcik7CiAgICAgICAgICAgcmVxdWlyZShwcmV2aW91c0JhbGFuY2VUbyArIF9hbW91bnQgPj0gcHJldmlvdXNCYWxhbmNlVG8pOyAvLyBDaGVjayBmb3Igb3ZlcmZsb3cKICAgICAgICAgICB1cGRhdGVWYWx1ZUF0Tm93KGJhbGFuY2VzW190b10sIHByZXZpb3VzQmFsYW5jZVRvICsgX2Ftb3VudCk7CgogICAgICAgICAgIC8vIEFuIGV2ZW50IHRvIG1ha2UgdGhlIHRyYW5zZmVyIGVhc3kgdG8gZmluZCBvbiB0aGUgYmxvY2tjaGFpbgogICAgICAgICAgIFRyYW5zZmVyKF9mcm9tLCBfdG8sIF9hbW91bnQpOwoKICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICAvLy8gQHBhcmFtIF9vd25lciBUaGUgYWRkcmVzcyB0aGF0J3MgYmFsYW5jZSBpcyBiZWluZyByZXF1ZXN0ZWQKICAgIC8vLyBAcmV0dXJuIFRoZSBiYWxhbmNlIG9mIGBfb3duZXJgIGF0IHRoZSBjdXJyZW50IGJsb2NrCiAgICBmdW5jdGlvbiBiYWxhbmNlT2YoYWRkcmVzcyBfb3duZXIpIHB1YmxpYyBjb25zdGFudCByZXR1cm5zICh1aW50MjU2IGJhbGFuY2UpIHsKICAgICAgICByZXR1cm4gYmFsYW5jZU9mQXQoX293bmVyLCBibG9jay5udW1iZXIpOwogICAgfQoKICAgIC8vLyBAbm90aWNlIGBtc2cuc2VuZGVyYCBhcHByb3ZlcyBgX3NwZW5kZXJgIHRvIHNwZW5kIGBfYW1vdW50YCB0b2tlbnMgb24KICAgIC8vLyAgaXRzIGJlaGFsZi4gVGhpcyBpcyBhIG1vZGlmaWVkIHZlcnNpb24gb2YgdGhlIEVSQzIwIGFwcHJvdmUgZnVuY3Rpb24KICAgIC8vLyAgdG8gYmUgYSBsaXR0bGUgYml0IHNhZmVyCiAgICAvLy8gQHBhcmFtIF9zcGVuZGVyIFRoZSBhZGRyZXNzIG9mIHRoZSBhY2NvdW50IGFibGUgdG8gdHJhbnNmZXIgdGhlIHRva2VucwogICAgLy8vIEBwYXJhbSBfYW1vdW50IFRoZSBhbW91bnQgb2YgdG9rZW5zIHRvIGJlIGFwcHJvdmVkIGZvciB0cmFuc2ZlcgogICAgLy8vIEByZXR1cm4gVHJ1ZSBpZiB0aGUgYXBwcm92YWwgd2FzIHN1Y2Nlc3NmdWwKICAgIGZ1bmN0aW9uIGFwcHJvdmUoYWRkcmVzcyBfc3BlbmRlciwgdWludDI1NiBfYW1vdW50KSBwdWJsaWMgcmV0dXJucyAoYm9vbCBzdWNjZXNzKSB7CiAgICAgICAgcmVxdWlyZSh0cmFuc2ZlcnNFbmFibGVkKTsKCiAgICAgICAgLy8gVG8gY2hhbmdlIHRoZSBhcHByb3ZlIGFtb3VudCB5b3UgZmlyc3QgaGF2ZSB0byByZWR1Y2UgdGhlIGFkZHJlc3Nlc2AKICAgICAgICAvLyAgYWxsb3dhbmNlIHRvIHplcm8gYnkgY2FsbGluZyBgYXBwcm92ZShfc3BlbmRlciwwKWAgaWYgaXQgaXMgbm90CiAgICAgICAgLy8gIGFscmVhZHkgMCB0byBtaXRpZ2F0ZSB0aGUgcmFjZSBjb25kaXRpb24gZGVzY3JpYmVkIGhlcmU6CiAgICAgICAgLy8gIGh0dHBzOi8vZ2l0aHViLmNvbS9ldGhlcmV1bS9FSVBzL2lzc3Vlcy8yMCNpc3N1ZWNvbW1lbnQtMjYzNTI0NzI5CiAgICAgICAgcmVxdWlyZSgoX2Ftb3VudCA9PSAwKSB8fCAoYWxsb3dlZFttc2cuc2VuZGVyXVtfc3BlbmRlcl0gPT0gMCkpOwoKICAgICAgICAvLyBBbGVydHMgdGhlIHRva2VuIGNvbnRyb2xsZXIgb2YgdGhlIGFwcHJvdmUgZnVuY3Rpb24gY2FsbAogICAgICAgIGlmIChpc0NvbnRyYWN0KGNvbnRyb2xsZXIpKSB7CiAgICAgICAgICAgIHJlcXVpcmUoVG9rZW5Db250cm9sbGVyKGNvbnRyb2xsZXIpLm9uQXBwcm92ZShtc2cuc2VuZGVyLCBfc3BlbmRlciwgX2Ftb3VudCkpOwogICAgICAgIH0KCiAgICAgICAgYWxsb3dlZFttc2cuc2VuZGVyXVtfc3BlbmRlcl0gPSBfYW1vdW50OwogICAgICAgIEFwcHJvdmFsKG1zZy5zZW5kZXIsIF9zcGVuZGVyLCBfYW1vdW50KTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICAvLy8gQGRldiBUaGlzIGZ1bmN0aW9uIG1ha2VzIGl0IGVhc3kgdG8gcmVhZCB0aGUgYGFsbG93ZWRbXWAgbWFwCiAgICAvLy8gQHBhcmFtIF9vd25lciBUaGUgYWRkcmVzcyBvZiB0aGUgYWNjb3VudCB0aGF0IG93bnMgdGhlIHRva2VuCiAgICAvLy8gQHBhcmFtIF9zcGVuZGVyIFRoZSBhZGRyZXNzIG9mIHRoZSBhY2NvdW50IGFibGUgdG8gdHJhbnNmZXIgdGhlIHRva2VucwogICAgLy8vIEByZXR1cm4gQW1vdW50IG9mIHJlbWFpbmluZyB0b2tlbnMgb2YgX293bmVyIHRoYXQgX3NwZW5kZXIgaXMgYWxsb3dlZAogICAgLy8vICB0byBzcGVuZAogICAgZnVuY3Rpb24gYWxsb3dhbmNlKGFkZHJlc3MgX293bmVyLCBhZGRyZXNzIF9zcGVuZGVyCiAgICApIHB1YmxpYyBjb25zdGFudCByZXR1cm5zICh1aW50MjU2IHJlbWFpbmluZykgewogICAgICAgIHJldHVybiBhbGxvd2VkW19vd25lcl1bX3NwZW5kZXJdOwogICAgfQoKICAgIC8vLyBAbm90aWNlIGBtc2cuc2VuZGVyYCBhcHByb3ZlcyBgX3NwZW5kZXJgIHRvIHNlbmQgYF9hbW91bnRgIHRva2VucyBvbgogICAgLy8vICBpdHMgYmVoYWxmLCBhbmQgdGhlbiBhIGZ1bmN0aW9uIGlzIHRyaWdnZXJlZCBpbiB0aGUgY29udHJhY3QgdGhhdCBpcwogICAgLy8vICBiZWluZyBhcHByb3ZlZCwgYF9zcGVuZGVyYC4gVGhpcyBhbGxvd3MgdXNlcnMgdG8gdXNlIHRoZWlyIHRva2VucyB0bwogICAgLy8vICBpbnRlcmFjdCB3aXRoIGNvbnRyYWN0cyBpbiBvbmUgZnVuY3Rpb24gY2FsbCBpbnN0ZWFkIG9mIHR3bwogICAgLy8vIEBwYXJhbSBfc3BlbmRlciBUaGUgYWRkcmVzcyBvZiB0aGUgY29udHJhY3QgYWJsZSB0byB0cmFuc2ZlciB0aGUgdG9rZW5zCiAgICAvLy8gQHBhcmFtIF9hbW91bnQgVGhlIGFtb3VudCBvZiB0b2tlbnMgdG8gYmUgYXBwcm92ZWQgZm9yIHRyYW5zZmVyCiAgICAvLy8gQHJldHVybiBUcnVlIGlmIHRoZSBmdW5jdGlvbiBjYWxsIHdhcyBzdWNjZXNzZnVsCiAgICBmdW5jdGlvbiBhcHByb3ZlQW5kQ2FsbChhZGRyZXNzIF9zcGVuZGVyLCB1aW50MjU2IF9hbW91bnQsIGJ5dGVzIF9leHRyYURhdGEKICAgICkgcHVibGljIHJldHVybnMgKGJvb2wgc3VjY2VzcykgewogICAgICAgIHJlcXVpcmUoYXBwcm92ZShfc3BlbmRlciwgX2Ftb3VudCkpOwoKICAgICAgICBBcHByb3ZlQW5kQ2FsbEZhbGxCYWNrKF9zcGVuZGVyKS5yZWNlaXZlQXBwcm92YWwoCiAgICAgICAgICAgIG1zZy5zZW5kZXIsCiAgICAgICAgICAgIF9hbW91bnQsCiAgICAgICAgICAgIHRoaXMsCiAgICAgICAgICAgIF9leHRyYURhdGEKICAgICAgICApOwoKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICAvLy8gQGRldiBUaGlzIGZ1bmN0aW9uIG1ha2VzIGl0IGVhc3kgdG8gZ2V0IHRoZSB0b3RhbCBudW1iZXIgb2YgdG9rZW5zCiAgICAvLy8gQHJldHVybiBUaGUgdG90YWwgbnVtYmVyIG9mIHRva2VucwogICAgZnVuY3Rpb24gdG90YWxTdXBwbHkoKSBwdWJsaWMgY29uc3RhbnQgcmV0dXJucyAodWludCkgewogICAgICAgIHJldHVybiB0b3RhbFN1cHBseUF0KGJsb2NrLm51bWJlcik7CiAgICB9CgoKLy8vLy8vLy8vLy8vLy8vLwovLyBRdWVyeSBiYWxhbmNlIGFuZCB0b3RhbFN1cHBseSBpbiBIaXN0b3J5Ci8vLy8vLy8vLy8vLy8vLy8KCiAgICAvLy8gQGRldiBRdWVyaWVzIHRoZSBiYWxhbmNlIG9mIGBfb3duZXJgIGF0IGEgc3BlY2lmaWMgYF9ibG9ja051bWJlcmAKICAgIC8vLyBAcGFyYW0gX293bmVyIFRoZSBhZGRyZXNzIGZyb20gd2hpY2ggdGhlIGJhbGFuY2Ugd2lsbCBiZSByZXRyaWV2ZWQKICAgIC8vLyBAcGFyYW0gX2Jsb2NrTnVtYmVyIFRoZSBibG9jayBudW1iZXIgd2hlbiB0aGUgYmFsYW5jZSBpcyBxdWVyaWVkCiAgICAvLy8gQHJldHVybiBUaGUgYmFsYW5jZSBhdCBgX2Jsb2NrTnVtYmVyYAogICAgZnVuY3Rpb24gYmFsYW5jZU9mQXQoYWRkcmVzcyBfb3duZXIsIHVpbnQgX2Jsb2NrTnVtYmVyKSBwdWJsaWMgY29uc3RhbnQKICAgICAgICByZXR1cm5zICh1aW50KSB7CgogICAgICAgIC8vIFRoZXNlIG5leHQgZmV3IGxpbmVzIGFyZSB1c2VkIHdoZW4gdGhlIGJhbGFuY2Ugb2YgdGhlIHRva2VuIGlzCiAgICAgICAgLy8gIHJlcXVlc3RlZCBiZWZvcmUgYSBjaGVjayBwb2ludCB3YXMgZXZlciBjcmVhdGVkIGZvciB0aGlzIHRva2VuLCBpdAogICAgICAgIC8vICByZXF1aXJlcyB0aGF0IHRoZSBgcGFyZW50VG9rZW4uYmFsYW5jZU9mQXRgIGJlIHF1ZXJpZWQgYXQgdGhlCiAgICAgICAgLy8gIGdlbmVzaXMgYmxvY2sgZm9yIHRoYXQgdG9rZW4gYXMgdGhpcyBjb250YWlucyBpbml0aWFsIGJhbGFuY2Ugb2YKICAgICAgICAvLyAgdGhpcyB0b2tlbgogICAgICAgIGlmICgoYmFsYW5jZXNbX293bmVyXS5sZW5ndGggPT0gMCkKICAgICAgICAgICAgfHwgKGJhbGFuY2VzW19vd25lcl1bMF0uZnJvbUJsb2NrID4gX2Jsb2NrTnVtYmVyKSkgewogICAgICAgICAgICBpZiAoYWRkcmVzcyhwYXJlbnRUb2tlbikgIT0gMCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHBhcmVudFRva2VuLmJhbGFuY2VPZkF0KF9vd25lciwgbWluKF9ibG9ja051bWJlciwgcGFyZW50U25hcFNob3RCbG9jaykpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gSGFzIG5vIHBhcmVudAogICAgICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgICAgIH0KCiAgICAgICAgLy8gVGhpcyB3aWxsIHJldHVybiB0aGUgZXhwZWN0ZWQgYmFsYW5jZSBkdXJpbmcgbm9ybWFsIHNpdHVhdGlvbnMKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gZ2V0VmFsdWVBdChiYWxhbmNlc1tfb3duZXJdLCBfYmxvY2tOdW1iZXIpOwogICAgICAgIH0KICAgIH0KCiAgICAvLy8gQG5vdGljZSBUb3RhbCBhbW91bnQgb2YgdG9rZW5zIGF0IGEgc3BlY2lmaWMgYF9ibG9ja051bWJlcmAuCiAgICAvLy8gQHBhcmFtIF9ibG9ja051bWJlciBUaGUgYmxvY2sgbnVtYmVyIHdoZW4gdGhlIHRvdGFsU3VwcGx5IGlzIHF1ZXJpZWQKICAgIC8vLyBAcmV0dXJuIFRoZSB0b3RhbCBhbW91bnQgb2YgdG9rZW5zIGF0IGBfYmxvY2tOdW1iZXJgCiAgICBmdW5jdGlvbiB0b3RhbFN1cHBseUF0KHVpbnQgX2Jsb2NrTnVtYmVyKSBwdWJsaWMgY29uc3RhbnQgcmV0dXJucyh1aW50KSB7CgogICAgICAgIC8vIFRoZXNlIG5leHQgZmV3IGxpbmVzIGFyZSB1c2VkIHdoZW4gdGhlIHRvdGFsU3VwcGx5IG9mIHRoZSB0b2tlbiBpcwogICAgICAgIC8vICByZXF1ZXN0ZWQgYmVmb3JlIGEgY2hlY2sgcG9pbnQgd2FzIGV2ZXIgY3JlYXRlZCBmb3IgdGhpcyB0b2tlbiwgaXQKICAgICAgICAvLyAgcmVxdWlyZXMgdGhhdCB0aGUgYHBhcmVudFRva2VuLnRvdGFsU3VwcGx5QXRgIGJlIHF1ZXJpZWQgYXQgdGhlCiAgICAgICAgLy8gIGdlbmVzaXMgYmxvY2sgZm9yIHRoaXMgdG9rZW4gYXMgdGhhdCBjb250YWlucyB0b3RhbFN1cHBseSBvZiB0aGlzCiAgICAgICAgLy8gIHRva2VuIGF0IHRoaXMgYmxvY2sgbnVtYmVyLgogICAgICAgIGlmICgodG90YWxTdXBwbHlIaXN0b3J5Lmxlbmd0aCA9PSAwKQogICAgICAgICAgICB8fCAodG90YWxTdXBwbHlIaXN0b3J5WzBdLmZyb21CbG9jayA+IF9ibG9ja051bWJlcikpIHsKICAgICAgICAgICAgaWYgKGFkZHJlc3MocGFyZW50VG9rZW4pICE9IDApIHsKICAgICAgICAgICAgICAgIHJldHVybiBwYXJlbnRUb2tlbi50b3RhbFN1cHBseUF0KG1pbihfYmxvY2tOdW1iZXIsIHBhcmVudFNuYXBTaG90QmxvY2spKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgICAgICB9CgogICAgICAgIC8vIFRoaXMgd2lsbCByZXR1cm4gdGhlIGV4cGVjdGVkIHRvdGFsU3VwcGx5IGR1cmluZyBub3JtYWwgc2l0dWF0aW9ucwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBnZXRWYWx1ZUF0KHRvdGFsU3VwcGx5SGlzdG9yeSwgX2Jsb2NrTnVtYmVyKTsKICAgICAgICB9CiAgICB9CgovLy8vLy8vLy8vLy8vLy8vCi8vIENsb25lIFRva2VuIE1ldGhvZAovLy8vLy8vLy8vLy8vLy8vCgogICAgLy8vIEBub3RpY2UgQ3JlYXRlcyBhIG5ldyBjbG9uZSB0b2tlbiB3aXRoIHRoZSBpbml0aWFsIGRpc3RyaWJ1dGlvbiBiZWluZwogICAgLy8vICB0aGlzIHRva2VuIGF0IGBfc25hcHNob3RCbG9ja2AKICAgIC8vLyBAcGFyYW0gX2Nsb25lVG9rZW5OYW1lIE5hbWUgb2YgdGhlIGNsb25lIHRva2VuCiAgICAvLy8gQHBhcmFtIF9jbG9uZURlY2ltYWxVbml0cyBOdW1iZXIgb2YgZGVjaW1hbHMgb2YgdGhlIHNtYWxsZXN0IHVuaXQKICAgIC8vLyBAcGFyYW0gX2Nsb25lVG9rZW5TeW1ib2wgU3ltYm9sIG9mIHRoZSBjbG9uZSB0b2tlbgogICAgLy8vIEBwYXJhbSBfc25hcHNob3RCbG9jayBCbG9jayB3aGVuIHRoZSBkaXN0cmlidXRpb24gb2YgdGhlIHBhcmVudCB0b2tlbiBpcwogICAgLy8vICBjb3BpZWQgdG8gc2V0IHRoZSBpbml0aWFsIGRpc3RyaWJ1dGlvbiBvZiB0aGUgbmV3IGNsb25lIHRva2VuOwogICAgLy8vICBpZiB0aGUgYmxvY2sgaXMgemVybyB0aGFuIHRoZSBhY3R1YWwgYmxvY2ssIHRoZSBjdXJyZW50IGJsb2NrIGlzIHVzZWQKICAgIC8vLyBAcGFyYW0gX3RyYW5zZmVyc0VuYWJsZWQgVHJ1ZSBpZiB0cmFuc2ZlcnMgYXJlIGFsbG93ZWQgaW4gdGhlIGNsb25lCiAgICAvLy8gQHJldHVybiBUaGUgYWRkcmVzcyBvZiB0aGUgbmV3IE1pbmlNZVRva2VuIENvbnRyYWN0CiAgICBmdW5jdGlvbiBjcmVhdGVDbG9uZVRva2VuKAogICAgICAgIHN0cmluZyBfY2xvbmVUb2tlbk5hbWUsCiAgICAgICAgdWludDggX2Nsb25lRGVjaW1hbFVuaXRzLAogICAgICAgIHN0cmluZyBfY2xvbmVUb2tlblN5bWJvbCwKICAgICAgICB1aW50IF9zbmFwc2hvdEJsb2NrLAogICAgICAgIGJvb2wgX3RyYW5zZmVyc0VuYWJsZWQKICAgICAgICApIHB1YmxpYyByZXR1cm5zKGFkZHJlc3MpIHsKICAgICAgICBpZiAoX3NuYXBzaG90QmxvY2sgPT0gMCkgX3NuYXBzaG90QmxvY2sgPSBibG9jay5udW1iZXI7CiAgICAgICAgTWluaU1lVG9rZW4gY2xvbmVUb2tlbiA9IHRva2VuRmFjdG9yeS5jcmVhdGVDbG9uZVRva2VuKAogICAgICAgICAgICB0aGlzLAogICAgICAgICAgICBfc25hcHNob3RCbG9jaywKICAgICAgICAgICAgX2Nsb25lVG9rZW5OYW1lLAogICAgICAgICAgICBfY2xvbmVEZWNpbWFsVW5pdHMsCiAgICAgICAgICAgIF9jbG9uZVRva2VuU3ltYm9sLAogICAgICAgICAgICBfdHJhbnNmZXJzRW5hYmxlZAogICAgICAgICAgICApOwoKICAgICAgICBjbG9uZVRva2VuLmNoYW5nZUNvbnRyb2xsZXIobXNnLnNlbmRlcik7CgogICAgICAgIC8vIEFuIGV2ZW50IHRvIG1ha2UgdGhlIHRva2VuIGVhc3kgdG8gZmluZCBvbiB0aGUgYmxvY2tjaGFpbgogICAgICAgIE5ld0Nsb25lVG9rZW4oYWRkcmVzcyhjbG9uZVRva2VuKSwgX3NuYXBzaG90QmxvY2spOwogICAgICAgIHJldHVybiBhZGRyZXNzKGNsb25lVG9rZW4pOwogICAgfQoKLy8vLy8vLy8vLy8vLy8vLwovLyBHZW5lcmF0ZSBhbmQgZGVzdHJveSB0b2tlbnMKLy8vLy8vLy8vLy8vLy8vLwoKICAgIC8vLyBAbm90aWNlIEdlbmVyYXRlcyBgX2Ftb3VudGAgdG9rZW5zIHRoYXQgYXJlIGFzc2lnbmVkIHRvIGBfb3duZXJgCiAgICAvLy8gQHBhcmFtIF9vd25lciBUaGUgYWRkcmVzcyB0aGF0IHdpbGwgYmUgYXNzaWduZWQgdGhlIG5ldyB0b2tlbnMKICAgIC8vLyBAcGFyYW0gX2Ftb3VudCBUaGUgcXVhbnRpdHkgb2YgdG9rZW5zIGdlbmVyYXRlZAogICAgLy8vIEByZXR1cm4gVHJ1ZSBpZiB0aGUgdG9rZW5zIGFyZSBnZW5lcmF0ZWQgY29ycmVjdGx5CiAgICBmdW5jdGlvbiBnZW5lcmF0ZVRva2VucyhhZGRyZXNzIF9vd25lciwgdWludCBfYW1vdW50CiAgICApIHB1YmxpYyBvbmx5Q29udHJvbGxlciByZXR1cm5zIChib29sKSB7CiAgICAgICAgdWludCBjdXJUb3RhbFN1cHBseSA9IHRvdGFsU3VwcGx5KCk7CiAgICAgICAgcmVxdWlyZShjdXJUb3RhbFN1cHBseSArIF9hbW91bnQgPj0gY3VyVG90YWxTdXBwbHkpOyAvLyBDaGVjayBmb3Igb3ZlcmZsb3cKICAgICAgICB1aW50IHByZXZpb3VzQmFsYW5jZVRvID0gYmFsYW5jZU9mKF9vd25lcik7CiAgICAgICAgcmVxdWlyZShwcmV2aW91c0JhbGFuY2VUbyArIF9hbW91bnQgPj0gcHJldmlvdXNCYWxhbmNlVG8pOyAvLyBDaGVjayBmb3Igb3ZlcmZsb3cKICAgICAgICB1cGRhdGVWYWx1ZUF0Tm93KHRvdGFsU3VwcGx5SGlzdG9yeSwgY3VyVG90YWxTdXBwbHkgKyBfYW1vdW50KTsKICAgICAgICB1cGRhdGVWYWx1ZUF0Tm93KGJhbGFuY2VzW19vd25lcl0sIHByZXZpb3VzQmFsYW5jZVRvICsgX2Ftb3VudCk7CiAgICAgICAgVHJhbnNmZXIoMCwgX293bmVyLCBfYW1vdW50KTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCgogICAgLy8vIEBub3RpY2UgQnVybnMgYF9hbW91bnRgIHRva2VucyBmcm9tIGBfb3duZXJgCiAgICAvLy8gQHBhcmFtIF9vd25lciBUaGUgYWRkcmVzcyB0aGF0IHdpbGwgbG9zZSB0aGUgdG9rZW5zCiAgICAvLy8gQHBhcmFtIF9hbW91bnQgVGhlIHF1YW50aXR5IG9mIHRva2VucyB0byBidXJuCiAgICAvLy8gQHJldHVybiBUcnVlIGlmIHRoZSB0b2tlbnMgYXJlIGJ1cm5lZCBjb3JyZWN0bHkKICAgIGZ1bmN0aW9uIGRlc3Ryb3lUb2tlbnMoYWRkcmVzcyBfb3duZXIsIHVpbnQgX2Ftb3VudAogICAgKSBvbmx5Q29udHJvbGxlciBwdWJsaWMgcmV0dXJucyAoYm9vbCkgewogICAgICAgIHVpbnQgY3VyVG90YWxTdXBwbHkgPSB0b3RhbFN1cHBseSgpOwogICAgICAgIHJlcXVpcmUoY3VyVG90YWxTdXBwbHkgPj0gX2Ftb3VudCk7CiAgICAgICAgdWludCBwcmV2aW91c0JhbGFuY2VGcm9tID0gYmFsYW5jZU9mKF9vd25lcik7CiAgICAgICAgcmVxdWlyZShwcmV2aW91c0JhbGFuY2VGcm9tID49IF9hbW91bnQpOwogICAgICAgIHVwZGF0ZVZhbHVlQXROb3codG90YWxTdXBwbHlIaXN0b3J5LCBjdXJUb3RhbFN1cHBseSAtIF9hbW91bnQpOwogICAgICAgIHVwZGF0ZVZhbHVlQXROb3coYmFsYW5jZXNbX293bmVyXSwgcHJldmlvdXNCYWxhbmNlRnJvbSAtIF9hbW91bnQpOwogICAgICAgIFRyYW5zZmVyKF9vd25lciwgMCwgX2Ftb3VudCk7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgovLy8vLy8vLy8vLy8vLy8vCi8vIEVuYWJsZSB0b2tlbnMgdHJhbnNmZXJzCi8vLy8vLy8vLy8vLy8vLy8KCgogICAgLy8vIEBub3RpY2UgRW5hYmxlcyB0b2tlbiBob2xkZXJzIHRvIHRyYW5zZmVyIHRoZWlyIHRva2VucyBmcmVlbHkgaWYgdHJ1ZQogICAgLy8vIEBwYXJhbSBfdHJhbnNmZXJzRW5hYmxlZCBUcnVlIGlmIHRyYW5zZmVycyBhcmUgYWxsb3dlZCBpbiB0aGUgY2xvbmUKICAgIGZ1bmN0aW9uIGVuYWJsZVRyYW5zZmVycyhib29sIF90cmFuc2ZlcnNFbmFibGVkKSBwdWJsaWMgb25seUNvbnRyb2xsZXIgewogICAgICAgIHRyYW5zZmVyc0VuYWJsZWQgPSBfdHJhbnNmZXJzRW5hYmxlZDsKICAgIH0KCi8vLy8vLy8vLy8vLy8vLy8KLy8gSW50ZXJuYWwgaGVscGVyIGZ1bmN0aW9ucyB0byBxdWVyeSBhbmQgc2V0IGEgdmFsdWUgaW4gYSBzbmFwc2hvdCBhcnJheQovLy8vLy8vLy8vLy8vLy8vCgogICAgLy8vIEBkZXYgYGdldFZhbHVlQXRgIHJldHJpZXZlcyB0aGUgbnVtYmVyIG9mIHRva2VucyBhdCBhIGdpdmVuIGJsb2NrIG51bWJlcgogICAgLy8vIEBwYXJhbSBjaGVja3BvaW50cyBUaGUgaGlzdG9yeSBvZiB2YWx1ZXMgYmVpbmcgcXVlcmllZAogICAgLy8vIEBwYXJhbSBfYmxvY2sgVGhlIGJsb2NrIG51bWJlciB0byByZXRyaWV2ZSB0aGUgdmFsdWUgYXQKICAgIC8vLyBAcmV0dXJuIFRoZSBudW1iZXIgb2YgdG9rZW5zIGJlaW5nIHF1ZXJpZWQKICAgIGZ1bmN0aW9uIGdldFZhbHVlQXQoQ2hlY2twb2ludFtdIHN0b3JhZ2UgY2hlY2twb2ludHMsIHVpbnQgX2Jsb2NrCiAgICApIGNvbnN0YW50IGludGVybmFsIHJldHVybnMgKHVpbnQpIHsKICAgICAgICBpZiAoY2hlY2twb2ludHMubGVuZ3RoID09IDApIHJldHVybiAwOwoKICAgICAgICAvLyBTaG9ydGN1dCBmb3IgdGhlIGFjdHVhbCB2YWx1ZQogICAgICAgIGlmIChfYmxvY2sgPj0gY2hlY2twb2ludHNbY2hlY2twb2ludHMubGVuZ3RoLTFdLmZyb21CbG9jaykKICAgICAgICAgICAgcmV0dXJuIGNoZWNrcG9pbnRzW2NoZWNrcG9pbnRzLmxlbmd0aC0xXS52YWx1ZTsKICAgICAgICBpZiAoX2Jsb2NrIDwgY2hlY2twb2ludHNbMF0uZnJvbUJsb2NrKSByZXR1cm4gMDsKCiAgICAgICAgLy8gQmluYXJ5IHNlYXJjaCBvZiB0aGUgdmFsdWUgaW4gdGhlIGFycmF5CiAgICAgICAgdWludCBtaW4gPSAwOwogICAgICAgIHVpbnQgbWF4ID0gY2hlY2twb2ludHMubGVuZ3RoLTE7CiAgICAgICAgd2hpbGUgKG1heCA+IG1pbikgewogICAgICAgICAgICB1aW50IG1pZCA9IChtYXggKyBtaW4gKyAxKS8gMjsKICAgICAgICAgICAgaWYgKGNoZWNrcG9pbnRzW21pZF0uZnJvbUJsb2NrPD1fYmxvY2spIHsKICAgICAgICAgICAgICAgIG1pbiA9IG1pZDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG1heCA9IG1pZC0xOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBjaGVja3BvaW50c1ttaW5dLnZhbHVlOwogICAgfQoKICAgIC8vLyBAZGV2IGB1cGRhdGVWYWx1ZUF0Tm93YCB1c2VkIHRvIHVwZGF0ZSB0aGUgYGJhbGFuY2VzYCBtYXAgYW5kIHRoZQogICAgLy8vICBgdG90YWxTdXBwbHlIaXN0b3J5YAogICAgLy8vIEBwYXJhbSBjaGVja3BvaW50cyBUaGUgaGlzdG9yeSBvZiBkYXRhIGJlaW5nIHVwZGF0ZWQKICAgIC8vLyBAcGFyYW0gX3ZhbHVlIFRoZSBuZXcgbnVtYmVyIG9mIHRva2VucwogICAgZnVuY3Rpb24gdXBkYXRlVmFsdWVBdE5vdyhDaGVja3BvaW50W10gc3RvcmFnZSBjaGVja3BvaW50cywgdWludCBfdmFsdWUKICAgICkgaW50ZXJuYWwgIHsKICAgICAgICBpZiAoKGNoZWNrcG9pbnRzLmxlbmd0aCA9PSAwKQogICAgICAgIHx8IChjaGVja3BvaW50c1tjaGVja3BvaW50cy5sZW5ndGggLTFdLmZyb21CbG9jayA8IGJsb2NrLm51bWJlcikpIHsKICAgICAgICAgICAgICAgQ2hlY2twb2ludCBzdG9yYWdlIG5ld0NoZWNrUG9pbnQgPSBjaGVja3BvaW50c1sgY2hlY2twb2ludHMubGVuZ3RoKysgXTsKICAgICAgICAgICAgICAgbmV3Q2hlY2tQb2ludC5mcm9tQmxvY2sgPSAgdWludDEyOChibG9jay5udW1iZXIpOwogICAgICAgICAgICAgICBuZXdDaGVja1BvaW50LnZhbHVlID0gdWludDEyOChfdmFsdWUpOwogICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgIENoZWNrcG9pbnQgc3RvcmFnZSBvbGRDaGVja1BvaW50ID0gY2hlY2twb2ludHNbY2hlY2twb2ludHMubGVuZ3RoLTFdOwogICAgICAgICAgICAgICBvbGRDaGVja1BvaW50LnZhbHVlID0gdWludDEyOChfdmFsdWUpOwogICAgICAgICAgIH0KICAgIH0KCiAgICAvLy8gQGRldiBJbnRlcm5hbCBmdW5jdGlvbiB0byBkZXRlcm1pbmUgaWYgYW4gYWRkcmVzcyBpcyBhIGNvbnRyYWN0CiAgICAvLy8gQHBhcmFtIF9hZGRyIFRoZSBhZGRyZXNzIGJlaW5nIHF1ZXJpZWQKICAgIC8vLyBAcmV0dXJuIFRydWUgaWYgYF9hZGRyYCBpcyBhIGNvbnRyYWN0CiAgICBmdW5jdGlvbiBpc0NvbnRyYWN0KGFkZHJlc3MgX2FkZHIpIGNvbnN0YW50IGludGVybmFsIHJldHVybnMoYm9vbCkgewogICAgICAgIHVpbnQgc2l6ZTsKICAgICAgICBpZiAoX2FkZHIgPT0gMCkgcmV0dXJuIGZhbHNlOwogICAgICAgIGFzc2VtYmx5IHsKICAgICAgICAgICAgc2l6ZSA6PSBleHRjb2Rlc2l6ZShfYWRkcikKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHNpemU+MDsKICAgIH0KCiAgICAvLy8gQGRldiBIZWxwZXIgZnVuY3Rpb24gdG8gcmV0dXJuIGEgbWluIGJldHdlbiB0aGUgdHdvIHVpbnRzCiAgICBmdW5jdGlvbiBtaW4odWludCBhLCB1aW50IGIpIHB1cmUgaW50ZXJuYWwgcmV0dXJucyAodWludCkgewogICAgICAgIHJldHVybiBhIDwgYiA/IGEgOiBiOwogICAgfQoKICAgIC8vLyBAbm90aWNlIFRoZSBmYWxsYmFjayBmdW5jdGlvbjogSWYgdGhlIGNvbnRyYWN0J3MgY29udHJvbGxlciBoYXMgbm90IGJlZW4KICAgIC8vLyAgc2V0IHRvIDAsIHRoZW4gdGhlIGBwcm94eVBheW1lbnRgIG1ldGhvZCBpcyBjYWxsZWQgd2hpY2ggcmVsYXlzIHRoZQogICAgLy8vICBldGhlciBhbmQgY3JlYXRlcyB0b2tlbnMgYXMgZGVzY3JpYmVkIGluIHRoZSB0b2tlbiBjb250cm9sbGVyIGNvbnRyYWN0CiAgICBmdW5jdGlvbiAoKSBwdWJsaWMgcGF5YWJsZSB7CiAgICAgICAgcmVxdWlyZShpc0NvbnRyYWN0KGNvbnRyb2xsZXIpKTsKICAgICAgICByZXF1aXJlKFRva2VuQ29udHJvbGxlcihjb250cm9sbGVyKS5wcm94eVBheW1lbnQudmFsdWUobXNnLnZhbHVlKShtc2cuc2VuZGVyKSk7CiAgICB9CgovLy8vLy8vLy8vCi8vIFNhZmV0eSBNZXRob2RzCi8vLy8vLy8vLy8KCiAgICAvLy8gQG5vdGljZSBUaGlzIG1ldGhvZCBjYW4gYmUgdXNlZCBieSB0aGUgY29udHJvbGxlciB0byBleHRyYWN0IG1pc3Rha2VubHkKICAgIC8vLyAgc2VudCB0b2tlbnMgdG8gdGhpcyBjb250cmFjdC4KICAgIC8vLyBAcGFyYW0gX3Rva2VuIFRoZSBhZGRyZXNzIG9mIHRoZSB0b2tlbiBjb250cmFjdCB0aGF0IHlvdSB3YW50IHRvIHJlY292ZXIKICAgIC8vLyAgc2V0IHRvIDAgaW4gY2FzZSB5b3Ugd2FudCB0byBleHRyYWN0IGV0aGVyLgogICAgZnVuY3Rpb24gY2xhaW1Ub2tlbnMoYWRkcmVzcyBfdG9rZW4pIHB1YmxpYyBvbmx5Q29udHJvbGxlciB7CiAgICAgICAgaWYgKF90b2tlbiA9PSAweDApIHsKICAgICAgICAgICAgY29udHJvbGxlci50cmFuc2Zlcih0aGlzLmJhbGFuY2UpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBNaW5pTWVUb2tlbiB0b2tlbiA9IE1pbmlNZVRva2VuKF90b2tlbik7CiAgICAgICAgdWludCBiYWxhbmNlID0gdG9rZW4uYmFsYW5jZU9mKHRoaXMpOwogICAgICAgIHRva2VuLnRyYW5zZmVyKGNvbnRyb2xsZXIsIGJhbGFuY2UpOwogICAgICAgIENsYWltZWRUb2tlbnMoX3Rva2VuLCBjb250cm9sbGVyLCBiYWxhbmNlKTsKICAgIH0KCi8vLy8vLy8vLy8vLy8vLy8KLy8gRXZlbnRzCi8vLy8vLy8vLy8vLy8vLy8KICAgIGV2ZW50IENsYWltZWRUb2tlbnMoYWRkcmVzcyBpbmRleGVkIF90b2tlbiwgYWRkcmVzcyBpbmRleGVkIF9jb250cm9sbGVyLCB1aW50IF9hbW91bnQpOwogICAgZXZlbnQgVHJhbnNmZXIoYWRkcmVzcyBpbmRleGVkIF9mcm9tLCBhZGRyZXNzIGluZGV4ZWQgX3RvLCB1aW50MjU2IF9hbW91bnQpOwogICAgZXZlbnQgTmV3Q2xvbmVUb2tlbihhZGRyZXNzIGluZGV4ZWQgX2Nsb25lVG9rZW4sIHVpbnQgX3NuYXBzaG90QmxvY2spOwogICAgZXZlbnQgQXBwcm92YWwoCiAgICAgICAgYWRkcmVzcyBpbmRleGVkIF9vd25lciwKICAgICAgICBhZGRyZXNzIGluZGV4ZWQgX3NwZW5kZXIsCiAgICAgICAgdWludDI1NiBfYW1vdW50CiAgICAgICAgKTsKCn0KCgovLy8vLy8vLy8vLy8vLy8vCi8vIE1pbmlNZVRva2VuRmFjdG9yeQovLy8vLy8vLy8vLy8vLy8vCgovLy8gQGRldiBUaGlzIGNvbnRyYWN0IGlzIHVzZWQgdG8gZ2VuZXJhdGUgY2xvbmUgY29udHJhY3RzIGZyb20gYSBjb250cmFjdC4KLy8vICBJbiBzb2xpZGl0eSB0aGlzIGlzIHRoZSB3YXkgdG8gY3JlYXRlIGEgY29udHJhY3QgZnJvbSBhIGNvbnRyYWN0IG9mIHRoZQovLy8gIHNhbWUgY2xhc3MKY29udHJhY3QgTWluaU1lVG9rZW5GYWN0b3J5IHsKCiAgICAvLy8gQG5vdGljZSBVcGRhdGUgdGhlIERBcHAgYnkgY3JlYXRpbmcgYSBuZXcgdG9rZW4gd2l0aCBuZXcgZnVuY3Rpb25hbGl0aWVzCiAgICAvLy8gIHRoZSBtc2cuc2VuZGVyIGJlY29tZXMgdGhlIGNvbnRyb2xsZXIgb2YgdGhpcyBjbG9uZSB0b2tlbgogICAgLy8vIEBwYXJhbSBfcGFyZW50VG9rZW4gQWRkcmVzcyBvZiB0aGUgdG9rZW4gYmVpbmcgY2xvbmVkCiAgICAvLy8gQHBhcmFtIF9zbmFwc2hvdEJsb2NrIEJsb2NrIG9mIHRoZSBwYXJlbnQgdG9rZW4gdGhhdCB3aWxsCiAgICAvLy8gIGRldGVybWluZSB0aGUgaW5pdGlhbCBkaXN0cmlidXRpb24gb2YgdGhlIGNsb25lIHRva2VuCiAgICAvLy8gQHBhcmFtIF90b2tlbk5hbWUgTmFtZSBvZiB0aGUgbmV3IHRva2VuCiAgICAvLy8gQHBhcmFtIF9kZWNpbWFsVW5pdHMgTnVtYmVyIG9mIGRlY2ltYWxzIG9mIHRoZSBuZXcgdG9rZW4KICAgIC8vLyBAcGFyYW0gX3Rva2VuU3ltYm9sIFRva2VuIFN5bWJvbCBmb3IgdGhlIG5ldyB0b2tlbgogICAgLy8vIEBwYXJhbSBfdHJhbnNmZXJzRW5hYmxlZCBJZiB0cnVlLCB0b2tlbnMgd2lsbCBiZSBhYmxlIHRvIGJlIHRyYW5zZmVycmVkCiAgICAvLy8gQHJldHVybiBUaGUgYWRkcmVzcyBvZiB0aGUgbmV3IHRva2VuIGNvbnRyYWN0CiAgICBmdW5jdGlvbiBjcmVhdGVDbG9uZVRva2VuKAogICAgICAgIGFkZHJlc3MgX3BhcmVudFRva2VuLAogICAgICAgIHVpbnQgX3NuYXBzaG90QmxvY2ssCiAgICAgICAgc3RyaW5nIF90b2tlbk5hbWUsCiAgICAgICAgdWludDggX2RlY2ltYWxVbml0cywKICAgICAgICBzdHJpbmcgX3Rva2VuU3ltYm9sLAogICAgICAgIGJvb2wgX3RyYW5zZmVyc0VuYWJsZWQKICAgICkgcHVibGljIHJldHVybnMgKE1pbmlNZVRva2VuKSB7CiAgICAgICAgTWluaU1lVG9rZW4gbmV3VG9rZW4gPSBuZXcgTWluaU1lVG9rZW4oCiAgICAgICAgICAgIHRoaXMsCiAgICAgICAgICAgIF9wYXJlbnRUb2tlbiwKICAgICAgICAgICAgX3NuYXBzaG90QmxvY2ssCiAgICAgICAgICAgIF90b2tlbk5hbWUsCiAgICAgICAgICAgIF9kZWNpbWFsVW5pdHMsCiAgICAgICAgICAgIF90b2tlblN5bWJvbCwKICAgICAgICAgICAgX3RyYW5zZmVyc0VuYWJsZWQKICAgICAgICAgICAgKTsKCiAgICAgICAgbmV3VG9rZW4uY2hhbmdlQ29udHJvbGxlcihtc2cuc2VuZGVyKTsKICAgICAgICByZXR1cm4gbmV3VG9rZW47CiAgICB9Cn0KCi8vRmlsZTogY29udHJhY3RzL0xQUERhY3Muc29sCnByYWdtYSBzb2xpZGl0eSBeMC40LjE3OwoKLyoKICAgIENvcHlyaWdodCAyMDE3LCBSSiBFd2luZyA8PHNwYW4gY2xhc3M9Il9fY2ZfZW1haWxfXyIgZGF0YS1jZmVtYWlsPSJmZjhmOWE4ZDk2OGM4YzkwOTM5MDk4ODZiZjhmOGQ5MDhiOTA5MTkyOWU5NjkzZDE5YzkwOTIiPltlbWFpbCYjMTYwO3Byb3RlY3RlZF08L3NwYW4+PgoKICAgIFRoaXMgcHJvZ3JhbSBpcyBmcmVlIHNvZnR3YXJlOiB5b3UgY2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3IgbW9kaWZ5CiAgICBpdCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFzIHB1Ymxpc2hlZCBieQogICAgdGhlIEZyZWUgU29mdHdhcmUgRm91bmRhdGlvbiwgZWl0aGVyIHZlcnNpb24gMyBvZiB0aGUgTGljZW5zZSwgb3IKICAgIChhdCB5b3VyIG9wdGlvbikgYW55IGxhdGVyIHZlcnNpb24uCgogICAgVGhpcyBwcm9ncmFtIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsCiAgICBidXQgV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZgogICAgTUVSQ0hBTlRBQklMSVRZIG9yIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFLiAgU2VlIHRoZQogICAgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmUgZGV0YWlscy4KCiAgICBZb3Ugc2hvdWxkIGhhdmUgcmVjZWl2ZWQgYSBjb3B5IG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZQogICAgYWxvbmcgd2l0aCB0aGlzIHByb2dyYW0uICBJZiBub3QsIHNlZSA8aHR0cDovL3d3dy5nbnUub3JnL2xpY2Vuc2VzLz4uCiovCgoKCgoKCmNvbnRyYWN0IExQUERhY3MgaXMgRXNjYXBhYmxlLCBUb2tlbkNvbnRyb2xsZXIgewogICAgdWludCBjb25zdGFudCBGUk9NX0ZJUlNUX0RFTEVHQVRFID0gMTsKICAgIHVpbnQgY29uc3RhbnQgVE9fRklSU1RfREVMRUdBVEUgPSAyNTc7CgogICAgTGlxdWlkUGxlZGdpbmcgcHVibGljIGxpcXVpZFBsZWRnaW5nOwoKICAgIHN0cnVjdCBEYWMgewogICAgICAgIE1pbmlNZVRva2VuIHRva2VuOwogICAgICAgIGFkZHJlc3Mgb3duZXI7CiAgICB9CgogICAgbWFwcGluZyAodWludDY0ID0+IERhYykgZGFjczsKCiAgICBldmVudCBHZW5lcmF0ZVRva2Vucyh1aW50NjQgaW5kZXhlZCBpZERlbGVnYXRlLCBhZGRyZXNzIGFkZHIsIHVpbnQgYW1vdW50KTsKICAgIGV2ZW50IERlc3Ryb3lUb2tlbnModWludDY0IGluZGV4ZWQgaWREZWxlZ2F0ZSwgYWRkcmVzcyBhZGRyLCB1aW50IGFtb3VudCk7CgogICAgLy89PSBjb25zdHJ1Y3RvcgoKICAgIGZ1bmN0aW9uIExQUERhY3MoCiAgICAgICAgTGlxdWlkUGxlZGdpbmcgX2xpcXVpZFBsZWRnaW5nLAogICAgICAgIGFkZHJlc3MgX2VzY2FwZUhhdGNoQ2FsbGVyLAogICAgICAgIGFkZHJlc3MgX2VzY2FwZUhhdGNoRGVzdGluYXRpb24KICAgICkgRXNjYXBhYmxlKF9lc2NhcGVIYXRjaENhbGxlciwgX2VzY2FwZUhhdGNoRGVzdGluYXRpb24pIHB1YmxpYwogICAgewogICAgICAgIGxpcXVpZFBsZWRnaW5nID0gX2xpcXVpZFBsZWRnaW5nOwogICAgfQoKICAgIC8vPT0gZXh0ZXJuYWwKCiAgICAvLy8gQGRldiB0aGlzIGlzIGNhbGxlZCBieSBsaXF1aWRQbGVkZ2luZyBiZWZvcmUgZXZlcnkgdHJhbnNmZXIgdG8gYW5kIGZyb20KICAgIC8vLyAgICAgIGEgcGxlZGdlQWRtaW4gdGhhdCBoYXMgdGhpcyBjb250cmFjdCBhcyBpdHMgcGx1Z2luCiAgICAvLy8gQGRldiBzZWUgSUxpcXVpZFBsZWRnaW5nUGx1Z2luIGludGVyZmFjZSBmb3IgZGV0YWlscyBhYm91dCBjb250ZXh0IHBhcmFtCiAgICBmdW5jdGlvbiBiZWZvcmVUcmFuc2ZlcigKICAgICAgICB1aW50NjQgcGxlZGdlTWFuYWdlciwKICAgICAgICB1aW50NjQgcGxlZGdlRnJvbSwKICAgICAgICB1aW50NjQgcGxlZGdlVG8sCiAgICAgICAgdWludDY0IGNvbnRleHQsCiAgICAgICAgdWludCBhbW91bnQKICAgICkgZXh0ZXJuYWwgcmV0dXJucyAodWludCBtYXhBbGxvd2VkKQogICAgewogICAgICAgIHJlcXVpcmUobXNnLnNlbmRlciA9PSBhZGRyZXNzKGxpcXVpZFBsZWRnaW5nKSk7CiAgICAgICAgcmV0dXJuIGFtb3VudDsKICAgIH0KCiAgICAvLy8gQGRldiB0aGlzIGlzIGNhbGxlZCBieSBsaXF1aWRQbGVkZ2luZyBhZnRlciBldmVyeSB0cmFuc2ZlciB0byBhbmQgZnJvbQogICAgLy8vICAgICAgYSBwbGVkZ2VBZG1pbiB0aGF0IGhhcyB0aGlzIGNvbnRyYWN0IGFzIGl0cyBwbHVnaW4KICAgIC8vLyBAZGV2IHNlZSBJTGlxdWlkUGxlZGdpbmdQbHVnaW4gaW50ZXJmYWNlIGZvciBkZXRhaWxzIGFib3V0IGNvbnRleHQgcGFyYW0KICAgIGZ1bmN0aW9uIGFmdGVyVHJhbnNmZXIoCiAgICAgICAgdWludDY0IHBsZWRnZU1hbmFnZXIsCiAgICAgICAgdWludDY0IHBsZWRnZUZyb20sCiAgICAgICAgdWludDY0IHBsZWRnZVRvLAogICAgICAgIHVpbnQ2NCBjb250ZXh0LAogICAgICAgIHVpbnQgYW1vdW50CiAgICApIGV4dGVybmFsCiAgICB7CiAgICAgICAgcmVxdWlyZShtc2cuc2VuZGVyID09IGFkZHJlc3MobGlxdWlkUGxlZGdpbmcpKTsKICAgICAgICB2YXIgKCwgdG9Pd25lciwgLCB0b0ludGVuZGVkUHJvamVjdCwgLCAsIHRvUGxlZGdlU3RhdGUgKSA9IGxpcXVpZFBsZWRnaW5nLmdldFBsZWRnZShwbGVkZ2VUbyk7CiAgICAgICAgdmFyICgsIGZyb21Pd25lciwgLCAsICwgLCApID0gbGlxdWlkUGxlZGdpbmcuZ2V0UGxlZGdlKHBsZWRnZUZyb20pOwogICAgICAgIHZhciAodG9BZG1pblR5cGUsIHRvQWRkciwgLCAsICwgLCAsICkgPSBsaXF1aWRQbGVkZ2luZy5nZXRQbGVkZ2VBZG1pbih0b093bmVyKTsKICAgICAgICBEYWMgc3RvcmFnZSBkOwogICAgICAgIHVpbnQ2NCBpZERlbGVnYXRlOwoKICAgICAgICAvLyBvbmx5IGlzc3VlIHRva2VucyB3aGVuIHBsZWRnZSBpcyBjb21taXR0ZWQgdG8gYSBwcm9qZWN0IGFuZCBhIGRhYyBpcyB0aGUgZmlyc3QgZGVsZWdhdGUKICAgICAgICBpZiAoY29udGV4dCA9PSBGUk9NX0ZJUlNUX0RFTEVHQVRFICYmCiAgICAgICAgICAgICAgICB0b0ludGVuZGVkUHJvamVjdCA9PSAwICYmCiAgICAgICAgICAgICAgICB0b0FkbWluVHlwZSA9PSBMaXF1aWRQbGVkZ2luZ0Jhc2UuUGxlZGdlQWRtaW5UeXBlLlByb2plY3QgJiYKICAgICAgICAgICAgICAgIHRvT3duZXIgIT0gZnJvbU93bmVyICYmCiAgICAgICAgICAgICAgICB0b1BsZWRnZVN0YXRlID09IExpcXVpZFBsZWRnaW5nQmFzZS5QbGVkZ2VTdGF0ZS5QbGVkZ2VkKQogICAgICAgIHsKICAgICAgICAgICAgKGlkRGVsZWdhdGUsICwgKSA9IGxpcXVpZFBsZWRnaW5nLmdldFBsZWRnZURlbGVnYXRlKHBsZWRnZUZyb20sIDEpOwogICAgICAgICAgICBkID0gZGFjc1tpZERlbGVnYXRlXTsKCiAgICAgICAgICAgIHJlcXVpcmUoYWRkcmVzcyhkLnRva2VuKSAhPSAweDApOwoKICAgICAgICAgICAgdmFyICgsIGZyb21BZGRyICwgLCAsICwgLCAsICkgPSBsaXF1aWRQbGVkZ2luZy5nZXRQbGVkZ2VBZG1pbihmcm9tT3duZXIpOwoKICAgICAgICAgICAgZC50b2tlbi5nZW5lcmF0ZVRva2Vucyhmcm9tQWRkciwgYW1vdW50KTsKICAgICAgICAgICAgR2VuZXJhdGVUb2tlbnMoaWREZWxlZ2F0ZSwgZnJvbUFkZHIsIGFtb3VudCk7CiAgICAgICAgfQoKICAgICAgICAvLyBpZiBhIGNvbW1pdHRlZCBwcm9qZWN0IGlzIGNhbmNlbGVkIGFuZCB0aGUgcGxlZGdlIGlzIHJvbGxpbmcgYmFjayB0byBhCiAgICAgICAgLy8gZGFjLCB3ZSBuZWVkIHRvIGJ1cm4gdGhlIHRva2VucyB0aGF0IHdlJ3JlIGdlbmVyYXRlZAogICAgICAgIGlmICggKGNvbnRleHQgPT0gVE9fRklSU1RfREVMRUdBVEUpICYmCiAgICAgICAgICAgIGxpcXVpZFBsZWRnaW5nLmlzUHJvamVjdENhbmNlbGVkKGZyb21Pd25lcikpIHsKICAgICAgICAgICAgKGlkRGVsZWdhdGUsICwgKSA9IGxpcXVpZFBsZWRnaW5nLmdldFBsZWRnZURlbGVnYXRlKHBsZWRnZVRvLCAxKTsKICAgICAgICAgICAgZCA9IGRhY3NbaWREZWxlZ2F0ZV07CgogICAgICAgICAgICByZXF1aXJlKGFkZHJlc3MoZC50b2tlbikgIT0gMHgwKTsKCiAgICAgICAgICAgIGlmIChkLnRva2VuLmJhbGFuY2VPZih0b0FkZHIpID49IGFtb3VudCkgewogICAgICAgICAgICAgICAgZC50b2tlbi5kZXN0cm95VG9rZW5zKHRvQWRkciwgYW1vdW50KTsKICAgICAgICAgICAgICAgIERlc3Ryb3lUb2tlbnMoZnJvbU93bmVyLCB0b0FkZHIsIGFtb3VudCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgLy89PSBwdWJsaWMKCiAgICBmdW5jdGlvbiBhZGREYWMoCiAgICAgICAgc3RyaW5nIG5hbWUsCiAgICAgICAgc3RyaW5nIHVybCwKICAgICAgICB1aW50NjQgY29tbWl0VGltZSwKICAgICAgICBzdHJpbmcgdG9rZW5OYW1lLAogICAgICAgIHN0cmluZyB0b2tlblN5bWJvbAogICAgKSBwdWJsaWMKICAgIHsKICAgICAgICB1aW50NjQgaWREZWxlZ2F0ZSA9IGxpcXVpZFBsZWRnaW5nLmFkZERlbGVnYXRlKAogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICB1cmwsCiAgICAgICAgICAgIGNvbW1pdFRpbWUsCiAgICAgICAgICAgIElMaXF1aWRQbGVkZ2luZ1BsdWdpbih0aGlzKQogICAgICAgICk7CgogICAgICAgIE1pbmlNZVRva2VuRmFjdG9yeSB0b2tlbkZhY3RvcnkgPSBuZXcgTWluaU1lVG9rZW5GYWN0b3J5KCk7CiAgICAgICAgTWluaU1lVG9rZW4gdG9rZW4gPSBuZXcgTWluaU1lVG9rZW4odG9rZW5GYWN0b3J5LCAweDAsIDAsIHRva2VuTmFtZSwgMTgsIHRva2VuU3ltYm9sLCBmYWxzZSk7CgogICAgICAgIGRhY3NbaWREZWxlZ2F0ZV0gPSBEYWModG9rZW4sIG1zZy5zZW5kZXIpOwogICAgfQoKICAgIGZ1bmN0aW9uIGFkZERhYygKICAgICAgICBzdHJpbmcgbmFtZSwKICAgICAgICBzdHJpbmcgdXJsLAogICAgICAgIHVpbnQ2NCBjb21taXRUaW1lLAogICAgICAgIE1pbmlNZVRva2VuIHRva2VuCiAgICApIHB1YmxpYwogICAgewogICAgICAgIHVpbnQ2NCBpZERlbGVnYXRlID0gbGlxdWlkUGxlZGdpbmcuYWRkRGVsZWdhdGUoCiAgICAgICAgICBuYW1lLAogICAgICAgICAgdXJsLAogICAgICAgICAgY29tbWl0VGltZSwKICAgICAgICAgIElMaXF1aWRQbGVkZ2luZ1BsdWdpbih0aGlzKQogICAgICAgICk7CgogICAgICAgIGRhY3NbaWREZWxlZ2F0ZV0gPSBEYWModG9rZW4sIG1zZy5zZW5kZXIpOwogICAgfQoKICAgIGZ1bmN0aW9uIHRyYW5zZmVyKAogICAgICAgIHVpbnQ2NCBpZERlbGVnYXRlLAogICAgICAgIHVpbnQ2NCBpZFBsZWRnZSwKICAgICAgICB1aW50IGFtb3VudCwKICAgICAgICB1aW50NjQgaWRSZWNlaXZlcgogICAgKSBwdWJsaWMKICAgIHsKICAgICAgICBEYWMgc3RvcmFnZSBkID0gZGFjc1tpZERlbGVnYXRlXTsKICAgICAgICByZXF1aXJlKG1zZy5zZW5kZXIgPT0gZC5vd25lcik7CgogICAgICAgIGxpcXVpZFBsZWRnaW5nLnRyYW5zZmVyKAogICAgICAgICAgICBpZERlbGVnYXRlLAogICAgICAgICAgICBpZFBsZWRnZSwKICAgICAgICAgICAgYW1vdW50LAogICAgICAgICAgICBpZFJlY2VpdmVyCiAgICAgICAgKTsKICAgIH0KCiAgICBmdW5jdGlvbiBjaGFuZ2VPd25lcigKICAgICAgICB1aW50NjQgaWREZWxlZ2F0ZSwKICAgICAgICBhZGRyZXNzIG5ld093bmVyCiAgICApIHB1YmxpYwogICAgewogICAgICAgIERhYyBzdG9yYWdlIGQgPSBkYWNzW2lkRGVsZWdhdGVdOwogICAgICAgIHJlcXVpcmUobXNnLnNlbmRlciA9PSBkLm93bmVyKTsKICAgICAgICBkLm93bmVyID0gbmV3T3duZXI7CiAgICB9CgogICAgZnVuY3Rpb24gdXBkYXRlRGFjKAogICAgICAgIHVpbnQ2NCBpZERlbGVnYXRlLAogICAgICAgIHN0cmluZyBuZXdOYW1lLAogICAgICAgIHN0cmluZyBuZXdVcmwsCiAgICAgICAgdWludDY0IG5ld0NvbW1pdFRpbWUKICAgICkgcHVibGljCiAgICB7CiAgICAgICAgRGFjIHN0b3JhZ2UgZCA9IGRhY3NbaWREZWxlZ2F0ZV07CiAgICAgICAgcmVxdWlyZShtc2cuc2VuZGVyID09IGQub3duZXIpOwoKICAgICAgICBsaXF1aWRQbGVkZ2luZy51cGRhdGVEZWxlZ2F0ZSgKICAgICAgICAgICAgaWREZWxlZ2F0ZSwKICAgICAgICAgICAgYWRkcmVzcyh0aGlzKSwKICAgICAgICAgICAgbmV3TmFtZSwKICAgICAgICAgICAgbmV3VXJsLAogICAgICAgICAgICBuZXdDb21taXRUaW1lCiAgICAgICAgKTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXREYWModWludDY0IGlkRGVsZWdhdGUpIHB1YmxpYyB2aWV3IHJldHVybnMgKAogICAgICAgIE1pbmlNZVRva2VuIHRva2VuLAogICAgICAgIGFkZHJlc3Mgb3duZXIKICAgICkKICAgIHsKICAgICAgICBEYWMgc3RvcmFnZSBkID0gZGFjc1tpZERlbGVnYXRlXTsKICAgICAgICB0b2tlbiA9IGQudG9rZW47CiAgICAgICAgb3duZXIgPSBkLm93bmVyOwogICAgfQoKICAgIC8vLy8vLy8vLy8vLy8vLy8KICAgIC8vIFRva2VuQ29udHJvbGxlcgogICAgLy8vLy8vLy8vLy8vLy8vLwoKICAgIC8vLyBAbm90aWNlIENhbGxlZCB3aGVuIGBfb3duZXJgIHNlbmRzIGV0aGVyIHRvIHRoZSBNaW5pTWUgVG9rZW4gY29udHJhY3QKICAgIC8vLyBAcGFyYW0gX293bmVyIFRoZSBhZGRyZXNzIHRoYXQgc2VudCB0aGUgZXRoZXIgdG8gY3JlYXRlIHRva2VucwogICAgLy8vIEByZXR1cm4gVHJ1ZSBpZiB0aGUgZXRoZXIgaXMgYWNjZXB0ZWQsIGZhbHNlIGlmIGl0IHRocm93cwogICAgZnVuY3Rpb24gcHJveHlQYXltZW50KGFkZHJlc3MgX293bmVyKSBwdWJsaWMgcGF5YWJsZSByZXR1cm5zKGJvb2wpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgLy8vIEBub3RpY2UgTm90aWZpZXMgdGhlIGNvbnRyb2xsZXIgYWJvdXQgYSB0b2tlbiB0cmFuc2ZlciBhbGxvd2luZyB0aGUKICAgIC8vLyAgY29udHJvbGxlciB0byByZWFjdCBpZiBkZXNpcmVkCiAgICAvLy8gQHBhcmFtIF9mcm9tIFRoZSBvcmlnaW4gb2YgdGhlIHRyYW5zZmVyCiAgICAvLy8gQHBhcmFtIF90byBUaGUgZGVzdGluYXRpb24gb2YgdGhlIHRyYW5zZmVyCiAgICAvLy8gQHBhcmFtIF9hbW91bnQgVGhlIGFtb3VudCBvZiB0aGUgdHJhbnNmZXIKICAgIC8vLyBAcmV0dXJuIEZhbHNlIGlmIHRoZSBjb250cm9sbGVyIGRvZXMgbm90IGF1dGhvcml6ZSB0aGUgdHJhbnNmZXIKICAgIGZ1bmN0aW9uIG9uVHJhbnNmZXIoYWRkcmVzcyBfZnJvbSwgYWRkcmVzcyBfdG8sIHVpbnQgX2Ftb3VudCkgcHVibGljIHJldHVybnMoYm9vbCkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICAvLy8gQG5vdGljZSBOb3RpZmllcyB0aGUgY29udHJvbGxlciBhYm91dCBhbiBhcHByb3ZhbCBhbGxvd2luZyB0aGUKICAgIC8vLyAgY29udHJvbGxlciB0byByZWFjdCBpZiBkZXNpcmVkCiAgICAvLy8gQHBhcmFtIF9vd25lciBUaGUgYWRkcmVzcyB0aGF0IGNhbGxzIGBhcHByb3ZlKClgCiAgICAvLy8gQHBhcmFtIF9zcGVuZGVyIFRoZSBzcGVuZGVyIGluIHRoZSBgYXBwcm92ZSgpYCBjYWxsCiAgICAvLy8gQHBhcmFtIF9hbW91bnQgVGhlIGFtb3VudCBpbiB0aGUgYGFwcHJvdmUoKWAgY2FsbAogICAgLy8vIEByZXR1cm4gRmFsc2UgaWYgdGhlIGNvbnRyb2xsZXIgZG9lcyBub3QgYXV0aG9yaXplIHRoZSBhcHByb3ZhbAogICAgZnVuY3Rpb24gb25BcHByb3ZlKGFkZHJlc3MgX293bmVyLCBhZGRyZXNzIF9zcGVuZGVyLCB1aW50IF9hbW91bnQpIHB1YmxpYyByZXR1cm5zKGJvb2wpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9Cn0='.
	

]
