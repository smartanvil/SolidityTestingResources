Class {
	#name : #SRT22B8Ff10f4149D7Ba100f61F2630c528E0AE8f98,
	#superclass : #SRTContracts,
	#category : #SolidityTestingResources
}

{ #category : #base64 }
SRT22B8Ff10f4149D7Ba100f61F2630c528E0AE8f98 >> base64 [
	^ 'cHJhZ21hIHNvbGlkaXR5IF4wLjQuMTk7CgoKLyoqCiAqIEB0aXRsZSBPd25hYmxlCiAqIEBkZXYgVGhlIE93bmFibGUgY29udHJhY3QgaGFzIGFuIG93bmVyIGFkZHJlc3MsIGFuZCBwcm92aWRlcyBiYXNpYyBhdXRob3JpemF0aW9uIGNvbnRyb2wKICogZnVuY3Rpb25zLCB0aGlzIHNpbXBsaWZpZXMgdGhlIGltcGxlbWVudGF0aW9uIG9mICJ1c2VyIHBlcm1pc3Npb25zIi4KICovCmNvbnRyYWN0IE93bmFibGUgewogIGFkZHJlc3MgcHVibGljIG93bmVyOwoKCiAgZXZlbnQgT3duZXJzaGlwVHJhbnNmZXJyZWQoYWRkcmVzcyBpbmRleGVkIHByZXZpb3VzT3duZXIsIGFkZHJlc3MgaW5kZXhlZCBuZXdPd25lcik7CgoKICAvKioKICAgKiBAZGV2IFRoZSBPd25hYmxlIGNvbnN0cnVjdG9yIHNldHMgdGhlIG9yaWdpbmFsIGBvd25lcmAgb2YgdGhlIGNvbnRyYWN0IHRvIHRoZSBzZW5kZXIKICAgKiBhY2NvdW50LgogICAqLwogIGZ1bmN0aW9uIE93bmFibGUoKSBwdWJsaWMgewogICAgb3duZXIgPSBtc2cuc2VuZGVyOwogIH0KCiAgLyoqCiAgICogQGRldiBUaHJvd3MgaWYgY2FsbGVkIGJ5IGFueSBhY2NvdW50IG90aGVyIHRoYW4gdGhlIG93bmVyLgogICAqLwogIG1vZGlmaWVyIG9ubHlPd25lcigpIHsKICAgIHJlcXVpcmUobXNnLnNlbmRlciA9PSBvd25lcik7CiAgICBfOwogIH0KCiAgLyoqCiAgICogQGRldiBBbGxvd3MgdGhlIGN1cnJlbnQgb3duZXIgdG8gdHJhbnNmZXIgY29udHJvbCBvZiB0aGUgY29udHJhY3QgdG8gYSBuZXdPd25lci4KICAgKiBAcGFyYW0gbmV3T3duZXIgVGhlIGFkZHJlc3MgdG8gdHJhbnNmZXIgb3duZXJzaGlwIHRvLgogICAqLwogIGZ1bmN0aW9uIHRyYW5zZmVyT3duZXJzaGlwKGFkZHJlc3MgbmV3T3duZXIpIHB1YmxpYyBvbmx5T3duZXIgewogICAgcmVxdWlyZShuZXdPd25lciAhPSBhZGRyZXNzKDApKTsKICAgIE93bmVyc2hpcFRyYW5zZmVycmVkKG93bmVyLCBuZXdPd25lcik7CiAgICBvd25lciA9IG5ld093bmVyOwogIH0KCn0KCmNvbnRyYWN0IEpvdWxlQVBJIHsKICAgIGV2ZW50IEludm9rZWQoYWRkcmVzcyBpbmRleGVkIF9pbnZva2VyLCBhZGRyZXNzIGluZGV4ZWQgX2FkZHJlc3MsIGJvb2wgX3N0YXR1cywgdWludCBfdXNlZEdhcyk7CiAgICBldmVudCBSZWdpc3RlcmVkKGFkZHJlc3MgaW5kZXhlZCBfcmVnaXN0cmFudCwgYWRkcmVzcyBpbmRleGVkIF9hZGRyZXNzLCB1aW50IF90aW1lc3RhbXAsIHVpbnQgX2dhc0xpbWl0LCB1aW50IF9nYXNQcmljZSk7CiAgICBldmVudCBVbnJlZ2lzdGVyZWQoYWRkcmVzcyBpbmRleGVkIF9yZWdpc3RyYW50LCBhZGRyZXNzIGluZGV4ZWQgX2FkZHJlc3MsIHVpbnQgX3RpbWVzdGFtcCwgdWludCBfZ2FzTGltaXQsIHVpbnQgX2dhc1ByaWNlLCB1aW50IF9hbW91bnQpOwoKICAgIC8qKgogICAgICogQGRldiBSZWdpc3RlcnMgdGhlIHNwZWNpZmllZCBjb250cmFjdCB0byBpbnZva2UgYXQgdGhlIHNwZWNpZmllZCB0aW1lIHdpdGggdGhlIHNwZWNpZmllZCBnYXMgYW5kIHByaWNlLgogICAgICogQG5vdGljZSBSZWdpc3RyYXRpb24gcmVxdWlyZXMgdGhlIHNwZWNpZmllZCBhbW91bnQgb2YgRVRIIGluIHZhbHVlLCB0byBjb3ZlciBpbnZva2UgYm9udXMuIFNlZSBnZXRQcmljZSBtZXRob2QuCiAgICAgKgogICAgICogQHBhcmFtIF9hZGRyZXNzICAgICAgQ29udHJhY3QncyBhZGRyZXNzLiBDb250cmFjdCBNVVNUIGltcGxlbWVudHMgQ2hlY2thYmxlIGludGVyZmFjZS4KICAgICAqIEBwYXJhbSBfdGltZXN0YW1wICAgIFRpbWVzdGFtcCBhdCB3aGF0IG1vbWVudCBjb250cmFjdCBzaG91bGQgYmUgY2FsbGVkLiBJdCBNVVNUIGJlIGluIGZ1dHVyZS4KICAgICAqIEBwYXJhbSBfZ2FzTGltaXQgICAgIEdhcyB3aGljaCB3aWxsIGJlIHBvc3RlZCB0byBjYWxsLgogICAgICogQHBhcmFtIF9nYXNQcmljZSAgICAgR2FzIHByaWNlIHdoaWNoIGlzIHJlY29tbWVuZGVkIHRvIHVzZSBmb3IgdGhpcyBpbnZvY2F0aW9uLgogICAgICogQHJldHVybiBBbW91bnQgb2YgY2hhbmdlLgogICAgICovCiAgICBmdW5jdGlvbiByZWdpc3RlcihhZGRyZXNzIF9hZGRyZXNzLCB1aW50IF90aW1lc3RhbXAsIHVpbnQgX2dhc0xpbWl0LCB1aW50IF9nYXNQcmljZSkgZXh0ZXJuYWwgcGF5YWJsZSByZXR1cm5zICh1aW50KTsKCiAgICAvKioKICAgICAqIEBkZXYgUmVnaXN0ZXJzIHRoZSBzcGVjaWZpZWQgY29udHJhY3QgdG8gaW52b2tlIGF0IHRoZSBzcGVjaWZpZWQgdGltZSB3aXRoIHRoZSBzcGVjaWZpZWQgZ2FzIGFuZCBwcmljZS4KICAgICAqIEBub3RpY2UgUmVnaXN0cmF0aW9uIHJlcXVpcmVzIHRoZSBzcGVjaWZpZWQgYW1vdW50IG9mIEVUSCBpbiB2YWx1ZSwgdG8gY292ZXIgaW52b2tlIGJvbnVzLiBTZWUgZ2V0UHJpY2UgbWV0aG9kLgogICAgICogQG5vdGljZSBJZiB2YWx1ZSB3b3VsZCBiZSBtb3JlIHRoZW4gcmVxdWlyZWQgKHNlZSBnZXRQcmljZSkgY2hhbmdlIHdpbGwgYmUgcmV0dXJuZWQgdG8gbXNnLnNlbmRlciAobm90IHRvIF9yZWdpc3RyYW50ISkuCiAgICAgKgogICAgICogQHBhcmFtIF9yZWdpc3RyYW50ICAgQW55IGFkZHJlc3Mgd2hpY2ggd2lsbCBiZSBvd25lcnMgZm9yIHRoaXMgcmVnaXN0cmF0aW9uLiBPbmx5IGhlIGNhbiB1bnJlZ2lzdGVyLiBVc2VmdWwgZm9yIGNhbGxpbmcgZnJvbSBjb250cmFjdC4KICAgICAqIEBwYXJhbSBfYWRkcmVzcyAgICAgIENvbnRyYWN0J3MgYWRkcmVzcy4gQ29udHJhY3QgTVVTVCBpbXBsZW1lbnRzIENoZWNrYWJsZSBpbnRlcmZhY2UuCiAgICAgKiBAcGFyYW0gX3RpbWVzdGFtcCAgICBUaW1lc3RhbXAgYXQgd2hhdCBtb21lbnQgY29udHJhY3Qgc2hvdWxkIGJlIGNhbGxlZC4gSXQgTVVTVCBiZSBpbiBmdXR1cmUuCiAgICAgKiBAcGFyYW0gX2dhc0xpbWl0ICAgICBHYXMgd2hpY2ggd2lsbCBiZSBwb3N0ZWQgdG8gY2FsbC4KICAgICAqIEBwYXJhbSBfZ2FzUHJpY2UgICAgIEdhcyBwcmljZSB3aGljaCBpcyByZWNvbW1lbmRlZCB0byB1c2UgZm9yIHRoaXMgaW52b2NhdGlvbi4KICAgICAqIEByZXR1cm4gQW1vdW50IG9mIGNoYW5nZS4KICAgICAqLwogICAgZnVuY3Rpb24gcmVnaXN0ZXJGb3IoYWRkcmVzcyBfcmVnaXN0cmFudCwgYWRkcmVzcyBfYWRkcmVzcywgdWludCBfdGltZXN0YW1wLCB1aW50IF9nYXNMaW1pdCwgdWludCBfZ2FzUHJpY2UpIHB1YmxpYyBwYXlhYmxlIHJldHVybnMgKHVpbnQpOwoKICAgIC8qKgogICAgICogQGRldiBSZW1vdmUgcmVnaXN0cmF0aW9uIG9mIHRoZSBzcGVjaWZpZWQgY29udHJhY3QgKHdpdGggZXhhY3QgcGFyYW1ldGVycykgYnkgdGhlIHNwZWNpZmllZCBrZXkuIFNlZSBmaW5kS2V5IG1ldGhvZCBmb3IgbG9va2luZyBmb3Iga2V5LgogICAgICogQG5vdGljZSBJdCByZXR1cm5zIG5vdCBmdWxsIGFtb3VudCBvZiBFVEguCiAgICAgKiBAbm90aWNlIE9ubHkgcmVnaXN0cmFudCBjYW4gcmVtb3ZlIHRoZWlyIHJlZ2lzdHJhdGlvbi4KICAgICAqIEBub3RpY2UgT25seSByZWdpc3RyYXRpb25zIGluIGZ1dHVyZSBjYW4gYmUgcmVtb3ZlZC4KICAgICAqCiAgICAgKiBAcGFyYW0gX2tleSAgICAgICAgICBDb250cmFjdCBrZXksIHRvIGZhc3QgZmluZGluZyBkdXJpbmcgdW5yZWdpc3Rlci4gU2VlIGZpbmRLZXkgbWV0aG9kIGZvciBnZXR0aW5nIGtleS4KICAgICAqIEBwYXJhbSBfYWRkcmVzcyAgICAgIENvbnRyYWN0J3MgYWRkcmVzcy4gQ29udHJhY3QgTVVTVCBpbXBsZW1lbnRzIENoZWNrYWJsZSBpbnRlcmZhY2UuCiAgICAgKiBAcGFyYW0gX3RpbWVzdGFtcCAgICBUaW1lc3RhbXAgYXQgd2hhdCBtb21lbnQgY29udHJhY3Qgc2hvdWxkIGJlIGNhbGxlZC4gSXQgTVVTVCBiZSBpbiBmdXR1cmUuCiAgICAgKiBAcGFyYW0gX2dhc0xpbWl0ICAgICBHYXMgd2hpY2ggd2lsbCBiZSBwb3N0ZWQgdG8gY2FsbC4KICAgICAqIEBwYXJhbSBfZ2FzUHJpY2UgICAgIEdhcyBwcmljZSB3aGljaCBpcyByZWNvbW1lbmRlZCB0byB1c2UgZm9yIHRoaXMgaW52b2NhdGlvbi4KICAgICAqIEByZXR1cm4gQW1vdW50IG9mIHJlZnVuZC4KICAgICAqLwogICAgZnVuY3Rpb24gdW5yZWdpc3RlcihieXRlczMyIF9rZXksIGFkZHJlc3MgX2FkZHJlc3MsIHVpbnQgX3RpbWVzdGFtcCwgdWludCBfZ2FzTGltaXQsIHVpbnQgX2dhc1ByaWNlKSBleHRlcm5hbCByZXR1cm5zICh1aW50KTsKCiAgICAvKioKICAgICAqIEBkZXYgSW52b2tlcyBuZXh0IGNvbnRyYWN0cyBpbiB0aGUgcXVldWUuCiAgICAgKiBAbm90aWNlIEV0aCBhbW91bnQgdG8gY292ZXIgZ2FzIHdpbGwgYmUgcmV0dXJuZWQgaWYgZ2FzIHByaWNlIGlzIGVxdWFsIG9yIGxlc3MgdGhlbiBzcGVjaWZpZWQgZm9yIGNvbnRyYWN0LiBDaGVjayBnZXRUb3AgZm9yIHJpZ2h0IGdhcyBwcmljZS4KICAgICAqIEByZXR1cm4gUmV3YXJkIGFtb3VudC4KICAgICAqLwogICAgZnVuY3Rpb24gaW52b2tlKCkgcHVibGljIHJldHVybnMgKHVpbnQpOwoKICAgIC8qKgogICAgICogQGRldiBJbnZva2VzIG5leHQgY29udHJhY3RzIGluIHRoZSBxdWV1ZS4KICAgICAqIEBub3RpY2UgRXRoIGFtb3VudCB0byBjb3ZlciBnYXMgd2lsbCBiZSByZXR1cm5lZCBpZiBnYXMgcHJpY2UgaXMgZXF1YWwgb3IgbGVzcyB0aGVuIHNwZWNpZmllZCBmb3IgY29udHJhY3QuIENoZWNrIGdldFRvcCBmb3IgcmlnaHQgZ2FzIHByaWNlLgogICAgICogQHBhcmFtIF9pbnZva2VyIEFueSBhZGRyZXNzIGZyb20gd2hpY2ggZXZlbnQgd2lsbCBiZSB0aHJldy4gVXNlZnVsIGZvciBjYWxsaW5nIGZyb20gY29udHJhY3QuCiAgICAgKiBAcmV0dXJuIFJld2FyZCBhbW91bnQuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGludm9rZUZvcihhZGRyZXNzIF9pbnZva2VyKSBwdWJsaWMgcmV0dXJucyAodWludCk7CgogICAgLyoqCiAgICAgKiBAZGV2IEludm9rZXMgdGhlIHRvcCBjb250cmFjdCBpbiB0aGUgcXVldWUuCiAgICAgKiBAbm90aWNlIEV0aCBhbW91bnQgdG8gY292ZXIgZ2FzIHdpbGwgYmUgcmV0dXJuZWQgaWYgZ2FzIHByaWNlIGlzIGVxdWFsIG9yIGxlc3MgdGhlbiBzcGVjaWZpZWQgZm9yIGNvbnRyYWN0LiBDaGVjayBnZXRUb3AgZm9yIHJpZ2h0IGdhcyBwcmljZS4KICAgICAqIEByZXR1cm4gUmV3YXJkIGFtb3VudC4KICAgICAqLwogICAgZnVuY3Rpb24gaW52b2tlT25jZSgpIHB1YmxpYyByZXR1cm5zICh1aW50KTsKCiAgICAvKioKICAgICAqIEBkZXYgSW52b2tlcyB0aGUgdG9wIGNvbnRyYWN0IGluIHRoZSBxdWV1ZS4KICAgICAqIEBub3RpY2UgRXRoIGFtb3VudCB0byBjb3ZlciBnYXMgd2lsbCBiZSByZXR1cm5lZCBpZiBnYXMgcHJpY2UgaXMgZXF1YWwgb3IgbGVzcyB0aGVuIHNwZWNpZmllZCBmb3IgY29udHJhY3QuIENoZWNrIGdldFRvcCBmb3IgcmlnaHQgZ2FzIHByaWNlLgogICAgICogQHBhcmFtIF9pbnZva2VyIEFueSBhZGRyZXNzIGZyb20gd2hpY2ggZXZlbnQgd2lsbCBiZSB0aHJldy4gVXNlZnVsIGZvciBjYWxsaW5nIGZyb20gY29udHJhY3QuCiAgICAgKiBAcmV0dXJuIFJld2FyZCBhbW91bnQuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGludm9rZU9uY2VGb3IoYWRkcmVzcyBfaW52b2tlcikgcHVibGljIHJldHVybnMgKHVpbnQpOwoKICAgIC8qKgogICAgICogQGRldiBDYWxjdWxhdGVzIHJlcXVpcmVkIHRvIHJlZ2lzdGVyIGFtb3VudCBvZiBXRUkuCiAgICAgKgogICAgICogQHBhcmFtIF9nYXNMaW1pdCBHYXMgd2hpY2ggd2lsbCBiZSBwb3N0ZWQgdG8gY2FsbC4KICAgICAqIEBwYXJhbSBfZ2FzUHJpY2UgR2FzIHByaWNlIHdoaWNoIGlzIHJlY29tbWVuZGVkIHRvIHVzZSBmb3IgdGhpcyBpbnZvY2F0aW9uLgogICAgICogQHJldHVybiBBbW91bnQgaW4gd2VpLgogICAgICovCiAgICBmdW5jdGlvbiBnZXRQcmljZSh1aW50IF9nYXNMaW1pdCwgdWludCBfZ2FzUHJpY2UpIGV4dGVybmFsIHZpZXcgcmV0dXJucyAodWludCk7CgogICAgLyoqCiAgICAgKiBAZGV2IEdldHMgaG93IG1hbnkgY29udHJhY3RzIGFyZSByZWdpc3RlcmVkIChhbmQgbm90IGludm9rZWQpLgogICAgICovCiAgICBmdW5jdGlvbiBnZXRDb3VudCgpIHB1YmxpYyB2aWV3IHJldHVybnMgKHVpbnQpOwoKICAgIC8qKgogICAgICogQGRldiBHZXRzIHRvcCBjb250cmFjdCAodGhlIG5leHQgdG8gaW52b2tlKS4KICAgICAqCiAgICAgKiBAcmV0dXJuIGNvbnRyYWN0QWRkcmVzcyAgVGhlIGNvbnRyYWN0IGFkZHJlc3MuCiAgICAgKiBAcmV0dXJuIHRpbWVzdGFtcCAgICAgICAgVGhlIGludm9jYXRpb24gdGltZXN0YW1wLgogICAgICogQHJldHVybiBnYXNMaW1pdCAgICAgICAgIFRoZSBjb250cmFjdCBnYXMuCiAgICAgKiBAcmV0dXJuIGdhc1ByaWNlICAgICAgICAgVGhlIGludm9jYXRpb24gZXhwZWN0ZWQgcHJpY2UuCiAgICAgKiBAcmV0dXJuIGludm9rZUdhcyAgICAgICAgVGhlIG1pbmltYWwgYW1vdW50IG9mIGdhcyB0byBpbnZva2UgKGluY2x1ZGluZyBnYXMgZm9yIGpvdWxlKS4KICAgICAqIEByZXR1cm4gcmV3YXJkQW1vdW50ICAgICBUaGUgYW1vdW50IG9mIHJld2FyZCBmb3IgaW52b2NhdGlvbi4KICAgICAqLwogICAgZnVuY3Rpb24gZ2V0VG9wT25jZSgpIGV4dGVybmFsIHZpZXcgcmV0dXJucyAoCiAgICAgICAgYWRkcmVzcyBjb250cmFjdEFkZHJlc3MsCiAgICAgICAgdWludCB0aW1lc3RhbXAsCiAgICAgICAgdWludCBnYXNMaW1pdCwKICAgICAgICB1aW50IGdhc1ByaWNlLAogICAgICAgIHVpbnQgaW52b2tlR2FzLAogICAgICAgIHVpbnQgcmV3YXJkQW1vdW50CiAgICApOwoKICAgIC8qKgogICAgICogQGRldiBHZXRzIG9uZSBuZXh0IGNvbnRyYWN0IGJ5IHRoZSBzcGVjaWZpZWQgcHJldmlvdXMgaW4gb3JkZXIgdG8gaW52b2tlLgogICAgICoKICAgICAqIEBwYXJhbSBfY29udHJhY3RBZGRyZXNzICBUaGUgcHJldmlvdXMgY29udHJhY3QgYWRkcmVzcy4KICAgICAqIEBwYXJhbSBfdGltZXN0YW1wICAgICAgICBUaGUgcHJldmlvdXMgaW52b2NhdGlvbiB0aW1lc3RhbXAuCiAgICAgKiBAcGFyYW0gX2dhc0xpbWl0ICAgICAgICAgVGhlIHByZXZpb3VzIGludm9jYXRpb24gbWF4aW11bSBnYXMuCiAgICAgKiBAcGFyYW0gX2dhc1ByaWNlICAgICAgICAgVGhlIHByZXZpb3VzIGludm9jYXRpb24gZXhwZWN0ZWQgcHJpY2UuCiAgICAgKiBAcmV0dXJuIGNvbnRyYWN0QWRkcmVzcyAgVGhlIGNvbnRyYWN0IGFkZHJlc3MuCiAgICAgKiBAcmV0dXJuIGdhc0xpbWl0ICAgICAgICAgVGhlIGNvbnRyYWN0IGdhcy4KICAgICAqIEByZXR1cm4gZ2FzUHJpY2UgICAgICAgICBUaGUgaW52b2NhdGlvbiBleHBlY3RlZCBwcmljZS4KICAgICAqIEByZXR1cm4gaW52b2tlR2FzICAgICAgICBUaGUgbWluaW1hbCBhbW91bnQgb2YgZ2FzIHRvIGludm9rZSAoaW5jbHVkaW5nIGdhcyBmb3Igam91bGUpLgogICAgICogQHJldHVybiByZXdhcmRBbW91bnQgICAgIFRoZSBhbW91bnQgb2YgcmV3YXJkIGZvciBpbnZvY2F0aW9uLgogICAgICovCiAgICBmdW5jdGlvbiBnZXROZXh0T25jZShhZGRyZXNzIF9jb250cmFjdEFkZHJlc3MsCiAgICAgICAgICAgICAgICAgICAgIHVpbnQgX3RpbWVzdGFtcCwKICAgICAgICAgICAgICAgICAgICAgdWludCBfZ2FzTGltaXQsCiAgICAgICAgICAgICAgICAgICAgIHVpbnQgX2dhc1ByaWNlKSBwdWJsaWMgdmlldyByZXR1cm5zICgKICAgICAgICBhZGRyZXNzIGNvbnRyYWN0QWRkcmVzcywKICAgICAgICB1aW50IHRpbWVzdGFtcCwKICAgICAgICB1aW50IGdhc0xpbWl0LAogICAgICAgIHVpbnQgZ2FzUHJpY2UsCiAgICAgICAgdWludCBpbnZva2VHYXMsCiAgICAgICAgdWludCByZXdhcmRBbW91bnQKICAgICk7CgogICAgLyoqCiAgICAgKiBAZGV2IEdldHMgX2NvdW50IG5leHQgY29udHJhY3RzIGJ5IHRoZSBzcGVjaWZpZWQgcHJldmlvdXMgaW4gb3JkZXIgdG8gaW52b2tlLgogICAgICogQG5vdGljZSBVbmxpa2UgZ2V0VG9wIHRoaXMgbWV0aG9kIHJldHVybiBleGFjdCBfY291bnQgdmFsdWVzLgogICAgICoKICAgICAqIEBwYXJhbSBfY291bnQgICAgICAgICAgICBUaGUgY291bnQgb2YgcmVzdWx0IGNvbnRyYWN0cy4KICAgICAqIEBwYXJhbSBfY29udHJhY3RBZGRyZXNzICBUaGUgcHJldmlvdXMgY29udHJhY3QgYWRkcmVzcy4KICAgICAqIEBwYXJhbSBfdGltZXN0YW1wICAgICAgICBUaGUgcHJldmlvdXMgaW52b2NhdGlvbiB0aW1lc3RhbXAuCiAgICAgKiBAcGFyYW0gX2dhc0xpbWl0ICAgICAgICAgVGhlIHByZXZpb3VzIGludm9jYXRpb24gbWF4aW11bSBnYXMuCiAgICAgKiBAcGFyYW0gX2dhc1ByaWNlICAgICAgICAgVGhlIHByZXZpb3VzIGludm9jYXRpb24gZXhwZWN0ZWQgcHJpY2UuCiAgICAgKiBAcmV0dXJuIGNvbnRyYWN0QWRkcmVzcyAgVGhlIGNvbnRyYWN0IGFkZHJlc3MuCiAgICAgKiBAcmV0dXJuIGdhc0xpbWl0ICAgICAgICAgVGhlIGNvbnRyYWN0IGdhcy4KICAgICAqIEByZXR1cm4gZ2FzUHJpY2UgICAgICAgICBUaGUgaW52b2NhdGlvbiBleHBlY3RlZCBwcmljZS4KICAgICAqIEByZXR1cm4gaW52b2tlR2FzICAgICAgICBUaGUgbWluaW1hbCBhbW91bnQgb2YgZ2FzIHRvIGludm9rZSAoaW5jbHVkaW5nIGdhcyBmb3Igam91bGUpLgogICAgICogQHJldHVybiByZXdhcmRBbW91bnQgICAgIFRoZSBhbW91bnQgb2YgcmV3YXJkIGZvciBpbnZvY2F0aW9uLgogICAgICovCiAgICBmdW5jdGlvbiBnZXROZXh0KHVpbnQgX2NvdW50LAogICAgICAgICAgICAgICAgYWRkcmVzcyBfY29udHJhY3RBZGRyZXNzLAogICAgICAgICAgICAgICAgdWludCBfdGltZXN0YW1wLAogICAgICAgICAgICAgICAgdWludCBfZ2FzTGltaXQsCiAgICAgICAgICAgICAgICB1aW50IF9nYXNQcmljZSkgZXh0ZXJuYWwgdmlldyByZXR1cm5zICgKICAgICAgICBhZGRyZXNzW10gYWRkcmVzc2VzLAogICAgICAgIHVpbnRbXSB0aW1lc3RhbXBzLAogICAgICAgIHVpbnRbXSBnYXNMaW1pdHMsCiAgICAgICAgdWludFtdIGdhc1ByaWNlcywKICAgICAgICB1aW50W10gaW52b2tlR2FzZXMsCiAgICAgICAgdWludFtdIHJld2FyZEFtb3VudHMKICAgICk7CgogICAgLyoqCiAgICAgKiBAZGV2IEdldHMgdG9wIF9jb3VudCBjb250cmFjdHMgKGluIG9yZGVyIHRvIGludm9rZSkuCiAgICAgKgogICAgICogQHBhcmFtIF9jb3VudCAgICAgICAgICAgIEhvdyBtYW55IHJlY29yZHMgd2lsbCBiZSByZXR1cm5lZC4KICAgICAqIEByZXR1cm4gYWRkcmVzc2VzICAgICAgICBUaGUgY29udHJhY3RzIGFkZHJlc3Nlcy4KICAgICAqIEByZXR1cm4gdGltZXN0YW1wcyAgICAgICBUaGUgaW52b2NhdGlvbiB0aW1lc3RhbXBzLgogICAgICogQHJldHVybiBnYXNMaW1pdHMgICAgICAgIFRoZSBjb250cmFjdCBnYXMuCiAgICAgKiBAcmV0dXJuIGdhc1ByaWNlcyAgICAgICAgVGhlIGludm9jYXRpb24gZXhwZWN0ZWQgcHJpY2UuCiAgICAgKiBAcmV0dXJuIGludm9rZUdhc2VzICAgICAgVGhlIG1pbmltYWwgYW1vdW50IG9mIGdhcyB0byBpbnZva2UgKGluY2x1ZGluZyBnYXMgZm9yIGpvdWxlKS4KICAgICAqIEByZXR1cm4gcmV3YXJkQW1vdW50cyAgICBUaGUgYW1vdW50IG9mIHJld2FyZCBmb3IgaW52b2NhdGlvbi4KICAgICAqLwogICAgZnVuY3Rpb24gZ2V0VG9wKHVpbnQgX2NvdW50KSBleHRlcm5hbCB2aWV3IHJldHVybnMgKAogICAgICAgIGFkZHJlc3NbXSBhZGRyZXNzZXMsCiAgICAgICAgdWludFtdIHRpbWVzdGFtcHMsCiAgICAgICAgdWludFtdIGdhc0xpbWl0cywKICAgICAgICB1aW50W10gZ2FzUHJpY2VzLAogICAgICAgIHVpbnRbXSBpbnZva2VHYXNlcywKICAgICAgICB1aW50W10gcmV3YXJkQW1vdW50cwogICAgKTsKCiAgICAvKioKICAgICAqIEBkZXYgRmluZHMga2V5IGZvciB0aGUgcmVnaXN0cmF0aW9uIHdpdGggZXhhY3QgcGFyYW1ldGVycy4gQmUgY2FyZWZ1bCwga2V5IG1pZ2h0IGJlIGNoYW5nZWQgYmVjYXVzZSBvZiBvdGhlciByZWdpc3RyYXRpb25zLgogICAgICogQHBhcmFtIF9hZGRyZXNzICAgICAgQ29udHJhY3QncyBhZGRyZXNzLiBDb250cmFjdCBNVVNUIGltcGxlbWVudHMgQ2hlY2thYmxlIGludGVyZmFjZS4KICAgICAqIEBwYXJhbSBfdGltZXN0YW1wICAgIFRpbWVzdGFtcCBhdCB3aGF0IG1vbWVudCBjb250cmFjdCBzaG91bGQgYmUgY2FsbGVkLiBJdCBNVVNUIGJlIGluIGZ1dHVyZS4KICAgICAqIEBwYXJhbSBfZ2FzTGltaXQgICAgIEdhcyB3aGljaCB3aWxsIGJlIHBvc3RlZCB0byBjYWxsLgogICAgICogQHBhcmFtIF9nYXNQcmljZSAgICAgR2FzIHByaWNlIHdoaWNoIGlzIHJlY29tbWVuZGVkIHRvIHVzZSBmb3IgdGhpcyBpbnZvY2F0aW9uLgogICAgICogQHJldHVybiBfa2V5ICAgICAgICAgS2V5IG9mIHRoZSBzcGVjaWZpZWQgcmVnaXN0cmF0aW9uLgogICAgICovCiAgICBmdW5jdGlvbiBmaW5kS2V5KGFkZHJlc3MgX2FkZHJlc3MsIHVpbnQgX3RpbWVzdGFtcCwgdWludCBfZ2FzTGltaXQsIHVpbnQgX2dhc1ByaWNlKSBwdWJsaWMgdmlldyByZXR1cm5zIChieXRlczMyKTsKCiAgICAvKioKICAgICAqIEBkZXYgR2V0cyBhY3R1YWwgY29kZSB2ZXJzaW9uLgogICAgICogQHJldHVybiBDb2RlIHZlcnNpb24uIE1hc2s6IDB4ZmYuMHhmZi4weGZmZmYtMHhmZmZmZmZmZiAobWFqb3IubWlub3IuYnVpbGQtaGFzaCkKICAgICAqLwogICAgZnVuY3Rpb24gZ2V0VmVyc2lvbigpIGV4dGVybmFsIHZpZXcgcmV0dXJucyAoYnl0ZXM4KTsKCiAgICAvKioKICAgICAqIEBkZXYgR2V0cyBtaW5pbWFsIGdhcyBwcmljZSwgc3BlY2lmaWVkIGJ5IG1haW50YWluZXIuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGdldE1pbkdhc1ByaWNlKCkgcHVibGljIHZpZXcgcmV0dXJucyAodWludCk7Cn0KCi8qKgogKiBAdGl0bGUgRVJDMjBCYXNpYwogKiBAZGV2IFNpbXBsZXIgdmVyc2lvbiBvZiBFUkMyMCBpbnRlcmZhY2UKICogQGRldiBzZWUgaHR0cHM6Ly9naXRodWIuY29tL2V0aGVyZXVtL0VJUHMvaXNzdWVzLzE3OQogKi8KY29udHJhY3QgRVJDMjBCYXNpYyB7CiAgdWludDI1NiBwdWJsaWMgdG90YWxTdXBwbHk7CiAgZnVuY3Rpb24gYmFsYW5jZU9mKGFkZHJlc3Mgd2hvKSBwdWJsaWMgY29uc3RhbnQgcmV0dXJucyAodWludDI1Nik7CiAgZnVuY3Rpb24gdHJhbnNmZXIoYWRkcmVzcyB0bywgdWludDI1NiB2YWx1ZSkgcHVibGljIHJldHVybnMgKGJvb2wpOwogIGV2ZW50IFRyYW5zZmVyKGFkZHJlc3MgaW5kZXhlZCBmcm9tLCBhZGRyZXNzIGluZGV4ZWQgdG8sIHVpbnQyNTYgdmFsdWUpOwp9CmNvbnRyYWN0IFRyYW5zZmVyVG9rZW4gaXMgT3duYWJsZSB7CiAgICBmdW5jdGlvbiB0cmFuc2ZlclRva2VuKEVSQzIwQmFzaWMgX3Rva2VuLCBhZGRyZXNzIF90bywgdWludCBfdmFsdWUpIHB1YmxpYyBvbmx5T3duZXIgewogICAgICAgIF90b2tlbi50cmFuc2ZlcihfdG8sIF92YWx1ZSk7CiAgICB9Cn0KY29udHJhY3QgSm91bGVQcm94eUFQSSB7CiAgICAvKioKICAgICAqIEZ1bmN0aW9uIGhhc2ggaXM6IDB4NzMwMjdmNmQKICAgICAqLwogICAgZnVuY3Rpb24gY2FsbGJhY2soYWRkcmVzcyBfaW52b2tlciwgYWRkcmVzcyBfYWRkcmVzcywgdWludCBfdGltZXN0YW1wLCB1aW50IF9nYXNMaW1pdCwgdWludCBfZ2FzUHJpY2UpIHB1YmxpYyByZXR1cm5zIChib29sKTsKfQpjb250cmFjdCBDaGVja2FibGVDb250cmFjdCB7CiAgICBldmVudCBDaGVja2VkKCk7CiAgICAvKgogICAgICogRnVuY3Rpb24gaGFzaCBpcyAweDkxOTg0MGFkLgogICAgICovCiAgICBmdW5jdGlvbiBjaGVjaygpIHB1YmxpYzsKfQoKY29udHJhY3QgdXNpbmdDb25zdHMgewogICAgdWludCBjb25zdGFudCBHV0VJID0gMC4wMDEgc3phYm87CgogICAgLy8gdGhpcyB2YWx1ZXMgaW5mbHVlbmNlIHRvIHRoZSByZXdhcmQgcHJpY2UhIGRvIG5vdCBjaGFuZ2UgZm9yIGFscmVhZHkgcmVnaXN0ZXJlZCBjb250cmFjdHMhCiAgICB1aW50IGNvbnN0YW50IFRSQU5TQUNUSU9OX0dBUyA9IDIyMDAwOwogICAgLy8gcmVtYWluaW5nIGdhcyAtIGFtb3VudCBvZiBnYXMgdG8gZmluaXNoIHRyYW5zYWN0aW9uIGFmdGVyIGludm9rZQogICAgdWludCBjb25zdGFudCBSRU1BSU5JTkdfR0FTID0gMzAwMDA7CiAgICAvLyBqb3VsZSBnYXMgLSBnYXMgdG8gam91bGUgKGluY2x1ZGluZyBwcm94eSBhbmQgb3RoZXJzKSBpbnZvY2F0aW9uLCBleGNsdWRpbmcgY29udHJhY3QgZ2FzCiAgICB1aW50IGNvbnN0YW50IEpPVUxFX0dBUyA9IFRSQU5TQUNUSU9OX0dBUyArIFJFTUFJTklOR19HQVMgKyA1MDAwOwoKICAgIC8vIG1pbmltYWwgZGVmYXVsdCBnYXMgcHJpY2UgKGJlY2F1c2Ugb2YgbmV0d29yayBsb2FkKQogICAgdWludDMyIGNvbnN0YW50IERFRkFVTFRfTUlOX0dBU19QUklDRV9HV0VJID0gMjA7CiAgICAvLyBtaW4gZ2FzIHByaWNlCiAgICB1aW50IGNvbnN0YW50IE1JTl9HQVNfUFJJQ0UgPSBHV0VJOwogICAgLy8gbWF4IGdhcyBwcmljZQogICAgdWludCBjb25zdGFudCBNQVhfR0FTX1BSSUNFID0gMHhmZmZmZmZmZiAqIEdXRUk7CiAgICAvLyBub3QsIGl0IG1pc3QgYmUgbGVzcyB0aGVuIDB4MDBmZmZmZmYsIGJlY2F1c2UgaGlnaCBieXRlcyBtaWdodCBiZSB1c2VkIGZvciBzdG9yaW5nIGZsYWdzCiAgICB1aW50IGNvbnN0YW50IE1BWF9HQVMgPSA0MDAwMDAwOwogICAgLy8gQ29kZSB2ZXJzaW9uCiAgICBieXRlczggY29uc3RhbnQgVkVSU0lPTiA9IDB4MDEwODAwMDAwMDAwMDAwMDsKICAgIC8vICAgICAgICAgICAgICAgICAgICAgICAgICBeXiAtIG1ham9yCiAgICAvLyAgICAgICAgICAgICAgICAgICAgICAgICAgICBeXiAtIG1pbm9yCiAgICAvLyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF5eXl4gLSBidWlsZAogICAgLy8gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXl5eXl5eXl4gLSBnaXQgaGFzaAp9CgoKbGlicmFyeSBLZXlzVXRpbHMgewogICAgLy8gU3VjaCBvcmRlciBpcyBpbXBvcnRhbnQgdG8gbG9hZCBmcm9tIHN0YXRlCiAgICBzdHJ1Y3QgT2JqZWN0IHsKICAgICAgICB1aW50MzIgZ2FzUHJpY2VHd2VpOwogICAgICAgIHVpbnQzMiBnYXNMaW1pdDsKICAgICAgICB1aW50MzIgdGltZXN0YW1wOwogICAgICAgIGFkZHJlc3MgY29udHJhY3RBZGRyZXNzOwogICAgfQoKICAgIGZ1bmN0aW9uIHRvS2V5KE9iamVjdCBfb2JqKSBpbnRlcm5hbCBwdXJlIHJldHVybnMgKGJ5dGVzMzIpIHsKICAgICAgICByZXR1cm4gdG9LZXkoX29iai5jb250cmFjdEFkZHJlc3MsIF9vYmoudGltZXN0YW1wLCBfb2JqLmdhc0xpbWl0LCBfb2JqLmdhc1ByaWNlR3dlaSk7CiAgICB9CgogICAgZnVuY3Rpb24gdG9LZXlGcm9tU3RvcmFnZShPYmplY3Qgc3RvcmFnZSBfb2JqKSBpbnRlcm5hbCB2aWV3IHJldHVybnMgKGJ5dGVzMzIgX2tleSkgewogICAgICAgIGFzc2VtYmx5IHsKICAgICAgICAgICAgX2tleSA6PSBzbG9hZChfb2JqX3Nsb3QpCiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIHRvS2V5KGFkZHJlc3MgX2FkZHJlc3MsIHVpbnQgX3RpbWVzdGFtcCwgdWludCBfZ2FzTGltaXQsIHVpbnQgX2dhc1ByaWNlKSBpbnRlcm5hbCBwdXJlIHJldHVybnMgKGJ5dGVzMzIgcmVzdWx0KSB7CiAgICAgICAgcmVzdWx0ID0gMHgwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwOwogICAgICAgIC8vICAgICAgICAgXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXiAtIGFkZHJlc3MgKDIwIGJ5dGVzKQogICAgICAgIC8vICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF5eXl5eXl5eIC0gdGltZXN0YW1wICg0IGJ5dGVzKQogICAgICAgIC8vICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXl5eXl5eXl4gLSBnYXMgbGltaXQgKDQgYnl0ZXMpCiAgICAgICAgLy8gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF5eXl5eXl5eIC0gZ2FzIHByaWNlICg0IGJ5dGVzKQogICAgICAgIGFzc2VtYmx5IHsKICAgICAgICAgICAgcmVzdWx0IDo9IG9yKHJlc3VsdCwgbXVsKF9hZGRyZXNzLCAweDEwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDApKQogICAgICAgICAgICByZXN1bHQgOj0gb3IocmVzdWx0LCBtdWwoYW5kKF90aW1lc3RhbXAsIDB4ZmZmZmZmZmYpLCAweDEwMDAwMDAwMDAwMDAwMDAwKSkKICAgICAgICAgICAgcmVzdWx0IDo9IG9yKHJlc3VsdCwgbXVsKGFuZChfZ2FzTGltaXQsIDB4ZmZmZmZmZmYpLCAweDEwMDAwMDAwMCkpCiAgICAgICAgICAgIHJlc3VsdCA6PSBvcihyZXN1bHQsIGFuZChfZ2FzUHJpY2UsIDB4ZmZmZmZmZmYpKQogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiB0b01lbW9yeU9iamVjdChieXRlczMyIF9rZXksIE9iamVjdCBtZW1vcnkgX2Rlc3QpIGludGVybmFsIHB1cmUgewogICAgICAgIGFzc2VtYmx5IHsKICAgICAgICAgICAgbXN0b3JlKF9kZXN0LCBhbmQoX2tleSwgMHhmZmZmZmZmZikpCiAgICAgICAgICAgIG1zdG9yZShhZGQoX2Rlc3QsIDB4MjApLCBhbmQoZGl2KF9rZXksIDB4MTAwMDAwMDAwKSwgMHhmZmZmZmZmZikpCiAgICAgICAgICAgIG1zdG9yZShhZGQoX2Rlc3QsIDB4NDApLCBhbmQoZGl2KF9rZXksIDB4MTAwMDAwMDAwMDAwMDAwMDApLCAweGZmZmZmZmZmKSkKICAgICAgICAgICAgbXN0b3JlKGFkZChfZGVzdCwgMHg2MCksIGRpdihfa2V5LCAweDEwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDApKQogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiB0b09iamVjdChieXRlczMyIF9rZXkpIGludGVybmFsIHB1cmUgcmV0dXJucyAoT2JqZWN0IG1lbW9yeSBfZGVzdCkgewogICAgICAgIHRvTWVtb3J5T2JqZWN0KF9rZXksIF9kZXN0KTsKICAgIH0KCiAgICBmdW5jdGlvbiB0b1N0YXRlT2JqZWN0KGJ5dGVzMzIgX2tleSwgT2JqZWN0IHN0b3JhZ2UgX2Rlc3QpIGludGVybmFsIHsKICAgICAgICBhc3NlbWJseSB7CiAgICAgICAgICAgIHNzdG9yZShfZGVzdF9zbG90LCBfa2V5KQogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBnZXRUaW1lc3RhbXAoYnl0ZXMzMiBfa2V5KSBpbnRlcm5hbCBwdXJlIHJldHVybnMgKHVpbnQgcmVzdWx0KSB7CiAgICAgICAgYXNzZW1ibHkgewogICAgICAgICAgICByZXN1bHQgOj0gYW5kKGRpdihfa2V5LCAweDEwMDAwMDAwMDAwMDAwMDAwKSwgMHhmZmZmZmZmZikKICAgICAgICB9CiAgICB9Cn0KCmNvbnRyYWN0IFJlc3RyaWN0aW9uIHsKICAgIG1hcHBpbmcgKGFkZHJlc3MgPT4gYm9vbCkgaW50ZXJuYWwgYWNjZXNzZXM7CgogICAgZnVuY3Rpb24gUmVzdHJpY3Rpb24oKSBwdWJsaWMgewogICAgICAgIGFjY2Vzc2VzW21zZy5zZW5kZXJdID0gdHJ1ZTsKICAgIH0KCiAgICBmdW5jdGlvbiBnaXZlQWNjZXNzKGFkZHJlc3MgX2FkZHIpIHB1YmxpYyByZXN0cmljdGVkIHsKICAgICAgICBhY2Nlc3Nlc1tfYWRkcl0gPSB0cnVlOwogICAgfQoKICAgIGZ1bmN0aW9uIHJlbW92ZUFjY2VzcyhhZGRyZXNzIF9hZGRyKSBwdWJsaWMgcmVzdHJpY3RlZCB7CiAgICAgICAgZGVsZXRlIGFjY2Vzc2VzW19hZGRyXTsKICAgIH0KCiAgICBmdW5jdGlvbiBoYXNBY2Nlc3MoKSBwdWJsaWMgY29uc3RhbnQgcmV0dXJucyAoYm9vbCkgewogICAgICAgIHJldHVybiBhY2Nlc3Nlc1ttc2cuc2VuZGVyXTsKICAgIH0KCiAgICBtb2RpZmllciByZXN0cmljdGVkKCkgewogICAgICAgIHJlcXVpcmUoaGFzQWNjZXNzKCkpOwogICAgICAgIF87CiAgICB9Cn0KCmNvbnRyYWN0IEpvdWxlU3RvcmFnZSBpcyBSZXN0cmljdGlvbiB7CiAgICBtYXBwaW5nKGJ5dGVzMzIgPT4gYnl0ZXMzMikgbWFwOwoKICAgIGZ1bmN0aW9uIGdldChieXRlczMyIF9rZXkpIHB1YmxpYyB2aWV3IHJldHVybnMgKGJ5dGVzMzIgX3ZhbHVlKSB7CiAgICAgICAgcmV0dXJuIG1hcFtfa2V5XTsKICAgIH0KCiAgICBmdW5jdGlvbiBzZXQoYnl0ZXMzMiBfa2V5LCBieXRlczMyIF92YWx1ZSkgcHVibGljIHJlc3RyaWN0ZWQgewogICAgICAgIG1hcFtfa2V5XSA9IF92YWx1ZTsKICAgIH0KCiAgICBmdW5jdGlvbiBkZWwoYnl0ZXMzMiBfa2V5KSBwdWJsaWMgcmVzdHJpY3RlZCB7CiAgICAgICAgZGVsZXRlIG1hcFtfa2V5XTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRBbmREZWwoYnl0ZXMzMiBfa2V5KSBwdWJsaWMgcmVzdHJpY3RlZCByZXR1cm5zIChieXRlczMyIF92YWx1ZSkgewogICAgICAgIF92YWx1ZSA9IG1hcFtfa2V5XTsKICAgICAgICBkZWxldGUgbWFwW19rZXldOwogICAgfQoKICAgIGZ1bmN0aW9uIHN3YXAoYnl0ZXMzMiBfZnJvbSwgYnl0ZXMzMiBfdG8pIHB1YmxpYyByZXN0cmljdGVkIHJldHVybnMgKGJ5dGVzMzIgX3ZhbHVlKSB7CiAgICAgICAgX3ZhbHVlID0gbWFwW190b107CiAgICAgICAgbWFwW190b10gPSBtYXBbX2Zyb21dOwogICAgICAgIGRlbGV0ZSBtYXBbX2Zyb21dOwogICAgfQp9Cgpjb250cmFjdCBKb3VsZUluZGV4Q29yZSB7CiAgICB1c2luZyBLZXlzVXRpbHMgZm9yIGJ5dGVzMzI7CiAgICB1aW50IGNvbnN0YW50IFlFQVIgPSAweDFERkUyMDA7CiAgICBieXRlczMyIGNvbnN0YW50IEhFQUQgPSAweDA7CgogICAgLy8gWUVBUiAtPiB3ZWVrIC0+IGhvdXIgLT4gbWludXRlCiAgICBKb3VsZVN0b3JhZ2UgcHVibGljIHN0YXRlOwoKICAgIGZ1bmN0aW9uIEpvdWxlSW5kZXhDb3JlKEpvdWxlU3RvcmFnZSBfc3RvcmFnZSkgcHVibGljIHsKICAgICAgICBzdGF0ZSA9IF9zdG9yYWdlOwogICAgfQoKICAgIGZ1bmN0aW9uIGluc2VydEluZGV4KGJ5dGVzMzIgX2tleSkgaW50ZXJuYWwgewogICAgICAgIHVpbnQgdGltZXN0YW1wID0gX2tleS5nZXRUaW1lc3RhbXAoKTsKICAgICAgICBieXRlczMyIHllYXIgPSB0b0tleSh0aW1lc3RhbXAsIFlFQVIpOwogICAgICAgIGJ5dGVzMzIgaGVhZExvdzsKICAgICAgICBieXRlczMyIGhlYWRIaWdoOwogICAgICAgIChoZWFkTG93LCBoZWFkSGlnaCkgPSBmcm9tVmFsdWUoc3RhdGUuZ2V0KEhFQUQpKTsKICAgICAgICBpZiAoeWVhciA8IGhlYWRMb3cgfHwgaGVhZExvdyA9PSAwIHx8IHllYXIgPiBoZWFkSGlnaCkgewogICAgICAgICAgICBpZiAoeWVhciA8IGhlYWRMb3cgfHwgaGVhZExvdyA9PSAwKSB7CiAgICAgICAgICAgICAgICBoZWFkTG93ID0geWVhcjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoeWVhciA+IGhlYWRIaWdoKSB7CiAgICAgICAgICAgICAgICBoZWFkSGlnaCA9IHllYXI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc3RhdGUuc2V0KEhFQUQsIHRvVmFsdWUoaGVhZExvdywgaGVhZEhpZ2gpKTsKICAgICAgICB9CgogICAgICAgIGJ5dGVzMzIgd2VlayA9IHRvS2V5KHRpbWVzdGFtcCwgMSB3ZWVrcyk7CiAgICAgICAgYnl0ZXMzMiBsb3c7CiAgICAgICAgYnl0ZXMzMiBoaWdoOwogICAgICAgIChsb3csIGhpZ2gpID0gZnJvbVZhbHVlKHN0YXRlLmdldCh5ZWFyKSk7CiAgICAgICAgaWYgKHdlZWsgPCBsb3cgfHwgd2VlayA+IGhpZ2gpIHsKICAgICAgICAgICAgaWYgKHdlZWsgPCBsb3cgfHwgbG93ID09IDApIHsKICAgICAgICAgICAgICAgIGxvdyA9IHdlZWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHdlZWsgPiBoaWdoKSB7CiAgICAgICAgICAgICAgICBoaWdoID0gd2VlazsKICAgICAgICAgICAgfQogICAgICAgICAgICBzdGF0ZS5zZXQoeWVhciwgdG9WYWx1ZShsb3csIGhpZ2gpKTsKICAgICAgICB9CgogICAgICAgIChsb3csIGhpZ2gpID0gZnJvbVZhbHVlKHN0YXRlLmdldCh3ZWVrKSk7CiAgICAgICAgYnl0ZXMzMiBob3VyID0gdG9LZXkodGltZXN0YW1wLCAxIGhvdXJzKTsKICAgICAgICBpZiAoaG91ciA8IGxvdyB8fCBob3VyID4gaGlnaCkgewogICAgICAgICAgICBpZiAoaG91ciA8IGxvdyB8fCBsb3cgPT0gMCkgewogICAgICAgICAgICAgICAgbG93ID0gaG91cjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaG91ciA+IGhpZ2gpIHsKICAgICAgICAgICAgICAgIGhpZ2ggPSBob3VyOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHN0YXRlLnNldCh3ZWVrLCB0b1ZhbHVlKGxvdywgaGlnaCkpOwogICAgICAgIH0KCiAgICAgICAgKGxvdywgaGlnaCkgPSBmcm9tVmFsdWUoc3RhdGUuZ2V0KGhvdXIpKTsKICAgICAgICBieXRlczMyIG1pbnV0ZSA9IHRvS2V5KHRpbWVzdGFtcCwgMSBtaW51dGVzKTsKICAgICAgICBpZiAobWludXRlIDwgbG93IHx8IG1pbnV0ZSA+IGhpZ2gpIHsKICAgICAgICAgICAgaWYgKG1pbnV0ZSA8IGxvdyB8fCBsb3cgPT0gMCkgewogICAgICAgICAgICAgICAgbG93ID0gbWludXRlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChtaW51dGUgPiBoaWdoKSB7CiAgICAgICAgICAgICAgICBoaWdoID0gbWludXRlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHN0YXRlLnNldChob3VyLCB0b1ZhbHVlKGxvdywgaGlnaCkpOwogICAgICAgIH0KCiAgICAgICAgKGxvdywgaGlnaCkgPSBmcm9tVmFsdWUoc3RhdGUuZ2V0KG1pbnV0ZSkpOwogICAgICAgIGJ5dGVzMzIgdHNLZXkgPSB0b0tleSh0aW1lc3RhbXApOwogICAgICAgIGlmICh0c0tleSA8IGxvdyB8fCB0c0tleSA+IGhpZ2gpIHsKICAgICAgICAgICAgaWYgKHRzS2V5IDwgbG93IHx8IGxvdyA9PSAwKSB7CiAgICAgICAgICAgICAgICBsb3cgPSB0c0tleTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHNLZXkgPiBoaWdoKSB7CiAgICAgICAgICAgICAgICBoaWdoID0gdHNLZXk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc3RhdGUuc2V0KG1pbnV0ZSwgdG9WYWx1ZShsb3csIGhpZ2gpKTsKICAgICAgICB9CgogICAgICAgIHN0YXRlLnNldCh0c0tleSwgX2tleSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBAZGV2IFVwZGF0ZSBrZXkgdmFsdWUgZnJvbSB0aGUgcHJldmlvdXMgc3RhdGUgdG8gbmV3LiBUaW1lc3RhbXAgTVVTVCBiZSB0aGUgc2FtZSBvbiBib3RoIGtleXMuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHVwZGF0ZUluZGV4KGJ5dGVzMzIgX3ByZXYsIGJ5dGVzMzIgX2tleSkgaW50ZXJuYWwgewogICAgICAgIHVpbnQgdGltZXN0YW1wID0gX2tleS5nZXRUaW1lc3RhbXAoKTsKICAgICAgICBieXRlczMyIHRzS2V5ID0gdG9LZXkodGltZXN0YW1wKTsKICAgICAgICBieXRlczMyIHByZXZLZXkgPSBzdGF0ZS5nZXQodHNLZXkpOwogICAgICAgIC8vIG9uIHRoZSBzYW1lIHRpbWVzdGFtcCBtaWdodCBiZSBvdGhlciBrZXksIGluIHRoYXQgY2FzZSB3ZSBkbyBub3QgbmVlZCB0byB1cGRhdGUgaXQKICAgICAgICBpZiAocHJldktleSAhPSBfcHJldikgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHN0YXRlLnNldCh0c0tleSwgX2tleSk7CiAgICB9CgogICAgZnVuY3Rpb24gZmluZEZsb29yS2V5WWVhcih1aW50IF90aW1lc3RhbXAsIGJ5dGVzMzIgX2xvdywgYnl0ZXMzMiBfaGlnaCkgdmlldyBwcml2YXRlIHJldHVybnMgKGJ5dGVzMzIpIHsKICAgICAgICBieXRlczMyIHllYXIgPSB0b0tleShfdGltZXN0YW1wLCBZRUFSKTsKICAgICAgICBpZiAoeWVhciA8IF9sb3cpIHsKICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgfQogICAgICAgIGlmICh5ZWFyID4gX2hpZ2gpIHsKICAgICAgICAgICAgLy8gd2VlawogICAgICAgICAgICAobG93LCBoaWdoKSA9IGZyb21WYWx1ZShzdGF0ZS5nZXQoX2hpZ2gpKTsKICAgICAgICAgICAgLy8gaG91cgogICAgICAgICAgICAobG93LCBoaWdoKSA9IGZyb21WYWx1ZShzdGF0ZS5nZXQoaGlnaCkpOwogICAgICAgICAgICAvLyBtaW51dGUKICAgICAgICAgICAgKGxvdywgaGlnaCkgPSBmcm9tVmFsdWUoc3RhdGUuZ2V0KGhpZ2gpKTsKICAgICAgICAgICAgLy8gdHMKICAgICAgICAgICAgKGxvdywgaGlnaCkgPSBmcm9tVmFsdWUoc3RhdGUuZ2V0KGhpZ2gpKTsKICAgICAgICAgICAgcmV0dXJuIHN0YXRlLmdldChoaWdoKTsKICAgICAgICB9CgogICAgICAgIGJ5dGVzMzIgbG93OwogICAgICAgIGJ5dGVzMzIgaGlnaDsKCiAgICAgICAgd2hpbGUgKHllYXIgPj0gX2xvdykgewogICAgICAgICAgICAobG93LCBoaWdoKSA9IGZyb21WYWx1ZShzdGF0ZS5nZXQoeWVhcikpOwogICAgICAgICAgICBpZiAobG93ICE9IDApIHsKICAgICAgICAgICAgICAgIGJ5dGVzMzIga2V5ID0gZmluZEZsb29yS2V5V2VlayhfdGltZXN0YW1wLCBsb3csIGhpZ2gpOwogICAgICAgICAgICAgICAgaWYgKGtleSAhPSAwKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGtleTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAvLyAweDFERkUyMDAgPSA1MiB3ZWVrcyA9IDMxNDQ5NjAwCiAgICAgICAgICAgIGFzc2VtYmx5IHsKICAgICAgICAgICAgICAgIHllYXIgOj0gc3ViKHllYXIsIDB4MURGRTIwMCkKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIDA7CiAgICB9CgogICAgZnVuY3Rpb24gZmluZEZsb29yS2V5V2Vlayh1aW50IF90aW1lc3RhbXAsIGJ5dGVzMzIgX2xvdywgYnl0ZXMzMiBfaGlnaCkgdmlldyBwcml2YXRlIHJldHVybnMgKGJ5dGVzMzIpIHsKICAgICAgICBieXRlczMyIHdlZWsgPSB0b0tleShfdGltZXN0YW1wLCAxIHdlZWtzKTsKICAgICAgICBpZiAod2VlayA8IF9sb3cpIHsKICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgfQoKICAgICAgICBieXRlczMyIGxvdzsKICAgICAgICBieXRlczMyIGhpZ2g7CgogICAgICAgIGlmICh3ZWVrID4gX2hpZ2gpIHsKICAgICAgICAgICAgLy8gaG91cgogICAgICAgICAgICAobG93LCBoaWdoKSA9IGZyb21WYWx1ZShzdGF0ZS5nZXQoX2hpZ2gpKTsKICAgICAgICAgICAgLy8gbWludXRlCiAgICAgICAgICAgIChsb3csIGhpZ2gpID0gZnJvbVZhbHVlKHN0YXRlLmdldChoaWdoKSk7CiAgICAgICAgICAgIC8vIHRzCiAgICAgICAgICAgIChsb3csIGhpZ2gpID0gZnJvbVZhbHVlKHN0YXRlLmdldChoaWdoKSk7CiAgICAgICAgICAgIHJldHVybiBzdGF0ZS5nZXQoaGlnaCk7CiAgICAgICAgfQoKICAgICAgICB3aGlsZSAod2VlayA+PSBfbG93KSB7CiAgICAgICAgICAgIChsb3csIGhpZ2gpID0gZnJvbVZhbHVlKHN0YXRlLmdldCh3ZWVrKSk7CiAgICAgICAgICAgIGlmIChsb3cgIT0gMCkgewogICAgICAgICAgICAgICAgYnl0ZXMzMiBrZXkgPSBmaW5kRmxvb3JLZXlIb3VyKF90aW1lc3RhbXAsIGxvdywgaGlnaCk7CiAgICAgICAgICAgICAgICBpZiAoa2V5ICE9IDApIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4ga2V5OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAxIHdlZWtzID0gNjA0ODAwCiAgICAgICAgICAgIGFzc2VtYmx5IHsKICAgICAgICAgICAgICAgIHdlZWsgOj0gc3ViKHdlZWssIDYwNDgwMCkKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gMDsKICAgIH0KCgogICAgZnVuY3Rpb24gZmluZEZsb29yS2V5SG91cih1aW50IF90aW1lc3RhbXAsIGJ5dGVzMzIgX2xvdywgYnl0ZXMzMiBfaGlnaCkgdmlldyBwcml2YXRlIHJldHVybnMgKGJ5dGVzMzIpIHsKICAgICAgICBieXRlczMyIGhvdXIgPSB0b0tleShfdGltZXN0YW1wLCAxIGhvdXJzKTsKICAgICAgICBpZiAoaG91ciA8IF9sb3cpIHsKICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgfQoKICAgICAgICBieXRlczMyIGxvdzsKICAgICAgICBieXRlczMyIGhpZ2g7CgogICAgICAgIGlmIChob3VyID4gX2hpZ2gpIHsKICAgICAgICAgICAgLy8gbWludXRlCiAgICAgICAgICAgIChsb3csIGhpZ2gpID0gZnJvbVZhbHVlKHN0YXRlLmdldChfaGlnaCkpOwogICAgICAgICAgICAvLyB0cwogICAgICAgICAgICAobG93LCBoaWdoKSA9IGZyb21WYWx1ZShzdGF0ZS5nZXQoaGlnaCkpOwogICAgICAgICAgICByZXR1cm4gc3RhdGUuZ2V0KGhpZ2gpOwogICAgICAgIH0KCiAgICAgICAgd2hpbGUgKGhvdXIgPj0gX2xvdykgewogICAgICAgICAgICAobG93LCBoaWdoKSA9IGZyb21WYWx1ZShzdGF0ZS5nZXQoaG91cikpOwogICAgICAgICAgICBpZiAobG93ICE9IDApIHsKICAgICAgICAgICAgICAgIGJ5dGVzMzIga2V5ID0gZmluZEZsb29yS2V5TWludXRlKF90aW1lc3RhbXAsIGxvdywgaGlnaCk7CiAgICAgICAgICAgICAgICBpZiAoa2V5ICE9IDApIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4ga2V5OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAxIGhvdXJzID0gMzYwMAogICAgICAgICAgICBhc3NlbWJseSB7CiAgICAgICAgICAgICAgICBob3VyIDo9IHN1Yihob3VyLCAzNjAwKQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiAwOwogICAgfQoKICAgIGZ1bmN0aW9uIGZpbmRGbG9vcktleU1pbnV0ZSh1aW50IF90aW1lc3RhbXAsIGJ5dGVzMzIgX2xvdywgYnl0ZXMzMiBfaGlnaCkgdmlldyBwcml2YXRlIHJldHVybnMgKGJ5dGVzMzIpIHsKICAgICAgICBieXRlczMyIG1pbnV0ZSA9IHRvS2V5KF90aW1lc3RhbXAsIDEgbWludXRlcyk7CiAgICAgICAgaWYgKG1pbnV0ZSA8IF9sb3cpIHsKICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgfQoKICAgICAgICBieXRlczMyIGxvdzsKICAgICAgICBieXRlczMyIGhpZ2g7CgogICAgICAgIGlmIChtaW51dGUgPiBfaGlnaCkgewogICAgICAgICAgICAvLyB0cwogICAgICAgICAgICAobG93LCBoaWdoKSA9IGZyb21WYWx1ZShzdGF0ZS5nZXQoX2hpZ2gpKTsKICAgICAgICAgICAgcmV0dXJuIHN0YXRlLmdldChoaWdoKTsKICAgICAgICB9CgogICAgICAgIHdoaWxlIChtaW51dGUgPj0gX2xvdykgewogICAgICAgICAgICAobG93LCBoaWdoKSA9IGZyb21WYWx1ZShzdGF0ZS5nZXQobWludXRlKSk7CiAgICAgICAgICAgIGlmIChsb3cgIT0gMCkgewogICAgICAgICAgICAgICAgYnl0ZXMzMiBrZXkgPSBmaW5kRmxvb3JLZXlUaW1lc3RhbXAoX3RpbWVzdGFtcCwgbG93LCBoaWdoKTsKICAgICAgICAgICAgICAgIGlmIChrZXkgIT0gMCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBrZXk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDEgbWludXRlcyA9IDYwCiAgICAgICAgICAgIGFzc2VtYmx5IHsKICAgICAgICAgICAgICAgIG1pbnV0ZSA6PSBzdWIobWludXRlLCA2MCkKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIDA7CiAgICB9CgogICAgZnVuY3Rpb24gZmluZEZsb29yS2V5VGltZXN0YW1wKHVpbnQgX3RpbWVzdGFtcCwgYnl0ZXMzMiBfbG93LCBieXRlczMyIF9oaWdoKSB2aWV3IHByaXZhdGUgcmV0dXJucyAoYnl0ZXMzMikgewogICAgICAgIGJ5dGVzMzIgdHNLZXkgPSB0b0tleShfdGltZXN0YW1wKTsKICAgICAgICBpZiAodHNLZXkgPCBfbG93KSB7CiAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgIH0KICAgICAgICBpZiAodHNLZXkgPiBfaGlnaCkgewogICAgICAgICAgICByZXR1cm4gc3RhdGUuZ2V0KF9oaWdoKTsKICAgICAgICB9CgogICAgICAgIHdoaWxlICh0c0tleSA+PSBfbG93KSB7CiAgICAgICAgICAgIGJ5dGVzMzIga2V5ID0gc3RhdGUuZ2V0KHRzS2V5KTsKICAgICAgICAgICAgaWYgKGtleSAhPSAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm4ga2V5OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGFzc2VtYmx5IHsKICAgICAgICAgICAgICAgIHRzS2V5IDo9IHN1Yih0c0tleSwgMSkKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gMDsKICAgIH0KCiAgICBmdW5jdGlvbiBmaW5kRmxvb3JLZXlJbmRleCh1aW50IF90aW1lc3RhbXApIHZpZXcgaW50ZXJuYWwgcmV0dXJucyAoYnl0ZXMzMikgewovLyAgICAgICAgcmVxdWlyZShfdGltZXN0YW1wID4gMHhmZmZmZmZmZik7Ci8vICAgICAgICBpZiAoX3RpbWVzdGFtcCA8IDE1MTU2MTI0MTUpIHsKLy8gICAgICAgICAgICByZXR1cm4gMDsKLy8gICAgICAgIH0KCiAgICAgICAgYnl0ZXMzMiB5ZWFyTG93OwogICAgICAgIGJ5dGVzMzIgeWVhckhpZ2g7CiAgICAgICAgKHllYXJMb3csIHllYXJIaWdoKSA9IGZyb21WYWx1ZShzdGF0ZS5nZXQoSEVBRCkpOwoKICAgICAgICByZXR1cm4gZmluZEZsb29yS2V5WWVhcihfdGltZXN0YW1wLCB5ZWFyTG93LCB5ZWFySGlnaCk7CiAgICB9CgogICAgZnVuY3Rpb24gdG9LZXkodWludCBfdGltZXN0YW1wLCB1aW50IHJvdW5kZXIpIHB1cmUgcHJpdmF0ZSByZXR1cm5zIChieXRlczMyIHJlc3VsdCkgewogICAgICAgIC8vIDB4MC4uLjAwMDAwMDAwMDAwMDAwMDAwCiAgICAgICAgLy8gICAgICAgIF5eXl5eXl5eIC0gcm91bmRlciBtYXJrZXIgKGVnLCB0byBhdm9pZCBjcm9zc2luZyBmaXJzdCBkYXkgb2YgeWVhciB3aXRoIHllYXIpCiAgICAgICAgLy8gICAgICAgICAgICAgICAgXl5eXl5eXl4gLSByb3VuZGVkIG1vbWVudCAoeWVhciwgd2VlaywgZXRjKQogICAgICAgIGFzc2VtYmx5IHsKICAgICAgICAgICAgcmVzdWx0IDo9IG9yKG11bChyb3VuZGVyLCAweDEwMDAwMDAwMCksIG11bChkaXYoX3RpbWVzdGFtcCwgcm91bmRlciksIHJvdW5kZXIpKQogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiB0b1ZhbHVlKGJ5dGVzMzIgX2xvd0tleSwgYnl0ZXMzMiBfaGlnaEtleSkgcHVyZSBwcml2YXRlIHJldHVybnMgKGJ5dGVzMzIgcmVzdWx0KSB7CiAgICAgICAgYXNzZW1ibHkgewogICAgICAgICAgICByZXN1bHQgOj0gb3IobXVsKF9sb3dLZXksIDB4MTAwMDAwMDAwMDAwMDAwMDApLCBfaGlnaEtleSkKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gZnJvbVZhbHVlKGJ5dGVzMzIgX3ZhbHVlKSBwdXJlIHByaXZhdGUgcmV0dXJucyAoYnl0ZXMzMiBfbG93S2V5LCBieXRlczMyIF9oaWdoS2V5KSB7CiAgICAgICAgYXNzZW1ibHkgewogICAgICAgICAgICBfbG93S2V5IDo9IGFuZChkaXYoX3ZhbHVlLCAweDEwMDAwMDAwMDAwMDAwMDAwKSwgMHhmZmZmZmZmZmZmZmZmZmZmKQogICAgICAgICAgICBfaGlnaEtleSA6PSBhbmQoX3ZhbHVlLCAweGZmZmZmZmZmZmZmZmZmZmYpCiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIHRvS2V5KHVpbnQgdGltZXN0YW1wKSBwdXJlIGludGVybmFsIHJldHVybnMgKGJ5dGVzMzIpIHsKICAgICAgICByZXR1cm4gYnl0ZXMzMih0aW1lc3RhbXApOwogICAgfQp9Cgpjb250cmFjdCBKb3VsZUNvbnRyYWN0SG9sZGVyIGlzIEpvdWxlSW5kZXhDb3JlLCB1c2luZ0NvbnN0cyB7CiAgICB1c2luZyBLZXlzVXRpbHMgZm9yIGJ5dGVzMzI7CiAgICB1aW50IGludGVybmFsIGxlbmd0aDsKICAgIGJ5dGVzMzIgcHVibGljIGhlYWQ7CgogICAgZnVuY3Rpb24gSm91bGVDb250cmFjdEhvbGRlcihieXRlczMyIF9oZWFkLCB1aW50IF9sZW5ndGgsIEpvdWxlU3RvcmFnZSBfc3RvcmFnZSkgcHVibGljCiAgICAgICAgICAgIEpvdWxlSW5kZXhDb3JlKF9zdG9yYWdlKSB7CiAgICAgICAgaGVhZCA9IF9oZWFkOwogICAgICAgIGxlbmd0aCA9IF9sZW5ndGg7CiAgICB9CgogICAgZnVuY3Rpb24gaW5zZXJ0KGFkZHJlc3MgX2FkZHJlc3MsIHVpbnQgX3RpbWVzdGFtcCwgdWludCBfZ2FzTGltaXQsIHVpbnQgX2dhc1ByaWNlKSBpbnRlcm5hbCB7CiAgICAgICAgbGVuZ3RoICsrOwogICAgICAgIGJ5dGVzMzIgaWQgPSBLZXlzVXRpbHMudG9LZXkoX2FkZHJlc3MsIF90aW1lc3RhbXAsIF9nYXNMaW1pdCwgX2dhc1ByaWNlKTsKICAgICAgICBpZiAoaGVhZCA9PSAwKSB7CiAgICAgICAgICAgIGhlYWQgPSBpZDsKICAgICAgICAgICAgaW5zZXJ0SW5kZXgoaWQpOwovLyAgICAgICAgICAgIEZvdW5kKDB4ZmZmZmZmZmYpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGJ5dGVzMzIgcHJldmlvdXMgPSBmaW5kRmxvb3JLZXlJbmRleChfdGltZXN0YW1wKTsKCiAgICAgICAgLy8gcmVqZWN0IGR1cGxpY2F0ZSBrZXkgb24gdGhlIGVuZAogICAgICAgIHJlcXVpcmUocHJldmlvdXMgIT0gaWQpOwogICAgICAgIC8vIHJlamVjdCBkdXBsaWNhdGUgaW4gdGhlIG1pZGRsZQogICAgICAgIHJlcXVpcmUoc3RhdGUuZ2V0KGlkKSA9PSAwKTsKCiAgICAgICAgdWludCBwcmV2VGltZXN0YW1wID0gcHJldmlvdXMuZ2V0VGltZXN0YW1wKCk7Ci8vICAgICAgICBGb3VuZChwcmV2VGltZXN0YW1wKTsKICAgICAgICB1aW50IGhlYWRUaW1lc3RhbXAgPSBoZWFkLmdldFRpbWVzdGFtcCgpOwogICAgICAgIC8vIGFkZCBhcyBoZWFkLCBwcmV2VGltZXN0YW1wID09IDAgb3IgaW4gdGhlIHBhc3QKICAgICAgICBpZiAocHJldlRpbWVzdGFtcCA8IGhlYWRUaW1lc3RhbXApIHsKICAgICAgICAgICAgc3RhdGUuc2V0KGlkLCBoZWFkKTsKICAgICAgICAgICAgaGVhZCA9IGlkOwogICAgICAgIH0KICAgICAgICAvLyBhZGQgYWZ0ZXIgdGhlIHByZXZpb3VzCiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIHN0YXRlLnNldChpZCwgc3RhdGUuZ2V0KHByZXZpb3VzKSk7CiAgICAgICAgICAgIHN0YXRlLnNldChwcmV2aW91cywgaWQpOwogICAgICAgIH0KICAgICAgICBpbnNlcnRJbmRleChpZCk7CiAgICB9CgogICAgZnVuY3Rpb24gdXBkYXRlR2FzKGJ5dGVzMzIgX2tleSwgYWRkcmVzcyBfYWRkcmVzcywgdWludCBfdGltZXN0YW1wLCB1aW50IF9nYXNMaW1pdCwgdWludCBfZ2FzUHJpY2UsIHVpbnQgX25ld0dhc0xpbWl0KSBpbnRlcm5hbCB7CiAgICAgICAgYnl0ZXMzMiBpZCA9IEtleXNVdGlscy50b0tleShfYWRkcmVzcywgX3RpbWVzdGFtcCwgX2dhc0xpbWl0LCBfZ2FzUHJpY2UpOwogICAgICAgIGJ5dGVzMzIgbmV3SWQgPSBLZXlzVXRpbHMudG9LZXkoX2FkZHJlc3MsIF90aW1lc3RhbXAsIF9uZXdHYXNMaW1pdCwgX2dhc1ByaWNlKTsKICAgICAgICBpZiAoaWQgPT0gaGVhZCkgewogICAgICAgICAgICBieXRlczMyIGFmdGVySGVhZCA9IHN0YXRlLmdldChpZCk7CiAgICAgICAgICAgIGhlYWQgPSBuZXdJZDsKICAgICAgICAgICAgc3RhdGUuc2V0KG5ld0lkLCBhZnRlckhlYWQpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICByZXF1aXJlKHN0YXRlLmdldChfa2V5KSA9PSBpZCk7CiAgICAgICAgc3RhdGUuc2V0KF9rZXksIG5ld0lkKTsKICAgICAgICBzdGF0ZS5zd2FwKGlkLCBuZXdJZCk7CiAgICAgICAgdXBkYXRlSW5kZXgoaWQsIG5ld0lkKTsKICAgIH0KCiAgICBmdW5jdGlvbiBuZXh0KCkgaW50ZXJuYWwgewogICAgICAgIGhlYWQgPSBzdGF0ZS5nZXRBbmREZWwoaGVhZCk7CiAgICAgICAgbGVuZ3RoLS07CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0Q291bnQoKSBwdWJsaWMgdmlldyByZXR1cm5zICh1aW50KSB7CiAgICAgICAgcmV0dXJuIGxlbmd0aDsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRSZWNvcmQoYnl0ZXMzMiBfcGFyZW50KSBpbnRlcm5hbCB2aWV3IHJldHVybnMgKGJ5dGVzMzIgX3JlY29yZCkgewogICAgICAgIGlmIChfcGFyZW50ID09IDApIHsKICAgICAgICAgICAgX3JlY29yZCA9IGhlYWQ7CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgICBfcmVjb3JkID0gc3RhdGUuZ2V0KF9wYXJlbnQpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIEBkZXYgRmluZCBwcmV2aW91cyBrZXkgZm9yIGV4aXN0aW5nIHZhbHVlLgogICAgICovCiAgICBmdW5jdGlvbiBmaW5kUHJldmlvdXMoYWRkcmVzcyBfYWRkcmVzcywgdWludCBfdGltZXN0YW1wLCB1aW50IF9nYXNMaW1pdCwgdWludCBfZ2FzUHJpY2UpIGludGVybmFsIHZpZXcgcmV0dXJucyAoYnl0ZXMzMikgewogICAgICAgIGJ5dGVzMzIgdGFyZ2V0ID0gS2V5c1V0aWxzLnRvS2V5KF9hZGRyZXNzLCBfdGltZXN0YW1wLCBfZ2FzTGltaXQsIF9nYXNQcmljZSk7CiAgICAgICAgYnl0ZXMzMiBwcmV2aW91cyA9IGhlYWQ7CiAgICAgICAgaWYgKHRhcmdldCA9PSBwcmV2aW91cykgewogICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICB9CiAgICAgICAgLy8gaWYgaXQgaXMgbm90IGhlYWQgdGltZQogICAgICAgIGlmIChfdGltZXN0YW1wICE9IHByZXZpb3VzLmdldFRpbWVzdGFtcCgpKSB7CiAgICAgICAgICAgIHByZXZpb3VzID0gZmluZEZsb29yS2V5SW5kZXgoX3RpbWVzdGFtcCAtIDEpOwogICAgICAgIH0KICAgICAgICBieXRlczMyIGN1cnJlbnQgPSBzdGF0ZS5nZXQocHJldmlvdXMpOwogICAgICAgIHdoaWxlIChjdXJyZW50ICE9IHRhcmdldCkgewogICAgICAgICAgICBwcmV2aW91cyA9IGN1cnJlbnQ7CiAgICAgICAgICAgIGN1cnJlbnQgPSBzdGF0ZS5nZXQocHJldmlvdXMpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcHJldmlvdXM7CiAgICB9Cn0KCmNvbnRyYWN0IEpvdWxlVmF1bHQgaXMgT3duYWJsZSB7CiAgICBhZGRyZXNzIHB1YmxpYyBqb3VsZTsKCiAgICBmdW5jdGlvbiBzZXRKb3VsZShhZGRyZXNzIF9qb3VsZSkgcHVibGljIG9ubHlPd25lciB7CiAgICAgICAgam91bGUgPSBfam91bGU7CiAgICB9CgogICAgbW9kaWZpZXIgb25seUpvdWxlKCkgewogICAgICAgIHJlcXVpcmUobXNnLnNlbmRlciA9PSBhZGRyZXNzKGpvdWxlKSk7CiAgICAgICAgXzsKICAgIH0KCiAgICBmdW5jdGlvbiB3aXRoZHJhdyhhZGRyZXNzIF9yZWNlaXZlciwgdWludCBfYW1vdW50KSBwdWJsaWMgb25seUpvdWxlIHsKICAgICAgICBfcmVjZWl2ZXIudHJhbnNmZXIoX2Ftb3VudCk7CiAgICB9CgogICAgZnVuY3Rpb24gKCkgcHVibGljIHBheWFibGUgewoKICAgIH0KfQoKY29udHJhY3QgSm91bGVDb3JlIGlzIEpvdWxlQ29udHJhY3RIb2xkZXIgewogICAgSm91bGVWYXVsdCBwdWJsaWMgdmF1bHQ7CiAgICB1aW50MzIgcHVibGljIG1pbkdhc1ByaWNlR3dlaSA9IERFRkFVTFRfTUlOX0dBU19QUklDRV9HV0VJOwogICAgdXNpbmcgS2V5c1V0aWxzIGZvciBieXRlczMyOwoKICAgIGZ1bmN0aW9uIEpvdWxlQ29yZShKb3VsZVZhdWx0IF92YXVsdCwgYnl0ZXMzMiBfaGVhZCwgdWludCBfbGVuZ3RoLCBKb3VsZVN0b3JhZ2UgX3N0b3JhZ2UpIHB1YmxpYwogICAgICAgIEpvdWxlQ29udHJhY3RIb2xkZXIoX2hlYWQsIF9sZW5ndGgsIF9zdG9yYWdlKSB7CiAgICAgICAgdmF1bHQgPSBfdmF1bHQ7CiAgICB9CgogICAgZnVuY3Rpb24gaW5uZXJSZWdpc3RlcihhZGRyZXNzIF9yZWdpc3RyYW50LCBhZGRyZXNzIF9hZGRyZXNzLCB1aW50IF90aW1lc3RhbXAsIHVpbnQgX2dhc0xpbWl0LCB1aW50IF9nYXNQcmljZSkgaW50ZXJuYWwgcmV0dXJucyAodWludCkgewogICAgICAgIHVpbnQgcHJpY2UgPSBnZXRQcmljZUlubmVyKF9nYXNMaW1pdCwgX2dhc1ByaWNlKTsKICAgICAgICByZXF1aXJlKG1zZy52YWx1ZSA+PSBwcmljZSk7CiAgICAgICAgdmF1bHQudHJhbnNmZXIocHJpY2UpOwoKICAgICAgICAvLyB0aGlzIHJlc3RyaWN0aW9uIHRvIGF2b2lkIGF0dGFjayB0byBicmFrZSBpbmRleCB0cmVlIChjcm9zc2luZyBrZXkpCiAgICAgICAgcmVxdWlyZShfYWRkcmVzcyAhPSAwKTsKICAgICAgICByZXF1aXJlKF90aW1lc3RhbXAgPiBub3cpOwogICAgICAgIHJlcXVpcmUoX3RpbWVzdGFtcCA8IDB4MTAwMDAwMDAwKTsKICAgICAgICByZXF1aXJlKF9nYXNMaW1pdCA8PSBNQVhfR0FTKTsKICAgICAgICByZXF1aXJlKF9nYXNMaW1pdCAhPSAwKTsKICAgICAgICAvLyBmcm9tIDEgZ3dlaSB0byAweDEwMDAwMDAwMCBnd2VpCiAgICAgICAgcmVxdWlyZShfZ2FzUHJpY2UgPj0gbWluR2FzUHJpY2VHd2VpICogR1dFSSk7CiAgICAgICAgcmVxdWlyZShfZ2FzUHJpY2UgPCBNQVhfR0FTX1BSSUNFKTsKICAgICAgICAvLyAwIG1lYW5zIG5vdCB5ZXQgcmVnaXN0ZXJlZAogICAgICAgIHJlcXVpcmUoX3JlZ2lzdHJhbnQgIT0gMHgwKTsKCiAgICAgICAgdWludCBpbm5lckdhc1ByaWNlID0gX2dhc1ByaWNlIC8gR1dFSTsKICAgICAgICBpbnNlcnQoX2FkZHJlc3MsIF90aW1lc3RhbXAsIF9nYXNMaW1pdCwgaW5uZXJHYXNQcmljZSk7CiAgICAgICAgc2F2ZVJlZ2lzdHJhbnQoX3JlZ2lzdHJhbnQsIF9hZGRyZXNzLCBfdGltZXN0YW1wLCBfZ2FzTGltaXQsIGlubmVyR2FzUHJpY2UpOwoKICAgICAgICBpZiAobXNnLnZhbHVlID4gcHJpY2UpIHsKICAgICAgICAgICAgbXNnLnNlbmRlci50cmFuc2Zlcihtc2cudmFsdWUgLSBwcmljZSk7CiAgICAgICAgICAgIHJldHVybiBtc2cudmFsdWUgLSBwcmljZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIDA7CiAgICB9CgogICAgZnVuY3Rpb24gc2F2ZVJlZ2lzdHJhbnQoYWRkcmVzcyBfcmVnaXN0cmFudCwgYWRkcmVzcyBfYWRkcmVzcywgdWludCBfdGltZXN0YW1wLCB1aW50LCB1aW50KSBpbnRlcm5hbCB7CiAgICAgICAgYnl0ZXMzMiBpZCA9IEtleXNVdGlscy50b0tleShfYWRkcmVzcywgX3RpbWVzdGFtcCwgMCwgMCk7CiAgICAgICAgcmVxdWlyZShzdGF0ZS5nZXQoaWQpID09IDApOwogICAgICAgIHN0YXRlLnNldChpZCwgYnl0ZXMzMihfcmVnaXN0cmFudCkpOwogICAgfQoKICAgIGZ1bmN0aW9uIGdldFJlZ2lzdHJhbnQoYWRkcmVzcyBfYWRkcmVzcywgdWludCBfdGltZXN0YW1wLCB1aW50LCB1aW50KSBpbnRlcm5hbCB2aWV3IHJldHVybnMgKGFkZHJlc3MpIHsKICAgICAgICBieXRlczMyIGlkID0gS2V5c1V0aWxzLnRvS2V5KF9hZGRyZXNzLCBfdGltZXN0YW1wLCAwLCAwKTsKICAgICAgICByZXR1cm4gYWRkcmVzcyhzdGF0ZS5nZXQoaWQpKTsKICAgIH0KCiAgICBmdW5jdGlvbiBkZWxSZWdpc3RyYW50KEtleXNVdGlscy5PYmplY3QgbWVtb3J5IGN1cnJlbnQpIGludGVybmFsIHsKICAgICAgICBieXRlczMyIGlkID0gS2V5c1V0aWxzLnRvS2V5KGN1cnJlbnQuY29udHJhY3RBZGRyZXNzLCBjdXJyZW50LnRpbWVzdGFtcCwgMCwgMCk7CiAgICAgICAgc3RhdGUuZGVsKGlkKTsKICAgIH0KCiAgICBmdW5jdGlvbiBmaW5kS2V5KGFkZHJlc3MgX2FkZHJlc3MsIHVpbnQgX3RpbWVzdGFtcCwgdWludCBfZ2FzTGltaXQsIHVpbnQgX2dhc1ByaWNlKSBwdWJsaWMgdmlldyByZXR1cm5zIChieXRlczMyKSB7CiAgICAgICAgcmVxdWlyZShfYWRkcmVzcyAhPSAwKTsKICAgICAgICByZXF1aXJlKF90aW1lc3RhbXAgPiBub3cpOwogICAgICAgIHJlcXVpcmUoX3RpbWVzdGFtcCA8IDB4MTAwMDAwMDAwKTsKICAgICAgICByZXF1aXJlKF9nYXNMaW1pdCA8IE1BWF9HQVMpOwogICAgICAgIHJlcXVpcmUoX2dhc1ByaWNlID4gR1dFSSk7CiAgICAgICAgcmVxdWlyZShfZ2FzUHJpY2UgPCAweDEwMDAwMDAwMCAqIEdXRUkpOwogICAgICAgIHJldHVybiBmaW5kUHJldmlvdXMoX2FkZHJlc3MsIF90aW1lc3RhbXAsIF9nYXNMaW1pdCwgX2dhc1ByaWNlIC8gR1dFSSk7CiAgICB9CgogICAgZnVuY3Rpb24gaW5uZXJVbnJlZ2lzdGVyKGFkZHJlc3MgX3JlZ2lzdHJhbnQsIGJ5dGVzMzIgX2tleSwgYWRkcmVzcyBfYWRkcmVzcywgdWludCBfdGltZXN0YW1wLCB1aW50IF9nYXNMaW1pdCwgdWludCBfZ2FzUHJpY2UpIGludGVybmFsIHJldHVybnMgKHVpbnQpIHsKICAgICAgICAvLyBvbmx5IGZ1dHVyZSByZWdpc3RyYXRpb25zIG1pZ2h0IGJlIHVwZGF0ZWQsIHRvIGF2b2lkIHJhY2UgY29uZGl0aW9uIGluIGJsb2NrICh3aXRoIGludm9rZSkKICAgICAgICByZXF1aXJlKF90aW1lc3RhbXAgPiBub3cpOwogICAgICAgIC8vIHRvIGF2b2lkIHJlbW92aW5nIGFscmVhZHkgcmVtb3ZlZCBrZXlzCiAgICAgICAgcmVxdWlyZShfZ2FzTGltaXQgIT0gMCk7CiAgICAgICAgdWludCBpbm5lckdhc1ByaWNlID0gX2dhc1ByaWNlIC8gR1dFSTsKICAgICAgICAvLyBjaGVjayByZWdpc3RyYW50CiAgICAgICAgYWRkcmVzcyByZWdpc3RyYW50ID0gZ2V0UmVnaXN0cmFudChfYWRkcmVzcywgX3RpbWVzdGFtcCwgX2dhc0xpbWl0LCBpbm5lckdhc1ByaWNlKTsKICAgICAgICByZXF1aXJlKHJlZ2lzdHJhbnQgPT0gX3JlZ2lzdHJhbnQpOwoKICAgICAgICB1cGRhdGVHYXMoX2tleSwgX2FkZHJlc3MsIF90aW1lc3RhbXAsIF9nYXNMaW1pdCwgaW5uZXJHYXNQcmljZSwgMCk7CiAgICAgICAgdWludCBhbW91bnQgPSBfZ2FzTGltaXQgKiBfZ2FzUHJpY2U7CiAgICAgICAgaWYgKGFtb3VudCAhPSAwKSB7CiAgICAgICAgICAgIHZhdWx0LndpdGhkcmF3KHJlZ2lzdHJhbnQsIGFtb3VudCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBhbW91bnQ7CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0UHJpY2UodWludCBfZ2FzTGltaXQsIHVpbnQgX2dhc1ByaWNlKSBleHRlcm5hbCB2aWV3IHJldHVybnMgKHVpbnQpIHsKICAgICAgICByZXF1aXJlKF9nYXNMaW1pdCA8PSBNQVhfR0FTKTsKICAgICAgICByZXF1aXJlKF9nYXNQcmljZSA+IEdXRUkpOwogICAgICAgIHJlcXVpcmUoX2dhc1ByaWNlIDwgMHgxMDAwMDAwMDAgKiBHV0VJKTsKCiAgICAgICAgcmV0dXJuIGdldFByaWNlSW5uZXIoX2dhc0xpbWl0LCBfZ2FzUHJpY2UpOwogICAgfQoKICAgIGZ1bmN0aW9uIGdldFByaWNlSW5uZXIodWludCBfZ2FzTGltaXQsIHVpbnQgX2dhc1ByaWNlKSBpbnRlcm5hbCBwdXJlIHJldHVybnMgKHVpbnQpIHsKICAgICAgICAvLyBpZiB0aGlzIGxvZ2ljIHdpbGwgYmUgY2hhbmdlZCwgbG9vayBhbHNvIHRvIHRoZSBpbm5lclVucmVnaXN0ZXIgbWV0aG9kCiAgICAgICAgcmV0dXJuIChfZ2FzTGltaXQgKyBKT1VMRV9HQVMpICogX2dhc1ByaWNlOwogICAgfQoKICAgIGZ1bmN0aW9uIGdldFZlcnNpb24oKSBleHRlcm5hbCB2aWV3IHJldHVybnMgKGJ5dGVzOCkgewogICAgICAgIHJldHVybiBWRVJTSU9OOwogICAgfQoKICAgIGZ1bmN0aW9uIGdldFRvcCh1aW50IF9jb3VudCkgZXh0ZXJuYWwgdmlldyByZXR1cm5zICgKICAgICAgICBhZGRyZXNzW10gX2FkZHJlc3NlcywKICAgICAgICB1aW50W10gX3RpbWVzdGFtcHMsCiAgICAgICAgdWludFtdIF9nYXNMaW1pdHMsCiAgICAgICAgdWludFtdIF9nYXNQcmljZXMsCiAgICAgICAgdWludFtdIF9pbnZva2VHYXNlcywKICAgICAgICB1aW50W10gX3Jld2FyZEFtb3VudHMKICAgICkgewogICAgICAgIHVpbnQgYW1vdW50ID0gX2NvdW50IDw9IGxlbmd0aCA/IF9jb3VudCA6IGxlbmd0aDsKCiAgICAgICAgX2FkZHJlc3NlcyA9IG5ldyBhZGRyZXNzW10oYW1vdW50KTsKICAgICAgICBfdGltZXN0YW1wcyA9IG5ldyB1aW50W10oYW1vdW50KTsKICAgICAgICBfZ2FzTGltaXRzID0gbmV3IHVpbnRbXShhbW91bnQpOwogICAgICAgIF9nYXNQcmljZXMgPSBuZXcgdWludFtdKGFtb3VudCk7CiAgICAgICAgX2ludm9rZUdhc2VzID0gbmV3IHVpbnRbXShhbW91bnQpOwogICAgICAgIF9yZXdhcmRBbW91bnRzID0gbmV3IHVpbnRbXShhbW91bnQpOwoKICAgICAgICBieXRlczMyIGN1cnJlbnQgPSBnZXRSZWNvcmQoMCk7CiAgICAgICAgZm9yICh1aW50IGkgPSAwOyBpIDwgYW1vdW50OyBpICsrKSB7CiAgICAgICAgICAgIEtleXNVdGlscy5PYmplY3QgbWVtb3J5IG9iaiA9IGN1cnJlbnQudG9PYmplY3QoKTsKICAgICAgICAgICAgX2FkZHJlc3Nlc1tpXSA9IG9iai5jb250cmFjdEFkZHJlc3M7CiAgICAgICAgICAgIF90aW1lc3RhbXBzW2ldID0gb2JqLnRpbWVzdGFtcDsKICAgICAgICAgICAgdWludCBnYXNMaW1pdCA9IG9iai5nYXNMaW1pdDsKICAgICAgICAgICAgX2dhc0xpbWl0c1tpXSA9IGdhc0xpbWl0OwogICAgICAgICAgICB1aW50IGdhc1ByaWNlID0gb2JqLmdhc1ByaWNlR3dlaSAqIEdXRUk7CiAgICAgICAgICAgIF9nYXNQcmljZXNbaV0gPSBnYXNQcmljZTsKICAgICAgICAgICAgdWludCBpbnZva2VHYXMgPSBnYXNMaW1pdCArIEpPVUxFX0dBUzsKICAgICAgICAgICAgX2ludm9rZUdhc2VzW2ldID0gaW52b2tlR2FzOwogICAgICAgICAgICBfcmV3YXJkQW1vdW50c1tpXSA9IGludm9rZUdhcyAqIGdhc1ByaWNlOwogICAgICAgICAgICBjdXJyZW50ID0gZ2V0UmVjb3JkKGN1cnJlbnQpOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBnZXRUb3BPbmNlKCkgZXh0ZXJuYWwgdmlldyByZXR1cm5zICgKICAgICAgICBhZGRyZXNzIGNvbnRyYWN0QWRkcmVzcywKICAgICAgICB1aW50IHRpbWVzdGFtcCwKICAgICAgICB1aW50IGdhc0xpbWl0LAogICAgICAgIHVpbnQgZ2FzUHJpY2UsCiAgICAgICAgdWludCBpbnZva2VHYXMsCiAgICAgICAgdWludCByZXdhcmRBbW91bnQKICAgICkgewogICAgICAgIEtleXNVdGlscy5PYmplY3QgbWVtb3J5IG9iaiA9IGdldFJlY29yZCgwKS50b09iamVjdCgpOwoKICAgICAgICBjb250cmFjdEFkZHJlc3MgPSBvYmouY29udHJhY3RBZGRyZXNzOwogICAgICAgIHRpbWVzdGFtcCA9IG9iai50aW1lc3RhbXA7CiAgICAgICAgZ2FzTGltaXQgPSBvYmouZ2FzTGltaXQ7CiAgICAgICAgZ2FzUHJpY2UgPSBvYmouZ2FzUHJpY2VHd2VpICogR1dFSTsKICAgICAgICBpbnZva2VHYXMgPSBnYXNMaW1pdCArIEpPVUxFX0dBUzsKICAgICAgICByZXdhcmRBbW91bnQgPSBpbnZva2VHYXMgKiBnYXNQcmljZTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXROZXh0T25jZShhZGRyZXNzIF9jb250cmFjdEFkZHJlc3MsCiAgICAgICAgICAgICAgICAgICAgIHVpbnQgX3RpbWVzdGFtcCwKICAgICAgICAgICAgICAgICAgICAgdWludCBfZ2FzTGltaXQsCiAgICAgICAgICAgICAgICAgICAgIHVpbnQgX2dhc1ByaWNlKSBwdWJsaWMgdmlldyByZXR1cm5zICgKICAgICAgICBhZGRyZXNzIGNvbnRyYWN0QWRkcmVzcywKICAgICAgICB1aW50IHRpbWVzdGFtcCwKICAgICAgICB1aW50IGdhc0xpbWl0LAogICAgICAgIHVpbnQgZ2FzUHJpY2UsCiAgICAgICAgdWludCBpbnZva2VHYXMsCiAgICAgICAgdWludCByZXdhcmRBbW91bnQKICAgICkgewogICAgICAgIGlmIChfdGltZXN0YW1wID09IDApIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0VG9wT25jZSgpOwogICAgICAgIH0KCiAgICAgICAgYnl0ZXMzMiBwcmV2ID0gS2V5c1V0aWxzLnRvS2V5KF9jb250cmFjdEFkZHJlc3MsIF90aW1lc3RhbXAsIF9nYXNMaW1pdCwgX2dhc1ByaWNlIC8gR1dFSSk7CiAgICAgICAgYnl0ZXMzMiBjdXJyZW50ID0gZ2V0UmVjb3JkKHByZXYpOwogICAgICAgIEtleXNVdGlscy5PYmplY3QgbWVtb3J5IG9iaiA9IGN1cnJlbnQudG9PYmplY3QoKTsKCiAgICAgICAgY29udHJhY3RBZGRyZXNzID0gb2JqLmNvbnRyYWN0QWRkcmVzczsKICAgICAgICB0aW1lc3RhbXAgPSBvYmoudGltZXN0YW1wOwogICAgICAgIGdhc0xpbWl0ID0gb2JqLmdhc0xpbWl0OwogICAgICAgIGdhc1ByaWNlID0gb2JqLmdhc1ByaWNlR3dlaSAqIEdXRUk7CiAgICAgICAgaW52b2tlR2FzID0gZ2FzTGltaXQgKyBKT1VMRV9HQVM7CiAgICAgICAgcmV3YXJkQW1vdW50ID0gaW52b2tlR2FzICogZ2FzUHJpY2U7CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0TmV4dCh1aW50IF9jb3VudCwKICAgICAgICAgICAgICAgICAgICBhZGRyZXNzIF9jb250cmFjdEFkZHJlc3MsCiAgICAgICAgICAgICAgICAgICAgdWludCBfdGltZXN0YW1wLAogICAgICAgICAgICAgICAgICAgIHVpbnQgX2dhc0xpbWl0LAogICAgICAgICAgICAgICAgICAgIHVpbnQgX2dhc1ByaWNlKSBleHRlcm5hbCB2aWV3IHJldHVybnMgKGFkZHJlc3NbXSBfYWRkcmVzc2VzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVpbnRbXSBfdGltZXN0YW1wcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1aW50W10gX2dhc0xpbWl0cywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1aW50W10gX2dhc1ByaWNlcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1aW50W10gX2ludm9rZUdhc2VzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVpbnRbXSBfcmV3YXJkQW1vdW50cykgewogICAgICAgIF9hZGRyZXNzZXMgPSBuZXcgYWRkcmVzc1tdKF9jb3VudCk7CiAgICAgICAgX3RpbWVzdGFtcHMgPSBuZXcgdWludFtdKF9jb3VudCk7CiAgICAgICAgX2dhc0xpbWl0cyA9IG5ldyB1aW50W10oX2NvdW50KTsKICAgICAgICBfZ2FzUHJpY2VzID0gbmV3IHVpbnRbXShfY291bnQpOwogICAgICAgIF9pbnZva2VHYXNlcyA9IG5ldyB1aW50W10oX2NvdW50KTsKICAgICAgICBfcmV3YXJkQW1vdW50cyA9IG5ldyB1aW50W10oX2NvdW50KTsKCiAgICAgICAgYnl0ZXMzMiBwcmV2OwogICAgICAgIGlmIChfdGltZXN0YW1wICE9IDApIHsKICAgICAgICAgICAgcHJldiA9IEtleXNVdGlscy50b0tleShfY29udHJhY3RBZGRyZXNzLCBfdGltZXN0YW1wLCBfZ2FzTGltaXQsIF9nYXNQcmljZSAvIEdXRUkpOwogICAgICAgIH0KCiAgICAgICAgdWludCBpbmRleCA9IDA7CiAgICAgICAgd2hpbGUgKGluZGV4IDwgX2NvdW50KSB7CiAgICAgICAgICAgIGJ5dGVzMzIgY3VycmVudCA9IGdldFJlY29yZChwcmV2KTsKICAgICAgICAgICAgaWYgKGN1cnJlbnQgPT0gMCkgewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgS2V5c1V0aWxzLk9iamVjdCBtZW1vcnkgb2JqID0gY3VycmVudC50b09iamVjdCgpOwoKICAgICAgICAgICAgX2FkZHJlc3Nlc1tpbmRleF0gPSBvYmouY29udHJhY3RBZGRyZXNzOwogICAgICAgICAgICBfdGltZXN0YW1wc1tpbmRleF0gPSBvYmoudGltZXN0YW1wOwogICAgICAgICAgICBfZ2FzTGltaXRzW2luZGV4XSA9IG9iai5nYXNMaW1pdDsKICAgICAgICAgICAgX2dhc1ByaWNlc1tpbmRleF0gPSBvYmouZ2FzUHJpY2VHd2VpICogR1dFSTsKICAgICAgICAgICAgX2ludm9rZUdhc2VzW2luZGV4XSA9IG9iai5nYXNMaW1pdCArIEpPVUxFX0dBUzsKICAgICAgICAgICAgX3Jld2FyZEFtb3VudHNbaW5kZXhdID0gKG9iai5nYXNMaW1pdCArIEpPVUxFX0dBUykgKiBvYmouZ2FzUHJpY2VHd2VpICogR1dFSTsKCiAgICAgICAgICAgIHByZXYgPSBjdXJyZW50OwogICAgICAgICAgICBpbmRleCArKzsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gbmV4dChLZXlzVXRpbHMuT2JqZWN0IG1lbW9yeSBjdXJyZW50KSBpbnRlcm5hbCB7CiAgICAgICAgZGVsUmVnaXN0cmFudChjdXJyZW50KTsKICAgICAgICBuZXh0KCk7CiAgICB9CgoKICAgIGZ1bmN0aW9uIGlubmVySW52b2tlKGFkZHJlc3MgX2ludm9rZXIpIGludGVybmFsIHJldHVybnMgKHVpbnQgX2Ftb3VudCkgewogICAgICAgIEtleXNVdGlscy5PYmplY3QgbWVtb3J5IGN1cnJlbnQgPSBLZXlzVXRpbHMudG9PYmplY3QoaGVhZCk7CgogICAgICAgIHVpbnQgYW1vdW50OwogICAgICAgIHdoaWxlIChjdXJyZW50LnRpbWVzdGFtcCAhPSAwICYmIGN1cnJlbnQudGltZXN0YW1wIDwgbm93ICYmIG1zZy5nYXMgPiAoY3VycmVudC5nYXNMaW1pdCArIFJFTUFJTklOR19HQVMpKSB7CiAgICAgICAgICAgIGlmIChjdXJyZW50Lmdhc0xpbWl0ICE9IDApIHsKICAgICAgICAgICAgICAgIGludm9rZUNhbGxiYWNrKF9pbnZva2VyLCBjdXJyZW50KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgYW1vdW50ICs9IGdldFByaWNlSW5uZXIoY3VycmVudC5nYXNMaW1pdCwgY3VycmVudC5nYXNQcmljZUd3ZWkgKiBHV0VJKTsKICAgICAgICAgICAgbmV4dChjdXJyZW50KTsKICAgICAgICAgICAgY3VycmVudCA9IGhlYWQudG9PYmplY3QoKTsKICAgICAgICB9CiAgICAgICAgaWYgKGFtb3VudCA+IDApIHsKICAgICAgICAgICAgdmF1bHQud2l0aGRyYXcobXNnLnNlbmRlciwgYW1vdW50KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGFtb3VudDsKICAgIH0KCiAgICBmdW5jdGlvbiBpbm5lckludm9rZU9uY2UoYWRkcmVzcyBfaW52b2tlcikgaW50ZXJuYWwgcmV0dXJucyAodWludCBfYW1vdW50KSB7CiAgICAgICAgS2V5c1V0aWxzLk9iamVjdCBtZW1vcnkgY3VycmVudCA9IGhlYWQudG9PYmplY3QoKTsKICAgICAgICBuZXh0KGN1cnJlbnQpOwogICAgICAgIGlmIChjdXJyZW50Lmdhc0xpbWl0ICE9IDApIHsKICAgICAgICAgICAgaW52b2tlQ2FsbGJhY2soX2ludm9rZXIsIGN1cnJlbnQpOwogICAgICAgIH0KCiAgICAgICAgdWludCBhbW91bnQgPSBnZXRQcmljZUlubmVyKGN1cnJlbnQuZ2FzTGltaXQsIGN1cnJlbnQuZ2FzUHJpY2VHd2VpICogR1dFSSk7CgogICAgICAgIGlmIChhbW91bnQgPiAwKSB7CiAgICAgICAgICAgIHZhdWx0LndpdGhkcmF3KG1zZy5zZW5kZXIsIGFtb3VudCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBhbW91bnQ7CiAgICB9CgoKICAgIGZ1bmN0aW9uIGludm9rZUNhbGxiYWNrKGFkZHJlc3MsIEtleXNVdGlscy5PYmplY3QgbWVtb3J5IF9yZWNvcmQpIGludGVybmFsIHJldHVybnMgKGJvb2wpIHsKICAgICAgICByZXF1aXJlKG1zZy5nYXMgPj0gX3JlY29yZC5nYXNMaW1pdCk7CiAgICAgICAgcmV0dXJuIF9yZWNvcmQuY29udHJhY3RBZGRyZXNzLmNhbGwuZ2FzKF9yZWNvcmQuZ2FzTGltaXQpKDB4OTE5ODQwYWQpOwogICAgfQoKfQoKCmNvbnRyYWN0IEpvdWxlQmVoaW5kUHJveHkgaXMgSm91bGVDb3JlLCBPd25hYmxlLCBUcmFuc2ZlclRva2VuIHsKICAgIEpvdWxlUHJveHlBUEkgcHVibGljIHByb3h5OwoKICAgIGZ1bmN0aW9uIEpvdWxlQmVoaW5kUHJveHkoSm91bGVWYXVsdCBfdmF1bHQsIGJ5dGVzMzIgX2hlYWQsIHVpbnQgX2xlbmd0aCwgSm91bGVTdG9yYWdlIF9zdG9yYWdlKSBwdWJsaWMKICAgICAgICBKb3VsZUNvcmUoX3ZhdWx0LCBfaGVhZCwgX2xlbmd0aCwgX3N0b3JhZ2UpIHsKICAgIH0KCiAgICBmdW5jdGlvbiBzZXRQcm94eShKb3VsZVByb3h5QVBJIF9wcm94eSkgcHVibGljIG9ubHlPd25lciB7CiAgICAgICAgcHJveHkgPSBfcHJveHk7CiAgICB9CgogICAgbW9kaWZpZXIgb25seVByb3h5KCkgewogICAgICAgIHJlcXVpcmUobXNnLnNlbmRlciA9PSBhZGRyZXNzKHByb3h5KSk7CiAgICAgICAgXzsKICAgIH0KCiAgICBmdW5jdGlvbiBzZXRNaW5HYXNQcmljZSh1aW50IF9taW5HYXNQcmljZSkgcHVibGljIG9ubHlPd25lciB7CiAgICAgICAgcmVxdWlyZShfbWluR2FzUHJpY2UgPj0gTUlOX0dBU19QUklDRSk7CiAgICAgICAgcmVxdWlyZShfbWluR2FzUHJpY2UgPD0gTUFYX0dBU19QUklDRSk7CiAgICAgICAgbWluR2FzUHJpY2VHd2VpID0gdWludDMyKF9taW5HYXNQcmljZSAvIEdXRUkpOwogICAgfQoKICAgIGZ1bmN0aW9uIHJlZ2lzdGVyRm9yKGFkZHJlc3MgX3JlZ2lzdHJhbnQsIGFkZHJlc3MgX2FkZHJlc3MsIHVpbnQgX3RpbWVzdGFtcCwgdWludCBfZ2FzTGltaXQsIHVpbnQgX2dhc1ByaWNlKSBwdWJsaWMgcGF5YWJsZSBvbmx5UHJveHkgcmV0dXJucyAodWludCkgewogICAgICAgIHJldHVybiBpbm5lclJlZ2lzdGVyKF9yZWdpc3RyYW50LCBfYWRkcmVzcywgX3RpbWVzdGFtcCwgX2dhc0xpbWl0LCBfZ2FzUHJpY2UpOwogICAgfQoKICAgIGZ1bmN0aW9uIHVucmVnaXN0ZXJGb3IoYWRkcmVzcyBfcmVnaXN0cmFudCwgYnl0ZXMzMiBfa2V5LCBhZGRyZXNzIF9hZGRyZXNzLCB1aW50IF90aW1lc3RhbXAsIHVpbnQgX2dhc0xpbWl0LCB1aW50IF9nYXNQcmljZSkgcHVibGljIG9ubHlQcm94eSByZXR1cm5zICh1aW50KSB7CiAgICAgICAgcmV0dXJuIGlubmVyVW5yZWdpc3RlcihfcmVnaXN0cmFudCwgX2tleSwgX2FkZHJlc3MsIF90aW1lc3RhbXAsIF9nYXNMaW1pdCwgX2dhc1ByaWNlKTsKICAgIH0KCiAgICBmdW5jdGlvbiBpbnZva2VGb3IoYWRkcmVzcyBfaW52b2tlcikgcHVibGljIG9ubHlQcm94eSByZXR1cm5zICh1aW50KSB7CiAgICAgICAgcmV0dXJuIGlubmVySW52b2tlKF9pbnZva2VyKTsKICAgIH0KCiAgICBmdW5jdGlvbiBpbnZva2VPbmNlRm9yKGFkZHJlc3MgX2ludm9rZXIpIHB1YmxpYyBvbmx5UHJveHkgcmV0dXJucyAodWludCkgewogICAgICAgIHJldHVybiBpbm5lckludm9rZU9uY2UoX2ludm9rZXIpOwogICAgfQoKICAgIGZ1bmN0aW9uIGludm9rZUNhbGxiYWNrKGFkZHJlc3MgX2ludm9rZXIsIEtleXNVdGlscy5PYmplY3QgbWVtb3J5IF9yZWNvcmQpIGludGVybmFsIHJldHVybnMgKGJvb2wpIHsKICAgICAgICByZXR1cm4gcHJveHkuY2FsbGJhY2soX2ludm9rZXIsIF9yZWNvcmQuY29udHJhY3RBZGRyZXNzLCBfcmVjb3JkLnRpbWVzdGFtcCwgX3JlY29yZC5nYXNMaW1pdCwgX3JlY29yZC5nYXNQcmljZUd3ZWkgKiBHV0VJKTsKICAgIH0KfQoKY29udHJhY3QgSm91bGVQcm94eSBpcyBKb3VsZVByb3h5QVBJLCBKb3VsZUFQSSwgT3duYWJsZSwgVHJhbnNmZXJUb2tlbiwgdXNpbmdDb25zdHMgewogICAgSm91bGVCZWhpbmRQcm94eSBwdWJsaWMgam91bGU7CgogICAgZnVuY3Rpb24gc2V0Sm91bGUoSm91bGVCZWhpbmRQcm94eSBfam91bGUpIHB1YmxpYyBvbmx5T3duZXIgewogICAgICAgIGpvdWxlID0gX2pvdWxlOwogICAgfQoKICAgIG1vZGlmaWVyIG9ubHlKb3VsZSgpIHsKICAgICAgICByZXF1aXJlKG1zZy5zZW5kZXIgPT0gYWRkcmVzcyhqb3VsZSkpOwogICAgICAgIF87CiAgICB9CgogICAgZnVuY3Rpb24gKCkgcHVibGljIHBheWFibGUgewogICAgfQoKICAgIGZ1bmN0aW9uIGdldENvdW50KCkgcHVibGljIHZpZXcgcmV0dXJucyAodWludCkgewogICAgICAgIHJldHVybiBqb3VsZS5nZXRDb3VudCgpOwogICAgfQoKICAgIGZ1bmN0aW9uIHJlZ2lzdGVyKGFkZHJlc3MgX2FkZHJlc3MsIHVpbnQgX3RpbWVzdGFtcCwgdWludCBfZ2FzTGltaXQsIHVpbnQgX2dhc1ByaWNlKSBleHRlcm5hbCBwYXlhYmxlIHJldHVybnMgKHVpbnQpIHsKICAgICAgICByZXR1cm4gcmVnaXN0ZXJGb3IobXNnLnNlbmRlciwgX2FkZHJlc3MsIF90aW1lc3RhbXAsIF9nYXNMaW1pdCwgX2dhc1ByaWNlKTsKICAgIH0KCiAgICBmdW5jdGlvbiByZWdpc3RlckZvcihhZGRyZXNzIF9yZWdpc3RyYW50LCBhZGRyZXNzIF9hZGRyZXNzLCB1aW50IF90aW1lc3RhbXAsIHVpbnQgX2dhc0xpbWl0LCB1aW50IF9nYXNQcmljZSkgcHVibGljIHBheWFibGUgcmV0dXJucyAodWludCkgewogICAgICAgIFJlZ2lzdGVyZWQoX3JlZ2lzdHJhbnQsIF9hZGRyZXNzLCBfdGltZXN0YW1wLCBfZ2FzTGltaXQsIF9nYXNQcmljZSk7CiAgICAgICAgdWludCBjaGFuZ2UgPSBqb3VsZS5yZWdpc3RlckZvci52YWx1ZShtc2cudmFsdWUpKF9yZWdpc3RyYW50LCBfYWRkcmVzcywgX3RpbWVzdGFtcCwgX2dhc0xpbWl0LCBfZ2FzUHJpY2UpOwogICAgICAgIGlmIChjaGFuZ2UgPiAwKSB7CiAgICAgICAgICAgIG1zZy5zZW5kZXIudHJhbnNmZXIoY2hhbmdlKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGNoYW5nZTsKICAgIH0KCiAgICBmdW5jdGlvbiB1bnJlZ2lzdGVyKGJ5dGVzMzIgX2tleSwgYWRkcmVzcyBfYWRkcmVzcywgdWludCBfdGltZXN0YW1wLCB1aW50IF9nYXNMaW1pdCwgdWludCBfZ2FzUHJpY2UpIGV4dGVybmFsIHJldHVybnMgKHVpbnQpIHsKICAgICAgICAvLyB1bnJlZ2lzdGVyIHdpbGwgcmV0dXJuIGZ1bmRzIHRvIHJlZ2lzdHJhbnQsIG5vdCB0byBtc2cuc2VuZGVyICh1bmxpa2UgcmVnaXN0ZXIpCiAgICAgICAgdWludCBhbW91bnQgPSBqb3VsZS51bnJlZ2lzdGVyRm9yKG1zZy5zZW5kZXIsIF9rZXksIF9hZGRyZXNzLCBfdGltZXN0YW1wLCBfZ2FzTGltaXQsIF9nYXNQcmljZSk7CiAgICAgICAgVW5yZWdpc3RlcmVkKG1zZy5zZW5kZXIsIF9hZGRyZXNzLCBfdGltZXN0YW1wLCBfZ2FzTGltaXQsIF9nYXNQcmljZSwgYW1vdW50KTsKICAgICAgICByZXR1cm4gYW1vdW50OwogICAgfQoKICAgIGZ1bmN0aW9uIGZpbmRLZXkoYWRkcmVzcyBfYWRkcmVzcywgdWludCBfdGltZXN0YW1wLCB1aW50IF9nYXNMaW1pdCwgdWludCBfZ2FzUHJpY2UpIHB1YmxpYyB2aWV3IHJldHVybnMgKGJ5dGVzMzIpIHsKICAgICAgICByZXR1cm4gam91bGUuZmluZEtleShfYWRkcmVzcywgX3RpbWVzdGFtcCwgX2dhc0xpbWl0LCBfZ2FzUHJpY2UpOwogICAgfQoKICAgIGZ1bmN0aW9uIGludm9rZSgpIHB1YmxpYyByZXR1cm5zICh1aW50KSB7CiAgICAgICAgcmV0dXJuIGludm9rZUZvcihtc2cuc2VuZGVyKTsKICAgIH0KCiAgICBmdW5jdGlvbiBpbnZva2VGb3IoYWRkcmVzcyBfaW52b2tlcikgcHVibGljIHJldHVybnMgKHVpbnQpIHsKICAgICAgICB1aW50IGFtb3VudCA9IGpvdWxlLmludm9rZUZvcihfaW52b2tlcik7CiAgICAgICAgaWYgKGFtb3VudCA+IDApIHsKICAgICAgICAgICAgbXNnLnNlbmRlci50cmFuc2ZlcihhbW91bnQpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYW1vdW50OwogICAgfQoKICAgIGZ1bmN0aW9uIGludm9rZU9uY2UoKSBwdWJsaWMgcmV0dXJucyAodWludCkgewogICAgICAgIHJldHVybiBpbnZva2VPbmNlRm9yKG1zZy5zZW5kZXIpOwogICAgfQoKICAgIGZ1bmN0aW9uIGludm9rZU9uY2VGb3IoYWRkcmVzcyBfaW52b2tlcikgcHVibGljIHJldHVybnMgKHVpbnQpIHsKICAgICAgICB1aW50IGFtb3VudCA9IGpvdWxlLmludm9rZU9uY2VGb3IoX2ludm9rZXIpOwogICAgICAgIGlmIChhbW91bnQgPiAwKSB7CiAgICAgICAgICAgIG1zZy5zZW5kZXIudHJhbnNmZXIoYW1vdW50KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGFtb3VudDsKICAgIH0KCgogICAgZnVuY3Rpb24gZ2V0UHJpY2UodWludCBfZ2FzTGltaXQsIHVpbnQgX2dhc1ByaWNlKSBleHRlcm5hbCB2aWV3IHJldHVybnMgKHVpbnQpIHsKICAgICAgICByZXR1cm4gam91bGUuZ2V0UHJpY2UoX2dhc0xpbWl0LCBfZ2FzUHJpY2UpOwogICAgfQoKICAgIGZ1bmN0aW9uIGdldFRvcE9uY2UoKSBleHRlcm5hbCB2aWV3IHJldHVybnMgKAogICAgICAgIGFkZHJlc3MgY29udHJhY3RBZGRyZXNzLAogICAgICAgIHVpbnQgdGltZXN0YW1wLAogICAgICAgIHVpbnQgZ2FzTGltaXQsCiAgICAgICAgdWludCBnYXNQcmljZSwKICAgICAgICB1aW50IGludm9rZUdhcywKICAgICAgICB1aW50IHJld2FyZEFtb3VudAogICAgKSB7CiAgICAgICAgKGNvbnRyYWN0QWRkcmVzcywgdGltZXN0YW1wLCBnYXNMaW1pdCwgZ2FzUHJpY2UsIGludm9rZUdhcywgcmV3YXJkQW1vdW50KSA9IGpvdWxlLmdldFRvcE9uY2UoKTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXROZXh0T25jZShhZGRyZXNzIF9jb250cmFjdEFkZHJlc3MsCiAgICAgICAgICAgICAgICAgICAgIHVpbnQgX3RpbWVzdGFtcCwKICAgICAgICAgICAgICAgICAgICAgdWludCBfZ2FzTGltaXQsCiAgICAgICAgICAgICAgICAgICAgIHVpbnQgX2dhc1ByaWNlKSBwdWJsaWMgdmlldyByZXR1cm5zICgKICAgICAgICBhZGRyZXNzIGNvbnRyYWN0QWRkcmVzcywKICAgICAgICB1aW50IHRpbWVzdGFtcCwKICAgICAgICB1aW50IGdhc0xpbWl0LAogICAgICAgIHVpbnQgZ2FzUHJpY2UsCiAgICAgICAgdWludCBpbnZva2VHYXMsCiAgICAgICAgdWludCByZXdhcmRBbW91bnQKICAgICkgewogICAgICAgIChjb250cmFjdEFkZHJlc3MsIHRpbWVzdGFtcCwgZ2FzTGltaXQsIGdhc1ByaWNlLCBpbnZva2VHYXMsIHJld2FyZEFtb3VudCkgPSBqb3VsZS5nZXROZXh0T25jZShfY29udHJhY3RBZGRyZXNzLCBfdGltZXN0YW1wLCBfZ2FzTGltaXQsIF9nYXNQcmljZSk7CiAgICB9CgoKICAgIGZ1bmN0aW9uIGdldE5leHQodWludCBfY291bnQsCiAgICAgICAgICAgICAgICAgICAgYWRkcmVzcyBfY29udHJhY3RBZGRyZXNzLAogICAgICAgICAgICAgICAgICAgIHVpbnQgX3RpbWVzdGFtcCwKICAgICAgICAgICAgICAgICAgICB1aW50IF9nYXNMaW1pdCwKICAgICAgICAgICAgICAgICAgICB1aW50IF9nYXNQcmljZSkgZXh0ZXJuYWwgdmlldyByZXR1cm5zICgKICAgICAgICBhZGRyZXNzW10gX2FkZHJlc3NlcywKICAgICAgICB1aW50W10gX3RpbWVzdGFtcHMsCiAgICAgICAgdWludFtdIF9nYXNMaW1pdHMsCiAgICAgICAgdWludFtdIF9nYXNQcmljZXMsCiAgICAgICAgdWludFtdIF9pbnZva2VHYXNlcywKICAgICAgICB1aW50W10gX3Jld2FyZEFtb3VudHMKICAgICkgewogICAgICAgIF9hZGRyZXNzZXMgPSBuZXcgYWRkcmVzc1tdKF9jb3VudCk7CiAgICAgICAgX3RpbWVzdGFtcHMgPSBuZXcgdWludFtdKF9jb3VudCk7CiAgICAgICAgX2dhc0xpbWl0cyA9IG5ldyB1aW50W10oX2NvdW50KTsKICAgICAgICBfZ2FzUHJpY2VzID0gbmV3IHVpbnRbXShfY291bnQpOwogICAgICAgIF9pbnZva2VHYXNlcyA9IG5ldyB1aW50W10oX2NvdW50KTsKICAgICAgICBfcmV3YXJkQW1vdW50cyA9IG5ldyB1aW50W10oX2NvdW50KTsKCiAgICAgICAgdWludCBpID0gMDsKCiAgICAgICAgKF9hZGRyZXNzZXNbaV0sIF90aW1lc3RhbXBzW2ldLCBfZ2FzTGltaXRzW2ldLCBfZ2FzUHJpY2VzW2ldLCBfaW52b2tlR2FzZXNbaV0sIF9yZXdhcmRBbW91bnRzW2ldKSA9IGpvdWxlLmdldE5leHRPbmNlKF9jb250cmFjdEFkZHJlc3MsIF90aW1lc3RhbXAsIF9nYXNMaW1pdCwgX2dhc1ByaWNlKTsKCiAgICAgICAgZm9yIChpICs9IDE7IGkgPCBfY291bnQ7IGkgKyspIHsKICAgICAgICAgICAgaWYgKF90aW1lc3RhbXBzW2kgLSAxXSA9PSAwKSB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICAoX2FkZHJlc3Nlc1tpXSwgX3RpbWVzdGFtcHNbaV0sIF9nYXNMaW1pdHNbaV0sIF9nYXNQcmljZXNbaV0sIF9pbnZva2VHYXNlc1tpXSwgX3Jld2FyZEFtb3VudHNbaV0pID0gam91bGUuZ2V0TmV4dE9uY2UoX2FkZHJlc3Nlc1tpIC0gMV0sIF90aW1lc3RhbXBzW2kgLSAxXSwgX2dhc0xpbWl0c1tpIC0gMV0sIF9nYXNQcmljZXNbaSAtIDFdKTsKICAgICAgICB9CiAgICB9CgoKICAgIGZ1bmN0aW9uIGdldFRvcCh1aW50IF9jb3VudCkgZXh0ZXJuYWwgdmlldyByZXR1cm5zICgKICAgICAgICBhZGRyZXNzW10gX2FkZHJlc3NlcywKICAgICAgICB1aW50W10gX3RpbWVzdGFtcHMsCiAgICAgICAgdWludFtdIF9nYXNMaW1pdHMsCiAgICAgICAgdWludFtdIF9nYXNQcmljZXMsCiAgICAgICAgdWludFtdIF9pbnZva2VHYXNlcywKICAgICAgICB1aW50W10gX3Jld2FyZEFtb3VudHMKICAgICkgewogICAgICAgIHVpbnQgbGVuZ3RoID0gam91bGUuZ2V0Q291bnQoKTsKICAgICAgICB1aW50IGFtb3VudCA9IF9jb3VudCA8PSBsZW5ndGggPyBfY291bnQgOiBsZW5ndGg7CgogICAgICAgIF9hZGRyZXNzZXMgPSBuZXcgYWRkcmVzc1tdKGFtb3VudCk7CiAgICAgICAgX3RpbWVzdGFtcHMgPSBuZXcgdWludFtdKGFtb3VudCk7CiAgICAgICAgX2dhc0xpbWl0cyA9IG5ldyB1aW50W10oYW1vdW50KTsKICAgICAgICBfZ2FzUHJpY2VzID0gbmV3IHVpbnRbXShhbW91bnQpOwogICAgICAgIF9pbnZva2VHYXNlcyA9IG5ldyB1aW50W10oYW1vdW50KTsKICAgICAgICBfcmV3YXJkQW1vdW50cyA9IG5ldyB1aW50W10oYW1vdW50KTsKCiAgICAgICAgdWludCBpID0gMDsKCiAgICAgICAgKF9hZGRyZXNzZXNbaV0sIF90aW1lc3RhbXBzW2ldLCBfZ2FzTGltaXRzW2ldLCBfZ2FzUHJpY2VzW2ldLCBfaW52b2tlR2FzZXNbaV0sIF9yZXdhcmRBbW91bnRzW2ldKSA9IGpvdWxlLmdldFRvcE9uY2UoKTsKCiAgICAgICAgZm9yIChpICs9IDE7IGkgPCBhbW91bnQ7IGkgKyspIHsKICAgICAgICAgICAgKF9hZGRyZXNzZXNbaV0sIF90aW1lc3RhbXBzW2ldLCBfZ2FzTGltaXRzW2ldLCBfZ2FzUHJpY2VzW2ldLCBfaW52b2tlR2FzZXNbaV0sIF9yZXdhcmRBbW91bnRzW2ldKSA9IGpvdWxlLmdldE5leHRPbmNlKF9hZGRyZXNzZXNbaSAtIDFdLCBfdGltZXN0YW1wc1tpIC0gMV0sIF9nYXNMaW1pdHNbaSAtIDFdLCBfZ2FzUHJpY2VzW2kgLSAxXSk7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGdldFZlcnNpb24oKSBleHRlcm5hbCB2aWV3IHJldHVybnMgKGJ5dGVzOCkgewogICAgICAgIHJldHVybiBqb3VsZS5nZXRWZXJzaW9uKCk7CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0TWluR2FzUHJpY2UoKSBwdWJsaWMgdmlldyByZXR1cm5zICh1aW50KSB7CiAgICAgICAgcmV0dXJuIGpvdWxlLm1pbkdhc1ByaWNlR3dlaSgpICogR1dFSTsKICAgIH0KCiAgICBmdW5jdGlvbiBjYWxsYmFjayhhZGRyZXNzIF9pbnZva2VyLCBhZGRyZXNzIF9hZGRyZXNzLCB1aW50LCB1aW50IF9nYXNMaW1pdCwgdWludCkgcHVibGljIG9ubHlKb3VsZSByZXR1cm5zIChib29sKSB7CiAgICAgICAgcmVxdWlyZShtc2cuZ2FzID49IF9nYXNMaW1pdCk7CiAgICAgICAgdWludCBnYXMgPSBtc2cuZ2FzOwogICAgICAgIGJvb2wgc3RhdHVzID0gX2FkZHJlc3MuY2FsbC5nYXMoX2dhc0xpbWl0KSgweDkxOTg0MGFkKTsKICAgICAgICBJbnZva2VkKF9pbnZva2VyLCBfYWRkcmVzcywgc3RhdHVzLCBnYXMgLSBtc2cuZ2FzKTsKICAgICAgICByZXR1cm4gc3RhdHVzOwogICAgfQp9'.
	

]
