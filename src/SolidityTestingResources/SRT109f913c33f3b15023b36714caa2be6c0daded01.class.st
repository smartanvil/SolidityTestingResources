Class {
	#name : #SRT109f913c33f3b15023b36714caa2be6c0daded01,
	#superclass : #SRTContracts,
	#category : #SolidityTestingResources
}

{ #category : #base64 }
SRT109f913c33f3b15023b36714caa2be6c0daded01 >> base64 [
	^ 'cHJhZ21hIHNvbGlkaXR5IF4wLjQuMjE7Ci8qKgogKiBNYXRoIG9wZXJhdGlvbnMgd2l0aCBzYWZldHkgY2hlY2tzCiAqLwpsaWJyYXJ5IFNhZmVNYXRoIHsKICBmdW5jdGlvbiBtdWwodWludCBhLCB1aW50IGIpIGludGVybmFsIHB1cmUgcmV0dXJucyAodWludCkgewogICAgdWludCBjID0gYSAqIGI7CiAgICBhc3NlcnQoYSA9PSAwIHx8IGMgLyBhID09IGIpOwogICAgcmV0dXJuIGM7CiAgfQoKICBmdW5jdGlvbiBkaXYodWludCBhLCB1aW50IGIpIGludGVybmFsIHB1cmUgcmV0dXJucyAodWludCkgewogICAgLy8gYXNzZXJ0KGIgPiAwKTsgLy8gU29saWRpdHkgYXV0b21hdGljYWxseSB0aHJvd3Mgd2hlbiBkaXZpZGluZyBieSAwCiAgICB1aW50IGMgPSBhIC8gYjsKICAgIC8vIGFzc2VydChhID09IGIgKiBjICsgYSAlIGIpOyAvLyBUaGVyZSBpcyBubyBjYXNlIGluIHdoaWNoIHRoaXMgZG9lc24ndCBob2xkCiAgICByZXR1cm4gYzsKICB9CgogIGZ1bmN0aW9uIHN1Yih1aW50IGEsIHVpbnQgYikgaW50ZXJuYWwgcHVyZSByZXR1cm5zICh1aW50KSB7CiAgICBhc3NlcnQoYiA8PSBhKTsKICAgIHJldHVybiBhIC0gYjsKICB9CgogIGZ1bmN0aW9uIGFkZCh1aW50IGEsIHVpbnQgYikgaW50ZXJuYWwgcHVyZSByZXR1cm5zICh1aW50KSB7CiAgICB1aW50IGMgPSBhICsgYjsKICAgIGFzc2VydChjID49IGEpOwogICAgcmV0dXJuIGM7CiAgfQoKICBmdW5jdGlvbiBtYXg2NCh1aW50NjQgYSwgdWludDY0IGIpIGludGVybmFsIHB1cmUgcmV0dXJucyAodWludDY0KSB7CiAgICByZXR1cm4gYSA+PSBiID8gYSA6IGI7CiAgfQoKICBmdW5jdGlvbiBtaW42NCh1aW50NjQgYSwgdWludDY0IGIpIGludGVybmFsIHB1cmUgcmV0dXJucyAodWludDY0KSB7CiAgICByZXR1cm4gYSA8IGIgPyBhIDogYjsKICB9CgogIGZ1bmN0aW9uIG1heDI1Nih1aW50MjU2IGEsIHVpbnQyNTYgYikgaW50ZXJuYWwgcHVyZSByZXR1cm5zICh1aW50MjU2KSB7CiAgICByZXR1cm4gYSA+PSBiID8gYSA6IGI7CiAgfQoKICBmdW5jdGlvbiBtaW4yNTYodWludDI1NiBhLCB1aW50MjU2IGIpIGludGVybmFsIHB1cmUgcmV0dXJucyAodWludDI1NikgewogICAgcmV0dXJuIGEgPCBiID8gYSA6IGI7CiAgfQp9CgovLyBFUkMyMCB0b2tlbiBpbnRlcmZhY2UgaXMgaW1wbGVtZW50ZWQgb25seSBwYXJ0aWFsbHkuCmludGVyZmFjZSB0b2tlblJlY2lwaWVudCB7IGZ1bmN0aW9uIHJlY2VpdmVBcHByb3ZhbChhZGRyZXNzIF9mcm9tLCB1aW50MjU2IF92YWx1ZSwgYWRkcmVzcyBfdG9rZW4sIGJ5dGVzIF9leHRyYURhdGEpIGV4dGVybmFsOyB9CgoKY29udHJhY3QgTmFtaVBvb2wgewogICAgdXNpbmcgU2FmZU1hdGggZm9yIHVpbnQyNTY7CiAgICAKICAgIGZ1bmN0aW9uIE5hbWlQb29sKGFkZHJlc3MgX2VzY3JvdywgYWRkcmVzcyBfbmFtaU11bHRpU2lnV2FsbGV0LCBhZGRyZXNzIF9uYW1pQWRkcmVzcykgcHVibGljIHsKICAgICAgICByZXF1aXJlKF9uYW1pTXVsdGlTaWdXYWxsZXQgIT0gMHgwKTsKICAgICAgICBlc2Nyb3cgPSBfZXNjcm93OwogICAgICAgIG5hbWlNdWx0aVNpZ1dhbGxldCA9IF9uYW1pTXVsdGlTaWdXYWxsZXQ7CiAgICAgICAgTmFtaUFkZHIgPSBfbmFtaUFkZHJlc3M7CiAgICB9CiAgICAKICAgIHN0cmluZyBwdWJsaWMgbmFtZSA9ICJOYW1pIFBvb2wiOwogICAgCiAgICAvLyBlc2Nyb3cgaGFzIGV4Y2x1c2l2ZSBwcml2ZWxlZ2VzIHRvIGNhbGwgYWRtaW5pc3RyYXRpdmUKICAgIC8vIGZ1bmN0aW9ucyBvbiB0aGlzIGNvbnRyYWN0LgogICAgYWRkcmVzcyBwdWJsaWMgZXNjcm93OwoKICAgIC8vIEdhdGhlcmVkIGZ1bmRzIGNhbiBiZSB3aXRoZHJhdyBvbmx5IHRvIG5hbWltdWx0aXNpZ3dhbGxldCdzIGFkZHJlc3MuCiAgICBhZGRyZXNzIHB1YmxpYyBuYW1pTXVsdGlTaWdXYWxsZXQ7CiAgICAKICAgIC8vLyBhZGRyZXNzIG9mIE5hbWkgdG9rZW4KICAgIGFkZHJlc3MgcHVibGljIE5hbWlBZGRyOwogICAgCiAgICBtb2RpZmllciBvbmx5RXNjcm93KCkgewogICAgICAgIHJlcXVpcmUobXNnLnNlbmRlciA9PSBlc2Nyb3cpOwogICAgICAgIF87CiAgICB9CiAgICAKICAgIG1vZGlmaWVyIG9ubHlOYW1pIHsKICAgICAgICByZXF1aXJlKG1zZy5zZW5kZXIgPT0gTmFtaUFkZHIpOwogICAgICAgIF87CiAgICB9CiAgICAKICAgIG1vZGlmaWVyIG9ubHlOYW1pTXVsdGlzaWcgewogICAgICAgIHJlcXVpcmUobXNnLnNlbmRlciA9PSBuYW1pTXVsdGlTaWdXYWxsZXQpOwogICAgICAgIF87CiAgICB9CiAgICAKICAgIHVpbnQgcHVibGljIGN1cnJlbnRSb3VuZCA9IDE7CiAgICAKICAgIHN0cnVjdCBTaGFyZUhvbGRlciB7CiAgICAgICAgdWludCBzdGFrZTsKICAgICAgICBib29sIGlzQWN0aXZlOwogICAgICAgIGJvb2wgaXNXaXRoZHJhd247CiAgICB9CiAgICAKICAgIHN0cnVjdCBSb3VuZCB7CiAgICAgICAgYm9vbCBpc09wZW47CiAgICAgICAgdWludCBjdXJyZW50TkFDOwogICAgICAgIHVpbnQgZmluYWxOQUM7CiAgICAgICAgdWludCBldGhCYWxhbmNlOwogICAgICAgIGJvb2wgd2l0aGRyYXdhYmxlOyAvL2ZvciB1c2VyIG5vdCBpbiB0b3AKICAgICAgICBib29sIHRvcFdpdGhkcmF3YWJsZTsKICAgICAgICBib29sIGlzQ29tcGxldGVBY3RpdmU7CiAgICAgICAgYm9vbCBpc0Nsb3NlRXRoUG9vbDsKICAgIH0KICAgIAogICAgbWFwcGluZyAodWludCA9PiBtYXBwaW5nIChhZGRyZXNzID0+IFNoYXJlSG9sZGVyKSkgcHVibGljIG5hbWlQb29sOwogICAgbWFwcGluZyAodWludCA9PiBSb3VuZCkgcHVibGljIHJvdW5kOwogICAgCiAgICAKICAgIC8vIEV2ZW50cwogICAgZXZlbnQgVXBkYXRlU2hhcmVIb2xkZXIoYWRkcmVzcyBpbmRleGVkIFNoYXJlSG9sZGVyQWRkcmVzcywgdWludCBpbmRleGVkIFJvdW5kSW5kZXgsIHVpbnQgU3Rha2UsIHVpbnQgVGltZSk7CiAgICBldmVudCBEZXBvc2l0KGFkZHJlc3Mgc2VuZGVyLHVpbnQgaW5kZXhlZCBSb3VuZEluZGV4LCB1aW50IHZhbHVlKTsKICAgIGV2ZW50IFdpdGhkcmF3UG9vbCh1aW50IEFtb3VudCwgdWludCBUaW1lV2l0aGRyYXcpOwogICAgZXZlbnQgVXBkYXRlQWN0aXZlKGFkZHJlc3MgaW5kZXhlZCBTaGFyZUhvbGRlckFkZHJlc3MsIHVpbnQgaW5kZXhlZCBSb3VuZEluZGV4LCBib29sIFN0YXR1cywgdWludCBUaW1lKTsKICAgIGV2ZW50IFdpdGhkcmF3KGFkZHJlc3MgaW5kZXhlZCBTaGFyZUhvbGRlckFkZHJlc3MsIHVpbnQgaW5kZXhlZCBSb3VuZEluZGV4LCB1aW50IEV0aGVyLCB1aW50IE5hYywgdWludCBUaW1lV2l0aGRyYXcpOwogICAgZXZlbnQgQWN0aXZhdGVSb3VuZCh1aW50IFJvdW5kSW5kZXgsIHVpbnQgVGltZUFjdGl2ZSk7CiAgICAKICAgIAogICAgZnVuY3Rpb24gY2hhbmdlRXNjcm93KGFkZHJlc3MgX2VzY3JvdykKICAgICAgICBvbmx5TmFtaU11bHRpc2lnCiAgICAgICAgcHVibGljCiAgICB7CiAgICAgICAgcmVxdWlyZShfZXNjcm93ICE9IDB4MCk7CiAgICAgICAgZXNjcm93ID0gX2VzY3JvdzsKICAgIH0KICAgIAogICAgZnVuY3Rpb24gd2l0aGRyYXdFdGhlcih1aW50IF9hbW91bnQpIHB1YmxpYwogICAgICAgIG9ubHlFc2Nyb3cKICAgIHsKICAgICAgICByZXF1aXJlKG5hbWlNdWx0aVNpZ1dhbGxldCAhPSAweDApOwogICAgICAgIC8vIAogICAgICAgIGlmIChhZGRyZXNzKHRoaXMpLmJhbGFuY2UgPiAwKSB7CiAgICAgICAgICAgIG5hbWlNdWx0aVNpZ1dhbGxldC50cmFuc2ZlcihfYW1vdW50KTsKICAgICAgICB9CiAgICB9CiAgICAKICAgIGZ1bmN0aW9uIHdpdGhkcmF3TkFDKHVpbnQgX2Ftb3VudCkgcHVibGljCiAgICAgICAgb25seUVzY3JvdwogICAgewogICAgICAgIHJlcXVpcmUobmFtaU11bHRpU2lnV2FsbGV0ICE9IDB4MCAmJiBfYW1vdW50ICE9IDApOwogICAgICAgIE5hbWlDcm93ZFNhbGUgbmFtaVRva2VuID0gTmFtaUNyb3dkU2FsZShOYW1pQWRkcik7CiAgICAgICAgaWYgKG5hbWlUb2tlbi5iYWxhbmNlT2YodGhpcykgPiAwKSB7CiAgICAgICAgICAgIG5hbWlUb2tlbi50cmFuc2ZlcihuYW1pTXVsdGlTaWdXYWxsZXQsIF9hbW91bnQpOwogICAgICAgIH0KICAgIH0KICAgIAogICAgCiAgICAvKi8KICAgICAqICBBZG1pbiBmdW5jdGlvbgogICAgLyovCiAgICAKICAgIC8qLyBwcm9jZXNzIG9mIG9uZSByb3VuZAogICAgICogc3RlcCAxOiBhZG1pbiBvcGVuIG9uZSByb3VuZCBieSBleGVjdXRlIGFjdGl2YXRlUm91bmQgZnVuY3Rpb24KICAgICAqIHN0ZXAgMjogbm93IGludmVzdG9yIGNhbiBpbnZlc3QgTmFjIHRvIE5hYyBQb29sIHVudGlsIHJvdW5kIGNsb3NlZAogICAgICogc3RlcCAzOiBhZG1pbiBjbG9zZSByb3VuZCwgbm93IGludmVzdG9yIGNhbm4ndCBpbnZlc3QgTkFDIHRvIFBvb2wKICAgICAqIHN0ZXAgNDogYWRtaW4gYWN0aXZhdGUgdG9wIGludmVzdG9yCiAgICAgKiBzdGVwIDU6IGFsbCB0b3AgaW52ZXN0b3Igd2FzIGFjdGl2YXRlZCwgYWRtaW4gZXhlY3V0ZSBjbG9zZUFjdGl2ZSBmdW5jdGlvbiB0byBjbG9zZSBhY3RpdmUgcGhyYXNlCiAgICAgKiBzdGVwIDY6IGFkbWluIG9wZW4gd2l0aGRyYXdhYmxlIGZvciBpbnZlc3RvciBub3QgaW4gdG9wIHRvIHdpdGhkcmF3IE5BQwogICAgICogc3RlcCA3OiBhZG1pbiBkZXBvc2l0IGV0aCB0byBldGggcG9vbAogICAgICogc3RlcCA4OiBjbG9zZSBkZXBvc2l0IGV0aCB0byBldGggcG9vbAogICAgICogc3RlcCA5OiBhZG1pbiBvcGVuIHdpdGhkcmF3YWJsZSB0byBpbnZlc3RvciBpbiB0b3AKICAgICAqIHN0ZXAgMTA6IGludmVzdG9yIGluIHRvcCBub3cgY2FuIHdpdGhkcmF3IE5BQyBhbmQgRVRIIGZvciB0aGlzIHJvdW5kCiAgICAvKi8KICAgIAogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIAogICAgLyoKICAgICogQWRtaW4gZnVuY3Rpb24KICAgICogT3BlbiBhbmQgQ2xvc2UgUm91bmQKICAgICoKICAgICovCiAgICBmdW5jdGlvbiBhY3RpdmF0ZVJvdW5kKHVpbnQgX3JvdW5kSW5kZXgpIAogICAgICAgIG9ubHlFc2Nyb3cKICAgICAgICBwdWJsaWMKICAgIHsKICAgICAgICByZXF1aXJlKHJvdW5kW19yb3VuZEluZGV4XS5pc09wZW4gPT0gZmFsc2UgJiYgcm91bmRbX3JvdW5kSW5kZXhdLmlzQ2xvc2VFdGhQb29sID09IGZhbHNlICYmIHJvdW5kW19yb3VuZEluZGV4XS5pc0NvbXBsZXRlQWN0aXZlID09IGZhbHNlKTsKICAgICAgICByb3VuZFtfcm91bmRJbmRleF0uaXNPcGVuID0gdHJ1ZTsKICAgICAgICBjdXJyZW50Um91bmQgPSBfcm91bmRJbmRleDsKICAgICAgICBlbWl0IEFjdGl2YXRlUm91bmQoX3JvdW5kSW5kZXgsIG5vdyk7CiAgICB9CiAgICAKICAgIGZ1bmN0aW9uIGRlYWN0aXZhdGVSb3VuZCh1aW50IF9yb3VuZEluZGV4KQogICAgICAgIG9ubHlFc2Nyb3cKICAgICAgICBwdWJsaWMKICAgIHsKICAgICAgICByZXF1aXJlKHJvdW5kW19yb3VuZEluZGV4XS5pc09wZW4gPT0gdHJ1ZSk7CiAgICAgICAgcm91bmRbX3JvdW5kSW5kZXhdLmlzT3BlbiA9IGZhbHNlOwogICAgfQogICAgCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gCiAgICAvLyB0aGlzIGZ1bmN0aW9uIGFkZCBzdGFrZSBvZiBTaGFyZUhvbGRlcgogICAgLy8gaW52ZXN0b3IgY2FuIGV4ZWN1dGUgdGhpcyBmdW5jdGlvbiBkdXJpbmcgcm91bmQgb3BlbgogICAgLy8KICAgIAogICAgZnVuY3Rpb24gdG9rZW5GYWxsYmFja0V4Y2hhbmdlKGFkZHJlc3MgX2Zyb20sIHVpbnQgX3ZhbHVlLCB1aW50IF9wcmljZSkgb25seU5hbWkgcHVibGljIHJldHVybnMgKGJvb2wgc3VjY2VzcykgewogICAgICAgIC8vIG9ubHkgb24gY3VycmVudFJvdW5kIGFuZCBhY3RpdmUgdXNlciBjYW4gYWRkIHN0YWtlCiAgICAgICAgcmVxdWlyZShyb3VuZFtfcHJpY2VdLmlzT3BlbiA9PSB0cnVlICYmIF92YWx1ZSA+IDApOwogICAgICAgIC8vIGFkZCBzdGFrZQogICAgICAgIG5hbWlQb29sW19wcmljZV1bX2Zyb21dLnN0YWtlID0gbmFtaVBvb2xbX3ByaWNlXVtfZnJvbV0uc3Rha2UuYWRkKF92YWx1ZSk7CiAgICAgICAgcm91bmRbX3ByaWNlXS5jdXJyZW50TkFDID0gcm91bmRbX3ByaWNlXS5jdXJyZW50TkFDLmFkZChfdmFsdWUpOwogICAgICAgIGVtaXQgVXBkYXRlU2hhcmVIb2xkZXIoX2Zyb20sIF9wcmljZSwgbmFtaVBvb2xbX3ByaWNlXVtfZnJvbV0uc3Rha2UsIG5vdyk7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICAKICAgIAogICAgLyoKICAgICoKICAgICogQWN0aXZhdGUgYW5kIGRlYWN0aXZhdGUgdXNlcgogICAgKiBhZGQgb3Igc3ViIGZpbmFsIE5hYyB0byBjb21wdXRlIHN0YWtlIHRvIHdpdGhkcmF3CiAgICAqLwogICAgZnVuY3Rpb24gYWN0aXZhdGVVc2VyKGFkZHJlc3MgX3NoYXJlQWRkcmVzcywgdWludCBfcm91bmRJZCkKICAgICAgICBvbmx5RXNjcm93CiAgICAgICAgcHVibGljCiAgICB7CiAgICAgICAgcmVxdWlyZShuYW1pUG9vbFtfcm91bmRJZF1bX3NoYXJlQWRkcmVzc10uaXNBY3RpdmUgPT0gZmFsc2UgJiYgbmFtaVBvb2xbX3JvdW5kSWRdW19zaGFyZUFkZHJlc3NdLnN0YWtlID4gMCk7CiAgICAgICAgcmVxdWlyZShyb3VuZFtfcm91bmRJZF0uaXNDb21wbGV0ZUFjdGl2ZSA9PSBmYWxzZSAmJiByb3VuZFtfcm91bmRJZF0uaXNPcGVuID09IGZhbHNlKTsKICAgICAgICBuYW1pUG9vbFtfcm91bmRJZF1bX3NoYXJlQWRkcmVzc10uaXNBY3RpdmUgPSB0cnVlOwogICAgICAgIHJvdW5kW19yb3VuZElkXS5maW5hbE5BQyA9IHJvdW5kW19yb3VuZElkXS5maW5hbE5BQy5hZGQobmFtaVBvb2xbX3JvdW5kSWRdW19zaGFyZUFkZHJlc3NdLnN0YWtlKTsKICAgICAgICBlbWl0IFVwZGF0ZUFjdGl2ZShfc2hhcmVBZGRyZXNzLCBfcm91bmRJZCAsbmFtaVBvb2xbX3JvdW5kSWRdW19zaGFyZUFkZHJlc3NdLmlzQWN0aXZlLCBub3cpOwogICAgfQogICAgCiAgICBmdW5jdGlvbiBkZWFjdGl2YXRlVXNlcihhZGRyZXNzIF9zaGFyZUFkZHJlc3MsIHVpbnQgX3JvdW5kSWQpCiAgICAgICAgb25seUVzY3JvdwogICAgICAgIHB1YmxpYwogICAgewogICAgICAgIHJlcXVpcmUobmFtaVBvb2xbX3JvdW5kSWRdW19zaGFyZUFkZHJlc3NdLmlzQWN0aXZlID09IHRydWUgJiYgbmFtaVBvb2xbX3JvdW5kSWRdW19zaGFyZUFkZHJlc3NdLnN0YWtlID4gMCk7CiAgICAgICAgcmVxdWlyZShyb3VuZFtfcm91bmRJZF0uaXNDb21wbGV0ZUFjdGl2ZSA9PSBmYWxzZSAmJiByb3VuZFtfcm91bmRJZF0uaXNPcGVuID09IGZhbHNlKTsKICAgICAgICBuYW1pUG9vbFtfcm91bmRJZF1bX3NoYXJlQWRkcmVzc10uaXNBY3RpdmUgPSBmYWxzZTsKICAgICAgICByb3VuZFtfcm91bmRJZF0uZmluYWxOQUMgPSByb3VuZFtfcm91bmRJZF0uZmluYWxOQUMuc3ViKG5hbWlQb29sW19yb3VuZElkXVtfc2hhcmVBZGRyZXNzXS5zdGFrZSk7CiAgICAgICAgZW1pdCBVcGRhdGVBY3RpdmUoX3NoYXJlQWRkcmVzcywgX3JvdW5kSWQgLG5hbWlQb29sW19yb3VuZElkXVtfc2hhcmVBZGRyZXNzXS5pc0FjdGl2ZSwgbm93KTsKICAgIH0KICAgIAogICAgCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gCiAgICAvLyBhZG1pbiBjbG9zZSBhY3RpdmF0ZSBwaHJhc2UgdG8gCiAgICAvLyAKICAgIC8vCiAgICBmdW5jdGlvbiBjbG9zZUFjdGl2ZSh1aW50IF9yb3VuZElkKQogICAgICAgIG9ubHlFc2Nyb3cKICAgICAgICBwdWJsaWMKICAgIHsKICAgICAgICByZXF1aXJlKHJvdW5kW19yb3VuZElkXS5pc0NvbXBsZXRlQWN0aXZlID09IGZhbHNlICYmIHJvdW5kW19yb3VuZElkXS5pc09wZW4gPT0gZmFsc2UpOwogICAgICAgIHJvdW5kW19yb3VuZElkXS5pc0NvbXBsZXRlQWN0aXZlID0gdHJ1ZTsKICAgIH0KICAgIC8vCiAgICAvLwogICAgLy8gY2hhbmdlIFdpdGhkcmF3YWJsZSBmb3Igb25lIHJvdW5kIGFmdGVyIGV2ZXJ5IG1vbnRoCiAgICAvLyBmb3IgaW52ZXN0b3Igbm90IGluIHRvcAogICAgLy8KICAgIGZ1bmN0aW9uIGNoYW5nZVdpdGhkcmF3YWJsZSh1aW50IF9yb3VuZEluZGV4KQogICAgICAgIG9ubHlFc2Nyb3cKICAgICAgICBwdWJsaWMKICAgIHsKICAgICAgICByZXF1aXJlKHJvdW5kW19yb3VuZEluZGV4XS5pc0NvbXBsZXRlQWN0aXZlID09IHRydWUgJiYgcm91bmRbX3JvdW5kSW5kZXhdLmlzT3BlbiA9PSBmYWxzZSk7CiAgICAgICAgcm91bmRbX3JvdW5kSW5kZXhdLndpdGhkcmF3YWJsZSA9ICFyb3VuZFtfcm91bmRJbmRleF0ud2l0aGRyYXdhYmxlOwogICAgfQogICAgCiAgICAKICAgIAogICAgLy8KICAgIC8vCiAgICAvLyBjaGFuZ2UgV2l0aGRyYXdhYmxlIGZvciBvbmUgcm91bmQgYWZ0ZXIgZXZlcnkgbW9udGgKICAgIC8vIGZvciBpbnZlc3RvciBpbiB0b3AKICAgIC8vCiAgICBmdW5jdGlvbiBjaGFuZ2VUb3BXaXRoZHJhd2FibGUodWludCBfcm91bmRJbmRleCkKICAgICAgICBvbmx5RXNjcm93CiAgICAgICAgcHVibGljCiAgICB7CiAgICAgICAgcmVxdWlyZShyb3VuZFtfcm91bmRJbmRleF0uaXNDb21wbGV0ZUFjdGl2ZSA9PSB0cnVlICYmIHJvdW5kW19yb3VuZEluZGV4XS5pc09wZW4gPT0gZmFsc2UpOwogICAgICAgIHJvdW5kW19yb3VuZEluZGV4XS50b3BXaXRoZHJhd2FibGUgPSAhcm91bmRbX3JvdW5kSW5kZXhdLnRvcFdpdGhkcmF3YWJsZTsKICAgIH0KICAgIAogICAgCiAgICAvLwogICAgLy8KICAgIC8vIGFmdGVyIG1vbnRoIGFkbWluIGRlcG9zaXQgRVRIIHRvIEVUSCBQb29sCiAgICAvLyAKICAgIC8vCiAgICBmdW5jdGlvbiBkZXBvc2l0RXRoUG9vbCh1aW50IF9yb3VuZEluZGV4KQogICAgICAgIHBheWFibGUgcHVibGljCiAgICAgICAgb25seUVzY3JvdwogICAgewogICAgICAgIHJlcXVpcmUobXNnLnZhbHVlID4gMCAmJiByb3VuZFtfcm91bmRJbmRleF0uaXNDbG9zZUV0aFBvb2wgPT0gZmFsc2UgJiYgcm91bmRbX3JvdW5kSW5kZXhdLmlzT3BlbiA9PSBmYWxzZSk7CiAgICAgICAgaWYgKG1zZy52YWx1ZSA+IDApIHsKICAgICAgICAgICAgcm91bmRbX3JvdW5kSW5kZXhdLmV0aEJhbGFuY2UgPSByb3VuZFtfcm91bmRJbmRleF0uZXRoQmFsYW5jZS5hZGQobXNnLnZhbHVlKTsKICAgICAgICAgICAgZW1pdCBEZXBvc2l0KG1zZy5zZW5kZXIsIF9yb3VuZEluZGV4LCBtc2cudmFsdWUpOwogICAgICAgIH0KICAgIH0KICAgIAogICAgLy8KICAgIC8vCiAgICBmdW5jdGlvbiB3aXRoZHJhd0V0aFBvb2wodWludCBfcm91bmRJbmRleCwgdWludCBfYW1vdW50KQogICAgICAgIHB1YmxpYwogICAgICAgIG9ubHlFc2Nyb3cKICAgIHsKICAgICAgICByZXF1aXJlKHJvdW5kW19yb3VuZEluZGV4XS5pc0Nsb3NlRXRoUG9vbCA9PSBmYWxzZSAmJiByb3VuZFtfcm91bmRJbmRleF0uaXNPcGVuID09IGZhbHNlKTsKICAgICAgICByZXF1aXJlKG5hbWlNdWx0aVNpZ1dhbGxldCAhPSAweDApOwogICAgICAgIC8vIAogICAgICAgIGlmIChfYW1vdW50ID4gMCkgewogICAgICAgICAgICBuYW1pTXVsdGlTaWdXYWxsZXQudHJhbnNmZXIoX2Ftb3VudCk7CiAgICAgICAgICAgIHJvdW5kW19yb3VuZEluZGV4XS5ldGhCYWxhbmNlID0gcm91bmRbX3JvdW5kSW5kZXhdLmV0aEJhbGFuY2Uuc3ViKF9hbW91bnQpOwogICAgICAgICAgICBlbWl0IFdpdGhkcmF3UG9vbChfYW1vdW50LCBub3cpOwogICAgICAgIH0KICAgIH0KICAgIAogICAgLy8KICAgIC8vIGNsb3NlIHBocmFzZSBkZXBvc2l0IEVUSCB0byBQb29sCiAgICAvLyAKICAgIGZ1bmN0aW9uIGNsb3NlRXRoUG9vbCh1aW50IF9yb3VuZEluZGV4KQogICAgICAgIHB1YmxpYwogICAgICAgIG9ubHlFc2Nyb3cKICAgIHsKICAgICAgICByZXF1aXJlKHJvdW5kW19yb3VuZEluZGV4XS5pc0Nsb3NlRXRoUG9vbCA9PSBmYWxzZSAmJiByb3VuZFtfcm91bmRJbmRleF0uaXNDb21wbGV0ZUFjdGl2ZSA9PSB0cnVlICYmIHJvdW5kW19yb3VuZEluZGV4XS5pc09wZW4gPT0gZmFsc2UpOwogICAgICAgIHJvdW5kW19yb3VuZEluZGV4XS5pc0Nsb3NlRXRoUG9vbCA9IHRydWU7CiAgICB9CiAgICAKICAgIC8vCiAgICAvLwogICAgLy8gd2l0aGRyYXcgTkFDIGZvciBpbnZlc3RvcgogICAgLy8gaW50ZXJuYWwgZnVuY3Rpb24gb25seSBjYW4gcnVuIGJ5IHRoaXMgc21hcnRjb250cmFjdAogICAgLy8gCiAgICAvLwogICAgZnVuY3Rpb24gX3dpdGhkcmF3TkFDKGFkZHJlc3MgX3NoYXJlQWRkcmVzcywgdWludCBfcm91bmRJbmRleCkgaW50ZXJuYWwgewogICAgICAgIHJlcXVpcmUobmFtaVBvb2xbX3JvdW5kSW5kZXhdW19zaGFyZUFkZHJlc3NdLnN0YWtlID4gMCk7CiAgICAgICAgTmFtaUNyb3dkU2FsZSBuYW1pVG9rZW4gPSBOYW1pQ3Jvd2RTYWxlKE5hbWlBZGRyKTsKICAgICAgICB1aW50IHByZXZpb3VzQmFsYW5jZXMgPSBuYW1pVG9rZW4uYmFsYW5jZU9mKHRoaXMpOwogICAgICAgIG5hbWlUb2tlbi50cmFuc2Zlcihfc2hhcmVBZGRyZXNzLCBuYW1pUG9vbFtfcm91bmRJbmRleF1bX3NoYXJlQWRkcmVzc10uc3Rha2UpOwogICAgICAgIC8vIHVwZGF0ZSBjdXJyZW50IE5hYyBwb29sIGJhbGFuY2UKICAgICAgICByb3VuZFtfcm91bmRJbmRleF0uY3VycmVudE5BQyA9IHJvdW5kW19yb3VuZEluZGV4XS5jdXJyZW50TkFDLnN1YihuYW1pUG9vbFtfcm91bmRJbmRleF1bX3NoYXJlQWRkcmVzc10uc3Rha2UpOwogICAgICAgIAogICAgICAgIG5hbWlQb29sW19yb3VuZEluZGV4XVtfc2hhcmVBZGRyZXNzXS5zdGFrZSA9IDA7CiAgICAgICAgYXNzZXJ0KHByZXZpb3VzQmFsYW5jZXMgPiBuYW1pVG9rZW4uYmFsYW5jZU9mKHRoaXMpKTsKICAgIH0KICAgIAogICAgCiAgICAvLwogICAgLy8KICAgIC8vIHdpdGhkcmF3IE5BQyBhbmQgRVRIIGZvciB0b3AgaW52ZXN0b3IKICAgIC8vIAogICAgLy8KICAgIGZ1bmN0aW9uIHdpdGhkcmF3VG9wRm9yVGVhbShhZGRyZXNzIF9zaGFyZUFkZHJlc3MsIHVpbnQgX3JvdW5kSW5kZXgpCiAgICAgICAgb25seUVzY3JvdwogICAgICAgIHB1YmxpYwogICAgewogICAgICAgIHJlcXVpcmUocm91bmRbX3JvdW5kSW5kZXhdLmlzQ29tcGxldGVBY3RpdmUgPT0gdHJ1ZSAmJiByb3VuZFtfcm91bmRJbmRleF0uaXNDbG9zZUV0aFBvb2wgPT0gdHJ1ZSAmJiByb3VuZFtfcm91bmRJbmRleF0uaXNPcGVuID09IGZhbHNlKTsKICAgICAgICByZXF1aXJlKHJvdW5kW19yb3VuZEluZGV4XS50b3BXaXRoZHJhd2FibGUpOwogICAgICAgIGlmKG5hbWlQb29sW19yb3VuZEluZGV4XVtfc2hhcmVBZGRyZXNzXS5pc0FjdGl2ZSA9PSB0cnVlKSB7CiAgICAgICAgICAgIHJlcXVpcmUobmFtaVBvb2xbX3JvdW5kSW5kZXhdW19zaGFyZUFkZHJlc3NdLmlzV2l0aGRyYXduID09IGZhbHNlKTsKICAgICAgICAgICAgYXNzZXJ0KHJvdW5kW19yb3VuZEluZGV4XS5maW5hbE5BQyA+IG5hbWlQb29sW19yb3VuZEluZGV4XVtfc2hhcmVBZGRyZXNzXS5zdGFrZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBjb21wdXRlIGV0aCBmb3IgaW52ZXN0ZXIKICAgICAgICAgICAgdWludCBldGhSZXR1cm4gPSAocm91bmRbX3JvdW5kSW5kZXhdLmV0aEJhbGFuY2UubXVsKG5hbWlQb29sW19yb3VuZEluZGV4XVtfc2hhcmVBZGRyZXNzXS5zdGFrZSkpLmRpdihyb3VuZFtfcm91bmRJbmRleF0uZmluYWxOQUMpOwogICAgICAgICAgICBfc2hhcmVBZGRyZXNzLnRyYW5zZmVyKGV0aFJldHVybik7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBzZXQgdXNlciB3aXRoZHJhdwogICAgICAgICAgICBuYW1pUG9vbFtfcm91bmRJbmRleF1bX3NoYXJlQWRkcmVzc10uaXNXaXRoZHJhd24gPSB0cnVlOwogICAgICAgICAgICBlbWl0IFdpdGhkcmF3KF9zaGFyZUFkZHJlc3MsIF9yb3VuZEluZGV4LCBldGhSZXR1cm4sIG5hbWlQb29sW19yb3VuZEluZGV4XVtfc2hhcmVBZGRyZXNzXS5zdGFrZSwgbm93KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIHdpdGhkcmF3IE5BQwogICAgICAgICAgICBfd2l0aGRyYXdOQUMoX3NoYXJlQWRkcmVzcywgX3JvdW5kSW5kZXgpOwogICAgICAgIH0KICAgIH0KICAgIAogICAgCiAgICAKICAgIAogICAgLy8KICAgIC8vCiAgICAvLyB3aXRoZHJhdyBOQUMgYW5kIEVUSCBmb3Igbm9uIHRvcCBpbnZlc3RvcgogICAgLy8gZXhlY3V0ZSBieSBhZG1pbiBvbmx5CiAgICAvLyAKICAgIC8vCiAgICBmdW5jdGlvbiB3aXRoZHJhd05vblRvcEZvclRlYW0oYWRkcmVzcyBfc2hhcmVBZGRyZXNzLCB1aW50IF9yb3VuZEluZGV4KQogICAgICAgIG9ubHlFc2Nyb3cKICAgICAgICBwdWJsaWMKICAgIHsKICAgICAgICByZXF1aXJlKHJvdW5kW19yb3VuZEluZGV4XS5pc0NvbXBsZXRlQWN0aXZlID09IHRydWUgJiYgcm91bmRbX3JvdW5kSW5kZXhdLmlzT3BlbiA9PSBmYWxzZSk7CiAgICAgICAgcmVxdWlyZShyb3VuZFtfcm91bmRJbmRleF0ud2l0aGRyYXdhYmxlKTsKICAgICAgICBpZihuYW1pUG9vbFtfcm91bmRJbmRleF1bX3NoYXJlQWRkcmVzc10uaXNBY3RpdmUgPT0gZmFsc2UpIHsKICAgICAgICAgICAgcmVxdWlyZShuYW1pUG9vbFtfcm91bmRJbmRleF1bX3NoYXJlQWRkcmVzc10uaXNXaXRoZHJhd24gPT0gZmFsc2UpOwogICAgICAgICAgICAvLyBzZXQgc3RhdGUgdXNlciB3aXRoZHJhdwogICAgICAgICAgICBuYW1pUG9vbFtfcm91bmRJbmRleF1bX3NoYXJlQWRkcmVzc10uaXNXaXRoZHJhd24gPSB0cnVlOwogICAgICAgICAgICBlbWl0IFdpdGhkcmF3KF9zaGFyZUFkZHJlc3MsIF9yb3VuZEluZGV4LCAwLCBuYW1pUG9vbFtfcm91bmRJbmRleF1bX3NoYXJlQWRkcmVzc10uc3Rha2UsIG5vdyk7CiAgICAgICAgICAgIC8vCiAgICAgICAgICAgIF93aXRoZHJhd05BQyhfc2hhcmVBZGRyZXNzLCBfcm91bmRJbmRleCk7CiAgICAgICAgfQogICAgfQogICAgCiAgICAKICAgIAogICAgLy8KICAgIC8vCiAgICAvLyB3aXRoZHJhdyBOQUMgYW5kIEVUSCBmb3IgdG9wIGludmVzdG9yCiAgICAvLyBleGVjdXRlIGJ5IGludmVzdG9yCiAgICAvLyAKICAgIC8vCiAgICBmdW5jdGlvbiB3aXRoZHJhd1RvcCh1aW50IF9yb3VuZEluZGV4KQogICAgICAgIHB1YmxpYwogICAgewogICAgICAgIHJlcXVpcmUocm91bmRbX3JvdW5kSW5kZXhdLmlzQ29tcGxldGVBY3RpdmUgPT0gdHJ1ZSAmJiByb3VuZFtfcm91bmRJbmRleF0uaXNDbG9zZUV0aFBvb2wgPT0gdHJ1ZSAmJiByb3VuZFtfcm91bmRJbmRleF0uaXNPcGVuID09IGZhbHNlKTsKICAgICAgICByZXF1aXJlKHJvdW5kW19yb3VuZEluZGV4XS50b3BXaXRoZHJhd2FibGUpOwogICAgICAgIGlmKG5hbWlQb29sW19yb3VuZEluZGV4XVttc2cuc2VuZGVyXS5pc0FjdGl2ZSA9PSB0cnVlKSB7CiAgICAgICAgICAgIHJlcXVpcmUobmFtaVBvb2xbX3JvdW5kSW5kZXhdW21zZy5zZW5kZXJdLmlzV2l0aGRyYXduID09IGZhbHNlKTsKICAgICAgICAgICAgdWludCBldGhSZXR1cm4gPSAocm91bmRbX3JvdW5kSW5kZXhdLmV0aEJhbGFuY2UubXVsKG5hbWlQb29sW19yb3VuZEluZGV4XVttc2cuc2VuZGVyXS5zdGFrZSkpLmRpdihyb3VuZFtfcm91bmRJbmRleF0uZmluYWxOQUMpOwogICAgICAgICAgICBtc2cuc2VuZGVyLnRyYW5zZmVyKGV0aFJldHVybik7CiAgICAgICAgICAgIC8vIHNldCB1c2VyIHdpdGhkcmF3CiAgICAgICAgICAgIG5hbWlQb29sW19yb3VuZEluZGV4XVttc2cuc2VuZGVyXS5pc1dpdGhkcmF3biA9IHRydWU7CiAgICAgICAgICAgIC8vCiAgICAgICAgICAgIGVtaXQgV2l0aGRyYXcobXNnLnNlbmRlciwgX3JvdW5kSW5kZXgsIGV0aFJldHVybiwgbmFtaVBvb2xbX3JvdW5kSW5kZXhdW21zZy5zZW5kZXJdLnN0YWtlLCBub3cpOwogICAgICAgICAgICBfd2l0aGRyYXdOQUMobXNnLnNlbmRlciwgX3JvdW5kSW5kZXgpOwogICAgICAgIH0KICAgIH0KICAgIAogICAgLy8KICAgIC8vCiAgICAvLyB3aXRoZHJhdyBOQUMgYW5kIEVUSCBmb3Igbm9uIHRvcCBpbnZlc3RvcgogICAgLy8gZXhlY3V0ZSBieSBpbnZlc3RvcgogICAgLy8gCiAgICAvLwogICAgZnVuY3Rpb24gd2l0aGRyYXdOb25Ub3AodWludCBfcm91bmRJbmRleCkKICAgICAgICBwdWJsaWMKICAgIHsKICAgICAgICByZXF1aXJlKHJvdW5kW19yb3VuZEluZGV4XS5pc0NvbXBsZXRlQWN0aXZlID09IHRydWUgJiYgcm91bmRbX3JvdW5kSW5kZXhdLmlzT3BlbiA9PSBmYWxzZSk7CiAgICAgICAgcmVxdWlyZShyb3VuZFtfcm91bmRJbmRleF0ud2l0aGRyYXdhYmxlKTsKICAgICAgICBpZihuYW1pUG9vbFtfcm91bmRJbmRleF1bbXNnLnNlbmRlcl0uaXNBY3RpdmUgPT0gZmFsc2UpIHsKICAgICAgICAgICAgcmVxdWlyZShuYW1pUG9vbFtfcm91bmRJbmRleF1bbXNnLnNlbmRlcl0uaXNXaXRoZHJhd24gPT0gZmFsc2UpOwogICAgICAgICAgICBuYW1pUG9vbFtfcm91bmRJbmRleF1bbXNnLnNlbmRlcl0uaXNXaXRoZHJhd24gPSB0cnVlOwogICAgICAgICAgICAvLwogICAgICAgICAgICBlbWl0IFdpdGhkcmF3KG1zZy5zZW5kZXIsIF9yb3VuZEluZGV4LCAwLCBuYW1pUG9vbFtfcm91bmRJbmRleF1bbXNnLnNlbmRlcl0uc3Rha2UsIG5vdyk7CiAgICAgICAgICAgIF93aXRoZHJhd05BQyhtc2cuc2VuZGVyLCBfcm91bmRJbmRleCk7CiAgICAgICAgfQogICAgfQogICAgCn0KCmNvbnRyYWN0IE5hbWlDcm93ZFNhbGUgewogICAgdXNpbmcgU2FmZU1hdGggZm9yIHVpbnQyNTY7CgogICAgLy8vIE5BQyBCcm9rZXIgUHJlc2FsZSBUb2tlbgogICAgLy8vIEBkZXYgQ29uc3RydWN0b3IKICAgIGZ1bmN0aW9uIE5hbWlDcm93ZFNhbGUoYWRkcmVzcyBfZXNjcm93LCBhZGRyZXNzIF9uYW1pTXVsdGlTaWdXYWxsZXQsIGFkZHJlc3MgX25hbWlQcmVzYWxlKSBwdWJsaWMgewogICAgICAgIHJlcXVpcmUoX25hbWlNdWx0aVNpZ1dhbGxldCAhPSAweDApOwogICAgICAgIGVzY3JvdyA9IF9lc2Nyb3c7CiAgICAgICAgbmFtaU11bHRpU2lnV2FsbGV0ID0gX25hbWlNdWx0aVNpZ1dhbGxldDsKICAgICAgICBuYW1pUHJlc2FsZSA9IF9uYW1pUHJlc2FsZTsKICAgIH0KCgogICAgLyovCiAgICAgKiAgQ29uc3RhbnRzCiAgICAvKi8KCiAgICBzdHJpbmcgcHVibGljIG5hbWUgPSAiTmFtaSBJQ08iOwogICAgc3RyaW5nIHB1YmxpYyAgc3ltYm9sID0gIk5BQyI7CiAgICB1aW50ICAgcHVibGljIGRlY2ltYWxzID0gMTg7CgogICAgYm9vbCBwdWJsaWMgVFJBTlNGRVJBQkxFID0gZmFsc2U7IC8vIGRlZmF1bHQgbm90IHRyYW5zZmVyYWJsZQoKICAgIHVpbnQgcHVibGljIGNvbnN0YW50IFRPS0VOX1NVUFBMWV9MSU1JVCA9IDEwMDAwMDAwMDAgKiAoMSBldGhlciAvIDEgd2VpKTsKICAgIAogICAgdWludCBwdWJsaWMgYmluYXJ5ID0gMDsKCiAgICAvKi8KICAgICAqICBUb2tlbiBzdGF0ZQogICAgLyovCgogICAgZW51bSBQaGFzZSB7CiAgICAgICAgQ3JlYXRlZCwKICAgICAgICBSdW5uaW5nLAogICAgICAgIFBhdXNlZCwKICAgICAgICBNaWdyYXRpbmcsCiAgICAgICAgTWlncmF0ZWQKICAgIH0KCiAgICBQaGFzZSBwdWJsaWMgY3VycmVudFBoYXNlID0gUGhhc2UuQ3JlYXRlZDsKICAgIHVpbnQgcHVibGljIHRvdGFsU3VwcGx5ID0gMDsgLy8gYW1vdW50IG9mIHRva2VucyBhbHJlYWR5IHNvbGQKCiAgICAvLyBlc2Nyb3cgaGFzIGV4Y2x1c2l2ZSBwcml2ZWxlZ2VzIHRvIGNhbGwgYWRtaW5pc3RyYXRpdmUKICAgIC8vIGZ1bmN0aW9ucyBvbiB0aGlzIGNvbnRyYWN0LgogICAgYWRkcmVzcyBwdWJsaWMgZXNjcm93OwoKICAgIC8vIEdhdGhlcmVkIGZ1bmRzIGNhbiBiZSB3aXRoZHJhdyBvbmx5IHRvIG5hbWltdWx0aXNpZ3dhbGxldCdzIGFkZHJlc3MuCiAgICBhZGRyZXNzIHB1YmxpYyBuYW1pTXVsdGlTaWdXYWxsZXQ7CgogICAgLy8gbmFtaSBwcmVzYWxlIGNvbnRyYWN0CiAgICBhZGRyZXNzIHB1YmxpYyBuYW1pUHJlc2FsZTsKCiAgICAvLyBDcm93ZHNhbGUgbWFuYWdlciBoYXMgZXhjbHVzaXZlIHByaXZlbGVnZXMgdG8gYnVybiBwcmVzYWxlIHRva2Vucy4KICAgIGFkZHJlc3MgcHVibGljIGNyb3dkc2FsZU1hbmFnZXI7CiAgICAKICAgIC8vIGJpbmFyeSBvcHRpb24gYWRkcmVzcwogICAgYWRkcmVzcyBwdWJsaWMgYmluYXJ5QWRkcmVzczsKICAgIAogICAgLy8gVGhpcyBjcmVhdGVzIGFuIGFycmF5IHdpdGggYWxsIGJhbGFuY2VzCiAgICBtYXBwaW5nIChhZGRyZXNzID0+IHVpbnQyNTYpIHB1YmxpYyBiYWxhbmNlT2Y7CiAgICBtYXBwaW5nIChhZGRyZXNzID0+IG1hcHBpbmcgKGFkZHJlc3MgPT4gdWludDI1NikpIHB1YmxpYyBhbGxvd2FuY2U7CgogICAgbW9kaWZpZXIgb25seUNyb3dkc2FsZU1hbmFnZXIoKSB7CiAgICAgICAgcmVxdWlyZShtc2cuc2VuZGVyID09IGNyb3dkc2FsZU1hbmFnZXIpOyAKICAgICAgICBfOyAKICAgIH0KCiAgICBtb2RpZmllciBvbmx5RXNjcm93KCkgewogICAgICAgIHJlcXVpcmUobXNnLnNlbmRlciA9PSBlc2Nyb3cpOwogICAgICAgIF87CiAgICB9CiAgICAKICAgIG1vZGlmaWVyIG9ubHlUcmFuZmVyYWJsZSgpIHsKICAgICAgICByZXF1aXJlKFRSQU5TRkVSQUJMRSk7CiAgICAgICAgXzsKICAgIH0KICAgIAogICAgbW9kaWZpZXIgb25seU5hbWlNdWx0aXNpZygpIHsKICAgICAgICByZXF1aXJlKG1zZy5zZW5kZXIgPT0gbmFtaU11bHRpU2lnV2FsbGV0KTsKICAgICAgICBfOwogICAgfQogICAgCiAgICAvKi8KICAgICAqICBFdmVudHMKICAgIC8qLwoKICAgIGV2ZW50IExvZ0J1eShhZGRyZXNzIGluZGV4ZWQgb3duZXIsIHVpbnQgdmFsdWUpOwogICAgZXZlbnQgTG9nQnVybihhZGRyZXNzIGluZGV4ZWQgb3duZXIsIHVpbnQgdmFsdWUpOwogICAgZXZlbnQgTG9nUGhhc2VTd2l0Y2goUGhhc2UgbmV3UGhhc2UpOwogICAgLy8gTG9nIG1pZ3JhdGUgdG9rZW4KICAgIGV2ZW50IExvZ01pZ3JhdGUoYWRkcmVzcyBfZnJvbSwgYWRkcmVzcyBfdG8sIHVpbnQyNTYgYW1vdW50KTsKICAgIC8vIFRoaXMgZ2VuZXJhdGVzIGEgcHVibGljIGV2ZW50IG9uIHRoZSBibG9ja2NoYWluIHRoYXQgd2lsbCBub3RpZnkgY2xpZW50cwogICAgZXZlbnQgVHJhbnNmZXIoYWRkcmVzcyBpbmRleGVkIGZyb20sIGFkZHJlc3MgaW5kZXhlZCB0bywgdWludDI1NiB2YWx1ZSk7CgogICAgLyovCiAgICAgKiAgUHVibGljIGZ1bmN0aW9ucwogICAgLyovCgogICAgLyoqCiAgICAgKiBJbnRlcm5hbCB0cmFuc2Zlciwgb25seSBjYW4gYmUgY2FsbGVkIGJ5IHRoaXMgY29udHJhY3QKICAgICAqLwogICAgZnVuY3Rpb24gX3RyYW5zZmVyKGFkZHJlc3MgX2Zyb20sIGFkZHJlc3MgX3RvLCB1aW50IF92YWx1ZSkgaW50ZXJuYWwgewogICAgICAgIC8vIFByZXZlbnQgdHJhbnNmZXIgdG8gMHgwIGFkZHJlc3MuIFVzZSBidXJuKCkgaW5zdGVhZAogICAgICAgIHJlcXVpcmUoX3RvICE9IDB4MCk7CiAgICAgICAgLy8gQ2hlY2sgaWYgdGhlIHNlbmRlciBoYXMgZW5vdWdoCiAgICAgICAgcmVxdWlyZShiYWxhbmNlT2ZbX2Zyb21dID49IF92YWx1ZSk7CiAgICAgICAgLy8gQ2hlY2sgZm9yIG92ZXJmbG93cwogICAgICAgIHJlcXVpcmUoYmFsYW5jZU9mW190b10gKyBfdmFsdWUgPiBiYWxhbmNlT2ZbX3RvXSk7CiAgICAgICAgLy8gU2F2ZSB0aGlzIGZvciBhbiBhc3NlcnRpb24gaW4gdGhlIGZ1dHVyZQogICAgICAgIHVpbnQgcHJldmlvdXNCYWxhbmNlcyA9IGJhbGFuY2VPZltfZnJvbV0gKyBiYWxhbmNlT2ZbX3RvXTsKICAgICAgICAvLyBTdWJ0cmFjdCBmcm9tIHRoZSBzZW5kZXIKICAgICAgICBiYWxhbmNlT2ZbX2Zyb21dIC09IF92YWx1ZTsKICAgICAgICAvLyBBZGQgdGhlIHNhbWUgdG8gdGhlIHJlY2lwaWVudAogICAgICAgIGJhbGFuY2VPZltfdG9dICs9IF92YWx1ZTsKICAgICAgICBlbWl0IFRyYW5zZmVyKF9mcm9tLCBfdG8sIF92YWx1ZSk7CiAgICAgICAgLy8gQXNzZXJ0cyBhcmUgdXNlZCB0byB1c2Ugc3RhdGljIGFuYWx5c2lzIHRvIGZpbmQgYnVncyBpbiB5b3VyIGNvZGUuIFRoZXkgc2hvdWxkIG5ldmVyIGZhaWwKICAgICAgICBhc3NlcnQoYmFsYW5jZU9mW19mcm9tXSArIGJhbGFuY2VPZltfdG9dID09IHByZXZpb3VzQmFsYW5jZXMpOwogICAgfQoKICAgIC8vIFRyYW5zZmVyIHRoZSBiYWxhbmNlIGZyb20gb3duZXIncyBhY2NvdW50IHRvIGFub3RoZXIgYWNjb3VudAogICAgLy8gb25seSBlc2Nyb3cgY2FuIHNlbmQgdG9rZW4gKHRvIHNlbmQgdG9rZW4gcHJpdmF0ZSBzYWxlKQogICAgZnVuY3Rpb24gdHJhbnNmZXJGb3JUZWFtKGFkZHJlc3MgX3RvLCB1aW50MjU2IF92YWx1ZSkgcHVibGljCiAgICAgICAgb25seUVzY3JvdwogICAgewogICAgICAgIF90cmFuc2Zlcihtc2cuc2VuZGVyLCBfdG8sIF92YWx1ZSk7CiAgICB9CiAgICAKICAgIC8qKgogICAgICogVHJhbnNmZXIgdG9rZW5zCiAgICAgKgogICAgICogU2VuZCBgX3ZhbHVlYCB0b2tlbnMgdG8gYF90b2AgZnJvbSB5b3VyIGFjY291bnQKICAgICAqCiAgICAgKiBAcGFyYW0gX3RvIFRoZSBhZGRyZXNzIG9mIHRoZSByZWNpcGllbnQKICAgICAqIEBwYXJhbSBfdmFsdWUgdGhlIGFtb3VudCB0byBzZW5kCiAgICAgKi8KICAgIGZ1bmN0aW9uIHRyYW5zZmVyKGFkZHJlc3MgX3RvLCB1aW50MjU2IF92YWx1ZSkgcHVibGljCiAgICAgICAgb25seVRyYW5mZXJhYmxlCiAgICB7CiAgICAgICAgX3RyYW5zZmVyKG1zZy5zZW5kZXIsIF90bywgX3ZhbHVlKTsKICAgIH0KICAgIAogICAgICAgLyoqCiAgICAgKiBUcmFuc2ZlciB0b2tlbnMgZnJvbSBvdGhlciBhZGRyZXNzCiAgICAgKgogICAgICogU2VuZCBgX3ZhbHVlYCB0b2tlbnMgdG8gYF90b2AgaW4gYmVoYWxmIG9mIGBfZnJvbWAKICAgICAqCiAgICAgKiBAcGFyYW0gX2Zyb20gVGhlIGFkZHJlc3Mgb2YgdGhlIHNlbmRlcgogICAgICogQHBhcmFtIF90byBUaGUgYWRkcmVzcyBvZiB0aGUgcmVjaXBpZW50CiAgICAgKiBAcGFyYW0gX3ZhbHVlIHRoZSBhbW91bnQgdG8gc2VuZAogICAgICovCiAgICBmdW5jdGlvbiB0cmFuc2ZlckZyb20oYWRkcmVzcyBfZnJvbSwgYWRkcmVzcyBfdG8sIHVpbnQyNTYgX3ZhbHVlKSAKICAgICAgICBwdWJsaWMKICAgICAgICBvbmx5VHJhbmZlcmFibGUKICAgICAgICByZXR1cm5zIChib29sIHN1Y2Nlc3MpCiAgICB7CiAgICAgICAgcmVxdWlyZShfdmFsdWUgPD0gYWxsb3dhbmNlW19mcm9tXVttc2cuc2VuZGVyXSk7ICAgICAvLyBDaGVjayBhbGxvd2FuY2UKICAgICAgICBhbGxvd2FuY2VbX2Zyb21dW21zZy5zZW5kZXJdIC09IF92YWx1ZTsKICAgICAgICBfdHJhbnNmZXIoX2Zyb20sIF90bywgX3ZhbHVlKTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICAvKioKICAgICAqIFNldCBhbGxvd2FuY2UgZm9yIG90aGVyIGFkZHJlc3MKICAgICAqCiAgICAgKiBBbGxvd3MgYF9zcGVuZGVyYCB0byBzcGVuZCBubyBtb3JlIHRoYW4gYF92YWx1ZWAgdG9rZW5zIGluIHlvdXIgYmVoYWxmCiAgICAgKgogICAgICogQHBhcmFtIF9zcGVuZGVyIFRoZSBhZGRyZXNzIGF1dGhvcml6ZWQgdG8gc3BlbmQKICAgICAqIEBwYXJhbSBfdmFsdWUgdGhlIG1heCBhbW91bnQgdGhleSBjYW4gc3BlbmQKICAgICAqLwogICAgZnVuY3Rpb24gYXBwcm92ZShhZGRyZXNzIF9zcGVuZGVyLCB1aW50MjU2IF92YWx1ZSkgcHVibGljCiAgICAgICAgb25seVRyYW5mZXJhYmxlCiAgICAgICAgcmV0dXJucyAoYm9vbCBzdWNjZXNzKSAKICAgIHsKICAgICAgICBhbGxvd2FuY2VbbXNnLnNlbmRlcl1bX3NwZW5kZXJdID0gX3ZhbHVlOwogICAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIC8qKgogICAgICogU2V0IGFsbG93YW5jZSBmb3Igb3RoZXIgYWRkcmVzcyBhbmQgbm90aWZ5CiAgICAgKgogICAgICogQWxsb3dzIGBfc3BlbmRlcmAgdG8gc3BlbmQgbm8gbW9yZSB0aGFuIGBfdmFsdWVgIHRva2VucyBpbiB5b3VyIGJlaGFsZiwgYW5kIHRoZW4gcGluZyB0aGUgY29udHJhY3QgYWJvdXQgaXQKICAgICAqCiAgICAgKiBAcGFyYW0gX3NwZW5kZXIgVGhlIGFkZHJlc3MgYXV0aG9yaXplZCB0byBzcGVuZAogICAgICogQHBhcmFtIF92YWx1ZSB0aGUgbWF4IGFtb3VudCB0aGV5IGNhbiBzcGVuZAogICAgICogQHBhcmFtIF9leHRyYURhdGEgc29tZSBleHRyYSBpbmZvcm1hdGlvbiB0byBzZW5kIHRvIHRoZSBhcHByb3ZlZCBjb250cmFjdAogICAgICovCiAgICBmdW5jdGlvbiBhcHByb3ZlQW5kQ2FsbChhZGRyZXNzIF9zcGVuZGVyLCB1aW50MjU2IF92YWx1ZSwgYnl0ZXMgX2V4dHJhRGF0YSkKICAgICAgICBwdWJsaWMKICAgICAgICBvbmx5VHJhbmZlcmFibGUKICAgICAgICByZXR1cm5zIChib29sIHN1Y2Nlc3MpIAogICAgewogICAgICAgIHRva2VuUmVjaXBpZW50IHNwZW5kZXIgPSB0b2tlblJlY2lwaWVudChfc3BlbmRlcik7CiAgICAgICAgaWYgKGFwcHJvdmUoX3NwZW5kZXIsIF92YWx1ZSkpIHsKICAgICAgICAgICAgc3BlbmRlci5yZWNlaXZlQXBwcm92YWwobXNnLnNlbmRlciwgX3ZhbHVlLCB0aGlzLCBfZXh0cmFEYXRhKTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgfQoKICAgIC8vIGFsbG93cyB0cmFuc2ZlciB0b2tlbgogICAgZnVuY3Rpb24gY2hhbmdlVHJhbnNmZXJhYmxlICgpIHB1YmxpYwogICAgICAgIG9ubHlFc2Nyb3cKICAgIHsKICAgICAgICBUUkFOU0ZFUkFCTEUgPSAhVFJBTlNGRVJBQkxFOwogICAgfQogICAgCiAgICAvLyBjaGFuZ2UgZXNjcm93CiAgICBmdW5jdGlvbiBjaGFuZ2VFc2Nyb3coYWRkcmVzcyBfZXNjcm93KSBwdWJsaWMKICAgICAgICBvbmx5TmFtaU11bHRpc2lnCiAgICB7CiAgICAgICAgcmVxdWlyZShfZXNjcm93ICE9IDB4MCk7CiAgICAgICAgZXNjcm93ID0gX2VzY3JvdzsKICAgIH0KICAgIAogICAgLy8gY2hhbmdlIGJpbmFyeSB2YWx1ZQogICAgZnVuY3Rpb24gY2hhbmdlQmluYXJ5KHVpbnQgX2JpbmFyeSkKICAgICAgICBwdWJsaWMKICAgICAgICBvbmx5RXNjcm93CiAgICB7CiAgICAgICAgYmluYXJ5ID0gX2JpbmFyeTsKICAgIH0KICAgIAogICAgLy8gY2hhbmdlIGJpbmFyeSBhZGRyZXNzCiAgICBmdW5jdGlvbiBjaGFuZ2VCaW5hcnlBZGRyZXNzKGFkZHJlc3MgX2JpbmFyeUFkZHJlc3MpCiAgICAgICAgcHVibGljCiAgICAgICAgb25seUVzY3JvdwogICAgewogICAgICAgIHJlcXVpcmUoX2JpbmFyeUFkZHJlc3MgIT0gMHgwKTsKICAgICAgICBiaW5hcnlBZGRyZXNzID0gX2JpbmFyeUFkZHJlc3M7CiAgICB9CiAgICAKICAgIC8qCiAgICAqIHByaWNlIGluIElDTzoKICAgICogZmlyc3Qgd2VlazogMSBFVEggPSAyNDAwIE5BQwogICAgKiBzZWNvbmQgd2VlazogMSBFVEggPSAyMzAwMCBOQUMKICAgICogM3JkIHdlZWs6IDEgRVRIID0gMjIwMCBOQUMKICAgICogNHRoIHdlZWs6IDEgRVRIID0gMjEwMCBOQUMKICAgICogNXRoIHdlZWs6IDEgRVRIID0gMjAwMCBOQUMKICAgICogNnRoIHdlZWs6IDEgRVRIID0gMTkwMCBOQUMKICAgICogN3RoIHdlZWs6IDEgRVRIID0gMTgwMCBOQUMKICAgICogOHRoIHdlZWs6IDEgRVRIID0gMTcwMCBuYWMKICAgICogdGltZTogCiAgICAqIDE1MTc0NDMyMDA6IFRodXJzZGF5LCBGZWJydWFyeSAxLCAyMDE4IDEyOjAwOjAwIEFNCiAgICAqIDE1MTgwNDgwMDA6IFRodXJzZGF5LCBGZWJydWFyeSA4LCAyMDE4IDEyOjAwOjAwIEFNCiAgICAqIDE1MTg2NTI4MDA6IFRodXJzZGF5LCBGZWJydWFyeSAxNSwgMjAxOCAxMjowMDowMCBBTQogICAgKiAxNTE5MjU3NjAwOiBUaHVyc2RheSwgRmVicnVhcnkgMjIsIDIwMTggMTI6MDA6MDAgQU0KICAgICogMTUxOTg2MjQwMDogVGh1cnNkYXksIE1hcmNoIDEsIDIwMTggMTI6MDA6MDAgQU0KICAgICogMTUyMDQ2NzIwMDogVGh1cnNkYXksIE1hcmNoIDgsIDIwMTggMTI6MDA6MDAgQU0KICAgICogMTUyMTA3MjAwMDogVGh1cnNkYXksIE1hcmNoIDE1LCAyMDE4IDEyOjAwOjAwIEFNCiAgICAqIDE1MjE2NzY4MDA6IFRodXJzZGF5LCBNYXJjaCAyMiwgMjAxOCAxMjowMDowMCBBTQogICAgKiAxNTIyMjgxNjAwOiBUaHVyc2RheSwgTWFyY2ggMjksIDIwMTggMTI6MDA6MDAgQU0KICAgICovCiAgICBmdW5jdGlvbiBnZXRQcmljZSgpIHB1YmxpYyB2aWV3IHJldHVybnMgKHVpbnQgcHJpY2UpIHsKICAgICAgICBpZiAobm93IDwgMTUxNzQ0MzIwMCkgewogICAgICAgICAgICAvLyBwcmVzYWxlCiAgICAgICAgICAgIHJldHVybiAzNDUwOwogICAgICAgIH0gZWxzZSBpZiAoMTUxNzQ0MzIwMCA8IG5vdyAmJiBub3cgPD0gMTUxODA0ODAwMCkgewogICAgICAgICAgICAvLyAxc3Qgd2VlawogICAgICAgICAgICByZXR1cm4gMjQwMDsKICAgICAgICB9IGVsc2UgaWYgKDE1MTgwNDgwMDAgPCBub3cgJiYgbm93IDw9IDE1MTg2NTI4MDApIHsKICAgICAgICAgICAgLy8gMm5kIHdlZWsKICAgICAgICAgICAgcmV0dXJuIDIzMDA7CiAgICAgICAgfSBlbHNlIGlmICgxNTE4NjUyODAwIDwgbm93ICYmIG5vdyA8PSAxNTE5MjU3NjAwKSB7CiAgICAgICAgICAgIC8vIDNyZCB3ZWVrCiAgICAgICAgICAgIHJldHVybiAyMjAwOwogICAgICAgIH0gZWxzZSBpZiAoMTUxOTI1NzYwMCA8IG5vdyAmJiBub3cgPD0gMTUxOTg2MjQwMCkgewogICAgICAgICAgICAvLyA0dGggd2VlawogICAgICAgICAgICByZXR1cm4gMjEwMDsKICAgICAgICB9IGVsc2UgaWYgKDE1MTk4NjI0MDAgPCBub3cgJiYgbm93IDw9IDE1MjA0NjcyMDApIHsKICAgICAgICAgICAgLy8gNXRoIHdlZWsKICAgICAgICAgICAgcmV0dXJuIDIwMDA7CiAgICAgICAgfSBlbHNlIGlmICgxNTIwNDY3MjAwIDwgbm93ICYmIG5vdyA8PSAxNTIxMDcyMDAwKSB7CiAgICAgICAgICAgIC8vIDZ0aCB3ZWVrCiAgICAgICAgICAgIHJldHVybiAxOTAwOwogICAgICAgIH0gZWxzZSBpZiAoMTUyMTA3MjAwMCA8IG5vdyAmJiBub3cgPD0gMTUyMTY3NjgwMCkgewogICAgICAgICAgICAvLyA3dGggd2VlawogICAgICAgICAgICByZXR1cm4gMTgwMDsKICAgICAgICB9IGVsc2UgaWYgKDE1MjE2NzY4MDAgPCBub3cgJiYgbm93IDw9IDE1MjIyODE2MDApIHsKICAgICAgICAgICAgLy8gOHRoIHdlZWsKICAgICAgICAgICAgcmV0dXJuIDE3MDA7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIGJpbmFyeTsKICAgICAgICB9CiAgICB9CgoKICAgIGZ1bmN0aW9uKCkgcGF5YWJsZSBwdWJsaWMgewogICAgICAgIGJ1eShtc2cuc2VuZGVyKTsKICAgIH0KICAgIAogICAgCiAgICBmdW5jdGlvbiBidXkoYWRkcmVzcyBfYnV5ZXIpIHBheWFibGUgcHVibGljIHsKICAgICAgICAvLyBBdmFpbGFibGUgb25seSBpZiBwcmVzYWxlIGlzIHJ1bm5pbmcuCiAgICAgICAgcmVxdWlyZShjdXJyZW50UGhhc2UgPT0gUGhhc2UuUnVubmluZyk7CiAgICAgICAgLy8gcmVxdWlyZSBJQ08gdGltZSBvciBiaW5hcnkgb3B0aW9uCiAgICAgICAgcmVxdWlyZShub3cgPD0gMTUyMjI4MTYwMCB8fCBtc2cuc2VuZGVyID09IGJpbmFyeUFkZHJlc3MpOwogICAgICAgIHJlcXVpcmUobXNnLnZhbHVlICE9IDApOwogICAgICAgIHVpbnQgbmV3VG9rZW5zID0gbXNnLnZhbHVlICogZ2V0UHJpY2UoKTsKICAgICAgICByZXF1aXJlICh0b3RhbFN1cHBseSArIG5ld1Rva2VucyA8IFRPS0VOX1NVUFBMWV9MSU1JVCk7CiAgICAgICAgLy8gYWRkIG5ldyB0b2tlbiB0byBidXllcgogICAgICAgIGJhbGFuY2VPZltfYnV5ZXJdID0gYmFsYW5jZU9mW19idXllcl0uYWRkKG5ld1Rva2Vucyk7CiAgICAgICAgLy8gYWRkIG5ldyB0b2tlbiB0byB0b3RhbFN1cHBseQogICAgICAgIHRvdGFsU3VwcGx5ID0gdG90YWxTdXBwbHkuYWRkKG5ld1Rva2Vucyk7CiAgICAgICAgZW1pdCBMb2dCdXkoX2J1eWVyLG5ld1Rva2Vucyk7CiAgICAgICAgZW1pdCBUcmFuc2Zlcih0aGlzLF9idXllcixuZXdUb2tlbnMpOwogICAgfQogICAgCgogICAgLy8vIEBkZXYgUmV0dXJucyBudW1iZXIgb2YgdG9rZW5zIG93bmVkIGJ5IGdpdmVuIGFkZHJlc3MuCiAgICAvLy8gQHBhcmFtIF9vd25lciBBZGRyZXNzIG9mIHRva2VuIG93bmVyLgogICAgZnVuY3Rpb24gYnVyblRva2VucyhhZGRyZXNzIF9vd25lcikgcHVibGljCiAgICAgICAgb25seUNyb3dkc2FsZU1hbmFnZXIKICAgIHsKICAgICAgICAvLyBBdmFpbGFibGUgb25seSBkdXJpbmcgbWlncmF0aW9uIHBoYXNlCiAgICAgICAgcmVxdWlyZShjdXJyZW50UGhhc2UgPT0gUGhhc2UuTWlncmF0aW5nKTsKCiAgICAgICAgdWludCB0b2tlbnMgPSBiYWxhbmNlT2ZbX293bmVyXTsKICAgICAgICByZXF1aXJlKHRva2VucyAhPSAwKTsKICAgICAgICBiYWxhbmNlT2ZbX293bmVyXSA9IDA7CiAgICAgICAgdG90YWxTdXBwbHkgLT0gdG9rZW5zOwogICAgICAgIGVtaXQgTG9nQnVybihfb3duZXIsIHRva2Vucyk7CiAgICAgICAgZW1pdCBUcmFuc2Zlcihfb3duZXIsIGNyb3dkc2FsZU1hbmFnZXIsIHRva2Vucyk7CgogICAgICAgIC8vIEF1dG9tYXRpY2FsbHkgc3dpdGNoIHBoYXNlIHdoZW4gbWlncmF0aW9uIGlzIGRvbmUuCiAgICAgICAgaWYgKHRvdGFsU3VwcGx5ID09IDApIHsKICAgICAgICAgICAgY3VycmVudFBoYXNlID0gUGhhc2UuTWlncmF0ZWQ7CiAgICAgICAgICAgIGVtaXQgTG9nUGhhc2VTd2l0Y2goUGhhc2UuTWlncmF0ZWQpOwogICAgICAgIH0KICAgIH0KCgogICAgLyovCiAgICAgKiAgQWRtaW5pc3RyYXRpdmUgZnVuY3Rpb25zCiAgICAvKi8KICAgIGZ1bmN0aW9uIHNldFByZXNhbGVQaGFzZShQaGFzZSBfbmV4dFBoYXNlKSBwdWJsaWMKICAgICAgICBvbmx5RXNjcm93CiAgICB7CiAgICAgICAgYm9vbCBjYW5Td2l0Y2hQaGFzZQogICAgICAgICAgICA9ICAoY3VycmVudFBoYXNlID09IFBoYXNlLkNyZWF0ZWQgJiYgX25leHRQaGFzZSA9PSBQaGFzZS5SdW5uaW5nKQogICAgICAgICAgICB8fCAoY3VycmVudFBoYXNlID09IFBoYXNlLlJ1bm5pbmcgJiYgX25leHRQaGFzZSA9PSBQaGFzZS5QYXVzZWQpCiAgICAgICAgICAgICAgICAvLyBzd2l0Y2ggdG8gbWlncmF0aW9uIHBoYXNlIG9ubHkgaWYgY3Jvd2RzYWxlIG1hbmFnZXIgaXMgc2V0CiAgICAgICAgICAgIHx8ICgoY3VycmVudFBoYXNlID09IFBoYXNlLlJ1bm5pbmcgfHwgY3VycmVudFBoYXNlID09IFBoYXNlLlBhdXNlZCkKICAgICAgICAgICAgICAgICYmIF9uZXh0UGhhc2UgPT0gUGhhc2UuTWlncmF0aW5nCiAgICAgICAgICAgICAgICAmJiBjcm93ZHNhbGVNYW5hZ2VyICE9IDB4MCkKICAgICAgICAgICAgfHwgKGN1cnJlbnRQaGFzZSA9PSBQaGFzZS5QYXVzZWQgJiYgX25leHRQaGFzZSA9PSBQaGFzZS5SdW5uaW5nKQogICAgICAgICAgICAgICAgLy8gc3dpdGNoIHRvIG1pZ3JhdGVkIG9ubHkgaWYgZXZlcnl0aW5nIGlzIG1pZ3JhdGVkCiAgICAgICAgICAgIHx8IChjdXJyZW50UGhhc2UgPT0gUGhhc2UuTWlncmF0aW5nICYmIF9uZXh0UGhhc2UgPT0gUGhhc2UuTWlncmF0ZWQKICAgICAgICAgICAgICAgICYmIHRvdGFsU3VwcGx5ID09IDApOwoKICAgICAgICByZXF1aXJlKGNhblN3aXRjaFBoYXNlKTsKICAgICAgICBjdXJyZW50UGhhc2UgPSBfbmV4dFBoYXNlOwogICAgICAgIGVtaXQgTG9nUGhhc2VTd2l0Y2goX25leHRQaGFzZSk7CiAgICB9CgoKICAgIGZ1bmN0aW9uIHdpdGhkcmF3RXRoZXIodWludCBfYW1vdW50KSBwdWJsaWMKICAgICAgICBvbmx5RXNjcm93CiAgICB7CiAgICAgICAgcmVxdWlyZShuYW1pTXVsdGlTaWdXYWxsZXQgIT0gMHgwKTsKICAgICAgICAvLyBBdmFpbGFibGUgYXQgYW55IHBoYXNlLgogICAgICAgIGlmIChhZGRyZXNzKHRoaXMpLmJhbGFuY2UgPiAwKSB7CiAgICAgICAgICAgIG5hbWlNdWx0aVNpZ1dhbGxldC50cmFuc2ZlcihfYW1vdW50KTsKICAgICAgICB9CiAgICB9CiAgICAKICAgIGZ1bmN0aW9uIHNhZmVXaXRoZHJhdyhhZGRyZXNzIF93aXRoZHJhdywgdWludCBfYW1vdW50KSBwdWJsaWMKICAgICAgICBvbmx5RXNjcm93CiAgICB7CiAgICAgICAgTmFtaU11bHRpU2lnV2FsbGV0IG5hbWlXYWxsZXQgPSBOYW1pTXVsdGlTaWdXYWxsZXQobmFtaU11bHRpU2lnV2FsbGV0KTsKICAgICAgICBpZiAobmFtaVdhbGxldC5pc093bmVyKF93aXRoZHJhdykpIHsKICAgICAgICAgICAgX3dpdGhkcmF3LnRyYW5zZmVyKF9hbW91bnQpOwogICAgICAgIH0KICAgIH0KCgogICAgZnVuY3Rpb24gc2V0Q3Jvd2RzYWxlTWFuYWdlcihhZGRyZXNzIF9tZ3IpIHB1YmxpYwogICAgICAgIG9ubHlFc2Nyb3cKICAgIHsKICAgICAgICAvLyBZb3UgY2FuJ3QgY2hhbmdlIGNyb3dkc2FsZSBjb250cmFjdCB3aGVuIG1pZ3JhdGlvbiBpcyBpbiBwcm9ncmVzcy4KICAgICAgICByZXF1aXJlKGN1cnJlbnRQaGFzZSAhPSBQaGFzZS5NaWdyYXRpbmcpOwogICAgICAgIGNyb3dkc2FsZU1hbmFnZXIgPSBfbWdyOwogICAgfQoKICAgIC8vIGludGVybmFsIG1pZ3JhdGUgbWlncmF0aW9uIHRva2VucwogICAgZnVuY3Rpb24gX21pZ3JhdGVUb2tlbihhZGRyZXNzIF9mcm9tLCBhZGRyZXNzIF90bykKICAgICAgICBpbnRlcm5hbAogICAgewogICAgICAgIFByZXNhbGVUb2tlbiBwcmVzYWxlID0gUHJlc2FsZVRva2VuKG5hbWlQcmVzYWxlKTsKICAgICAgICB1aW50MjU2IG5ld1Rva2VuID0gcHJlc2FsZS5iYWxhbmNlT2YoX2Zyb20pOwogICAgICAgIHJlcXVpcmUobmV3VG9rZW4gPiAwKTsKICAgICAgICAvLyBidXJuIG9sZCB0b2tlbgogICAgICAgIHByZXNhbGUuYnVyblRva2VucyhfZnJvbSk7CiAgICAgICAgLy8gYWRkIG5ldyB0b2tlbiB0byBfdG8KICAgICAgICBiYWxhbmNlT2ZbX3RvXSA9IGJhbGFuY2VPZltfdG9dLmFkZChuZXdUb2tlbik7CiAgICAgICAgLy8gYWRkIG5ldyB0b2tlbiB0byB0b3RhbFN1cHBseQogICAgICAgIHRvdGFsU3VwcGx5ID0gdG90YWxTdXBwbHkuYWRkKG5ld1Rva2VuKTsKICAgICAgICBlbWl0IExvZ01pZ3JhdGUoX2Zyb20sIF90bywgbmV3VG9rZW4pOwogICAgICAgIGVtaXQgVHJhbnNmZXIodGhpcyxfdG8sbmV3VG9rZW4pOwogICAgfQoKICAgIC8vIG1pZ2F0ZSB0b2tlbiBmdW5jdGlvbiBmb3IgTmFtaSBUZWFtCiAgICBmdW5jdGlvbiBtaWdyYXRlVG9rZW4oYWRkcmVzcyBfZnJvbSwgYWRkcmVzcyBfdG8pIHB1YmxpYwogICAgICAgIG9ubHlFc2Nyb3cKICAgIHsKICAgICAgICBfbWlncmF0ZVRva2VuKF9mcm9tLCBfdG8pOwogICAgfQoKICAgIC8vIG1pZ3JhdGUgdG9rZW4gZm9yIGludmVzdG9yCiAgICBmdW5jdGlvbiBtaWdyYXRlRm9ySW52ZXN0b3IoKSBwdWJsaWMgewogICAgICAgIF9taWdyYXRlVG9rZW4obXNnLnNlbmRlciwgbXNnLnNlbmRlcik7CiAgICB9CgogICAgLy8gTmFtaSBpbnRlcm5hbCBleGNoYW5nZQogICAgCiAgICAvLyBldmVudCBmb3IgTmFtaSBleGNoYW5nZQogICAgZXZlbnQgVHJhbnNmZXJUb0J1eWVyKGFkZHJlc3MgaW5kZXhlZCBfZnJvbSwgYWRkcmVzcyBpbmRleGVkIF90bywgdWludCBfdmFsdWUsIGFkZHJlc3MgaW5kZXhlZCBfc2VsbGVyKTsKICAgIGV2ZW50IFRyYW5zZmVyVG9FeGNoYW5nZShhZGRyZXNzIGluZGV4ZWQgX2Zyb20sIGFkZHJlc3MgaW5kZXhlZCBfdG8sIHVpbnQgX3ZhbHVlLCB1aW50IF9wcmljZSk7CiAgICAKICAgIAogICAgLyoqCiAgICAgKiBAZGV2IFRyYW5zZmVyIHRoZSBzcGVjaWZpZWQgYW1vdW50IG9mIHRva2VucyB0byB0aGUgTmFtaUV4Y2hhbmdlIGFkZHJlc3MuCiAgICAgKiAgICAgIEludm9rZXMgdGhlIGB0b2tlbkZhbGxiYWNrRXhjaGFuZ2VgIGZ1bmN0aW9uLgogICAgICogICAgICBUaGUgdG9rZW4gdHJhbnNmZXIgZmFpbHMgaWYgdGhlIHJlY2lwaWVudCBpcyBhIGNvbnRyYWN0CiAgICAgKiAgICAgIGJ1dCBkb2VzIG5vdCBpbXBsZW1lbnQgdGhlIGB0b2tlbkZhbGxiYWNrRXhjaGFuZ2VgIGZ1bmN0aW9uCiAgICAgKiAgICAgIG9yIHRoZSBmYWxsYmFjayBmdW5jdGlvbiB0byByZWNlaXZlIGZ1bmRzLgogICAgICoKICAgICAqIEBwYXJhbSBfdG8gICAgUmVjZWl2ZXIgYWRkcmVzcy4KICAgICAqIEBwYXJhbSBfdmFsdWUgQW1vdW50IG9mIHRva2VucyB0aGF0IHdpbGwgYmUgdHJhbnNmZXJyZWQuCiAgICAgKiBAcGFyYW0gX3ByaWNlIHByaWNlIHRvIHNlbGwgdG9rZW4uCiAgICAgKi8KICAgICAKICAgIGZ1bmN0aW9uIHRyYW5zZmVyVG9FeGNoYW5nZShhZGRyZXNzIF90bywgdWludCBfdmFsdWUsIHVpbnQgX3ByaWNlKSBwdWJsaWMgewogICAgICAgIHVpbnQgY29kZUxlbmd0aDsKICAgICAgICAKICAgICAgICBhc3NlbWJseSB7CiAgICAgICAgICAgIGNvZGVMZW5ndGggOj0gZXh0Y29kZXNpemUoX3RvKQogICAgICAgIH0KICAgICAgICAKICAgICAgICBiYWxhbmNlT2ZbbXNnLnNlbmRlcl0gPSBiYWxhbmNlT2ZbbXNnLnNlbmRlcl0uc3ViKF92YWx1ZSk7CiAgICAgICAgYmFsYW5jZU9mW190b10gPSBiYWxhbmNlT2ZbX3RvXS5hZGQoX3ZhbHVlKTsKICAgICAgICBlbWl0IFRyYW5zZmVyKG1zZy5zZW5kZXIsX3RvLF92YWx1ZSk7CiAgICAgICAgaWYgKGNvZGVMZW5ndGggPiAwKSB7CiAgICAgICAgICAgIEVSQzIyM1JlY2VpdmluZ0NvbnRyYWN0IHJlY2VpdmVyID0gRVJDMjIzUmVjZWl2aW5nQ29udHJhY3QoX3RvKTsKICAgICAgICAgICAgcmVjZWl2ZXIudG9rZW5GYWxsYmFja0V4Y2hhbmdlKG1zZy5zZW5kZXIsIF92YWx1ZSwgX3ByaWNlKTsKICAgICAgICAgICAgZW1pdCBUcmFuc2ZlclRvRXhjaGFuZ2UobXNnLnNlbmRlciwgX3RvLCBfdmFsdWUsIF9wcmljZSk7CiAgICAgICAgfQogICAgfQogICAgCiAgICAvKioKICAgICAqIEBkZXYgVHJhbnNmZXIgdGhlIHNwZWNpZmllZCBhbW91bnQgb2YgdG9rZW5zIHRvIHRoZSBOYW1pRXhjaGFuZ2UgYWRkcmVzcy4KICAgICAqICAgICAgSW52b2tlcyB0aGUgYHRva2VuRmFsbGJhY2tCdXllcmAgZnVuY3Rpb24uCiAgICAgKiAgICAgIFRoZSB0b2tlbiB0cmFuc2ZlciBmYWlscyBpZiB0aGUgcmVjaXBpZW50IGlzIGEgY29udHJhY3QKICAgICAqICAgICAgYnV0IGRvZXMgbm90IGltcGxlbWVudCB0aGUgYHRva2VuRmFsbGJhY2tCdXllcmAgZnVuY3Rpb24KICAgICAqICAgICAgb3IgdGhlIGZhbGxiYWNrIGZ1bmN0aW9uIHRvIHJlY2VpdmUgZnVuZHMuCiAgICAgKgogICAgICogQHBhcmFtIF90byAgICBSZWNlaXZlciBhZGRyZXNzLgogICAgICogQHBhcmFtIF92YWx1ZSBBbW91bnQgb2YgdG9rZW5zIHRoYXQgd2lsbCBiZSB0cmFuc2ZlcnJlZC4KICAgICAqIEBwYXJhbSBfYnV5ZXIgYWRkcmVzcyBvZiBzZWxsZXIuCiAgICAgKi8KICAgICAKICAgIGZ1bmN0aW9uIHRyYW5zZmVyVG9CdXllcihhZGRyZXNzIF90bywgdWludCBfdmFsdWUsIGFkZHJlc3MgX2J1eWVyKSBwdWJsaWMgewogICAgICAgIHVpbnQgY29kZUxlbmd0aDsKICAgICAgICAKICAgICAgICBhc3NlbWJseSB7CiAgICAgICAgICAgIGNvZGVMZW5ndGggOj0gZXh0Y29kZXNpemUoX3RvKQogICAgICAgIH0KICAgICAgICAKICAgICAgICBiYWxhbmNlT2ZbbXNnLnNlbmRlcl0gPSBiYWxhbmNlT2ZbbXNnLnNlbmRlcl0uc3ViKF92YWx1ZSk7CiAgICAgICAgYmFsYW5jZU9mW190b10gPSBiYWxhbmNlT2ZbX3RvXS5hZGQoX3ZhbHVlKTsKICAgICAgICBlbWl0IFRyYW5zZmVyKG1zZy5zZW5kZXIsX3RvLF92YWx1ZSk7CiAgICAgICAgaWYgKGNvZGVMZW5ndGggPiAwKSB7CiAgICAgICAgICAgIEVSQzIyM1JlY2VpdmluZ0NvbnRyYWN0IHJlY2VpdmVyID0gRVJDMjIzUmVjZWl2aW5nQ29udHJhY3QoX3RvKTsKICAgICAgICAgICAgcmVjZWl2ZXIudG9rZW5GYWxsYmFja0J1eWVyKG1zZy5zZW5kZXIsIF92YWx1ZSwgX2J1eWVyKTsKICAgICAgICAgICAgZW1pdCBUcmFuc2ZlclRvQnV5ZXIobXNnLnNlbmRlciwgX3RvLCBfdmFsdWUsIF9idXllcik7CiAgICAgICAgfQogICAgfQovLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KfQoKCi8qCiogQmluYXJ5IG9wdGlvbiBzbWFydCBjb250cmFjdC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KKi8KY29udHJhY3QgQmluYXJ5T3B0aW9uIHsKICAgIC8qCiAgICAgKiBiaW5hcnkgb3B0aW9uIGNvbnRyb2xlZCBieSBlc2Nyb3cgdG8gYnV5IE5BQyB3aXRoIGdvb2QgcHJpY2UKICAgICAqLwogICAgLy8gTmFtaUNyb3dkU2FsZSBhZGRyZXNzCiAgICBhZGRyZXNzIHB1YmxpYyBuYW1pQ3Jvd2RTYWxlQWRkcjsKICAgIGFkZHJlc3MgcHVibGljIGVzY3JvdzsKICAgIAogICAgLy8gbmFtaU11bHRpU2lnV2FsbGV0CiAgICBhZGRyZXNzIHB1YmxpYyBuYW1pTXVsdGlTaWdXYWxsZXQ7CiAgICAKICAgIFNlc3Npb24gcHVibGljIHNlc3Npb247CiAgICB1aW50IHB1YmxpYyB0aW1lSW52ZXN0SW5NaW51dGUgPSAxNTsKICAgIHVpbnQgcHVibGljIHRpbWVPbmVTZXNzaW9uID0gMjA7CiAgICB1aW50IHB1YmxpYyBzZXNzaW9uSWQgPSAxOwogICAgdWludCBwdWJsaWMgcmF0ZVdpbiA9IDEwMDsKICAgIHVpbnQgcHVibGljIHJhdGVMb3NzID0gMjA7CiAgICB1aW50IHB1YmxpYyByYXRlRmVlID0gNTsKICAgIHVpbnQgcHVibGljIGNvbnN0YW50IE1BWF9JTlZFU1RPUiA9IDIwOwogICAgdWludCBwdWJsaWMgbWluaW11bkV0aCA9IDEwMDAwMDAwMDAwMDAwMDAwOyAvLyBtaW5pbXVuRXRoID0gMC4wMSBldGgKICAgIC8qKgogICAgICogRXZlbnRzIGZvciBiaW5hbnkgb3B0aW9uIHN5c3RlbQogICAgICovCiAgICBldmVudCBTZXNzaW9uT3Blbih1aW50IHRpbWVPcGVuLCB1aW50IGluZGV4ZWQgc2Vzc2lvbklkKTsKICAgIGV2ZW50IEludmVzdENsb3NlKHVpbnQgdGltZUludmVzdENsb3NlLCB1aW50IHByaWNlT3BlbiwgdWludCBpbmRleGVkIHNlc3Npb25JZCk7CiAgICBldmVudCBJbnZlc3QoYWRkcmVzcyBpbmRleGVkIGludmVzdG9yLCBib29sIGNob29zZSwgdWludCBhbW91bnQsIHVpbnQgdGltZUludmVzdCwgdWludCBpbmRleGVkIHNlc3Npb25JZCk7CiAgICBldmVudCBTZXNzaW9uQ2xvc2UodWludCB0aW1lQ2xvc2UsIHVpbnQgaW5kZXhlZCBzZXNzaW9uSWQsIHVpbnQgcHJpY2VDbG9zZSwgdWludCBuYWNQcmljZSwgdWludCByYXRlV2luLCB1aW50IHJhdGVMb3NzLCB1aW50IHJhdGVGZWUpOwoKICAgIGV2ZW50IERlcG9zaXQoYWRkcmVzcyBpbmRleGVkIHNlbmRlciwgdWludCB2YWx1ZSk7CiAgICAvLy8gQGRldiBGYWxsYmFjayBmdW5jdGlvbiBhbGxvd3MgdG8gZGVwb3NpdCBldGhlci4KICAgIGZ1bmN0aW9uKCkgcHVibGljIHBheWFibGUgewogICAgICAgIGlmIChtc2cudmFsdWUgPiAwKQogICAgICAgICAgICBlbWl0IERlcG9zaXQobXNnLnNlbmRlciwgbXNnLnZhbHVlKTsKICAgIH0KICAgIC8vIHRoZXJlIGlzIG9ubHkgb25lIHNlc3Npb24gYXZhaWxhYmxlIGF0IG9uZSB0aW1lT3BlbgogICAgLy8gcHJpY2VPcGVuIGlzIHByaWNlIG9mIEVUSCBpbiBVU0QKICAgIC8vIHByaWNlQ2xvc2UgaXMgcHJpY2Ugb2YgRVRIIGluIFVTRAogICAgLy8gcHJvY2VzcyBvZiBvbmUgU2Vzc2lvbgogICAgLy8gMXN0OiBlc2Nyb3cgcmVzZXQgc2Vzc2lvbiBieSBydW4gcmVzZXRTZXNzaW9uKCkKICAgIC8vIDJuZDogZXNjcm93IG9wZW4gc2Vzc2lvbiBieSBydW4gb3BlblNlc3Npb24oKSA9PiBzYXZlIHRpbWVPcGVuIGF0IHRoaXMgdGltZQogICAgLy8gM3JkOiBhbGwgaW52ZXN0b3IgY2FuIGludmVzdCBieSBydW4gaW52ZXN0KCksIHNlbmQgbWluaW11bSAwLjEgRVRICiAgICAvLyA0dGg6IGVzY3JvdyBjbG9zZSBpbnZlc3QgYW5kIGluc2VydCBwcmljZSBvcGVuIGZvciB0aGlzIFNlc3Npb24KICAgIC8vIDV0aDogZXNjcm93IGNsb3NlIHNlc3Npb24gYW5kIHNlbmQgTkFDIGZvciBpbnZlc3RvcgogICAgc3RydWN0IFNlc3Npb24gewogICAgICAgIHVpbnQgcHJpY2VPcGVuOwogICAgICAgIHVpbnQgcHJpY2VDbG9zZTsKICAgICAgICB1aW50IHRpbWVPcGVuOwogICAgICAgIGJvb2wgaXNSZXNldDsKICAgICAgICBib29sIGlzT3BlbjsKICAgICAgICBib29sIGludmVzdE9wZW47CiAgICAgICAgdWludCBpbnZlc3RvckNvdW50OwogICAgICAgIG1hcHBpbmcodWludCA9PiBhZGRyZXNzKSBpbnZlc3RvcjsKICAgICAgICBtYXBwaW5nKHVpbnQgPT4gYm9vbCkgd2luOwogICAgICAgIG1hcHBpbmcodWludCA9PiB1aW50KSBhbW91bnRJbnZlc3Q7CiAgICB9CiAgICAKICAgIGZ1bmN0aW9uIEJpbmFyeU9wdGlvbihhZGRyZXNzIF9uYW1pQ3Jvd2RTYWxlLCBhZGRyZXNzIF9lc2Nyb3csIGFkZHJlc3MgX25hbWlNdWx0aVNpZ1dhbGxldCkgcHVibGljIHsKICAgICAgICByZXF1aXJlKF9uYW1pQ3Jvd2RTYWxlICE9IDB4MCAmJiBfZXNjcm93ICE9IDB4MCk7CiAgICAgICAgbmFtaUNyb3dkU2FsZUFkZHIgPSBfbmFtaUNyb3dkU2FsZTsKICAgICAgICBlc2Nyb3cgPSBfZXNjcm93OwogICAgICAgIG5hbWlNdWx0aVNpZ1dhbGxldCA9IF9uYW1pTXVsdGlTaWdXYWxsZXQ7CiAgICB9CiAgICAKICAgIAogICAgbW9kaWZpZXIgb25seUVzY3JvdygpIHsKICAgICAgICByZXF1aXJlKG1zZy5zZW5kZXI9PWVzY3Jvdyk7CiAgICAgICAgXzsKICAgIH0KICAgIAogICAgICAgIAogICAgbW9kaWZpZXIgb25seU5hbWlNdWx0aXNpZygpIHsKICAgICAgICByZXF1aXJlKG1zZy5zZW5kZXIgPT0gbmFtaU11bHRpU2lnV2FsbGV0KTsKICAgICAgICBfOwogICAgfQogICAgCiAgICAvLyBjaGFuZ2UgZXNjcm93CiAgICBmdW5jdGlvbiBjaGFuZ2VFc2Nyb3coYWRkcmVzcyBfZXNjcm93KSBwdWJsaWMKICAgICAgICBvbmx5TmFtaU11bHRpc2lnCiAgICB7CiAgICAgICAgcmVxdWlyZShfZXNjcm93ICE9IDB4MCk7CiAgICAgICAgZXNjcm93ID0gX2VzY3JvdzsKICAgIH0KICAgIAogICAgLy8gY2hhZ25lIG1pbmltdW5FdGgKICAgIGZ1bmN0aW9uIGNoYW5nZU1pbkV0aCh1aW50IF9taW5pbXVuRXRoKSBwdWJsaWMgCiAgICAgICAgb25seUVzY3JvdwogICAgewogICAgICAgIHJlcXVpcmUoX21pbmltdW5FdGggIT0gMCk7CiAgICAgICAgbWluaW11bkV0aCA9IF9taW5pbXVuRXRoOwogICAgfQogICAgCiAgICAvLy8gQGRldiBDaGFuZ2UgdGltZSBmb3IgaW52ZXN0b3IgY2FuIGludmVzdCBpbiBvbmUgc2Vzc2lvbiwgY2FuIG9ubHkgY2hhbmdlIGF0IHRpbWUgbm90IGluIHNlc3Npb24KICAgIC8vLyBAcGFyYW0gX3RpbWVJbnZlc3QgdGltZSBpbnZlc3QgaW4gbWludXRlcwogICAgLy8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tY2hhbmdlIHRpbWUgZnVuY3Rpb24tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIGZ1bmN0aW9uIGNoYW5nZVRpbWVJbnZlc3QodWludCBfdGltZUludmVzdCkKICAgICAgICBwdWJsaWMKICAgICAgICBvbmx5RXNjcm93CiAgICB7CiAgICAgICAgcmVxdWlyZSghc2Vzc2lvbi5pc09wZW4gJiYgX3RpbWVJbnZlc3QgPCB0aW1lT25lU2Vzc2lvbik7CiAgICAgICAgdGltZUludmVzdEluTWludXRlID0gX3RpbWVJbnZlc3Q7CiAgICB9CgogICAgZnVuY3Rpb24gY2hhbmdlVGltZU9uZVNlc3Npb24odWludCBfdGltZU9uZVNlc3Npb24pIAogICAgICAgIHB1YmxpYwogICAgICAgIG9ubHlFc2Nyb3cKICAgIHsKICAgICAgICByZXF1aXJlKCFzZXNzaW9uLmlzT3BlbiAmJiBfdGltZU9uZVNlc3Npb24gPiB0aW1lSW52ZXN0SW5NaW51dGUpOwogICAgICAgIHRpbWVPbmVTZXNzaW9uID0gX3RpbWVPbmVTZXNzaW9uOwogICAgfQoKICAgIC8vLy8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tY2hhbmdlIHJhdGUgZnVuY3Rpb24tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAKICAgIGZ1bmN0aW9uIGNoYW5nZVJhdGVXaW4odWludCBfcmF0ZVdpbikKICAgICAgICBwdWJsaWMKICAgICAgICBvbmx5RXNjcm93CiAgICB7CiAgICAgICAgcmVxdWlyZSghc2Vzc2lvbi5pc09wZW4pOwogICAgICAgIHJhdGVXaW4gPSBfcmF0ZVdpbjsKICAgIH0KICAgIAogICAgZnVuY3Rpb24gY2hhbmdlUmF0ZUxvc3ModWludCBfcmF0ZUxvc3MpCiAgICAgICAgcHVibGljCiAgICAgICAgb25seUVzY3JvdwogICAgewogICAgICAgIHJlcXVpcmUoIXNlc3Npb24uaXNPcGVuKTsKICAgICAgICByYXRlTG9zcyA9IF9yYXRlTG9zczsKICAgIH0KICAgIAogICAgZnVuY3Rpb24gY2hhbmdlUmF0ZUZlZSh1aW50IF9yYXRlRmVlKQogICAgICAgIHB1YmxpYwogICAgICAgIG9ubHlFc2Nyb3cKICAgIHsKICAgICAgICByZXF1aXJlKCFzZXNzaW9uLmlzT3Blbik7CiAgICAgICAgcmF0ZUZlZSA9IF9yYXRlRmVlOwogICAgfQogICAgCiAgICAKICAgIC8vLyBAZGV2IHdpdGhkcmF3IGV0aGVyIHRvIG5hbWkgbXVsdGlzaWduYXR1cmUgd2FsbGV0LCBvbmx5IGVzY3JvdyBjYW4gY2FsbAogICAgLy8vIEBwYXJhbSBfYW1vdW50IHZhbHVlIGV0aGVyIGluIHdlaSB0byB3aXRoZHJhdwogICAgZnVuY3Rpb24gd2l0aGRyYXdFdGhlcih1aW50IF9hbW91bnQpIHB1YmxpYwogICAgICAgIG9ubHlFc2Nyb3cKICAgIHsKICAgICAgICByZXF1aXJlKG5hbWlNdWx0aVNpZ1dhbGxldCAhPSAweDApOwogICAgICAgIC8vIEF2YWlsYWJsZSBhdCBhbnkgcGhhc2UuCiAgICAgICAgaWYgKGFkZHJlc3ModGhpcykuYmFsYW5jZSA+IDApIHsKICAgICAgICAgICAgbmFtaU11bHRpU2lnV2FsbGV0LnRyYW5zZmVyKF9hbW91bnQpOwogICAgICAgIH0KICAgIH0KICAgIAogICAgLy8vIEBkZXYgc2FmZSB3aXRoZHJhdyBFdGhlciB0byBvbmUgb2Ygb3duZXIgb2YgbmFtaSBtdWx0aXNpZ25hdHVyZSB3YWxsZXQKICAgIC8vLyBAcGFyYW0gX3dpdGhkcmF3IGFkZHJlc3MgdG8gd2l0aGRyYXcKICAgIGZ1bmN0aW9uIHNhZmVXaXRoZHJhdyhhZGRyZXNzIF93aXRoZHJhdywgdWludCBfYW1vdW50KSBwdWJsaWMKICAgICAgICBvbmx5RXNjcm93CiAgICB7CiAgICAgICAgTmFtaU11bHRpU2lnV2FsbGV0IG5hbWlXYWxsZXQgPSBOYW1pTXVsdGlTaWdXYWxsZXQobmFtaU11bHRpU2lnV2FsbGV0KTsKICAgICAgICBpZiAobmFtaVdhbGxldC5pc093bmVyKF93aXRoZHJhdykpIHsKICAgICAgICAgICAgX3dpdGhkcmF3LnRyYW5zZmVyKF9hbW91bnQpOwogICAgICAgIH0KICAgIH0KICAgIAogICAgLy8gQGRldiBSZXR1cm5zIGxpc3Qgb2Ygb3duZXJzLgogICAgLy8gQHJldHVybiBMaXN0IG9mIG93bmVyIGFkZHJlc3Nlcy4KICAgIC8vIE1BWF9JTlZFU1RPUiA9IDIwCiAgICBmdW5jdGlvbiBnZXRJbnZlc3RvcnMoKQogICAgICAgIHB1YmxpYwogICAgICAgIHZpZXcKICAgICAgICByZXR1cm5zIChhZGRyZXNzWzIwXSkKICAgIHsKICAgICAgICBhZGRyZXNzWzIwXSBtZW1vcnkgbGlzdEludmVzdG9yOwogICAgICAgIGZvciAodWludCBpID0gMDsgaSA8IE1BWF9JTlZFU1RPUjsgaSsrKSB7CiAgICAgICAgICAgIGxpc3RJbnZlc3RvcltpXSA9IHNlc3Npb24uaW52ZXN0b3JbaV07CiAgICAgICAgfQogICAgICAgIHJldHVybiBsaXN0SW52ZXN0b3I7CiAgICB9CiAgICAKICAgIGZ1bmN0aW9uIGdldENob29zZXMoKQogICAgICAgIHB1YmxpYwogICAgICAgIHZpZXcKICAgICAgICByZXR1cm5zIChib29sWzIwXSkKICAgIHsKICAgICAgICBib29sWzIwXSBtZW1vcnkgbGlzdENob29zZXM7CiAgICAgICAgZm9yICh1aW50IGkgPSAwOyBpIDwgTUFYX0lOVkVTVE9SOyBpKyspIHsKICAgICAgICAgICAgbGlzdENob29zZXNbaV0gPSBzZXNzaW9uLndpbltpXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGxpc3RDaG9vc2VzOwogICAgfQogICAgCiAgICBmdW5jdGlvbiBnZXRBbW91bnQoKQogICAgICAgIHB1YmxpYwogICAgICAgIHZpZXcKICAgICAgICByZXR1cm5zICh1aW50WzIwXSkKICAgIHsKICAgICAgICB1aW50WzIwXSBtZW1vcnkgbGlzdEFtb3VudDsKICAgICAgICBmb3IgKHVpbnQgaSA9IDA7IGkgPCBNQVhfSU5WRVNUT1I7IGkrKykgewogICAgICAgICAgICBsaXN0QW1vdW50W2ldID0gc2Vzc2lvbi5hbW91bnRJbnZlc3RbaV07CiAgICAgICAgfQogICAgICAgIHJldHVybiBsaXN0QW1vdW50OwogICAgfQogICAgCiAgICAvLy8gQGRldiByZXNldCBhbGwgZGF0YSBvZiBwcmV2aW91cyBzZXNzaW9uLCBtdXN0IHJ1biBiZWZvcmUgb3BlbiBuZXcgc2Vzc2lvbgogICAgLy8gb25seSBlc2Nyb3cgY2FuIGNhbGwKICAgIGZ1bmN0aW9uIHJlc2V0U2Vzc2lvbigpCiAgICAgICAgcHVibGljCiAgICAgICAgb25seUVzY3JvdwogICAgewogICAgICAgIHJlcXVpcmUoIXNlc3Npb24uaXNSZXNldCAmJiAhc2Vzc2lvbi5pc09wZW4pOwogICAgICAgIHNlc3Npb24ucHJpY2VPcGVuID0gMDsKICAgICAgICBzZXNzaW9uLnByaWNlQ2xvc2UgPSAwOwogICAgICAgIHNlc3Npb24uaXNSZXNldCA9IHRydWU7CiAgICAgICAgc2Vzc2lvbi5pc09wZW4gPSBmYWxzZTsKICAgICAgICBzZXNzaW9uLmludmVzdE9wZW4gPSBmYWxzZTsKICAgICAgICBzZXNzaW9uLmludmVzdG9yQ291bnQgPSAwOwogICAgICAgIGZvciAodWludCBpID0gMDsgaSA8IE1BWF9JTlZFU1RPUjsgaSsrKSB7CiAgICAgICAgICAgIHNlc3Npb24uaW52ZXN0b3JbaV0gPSAweDA7CiAgICAgICAgICAgIHNlc3Npb24ud2luW2ldID0gZmFsc2U7CiAgICAgICAgICAgIHNlc3Npb24uYW1vdW50SW52ZXN0W2ldID0gMDsKICAgICAgICB9CiAgICB9CiAgICAKICAgIC8vLyBAZGV2IE9wZW4gbmV3IHNlc3Npb24sIG9ubHkgZXNjcm93IGNhbiBjYWxsCiAgICBmdW5jdGlvbiBvcGVuU2Vzc2lvbiAoKQogICAgICAgIHB1YmxpYwogICAgICAgIG9ubHlFc2Nyb3cKICAgIHsKICAgICAgICByZXF1aXJlKHNlc3Npb24uaXNSZXNldCAmJiAhc2Vzc2lvbi5pc09wZW4pOwogICAgICAgIHNlc3Npb24uaXNSZXNldCA9IGZhbHNlOwogICAgICAgIC8vIG9wZW4gaW52ZXN0CiAgICAgICAgc2Vzc2lvbi5pbnZlc3RPcGVuID0gdHJ1ZTsKICAgICAgICBzZXNzaW9uLnRpbWVPcGVuID0gbm93OwogICAgICAgIHNlc3Npb24uaXNPcGVuID0gdHJ1ZTsKICAgICAgICBlbWl0IFNlc3Npb25PcGVuKG5vdywgc2Vzc2lvbklkKTsKICAgIH0KICAgIAogICAgLy8vIEBkZXYgRnVjdGlvbiBmb3IgaW52ZXN0b3IsIG1pbmltdW4gZXRoZXIgc2VuZCBpcyAwLjEsIG9uZSBhZGRyZXNzIGNhbiBjYWxsIG9uZSB0aW1lIGluIG9uZSBzZXNzaW9uCiAgICAvLy8gQHBhcmFtIF9jaG9vc2UgY2hvaXNlIG9mIGludmVzdG9yLCB0cnVlIGlzIGNhbGwsIGZhbHNlIGlzIHB1dAogICAgZnVuY3Rpb24gaW52ZXN0IChib29sIF9jaG9vc2UpCiAgICAgICAgcHVibGljCiAgICAgICAgcGF5YWJsZQogICAgewogICAgICAgIHJlcXVpcmUobXNnLnZhbHVlID49IG1pbmltdW5FdGggJiYgc2Vzc2lvbi5pbnZlc3RPcGVuKTsgLy8gbXNnLnZhbHVlID49IDAuMSBldGhlcgogICAgICAgIHJlcXVpcmUobm93IDwgKHNlc3Npb24udGltZU9wZW4gKyB0aW1lSW52ZXN0SW5NaW51dGUgKiAxIG1pbnV0ZXMpKTsKICAgICAgICByZXF1aXJlKHNlc3Npb24uaW52ZXN0b3JDb3VudCA8IE1BWF9JTlZFU1RPUik7CiAgICAgICAgc2Vzc2lvbi5pbnZlc3RvcltzZXNzaW9uLmludmVzdG9yQ291bnRdID0gbXNnLnNlbmRlcjsKICAgICAgICBzZXNzaW9uLndpbltzZXNzaW9uLmludmVzdG9yQ291bnRdID0gX2Nob29zZTsKICAgICAgICBzZXNzaW9uLmFtb3VudEludmVzdFtzZXNzaW9uLmludmVzdG9yQ291bnRdID0gbXNnLnZhbHVlOwogICAgICAgIHNlc3Npb24uaW52ZXN0b3JDb3VudCArPSAxOwogICAgICAgIGVtaXQgSW52ZXN0KG1zZy5zZW5kZXIsIF9jaG9vc2UsIG1zZy52YWx1ZSwgbm93LCBzZXNzaW9uSWQpOwogICAgfQogICAgCiAgICAvLy8gQGRldiBjbG9zZSBpbnZlc3QgZm9yIGVzY3JvdwogICAgLy8vIEBwYXJhbSBfcHJpY2VPcGVuIHByaWNlIEVUSCBpbiBVU0QKICAgIGZ1bmN0aW9uIGNsb3NlSW52ZXN0ICh1aW50IF9wcmljZU9wZW4pIAogICAgICAgIHB1YmxpYwogICAgICAgIG9ubHlFc2Nyb3cKICAgIHsKICAgICAgICByZXF1aXJlKF9wcmljZU9wZW4gIT0gMCAmJiBzZXNzaW9uLmludmVzdE9wZW4pOwogICAgICAgIHJlcXVpcmUobm93ID4gKHNlc3Npb24udGltZU9wZW4gKyB0aW1lSW52ZXN0SW5NaW51dGUgKiAxIG1pbnV0ZXMpKTsKICAgICAgICBzZXNzaW9uLmludmVzdE9wZW4gPSBmYWxzZTsKICAgICAgICBzZXNzaW9uLnByaWNlT3BlbiA9IF9wcmljZU9wZW47CiAgICAgICAgZW1pdCBJbnZlc3RDbG9zZShub3csIF9wcmljZU9wZW4sIHNlc3Npb25JZCk7CiAgICB9CiAgICAKICAgIC8vLyBAZGV2IGdldCBhbW91bnQgb2YgZXRoZXIgdG8gYnV5IE5BQyBmb3IgaW52ZXN0b3IKICAgIC8vLyBAcGFyYW0gX2V0aGVyIGFtb3VudCBldGhlciB3aGljaCBpbnZlc3RvciBpbnZlc3QKICAgIC8vLyBAcGFyYW0gX3N0YXR1cyB0cnVlIGZvciBpbnZlc3RvciB3aW4gYW5kIGZhbHNlIGZvciBpbnZlc3RvciBsb3NzCiAgICBmdW5jdGlvbiBnZXRFdGhlclRvQnV5ICh1aW50IF9ldGhlciwgYm9vbCBfc3RhdHVzKQogICAgICAgIHB1YmxpYwogICAgICAgIHZpZXcKICAgICAgICByZXR1cm5zICh1aW50KQogICAgewogICAgICAgIGlmIChfc3RhdHVzKSB7CiAgICAgICAgICAgIHJldHVybiBfZXRoZXIgKiByYXRlV2luIC8gMTAwOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBfZXRoZXIgKiByYXRlTG9zcyAvIDEwMDsKICAgICAgICB9CiAgICB9CgogICAgLy8vIEBkZXYgY2xvc2Ugc2Vzc2lvbiwgb25seSBlc2Nyb3cgY2FuIGNhbGwKICAgIC8vLyBAcGFyYW0gX3ByaWNlQ2xvc2UgcHJpY2Ugb2YgRVRIIGluIFVTRAogICAgZnVuY3Rpb24gY2xvc2VTZXNzaW9uICh1aW50IF9wcmljZUNsb3NlKQogICAgICAgIHB1YmxpYwogICAgICAgIG9ubHlFc2Nyb3cKICAgIHsKICAgICAgICByZXF1aXJlKF9wcmljZUNsb3NlICE9IDAgJiYgbm93ID4gKHNlc3Npb24udGltZU9wZW4gKyB0aW1lT25lU2Vzc2lvbiAqIDEgbWludXRlcykpOwogICAgICAgIHJlcXVpcmUoIXNlc3Npb24uaW52ZXN0T3BlbiAmJiBzZXNzaW9uLmlzT3Blbik7CiAgICAgICAgc2Vzc2lvbi5wcmljZUNsb3NlID0gX3ByaWNlQ2xvc2U7CiAgICAgICAgYm9vbCByZXN1bHQgPSAoX3ByaWNlQ2xvc2U+c2Vzc2lvbi5wcmljZU9wZW4pP3RydWU6ZmFsc2U7CiAgICAgICAgdWludCBldGhlclRvQnV5OwogICAgICAgIE5hbWlDcm93ZFNhbGUgbmFtaUNvbnRyYWN0ID0gTmFtaUNyb3dkU2FsZShuYW1pQ3Jvd2RTYWxlQWRkcik7CiAgICAgICAgdWludCBwcmljZSA9IG5hbWlDb250cmFjdC5nZXRQcmljZSgpOwogICAgICAgIHJlcXVpcmUocHJpY2UgIT0gMCk7CiAgICAgICAgZm9yICh1aW50IGkgPSAwOyBpIDwgc2Vzc2lvbi5pbnZlc3RvckNvdW50OyBpKyspIHsKICAgICAgICAgICAgaWYgKHNlc3Npb24ud2luW2ldPT1yZXN1bHQpIHsKICAgICAgICAgICAgICAgIGV0aGVyVG9CdXkgPSAoc2Vzc2lvbi5hbW91bnRJbnZlc3RbaV0gLSBzZXNzaW9uLmFtb3VudEludmVzdFtpXSAqIHJhdGVGZWUgLyAxMDApICogcmF0ZVdpbiAvIDEwMDsKICAgICAgICAgICAgICAgIHVpbnQgZXRoZXJSZXR1cm4gPSBzZXNzaW9uLmFtb3VudEludmVzdFtpXSAtIHNlc3Npb24uYW1vdW50SW52ZXN0W2ldICogcmF0ZUZlZSAvIDEwMDsKICAgICAgICAgICAgICAgIChzZXNzaW9uLmludmVzdG9yW2ldKS50cmFuc2ZlcihldGhlclJldHVybik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBldGhlclRvQnV5ID0gKHNlc3Npb24uYW1vdW50SW52ZXN0W2ldIC0gc2Vzc2lvbi5hbW91bnRJbnZlc3RbaV0gKiByYXRlRmVlIC8gMTAwKSAqIHJhdGVMb3NzIC8gMTAwOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5hbWlDb250cmFjdC5idXkudmFsdWUoZXRoZXJUb0J1eSkoc2Vzc2lvbi5pbnZlc3RvcltpXSk7CiAgICAgICAgICAgIC8vIHJlc2V0IGludmVzdG9yCiAgICAgICAgICAgIHNlc3Npb24uaW52ZXN0b3JbaV0gPSAweDA7CiAgICAgICAgICAgIHNlc3Npb24ud2luW2ldID0gZmFsc2U7CiAgICAgICAgICAgIHNlc3Npb24uYW1vdW50SW52ZXN0W2ldID0gMDsKICAgICAgICB9CiAgICAgICAgc2Vzc2lvbi5pc09wZW4gPSBmYWxzZTsKICAgICAgICBlbWl0IFNlc3Npb25DbG9zZShub3csIHNlc3Npb25JZCwgX3ByaWNlQ2xvc2UsIHByaWNlLCByYXRlV2luLCByYXRlTG9zcywgcmF0ZUZlZSk7CiAgICAgICAgc2Vzc2lvbklkICs9IDE7CiAgICAgICAgCiAgICAgICAgLy8gcmVxdWlyZSghc2Vzc2lvbi5pc1Jlc2V0ICYmICFzZXNzaW9uLmlzT3Blbik7CiAgICAgICAgLy8gcmVzZXQgc3RhdGUgc2Vzc2lvbgogICAgICAgIHNlc3Npb24ucHJpY2VPcGVuID0gMDsKICAgICAgICBzZXNzaW9uLnByaWNlQ2xvc2UgPSAwOwogICAgICAgIHNlc3Npb24uaXNSZXNldCA9IHRydWU7CiAgICAgICAgc2Vzc2lvbi5pbnZlc3RPcGVuID0gZmFsc2U7CiAgICAgICAgc2Vzc2lvbi5pbnZlc3RvckNvdW50ID0gMDsKICAgIH0KfQoKCgoKCi8qCiogQmluYXJ5IG9wdGlvbiBzbWFydCBjb250cmFjdCBOQUMgdG8gRVRILS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoqLwpjb250cmFjdCBCaW5hcnlPcHRpb25WMiB7CiAgICB1c2luZyBTYWZlTWF0aCBmb3IgdWludDI1NjsKICAgIC8qCiAgICAgKiBiaW5hcnkgb3B0aW9uIGNvbnRyb2xlZCBieSBlc2Nyb3cgdG8gYnV5IE5BQyB3aXRoIGdvb2QgcHJpY2UKICAgICAqLwogICAgLy8gTmFtaUNyb3dkU2FsZSBhZGRyZXNzCiAgICBhZGRyZXNzIHB1YmxpYyBOYW1pQWRkcjsKICAgIGFkZHJlc3MgcHVibGljIGVzY3JvdzsKICAgIAogICAgLy8gbmFtaU11bHRpU2lnV2FsbGV0CiAgICBhZGRyZXNzIHB1YmxpYyBuYW1pTXVsdGlTaWdXYWxsZXQ7CiAgICAKICAgIFNlc3Npb24gcHVibGljIHNlc3Npb247CiAgICB1aW50IHB1YmxpYyB0aW1lSW52ZXN0SW5NaW51dGUgPSAxNTsKICAgIHVpbnQgcHVibGljIHRpbWVPbmVTZXNzaW9uID0gMjA7CiAgICB1aW50IHB1YmxpYyBzZXNzaW9uSWQgPSAxOwogICAgdWludCBwdWJsaWMgcmF0ZVdpbiA9IDIwMDsKICAgIHVpbnQgcHVibGljIHJhdGVMb3NzID0gMDsKICAgIHVpbnQgcHVibGljIHJhdGVGZWUgPSA1OwogICAgdWludCBwdWJsaWMgY29uc3RhbnQgTUFYX0lOVkVTVE9SID0gMjA7CiAgICB1aW50IHB1YmxpYyBtaW5OYWMgPSAxMDAwMDAwMDAwMDAwMDAwMDAwMDA7IC8vIDEwMCBOYWMKICAgIHVpbnQgcHVibGljIHRvdGFsRmNpID0gMDsKICAgIHVpbnQgcHVibGljIHRvdGFsTmFjSW5Qb29sID0gMDsKICAgIGJvb2wgaXNFbXB0eVBvb2wgPSB0cnVlOwogICAgYm9vbCBwdWJsaWMgaXNUcmFkYWJsZUZjaUluU2Vzc2lvbiA9IGZhbHNlOwogICAgLyoqCiAgICAgKiBFdmVudHMgZm9yIGJpbmFueSBvcHRpb24gc3lzdGVtCiAgICAgKi8KICAgIGV2ZW50IFNlc3Npb25PcGVuKHVpbnQgdGltZU9wZW4sIHVpbnQgaW5kZXhlZCBzZXNzaW9uSWQpOwogICAgZXZlbnQgSW52ZXN0Q2xvc2UodWludCB0aW1lSW52ZXN0Q2xvc2UsIHVpbnQgcHJpY2VPcGVuLCB1aW50IGluZGV4ZWQgc2Vzc2lvbklkKTsKICAgIGV2ZW50IEludmVzdChhZGRyZXNzIGluZGV4ZWQgaW52ZXN0b3IsIHVpbnQgY2hvb3NlLCB1aW50IGFtb3VudCwgdWludCB0aW1lSW52ZXN0LCB1aW50IGluZGV4ZWQgc2Vzc2lvbklkKTsKICAgIGV2ZW50IEludmVzdFRvUG9vbChhZGRyZXNzIGluZGV4ZWQgaW52ZXN0b3IsIHVpbnQgYW1vdW50LCB1aW50IHRpbWVJbnZlc3QpOwogICAgZXZlbnQgU2Vzc2lvbkNsb3NlKHVpbnQgdGltZUNsb3NlLCB1aW50IGluZGV4ZWQgc2Vzc2lvbklkLCB1aW50IHByaWNlQ2xvc2UsIHVpbnQgcmF0ZVdpbiwgdWludCByYXRlTG9zcywgdWludCByYXRlRmVlKTsKCiAgICBldmVudCBEZXBvc2l0KGFkZHJlc3MgaW5kZXhlZCBzZW5kZXIsIHVpbnQgdmFsdWUpOwogICAgLy8vIEBkZXYgRmFsbGJhY2sgZnVuY3Rpb24gYWxsb3dzIHRvIGRlcG9zaXQgZXRoZXIuCiAgICBmdW5jdGlvbigpIHB1YmxpYyBwYXlhYmxlIHsKICAgICAgICBpZiAobXNnLnZhbHVlID4gMCkKICAgICAgICAgICAgZW1pdCBEZXBvc2l0KG1zZy5zZW5kZXIsIG1zZy52YWx1ZSk7CiAgICB9CiAgICAKICAgIC8vIHRoZXJlIGlzIG9ubHkgb25lIHNlc3Npb24gYXZhaWxhYmxlIGF0IG9uZSB0aW1lT3BlbgogICAgLy8gcHJpY2VPcGVuIGlzIHByaWNlIG9mIEVUSCBpbiBVU0QKICAgIC8vIHByaWNlQ2xvc2UgaXMgcHJpY2Ugb2YgRVRIIGluIFVTRAogICAgLy8gcHJvY2VzcyBvZiBvbmUgU2Vzc2lvbgogICAgLy8gMXN0OiBlc2Nyb3cgcmVzZXQgc2Vzc2lvbiBieSBydW4gcmVzZXRTZXNzaW9uKCkKICAgIC8vIDJuZDogZXNjcm93IG9wZW4gc2Vzc2lvbiBieSBydW4gb3BlblNlc3Npb24oKSA9PiBzYXZlIHRpbWVPcGVuIGF0IHRoaXMgdGltZQogICAgLy8gM3JkOiBhbGwgaW52ZXN0b3IgY2FuIGludmVzdCBieSBydW4gaW52ZXN0KCksIHNlbmQgbWluaW11bSAwLjEgRVRICiAgICAvLyA0dGg6IGVzY3JvdyBjbG9zZSBpbnZlc3QgYW5kIGluc2VydCBwcmljZSBvcGVuIGZvciB0aGlzIFNlc3Npb24KICAgIC8vIDV0aDogZXNjcm93IGNsb3NlIHNlc3Npb24gYW5kIHNlbmQgTkFDIGZvciBpbnZlc3RvcgogICAgc3RydWN0IFNlc3Npb24gewogICAgICAgIHVpbnQgcHJpY2VPcGVuOwogICAgICAgIHVpbnQgcHJpY2VDbG9zZTsKICAgICAgICB1aW50IHRpbWVPcGVuOwogICAgICAgIGJvb2wgaXNSZXNldDsKICAgICAgICBib29sIGlzT3BlbjsKICAgICAgICBib29sIGludmVzdE9wZW47CiAgICAgICAgdWludCBpbnZlc3RvckNvdW50OwogICAgICAgIG1hcHBpbmcodWludCA9PiBhZGRyZXNzKSBpbnZlc3RvcjsKICAgICAgICBtYXBwaW5nKHVpbnQgPT4gdWludCkgd2luOwogICAgICAgIG1hcHBpbmcodWludCA9PiB1aW50KSBhbW91bnRJbnZlc3Q7CiAgICB9CiAgICAKICAgIC8vIGxpc3QgZmNpCiAgICBtYXBwaW5nKGFkZHJlc3MgPT4gdWludCkgcHVibGljIGZjaTsKICAgIAogICAgZnVuY3Rpb24gQmluYXJ5T3B0aW9uVjIoYWRkcmVzcyBfbmFtaUNyb3dkU2FsZSwgYWRkcmVzcyBfZXNjcm93LCBhZGRyZXNzIF9uYW1pTXVsdGlTaWdXYWxsZXQpIHB1YmxpYyB7CiAgICAgICAgcmVxdWlyZShfbmFtaUNyb3dkU2FsZSAhPSAweDAgJiYgX2VzY3JvdyAhPSAweDApOwogICAgICAgIE5hbWlBZGRyID0gX25hbWlDcm93ZFNhbGU7CiAgICAgICAgZXNjcm93ID0gX2VzY3JvdzsKICAgICAgICBuYW1pTXVsdGlTaWdXYWxsZXQgPSBfbmFtaU11bHRpU2lnV2FsbGV0OwogICAgfQogICAgCiAgICAKICAgIG1vZGlmaWVyIG9ubHlFc2Nyb3coKSB7CiAgICAgICAgcmVxdWlyZShtc2cuc2VuZGVyPT1lc2Nyb3cpOwogICAgICAgIF87CiAgICB9CiAgICAKICAgIG1vZGlmaWVyIG9ubHlOYW1pIHsKICAgICAgICByZXF1aXJlKG1zZy5zZW5kZXIgPT0gTmFtaUFkZHIpOwogICAgICAgIF87CiAgICB9CiAgICAKICAgICAgICAKICAgIG1vZGlmaWVyIG9ubHlOYW1pTXVsdGlzaWcoKSB7CiAgICAgICAgcmVxdWlyZShtc2cuc2VuZGVyID09IG5hbWlNdWx0aVNpZ1dhbGxldCk7CiAgICAgICAgXzsKICAgIH0KICAgIAogICAgLy8gY2hhbmdlIGVzY3JvdwogICAgZnVuY3Rpb24gY2hhbmdlRXNjcm93KGFkZHJlc3MgX2VzY3JvdykgcHVibGljCiAgICAgICAgb25seU5hbWlNdWx0aXNpZwogICAgewogICAgICAgIHJlcXVpcmUoX2VzY3JvdyAhPSAweDApOwogICAgICAgIGVzY3JvdyA9IF9lc2Nyb3c7CiAgICB9CiAgICAKICAgIC8vIGNoYW5nZSBtaW5pbXVtIG5hYyBpbiBvbmUgb3JkZXIKICAgIGZ1bmN0aW9uIGNoYW5nZU1pbk5hYyh1aW50IF9taW5OQUMpIHB1YmxpYwogICAgICAgIG9ubHlFc2Nyb3cKICAgIHsKICAgICAgICByZXF1aXJlKF9taW5OQUMgIT0gMCk7CiAgICAgICAgbWluTmFjID0gX21pbk5BQzsKICAgIH0KICAgIAogICAgLy8vIEBkZXYgQ2hhbmdlIHRpbWUgZm9yIGludmVzdG9yIGNhbiBpbnZlc3QgaW4gb25lIHNlc3Npb24sIGNhbiBvbmx5IGNoYW5nZSBhdCB0aW1lIG5vdCBpbiBzZXNzaW9uCiAgICAvLy8gQHBhcmFtIF90aW1lSW52ZXN0IHRpbWUgaW52ZXN0IGluIG1pbnV0ZXMKICAgIC8vLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLWNoYW5nZSB0aW1lIGZ1bmN0aW9uLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICBmdW5jdGlvbiBjaGFuZ2VUaW1lSW52ZXN0KHVpbnQgX3RpbWVJbnZlc3QpCiAgICAgICAgcHVibGljCiAgICAgICAgb25seUVzY3JvdwogICAgewogICAgICAgIHJlcXVpcmUoIXNlc3Npb24uaXNPcGVuICYmIF90aW1lSW52ZXN0IDwgdGltZU9uZVNlc3Npb24pOwogICAgICAgIHRpbWVJbnZlc3RJbk1pbnV0ZSA9IF90aW1lSW52ZXN0OwogICAgfQoKICAgIGZ1bmN0aW9uIGNoYW5nZVRpbWVPbmVTZXNzaW9uKHVpbnQgX3RpbWVPbmVTZXNzaW9uKSAKICAgICAgICBwdWJsaWMKICAgICAgICBvbmx5RXNjcm93CiAgICB7CiAgICAgICAgcmVxdWlyZSghc2Vzc2lvbi5pc09wZW4gJiYgX3RpbWVPbmVTZXNzaW9uID4gdGltZUludmVzdEluTWludXRlKTsKICAgICAgICB0aW1lT25lU2Vzc2lvbiA9IF90aW1lT25lU2Vzc2lvbjsKICAgIH0KICAgIAogICAgZnVuY3Rpb24gY2hhbmdlVHJhZGFibGVGY2lJblNlc3Npb24oYm9vbCBfaXNUcmFkYWJsZUZjaUluUG9vbCkKICAgICAgICBwdWJsaWMKICAgICAgICBvbmx5RXNjcm93CiAgICB7CiAgICAgICAgaXNUcmFkYWJsZUZjaUluU2Vzc2lvbiA9IF9pc1RyYWRhYmxlRmNpSW5Qb29sOwogICAgfQoKICAgIAogICAgLy8vLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1jaGFuZ2UgcmF0ZSBmdW5jdGlvbi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIAogICAgZnVuY3Rpb24gY2hhbmdlUmF0ZVdpbih1aW50IF9yYXRlV2luKQogICAgICAgIHB1YmxpYwogICAgICAgIG9ubHlFc2Nyb3cKICAgIHsKICAgICAgICByZXF1aXJlKCFzZXNzaW9uLmlzT3Blbik7CiAgICAgICAgcmF0ZVdpbiA9IF9yYXRlV2luOwogICAgfQogICAgCiAgICBmdW5jdGlvbiBjaGFuZ2VSYXRlTG9zcyh1aW50IF9yYXRlTG9zcykKICAgICAgICBwdWJsaWMKICAgICAgICBvbmx5RXNjcm93CiAgICB7CiAgICAgICAgcmVxdWlyZSghc2Vzc2lvbi5pc09wZW4pOwogICAgICAgIHJhdGVMb3NzID0gX3JhdGVMb3NzOwogICAgfQogICAgCiAgICBmdW5jdGlvbiBjaGFuZ2VSYXRlRmVlKHVpbnQgX3JhdGVGZWUpCiAgICAgICAgcHVibGljCiAgICAgICAgb25seUVzY3JvdwogICAgewogICAgICAgIHJlcXVpcmUoIXNlc3Npb24uaXNPcGVuKTsKICAgICAgICByYXRlRmVlID0gX3JhdGVGZWU7CiAgICB9CiAgICAKICAgIAogICAgLy8vIEBkZXYgd2l0aGRyYXcgZXRoZXIgdG8gbmFtaSBtdWx0aXNpZ25hdHVyZSB3YWxsZXQsIG9ubHkgZXNjcm93IGNhbiBjYWxsCiAgICAvLy8gQHBhcmFtIF9hbW91bnQgdmFsdWUgZXRoZXIgaW4gd2VpIHRvIHdpdGhkcmF3CiAgICBmdW5jdGlvbiB3aXRoZHJhd0V0aGVyKHVpbnQgX2Ftb3VudCkgcHVibGljCiAgICAgICAgb25seUVzY3JvdwogICAgewogICAgICAgIHJlcXVpcmUobmFtaU11bHRpU2lnV2FsbGV0ICE9IDB4MCk7CiAgICAgICAgLy8gQXZhaWxhYmxlIGF0IGFueSBwaGFzZS4KICAgICAgICBpZiAoYWRkcmVzcyh0aGlzKS5iYWxhbmNlID4gMCkgewogICAgICAgICAgICBuYW1pTXVsdGlTaWdXYWxsZXQudHJhbnNmZXIoX2Ftb3VudCk7CiAgICAgICAgfQogICAgfQogICAgCiAgICAKICAgIC8vLyBAZGV2IHdpdGhkcmF3IE5BQyB0byBuYW1pIG11bHRpc2lnbmF0dXJlIHdhbGxldCwgb25seSBlc2Nyb3cgY2FuIGNhbGwKICAgIC8vLyBAcGFyYW0gX2Ftb3VudCB2YWx1ZSBOQUMgdG8gd2l0aGRyYXcKICAgIGZ1bmN0aW9uIHdpdGhkcmF3TmFjKHVpbnQgX2Ftb3VudCkgcHVibGljCiAgICAgICAgb25seUVzY3JvdwogICAgewogICAgICAgIHJlcXVpcmUobmFtaU11bHRpU2lnV2FsbGV0ICE9IDB4MCk7CiAgICAgICAgLy8gQXZhaWxhYmxlIGF0IGFueSBwaGFzZS4KICAgICAgICBOYW1pQ3Jvd2RTYWxlIG5hbWlUb2tlbiA9IE5hbWlDcm93ZFNhbGUoTmFtaUFkZHIpOwogICAgICAgIGlmIChuYW1pVG9rZW4uYmFsYW5jZU9mKGFkZHJlc3ModGhpcykpID4gMCkgewogICAgICAgICAgICBuYW1pVG9rZW4udHJhbnNmZXIobmFtaU11bHRpU2lnV2FsbGV0LCBfYW1vdW50KTsKICAgICAgICB9CiAgICB9CiAgICAKICAgICAgICAKICAgIC8vLyBAZGV2IHNhZmUgd2l0aGRyYXcgRXRoZXIgdG8gb25lIG9mIG93bmVyIG9mIG5hbWkgbXVsdGlzaWduYXR1cmUgd2FsbGV0CiAgICAvLy8gQHBhcmFtIF93aXRoZHJhdyBhZGRyZXNzIHRvIHdpdGhkcmF3CiAgICBmdW5jdGlvbiBzYWZlV2l0aGRyYXcoYWRkcmVzcyBfd2l0aGRyYXcsIHVpbnQgX2Ftb3VudCkgcHVibGljCiAgICAgICAgb25seUVzY3JvdwogICAgewogICAgICAgIE5hbWlNdWx0aVNpZ1dhbGxldCBuYW1pV2FsbGV0ID0gTmFtaU11bHRpU2lnV2FsbGV0KG5hbWlNdWx0aVNpZ1dhbGxldCk7CiAgICAgICAgaWYgKG5hbWlXYWxsZXQuaXNPd25lcihfd2l0aGRyYXcpKSB7CiAgICAgICAgICAgIF93aXRoZHJhdy50cmFuc2ZlcihfYW1vdW50KTsKICAgICAgICB9CiAgICB9CiAgICAKICAgIC8vIEBkZXYgUmV0dXJucyBsaXN0IG9mIG93bmVycy4KICAgIC8vIEByZXR1cm4gTGlzdCBvZiBvd25lciBhZGRyZXNzZXMuCiAgICAvLyBNQVhfSU5WRVNUT1IgPSAyMAogICAgZnVuY3Rpb24gZ2V0SW52ZXN0b3JzKCkKICAgICAgICBwdWJsaWMKICAgICAgICB2aWV3CiAgICAgICAgcmV0dXJucyAoYWRkcmVzc1syMF0pCiAgICB7CiAgICAgICAgYWRkcmVzc1syMF0gbWVtb3J5IGxpc3RJbnZlc3RvcjsKICAgICAgICBmb3IgKHVpbnQgaSA9IDA7IGkgPCBNQVhfSU5WRVNUT1I7IGkrKykgewogICAgICAgICAgICBsaXN0SW52ZXN0b3JbaV0gPSBzZXNzaW9uLmludmVzdG9yW2ldOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbGlzdEludmVzdG9yOwogICAgfQogICAgCiAgICBmdW5jdGlvbiBnZXRDaG9vc2VzKCkKICAgICAgICBwdWJsaWMKICAgICAgICB2aWV3CiAgICAgICAgcmV0dXJucyAodWludFsyMF0pCiAgICB7CiAgICAgICAgdWludFsyMF0gbWVtb3J5IGxpc3RDaG9vc2VzOwogICAgICAgIGZvciAodWludCBpID0gMDsgaSA8IE1BWF9JTlZFU1RPUjsgaSsrKSB7CiAgICAgICAgICAgIGxpc3RDaG9vc2VzW2ldID0gc2Vzc2lvbi53aW5baV07CiAgICAgICAgfQogICAgICAgIHJldHVybiBsaXN0Q2hvb3NlczsKICAgIH0KICAgIAogICAgZnVuY3Rpb24gZ2V0QW1vdW50KCkKICAgICAgICBwdWJsaWMKICAgICAgICB2aWV3CiAgICAgICAgcmV0dXJucyAodWludFsyMF0pCiAgICB7CiAgICAgICAgdWludFsyMF0gbWVtb3J5IGxpc3RBbW91bnQ7CiAgICAgICAgZm9yICh1aW50IGkgPSAwOyBpIDwgTUFYX0lOVkVTVE9SOyBpKyspIHsKICAgICAgICAgICAgbGlzdEFtb3VudFtpXSA9IHNlc3Npb24uYW1vdW50SW52ZXN0W2ldOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbGlzdEFtb3VudDsKICAgIH0KICAgIAogICAgLy8vIEBkZXYgcmVzZXQgYWxsIGRhdGEgb2YgcHJldmlvdXMgc2Vzc2lvbiwgbXVzdCBydW4gYmVmb3JlIG9wZW4gbmV3IHNlc3Npb24KICAgIC8vIG9ubHkgZXNjcm93IGNhbiBjYWxsCiAgICBmdW5jdGlvbiByZXNldFNlc3Npb24oKQogICAgICAgIHB1YmxpYwogICAgICAgIG9ubHlFc2Nyb3cKICAgIHsKICAgICAgICByZXF1aXJlKCFzZXNzaW9uLmlzUmVzZXQgJiYgIXNlc3Npb24uaXNPcGVuKTsKICAgICAgICBzZXNzaW9uLnByaWNlT3BlbiA9IDA7CiAgICAgICAgc2Vzc2lvbi5wcmljZUNsb3NlID0gMDsKICAgICAgICBzZXNzaW9uLmlzUmVzZXQgPSB0cnVlOwogICAgICAgIHNlc3Npb24uaXNPcGVuID0gZmFsc2U7CiAgICAgICAgc2Vzc2lvbi5pbnZlc3RPcGVuID0gZmFsc2U7CiAgICAgICAgc2Vzc2lvbi5pbnZlc3RvckNvdW50ID0gMDsKICAgICAgICBmb3IgKHVpbnQgaSA9IDA7IGkgPCBNQVhfSU5WRVNUT1I7IGkrKykgewogICAgICAgICAgICBzZXNzaW9uLmludmVzdG9yW2ldID0gMHgwOwogICAgICAgICAgICBzZXNzaW9uLndpbltpXSA9IDA7CiAgICAgICAgICAgIHNlc3Npb24uYW1vdW50SW52ZXN0W2ldID0gMDsKICAgICAgICB9CiAgICB9CiAgICAKICAgIC8vLyBAZGV2IE9wZW4gbmV3IHNlc3Npb24sIG9ubHkgZXNjcm93IGNhbiBjYWxsCiAgICBmdW5jdGlvbiBvcGVuU2Vzc2lvbiAoKQogICAgICAgIHB1YmxpYwogICAgICAgIG9ubHlFc2Nyb3cKICAgIHsKICAgICAgICBOYW1pQ3Jvd2RTYWxlIG5hbWlUb2tlbiA9IE5hbWlDcm93ZFNhbGUoTmFtaUFkZHIpOwogICAgICAgIHJlcXVpcmUobmFtaVRva2VuLmJhbGFuY2VPZihhZGRyZXNzKHRoaXMpKSA+IDApOwogICAgICAgIHJlcXVpcmUoc2Vzc2lvbi5pc1Jlc2V0ICYmICFzZXNzaW9uLmlzT3Blbik7CiAgICAgICAgc2Vzc2lvbi5pc1Jlc2V0ID0gZmFsc2U7CiAgICAgICAgLy8gb3BlbiBpbnZlc3QKICAgICAgICBzZXNzaW9uLmludmVzdE9wZW4gPSB0cnVlOwogICAgICAgIHNlc3Npb24udGltZU9wZW4gPSBub3c7CiAgICAgICAgc2Vzc2lvbi5pc09wZW4gPSB0cnVlOwogICAgICAgIGVtaXQgU2Vzc2lvbk9wZW4obm93LCBzZXNzaW9uSWQpOwogICAgfQogICAgCiAgICBmdW5jdGlvbiBzZXRQb29sU3RhdHVzKCkKICAgICAgICBwdWJsaWMKICAgICAgICBvbmx5RXNjcm93CiAgICB7CiAgICAgICAgTmFtaUNyb3dkU2FsZSBuYW1pVG9rZW4gPSBOYW1pQ3Jvd2RTYWxlKE5hbWlBZGRyKTsKICAgICAgICBpZihuYW1pVG9rZW4uYmFsYW5jZU9mKGFkZHJlc3ModGhpcykpID09IDApIHsKICAgICAgICAgICAgaXNFbXB0eVBvb2wgPSB0cnVlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlzRW1wdHlQb29sID0gZmFsc2U7CiAgICAgICAgfQogICAgfQogICAgCiAgICAvLy8gQGRldiBGdWN0aW9uIGZvciBpbnZlc3RvciwgbWluaW11biBldGhlciBzZW5kIGlzIDAuMSwgb25lIGFkZHJlc3MgY2FuIGNhbGwgb25lIHRpbWUgaW4gb25lIHNlc3Npb24KICAgIC8vLyBAcGFyYW0gX2Nob29zZSBjaG9pc2Ugb2YgaW52ZXN0b3IsIHRydWUgaXMgY2FsbCwgZmFsc2UgaXMgcHV0CiAgICAvLyBmdW5jdGlvbiBpbnZlc3QgKGJvb2wgX2Nob29zZSkKICAgIC8vICAgICBwdWJsaWMKICAgIC8vICAgICBwYXlhYmxlCiAgICAvLyB7CiAgICAvLyAgICAgcmVxdWlyZShtc2cudmFsdWUgPj0gbWluaW11bkV0aCAmJiBzZXNzaW9uLmludmVzdE9wZW4pOyAvLyBtc2cudmFsdWUgPj0gMC4xIGV0aGVyCiAgICAvLyAgICAgcmVxdWlyZShub3cgPCAoc2Vzc2lvbi50aW1lT3BlbiArIHRpbWVJbnZlc3RJbk1pbnV0ZSAqIDEgbWludXRlcykpOwogICAgLy8gICAgIHJlcXVpcmUoc2Vzc2lvbi5pbnZlc3RvckNvdW50IDwgTUFYX0lOVkVTVE9SKTsKICAgIC8vICAgICBzZXNzaW9uLmludmVzdG9yW3Nlc3Npb24uaW52ZXN0b3JDb3VudF0gPSBtc2cuc2VuZGVyOwogICAgLy8gICAgIHNlc3Npb24ud2luW3Nlc3Npb24uaW52ZXN0b3JDb3VudF0gPSBfY2hvb3NlOwogICAgLy8gICAgIHNlc3Npb24uYW1vdW50SW52ZXN0W3Nlc3Npb24uaW52ZXN0b3JDb3VudF0gPSBtc2cudmFsdWU7CiAgICAvLyAgICAgc2Vzc2lvbi5pbnZlc3RvckNvdW50ICs9IDE7CiAgICAvLyAgICAgSW52ZXN0KG1zZy5zZW5kZXIsIF9jaG9vc2UsIG1zZy52YWx1ZSwgbm93LCBzZXNzaW9uSWQpOwogICAgLy8gfQogICAgCiAgICAKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSAKICAgIC8vLyBAZGV2IEZ1Y3Rpb24gZm9yIGludmVzdG9yLCBtaW5pbXVuIGV0aGVyIHNlbmQgaXMgMC4xLCBvbmUgYWRkcmVzcyBjYW4gY2FsbCBvbmUgdGltZSBpbiBvbmUgc2Vzc2lvbgogICAgLy8vIEBwYXJhbSBfY2hvb3NlIGNob2lzZSBvZiBpbnZlc3RvciwgdHJ1ZSBpcyBjYWxsLCBmYWxzZSBpcyBwdXQKICAgIAogICAgZnVuY3Rpb24gdG9rZW5GYWxsYmFja0V4Y2hhbmdlKGFkZHJlc3MgX2Zyb20sIHVpbnQgX3ZhbHVlLCB1aW50IF9jaG9vc2UpIG9ubHlOYW1pIHB1YmxpYyByZXR1cm5zIChib29sIHN1Y2Nlc3MpIHsKICAgICAgICBpZihfY2hvb3NlIDwgMikgewogICAgICAgICAgICByZXF1aXJlKF92YWx1ZSA+PSBtaW5OYWMgJiYgc2Vzc2lvbi5pbnZlc3RPcGVuKTsgLy8gbXNnLnZhbHVlID49IDAuMSBldGhlcgogICAgICAgICAgICByZXF1aXJlKG5vdyA8IChzZXNzaW9uLnRpbWVPcGVuICsgdGltZUludmVzdEluTWludXRlICogMSBtaW51dGVzKSk7CiAgICAgICAgICAgIHJlcXVpcmUoc2Vzc2lvbi5pbnZlc3RvckNvdW50IDwgTUFYX0lOVkVTVE9SKTsKICAgICAgICAgICAgLy8KICAgICAgICAgICAgc2Vzc2lvbi5pbnZlc3RvcltzZXNzaW9uLmludmVzdG9yQ291bnRdID0gX2Zyb207CiAgICAgICAgICAgIHNlc3Npb24ud2luW3Nlc3Npb24uaW52ZXN0b3JDb3VudF0gPSBfY2hvb3NlOwogICAgICAgICAgICBzZXNzaW9uLmFtb3VudEludmVzdFtzZXNzaW9uLmludmVzdG9yQ291bnRdID0gX3ZhbHVlOwogICAgICAgICAgICBzZXNzaW9uLmludmVzdG9yQ291bnQgKz0gMTsKICAgICAgICAgICAgZW1pdCBJbnZlc3QoX2Zyb20sIF9jaG9vc2UsIF92YWx1ZSwgbm93LCBzZXNzaW9uSWQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlcXVpcmUoX2Nob29zZT09MiAmJiBfdmFsdWUgPiAwKTsKICAgICAgICAgICAgYm9vbCBjaGVjayA9ICghc2Vzc2lvbi5pc09wZW4pIHx8IGlzVHJhZGFibGVGY2lJblNlc3Npb247CiAgICAgICAgICAgIHJlcXVpcmUoY2hlY2spOwogICAgICAgICAgICAvLyBjaGVjayBwb29sIGVtcHR5CiAgICAgICAgICAgIGlmKGlzRW1wdHlQb29sPT10cnVlKSB7CiAgICAgICAgICAgICAgICBmY2lbX2Zyb21dID0gKGZjaVtfZnJvbV0pLmFkZChfdmFsdWUpOwogICAgICAgICAgICAgICAgdG90YWxOYWNJblBvb2wgPSB0b3RhbE5hY0luUG9vbC5hZGQoX3ZhbHVlKTsKICAgICAgICAgICAgICAgIHRvdGFsRmNpID0gdG90YWxGY2kuYWRkKF92YWx1ZSk7CiAgICAgICAgICAgICAgICBpZih0b3RhbE5hY0luUG9vbCA+IDApIHsKICAgICAgICAgICAgICAgICAgICBpc0VtcHR5UG9vbCA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdWludCBmY2lSZWNlaXZlID0gKF92YWx1ZS5tdWwodG90YWxGY2kpKS5kaXYodG90YWxOYWNJblBvb2wpOwogICAgICAgICAgICAgICAgLy8gY2hlY2sgZmNpIHJlY2VpdmUKICAgICAgICAgICAgICAgIHJlcXVpcmUoZmNpUmVjZWl2ZSA+IDApOwogICAgICAgICAgICAgICAgZmNpW19mcm9tXSA9IGZjaVtfZnJvbV0uYWRkKGZjaVJlY2VpdmUpOwogICAgICAgICAgICAgICAgdG90YWxOYWNJblBvb2wgPSB0b3RhbE5hY0luUG9vbC5hZGQoX3ZhbHVlKTsKICAgICAgICAgICAgICAgIHRvdGFsRmNpID0gdG90YWxGY2kuYWRkKGZjaVJlY2VpdmUpOwogICAgICAgICAgICAgICAgaWYodG90YWxOYWNJblBvb2wgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgaXNFbXB0eVBvb2wgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBhZGQgc2hhcmVIb2xkZXIKICAgICAgICAgICAgLy8gdWludCBmY2lSZWNlaXZlID0gCiAgICAgICAgICAgIGVtaXQgSW52ZXN0VG9Qb29sKF9mcm9tLCBfdmFsdWUsIG5vdyk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgCiAgICAvLyBzZWxsIGZjaSBhbmQgcmVjZWl2ZSBOQUMgYmFjawogICAgCiAgICBmdW5jdGlvbiBzZWxsRmNpKHVpbnQgX2Ftb3VudCkgcHVibGljIHsKICAgICAgICBib29sIGNoZWNrID0gKCFzZXNzaW9uLmlzT3BlbikgfHwgaXNUcmFkYWJsZUZjaUluU2Vzc2lvbjsKICAgICAgICByZXF1aXJlKGNoZWNrICYmIGZjaVttc2cuc2VuZGVyXSA+PSBfYW1vdW50KTsKICAgICAgICBOYW1pQ3Jvd2RTYWxlIG5hbWlUb2tlbiA9IE5hbWlDcm93ZFNhbGUoTmFtaUFkZHIpOwogICAgICAgIHJlcXVpcmUobmFtaVRva2VuLmJhbGFuY2VPZihhZGRyZXNzKHRoaXMpKSA+IDAgJiYgdG90YWxOYWNJblBvb2wgPiAwKTsKICAgICAgICB1aW50IG5hY1JlY2VpdmUgPSAoX2Ftb3VudC5tdWwodG90YWxOYWNJblBvb2wpKS5kaXYodG90YWxGY2kpOwogICAgICAgIAogICAgICAgIC8vIGNoZWNrIG5hYyByZWNlaXZlCiAgICAgICAgcmVxdWlyZShuYWNSZWNlaXZlID4gMCk7CiAgICAgICAgZmNpW21zZy5zZW5kZXJdID0gZmNpW21zZy5zZW5kZXJdLnN1YihfYW1vdW50KTsKICAgICAgICB0b3RhbEZjaSA9IHRvdGFsRmNpLnN1YihfYW1vdW50KTsKICAgICAgICBuYW1pVG9rZW4udHJhbnNmZXIobXNnLnNlbmRlciwgbmFjUmVjZWl2ZSk7CiAgICAgICAgdG90YWxOYWNJblBvb2wgPSB0b3RhbE5hY0luUG9vbC5zdWIobmFjUmVjZWl2ZSk7CiAgICAgICAgaWYodG90YWxOYWNJblBvb2wgPT0gMCkgewogICAgICAgICAgICBpc0VtcHR5UG9vbCA9IHRydWU7CiAgICAgICAgfQogICAgfQogICAgCiAgICAvLy8gQGRldiBjbG9zZSBpbnZlc3QgZm9yIGVzY3JvdwogICAgLy8vIEBwYXJhbSBfcHJpY2VPcGVuIHByaWNlIEVUSCBpbiBVU0QKICAgIGZ1bmN0aW9uIGNsb3NlSW52ZXN0ICh1aW50IF9wcmljZU9wZW4pIAogICAgICAgIHB1YmxpYwogICAgICAgIG9ubHlFc2Nyb3cKICAgIHsKICAgICAgICByZXF1aXJlKF9wcmljZU9wZW4gIT0gMCAmJiBzZXNzaW9uLmludmVzdE9wZW4pOwogICAgICAgIHJlcXVpcmUobm93ID4gKHNlc3Npb24udGltZU9wZW4gKyB0aW1lSW52ZXN0SW5NaW51dGUgKiAxIG1pbnV0ZXMpKTsKICAgICAgICBzZXNzaW9uLmludmVzdE9wZW4gPSBmYWxzZTsKICAgICAgICBzZXNzaW9uLnByaWNlT3BlbiA9IF9wcmljZU9wZW47CiAgICAgICAgZW1pdCBJbnZlc3RDbG9zZShub3csIF9wcmljZU9wZW4sIHNlc3Npb25JZCk7CiAgICB9CiAgICAKICAgIC8vLyBAZGV2IGNsb3NlIHNlc3Npb24sIG9ubHkgZXNjcm93IGNhbiBjYWxsCiAgICAvLy8gQHBhcmFtIF9wcmljZUNsb3NlIHByaWNlIG9mIEVUSCBpbiBVU0QKICAgIGZ1bmN0aW9uIGNsb3NlU2Vzc2lvbiAodWludCBfcHJpY2VDbG9zZSkKICAgICAgICBwdWJsaWMKICAgICAgICBvbmx5RXNjcm93CiAgICB7CiAgICAgICAgcmVxdWlyZShfcHJpY2VDbG9zZSAhPSAwICYmIG5vdyA+IChzZXNzaW9uLnRpbWVPcGVuICsgdGltZU9uZVNlc3Npb24gKiAxIG1pbnV0ZXMpKTsKICAgICAgICByZXF1aXJlKCFzZXNzaW9uLmludmVzdE9wZW4gJiYgc2Vzc2lvbi5pc09wZW4pOwogICAgICAgIHNlc3Npb24ucHJpY2VDbG9zZSA9IF9wcmljZUNsb3NlOwogICAgICAgIHVpbnQgcmVzdWx0ID0gKF9wcmljZUNsb3NlPnNlc3Npb24ucHJpY2VPcGVuKT8xOjA7CiAgICAgICAgTmFtaUNyb3dkU2FsZSBuYW1pVG9rZW4gPSBOYW1pQ3Jvd2RTYWxlKE5hbWlBZGRyKTsKICAgICAgICB1aW50IG5hY1JldHVybjsKICAgICAgICAvLyB1aW50IHByaWNlID0gbmFtaVRva2VuLmdldFByaWNlKCk7CiAgICAgICAgLy8gcmVxdWlyZShwcmljZSAhPSAwKTsKICAgICAgICBmb3IgKHVpbnQgaSA9IDA7IGkgPCBzZXNzaW9uLmludmVzdG9yQ291bnQ7IGkrKykgewogICAgICAgICAgICBpZiAoc2Vzc2lvbi53aW5baV09PXJlc3VsdCkgewogICAgICAgICAgICAgICAgLy8gZXRoZXJUb0J1eSA9IChzZXNzaW9uLmFtb3VudEludmVzdFtpXSAtIHNlc3Npb24uYW1vdW50SW52ZXN0W2ldICogcmF0ZUZlZSAvIDEwMCkgKiByYXRlV2luIC8gMTAwOwogICAgICAgICAgICAgICAgLy8gdWludCBldGhlclJldHVybiA9IHNlc3Npb24uYW1vdW50SW52ZXN0W2ldIC0gc2Vzc2lvbi5hbW91bnRJbnZlc3RbaV0gKiByYXRlRmVlIC8gMTAwOwogICAgICAgICAgICAgICAgLy8gKHNlc3Npb24uaW52ZXN0b3JbaV0pLnRyYW5zZmVyKGV0aGVyUmV0dXJuKTsKICAgICAgICAgICAgICAgIG5hY1JldHVybiA9IChzZXNzaW9uLmFtb3VudEludmVzdFtpXSAtIHNlc3Npb24uYW1vdW50SW52ZXN0W2ldICogcmF0ZUZlZSAvIDEwMCkgKiByYXRlV2luIC8gMTAwOwogICAgICAgICAgICAgICAgcmVxdWlyZShuYW1pVG9rZW4uYmFsYW5jZU9mKGFkZHJlc3ModGhpcykpID49IG5hY1JldHVybik7CiAgICAgICAgICAgICAgICBuYW1pVG9rZW4udHJhbnNmZXIoc2Vzc2lvbi5pbnZlc3RvcltpXSwgbmFjUmV0dXJuKTsKICAgICAgICAgICAgICAgIHRvdGFsTmFjSW5Qb29sID0gdG90YWxOYWNJblBvb2wuc3ViKG5hY1JldHVybi5zdWIoc2Vzc2lvbi5hbW91bnRJbnZlc3RbaV0pKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmKHJhdGVMb3NzID4gMCkgewogICAgICAgICAgICAgICAgICAgIG5hY1JldHVybiA9IChzZXNzaW9uLmFtb3VudEludmVzdFtpXSAtIHNlc3Npb24uYW1vdW50SW52ZXN0W2ldICogcmF0ZUZlZSAvIDEwMCkgKiByYXRlTG9zcyAvIDEwMDsKICAgICAgICAgICAgICAgICAgICByZXF1aXJlKG5hbWlUb2tlbi5iYWxhbmNlT2YoYWRkcmVzcyh0aGlzKSkgPj0gbmFjUmV0dXJuKTsKICAgICAgICAgICAgICAgICAgICBuYW1pVG9rZW4udHJhbnNmZXIoc2Vzc2lvbi5pbnZlc3RvcltpXSwgbmFjUmV0dXJuKTsKICAgICAgICAgICAgICAgICAgICB0b3RhbE5hY0luUG9vbCA9IHRvdGFsTmFjSW5Qb29sLmFkZChzZXNzaW9uLmFtb3VudEludmVzdFtpXS5zdWIobmFjUmV0dXJuKSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRvdGFsTmFjSW5Qb29sID0gdG90YWxOYWNJblBvb2wuYWRkKHNlc3Npb24uYW1vdW50SW52ZXN0W2ldKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBuYW1pVG9rZW4uYnV5LnZhbHVlKGV0aGVyVG9CdXkpKHNlc3Npb24uaW52ZXN0b3JbaV0pOwogICAgICAgICAgICAvLyByZXNldCBpbnZlc3RvcgogICAgICAgICAgICBzZXNzaW9uLmludmVzdG9yW2ldID0gMHgwOwogICAgICAgICAgICBzZXNzaW9uLndpbltpXSA9IDA7CiAgICAgICAgICAgIHNlc3Npb24uYW1vdW50SW52ZXN0W2ldID0gMDsKICAgICAgICB9CiAgICAgICAgc2Vzc2lvbi5pc09wZW4gPSBmYWxzZTsKICAgICAgICBlbWl0IFNlc3Npb25DbG9zZShub3csIHNlc3Npb25JZCwgX3ByaWNlQ2xvc2UsIHJhdGVXaW4sIHJhdGVMb3NzLCByYXRlRmVlKTsKICAgICAgICBzZXNzaW9uSWQgKz0gMTsKICAgICAgICAKICAgICAgICAvLyByZXF1aXJlKCFzZXNzaW9uLmlzUmVzZXQgJiYgIXNlc3Npb24uaXNPcGVuKTsKICAgICAgICAvLyByZXNldCBzdGF0ZSBzZXNzaW9uCiAgICAgICAgc2Vzc2lvbi5wcmljZU9wZW4gPSAwOwogICAgICAgIHNlc3Npb24ucHJpY2VDbG9zZSA9IDA7CiAgICAgICAgc2Vzc2lvbi5pc1Jlc2V0ID0gdHJ1ZTsKICAgICAgICBzZXNzaW9uLmludmVzdE9wZW4gPSBmYWxzZTsKICAgICAgICBzZXNzaW9uLmludmVzdG9yQ291bnQgPSAwOwogICAgfQp9CgoKY29udHJhY3QgUHJlc2FsZVRva2VuIHsKICAgIG1hcHBpbmcgKGFkZHJlc3MgPT4gdWludDI1NikgcHVibGljIGJhbGFuY2VPZjsKICAgIGZ1bmN0aW9uIGJ1cm5Ub2tlbnMoYWRkcmVzcyBfb3duZXIpIHB1YmxpYzsKfQoKIC8qCiAqIENvbnRyYWN0IHRoYXQgaXMgd29ya2luZyB3aXRoIEVSQzIyMyB0b2tlbnMKICovCiAKIC8qKgogKiBAdGl0bGUgQ29udHJhY3QgdGhhdCB3aWxsIHdvcmsgd2l0aCBFUkMyMjMgdG9rZW5zLgogKi8KIApjb250cmFjdCBFUkMyMjNSZWNlaXZpbmdDb250cmFjdCB7Ci8qKgogKiBAZGV2IFN0YW5kYXJkIEVSQzIyMyBmdW5jdGlvbiB0aGF0IHdpbGwgaGFuZGxlIGluY29taW5nIHRva2VuIHRyYW5zZmVycy4KICoKICogQHBhcmFtIF9mcm9tICBUb2tlbiBzZW5kZXIgYWRkcmVzcy4KICogQHBhcmFtIF92YWx1ZSBBbW91bnQgb2YgdG9rZW5zLgogKiBAcGFyYW0gX2RhdGEgIFRyYW5zYWN0aW9uIG1ldGFkYXRhLgogKi8KICAgIGZ1bmN0aW9uIHRva2VuRmFsbGJhY2soYWRkcmVzcyBfZnJvbSwgdWludCBfdmFsdWUsIGJ5dGVzIF9kYXRhKSBwdWJsaWMgcmV0dXJucyAoYm9vbCBzdWNjZXNzKTsKICAgIGZ1bmN0aW9uIHRva2VuRmFsbGJhY2tCdXllcihhZGRyZXNzIF9mcm9tLCB1aW50IF92YWx1ZSwgYWRkcmVzcyBfYnV5ZXIpIHB1YmxpYyByZXR1cm5zIChib29sIHN1Y2Nlc3MpOwogICAgZnVuY3Rpb24gdG9rZW5GYWxsYmFja0V4Y2hhbmdlKGFkZHJlc3MgX2Zyb20sIHVpbnQgX3ZhbHVlLCB1aW50IF9wcmljZSkgcHVibGljIHJldHVybnMgKGJvb2wgc3VjY2Vzcyk7Cn0KCgogLyoKICogTmFtaSBJbnRlcm5hbCBFeGNoYW5nZSBzbWFydGNvbnRyYWN0LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICoKICovCgpjb250cmFjdCBOYW1pRXhjaGFuZ2UgewogICAgdXNpbmcgU2FmZU1hdGggZm9yIHVpbnQ7CiAgICAKICAgIGZ1bmN0aW9uIE5hbWlFeGNoYW5nZShhZGRyZXNzIF9uYW1pQWRkcmVzcykgcHVibGljIHsKICAgICAgICBOYW1pQWRkciA9IF9uYW1pQWRkcmVzczsKICAgIH0KCiAgICBldmVudCBVcGRhdGVCaWQoYWRkcmVzcyBvd25lciwgdWludCBwcmljZSwgdWludCBiYWxhbmNlKTsKICAgIGV2ZW50IFVwZGF0ZUFzayhhZGRyZXNzIG93bmVyLCB1aW50IHByaWNlLCB1aW50IHZvbHVtZSk7CiAgICBldmVudCBCdXlIaXN0b3J5KGFkZHJlc3MgaW5kZXhlZCBidXllciwgYWRkcmVzcyBpbmRleGVkIHNlbGxlciwgdWludCBwcmljZSwgdWludCB2b2x1bWUsIHVpbnQgdGltZSk7CiAgICBldmVudCBTZWxsSGlzdG9yeShhZGRyZXNzIGluZGV4ZWQgc2VsbGVyLCBhZGRyZXNzIGluZGV4ZWQgYnV5ZXIsIHVpbnQgcHJpY2UsIHVpbnQgdm9sdW1lLCB1aW50IHRpbWUpOwoKICAgIAogICAgbWFwcGluZyhhZGRyZXNzID0+IE9yZGVyQmlkKSBwdWJsaWMgYmlkOwogICAgbWFwcGluZyhhZGRyZXNzID0+IE9yZGVyQXNrKSBwdWJsaWMgYXNrOwogICAgc3RyaW5nIHB1YmxpYyBuYW1lID0gIk5hY0V4Y2hhbmdlIjsKICAgIAogICAgLy8vIGFkZHJlc3Mgb2YgTmFtaSB0b2tlbgogICAgYWRkcmVzcyBwdWJsaWMgTmFtaUFkZHI7CiAgICAKICAgIC8vLyBwcmljZSBvZiBOYWMgPSBFVEgvTkFDCiAgICB1aW50IHB1YmxpYyBwcmljZSA9IDE7CiAgICAvLyBzdHJ1Y3Qgc3RvcmUgb3JkZXIgb2YgdXNlcgogICAgc3RydWN0IE9yZGVyQmlkIHsKICAgICAgICB1aW50IHByaWNlOwogICAgICAgIHVpbnQgZXRoOwogICAgfQogICAgCiAgICBzdHJ1Y3QgT3JkZXJBc2sgewogICAgICAgIHVpbnQgcHJpY2U7CiAgICAgICAgdWludCB2b2x1bWU7CiAgICB9CiAgICAKICAgICAgICAKICAgIC8vIHByZXZlbnQgbG9zdCBldGhlcgogICAgZnVuY3Rpb24oKSBwYXlhYmxlIHB1YmxpYyB7CiAgICAgICAgcmVxdWlyZShtc2cuZGF0YS5sZW5ndGggIT0gMCk7CiAgICAgICAgcmVxdWlyZShtc2cudmFsdWUgPT0gMCk7CiAgICB9CiAgICAKICAgIG1vZGlmaWVyIG9ubHlOYW1pIHsKICAgICAgICByZXF1aXJlKG1zZy5zZW5kZXIgPT0gTmFtaUFkZHIpOwogICAgICAgIF87CiAgICB9CiAgICAKICAgIC8vLy8vLy8vLy8vLy8vLy8vCiAgICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLWZ1bmN0aW9uIGFib3V0IGJpZCBPcmRlci0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAKICAgIGZ1bmN0aW9uIHBsYWNlQnV5T3JkZXIodWludCBfcHJpY2UpIHBheWFibGUgcHVibGljIHsKICAgICAgICByZXF1aXJlKF9wcmljZSA+IDAgJiYgbXNnLnZhbHVlID4gMCAmJiBiaWRbbXNnLnNlbmRlcl0uZXRoID09IDApOwogICAgICAgIGlmIChtc2cudmFsdWUgPiAwKSB7CiAgICAgICAgICAgIGJpZFttc2cuc2VuZGVyXS5ldGggPSAoYmlkW21zZy5zZW5kZXJdLmV0aCkuYWRkKG1zZy52YWx1ZSk7CiAgICAgICAgICAgIGJpZFttc2cuc2VuZGVyXS5wcmljZSA9IF9wcmljZTsKICAgICAgICAgICAgZW1pdCBVcGRhdGVCaWQobXNnLnNlbmRlciwgX3ByaWNlLCBiaWRbbXNnLnNlbmRlcl0uZXRoKTsKICAgICAgICB9CiAgICB9CiAgICAKICAgIGZ1bmN0aW9uIHNlbGxOYWModWludCBfdmFsdWUsIGFkZHJlc3MgX2J1eWVyLCB1aW50IF9wcmljZSkgcHVibGljIHJldHVybnMgKGJvb2wgc3VjY2VzcykgewogICAgICAgIHJlcXVpcmUoX3ByaWNlID09IGJpZFtfYnV5ZXJdLnByaWNlICYmIF9idXllciAhPSBtc2cuc2VuZGVyKTsKICAgICAgICBOYW1pQ3Jvd2RTYWxlIG5hbWlUb2tlbiA9IE5hbWlDcm93ZFNhbGUoTmFtaUFkZHIpOwogICAgICAgIHVpbnQgZXRoT2ZCdXllciA9IGJpZFtfYnV5ZXJdLmV0aDsKICAgICAgICB1aW50IG1heFRva2VuID0gZXRoT2ZCdXllci5tdWwoYmlkW19idXllcl0ucHJpY2UpOwogICAgICAgIHJlcXVpcmUobmFtaVRva2VuLmFsbG93YW5jZShtc2cuc2VuZGVyLCB0aGlzKSA+PSBfdmFsdWUgJiYgX3ZhbHVlID4gMCAmJiBldGhPZkJ1eWVyICE9IDAgJiYgX2J1eWVyICE9IDB4MCk7CiAgICAgICAgaWYgKF92YWx1ZSA+IG1heFRva2VuKSB7CiAgICAgICAgICAgIGlmIChtc2cuc2VuZGVyLnNlbmQoZXRoT2ZCdXllcikgJiYgbmFtaVRva2VuLnRyYW5zZmVyRnJvbShtc2cuc2VuZGVyLF9idXllcixtYXhUb2tlbikpIHsKICAgICAgICAgICAgICAgIC8vIHVwZGF0ZSBvcmRlcgogICAgICAgICAgICAgICAgYmlkW19idXllcl0uZXRoID0gMDsKICAgICAgICAgICAgICAgIGVtaXQgVXBkYXRlQmlkKF9idXllciwgYmlkW19idXllcl0ucHJpY2UsIGJpZFtfYnV5ZXJdLmV0aCk7CiAgICAgICAgICAgICAgICBlbWl0IEJ1eUhpc3RvcnkoX2J1eWVyLCBtc2cuc2VuZGVyLCBiaWRbX2J1eWVyXS5wcmljZSwgbWF4VG9rZW4sIG5vdyk7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIHJldmVydCBhbnl0aGluZwogICAgICAgICAgICAgICAgcmV2ZXJ0KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB1aW50IGV0aCA9IF92YWx1ZS5kaXYoYmlkW19idXllcl0ucHJpY2UpOwogICAgICAgICAgICBpZiAobXNnLnNlbmRlci5zZW5kKGV0aCkgJiYgbmFtaVRva2VuLnRyYW5zZmVyRnJvbShtc2cuc2VuZGVyLF9idXllcixfdmFsdWUpKSB7CiAgICAgICAgICAgICAgICAvLyB1cGRhdGUgb3JkZXIKICAgICAgICAgICAgICAgIGJpZFtfYnV5ZXJdLmV0aCA9IChiaWRbX2J1eWVyXS5ldGgpLnN1YihldGgpOwogICAgICAgICAgICAgICAgZW1pdCBVcGRhdGVCaWQoX2J1eWVyLCBiaWRbX2J1eWVyXS5wcmljZSwgYmlkW19idXllcl0uZXRoKTsKICAgICAgICAgICAgICAgIGVtaXQgQnV5SGlzdG9yeShfYnV5ZXIsIG1zZy5zZW5kZXIsIGJpZFtfYnV5ZXJdLnByaWNlLCBfdmFsdWUsIG5vdyk7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIHJldmVydCBhbnl0aGluZwogICAgICAgICAgICAgICAgcmV2ZXJ0KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICAKICAgIGZ1bmN0aW9uIGNsb3NlQmlkT3JkZXIoKSBwdWJsaWMgewogICAgICAgIHJlcXVpcmUoYmlkW21zZy5zZW5kZXJdLmV0aCA+IDAgJiYgYmlkW21zZy5zZW5kZXJdLnByaWNlID4gMCk7CiAgICAgICAgLy8gdHJhbnNmZXIgRVRICiAgICAgICAgbXNnLnNlbmRlci50cmFuc2ZlcihiaWRbbXNnLnNlbmRlcl0uZXRoKTsKICAgICAgICAvLyB1cGRhdGUgb3JkZXIKICAgICAgICBiaWRbbXNnLnNlbmRlcl0uZXRoID0gMDsKICAgICAgICBlbWl0IFVwZGF0ZUJpZChtc2cuc2VuZGVyLCBiaWRbbXNnLnNlbmRlcl0ucHJpY2UsIGJpZFttc2cuc2VuZGVyXS5ldGgpOwogICAgfQogICAgCgogICAgLy8vLy8vLy8vLy8vLy8vLwogICAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1mdW5jdGlvbiBhYm91dCBhc2sgT3JkZXItLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgCiAgICAvLyBwbGFjZSBhc2sgb3JkZXIgYnkgc2VuZCBOQUMgdG8gTmFtaSBFeGNoYW5nZSBjb250cmFjdAogICAgLy8gdGhpcyBmdW5jdGlvbiBwbGFjZSBzZWxsIG9yZGVyCiAgICBmdW5jdGlvbiB0b2tlbkZhbGxiYWNrRXhjaGFuZ2UoYWRkcmVzcyBfZnJvbSwgdWludCBfdmFsdWUsIHVpbnQgX3ByaWNlKSBvbmx5TmFtaSBwdWJsaWMgcmV0dXJucyAoYm9vbCBzdWNjZXNzKSB7CiAgICAgICAgcmVxdWlyZShfcHJpY2UgPiAwICYmIF92YWx1ZSA+IDAgJiYgYXNrW19mcm9tXS52b2x1bWUgPT0gMCk7CiAgICAgICAgaWYgKF92YWx1ZSA+IDApIHsKICAgICAgICAgICAgYXNrW19mcm9tXS52b2x1bWUgPSAoYXNrW19mcm9tXS52b2x1bWUpLmFkZChfdmFsdWUpOwogICAgICAgICAgICBhc2tbX2Zyb21dLnByaWNlID0gX3ByaWNlOwogICAgICAgICAgICBlbWl0IFVwZGF0ZUFzayhfZnJvbSwgX3ByaWNlLCBhc2tbX2Zyb21dLnZvbHVtZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgCiAgICBmdW5jdGlvbiBjbG9zZUFza09yZGVyKCkgcHVibGljIHsKICAgICAgICByZXF1aXJlKGFza1ttc2cuc2VuZGVyXS52b2x1bWUgPiAwICYmIGFza1ttc2cuc2VuZGVyXS5wcmljZSA+IDApOwogICAgICAgIE5hbWlDcm93ZFNhbGUgbmFtaVRva2VuID0gTmFtaUNyb3dkU2FsZShOYW1pQWRkcik7CiAgICAgICAgdWludCBwcmV2aW91c0JhbGFuY2VzID0gbmFtaVRva2VuLmJhbGFuY2VPZihtc2cuc2VuZGVyKTsKICAgICAgICAvLyB0cmFuc2ZlciB0b2tlbgogICAgICAgIG5hbWlUb2tlbi50cmFuc2Zlcihtc2cuc2VuZGVyLCBhc2tbbXNnLnNlbmRlcl0udm9sdW1lKTsKICAgICAgICAvLyB1cGRhdGUgb3JkZXIKICAgICAgICBhc2tbbXNnLnNlbmRlcl0udm9sdW1lID0gMDsKICAgICAgICBlbWl0IFVwZGF0ZUFzayhtc2cuc2VuZGVyLCBhc2tbbXNnLnNlbmRlcl0ucHJpY2UsIDApOwogICAgICAgIC8vIGNoZWNrIGJhbGFuY2UKICAgICAgICBhc3NlcnQocHJldmlvdXNCYWxhbmNlcyA8IG5hbWlUb2tlbi5iYWxhbmNlT2YobXNnLnNlbmRlcikpOwogICAgfQogICAgCiAgICBmdW5jdGlvbiBidXlOYWMoYWRkcmVzcyBfc2VsbGVyLCB1aW50IF9wcmljZSkgcGF5YWJsZSBwdWJsaWMgcmV0dXJucyAoYm9vbCBzdWNjZXNzKSB7CiAgICAgICAgcmVxdWlyZShtc2cudmFsdWUgPiAwICYmIGFza1tfc2VsbGVyXS52b2x1bWUgPiAwICYmIGFza1tfc2VsbGVyXS5wcmljZSA+IDApOwogICAgICAgIHJlcXVpcmUoX3ByaWNlID09IGFza1tfc2VsbGVyXS5wcmljZSAmJiBfc2VsbGVyICE9IG1zZy5zZW5kZXIpOwogICAgICAgIE5hbWlDcm93ZFNhbGUgbmFtaVRva2VuID0gTmFtaUNyb3dkU2FsZShOYW1pQWRkcik7CiAgICAgICAgdWludCBtYXhFdGggPSAoYXNrW19zZWxsZXJdLnZvbHVtZSkuZGl2KGFza1tfc2VsbGVyXS5wcmljZSk7CiAgICAgICAgdWludCBwcmV2aW91c0JhbGFuY2VzID0gbmFtaVRva2VuLmJhbGFuY2VPZihtc2cuc2VuZGVyKTsKICAgICAgICBpZiAobXNnLnZhbHVlID4gbWF4RXRoKSB7CiAgICAgICAgICAgIGlmIChfc2VsbGVyLnNlbmQobWF4RXRoKSAmJiBtc2cuc2VuZGVyLnNlbmQobXNnLnZhbHVlLnN1YihtYXhFdGgpKSkgewogICAgICAgICAgICAgICAgLy8gdHJhbnNmZXIgdG9rZW4KICAgICAgICAgICAgICAgIG5hbWlUb2tlbi50cmFuc2Zlcihtc2cuc2VuZGVyLCBhc2tbX3NlbGxlcl0udm9sdW1lKTsKICAgICAgICAgICAgICAgIGVtaXQgU2VsbEhpc3RvcnkoX3NlbGxlciwgbXNnLnNlbmRlciwgYXNrW19zZWxsZXJdLnByaWNlLCBhc2tbX3NlbGxlcl0udm9sdW1lLCBub3cpOwogICAgICAgICAgICAgICAgLy8gdXBkYXRlIG9yZGVyCiAgICAgICAgICAgICAgICBhc2tbX3NlbGxlcl0udm9sdW1lID0gMDsKICAgICAgICAgICAgICAgIGVtaXQgVXBkYXRlQXNrKF9zZWxsZXIsIGFza1tfc2VsbGVyXS5wcmljZSwgMCk7CiAgICAgICAgICAgICAgICBhc3NlcnQocHJldmlvdXNCYWxhbmNlcyA8IG5hbWlUb2tlbi5iYWxhbmNlT2YobXNnLnNlbmRlcikpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyByZXZlcnQgYW55dGhpbmcKICAgICAgICAgICAgICAgIHJldmVydCgpOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdWludCBuYWMgPSAobXNnLnZhbHVlKS5tdWwoYXNrW19zZWxsZXJdLnByaWNlKTsKICAgICAgICAgICAgaWYgKF9zZWxsZXIuc2VuZChtc2cudmFsdWUpKSB7CiAgICAgICAgICAgICAgICAvLyB0cmFuc2ZlciB0b2tlbgogICAgICAgICAgICAgICAgbmFtaVRva2VuLnRyYW5zZmVyKG1zZy5zZW5kZXIsIG5hYyk7CiAgICAgICAgICAgICAgICAvLyB1cGRhdGUgb3JkZXIKICAgICAgICAgICAgICAgIGFza1tfc2VsbGVyXS52b2x1bWUgPSAoYXNrW19zZWxsZXJdLnZvbHVtZSkuc3ViKG5hYyk7CiAgICAgICAgICAgICAgICBlbWl0IFVwZGF0ZUFzayhfc2VsbGVyLCBhc2tbX3NlbGxlcl0ucHJpY2UsIGFza1tfc2VsbGVyXS52b2x1bWUpOwogICAgICAgICAgICAgICAgZW1pdCBTZWxsSGlzdG9yeShfc2VsbGVyLCBtc2cuc2VuZGVyLCBhc2tbX3NlbGxlcl0ucHJpY2UsIG5hYywgbm93KTsKICAgICAgICAgICAgICAgIGFzc2VydChwcmV2aW91c0JhbGFuY2VzIDwgbmFtaVRva2VuLmJhbGFuY2VPZihtc2cuc2VuZGVyKSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIHJldmVydCBhbnl0aGluZwogICAgICAgICAgICAgICAgcmV2ZXJ0KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Cn0KCmNvbnRyYWN0IEVSQzIzIHsKICAgIGZ1bmN0aW9uIGJhbGFuY2VPZihhZGRyZXNzIHdobykgcHVibGljIGNvbnN0YW50IHJldHVybnMgKHVpbnQpOwogICAgZnVuY3Rpb24gdHJhbnNmZXIoYWRkcmVzcyB0bywgdWludCB2YWx1ZSkgcHVibGljIHJldHVybnMgKGJvb2wgc3VjY2Vzcyk7Cn0KCgoKLyoKKiBOYW1pTXVsdGlTaWdXYWxsZXQgc21hcnQgY29udHJhY3QtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiovCi8vLyBAdGl0bGUgTXVsdGlzaWduYXR1cmUgd2FsbGV0IC0gQWxsb3dzIG11bHRpcGxlIHBhcnRpZXMgdG8gYWdyZWUgb24gdHJhbnNhY3Rpb25zIGJlZm9yZSBleGVjdXRpb24uCmNvbnRyYWN0IE5hbWlNdWx0aVNpZ1dhbGxldCB7CgogICAgdWludCBjb25zdGFudCBwdWJsaWMgTUFYX09XTkVSX0NPVU5UID0gNTA7CgogICAgZXZlbnQgQ29uZmlybWF0aW9uKGFkZHJlc3MgaW5kZXhlZCBzZW5kZXIsIHVpbnQgaW5kZXhlZCB0cmFuc2FjdGlvbklkKTsKICAgIGV2ZW50IFJldm9jYXRpb24oYWRkcmVzcyBpbmRleGVkIHNlbmRlciwgdWludCBpbmRleGVkIHRyYW5zYWN0aW9uSWQpOwogICAgZXZlbnQgU3VibWlzc2lvbih1aW50IGluZGV4ZWQgdHJhbnNhY3Rpb25JZCk7CiAgICBldmVudCBFeGVjdXRpb24odWludCBpbmRleGVkIHRyYW5zYWN0aW9uSWQpOwogICAgZXZlbnQgRXhlY3V0aW9uRmFpbHVyZSh1aW50IGluZGV4ZWQgdHJhbnNhY3Rpb25JZCk7CiAgICBldmVudCBEZXBvc2l0KGFkZHJlc3MgaW5kZXhlZCBzZW5kZXIsIHVpbnQgdmFsdWUpOwogICAgZXZlbnQgT3duZXJBZGRpdGlvbihhZGRyZXNzIGluZGV4ZWQgb3duZXIpOwogICAgZXZlbnQgT3duZXJSZW1vdmFsKGFkZHJlc3MgaW5kZXhlZCBvd25lcik7CiAgICBldmVudCBSZXF1aXJlbWVudENoYW5nZSh1aW50IHJlcXVpcmVkKTsKCiAgICBtYXBwaW5nICh1aW50ID0+IFRyYW5zYWN0aW9uKSBwdWJsaWMgdHJhbnNhY3Rpb25zOwogICAgbWFwcGluZyAodWludCA9PiBtYXBwaW5nIChhZGRyZXNzID0+IGJvb2wpKSBwdWJsaWMgY29uZmlybWF0aW9uczsKICAgIG1hcHBpbmcgKGFkZHJlc3MgPT4gYm9vbCkgcHVibGljIGlzT3duZXI7CiAgICBhZGRyZXNzW10gcHVibGljIG93bmVyczsKICAgIHVpbnQgcHVibGljIHJlcXVpcmVkOwogICAgdWludCBwdWJsaWMgdHJhbnNhY3Rpb25Db3VudDsKCiAgICBzdHJ1Y3QgVHJhbnNhY3Rpb24gewogICAgICAgIGFkZHJlc3MgZGVzdGluYXRpb247CiAgICAgICAgdWludCB2YWx1ZTsKICAgICAgICBieXRlcyBkYXRhOwogICAgICAgIGJvb2wgZXhlY3V0ZWQ7CiAgICB9CgogICAgbW9kaWZpZXIgb25seVdhbGxldCgpIHsKICAgICAgICByZXF1aXJlKG1zZy5zZW5kZXIgPT0gYWRkcmVzcyh0aGlzKSk7CiAgICAgICAgXzsKICAgIH0KCiAgICBtb2RpZmllciBvd25lckRvZXNOb3RFeGlzdChhZGRyZXNzIG93bmVyKSB7CiAgICAgICAgcmVxdWlyZSghaXNPd25lcltvd25lcl0pOwogICAgICAgIF87CiAgICB9CgogICAgbW9kaWZpZXIgb3duZXJFeGlzdHMoYWRkcmVzcyBvd25lcikgewogICAgICAgIHJlcXVpcmUoaXNPd25lcltvd25lcl0pOwogICAgICAgIF87CiAgICB9CgogICAgbW9kaWZpZXIgdHJhbnNhY3Rpb25FeGlzdHModWludCB0cmFuc2FjdGlvbklkKSB7CiAgICAgICAgcmVxdWlyZSh0cmFuc2FjdGlvbnNbdHJhbnNhY3Rpb25JZF0uZGVzdGluYXRpb24gIT0gMCk7CiAgICAgICAgXzsKICAgIH0KCiAgICBtb2RpZmllciBjb25maXJtZWQodWludCB0cmFuc2FjdGlvbklkLCBhZGRyZXNzIG93bmVyKSB7CiAgICAgICAgcmVxdWlyZShjb25maXJtYXRpb25zW3RyYW5zYWN0aW9uSWRdW293bmVyXSk7CiAgICAgICAgXzsKICAgIH0KCiAgICBtb2RpZmllciBub3RDb25maXJtZWQodWludCB0cmFuc2FjdGlvbklkLCBhZGRyZXNzIG93bmVyKSB7CiAgICAgICAgcmVxdWlyZSghY29uZmlybWF0aW9uc1t0cmFuc2FjdGlvbklkXVtvd25lcl0pOwogICAgICAgIF87CiAgICB9CgogICAgbW9kaWZpZXIgbm90RXhlY3V0ZWQodWludCB0cmFuc2FjdGlvbklkKSB7CiAgICAgICAgcmVxdWlyZSghdHJhbnNhY3Rpb25zW3RyYW5zYWN0aW9uSWRdLmV4ZWN1dGVkKTsKICAgICAgICBfOwogICAgfQoKICAgIG1vZGlmaWVyIG5vdE51bGwoYWRkcmVzcyBfYWRkcmVzcykgewogICAgICAgIHJlcXVpcmUoX2FkZHJlc3MgIT0gMCk7CiAgICAgICAgXzsKICAgIH0KCiAgICBtb2RpZmllciB2YWxpZFJlcXVpcmVtZW50KHVpbnQgb3duZXJDb3VudCwgdWludCBfcmVxdWlyZWQpIHsKICAgICAgICByZXF1aXJlKCEob3duZXJDb3VudCA+IE1BWF9PV05FUl9DT1VOVAogICAgICAgICAgICB8fCBfcmVxdWlyZWQgPiBvd25lckNvdW50CiAgICAgICAgICAgIHx8IF9yZXF1aXJlZCA9PSAwCiAgICAgICAgICAgIHx8IG93bmVyQ291bnQgPT0gMCkpOwogICAgICAgIF87CiAgICB9CgogICAgLy8vIEBkZXYgRmFsbGJhY2sgZnVuY3Rpb24gYWxsb3dzIHRvIGRlcG9zaXQgZXRoZXIuCiAgICBmdW5jdGlvbigpIHB1YmxpYyBwYXlhYmxlIHsKICAgICAgICBpZiAobXNnLnZhbHVlID4gMCkKICAgICAgICAgICAgZW1pdCBEZXBvc2l0KG1zZy5zZW5kZXIsIG1zZy52YWx1ZSk7CiAgICB9CgogICAgLyoKICAgICAqIFB1YmxpYyBmdW5jdGlvbnMKICAgICAqLwogICAgLy8vIEBkZXYgQ29udHJhY3QgY29uc3RydWN0b3Igc2V0cyBpbml0aWFsIG93bmVycyBhbmQgcmVxdWlyZWQgbnVtYmVyIG9mIGNvbmZpcm1hdGlvbnMuCiAgICAvLy8gQHBhcmFtIF9vd25lcnMgTGlzdCBvZiBpbml0aWFsIG93bmVycy4KICAgIC8vLyBAcGFyYW0gX3JlcXVpcmVkIE51bWJlciBvZiByZXF1aXJlZCBjb25maXJtYXRpb25zLgogICAgZnVuY3Rpb24gTmFtaU11bHRpU2lnV2FsbGV0KGFkZHJlc3NbXSBfb3duZXJzLCB1aW50IF9yZXF1aXJlZCkKICAgICAgICBwdWJsaWMKICAgICAgICB2YWxpZFJlcXVpcmVtZW50KF9vd25lcnMubGVuZ3RoLCBfcmVxdWlyZWQpCiAgICB7CiAgICAgICAgZm9yICh1aW50IGkgPSAwOyBpIDwgX293bmVycy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICByZXF1aXJlKCEoaXNPd25lcltfb3duZXJzW2ldXSB8fCBfb3duZXJzW2ldID09IDApKTsKICAgICAgICAgICAgaXNPd25lcltfb3duZXJzW2ldXSA9IHRydWU7CiAgICAgICAgfQogICAgICAgIG93bmVycyA9IF9vd25lcnM7CiAgICAgICAgcmVxdWlyZWQgPSBfcmVxdWlyZWQ7CiAgICB9CgogICAgLy8vIEBkZXYgQWxsb3dzIHRvIGFkZCBhIG5ldyBvd25lci4gVHJhbnNhY3Rpb24gaGFzIHRvIGJlIHNlbnQgYnkgd2FsbGV0LgogICAgLy8vIEBwYXJhbSBvd25lciBBZGRyZXNzIG9mIG5ldyBvd25lci4KICAgIGZ1bmN0aW9uIGFkZE93bmVyKGFkZHJlc3Mgb3duZXIpCiAgICAgICAgcHVibGljCiAgICAgICAgb25seVdhbGxldAogICAgICAgIG93bmVyRG9lc05vdEV4aXN0KG93bmVyKQogICAgICAgIG5vdE51bGwob3duZXIpCiAgICAgICAgdmFsaWRSZXF1aXJlbWVudChvd25lcnMubGVuZ3RoICsgMSwgcmVxdWlyZWQpCiAgICB7CiAgICAgICAgaXNPd25lcltvd25lcl0gPSB0cnVlOwogICAgICAgIG93bmVycy5wdXNoKG93bmVyKTsKICAgICAgICBlbWl0IE93bmVyQWRkaXRpb24ob3duZXIpOwogICAgfQoKICAgIC8vLyBAZGV2IEFsbG93cyB0byByZW1vdmUgYW4gb3duZXIuIFRyYW5zYWN0aW9uIGhhcyB0byBiZSBzZW50IGJ5IHdhbGxldC4KICAgIC8vLyBAcGFyYW0gb3duZXIgQWRkcmVzcyBvZiBvd25lci4KICAgIGZ1bmN0aW9uIHJlbW92ZU93bmVyKGFkZHJlc3Mgb3duZXIpCiAgICAgICAgcHVibGljCiAgICAgICAgb25seVdhbGxldAogICAgICAgIG93bmVyRXhpc3RzKG93bmVyKQogICAgewogICAgICAgIGlzT3duZXJbb3duZXJdID0gZmFsc2U7CiAgICAgICAgZm9yICh1aW50IGk9MDsgaTxvd25lcnMubGVuZ3RoIC0gMTsgaSsrKSB7CiAgICAgICAgICAgIGlmIChvd25lcnNbaV0gPT0gb3duZXIpIHsKICAgICAgICAgICAgICAgIG93bmVyc1tpXSA9IG93bmVyc1tvd25lcnMubGVuZ3RoIC0gMV07CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBvd25lcnMubGVuZ3RoIC09IDE7CiAgICAgICAgaWYgKHJlcXVpcmVkID4gb3duZXJzLmxlbmd0aCkKICAgICAgICAgICAgY2hhbmdlUmVxdWlyZW1lbnQob3duZXJzLmxlbmd0aCk7CiAgICAgICAgZW1pdCBPd25lclJlbW92YWwob3duZXIpOwogICAgfQoKICAgIC8vLyBAZGV2IEFsbG93cyB0byByZXBsYWNlIGFuIG93bmVyIHdpdGggYSBuZXcgb3duZXIuIFRyYW5zYWN0aW9uIGhhcyB0byBiZSBzZW50IGJ5IHdhbGxldC4KICAgIC8vLyBAcGFyYW0gb3duZXIgQWRkcmVzcyBvZiBvd25lciB0byBiZSByZXBsYWNlZC4KICAgIC8vLyBAcGFyYW0gb3duZXIgQWRkcmVzcyBvZiBuZXcgb3duZXIuCiAgICBmdW5jdGlvbiByZXBsYWNlT3duZXIoYWRkcmVzcyBvd25lciwgYWRkcmVzcyBuZXdPd25lcikKICAgICAgICBwdWJsaWMKICAgICAgICBvbmx5V2FsbGV0CiAgICAgICAgb3duZXJFeGlzdHMob3duZXIpCiAgICAgICAgb3duZXJEb2VzTm90RXhpc3QobmV3T3duZXIpCiAgICB7CiAgICAgICAgZm9yICh1aW50IGk9MDsgaTxvd25lcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgaWYgKG93bmVyc1tpXSA9PSBvd25lcikgewogICAgICAgICAgICAgICAgb3duZXJzW2ldID0gbmV3T3duZXI7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpc093bmVyW293bmVyXSA9IGZhbHNlOwogICAgICAgIGlzT3duZXJbbmV3T3duZXJdID0gdHJ1ZTsKICAgICAgICBlbWl0IE93bmVyUmVtb3ZhbChvd25lcik7CiAgICAgICAgZW1pdCBPd25lckFkZGl0aW9uKG5ld093bmVyKTsKICAgIH0KCiAgICAvLy8gQGRldiBBbGxvd3MgdG8gY2hhbmdlIHRoZSBudW1iZXIgb2YgcmVxdWlyZWQgY29uZmlybWF0aW9ucy4gVHJhbnNhY3Rpb24gaGFzIHRvIGJlIHNlbnQgYnkgd2FsbGV0LgogICAgLy8vIEBwYXJhbSBfcmVxdWlyZWQgTnVtYmVyIG9mIHJlcXVpcmVkIGNvbmZpcm1hdGlvbnMuCiAgICBmdW5jdGlvbiBjaGFuZ2VSZXF1aXJlbWVudCh1aW50IF9yZXF1aXJlZCkKICAgICAgICBwdWJsaWMKICAgICAgICBvbmx5V2FsbGV0CiAgICAgICAgdmFsaWRSZXF1aXJlbWVudChvd25lcnMubGVuZ3RoLCBfcmVxdWlyZWQpCiAgICB7CiAgICAgICAgcmVxdWlyZWQgPSBfcmVxdWlyZWQ7CiAgICAgICAgZW1pdCBSZXF1aXJlbWVudENoYW5nZShfcmVxdWlyZWQpOwogICAgfQoKICAgIC8vLyBAZGV2IEFsbG93cyBhbiBvd25lciB0byBzdWJtaXQgYW5kIGNvbmZpcm0gYSB0cmFuc2FjdGlvbi4KICAgIC8vLyBAcGFyYW0gZGVzdGluYXRpb24gVHJhbnNhY3Rpb24gdGFyZ2V0IGFkZHJlc3MuCiAgICAvLy8gQHBhcmFtIHZhbHVlIFRyYW5zYWN0aW9uIGV0aGVyIHZhbHVlLgogICAgLy8vIEBwYXJhbSBkYXRhIFRyYW5zYWN0aW9uIGRhdGEgcGF5bG9hZC4KICAgIC8vLyBAcmV0dXJuIFJldHVybnMgdHJhbnNhY3Rpb24gSUQuCiAgICBmdW5jdGlvbiBzdWJtaXRUcmFuc2FjdGlvbihhZGRyZXNzIGRlc3RpbmF0aW9uLCB1aW50IHZhbHVlLCBieXRlcyBkYXRhKQogICAgICAgIHB1YmxpYwogICAgICAgIHJldHVybnMgKHVpbnQgdHJhbnNhY3Rpb25JZCkKICAgIHsKICAgICAgICB0cmFuc2FjdGlvbklkID0gYWRkVHJhbnNhY3Rpb24oZGVzdGluYXRpb24sIHZhbHVlLCBkYXRhKTsKICAgICAgICBjb25maXJtVHJhbnNhY3Rpb24odHJhbnNhY3Rpb25JZCk7CiAgICB9CgogICAgLy8vIEBkZXYgQWxsb3dzIGFuIG93bmVyIHRvIGNvbmZpcm0gYSB0cmFuc2FjdGlvbi4KICAgIC8vLyBAcGFyYW0gdHJhbnNhY3Rpb25JZCBUcmFuc2FjdGlvbiBJRC4KICAgIGZ1bmN0aW9uIGNvbmZpcm1UcmFuc2FjdGlvbih1aW50IHRyYW5zYWN0aW9uSWQpCiAgICAgICAgcHVibGljCiAgICAgICAgb3duZXJFeGlzdHMobXNnLnNlbmRlcikKICAgICAgICB0cmFuc2FjdGlvbkV4aXN0cyh0cmFuc2FjdGlvbklkKQogICAgICAgIG5vdENvbmZpcm1lZCh0cmFuc2FjdGlvbklkLCBtc2cuc2VuZGVyKQogICAgewogICAgICAgIGNvbmZpcm1hdGlvbnNbdHJhbnNhY3Rpb25JZF1bbXNnLnNlbmRlcl0gPSB0cnVlOwogICAgICAgIGVtaXQgQ29uZmlybWF0aW9uKG1zZy5zZW5kZXIsIHRyYW5zYWN0aW9uSWQpOwogICAgICAgIGV4ZWN1dGVUcmFuc2FjdGlvbih0cmFuc2FjdGlvbklkKTsKICAgIH0KCiAgICAvLy8gQGRldiBBbGxvd3MgYW4gb3duZXIgdG8gcmV2b2tlIGEgY29uZmlybWF0aW9uIGZvciBhIHRyYW5zYWN0aW9uLgogICAgLy8vIEBwYXJhbSB0cmFuc2FjdGlvbklkIFRyYW5zYWN0aW9uIElELgogICAgZnVuY3Rpb24gcmV2b2tlQ29uZmlybWF0aW9uKHVpbnQgdHJhbnNhY3Rpb25JZCkKICAgICAgICBwdWJsaWMKICAgICAgICBvd25lckV4aXN0cyhtc2cuc2VuZGVyKQogICAgICAgIGNvbmZpcm1lZCh0cmFuc2FjdGlvbklkLCBtc2cuc2VuZGVyKQogICAgICAgIG5vdEV4ZWN1dGVkKHRyYW5zYWN0aW9uSWQpCiAgICB7CiAgICAgICAgY29uZmlybWF0aW9uc1t0cmFuc2FjdGlvbklkXVttc2cuc2VuZGVyXSA9IGZhbHNlOwogICAgICAgIGVtaXQgUmV2b2NhdGlvbihtc2cuc2VuZGVyLCB0cmFuc2FjdGlvbklkKTsKICAgIH0KCiAgICAvLy8gQGRldiBBbGxvd3MgYW55b25lIHRvIGV4ZWN1dGUgYSBjb25maXJtZWQgdHJhbnNhY3Rpb24uCiAgICAvLy8gQHBhcmFtIHRyYW5zYWN0aW9uSWQgVHJhbnNhY3Rpb24gSUQuCiAgICBmdW5jdGlvbiBleGVjdXRlVHJhbnNhY3Rpb24odWludCB0cmFuc2FjdGlvbklkKQogICAgICAgIHB1YmxpYwogICAgICAgIG5vdEV4ZWN1dGVkKHRyYW5zYWN0aW9uSWQpCiAgICB7CiAgICAgICAgaWYgKGlzQ29uZmlybWVkKHRyYW5zYWN0aW9uSWQpKSB7CiAgICAgICAgICAgIC8vIFRyYW5zYWN0aW9uIHR4ID0gdHJhbnNhY3Rpb25zW3RyYW5zYWN0aW9uSWRdOwogICAgICAgICAgICB0cmFuc2FjdGlvbnNbdHJhbnNhY3Rpb25JZF0uZXhlY3V0ZWQgPSB0cnVlOwogICAgICAgICAgICAvLyB0eC5leGVjdXRlZCA9IHRydWU7CiAgICAgICAgICAgIGlmICh0cmFuc2FjdGlvbnNbdHJhbnNhY3Rpb25JZF0uZGVzdGluYXRpb24uY2FsbC52YWx1ZSh0cmFuc2FjdGlvbnNbdHJhbnNhY3Rpb25JZF0udmFsdWUpKHRyYW5zYWN0aW9uc1t0cmFuc2FjdGlvbklkXS5kYXRhKSkgewogICAgICAgICAgICAgICAgZW1pdCBFeGVjdXRpb24odHJhbnNhY3Rpb25JZCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBlbWl0IEV4ZWN1dGlvbkZhaWx1cmUodHJhbnNhY3Rpb25JZCk7CiAgICAgICAgICAgICAgICB0cmFuc2FjdGlvbnNbdHJhbnNhY3Rpb25JZF0uZXhlY3V0ZWQgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICAvLy8gQGRldiBSZXR1cm5zIHRoZSBjb25maXJtYXRpb24gc3RhdHVzIG9mIGEgdHJhbnNhY3Rpb24uCiAgICAvLy8gQHBhcmFtIHRyYW5zYWN0aW9uSWQgVHJhbnNhY3Rpb24gSUQuCiAgICAvLy8gQHJldHVybiBDb25maXJtYXRpb24gc3RhdHVzLgogICAgZnVuY3Rpb24gaXNDb25maXJtZWQodWludCB0cmFuc2FjdGlvbklkKQogICAgICAgIHB1YmxpYwogICAgICAgIGNvbnN0YW50CiAgICAgICAgcmV0dXJucyAoYm9vbCkKICAgIHsKICAgICAgICB1aW50IGNvdW50ID0gMDsKICAgICAgICBmb3IgKHVpbnQgaSA9IDA7IGkgPCBvd25lcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgaWYgKGNvbmZpcm1hdGlvbnNbdHJhbnNhY3Rpb25JZF1bb3duZXJzW2ldXSkKICAgICAgICAgICAgICAgIGNvdW50ICs9IDE7CiAgICAgICAgICAgIGlmIChjb3VudCA9PSByZXF1aXJlZCkKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgIH0KCiAgICAvKgogICAgICogSW50ZXJuYWwgZnVuY3Rpb25zCiAgICAgKi8KICAgIC8vLyBAZGV2IEFkZHMgYSBuZXcgdHJhbnNhY3Rpb24gdG8gdGhlIHRyYW5zYWN0aW9uIG1hcHBpbmcsIGlmIHRyYW5zYWN0aW9uIGRvZXMgbm90IGV4aXN0IHlldC4KICAgIC8vLyBAcGFyYW0gZGVzdGluYXRpb24gVHJhbnNhY3Rpb24gdGFyZ2V0IGFkZHJlc3MuCiAgICAvLy8gQHBhcmFtIHZhbHVlIFRyYW5zYWN0aW9uIGV0aGVyIHZhbHVlLgogICAgLy8vIEBwYXJhbSBkYXRhIFRyYW5zYWN0aW9uIGRhdGEgcGF5bG9hZC4KICAgIC8vLyBAcmV0dXJuIFJldHVybnMgdHJhbnNhY3Rpb24gSUQuCiAgICBmdW5jdGlvbiBhZGRUcmFuc2FjdGlvbihhZGRyZXNzIGRlc3RpbmF0aW9uLCB1aW50IHZhbHVlLCBieXRlcyBkYXRhKQogICAgICAgIGludGVybmFsCiAgICAgICAgbm90TnVsbChkZXN0aW5hdGlvbikKICAgICAgICByZXR1cm5zICh1aW50IHRyYW5zYWN0aW9uSWQpCiAgICB7CiAgICAgICAgdHJhbnNhY3Rpb25JZCA9IHRyYW5zYWN0aW9uQ291bnQ7CiAgICAgICAgdHJhbnNhY3Rpb25zW3RyYW5zYWN0aW9uSWRdID0gVHJhbnNhY3Rpb24oewogICAgICAgICAgICBkZXN0aW5hdGlvbjogZGVzdGluYXRpb24sIAogICAgICAgICAgICB2YWx1ZTogdmFsdWUsCiAgICAgICAgICAgIGRhdGE6IGRhdGEsCiAgICAgICAgICAgIGV4ZWN1dGVkOiBmYWxzZQogICAgICAgIH0pOwogICAgICAgIHRyYW5zYWN0aW9uQ291bnQgKz0gMTsKICAgICAgICBlbWl0IFN1Ym1pc3Npb24odHJhbnNhY3Rpb25JZCk7CiAgICB9CgogICAgLyoKICAgICAqIFdlYjMgY2FsbCBmdW5jdGlvbnMKICAgICAqLwogICAgLy8vIEBkZXYgUmV0dXJucyBudW1iZXIgb2YgY29uZmlybWF0aW9ucyBvZiBhIHRyYW5zYWN0aW9uLgogICAgLy8vIEBwYXJhbSB0cmFuc2FjdGlvbklkIFRyYW5zYWN0aW9uIElELgogICAgLy8vIEByZXR1cm4gTnVtYmVyIG9mIGNvbmZpcm1hdGlvbnMuCiAgICBmdW5jdGlvbiBnZXRDb25maXJtYXRpb25Db3VudCh1aW50IHRyYW5zYWN0aW9uSWQpCiAgICAgICAgcHVibGljCiAgICAgICAgY29uc3RhbnQKICAgICAgICByZXR1cm5zICh1aW50IGNvdW50KQogICAgewogICAgICAgIGZvciAodWludCBpID0gMDsgaSA8IG93bmVycy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBpZiAoY29uZmlybWF0aW9uc1t0cmFuc2FjdGlvbklkXVtvd25lcnNbaV1dKQogICAgICAgICAgICAgICAgY291bnQgKz0gMTsKICAgICAgICB9CiAgICB9CgogICAgLy8vIEBkZXYgUmV0dXJucyB0b3RhbCBudW1iZXIgb2YgdHJhbnNhY3Rpb25zIGFmdGVyIGZpbGVycyBhcmUgYXBwbGllZC4KICAgIC8vLyBAcGFyYW0gcGVuZGluZyBJbmNsdWRlIHBlbmRpbmcgdHJhbnNhY3Rpb25zLgogICAgLy8vIEBwYXJhbSBleGVjdXRlZCBJbmNsdWRlIGV4ZWN1dGVkIHRyYW5zYWN0aW9ucy4KICAgIC8vLyBAcmV0dXJuIFRvdGFsIG51bWJlciBvZiB0cmFuc2FjdGlvbnMgYWZ0ZXIgZmlsdGVycyBhcmUgYXBwbGllZC4KICAgIGZ1bmN0aW9uIGdldFRyYW5zYWN0aW9uQ291bnQoYm9vbCBwZW5kaW5nLCBib29sIGV4ZWN1dGVkKQogICAgICAgIHB1YmxpYwogICAgICAgIGNvbnN0YW50CiAgICAgICAgcmV0dXJucyAodWludCBjb3VudCkKICAgIHsKICAgICAgICBmb3IgKHVpbnQgaSA9IDA7IGkgPCB0cmFuc2FjdGlvbkNvdW50OyBpKyspIHsKICAgICAgICAgICAgaWYgKHBlbmRpbmcgJiYgIXRyYW5zYWN0aW9uc1tpXS5leGVjdXRlZCB8fCBleGVjdXRlZCAmJiB0cmFuc2FjdGlvbnNbaV0uZXhlY3V0ZWQpCiAgICAgICAgICAgICAgICBjb3VudCArPSAxOwogICAgICAgIH0KICAgIH0KCiAgICAvLy8gQGRldiBSZXR1cm5zIGxpc3Qgb2Ygb3duZXJzLgogICAgLy8vIEByZXR1cm4gTGlzdCBvZiBvd25lciBhZGRyZXNzZXMuCiAgICBmdW5jdGlvbiBnZXRPd25lcnMoKQogICAgICAgIHB1YmxpYwogICAgICAgIGNvbnN0YW50CiAgICAgICAgcmV0dXJucyAoYWRkcmVzc1tdKQogICAgewogICAgICAgIHJldHVybiBvd25lcnM7CiAgICB9CgogICAgLy8vIEBkZXYgUmV0dXJucyBhcnJheSB3aXRoIG93bmVyIGFkZHJlc3Nlcywgd2hpY2ggY29uZmlybWVkIHRyYW5zYWN0aW9uLgogICAgLy8vIEBwYXJhbSB0cmFuc2FjdGlvbklkIFRyYW5zYWN0aW9uIElELgogICAgLy8vIEByZXR1cm4gUmV0dXJucyBhcnJheSBvZiBvd25lciBhZGRyZXNzZXMuCiAgICBmdW5jdGlvbiBnZXRDb25maXJtYXRpb25zKHVpbnQgdHJhbnNhY3Rpb25JZCkKICAgICAgICBwdWJsaWMKICAgICAgICBjb25zdGFudAogICAgICAgIHJldHVybnMgKGFkZHJlc3NbXSBfY29uZmlybWF0aW9ucykKICAgIHsKICAgICAgICBhZGRyZXNzW10gbWVtb3J5IGNvbmZpcm1hdGlvbnNUZW1wID0gbmV3IGFkZHJlc3NbXShvd25lcnMubGVuZ3RoKTsKICAgICAgICB1aW50IGNvdW50ID0gMDsKICAgICAgICB1aW50IGk7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IG93bmVycy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBpZiAoY29uZmlybWF0aW9uc1t0cmFuc2FjdGlvbklkXVtvd25lcnNbaV1dKSB7CiAgICAgICAgICAgICAgICBjb25maXJtYXRpb25zVGVtcFtjb3VudF0gPSBvd25lcnNbaV07CiAgICAgICAgICAgICAgICBjb3VudCArPSAxOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIF9jb25maXJtYXRpb25zID0gbmV3IGFkZHJlc3NbXShjb3VudCk7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGNvdW50OyBpKyspIHsKICAgICAgICAgICAgX2NvbmZpcm1hdGlvbnNbaV0gPSBjb25maXJtYXRpb25zVGVtcFtpXTsKICAgICAgICB9CiAgICB9CgogICAgLy8vIEBkZXYgUmV0dXJucyBsaXN0IG9mIHRyYW5zYWN0aW9uIElEcyBpbiBkZWZpbmVkIHJhbmdlLgogICAgLy8vIEBwYXJhbSBmcm9tIEluZGV4IHN0YXJ0IHBvc2l0aW9uIG9mIHRyYW5zYWN0aW9uIGFycmF5LgogICAgLy8vIEBwYXJhbSB0byBJbmRleCBlbmQgcG9zaXRpb24gb2YgdHJhbnNhY3Rpb24gYXJyYXkuCiAgICAvLy8gQHBhcmFtIHBlbmRpbmcgSW5jbHVkZSBwZW5kaW5nIHRyYW5zYWN0aW9ucy4KICAgIC8vLyBAcGFyYW0gZXhlY3V0ZWQgSW5jbHVkZSBleGVjdXRlZCB0cmFuc2FjdGlvbnMuCiAgICAvLy8gQHJldHVybiBSZXR1cm5zIGFycmF5IG9mIHRyYW5zYWN0aW9uIElEcy4KICAgIGZ1bmN0aW9uIGdldFRyYW5zYWN0aW9uSWRzKHVpbnQgZnJvbSwgdWludCB0bywgYm9vbCBwZW5kaW5nLCBib29sIGV4ZWN1dGVkKQogICAgICAgIHB1YmxpYwogICAgICAgIGNvbnN0YW50CiAgICAgICAgcmV0dXJucyAodWludFtdIF90cmFuc2FjdGlvbklkcykKICAgIHsKICAgICAgICB1aW50W10gbWVtb3J5IHRyYW5zYWN0aW9uSWRzVGVtcCA9IG5ldyB1aW50W10odHJhbnNhY3Rpb25Db3VudCk7CiAgICAgICAgdWludCBjb3VudCA9IDA7CiAgICAgICAgdWludCBpOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCB0cmFuc2FjdGlvbkNvdW50OyBpKyspIHsKICAgICAgICAgICAgaWYgKHBlbmRpbmcgJiYgIXRyYW5zYWN0aW9uc1tpXS5leGVjdXRlZCB8fCBleGVjdXRlZCAmJiB0cmFuc2FjdGlvbnNbaV0uZXhlY3V0ZWQpIHsKICAgICAgICAgICAgICAgIHRyYW5zYWN0aW9uSWRzVGVtcFtjb3VudF0gPSBpOwogICAgICAgICAgICAgICAgY291bnQgKz0gMTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBfdHJhbnNhY3Rpb25JZHMgPSBuZXcgdWludFtdKHRvIC0gZnJvbSk7CiAgICAgICAgZm9yIChpID0gZnJvbTsgaSA8IHRvOyBpKyspIHsKICAgICAgICAgICAgX3RyYW5zYWN0aW9uSWRzW2kgLSBmcm9tXSA9IHRyYW5zYWN0aW9uSWRzVGVtcFtpXTsKICAgICAgICB9CiAgICB9Cn0='.
	

]
