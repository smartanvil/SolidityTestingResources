Class {
	#name : #SRTf925a82b8c26520170c8d51b65a7def6364877b3,
	#superclass : #SRTContracts,
	#category : #SolidityTestingResources
}

{ #category : #base64 }
SRTf925a82b8c26520170c8d51b65a7def6364877b3 >> base64 [
	^ 'cHJhZ21hIHNvbGlkaXR5IF4wLjQuMDsKCmludGVyZmFjZSBFUkMyMCB7CiAgICBmdW5jdGlvbiB0b3RhbFN1cHBseSgpIHB1YmxpYyBjb25zdGFudCByZXR1cm5zICh1aW50KTsKICAgIGZ1bmN0aW9uIGJhbGFuY2VPZihhZGRyZXNzIHRva2VuT3duZXIpIHB1YmxpYyBjb25zdGFudCByZXR1cm5zICh1aW50IGJhbGFuY2UpOwogICAgZnVuY3Rpb24gYWxsb3dhbmNlKGFkZHJlc3MgdG9rZW5Pd25lciwgYWRkcmVzcyBzcGVuZGVyKSBwdWJsaWMgY29uc3RhbnQgcmV0dXJucyAodWludCByZW1haW5pbmcpOwogICAgZnVuY3Rpb24gdHJhbnNmZXIoYWRkcmVzcyB0bywgdWludCB0b2tlbnMpIHB1YmxpYyByZXR1cm5zIChib29sIHN1Y2Nlc3MpOwogICAgZnVuY3Rpb24gYXBwcm92ZShhZGRyZXNzIHNwZW5kZXIsIHVpbnQgdG9rZW5zKSBwdWJsaWMgcmV0dXJucyAoYm9vbCBzdWNjZXNzKTsKICAgIGZ1bmN0aW9uIHRyYW5zZmVyRnJvbShhZGRyZXNzIGZyb20sIGFkZHJlc3MgdG8sIHVpbnQgdG9rZW5zKSBwdWJsaWMgcmV0dXJucyAoYm9vbCBzdWNjZXNzKTsKCiAgICBldmVudCBUcmFuc2ZlcihhZGRyZXNzIGluZGV4ZWQgZnJvbSwgYWRkcmVzcyBpbmRleGVkIHRvLCB1aW50IHRva2Vucyk7CiAgICBldmVudCBBcHByb3ZhbChhZGRyZXNzIGluZGV4ZWQgdG9rZW5Pd25lciwgYWRkcmVzcyBpbmRleGVkIHNwZW5kZXIsIHVpbnQgdG9rZW5zKTsKfQoKLy8gR09PIC0gQ3J5cHRvIElkbGUgR2FtZQovLyBodHRwczovL2V0aGVyZ29vLmlvCgpjb250cmFjdCBHb28gaXMgRVJDMjAgewogICAgCiAgICBzdHJpbmcgcHVibGljIGNvbnN0YW50IG5hbWUgID0gIklkbGVFdGgiOwogICAgc3RyaW5nIHB1YmxpYyBjb25zdGFudCBzeW1ib2wgPSAiR29vIjsKICAgIHVpbnQ4IHB1YmxpYyBjb25zdGFudCBkZWNpbWFscyA9IDA7CiAgICB1aW50MjU2IHByaXZhdGUgcm91Z2hTdXBwbHk7CiAgICB1aW50MjU2IHB1YmxpYyB0b3RhbEdvb1Byb2R1Y3Rpb247CiAgICBhZGRyZXNzIHB1YmxpYyBvd25lcjsgLy8gTWlub3IgbWFuYWdlbWVudCBvZiBnYW1lCiAgICBib29sIHB1YmxpYyBnYW1lU3RhcnRlZDsKICAgIAogICAgdWludDI1NiBwdWJsaWMgcmVzZWFyY2hEaXZQZXJjZW50ID0gODsKICAgIHVpbnQyNTYgcHVibGljIGdvb0RlcG9zaXREaXZQZXJjZW50ID0gMjsKICAgIAogICAgdWludDI1NiBwdWJsaWMgdG90YWxFdGhlckdvb1Jlc2VhcmNoUG9vbDsgLy8gRXRoIGRpdmlkZW5kcyB0byBiZSBzcGxpdCBiZXR3ZWVuIHBsYXllcnMnIGdvbyBwcm9kdWN0aW9uCiAgICB1aW50MjU2W10gcHJpdmF0ZSB0b3RhbEdvb1Byb2R1Y3Rpb25TbmFwc2hvdHM7IC8vIFRoZSB0b3RhbCBnb28gcHJvZHVjdGlvbiBmb3IgZWFjaCBwcmlvciBkYXkgcGFzdAogICAgdWludDI1NltdIHByaXZhdGUgdG90YWxHb29EZXBvc2l0U25hcHNob3RzOyAgLy8gVGhlIHRvdGFsIGdvbyBkZXBvc2l0ZWQgZm9yIGVhY2ggcHJpb3IgZGF5IHBhc3QKICAgIHVpbnQyNTZbXSBwcml2YXRlIGFsbG9jYXRlZEdvb1Jlc2VhcmNoU25hcHNob3RzOyAvLyBEaXYgcG90ICMxIChyZXNlYXJjaCBldGggYWxsb2NhdGVkIHRvIGVhY2ggcHJpb3IgZGF5IHBhc3QpCiAgICB1aW50MjU2W10gcHJpdmF0ZSBhbGxvY2F0ZWRHb29EZXBvc2l0U25hcHNob3RzOyAgLy8gRGl2IHBvdCAjMiAoZGVwb3NpdCBldGggYWxsb2NhdGVkIHRvIGVhY2ggcHJpb3IgZGF5IHBhc3QpCiAgICB1aW50MjU2IHB1YmxpYyBuZXh0U25hcHNob3RUaW1lOwogICAgCiAgICAvLyBCYWxhbmNlcyBmb3IgZWFjaCBwbGF5ZXIKICAgIG1hcHBpbmcoYWRkcmVzcyA9PiB1aW50MjU2KSBwcml2YXRlIGV0aEJhbGFuY2U7CiAgICBtYXBwaW5nKGFkZHJlc3MgPT4gdWludDI1NikgcHJpdmF0ZSBnb29CYWxhbmNlOwogICAgbWFwcGluZyhhZGRyZXNzID0+IG1hcHBpbmcodWludDI1NiA9PiB1aW50MjU2KSkgcHJpdmF0ZSBnb29Qcm9kdWN0aW9uU25hcHNob3RzOyAvLyBTdG9yZSBwbGF5ZXIncyBnb28gcHJvZHVjdGlvbiBmb3IgZ2l2ZW4gZGF5IChzbmFwc2hvdCkKICAgIG1hcHBpbmcoYWRkcmVzcyA9PiBtYXBwaW5nKHVpbnQyNTYgPT4gdWludDI1NikpIHByaXZhdGUgZ29vRGVwb3NpdFNuYXBzaG90czsgICAgLy8gU3RvcmUgcGxheWVyJ3MgZ29vIGRlcG9zaXRlZCBmb3IgZ2l2ZW4gZGF5IChzbmFwc2hvdCkKICAgIG1hcHBpbmcoYWRkcmVzcyA9PiBtYXBwaW5nKHVpbnQyNTYgPT4gYm9vbCkpIHByaXZhdGUgZ29vUHJvZHVjdGlvblplcm9lZFNuYXBzaG90czsgLy8gVGhpcyBpc24ndCBncmVhdCBidXQgd2UgbmVlZCBrbm93IGRpZmZlcmVuY2UgYmV0d2VlbiAwIHByb2R1Y3Rpb24gYW5kIGFuIHVudXNlZC9pbmFjdGl2ZSBkYXkuCiAgICAKICAgIG1hcHBpbmcoYWRkcmVzcyA9PiB1aW50MjU2KSBwcml2YXRlIGxhc3RHb29TYXZlVGltZTsgLy8gU2Vjb25kcyAobGFzdCB0aW1lIHBsYXllciBjbGFpbWVkIHRoZWlyIHByb2R1Y2VkIGdvbykKICAgIG1hcHBpbmcoYWRkcmVzcyA9PiB1aW50MjU2KSBwdWJsaWMgbGFzdEdvb1Byb2R1Y3Rpb25VcGRhdGU7IC8vIERheXMgKGxhc3Qgc25hcHNob3QgcGxheWVyIHVwZGF0ZWQgdGhlaXIgcHJvZHVjdGlvbikKICAgIG1hcHBpbmcoYWRkcmVzcyA9PiB1aW50MjU2KSBwcml2YXRlIGxhc3RHb29SZXNlYXJjaEZ1bmRDbGFpbTsgLy8gRGF5cyAoc25hcHNob3QgbnVtYmVyKQogICAgbWFwcGluZyhhZGRyZXNzID0+IHVpbnQyNTYpIHByaXZhdGUgbGFzdEdvb0RlcG9zaXRGdW5kQ2xhaW07IC8vIERheXMgKHNuYXBzaG90IG51bWJlcikKICAgIG1hcHBpbmcoYWRkcmVzcyA9PiB1aW50MjU2KSBwcml2YXRlIGJhdHRsZUNvb2xkb3duOyAvLyBJZiB1c2VyIGF0dGFja3MgdGhleSBjYW5ub3QgYXR0YWNrIGFnYWluIGZvciBzaG9ydCB0aW1lCiAgICAKICAgIC8vIFN0dWZmIG93bmVkIGJ5IGVhY2ggcGxheWVyCiAgICBtYXBwaW5nKGFkZHJlc3MgPT4gbWFwcGluZyh1aW50MjU2ID0+IHVpbnQyNTYpKSBwcml2YXRlIHVuaXRzT3duZWQ7CiAgICBtYXBwaW5nKGFkZHJlc3MgPT4gbWFwcGluZyh1aW50MjU2ID0+IGJvb2wpKSBwcml2YXRlIHVwZ3JhZGVzT3duZWQ7CiAgICBtYXBwaW5nKHVpbnQyNTYgPT4gYWRkcmVzcykgcHJpdmF0ZSByYXJlSXRlbU93bmVyOwogICAgbWFwcGluZyh1aW50MjU2ID0+IHVpbnQyNTYpIHByaXZhdGUgcmFyZUl0ZW1QcmljZTsKICAgIAogICAgLy8gUmFyZXMgJiBVcGdyYWRlcyAoSW5jcmVhc2UgdW5pdCdzIHByb2R1Y3Rpb24gLyBhdHRhY2sgZXRjLikKICAgIG1hcHBpbmcoYWRkcmVzcyA9PiBtYXBwaW5nKHVpbnQyNTYgPT4gdWludDI1NikpIHByaXZhdGUgdW5pdEdvb1Byb2R1Y3Rpb25JbmNyZWFzZXM7IC8vIEFkZHMgdG8gdGhlIGdvbyBwZXIgc2Vjb25kCiAgICBtYXBwaW5nKGFkZHJlc3MgPT4gbWFwcGluZyh1aW50MjU2ID0+IHVpbnQyNTYpKSBwcml2YXRlIHVuaXRHb29Qcm9kdWN0aW9uTXVsdGlwbGllcjsgLy8gTXVsdGlwbGllcyB0aGUgZ29vIHBlciBzZWNvbmQKICAgIG1hcHBpbmcoYWRkcmVzcyA9PiBtYXBwaW5nKHVpbnQyNTYgPT4gdWludDI1NikpIHByaXZhdGUgdW5pdEF0dGFja0luY3JlYXNlczsKICAgIG1hcHBpbmcoYWRkcmVzcyA9PiBtYXBwaW5nKHVpbnQyNTYgPT4gdWludDI1NikpIHByaXZhdGUgdW5pdEF0dGFja011bHRpcGxpZXI7CiAgICBtYXBwaW5nKGFkZHJlc3MgPT4gbWFwcGluZyh1aW50MjU2ID0+IHVpbnQyNTYpKSBwcml2YXRlIHVuaXREZWZlbnNlSW5jcmVhc2VzOwogICAgbWFwcGluZyhhZGRyZXNzID0+IG1hcHBpbmcodWludDI1NiA9PiB1aW50MjU2KSkgcHJpdmF0ZSB1bml0RGVmZW5zZU11bHRpcGxpZXI7CiAgICBtYXBwaW5nKGFkZHJlc3MgPT4gbWFwcGluZyh1aW50MjU2ID0+IHVpbnQyNTYpKSBwcml2YXRlIHVuaXRHb29TdGVhbGluZ0luY3JlYXNlczsKICAgIG1hcHBpbmcoYWRkcmVzcyA9PiBtYXBwaW5nKHVpbnQyNTYgPT4gdWludDI1NikpIHByaXZhdGUgdW5pdEdvb1N0ZWFsaW5nTXVsdGlwbGllcjsKICAgIG1hcHBpbmcoYWRkcmVzcyA9PiBtYXBwaW5nKHVpbnQyNTYgPT4gdWludDI1NikpIHByaXZhdGUgdW5pdE1heENhcDsKICAgIAogICAgLy8gTWFwcGluZyBvZiBhcHByb3ZlZCBFUkMyMCB0cmFuc2ZlcnMgKGJ5IHBsYXllcikKICAgIG1hcHBpbmcoYWRkcmVzcyA9PiBtYXBwaW5nKGFkZHJlc3MgPT4gdWludDI1NikpIHByaXZhdGUgYWxsb3dlZDsKICAgIG1hcHBpbmcoYWRkcmVzcyA9PiBib29sKSBwcml2YXRlIHByb3RlY3RlZEFkZHJlc3NlczsgLy8gRm9yIG5wYyBleGNoYW5nZXMgKHJlcXVpcmVzIDAgZ29vIHByb2R1Y3Rpb24pCiAgICAKICAgIC8vIFJhZmZsZSBzdHJ1Y3R1cmVzCiAgICBzdHJ1Y3QgVGlja2V0UHVyY2hhc2VzIHsKICAgICAgICBUaWNrZXRQdXJjaGFzZVtdIHRpY2tldHNCb3VnaHQ7CiAgICAgICAgdWludDI1NiBudW1QdXJjaGFzZXM7IC8vIEFsbG93cyB1cyB0byByZXNldCB3aXRob3V0IGNsZWFyaW5nIFRpY2tldFB1cmNoYXNlW10gKGF2b2lkcyBwb3RlbnRpYWwgZm9yIGdhcyBsaW1pdCkKICAgICAgICB1aW50MjU2IHJhZmZsZUlkOwogICAgfQogICAgCiAgICAvLyBBbGxvd3MgdXMgdG8gcXVlcnkgd2lubmVyIHdpdGhvdXQgbG9vcGluZyAoYXZvaWRpbmcgcG90ZW50aWFsIGZvciBnYXMgbGltaXQpCiAgICBzdHJ1Y3QgVGlja2V0UHVyY2hhc2UgewogICAgICAgIHVpbnQyNTYgc3RhcnRJZDsKICAgICAgICB1aW50MjU2IGVuZElkOwogICAgfQogICAgCiAgICAvLyBSYWZmbGUgdGlja2V0cwogICAgbWFwcGluZyhhZGRyZXNzID0+IFRpY2tldFB1cmNoYXNlcykgcHJpdmF0ZSByYXJlSXRlbVRpY2tldHNCb3VnaHRCeVBsYXllcjsKICAgIG1hcHBpbmcodWludDI1NiA9PiBhZGRyZXNzW10pIHByaXZhdGUgaXRlbVJhZmZsZVBsYXllcnM7CiAgICAKICAgIC8vIER1cGxpY2F0aW5nIGZvciB0aGUgdHdvIHJhZmZsZXMgaXMgbm90IGlkZWFsCiAgICBtYXBwaW5nKGFkZHJlc3MgPT4gVGlja2V0UHVyY2hhc2VzKSBwcml2YXRlIHJhcmVVbml0VGlja2V0c0JvdWdodEJ5UGxheWVyOwogICAgbWFwcGluZyh1aW50MjU2ID0+IGFkZHJlc3NbXSkgcHJpdmF0ZSB1bml0UmFmZmxlUGxheWVyczsKCiAgICAvLyBJdGVtIHJhZmZsZSBpbmZvCiAgICB1aW50MjU2IHByaXZhdGUgY29uc3RhbnQgUkFGRkxFX1RJQ0tFVF9CQVNFX0dPT19QUklDRSA9IDEwMDA7CiAgICB1aW50MjU2IHByaXZhdGUgaXRlbVJhZmZsZUVuZFRpbWU7CiAgICB1aW50MjU2IHByaXZhdGUgaXRlbVJhZmZsZVJhcmVJZDsKICAgIHVpbnQyNTYgcHJpdmF0ZSBpdGVtUmFmZmxlVGlja2V0c0JvdWdodDsKICAgIGFkZHJlc3MgcHJpdmF0ZSBpdGVtUmFmZmxlV2lubmVyOyAvLyBBZGRyZXNzIG9mIHdpbm5lcgogICAgYm9vbCBwcml2YXRlIGl0ZW1SYWZmbGVXaW5uaW5nVGlja2V0U2VsZWN0ZWQ7CiAgICB1aW50MjU2IHByaXZhdGUgaXRlbVJhZmZsZVRpY2tldFRoYXRXb247CiAgICAKICAgICAvLyBVbml0IHJhZmZsZSBpbmZvCiAgICB1aW50MjU2IHByaXZhdGUgdW5pdFJhZmZsZUVuZFRpbWU7CiAgICB1aW50MjU2IHByaXZhdGUgdW5pdFJhZmZsZUlkOyAgICAgLy8gUmFmZmxlIElkCiAgICB1aW50MjU2IHByaXZhdGUgdW5pdFJhZmZsZVJhcmVJZDsgLy8gVW5pdCBJZAogICAgdWludDI1NiBwcml2YXRlIHVuaXRSYWZmbGVUaWNrZXRzQm91Z2h0OwogICAgYWRkcmVzcyBwcml2YXRlIHVuaXRSYWZmbGVXaW5uZXI7IC8vIEFkZHJlc3Mgb2Ygd2lubmVyCiAgICBib29sIHByaXZhdGUgdW5pdFJhZmZsZVdpbm5pbmdUaWNrZXRTZWxlY3RlZDsKICAgIHVpbnQyNTYgcHJpdmF0ZSB1bml0UmFmZmxlVGlja2V0VGhhdFdvbjsKICAgIAogICAgLy8gTWlub3IgZ2FtZSBldmVudHMKICAgIGV2ZW50IFVuaXRCb3VnaHQoYWRkcmVzcyBwbGF5ZXIsIHVpbnQyNTYgdW5pdElkLCB1aW50MjU2IGFtb3VudCk7CiAgICBldmVudCBVbml0U29sZChhZGRyZXNzIHBsYXllciwgdWludDI1NiB1bml0SWQsIHVpbnQyNTYgYW1vdW50KTsKICAgIGV2ZW50IFBsYXllckF0dGFja2VkKGFkZHJlc3MgYXR0YWNrZXIsIGFkZHJlc3MgdGFyZ2V0LCBib29sIHN1Y2Nlc3MsIHVpbnQyNTYgZ29vU3RvbGVuKTsKICAgIAogICAgZXZlbnQgUmVmZXJhbEdhaW4oYWRkcmVzcyBwbGF5ZXIsIGFkZHJlc3MgcmVmZXJhbCwgdWludDI1NiBhbW91bnQpOwogICAgZXZlbnQgVXBncmFkZU1pZ3JhdGlvbihhZGRyZXNzIHBsYXllciwgdWludDI1NiB1cGdyYWRlSWQsIHVpbnQyNTYgdHhQcm9vZik7CiAgICAKICAgIEdvb0dhbWVDb25maWcgc2NoZW1hID0gR29vR2FtZUNvbmZpZygweGY5MjVhODJiOGMyNjUyMDE3MGM4ZDUxYjY1YTdkZWY2MzY0ODc3YjMpOwogICAgCiAgICAvLyBDb25zdHJ1Y3RvcgogICAgZnVuY3Rpb24gR29vKCkgcHVibGljIHBheWFibGUgewogICAgICAgIG93bmVyID0gbXNnLnNlbmRlcjsKICAgIH0KICAgIAogICAgZnVuY3Rpb24oKSBwYXlhYmxlIHsKICAgICAgICAvLyBGYWxsYmFjayB3aWxsIGRvbmF0ZSB0byBwb3QKICAgICAgICB0b3RhbEV0aGVyR29vUmVzZWFyY2hQb29sICs9IG1zZy52YWx1ZTsKICAgIH0KICAgIAogICAgZnVuY3Rpb24gYmVnaW5HYW1lKHVpbnQyNTYgZmlyc3REaXZzVGltZSkgZXh0ZXJuYWwgcGF5YWJsZSB7CiAgICAgICAgcmVxdWlyZShtc2cuc2VuZGVyID09IG93bmVyKTsKICAgICAgICByZXF1aXJlKCFnYW1lU3RhcnRlZCk7CiAgICAgICAgCiAgICAgICAgZ2FtZVN0YXJ0ZWQgPSB0cnVlOyAvLyBHTy1PT09PIQogICAgICAgIG5leHRTbmFwc2hvdFRpbWUgPSBmaXJzdERpdnNUaW1lOwogICAgICAgIHRvdGFsR29vRGVwb3NpdFNuYXBzaG90cy5wdXNoKDApOyAvLyBBZGQgaW5pdGlhbC16ZXJvIHNuYXBzaG90CiAgICAgICAgdG90YWxFdGhlckdvb1Jlc2VhcmNoUG9vbCA9IG1zZy52YWx1ZTsgLy8gU2VlZCBwb3QKICAgIH0KICAgIAogICAgLy8gSW5jYXNlIGNvbW11bml0eSBwcmVmZXJzIGdvbyBkZXBvc2l0IHBheW1lbnRzIG92ZXIgcHJvZHVjdGlvbiAlLCBjYW4gYmUgdHdlYWtlZCBmb3IgYmFsYW5jZQogICAgZnVuY3Rpb24gdHdlYWtEYWlseURpdmlkZW5kcyh1aW50MjU2IG5ld1Jlc2VhcmNoUGVyY2VudCwgdWludDI1NiBuZXdHb29EZXBvc2l0UGVyY2VudCkgZXh0ZXJuYWwgewogICAgICAgIHJlcXVpcmUobXNnLnNlbmRlciA9PSBvd25lcik7CiAgICAgICAgcmVxdWlyZShuZXdSZXNlYXJjaFBlcmNlbnQgPiAwICYmIG5ld1Jlc2VhcmNoUGVyY2VudCA8PSAxMCk7CiAgICAgICAgcmVxdWlyZShuZXdHb29EZXBvc2l0UGVyY2VudCA+IDAgJiYgbmV3R29vRGVwb3NpdFBlcmNlbnQgPD0gMTApOwogICAgICAgIAogICAgICAgIHJlc2VhcmNoRGl2UGVyY2VudCA9IG5ld1Jlc2VhcmNoUGVyY2VudDsKICAgICAgICBnb29EZXBvc2l0RGl2UGVyY2VudCA9IG5ld0dvb0RlcG9zaXRQZXJjZW50OwogICAgfQogICAgCiAgICBmdW5jdGlvbiB0b3RhbFN1cHBseSgpIHB1YmxpYyBjb25zdGFudCByZXR1cm5zKHVpbnQyNTYpIHsKICAgICAgICByZXR1cm4gcm91Z2hTdXBwbHk7IC8vIFN0b3JlZCBnb28gKHJvdWdoIHN1cHBseSBhcyBpdCBpZ25vcmVzIGVhcm5lZC91bmNsYWltZWQgZ29vKQogICAgfQogICAgCiAgICBmdW5jdGlvbiBiYWxhbmNlT2YoYWRkcmVzcyBwbGF5ZXIpIHB1YmxpYyBjb25zdGFudCByZXR1cm5zKHVpbnQyNTYpIHsKICAgICAgICByZXR1cm4gZ29vQmFsYW5jZVtwbGF5ZXJdICsgYmFsYW5jZU9mVW5jbGFpbWVkR29vKHBsYXllcik7CiAgICB9CiAgICAKICAgIGZ1bmN0aW9uIGJhbGFuY2VPZlVuY2xhaW1lZEdvbyhhZGRyZXNzIHBsYXllcikgaW50ZXJuYWwgY29uc3RhbnQgcmV0dXJucyAodWludDI1NikgewogICAgICAgIHVpbnQyNTYgbGFzdFNhdmUgPSBsYXN0R29vU2F2ZVRpbWVbcGxheWVyXTsKICAgICAgICBpZiAobGFzdFNhdmUgPiAwICYmIGxhc3RTYXZlIDwgYmxvY2sudGltZXN0YW1wKSB7CiAgICAgICAgICAgIHJldHVybiAoZ2V0R29vUHJvZHVjdGlvbihwbGF5ZXIpICogKGJsb2NrLnRpbWVzdGFtcCAtIGxhc3RTYXZlKSkgLyAxMDA7CiAgICAgICAgfQogICAgICAgIHJldHVybiAwOwogICAgfQogICAgCiAgICBmdW5jdGlvbiBldGhlckJhbGFuY2VPZihhZGRyZXNzIHBsYXllcikgcHVibGljIGNvbnN0YW50IHJldHVybnModWludDI1NikgewogICAgICAgIHJldHVybiBldGhCYWxhbmNlW3BsYXllcl07CiAgICB9CiAgICAKICAgIGZ1bmN0aW9uIHRyYW5zZmVyKGFkZHJlc3MgcmVjaXBpZW50LCB1aW50MjU2IGFtb3VudCkgcHVibGljIHJldHVybnMgKGJvb2wpIHsKICAgICAgICB1cGRhdGVQbGF5ZXJzR29vKG1zZy5zZW5kZXIpOwogICAgICAgIHJlcXVpcmUoYW1vdW50IDw9IGdvb0JhbGFuY2VbbXNnLnNlbmRlcl0pOwogICAgICAgIAogICAgICAgIGdvb0JhbGFuY2VbbXNnLnNlbmRlcl0gLT0gYW1vdW50OwogICAgICAgIGdvb0JhbGFuY2VbcmVjaXBpZW50XSArPSBhbW91bnQ7CiAgICAgICAgCiAgICAgICAgZW1pdCBUcmFuc2Zlcihtc2cuc2VuZGVyLCByZWNpcGllbnQsIGFtb3VudCk7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICAKICAgIGZ1bmN0aW9uIHRyYW5zZmVyRnJvbShhZGRyZXNzIHBsYXllciwgYWRkcmVzcyByZWNpcGllbnQsIHVpbnQyNTYgYW1vdW50KSBwdWJsaWMgcmV0dXJucyAoYm9vbCkgewogICAgICAgIHVwZGF0ZVBsYXllcnNHb28ocGxheWVyKTsKICAgICAgICByZXF1aXJlKGFtb3VudCA8PSBhbGxvd2VkW3BsYXllcl1bbXNnLnNlbmRlcl0gJiYgYW1vdW50IDw9IGdvb0JhbGFuY2VbcGxheWVyXSk7CiAgICAgICAgCiAgICAgICAgZ29vQmFsYW5jZVtwbGF5ZXJdIC09IGFtb3VudDsKICAgICAgICBnb29CYWxhbmNlW3JlY2lwaWVudF0gKz0gYW1vdW50OwogICAgICAgIGFsbG93ZWRbcGxheWVyXVttc2cuc2VuZGVyXSAtPSBhbW91bnQ7CiAgICAgICAgCiAgICAgICAgZW1pdCBUcmFuc2ZlcihwbGF5ZXIsIHJlY2lwaWVudCwgYW1vdW50KTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIAogICAgZnVuY3Rpb24gYXBwcm92ZShhZGRyZXNzIGFwcHJvdmVlLCB1aW50MjU2IGFtb3VudCkgcHVibGljIHJldHVybnMgKGJvb2wpewogICAgICAgIGFsbG93ZWRbbXNnLnNlbmRlcl1bYXBwcm92ZWVdID0gYW1vdW50OwogICAgICAgIGVtaXQgQXBwcm92YWwobXNnLnNlbmRlciwgYXBwcm92ZWUsIGFtb3VudCk7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICAKICAgIGZ1bmN0aW9uIGFsbG93YW5jZShhZGRyZXNzIHBsYXllciwgYWRkcmVzcyBhcHByb3ZlZSkgcHVibGljIGNvbnN0YW50IHJldHVybnModWludDI1Nil7CiAgICAgICAgcmV0dXJuIGFsbG93ZWRbcGxheWVyXVthcHByb3ZlZV07CiAgICB9CiAgICAKICAgIGZ1bmN0aW9uIGdldEdvb1Byb2R1Y3Rpb24oYWRkcmVzcyBwbGF5ZXIpIHB1YmxpYyBjb25zdGFudCByZXR1cm5zICh1aW50MjU2KXsKICAgICAgICByZXR1cm4gZ29vUHJvZHVjdGlvblNuYXBzaG90c1twbGF5ZXJdW2xhc3RHb29Qcm9kdWN0aW9uVXBkYXRlW3BsYXllcl1dOwogICAgfQogICAgCiAgICBmdW5jdGlvbiB1cGRhdGVQbGF5ZXJzR29vKGFkZHJlc3MgcGxheWVyKSBpbnRlcm5hbCB7CiAgICAgICAgdWludDI1NiBnb29HYWluID0gYmFsYW5jZU9mVW5jbGFpbWVkR29vKHBsYXllcik7CiAgICAgICAgbGFzdEdvb1NhdmVUaW1lW3BsYXllcl0gPSBibG9jay50aW1lc3RhbXA7CiAgICAgICAgcm91Z2hTdXBwbHkgKz0gZ29vR2FpbjsKICAgICAgICBnb29CYWxhbmNlW3BsYXllcl0gKz0gZ29vR2FpbjsKICAgIH0KICAgIAogICAgZnVuY3Rpb24gdXBkYXRlUGxheWVyc0dvb0Zyb21QdXJjaGFzZShhZGRyZXNzIHBsYXllciwgdWludDI1NiBwdXJjaGFzZUNvc3QpIGludGVybmFsIHsKICAgICAgICB1aW50MjU2IHVuY2xhaW1lZEdvbyA9IGJhbGFuY2VPZlVuY2xhaW1lZEdvbyhwbGF5ZXIpOwogICAgICAgIAogICAgICAgIGlmIChwdXJjaGFzZUNvc3QgPiB1bmNsYWltZWRHb28pIHsKICAgICAgICAgICAgdWludDI1NiBnb29EZWNyZWFzZSA9IHB1cmNoYXNlQ29zdCAtIHVuY2xhaW1lZEdvbzsKICAgICAgICAgICAgcmVxdWlyZShnb29CYWxhbmNlW3BsYXllcl0gPj0gZ29vRGVjcmVhc2UpOwogICAgICAgICAgICByb3VnaFN1cHBseSAtPSBnb29EZWNyZWFzZTsKICAgICAgICAgICAgZ29vQmFsYW5jZVtwbGF5ZXJdIC09IGdvb0RlY3JlYXNlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHVpbnQyNTYgZ29vR2FpbiA9IHVuY2xhaW1lZEdvbyAtIHB1cmNoYXNlQ29zdDsKICAgICAgICAgICAgcm91Z2hTdXBwbHkgKz0gZ29vR2FpbjsKICAgICAgICAgICAgZ29vQmFsYW5jZVtwbGF5ZXJdICs9IGdvb0dhaW47CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGxhc3RHb29TYXZlVGltZVtwbGF5ZXJdID0gYmxvY2sudGltZXN0YW1wOwogICAgfQogICAgCiAgICBmdW5jdGlvbiBpbmNyZWFzZVBsYXllcnNHb29Qcm9kdWN0aW9uKGFkZHJlc3MgcGxheWVyLCB1aW50MjU2IGluY3JlYXNlKSBpbnRlcm5hbCB7CiAgICAgICAgZ29vUHJvZHVjdGlvblNuYXBzaG90c1twbGF5ZXJdW2FsbG9jYXRlZEdvb1Jlc2VhcmNoU25hcHNob3RzLmxlbmd0aF0gPSBnZXRHb29Qcm9kdWN0aW9uKHBsYXllcikgKyBpbmNyZWFzZTsKICAgICAgICBsYXN0R29vUHJvZHVjdGlvblVwZGF0ZVtwbGF5ZXJdID0gYWxsb2NhdGVkR29vUmVzZWFyY2hTbmFwc2hvdHMubGVuZ3RoOwogICAgICAgIHRvdGFsR29vUHJvZHVjdGlvbiArPSBpbmNyZWFzZTsKICAgIH0KICAgIAogICAgZnVuY3Rpb24gcmVkdWNlUGxheWVyc0dvb1Byb2R1Y3Rpb24oYWRkcmVzcyBwbGF5ZXIsIHVpbnQyNTYgZGVjcmVhc2UpIGludGVybmFsIHsKICAgICAgICB1aW50MjU2IHByZXZpb3VzUHJvZHVjdGlvbiA9IGdldEdvb1Byb2R1Y3Rpb24ocGxheWVyKTsKICAgICAgICB1aW50MjU2IG5ld1Byb2R1Y3Rpb24gPSBTYWZlTWF0aC5zdWIocHJldmlvdXNQcm9kdWN0aW9uLCBkZWNyZWFzZSk7CiAgICAgICAgCiAgICAgICAgaWYgKG5ld1Byb2R1Y3Rpb24gPT0gMCkgeyAvLyBTcGVjaWFsIGNhc2Ugd2hpY2ggdGFuZ2xlcyB3aXRoICJpbmFjdGl2ZSBkYXkiIHNuYXBzaG90cyAoY2xhaW1pbmcgZGl2cykKICAgICAgICAgICAgZ29vUHJvZHVjdGlvblplcm9lZFNuYXBzaG90c1twbGF5ZXJdW2FsbG9jYXRlZEdvb1Jlc2VhcmNoU25hcHNob3RzLmxlbmd0aF0gPSB0cnVlOwogICAgICAgICAgICBkZWxldGUgZ29vUHJvZHVjdGlvblNuYXBzaG90c1twbGF5ZXJdW2FsbG9jYXRlZEdvb1Jlc2VhcmNoU25hcHNob3RzLmxlbmd0aF07IC8vIDAKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBnb29Qcm9kdWN0aW9uU25hcHNob3RzW3BsYXllcl1bYWxsb2NhdGVkR29vUmVzZWFyY2hTbmFwc2hvdHMubGVuZ3RoXSA9IG5ld1Byb2R1Y3Rpb247CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGxhc3RHb29Qcm9kdWN0aW9uVXBkYXRlW3BsYXllcl0gPSBhbGxvY2F0ZWRHb29SZXNlYXJjaFNuYXBzaG90cy5sZW5ndGg7CiAgICAgICAgdG90YWxHb29Qcm9kdWN0aW9uIC09IGRlY3JlYXNlOwogICAgfQogICAgCiAgICAKICAgIGZ1bmN0aW9uIGJ1eUJhc2ljVW5pdCh1aW50MjU2IHVuaXRJZCwgdWludDI1NiBhbW91bnQpIGV4dGVybmFsIHsKICAgICAgICB1aW50MjU2IHNjaGVtYVVuaXRJZDsKICAgICAgICB1aW50MjU2IGdvb1Byb2R1Y3Rpb247CiAgICAgICAgdWludDI1NiBnb29Db3N0OwogICAgICAgIHVpbnQyNTYgZXRoQ29zdDsKICAgICAgICB1aW50MjU2IGV4aXN0aW5nID0gdW5pdHNPd25lZFttc2cuc2VuZGVyXVt1bml0SWRdOwogICAgICAgIChzY2hlbWFVbml0SWQsIGdvb1Byb2R1Y3Rpb24sIGdvb0Nvc3QsIGV0aENvc3QpID0gc2NoZW1hLmdldFVuaXRJbmZvKHVuaXRJZCwgZXhpc3RpbmcsIGFtb3VudCk7CiAgICAgICAgCiAgICAgICAgcmVxdWlyZShnYW1lU3RhcnRlZCk7CiAgICAgICAgcmVxdWlyZShzY2hlbWFVbml0SWQgPiAwKTsgLy8gVmFsaWQgdW5pdAogICAgICAgIHJlcXVpcmUoZXRoQ29zdCA9PSAwKTsgLy8gRnJlZSB1bml0CiAgICAgICAgCiAgICAgICAgdWludDI1NiBuZXdUb3RhbCA9IFNhZmVNYXRoLmFkZChleGlzdGluZywgYW1vdW50KTsKICAgICAgICBpZiAobmV3VG90YWwgPiA5OSkgeyAvLyBEZWZhdWx0IHVuaXQgbGltaXQKICAgICAgICAgICAgcmVxdWlyZShuZXdUb3RhbCA8PSB1bml0TWF4Q2FwW21zZy5zZW5kZXJdW3VuaXRJZF0pOyAvLyBIb3VzaW5nIHVwZ3JhZGVzIChhbGxvdyBtb3JlIHVuaXRzKQogICAgICAgIH0KICAgICAgICAKICAgICAgICAvLyBVcGRhdGUgcGxheWVycyBnb28KICAgICAgICB1cGRhdGVQbGF5ZXJzR29vRnJvbVB1cmNoYXNlKG1zZy5zZW5kZXIsIGdvb0Nvc3QpOwogICAgICAgIAogICAgICAgIGlmIChnb29Qcm9kdWN0aW9uID4gMCkgewogICAgICAgICAgICBpbmNyZWFzZVBsYXllcnNHb29Qcm9kdWN0aW9uKG1zZy5zZW5kZXIsIGdldFVuaXRzUHJvZHVjdGlvbihtc2cuc2VuZGVyLCB1bml0SWQsIGFtb3VudCkpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICB1bml0c093bmVkW21zZy5zZW5kZXJdW3VuaXRJZF0gPSBuZXdUb3RhbDsKICAgICAgICBlbWl0IFVuaXRCb3VnaHQobXNnLnNlbmRlciwgdW5pdElkLCBhbW91bnQpOwogICAgfQogICAgCiAgICAKICAgIGZ1bmN0aW9uIGJ1eUV0aFVuaXQodWludDI1NiB1bml0SWQsIHVpbnQyNTYgYW1vdW50KSBleHRlcm5hbCBwYXlhYmxlIHsKICAgICAgICB1aW50MjU2IHNjaGVtYVVuaXRJZDsKICAgICAgICB1aW50MjU2IGdvb1Byb2R1Y3Rpb247CiAgICAgICAgdWludDI1NiBnb29Db3N0OwogICAgICAgIHVpbnQyNTYgZXRoQ29zdDsKICAgICAgICB1aW50MjU2IGV4aXN0aW5nID0gdW5pdHNPd25lZFttc2cuc2VuZGVyXVt1bml0SWRdOwogICAgICAgIChzY2hlbWFVbml0SWQsIGdvb1Byb2R1Y3Rpb24sIGdvb0Nvc3QsIGV0aENvc3QpID0gc2NoZW1hLmdldFVuaXRJbmZvKHVuaXRJZCwgZXhpc3RpbmcsIGFtb3VudCk7CiAgICAgICAgCiAgICAgICAgcmVxdWlyZShnYW1lU3RhcnRlZCk7CiAgICAgICAgcmVxdWlyZShzY2hlbWFVbml0SWQgPiAwKTsKICAgICAgICByZXF1aXJlKGV0aEJhbGFuY2VbbXNnLnNlbmRlcl0gKyBtc2cudmFsdWUgPj0gZXRoQ29zdCk7CgogICAgICAgIGlmIChldGhDb3N0ID4gbXNnLnZhbHVlKSB7CiAgICAgICAgICAgIGV0aEJhbGFuY2VbbXNnLnNlbmRlcl0gLT0gKGV0aENvc3QgLSBtc2cudmFsdWUpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICB1aW50MjU2IGRldkZ1bmQgPSBldGhDb3N0IC8gNTA7IC8vIDIlIGZlZSBvbiBwdXJjaGFzZXMgKG1hcmtldGluZywgZ2FtZXBsYXkgJiBtYWludGVuYW5jZSkKICAgICAgICB1aW50MjU2IGRpdmlkZW5kcyA9IChldGhDb3N0IC0gZGV2RnVuZCkgLyA0OyAvLyAyNSUgZ29lcyB0byBwb29sICg3NSUgcmV0YWluZWQgZm9yIHNhbGUgdmFsdWUpCiAgICAgICAgdG90YWxFdGhlckdvb1Jlc2VhcmNoUG9vbCArPSBkaXZpZGVuZHM7CiAgICAgICAgZXRoQmFsYW5jZVtvd25lcl0gKz0gZGV2RnVuZDsKICAgICAgICAKICAgICAgICAKICAgICAgICB1aW50MjU2IG5ld1RvdGFsID0gU2FmZU1hdGguYWRkKGV4aXN0aW5nLCBhbW91bnQpOwogICAgICAgIGlmIChuZXdUb3RhbCA+IDk5KSB7IC8vIERlZmF1bHQgdW5pdCBsaW1pdAogICAgICAgICAgICByZXF1aXJlKG5ld1RvdGFsIDw9IHVuaXRNYXhDYXBbbXNnLnNlbmRlcl1bdW5pdElkXSk7IC8vIEhvdXNpbmcgdXBncmFkZXMgKGFsbG93IG1vcmUgdW5pdHMpCiAgICAgICAgfQogICAgICAgIAogICAgICAgIC8vIFVwZGF0ZSBwbGF5ZXJzIGdvbwogICAgICAgIHVwZGF0ZVBsYXllcnNHb29Gcm9tUHVyY2hhc2UobXNnLnNlbmRlciwgZ29vQ29zdCk7CiAgICAgICAgCiAgICAgICAgaWYgKGdvb1Byb2R1Y3Rpb24gPiAwKSB7CiAgICAgICAgICAgIGluY3JlYXNlUGxheWVyc0dvb1Byb2R1Y3Rpb24obXNnLnNlbmRlciwgZ2V0VW5pdHNQcm9kdWN0aW9uKG1zZy5zZW5kZXIsIHVuaXRJZCwgYW1vdW50KSk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHVuaXRzT3duZWRbbXNnLnNlbmRlcl1bdW5pdElkXSArPSBhbW91bnQ7CiAgICAgICAgZW1pdCBVbml0Qm91Z2h0KG1zZy5zZW5kZXIsIHVuaXRJZCwgYW1vdW50KTsKICAgIH0KICAgIAogICAgCiAgICBmdW5jdGlvbiBzZWxsVW5pdCh1aW50MjU2IHVuaXRJZCwgdWludDI1NiBhbW91bnQpIGV4dGVybmFsIHsKICAgICAgICB1aW50MjU2IGV4aXN0aW5nID0gdW5pdHNPd25lZFttc2cuc2VuZGVyXVt1bml0SWRdOwogICAgICAgIHJlcXVpcmUoZXhpc3RpbmcgPj0gYW1vdW50ICYmIGFtb3VudCA+IDApOwogICAgICAgIGV4aXN0aW5nIC09IGFtb3VudDsKICAgICAgICB1bml0c093bmVkW21zZy5zZW5kZXJdW3VuaXRJZF0gPSBleGlzdGluZzsKICAgICAgICAKICAgICAgICB1aW50MjU2IHNjaGVtYVVuaXRJZDsKICAgICAgICB1aW50MjU2IGdvb1Byb2R1Y3Rpb247CiAgICAgICAgdWludDI1NiBnb29Db3N0OwogICAgICAgIHVpbnQyNTYgZXRoQ29zdDsKICAgICAgICAoc2NoZW1hVW5pdElkLCBnb29Qcm9kdWN0aW9uLCBnb29Db3N0LCBldGhDb3N0KSA9IHNjaGVtYS5nZXRVbml0SW5mbyh1bml0SWQsIGV4aXN0aW5nLCBhbW91bnQpOwogICAgICAgIHJlcXVpcmUoc2NoZW1hLnVuaXRTZWxsYWJsZSh1bml0SWQpKTsKICAgICAgICAKICAgICAgICB1aW50MjU2IGdvb0NoYW5nZSA9IGJhbGFuY2VPZlVuY2xhaW1lZEdvbyhtc2cuc2VuZGVyKSArICgoZ29vQ29zdCAqIDMpIC8gNCk7IC8vIENsYWltIHVuc2F2ZWQgZ29vIHdoaWxzdCBoZXJlCiAgICAgICAgbGFzdEdvb1NhdmVUaW1lW21zZy5zZW5kZXJdID0gYmxvY2sudGltZXN0YW1wOwogICAgICAgIHJvdWdoU3VwcGx5ICs9IGdvb0NoYW5nZTsKICAgICAgICBnb29CYWxhbmNlW21zZy5zZW5kZXJdICs9IGdvb0NoYW5nZTsKICAgICAgICAKICAgICAgICBpZiAoZ29vUHJvZHVjdGlvbiA+IDApIHsKICAgICAgICAgICAgcmVkdWNlUGxheWVyc0dvb1Byb2R1Y3Rpb24obXNnLnNlbmRlciwgZ2V0VW5pdHNQcm9kdWN0aW9uKG1zZy5zZW5kZXIsIHVuaXRJZCwgYW1vdW50KSk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGlmIChldGhDb3N0ID4gMCkgeyAvLyBQcmVtaXVtIHVuaXRzIHNlbGwgZm9yIDc1JSBvZiBidXkgY29zdAogICAgICAgICAgICBldGhCYWxhbmNlW21zZy5zZW5kZXJdICs9IChldGhDb3N0ICogMykgLyA0OwogICAgICAgIH0KICAgICAgICAKICAgICAgICBlbWl0IFVuaXRTb2xkKG1zZy5zZW5kZXIsIHVuaXRJZCwgYW1vdW50KTsKICAgIH0KICAgIAogICAgCiAgICBmdW5jdGlvbiBidXlVcGdyYWRlKHVpbnQyNTYgdXBncmFkZUlkKSBleHRlcm5hbCBwYXlhYmxlIHsKICAgICAgICB1aW50MjU2IGdvb0Nvc3Q7CiAgICAgICAgdWludDI1NiBldGhDb3N0OwogICAgICAgIHVpbnQyNTYgdXBncmFkZUNsYXNzOwogICAgICAgIHVpbnQyNTYgdW5pdElkOwogICAgICAgIHVpbnQyNTYgdXBncmFkZVZhbHVlOwogICAgICAgIHVpbnQyNTYgcHJlcmVxdWlzaXRlVXBncmFkZTsKICAgICAgICAoZ29vQ29zdCwgZXRoQ29zdCwgdXBncmFkZUNsYXNzLCB1bml0SWQsIHVwZ3JhZGVWYWx1ZSwgcHJlcmVxdWlzaXRlVXBncmFkZSkgPSBzY2hlbWEuZ2V0VXBncmFkZUluZm8odXBncmFkZUlkKTsKICAgICAgICAKICAgICAgICByZXF1aXJlKGdhbWVTdGFydGVkKTsKICAgICAgICByZXF1aXJlKHVuaXRJZCA+IDApOyAvLyBWYWxpZCB1cGdyYWRlCiAgICAgICAgcmVxdWlyZSghdXBncmFkZXNPd25lZFttc2cuc2VuZGVyXVt1cGdyYWRlSWRdKTsgLy8gSGF2ZW4ndCBhbHJlYWR5IHB1cmNoYXNlZAogICAgICAgIAogICAgICAgIGlmIChwcmVyZXF1aXNpdGVVcGdyYWRlID4gMCkgewogICAgICAgICAgICByZXF1aXJlKHVwZ3JhZGVzT3duZWRbbXNnLnNlbmRlcl1bcHJlcmVxdWlzaXRlVXBncmFkZV0pOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBpZiAoZXRoQ29zdCA+IDApIHsKICAgICAgICAgICAgcmVxdWlyZShldGhCYWxhbmNlW21zZy5zZW5kZXJdICsgbXNnLnZhbHVlID49IGV0aENvc3QpOwogICAgICAgICAgICAgaWYgKGV0aENvc3QgPiBtc2cudmFsdWUpIHsgLy8gVGhleSBjYW4gdXNlIHRoZWlyIGJhbGFuY2UgaW5zdGVhZAogICAgICAgICAgICAgICAgZXRoQmFsYW5jZVttc2cuc2VuZGVyXSAtPSAoZXRoQ29zdCAtIG1zZy52YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAKICAgICAgICAgICAgdWludDI1NiBkZXZGdW5kID0gZXRoQ29zdCAvIDUwOyAvLyAyJSBmZWUgb24gcHVyY2hhc2VzIChtYXJrZXRpbmcsIGdhbWVwbGF5ICYgbWFpbnRlbmFuY2UpCiAgICAgICAgICAgIHRvdGFsRXRoZXJHb29SZXNlYXJjaFBvb2wgKz0gKGV0aENvc3QgLSBkZXZGdW5kKTsgLy8gUmVzdCBnb2VzIHRvIGRpdiBwb29sIChDYW4ndCBzZWxsIHVwZ3JhZGVzKQogICAgICAgICAgICBldGhCYWxhbmNlW293bmVyXSArPSBkZXZGdW5kOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAvLyBVcGRhdGUgcGxheWVycyBnb28KICAgICAgICB1cGRhdGVQbGF5ZXJzR29vRnJvbVB1cmNoYXNlKG1zZy5zZW5kZXIsIGdvb0Nvc3QpOwoKICAgICAgICB1cGdyYWRlVW5pdE11bHRpcGxpZXJzKG1zZy5zZW5kZXIsIHVwZ3JhZGVDbGFzcywgdW5pdElkLCB1cGdyYWRlVmFsdWUpOwogICAgICAgIHVwZ3JhZGVzT3duZWRbbXNnLnNlbmRlcl1bdXBncmFkZUlkXSA9IHRydWU7CiAgICB9CiAgICAKICAgIGZ1bmN0aW9uIHVwZ3JhZGVVbml0TXVsdGlwbGllcnMoYWRkcmVzcyBwbGF5ZXIsIHVpbnQyNTYgdXBncmFkZUNsYXNzLCB1aW50MjU2IHVuaXRJZCwgdWludDI1NiB1cGdyYWRlVmFsdWUpIGludGVybmFsIHsKICAgICAgICB1aW50MjU2IHByb2R1Y3Rpb25HYWluOwogICAgICAgIGlmICh1cGdyYWRlQ2xhc3MgPT0gMCkgewogICAgICAgICAgICB1bml0R29vUHJvZHVjdGlvbkluY3JlYXNlc1twbGF5ZXJdW3VuaXRJZF0gKz0gdXBncmFkZVZhbHVlOwogICAgICAgICAgICBwcm9kdWN0aW9uR2FpbiA9IHVuaXRzT3duZWRbcGxheWVyXVt1bml0SWRdICogdXBncmFkZVZhbHVlICogKDEwICsgdW5pdEdvb1Byb2R1Y3Rpb25NdWx0aXBsaWVyW3BsYXllcl1bdW5pdElkXSk7CiAgICAgICAgICAgIGluY3JlYXNlUGxheWVyc0dvb1Byb2R1Y3Rpb24ocGxheWVyLCBwcm9kdWN0aW9uR2Fpbik7CiAgICAgICAgfSBlbHNlIGlmICh1cGdyYWRlQ2xhc3MgPT0gMSkgewogICAgICAgICAgICB1bml0R29vUHJvZHVjdGlvbk11bHRpcGxpZXJbcGxheWVyXVt1bml0SWRdICs9IHVwZ3JhZGVWYWx1ZTsKICAgICAgICAgICAgcHJvZHVjdGlvbkdhaW4gPSB1bml0c093bmVkW3BsYXllcl1bdW5pdElkXSAqIHVwZ3JhZGVWYWx1ZSAqIChzY2hlbWEudW5pdEdvb1Byb2R1Y3Rpb24odW5pdElkKSArIHVuaXRHb29Qcm9kdWN0aW9uSW5jcmVhc2VzW3BsYXllcl1bdW5pdElkXSk7CiAgICAgICAgICAgIGluY3JlYXNlUGxheWVyc0dvb1Byb2R1Y3Rpb24ocGxheWVyLCBwcm9kdWN0aW9uR2Fpbik7CiAgICAgICAgfSBlbHNlIGlmICh1cGdyYWRlQ2xhc3MgPT0gMikgewogICAgICAgICAgICB1bml0QXR0YWNrSW5jcmVhc2VzW3BsYXllcl1bdW5pdElkXSArPSB1cGdyYWRlVmFsdWU7CiAgICAgICAgfSBlbHNlIGlmICh1cGdyYWRlQ2xhc3MgPT0gMykgewogICAgICAgICAgICB1bml0QXR0YWNrTXVsdGlwbGllcltwbGF5ZXJdW3VuaXRJZF0gKz0gdXBncmFkZVZhbHVlOwogICAgICAgIH0gZWxzZSBpZiAodXBncmFkZUNsYXNzID09IDQpIHsKICAgICAgICAgICAgdW5pdERlZmVuc2VJbmNyZWFzZXNbcGxheWVyXVt1bml0SWRdICs9IHVwZ3JhZGVWYWx1ZTsKICAgICAgICB9IGVsc2UgaWYgKHVwZ3JhZGVDbGFzcyA9PSA1KSB7CiAgICAgICAgICAgIHVuaXREZWZlbnNlTXVsdGlwbGllcltwbGF5ZXJdW3VuaXRJZF0gKz0gdXBncmFkZVZhbHVlOwogICAgICAgIH0gZWxzZSBpZiAodXBncmFkZUNsYXNzID09IDYpIHsKICAgICAgICAgICAgdW5pdEdvb1N0ZWFsaW5nSW5jcmVhc2VzW3BsYXllcl1bdW5pdElkXSArPSB1cGdyYWRlVmFsdWU7CiAgICAgICAgfSBlbHNlIGlmICh1cGdyYWRlQ2xhc3MgPT0gNykgewogICAgICAgICAgICB1bml0R29vU3RlYWxpbmdNdWx0aXBsaWVyW3BsYXllcl1bdW5pdElkXSArPSB1cGdyYWRlVmFsdWU7CiAgICAgICAgfSBlbHNlIGlmICh1cGdyYWRlQ2xhc3MgPT0gOCkgewogICAgICAgICAgICB1bml0TWF4Q2FwW3BsYXllcl1bdW5pdElkXSA9IHVwZ3JhZGVWYWx1ZTsgLy8gSG91c2luZyB1cGdyYWRlIChuZXcgY2FwYWNpdHkpCiAgICAgICAgfQogICAgfQogICAgCiAgICBmdW5jdGlvbiByZW1vdmVVbml0TXVsdGlwbGllcnMoYWRkcmVzcyBwbGF5ZXIsIHVpbnQyNTYgdXBncmFkZUNsYXNzLCB1aW50MjU2IHVuaXRJZCwgdWludDI1NiB1cGdyYWRlVmFsdWUpIGludGVybmFsIHsKICAgICAgICB1aW50MjU2IHByb2R1Y3Rpb25Mb3NzOwogICAgICAgIGlmICh1cGdyYWRlQ2xhc3MgPT0gMCkgewogICAgICAgICAgICB1bml0R29vUHJvZHVjdGlvbkluY3JlYXNlc1twbGF5ZXJdW3VuaXRJZF0gLT0gdXBncmFkZVZhbHVlOwogICAgICAgICAgICBwcm9kdWN0aW9uTG9zcyA9IHVuaXRzT3duZWRbcGxheWVyXVt1bml0SWRdICogdXBncmFkZVZhbHVlICogKDEwICsgdW5pdEdvb1Byb2R1Y3Rpb25NdWx0aXBsaWVyW3BsYXllcl1bdW5pdElkXSk7CiAgICAgICAgICAgIHJlZHVjZVBsYXllcnNHb29Qcm9kdWN0aW9uKHBsYXllciwgcHJvZHVjdGlvbkxvc3MpOwogICAgICAgIH0gZWxzZSBpZiAodXBncmFkZUNsYXNzID09IDEpIHsKICAgICAgICAgICAgdW5pdEdvb1Byb2R1Y3Rpb25NdWx0aXBsaWVyW3BsYXllcl1bdW5pdElkXSAtPSB1cGdyYWRlVmFsdWU7CiAgICAgICAgICAgIHByb2R1Y3Rpb25Mb3NzID0gdW5pdHNPd25lZFtwbGF5ZXJdW3VuaXRJZF0gKiB1cGdyYWRlVmFsdWUgKiAoc2NoZW1hLnVuaXRHb29Qcm9kdWN0aW9uKHVuaXRJZCkgKyB1bml0R29vUHJvZHVjdGlvbkluY3JlYXNlc1twbGF5ZXJdW3VuaXRJZF0pOwogICAgICAgICAgICByZWR1Y2VQbGF5ZXJzR29vUHJvZHVjdGlvbihwbGF5ZXIsIHByb2R1Y3Rpb25Mb3NzKTsKICAgICAgICB9IGVsc2UgaWYgKHVwZ3JhZGVDbGFzcyA9PSAyKSB7CiAgICAgICAgICAgIHVuaXRBdHRhY2tJbmNyZWFzZXNbcGxheWVyXVt1bml0SWRdIC09IHVwZ3JhZGVWYWx1ZTsKICAgICAgICB9IGVsc2UgaWYgKHVwZ3JhZGVDbGFzcyA9PSAzKSB7CiAgICAgICAgICAgIHVuaXRBdHRhY2tNdWx0aXBsaWVyW3BsYXllcl1bdW5pdElkXSAtPSB1cGdyYWRlVmFsdWU7CiAgICAgICAgfSBlbHNlIGlmICh1cGdyYWRlQ2xhc3MgPT0gNCkgewogICAgICAgICAgICB1bml0RGVmZW5zZUluY3JlYXNlc1twbGF5ZXJdW3VuaXRJZF0gLT0gdXBncmFkZVZhbHVlOwogICAgICAgIH0gZWxzZSBpZiAodXBncmFkZUNsYXNzID09IDUpIHsKICAgICAgICAgICAgdW5pdERlZmVuc2VNdWx0aXBsaWVyW3BsYXllcl1bdW5pdElkXSAtPSB1cGdyYWRlVmFsdWU7CiAgICAgICAgfSBlbHNlIGlmICh1cGdyYWRlQ2xhc3MgPT0gNikgewogICAgICAgICAgICB1bml0R29vU3RlYWxpbmdJbmNyZWFzZXNbcGxheWVyXVt1bml0SWRdIC09IHVwZ3JhZGVWYWx1ZTsKICAgICAgICB9IGVsc2UgaWYgKHVwZ3JhZGVDbGFzcyA9PSA3KSB7CiAgICAgICAgICAgIHVuaXRHb29TdGVhbGluZ011bHRpcGxpZXJbcGxheWVyXVt1bml0SWRdIC09IHVwZ3JhZGVWYWx1ZTsKICAgICAgICB9CiAgICB9CiAgICAKICAgIGZ1bmN0aW9uIGJ1eVJhcmVJdGVtKHVpbnQyNTYgcmFyZUlkKSBleHRlcm5hbCBwYXlhYmxlIHsKICAgICAgICB1aW50MjU2IHVwZ3JhZGVDbGFzczsKICAgICAgICB1aW50MjU2IHVuaXRJZDsKICAgICAgICB1aW50MjU2IHVwZ3JhZGVWYWx1ZTsKICAgICAgICAodXBncmFkZUNsYXNzLCB1bml0SWQsIHVwZ3JhZGVWYWx1ZSkgPSBzY2hlbWEuZ2V0UmFyZUluZm8ocmFyZUlkKTsKCiAgICAgICAgYWRkcmVzcyBwcmV2aW91c093bmVyID0gcmFyZUl0ZW1Pd25lcltyYXJlSWRdOwogICAgICAgIHJlcXVpcmUocHJldmlvdXNPd25lciAhPSAwKTsKICAgICAgICByZXF1aXJlKHVuaXRJZCA+IDApOwogICAgICAgIAogICAgICAgIC8vIFdlIGhhdmUgdG8gY2xhaW0gYnV5ZXIncyBnb28gYmVmb3JlIHVwZGF0aW5nIHRoZWlyIHByb2R1Y3Rpb24gdmFsdWVzCiAgICAgICAgdXBkYXRlUGxheWVyc0dvbyhtc2cuc2VuZGVyKTsKICAgICAgICB1cGdyYWRlVW5pdE11bHRpcGxpZXJzKG1zZy5zZW5kZXIsIHVwZ3JhZGVDbGFzcywgdW5pdElkLCB1cGdyYWRlVmFsdWUpOwogICAgICAgIAogICAgICAgIC8vIFdlIGhhdmUgdG8gY2xhaW0gc2VsbGVyJ3MgZ29vIGJlZm9yZSByZWR1Y2luZyB0aGVpciBwcm9kdWN0aW9uIHZhbHVlcwogICAgICAgIHVwZGF0ZVBsYXllcnNHb28ocHJldmlvdXNPd25lcik7CiAgICAgICAgcmVtb3ZlVW5pdE11bHRpcGxpZXJzKHByZXZpb3VzT3duZXIsIHVwZ3JhZGVDbGFzcywgdW5pdElkLCB1cGdyYWRlVmFsdWUpOwogICAgICAgIAogICAgICAgIHVpbnQyNTYgZXRoQ29zdCA9IHJhcmVJdGVtUHJpY2VbcmFyZUlkXTsKICAgICAgICByZXF1aXJlKGV0aEJhbGFuY2VbbXNnLnNlbmRlcl0gKyBtc2cudmFsdWUgPj0gZXRoQ29zdCk7CiAgICAgICAgCiAgICAgICAgLy8gU3BsaXRiaWQvT3ZlcmJpZAogICAgICAgIGlmIChldGhDb3N0ID4gbXNnLnZhbHVlKSB7CiAgICAgICAgICAgIC8vIEVhcmxpZXIgcmVxdWlyZSgpIHNhaWQgdGhleSBjYW4gc3RpbGwgYWZmb3JkIGl0IChzbyB1c2UgdGhlaXIgaW5nYW1lIGJhbGFuY2UpCiAgICAgICAgICAgIGV0aEJhbGFuY2VbbXNnLnNlbmRlcl0gLT0gKGV0aENvc3QgLSBtc2cudmFsdWUpOwogICAgICAgIH0gZWxzZSBpZiAobXNnLnZhbHVlID4gZXRoQ29zdCkgewogICAgICAgICAgICAvLyBTdG9yZSBvdmVyYmlkIGluIHRoZWlyIGJhbGFuY2UKICAgICAgICAgICAgZXRoQmFsYW5jZVttc2cuc2VuZGVyXSArPSBtc2cudmFsdWUgLSBldGhDb3N0OwogICAgICAgIH0KICAgICAgICAKICAgICAgICAvLyBEaXN0cmlidXRlIGV0aENvc3QKICAgICAgICB1aW50MjU2IGRldkZ1bmQgPSBldGhDb3N0IC8gNTA7IC8vIDIlIGZlZSBvbiBwdXJjaGFzZXMgKG1hcmtldGluZywgZ2FtZXBsYXkgJiBtYWludGVuYW5jZSkKICAgICAgICB1aW50MjU2IGRpdmlkZW5kcyA9IGV0aENvc3QgLyAyMDsgLy8gNSUgZ29lcyB0byBwb29sICh+OTMlIGdvZXMgdG8gcGxheWVyKQogICAgICAgIHRvdGFsRXRoZXJHb29SZXNlYXJjaFBvb2wgKz0gZGl2aWRlbmRzOwogICAgICAgIGV0aEJhbGFuY2Vbb3duZXJdICs9IGRldkZ1bmQ7CiAgICAgICAgCiAgICAgICAgLy8gVHJhbnNmZXIgLyB1cGRhdGUgcmFyZSBpdGVtCiAgICAgICAgcmFyZUl0ZW1Pd25lcltyYXJlSWRdID0gbXNnLnNlbmRlcjsKICAgICAgICByYXJlSXRlbVByaWNlW3JhcmVJZF0gPSAoZXRoQ29zdCAqIDUpIC8gNDsgLy8gMjUlIHByaWNlIGZsaXAgaW5jcmVhc2UKICAgICAgICBldGhCYWxhbmNlW3ByZXZpb3VzT3duZXJdICs9IGV0aENvc3QgLSAoZGl2aWRlbmRzICsgZGV2RnVuZCk7CiAgICB9CiAgICAKICAgIGZ1bmN0aW9uIHdpdGhkcmF3RXRoZXIodWludDI1NiBhbW91bnQpIGV4dGVybmFsIHsKICAgICAgICByZXF1aXJlKGFtb3VudCA8PSBldGhCYWxhbmNlW21zZy5zZW5kZXJdKTsKICAgICAgICBldGhCYWxhbmNlW21zZy5zZW5kZXJdIC09IGFtb3VudDsKICAgICAgICBtc2cuc2VuZGVyLnRyYW5zZmVyKGFtb3VudCk7CiAgICB9CiAgICAKICAgIGZ1bmN0aW9uIGZ1bmRHb29SZXNlYXJjaCh1aW50MjU2IGFtb3VudCkgZXh0ZXJuYWwgewogICAgICAgIHVwZGF0ZVBsYXllcnNHb29Gcm9tUHVyY2hhc2UobXNnLnNlbmRlciwgYW1vdW50KTsKICAgICAgICBnb29EZXBvc2l0U25hcHNob3RzW21zZy5zZW5kZXJdW3RvdGFsR29vRGVwb3NpdFNuYXBzaG90cy5sZW5ndGggLSAxXSArPSBhbW91bnQ7CiAgICAgICAgdG90YWxHb29EZXBvc2l0U25hcHNob3RzW3RvdGFsR29vRGVwb3NpdFNuYXBzaG90cy5sZW5ndGggLSAxXSArPSBhbW91bnQ7CiAgICB9CiAgICAKICAgIGZ1bmN0aW9uIGNsYWltUmVzZWFyY2hEaXZpZGVuZHMoYWRkcmVzcyByZWZlcmVyLCB1aW50MjU2IHN0YXJ0U25hcHNob3QsIHVpbnQyNTYgZW5kU25hcFNob3QpIGV4dGVybmFsIHsKICAgICAgICByZXF1aXJlKHN0YXJ0U25hcHNob3QgPD0gZW5kU25hcFNob3QpOwogICAgICAgIHJlcXVpcmUoc3RhcnRTbmFwc2hvdCA+PSBsYXN0R29vUmVzZWFyY2hGdW5kQ2xhaW1bbXNnLnNlbmRlcl0pOwogICAgICAgIHJlcXVpcmUoZW5kU25hcFNob3QgPCBhbGxvY2F0ZWRHb29SZXNlYXJjaFNuYXBzaG90cy5sZW5ndGgpOwogICAgICAgIAogICAgICAgIHVpbnQyNTYgcmVzZWFyY2hTaGFyZTsKICAgICAgICB1aW50MjU2IHByZXZpb3VzUHJvZHVjdGlvbiA9IGdvb1Byb2R1Y3Rpb25TbmFwc2hvdHNbbXNnLnNlbmRlcl1bbGFzdEdvb1Jlc2VhcmNoRnVuZENsYWltW21zZy5zZW5kZXJdIC0gMV07IC8vIFVuZGVyZmxvdyB3b24ndCBiZSBhIHByb2JsZW0gYXMgZ29vUHJvZHVjdGlvblNuYXBzaG90c1tdWzB4ZmZmZmZmZmZmZl0gPSAwOwogICAgICAgIGZvciAodWludDI1NiBpID0gc3RhcnRTbmFwc2hvdDsgaSA8PSBlbmRTbmFwU2hvdDsgaSsrKSB7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTbGlnaHRseSBjb21wbGV4IHRoaW5ncyBieSBhY2NvdW50aW5nIGZvciBkYXlzL3NuYXBzaG90cyB3aGVuIHVzZXIgbWFkZSBubyB0eCdzCiAgICAgICAgICAgIHVpbnQyNTYgcHJvZHVjdGlvbkR1cmluZ1NuYXBzaG90ID0gZ29vUHJvZHVjdGlvblNuYXBzaG90c1ttc2cuc2VuZGVyXVtpXTsKICAgICAgICAgICAgYm9vbCBzb2xkQWxsUHJvZHVjdGlvbiA9IGdvb1Byb2R1Y3Rpb25aZXJvZWRTbmFwc2hvdHNbbXNnLnNlbmRlcl1baV07CiAgICAgICAgICAgIGlmIChwcm9kdWN0aW9uRHVyaW5nU25hcHNob3QgPT0gMCAmJiAhc29sZEFsbFByb2R1Y3Rpb24pIHsKICAgICAgICAgICAgICAgIHByb2R1Y3Rpb25EdXJpbmdTbmFwc2hvdCA9IHByZXZpb3VzUHJvZHVjdGlvbjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgcHJldmlvdXNQcm9kdWN0aW9uID0gcHJvZHVjdGlvbkR1cmluZ1NuYXBzaG90OwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICByZXNlYXJjaFNoYXJlICs9IChhbGxvY2F0ZWRHb29SZXNlYXJjaFNuYXBzaG90c1tpXSAqIHByb2R1Y3Rpb25EdXJpbmdTbmFwc2hvdCkgLyB0b3RhbEdvb1Byb2R1Y3Rpb25TbmFwc2hvdHNbaV07CiAgICAgICAgfQogICAgICAgIAogICAgICAgIAogICAgICAgIGlmIChnb29Qcm9kdWN0aW9uU25hcHNob3RzW21zZy5zZW5kZXJdW2VuZFNuYXBTaG90XSA9PSAwICYmICFnb29Qcm9kdWN0aW9uWmVyb2VkU25hcHNob3RzW21zZy5zZW5kZXJdW2VuZFNuYXBTaG90XSAmJiBwcmV2aW91c1Byb2R1Y3Rpb24gPiAwKSB7CiAgICAgICAgICAgIGdvb1Byb2R1Y3Rpb25TbmFwc2hvdHNbbXNnLnNlbmRlcl1bZW5kU25hcFNob3RdID0gcHJldmlvdXNQcm9kdWN0aW9uOyAvLyBDaGVja3BvaW50IGZvciBuZXh0IGNsYWltCiAgICAgICAgfQogICAgICAgIAogICAgICAgIGxhc3RHb29SZXNlYXJjaEZ1bmRDbGFpbVttc2cuc2VuZGVyXSA9IGVuZFNuYXBTaG90ICsgMTsKICAgICAgICAKICAgICAgICB1aW50MjU2IHJlZmVyYWxEaXZzOwogICAgICAgIGlmIChyZWZlcmVyICE9IGFkZHJlc3MoMCkgJiYgcmVmZXJlciAhPSBtc2cuc2VuZGVyKSB7CiAgICAgICAgICAgIHJlZmVyYWxEaXZzID0gcmVzZWFyY2hTaGFyZSAvIDEwMDsgLy8gMSUKICAgICAgICAgICAgZXRoQmFsYW5jZVtyZWZlcmVyXSArPSByZWZlcmFsRGl2czsKICAgICAgICAgICAgZW1pdCBSZWZlcmFsR2FpbihyZWZlcmVyLCBtc2cuc2VuZGVyLCByZWZlcmFsRGl2cyk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGV0aEJhbGFuY2VbbXNnLnNlbmRlcl0gKz0gcmVzZWFyY2hTaGFyZSAtIHJlZmVyYWxEaXZzOwogICAgfQogICAgCiAgICAKICAgIGZ1bmN0aW9uIGNsYWltR29vRGVwb3NpdERpdmlkZW5kcyhhZGRyZXNzIHJlZmVyZXIsIHVpbnQyNTYgc3RhcnRTbmFwc2hvdCwgdWludDI1NiBlbmRTbmFwU2hvdCkgZXh0ZXJuYWwgewogICAgICAgIHJlcXVpcmUoc3RhcnRTbmFwc2hvdCA8PSBlbmRTbmFwU2hvdCk7CiAgICAgICAgcmVxdWlyZShzdGFydFNuYXBzaG90ID49IGxhc3RHb29EZXBvc2l0RnVuZENsYWltW21zZy5zZW5kZXJdKTsKICAgICAgICByZXF1aXJlKGVuZFNuYXBTaG90IDwgYWxsb2NhdGVkR29vRGVwb3NpdFNuYXBzaG90cy5sZW5ndGgpOwogICAgICAgIAogICAgICAgIHVpbnQyNTYgZGVwb3NpdFNoYXJlOwogICAgICAgIGZvciAodWludDI1NiBpID0gc3RhcnRTbmFwc2hvdDsgaSA8PSBlbmRTbmFwU2hvdDsgaSsrKSB7CiAgICAgICAgICAgIGRlcG9zaXRTaGFyZSArPSAoYWxsb2NhdGVkR29vRGVwb3NpdFNuYXBzaG90c1tpXSAqIGdvb0RlcG9zaXRTbmFwc2hvdHNbbXNnLnNlbmRlcl1baV0pIC8gdG90YWxHb29EZXBvc2l0U25hcHNob3RzW2ldOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBsYXN0R29vRGVwb3NpdEZ1bmRDbGFpbVttc2cuc2VuZGVyXSA9IGVuZFNuYXBTaG90ICsgMTsKICAgICAgICAKICAgICAgICB1aW50MjU2IHJlZmVyYWxEaXZzOwogICAgICAgIGlmIChyZWZlcmVyICE9IGFkZHJlc3MoMCkgJiYgcmVmZXJlciAhPSBtc2cuc2VuZGVyKSB7CiAgICAgICAgICAgIHJlZmVyYWxEaXZzID0gZGVwb3NpdFNoYXJlIC8gMTAwOyAvLyAxJQogICAgICAgICAgICBldGhCYWxhbmNlW3JlZmVyZXJdICs9IHJlZmVyYWxEaXZzOwogICAgICAgICAgICBlbWl0IFJlZmVyYWxHYWluKHJlZmVyZXIsIG1zZy5zZW5kZXIsIHJlZmVyYWxEaXZzKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgZXRoQmFsYW5jZVttc2cuc2VuZGVyXSArPSBkZXBvc2l0U2hhcmUgLSByZWZlcmFsRGl2czsKICAgIH0KICAgIAogICAgCiAgICAvLyBBbGxvY2F0ZSBwb3QgIzEgZGl2cyBmb3IgdGhlIGRheSAoMDA6MDAgY3JvbiBqb2IpCiAgICBmdW5jdGlvbiBzbmFwc2hvdERhaWx5R29vUmVzZWFyY2hGdW5kaW5nKCkgZXh0ZXJuYWwgewogICAgICAgIHJlcXVpcmUobXNnLnNlbmRlciA9PSBvd25lcik7CiAgICAgICAgCiAgICAgICAgdWludDI1NiB0b2RheXNHb29SZXNlYXJjaEZ1bmQgPSAodG90YWxFdGhlckdvb1Jlc2VhcmNoUG9vbCAqIHJlc2VhcmNoRGl2UGVyY2VudCkgLyAxMDA7IC8vIDglIG9mIHBvb2wgZGFpbHkKICAgICAgICB0b3RhbEV0aGVyR29vUmVzZWFyY2hQb29sIC09IHRvZGF5c0dvb1Jlc2VhcmNoRnVuZDsKICAgICAgICAKICAgICAgICB0b3RhbEdvb1Byb2R1Y3Rpb25TbmFwc2hvdHMucHVzaCh0b3RhbEdvb1Byb2R1Y3Rpb24pOwogICAgICAgIGFsbG9jYXRlZEdvb1Jlc2VhcmNoU25hcHNob3RzLnB1c2godG9kYXlzR29vUmVzZWFyY2hGdW5kKTsKICAgICAgICBuZXh0U25hcHNob3RUaW1lID0gYmxvY2sudGltZXN0YW1wICsgMjQgaG91cnM7CiAgICB9CiAgICAKICAgIC8vIEFsbG9jYXRlIHBvdCAjMiBkaXZzIGZvciB0aGUgZGF5ICgxMjowMCBjcm9uIGpvYikKICAgIGZ1bmN0aW9uIHNuYXBzaG90RGFpbHlHb29EZXBvc2l0RnVuZGluZygpIGV4dGVybmFsIHsKICAgICAgICByZXF1aXJlKG1zZy5zZW5kZXIgPT0gb3duZXIpOwogICAgICAgIAogICAgICAgIHVpbnQyNTYgdG9kYXlzR29vRGVwb3NpdEZ1bmQgPSAodG90YWxFdGhlckdvb1Jlc2VhcmNoUG9vbCAqIGdvb0RlcG9zaXREaXZQZXJjZW50KSAvIDEwMDsgLy8gMiUgb2YgcG9vbCBkYWlseQogICAgICAgIHRvdGFsRXRoZXJHb29SZXNlYXJjaFBvb2wgLT0gdG9kYXlzR29vRGVwb3NpdEZ1bmQ7CiAgICAgICAgdG90YWxHb29EZXBvc2l0U25hcHNob3RzLnB1c2goMCk7IC8vIFJlc2V0IGZvciB0byBzdG9yZSBuZXh0IGRheSdzIGRlcG9zaXRzCiAgICAgICAgYWxsb2NhdGVkR29vRGVwb3NpdFNuYXBzaG90cy5wdXNoKHRvZGF5c0dvb0RlcG9zaXRGdW5kKTsgLy8gU3RvcmUgdG8gcGF5b3V0IGRpdnMgZm9yIHByZXZpb3VzIGRheSBkZXBvc2l0cwogICAgfQogICAgCiAgICAKICAgIC8vIFJhZmZsZSBmb3IgcmFyZSBpdGVtcwogICAgZnVuY3Rpb24gYnV5SXRlbVJhZmZsZVRpY2tldCh1aW50MjU2IGFtb3VudCkgZXh0ZXJuYWwgewogICAgICAgIHJlcXVpcmUoaXRlbVJhZmZsZUVuZFRpbWUgPj0gYmxvY2sudGltZXN0YW1wKTsKICAgICAgICByZXF1aXJlKGFtb3VudCA+IDApOwogICAgICAgIAogICAgICAgIHVpbnQyNTYgdGlja2V0c0Nvc3QgPSBTYWZlTWF0aC5tdWwoUkFGRkxFX1RJQ0tFVF9CQVNFX0dPT19QUklDRSwgYW1vdW50KTsKICAgICAgICByZXF1aXJlKGJhbGFuY2VPZihtc2cuc2VuZGVyKSA+PSB0aWNrZXRzQ29zdCk7CiAgICAgICAgCiAgICAgICAgLy8gVXBkYXRlIHBsYXllcnMgZ29vCiAgICAgICAgdXBkYXRlUGxheWVyc0dvb0Zyb21QdXJjaGFzZShtc2cuc2VuZGVyLCB0aWNrZXRzQ29zdCk7CiAgICAgICAgCiAgICAgICAgLy8gSGFuZGxlIG5ldyB0aWNrZXRzCiAgICAgICAgVGlja2V0UHVyY2hhc2VzIHN0b3JhZ2UgcHVyY2hhc2VzID0gcmFyZUl0ZW1UaWNrZXRzQm91Z2h0QnlQbGF5ZXJbbXNnLnNlbmRlcl07CiAgICAgICAgCiAgICAgICAgLy8gSWYgd2UgbmVlZCB0byByZXNldCB0aWNrZXRzIGZyb20gYSBwcmV2aW91cyByYWZmbGUKICAgICAgICBpZiAocHVyY2hhc2VzLnJhZmZsZUlkICE9IGl0ZW1SYWZmbGVSYXJlSWQpIHsKICAgICAgICAgICAgcHVyY2hhc2VzLm51bVB1cmNoYXNlcyA9IDA7CiAgICAgICAgICAgIHB1cmNoYXNlcy5yYWZmbGVJZCA9IGl0ZW1SYWZmbGVSYXJlSWQ7CiAgICAgICAgICAgIGl0ZW1SYWZmbGVQbGF5ZXJzW2l0ZW1SYWZmbGVSYXJlSWRdLnB1c2gobXNnLnNlbmRlcik7IC8vIEFkZCB1c2VyIHRvIHJhZmZsZQogICAgICAgIH0KICAgICAgICAKICAgICAgICAvLyBTdG9yZSBuZXcgdGlja2V0IHB1cmNoYXNlCiAgICAgICAgaWYgKHB1cmNoYXNlcy5udW1QdXJjaGFzZXMgPT0gcHVyY2hhc2VzLnRpY2tldHNCb3VnaHQubGVuZ3RoKSB7CiAgICAgICAgICAgIHB1cmNoYXNlcy50aWNrZXRzQm91Z2h0Lmxlbmd0aCArPSAxOwogICAgICAgIH0KICAgICAgICBwdXJjaGFzZXMudGlja2V0c0JvdWdodFtwdXJjaGFzZXMubnVtUHVyY2hhc2VzKytdID0gVGlja2V0UHVyY2hhc2UoaXRlbVJhZmZsZVRpY2tldHNCb3VnaHQsIGl0ZW1SYWZmbGVUaWNrZXRzQm91Z2h0ICsgKGFtb3VudCAtIDEpKTsgLy8gKGVnOiBidXkgMTAsIGdldCBpZCdzIDAtOSkKICAgICAgICAKICAgICAgICAvLyBGaW5hbGx5IHVwZGF0ZSB0aWNrZXQgdG90YWwKICAgICAgICBpdGVtUmFmZmxlVGlja2V0c0JvdWdodCArPSBhbW91bnQ7CiAgICB9CiAgICAKICAgIC8vIFJhZmZsZSBmb3IgcmFyZSB1bml0cwogICAgZnVuY3Rpb24gYnV5VW5pdFJhZmZsZVRpY2tldCh1aW50MjU2IGFtb3VudCkgZXh0ZXJuYWwgewogICAgICAgIHJlcXVpcmUodW5pdFJhZmZsZUVuZFRpbWUgPj0gYmxvY2sudGltZXN0YW1wKTsKICAgICAgICByZXF1aXJlKGFtb3VudCA+IDApOwogICAgICAgIAogICAgICAgIHVpbnQyNTYgdGlja2V0c0Nvc3QgPSBTYWZlTWF0aC5tdWwoUkFGRkxFX1RJQ0tFVF9CQVNFX0dPT19QUklDRSwgYW1vdW50KTsKICAgICAgICByZXF1aXJlKGJhbGFuY2VPZihtc2cuc2VuZGVyKSA+PSB0aWNrZXRzQ29zdCk7CiAgICAgICAgCiAgICAgICAgLy8gVXBkYXRlIHBsYXllcnMgZ29vCiAgICAgICAgdXBkYXRlUGxheWVyc0dvb0Zyb21QdXJjaGFzZShtc2cuc2VuZGVyLCB0aWNrZXRzQ29zdCk7CiAgICAgICAgCiAgICAgICAgLy8gSGFuZGxlIG5ldyB0aWNrZXRzCiAgICAgICAgVGlja2V0UHVyY2hhc2VzIHN0b3JhZ2UgcHVyY2hhc2VzID0gcmFyZVVuaXRUaWNrZXRzQm91Z2h0QnlQbGF5ZXJbbXNnLnNlbmRlcl07CiAgICAgICAgCiAgICAgICAgLy8gSWYgd2UgbmVlZCB0byByZXNldCB0aWNrZXRzIGZyb20gYSBwcmV2aW91cyByYWZmbGUKICAgICAgICBpZiAocHVyY2hhc2VzLnJhZmZsZUlkICE9IHVuaXRSYWZmbGVJZCkgewogICAgICAgICAgICBwdXJjaGFzZXMubnVtUHVyY2hhc2VzID0gMDsKICAgICAgICAgICAgcHVyY2hhc2VzLnJhZmZsZUlkID0gdW5pdFJhZmZsZUlkOwogICAgICAgICAgICB1bml0UmFmZmxlUGxheWVyc1t1bml0UmFmZmxlSWRdLnB1c2gobXNnLnNlbmRlcik7IC8vIEFkZCB1c2VyIHRvIHJhZmZsZQogICAgICAgIH0KICAgICAgICAKICAgICAgICAvLyBTdG9yZSBuZXcgdGlja2V0IHB1cmNoYXNlCiAgICAgICAgaWYgKHB1cmNoYXNlcy5udW1QdXJjaGFzZXMgPT0gcHVyY2hhc2VzLnRpY2tldHNCb3VnaHQubGVuZ3RoKSB7CiAgICAgICAgICAgIHB1cmNoYXNlcy50aWNrZXRzQm91Z2h0Lmxlbmd0aCArPSAxOwogICAgICAgIH0KICAgICAgICBwdXJjaGFzZXMudGlja2V0c0JvdWdodFtwdXJjaGFzZXMubnVtUHVyY2hhc2VzKytdID0gVGlja2V0UHVyY2hhc2UodW5pdFJhZmZsZVRpY2tldHNCb3VnaHQsIHVuaXRSYWZmbGVUaWNrZXRzQm91Z2h0ICsgKGFtb3VudCAtIDEpKTsgLy8gKGVnOiBidXkgMTAsIGdldCBpZCdzIDAtOSkKICAgICAgICAKICAgICAgICAvLyBGaW5hbGx5IHVwZGF0ZSB0aWNrZXQgdG90YWwKICAgICAgICB1bml0UmFmZmxlVGlja2V0c0JvdWdodCArPSBhbW91bnQ7CiAgICB9CiAgICAKICAgIGZ1bmN0aW9uIHN0YXJ0SXRlbVJhZmZsZSh1aW50MjU2IGVuZFRpbWUsIHVpbnQyNTYgcmFyZUlkKSBleHRlcm5hbCB7CiAgICAgICAgcmVxdWlyZShtc2cuc2VuZGVyID09IG93bmVyKTsKICAgICAgICByZXF1aXJlKHNjaGVtYS52YWxpZFJhcmVJZChyYXJlSWQpKTsKICAgICAgICByZXF1aXJlKHJhcmVJdGVtT3duZXJbcmFyZUlkXSA9PSAwKTsKICAgICAgICByZXF1aXJlKGJsb2NrLnRpbWVzdGFtcCA8IGVuZFRpbWUpOwogICAgICAgIAogICAgICAgIGlmIChpdGVtUmFmZmxlUmFyZUlkICE9IDApIHsgLy8gU2FuaXR5IHRvIGFzc3VyZSByYWZmbGUgaGFzIGVuZGVkIGJlZm9yZSBuZXh0IG9uZSBzdGFydHMKICAgICAgICAgICAgcmVxdWlyZShpdGVtUmFmZmxlV2lubmVyICE9IDApOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAvLyBSZXNldCBwcmV2aW91cyByYWZmbGUgaW5mbwogICAgICAgIGl0ZW1SYWZmbGVXaW5uaW5nVGlja2V0U2VsZWN0ZWQgPSBmYWxzZTsKICAgICAgICBpdGVtUmFmZmxlVGlja2V0VGhhdFdvbiA9IDA7CiAgICAgICAgaXRlbVJhZmZsZVdpbm5lciA9IDA7CiAgICAgICAgaXRlbVJhZmZsZVRpY2tldHNCb3VnaHQgPSAwOwogICAgICAgIAogICAgICAgIC8vIFNldCBjdXJyZW50IHJhZmZsZSBpbmZvCiAgICAgICAgaXRlbVJhZmZsZUVuZFRpbWUgPSBlbmRUaW1lOwogICAgICAgIGl0ZW1SYWZmbGVSYXJlSWQgPSByYXJlSWQ7CiAgICB9CiAgICAKICAgIGZ1bmN0aW9uIHN0YXJ0VW5pdFJhZmZsZSh1aW50MjU2IGVuZFRpbWUsIHVpbnQyNTYgdW5pdElkKSBleHRlcm5hbCB7CiAgICAgICAgcmVxdWlyZShtc2cuc2VuZGVyID09IG93bmVyKTsKICAgICAgICByZXF1aXJlKGJsb2NrLnRpbWVzdGFtcCA8IGVuZFRpbWUpOwogICAgICAgIAogICAgICAgIGlmICh1bml0UmFmZmxlUmFyZUlkICE9IDApIHsgLy8gU2FuaXR5IHRvIGFzc3VyZSByYWZmbGUgaGFzIGVuZGVkIGJlZm9yZSBuZXh0IG9uZSBzdGFydHMKICAgICAgICAgICAgcmVxdWlyZSh1bml0UmFmZmxlV2lubmVyICE9IDApOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAvLyBSZXNldCBwcmV2aW91cyByYWZmbGUgaW5mbwogICAgICAgIHVuaXRSYWZmbGVXaW5uaW5nVGlja2V0U2VsZWN0ZWQgPSBmYWxzZTsKICAgICAgICB1bml0UmFmZmxlVGlja2V0VGhhdFdvbiA9IDA7CiAgICAgICAgdW5pdFJhZmZsZVdpbm5lciA9IDA7CiAgICAgICAgdW5pdFJhZmZsZVRpY2tldHNCb3VnaHQgPSAwOwogICAgICAgIAogICAgICAgIC8vIFNldCBjdXJyZW50IHJhZmZsZSBpbmZvCiAgICAgICAgdW5pdFJhZmZsZUVuZFRpbWUgPSBlbmRUaW1lOwogICAgICAgIHVuaXRSYWZmbGVSYXJlSWQgPSB1bml0SWQ7CiAgICAgICAgdW5pdFJhZmZsZUlkKys7IC8vIENhbid0IHVzZSB1bml0UmFmZmxlUmFyZUlkIChhcyByYXJlIHVuaXRzIGFyZSBub3QgdW5pcXVlKQogICAgfQogICAgCiAgICBmdW5jdGlvbiBhd2FyZEl0ZW1SYWZmbGVQcml6ZShhZGRyZXNzIGNoZWNrV2lubmVyLCB1aW50MjU2IGNoZWNrSW5kZXgpIGV4dGVybmFsIHsKICAgICAgICByZXF1aXJlKGl0ZW1SYWZmbGVFbmRUaW1lIDwgYmxvY2sudGltZXN0YW1wKTsKICAgICAgICByZXF1aXJlKGl0ZW1SYWZmbGVXaW5uZXIgPT0gMCk7CiAgICAgICAgcmVxdWlyZShyYXJlSXRlbU93bmVyW2l0ZW1SYWZmbGVSYXJlSWRdID09IDApOwogICAgICAgIAogICAgICAgIGlmICghaXRlbVJhZmZsZVdpbm5pbmdUaWNrZXRTZWxlY3RlZCkgewogICAgICAgICAgICBkcmF3UmFuZG9tSXRlbVdpbm5lcigpOyAvLyBJZGVhbGx5IGRvIGl0IGluIG9uZSBjYWxsIChnYXMgbGltaXQgY2F1dGlvdXMpCiAgICAgICAgfQogICAgICAgIAogICAgICAgIC8vIFJlZHVjZSBnYXMgYnkgKG9wdGlvbmFsbHkpIG9mZmVyaW5nIGFuIGFkZHJlc3MgdG8gX2NoZWNrXyBmb3Igd2lubmVyCiAgICAgICAgaWYgKGNoZWNrV2lubmVyICE9IDApIHsKICAgICAgICAgICAgVGlja2V0UHVyY2hhc2VzIHN0b3JhZ2UgdGlja2V0cyA9IHJhcmVJdGVtVGlja2V0c0JvdWdodEJ5UGxheWVyW2NoZWNrV2lubmVyXTsKICAgICAgICAgICAgaWYgKHRpY2tldHMubnVtUHVyY2hhc2VzID4gMCAmJiBjaGVja0luZGV4IDwgdGlja2V0cy5udW1QdXJjaGFzZXMgJiYgdGlja2V0cy5yYWZmbGVJZCA9PSBpdGVtUmFmZmxlUmFyZUlkKSB7CiAgICAgICAgICAgICAgICBUaWNrZXRQdXJjaGFzZSBzdG9yYWdlIGNoZWNrVGlja2V0ID0gdGlja2V0cy50aWNrZXRzQm91Z2h0W2NoZWNrSW5kZXhdOwogICAgICAgICAgICAgICAgaWYgKGl0ZW1SYWZmbGVUaWNrZXRUaGF0V29uID49IGNoZWNrVGlja2V0LnN0YXJ0SWQgJiYgaXRlbVJhZmZsZVRpY2tldFRoYXRXb24gPD0gY2hlY2tUaWNrZXQuZW5kSWQpIHsKICAgICAgICAgICAgICAgICAgICBhc3NpZ25JdGVtUmFmZmxlUHJpemUoY2hlY2tXaW5uZXIpOyAvLyBXSU5ORVIhCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC8vIE90aGVyd2lzZSBqdXN0IG5haXZlbHkgdHJ5IHRvIGZpbmQgdGhlIHdpbm5lciAod2lsbCB3b3JrIHVudGlsIG1hc3MgYW1vdW50cyBvZiBwbGF5ZXJzKQogICAgICAgIGZvciAodWludDI1NiBpID0gMDsgaSA8IGl0ZW1SYWZmbGVQbGF5ZXJzW2l0ZW1SYWZmbGVSYXJlSWRdLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGFkZHJlc3MgcGxheWVyID0gaXRlbVJhZmZsZVBsYXllcnNbaXRlbVJhZmZsZVJhcmVJZF1baV07CiAgICAgICAgICAgIFRpY2tldFB1cmNoYXNlcyBzdG9yYWdlIHBsYXllcnNUaWNrZXRzID0gcmFyZUl0ZW1UaWNrZXRzQm91Z2h0QnlQbGF5ZXJbcGxheWVyXTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHVpbnQyNTYgZW5kSW5kZXggPSBwbGF5ZXJzVGlja2V0cy5udW1QdXJjaGFzZXMgLSAxOwogICAgICAgICAgICAvLyBNaW5vciBvcHRpbWl6YXRpb24gdG8gYXZvaWQgY2hlY2tpbmcgZXZlcnkgc2luZ2xlIHBsYXllcgogICAgICAgICAgICBpZiAoaXRlbVJhZmZsZVRpY2tldFRoYXRXb24gPj0gcGxheWVyc1RpY2tldHMudGlja2V0c0JvdWdodFswXS5zdGFydElkICYmIGl0ZW1SYWZmbGVUaWNrZXRUaGF0V29uIDw9IHBsYXllcnNUaWNrZXRzLnRpY2tldHNCb3VnaHRbZW5kSW5kZXhdLmVuZElkKSB7CiAgICAgICAgICAgICAgICBmb3IgKHVpbnQyNTYgaiA9IDA7IGogPCBwbGF5ZXJzVGlja2V0cy5udW1QdXJjaGFzZXM7IGorKykgewogICAgICAgICAgICAgICAgICAgIFRpY2tldFB1cmNoYXNlIHN0b3JhZ2UgcGxheWVyVGlja2V0ID0gcGxheWVyc1RpY2tldHMudGlja2V0c0JvdWdodFtqXTsKICAgICAgICAgICAgICAgICAgICBpZiAoaXRlbVJhZmZsZVRpY2tldFRoYXRXb24gPj0gcGxheWVyVGlja2V0LnN0YXJ0SWQgJiYgaXRlbVJhZmZsZVRpY2tldFRoYXRXb24gPD0gcGxheWVyVGlja2V0LmVuZElkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFzc2lnbkl0ZW1SYWZmbGVQcml6ZShwbGF5ZXIpOyAvLyBXSU5ORVIhCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICAKICAgIGZ1bmN0aW9uIGF3YXJkVW5pdFJhZmZsZVByaXplKGFkZHJlc3MgY2hlY2tXaW5uZXIsIHVpbnQyNTYgY2hlY2tJbmRleCkgZXh0ZXJuYWwgewogICAgICAgIHJlcXVpcmUodW5pdFJhZmZsZUVuZFRpbWUgPCBibG9jay50aW1lc3RhbXApOwogICAgICAgIHJlcXVpcmUodW5pdFJhZmZsZVdpbm5lciA9PSAwKTsKICAgICAgICAKICAgICAgICBpZiAoIXVuaXRSYWZmbGVXaW5uaW5nVGlja2V0U2VsZWN0ZWQpIHsKICAgICAgICAgICAgZHJhd1JhbmRvbVVuaXRXaW5uZXIoKTsgLy8gSWRlYWxseSBkbyBpdCBpbiBvbmUgY2FsbCAoZ2FzIGxpbWl0IGNhdXRpb3VzKQogICAgICAgIH0KICAgICAgICAKICAgICAgICAvLyBSZWR1Y2UgZ2FzIGJ5IChvcHRpb25hbGx5KSBvZmZlcmluZyBhbiBhZGRyZXNzIHRvIF9jaGVja18gZm9yIHdpbm5lcgogICAgICAgIGlmIChjaGVja1dpbm5lciAhPSAwKSB7CiAgICAgICAgICAgIFRpY2tldFB1cmNoYXNlcyBzdG9yYWdlIHRpY2tldHMgPSByYXJlVW5pdFRpY2tldHNCb3VnaHRCeVBsYXllcltjaGVja1dpbm5lcl07CiAgICAgICAgICAgIGlmICh0aWNrZXRzLm51bVB1cmNoYXNlcyA+IDAgJiYgY2hlY2tJbmRleCA8IHRpY2tldHMubnVtUHVyY2hhc2VzICYmIHRpY2tldHMucmFmZmxlSWQgPT0gdW5pdFJhZmZsZUlkKSB7CiAgICAgICAgICAgICAgICBUaWNrZXRQdXJjaGFzZSBzdG9yYWdlIGNoZWNrVGlja2V0ID0gdGlja2V0cy50aWNrZXRzQm91Z2h0W2NoZWNrSW5kZXhdOwogICAgICAgICAgICAgICAgaWYgKHVuaXRSYWZmbGVUaWNrZXRUaGF0V29uID49IGNoZWNrVGlja2V0LnN0YXJ0SWQgJiYgdW5pdFJhZmZsZVRpY2tldFRoYXRXb24gPD0gY2hlY2tUaWNrZXQuZW5kSWQpIHsKICAgICAgICAgICAgICAgICAgICBhc3NpZ25Vbml0UmFmZmxlUHJpemUoY2hlY2tXaW5uZXIpOyAvLyBXSU5ORVIhCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC8vIE90aGVyd2lzZSBqdXN0IG5haXZlbHkgdHJ5IHRvIGZpbmQgdGhlIHdpbm5lciAod2lsbCB3b3JrIHVudGlsIG1hc3MgYW1vdW50cyBvZiBwbGF5ZXJzKQogICAgICAgIGZvciAodWludDI1NiBpID0gMDsgaSA8IHVuaXRSYWZmbGVQbGF5ZXJzW3VuaXRSYWZmbGVJZF0ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgYWRkcmVzcyBwbGF5ZXIgPSB1bml0UmFmZmxlUGxheWVyc1t1bml0UmFmZmxlSWRdW2ldOwogICAgICAgICAgICBUaWNrZXRQdXJjaGFzZXMgc3RvcmFnZSBwbGF5ZXJzVGlja2V0cyA9IHJhcmVVbml0VGlja2V0c0JvdWdodEJ5UGxheWVyW3BsYXllcl07CiAgICAgICAgICAgIAogICAgICAgICAgICB1aW50MjU2IGVuZEluZGV4ID0gcGxheWVyc1RpY2tldHMubnVtUHVyY2hhc2VzIC0gMTsKICAgICAgICAgICAgLy8gTWlub3Igb3B0aW1pemF0aW9uIHRvIGF2b2lkIGNoZWNraW5nIGV2ZXJ5IHNpbmdsZSBwbGF5ZXIKICAgICAgICAgICAgaWYgKHVuaXRSYWZmbGVUaWNrZXRUaGF0V29uID49IHBsYXllcnNUaWNrZXRzLnRpY2tldHNCb3VnaHRbMF0uc3RhcnRJZCAmJiB1bml0UmFmZmxlVGlja2V0VGhhdFdvbiA8PSBwbGF5ZXJzVGlja2V0cy50aWNrZXRzQm91Z2h0W2VuZEluZGV4XS5lbmRJZCkgewogICAgICAgICAgICAgICAgZm9yICh1aW50MjU2IGogPSAwOyBqIDwgcGxheWVyc1RpY2tldHMubnVtUHVyY2hhc2VzOyBqKyspIHsKICAgICAgICAgICAgICAgICAgICBUaWNrZXRQdXJjaGFzZSBzdG9yYWdlIHBsYXllclRpY2tldCA9IHBsYXllcnNUaWNrZXRzLnRpY2tldHNCb3VnaHRbal07CiAgICAgICAgICAgICAgICAgICAgaWYgKHVuaXRSYWZmbGVUaWNrZXRUaGF0V29uID49IHBsYXllclRpY2tldC5zdGFydElkICYmIHVuaXRSYWZmbGVUaWNrZXRUaGF0V29uIDw9IHBsYXllclRpY2tldC5lbmRJZCkgewogICAgICAgICAgICAgICAgICAgICAgICBhc3NpZ25Vbml0UmFmZmxlUHJpemUocGxheWVyKTsgLy8gV0lOTkVSIQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgCiAgICBmdW5jdGlvbiBhc3NpZ25JdGVtUmFmZmxlUHJpemUoYWRkcmVzcyB3aW5uZXIpIGludGVybmFsIHsKICAgICAgICBpdGVtUmFmZmxlV2lubmVyID0gd2lubmVyOwogICAgICAgIHJhcmVJdGVtT3duZXJbaXRlbVJhZmZsZVJhcmVJZF0gPSB3aW5uZXI7CiAgICAgICAgcmFyZUl0ZW1QcmljZVtpdGVtUmFmZmxlUmFyZUlkXSA9IChzY2hlbWEucmFyZVN0YXJ0UHJpY2UoaXRlbVJhZmZsZVJhcmVJZCkgKiAyMSkgLyAyMDsgLy8gQnV5IHByaWNlIHNsaWdodGx5IGhpZ2hlciAoRGl2IHBvb2wgY3V0KQogICAgICAgIAogICAgICAgIHVwZGF0ZVBsYXllcnNHb28od2lubmVyKTsKICAgICAgICB1aW50MjU2IHVwZ3JhZGVDbGFzczsKICAgICAgICB1aW50MjU2IHVuaXRJZDsKICAgICAgICB1aW50MjU2IHVwZ3JhZGVWYWx1ZTsKICAgICAgICAodXBncmFkZUNsYXNzLCB1bml0SWQsIHVwZ3JhZGVWYWx1ZSkgPSBzY2hlbWEuZ2V0UmFyZUluZm8oaXRlbVJhZmZsZVJhcmVJZCk7CiAgICAgICAgdXBncmFkZVVuaXRNdWx0aXBsaWVycyh3aW5uZXIsIHVwZ3JhZGVDbGFzcywgdW5pdElkLCB1cGdyYWRlVmFsdWUpOwogICAgfQogICAgCiAgICBmdW5jdGlvbiBhc3NpZ25Vbml0UmFmZmxlUHJpemUoYWRkcmVzcyB3aW5uZXIpIGludGVybmFsIHsKICAgICAgICB1bml0UmFmZmxlV2lubmVyID0gd2lubmVyOwogICAgICAgIHVwZGF0ZVBsYXllcnNHb28od2lubmVyKTsKICAgICAgICBpbmNyZWFzZVBsYXllcnNHb29Qcm9kdWN0aW9uKHdpbm5lciwgZ2V0VW5pdHNQcm9kdWN0aW9uKHdpbm5lciwgdW5pdFJhZmZsZVJhcmVJZCwgMSkpOwogICAgICAgIHVuaXRzT3duZWRbd2lubmVyXVt1bml0UmFmZmxlUmFyZUlkXSArPSAxOwogICAgfQogICAgCiAgICAvLyBSYW5kb20gZW5vdWdoIGZvciBzbWFsbCBjb250ZXN0cyAoT3duZXIgb25seSB0byBwcmV2ZW50IHRyaWFsICYgZXJyb3IgZXhlY3V0aW9uKQogICAgZnVuY3Rpb24gZHJhd1JhbmRvbUl0ZW1XaW5uZXIoKSBwdWJsaWMgewogICAgICAgIHJlcXVpcmUobXNnLnNlbmRlciA9PSBvd25lcik7CiAgICAgICAgcmVxdWlyZShpdGVtUmFmZmxlRW5kVGltZSA8IGJsb2NrLnRpbWVzdGFtcCk7CiAgICAgICAgcmVxdWlyZSghaXRlbVJhZmZsZVdpbm5pbmdUaWNrZXRTZWxlY3RlZCk7CiAgICAgICAgCiAgICAgICAgdWludDI1NiBzZWVkID0gaXRlbVJhZmZsZVRpY2tldHNCb3VnaHQgKyBibG9jay50aW1lc3RhbXA7CiAgICAgICAgaXRlbVJhZmZsZVRpY2tldFRoYXRXb24gPSBhZGRtb2QodWludDI1NihibG9jay5ibG9ja2hhc2goYmxvY2subnVtYmVyLTEpKSwgc2VlZCwgaXRlbVJhZmZsZVRpY2tldHNCb3VnaHQpOwogICAgICAgIGl0ZW1SYWZmbGVXaW5uaW5nVGlja2V0U2VsZWN0ZWQgPSB0cnVlOwogICAgfQogICAgCiAgICBmdW5jdGlvbiBkcmF3UmFuZG9tVW5pdFdpbm5lcigpIHB1YmxpYyB7CiAgICAgICAgcmVxdWlyZShtc2cuc2VuZGVyID09IG93bmVyKTsKICAgICAgICByZXF1aXJlKHVuaXRSYWZmbGVFbmRUaW1lIDwgYmxvY2sudGltZXN0YW1wKTsKICAgICAgICByZXF1aXJlKCF1bml0UmFmZmxlV2lubmluZ1RpY2tldFNlbGVjdGVkKTsKICAgICAgICAKICAgICAgICB1aW50MjU2IHNlZWQgPSB1bml0UmFmZmxlVGlja2V0c0JvdWdodCArIGJsb2NrLnRpbWVzdGFtcDsKICAgICAgICB1bml0UmFmZmxlVGlja2V0VGhhdFdvbiA9IGFkZG1vZCh1aW50MjU2KGJsb2NrLmJsb2NraGFzaChibG9jay5udW1iZXItMSkpLCBzZWVkLCB1bml0UmFmZmxlVGlja2V0c0JvdWdodCk7CiAgICAgICAgdW5pdFJhZmZsZVdpbm5pbmdUaWNrZXRTZWxlY3RlZCA9IHRydWU7CiAgICB9CiAgICAKICAgIC8vIEdpdmVzIHBsYXllcnMgdGhlIHVwZ3JhZGVzIHRoZXkgJ3ByZXZpb3VzbHkgcGFpZCBmb3InIChpLmUuIHdpbGwgYmUgb25lIG9mIHNhbWUgdW5pdC90eXBlL3ZhbHVlIG9mIHRoZWlyIHYxIHB1cmNoYXNlKQogICAgLy8gVHggb2YgdGhlaXIgKHByaW9yKSBwdXJjaGFzZSBpcyBwcm92aWRlZCBzbyBjYW4gYmUgdmFsaWRhdGVkIGJ5IGFueW9uZSBmb3IgMCBhYnVzZQogICAgZnVuY3Rpb24gbWlncmF0ZVYxVXBncmFkZXMoYWRkcmVzc1tdIHBsYXllclRvQ3JlZGl0LCB1aW50MjU2W10gdXBncmFkZUlkcywgdWludDI1NltdIHR4UHJvb2YpIGV4dGVybmFsIHsKICAgICAgICByZXF1aXJlKG1zZy5zZW5kZXIgPT0gb3duZXIpOwogICAgICAgIHJlcXVpcmUoIWdhbWVTdGFydGVkKTsgLy8gUHJlLWdhbWUgbWlncmF0aW9uCiAgICAgICAgCiAgICAgICAgZm9yICh1aW50MjU2IGkgPSAwOyBpIDwgdHhQcm9vZi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBhZGRyZXNzIHBsYXllciA9IHBsYXllclRvQ3JlZGl0W2ldOwogICAgICAgICAgICB1aW50MjU2IHVwZ3JhZGVJZCA9IHVwZ3JhZGVJZHNbaV07CiAgICAgICAgICAgIAogICAgICAgICAgICB1aW50MjU2IHVuaXRJZCA9IHNjaGVtYS51cGdyYWRlVW5pdElkKHVwZ3JhZGVJZCk7CiAgICAgICAgICAgIGlmICh1bml0SWQgPiAwICYmICF1cGdyYWRlc093bmVkW3BsYXllcl1bdXBncmFkZUlkXSkgeyAvLyBVcGdyYWRlIHZhbGlkIChhbmQgaGF2ZW4ndCBhbHJlYWR5IG1pZ3JhdGVkKQogICAgICAgICAgICAgICAgdWludDI1NiB1cGdyYWRlQ2xhc3MgPSBzY2hlbWEudXBncmFkZUNsYXNzKHVwZ3JhZGVJZCk7CiAgICAgICAgICAgICAgICB1aW50MjU2IHVwZ3JhZGVWYWx1ZSA9IHNjaGVtYS51cGdyYWRlVmFsdWUodXBncmFkZUlkKTsKICAgICAgICAKICAgICAgICAgICAgICAgIHVwZ3JhZGVVbml0TXVsdGlwbGllcnMocGxheWVyLCB1cGdyYWRlQ2xhc3MsIHVuaXRJZCwgdXBncmFkZVZhbHVlKTsKICAgICAgICAgICAgICAgIHVwZ3JhZGVzT3duZWRbcGxheWVyXVt1cGdyYWRlSWRdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGVtaXQgVXBncmFkZU1pZ3JhdGlvbihwbGF5ZXIsIHVwZ3JhZGVJZCwgdHhQcm9vZltpXSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICAKICAgIGZ1bmN0aW9uIHByb3RlY3RBZGRyZXNzKGFkZHJlc3MgZXhjaGFuZ2UsIGJvb2wgc2hvdWxkUHJvdGVjdCkgZXh0ZXJuYWwgewogICAgICAgIHJlcXVpcmUobXNnLnNlbmRlciA9PSBvd25lcik7CiAgICAgICAgaWYgKHNob3VsZFByb3RlY3QpIHsKICAgICAgICAgICAgcmVxdWlyZShnZXRHb29Qcm9kdWN0aW9uKGV4Y2hhbmdlKSA9PSAwKTsgLy8gQ2FuJ3QgcHJvdGVjdCBhY3R1YWwgcGxheWVycwogICAgICAgIH0KICAgICAgICBwcm90ZWN0ZWRBZGRyZXNzZXNbZXhjaGFuZ2VdID0gc2hvdWxkUHJvdGVjdDsKICAgIH0KICAgIAogICAgZnVuY3Rpb24gYXR0YWNrUGxheWVyKGFkZHJlc3MgdGFyZ2V0KSBleHRlcm5hbCB7CiAgICAgICAgcmVxdWlyZShiYXR0bGVDb29sZG93blttc2cuc2VuZGVyXSA8IGJsb2NrLnRpbWVzdGFtcCk7CiAgICAgICAgcmVxdWlyZSh0YXJnZXQgIT0gbXNnLnNlbmRlcik7CiAgICAgICAgcmVxdWlyZSghcHJvdGVjdGVkQWRkcmVzc2VzW3RhcmdldF0pOyAvLyBUYXJnZXQgbm90IHdoaXRlbGlzdGVkIChpLmUuIGV4Y2hhbmdlIHdhbGxldHMpCiAgICAgICAgCiAgICAgICAgdWludDI1NiBhdHRhY2tpbmdQb3dlcjsKICAgICAgICB1aW50MjU2IGRlZmVuZGluZ1Bvd2VyOwogICAgICAgIHVpbnQyNTYgc3RlYWxpbmdQb3dlcjsKICAgICAgICAoYXR0YWNraW5nUG93ZXIsIGRlZmVuZGluZ1Bvd2VyLCBzdGVhbGluZ1Bvd2VyKSA9IGdldFBsYXllcnNCYXR0bGVQb3dlcihtc2cuc2VuZGVyLCB0YXJnZXQpOwogICAgICAgIAogICAgICAgIGlmIChiYXR0bGVDb29sZG93blt0YXJnZXRdID4gYmxvY2sudGltZXN0YW1wKSB7IC8vIFdoZW4gb24gYmF0dGxlIGNvb2xkb3duIHlvdSdyZSB2dWxuZXJhYmxlIChzdGFydGluZyB2YWx1ZSBpcyA1MCUgbm9ybWFsIHBvd2VyKQogICAgICAgICAgICBkZWZlbmRpbmdQb3dlciA9IHNjaGVtYS5nZXRXZWFrZW5lZERlZmVuc2VQb3dlcihkZWZlbmRpbmdQb3dlcik7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGlmIChhdHRhY2tpbmdQb3dlciA+IGRlZmVuZGluZ1Bvd2VyKSB7CiAgICAgICAgICAgIGJhdHRsZUNvb2xkb3duW21zZy5zZW5kZXJdID0gYmxvY2sudGltZXN0YW1wICsgMzAgbWludXRlczsKICAgICAgICAgICAgaWYgKGJhbGFuY2VPZih0YXJnZXQpID4gc3RlYWxpbmdQb3dlcikgewogICAgICAgICAgICAgICAgLy8gU2F2ZSBhbGwgdGhlaXIgdW5jbGFpbWVkIGdvbywgdGhlbiBzdGVhbCBhdHRhY2tlcidzIG1heCBjYXBhY2l0eSAoYXQgc2FtZSB0aW1lKQogICAgICAgICAgICAgICAgdWludDI1NiB1bmNsYWltZWRHb28gPSBiYWxhbmNlT2ZVbmNsYWltZWRHb28odGFyZ2V0KTsKICAgICAgICAgICAgICAgIGlmIChzdGVhbGluZ1Bvd2VyID4gdW5jbGFpbWVkR29vKSB7CiAgICAgICAgICAgICAgICAgICAgdWludDI1NiBnb29EZWNyZWFzZSA9IHN0ZWFsaW5nUG93ZXIgLSB1bmNsYWltZWRHb287CiAgICAgICAgICAgICAgICAgICAgZ29vQmFsYW5jZVt0YXJnZXRdIC09IGdvb0RlY3JlYXNlOwogICAgICAgICAgICAgICAgICAgIHJvdWdoU3VwcGx5IC09IGdvb0RlY3JlYXNlOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB1aW50MjU2IGdvb0dhaW4gPSB1bmNsYWltZWRHb28gLSBzdGVhbGluZ1Bvd2VyOwogICAgICAgICAgICAgICAgICAgIGdvb0JhbGFuY2VbdGFyZ2V0XSArPSBnb29HYWluOwogICAgICAgICAgICAgICAgICAgIHJvdWdoU3VwcGx5ICs9IGdvb0dhaW47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBnb29CYWxhbmNlW21zZy5zZW5kZXJdICs9IHN0ZWFsaW5nUG93ZXI7CiAgICAgICAgICAgICAgICBlbWl0IFBsYXllckF0dGFja2VkKG1zZy5zZW5kZXIsIHRhcmdldCwgdHJ1ZSwgc3RlYWxpbmdQb3dlcik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBlbWl0IFBsYXllckF0dGFja2VkKG1zZy5zZW5kZXIsIHRhcmdldCwgdHJ1ZSwgYmFsYW5jZU9mKHRhcmdldCkpOwogICAgICAgICAgICAgICAgZ29vQmFsYW5jZVttc2cuc2VuZGVyXSArPSBiYWxhbmNlT2YodGFyZ2V0KTsKICAgICAgICAgICAgICAgIGdvb0JhbGFuY2VbdGFyZ2V0XSA9IDA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGxhc3RHb29TYXZlVGltZVt0YXJnZXRdID0gYmxvY2sudGltZXN0YW1wOwogICAgICAgICAgICAvLyBXZSBkb24ndCBuZWVkIHRvIGNsYWltL3NhdmUgbXNnLnNlbmRlcidzIGdvbyAoYXMgcHJvZHVjdGlvbiBkZWx0YSBpcyB1bmNoYW5nZWQpCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgYmF0dGxlQ29vbGRvd25bbXNnLnNlbmRlcl0gPSBibG9jay50aW1lc3RhbXAgKyAxMCBtaW51dGVzOwogICAgICAgICAgICBlbWl0IFBsYXllckF0dGFja2VkKG1zZy5zZW5kZXIsIHRhcmdldCwgZmFsc2UsIDApOwogICAgICAgIH0KICAgIH0KICAgIAogICAgZnVuY3Rpb24gZ2V0UGxheWVyc0JhdHRsZVBvd2VyKGFkZHJlc3MgYXR0YWNrZXIsIGFkZHJlc3MgZGVmZW5kZXIpIGludGVybmFsIGNvbnN0YW50IHJldHVybnMgKHVpbnQyNTYsIHVpbnQyNTYsIHVpbnQyNTYpIHsKICAgICAgICB1aW50MjU2IHN0YXJ0SWQ7CiAgICAgICAgdWludDI1NiBlbmRJZDsKICAgICAgICAoc3RhcnRJZCwgZW5kSWQpID0gc2NoZW1hLmJhdHRsZVVuaXRJZFJhbmdlKCk7CiAgICAgICAgCiAgICAgICAgdWludDI1NiBhdHRhY2tpbmdQb3dlcjsKICAgICAgICB1aW50MjU2IGRlZmVuZGluZ1Bvd2VyOwogICAgICAgIHVpbnQyNTYgc3RlYWxpbmdQb3dlcjsKCiAgICAgICAgLy8gTm90IGlkZWFsIGJ1dCB3aWxsIG9ubHkgYmUgYSBzbWFsbCBudW1iZXIgb2YgdW5pdHMgKGFuZCBzYXZlcyBnYXMgd2hlbiBidXlpbmcgdW5pdHMpCiAgICAgICAgd2hpbGUgKHN0YXJ0SWQgPD0gZW5kSWQpIHsKICAgICAgICAgICAgYXR0YWNraW5nUG93ZXIgKz0gZ2V0VW5pdHNBdHRhY2soYXR0YWNrZXIsIHN0YXJ0SWQsIHVuaXRzT3duZWRbYXR0YWNrZXJdW3N0YXJ0SWRdKTsKICAgICAgICAgICAgc3RlYWxpbmdQb3dlciArPSBnZXRVbml0c1N0ZWFsaW5nQ2FwYWNpdHkoYXR0YWNrZXIsIHN0YXJ0SWQsIHVuaXRzT3duZWRbYXR0YWNrZXJdW3N0YXJ0SWRdKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGRlZmVuZGluZ1Bvd2VyICs9IGdldFVuaXRzRGVmZW5zZShkZWZlbmRlciwgc3RhcnRJZCwgdW5pdHNPd25lZFtkZWZlbmRlcl1bc3RhcnRJZF0pOwogICAgICAgICAgICBzdGFydElkKys7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHJldHVybiAoYXR0YWNraW5nUG93ZXIsIGRlZmVuZGluZ1Bvd2VyLCBzdGVhbGluZ1Bvd2VyKTsKICAgIH0KICAgIAogICAgZnVuY3Rpb24gZ2V0UGxheWVyc0JhdHRsZVN0YXRzKGFkZHJlc3MgcGxheWVyKSBleHRlcm5hbCBjb25zdGFudCByZXR1cm5zICh1aW50MjU2LCB1aW50MjU2LCB1aW50MjU2LCB1aW50MjU2KSB7CiAgICAgICAgdWludDI1NiBzdGFydElkOwogICAgICAgIHVpbnQyNTYgZW5kSWQ7CiAgICAgICAgKHN0YXJ0SWQsIGVuZElkKSA9IHNjaGVtYS5iYXR0bGVVbml0SWRSYW5nZSgpOwogICAgICAgIAogICAgICAgIHVpbnQyNTYgYXR0YWNraW5nUG93ZXI7CiAgICAgICAgdWludDI1NiBkZWZlbmRpbmdQb3dlcjsKICAgICAgICB1aW50MjU2IHN0ZWFsaW5nUG93ZXI7CgogICAgICAgIC8vIE5vdCBpZGVhbCBidXQgd2lsbCBvbmx5IGJlIGEgc21hbGwgbnVtYmVyIG9mIHVuaXRzIChhbmQgc2F2ZXMgZ2FzIHdoZW4gYnV5aW5nIHVuaXRzKQogICAgICAgIHdoaWxlIChzdGFydElkIDw9IGVuZElkKSB7CiAgICAgICAgICAgIGF0dGFja2luZ1Bvd2VyICs9IGdldFVuaXRzQXR0YWNrKHBsYXllciwgc3RhcnRJZCwgdW5pdHNPd25lZFtwbGF5ZXJdW3N0YXJ0SWRdKTsKICAgICAgICAgICAgc3RlYWxpbmdQb3dlciArPSBnZXRVbml0c1N0ZWFsaW5nQ2FwYWNpdHkocGxheWVyLCBzdGFydElkLCB1bml0c093bmVkW3BsYXllcl1bc3RhcnRJZF0pOwogICAgICAgICAgICBkZWZlbmRpbmdQb3dlciArPSBnZXRVbml0c0RlZmVuc2UocGxheWVyLCBzdGFydElkLCB1bml0c093bmVkW3BsYXllcl1bc3RhcnRJZF0pOwogICAgICAgICAgICBzdGFydElkKys7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGlmIChiYXR0bGVDb29sZG93bltwbGF5ZXJdID4gYmxvY2sudGltZXN0YW1wKSB7IC8vIFdoZW4gb24gYmF0dGxlIGNvb2xkb3duIHlvdSdyZSB2dWxuZXJhYmxlIChzdGFydGluZyB2YWx1ZSBpcyA1MCUgbm9ybWFsIHBvd2VyKQogICAgICAgICAgICBkZWZlbmRpbmdQb3dlciA9IHNjaGVtYS5nZXRXZWFrZW5lZERlZmVuc2VQb3dlcihkZWZlbmRpbmdQb3dlcik7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHJldHVybiAoYXR0YWNraW5nUG93ZXIsIGRlZmVuZGluZ1Bvd2VyLCBzdGVhbGluZ1Bvd2VyLCBiYXR0bGVDb29sZG93bltwbGF5ZXJdKTsKICAgIH0KICAgIAogICAgZnVuY3Rpb24gZ2V0VW5pdHNQcm9kdWN0aW9uKGFkZHJlc3MgcGxheWVyLCB1aW50MjU2IHVuaXRJZCwgdWludDI1NiBhbW91bnQpIGludGVybmFsIGNvbnN0YW50IHJldHVybnMgKHVpbnQyNTYpIHsKICAgICAgICByZXR1cm4gKGFtb3VudCAqIChzY2hlbWEudW5pdEdvb1Byb2R1Y3Rpb24odW5pdElkKSArIHVuaXRHb29Qcm9kdWN0aW9uSW5jcmVhc2VzW3BsYXllcl1bdW5pdElkXSkgKiAoMTAgKyB1bml0R29vUHJvZHVjdGlvbk11bHRpcGxpZXJbcGxheWVyXVt1bml0SWRdKSk7CiAgICB9CiAgICAKICAgIGZ1bmN0aW9uIGdldFVuaXRzQXR0YWNrKGFkZHJlc3MgcGxheWVyLCB1aW50MjU2IHVuaXRJZCwgdWludDI1NiBhbW91bnQpIGludGVybmFsIGNvbnN0YW50IHJldHVybnMgKHVpbnQyNTYpIHsKICAgICAgICByZXR1cm4gKGFtb3VudCAqIChzY2hlbWEudW5pdEF0dGFjayh1bml0SWQpICsgdW5pdEF0dGFja0luY3JlYXNlc1twbGF5ZXJdW3VuaXRJZF0pICogKDEwICsgdW5pdEF0dGFja011bHRpcGxpZXJbcGxheWVyXVt1bml0SWRdKSkgLyAxMDsKICAgIH0KICAgIAogICAgZnVuY3Rpb24gZ2V0VW5pdHNEZWZlbnNlKGFkZHJlc3MgcGxheWVyLCB1aW50MjU2IHVuaXRJZCwgdWludDI1NiBhbW91bnQpIGludGVybmFsIGNvbnN0YW50IHJldHVybnMgKHVpbnQyNTYpIHsKICAgICAgICByZXR1cm4gKGFtb3VudCAqIChzY2hlbWEudW5pdERlZmVuc2UodW5pdElkKSArIHVuaXREZWZlbnNlSW5jcmVhc2VzW3BsYXllcl1bdW5pdElkXSkgKiAoMTAgKyB1bml0RGVmZW5zZU11bHRpcGxpZXJbcGxheWVyXVt1bml0SWRdKSkgLyAxMDsKICAgIH0KICAgIAogICAgZnVuY3Rpb24gZ2V0VW5pdHNTdGVhbGluZ0NhcGFjaXR5KGFkZHJlc3MgcGxheWVyLCB1aW50MjU2IHVuaXRJZCwgdWludDI1NiBhbW91bnQpIGludGVybmFsIGNvbnN0YW50IHJldHVybnMgKHVpbnQyNTYpIHsKICAgICAgICByZXR1cm4gKGFtb3VudCAqIChzY2hlbWEudW5pdFN0ZWFsaW5nQ2FwYWNpdHkodW5pdElkKSArIHVuaXRHb29TdGVhbGluZ0luY3JlYXNlc1twbGF5ZXJdW3VuaXRJZF0pICogKDEwICsgdW5pdEdvb1N0ZWFsaW5nTXVsdGlwbGllcltwbGF5ZXJdW3VuaXRJZF0pKSAvIDEwOwogICAgfQogICAgCiAgICAKICAgIC8vIFRvIGRpc3BsYXkgb24gd2Vic2l0ZQogICAgZnVuY3Rpb24gZ2V0R2FtZUluZm8oKSBleHRlcm5hbCBjb25zdGFudCByZXR1cm5zICh1aW50MjU2LCB1aW50MjU2LCB1aW50MjU2LCB1aW50MjU2LCB1aW50MjU2LCB1aW50MjU2LCB1aW50MjU2LCB1aW50MjU2LCB1aW50MjU2LCB1aW50MjU2W10sIGJvb2xbXSl7CiAgICAgICAgdWludDI1NltdIG1lbW9yeSB1bml0cyA9IG5ldyB1aW50MjU2W10oc2NoZW1hLmN1cnJlbnROdW1iZXJPZlVuaXRzKCkpOwogICAgICAgIGJvb2xbXSBtZW1vcnkgdXBncmFkZXMgPSBuZXcgYm9vbFtdKHNjaGVtYS5jdXJyZW50TnVtYmVyT2ZVcGdyYWRlcygpKTsKICAgICAgICAKICAgICAgICB1aW50MjU2IHN0YXJ0SWQ7CiAgICAgICAgdWludDI1NiBlbmRJZDsKICAgICAgICAoc3RhcnRJZCwgZW5kSWQpID0gc2NoZW1hLnByb2R1Y3Rpb25Vbml0SWRSYW5nZSgpOwogICAgICAgIAogICAgICAgIHVpbnQyNTYgaTsKICAgICAgICB3aGlsZSAoc3RhcnRJZCA8PSBlbmRJZCkgewogICAgICAgICAgICB1bml0c1tpXSA9IHVuaXRzT3duZWRbbXNnLnNlbmRlcl1bc3RhcnRJZF07CiAgICAgICAgICAgIGkrKzsKICAgICAgICAgICAgc3RhcnRJZCsrOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAoc3RhcnRJZCwgZW5kSWQpID0gc2NoZW1hLmJhdHRsZVVuaXRJZFJhbmdlKCk7CiAgICAgICAgd2hpbGUgKHN0YXJ0SWQgPD0gZW5kSWQpIHsKICAgICAgICAgICAgdW5pdHNbaV0gPSB1bml0c093bmVkW21zZy5zZW5kZXJdW3N0YXJ0SWRdOwogICAgICAgICAgICBpKys7CiAgICAgICAgICAgIHN0YXJ0SWQrKzsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLy8gUmVzZXQgZm9yIHVwZ3JhZGVzCiAgICAgICAgaSA9IDA7CiAgICAgICAgKHN0YXJ0SWQsIGVuZElkKSA9IHNjaGVtYS51cGdyYWRlSWRSYW5nZSgpOwogICAgICAgIHdoaWxlIChzdGFydElkIDw9IGVuZElkKSB7CiAgICAgICAgICAgIHVwZ3JhZGVzW2ldID0gdXBncmFkZXNPd25lZFttc2cuc2VuZGVyXVtzdGFydElkXTsKICAgICAgICAgICAgaSsrOwogICAgICAgICAgICBzdGFydElkKys7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHJldHVybiAoYmxvY2sudGltZXN0YW1wLCB0b3RhbEV0aGVyR29vUmVzZWFyY2hQb29sLCB0b3RhbEdvb1Byb2R1Y3Rpb24sIHRvdGFsR29vRGVwb3NpdFNuYXBzaG90c1t0b3RhbEdvb0RlcG9zaXRTbmFwc2hvdHMubGVuZ3RoIC0gMV0sICBnb29EZXBvc2l0U25hcHNob3RzW21zZy5zZW5kZXJdW3RvdGFsR29vRGVwb3NpdFNuYXBzaG90cy5sZW5ndGggLSAxXSwKICAgICAgICBuZXh0U25hcHNob3RUaW1lLCBiYWxhbmNlT2YobXNnLnNlbmRlciksIGV0aEJhbGFuY2VbbXNnLnNlbmRlcl0sIGdldEdvb1Byb2R1Y3Rpb24obXNnLnNlbmRlciksIHVuaXRzLCB1cGdyYWRlcyk7CiAgICB9CiAgICAKICAgIC8vIFRvIGRpc3BsYXkgb24gd2Vic2l0ZQogICAgZnVuY3Rpb24gZ2V0UmFyZUl0ZW1JbmZvKCkgZXh0ZXJuYWwgY29uc3RhbnQgcmV0dXJucyAoYWRkcmVzc1tdLCB1aW50MjU2W10pIHsKICAgICAgICBhZGRyZXNzW10gbWVtb3J5IGl0ZW1Pd25lcnMgPSBuZXcgYWRkcmVzc1tdKHNjaGVtYS5jdXJyZW50TnVtYmVyT2ZSYXJlcygpKTsKICAgICAgICB1aW50MjU2W10gbWVtb3J5IGl0ZW1QcmljZXMgPSBuZXcgdWludDI1NltdKHNjaGVtYS5jdXJyZW50TnVtYmVyT2ZSYXJlcygpKTsKICAgICAgICAKICAgICAgICB1aW50MjU2IHN0YXJ0SWQ7CiAgICAgICAgdWludDI1NiBlbmRJZDsKICAgICAgICAoc3RhcnRJZCwgZW5kSWQpID0gc2NoZW1hLnJhcmVJZFJhbmdlKCk7CiAgICAgICAgCiAgICAgICAgdWludDI1NiBpOwogICAgICAgIHdoaWxlIChzdGFydElkIDw9IGVuZElkKSB7CiAgICAgICAgICAgIGl0ZW1Pd25lcnNbaV0gPSByYXJlSXRlbU93bmVyW3N0YXJ0SWRdOwogICAgICAgICAgICBpdGVtUHJpY2VzW2ldID0gcmFyZUl0ZW1QcmljZVtzdGFydElkXTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGkrKzsKICAgICAgICAgICAgc3RhcnRJZCsrOwogICAgICAgIH0KICAgICAgICAKICAgICAgICByZXR1cm4gKGl0ZW1Pd25lcnMsIGl0ZW1QcmljZXMpOwogICAgfQogICAgCiAgICAvLyBUbyBkaXNwbGF5IG9uIHdlYnNpdGUKICAgIGZ1bmN0aW9uIHZpZXdVbmNsYWltZWRSZXNlYXJjaERpdmlkZW5kcygpIGV4dGVybmFsIGNvbnN0YW50IHJldHVybnMgKHVpbnQyNTYsIHVpbnQyNTYsIHVpbnQyNTYpIHsKICAgICAgICB1aW50MjU2IHN0YXJ0U25hcHNob3QgPSBsYXN0R29vUmVzZWFyY2hGdW5kQ2xhaW1bbXNnLnNlbmRlcl07CiAgICAgICAgdWludDI1NiBsYXRlc3RTbmFwc2hvdCA9IGFsbG9jYXRlZEdvb1Jlc2VhcmNoU25hcHNob3RzLmxlbmd0aCAtIDE7IC8vIE5vIHNuYXBzaG90cyB0byBiZWdpbiB3aXRoCiAgICAgICAgCiAgICAgICAgdWludDI1NiByZXNlYXJjaFNoYXJlOwogICAgICAgIHVpbnQyNTYgcHJldmlvdXNQcm9kdWN0aW9uID0gZ29vUHJvZHVjdGlvblNuYXBzaG90c1ttc2cuc2VuZGVyXVtsYXN0R29vUmVzZWFyY2hGdW5kQ2xhaW1bbXNnLnNlbmRlcl0gLSAxXTsgLy8gVW5kZXJmbG93IHdvbid0IGJlIGEgcHJvYmxlbSBhcyBnb29Qcm9kdWN0aW9uU25hcHNob3RzW11bMHhmZmZmZmZmZmZmZmZmXSA9IDA7CiAgICAgICAgZm9yICh1aW50MjU2IGkgPSBzdGFydFNuYXBzaG90OyBpIDw9IGxhdGVzdFNuYXBzaG90OyBpKyspIHsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNsaWdodGx5IGNvbXBsZXggdGhpbmdzIGJ5IGFjY291bnRpbmcgZm9yIGRheXMvc25hcHNob3RzIHdoZW4gdXNlciBtYWRlIG5vIHR4J3MKICAgICAgICAgICAgdWludDI1NiBwcm9kdWN0aW9uRHVyaW5nU25hcHNob3QgPSBnb29Qcm9kdWN0aW9uU25hcHNob3RzW21zZy5zZW5kZXJdW2ldOwogICAgICAgICAgICBib29sIHNvbGRBbGxQcm9kdWN0aW9uID0gZ29vUHJvZHVjdGlvblplcm9lZFNuYXBzaG90c1ttc2cuc2VuZGVyXVtpXTsKICAgICAgICAgICAgaWYgKHByb2R1Y3Rpb25EdXJpbmdTbmFwc2hvdCA9PSAwICYmICFzb2xkQWxsUHJvZHVjdGlvbikgewogICAgICAgICAgICAgICAgcHJvZHVjdGlvbkR1cmluZ1NuYXBzaG90ID0gcHJldmlvdXNQcm9kdWN0aW9uOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICBwcmV2aW91c1Byb2R1Y3Rpb24gPSBwcm9kdWN0aW9uRHVyaW5nU25hcHNob3Q7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIHJlc2VhcmNoU2hhcmUgKz0gKGFsbG9jYXRlZEdvb1Jlc2VhcmNoU25hcHNob3RzW2ldICogcHJvZHVjdGlvbkR1cmluZ1NuYXBzaG90KSAvIHRvdGFsR29vUHJvZHVjdGlvblNuYXBzaG90c1tpXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIChyZXNlYXJjaFNoYXJlLCBzdGFydFNuYXBzaG90LCBsYXRlc3RTbmFwc2hvdCk7CiAgICB9CiAgICAKICAgIC8vIFRvIGRpc3BsYXkgb24gd2Vic2l0ZQogICAgZnVuY3Rpb24gdmlld1VuY2xhaW1lZERlcG9zaXREaXZpZGVuZHMoKSBleHRlcm5hbCBjb25zdGFudCByZXR1cm5zICh1aW50MjU2LCB1aW50MjU2LCB1aW50MjU2KSB7CiAgICAgICAgdWludDI1NiBzdGFydFNuYXBzaG90ID0gbGFzdEdvb0RlcG9zaXRGdW5kQ2xhaW1bbXNnLnNlbmRlcl07CiAgICAgICAgdWludDI1NiBsYXRlc3RTbmFwc2hvdCA9IGFsbG9jYXRlZEdvb0RlcG9zaXRTbmFwc2hvdHMubGVuZ3RoIC0gMTsgLy8gTm8gc25hcHNob3RzIHRvIGJlZ2luIHdpdGgKICAgICAgICAKICAgICAgICB1aW50MjU2IGRlcG9zaXRTaGFyZTsKICAgICAgICBmb3IgKHVpbnQyNTYgaSA9IHN0YXJ0U25hcHNob3Q7IGkgPD0gbGF0ZXN0U25hcHNob3Q7IGkrKykgewogICAgICAgICAgICBkZXBvc2l0U2hhcmUgKz0gKGFsbG9jYXRlZEdvb0RlcG9zaXRTbmFwc2hvdHNbaV0gKiBnb29EZXBvc2l0U25hcHNob3RzW21zZy5zZW5kZXJdW2ldKSAvIHRvdGFsR29vRGVwb3NpdFNuYXBzaG90c1tpXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIChkZXBvc2l0U2hhcmUsIHN0YXJ0U25hcHNob3QsIGxhdGVzdFNuYXBzaG90KTsKICAgIH0KICAgIAogICAgCiAgICAvLyBUbyBhbGxvdyBjbGllbnRzIHRvIHZlcmlmeSBjb250ZXN0YW50cwogICAgZnVuY3Rpb24gZ2V0SXRlbVJhZmZsZVBsYXllcnModWludDI1NiByYWZmbGVJZCkgZXh0ZXJuYWwgY29uc3RhbnQgcmV0dXJucyAoYWRkcmVzc1tdKSB7CiAgICAgICAgcmV0dXJuIChpdGVtUmFmZmxlUGxheWVyc1tyYWZmbGVJZF0pOwogICAgfQogICAgCiAgICAvLyBUbyBhbGxvdyBjbGllbnRzIHRvIHZlcmlmeSBjb250ZXN0YW50cwogICAgZnVuY3Rpb24gZ2V0VW5pdFJhZmZsZVBsYXllcnModWludDI1NiByYWZmbGVJZCkgZXh0ZXJuYWwgY29uc3RhbnQgcmV0dXJucyAoYWRkcmVzc1tdKSB7CiAgICAgICAgcmV0dXJuICh1bml0UmFmZmxlUGxheWVyc1tyYWZmbGVJZF0pOwogICAgfQogICAgCiAgICAvLyBUbyBhbGxvdyBjbGllbnRzIHRvIHZlcmlmeSBjb250ZXN0YW50cwogICAgZnVuY3Rpb24gZ2V0UGxheWVyc0l0ZW1UaWNrZXRzKGFkZHJlc3MgcGxheWVyKSBleHRlcm5hbCBjb25zdGFudCByZXR1cm5zICh1aW50MjU2W10sIHVpbnQyNTZbXSkgewogICAgICAgIFRpY2tldFB1cmNoYXNlcyBzdG9yYWdlIHBsYXllcnNUaWNrZXRzID0gcmFyZUl0ZW1UaWNrZXRzQm91Z2h0QnlQbGF5ZXJbcGxheWVyXTsKICAgICAgICAKICAgICAgICBpZiAocGxheWVyc1RpY2tldHMucmFmZmxlSWQgPT0gaXRlbVJhZmZsZVJhcmVJZCkgewogICAgICAgICAgICB1aW50MjU2W10gbWVtb3J5IHN0YXJ0SWRzID0gbmV3IHVpbnQyNTZbXShwbGF5ZXJzVGlja2V0cy5udW1QdXJjaGFzZXMpOwogICAgICAgICAgICB1aW50MjU2W10gbWVtb3J5IGVuZElkcyA9IG5ldyB1aW50MjU2W10ocGxheWVyc1RpY2tldHMubnVtUHVyY2hhc2VzKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvciAodWludDI1NiBpID0gMDsgaSA8IHBsYXllcnNUaWNrZXRzLm51bVB1cmNoYXNlczsgaSsrKSB7CiAgICAgICAgICAgICAgICBzdGFydElkc1tpXSA9IHBsYXllcnNUaWNrZXRzLnRpY2tldHNCb3VnaHRbaV0uc3RhcnRJZDsKICAgICAgICAgICAgICAgIGVuZElkc1tpXSA9IHBsYXllcnNUaWNrZXRzLnRpY2tldHNCb3VnaHRbaV0uZW5kSWQ7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgcmV0dXJuIChzdGFydElkcywgZW5kSWRzKTsKICAgIH0KICAgIAogICAgLy8gVG8gYWxsb3cgY2xpZW50cyB0byB2ZXJpZnkgY29udGVzdGFudHMKICAgIGZ1bmN0aW9uIGdldFBsYXllcnNVbml0VGlja2V0cyhhZGRyZXNzIHBsYXllcikgZXh0ZXJuYWwgY29uc3RhbnQgcmV0dXJucyAodWludDI1NltdLCB1aW50MjU2W10pIHsKICAgICAgICBUaWNrZXRQdXJjaGFzZXMgc3RvcmFnZSBwbGF5ZXJzVGlja2V0cyA9IHJhcmVVbml0VGlja2V0c0JvdWdodEJ5UGxheWVyW3BsYXllcl07CiAgICAgICAgCiAgICAgICAgaWYgKHBsYXllcnNUaWNrZXRzLnJhZmZsZUlkID09IHVuaXRSYWZmbGVJZCkgewogICAgICAgICAgICB1aW50MjU2W10gbWVtb3J5IHN0YXJ0SWRzID0gbmV3IHVpbnQyNTZbXShwbGF5ZXJzVGlja2V0cy5udW1QdXJjaGFzZXMpOwogICAgICAgICAgICB1aW50MjU2W10gbWVtb3J5IGVuZElkcyA9IG5ldyB1aW50MjU2W10ocGxheWVyc1RpY2tldHMubnVtUHVyY2hhc2VzKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvciAodWludDI1NiBpID0gMDsgaSA8IHBsYXllcnNUaWNrZXRzLm51bVB1cmNoYXNlczsgaSsrKSB7CiAgICAgICAgICAgICAgICBzdGFydElkc1tpXSA9IHBsYXllcnNUaWNrZXRzLnRpY2tldHNCb3VnaHRbaV0uc3RhcnRJZDsKICAgICAgICAgICAgICAgIGVuZElkc1tpXSA9IHBsYXllcnNUaWNrZXRzLnRpY2tldHNCb3VnaHRbaV0uZW5kSWQ7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgcmV0dXJuIChzdGFydElkcywgZW5kSWRzKTsKICAgIH0KICAgIAogICAgLy8gVG8gZGlzcGxheSBvbiB3ZWJzaXRlCiAgICBmdW5jdGlvbiBnZXRMYXRlc3RJdGVtUmFmZmxlSW5mbygpIGV4dGVybmFsIGNvbnN0YW50IHJldHVybnMgKHVpbnQyNTYsIHVpbnQyNTYsIHVpbnQyNTYsIGFkZHJlc3MsIHVpbnQyNTYpIHsKICAgICAgICByZXR1cm4gKGl0ZW1SYWZmbGVFbmRUaW1lLCBpdGVtUmFmZmxlUmFyZUlkLCBpdGVtUmFmZmxlVGlja2V0c0JvdWdodCwgaXRlbVJhZmZsZVdpbm5lciwgaXRlbVJhZmZsZVRpY2tldFRoYXRXb24pOwogICAgfQogICAgCiAgICAvLyBUbyBkaXNwbGF5IG9uIHdlYnNpdGUKICAgIGZ1bmN0aW9uIGdldExhdGVzdFVuaXRSYWZmbGVJbmZvKCkgZXh0ZXJuYWwgY29uc3RhbnQgcmV0dXJucyAodWludDI1NiwgdWludDI1NiwgdWludDI1NiwgYWRkcmVzcywgdWludDI1NikgewogICAgICAgIHJldHVybiAodW5pdFJhZmZsZUVuZFRpbWUsIHVuaXRSYWZmbGVSYXJlSWQsIHVuaXRSYWZmbGVUaWNrZXRzQm91Z2h0LCB1bml0UmFmZmxlV2lubmVyLCB1bml0UmFmZmxlVGlja2V0VGhhdFdvbik7CiAgICB9CiAgICAKICAgIAogICAgLy8gTmV3IHVuaXRzIG1heSBiZSBhZGRlZCBpbiBmdXR1cmUsIGJ1dCBjaGVjayBpdCBtYXRjaGVzIGV4aXN0aW5nIHNjaGVtYSBzbyBuby1vbmUgY2FuIGFidXNlIHNlbGxpbmcuCiAgICBmdW5jdGlvbiB1cGRhdGVHb29Db25maWcoYWRkcmVzcyBuZXdTY2hlbWFBZGRyZXNzKSBleHRlcm5hbCB7CiAgICAgICAgcmVxdWlyZShtc2cuc2VuZGVyID09IG93bmVyKTsKICAgICAgICAKICAgICAgICBHb29HYW1lQ29uZmlnIG5ld1NjaGVtYSA9IEdvb0dhbWVDb25maWcobmV3U2NoZW1hQWRkcmVzcyk7CiAgICAgICAgCiAgICAgICAgcmVxdWlyZUV4aXN0aW5nVW5pdHNTYW1lKG5ld1NjaGVtYSk7CiAgICAgICAgcmVxdWlyZUV4aXN0aW5nVXBncmFkZXNTYW1lKG5ld1NjaGVtYSk7CiAgICAgICAgCiAgICAgICAgLy8gRmluYWxseSB1cGRhdGUgY29uZmlnCiAgICAgICAgc2NoZW1hID0gR29vR2FtZUNvbmZpZyhuZXdTY2hlbWEpOwogICAgfQogICAgCiAgICBmdW5jdGlvbiByZXF1aXJlRXhpc3RpbmdVbml0c1NhbWUoR29vR2FtZUNvbmZpZyBuZXdTY2hlbWEpIGludGVybmFsIGNvbnN0YW50IHsKICAgICAgICAvLyBSZXF1aXJlcyB1bml0cyBldGggY29zdHMgbWF0Y2ggdXAgb3IgZmFpbCBleGVjdXRpb24KICAgICAgICAKICAgICAgICB1aW50MjU2IHN0YXJ0SWQ7CiAgICAgICAgdWludDI1NiBlbmRJZDsKICAgICAgICAoc3RhcnRJZCwgZW5kSWQpID0gc2NoZW1hLnByb2R1Y3Rpb25Vbml0SWRSYW5nZSgpOwogICAgICAgIHdoaWxlIChzdGFydElkIDw9IGVuZElkKSB7CiAgICAgICAgICAgIHJlcXVpcmUoc2NoZW1hLnVuaXRFdGhDb3N0KHN0YXJ0SWQpID09IG5ld1NjaGVtYS51bml0RXRoQ29zdChzdGFydElkKSk7CiAgICAgICAgICAgIHJlcXVpcmUoc2NoZW1hLnVuaXRHb29Qcm9kdWN0aW9uKHN0YXJ0SWQpID09IG5ld1NjaGVtYS51bml0R29vUHJvZHVjdGlvbihzdGFydElkKSk7CiAgICAgICAgICAgIHN0YXJ0SWQrKzsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgKHN0YXJ0SWQsIGVuZElkKSA9IHNjaGVtYS5iYXR0bGVVbml0SWRSYW5nZSgpOwogICAgICAgIHdoaWxlIChzdGFydElkIDw9IGVuZElkKSB7CiAgICAgICAgICAgIHJlcXVpcmUoc2NoZW1hLnVuaXRFdGhDb3N0KHN0YXJ0SWQpID09IG5ld1NjaGVtYS51bml0RXRoQ29zdChzdGFydElkKSk7CiAgICAgICAgICAgIHJlcXVpcmUoc2NoZW1hLnVuaXRBdHRhY2soc3RhcnRJZCkgPT0gbmV3U2NoZW1hLnVuaXRBdHRhY2soc3RhcnRJZCkpOwogICAgICAgICAgICByZXF1aXJlKHNjaGVtYS51bml0RGVmZW5zZShzdGFydElkKSA9PSBuZXdTY2hlbWEudW5pdERlZmVuc2Uoc3RhcnRJZCkpOwogICAgICAgICAgICByZXF1aXJlKHNjaGVtYS51bml0U3RlYWxpbmdDYXBhY2l0eShzdGFydElkKSA9PSBuZXdTY2hlbWEudW5pdFN0ZWFsaW5nQ2FwYWNpdHkoc3RhcnRJZCkpOwogICAgICAgICAgICBzdGFydElkKys7CiAgICAgICAgfQogICAgfQogICAgCiAgICBmdW5jdGlvbiByZXF1aXJlRXhpc3RpbmdVcGdyYWRlc1NhbWUoR29vR2FtZUNvbmZpZyBuZXdTY2hlbWEpIGludGVybmFsIGNvbnN0YW50IHsKICAgICAgICB1aW50MjU2IHN0YXJ0SWQ7CiAgICAgICAgdWludDI1NiBlbmRJZDsKICAgICAgICAKICAgICAgICAvLyBSZXF1aXJlcyBBTEwgdXBncmFkZSBzdGF0cyBtYXRjaCB1cCBvciBmYWlsIGV4ZWN1dGlvbgogICAgICAgIChzdGFydElkLCBlbmRJZCkgPSBzY2hlbWEudXBncmFkZUlkUmFuZ2UoKTsKICAgICAgICB3aGlsZSAoc3RhcnRJZCA8PSBlbmRJZCkgewogICAgICAgICAgICByZXF1aXJlKHNjaGVtYS51cGdyYWRlR29vQ29zdChzdGFydElkKSA9PSBuZXdTY2hlbWEudXBncmFkZUdvb0Nvc3Qoc3RhcnRJZCkpOwogICAgICAgICAgICByZXF1aXJlKHNjaGVtYS51cGdyYWRlRXRoQ29zdChzdGFydElkKSA9PSBuZXdTY2hlbWEudXBncmFkZUV0aENvc3Qoc3RhcnRJZCkpOwogICAgICAgICAgICByZXF1aXJlKHNjaGVtYS51cGdyYWRlQ2xhc3Moc3RhcnRJZCkgPT0gbmV3U2NoZW1hLnVwZ3JhZGVDbGFzcyhzdGFydElkKSk7CiAgICAgICAgICAgIHJlcXVpcmUoc2NoZW1hLnVwZ3JhZGVVbml0SWQoc3RhcnRJZCkgPT0gbmV3U2NoZW1hLnVwZ3JhZGVVbml0SWQoc3RhcnRJZCkpOwogICAgICAgICAgICByZXF1aXJlKHNjaGVtYS51cGdyYWRlVmFsdWUoc3RhcnRJZCkgPT0gbmV3U2NoZW1hLnVwZ3JhZGVWYWx1ZShzdGFydElkKSk7CiAgICAgICAgICAgIHN0YXJ0SWQrKzsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLy8gUmVxdWlyZXMgQUxMIHJhcmUgc3RhdHMgbWF0Y2ggdXAgb3IgZmFpbCBleGVjdXRpb24KICAgICAgICAoc3RhcnRJZCwgZW5kSWQpID0gc2NoZW1hLnJhcmVJZFJhbmdlKCk7CiAgICAgICAgd2hpbGUgKHN0YXJ0SWQgPD0gZW5kSWQpIHsKICAgICAgICAgICAgdWludDI1NiBvbGRDbGFzczsKICAgICAgICAgICAgdWludDI1NiBvbGRVbml0SWQ7CiAgICAgICAgICAgIHVpbnQyNTYgb2xkVmFsdWU7CiAgICAgICAgICAgIAogICAgICAgICAgICB1aW50MjU2IG5ld0NsYXNzOwogICAgICAgICAgICB1aW50MjU2IG5ld1VuaXRJZDsKICAgICAgICAgICAgdWludDI1NiBuZXdWYWx1ZTsKICAgICAgICAgICAgKG9sZENsYXNzLCBvbGRVbml0SWQsIG9sZFZhbHVlKSA9IHNjaGVtYS5nZXRSYXJlSW5mbyhzdGFydElkKTsKICAgICAgICAgICAgKG5ld0NsYXNzLCBuZXdVbml0SWQsIG5ld1ZhbHVlKSA9IG5ld1NjaGVtYS5nZXRSYXJlSW5mbyhzdGFydElkKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHJlcXVpcmUob2xkQ2xhc3MgPT0gbmV3Q2xhc3MpOwogICAgICAgICAgICByZXF1aXJlKG9sZFVuaXRJZCA9PSBuZXdVbml0SWQpOwogICAgICAgICAgICByZXF1aXJlKG9sZFZhbHVlID09IG5ld1ZhbHVlKTsKICAgICAgICAgICAgc3RhcnRJZCsrOwogICAgICAgIH0KICAgIH0KfQoKCmNvbnRyYWN0IEdvb0dhbWVDb25maWcgewogICAgCiAgICBtYXBwaW5nKHVpbnQyNTYgPT4gVW5pdCkgcHJpdmF0ZSB1bml0SW5mbzsKICAgIG1hcHBpbmcodWludDI1NiA9PiBVcGdyYWRlKSBwcml2YXRlIHVwZ3JhZGVJbmZvOwogICAgbWFwcGluZyh1aW50MjU2ID0+IFJhcmUpIHByaXZhdGUgcmFyZUluZm87CiAgICAKICAgIHVpbnQyNTYgcHVibGljIGNvbnN0YW50IGN1cnJlbnROdW1iZXJPZlVuaXRzID0gMTU7CiAgICB1aW50MjU2IHB1YmxpYyBjb25zdGFudCBjdXJyZW50TnVtYmVyT2ZVcGdyYWRlcyA9IDIxMDsKICAgIHVpbnQyNTYgcHVibGljIGNvbnN0YW50IGN1cnJlbnROdW1iZXJPZlJhcmVzID0gMjsKICAgIAogICAgYWRkcmVzcyBwdWJsaWMgb3duZXI7CiAgICAKICAgIHN0cnVjdCBVbml0IHsKICAgICAgICB1aW50MjU2IHVuaXRJZDsKICAgICAgICB1aW50MjU2IGJhc2VHb29Db3N0OwogICAgICAgIHVpbnQyNTYgZ29vQ29zdEluY3JlYXNlSGFsZjsgLy8gSGFsZmVkIHRvIG1ha2UgbWF0aHMgc2xpZ2h0bHkgbGVzcyAoY2FuY2VscyBhIDIgb3V0KQogICAgICAgIHVpbnQyNTYgZXRoQ29zdDsKICAgICAgICB1aW50MjU2IGJhc2VHb29Qcm9kdWN0aW9uOwogICAgICAgIAogICAgICAgIHVpbnQyNTYgYXR0YWNrVmFsdWU7CiAgICAgICAgdWludDI1NiBkZWZlbnNlVmFsdWU7CiAgICAgICAgdWludDI1NiBnb29TdGVhbGluZ0NhcGFjaXR5OwogICAgICAgIGJvb2wgdW5pdFNlbGxhYmxlOyAvLyBSYXJlIHVuaXRzIChmcm9tIHJhZmZsZSkgbm90IHNlbGxhYmxlCiAgICB9CiAgICAKICAgIHN0cnVjdCBVcGdyYWRlIHsKICAgICAgICB1aW50MjU2IHVwZ3JhZGVJZDsKICAgICAgICB1aW50MjU2IGdvb0Nvc3Q7CiAgICAgICAgdWludDI1NiBldGhDb3N0OwogICAgICAgIHVpbnQyNTYgdXBncmFkZUNsYXNzOwogICAgICAgIHVpbnQyNTYgdW5pdElkOwogICAgICAgIHVpbnQyNTYgdXBncmFkZVZhbHVlOwogICAgICAgIHVpbnQyNTYgcHJlcmVxdWlzaXRlVXBncmFkZTsKICAgIH0KICAgIAogICAgc3RydWN0IFJhcmUgewogICAgICAgIHVpbnQyNTYgcmFyZUlkOwogICAgICAgIHVpbnQyNTYgZXRoQ29zdDsKICAgICAgICB1aW50MjU2IHJhcmVDbGFzczsKICAgICAgICB1aW50MjU2IHVuaXRJZDsKICAgICAgICB1aW50MjU2IHJhcmVWYWx1ZTsKICAgIH0KICAgIAogICAgZnVuY3Rpb24gR29vR2FtZUNvbmZpZygpIHB1YmxpYyB7CiAgICAgICAgb3duZXIgPSBtc2cuc2VuZGVyOwogICAgICAgIAogICAgICAgIHJhcmVJbmZvWzFdID0gUmFyZSgxLCAwLjUgZXRoZXIsIDEsIDEsIDQwKTsgLy8gNDAgPSArNDAwJQogICAgICAgIHJhcmVJbmZvWzJdID0gUmFyZSgyLCAwLjUgZXRoZXIsIDAsIDIsIDM1KTsgLy8gKzM1CiAgICAgICAgCiAgICAgICAgdW5pdEluZm9bMV0gPSBVbml0KDEsIDAsIDEwLCAwLCAyLCAwLCAwLCAwLCB0cnVlKTsKICAgICAgICB1bml0SW5mb1syXSA9IFVuaXQoMiwgMTAwLCA1MCwgMCwgNSwgMCwgMCwgMCwgdHJ1ZSk7CiAgICAgICAgdW5pdEluZm9bM10gPSBVbml0KDMsIDAsIDAsIDAuMDEgZXRoZXIsIDEwMCwgMCwgMCwgMCwgdHJ1ZSk7CiAgICAgICAgdW5pdEluZm9bNF0gPSBVbml0KDQsIDIwMCwgMTAwLCAwLCAxMCwgMCwgMCwgMCwgdHJ1ZSk7CiAgICAgICAgdW5pdEluZm9bNV0gPSBVbml0KDUsIDUwMCwgMjUwLCAwLCAyMCwgMCwgMCwgMCwgdHJ1ZSk7CiAgICAgICAgdW5pdEluZm9bNl0gPSBVbml0KDYsIDEwMDAsIDUwMCwgMCwgNDAsIDAsIDAsIDAsIHRydWUpOwogICAgICAgIHVuaXRJbmZvWzddID0gVW5pdCg3LCAwLCAxMDAwLCAwLjA1IGV0aGVyLCA1MDAsIDAsIDAsIDAsIHRydWUpOwogICAgICAgIHVuaXRJbmZvWzhdID0gVW5pdCg4LCAxNTAwLCA3NTAsIDAsIDYwLCAwLCAwLCAwLCB0cnVlKTsKICAgICAgICB1bml0SW5mb1s5XSA9IFVuaXQoOSwgMCwgMCwgMTAgZXRoZXIsIDYwMDAsIDAsIDAsIDAsIGZhbHNlKTsgLy8gRmlyc3Qgc2VjcmV0IHJhcmUgdW5pdCBmcm9tIHJhZmZsZSAodW5zZWxsYWJsZSkKICAgICAgICAKICAgICAgICB1bml0SW5mb1s0MF0gPSBVbml0KDQwLCA1MCwgMjUsIDAsIDAsIDEwLCAxMCwgMTAwMDAsIHRydWUpOwogICAgICAgIHVuaXRJbmZvWzQxXSA9IFVuaXQoNDEsIDEwMCwgNTAsIDAsIDAsIDEsIDI1LCA1MDAsIHRydWUpOwogICAgICAgIHVuaXRJbmZvWzQyXSA9IFVuaXQoNDIsIDAsIDAsIDAuMDEgZXRoZXIsIDAsIDIwMCwgMTAsIDUwMDAwLCB0cnVlKTsKICAgICAgICB1bml0SW5mb1s0M10gPSBVbml0KDQzLCAyNTAsIDEyNSwgMCwgMCwgMjUsIDEsIDE1MDAwLCB0cnVlKTsKICAgICAgICB1bml0SW5mb1s0NF0gPSBVbml0KDQ0LCA1MDAsIDI1MCwgMCwgMCwgMjAsIDQwLCA1MDAwLCB0cnVlKTsKICAgICAgICB1bml0SW5mb1s0NV0gPSBVbml0KDQ1LCAwLCAyNTAwLCAwLjAyIGV0aGVyLCAwLCAwLCAwLCAxMDAwMDAsIHRydWUpOwogICAgfQogICAgCiAgICBhZGRyZXNzIGFsbG93ZWRDb25maWc7CiAgICBmdW5jdGlvbiBzZXRDb25maWdTZXR1cENvbnRyYWN0KGFkZHJlc3Mgc2NoZW1hKSBleHRlcm5hbCB7CiAgICAgICAgcmVxdWlyZShtc2cuc2VuZGVyID09IG93bmVyKTsKICAgICAgICBhbGxvd2VkQ29uZmlnID0gc2NoZW1hOwogICAgfQogICAgCiAgICBmdW5jdGlvbiBhZGRVcGdyYWRlKHVpbnQyNTYgaWQsIHVpbnQyNTYgZ29vLCB1aW50MjU2IGV0aCwgdWludDI1NiBjbGFzcywgdWludDI1NiB1bml0LCB1aW50MjU2IHZhbHVlLCB1aW50MjU2IHByZXJlcSkgZXh0ZXJuYWwgewogICAgICAgIHJlcXVpcmUobXNnLnNlbmRlciA9PSBhbGxvd2VkQ29uZmlnKTsKICAgICAgICB1cGdyYWRlSW5mb1tpZF0gPSBVcGdyYWRlKGlkLCBnb28sIGV0aCwgY2xhc3MsIHVuaXQsIHZhbHVlLCBwcmVyZXEpOwogICAgfQogICAgCiAgICBmdW5jdGlvbiBnZXRHb29Db3N0Rm9yVW5pdCh1aW50MjU2IHVuaXRJZCwgdWludDI1NiBleGlzdGluZywgdWludDI1NiBhbW91bnQpIHB1YmxpYyBjb25zdGFudCByZXR1cm5zICh1aW50MjU2KSB7CiAgICAgICAgVW5pdCBzdG9yYWdlIHVuaXQgPSB1bml0SW5mb1t1bml0SWRdOwogICAgICAgIGlmIChhbW91bnQgPT0gMSkgeyAvLyAxCiAgICAgICAgICAgIGlmIChleGlzdGluZyA9PSAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdW5pdC5iYXNlR29vQ29zdDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiB1bml0LmJhc2VHb29Db3N0ICsgKGV4aXN0aW5nICogdW5pdC5nb29Db3N0SW5jcmVhc2VIYWxmICogMik7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKGFtb3VudCA+IDEpIHsKICAgICAgICAgICAgdWludDI1NiBleGlzdGluZ0Nvc3Q7CiAgICAgICAgICAgIGlmIChleGlzdGluZyA+IDApIHsgLy8gR2F0ZWQgYnkgdW5pdCBsaW1pdAogICAgICAgICAgICAgICAgZXhpc3RpbmdDb3N0ID0gKHVuaXQuYmFzZUdvb0Nvc3QgKiBleGlzdGluZykgKyAoZXhpc3RpbmcgKiAoZXhpc3RpbmcgLSAxKSAqIHVuaXQuZ29vQ29zdEluY3JlYXNlSGFsZik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGV4aXN0aW5nID0gU2FmZU1hdGguYWRkKGV4aXN0aW5nLCBhbW91bnQpOwogICAgICAgICAgICByZXR1cm4gU2FmZU1hdGguYWRkKFNhZmVNYXRoLm11bCh1bml0LmJhc2VHb29Db3N0LCBleGlzdGluZyksIFNhZmVNYXRoLm11bChTYWZlTWF0aC5tdWwoZXhpc3RpbmcsIChleGlzdGluZyAtIDEpKSwgdW5pdC5nb29Db3N0SW5jcmVhc2VIYWxmKSkgLSBleGlzdGluZ0Nvc3Q7CiAgICAgICAgfQogICAgfQogICAgCiAgICBmdW5jdGlvbiBnZXRXZWFrZW5lZERlZmVuc2VQb3dlcih1aW50MjU2IGRlZmVuZGluZ1Bvd2VyKSBleHRlcm5hbCBjb25zdGFudCByZXR1cm5zICh1aW50MjU2KSB7CiAgICAgICAgcmV0dXJuIGRlZmVuZGluZ1Bvd2VyIC8gMjsKICAgIH0KICAgIAogICAgZnVuY3Rpb24gdmFsaWRSYXJlSWQodWludDI1NiByYXJlSWQpIGV4dGVybmFsIGNvbnN0YW50IHJldHVybnMgKGJvb2wpIHsKICAgICAgICByZXR1cm4gKHJhcmVJZCA+IDAgJiYgcmFyZUlkIDwgMyk7CiAgICB9CiAgICAKICAgIGZ1bmN0aW9uIHVuaXRTZWxsYWJsZSh1aW50MjU2IHVuaXRJZCkgZXh0ZXJuYWwgY29uc3RhbnQgcmV0dXJucyAoYm9vbCkgewogICAgICAgIHJldHVybiB1bml0SW5mb1t1bml0SWRdLnVuaXRTZWxsYWJsZTsKICAgIH0KICAgIAogICAgZnVuY3Rpb24gdW5pdEV0aENvc3QodWludDI1NiB1bml0SWQpIGV4dGVybmFsIGNvbnN0YW50IHJldHVybnMgKHVpbnQyNTYpIHsKICAgICAgICByZXR1cm4gdW5pdEluZm9bdW5pdElkXS5ldGhDb3N0OwogICAgfQogICAgCiAgICBmdW5jdGlvbiB1bml0R29vUHJvZHVjdGlvbih1aW50MjU2IHVuaXRJZCkgZXh0ZXJuYWwgY29uc3RhbnQgcmV0dXJucyAodWludDI1NikgewogICAgICAgIHJldHVybiB1bml0SW5mb1t1bml0SWRdLmJhc2VHb29Qcm9kdWN0aW9uOwogICAgfQogICAgCiAgICBmdW5jdGlvbiB1bml0QXR0YWNrKHVpbnQyNTYgdW5pdElkKSBleHRlcm5hbCBjb25zdGFudCByZXR1cm5zICh1aW50MjU2KSB7CiAgICAgICAgcmV0dXJuIHVuaXRJbmZvW3VuaXRJZF0uYXR0YWNrVmFsdWU7CiAgICB9CiAgICAKICAgIGZ1bmN0aW9uIHVuaXREZWZlbnNlKHVpbnQyNTYgdW5pdElkKSBleHRlcm5hbCBjb25zdGFudCByZXR1cm5zICh1aW50MjU2KSB7CiAgICAgICAgcmV0dXJuIHVuaXRJbmZvW3VuaXRJZF0uZGVmZW5zZVZhbHVlOwogICAgfQogICAgCiAgICBmdW5jdGlvbiB1bml0U3RlYWxpbmdDYXBhY2l0eSh1aW50MjU2IHVuaXRJZCkgZXh0ZXJuYWwgY29uc3RhbnQgcmV0dXJucyAodWludDI1NikgewogICAgICAgIHJldHVybiB1bml0SW5mb1t1bml0SWRdLmdvb1N0ZWFsaW5nQ2FwYWNpdHk7CiAgICB9CiAgICAKICAgIGZ1bmN0aW9uIHJhcmVTdGFydFByaWNlKHVpbnQyNTYgcmFyZUlkKSBleHRlcm5hbCBjb25zdGFudCByZXR1cm5zICh1aW50MjU2KSB7CiAgICAgICAgcmV0dXJuIHJhcmVJbmZvW3JhcmVJZF0uZXRoQ29zdDsKICAgIH0KICAgIAogICAgZnVuY3Rpb24gdXBncmFkZUdvb0Nvc3QodWludDI1NiB1cGdyYWRlSWQpIGV4dGVybmFsIGNvbnN0YW50IHJldHVybnMgKHVpbnQyNTYpIHsKICAgICAgICByZXR1cm4gdXBncmFkZUluZm9bdXBncmFkZUlkXS5nb29Db3N0OwogICAgfQogICAgCiAgICBmdW5jdGlvbiB1cGdyYWRlRXRoQ29zdCh1aW50MjU2IHVwZ3JhZGVJZCkgZXh0ZXJuYWwgY29uc3RhbnQgcmV0dXJucyAodWludDI1NikgewogICAgICAgIHJldHVybiB1cGdyYWRlSW5mb1t1cGdyYWRlSWRdLmV0aENvc3Q7CiAgICB9CiAgICAKICAgIGZ1bmN0aW9uIHVwZ3JhZGVDbGFzcyh1aW50MjU2IHVwZ3JhZGVJZCkgZXh0ZXJuYWwgY29uc3RhbnQgcmV0dXJucyAodWludDI1NikgewogICAgICAgIHJldHVybiB1cGdyYWRlSW5mb1t1cGdyYWRlSWRdLnVwZ3JhZGVDbGFzczsKICAgIH0KICAgIAogICAgZnVuY3Rpb24gdXBncmFkZVVuaXRJZCh1aW50MjU2IHVwZ3JhZGVJZCkgZXh0ZXJuYWwgY29uc3RhbnQgcmV0dXJucyAodWludDI1NikgewogICAgICAgIHJldHVybiB1cGdyYWRlSW5mb1t1cGdyYWRlSWRdLnVuaXRJZDsKICAgIH0KICAgIAogICAgZnVuY3Rpb24gdXBncmFkZVZhbHVlKHVpbnQyNTYgdXBncmFkZUlkKSBleHRlcm5hbCBjb25zdGFudCByZXR1cm5zICh1aW50MjU2KSB7CiAgICAgICAgcmV0dXJuIHVwZ3JhZGVJbmZvW3VwZ3JhZGVJZF0udXBncmFkZVZhbHVlOwogICAgfQogICAgCiAgICBmdW5jdGlvbiBwcm9kdWN0aW9uVW5pdElkUmFuZ2UoKSBleHRlcm5hbCBjb25zdGFudCByZXR1cm5zICh1aW50MjU2LCB1aW50MjU2KSB7CiAgICAgICAgcmV0dXJuICgxLCA5KTsKICAgIH0KICAgIAogICAgZnVuY3Rpb24gYmF0dGxlVW5pdElkUmFuZ2UoKSBleHRlcm5hbCBjb25zdGFudCByZXR1cm5zICh1aW50MjU2LCB1aW50MjU2KSB7CiAgICAgICAgcmV0dXJuICg0MCwgNDUpOwogICAgfQogICAgCiAgICBmdW5jdGlvbiB1cGdyYWRlSWRSYW5nZSgpIGV4dGVybmFsIGNvbnN0YW50IHJldHVybnMgKHVpbnQyNTYsIHVpbnQyNTYpIHsKICAgICAgICByZXR1cm4gKDEsIDIxMCk7CiAgICB9CiAgICAKICAgIGZ1bmN0aW9uIHJhcmVJZFJhbmdlKCkgZXh0ZXJuYWwgY29uc3RhbnQgcmV0dXJucyAodWludDI1NiwgdWludDI1NikgewogICAgICAgIHJldHVybiAoMSwgMik7CiAgICB9CiAgICAKICAgIGZ1bmN0aW9uIGdldFVwZ3JhZGVJbmZvKHVpbnQyNTYgdXBncmFkZUlkKSBleHRlcm5hbCBjb25zdGFudCByZXR1cm5zICh1aW50MjU2LCB1aW50MjU2LCB1aW50MjU2LCB1aW50MjU2LCB1aW50MjU2LCB1aW50MjU2KSB7CiAgICAgICAgcmV0dXJuICh1cGdyYWRlSW5mb1t1cGdyYWRlSWRdLmdvb0Nvc3QsIHVwZ3JhZGVJbmZvW3VwZ3JhZGVJZF0uZXRoQ29zdCwgdXBncmFkZUluZm9bdXBncmFkZUlkXS51cGdyYWRlQ2xhc3MsCiAgICAgICAgdXBncmFkZUluZm9bdXBncmFkZUlkXS51bml0SWQsIHVwZ3JhZGVJbmZvW3VwZ3JhZGVJZF0udXBncmFkZVZhbHVlLCB1cGdyYWRlSW5mb1t1cGdyYWRlSWRdLnByZXJlcXVpc2l0ZVVwZ3JhZGUpOwogICAgfQogICAgCiAgICBmdW5jdGlvbiBnZXRSYXJlSW5mbyh1aW50MjU2IHJhcmVJZCkgZXh0ZXJuYWwgY29uc3RhbnQgcmV0dXJucyAodWludDI1NiwgdWludDI1NiwgdWludDI1NikgewogICAgICAgIHJldHVybiAocmFyZUluZm9bcmFyZUlkXS5yYXJlQ2xhc3MsIHJhcmVJbmZvW3JhcmVJZF0udW5pdElkLCByYXJlSW5mb1tyYXJlSWRdLnJhcmVWYWx1ZSk7CiAgICB9CiAgICAKICAgIGZ1bmN0aW9uIGdldFVuaXRJbmZvKHVpbnQyNTYgdW5pdElkLCB1aW50MjU2IGV4aXN0aW5nLCB1aW50MjU2IGFtb3VudCkgZXh0ZXJuYWwgY29uc3RhbnQgcmV0dXJucyAodWludDI1NiwgdWludDI1NiwgdWludDI1NiwgdWludDI1NikgewogICAgICAgIHJldHVybiAodW5pdEluZm9bdW5pdElkXS51bml0SWQsIHVuaXRJbmZvW3VuaXRJZF0uYmFzZUdvb1Byb2R1Y3Rpb24sIGdldEdvb0Nvc3RGb3JVbml0KHVuaXRJZCwgZXhpc3RpbmcsIGFtb3VudCksIFNhZmVNYXRoLm11bCh1bml0SW5mb1t1bml0SWRdLmV0aENvc3QsIGFtb3VudCkpOwogICAgfQogICAgCn0KCgpsaWJyYXJ5IFNhZmVNYXRoIHsKCiAgLyoqCiAgKiBAZGV2IE11bHRpcGxpZXMgdHdvIG51bWJlcnMsIHRocm93cyBvbiBvdmVyZmxvdy4KICAqLwogIGZ1bmN0aW9uIG11bCh1aW50MjU2IGEsIHVpbnQyNTYgYikgaW50ZXJuYWwgcHVyZSByZXR1cm5zICh1aW50MjU2KSB7CiAgICBpZiAoYSA9PSAwKSB7CiAgICAgIHJldHVybiAwOwogICAgfQogICAgdWludDI1NiBjID0gYSAqIGI7CiAgICBhc3NlcnQoYyAvIGEgPT0gYik7CiAgICByZXR1cm4gYzsKICB9CgogIC8qKgogICogQGRldiBJbnRlZ2VyIGRpdmlzaW9uIG9mIHR3byBudW1iZXJzLCB0cnVuY2F0aW5nIHRoZSBxdW90aWVudC4KICAqLwogIGZ1bmN0aW9uIGRpdih1aW50MjU2IGEsIHVpbnQyNTYgYikgaW50ZXJuYWwgcHVyZSByZXR1cm5zICh1aW50MjU2KSB7CiAgICAvLyBhc3NlcnQoYiA+IDApOyAvLyBTb2xpZGl0eSBhdXRvbWF0aWNhbGx5IHRocm93cyB3aGVuIGRpdmlkaW5nIGJ5IDAKICAgIHVpbnQyNTYgYyA9IGEgLyBiOwogICAgLy8gYXNzZXJ0KGEgPT0gYiAqIGMgKyBhICUgYik7IC8vIFRoZXJlIGlzIG5vIGNhc2UgaW4gd2hpY2ggdGhpcyBkb2Vzbid0IGhvbGQKICAgIHJldHVybiBjOwogIH0KCiAgLyoqCiAgKiBAZGV2IFN1YnN0cmFjdHMgdHdvIG51bWJlcnMsIHRocm93cyBvbiBvdmVyZmxvdyAoaS5lLiBpZiBzdWJ0cmFoZW5kIGlzIGdyZWF0ZXIgdGhhbiBtaW51ZW5kKS4KICAqLwogIGZ1bmN0aW9uIHN1Yih1aW50MjU2IGEsIHVpbnQyNTYgYikgaW50ZXJuYWwgcHVyZSByZXR1cm5zICh1aW50MjU2KSB7CiAgICBhc3NlcnQoYiA8PSBhKTsKICAgIHJldHVybiBhIC0gYjsKICB9CgogIC8qKgogICogQGRldiBBZGRzIHR3byBudW1iZXJzLCB0aHJvd3Mgb24gb3ZlcmZsb3cuCiAgKi8KICBmdW5jdGlvbiBhZGQodWludDI1NiBhLCB1aW50MjU2IGIpIGludGVybmFsIHB1cmUgcmV0dXJucyAodWludDI1NikgewogICAgdWludDI1NiBjID0gYSArIGI7CiAgICBhc3NlcnQoYyA+PSBhKTsKICAgIHJldHVybiBjOwogIH0KfQ=='.
	

]
