Class {
	#name : #SRT523630976eB6147621B5c31c781eBe2Ec2a806E0,
	#superclass : #SRTContracts,
	#category : #SolidityTestingResources
}

{ #category : #base64 }
SRT523630976eB6147621B5c31c781eBe2Ec2a806E0 >> base64 [
	^ 'LyoKLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KRklMRSBIRUFERVIKLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KCmZpbGU6ICAgICAgIEV0aGVyTm9taW4uc29sCnZlcnNpb246ICAgIDEuMAphdXRob3JzOiAgICBBbnRvbiBKdXJpc2V2aWMKICAgICAgICAgICAgRG9taW5pYyBSb21hbm93c2tpCiAgICAgICAgICAgIE1pa2UgU3BhaW4KCmRhdGU6ICAgICAgIDIwMTgtMDQtMDMKY2hlY2tlZDogICAgTWlrZSBTcGFpbgphcHByb3ZlZDogICBTYW11ZWwgQnJvb2tzCgpyZXBvOiAgICAgICBodHRwczovL2dpdGh1Yi5jb20vSGF2dmVuL2hhdnZlbgpjb21taXQ6ICAgICBmYTcwNWRkMmZlYWJjOWRlZjAzYmNlMTM1ZjZhMTUzYTRiNzBiMTExCgotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoqLwoKcHJhZ21hIHNvbGlkaXR5IF4wLjQuMjE7CgovKgotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQpDT05UUkFDVCBERVNDUklQVElPTgotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoKQSBjb250cmFjdCB3aXRoIGEgbGltaXRlZCBzZXR1cCBwZXJpb2QuIEFueSBmdW5jdGlvbiBtb2RpZmllZAp3aXRoIHRoZSBzZXR1cCBtb2RpZmllciB3aWxsIGNlYXNlIHRvIHdvcmsgYWZ0ZXIgdGhlCmNvbmNsdXNpb24gb2YgdGhlIGNvbmZpZ3VyYWJsZS1sZW5ndGggcG9zdC1jb25zdHJ1Y3Rpb24gc2V0dXAgcGVyaW9kLgoKLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KKi8KCmNvbnRyYWN0IExpbWl0ZWRTZXR1cCB7CgogICAgdWludCBzZXR1cEV4cGlyeVRpbWU7CgogICAgZnVuY3Rpb24gTGltaXRlZFNldHVwKHVpbnQgc2V0dXBEdXJhdGlvbikKICAgICAgICBwdWJsaWMKICAgIHsKICAgICAgICBzZXR1cEV4cGlyeVRpbWUgPSBub3cgKyBzZXR1cER1cmF0aW9uOwogICAgfQoKICAgIG1vZGlmaWVyIHNldHVwRnVuY3Rpb24KICAgIHsKICAgICAgICByZXF1aXJlKG5vdyA8IHNldHVwRXhwaXJ5VGltZSk7CiAgICAgICAgXzsKICAgIH0KfQoKLyoKLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KQ09OVFJBQ1QgREVTQ1JJUFRJT04KLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KCkFuIE93bmVkIGNvbnRyYWN0LCB0byBiZSBpbmhlcml0ZWQgYnkgb3RoZXIgY29udHJhY3RzLgpSZXF1aXJlcyBpdHMgb3duZXIgdG8gYmUgZXhwbGljaXRseSBzZXQgaW4gdGhlIGNvbnN0cnVjdG9yLgpQcm92aWRlcyBhbiBvbmx5T3duZXIgYWNjZXNzIG1vZGlmaWVyLgoKVG8gY2hhbmdlIG93bmVyLCB0aGUgY3VycmVudCBvd25lciBtdXN0IG5vbWluYXRlIHRoZSBuZXh0IG93bmVyLAp3aG8gdGhlbiBoYXMgdG8gYWNjZXB0IHRoZSBub21pbmF0aW9uLiBUaGUgbm9taW5hdGlvbiBjYW4gYmUKY2FuY2VsbGVkIGJlZm9yZSBpdCBpcyBhY2NlcHRlZCBieSB0aGUgbmV3IG93bmVyIGJ5IGhhdmluZyB0aGUKcHJldmlvdXMgb3duZXIgY2hhbmdlIHRoZSBub21pbmF0aW9uIChzZXR0aW5nIGl0IHRvIDApLgoKLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KKi8KCmNvbnRyYWN0IE93bmVkIHsKICAgIGFkZHJlc3MgcHVibGljIG93bmVyOwogICAgYWRkcmVzcyBwdWJsaWMgbm9taW5hdGVkT3duZXI7CgogICAgZnVuY3Rpb24gT3duZWQoYWRkcmVzcyBfb3duZXIpCiAgICAgICAgcHVibGljCiAgICB7CiAgICAgICAgb3duZXIgPSBfb3duZXI7CiAgICB9CgogICAgZnVuY3Rpb24gbm9taW5hdGVPd25lcihhZGRyZXNzIF9vd25lcikKICAgICAgICBleHRlcm5hbAogICAgICAgIG9ubHlPd25lcgogICAgewogICAgICAgIG5vbWluYXRlZE93bmVyID0gX293bmVyOwogICAgICAgIGVtaXQgT3duZXJOb21pbmF0ZWQoX293bmVyKTsKICAgIH0KCiAgICBmdW5jdGlvbiBhY2NlcHRPd25lcnNoaXAoKQogICAgICAgIGV4dGVybmFsCiAgICB7CiAgICAgICAgcmVxdWlyZShtc2cuc2VuZGVyID09IG5vbWluYXRlZE93bmVyKTsKICAgICAgICBlbWl0IE93bmVyQ2hhbmdlZChvd25lciwgbm9taW5hdGVkT3duZXIpOwogICAgICAgIG93bmVyID0gbm9taW5hdGVkT3duZXI7CiAgICAgICAgbm9taW5hdGVkT3duZXIgPSBhZGRyZXNzKDApOwogICAgfQoKICAgIG1vZGlmaWVyIG9ubHlPd25lcgogICAgewogICAgICAgIHJlcXVpcmUobXNnLnNlbmRlciA9PSBvd25lcik7CiAgICAgICAgXzsKICAgIH0KCiAgICBldmVudCBPd25lck5vbWluYXRlZChhZGRyZXNzIG5ld093bmVyKTsKICAgIGV2ZW50IE93bmVyQ2hhbmdlZChhZGRyZXNzIG9sZE93bmVyLCBhZGRyZXNzIG5ld093bmVyKTsKfQoKLyoKLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KQ09OVFJBQ1QgREVTQ1JJUFRJT04KLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KCkEgcHJveHkgY29udHJhY3QgdGhhdCwgaWYgaXQgZG9lcyBub3QgcmVjb2duaXNlIHRoZSBmdW5jdGlvbgpiZWluZyBjYWxsZWQgb24gaXQsIHBhc3NlcyBhbGwgdmFsdWUgYW5kIGNhbGwgZGF0YSB0byBhbgp1bmRlcmx5aW5nIHRhcmdldCBjb250cmFjdC4KCi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiovCgpjb250cmFjdCBQcm94eSBpcyBPd25lZCB7CiAgICBQcm94eWFibGUgdGFyZ2V0OwoKICAgIGZ1bmN0aW9uIFByb3h5KFByb3h5YWJsZSBfdGFyZ2V0LCBhZGRyZXNzIF9vd25lcikKICAgICAgICBPd25lZChfb3duZXIpCiAgICAgICAgcHVibGljCiAgICB7CiAgICAgICAgdGFyZ2V0ID0gX3RhcmdldDsKICAgICAgICBlbWl0IFRhcmdldENoYW5nZWQoX3RhcmdldCk7CiAgICB9CgogICAgZnVuY3Rpb24gX3NldFRhcmdldChhZGRyZXNzIF90YXJnZXQpIAogICAgICAgIGV4dGVybmFsCiAgICAgICAgb25seU93bmVyCiAgICB7CiAgICAgICAgcmVxdWlyZShfdGFyZ2V0ICE9IGFkZHJlc3MoMCkpOwogICAgICAgIHRhcmdldCA9IFByb3h5YWJsZShfdGFyZ2V0KTsKICAgICAgICBlbWl0IFRhcmdldENoYW5nZWQoX3RhcmdldCk7CiAgICB9CgogICAgZnVuY3Rpb24gKCkgCiAgICAgICAgcHVibGljCiAgICAgICAgcGF5YWJsZQogICAgewogICAgICAgIHRhcmdldC5zZXRNZXNzYWdlU2VuZGVyKG1zZy5zZW5kZXIpOwogICAgICAgIGFzc2VtYmx5IHsKICAgICAgICAgICAgLy8gQ29weSBjYWxsIGRhdGEgaW50byBmcmVlIG1lbW9yeSByZWdpb24uCiAgICAgICAgICAgIGxldCBmcmVlX3B0ciA6PSBtbG9hZCgweDQwKQogICAgICAgICAgICBjYWxsZGF0YWNvcHkoZnJlZV9wdHIsIDAsIGNhbGxkYXRhc2l6ZSkKCiAgICAgICAgICAgIC8vIEZvcndhcmQgYWxsIGdhcywgZXRoZXIsIGFuZCBkYXRhIHRvIHRoZSB0YXJnZXQgY29udHJhY3QuCiAgICAgICAgICAgIGxldCByZXN1bHQgOj0gY2FsbChnYXMsIHNsb2FkKHRhcmdldF9zbG90KSwgY2FsbHZhbHVlLCBmcmVlX3B0ciwgY2FsbGRhdGFzaXplLCAwLCAwKQogICAgICAgICAgICByZXR1cm5kYXRhY29weShmcmVlX3B0ciwgMCwgcmV0dXJuZGF0YXNpemUpCgogICAgICAgICAgICAvLyBSZXZlcnQgaWYgdGhlIGNhbGwgZmFpbGVkLCBvdGhlcndpc2UgcmV0dXJuIHRoZSByZXN1bHQuCiAgICAgICAgICAgIGlmIGlzemVybyhyZXN1bHQpIHsgcmV2ZXJ0KGZyZWVfcHRyLCBjYWxsZGF0YXNpemUpIH0KICAgICAgICAgICAgcmV0dXJuKGZyZWVfcHRyLCByZXR1cm5kYXRhc2l6ZSkKICAgICAgICB9IAogICAgfQoKICAgIGV2ZW50IFRhcmdldENoYW5nZWQoYWRkcmVzcyB0YXJnZXRBZGRyZXNzKTsKfQoKLyoKLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KQ09OVFJBQ1QgREVTQ1JJUFRJT04KLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KClRoaXMgY29udHJhY3QgY29udGFpbnMgdGhlIFByb3h5YWJsZSBpbnRlcmZhY2UuCkFueSBjb250cmFjdCB0aGUgcHJveHkgd3JhcHMgbXVzdCBpbXBsZW1lbnQgdGhpcywgaW4gb3JkZXIKZm9yIHRoZSBwcm94eSB0byBiZSBhYmxlIHRvIHBhc3MgbXNnLnNlbmRlciBpbnRvIHRoZSB1bmRlcmx5aW5nCmNvbnRyYWN0IGFzIHRoZSBzdGF0ZSBwYXJhbWV0ZXIsIG1lc3NhZ2VTZW5kZXIuCgotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoqLwoKY29udHJhY3QgUHJveHlhYmxlIGlzIE93bmVkIHsKICAgIC8vIHRoZSBwcm94eSB0aGlzIGNvbnRyYWN0IGV4aXN0cyBiZWhpbmQuCiAgICBQcm94eSBwdWJsaWMgcHJveHk7CgogICAgLy8gVGhlIGNhbGxlciBvZiB0aGUgcHJveHksIHBhc3NlZCB0aHJvdWdoIHRvIHRoaXMgY29udHJhY3QuCiAgICAvLyBOb3RlIHRoYXQgZXZlcnkgZnVuY3Rpb24gdXNpbmcgdGhpcyBtZW1iZXIgbXVzdCBhcHBseSB0aGUgb25seVByb3h5IG9yCiAgICAvLyBvcHRpb25hbFByb3h5IG1vZGlmaWVycywgb3RoZXJ3aXNlIHRoZWlyIGludm9jYXRpb25zIGNhbiB1c2Ugc3RhbGUgdmFsdWVzLgogICAgYWRkcmVzcyBtZXNzYWdlU2VuZGVyOwoKICAgIGZ1bmN0aW9uIFByb3h5YWJsZShhZGRyZXNzIF9vd25lcikKICAgICAgICBPd25lZChfb3duZXIpCiAgICAgICAgcHVibGljIHsgfQoKICAgIGZ1bmN0aW9uIHNldFByb3h5KFByb3h5IF9wcm94eSkKICAgICAgICBleHRlcm5hbAogICAgICAgIG9ubHlPd25lcgogICAgewogICAgICAgIHByb3h5ID0gX3Byb3h5OwogICAgICAgIGVtaXQgUHJveHlDaGFuZ2VkKF9wcm94eSk7CiAgICB9CgogICAgZnVuY3Rpb24gc2V0TWVzc2FnZVNlbmRlcihhZGRyZXNzIHNlbmRlcikKICAgICAgICBleHRlcm5hbAogICAgICAgIG9ubHlQcm94eQogICAgewogICAgICAgIG1lc3NhZ2VTZW5kZXIgPSBzZW5kZXI7CiAgICB9CgogICAgbW9kaWZpZXIgb25seVByb3h5CiAgICB7CiAgICAgICAgcmVxdWlyZShQcm94eShtc2cuc2VuZGVyKSA9PSBwcm94eSk7CiAgICAgICAgXzsKICAgIH0KCiAgICBtb2RpZmllciBvcHRpb25hbFByb3h5CiAgICB7CiAgICAgICAgaWYgKFByb3h5KG1zZy5zZW5kZXIpICE9IHByb3h5KSB7CiAgICAgICAgICAgIG1lc3NhZ2VTZW5kZXIgPSBtc2cuc2VuZGVyOwogICAgICAgIH0KICAgICAgICBfOwogICAgfQoKICAgIC8vIENvbWJpbmUgdGhlIG9wdGlvbmFsUHJveHkgYW5kIG9ubHlPd25lcl9Qcm94eSBtb2RpZmllcnMuCiAgICAvLyBUaGlzIGlzIHNsaWdodGx5IGNoZWFwZXIgYW5kIHNhZmVyLCBzaW5jZSB0aGVyZSBpcyBhbiBvcmRlcmluZyByZXF1aXJlbWVudC4KICAgIG1vZGlmaWVyIG9wdGlvbmFsUHJveHlfb25seU93bmVyCiAgICB7CiAgICAgICAgaWYgKFByb3h5KG1zZy5zZW5kZXIpICE9IHByb3h5KSB7CiAgICAgICAgICAgIG1lc3NhZ2VTZW5kZXIgPSBtc2cuc2VuZGVyOwogICAgICAgIH0KICAgICAgICByZXF1aXJlKG1lc3NhZ2VTZW5kZXIgPT0gb3duZXIpOwogICAgICAgIF87CiAgICB9CgogICAgZXZlbnQgUHJveHlDaGFuZ2VkKGFkZHJlc3MgcHJveHlBZGRyZXNzKTsKCn0KCi8qCi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCkNPTlRSQUNUIERFU0NSSVBUSU9OCi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCgpBIGZpeGVkIHBvaW50IGRlY2ltYWwgbGlicmFyeSB0aGF0IHByb3ZpZGVzIGJhc2ljIG1hdGhlbWF0aWNhbApvcGVyYXRpb25zLCBhbmQgY2hlY2tzIGZvciB1bnNhZmUgYXJndW1lbnRzLCBmb3IgZXhhbXBsZSB0aGF0CndvdWxkIGxlYWQgdG8gb3ZlcmZsb3dzLgoKRXhjZXB0aW9ucyBhcmUgdGhyb3duIHdoZW5ldmVyIHRob3NlIHVuc2FmZSBvcGVyYXRpb25zCm9jY3VyLgoKLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KKi8KCmNvbnRyYWN0IFNhZmVEZWNpbWFsTWF0aCB7CgogICAgLy8gTnVtYmVyIG9mIGRlY2ltYWwgcGxhY2VzIGluIHRoZSByZXByZXNlbnRhdGlvbi4KICAgIHVpbnQ4IHB1YmxpYyBjb25zdGFudCBkZWNpbWFscyA9IDE4OwoKICAgIC8vIFRoZSBudW1iZXIgcmVwcmVzZW50aW5nIDEuMC4KICAgIHVpbnQgcHVibGljIGNvbnN0YW50IFVOSVQgPSAxMCAqKiB1aW50KGRlY2ltYWxzKTsKCiAgICAvKiBUcnVlIGlmZiBhZGRpbmcgeCBhbmQgeSB3aWxsIG5vdCBvdmVyZmxvdy4gKi8KICAgIGZ1bmN0aW9uIGFkZElzU2FmZSh1aW50IHgsIHVpbnQgeSkKICAgICAgICBwdXJlCiAgICAgICAgaW50ZXJuYWwKICAgICAgICByZXR1cm5zIChib29sKQogICAgewogICAgICAgIHJldHVybiB4ICsgeSA+PSB5OwogICAgfQoKICAgIC8qIFJldHVybiB0aGUgcmVzdWx0IG9mIGFkZGluZyB4IGFuZCB5LCB0aHJvd2luZyBhbiBleGNlcHRpb24gaW4gY2FzZSBvZiBvdmVyZmxvdy4gKi8KICAgIGZ1bmN0aW9uIHNhZmVBZGQodWludCB4LCB1aW50IHkpCiAgICAgICAgcHVyZQogICAgICAgIGludGVybmFsCiAgICAgICAgcmV0dXJucyAodWludCkKICAgIHsKICAgICAgICByZXF1aXJlKHggKyB5ID49IHkpOwogICAgICAgIHJldHVybiB4ICsgeTsKICAgIH0KCiAgICAvKiBUcnVlIGlmZiBzdWJ0cmFjdGluZyB5IGZyb20geCB3aWxsIG5vdCBvdmVyZmxvdyBpbiB0aGUgbmVnYXRpdmUgZGlyZWN0aW9uLiAqLwogICAgZnVuY3Rpb24gc3ViSXNTYWZlKHVpbnQgeCwgdWludCB5KQogICAgICAgIHB1cmUKICAgICAgICBpbnRlcm5hbAogICAgICAgIHJldHVybnMgKGJvb2wpCiAgICB7CiAgICAgICAgcmV0dXJuIHkgPD0geDsKICAgIH0KCiAgICAvKiBSZXR1cm4gdGhlIHJlc3VsdCBvZiBzdWJ0cmFjdGluZyB5IGZyb20geCwgdGhyb3dpbmcgYW4gZXhjZXB0aW9uIGluIGNhc2Ugb2Ygb3ZlcmZsb3cuICovCiAgICBmdW5jdGlvbiBzYWZlU3ViKHVpbnQgeCwgdWludCB5KQogICAgICAgIHB1cmUKICAgICAgICBpbnRlcm5hbAogICAgICAgIHJldHVybnMgKHVpbnQpCiAgICB7CiAgICAgICAgcmVxdWlyZSh5IDw9IHgpOwogICAgICAgIHJldHVybiB4IC0geTsKICAgIH0KCiAgICAvKiBUcnVlIGlmZiBtdWx0aXBseWluZyB4IGFuZCB5IHdvdWxkIG5vdCBvdmVyZmxvdy4gKi8KICAgIGZ1bmN0aW9uIG11bElzU2FmZSh1aW50IHgsIHVpbnQgeSkKICAgICAgICBwdXJlCiAgICAgICAgaW50ZXJuYWwKICAgICAgICByZXR1cm5zIChib29sKQogICAgewogICAgICAgIGlmICh4ID09IDApIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIHJldHVybiAoeCAqIHkpIC8geCA9PSB5OwogICAgfQoKICAgIC8qIFJldHVybiB0aGUgcmVzdWx0IG9mIG11bHRpcGx5aW5nIHggYW5kIHksIHRocm93aW5nIGFuIGV4Y2VwdGlvbiBpbiBjYXNlIG9mIG92ZXJmbG93LiovCiAgICBmdW5jdGlvbiBzYWZlTXVsKHVpbnQgeCwgdWludCB5KQogICAgICAgIHB1cmUKICAgICAgICBpbnRlcm5hbAogICAgICAgIHJldHVybnMgKHVpbnQpCiAgICB7CiAgICAgICAgaWYgKHggPT0gMCkgewogICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICB9CiAgICAgICAgdWludCBwID0geCAqIHk7CiAgICAgICAgcmVxdWlyZShwIC8geCA9PSB5KTsKICAgICAgICByZXR1cm4gcDsKICAgIH0KCiAgICAvKiBSZXR1cm4gdGhlIHJlc3VsdCBvZiBtdWx0aXBseWluZyB4IGFuZCB5LCBpbnRlcnByZXRpbmcgdGhlIG9wZXJhbmRzIGFzIGZpeGVkLXBvaW50CiAgICAgKiBkZW1pY2ltYWxzLiBUaHJvd3MgYW4gZXhjZXB0aW9uIGluIGNhc2Ugb2Ygb3ZlcmZsb3cuIEEgdW5pdCBmYWN0b3IgaXMgZGl2aWRlZCBvdXQKICAgICAqIGFmdGVyIHRoZSBwcm9kdWN0IG9mIHggYW5kIHkgaXMgZXZhbHVhdGVkLCBzbyB0aGF0IHByb2R1Y3QgbXVzdCBiZSBsZXNzIHRoYW4gMioqMjU2LgogICAgICogCiAgICAgKiBJbmNpZGVudGFsbHksIHRoZSBpbnRlcm5hbCBkaXZpc2lvbiBhbHdheXMgcm91bmRzIGRvd246IHdlIGNvdWxkIGhhdmUgcm91bmRlZCB0byB0aGUgbmVhcmVzdCBpbnRlZ2VyLAogICAgICogYnV0IHRoZW4gd2Ugd291bGQgYmUgc3BlbmRpbmcgYSBzaWduaWZpY2FudCBmcmFjdGlvbiBvZiBhIGNlbnQgKG9mIG9yZGVyIGEgbWljcm9ldGhlcgogICAgICogYXQgcHJlc2VudCBnYXMgcHJpY2VzKSBpbiBvcmRlciB0byBzYXZlIGxlc3MgdGhhbiBvbmUgcGFydCBpbiAwLjUgKiAxMF4xOCBwZXIgb3BlcmF0aW9uLCBpZiB0aGUgb3BlcmFuZHMKICAgICAqIGNvbnRhaW4gc21hbGwgZW5vdWdoIGZyYWN0aW9uYWwgY29tcG9uZW50cy4gSXQgd291bGQgYWxzbyBtYXJnaW5hbGx5IGRpbWluaXNoIHRoZSAKICAgICAqIGRvbWFpbiB0aGlzIGZ1bmN0aW9uIGlzIGRlZmluZWQgdXBvbi4gCiAgICAgKi8KICAgIGZ1bmN0aW9uIHNhZmVNdWxfZGVjKHVpbnQgeCwgdWludCB5KQogICAgICAgIHB1cmUKICAgICAgICBpbnRlcm5hbAogICAgICAgIHJldHVybnMgKHVpbnQpCiAgICB7CiAgICAgICAgLy8gRGl2aWRlIGJ5IFVOSVQgdG8gcmVtb3ZlIHRoZSBleHRyYSBmYWN0b3IgaW50cm9kdWNlZCBieSB0aGUgcHJvZHVjdC4KICAgICAgICAvLyBVTklUIGJlIDAuCiAgICAgICAgcmV0dXJuIHNhZmVNdWwoeCwgeSkgLyBVTklUOwoKICAgIH0KCiAgICAvKiBUcnVlIGlmZiB0aGUgZGVub21pbmF0b3Igb2YgeC95IGlzIG5vbnplcm8uICovCiAgICBmdW5jdGlvbiBkaXZJc1NhZmUodWludCB4LCB1aW50IHkpCiAgICAgICAgcHVyZQogICAgICAgIGludGVybmFsCiAgICAgICAgcmV0dXJucyAoYm9vbCkKICAgIHsKICAgICAgICByZXR1cm4geSAhPSAwOwogICAgfQoKICAgIC8qIFJldHVybiB0aGUgcmVzdWx0IG9mIGRpdmlkaW5nIHggYnkgeSwgdGhyb3dpbmcgYW4gZXhjZXB0aW9uIGlmIHRoZSBkaXZpc29yIGlzIHplcm8uICovCiAgICBmdW5jdGlvbiBzYWZlRGl2KHVpbnQgeCwgdWludCB5KQogICAgICAgIHB1cmUKICAgICAgICBpbnRlcm5hbAogICAgICAgIHJldHVybnMgKHVpbnQpCiAgICB7CiAgICAgICAgLy8gQWx0aG91Z2ggYSAwIGRlbm9taW5hdG9yIGFscmVhZHkgdGhyb3dzIGFuIGV4Y2VwdGlvbiwKICAgICAgICAvLyBpdCBpcyBlcXVpdmFsZW50IHRvIGEgVEhST1cgb3BlcmF0aW9uLCB3aGljaCBjb25zdW1lcyBhbGwgZ2FzLgogICAgICAgIC8vIEEgcmVxdWlyZSBzdGF0ZW1lbnQgZW1pdHMgUkVWRVJUIGluc3RlYWQsIHdoaWNoIHJlbWl0cyByZW1haW5pbmcgZ2FzLgogICAgICAgIHJlcXVpcmUoeSAhPSAwKTsKICAgICAgICByZXR1cm4geCAvIHk7CiAgICB9CgogICAgLyogUmV0dXJuIHRoZSByZXN1bHQgb2YgZGl2aWRpbmcgeCBieSB5LCBpbnRlcnByZXRpbmcgdGhlIG9wZXJhbmRzIGFzIGZpeGVkIHBvaW50IGRlY2ltYWwgbnVtYmVycy4KICAgICAqIFRocm93cyBhbiBleGNlcHRpb24gaW4gY2FzZSBvZiBvdmVyZmxvdyBvciB6ZXJvIGRpdmlzb3I7IHggbXVzdCBiZSBsZXNzIHRoYW4gMl4yNTYgLyBVTklULgogICAgICogSW50ZXJuYWwgcm91bmRpbmcgaXMgZG93bndhcmQ6IGEgc2ltaWxhciBjYXZlYXQgaG9sZHMgYXMgd2l0aCBzYWZlRGVjTXVsKCkuKi8KICAgIGZ1bmN0aW9uIHNhZmVEaXZfZGVjKHVpbnQgeCwgdWludCB5KQogICAgICAgIHB1cmUKICAgICAgICBpbnRlcm5hbAogICAgICAgIHJldHVybnMgKHVpbnQpCiAgICB7CiAgICAgICAgLy8gUmVpbnRyb2R1Y2UgdGhlIFVOSVQgZmFjdG9yIHRoYXQgd2lsbCBiZSBkaXZpZGVkIG91dCBieSB5LgogICAgICAgIHJldHVybiBzYWZlRGl2KHNhZmVNdWwoeCwgVU5JVCksIHkpOwogICAgfQoKICAgIC8qIENvbnZlcnQgYW4gdW5zaWduZWQgaW50ZWdlciB0byBhIHVuc2lnbmVkIGZpeGVkLXBvaW50IGRlY2ltYWwuCiAgICAgKiBUaHJvdyBhbiBleGNlcHRpb24gaWYgdGhlIHJlc3VsdCB3b3VsZCBiZSBvdXQgb2YgcmFuZ2UuICovCiAgICBmdW5jdGlvbiBpbnRUb0RlYyh1aW50IGkpCiAgICAgICAgcHVyZQogICAgICAgIGludGVybmFsCiAgICAgICAgcmV0dXJucyAodWludCkKICAgIHsKICAgICAgICByZXR1cm4gc2FmZU11bChpLCBVTklUKTsKICAgIH0KfQoKLyoKLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KQ09OVFJBQ1QgREVTQ1JJUFRJT04KLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KClRoaXMgcHJvdmlkZXMgdGhlIG5vbWluIGNvbnRyYWN0IHdpdGggYSBjb25maXNjYXRpb24KZmFjaWxpdHksIGlmIGVub3VnaCBoYXZ2ZW4gb3duZXJzIHZvdGUgdG8gY29uZmlzY2F0ZSBhIHRhcmdldAphY2NvdW50J3Mgbm9taW5zLgoKVGhpcyBpcyBkZXNpZ25lZCB0byBwcm92aWRlIGEgbWVjaGFuaXNtIHRvIHJlc3BvbmQgdG8gYWJ1c2l2ZQpjb250cmFjdHMgc3VjaCBhcyBub21pbiB3cmFwcGVycywgd2hpY2ggd291bGQgYWxsb3cgdXNlcnMgdG8KdHJhZGUgd3JhcHBlZCBub21pbnMgd2l0aG91dCBhY2NydWluZyBmZWVzIG9uIHRob3NlIHRyYW5zYWN0aW9ucy4KCkluIG9yZGVyIHRvIHByZXZlbnQgdHlyYW5ueSwgYW4gYWNjb3VudCBtYXkgb25seSBiZSBmcm96ZW4gaWYKdXNlcnMgY29udHJvbGxpbmcgYXQgbGVhc3QgMzAlIG9mIHRoZSB2YWx1ZSBvZiBoYXZ2ZW5zIHBhcnRpY2lwYXRlLAphbmQgYSB0d28gdGhpcmRzIG1ham9yaXR5IGlzIGF0dGFpbmVkIGluIHRoYXQgdm90ZS4KSW4gb3JkZXIgdG8gcHJldmVudCB0eXJhbm55IG9mIHRoZSBtYWpvcml0eSBvciBtb2IganVzdGljZSwKY29uZmlzY2F0aW9uIG1vdGlvbnMgYXJlIG9ubHkgYXBwcm92ZWQgaWYgdGhlIGhhdnZlbiBmb3VuZGF0aW9uCmFwcHJvdmVzIHRoZSByZXN1bHQuClRoaXMgbGF0dGVyIHJlcXVpcmVtZW50IG1heSBiZSBsaWZ0ZWQgaW4gZnV0dXJlIHZlcnNpb25zLgoKVGhlIGZvdW5kYXRpb24sIG9yIGFueSB1c2VyIHdpdGggYSBzdWZmaWNpZW50IGhhdnZlbiBiYWxhbmNlIG1heSBicmluZyBhCmNvbmZpc2NhdGlvbiBtb3Rpb24uCkEgbW90aW9uIGxhc3RzIGZvciBhIGRlZmF1bHQgcGVyaW9kIG9mIG9uZSB3ZWVrLCB3aXRoIGEgZnVydGhlciBjb25maXJtYXRpb24KcGVyaW9kIGluIHdoaWNoIHRoZSBmb3VuZGF0aW9uIGFwcHJvdmVzIHRoZSByZXN1bHQuClRoZSBsYXR0ZXIgcGVyaW9kIG1heSBjb25jbHVkZSBlYXJseSB1cG9uIHRoZSBmb3VuZGF0aW9uJ3MgZGVjaXNpb24gdG8gZWl0aGVyCnZldG8gb3IgYXBwcm92ZSB0aGUgbW9vdGVkIGNvbmZpc2NhdGlvbiBtb3Rpb24uCklmIHRoZSBjb25maXJtYXRpb24gcGVyaW9kIGVsYXBzZXMgd2l0aG91dCB0aGUgZm91bmRhdGlvbiBtYWtpbmcgYSBkZWNpc2lvbiwKdGhlIG1vdGlvbiBmYWlscy4KClRoZSB3ZWlnaHQgb2YgYSBoYXZ2ZW4gaG9sZGVyJ3Mgdm90ZSBpcyBkZXRlcm1pbmVkIGJ5IGV4YW1pbmluZyB0aGVpcgphdmVyYWdlIGJhbGFuY2Ugb3ZlciB0aGUgbGFzdCBjb21wbGV0ZWQgZmVlIHBlcmlvZCBwcmlvciB0byB0aGUKYmVnaW5uaW5nIG9mIGEgZ2l2ZW4gbW90aW9uLgpUaHVzLCBzaW5jZSBhIGZlZSBwZXJpb2QgY2FuIHJvbGwgb3ZlciBpbiB0aGUgbWlkZGxlIG9mIGEgbW90aW9uLCB3ZSBtdXN0CmFsc28gdHJhY2sgYSB1c2VyJ3MgYXZlcmFnZSBiYWxhbmNlIG9mIHRoZSBsYXN0IHR3byBwZXJpb2RzLgpUaGlzIHN5c3RlbSBpcyBkZXNpZ25lZCBzdWNoIHRoYXQgaXQgY2Fubm90IGJlIGF0dGFja2VkIGJ5IHVzZXJzIHRyYW5zZmVycmluZwpmdW5kcyBiZXR3ZWVuIHRoZW1zZWx2ZXMsIHdoaWxlIGFsc28gbm90IHJlcXVpcmluZyB0aGVtIHRvIGxvY2sgdGhlaXIgaGF2dmVucwpmb3IgdGhlIGR1cmF0aW9uIG9mIHRoZSB2b3RlLiBUaGlzIGlzIHBvc3NpYmxlIHNpbmNlIGFueSB0cmFuc2ZlciB0aGF0IGluY3JlYXNlcwp0aGUgYXZlcmFnZSBiYWxhbmNlIGluIG9uZSBhY2NvdW50IHdpbGwgYmUgcmVmbGVjdGVkIGJ5IGFuIGVxdWl2YWxlbnQgcmVkdWN0aW9uCmluIHRoZSB2b3Rpbmcgd2VpZ2h0IGluIHRoZSBvdGhlci4KQXQgcHJlc2VudCBhIHVzZXIgbWF5IGNhc3QgYSB2b3RlIG9ubHkgZm9yIG9uZSBtb3Rpb24gYXQgYSB0aW1lLApidXQgbWF5IGNhbmNlbCB0aGVpciB2b3RlIGF0IGFueSB0aW1lIGV4Y2VwdCBkdXJpbmcgdGhlIGNvbmZpcm1hdGlvbiBwZXJpb2QsCndoZW4gdGhlIHZvdGUgdGFsbGllcyBtdXN0IHJlbWFpbiBzdGF0aWMgdW50aWwgdGhlIG1hdHRlciBoYXMgYmVlbiBzZXR0bGVkLgoKQSBtb3Rpb24gdG8gY29uZmlzY2F0ZSB0aGUgYmFsYW5jZSBvZiBhIGdpdmVuIGFkZHJlc3MgY29tcG9zZXMKYSBzdGF0ZSBtYWNoaW5lIGJ1aWx0IG9mIHRoZSBmb2xsb3dpbmcgc3RhdGVzOgoKCldhaXRpbmc6CiAgLSBBIHVzZXIgd2l0aCBzdGFuZGluZyBicmluZ3MgYSBtb3Rpb246CiAgICBJZiB0aGUgdGFyZ2V0IGFkZHJlc3MgaXMgbm90IGZyb3plbjsKICAgIGluaXRpYWxpc2Ugdm90ZSB0YWxsaWVzIHRvIDA7CiAgICB0cmFuc2l0aW9uIHRvIHRoZSBWb3Rpbmcgc3RhdGUuCgogIC0gQW4gYWNjb3VudCBjYW5jZWxzIGEgcHJldmlvdXMgcmVzaWR1YWwgdm90ZToKICAgIHJlbWFpbiBpbiB0aGUgV2FpdGluZyBzdGF0ZS4KClZvdGluZzoKICAtIFRoZSBmb3VuZGF0aW9uIHZldG9lcyB0aGUgaW4tcHJvZ3Jlc3MgbW90aW9uOgogICAgdHJhbnNpdGlvbiB0byB0aGUgV2FpdGluZyBzdGF0ZS4KCiAgLSBUaGUgdm90aW5nIHBlcmlvZCBlbGFwc2VzOgogICAgdHJhbnNpdGlvbiB0byB0aGUgQ29uZmlybWF0aW9uIHN0YXRlLgoKICAtIEFuIGFjY291bnQgdm90ZXMgKGZvciBvciBhZ2FpbnN0IHRoZSBtb3Rpb24pOgogICAgaXRzIHdlaWdodCBpcyBhZGRlZCB0byB0aGUgYXBwcm9wcmlhdGUgdGFsbHk7CiAgICByZW1haW4gaW4gdGhlIFZvdGluZyBzdGF0ZS4KCiAgLSBBbiBhY2NvdW50IGNhbmNlbHMgaXRzIHByZXZpb3VzIHZvdGU6CiAgICBpdHMgd2VpZ2h0IGlzIGRlZHVjdGVkIGZyb20gdGhlIGFwcHJvcHJpYXRlIHRhbGx5IChpZiBhbnkpOwogICAgcmVtYWluIGluIHRoZSBWb3Rpbmcgc3RhdGUuCgpDb25maXJtYXRpb246CiAgLSBUaGUgZm91bmRhdGlvbiB2ZXRvZXMgdGhlIGNvbXBsZXRlZCBtb3Rpb246CiAgICB0cmFuc2l0aW9uIHRvIHRoZSBXYWl0aW5nIHN0YXRlLgoKICAtIFRoZSBmb3VuZGF0aW9uIGFwcHJvdmVzIGNvbmZpc2NhdGlvbiBvZiB0aGUgdGFyZ2V0IGFjY291bnQ6CiAgICBmcmVlemUgdGhlIHRhcmdldCBhY2NvdW50LCB0cmFuc2ZlciBpdHMgbm9taW4gYmFsYW5jZSB0byB0aGUgZmVlIHBvb2w7CiAgICB0cmFuc2l0aW9uIHRvIHRoZSBXYWl0aW5nIHN0YXRlLgoKICAtIFRoZSBjb25maXJtYXRpb24gcGVyaW9kIGVsYXBzZXM6CiAgICB0cmFuc2l0aW9uIHRvIHRoZSBXYWl0aW5nIHN0YXRlLgoKClVzZXIgdm90ZXMgYXJlIG5vdCBhdXRvbWF0aWNhbGx5IGNhbmNlbGxlZCB1cG9uIHRoZSBjb25jbHVzaW9uIG9mIGEgbW90aW9uLgpUaGVyZWZvcmUsIGFmdGVyIGEgbW90aW9uIGNvbWVzIHRvIGEgY29uY2x1c2lvbiwgaWYgYSB1c2VyIHdpc2hlcyB0byB2b3RlIAppbiBhbm90aGVyIG1vdGlvbiwgdGhleSBtdXN0IG1hbnVhbGx5IGNhbmNlbCB0aGVpciB2b3RlIGluIG9yZGVyIHRvIGRvIHNvLgoKVGhpcyBwcm9jZWR1cmUgaXMgZGVzaWduZWQgdG8gYmUgcmVsYXRpdmVseSBzaW1wbGUuClRoZXJlIGFyZSBzb21lIHRoaW5ncyB0aGF0IGNhbiBiZSBhZGRlZCB0byBlbmhhbmNlIHRoZSBmdW5jdGlvbmFsaXR5CmF0IHRoZSBleHBlbnNlIG9mIHNpbXBsaWNpdHkgYW5kIGVmZmljaWVuY3k6CiAgCiAgLSBEZW1vY3JhdGljIHVuZnJlZXppbmcgb2Ygbm9taW4gYWNjb3VudHMgKGluZHVjZXMgbXVsdGlwbGUgY2F0ZWdvcmllcyBvZiB2b3RlKQogIC0gQ29uZmlndXJhYmxlIHBlci12b3RlIGR1cmF0aW9uczsKICAtIFZvdGUgc3RhbmRpbmcgZGVub21pbmF0ZWQgaW4gYSBmaWF0IHF1YW50aXR5IHJhdGhlciB0aGFuIGEgcXVhbnRpdHkgb2YgaGF2dmVuczsKICAtIENvbmZpc2NhdGUgZnJvbSBtdWx0aXBsZSBhZGRyZXNzZXMgaW4gYSBzaW5nbGUgdm90ZTsKCldlIG1pZ2h0IGNvbnNpZGVyIHVwZGF0aW5nIHRoZSBjb250cmFjdCB3aXRoIGFueSBvZiB0aGVzZSBmZWF0dXJlcyBhdCBhIGxhdGVyIGRhdGUgaWYgbmVjZXNzYXJ5LgoKLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KKi8KCmNvbnRyYWN0IENvdXJ0IGlzIE93bmVkLCBTYWZlRGVjaW1hbE1hdGggewoKICAgIC8qID09PT09PT09PT0gU1RBVEUgVkFSSUFCTEVTID09PT09PT09PT0gKi8KCiAgICAvLyBUaGUgYWRkcmVzc2VzIG9mIHRoZSB0b2tlbiBjb250cmFjdHMgdGhpcyBjb25maXNjYXRpb24gY291cnQgaW50ZXJhY3RzIHdpdGguCiAgICBIYXZ2ZW4gcHVibGljIGhhdnZlbjsKICAgIEV0aGVyTm9taW4gcHVibGljIG5vbWluOwoKICAgIC8vIFRoZSBtaW5pbXVtIGhhdnZlbiBiYWxhbmNlIHJlcXVpcmVkIHRvIGJlIGNvbnNpZGVyZWQgdG8gaGF2ZSBzdGFuZGluZwogICAgLy8gdG8gYmVnaW4gY29uZmlzY2F0aW9uIHByb2NlZWRpbmdzLgogICAgdWludCBwdWJsaWMgbWluU3RhbmRpbmdCYWxhbmNlID0gMTAwICogVU5JVDsKCiAgICAvLyBUaGUgdm90aW5nIHBlcmlvZCBsYXN0cyBmb3IgdGhpcyBkdXJhdGlvbiwKICAgIC8vIGFuZCBpZiBzZXQsIG11c3QgZmFsbCB3aXRoaW4gdGhlIGdpdmVuIGJvdW5kcy4KICAgIHVpbnQgcHVibGljIHZvdGluZ1BlcmlvZCA9IDEgd2Vla3M7CiAgICB1aW50IGNvbnN0YW50IE1JTl9WT1RJTkdfUEVSSU9EID0gMyBkYXlzOwogICAgdWludCBjb25zdGFudCBNQVhfVk9USU5HX1BFUklPRCA9IDQgd2Vla3M7CgogICAgLy8gRHVyYXRpb24gb2YgdGhlIHBlcmlvZCBkdXJpbmcgd2hpY2ggdGhlIGZvdW5kYXRpb24gbWF5IGNvbmZpcm0KICAgIC8vIG9yIHZldG8gYSBtb3Rpb24gdGhhdCBoYXMgY29uY2x1ZGVkLgogICAgLy8gSWYgc2V0LCB0aGUgY29uZmlybWF0aW9uIGR1cmF0aW9uIG11c3QgZmFsbCB3aXRoaW4gdGhlIGdpdmVuIGJvdW5kcy4KICAgIHVpbnQgcHVibGljIGNvbmZpcm1hdGlvblBlcmlvZCA9IDEgd2Vla3M7CiAgICB1aW50IGNvbnN0YW50IE1JTl9DT05GSVJNQVRJT05fUEVSSU9EID0gMSBkYXlzOwogICAgdWludCBjb25zdGFudCBNQVhfQ09ORklSTUFUSU9OX1BFUklPRCA9IDIgd2Vla3M7CgogICAgLy8gTm8gZmV3ZXIgdGhhbiB0aGlzIGZyYWN0aW9uIG9mIGhhdnZlbnMgbXVzdCBwYXJ0aWNpcGF0ZSBpbiBhIG1vdGlvbgogICAgLy8gaW4gb3JkZXIgZm9yIGEgcXVvcnVtIHRvIGJlIHJlYWNoZWQuCiAgICAvLyBUaGUgcGFydGljaXBhdGlvbiBmcmFjdGlvbiByZXF1aXJlZCBtYXkgYmUgc2V0IG5vIGxvd2VyIHRoYW4gMTAlLgogICAgdWludCBwdWJsaWMgcmVxdWlyZWRQYXJ0aWNpcGF0aW9uID0gMyAqIFVOSVQgLyAxMDsKICAgIHVpbnQgY29uc3RhbnQgTUlOX1JFUVVJUkVEX1BBUlRJQ0lQQVRJT04gPSBVTklUIC8gMTA7CgogICAgLy8gQXQgbGVhc3QgdGhpcyBmcmFjdGlvbiBvZiBwYXJ0aWNpcGF0aW5nIHZvdGVzIG11c3QgYmUgaW4gZmF2b3VyIG9mCiAgICAvLyBjb25maXNjYXRpb24gZm9yIHRoZSBtb3Rpb24gdG8gcGFzcy4KICAgIC8vIFRoZSByZXF1aXJlZCBtYWpvcml0eSBtYXkgYmUgbm8gbG93ZXIgdGhhbiA1MCUuCiAgICB1aW50IHB1YmxpYyByZXF1aXJlZE1ham9yaXR5ID0gKDIgKiBVTklUKSAvIDM7CiAgICB1aW50IGNvbnN0YW50IE1JTl9SRVFVSVJFRF9NQUpPUklUWSA9IFVOSVQgLyAyOwoKICAgIC8vIFRoZSBuZXh0IElEIHRvIHVzZSBmb3Igb3BlbmluZyBhIG1vdGlvbi4KICAgIHVpbnQgbmV4dE1vdGlvbklEID0gMTsKCiAgICAvLyBNYXBwaW5nIGZyb20gbW90aW9uIElEcyB0byB0YXJnZXQgYWRkcmVzc2VzLgogICAgbWFwcGluZyh1aW50ID0+IGFkZHJlc3MpIHB1YmxpYyBtb3Rpb25UYXJnZXQ7CgogICAgLy8gVGhlIElEIGEgbW90aW9uIG9uIGFuIGFkZHJlc3MgaXMgY3VycmVudGx5IG9wZXJhdGluZyBhdC4KICAgIC8vIFplcm8gaWYgbm8gc3VjaCBtb3Rpb24gaXMgcnVubmluZy4KICAgIG1hcHBpbmcoYWRkcmVzcyA9PiB1aW50KSBwdWJsaWMgdGFyZ2V0TW90aW9uSUQ7CgogICAgLy8gVGhlIHRpbWVzdGFtcCBhdCB3aGljaCBhIG1vdGlvbiBiZWdhbi4gVGhpcyBpcyB1c2VkIHRvIGRldGVybWluZQogICAgLy8gd2hldGhlciBhIG1vdGlvbiBpczogcnVubmluZywgaW4gdGhlIGNvbmZpcm1hdGlvbiBwZXJpb2QsCiAgICAvLyBvciBoYXMgY29uY2x1ZGVkLgogICAgLy8gQSBtb3Rpb24gcnVucyBmcm9tIGl0cyBzdGFydCB0aW1lIHQgdW50aWwgKHQgKyB2b3RpbmdQZXJpb2QpLAogICAgLy8gYW5kIHRoZW4gdGhlIGNvbmZpcm1hdGlvbiBwZXJpb2QgdGVybWluYXRlcyBubyBsYXRlciB0aGFuCiAgICAvLyAodCArIHZvdGluZ1BlcmlvZCArIGNvbmZpcm1hdGlvblBlcmlvZCkuCiAgICBtYXBwaW5nKHVpbnQgPT4gdWludCkgcHVibGljIG1vdGlvblN0YXJ0VGltZTsKCiAgICAvLyBUaGUgdGFsbGllcyBmb3IgYW5kIGFnYWluc3QgY29uZmlzY2F0aW9uIG9mIGEgZ2l2ZW4gYmFsYW5jZS4KICAgIC8vIFRoZXNlIGFyZSBzZXQgdG8gemVybyBhdCB0aGUgc3RhcnQgb2YgYSBtb3Rpb24sIGFuZCBhbHNvIG9uIGNvbmNsdXNpb24sCiAgICAvLyBqdXN0IHRvIGtlZXAgdGhlIHN0YXRlIGNsZWFuLgogICAgbWFwcGluZyh1aW50ID0+IHVpbnQpIHB1YmxpYyB2b3Rlc0ZvcjsKICAgIG1hcHBpbmcodWludCA9PiB1aW50KSBwdWJsaWMgdm90ZXNBZ2FpbnN0OwoKICAgIC8vIFRoZSBsYXN0L3BlbnVsdGltYXRlIGF2ZXJhZ2UgYmFsYW5jZSBvZiBhIHVzZXIgYXQgdGhlIHRpbWUgdGhleSB2b3RlZAogICAgLy8gaW4gYSBwYXJ0aWN1bGFyIG1vdGlvbi4KICAgIC8vIElmIHdlIGRpZCBub3Qgc2F2ZSB0aGlzIGluZm9ybWF0aW9uIHRoZW4gd2Ugd291bGQgaGF2ZSB0bwogICAgLy8gZGlzYWxsb3cgdHJhbnNmZXJzIGludG8gYW4gYWNjb3VudCBsZXN0IGl0IGNhbmNlbCBhIHZvdGUKICAgIC8vIHdpdGggZ3JlYXRlciB3ZWlnaHQgdGhhbiB0aGF0IHdpdGggd2hpY2ggaXQgb3JpZ2luYWxseSB2b3RlZCwKICAgIC8vIGFuZCB0aGUgZmVlIHBlcmlvZCByb2xsZWQgb3ZlciBpbiBiZXR3ZWVuLgogICAgbWFwcGluZyhhZGRyZXNzID0+IG1hcHBpbmcodWludCA9PiB1aW50KSkgdm90ZVdlaWdodDsKCiAgICAvLyBUaGUgcG9zc2libGUgdm90ZSB0eXBlcy4KICAgIC8vIEFic3RlbnRpb246IG5vdCBwYXJ0aWNpcGF0aW5nIGluIGEgbW90aW9uOyBUaGlzIGlzIHRoZSBkZWZhdWx0IHZhbHVlLgogICAgLy8gWWVhOiB2b3RpbmcgaW4gZmF2b3VyIG9mIGEgbW90aW9uLgogICAgLy8gTmF5OiB2b3RpbmcgYWdhaW5zdCBhIG1vdGlvbi4KICAgIGVudW0gVm90ZSB7QWJzdGVudGlvbiwgWWVhLCBOYXl9CgogICAgLy8gQSBnaXZlbiBhY2NvdW50J3Mgdm90ZSBpbiBzb21lIGNvbmZpc2NhdGlvbiBtb3Rpb24uCiAgICAvLyBUaGlzIHJlcXVpcmVzIHRoZSBkZWZhdWx0IHZhbHVlIG9mIHRoZSBWb3RlIGVudW0gdG8gY29ycmVzcG9uZCB0byBhbiBhYnN0ZW50aW9uLgogICAgbWFwcGluZyhhZGRyZXNzID0+IG1hcHBpbmcodWludCA9PiBWb3RlKSkgcHVibGljIHZvdGU7CgogICAgLyogPT09PT09PT09PSBDT05TVFJVQ1RPUiA9PT09PT09PT09ICovCgogICAgZnVuY3Rpb24gQ291cnQoSGF2dmVuIF9oYXZ2ZW4sIEV0aGVyTm9taW4gX25vbWluLCBhZGRyZXNzIF9vd25lcikKICAgICAgICBPd25lZChfb3duZXIpCiAgICAgICAgcHVibGljCiAgICB7CiAgICAgICAgaGF2dmVuID0gX2hhdnZlbjsKICAgICAgICBub21pbiA9IF9ub21pbjsKICAgIH0KCgogICAgLyogPT09PT09PT09PSBTRVRURVJTID09PT09PT09PT0gKi8KCiAgICBmdW5jdGlvbiBzZXRNaW5TdGFuZGluZ0JhbGFuY2UodWludCBiYWxhbmNlKQogICAgICAgIGV4dGVybmFsCiAgICAgICAgb25seU93bmVyCiAgICB7CiAgICAgICAgLy8gTm8gcmVxdWlyZW1lbnQgb24gdGhlIHN0YW5kaW5nIHRocmVzaG9sZCBoZXJlOwogICAgICAgIC8vIHRoZSBmb3VuZGF0aW9uIGNhbiBzZXQgdGhpcyB2YWx1ZSBzdWNoIHRoYXQKICAgICAgICAvLyBhbnlvbmUgb3Igbm8gb25lIGNhbiBhY3R1YWxseSBzdGFydCBhIG1vdGlvbi4KICAgICAgICBtaW5TdGFuZGluZ0JhbGFuY2UgPSBiYWxhbmNlOwogICAgfQoKICAgIGZ1bmN0aW9uIHNldFZvdGluZ1BlcmlvZCh1aW50IGR1cmF0aW9uKQogICAgICAgIGV4dGVybmFsCiAgICAgICAgb25seU93bmVyCiAgICB7CiAgICAgICAgcmVxdWlyZShNSU5fVk9USU5HX1BFUklPRCA8PSBkdXJhdGlvbiAmJgogICAgICAgICAgICAgICAgZHVyYXRpb24gPD0gTUFYX1ZPVElOR19QRVJJT0QpOwogICAgICAgIC8vIFJlcXVpcmUgdGhhdCB0aGUgdm90aW5nIHBlcmlvZCBpcyBubyBsb25nZXIgdGhhbiBhIHNpbmdsZSBmZWUgcGVyaW9kLAogICAgICAgIC8vIFNvIHRoYXQgYSBzaW5nbGUgdm90ZSBjYW4gc3BhbiBhdCBtb3N0IHR3byBmZWUgcGVyaW9kcy4KICAgICAgICByZXF1aXJlKGR1cmF0aW9uIDw9IGhhdnZlbi50YXJnZXRGZWVQZXJpb2REdXJhdGlvblNlY29uZHMoKSk7CiAgICAgICAgdm90aW5nUGVyaW9kID0gZHVyYXRpb247CiAgICB9CgogICAgZnVuY3Rpb24gc2V0Q29uZmlybWF0aW9uUGVyaW9kKHVpbnQgZHVyYXRpb24pCiAgICAgICAgZXh0ZXJuYWwKICAgICAgICBvbmx5T3duZXIKICAgIHsKICAgICAgICByZXF1aXJlKE1JTl9DT05GSVJNQVRJT05fUEVSSU9EIDw9IGR1cmF0aW9uICYmCiAgICAgICAgICAgICAgICBkdXJhdGlvbiA8PSBNQVhfQ09ORklSTUFUSU9OX1BFUklPRCk7CiAgICAgICAgY29uZmlybWF0aW9uUGVyaW9kID0gZHVyYXRpb247CiAgICB9CgogICAgZnVuY3Rpb24gc2V0UmVxdWlyZWRQYXJ0aWNpcGF0aW9uKHVpbnQgZnJhY3Rpb24pCiAgICAgICAgZXh0ZXJuYWwKICAgICAgICBvbmx5T3duZXIKICAgIHsKICAgICAgICByZXF1aXJlKE1JTl9SRVFVSVJFRF9QQVJUSUNJUEFUSU9OIDw9IGZyYWN0aW9uKTsKICAgICAgICByZXF1aXJlZFBhcnRpY2lwYXRpb24gPSBmcmFjdGlvbjsKICAgIH0KCiAgICBmdW5jdGlvbiBzZXRSZXF1aXJlZE1ham9yaXR5KHVpbnQgZnJhY3Rpb24pCiAgICAgICAgZXh0ZXJuYWwKICAgICAgICBvbmx5T3duZXIKICAgIHsKICAgICAgICByZXF1aXJlKE1JTl9SRVFVSVJFRF9NQUpPUklUWSA8PSBmcmFjdGlvbik7CiAgICAgICAgcmVxdWlyZWRNYWpvcml0eSA9IGZyYWN0aW9uOwogICAgfQoKCiAgICAvKiA9PT09PT09PT09IFZJRVcgRlVOQ1RJT05TID09PT09PT09PT0gKi8KCiAgICAvKiBUaGVyZSBpcyBhIG1vdGlvbiBpbiBwcm9ncmVzcyBvbiB0aGUgc3BlY2lmaWVkCiAgICAgKiBhY2NvdW50LCBhbmQgdm90ZXMgYXJlIGJlaW5nIGFjY2VwdGVkIGluIHRoYXQgbW90aW9uLiAqLwogICAgZnVuY3Rpb24gbW90aW9uVm90aW5nKHVpbnQgbW90aW9uSUQpCiAgICAgICAgcHVibGljCiAgICAgICAgdmlldwogICAgICAgIHJldHVybnMgKGJvb2wpCiAgICB7CiAgICAgICAgLy8gTm8gbmVlZCB0byBjaGVjayAoc3RhcnRUaW1lIDwgbm93KSBhcyB0aGVyZSBpcyBubyB3YXkKICAgICAgICAvLyB0byBzZXQgZnV0dXJlIHN0YXJ0IHRpbWVzIGZvciB2b3Rlcy4KICAgICAgICAvLyBUaGVzZSB2YWx1ZXMgYXJlIHRpbWVzdGFtcHMsIHRoZXkgd2lsbCBub3Qgb3ZlcmZsb3cKICAgICAgICAvLyBhcyB0aGV5IGNhbiBvbmx5IGV2ZXIgYmUgaW5pdGlhbGlzZWQgdG8gcmVsYXRpdmVseSBzbWFsbCB2YWx1ZXMuCiAgICAgICAgcmV0dXJuIG5vdyA8IG1vdGlvblN0YXJ0VGltZVttb3Rpb25JRF0gKyB2b3RpbmdQZXJpb2Q7CiAgICB9CgogICAgLyogQSB2b3RlIG9uIHRoZSB0YXJnZXQgYWNjb3VudCBoYXMgY29uY2x1ZGVkLCBidXQgdGhlIG1vdGlvbgogICAgICogaGFzIG5vdCB5ZXQgYmVlbiBhcHByb3ZlZCwgdmV0b2VkLCBvciBjbG9zZWQuICovCiAgICBmdW5jdGlvbiBtb3Rpb25Db25maXJtaW5nKHVpbnQgbW90aW9uSUQpCiAgICAgICAgcHVibGljCiAgICAgICAgdmlldwogICAgICAgIHJldHVybnMgKGJvb2wpCiAgICB7CiAgICAgICAgLy8gVGhlc2UgdmFsdWVzIGFyZSB0aW1lc3RhbXBzLCB0aGV5IHdpbGwgbm90IG92ZXJmbG93CiAgICAgICAgLy8gYXMgdGhleSBjYW4gb25seSBldmVyIGJlIGluaXRpYWxpc2VkIHRvIHJlbGF0aXZlbHkgc21hbGwgdmFsdWVzLgogICAgICAgIHVpbnQgc3RhcnRUaW1lID0gbW90aW9uU3RhcnRUaW1lW21vdGlvbklEXTsKICAgICAgICByZXR1cm4gc3RhcnRUaW1lICsgdm90aW5nUGVyaW9kIDw9IG5vdyAmJgogICAgICAgICAgICAgICBub3cgPCBzdGFydFRpbWUgKyB2b3RpbmdQZXJpb2QgKyBjb25maXJtYXRpb25QZXJpb2Q7CiAgICB9CgogICAgLyogQSB2b3RlIG1vdGlvbiBlaXRoZXIgbm90IGJlZ3VuLCBvciBpdCBoYXMgY29tcGxldGVseSB0ZXJtaW5hdGVkLiAqLwogICAgZnVuY3Rpb24gbW90aW9uV2FpdGluZyh1aW50IG1vdGlvbklEKQogICAgICAgIHB1YmxpYwogICAgICAgIHZpZXcKICAgICAgICByZXR1cm5zIChib29sKQogICAgewogICAgICAgIC8vIFRoZXNlIHZhbHVlcyBhcmUgdGltZXN0YW1wcywgdGhleSB3aWxsIG5vdCBvdmVyZmxvdwogICAgICAgIC8vIGFzIHRoZXkgY2FuIG9ubHkgZXZlciBiZSBpbml0aWFsaXNlZCB0byByZWxhdGl2ZWx5IHNtYWxsIHZhbHVlcy4KICAgICAgICByZXR1cm4gbW90aW9uU3RhcnRUaW1lW21vdGlvbklEXSArIHZvdGluZ1BlcmlvZCArIGNvbmZpcm1hdGlvblBlcmlvZCA8PSBub3c7CiAgICB9CgogICAgLyogSWYgdGhlIG1vdGlvbiB3YXMgdG8gdGVybWluYXRlIGF0IHRoaXMgaW5zdGFudCwgaXQgd291bGQgcGFzcy4KICAgICAqIFRoYXQgaXM6IHRoZXJlIHdhcyBzdWZmaWNpZW50IHBhcnRpY2lwYXRpb24gYW5kIGEgc2l6ZWFibGUgZW5vdWdoIG1ham9yaXR5LiAqLwogICAgZnVuY3Rpb24gbW90aW9uUGFzc2VzKHVpbnQgbW90aW9uSUQpCiAgICAgICAgcHVibGljCiAgICAgICAgdmlldwogICAgICAgIHJldHVybnMgKGJvb2wpCiAgICB7CiAgICAgICAgdWludCB5ZWFzID0gdm90ZXNGb3JbbW90aW9uSURdOwogICAgICAgIHVpbnQgbmF5cyA9IHZvdGVzQWdhaW5zdFttb3Rpb25JRF07CiAgICAgICAgdWludCB0b3RhbFZvdGVzID0gc2FmZUFkZCh5ZWFzLCBuYXlzKTsKCiAgICAgICAgaWYgKHRvdGFsVm90ZXMgPT0gMCkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICB1aW50IHBhcnRpY2lwYXRpb24gPSBzYWZlRGl2X2RlYyh0b3RhbFZvdGVzLCBoYXZ2ZW4udG90YWxTdXBwbHkoKSk7CiAgICAgICAgdWludCBmcmFjdGlvbkluRmF2b3VyID0gc2FmZURpdl9kZWMoeWVhcywgdG90YWxWb3Rlcyk7CgogICAgICAgIC8vIFdlIHJlcXVpcmUgdGhlIHJlc3VsdCB0byBiZSBzdHJpY3RseSBncmVhdGVyIHRoYW4gdGhlIHJlcXVpcmVtZW50CiAgICAgICAgLy8gdG8gZW5mb3JjZSBhIG1ham9yaXR5IGJlaW5nICI1MCUgKyAxIiwgYW5kIHNvIG9uLgogICAgICAgIHJldHVybiBwYXJ0aWNpcGF0aW9uID4gcmVxdWlyZWRQYXJ0aWNpcGF0aW9uICYmCiAgICAgICAgICAgICAgIGZyYWN0aW9uSW5GYXZvdXIgPiByZXF1aXJlZE1ham9yaXR5OwogICAgfQoKICAgIGZ1bmN0aW9uIGhhc1ZvdGVkKGFkZHJlc3MgYWNjb3VudCwgdWludCBtb3Rpb25JRCkKICAgICAgICBwdWJsaWMKICAgICAgICB2aWV3CiAgICAgICAgcmV0dXJucyAoYm9vbCkKICAgIHsKICAgICAgICByZXR1cm4gdm90ZVthY2NvdW50XVttb3Rpb25JRF0gIT0gVm90ZS5BYnN0ZW50aW9uOwogICAgfQoKCiAgICAvKiA9PT09PT09PT09IE1VVEFUSVZFIEZVTkNUSU9OUyA9PT09PT09PT09ICovCgogICAgLyogQmVnaW4gYSBtb3Rpb24gdG8gY29uZmlzY2F0ZSB0aGUgZnVuZHMgaW4gYSBnaXZlbiBub21pbiBhY2NvdW50LgogICAgICogT25seSB0aGUgZm91bmRhdGlvbiwgb3IgYWNjb3VudHMgd2l0aCBzdWZmaWNpZW50IGhhdnZlbiBiYWxhbmNlcwogICAgICogbWF5IGVsZWN0IHRvIHN0YXJ0IHN1Y2ggYSBtb3Rpb24uCiAgICAgKiBSZXR1cm5zIHRoZSBJRCBvZiB0aGUgbW90aW9uIHRoYXQgd2FzIGJlZ3VuLiAqLwogICAgZnVuY3Rpb24gYmVnaW5Nb3Rpb24oYWRkcmVzcyB0YXJnZXQpCiAgICAgICAgZXh0ZXJuYWwKICAgICAgICByZXR1cm5zICh1aW50KQogICAgewogICAgICAgIC8vIEEgY29uZmlzY2F0aW9uIG1vdGlvbiBtdXN0IGJlIG1vb3RlZCBieSBzb21lb25lIHdpdGggc3RhbmRpbmcuCiAgICAgICAgcmVxdWlyZSgoaGF2dmVuLmJhbGFuY2VPZihtc2cuc2VuZGVyKSA+PSBtaW5TdGFuZGluZ0JhbGFuY2UpIHx8CiAgICAgICAgICAgICAgICBtc2cuc2VuZGVyID09IG93bmVyKTsKCiAgICAgICAgLy8gUmVxdWlyZSB0aGF0IHRoZSB2b3RpbmcgcGVyaW9kIGlzIGxvbmdlciB0aGFuIGEgc2luZ2xlIGZlZSBwZXJpb2QsCiAgICAgICAgLy8gU28gdGhhdCBhIHNpbmdsZSB2b3RlIGNhbiBzcGFuIGF0IG1vc3QgdHdvIGZlZSBwZXJpb2RzLgogICAgICAgIHJlcXVpcmUodm90aW5nUGVyaW9kIDw9IGhhdnZlbi50YXJnZXRGZWVQZXJpb2REdXJhdGlvblNlY29uZHMoKSk7CgogICAgICAgIC8vIFRoZXJlIG11c3QgYmUgbm8gY29uZmlzY2F0aW9uIG1vdGlvbiBhbHJlYWR5IHJ1bm5pbmcgZm9yIHRoaXMgYWNjb3VudC4KICAgICAgICByZXF1aXJlKHRhcmdldE1vdGlvbklEW3RhcmdldF0gPT0gMCk7CgogICAgICAgIC8vIERpc2FsbG93IHZvdGVzIG9uIGFjY291bnRzIHRoYXQgaGF2ZSBwcmV2aW91c2x5IGJlZW4gZnJvemVuLgogICAgICAgIHJlcXVpcmUoIW5vbWluLmZyb3plbih0YXJnZXQpKTsKCiAgICAgICAgdWludCBtb3Rpb25JRCA9IG5leHRNb3Rpb25JRCsrOwogICAgICAgIG1vdGlvblRhcmdldFttb3Rpb25JRF0gPSB0YXJnZXQ7CiAgICAgICAgdGFyZ2V0TW90aW9uSURbdGFyZ2V0XSA9IG1vdGlvbklEOwoKICAgICAgICBtb3Rpb25TdGFydFRpbWVbbW90aW9uSURdID0gbm93OwogICAgICAgIGVtaXQgTW90aW9uQmVndW4obXNnLnNlbmRlciwgbXNnLnNlbmRlciwgdGFyZ2V0LCB0YXJnZXQsIG1vdGlvbklELCBtb3Rpb25JRCk7CgogICAgICAgIHJldHVybiBtb3Rpb25JRDsKICAgIH0KCiAgICAvKiBTaGFyZWQgdm90ZSBzZXR1cCBmdW5jdGlvbiBiZXR3ZWVuIHZvdGVGb3IgYW5kIHZvdGVBZ2FpbnN0LgogICAgICogUmV0dXJucyB0aGUgdm90ZXIncyB2b3RlIHdlaWdodC4gKi8KICAgIGZ1bmN0aW9uIHNldHVwVm90ZSh1aW50IG1vdGlvbklEKQogICAgICAgIGludGVybmFsCiAgICAgICAgcmV0dXJucyAodWludCkKICAgIHsKICAgICAgICAvLyBUaGVyZSBtdXN0IGJlIGFuIGFjdGl2ZSB2b3RlIGZvciB0aGlzIHRhcmdldCBydW5uaW5nLgogICAgICAgIC8vIFZvdGUgdG90YWxzIG11c3Qgb25seSBjaGFuZ2UgZHVyaW5nIHRoZSB2b3RpbmcgcGhhc2UuCiAgICAgICAgcmVxdWlyZShtb3Rpb25Wb3RpbmcobW90aW9uSUQpKTsKCiAgICAgICAgLy8gVGhlIHZvdGVyIG11c3Qgbm90IGhhdmUgYW4gYWN0aXZlIHZvdGUgdGhpcyBtb3Rpb24uCiAgICAgICAgcmVxdWlyZSghaGFzVm90ZWQobXNnLnNlbmRlciwgbW90aW9uSUQpKTsKCiAgICAgICAgLy8gVGhlIHZvdGVyIG1heSBub3QgY2FzdCB2b3RlcyBvbiB0aGVtc2VsdmVzLgogICAgICAgIHJlcXVpcmUobXNnLnNlbmRlciAhPSBtb3Rpb25UYXJnZXRbbW90aW9uSURdKTsKCiAgICAgICAgLy8gRW5zdXJlIHRoZSB2b3RlcidzIHZvdGUgd2VpZ2h0IGlzIGN1cnJlbnQuCiAgICAgICAgaGF2dmVuLnJlY29tcHV0ZUFjY291bnRMYXN0QXZlcmFnZUJhbGFuY2UobXNnLnNlbmRlcik7CgogICAgICAgIHVpbnQgd2VpZ2h0OwogICAgICAgIC8vIFdlIHVzZSBhIGZlZSBwZXJpb2QgZ3VhcmFudGVlZCB0byBoYXZlIHRlcm1pbmF0ZWQgYmVmb3JlCiAgICAgICAgLy8gdGhlIHN0YXJ0IG9mIHRoZSB2b3RlLiBTZWxlY3QgdGhlIHJpZ2h0IHBlcmlvZCBpZgogICAgICAgIC8vIGEgZmVlIHBlcmlvZCByb2xscyBvdmVyIGluIHRoZSBtaWRkbGUgb2YgdGhlIHZvdGUuCiAgICAgICAgaWYgKG1vdGlvblN0YXJ0VGltZVttb3Rpb25JRF0gPCBoYXZ2ZW4uZmVlUGVyaW9kU3RhcnRUaW1lKCkpIHsKICAgICAgICAgICAgd2VpZ2h0ID0gaGF2dmVuLnBlbnVsdGltYXRlQXZlcmFnZUJhbGFuY2UobXNnLnNlbmRlcik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgd2VpZ2h0ID0gaGF2dmVuLmxhc3RBdmVyYWdlQmFsYW5jZShtc2cuc2VuZGVyKTsKICAgICAgICB9CgogICAgICAgIC8vIFVzZXJzIG11c3QgaGF2ZSBhIG5vbnplcm8gdm90aW5nIHdlaWdodCB0byB2b3RlLgogICAgICAgIHJlcXVpcmUod2VpZ2h0ID4gMCk7CgogICAgICAgIHZvdGVXZWlnaHRbbXNnLnNlbmRlcl1bbW90aW9uSURdID0gd2VpZ2h0OwoKICAgICAgICByZXR1cm4gd2VpZ2h0OwogICAgfQoKICAgIC8qIFRoZSBzZW5kZXIgY2FzdHMgYSB2b3RlIGluIGZhdm91ciBvZiBjb25maXNjYXRpb24gb2YgdGhlCiAgICAgKiB0YXJnZXQgYWNjb3VudCdzIG5vbWluIGJhbGFuY2UuICovCiAgICBmdW5jdGlvbiB2b3RlRm9yKHVpbnQgbW90aW9uSUQpCiAgICAgICAgZXh0ZXJuYWwKICAgIHsKICAgICAgICB1aW50IHdlaWdodCA9IHNldHVwVm90ZShtb3Rpb25JRCk7CiAgICAgICAgdm90ZVttc2cuc2VuZGVyXVttb3Rpb25JRF0gPSBWb3RlLlllYTsKICAgICAgICB2b3Rlc0Zvclttb3Rpb25JRF0gPSBzYWZlQWRkKHZvdGVzRm9yW21vdGlvbklEXSwgd2VpZ2h0KTsKICAgICAgICBlbWl0IFZvdGVkRm9yKG1zZy5zZW5kZXIsIG1zZy5zZW5kZXIsIG1vdGlvbklELCBtb3Rpb25JRCwgd2VpZ2h0KTsKICAgIH0KCiAgICAvKiBUaGUgc2VuZGVyIGNhc3RzIGEgdm90ZSBhZ2FpbnN0IGNvbmZpc2NhdGlvbiBvZiB0aGUKICAgICAqIHRhcmdldCBhY2NvdW50J3Mgbm9taW4gYmFsYW5jZS4gKi8KICAgIGZ1bmN0aW9uIHZvdGVBZ2FpbnN0KHVpbnQgbW90aW9uSUQpCiAgICAgICAgZXh0ZXJuYWwKICAgIHsKICAgICAgICB1aW50IHdlaWdodCA9IHNldHVwVm90ZShtb3Rpb25JRCk7CiAgICAgICAgdm90ZVttc2cuc2VuZGVyXVttb3Rpb25JRF0gPSBWb3RlLk5heTsKICAgICAgICB2b3Rlc0FnYWluc3RbbW90aW9uSURdID0gc2FmZUFkZCh2b3Rlc0FnYWluc3RbbW90aW9uSURdLCB3ZWlnaHQpOwogICAgICAgIGVtaXQgVm90ZWRBZ2FpbnN0KG1zZy5zZW5kZXIsIG1zZy5zZW5kZXIsIG1vdGlvbklELCBtb3Rpb25JRCwgd2VpZ2h0KTsKICAgIH0KCiAgICAvKiBDYW5jZWwgYW4gZXhpc3Rpbmcgdm90ZSBieSB0aGUgc2VuZGVyIG9uIGEgbW90aW9uCiAgICAgKiB0byBjb25maXNjYXRlIHRoZSB0YXJnZXQgYmFsYW5jZS4gKi8KICAgIGZ1bmN0aW9uIGNhbmNlbFZvdGUodWludCBtb3Rpb25JRCkKICAgICAgICBleHRlcm5hbAogICAgewogICAgICAgIC8vIEFuIGFjY291bnQgbWF5IGNhbmNlbCBpdHMgdm90ZSBlaXRoZXIgYmVmb3JlIHRoZSBjb25maXJtYXRpb24gcGhhc2UKICAgICAgICAvLyB3aGVuIHRoZSBtb3Rpb24gaXMgc3RpbGwgb3Blbiwgb3IgYWZ0ZXIgdGhlIGNvbmZpcm1hdGlvbiBwaGFzZSwKICAgICAgICAvLyB3aGVuIHRoZSBtb3Rpb24gaGFzIGNvbmNsdWRlZC4KICAgICAgICAvLyBCdXQgdGhlIHRvdGFscyBtdXN0IG5vdCBjaGFuZ2UgZHVyaW5nIHRoZSBjb25maXJtYXRpb24gcGhhc2UgaXRzZWxmLgogICAgICAgIHJlcXVpcmUoIW1vdGlvbkNvbmZpcm1pbmcobW90aW9uSUQpKTsKCiAgICAgICAgVm90ZSBzZW5kZXJWb3RlID0gdm90ZVttc2cuc2VuZGVyXVttb3Rpb25JRF07CgogICAgICAgIC8vIElmIHRoZSBzZW5kZXIgaGFzIG5vdCB2b3RlZCB0aGVuIHRoZXJlIGlzIG5vIG5lZWQgdG8gdXBkYXRlIGFueXRoaW5nLgogICAgICAgIHJlcXVpcmUoc2VuZGVyVm90ZSAhPSBWb3RlLkFic3RlbnRpb24pOwoKICAgICAgICAvLyBJZiB3ZSBhcmUgbm90IHZvdGluZywgdGhlcmUgaXMgbm8gcmVhc29uIHRvIHVwZGF0ZSB0aGUgdm90ZSB0b3RhbHMuCiAgICAgICAgaWYgKG1vdGlvblZvdGluZyhtb3Rpb25JRCkpIHsKICAgICAgICAgICAgaWYgKHNlbmRlclZvdGUgPT0gVm90ZS5ZZWEpIHsKICAgICAgICAgICAgICAgIHZvdGVzRm9yW21vdGlvbklEXSA9IHNhZmVTdWIodm90ZXNGb3JbbW90aW9uSURdLCB2b3RlV2VpZ2h0W21zZy5zZW5kZXJdW21vdGlvbklEXSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBTaW5jZSB3ZSBhbHJlYWR5IGVuc3VyZWQgdGhhdCB0aGUgdm90ZSBpcyBub3QgYW4gYWJzdGVudGlvbiwKICAgICAgICAgICAgICAgIC8vIHRoZSBvbmx5IG9wdGlvbiByZW1haW5pbmcgaXMgVm90ZS5OYXkuCiAgICAgICAgICAgICAgICB2b3Rlc0FnYWluc3RbbW90aW9uSURdID0gc2FmZVN1Yih2b3Rlc0FnYWluc3RbbW90aW9uSURdLCB2b3RlV2VpZ2h0W21zZy5zZW5kZXJdW21vdGlvbklEXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gQSBjYW5jZWxsZWQgdm90ZSBpcyBvbmx5IG1lYW5pbmdmdWwgaWYgYSB2b3RlIGlzIHJ1bm5pbmcKICAgICAgICAgICAgZW1pdCBWb3RlQ2FuY2VsbGVkKG1zZy5zZW5kZXIsIG1zZy5zZW5kZXIsIG1vdGlvbklELCBtb3Rpb25JRCk7CiAgICAgICAgfQoKICAgICAgICBkZWxldGUgdm90ZVdlaWdodFttc2cuc2VuZGVyXVttb3Rpb25JRF07CiAgICAgICAgZGVsZXRlIHZvdGVbbXNnLnNlbmRlcl1bbW90aW9uSURdOwogICAgfQoKICAgIGZ1bmN0aW9uIF9jbG9zZU1vdGlvbih1aW50IG1vdGlvbklEKQogICAgICAgIGludGVybmFsCiAgICB7CiAgICAgICAgZGVsZXRlIHRhcmdldE1vdGlvbklEW21vdGlvblRhcmdldFttb3Rpb25JRF1dOwogICAgICAgIGRlbGV0ZSBtb3Rpb25UYXJnZXRbbW90aW9uSURdOwogICAgICAgIGRlbGV0ZSBtb3Rpb25TdGFydFRpbWVbbW90aW9uSURdOwogICAgICAgIGRlbGV0ZSB2b3Rlc0Zvclttb3Rpb25JRF07CiAgICAgICAgZGVsZXRlIHZvdGVzQWdhaW5zdFttb3Rpb25JRF07CiAgICAgICAgZW1pdCBNb3Rpb25DbG9zZWQobW90aW9uSUQsIG1vdGlvbklEKTsKICAgIH0KCiAgICAvKiBJZiBhIG1vdGlvbiBoYXMgY29uY2x1ZGVkLCBvciBpZiBpdCBsYXN0ZWQgaXRzIGZ1bGwgZHVyYXRpb24gYnV0IG5vdCBwYXNzZWQsCiAgICAgKiB0aGVuIGFueW9uZSBtYXkgY2xvc2UgaXQuICovCiAgICBmdW5jdGlvbiBjbG9zZU1vdGlvbih1aW50IG1vdGlvbklEKQogICAgICAgIGV4dGVybmFsCiAgICB7CiAgICAgICAgcmVxdWlyZSgobW90aW9uQ29uZmlybWluZyhtb3Rpb25JRCkgJiYgIW1vdGlvblBhc3Nlcyhtb3Rpb25JRCkpIHx8IG1vdGlvbldhaXRpbmcobW90aW9uSUQpKTsKICAgICAgICBfY2xvc2VNb3Rpb24obW90aW9uSUQpOwogICAgfQoKICAgIC8qIFRoZSBmb3VuZGF0aW9uIG1heSBvbmx5IGNvbmZpc2NhdGUgYSBiYWxhbmNlIGR1cmluZyB0aGUgY29uZmlybWF0aW9uCiAgICAgKiBwZXJpb2QgYWZ0ZXIgYSBtb3Rpb24gaGFzIHBhc3NlZC4gKi8KICAgIGZ1bmN0aW9uIGFwcHJvdmVNb3Rpb24odWludCBtb3Rpb25JRCkKICAgICAgICBleHRlcm5hbAogICAgICAgIG9ubHlPd25lcgogICAgewogICAgICAgIHJlcXVpcmUobW90aW9uQ29uZmlybWluZyhtb3Rpb25JRCkgJiYgbW90aW9uUGFzc2VzKG1vdGlvbklEKSk7CiAgICAgICAgYWRkcmVzcyB0YXJnZXQgPSBtb3Rpb25UYXJnZXRbbW90aW9uSURdOwogICAgICAgIG5vbWluLmNvbmZpc2NhdGVCYWxhbmNlKHRhcmdldCk7CiAgICAgICAgX2Nsb3NlTW90aW9uKG1vdGlvbklEKTsKICAgICAgICBlbWl0IE1vdGlvbkFwcHJvdmVkKG1vdGlvbklELCBtb3Rpb25JRCk7CiAgICB9CgogICAgLyogVGhlIGZvdW5kYXRpb24gbWF5IHZldG8gYSBtb3Rpb24gYXQgYW55IHRpbWUuICovCiAgICBmdW5jdGlvbiB2ZXRvTW90aW9uKHVpbnQgbW90aW9uSUQpCiAgICAgICAgZXh0ZXJuYWwKICAgICAgICBvbmx5T3duZXIKICAgIHsKICAgICAgICByZXF1aXJlKCFtb3Rpb25XYWl0aW5nKG1vdGlvbklEKSk7CiAgICAgICAgX2Nsb3NlTW90aW9uKG1vdGlvbklEKTsKICAgICAgICBlbWl0IE1vdGlvblZldG9lZChtb3Rpb25JRCwgbW90aW9uSUQpOwogICAgfQoKCiAgICAvKiA9PT09PT09PT09IEVWRU5UUyA9PT09PT09PT09ICovCgogICAgZXZlbnQgTW90aW9uQmVndW4oYWRkcmVzcyBpbml0aWF0b3IsIGFkZHJlc3MgaW5kZXhlZCBpbml0aWF0b3JJbmRleCwgYWRkcmVzcyB0YXJnZXQsIGFkZHJlc3MgaW5kZXhlZCB0YXJnZXRJbmRleCwgdWludCBtb3Rpb25JRCwgdWludCBpbmRleGVkIG1vdGlvbklESW5kZXgpOwoKICAgIGV2ZW50IFZvdGVkRm9yKGFkZHJlc3Mgdm90ZXIsIGFkZHJlc3MgaW5kZXhlZCB2b3RlckluZGV4LCB1aW50IG1vdGlvbklELCB1aW50IGluZGV4ZWQgbW90aW9uSURJbmRleCwgdWludCB3ZWlnaHQpOwoKICAgIGV2ZW50IFZvdGVkQWdhaW5zdChhZGRyZXNzIHZvdGVyLCBhZGRyZXNzIGluZGV4ZWQgdm90ZXJJbmRleCwgdWludCBtb3Rpb25JRCwgdWludCBpbmRleGVkIG1vdGlvbklESW5kZXgsIHVpbnQgd2VpZ2h0KTsKCiAgICBldmVudCBWb3RlQ2FuY2VsbGVkKGFkZHJlc3Mgdm90ZXIsIGFkZHJlc3MgaW5kZXhlZCB2b3RlckluZGV4LCB1aW50IG1vdGlvbklELCB1aW50IGluZGV4ZWQgbW90aW9uSURJbmRleCk7CgogICAgZXZlbnQgTW90aW9uQ2xvc2VkKHVpbnQgbW90aW9uSUQsIHVpbnQgaW5kZXhlZCBtb3Rpb25JREluZGV4KTsKCiAgICBldmVudCBNb3Rpb25WZXRvZWQodWludCBtb3Rpb25JRCwgdWludCBpbmRleGVkIG1vdGlvbklESW5kZXgpOwoKICAgIGV2ZW50IE1vdGlvbkFwcHJvdmVkKHVpbnQgbW90aW9uSUQsIHVpbnQgaW5kZXhlZCBtb3Rpb25JREluZGV4KTsKfQoKLyoKLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KQ09OVFJBQ1QgREVTQ1JJUFRJT04KLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KCkEgdG9rZW4gd2hpY2ggYWxzbyBoYXMgYSBjb25maWd1cmFibGUgZmVlIHJhdGUKY2hhcmdlZCBvbiBpdHMgdHJhbnNmZXJzLiBUaGlzIGlzIGRlc2lnbmVkIHRvIGJlIG92ZXJyaWRkZW4gaW4Kb3JkZXIgdG8gcHJvZHVjZSBhbiBFUkMyMC1jb21wbGlhbnQgdG9rZW4uCgpUaGVzZSBmZWVzIGFjY3J1ZSBpbnRvIGEgcG9vbCwgZnJvbSB3aGljaCBhIG5vbWluYXRlZCBhdXRob3JpdHkKbWF5IHdpdGhkcmF3LgoKVGhpcyBjb250cmFjdCB1dGlsaXNlcyBhIHN0YXRlIGZvciB1cGdyYWRhYmlsaXR5IHB1cnBvc2VzLgpJdCByZWxpZXMgb24gYmVpbmcgY2FsbGVkIHVuZGVybmVhdGggYSBwcm94eSBjb250cmFjdCwgYXMKaW5jbHVkZWQgaW4gUHJveHkuc29sLgoKLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KKi8KCmNvbnRyYWN0IEV4dGVyblN0YXRlUHJveHlGZWVUb2tlbiBpcyBQcm94eWFibGUsIFNhZmVEZWNpbWFsTWF0aCB7CgogICAgLyogPT09PT09PT09PSBTVEFURSBWQVJJQUJMRVMgPT09PT09PT09PSAqLwoKICAgIC8vIFN0b3JlcyBiYWxhbmNlcyBhbmQgYWxsb3dhbmNlcy4KICAgIFRva2VuU3RhdGUgcHVibGljIHN0YXRlOwoKICAgIC8vIE90aGVyIEVSQzIwIGZpZWxkcwogICAgc3RyaW5nIHB1YmxpYyBuYW1lOwogICAgc3RyaW5nIHB1YmxpYyBzeW1ib2w7CiAgICB1aW50IHB1YmxpYyB0b3RhbFN1cHBseTsKCiAgICAvLyBBIHBlcmNlbnRhZ2UgZmVlIGNoYXJnZWQgb24gZWFjaCB0cmFuc2Zlci4KICAgIHVpbnQgcHVibGljIHRyYW5zZmVyRmVlUmF0ZTsKICAgIC8vIEZlZSBtYXkgbm90IGV4Y2VlZCAxMCUuCiAgICB1aW50IGNvbnN0YW50IE1BWF9UUkFOU0ZFUl9GRUVfUkFURSA9IFVOSVQgLyAxMDsKICAgIC8vIFRoZSBhZGRyZXNzIHdpdGggdGhlIGF1dGhvcml0eSB0byBkaXN0cmlidXRlIGZlZXMuCiAgICBhZGRyZXNzIHB1YmxpYyBmZWVBdXRob3JpdHk7CgoKICAgIC8qID09PT09PT09PT0gQ09OU1RSVUNUT1IgPT09PT09PT09PSAqLwoKICAgIGZ1bmN0aW9uIEV4dGVyblN0YXRlUHJveHlGZWVUb2tlbihzdHJpbmcgX25hbWUsIHN0cmluZyBfc3ltYm9sLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVpbnQgX3RyYW5zZmVyRmVlUmF0ZSwgYWRkcmVzcyBfZmVlQXV0aG9yaXR5LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFRva2VuU3RhdGUgX3N0YXRlLCBhZGRyZXNzIF9vd25lcikKICAgICAgICBQcm94eWFibGUoX293bmVyKQogICAgICAgIHB1YmxpYwogICAgewogICAgICAgIGlmIChfc3RhdGUgPT0gVG9rZW5TdGF0ZSgwKSkgewogICAgICAgICAgICBzdGF0ZSA9IG5ldyBUb2tlblN0YXRlKF9vd25lciwgYWRkcmVzcyh0aGlzKSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3RhdGUgPSBfc3RhdGU7CiAgICAgICAgfQoKICAgICAgICBuYW1lID0gX25hbWU7CiAgICAgICAgc3ltYm9sID0gX3N5bWJvbDsKICAgICAgICBmZWVBdXRob3JpdHkgPSBfZmVlQXV0aG9yaXR5OwoKICAgICAgICByZXF1aXJlKF90cmFuc2ZlckZlZVJhdGUgPD0gTUFYX1RSQU5TRkVSX0ZFRV9SQVRFKTsKICAgICAgICB0cmFuc2ZlckZlZVJhdGUgPSBfdHJhbnNmZXJGZWVSYXRlOwogICAgfQoKICAgIC8qID09PT09PT09PT0gU0VUVEVSUyA9PT09PT09PT09ICovCgogICAgZnVuY3Rpb24gc2V0VHJhbnNmZXJGZWVSYXRlKHVpbnQgX3RyYW5zZmVyRmVlUmF0ZSkKICAgICAgICBleHRlcm5hbAogICAgICAgIG9wdGlvbmFsUHJveHlfb25seU93bmVyCiAgICB7CiAgICAgICAgcmVxdWlyZShfdHJhbnNmZXJGZWVSYXRlIDw9IE1BWF9UUkFOU0ZFUl9GRUVfUkFURSk7CiAgICAgICAgdHJhbnNmZXJGZWVSYXRlID0gX3RyYW5zZmVyRmVlUmF0ZTsKICAgICAgICBlbWl0IFRyYW5zZmVyRmVlUmF0ZVVwZGF0ZWQoX3RyYW5zZmVyRmVlUmF0ZSk7CiAgICB9CgogICAgZnVuY3Rpb24gc2V0RmVlQXV0aG9yaXR5KGFkZHJlc3MgX2ZlZUF1dGhvcml0eSkKICAgICAgICBleHRlcm5hbAogICAgICAgIG9wdGlvbmFsUHJveHlfb25seU93bmVyCiAgICB7CiAgICAgICAgZmVlQXV0aG9yaXR5ID0gX2ZlZUF1dGhvcml0eTsKICAgICAgICBlbWl0IEZlZUF1dGhvcml0eVVwZGF0ZWQoX2ZlZUF1dGhvcml0eSk7CiAgICB9CgogICAgZnVuY3Rpb24gc2V0U3RhdGUoVG9rZW5TdGF0ZSBfc3RhdGUpCiAgICAgICAgZXh0ZXJuYWwKICAgICAgICBvcHRpb25hbFByb3h5X29ubHlPd25lcgogICAgewogICAgICAgIHN0YXRlID0gX3N0YXRlOwogICAgICAgIGVtaXQgU3RhdGVVcGRhdGVkKF9zdGF0ZSk7CiAgICB9CgogICAgLyogPT09PT09PT09PSBWSUVXUyA9PT09PT09PT09ICovCgogICAgZnVuY3Rpb24gYmFsYW5jZU9mKGFkZHJlc3MgYWNjb3VudCkKICAgICAgICBwdWJsaWMKICAgICAgICB2aWV3CiAgICAgICAgcmV0dXJucyAodWludCkKICAgIHsKICAgICAgICByZXR1cm4gc3RhdGUuYmFsYW5jZU9mKGFjY291bnQpOwogICAgfQoKICAgIGZ1bmN0aW9uIGFsbG93YW5jZShhZGRyZXNzIGZyb20sIGFkZHJlc3MgdG8pCiAgICAgICAgcHVibGljCiAgICAgICAgdmlldwogICAgICAgIHJldHVybnMgKHVpbnQpCiAgICB7CiAgICAgICAgcmV0dXJuIHN0YXRlLmFsbG93YW5jZShmcm9tLCB0byk7CiAgICB9CgogICAgLy8gUmV0dXJuIHRoZSBmZWUgY2hhcmdlZCBvbiB0b3AgaW4gb3JkZXIgdG8gdHJhbnNmZXIgX3ZhbHVlIHdvcnRoIG9mIHRva2Vucy4KICAgIGZ1bmN0aW9uIHRyYW5zZmVyRmVlSW5jdXJyZWQodWludCB2YWx1ZSkKICAgICAgICBwdWJsaWMKICAgICAgICB2aWV3CiAgICAgICAgcmV0dXJucyAodWludCkKICAgIHsKICAgICAgICByZXR1cm4gc2FmZU11bF9kZWModmFsdWUsIHRyYW5zZmVyRmVlUmF0ZSk7CiAgICAgICAgLy8gVHJhbnNmZXJzIGxlc3MgdGhhbiB0aGUgcmVjaXByb2NhbCBvZiB0cmFuc2ZlckZlZVJhdGUgc2hvdWxkIGJlIGNvbXBsZXRlbHkgZWF0ZW4gdXAgYnkgZmVlcy4KICAgICAgICAvLyBUaGlzIGlzIG9uIHRoZSBiYXNpcyB0aGF0IHRyYW5zZmVycyBsZXNzIHRoYW4gdGhpcyB2YWx1ZSB3aWxsIHJlc3VsdCBpbiBhIG5pbCBmZWUuCiAgICAgICAgLy8gUHJvYmFibHkgdG9vIGluc2lnbmlmaWNhbnQgdG8gd29ycnkgYWJvdXQsIGJ1dCB0aGUgZm9sbG93aW5nIGNvZGUgd2lsbCBhY2hpZXZlIGl0LgogICAgICAgIC8vICAgICAgaWYgKGZlZSA9PSAwICYmIHRyYW5zZmVyRmVlUmF0ZSAhPSAwKSB7CiAgICAgICAgLy8gICAgICAgICAgcmV0dXJuIF92YWx1ZTsKICAgICAgICAvLyAgICAgIH0KICAgICAgICAvLyAgICAgIHJldHVybiBmZWU7CiAgICB9CgogICAgLy8gVGhlIHZhbHVlIHRoYXQgeW91IHdvdWxkIG5lZWQgdG8gc2VuZCBzbyB0aGF0IHRoZSByZWNpcGllbnQgcmVjZWl2ZXMKICAgIC8vIGEgc3BlY2lmaWVkIHZhbHVlLgogICAgZnVuY3Rpb24gdHJhbnNmZXJQbHVzRmVlKHVpbnQgdmFsdWUpCiAgICAgICAgZXh0ZXJuYWwKICAgICAgICB2aWV3CiAgICAgICAgcmV0dXJucyAodWludCkKICAgIHsKICAgICAgICByZXR1cm4gc2FmZUFkZCh2YWx1ZSwgdHJhbnNmZXJGZWVJbmN1cnJlZCh2YWx1ZSkpOwogICAgfQoKICAgIC8vIFRoZSBxdWFudGl0eSB0byBzZW5kIGluIG9yZGVyIHRoYXQgdGhlIHNlbmRlciBzcGVuZHMgYSBjZXJ0YWluIHZhbHVlIG9mIHRva2Vucy4KICAgIGZ1bmN0aW9uIHByaWNlVG9TcGVuZCh1aW50IHZhbHVlKQogICAgICAgIGV4dGVybmFsCiAgICAgICAgdmlldwogICAgICAgIHJldHVybnMgKHVpbnQpCiAgICB7CiAgICAgICAgcmV0dXJuIHNhZmVEaXZfZGVjKHZhbHVlLCBzYWZlQWRkKFVOSVQsIHRyYW5zZmVyRmVlUmF0ZSkpOwogICAgfQoKICAgIC8vIFRoZSBiYWxhbmNlIG9mIHRoZSBub21pbiBjb250cmFjdCBpdHNlbGYgaXMgdGhlIGZlZSBwb29sLgogICAgLy8gQ29sbGVjdGVkIGZlZXMgc2l0IGhlcmUgdW50aWwgdGhleSBhcmUgZGlzdHJpYnV0ZWQuCiAgICBmdW5jdGlvbiBmZWVQb29sKCkKICAgICAgICBleHRlcm5hbAogICAgICAgIHZpZXcKICAgICAgICByZXR1cm5zICh1aW50KQogICAgewogICAgICAgIHJldHVybiBzdGF0ZS5iYWxhbmNlT2YoYWRkcmVzcyh0aGlzKSk7CiAgICB9CgoKICAgIC8qID09PT09PT09PT0gTVVUQVRJVkUgRlVOQ1RJT05TID09PT09PT09PT0gKi8KCiAgICAvKiBXaGF0ZXZlciBjYWxscyB0aGlzIHNob3VsZCBoYXZlIGVpdGhlciB0aGUgb3B0aW9uYWxQcm94eSBvciBvbmx5UHJveHkgbW9kaWZpZXIsCiAgICAgKiBhbmQgcGFzcyBpbiBtZXNzYWdlU2VuZGVyLiAqLwogICAgZnVuY3Rpb24gX3RyYW5zZmVyX2J5UHJveHkoYWRkcmVzcyBzZW5kZXIsIGFkZHJlc3MgdG8sIHVpbnQgdmFsdWUpCiAgICAgICAgaW50ZXJuYWwKICAgICAgICByZXR1cm5zIChib29sKQogICAgewogICAgICAgIHJlcXVpcmUodG8gIT0gYWRkcmVzcygwKSk7CgogICAgICAgIC8vIFRoZSBmZWUgaXMgZGVkdWN0ZWQgZnJvbSB0aGUgc2VuZGVyJ3MgYmFsYW5jZSwgaW4gYWRkaXRpb24gdG8KICAgICAgICAvLyB0aGUgdHJhbnNmZXJyZWQgcXVhbnRpdHkuCiAgICAgICAgdWludCBmZWUgPSB0cmFuc2ZlckZlZUluY3VycmVkKHZhbHVlKTsKICAgICAgICB1aW50IHRvdGFsQ2hhcmdlID0gc2FmZUFkZCh2YWx1ZSwgZmVlKTsKCiAgICAgICAgLy8gSW5zdWZmaWNpZW50IGJhbGFuY2Ugd2lsbCBiZSBoYW5kbGVkIGJ5IHRoZSBzYWZlIHN1YnRyYWN0aW9uLgogICAgICAgIHN0YXRlLnNldEJhbGFuY2VPZihzZW5kZXIsIHNhZmVTdWIoc3RhdGUuYmFsYW5jZU9mKHNlbmRlciksIHRvdGFsQ2hhcmdlKSk7CiAgICAgICAgc3RhdGUuc2V0QmFsYW5jZU9mKHRvLCBzYWZlQWRkKHN0YXRlLmJhbGFuY2VPZih0byksIHZhbHVlKSk7CiAgICAgICAgc3RhdGUuc2V0QmFsYW5jZU9mKGFkZHJlc3ModGhpcyksIHNhZmVBZGQoc3RhdGUuYmFsYW5jZU9mKGFkZHJlc3ModGhpcykpLCBmZWUpKTsKCiAgICAgICAgZW1pdCBUcmFuc2ZlcihzZW5kZXIsIHRvLCB2YWx1ZSk7CiAgICAgICAgZW1pdCBUcmFuc2ZlckZlZVBhaWQoc2VuZGVyLCBmZWUpOwogICAgICAgIGVtaXQgVHJhbnNmZXIoc2VuZGVyLCBhZGRyZXNzKHRoaXMpLCBmZWUpOwoKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICAvKiBXaGF0ZXZlciBjYWxscyB0aGlzIHNob3VsZCBoYXZlIGVpdGhlciB0aGUgb3B0aW9uYWxQcm94eSBvciBvbmx5UHJveHkgbW9kaWZpZXIsCiAgICAgKiBhbmQgcGFzcyBpbiBtZXNzYWdlU2VuZGVyLiAqLwogICAgZnVuY3Rpb24gX3RyYW5zZmVyRnJvbV9ieVByb3h5KGFkZHJlc3Mgc2VuZGVyLCBhZGRyZXNzIGZyb20sIGFkZHJlc3MgdG8sIHVpbnQgdmFsdWUpCiAgICAgICAgaW50ZXJuYWwKICAgICAgICByZXR1cm5zIChib29sKQogICAgewogICAgICAgIHJlcXVpcmUodG8gIT0gYWRkcmVzcygwKSk7CgogICAgICAgIC8vIFRoZSBmZWUgaXMgZGVkdWN0ZWQgZnJvbSB0aGUgc2VuZGVyJ3MgYmFsYW5jZSwgaW4gYWRkaXRpb24gdG8KICAgICAgICAvLyB0aGUgdHJhbnNmZXJyZWQgcXVhbnRpdHkuCiAgICAgICAgdWludCBmZWUgPSB0cmFuc2ZlckZlZUluY3VycmVkKHZhbHVlKTsKICAgICAgICB1aW50IHRvdGFsQ2hhcmdlID0gc2FmZUFkZCh2YWx1ZSwgZmVlKTsKCiAgICAgICAgLy8gSW5zdWZmaWNpZW50IGJhbGFuY2Ugd2lsbCBiZSBoYW5kbGVkIGJ5IHRoZSBzYWZlIHN1YnRyYWN0aW9uLgogICAgICAgIHN0YXRlLnNldEJhbGFuY2VPZihmcm9tLCBzYWZlU3ViKHN0YXRlLmJhbGFuY2VPZihmcm9tKSwgdG90YWxDaGFyZ2UpKTsKICAgICAgICBzdGF0ZS5zZXRBbGxvd2FuY2UoZnJvbSwgc2VuZGVyLCBzYWZlU3ViKHN0YXRlLmFsbG93YW5jZShmcm9tLCBzZW5kZXIpLCB0b3RhbENoYXJnZSkpOwogICAgICAgIHN0YXRlLnNldEJhbGFuY2VPZih0bywgc2FmZUFkZChzdGF0ZS5iYWxhbmNlT2YodG8pLCB2YWx1ZSkpOwogICAgICAgIHN0YXRlLnNldEJhbGFuY2VPZihhZGRyZXNzKHRoaXMpLCBzYWZlQWRkKHN0YXRlLmJhbGFuY2VPZihhZGRyZXNzKHRoaXMpKSwgZmVlKSk7CgogICAgICAgIGVtaXQgVHJhbnNmZXIoZnJvbSwgdG8sIHZhbHVlKTsKICAgICAgICBlbWl0IFRyYW5zZmVyRmVlUGFpZChmcm9tLCBmZWUpOwogICAgICAgIGVtaXQgVHJhbnNmZXIoZnJvbSwgYWRkcmVzcyh0aGlzKSwgZmVlKTsKCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgZnVuY3Rpb24gYXBwcm92ZShhZGRyZXNzIHNwZW5kZXIsIHVpbnQgdmFsdWUpCiAgICAgICAgZXh0ZXJuYWwKICAgICAgICBvcHRpb25hbFByb3h5CiAgICAgICAgcmV0dXJucyAoYm9vbCkKICAgIHsKICAgICAgICBhZGRyZXNzIHNlbmRlciA9IG1lc3NhZ2VTZW5kZXI7CiAgICAgICAgc3RhdGUuc2V0QWxsb3dhbmNlKHNlbmRlciwgc3BlbmRlciwgdmFsdWUpOwoKICAgICAgICBlbWl0IEFwcHJvdmFsKHNlbmRlciwgc3BlbmRlciwgdmFsdWUpOwoKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICAvKiBXaXRoZHJhdyB0b2tlbnMgZnJvbSB0aGUgZmVlIHBvb2wgaW50byBhIGdpdmVuIGFjY291bnQuICovCiAgICBmdW5jdGlvbiB3aXRoZHJhd0ZlZShhZGRyZXNzIGFjY291bnQsIHVpbnQgdmFsdWUpCiAgICAgICAgZXh0ZXJuYWwKICAgICAgICByZXR1cm5zIChib29sKQogICAgewogICAgICAgIHJlcXVpcmUobXNnLnNlbmRlciA9PSBmZWVBdXRob3JpdHkgJiYgYWNjb3VudCAhPSBhZGRyZXNzKDApKTsKICAgICAgICAKICAgICAgICAvLyAwLXZhbHVlIHdpdGhkcmF3YWxzIGRvIG5vdGhpbmcuCiAgICAgICAgaWYgKHZhbHVlID09IDApIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgLy8gU2FmZSBzdWJ0cmFjdGlvbiBlbnN1cmVzIGFuIGV4Y2VwdGlvbiBpcyB0aHJvd24gaWYgdGhlIGJhbGFuY2UgaXMgaW5zdWZmaWNpZW50LgogICAgICAgIHN0YXRlLnNldEJhbGFuY2VPZihhZGRyZXNzKHRoaXMpLCBzYWZlU3ViKHN0YXRlLmJhbGFuY2VPZihhZGRyZXNzKHRoaXMpKSwgdmFsdWUpKTsKICAgICAgICBzdGF0ZS5zZXRCYWxhbmNlT2YoYWNjb3VudCwgc2FmZUFkZChzdGF0ZS5iYWxhbmNlT2YoYWNjb3VudCksIHZhbHVlKSk7CgogICAgICAgIGVtaXQgRmVlc1dpdGhkcmF3bihhY2NvdW50LCBhY2NvdW50LCB2YWx1ZSk7CiAgICAgICAgZW1pdCBUcmFuc2ZlcihhZGRyZXNzKHRoaXMpLCBhY2NvdW50LCB2YWx1ZSk7CgogICAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIC8qIERvbmF0ZSB0b2tlbnMgZnJvbSB0aGUgc2VuZGVyJ3MgYmFsYW5jZSBpbnRvIHRoZSBmZWUgcG9vbC4gKi8KICAgIGZ1bmN0aW9uIGRvbmF0ZVRvRmVlUG9vbCh1aW50IG4pCiAgICAgICAgZXh0ZXJuYWwKICAgICAgICBvcHRpb25hbFByb3h5CiAgICAgICAgcmV0dXJucyAoYm9vbCkKICAgIHsKICAgICAgICBhZGRyZXNzIHNlbmRlciA9IG1lc3NhZ2VTZW5kZXI7CgogICAgICAgIC8vIEVtcHR5IGRvbmF0aW9ucyBhcmUgZGlzYWxsb3dlZC4KICAgICAgICB1aW50IGJhbGFuY2UgPSBzdGF0ZS5iYWxhbmNlT2Yoc2VuZGVyKTsKICAgICAgICByZXF1aXJlKGJhbGFuY2UgIT0gMCk7CgogICAgICAgIC8vIHNhZmVTdWIgZW5zdXJlcyB0aGUgZG9ub3IgaGFzIHN1ZmZpY2llbnQgYmFsYW5jZS4KICAgICAgICBzdGF0ZS5zZXRCYWxhbmNlT2Yoc2VuZGVyLCBzYWZlU3ViKGJhbGFuY2UsIG4pKTsKICAgICAgICBzdGF0ZS5zZXRCYWxhbmNlT2YoYWRkcmVzcyh0aGlzKSwgc2FmZUFkZChzdGF0ZS5iYWxhbmNlT2YoYWRkcmVzcyh0aGlzKSksIG4pKTsKCiAgICAgICAgZW1pdCBGZWVzRG9uYXRlZChzZW5kZXIsIHNlbmRlciwgbik7CiAgICAgICAgZW1pdCBUcmFuc2ZlcihzZW5kZXIsIGFkZHJlc3ModGhpcyksIG4pOwoKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICAvKiA9PT09PT09PT09IEVWRU5UUyA9PT09PT09PT09ICovCgogICAgZXZlbnQgVHJhbnNmZXIoYWRkcmVzcyBpbmRleGVkIGZyb20sIGFkZHJlc3MgaW5kZXhlZCB0bywgdWludCB2YWx1ZSk7CgogICAgZXZlbnQgVHJhbnNmZXJGZWVQYWlkKGFkZHJlc3MgaW5kZXhlZCBhY2NvdW50LCB1aW50IHZhbHVlKTsKCiAgICBldmVudCBBcHByb3ZhbChhZGRyZXNzIGluZGV4ZWQgb3duZXIsIGFkZHJlc3MgaW5kZXhlZCBzcGVuZGVyLCB1aW50IHZhbHVlKTsKCiAgICBldmVudCBUcmFuc2ZlckZlZVJhdGVVcGRhdGVkKHVpbnQgbmV3RmVlUmF0ZSk7CgogICAgZXZlbnQgRmVlQXV0aG9yaXR5VXBkYXRlZChhZGRyZXNzIGZlZUF1dGhvcml0eSk7CgogICAgZXZlbnQgU3RhdGVVcGRhdGVkKGFkZHJlc3MgbmV3U3RhdGUpOwoKICAgIGV2ZW50IEZlZXNXaXRoZHJhd24oYWRkcmVzcyBhY2NvdW50LCBhZGRyZXNzIGluZGV4ZWQgYWNjb3VudEluZGV4LCB1aW50IHZhbHVlKTsKCiAgICBldmVudCBGZWVzRG9uYXRlZChhZGRyZXNzIGRvbm9yLCBhZGRyZXNzIGluZGV4ZWQgZG9ub3JJbmRleCwgdWludCB2YWx1ZSk7Cn0KCi8qCi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCkNPTlRSQUNUIERFU0NSSVBUSU9OCi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCgpFdGhlci1iYWNrZWQgbm9taW4gc3RhYmxlY29pbiBjb250cmFjdC4KClRoaXMgY29udHJhY3QgaXNzdWVzIG5vbWlucywgd2hpY2ggYXJlIHRva2VucyB3b3J0aCAxIFVTRCBlYWNoLiBUaGV5IGFyZSBiYWNrZWQKYnkgYSBwb29sIG9mIGV0aGVyIGNvbGxhdGVyYWwsIHNvIHRoYXQgaWYgYSB1c2VyIGhhcyBub21pbnMsIHRoZXkgbWF5CnJlZGVlbSB0aGVtIGZvciBldGhlciBmcm9tIHRoZSBwb29sLCBvciBpZiB0aGV5IHdhbnQgdG8gb2J0YWluIG5vbWlucywKdGhleSBtYXkgcGF5IGV0aGVyIGludG8gdGhlIHBvb2wgaW4gb3JkZXIgdG8gZG8gc28uCgpUaGUgc3VwcGx5IG9mIG5vbWlucyB0aGF0IG1heSBiZSBpbiBjaXJjdWxhdGlvbiBhdCBhbnkgdGltZSBpcyBsaW1pdGVkLgpUaGUgY29udHJhY3Qgb3duZXIgbWF5IGluY3JlYXNlIHRoaXMgcXVhbnRpdHksIGJ1dCBvbmx5IGlmIHRoZXkgcHJvdmlkZQpldGhlciB0byBiYWNrIGl0LiBUaGUgYmFja2luZyB0aGUgb3duZXIgcHJvdmlkZXMgYXQgaXNzdWFuY2UgbXVzdAprZWVwIGVhY2ggbm9taW4gYXQgbGVhc3QgdHdpY2Ugb3ZlcmNvbGxhdGVyYWxpc2VkLgpUaGUgb3duZXIgbWF5IGFsc28gZGVzdHJveSBub21pbnMgaW4gdGhlIHBvb2wsIHdoaWNoIGlzIHBvdGVudGlhbCBhdmVudWUKYnkgd2hpY2ggdG8gbWFpbnRhaW4gaGVhbHRoeSBjb2xsYXRlcmFsaXNhdGlvbiBsZXZlbHMsIGFzIGl0IHJlZHVjZXMKc3VwcGx5IHdpdGhvdXQgd2l0aGRyYXdpbmcgZXRoZXIgY29sbGF0ZXJhbC4KCkEgY29uZmlndXJhYmxlIGZlZSBpcyBjaGFyZ2VkIG9uIG5vbWluIHRyYW5zZmVycyBhbmQgZGVwb3NpdGVkCmludG8gYSBjb21tb24gcG90LCB3aGljaCBoYXZ2ZW4gaG9sZGVycyBtYXkgd2l0aGRyYXcgZnJvbSBvbmNlIHBlcgpmZWUgcGVyaW9kLgoKRXRoZXIgcHJpY2UgaXMgY29udGludWFsbHkgdXBkYXRlZCBieSBhbiBleHRlcm5hbCBvcmFjbGUsIGFuZCB0aGUgdmFsdWUKb2YgdGhlIGJhY2tpbmcgaXMgY29tcHV0ZWQgb24gdGhpcyBiYXNpcy4gVG8gZW5zdXJlIHRoZSBpbnRlZ3JpdHkgb2YKdGhpcyBzeXN0ZW0sIGlmIHRoZSBjb250cmFjdCdzIHByaWNlIGhhcyBub3QgYmVlbiB1cGRhdGVkIHJlY2VudGx5IGVub3VnaCwKaXQgd2lsbCB0ZW1wb3JhcmlseSBkaXNhYmxlIGl0c2VsZiB1bnRpbCBpdCByZWNlaXZlcyBtb3JlIHByaWNlIGluZm9ybWF0aW9uLgoKVGhlIGNvbnRyYWN0IG93bmVyIG1heSBhdCBhbnkgdGltZSBpbml0aWF0ZSBjb250cmFjdCBsaXF1aWRhdGlvbi4KRHVyaW5nIHRoZSBsaXF1aWRhdGlvbiBwZXJpb2QsIG1vc3QgY29udHJhY3QgZnVuY3Rpb25zIHdpbGwgYmUgZGVhY3RpdmF0ZWQuCk5vIG5ldyBub21pbnMgbWF5IGJlIGlzc3VlZCBvciBib3VnaHQsIGJ1dCB1c2VycyBtYXkgc2VsbCBub21pbnMgYmFjawp0byB0aGUgc3lzdGVtLgpJZiB0aGUgc3lzdGVtJ3MgY29sbGF0ZXJhbCBmYWxscyBiZWxvdyBhIHNwZWNpZmllZCBsZXZlbCwgdGhlbiBhbnlvbmUKbWF5IGluaXRpYXRlIGxpcXVpZGF0aW9uLgoKQWZ0ZXIgdGhlIGxpcXVpZGF0aW9uIHBlcmlvZCBoYXMgZWxhcHNlZCwgd2hpY2ggaXMgaW5pdGlhbGx5IDkwIGRheXMsCnRoZSBvd25lciBtYXkgZGVzdHJveSB0aGUgY29udHJhY3QsIHRyYW5zZmVycmluZyBhbnkgcmVtYWluaW5nIGNvbGxhdGVyYWwKdG8gYSBub21pbmF0ZWQgYmVuZWZpY2lhcnkgYWRkcmVzcy4KVGhpcyBsaXF1aWRhdGlvbiBwZXJpb2QgbWF5IGJlIGV4dGVuZGVkIHVwIHRvIGEgbWF4aW11bSBvZiAxODAgZGF5cy4KSWYgdGhlIGNvbnRyYWN0IGlzIHJlY29sbGF0ZXJhbGlzZWQsIHRoZSBvd25lciBtYXkgdGVybWluYXRlIGxpcXVpZGF0aW9uLgoKLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KKi8KCmNvbnRyYWN0IEV0aGVyTm9taW4gaXMgRXh0ZXJuU3RhdGVQcm94eUZlZVRva2VuIHsKCiAgICAvKiA9PT09PT09PT09IFNUQVRFIFZBUklBQkxFUyA9PT09PT09PT09ICovCgogICAgLy8gVGhlIG9yYWNsZSBwcm92aWRlcyBwcmljZSBpbmZvcm1hdGlvbiB0byB0aGlzIGNvbnRyYWN0LgogICAgLy8gSXQgbWF5IG9ubHkgY2FsbCB0aGUgdXBkYXRlUHJpY2UoKSBmdW5jdGlvbi4KICAgIGFkZHJlc3MgcHVibGljIG9yYWNsZTsKCiAgICAvLyBUaGUgYWRkcmVzcyBvZiB0aGUgY29udHJhY3Qgd2hpY2ggbWFuYWdlcyBjb25maXNjYXRpb24gdm90ZXMuCiAgICBDb3VydCBwdWJsaWMgY291cnQ7CgogICAgLy8gRm91bmRhdGlvbiB3YWxsZXQgZm9yIGZ1bmRzIHRvIGdvIHRvIHBvc3QgbGlxdWlkYXRpb24uCiAgICBhZGRyZXNzIHB1YmxpYyBiZW5lZmljaWFyeTsKCiAgICAvLyBOb21pbnMgaW4gdGhlIHBvb2wgcmVhZHkgdG8gYmUgc29sZC4KICAgIHVpbnQgcHVibGljIG5vbWluUG9vbDsKCiAgICAvLyBJbXBvc2UgYSA1MCBiYXNpcy1wb2ludCBmZWUgZm9yIGJ1eWluZyBmcm9tIGFuZCBzZWxsaW5nIHRvIHRoZSBub21pbiBwb29sLgogICAgdWludCBwdWJsaWMgcG9vbEZlZVJhdGUgPSBVTklUIC8gMjAwOwoKICAgIC8vIFRoZSBtaW5pbXVtIHB1cmNoYXNhYmxlIHF1YW50aXR5IG9mIG5vbWlucyBpcyAxIGNlbnQuCiAgICB1aW50IGNvbnN0YW50IE1JTklNVU1fUFVSQ0hBU0UgPSBVTklUIC8gMTAwOwoKICAgIC8vIFdoZW4gaXNzdWluZywgbm9taW5zIG11c3QgYmUgb3ZlcmNvbGxhdGVyYWxpc2VkIGJ5IHRoaXMgcmF0aW8uCiAgICB1aW50IGNvbnN0YW50IE1JTklNVU1fSVNTVUFOQ0VfUkFUSU8gPSAgMiAqIFVOSVQ7CgogICAgLy8gSWYgdGhlIGNvbGxhdGVyYWxpc2F0aW9uIHJhdGlvIG9mIHRoZSBjb250cmFjdCBmYWxscyBiZWxvdyB0aGlzIGxldmVsLAogICAgLy8gaW1tZWRpYXRlbHkgYmVnaW4gbGlxdWlkYXRpb24uCiAgICB1aW50IGNvbnN0YW50IEFVVE9fTElRVUlEQVRJT05fUkFUSU8gPSBVTklUOwoKICAgIC8vIFRoZSBsaXF1aWRhdGlvbiBwZXJpb2QgaXMgdGhlIGR1cmF0aW9uIHRoYXQgbXVzdCBwYXNzIGJlZm9yZSB0aGUgbGlxdWlkYXRpb24gcGVyaW9kIGlzIGNvbXBsZXRlLgogICAgLy8gSXQgY2FuIGJlIGV4dGVuZGVkIHVwIHRvIGEgZ2l2ZW4gZHVyYXRpb24uCiAgICB1aW50IGNvbnN0YW50IERFRkFVTFRfTElRVUlEQVRJT05fUEVSSU9EID0gMTQgZGF5czsKICAgIHVpbnQgY29uc3RhbnQgTUFYX0xJUVVJREFUSU9OX1BFUklPRCA9IDE4MCBkYXlzOwogICAgdWludCBwdWJsaWMgbGlxdWlkYXRpb25QZXJpb2QgPSBERUZBVUxUX0xJUVVJREFUSU9OX1BFUklPRDsKCiAgICAvLyBUaGUgdGltZXN0YW1wIHdoZW4gbGlxdWlkYXRpb24gd2FzIGFjdGl2YXRlZC4gV2UgaW5pdGlhbGlzZSB0aGlzIHRvCiAgICAvLyB1aW50IG1heCwgc28gdGhhdCB3ZSBrbm93IHRoYXQgd2UgYXJlIHVuZGVyIGxpcXVpZGF0aW9uIGlmIHRoZQogICAgLy8gbGlxdWlkYXRpb24gdGltZXN0YW1wIGlzIGluIHRoZSBwYXN0LgogICAgdWludCBwdWJsaWMgbGlxdWlkYXRpb25UaW1lc3RhbXAgPSB+dWludCgwKTsKCiAgICAvLyBFdGhlciBwcmljZSBmcm9tIG9yYWNsZSAoZmlhdCBwZXIgZXRoZXIpLgogICAgdWludCBwdWJsaWMgZXRoZXJQcmljZTsKCiAgICAvLyBMYXN0IHRpbWUgdGhlIHByaWNlIHdhcyB1cGRhdGVkLgogICAgdWludCBwdWJsaWMgbGFzdFByaWNlVXBkYXRlVGltZTsKCiAgICAvLyBUaGUgcGVyaW9kIGl0IHRha2VzIGZvciB0aGUgcHJpY2UgdG8gYmUgY29uc2lkZXJlZCBzdGFsZS4KICAgIC8vIElmIHRoZSBwcmljZSBpcyBzdGFsZSwgZnVuY3Rpb25zIHRoYXQgcmVxdWlyZSB0aGUgcHJpY2UgYXJlIGRpc2FibGVkLgogICAgdWludCBwdWJsaWMgc3RhbGVQZXJpb2QgPSA2MCBtaW51dGVzOwoKICAgIC8vIEFjY291bnRzIHdoaWNoIGhhdmUgbG9zdCB0aGUgcHJpdmlsZWdlIHRvIHRyYW5zYWN0IGluIG5vbWlucy4KICAgIG1hcHBpbmcoYWRkcmVzcyA9PiBib29sKSBwdWJsaWMgZnJvemVuOwoKCiAgICAvKiA9PT09PT09PT09IENPTlNUUlVDVE9SID09PT09PT09PT0gKi8KCiAgICBmdW5jdGlvbiBFdGhlck5vbWluKGFkZHJlc3MgX2hhdnZlbiwgYWRkcmVzcyBfb3JhY2xlLAogICAgICAgICAgICAgICAgICAgICAgICBhZGRyZXNzIF9iZW5lZmljaWFyeSwKICAgICAgICAgICAgICAgICAgICAgICAgdWludCBfaW5pdGlhbEV0aGVyUHJpY2UsCiAgICAgICAgICAgICAgICAgICAgICAgIGFkZHJlc3MgX293bmVyLCBUb2tlblN0YXRlIF9pbml0aWFsU3RhdGUpCiAgICAgICAgRXh0ZXJuU3RhdGVQcm94eUZlZVRva2VuKCJFdGhlci1CYWNrZWQgVVNEIE5vbWlucyIsICJlVVNEIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgMTUgKiBVTklUIC8gMTAwMDAsIC8vIG5vbWluIHRyYW5zZmVycyBpbmN1ciBhIDE1IGJwIGZlZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfaGF2dmVuLCAvLyB0aGUgaGF2dmVuIGNvbnRyYWN0IGlzIHRoZSBmZWUgYXV0aG9yaXR5CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9pbml0aWFsU3RhdGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9vd25lcikKICAgICAgICBwdWJsaWMKICAgIHsKICAgICAgICBvcmFjbGUgPSBfb3JhY2xlOwogICAgICAgIGJlbmVmaWNpYXJ5ID0gX2JlbmVmaWNpYXJ5OwoKICAgICAgICBldGhlclByaWNlID0gX2luaXRpYWxFdGhlclByaWNlOwogICAgICAgIGxhc3RQcmljZVVwZGF0ZVRpbWUgPSBub3c7CiAgICAgICAgZW1pdCBQcmljZVVwZGF0ZWQoX2luaXRpYWxFdGhlclByaWNlKTsKCiAgICAgICAgLy8gSXQgc2hvdWxkIG5vdCBiZSBwb3NzaWJsZSB0byB0cmFuc2ZlciB0byB0aGUgbm9taW4gY29udHJhY3QgaXRzZWxmLgogICAgICAgIGZyb3plblt0aGlzXSA9IHRydWU7CiAgICB9CgoKICAgIC8qID09PT09PT09PT0gRkFMTEJBQ0sgRlVOQ1RJT04gPT09PT09PT09PSAqLwoKICAgIC8qIEZhbGxiYWNrIGZ1bmN0aW9uIGFsbG93cyBjb252ZW5pZW50IGNvbGxhdGVyYWxpc2F0aW9uIG9mIHRoZSBjb250cmFjdCwKICAgICAqIGluY2x1ZGluZyBieSBub24tZm91bmRhdGlvbiBwYXJ0aWVzLiAqLwogICAgZnVuY3Rpb24oKSBwdWJsaWMgcGF5YWJsZSB7fQoKCiAgICAvKiA9PT09PT09PT09IFNFVFRFUlMgPT09PT09PT09PSAqLwoKICAgIGZ1bmN0aW9uIHNldE9yYWNsZShhZGRyZXNzIF9vcmFjbGUpCiAgICAgICAgZXh0ZXJuYWwKICAgICAgICBvcHRpb25hbFByb3h5X29ubHlPd25lcgogICAgewogICAgICAgIG9yYWNsZSA9IF9vcmFjbGU7CiAgICAgICAgZW1pdCBPcmFjbGVVcGRhdGVkKF9vcmFjbGUpOwogICAgfQoKICAgIGZ1bmN0aW9uIHNldENvdXJ0KENvdXJ0IF9jb3VydCkKICAgICAgICBleHRlcm5hbAogICAgICAgIG9wdGlvbmFsUHJveHlfb25seU93bmVyCiAgICB7CiAgICAgICAgY291cnQgPSBfY291cnQ7CiAgICAgICAgZW1pdCBDb3VydFVwZGF0ZWQoX2NvdXJ0KTsKICAgIH0KCiAgICBmdW5jdGlvbiBzZXRCZW5lZmljaWFyeShhZGRyZXNzIF9iZW5lZmljaWFyeSkKICAgICAgICBleHRlcm5hbAogICAgICAgIG9wdGlvbmFsUHJveHlfb25seU93bmVyCiAgICB7CiAgICAgICAgYmVuZWZpY2lhcnkgPSBfYmVuZWZpY2lhcnk7CiAgICAgICAgZW1pdCBCZW5lZmljaWFyeVVwZGF0ZWQoX2JlbmVmaWNpYXJ5KTsKICAgIH0KCiAgICBmdW5jdGlvbiBzZXRQb29sRmVlUmF0ZSh1aW50IF9wb29sRmVlUmF0ZSkKICAgICAgICBleHRlcm5hbAogICAgICAgIG9wdGlvbmFsUHJveHlfb25seU93bmVyCiAgICB7CiAgICAgICAgcmVxdWlyZShfcG9vbEZlZVJhdGUgPD0gVU5JVCk7CiAgICAgICAgcG9vbEZlZVJhdGUgPSBfcG9vbEZlZVJhdGU7CiAgICAgICAgZW1pdCBQb29sRmVlUmF0ZVVwZGF0ZWQoX3Bvb2xGZWVSYXRlKTsKICAgIH0KCiAgICBmdW5jdGlvbiBzZXRTdGFsZVBlcmlvZCh1aW50IF9zdGFsZVBlcmlvZCkKICAgICAgICBleHRlcm5hbAogICAgICAgIG9wdGlvbmFsUHJveHlfb25seU93bmVyCiAgICB7CiAgICAgICAgc3RhbGVQZXJpb2QgPSBfc3RhbGVQZXJpb2Q7CiAgICAgICAgZW1pdCBTdGFsZVBlcmlvZFVwZGF0ZWQoX3N0YWxlUGVyaW9kKTsKICAgIH0KIAoKICAgIC8qID09PT09PT09PT0gVklFVyBGVU5DVElPTlMgPT09PT09PT09PSAqLyAKCiAgICAvKiBSZXR1cm4gdGhlIGVxdWl2YWxlbnQgZmlhdCB2YWx1ZSBvZiB0aGUgZ2l2ZW4gcXVhbnRpdHkKICAgICAqIG9mIGV0aGVyIGF0IHRoZSBjdXJyZW50IHByaWNlLgogICAgICogUmV2ZXJ0cyBpZiB0aGUgcHJpY2UgaXMgc3RhbGUuICovCiAgICBmdW5jdGlvbiBmaWF0VmFsdWUodWludCBldGhlcldlaSkKICAgICAgICBwdWJsaWMKICAgICAgICB2aWV3CiAgICAgICAgcHJpY2VOb3RTdGFsZQogICAgICAgIHJldHVybnMgKHVpbnQpCiAgICB7CiAgICAgICAgcmV0dXJuIHNhZmVNdWxfZGVjKGV0aGVyV2VpLCBldGhlclByaWNlKTsKICAgIH0KCiAgICAvKiBSZXR1cm4gdGhlIGN1cnJlbnQgZmlhdCB2YWx1ZSBvZiB0aGUgY29udHJhY3QncyBiYWxhbmNlLgogICAgICogUmV2ZXJ0cyBpZiB0aGUgcHJpY2UgaXMgc3RhbGUuICovCiAgICBmdW5jdGlvbiBmaWF0QmFsYW5jZSgpCiAgICAgICAgcHVibGljCiAgICAgICAgdmlldwogICAgICAgIHJldHVybnMgKHVpbnQpCiAgICB7CiAgICAgICAgLy8gUHJpY2Ugc3RhbGVuZXNzIGNoZWNrIG9jY3VycyBpbnNpZGUgdGhlIGNhbGwgdG8gZmlhdFZhbHVlLgogICAgICAgIHJldHVybiBmaWF0VmFsdWUoYWRkcmVzcyh0aGlzKS5iYWxhbmNlKTsKICAgIH0KCiAgICAvKiBSZXR1cm4gdGhlIGVxdWl2YWxlbnQgZXRoZXIgdmFsdWUgb2YgdGhlIGdpdmVuIHF1YW50aXR5CiAgICAgKiBvZiBmaWF0IGF0IHRoZSBjdXJyZW50IHByaWNlLgogICAgICogUmV2ZXJ0cyBpZiB0aGUgcHJpY2UgaXMgc3RhbGUuICovCiAgICBmdW5jdGlvbiBldGhlclZhbHVlKHVpbnQgZmlhdCkKICAgICAgICBwdWJsaWMKICAgICAgICB2aWV3CiAgICAgICAgcHJpY2VOb3RTdGFsZQogICAgICAgIHJldHVybnMgKHVpbnQpCiAgICB7CiAgICAgICAgcmV0dXJuIHNhZmVEaXZfZGVjKGZpYXQsIGV0aGVyUHJpY2UpOwogICAgfQoKICAgIC8qIFRoZSBzYW1lIGFzIGV0aGVyVmFsdWUoKSwgYnV0IHdpdGhvdXQgdGhlIHN0YWxlIHByaWNlIGNoZWNrLiAqLwogICAgZnVuY3Rpb24gZXRoZXJWYWx1ZUFsbG93U3RhbGUodWludCBmaWF0KSAKICAgICAgICBpbnRlcm5hbAogICAgICAgIHZpZXcKICAgICAgICByZXR1cm5zICh1aW50KQogICAgewogICAgICAgIHJldHVybiBzYWZlRGl2X2RlYyhmaWF0LCBldGhlclByaWNlKTsKICAgIH0KCiAgICAvKiBSZXR1cm4gdGhlIHVuaXRzIG9mIGZpYXQgcGVyIG5vbWluIGluIHRoZSBzdXBwbHkuCiAgICAgKiBSZXZlcnRzIGlmIHRoZSBwcmljZSBpcyBzdGFsZS4gKi8KICAgIGZ1bmN0aW9uIGNvbGxhdGVyYWxpc2F0aW9uUmF0aW8oKQogICAgICAgIHB1YmxpYwogICAgICAgIHZpZXcKICAgICAgICByZXR1cm5zICh1aW50KQogICAgewogICAgICAgIHJldHVybiBzYWZlRGl2X2RlYyhmaWF0QmFsYW5jZSgpLCBfbm9taW5DYXAoKSk7CiAgICB9CgogICAgLyogUmV0dXJuIHRoZSBtYXhpbXVtIG51bWJlciBvZiBleHRhbnQgbm9taW5zLAogICAgICogZXF1YWwgdG8gdGhlIG5vbWluIHBvb2wgcGx1cyB0b3RhbCAoY2lyY3VsYXRpbmcpIHN1cHBseS4gKi8KICAgIGZ1bmN0aW9uIF9ub21pbkNhcCgpCiAgICAgICAgaW50ZXJuYWwKICAgICAgICB2aWV3CiAgICAgICAgcmV0dXJucyAodWludCkKICAgIHsKICAgICAgICByZXR1cm4gc2FmZUFkZChub21pblBvb2wsIHRvdGFsU3VwcGx5KTsKICAgIH0KCiAgICAvKiBSZXR1cm4gdGhlIGZlZSBjaGFyZ2VkIG9uIGEgcHVyY2hhc2Ugb3Igc2FsZSBvZiBuIG5vbWlucy4gKi8KICAgIGZ1bmN0aW9uIHBvb2xGZWVJbmN1cnJlZCh1aW50IG4pCiAgICAgICAgcHVibGljCiAgICAgICAgdmlldwogICAgICAgIHJldHVybnMgKHVpbnQpCiAgICB7CiAgICAgICAgcmV0dXJuIHNhZmVNdWxfZGVjKG4sIHBvb2xGZWVSYXRlKTsKICAgIH0KCiAgICAvKiBSZXR1cm4gdGhlIGZpYXQgY29zdCAoaW5jbHVkaW5nIGZlZSkgb2YgcHVyY2hhc2luZyBuIG5vbWlucy4KICAgICAqIE5vbWlucyBhcmUgcHVyY2hhc2VkIGZvciAkMSwgcGx1cyB0aGUgZmVlLiAqLwogICAgZnVuY3Rpb24gcHVyY2hhc2VDb3N0RmlhdCh1aW50IG4pCiAgICAgICAgcHVibGljCiAgICAgICAgdmlldwogICAgICAgIHJldHVybnMgKHVpbnQpCiAgICB7CiAgICAgICAgcmV0dXJuIHNhZmVBZGQobiwgcG9vbEZlZUluY3VycmVkKG4pKTsKICAgIH0KCiAgICAvKiBSZXR1cm4gdGhlIGV0aGVyIGNvc3QgKGluY2x1ZGluZyBmZWUpIG9mIHB1cmNoYXNpbmcgbiBub21pbnMuCiAgICAgKiBSZXZlcnRzIGlmIHRoZSBwcmljZSBpcyBzdGFsZS4gKi8KICAgIGZ1bmN0aW9uIHB1cmNoYXNlQ29zdEV0aGVyKHVpbnQgbikKICAgICAgICBwdWJsaWMKICAgICAgICB2aWV3CiAgICAgICAgcmV0dXJucyAodWludCkKICAgIHsKICAgICAgICAvLyBQcmljZSBzdGFsZW5lc3MgY2hlY2sgb2NjdXJzIGluc2lkZSB0aGUgY2FsbCB0byBldGhlclZhbHVlLgogICAgICAgIHJldHVybiBldGhlclZhbHVlKHB1cmNoYXNlQ29zdEZpYXQobikpOwogICAgfQoKICAgIC8qIFJldHVybiB0aGUgZmlhdCBwcm9jZWVkcyAobGVzcyB0aGUgZmVlKSBvZiBzZWxsaW5nIG4gbm9taW5zLgogICAgICogTm9taW5zIGFyZSBzb2xkIGZvciAkMSwgbWludXMgdGhlIGZlZS4gKi8KICAgIGZ1bmN0aW9uIHNhbGVQcm9jZWVkc0ZpYXQodWludCBuKQogICAgICAgIHB1YmxpYwogICAgICAgIHZpZXcKICAgICAgICByZXR1cm5zICh1aW50KQogICAgewogICAgICAgIHJldHVybiBzYWZlU3ViKG4sIHBvb2xGZWVJbmN1cnJlZChuKSk7CiAgICB9CgogICAgLyogUmV0dXJuIHRoZSBldGhlciBwcm9jZWVkcyAobGVzcyB0aGUgZmVlKSBvZiBzZWxsaW5nIG4KICAgICAqIG5vbWlucy4KICAgICAqIFJldmVydHMgaWYgdGhlIHByaWNlIGlzIHN0YWxlLiAqLwogICAgZnVuY3Rpb24gc2FsZVByb2NlZWRzRXRoZXIodWludCBuKQogICAgICAgIHB1YmxpYwogICAgICAgIHZpZXcKICAgICAgICByZXR1cm5zICh1aW50KQogICAgewogICAgICAgIC8vIFByaWNlIHN0YWxlbmVzcyBjaGVjayBvY2N1cnMgaW5zaWRlIHRoZSBjYWxsIHRvIGV0aGVyVmFsdWUuCiAgICAgICAgcmV0dXJuIGV0aGVyVmFsdWUoc2FsZVByb2NlZWRzRmlhdChuKSk7CiAgICB9CgogICAgLyogVGhlIHNhbWUgYXMgc2FsZVByb2NlZWRzRXRoZXIoKSwgYnV0IHdpdGhvdXQgdGhlIHN0YWxlIHByaWNlIGNoZWNrLiAqLwogICAgZnVuY3Rpb24gc2FsZVByb2NlZWRzRXRoZXJBbGxvd1N0YWxlKHVpbnQgbikKICAgICAgICBpbnRlcm5hbAogICAgICAgIHZpZXcKICAgICAgICByZXR1cm5zICh1aW50KQogICAgewogICAgICAgIHJldHVybiBldGhlclZhbHVlQWxsb3dTdGFsZShzYWxlUHJvY2VlZHNGaWF0KG4pKTsKICAgIH0KCiAgICAvKiBUcnVlIGlmZiB0aGUgY3VycmVudCBibG9jayB0aW1lc3RhbXAgaXMgbGF0ZXIgdGhhbiB0aGUgdGltZQogICAgICogdGhlIHByaWNlIHdhcyBsYXN0IHVwZGF0ZWQsIHBsdXMgdGhlIHN0YWxlIHBlcmlvZC4gKi8KICAgIGZ1bmN0aW9uIHByaWNlSXNTdGFsZSgpCiAgICAgICAgcHVibGljCiAgICAgICAgdmlldwogICAgICAgIHJldHVybnMgKGJvb2wpCiAgICB7CiAgICAgICAgcmV0dXJuIHNhZmVBZGQobGFzdFByaWNlVXBkYXRlVGltZSwgc3RhbGVQZXJpb2QpIDwgbm93OwogICAgfQoKICAgIGZ1bmN0aW9uIGlzTGlxdWlkYXRpbmcoKQogICAgICAgIHB1YmxpYwogICAgICAgIHZpZXcKICAgICAgICByZXR1cm5zIChib29sKQogICAgewogICAgICAgIHJldHVybiBsaXF1aWRhdGlvblRpbWVzdGFtcCA8PSBub3c7CiAgICB9CgogICAgLyogVHJ1ZSBpZiB0aGUgY29udHJhY3QgaXMgc2VsZi1kZXN0cnVjdGlibGUuIAogICAgICogVGhpcyBpcyB0cnVlIGlmIGVpdGhlciB0aGUgY29tcGxldGUgbGlxdWlkYXRpb24gcGVyaW9kIGhhcyBlbGFwc2VkLAogICAgICogb3IgaWYgYWxsIHRva2VucyBoYXZlIGJlZW4gcmV0dXJuZWQgdG8gdGhlIGNvbnRyYWN0IGFuZCBpdCBoYXMgYmVlbgogICAgICogaW4gbGlxdWlkYXRpb24gZm9yIGF0IGxlYXN0IGEgd2Vlay4KICAgICAqIFNpbmNlIHRoZSBjb250cmFjdCBpcyBvbmx5IGRlc3RydWN0aWJsZSBhZnRlciB0aGUgbGlxdWlkYXRpb25UaW1lc3RhbXAsCiAgICAgKiBhIGZvcnRpb3JpIGNhblNlbGZEZXN0cnVjdCgpIGltcGxpZXMgaXNMaXF1aWRhdGluZygpLiAqLwogICAgZnVuY3Rpb24gY2FuU2VsZkRlc3RydWN0KCkKICAgICAgICBwdWJsaWMKICAgICAgICB2aWV3CiAgICAgICAgcmV0dXJucyAoYm9vbCkKICAgIHsKICAgICAgICAvLyBOb3QgYmVpbmcgaW4gbGlxdWlkYXRpb24gaW1wbGllcyB0aGUgdGltZXN0YW1wIGlzIHVpbnQgbWF4LCBzbyBpdCB3b3VsZCByb2xsIG92ZXIuCiAgICAgICAgLy8gV2UgbmVlZCB0byBjaGVjayB3aGV0aGVyIHdlJ3JlIGluIGxpcXVpZGF0aW9uIGZpcnN0LgogICAgICAgIGlmIChpc0xpcXVpZGF0aW5nKCkpIHsKICAgICAgICAgICAgLy8gVGhlc2UgdGltZXN0YW1wcyBhbmQgZHVyYXRpb25zIGhhdmUgdmFsdWVzIGNsYW1wZWQgd2l0aGluIHJlYXNvbmFibGUgdmFsdWVzIGFuZAogICAgICAgICAgICAvLyBjYW5ub3Qgb3ZlcmZsb3cuCiAgICAgICAgICAgIGJvb2wgdG90YWxQZXJpb2RFbGFwc2VkID0gbGlxdWlkYXRpb25UaW1lc3RhbXAgKyBsaXF1aWRhdGlvblBlcmlvZCA8IG5vdzsKICAgICAgICAgICAgLy8gVG90YWwgc3VwcGx5IG9mIDAgbWVhbnMgYWxsIHRva2VucyBoYXZlIHJldHVybmVkIHRvIHRoZSBwb29sLgogICAgICAgICAgICBib29sIGFsbFRva2Vuc1JldHVybmVkID0gKGxpcXVpZGF0aW9uVGltZXN0YW1wICsgMSB3ZWVrcyA8IG5vdykgJiYgKHRvdGFsU3VwcGx5ID09IDApOwogICAgICAgICAgICByZXR1cm4gdG90YWxQZXJpb2RFbGFwc2VkIHx8IGFsbFRva2Vuc1JldHVybmVkOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgoKICAgIC8qID09PT09PT09PT0gTVVUQVRJVkUgRlVOQ1RJT05TID09PT09PT09PT0gKi8KCiAgICAvKiBPdmVycmlkZSBFUkMyMCB0cmFuc2ZlciBmdW5jdGlvbiBpbiBvcmRlciB0byBjaGVjawogICAgICogd2hldGhlciB0aGUgcmVjaXBpZW50IGFjY291bnQgaXMgZnJvemVuLiBOb3RlIHRoYXQgdGhlcmUgaXMKICAgICAqIG5vIG5lZWQgdG8gY2hlY2sgd2hldGhlciB0aGUgc2VuZGVyIGhhcyBhIGZyb3plbiBhY2NvdW50LAogICAgICogc2luY2UgdGhlaXIgZnVuZHMgaGF2ZSBhbHJlYWR5IGJlZW4gY29uZmlzY2F0ZWQsCiAgICAgKiBhbmQgbm8gbmV3IGZ1bmRzIGNhbiBiZSB0cmFuc2ZlcnJlZCB0byBpdC4qLwogICAgZnVuY3Rpb24gdHJhbnNmZXIoYWRkcmVzcyB0bywgdWludCB2YWx1ZSkKICAgICAgICBwdWJsaWMKICAgICAgICBvcHRpb25hbFByb3h5CiAgICAgICAgcmV0dXJucyAoYm9vbCkKICAgIHsKICAgICAgICByZXF1aXJlKCFmcm96ZW5bdG9dKTsKICAgICAgICByZXR1cm4gX3RyYW5zZmVyX2J5UHJveHkobWVzc2FnZVNlbmRlciwgdG8sIHZhbHVlKTsKICAgIH0KCiAgICAvKiBPdmVycmlkZSBFUkMyMCB0cmFuc2ZlckZyb20gZnVuY3Rpb24gaW4gb3JkZXIgdG8gY2hlY2sKICAgICAqIHdoZXRoZXIgdGhlIHJlY2lwaWVudCBhY2NvdW50IGlzIGZyb3plbi4gKi8KICAgIGZ1bmN0aW9uIHRyYW5zZmVyRnJvbShhZGRyZXNzIGZyb20sIGFkZHJlc3MgdG8sIHVpbnQgdmFsdWUpCiAgICAgICAgcHVibGljCiAgICAgICAgb3B0aW9uYWxQcm94eQogICAgICAgIHJldHVybnMgKGJvb2wpCiAgICB7CiAgICAgICAgcmVxdWlyZSghZnJvemVuW3RvXSk7CiAgICAgICAgcmV0dXJuIF90cmFuc2ZlckZyb21fYnlQcm94eShtZXNzYWdlU2VuZGVyLCBmcm9tLCB0bywgdmFsdWUpOwogICAgfQoKICAgIC8qIFVwZGF0ZSB0aGUgY3VycmVudCBldGhlciBwcmljZSBhbmQgdXBkYXRlIHRoZSBsYXN0IHVwZGF0ZWQgdGltZSwKICAgICAqIHJlZnJlc2hpbmcgdGhlIHByaWNlIHN0YWxlbmVzcy4KICAgICAqIEFsc28gY2hlY2tzIHdoZXRoZXIgdGhlIGNvbnRyYWN0J3MgY29sbGF0ZXJhbCBsZXZlbHMgaGF2ZSBmYWxsZW4gdG8gbG93LAogICAgICogYW5kIGluaXRpYXRlcyBsaXF1aWRhdGlvbiBpZiB0aGF0IGlzIHRoZSBjYXNlLgogICAgICogRXhjZXB0aW9uYWwgY29uZGl0aW9uczoKICAgICAqICAgICBOb3QgY2FsbGVkIGJ5IHRoZSBvcmFjbGUuCiAgICAgKiAgICAgTm90IHRoZSBtb3N0IHJlY2VudGx5IHNlbnQgcHJpY2UuICovCiAgICBmdW5jdGlvbiB1cGRhdGVQcmljZSh1aW50IHByaWNlLCB1aW50IHRpbWVTZW50KQogICAgICAgIGV4dGVybmFsCiAgICAgICAgcG9zdENoZWNrQXV0b0xpcXVpZGF0ZQogICAgewogICAgICAgIC8vIFNob3VsZCBiZSBjYWxsYWJsZSBvbmx5IGJ5IHRoZSBvcmFjbGUuCiAgICAgICAgcmVxdWlyZShtc2cuc2VuZGVyID09IG9yYWNsZSk7CiAgICAgICAgLy8gTXVzdCBiZSB0aGUgbW9zdCByZWNlbnRseSBzZW50IHByaWNlLCBidXQgbm90IHRvbyBmYXIgaW4gdGhlIGZ1dHVyZS4KICAgICAgICAvLyAoc28gd2UgY2FuJ3QgbG9jayBvdXJzZWx2ZXMgb3V0IG9mIHVwZGF0aW5nIHRoZSBvcmFjbGUgZm9yIGxvbmdlciB0aGFuIHRoaXMpCiAgICAgICAgcmVxdWlyZShsYXN0UHJpY2VVcGRhdGVUaW1lIDwgdGltZVNlbnQgJiYgdGltZVNlbnQgPCBub3cgKyAxMCBtaW51dGVzKTsKCiAgICAgICAgZXRoZXJQcmljZSA9IHByaWNlOwogICAgICAgIGxhc3RQcmljZVVwZGF0ZVRpbWUgPSB0aW1lU2VudDsKICAgICAgICBlbWl0IFByaWNlVXBkYXRlZChwcmljZSk7CiAgICB9CgogICAgLyogSXNzdWVzIG4gbm9taW5zIGludG8gdGhlIHBvb2wgYXZhaWxhYmxlIHRvIGJlIGJvdWdodCBieSB1c2Vycy4KICAgICAqIE11c3QgYmUgYWNjb21wYW5pZWQgYnkgJG4gd29ydGggb2YgZXRoZXIuCiAgICAgKiBFeGNlcHRpb25hbCBjb25kaXRpb25zOgogICAgICogICAgIE5vdCBjYWxsZWQgYnkgY29udHJhY3Qgb3duZXIuCiAgICAgKiAgICAgSW5zdWZmaWNpZW50IGJhY2tpbmcgZnVuZHMgcHJvdmlkZWQgKHBvc3QtaXNzdWFuY2UgY29sbGF0ZXJhbGlzYXRpb24gYmVsb3cgbWluaW11bSByZXF1aXJlbWVudCkuCiAgICAgKiAgICAgUHJpY2UgaXMgc3RhbGUuICovCiAgICBmdW5jdGlvbiByZXBsZW5pc2hQb29sKHVpbnQgbikKICAgICAgICBleHRlcm5hbAogICAgICAgIHBheWFibGUKICAgICAgICBub3RMaXF1aWRhdGluZwogICAgICAgIG9wdGlvbmFsUHJveHlfb25seU93bmVyCiAgICB7CiAgICAgICAgLy8gUHJpY2Ugc3RhbGVuZXNzIGNoZWNrIG9jY3VycyBpbnNpZGUgdGhlIGNhbGwgdG8gZmlhdEJhbGFuY2UuCiAgICAgICAgLy8gU2FmZSBhZGRpdGlvbnMgYXJlIHVubmVjZXNzYXJ5IGhlcmUsIGFzIGVpdGhlciB0aGUgYWRkaXRpb24gaXMgY2hlY2tlZCBvbiB0aGUgZm9sbG93aW5nIGxpbmUKICAgICAgICAvLyBvciB0aGUgb3ZlcmZsb3cgd291bGQgY2F1c2UgdGhlIHJlcXVpcmVtZW50IG5vdCB0byBiZSBzYXRpc2ZpZWQuCiAgICAgICAgcmVxdWlyZShmaWF0QmFsYW5jZSgpID49IHNhZmVNdWxfZGVjKHNhZmVBZGQoX25vbWluQ2FwKCksIG4pLCBNSU5JTVVNX0lTU1VBTkNFX1JBVElPKSk7CiAgICAgICAgbm9taW5Qb29sID0gc2FmZUFkZChub21pblBvb2wsIG4pOwogICAgICAgIGVtaXQgUG9vbFJlcGxlbmlzaGVkKG4sIG1zZy52YWx1ZSk7CiAgICB9CgogICAgLyogQnVybnMgbiBub21pbnMgZnJvbSB0aGUgcG9vbC4KICAgICAqIEV4Y2VwdGlvbmFsIGNvbmRpdGlvbnM6CiAgICAgKiAgICAgTm90IGNhbGxlZCBieSBjb250cmFjdCBvd25lci4KICAgICAqICAgICBUaGVyZSBhcmUgZmV3ZXIgdGhhbiBuIG5vbWlucyBpbiB0aGUgcG9vbC4gKi8KICAgIGZ1bmN0aW9uIGRpbWluaXNoUG9vbCh1aW50IG4pCiAgICAgICAgZXh0ZXJuYWwKICAgICAgICBvcHRpb25hbFByb3h5X29ubHlPd25lcgogICAgewogICAgICAgIC8vIFJlcXVpcmUgdGhhdCB0aGVyZSBhcmUgZW5vdWdoIG5vbWlucyBpbiB0aGUgYWNjZXNzaWJsZSBwb29sIHRvIGJ1cm4KICAgICAgICByZXF1aXJlKG5vbWluUG9vbCA+PSBuKTsKICAgICAgICBub21pblBvb2wgPSBzYWZlU3ViKG5vbWluUG9vbCwgbik7CiAgICAgICAgZW1pdCBQb29sRGltaW5pc2hlZChuKTsKICAgIH0KCiAgICAvKiBTZW5kcyBuIG5vbWlucyB0byB0aGUgc2VuZGVyIGZyb20gdGhlIHBvb2wsIGluIGV4Y2hhbmdlIGZvcgogICAgICogJG4gcGx1cyB0aGUgZmVlIHdvcnRoIG9mIGV0aGVyLgogICAgICogRXhjZXB0aW9uYWwgY29uZGl0aW9uczoKICAgICAqICAgICBJbnN1ZmZpY2llbnQgb3IgdG9vIG1hbnkgZnVuZHMgcHJvdmlkZWQuCiAgICAgKiAgICAgTW9yZSBub21pbnMgcmVxdWVzdGVkIHRoYW4gYXJlIGluIHRoZSBwb29sLgogICAgICogICAgIG4gYmVsb3cgdGhlIHB1cmNoYXNlIG1pbmltdW0gKDEgY2VudCkuCiAgICAgKiAgICAgY29udHJhY3QgaW4gbGlxdWlkYXRpb24uCiAgICAgKiAgICAgUHJpY2UgaXMgc3RhbGUuICovCiAgICBmdW5jdGlvbiBidXkodWludCBuKQogICAgICAgIGV4dGVybmFsCiAgICAgICAgcGF5YWJsZQogICAgICAgIG5vdExpcXVpZGF0aW5nCiAgICAgICAgb3B0aW9uYWxQcm94eQogICAgewogICAgICAgIC8vIFByaWNlIHN0YWxlbmVzcyBjaGVjayBvY2N1cnMgaW5zaWRlIHRoZSBjYWxsIHRvIHB1cmNoYXNlRXRoZXJDb3N0LgogICAgICAgIHJlcXVpcmUobiA+PSBNSU5JTVVNX1BVUkNIQVNFICYmCiAgICAgICAgICAgICAgICBtc2cudmFsdWUgPT0gcHVyY2hhc2VDb3N0RXRoZXIobikpOwogICAgICAgIGFkZHJlc3Mgc2VuZGVyID0gbWVzc2FnZVNlbmRlcjsKICAgICAgICAvLyBzdWIgcmVxdWlyZXMgdGhhdCBub21pblBvb2wgPj0gbgogICAgICAgIG5vbWluUG9vbCA9IHNhZmVTdWIobm9taW5Qb29sLCBuKTsKICAgICAgICBzdGF0ZS5zZXRCYWxhbmNlT2Yoc2VuZGVyLCBzYWZlQWRkKHN0YXRlLmJhbGFuY2VPZihzZW5kZXIpLCBuKSk7CiAgICAgICAgZW1pdCBQdXJjaGFzZWQoc2VuZGVyLCBzZW5kZXIsIG4sIG1zZy52YWx1ZSk7CiAgICAgICAgZW1pdCBUcmFuc2ZlcigwLCBzZW5kZXIsIG4pOwogICAgICAgIHRvdGFsU3VwcGx5ID0gc2FmZUFkZCh0b3RhbFN1cHBseSwgbik7CiAgICB9CgogICAgLyogU2VuZHMgbiBub21pbnMgdG8gdGhlIHBvb2wgZnJvbSB0aGUgc2VuZGVyLCBpbiBleGNoYW5nZSBmb3IKICAgICAqICRuIG1pbnVzIHRoZSBmZWUgd29ydGggb2YgZXRoZXIuCiAgICAgKiBFeGNlcHRpb25hbCBjb25kaXRpb25zOgogICAgICogICAgIEluc3VmZmljaWVudCBub21pbnMgaW4gc2VuZGVyJ3Mgd2FsbGV0LgogICAgICogICAgIEluc3VmZmljaWVudCBmdW5kcyBpbiB0aGUgcG9vbCB0byBwYXkgc2VuZGVyLgogICAgICogICAgIFByaWNlIGlzIHN0YWxlIGlmIG5vdCBpbiBsaXF1aWRhdGlvbi4gKi8KICAgIGZ1bmN0aW9uIHNlbGwodWludCBuKQogICAgICAgIGV4dGVybmFsCiAgICAgICAgb3B0aW9uYWxQcm94eQogICAgewoKICAgICAgICAvLyBQcmljZSBzdGFsZW5lc3MgY2hlY2sgb2NjdXJzIGluc2lkZSB0aGUgY2FsbCB0byBzYWxlUHJvY2VlZHNFdGhlciwKICAgICAgICAvLyBidXQgd2UgYWxsb3cgcGVvcGxlIHRvIHNlbGwgdGhlaXIgbm9taW5zIGJhY2sgdG8gdGhlIHN5c3RlbQogICAgICAgIC8vIGlmIHdlJ3JlIGluIGxpcXVpZGF0aW9uLCByZWdhcmRsZXNzLgogICAgICAgIHVpbnQgcHJvY2VlZHM7CiAgICAgICAgaWYgKGlzTGlxdWlkYXRpbmcoKSkgewogICAgICAgICAgICBwcm9jZWVkcyA9IHNhbGVQcm9jZWVkc0V0aGVyQWxsb3dTdGFsZShuKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBwcm9jZWVkcyA9IHNhbGVQcm9jZWVkc0V0aGVyKG4pOwogICAgICAgIH0KCiAgICAgICAgcmVxdWlyZShhZGRyZXNzKHRoaXMpLmJhbGFuY2UgPj0gcHJvY2VlZHMpOwoKICAgICAgICBhZGRyZXNzIHNlbmRlciA9IG1lc3NhZ2VTZW5kZXI7CiAgICAgICAgLy8gc3ViIHJlcXVpcmVzIHRoYXQgdGhlIGJhbGFuY2UgaXMgZ3JlYXRlciB0aGFuIG4KICAgICAgICBzdGF0ZS5zZXRCYWxhbmNlT2Yoc2VuZGVyLCBzYWZlU3ViKHN0YXRlLmJhbGFuY2VPZihzZW5kZXIpLCBuKSk7CiAgICAgICAgbm9taW5Qb29sID0gc2FmZUFkZChub21pblBvb2wsIG4pOwogICAgICAgIGVtaXQgU29sZChzZW5kZXIsIHNlbmRlciwgbiwgcHJvY2VlZHMpOwogICAgICAgIGVtaXQgVHJhbnNmZXIoc2VuZGVyLCAwLCBuKTsKICAgICAgICB0b3RhbFN1cHBseSA9IHNhZmVTdWIodG90YWxTdXBwbHksIG4pOwogICAgICAgIHNlbmRlci50cmFuc2Zlcihwcm9jZWVkcyk7CiAgICB9CgogICAgLyogTG9jayBub21pbiBwdXJjaGFzZSBmdW5jdGlvbiBpbiBwcmVwYXJhdGlvbiBmb3IgZGVzdHJveWluZyB0aGUgY29udHJhY3QuCiAgICAgKiBXaGlsZSB0aGUgY29udHJhY3QgaXMgdW5kZXIgbGlxdWlkYXRpb24sIHVzZXJzIG1heSBzZWxsIG5vbWlucyBiYWNrIHRvIHRoZSBzeXN0ZW0uCiAgICAgKiBBZnRlciBsaXF1aWRhdGlvbiBwZXJpb2QgaGFzIHRlcm1pbmF0ZWQsIHRoZSBjb250cmFjdCBtYXkgYmUgc2VsZi1kZXN0cnVjdGVkLAogICAgICogcmV0dXJuaW5nIGFsbCByZW1haW5pbmcgZXRoZXIgdG8gdGhlIGJlbmVmaWNpYXJ5IGFkZHJlc3MuCiAgICAgKiBFeGNlcHRpb25hbCBjYXNlczoKICAgICAqICAgICBOb3QgY2FsbGVkIGJ5IGNvbnRyYWN0IG93bmVyOwogICAgICogICAgIGNvbnRyYWN0IGFscmVhZHkgaW4gbGlxdWlkYXRpb247ICovCiAgICBmdW5jdGlvbiBmb3JjZUxpcXVpZGF0aW9uKCkKICAgICAgICBleHRlcm5hbAogICAgICAgIG5vdExpcXVpZGF0aW5nCiAgICAgICAgb3B0aW9uYWxQcm94eV9vbmx5T3duZXIKICAgIHsKICAgICAgICBiZWdpbkxpcXVpZGF0aW9uKCk7CiAgICB9CgogICAgZnVuY3Rpb24gYmVnaW5MaXF1aWRhdGlvbigpCiAgICAgICAgaW50ZXJuYWwKICAgIHsKICAgICAgICBsaXF1aWRhdGlvblRpbWVzdGFtcCA9IG5vdzsKICAgICAgICBlbWl0IExpcXVpZGF0aW9uQmVndW4obGlxdWlkYXRpb25QZXJpb2QpOwogICAgfQoKICAgIC8qIElmIHRoZSBjb250cmFjdCBpcyBsaXF1aWRhdGluZywgdGhlIG93bmVyIG1heSBleHRlbmQgdGhlIGxpcXVpZGF0aW9uIHBlcmlvZC4KICAgICAqIEl0IG1heSBvbmx5IGdldCBsb25nZXIsIG5vdCBzaG9ydGVyLCBhbmQgaXQgbWF5IG5vdCBiZSBleHRlbmRlZCBwYXN0CiAgICAgKiB0aGUgbGlxdWlkYXRpb24gbWF4LiAqLwogICAgZnVuY3Rpb24gZXh0ZW5kTGlxdWlkYXRpb25QZXJpb2QodWludCBleHRlbnNpb24pCiAgICAgICAgZXh0ZXJuYWwKICAgICAgICBvcHRpb25hbFByb3h5X29ubHlPd25lcgogICAgewogICAgICAgIHJlcXVpcmUoaXNMaXF1aWRhdGluZygpKTsKICAgICAgICB1aW50IHN1bSA9IHNhZmVBZGQobGlxdWlkYXRpb25QZXJpb2QsIGV4dGVuc2lvbik7CiAgICAgICAgcmVxdWlyZShzdW0gPD0gTUFYX0xJUVVJREFUSU9OX1BFUklPRCk7CiAgICAgICAgbGlxdWlkYXRpb25QZXJpb2QgPSBzdW07CiAgICAgICAgZW1pdCBMaXF1aWRhdGlvbkV4dGVuZGVkKGV4dGVuc2lvbik7CiAgICB9CgogICAgLyogTGlxdWlkYXRpb24gY2FuIG9ubHkgYmUgc3RvcHBlZCBpZiB0aGUgY29sbGF0ZXJhbGlzYXRpb24gcmF0aW8KICAgICAqIG9mIHRoaXMgY29udHJhY3QgaGFzIHJlY292ZXJlZCBhYm92ZSB0aGUgYXV0b21hdGljIGxpcXVpZGF0aW9uCiAgICAgKiB0aHJlc2hvbGQsIGZvciBleGFtcGxlIGlmIHRoZSBldGhlciBwcmljZSBoYXMgaW5jcmVhc2VkLAogICAgICogb3IgYnkgaW5jbHVkaW5nIGVub3VnaCBldGhlciBpbiB0aGlzIHRyYW5zYWN0aW9uLiAqLwogICAgZnVuY3Rpb24gdGVybWluYXRlTGlxdWlkYXRpb24oKQogICAgICAgIGV4dGVybmFsCiAgICAgICAgcGF5YWJsZQogICAgICAgIHByaWNlTm90U3RhbGUKICAgICAgICBvcHRpb25hbFByb3h5X29ubHlPd25lcgogICAgewogICAgICAgIHJlcXVpcmUoaXNMaXF1aWRhdGluZygpKTsKICAgICAgICByZXF1aXJlKF9ub21pbkNhcCgpID09IDAgfHwgY29sbGF0ZXJhbGlzYXRpb25SYXRpbygpID49IEFVVE9fTElRVUlEQVRJT05fUkFUSU8pOwogICAgICAgIGxpcXVpZGF0aW9uVGltZXN0YW1wID0gfnVpbnQoMCk7CiAgICAgICAgbGlxdWlkYXRpb25QZXJpb2QgPSBERUZBVUxUX0xJUVVJREFUSU9OX1BFUklPRDsKICAgICAgICBlbWl0IExpcXVpZGF0aW9uVGVybWluYXRlZCgpOwogICAgfQoKICAgIC8qIFRoZSBvd25lciBtYXkgZGVzdHJveSB0aGlzIGNvbnRyYWN0LCByZXR1cm5pbmcgYWxsIGZ1bmRzIGJhY2sgdG8gdGhlIGJlbmVmaWNpYXJ5CiAgICAgKiB3YWxsZXQsIG1heSBvbmx5IGJlIGNhbGxlZCBhZnRlciB0aGUgY29udHJhY3QgaGFzIGJlZW4gaW4KICAgICAqIGxpcXVpZGF0aW9uIGZvciBhdCBsZWFzdCBsaXF1aWRhdGlvblBlcmlvZCwgb3IgYWxsIGNpcmN1bGF0aW5nCiAgICAgKiBub21pbnMgaGF2ZSBiZWVuIHNvbGQgYmFjayBpbnRvIHRoZSBwb29sLiAqLwogICAgZnVuY3Rpb24gc2VsZkRlc3RydWN0KCkKICAgICAgICBleHRlcm5hbAogICAgICAgIG9wdGlvbmFsUHJveHlfb25seU93bmVyCiAgICB7CiAgICAgICAgcmVxdWlyZShjYW5TZWxmRGVzdHJ1Y3QoKSk7CiAgICAgICAgZW1pdCBTZWxmRGVzdHJ1Y3RlZChiZW5lZmljaWFyeSk7CiAgICAgICAgc2VsZmRlc3RydWN0KGJlbmVmaWNpYXJ5KTsKICAgIH0KCiAgICAvKiBJZiBhIGNvbmZpc2NhdGlvbiBjb3VydCBtb3Rpb24gaGFzIHBhc3NlZCBhbmQgcmVhY2hlZCB0aGUgY29uZmlybWF0aW9uCiAgICAgKiBzdGF0ZSwgdGhlIGNvdXJ0IG1heSB0cmFuc2ZlciB0aGUgdGFyZ2V0IGFjY291bnQncyBiYWxhbmNlIHRvIHRoZSBmZWUgcG9vbAogICAgICogYW5kIGZyZWV6ZSBpdHMgcGFydGljaXBhdGlvbiBpbiBmdXJ0aGVyIHRyYW5zYWN0aW9ucy4gKi8KICAgIGZ1bmN0aW9uIGNvbmZpc2NhdGVCYWxhbmNlKGFkZHJlc3MgdGFyZ2V0KQogICAgICAgIGV4dGVybmFsCiAgICB7CiAgICAgICAgLy8gU2hvdWxkIGJlIGNhbGxhYmxlIG9ubHkgYnkgdGhlIGNvbmZpc2NhdGlvbiBjb3VydC4KICAgICAgICByZXF1aXJlKENvdXJ0KG1zZy5zZW5kZXIpID09IGNvdXJ0KTsKICAgICAgICAKICAgICAgICAvLyBBIG1vdGlvbiBtdXN0IGFjdHVhbGx5IGJlIHVuZGVyd2F5LgogICAgICAgIHVpbnQgbW90aW9uSUQgPSBjb3VydC50YXJnZXRNb3Rpb25JRCh0YXJnZXQpOwogICAgICAgIHJlcXVpcmUobW90aW9uSUQgIT0gMCk7CgogICAgICAgIC8vIFRoZXNlIGNoZWNrcyBhcmUgc3RyaWN0bHkgdW5uZWNlc3NhcnksCiAgICAgICAgLy8gc2luY2UgdGhleSBhcmUgYWxyZWFkeSBjaGVja2VkIGluIHRoZSBjb3VydCBjb250cmFjdCBpdHNlbGYuCiAgICAgICAgLy8gSSBsZWF2ZSB0aGVtIGluIG91dCBvZiBwYXJhbm9pYS4KICAgICAgICByZXF1aXJlKGNvdXJ0Lm1vdGlvbkNvbmZpcm1pbmcobW90aW9uSUQpKTsKICAgICAgICByZXF1aXJlKGNvdXJ0Lm1vdGlvblBhc3Nlcyhtb3Rpb25JRCkpOwogICAgICAgIHJlcXVpcmUoIWZyb3plblt0YXJnZXRdKTsKCiAgICAgICAgLy8gQ29uZmlzY2F0ZSB0aGUgYmFsYW5jZSBpbiB0aGUgYWNjb3VudCBhbmQgZnJlZXplIGl0LgogICAgICAgIHVpbnQgYmFsYW5jZSA9IHN0YXRlLmJhbGFuY2VPZih0YXJnZXQpOwogICAgICAgIHN0YXRlLnNldEJhbGFuY2VPZihhZGRyZXNzKHRoaXMpLCBzYWZlQWRkKHN0YXRlLmJhbGFuY2VPZihhZGRyZXNzKHRoaXMpKSwgYmFsYW5jZSkpOwogICAgICAgIHN0YXRlLnNldEJhbGFuY2VPZih0YXJnZXQsIDApOwogICAgICAgIGZyb3plblt0YXJnZXRdID0gdHJ1ZTsKICAgICAgICBlbWl0IEFjY291bnRGcm96ZW4odGFyZ2V0LCB0YXJnZXQsIGJhbGFuY2UpOwogICAgICAgIGVtaXQgVHJhbnNmZXIodGFyZ2V0LCBhZGRyZXNzKHRoaXMpLCBiYWxhbmNlKTsKICAgIH0KCiAgICAvKiBUaGUgb3duZXIgbWF5IGFsbG93IGEgcHJldmlvdXNseS1mcm96ZW4gY29udHJhY3QgdG8gb25jZQogICAgICogYWdhaW4gYWNjZXB0IGFuZCB0cmFuc2ZlciBub21pbnMuICovCiAgICBmdW5jdGlvbiB1bmZyZWV6ZUFjY291bnQoYWRkcmVzcyB0YXJnZXQpCiAgICAgICAgZXh0ZXJuYWwKICAgICAgICBvcHRpb25hbFByb3h5X29ubHlPd25lcgogICAgewogICAgICAgIGlmIChmcm96ZW5bdGFyZ2V0XSAmJiBFdGhlck5vbWluKHRhcmdldCkgIT0gdGhpcykgewogICAgICAgICAgICBmcm96ZW5bdGFyZ2V0XSA9IGZhbHNlOwogICAgICAgICAgICBlbWl0IEFjY291bnRVbmZyb3plbih0YXJnZXQsIHRhcmdldCk7CiAgICAgICAgfQogICAgfQoKCiAgICAvKiA9PT09PT09PT09IE1PRElGSUVSUyA9PT09PT09PT09ICovCgogICAgbW9kaWZpZXIgbm90TGlxdWlkYXRpbmcKICAgIHsKICAgICAgICByZXF1aXJlKCFpc0xpcXVpZGF0aW5nKCkpOwogICAgICAgIF87CiAgICB9CgogICAgbW9kaWZpZXIgcHJpY2VOb3RTdGFsZQogICAgewogICAgICAgIHJlcXVpcmUoIXByaWNlSXNTdGFsZSgpKTsKICAgICAgICBfOwogICAgfQoKICAgIC8qIEFueSBmdW5jdGlvbiBtb2RpZmllZCBieSB0aGlzIHdpbGwgYXV0b21hdGljYWxseSBsaXF1aWRhdGUKICAgICAqIHRoZSBzeXN0ZW0gaWYgdGhlIGNvbGxhdGVyYWwgbGV2ZWxzIGFyZSB0b28gbG93LgogICAgICogVGhpcyBpcyBjYWxsZWQgb24gY29sbGF0ZXJhbC12YWx1ZS9ub21pbi1zdXBwbHkgbW9kaWZ5aW5nIGZ1bmN0aW9ucyB0aGF0IGNhbgogICAgICogYWN0dWFsbHkgbW92ZSB0aGUgY29udHJhY3QgaW50byBsaXF1aWRhdGlvbi4gVGhpcyBpcyByZWFsbHkgb25seQogICAgICogdGhlIHByaWNlIHVwZGF0ZSwgc2luY2UgaXNzdWFuY2UgcmVxdWlyZXMgdGhhdCB0aGUgY29udHJhY3QgaXMgb3ZlcmNvbGxhdGVyYWxpc2VkLAogICAgICogYnVybmluZyBjYW4gb25seSBkZXN0cm95IHRva2VucyB3aXRob3V0IHdpdGhkcmF3aW5nIGJhY2tpbmcsIGJ1eWluZyBmcm9tIHRoZSBwb29sIGNhbiBvbmx5CiAgICAgKiBhc3ltcHRvdGUgdG8gYSBjb2xsYXRlcmFsaXNhdGlvbiBsZXZlbCBvZiB1bml0eSwgd2hpbGUgc2VsbGluZyBpbnRvIHRoZSBwb29sIGNhbiBvbmx5IAogICAgICogaW5jcmVhc2UgdGhlIGNvbGxhdGVyYWxpc2F0aW9uIHJhdGlvLgogICAgICogQWRkaXRpb25hbGx5LCBwcmljZSB1cGRhdGUgY2hlY2tzIHNob3VsZC93aWxsIG9jY3VyIGZyZXF1ZW50bHkuICovCiAgICBtb2RpZmllciBwb3N0Q2hlY2tBdXRvTGlxdWlkYXRlCiAgICB7CiAgICAgICAgXzsKICAgICAgICBpZiAoIWlzTGlxdWlkYXRpbmcoKSAmJiBfbm9taW5DYXAoKSAhPSAwICYmIGNvbGxhdGVyYWxpc2F0aW9uUmF0aW8oKSA8IEFVVE9fTElRVUlEQVRJT05fUkFUSU8pIHsKICAgICAgICAgICAgYmVnaW5MaXF1aWRhdGlvbigpOwogICAgICAgIH0KICAgIH0KCgogICAgLyogPT09PT09PT09PSBFVkVOVFMgPT09PT09PT09PSAqLwoKICAgIGV2ZW50IFBvb2xSZXBsZW5pc2hlZCh1aW50IG5vbWluc0NyZWF0ZWQsIHVpbnQgY29sbGF0ZXJhbERlcG9zaXRlZCk7CgogICAgZXZlbnQgUG9vbERpbWluaXNoZWQodWludCBub21pbnNEZXN0cm95ZWQpOwoKICAgIGV2ZW50IFB1cmNoYXNlZChhZGRyZXNzIGJ1eWVyLCBhZGRyZXNzIGluZGV4ZWQgYnV5ZXJJbmRleCwgdWludCBub21pbnMsIHVpbnQgZXRoZXJXZWkpOwoKICAgIGV2ZW50IFNvbGQoYWRkcmVzcyBzZWxsZXIsIGFkZHJlc3MgaW5kZXhlZCBzZWxsZXJJbmRleCwgdWludCBub21pbnMsIHVpbnQgZXRoZXJXZWkpOwoKICAgIGV2ZW50IFByaWNlVXBkYXRlZCh1aW50IG5ld1ByaWNlKTsKCiAgICBldmVudCBTdGFsZVBlcmlvZFVwZGF0ZWQodWludCBuZXdQZXJpb2QpOwoKICAgIGV2ZW50IE9yYWNsZVVwZGF0ZWQoYWRkcmVzcyBuZXdPcmFjbGUpOwoKICAgIGV2ZW50IENvdXJ0VXBkYXRlZChhZGRyZXNzIG5ld0NvdXJ0KTsKCiAgICBldmVudCBCZW5lZmljaWFyeVVwZGF0ZWQoYWRkcmVzcyBuZXdCZW5lZmljaWFyeSk7CgogICAgZXZlbnQgTGlxdWlkYXRpb25CZWd1bih1aW50IGR1cmF0aW9uKTsKCiAgICBldmVudCBMaXF1aWRhdGlvblRlcm1pbmF0ZWQoKTsKCiAgICBldmVudCBMaXF1aWRhdGlvbkV4dGVuZGVkKHVpbnQgZXh0ZW5zaW9uKTsKCiAgICBldmVudCBQb29sRmVlUmF0ZVVwZGF0ZWQodWludCBuZXdGZWVSYXRlKTsKCiAgICBldmVudCBTZWxmRGVzdHJ1Y3RlZChhZGRyZXNzIGJlbmVmaWNpYXJ5KTsKCiAgICBldmVudCBBY2NvdW50RnJvemVuKGFkZHJlc3MgdGFyZ2V0LCBhZGRyZXNzIGluZGV4ZWQgdGFyZ2V0SW5kZXgsIHVpbnQgYmFsYW5jZSk7CgogICAgZXZlbnQgQWNjb3VudFVuZnJvemVuKGFkZHJlc3MgdGFyZ2V0LCBhZGRyZXNzIGluZGV4ZWQgdGFyZ2V0SW5kZXgpOwp9CgovKgotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQpDT05UUkFDVCBERVNDUklQVElPTgotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoKQSB0b2tlbiBpbnRlcmZhY2UgdG8gYmUgb3ZlcnJpZGRlbiB0byBwcm9kdWNlIGFuIEVSQzIwLWNvbXBsaWFudAp0b2tlbiBjb250cmFjdC4gSXQgcmVsaWVzIG9uIGJlaW5nIGNhbGxlZCB1bmRlcm5lYXRoIGEgcHJveHksCmFzIGRlc2NyaWJlZCBpbiBQcm94eS5zb2wuCgpUaGlzIGNvbnRyYWN0IHV0aWxpc2VzIGEgc3RhdGUgZm9yIHVwZ3JhZGFiaWxpdHkgcHVycG9zZXMuCgotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoqLwoKY29udHJhY3QgRXh0ZXJuU3RhdGVQcm94eVRva2VuIGlzIFNhZmVEZWNpbWFsTWF0aCwgUHJveHlhYmxlIHsKCiAgICAvKiA9PT09PT09PT09IFNUQVRFIFZBUklBQkxFUyA9PT09PT09PT09ICovCgogICAgLy8gU3RvcmVzIGJhbGFuY2VzIGFuZCBhbGxvd2FuY2VzLgogICAgVG9rZW5TdGF0ZSBwdWJsaWMgc3RhdGU7CgogICAgLy8gT3RoZXIgRVJDMjAgZmllbGRzCiAgICBzdHJpbmcgcHVibGljIG5hbWU7CiAgICBzdHJpbmcgcHVibGljIHN5bWJvbDsKICAgIHVpbnQgcHVibGljIHRvdGFsU3VwcGx5OwoKCiAgICAvKiA9PT09PT09PT09IENPTlNUUlVDVE9SID09PT09PT09PT0gKi8KCiAgICBmdW5jdGlvbiBFeHRlcm5TdGF0ZVByb3h5VG9rZW4oc3RyaW5nIF9uYW1lLCBzdHJpbmcgX3N5bWJvbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1aW50IGluaXRpYWxTdXBwbHksIGFkZHJlc3MgaW5pdGlhbEJlbmVmaWNpYXJ5LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFRva2VuU3RhdGUgX3N0YXRlLCBhZGRyZXNzIF9vd25lcikKICAgICAgICBQcm94eWFibGUoX293bmVyKQogICAgICAgIHB1YmxpYwogICAgewogICAgICAgIG5hbWUgPSBfbmFtZTsKICAgICAgICBzeW1ib2wgPSBfc3ltYm9sOwogICAgICAgIHRvdGFsU3VwcGx5ID0gaW5pdGlhbFN1cHBseTsKCiAgICAgICAgLy8gaWYgdGhlIHN0YXRlIGlzbid0IHNldCwgY3JlYXRlIGEgbmV3IG9uZQogICAgICAgIGlmIChfc3RhdGUgPT0gVG9rZW5TdGF0ZSgwKSkgewogICAgICAgICAgICBzdGF0ZSA9IG5ldyBUb2tlblN0YXRlKF9vd25lciwgYWRkcmVzcyh0aGlzKSk7CiAgICAgICAgICAgIHN0YXRlLnNldEJhbGFuY2VPZihpbml0aWFsQmVuZWZpY2lhcnksIHRvdGFsU3VwcGx5KTsKICAgICAgICAgICAgZW1pdCBUcmFuc2ZlcihhZGRyZXNzKDApLCBpbml0aWFsQmVuZWZpY2lhcnksIGluaXRpYWxTdXBwbHkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHN0YXRlID0gX3N0YXRlOwogICAgICAgIH0KICAgfQoKICAgIC8qID09PT09PT09PT0gVklFV1MgPT09PT09PT09PSAqLwoKICAgIGZ1bmN0aW9uIGFsbG93YW5jZShhZGRyZXNzIHRva2VuT3duZXIsIGFkZHJlc3Mgc3BlbmRlcikKICAgICAgICBwdWJsaWMKICAgICAgICB2aWV3CiAgICAgICAgcmV0dXJucyAodWludCkKICAgIHsKICAgICAgICByZXR1cm4gc3RhdGUuYWxsb3dhbmNlKHRva2VuT3duZXIsIHNwZW5kZXIpOwogICAgfQoKICAgIGZ1bmN0aW9uIGJhbGFuY2VPZihhZGRyZXNzIGFjY291bnQpCiAgICAgICAgcHVibGljCiAgICAgICAgdmlldwogICAgICAgIHJldHVybnMgKHVpbnQpCiAgICB7CiAgICAgICAgcmV0dXJuIHN0YXRlLmJhbGFuY2VPZihhY2NvdW50KTsKICAgIH0KCiAgICAvKiA9PT09PT09PT09IE1VVEFUSVZFIEZVTkNUSU9OUyA9PT09PT09PT09ICovCgogICAgZnVuY3Rpb24gc2V0U3RhdGUoVG9rZW5TdGF0ZSBfc3RhdGUpCiAgICAgICAgZXh0ZXJuYWwKICAgICAgICBvcHRpb25hbFByb3h5X29ubHlPd25lcgogICAgewogICAgICAgIHN0YXRlID0gX3N0YXRlOwogICAgICAgIGVtaXQgU3RhdGVVcGRhdGVkKF9zdGF0ZSk7CiAgICB9IAoKICAgIC8qIEFueXRoaW5nIGNhbGxpbmcgdGhpcyBtdXN0IGFwcGx5IHRoZSBvbmx5UHJveHkgb3Igb3B0aW9uYWxQcm94eSBtb2RpZmllcnMuKi8KICAgIGZ1bmN0aW9uIF90cmFuc2Zlcl9ieVByb3h5KGFkZHJlc3Mgc2VuZGVyLCBhZGRyZXNzIHRvLCB1aW50IHZhbHVlKQogICAgICAgIGludGVybmFsCiAgICAgICAgcmV0dXJucyAoYm9vbCkKICAgIHsKICAgICAgICByZXF1aXJlKHRvICE9IGFkZHJlc3MoMCkpOwoKICAgICAgICAvLyBJbnN1ZmZpY2llbnQgYmFsYW5jZSB3aWxsIGJlIGhhbmRsZWQgYnkgdGhlIHNhZmUgc3VidHJhY3Rpb24uCiAgICAgICAgc3RhdGUuc2V0QmFsYW5jZU9mKHNlbmRlciwgc2FmZVN1YihzdGF0ZS5iYWxhbmNlT2Yoc2VuZGVyKSwgdmFsdWUpKTsKICAgICAgICBzdGF0ZS5zZXRCYWxhbmNlT2YodG8sIHNhZmVBZGQoc3RhdGUuYmFsYW5jZU9mKHRvKSwgdmFsdWUpKTsKCiAgICAgICAgZW1pdCBUcmFuc2ZlcihzZW5kZXIsIHRvLCB2YWx1ZSk7CgogICAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIC8qIEFueXRoaW5nIGNhbGxpbmcgdGhpcyBtdXN0IGFwcGx5IHRoZSBvbmx5UHJveHkgb3Igb3B0aW9uYWxQcm94eSBtb2RpZmllcnMuKi8KICAgIGZ1bmN0aW9uIF90cmFuc2ZlckZyb21fYnlQcm94eShhZGRyZXNzIHNlbmRlciwgYWRkcmVzcyBmcm9tLCBhZGRyZXNzIHRvLCB1aW50IHZhbHVlKQogICAgICAgIGludGVybmFsCiAgICAgICAgcmV0dXJucyAoYm9vbCkKICAgIHsKICAgICAgICByZXF1aXJlKHRvICE9IGFkZHJlc3MoMCkpOwoKICAgICAgICAvLyBJbnN1ZmZpY2llbnQgYmFsYW5jZSB3aWxsIGJlIGhhbmRsZWQgYnkgdGhlIHNhZmUgc3VidHJhY3Rpb24uCiAgICAgICAgc3RhdGUuc2V0QmFsYW5jZU9mKGZyb20sIHNhZmVTdWIoc3RhdGUuYmFsYW5jZU9mKGZyb20pLCB2YWx1ZSkpOwogICAgICAgIHN0YXRlLnNldEFsbG93YW5jZShmcm9tLCBzZW5kZXIsIHNhZmVTdWIoc3RhdGUuYWxsb3dhbmNlKGZyb20sIHNlbmRlciksIHZhbHVlKSk7CiAgICAgICAgc3RhdGUuc2V0QmFsYW5jZU9mKHRvLCBzYWZlQWRkKHN0YXRlLmJhbGFuY2VPZih0byksIHZhbHVlKSk7CgogICAgICAgIGVtaXQgVHJhbnNmZXIoZnJvbSwgdG8sIHZhbHVlKTsKCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgZnVuY3Rpb24gYXBwcm92ZShhZGRyZXNzIHNwZW5kZXIsIHVpbnQgdmFsdWUpCiAgICAgICAgZXh0ZXJuYWwKICAgICAgICBvcHRpb25hbFByb3h5CiAgICAgICAgcmV0dXJucyAoYm9vbCkKICAgIHsKICAgICAgICBhZGRyZXNzIHNlbmRlciA9IG1lc3NhZ2VTZW5kZXI7CiAgICAgICAgc3RhdGUuc2V0QWxsb3dhbmNlKHNlbmRlciwgc3BlbmRlciwgdmFsdWUpOwogICAgICAgIGVtaXQgQXBwcm92YWwoc2VuZGVyLCBzcGVuZGVyLCB2YWx1ZSk7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgLyogPT09PT09PT09PSBFVkVOVFMgPT09PT09PT09PSAqLwoKICAgIGV2ZW50IFRyYW5zZmVyKGFkZHJlc3MgaW5kZXhlZCBmcm9tLCBhZGRyZXNzIGluZGV4ZWQgdG8sIHVpbnQgdmFsdWUpOwoKICAgIGV2ZW50IEFwcHJvdmFsKGFkZHJlc3MgaW5kZXhlZCBvd25lciwgYWRkcmVzcyBpbmRleGVkIHNwZW5kZXIsIHVpbnQgdmFsdWUpOwoKICAgIGV2ZW50IFN0YXRlVXBkYXRlZChhZGRyZXNzIG5ld1N0YXRlKTsKfQoKLyoKLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KQ09OVFJBQ1QgREVTQ1JJUFRJT04KLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KClRoaXMgY29udHJhY3QgYWxsb3dzIHRoZSBmb3VuZGF0aW9uIHRvIGFwcGx5IHVuaXF1ZSB2ZXN0aW5nCnNjaGVkdWxlcyB0byBoYXZ2ZW4gZnVuZHMgc29sZCBhdCB2YXJpb3VzIGRpc2NvdW50cyBpbiB0aGUgdG9rZW4Kc2FsZS4gSGF2dmVuRXNjcm93IGdpdmVzIHVzZXJzIHRoZSBhYmlsaXR5IHRvIGluc3BlY3QgdGhlaXIKdmVzdGVkIGZ1bmRzLCB0aGVpciBxdWFudGl0aWVzIGFuZCB2ZXN0aW5nIGRhdGVzLCBhbmQgdG8gd2l0aGRyYXcKdGhlIGZlZXMgdGhhdCBhY2NydWUgb24gdGhvc2UgZnVuZHMuCgpUaGUgZmVlcyBhcmUgaGFuZGxlZCBieSB3aXRoZHJhd2luZyB0aGUgZW50aXJlIGZlZSBhbGxvY2F0aW9uCmZvciBhbGwgaGF2dmVucyBpbnNpZGUgdGhlIGVzY3JvdyBjb250cmFjdCwgYW5kIHRoZW4gYWxsb3dpbmcKdGhlIGNvbnRyYWN0IGl0c2VsZiB0byBzdWJkaXZpZGUgdGhhdCBwb29sIHVwIHByb3BvcnRpb25hbGx5IHdpdGhpbgppdHNlbGYuIEV2ZXJ5IHRpbWUgdGhlIGZlZSBwZXJpb2Qgcm9sbHMgb3ZlciBpbiB0aGUgbWFpbiBIYXZ2ZW4KY29udHJhY3QsIHRoZSBIYXZ2ZW5Fc2Nyb3cgZmVlIHBvb2wgaXMgcmVtaXR0ZWQgYmFjayBpbnRvIHRoZSAKbWFpbiBmZWUgcG9vbCB0byBiZSByZWRpc3RyaWJ1dGVkIGluIHRoZSBuZXh0IGZlZSBwZXJpb2QuCgotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoqLwoKY29udHJhY3QgSGF2dmVuRXNjcm93IGlzIE93bmVkLCBMaW1pdGVkU2V0dXAoOCB3ZWVrcyksIFNhZmVEZWNpbWFsTWF0aCB7ICAgIAogICAgLy8gVGhlIGNvcnJlc3BvbmRpbmcgSGF2dmVuIGNvbnRyYWN0LgogICAgSGF2dmVuIHB1YmxpYyBoYXZ2ZW47CgogICAgLy8gTGlzdHMgb2YgKHRpbWVzdGFtcCwgcXVhbnRpdHkpIHBhaXJzIHBlciBhY2NvdW50LCBzb3J0ZWQgaW4gYXNjZW5kaW5nIHRpbWUgb3JkZXIuCiAgICAvLyBUaGVzZSBhcmUgdGhlIHRpbWVzIGF0IHdoaWNoIGVhY2ggZ2l2ZW4gcXVhbnRpdHkgb2YgaGF2dmVucyB2ZXN0cy4KICAgIG1hcHBpbmcoYWRkcmVzcyA9PiB1aW50WzJdW10pIHB1YmxpYyB2ZXN0aW5nU2NoZWR1bGVzOwoKICAgIC8vIEFuIGFjY291bnQncyB0b3RhbCB2ZXN0ZWQgaGF2dmVuIGJhbGFuY2UgdG8gc2F2ZSByZWNvbXB1dGluZyB0aGlzIGZvciBmZWUgZXh0cmFjdGlvbiBwdXJwb3Nlcy4KICAgIG1hcHBpbmcoYWRkcmVzcyA9PiB1aW50KSBwdWJsaWMgdG90YWxWZXN0ZWRBY2NvdW50QmFsYW5jZTsKCiAgICAvLyBUaGUgdG90YWwgcmVtYWluaW5nIHZlc3RlZCBiYWxhbmNlLCBmb3IgdmVyaWZ5aW5nIHRoZSBhY3R1YWwgaGF2dmVuIGJhbGFuY2Ugb2YgdGhpcyBjb250cmFjdCBhZ2FpbnN0LgogICAgdWludCBwdWJsaWMgdG90YWxWZXN0ZWRCYWxhbmNlOwoKCiAgICAvKiA9PT09PT09PT09IENPTlNUUlVDVE9SID09PT09PT09PT0gKi8KCiAgICBmdW5jdGlvbiBIYXZ2ZW5Fc2Nyb3coYWRkcmVzcyBfb3duZXIsIEhhdnZlbiBfaGF2dmVuKQogICAgICAgIE93bmVkKF9vd25lcikKICAgICAgICBwdWJsaWMKICAgIHsKICAgICAgICBoYXZ2ZW4gPSBfaGF2dmVuOwogICAgfQoKCiAgICAvKiA9PT09PT09PT09IFNFVFRFUlMgPT09PT09PT09PSAqLwoKICAgIGZ1bmN0aW9uIHNldEhhdnZlbihIYXZ2ZW4gX2hhdnZlbikKICAgICAgICBleHRlcm5hbAogICAgICAgIG9ubHlPd25lcgogICAgewogICAgICAgIGhhdnZlbiA9IF9oYXZ2ZW47CiAgICAgICAgZW1pdCBIYXZ2ZW5VcGRhdGVkKF9oYXZ2ZW4pOwogICAgfQoKCiAgICAvKiA9PT09PT09PT09IFZJRVcgRlVOQ1RJT05TID09PT09PT09PT0gKi8KCiAgICAvKiBBIHNpbXBsZSBhbGlhcyB0byB0b3RhbFZlc3RlZEFjY291bnRCYWxhbmNlOiBwcm92aWRlcyBFUkMyMCBiYWxhbmNlIGludGVncmF0aW9uLiAqLwogICAgZnVuY3Rpb24gYmFsYW5jZU9mKGFkZHJlc3MgYWNjb3VudCkKICAgICAgICBwdWJsaWMKICAgICAgICB2aWV3CiAgICAgICAgcmV0dXJucyAodWludCkKICAgIHsKICAgICAgICByZXR1cm4gdG90YWxWZXN0ZWRBY2NvdW50QmFsYW5jZVthY2NvdW50XTsKICAgIH0KCiAgICAvKiBUaGUgbnVtYmVyIG9mIHZlc3RpbmcgZGF0ZXMgaW4gYW4gYWNjb3VudCdzIHNjaGVkdWxlLiAqLwogICAgZnVuY3Rpb24gbnVtVmVzdGluZ0VudHJpZXMoYWRkcmVzcyBhY2NvdW50KQogICAgICAgIHB1YmxpYwogICAgICAgIHZpZXcKICAgICAgICByZXR1cm5zICh1aW50KQogICAgewogICAgICAgIHJldHVybiB2ZXN0aW5nU2NoZWR1bGVzW2FjY291bnRdLmxlbmd0aDsKICAgIH0KCiAgICAvKiBHZXQgYSBwYXJ0aWN1bGFyIHNjaGVkdWxlIGVudHJ5IGZvciBhbiBhY2NvdW50LgogICAgICogVGhlIHJldHVybiB2YWx1ZSBpcyBhIHBhaXIgKHRpbWVzdGFtcCwgaGF2dmVuIHF1YW50aXR5KSAqLwogICAgZnVuY3Rpb24gZ2V0VmVzdGluZ1NjaGVkdWxlRW50cnkoYWRkcmVzcyBhY2NvdW50LCB1aW50IGluZGV4KQogICAgICAgIHB1YmxpYwogICAgICAgIHZpZXcKICAgICAgICByZXR1cm5zICh1aW50WzJdKQogICAgewogICAgICAgIHJldHVybiB2ZXN0aW5nU2NoZWR1bGVzW2FjY291bnRdW2luZGV4XTsKICAgIH0KCiAgICAvKiBHZXQgdGhlIHRpbWUgYXQgd2hpY2ggYSBnaXZlbiBzY2hlZHVsZSBlbnRyeSB3aWxsIHZlc3QuICovCiAgICBmdW5jdGlvbiBnZXRWZXN0aW5nVGltZShhZGRyZXNzIGFjY291bnQsIHVpbnQgaW5kZXgpCiAgICAgICAgcHVibGljCiAgICAgICAgdmlldwogICAgICAgIHJldHVybnMgKHVpbnQpCiAgICB7CiAgICAgICAgcmV0dXJuIHZlc3RpbmdTY2hlZHVsZXNbYWNjb3VudF1baW5kZXhdWzBdOwogICAgfQoKICAgIC8qIEdldCB0aGUgcXVhbnRpdHkgb2YgaGF2dmVucyBhc3NvY2lhdGVkIHdpdGggYSBnaXZlbiBzY2hlZHVsZSBlbnRyeS4gKi8KICAgIGZ1bmN0aW9uIGdldFZlc3RpbmdRdWFudGl0eShhZGRyZXNzIGFjY291bnQsIHVpbnQgaW5kZXgpCiAgICAgICAgcHVibGljCiAgICAgICAgdmlldwogICAgICAgIHJldHVybnMgKHVpbnQpCiAgICB7CiAgICAgICAgcmV0dXJuIHZlc3RpbmdTY2hlZHVsZXNbYWNjb3VudF1baW5kZXhdWzFdOwogICAgfQoKICAgIC8qIE9idGFpbiB0aGUgaW5kZXggb2YgdGhlIG5leHQgc2NoZWR1bGUgZW50cnkgdGhhdCB3aWxsIHZlc3QgZm9yIGEgZ2l2ZW4gdXNlci4gKi8KICAgIGZ1bmN0aW9uIGdldE5leHRWZXN0aW5nSW5kZXgoYWRkcmVzcyBhY2NvdW50KQogICAgICAgIHB1YmxpYwogICAgICAgIHZpZXcKICAgICAgICByZXR1cm5zICh1aW50KQogICAgewogICAgICAgIHVpbnQgbGVuID0gbnVtVmVzdGluZ0VudHJpZXMoYWNjb3VudCk7CiAgICAgICAgZm9yICh1aW50IGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAgaWYgKGdldFZlc3RpbmdUaW1lKGFjY291bnQsIGkpICE9IDApIHsKICAgICAgICAgICAgICAgIHJldHVybiBpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBsZW47CiAgICB9CgogICAgLyogT2J0YWluIHRoZSBuZXh0IHNjaGVkdWxlIGVudHJ5IHRoYXQgd2lsbCB2ZXN0IGZvciBhIGdpdmVuIHVzZXIuCiAgICAgKiBUaGUgcmV0dXJuIHZhbHVlIGlzIGEgcGFpciAodGltZXN0YW1wLCBoYXZ2ZW4gcXVhbnRpdHkpICovCiAgICBmdW5jdGlvbiBnZXROZXh0VmVzdGluZ0VudHJ5KGFkZHJlc3MgYWNjb3VudCkKICAgICAgICBleHRlcm5hbAogICAgICAgIHZpZXcKICAgICAgICByZXR1cm5zICh1aW50WzJdKQogICAgewogICAgICAgIHVpbnQgaW5kZXggPSBnZXROZXh0VmVzdGluZ0luZGV4KGFjY291bnQpOwogICAgICAgIGlmIChpbmRleCA9PSBudW1WZXN0aW5nRW50cmllcyhhY2NvdW50KSkgewogICAgICAgICAgICByZXR1cm4gW3VpbnQoMCksIDBdOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZ2V0VmVzdGluZ1NjaGVkdWxlRW50cnkoYWNjb3VudCwgaW5kZXgpOwogICAgfQoKICAgIC8qIE9idGFpbiB0aGUgdGltZSBhdCB3aGljaCB0aGUgbmV4dCBzY2hlZHVsZSBlbnRyeSB3aWxsIHZlc3QgZm9yIGEgZ2l2ZW4gdXNlci4gKi8KICAgIGZ1bmN0aW9uIGdldE5leHRWZXN0aW5nVGltZShhZGRyZXNzIGFjY291bnQpCiAgICAgICAgZXh0ZXJuYWwKICAgICAgICB2aWV3CiAgICAgICAgcmV0dXJucyAodWludCkKICAgIHsKICAgICAgICB1aW50IGluZGV4ID0gZ2V0TmV4dFZlc3RpbmdJbmRleChhY2NvdW50KTsKICAgICAgICBpZiAoaW5kZXggPT0gbnVtVmVzdGluZ0VudHJpZXMoYWNjb3VudCkpIHsKICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgfQogICAgICAgIHJldHVybiBnZXRWZXN0aW5nVGltZShhY2NvdW50LCBpbmRleCk7CiAgICB9CgogICAgLyogT2J0YWluIHRoZSBxdWFudGl0eSB3aGljaCB0aGUgbmV4dCBzY2hlZHVsZSBlbnRyeSB3aWxsIHZlc3QgZm9yIGEgZ2l2ZW4gdXNlci4gKi8KICAgIGZ1bmN0aW9uIGdldE5leHRWZXN0aW5nUXVhbnRpdHkoYWRkcmVzcyBhY2NvdW50KQogICAgICAgIGV4dGVybmFsCiAgICAgICAgdmlldwogICAgICAgIHJldHVybnMgKHVpbnQpCiAgICB7CiAgICAgICAgdWludCBpbmRleCA9IGdldE5leHRWZXN0aW5nSW5kZXgoYWNjb3VudCk7CiAgICAgICAgaWYgKGluZGV4ID09IG51bVZlc3RpbmdFbnRyaWVzKGFjY291bnQpKSB7CiAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZ2V0VmVzdGluZ1F1YW50aXR5KGFjY291bnQsIGluZGV4KTsKICAgIH0KCgogICAgLyogPT09PT09PT09PSBNVVRBVElWRSBGVU5DVElPTlMgPT09PT09PT09PSAqLwoKICAgIC8qIFdpdGhkcmF3cyBhIHF1YW50aXR5IG9mIGhhdnZlbnMgYmFjayB0byB0aGUgaGF2dmVuIGNvbnRyYWN0LiAqLwogICAgZnVuY3Rpb24gd2l0aGRyYXdIYXZ2ZW5zKHVpbnQgcXVhbnRpdHkpCiAgICAgICAgZXh0ZXJuYWwKICAgICAgICBvbmx5T3duZXIKICAgICAgICBzZXR1cEZ1bmN0aW9uCiAgICB7CiAgICAgICAgaGF2dmVuLnRyYW5zZmVyKGhhdnZlbiwgcXVhbnRpdHkpOwogICAgfQoKICAgIC8qIERlc3Ryb3kgdGhlIHZlc3RpbmcgaW5mb3JtYXRpb24gYXNzb2NpYXRlZCB3aXRoIGFuIGFjY291bnQuICovCiAgICBmdW5jdGlvbiBwdXJnZUFjY291bnQoYWRkcmVzcyBhY2NvdW50KQogICAgICAgIGV4dGVybmFsCiAgICAgICAgb25seU93bmVyCiAgICAgICAgc2V0dXBGdW5jdGlvbgogICAgewogICAgICAgIGRlbGV0ZSB2ZXN0aW5nU2NoZWR1bGVzW2FjY291bnRdOwogICAgICAgIHRvdGFsVmVzdGVkQmFsYW5jZSA9IHNhZmVTdWIodG90YWxWZXN0ZWRCYWxhbmNlLCB0b3RhbFZlc3RlZEFjY291bnRCYWxhbmNlW2FjY291bnRdKTsKICAgICAgICBkZWxldGUgdG90YWxWZXN0ZWRBY2NvdW50QmFsYW5jZVthY2NvdW50XTsKICAgIH0KCiAgICAvKiBBZGQgYSBuZXcgdmVzdGluZyBlbnRyeSBhdCBhIGdpdmVuIHRpbWUgYW5kIHF1YW50aXR5IHRvIGFuIGFjY291bnQncyBzY2hlZHVsZS4KICAgICAqIEEgY2FsbCB0byB0aGlzIHNob3VsZCBiZSBhY2NvbXBhbmllZCBieSBlaXRoZXIgZW5vdWdoIGJhbGFuY2UgYWxyZWFkeSBhdmFpbGFibGUKICAgICAqIGluIHRoaXMgY29udHJhY3QsIG9yIGEgY29ycmVzcG9uZGluZyBjYWxsIHRvIGhhdnZlbi5lbmRvdygpLCB0byBlbnN1cmUgdGhhdCB3aGVuCiAgICAgKiB0aGUgZnVuZHMgYXJlIHdpdGhkcmF3biwgdGhlcmUgaXMgZW5vdWdoIGJhbGFuY2UsIGFzIHdlbGwgYXMgY29ycmVjdGx5IGNhbGN1bGF0aW5nCiAgICAgKiB0aGUgZmVlcy4KICAgICAqIE5vdGU7IGFsdGhvdWdoIHRoaXMgZnVuY3Rpb24gY291bGQgdGVjaG5pY2FsbHkgYmUgdXNlZCB0byBwcm9kdWNlIHVuYm91bmRlZAogICAgICogYXJyYXlzLCBpdCdzIG9ubHkgaW4gdGhlIGZvdW5kYXRpb24ncyBjb21tYW5kIHRvIGFkZCB0byB0aGVzZSBsaXN0cy4gKi8KICAgIGZ1bmN0aW9uIGFwcGVuZFZlc3RpbmdFbnRyeShhZGRyZXNzIGFjY291bnQsIHVpbnQgdGltZSwgdWludCBxdWFudGl0eSkKICAgICAgICBwdWJsaWMKICAgICAgICBvbmx5T3duZXIKICAgICAgICBzZXR1cEZ1bmN0aW9uCiAgICB7CiAgICAgICAgLy8gTm8gZW1wdHkgb3IgYWxyZWFkeS1wYXNzZWQgdmVzdGluZyBlbnRyaWVzIGFsbG93ZWQuCiAgICAgICAgcmVxdWlyZShub3cgPCB0aW1lKTsKICAgICAgICByZXF1aXJlKHF1YW50aXR5ICE9IDApOwogICAgICAgIHRvdGFsVmVzdGVkQmFsYW5jZSA9IHNhZmVBZGQodG90YWxWZXN0ZWRCYWxhbmNlLCBxdWFudGl0eSk7CiAgICAgICAgcmVxdWlyZSh0b3RhbFZlc3RlZEJhbGFuY2UgPD0gaGF2dmVuLmJhbGFuY2VPZih0aGlzKSk7CgogICAgICAgIGlmICh2ZXN0aW5nU2NoZWR1bGVzW2FjY291bnRdLmxlbmd0aCA9PSAwKSB7CiAgICAgICAgICAgIHRvdGFsVmVzdGVkQWNjb3VudEJhbGFuY2VbYWNjb3VudF0gPSBxdWFudGl0eTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBEaXNhbGxvdyBhZGRpbmcgbmV3IHZlc3RlZCBoYXZ2ZW5zIGVhcmxpZXIgdGhhbiB0aGUgbGFzdCBvbmUuCiAgICAgICAgICAgIC8vIFNpbmNlIGVudHJpZXMgYXJlIG9ubHkgYXBwZW5kZWQsIHRoaXMgbWVhbnMgdGhhdCBubyB2ZXN0aW5nIGRhdGUgY2FuIGJlIHJlcGVhdGVkLgogICAgICAgICAgICByZXF1aXJlKGdldFZlc3RpbmdUaW1lKGFjY291bnQsIG51bVZlc3RpbmdFbnRyaWVzKGFjY291bnQpIC0gMSkgPCB0aW1lKTsKICAgICAgICAgICAgdG90YWxWZXN0ZWRBY2NvdW50QmFsYW5jZVthY2NvdW50XSA9IHNhZmVBZGQodG90YWxWZXN0ZWRBY2NvdW50QmFsYW5jZVthY2NvdW50XSwgcXVhbnRpdHkpOwogICAgICAgIH0KCiAgICAgICAgdmVzdGluZ1NjaGVkdWxlc1thY2NvdW50XS5wdXNoKFt0aW1lLCBxdWFudGl0eV0pOwogICAgfQoKICAgIC8qIENvbnN0cnVjdCBhIHZlc3Rpbmcgc2NoZWR1bGUgdG8gcmVsZWFzZSBhIHF1YW50aXRpZXMgb2YgaGF2dmVucwogICAgICogb3ZlciBhIHNlcmllcyBvZiBpbnRlcnZhbHMuIEFzc3VtZXMgdGhhdCB0aGUgcXVhbnRpdGllcyBhcmUgbm9uemVybwogICAgICogYW5kIHRoYXQgdGhlIHNlcXVlbmNlIG9mIHRpbWVzdGFtcHMgaXMgc3RyaWN0bHkgaW5jcmVhc2luZy4gKi8KICAgIGZ1bmN0aW9uIGFkZFZlc3RpbmdTY2hlZHVsZShhZGRyZXNzIGFjY291bnQsIHVpbnRbXSB0aW1lcywgdWludFtdIHF1YW50aXRpZXMpCiAgICAgICAgZXh0ZXJuYWwKICAgICAgICBvbmx5T3duZXIKICAgICAgICBzZXR1cEZ1bmN0aW9uCiAgICB7CiAgICAgICAgZm9yICh1aW50IGkgPSAwOyBpIDwgdGltZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgYXBwZW5kVmVzdGluZ0VudHJ5KGFjY291bnQsIHRpbWVzW2ldLCBxdWFudGl0aWVzW2ldKTsKICAgICAgICB9CgogICAgfQoKICAgIC8qIEFsbG93IGEgdXNlciB0byB3aXRoZHJhdyBhbnkgdG9rZW5zIHRoYXQgaGF2ZSB2ZXN0ZWQuICovCiAgICBmdW5jdGlvbiB2ZXN0KCkgCiAgICAgICAgZXh0ZXJuYWwKICAgIHsKICAgICAgICB1aW50IG51bUVudHJpZXMgPSBudW1WZXN0aW5nRW50cmllcyhtc2cuc2VuZGVyKTsKICAgICAgICB1aW50IHRvdGFsOwogICAgICAgIGZvciAodWludCBpID0gMDsgaSA8IG51bUVudHJpZXM7IGkrKykgewogICAgICAgICAgICB1aW50IHRpbWUgPSBnZXRWZXN0aW5nVGltZShtc2cuc2VuZGVyLCBpKTsKICAgICAgICAgICAgLy8gVGhlIGxpc3QgaXMgc29ydGVkOyB3aGVuIHdlIHJlYWNoIHRoZSBmaXJzdCBmdXR1cmUgdGltZSwgYmFpbCBvdXQuCiAgICAgICAgICAgIGlmICh0aW1lID4gbm93KSB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICB1aW50IHF0eSA9IGdldFZlc3RpbmdRdWFudGl0eShtc2cuc2VuZGVyLCBpKTsKICAgICAgICAgICAgaWYgKHF0eSA9PSAwKSB7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmVzdGluZ1NjaGVkdWxlc1ttc2cuc2VuZGVyXVtpXSA9IFswLCAwXTsKICAgICAgICAgICAgdG90YWwgPSBzYWZlQWRkKHRvdGFsLCBxdHkpOwogICAgICAgICAgICB0b3RhbFZlc3RlZEFjY291bnRCYWxhbmNlW21zZy5zZW5kZXJdID0gc2FmZVN1Yih0b3RhbFZlc3RlZEFjY291bnRCYWxhbmNlW21zZy5zZW5kZXJdLCBxdHkpOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRvdGFsICE9IDApIHsKICAgICAgICAgICAgdG90YWxWZXN0ZWRCYWxhbmNlID0gc2FmZVN1Yih0b3RhbFZlc3RlZEJhbGFuY2UsIHRvdGFsKTsKICAgICAgICAgICAgaGF2dmVuLnRyYW5zZmVyKG1zZy5zZW5kZXIsIHRvdGFsKTsKICAgICAgICAgICAgZW1pdCBWZXN0ZWQobXNnLnNlbmRlciwgbXNnLnNlbmRlciwKICAgICAgICAgICAgICAgICAgIG5vdywgdG90YWwpOwogICAgICAgIH0KICAgIH0KCgogICAgLyogPT09PT09PT09PSBFVkVOVFMgPT09PT09PT09PSAqLwoKICAgIGV2ZW50IEhhdnZlblVwZGF0ZWQoYWRkcmVzcyBuZXdIYXZ2ZW4pOwoKICAgIGV2ZW50IFZlc3RlZChhZGRyZXNzIGJlbmVmaWNpYXJ5LCBhZGRyZXNzIGluZGV4ZWQgYmVuZWZpY2lhcnlJbmRleCwgdWludCB0aW1lLCB1aW50IHZhbHVlKTsKfQoKLyoKLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KQ09OVFJBQ1QgREVTQ1JJUFRJT04KLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KClRoaXMgY29udHJhY3QgYWxsb3dzIGFuIGluaGVyaXRpbmcgY29udHJhY3QgdG8gYmUgZGVzdHJveWVkIGFmdGVyCml0cyBvd25lciBpbmRpY2F0ZXMgYW4gaW50ZW50aW9uIGFuZCB0aGVuIHdhaXRzIGZvciBhIHBlcmlvZAp3aXRob3V0IGNoYW5naW5nIHRoZWlyIG1pbmQuCgotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoqLwoKY29udHJhY3QgU2VsZkRlc3RydWN0aWJsZSBpcyBPd25lZCB7CgkKCXVpbnQgcHVibGljIGluaXRpYXRpb25UaW1lID0gfnVpbnQoMCk7Cgl1aW50IGNvbnN0YW50IFNEX0RVUkFUSU9OID0gMyBkYXlzOwoJYWRkcmVzcyBwdWJsaWMgYmVuZWZpY2lhcnk7CgoJZnVuY3Rpb24gU2VsZkRlc3RydWN0aWJsZShhZGRyZXNzIF9vd25lciwgYWRkcmVzcyBfYmVuZWZpY2lhcnkpCgkJcHVibGljCgkJT3duZWQoX293bmVyKQoJewoJCWJlbmVmaWNpYXJ5ID0gX2JlbmVmaWNpYXJ5OwoJfQoKCWZ1bmN0aW9uIHNldEJlbmVmaWNpYXJ5KGFkZHJlc3MgX2JlbmVmaWNpYXJ5KQoJCWV4dGVybmFsCgkJb25seU93bmVyCgl7CgkJYmVuZWZpY2lhcnkgPSBfYmVuZWZpY2lhcnk7CgkJZW1pdCBTZWxmRGVzdHJ1Y3RCZW5lZmljaWFyeVVwZGF0ZWQoX2JlbmVmaWNpYXJ5KTsKCX0KCglmdW5jdGlvbiBpbml0aWF0ZVNlbGZEZXN0cnVjdCgpCgkJZXh0ZXJuYWwKCQlvbmx5T3duZXIKCXsKCQlpbml0aWF0aW9uVGltZSA9IG5vdzsKCQllbWl0IFNlbGZEZXN0cnVjdEluaXRpYXRlZChTRF9EVVJBVElPTik7Cgl9CgoJZnVuY3Rpb24gdGVybWluYXRlU2VsZkRlc3RydWN0KCkKCQlleHRlcm5hbAoJCW9ubHlPd25lcgoJewoJCWluaXRpYXRpb25UaW1lID0gfnVpbnQoMCk7CgkJZW1pdCBTZWxmRGVzdHJ1Y3RUZXJtaW5hdGVkKCk7Cgl9CgoJZnVuY3Rpb24gc2VsZkRlc3RydWN0KCkKCQlleHRlcm5hbAoJCW9ubHlPd25lcgoJewoJCXJlcXVpcmUoaW5pdGlhdGlvblRpbWUgKyBTRF9EVVJBVElPTiA8IG5vdyk7CgkJZW1pdCBTZWxmRGVzdHJ1Y3RlZChiZW5lZmljaWFyeSk7CgkJc2VsZmRlc3RydWN0KGJlbmVmaWNpYXJ5KTsKCX0KCglldmVudCBTZWxmRGVzdHJ1Y3RCZW5lZmljaWFyeVVwZGF0ZWQoYWRkcmVzcyBuZXdCZW5lZmljaWFyeSk7CgoJZXZlbnQgU2VsZkRlc3RydWN0SW5pdGlhdGVkKHVpbnQgZHVyYXRpb24pOwoKCWV2ZW50IFNlbGZEZXN0cnVjdFRlcm1pbmF0ZWQoKTsKCglldmVudCBTZWxmRGVzdHJ1Y3RlZChhZGRyZXNzIGJlbmVmaWNpYXJ5KTsKfQoKLyoKLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KQ09OVFJBQ1QgREVTQ1JJUFRJT04KLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KCkhhdnZlbiB0b2tlbiBjb250cmFjdC4gSGF2dmVucyBhcmUgdHJhbnNmZXJhYmxlIEVSQzIwIHRva2VucywKYW5kIGFsc28gZ2l2ZSB0aGVpciBob2xkZXJzIHRoZSBmb2xsb3dpbmcgcHJpdmlsZWdlcy4KQW4gb3duZXIgb2YgaGF2dmVucyBpcyBlbnRpdGxlZCB0byBhIHNoYXJlIGluIHRoZSBmZWVzIGxldmllZCBvbgpub21pbiB0cmFuc2FjdGlvbnMsIGFuZCBhZGRpdGlvbmFsbHkgbWF5IHBhcnRpY2lwYXRlIGluIG5vbWluCmNvbmZpc2NhdGlvbiB2b3Rlcy4KCkFmdGVyIGEgZmVlIHBlcmlvZCB0ZXJtaW5hdGVzLCB0aGUgZHVyYXRpb24gYW5kIGZlZXMgY29sbGVjdGVkIGZvciB0aGF0CnBlcmlvZCBhcmUgY29tcHV0ZWQsIGFuZCB0aGUgbmV4dCBwZXJpb2QgYmVnaW5zLgpUaHVzIGFuIGFjY291bnQgbWF5IG9ubHkgd2l0aGRyYXcgdGhlIGZlZXMgb3dlZCB0byB0aGVtIGZvciB0aGUgcHJldmlvdXMKcGVyaW9kLCBhbmQgbWF5IG9ubHkgZG8gc28gb25jZSBwZXIgcGVyaW9kLgpBbnkgdW5jbGFpbWVkIGZlZXMgcm9sbCBvdmVyIGludG8gdGhlIGNvbW1vbiBwb3QgZm9yIHRoZSBuZXh0IHBlcmlvZC4KClRoZSBmZWUgZW50aXRsZW1lbnQgb2YgYSBoYXZ2ZW4gaG9sZGVyIGlzIHByb3BvcnRpb25hbCB0byB0aGVpciBhdmVyYWdlCmhhdnZlbiBiYWxhbmNlIG92ZXIgdGhlIGxhc3QgZmVlIHBlcmlvZC4gVGhpcyBpcyBjb21wdXRlZCBieSBtZWFzdXJpbmcgdGhlCmFyZWEgdW5kZXIgdGhlIGdyYXBoIG9mIGEgdXNlcidzIGJhbGFuY2Ugb3ZlciB0aW1lLCBhbmQgdGhlbiB3aGVuIGZlZXMgYXJlCmRpc3RyaWJ1dGVkLCBkaXZpZGluZyB0aHJvdWdoIGJ5IHRoZSBkdXJhdGlvbiBvZiB0aGUgZmVlIHBlcmlvZC4KCldlIG5lZWQgb25seSB1cGRhdGUgZmVlIGVudGl0bGVtZW50IG9uIHRyYW5zZmVyIHdoZW4gdGhlIGhhdnZlbiBiYWxhbmNlcyBvZiB0aGUgc2VuZGVyCmFuZCByZWNpcGllbnQgYXJlIG1vZGlmaWVkLiBUaGlzIGlzIGZvciBlZmZpY2llbmN5LCBhbmQgYWRkcyBhbiBpbXBsaWNpdCBmcmljdGlvbiB0bwp0cmFkaW5nIGluIHRoZSBoYXZ2ZW4gbWFya2V0LiBBIGhhdnZlbiBob2xkZXIgcGF5cyBmb3IgaGlzIG93biByZWNvbXB1dGF0aW9uIHdoZW5ldmVyCmhlIHdhbnRzIHRvIGNoYW5nZSBoaXMgcG9zaXRpb24sIHdoaWNoIHNhdmVzIHRoZSBmb3VuZGF0aW9uIGhhdmluZyB0byBtYWludGFpbiBhIHBvdApkZWRpY2F0ZWQgdG8gcmVzb3VyY2luZyB0aGlzLgoKQSBoeXBvdGhldGljYWwgdXNlcidzIGJhbGFuY2UgaGlzdG9yeSBvdmVyIG9uZSBmZWUgcGVyaW9kLCBwaWN0b3JpYWxseToKCiAgICAgIHMgX19fXwogICAgICAgfCAgICB8CiAgICAgICB8ICAgIHxfX18gcAogICAgICAgfF9fX198X19ffF9fXyBfXyBfICBfCiAgICAgICBmICAgIHQgICBuCgpIZXJlLCB0aGUgYmFsYW5jZSB3YXMgcyBiZXR3ZWVuIHRpbWVzIGYgYW5kIHQsIGF0IHdoaWNoIHRpbWUgYSB0cmFuc2ZlcgpvY2N1cnJlZCwgdXBkYXRpbmcgdGhlIGJhbGFuY2UgdG8gcCwgdW50aWwgbiwgd2hlbiB0aGUgcHJlc2VudCB0cmFuc2ZlciBvY2N1cnMuCldoZW4gYSBuZXcgdHJhbnNmZXIgb2NjdXJzIGF0IHRpbWUgbiwgdGhlIGJhbGFuY2UgYmVpbmcgcCwKd2UgbXVzdDoKCiAgLSBBZGQgdGhlIGFyZWEgcCAqIChuIC0gdCkgdG8gdGhlIHRvdGFsIGFyZWEgcmVjb3JkZWQgc28gZmFyCiAgLSBVcGRhdGUgdGhlIGxhc3QgdHJhbnNmZXIgdGltZSB0byBwCgpTbyBpZiB0aGlzIGdyYXBoIHJlcHJlc2VudHMgdGhlIGVudGlyZSBjdXJyZW50IGZlZSBwZXJpb2QsCnRoZSBhdmVyYWdlIGhhdnZlbnMgaGVsZCBzbyBmYXIgaXMgKCh0LWYpKnMgKyAobi10KSpwKSAvIChuLWYpLgpUaGUgY29tcGxlbWVudGFyeSBjb21wdXRhdGlvbnMgbXVzdCBiZSBwZXJmb3JtZWQgZm9yIGJvdGggc2VuZGVyIGFuZApyZWNpcGllbnQuCgpOb3RlIHRoYXQgYSB0cmFuc2ZlciBrZWVwcyBnbG9iYWwgc3VwcGx5IG9mIGhhdnZlbnMgaW52YXJpYW50LgpUaGUgc3VtIG9mIGFsbCBiYWxhbmNlcyBpcyBjb25zdGFudCwgYW5kIHVubW9kaWZpZWQgYnkgYW55IHRyYW5zZmVyLgpTbyB0aGUgc3VtIG9mIGFsbCBiYWxhbmNlcyBtdWx0aXBsaWVkIGJ5IHRoZSBkdXJhdGlvbiBvZiBhIGZlZSBwZXJpb2QgaXMgYWxzbwpjb25zdGFudCwgYW5kIHRoaXMgaXMgZXF1aXZhbGVudCB0byB0aGUgc3VtIG9mIHRoZSBhcmVhIG9mIGV2ZXJ5IHVzZXIncwp0aW1lL2JhbGFuY2UgZ3JhcGguIERpdmlkaW5nIHRocm91Z2ggYnkgdGhhdCBkdXJhdGlvbiB5aWVsZHMgYmFjayB0aGUgdG90YWwKaGF2dmVuIHN1cHBseS4gU28sIGF0IHRoZSBlbmQgb2YgYSBmZWUgcGVyaW9kLCB3ZSByZWFsbHkgZG8geWllbGQgYSB1c2VyJ3MKYXZlcmFnZSBzaGFyZSBpbiB0aGUgaGF2dmVuIHN1cHBseSBvdmVyIHRoYXQgcGVyaW9kLgoKQSBzbGlnaHQgd3JpbmtsZSBpcyBpbnRyb2R1Y2VkIGlmIHdlIGNvbnNpZGVyIHRoZSB0aW1lIHIgd2hlbiB0aGUgZmVlIHBlcmlvZApyb2xscyBvdmVyLiBUaGVuIHRoZSBwcmV2aW91cyBmZWUgcGVyaW9kIGstMSBpcyBiZWZvcmUgciwgYW5kIHRoZSBjdXJyZW50IGZlZQpwZXJpb2QgayBpcyBhZnRlcndhcmRzLiBJZiB0aGUgbGFzdCB0cmFuc2ZlciB0b29rIHBsYWNlIGJlZm9yZSByLApidXQgdGhlIGxhdGVzdCB0cmFuc2ZlciBvY2N1cnJlZCBhZnRlcndhcmRzOgoKay0xICAgICAgIHwgICAgICAgIGsKICAgICAgcyBfX3xfCiAgICAgICB8ICB8IHwKICAgICAgIHwgIHwgfF9fX18gcAogICAgICAgfF9ffF98X19fX3xfX18gX18gXyAgXwogICAgICAgICAgfAogICAgICAgZiAgfCB0ICAgIG4KICAgICAgICAgIHIKCkluIHRoaXMgc2l0dWF0aW9uIHRoZSBhcmVhIChyLWYpKnMgY29udHJpYnV0ZXMgdG8gZmVlIHBlcmlvZCBrLTEsIHdoaWxlCnRoZSBhcmVhICh0LXIpKnMgY29udHJpYnV0ZXMgdG8gZmVlIHBlcmlvZCBrLiBXZSB3aWxsIGltcGxpY2l0bHkgY29uc2lkZXIgYQp6ZXJvLXZhbHVlIHRyYW5zZmVyIHRvIGhhdmUgb2NjdXJyZWQgYXQgdGltZSByLiBUaGVpciBmZWUgZW50aXRsZW1lbnQgZm9yIHRoZQpwcmV2aW91cyBwZXJpb2Qgd2lsbCBiZSBmaW5hbGlzZWQgYXQgdGhlIHRpbWUgb2YgdGhlaXIgZmlyc3QgdHJhbnNmZXIgZHVyaW5nIHRoZQpjdXJyZW50IGZlZSBwZXJpb2QsIG9yIHdoZW4gdGhleSBxdWVyeSBvciB3aXRoZHJhdyB0aGVpciBmZWUgZW50aXRsZW1lbnQuCgpJbiB0aGUgaW1wbGVtZW50YXRpb24sIHRoZSBkdXJhdGlvbiBvZiBkaWZmZXJlbnQgZmVlIHBlcmlvZHMgbWF5IGJlIHNsaWdodGx5IGlycmVndWxhciwKYXMgdGhlIGNoZWNrIHRoYXQgdGhleSBoYXZlIHJvbGxlZCBvdmVyIG9jY3VycyBvbmx5IHdoZW4gc3RhdGUtY2hhbmdpbmcgaGF2dmVuCm9wZXJhdGlvbnMgYXJlIHBlcmZvcm1lZC4KCkFkZGl0aW9uYWxseSwgd2Uga2VlcCB0cmFjayBhbHNvIG9mIHRoZSBwZW51bHRpbWF0ZSBhbmQgbm90IGp1c3QgdGhlIGxhc3QKYXZlcmFnZSBiYWxhbmNlLCBpbiBvcmRlciB0byBzdXBwb3J0IHRoZSB2b3RpbmcgZnVuY3Rpb25hbGl0eSBkZXRhaWxlZCBpbiBDb3VydC5zb2wuCgotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoqLwoKY29udHJhY3QgSGF2dmVuIGlzIEV4dGVyblN0YXRlUHJveHlUb2tlbiwgU2VsZkRlc3RydWN0aWJsZSB7CgogICAgLyogPT09PT09PT09PSBTVEFURSBWQVJJQUJMRVMgPT09PT09PT09PSAqLwoKICAgIC8vIFN1bXMgb2YgYmFsYW5jZXMqZHVyYXRpb24gaW4gdGhlIGN1cnJlbnQgZmVlIHBlcmlvZC4KICAgIC8vIHJhbmdlOiBkZWNpbWFsczsgdW5pdHM6IGhhdnZlbi1zZWNvbmRzCiAgICBtYXBwaW5nKGFkZHJlc3MgPT4gdWludCkgcHVibGljIGN1cnJlbnRCYWxhbmNlU3VtOwoKICAgIC8vIEF2ZXJhZ2UgYWNjb3VudCBiYWxhbmNlcyBpbiB0aGUgbGFzdCBjb21wbGV0ZWQgZmVlIHBlcmlvZC4gVGhpcyBpcyBwcm9wb3J0aW9uYWwKICAgIC8vIHRvIHRoYXQgYWNjb3VudCdzIGxhc3QgcGVyaW9kIGZlZSBlbnRpdGxlbWVudC4KICAgIC8vIChpLmUuIGN1cnJlbnRCYWxhbmNlU3VtIGZvciB0aGUgcHJldmlvdXMgcGVyaW9kIGRpdmlkZWQgdGhyb3VnaCBieSBkdXJhdGlvbikKICAgIC8vIFdBUk5JTkc6IFRoaXMgbWF5IG5vdCBoYXZlIGJlZW4gdXBkYXRlZCBmb3IgdGhlIGxhdGVzdCBmZWUgcGVyaW9kIGF0IHRoZQogICAgLy8gICAgICAgICAgdGltZSBpdCBpcyBxdWVyaWVkLgogICAgLy8gcmFuZ2U6IGRlY2ltYWxzOyB1bml0czogaGF2dmVucwogICAgbWFwcGluZyhhZGRyZXNzID0+IHVpbnQpIHB1YmxpYyBsYXN0QXZlcmFnZUJhbGFuY2U7CgogICAgLy8gVGhlIGF2ZXJhZ2UgYWNjb3VudCBiYWxhbmNlcyBpbiB0aGUgcGVyaW9kIGJlZm9yZSB0aGUgbGFzdCBjb21wbGV0ZWQgZmVlIHBlcmlvZC4KICAgIC8vIFRoaXMgaXMgdXNlZCBhcyBhIHBlcnNvbidzIHdlaWdodCBpbiBhIGNvbmZpc2NhdGlvbiB2b3RlLCBzbyBpdCBpbXBsaWVzIHRoYXQKICAgIC8vIHRoZSB2b3RlIGR1cmF0aW9uIG11c3QgYmUgbm8gbG9uZ2VyIHRoYW4gdGhlIGZlZSBwZXJpb2QgaW4gb3JkZXIgdG8gZ3VhcmFudGVlIHRoYXQgCiAgICAvLyBubyBwb3J0aW9uIG9mIGEgZmVlIHBlcmlvZCB1c2VkIGZvciBkZXRlcm1pbmluZyB2b3RlIHdlaWdodHMgZmFsbHMgd2l0aGluIHRoZQogICAgLy8gZHVyYXRpb24gb2YgYSB2b3RlIGl0IGNvbnRyaWJ1dGVzIHRvLgogICAgLy8gV0FSTklORzogVGhpcyBtYXkgbm90IGhhdmUgYmVlbiB1cGRhdGVkIGZvciB0aGUgbGF0ZXN0IGZlZSBwZXJpb2QgYXQgdGhlCiAgICAvLyAgICAgICAgICB0aW1lIGl0IGlzIHF1ZXJpZWQuCiAgICBtYXBwaW5nKGFkZHJlc3MgPT4gdWludCkgcHVibGljIHBlbnVsdGltYXRlQXZlcmFnZUJhbGFuY2U7CgogICAgLy8gVGhlIHRpbWUgYW4gYWNjb3VudCBsYXN0IG1hZGUgYSB0cmFuc2Zlci4KICAgIC8vIHJhbmdlOiBuYXR1cmFscwogICAgbWFwcGluZyhhZGRyZXNzID0+IHVpbnQpIHB1YmxpYyBsYXN0VHJhbnNmZXJUaW1lc3RhbXA7CgogICAgLy8gVGhlIHRpbWUgdGhlIGN1cnJlbnQgZmVlIHBlcmlvZCBiZWdhbi4KICAgIHVpbnQgcHVibGljIGZlZVBlcmlvZFN0YXJ0VGltZSA9IDM7CiAgICAvLyBUaGUgYWN0dWFsIHN0YXJ0IG9mIHRoZSBsYXN0IGZlZSBwZXJpb2QgKHNlY29uZHMpLgogICAgLy8gVGhpcywgYW5kIHRoZSBwZW51bHRpbWF0ZSBmZWUgcGVyaW9kIGNhbiBiZSBpbml0aWFsbHkgc2V0IHRvIGFueSB2YWx1ZQogICAgLy8gICAwIDwgdmFsIDwgbm93LCBhcyBldmVyeW9uZSdzIGluZGl2aWR1YWwgbGFzdFRyYW5zZmVyVGltZSB3aWxsIGJlIDAKICAgIC8vICAgYW5kIGFzIHN1Y2gsIHRoZWlyIGxhc3RBdmdCYWwvcGVudWx0aW1hdGVBdmdCYWwgd2lsbCBiZSBzZXQgdG8gdGhhdCB2YWx1ZQogICAgLy8gICBhcGFydCBmcm9tIHRoZSBjb250cmFjdCwgd2hpY2ggd2lsbCBoYXZlIHRvdGFsU3VwcGx5CiAgICB1aW50IHB1YmxpYyBsYXN0RmVlUGVyaW9kU3RhcnRUaW1lID0gMjsKICAgIC8vIFRoZSBhY3R1YWwgc3RhcnQgb2YgdGhlIHBlbnVsdGltYXRlIGZlZSBwZXJpb2QgKHNlY29uZHMpLgogICAgdWludCBwdWJsaWMgcGVudWx0aW1hdGVGZWVQZXJpb2RTdGFydFRpbWUgPSAxOwoKICAgIC8vIEZlZSBwZXJpb2RzIHdpbGwgcm9sbCBvdmVyIGluIG5vIHNob3J0ZXIgYSB0aW1lIHRoYW4gdGhpcy4KICAgIHVpbnQgcHVibGljIHRhcmdldEZlZVBlcmlvZER1cmF0aW9uU2Vjb25kcyA9IDQgd2Vla3M7CiAgICAvLyBBbmQgbWF5IG5vdCBiZSBzZXQgdG8gYmUgc2hvcnRlciB0aGFuIGEgZGF5LgogICAgdWludCBjb25zdGFudCBNSU5fRkVFX1BFUklPRF9EVVJBVElPTl9TRUNPTkRTID0gMSBkYXlzOwogICAgLy8gQW5kIG1heSBub3QgYmUgc2V0IHRvIGJlIGxvbmdlciB0aGFuIHNpeCBtb250aHMuCiAgICB1aW50IGNvbnN0YW50IE1BWF9GRUVfUEVSSU9EX0RVUkFUSU9OX1NFQ09ORFMgPSAyNiB3ZWVrczsKCiAgICAvLyBUaGUgcXVhbnRpdHkgb2Ygbm9taW5zIHRoYXQgd2VyZSBpbiB0aGUgZmVlIHBvdCBhdCB0aGUgdGltZQogICAgLy8gb2YgdGhlIGxhc3QgZmVlIHJvbGxvdmVyIChmZWVQZXJpb2RTdGFydFRpbWUpLgogICAgdWludCBwdWJsaWMgbGFzdEZlZXNDb2xsZWN0ZWQ7CgogICAgbWFwcGluZyhhZGRyZXNzID0+IGJvb2wpIHB1YmxpYyBoYXNXaXRoZHJhd25MYXN0UGVyaW9kRmVlczsKCiAgICBFdGhlck5vbWluIHB1YmxpYyBub21pbjsKICAgIEhhdnZlbkVzY3JvdyBwdWJsaWMgZXNjcm93OwoKCiAgICAvKiA9PT09PT09PT09IENPTlNUUlVDVE9SID09PT09PT09PT0gKi8KCiAgICBmdW5jdGlvbiBIYXZ2ZW4oVG9rZW5TdGF0ZSBpbml0aWFsU3RhdGUsIGFkZHJlc3MgX293bmVyKQogICAgICAgIEV4dGVyblN0YXRlUHJveHlUb2tlbigiSGF2dmVuIiwgIkhBViIsIDFlOCAqIFVOSVQsIGFkZHJlc3ModGhpcyksIGluaXRpYWxTdGF0ZSwgX293bmVyKQogICAgICAgIFNlbGZEZXN0cnVjdGlibGUoX293bmVyLCBfb3duZXIpCiAgICAgICAgLy8gT3duZWQgaXMgaW5pdGlhbGlzZWQgaW4gRXh0ZXJuU3RhdGVQcm94eVRva2VuCiAgICAgICAgcHVibGljCiAgICB7CiAgICAgICAgbGFzdFRyYW5zZmVyVGltZXN0YW1wW3RoaXNdID0gbm93OwogICAgICAgIGZlZVBlcmlvZFN0YXJ0VGltZSA9IG5vdzsKICAgICAgICBsYXN0RmVlUGVyaW9kU3RhcnRUaW1lID0gbm93IC0gdGFyZ2V0RmVlUGVyaW9kRHVyYXRpb25TZWNvbmRzOwogICAgICAgIHBlbnVsdGltYXRlRmVlUGVyaW9kU3RhcnRUaW1lID0gbm93IC0gMip0YXJnZXRGZWVQZXJpb2REdXJhdGlvblNlY29uZHM7CiAgICB9CgoKICAgIC8qID09PT09PT09PT0gU0VUVEVSUyA9PT09PT09PT09ICovCgogICAgZnVuY3Rpb24gc2V0Tm9taW4oRXRoZXJOb21pbiBfbm9taW4pIAogICAgICAgIGV4dGVybmFsCiAgICAgICAgb3B0aW9uYWxQcm94eV9vbmx5T3duZXIKICAgIHsKICAgICAgICBub21pbiA9IF9ub21pbjsKICAgIH0KCiAgICBmdW5jdGlvbiBzZXRFc2Nyb3coSGF2dmVuRXNjcm93IF9lc2Nyb3cpCiAgICAgICAgZXh0ZXJuYWwKICAgICAgICBvcHRpb25hbFByb3h5X29ubHlPd25lcgogICAgewogICAgICAgIGVzY3JvdyA9IF9lc2Nyb3c7CiAgICB9CgogICAgZnVuY3Rpb24gc2V0VGFyZ2V0RmVlUGVyaW9kRHVyYXRpb24odWludCBkdXJhdGlvbikKICAgICAgICBleHRlcm5hbAogICAgICAgIHBvc3RDaGVja0ZlZVBlcmlvZFJvbGxvdmVyCiAgICAgICAgb3B0aW9uYWxQcm94eV9vbmx5T3duZXIKICAgIHsKICAgICAgICByZXF1aXJlKE1JTl9GRUVfUEVSSU9EX0RVUkFUSU9OX1NFQ09ORFMgPD0gZHVyYXRpb24gJiYKICAgICAgICAgICAgICAgIGR1cmF0aW9uIDw9IE1BWF9GRUVfUEVSSU9EX0RVUkFUSU9OX1NFQ09ORFMpOwogICAgICAgIHRhcmdldEZlZVBlcmlvZER1cmF0aW9uU2Vjb25kcyA9IGR1cmF0aW9uOwogICAgICAgIGVtaXQgRmVlUGVyaW9kRHVyYXRpb25VcGRhdGVkKGR1cmF0aW9uKTsKICAgIH0KCgogICAgLyogPT09PT09PT09PSBNVVRBVElWRSBGVU5DVElPTlMgPT09PT09PT09PSAqLwoKICAgIC8qIEFsbG93IHRoZSBvd25lciBvZiB0aGlzIGNvbnRyYWN0IHRvIGVuZG93IGFueSBhZGRyZXNzIHdpdGggaGF2dmVucwogICAgICogZnJvbSB0aGUgaW5pdGlhbCBzdXBwbHkuIFNpbmNlIHRoZSBlbnRpcmUgaW5pdGlhbCBzdXBwbHkgcmVzaWRlcwogICAgICogaW4gdGhlIGhhdnZlbiBjb250cmFjdCwgdGhpcyBkaXNhbGxvd3MgdGhlIGZvdW5kYXRpb24gZnJvbSB3aXRoZHJhd2luZwogICAgICogZmVlcyBvbiB1bmRpc3RyaWJ1dGVkIGJhbGFuY2VzLiBUaGlzIGZ1bmN0aW9uIGNhbiBhbHNvIGJlIHVzZWQKICAgICAqIHRvIHJldHJpZXZlIGFueSBoYXZ2ZW5zIHNlbnQgdG8gdGhlIEhhdnZlbiBjb250cmFjdCBpdHNlbGYuICovCiAgICBmdW5jdGlvbiBlbmRvdyhhZGRyZXNzIGFjY291bnQsIHVpbnQgdmFsdWUpCiAgICAgICAgZXh0ZXJuYWwKICAgICAgICBvcHRpb25hbFByb3h5X29ubHlPd25lcgogICAgICAgIHJldHVybnMgKGJvb2wpCiAgICB7CgogICAgICAgIC8vIFVzZSAidGhpcyIgaW4gb3JkZXIgdGhhdCB0aGUgaGF2dmVuIGFjY291bnQgaXMgdGhlIHNlbmRlci4KICAgICAgICAvLyBUaGF0IHRoaXMgaXMgYW4gZXhwbGljaXQgdHJhbnNmZXIgYWxzbyBpbml0aWFsaXNlcyBmZWUgZW50aXRsZW1lbnQgaW5mb3JtYXRpb24uCiAgICAgICAgcmV0dXJuIF90cmFuc2Zlcih0aGlzLCBhY2NvdW50LCB2YWx1ZSk7CiAgICB9CgogICAgLyogQWxsb3cgdGhlIG93bmVyIG9mIHRoaXMgY29udHJhY3QgdG8gZW1pdCB0cmFuc2ZlciBldmVudHMgZm9yCiAgICAgKiBjb250cmFjdCBzZXR1cCBwdXJwb3Nlcy4gKi8KICAgIGZ1bmN0aW9uIGVtaXRUcmFuc2ZlckV2ZW50cyhhZGRyZXNzIHNlbmRlciwgYWRkcmVzc1tdIHJlY2lwaWVudHMsIHVpbnRbXSB2YWx1ZXMpCiAgICAgICAgZXh0ZXJuYWwKICAgICAgICBvbmx5T3duZXIKICAgIHsKICAgICAgICBmb3IgKHVpbnQgaSA9IDA7IGkgPCByZWNpcGllbnRzLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgIGVtaXQgVHJhbnNmZXIoc2VuZGVyLCByZWNpcGllbnRzW2ldLCB2YWx1ZXNbaV0pOwogICAgICAgIH0KICAgIH0KCiAgICAvKiBPdmVycmlkZSBFUkMyMCB0cmFuc2ZlciBmdW5jdGlvbiBpbiBvcmRlciB0byBwZXJmb3JtCiAgICAgKiBmZWUgZW50aXRsZW1lbnQgcmVjb21wdXRhdGlvbiB3aGVuZXZlciBiYWxhbmNlcyBhcmUgdXBkYXRlZC4gKi8KICAgIGZ1bmN0aW9uIHRyYW5zZmVyKGFkZHJlc3MgdG8sIHVpbnQgdmFsdWUpCiAgICAgICAgZXh0ZXJuYWwKICAgICAgICBvcHRpb25hbFByb3h5CiAgICAgICAgcmV0dXJucyAoYm9vbCkKICAgIHsKICAgICAgICByZXR1cm4gX3RyYW5zZmVyKG1lc3NhZ2VTZW5kZXIsIHRvLCB2YWx1ZSk7CiAgICB9CgogICAgLyogQW55dGhpbmcgY2FsbGluZyB0aGlzIG11c3QgYXBwbHkgdGhlIG9wdGlvbmFsUHJveHkgb3Igb25seVByb3h5IG1vZGlmaWVyLiAqLwogICAgZnVuY3Rpb24gX3RyYW5zZmVyKGFkZHJlc3Mgc2VuZGVyLCBhZGRyZXNzIHRvLCB1aW50IHZhbHVlKQogICAgICAgIGludGVybmFsCiAgICAgICAgcHJlQ2hlY2tGZWVQZXJpb2RSb2xsb3ZlcgogICAgICAgIHJldHVybnMgKGJvb2wpCiAgICB7CgogICAgICAgIHVpbnQgc2VuZGVyUHJlQmFsYW5jZSA9IHN0YXRlLmJhbGFuY2VPZihzZW5kZXIpOwogICAgICAgIHVpbnQgcmVjaXBpZW50UHJlQmFsYW5jZSA9IHN0YXRlLmJhbGFuY2VPZih0byk7CgogICAgICAgIC8vIFBlcmZvcm0gdGhlIHRyYW5zZmVyOiBpZiB0aGVyZSBpcyBhIHByb2JsZW0sCiAgICAgICAgLy8gYW4gZXhjZXB0aW9uIHdpbGwgYmUgdGhyb3duIGluIHRoaXMgY2FsbC4KICAgICAgICBfdHJhbnNmZXJfYnlQcm94eShzZW5kZXIsIHRvLCB2YWx1ZSk7CgogICAgICAgIC8vIFplcm8tdmFsdWUgdHJhbnNmZXJzIHN0aWxsIHVwZGF0ZSBmZWUgZW50aXRsZW1lbnQgaW5mb3JtYXRpb24sCiAgICAgICAgLy8gYW5kIG1heSByb2xsIG92ZXIgdGhlIGZlZSBwZXJpb2QuCiAgICAgICAgYWRqdXN0RmVlRW50aXRsZW1lbnQoc2VuZGVyLCBzZW5kZXJQcmVCYWxhbmNlKTsKICAgICAgICBhZGp1c3RGZWVFbnRpdGxlbWVudCh0bywgcmVjaXBpZW50UHJlQmFsYW5jZSk7CgogICAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIC8qIE92ZXJyaWRlIEVSQzIwIHRyYW5zZmVyRnJvbSBmdW5jdGlvbiBpbiBvcmRlciB0byBwZXJmb3JtCiAgICAgKiBmZWUgZW50aXRsZW1lbnQgcmVjb21wdXRhdGlvbiB3aGVuZXZlciBiYWxhbmNlcyBhcmUgdXBkYXRlZC4gKi8KICAgIGZ1bmN0aW9uIHRyYW5zZmVyRnJvbShhZGRyZXNzIGZyb20sIGFkZHJlc3MgdG8sIHVpbnQgdmFsdWUpCiAgICAgICAgZXh0ZXJuYWwKICAgICAgICBwcmVDaGVja0ZlZVBlcmlvZFJvbGxvdmVyCiAgICAgICAgb3B0aW9uYWxQcm94eQogICAgICAgIHJldHVybnMgKGJvb2wpCiAgICB7CiAgICAgICAgdWludCBzZW5kZXJQcmVCYWxhbmNlID0gc3RhdGUuYmFsYW5jZU9mKGZyb20pOwogICAgICAgIHVpbnQgcmVjaXBpZW50UHJlQmFsYW5jZSA9IHN0YXRlLmJhbGFuY2VPZih0byk7CgogICAgICAgIC8vIFBlcmZvcm0gdGhlIHRyYW5zZmVyOiBpZiB0aGVyZSBpcyBhIHByb2JsZW0sCiAgICAgICAgLy8gYW4gZXhjZXB0aW9uIHdpbGwgYmUgdGhyb3duIGluIHRoaXMgY2FsbC4KICAgICAgICBfdHJhbnNmZXJGcm9tX2J5UHJveHkobWVzc2FnZVNlbmRlciwgZnJvbSwgdG8sIHZhbHVlKTsKCiAgICAgICAgLy8gWmVyby12YWx1ZSB0cmFuc2ZlcnMgc3RpbGwgdXBkYXRlIGZlZSBlbnRpdGxlbWVudCBpbmZvcm1hdGlvbiwKICAgICAgICAvLyBhbmQgbWF5IHJvbGwgb3ZlciB0aGUgZmVlIHBlcmlvZC4KICAgICAgICBhZGp1c3RGZWVFbnRpdGxlbWVudChmcm9tLCBzZW5kZXJQcmVCYWxhbmNlKTsKICAgICAgICBhZGp1c3RGZWVFbnRpdGxlbWVudCh0bywgcmVjaXBpZW50UHJlQmFsYW5jZSk7CgogICAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIC8qIENvbXB1dGUgdGhlIGxhc3QgcGVyaW9kJ3MgZmVlIGVudGl0bGVtZW50IGZvciB0aGUgbWVzc2FnZSBzZW5kZXIKICAgICAqIGFuZCB0aGVuIGRlcG9zaXQgaXQgaW50byB0aGVpciBub21pbiBhY2NvdW50LiAqLwogICAgZnVuY3Rpb24gd2l0aGRyYXdGZWVFbnRpdGxlbWVudCgpCiAgICAgICAgcHVibGljCiAgICAgICAgcHJlQ2hlY2tGZWVQZXJpb2RSb2xsb3ZlcgogICAgICAgIG9wdGlvbmFsUHJveHkKICAgIHsKICAgICAgICBhZGRyZXNzIHNlbmRlciA9IG1lc3NhZ2VTZW5kZXI7CgogICAgICAgIC8vIERvIG5vdCBkZXBvc2l0IGZlZXMgaW50byBmcm96ZW4gYWNjb3VudHMuCiAgICAgICAgcmVxdWlyZSghbm9taW4uZnJvemVuKHNlbmRlcikpOwoKICAgICAgICAvLyBjaGVjayB0aGUgcGVyaW9kIGhhcyByb2xsZWQgb3ZlciBmaXJzdAogICAgICAgIHJvbGxvdmVyRmVlKHNlbmRlciwgbGFzdFRyYW5zZmVyVGltZXN0YW1wW3NlbmRlcl0sIHN0YXRlLmJhbGFuY2VPZihzZW5kZXIpKTsKCiAgICAgICAgLy8gT25seSBhbGxvdyBhY2NvdW50cyB0byB3aXRoZHJhdyBmZWVzIG9uY2UgcGVyIHBlcmlvZC4KICAgICAgICByZXF1aXJlKCFoYXNXaXRoZHJhd25MYXN0UGVyaW9kRmVlc1tzZW5kZXJdKTsKCiAgICAgICAgdWludCBmZWVzT3dlZDsKCiAgICAgICAgaWYgKGVzY3JvdyAhPSBIYXZ2ZW5Fc2Nyb3coMCkpIHsKICAgICAgICAgICAgZmVlc093ZWQgPSBlc2Nyb3cudG90YWxWZXN0ZWRBY2NvdW50QmFsYW5jZShzZW5kZXIpOwogICAgICAgIH0KCiAgICAgICAgZmVlc093ZWQgPSBzYWZlRGl2X2RlYyhzYWZlTXVsX2RlYyhzYWZlQWRkKGZlZXNPd2VkLCBsYXN0QXZlcmFnZUJhbGFuY2Vbc2VuZGVyXSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0RmVlc0NvbGxlY3RlZCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b3RhbFN1cHBseSk7CgogICAgICAgIGhhc1dpdGhkcmF3bkxhc3RQZXJpb2RGZWVzW3NlbmRlcl0gPSB0cnVlOwogICAgICAgIGlmIChmZWVzT3dlZCAhPSAwKSB7CiAgICAgICAgICAgIG5vbWluLndpdGhkcmF3RmVlKHNlbmRlciwgZmVlc093ZWQpOwogICAgICAgICAgICBlbWl0IEZlZXNXaXRoZHJhd24oc2VuZGVyLCBzZW5kZXIsIGZlZXNPd2VkKTsKICAgICAgICB9CiAgICB9CgogICAgLyogVXBkYXRlIHRoZSBmZWUgZW50aXRsZW1lbnQgc2luY2UgdGhlIGxhc3QgdHJhbnNmZXIgb3IgZW50aXRsZW1lbnQKICAgICAqIGFkanVzdG1lbnQuIFNpbmNlIHRoaXMgdXBkYXRlcyB0aGUgbGFzdCB0cmFuc2ZlciB0aW1lc3RhbXAsIGlmIGludm9rZWQKICAgICAqIGNvbnNlY3V0aXZlbHksIHRoaXMgZnVuY3Rpb24gd2lsbCBkbyBub3RoaW5nIGFmdGVyIHRoZSBmaXJzdCBjYWxsLiAqLwogICAgZnVuY3Rpb24gYWRqdXN0RmVlRW50aXRsZW1lbnQoYWRkcmVzcyBhY2NvdW50LCB1aW50IHByZUJhbGFuY2UpCiAgICAgICAgaW50ZXJuYWwKICAgIHsKICAgICAgICAvLyBUaGUgdGltZSBzaW5jZSB0aGUgbGFzdCB0cmFuc2ZlciBjbGFtcHMgYXQgdGhlIGxhc3QgZmVlIHJvbGxvdmVyIHRpbWUgaWYgdGhlIGxhc3QgdHJhbnNmZXIKICAgICAgICAvLyB3YXMgZWFybGllciB0aGFuIHRoYXQuCiAgICAgICAgcm9sbG92ZXJGZWUoYWNjb3VudCwgbGFzdFRyYW5zZmVyVGltZXN0YW1wW2FjY291bnRdLCBwcmVCYWxhbmNlKTsKCiAgICAgICAgY3VycmVudEJhbGFuY2VTdW1bYWNjb3VudF0gPSBzYWZlQWRkKAogICAgICAgICAgICBjdXJyZW50QmFsYW5jZVN1bVthY2NvdW50XSwKICAgICAgICAgICAgc2FmZU11bChwcmVCYWxhbmNlLCBub3cgLSBsYXN0VHJhbnNmZXJUaW1lc3RhbXBbYWNjb3VudF0pCiAgICAgICAgKTsKCiAgICAgICAgLy8gVXBkYXRlIHRoZSBsYXN0IHRpbWUgdGhpcyB1c2VyJ3MgYmFsYW5jZSBjaGFuZ2VkLgogICAgICAgIGxhc3RUcmFuc2ZlclRpbWVzdGFtcFthY2NvdW50XSA9IG5vdzsKICAgIH0KCiAgICAvKiBVcGRhdGUgdGhlIGdpdmVuIGFjY291bnQncyBwcmV2aW91cyBwZXJpb2QgZmVlIGVudGl0bGVtZW50IHZhbHVlLgogICAgICogRG8gbm90aGluZyBpZiB0aGUgbGFzdCB0cmFuc2ZlciBvY2N1cnJlZCBzaW5jZSB0aGUgZmVlIHBlcmlvZCByb2xsZWQgb3Zlci4KICAgICAqIElmIHRoZSBlbnRpdGxlbWVudCB3YXMgdXBkYXRlZCwgYWxzbyB1cGRhdGUgdGhlIGxhc3QgdHJhbnNmZXIgdGltZSB0byBiZQogICAgICogYXQgdGhlIHRpbWVzdGFtcCBvZiB0aGUgcm9sbG92ZXIsIHNvIGlmIHRoaXMgc2hvdWxkIGRvIG5vdGhpbmcgaWYgY2FsbGVkIG1vcmUKICAgICAqIHRoYW4gb25jZSBkdXJpbmcgYSBnaXZlbiBwZXJpb2QuCiAgICAgKgogICAgICogQ29uc2lkZXIgdGhlIGNhc2Ugd2hlcmUgdGhlIGVudGl0bGVtZW50IGlzIHVwZGF0ZWQuIElmIHRoZSBsYXN0IHRyYW5zZmVyCiAgICAgKiBvY2N1cnJlZCBhdCB0aW1lIHQgaW4gdGhlIGxhc3QgcGVyaW9kLCB0aGVuIHRoZSBzdGFycmVkIHJlZ2lvbiBpcyBhZGRlZCB0byB0aGUKICAgICAqIGVudGl0bGVtZW50LCB0aGUgbGFzdCB0cmFuc2ZlciB0aW1lc3RhbXAgaXMgbW92ZWQgdG8gciwgYW5kIHRoZSBmZWUgcGVyaW9kIGlzCiAgICAgKiByb2xsZWQgb3ZlciBmcm9tIGstMSB0byBrIHNvIHRoYXQgdGhlIG5ldyBmZWUgcGVyaW9kIHN0YXJ0IHRpbWUgaXMgYXQgdGltZSByLgogICAgICogCiAgICAgKiAgIGstMSAgICAgICB8ICAgICAgICBrCiAgICAgKiAgICAgICAgIHMgX198CiAgICAgKiAgXyAgXyBfX198Kip8CiAgICAgKiAgICAgICAgICB8Kip8CiAgICAgKiAgXyAgXyBfX198Kip8X19fIF9fIF8gIF8KICAgICAqICAgICAgICAgICAgIHwKICAgICAqICAgICAgICAgIHQgIHwKICAgICAqICAgICAgICAgICAgIHIKICAgICAqIAogICAgICogU2ltaWxhciBjb21wdXRhdGlvbnMgYXJlIHBlcmZvcm1lZCBhY2NvcmRpbmcgdG8gdGhlIGZlZSBwZXJpb2QgaW4gd2hpY2ggdGhlCiAgICAgKiBsYXN0IHRyYW5zZmVyIG9jY3VycmVkLgogICAgICovCiAgICBmdW5jdGlvbiByb2xsb3ZlckZlZShhZGRyZXNzIGFjY291bnQsIHVpbnQgbGFzdFRyYW5zZmVyVGltZSwgdWludCBwcmVCYWxhbmNlKQogICAgICAgIGludGVybmFsCiAgICB7CiAgICAgICAgaWYgKGxhc3RUcmFuc2ZlclRpbWUgPCBmZWVQZXJpb2RTdGFydFRpbWUpIHsKICAgICAgICAgICAgaWYgKGxhc3RUcmFuc2ZlclRpbWUgPCBsYXN0RmVlUGVyaW9kU3RhcnRUaW1lKSB7CiAgICAgICAgICAgICAgICAvLyBUaGUgbGFzdCB0cmFuc2ZlciBwcmVkYXRlZCB0aGUgcHJldmlvdXMgdHdvIGZlZSBwZXJpb2RzLgogICAgICAgICAgICAgICAgaWYgKGxhc3RUcmFuc2ZlclRpbWUgPCBwZW51bHRpbWF0ZUZlZVBlcmlvZFN0YXJ0VGltZSkgewogICAgICAgICAgICAgICAgICAgIC8vIFRoZSBiYWxhbmNlIGRpZCBub3RoaW5nIGluIHRoZSBwZW51bHRpbWF0ZSBmZWUgcGVyaW9kLCBzbyB0aGUgYXZlcmFnZSBiYWxhbmNlCiAgICAgICAgICAgICAgICAgICAgLy8gaW4gdGhpcyBwZXJpb2QgaXMgdGhlaXIgcHJlLXRyYW5zZmVyIGJhbGFuY2UuCiAgICAgICAgICAgICAgICAgICAgcGVudWx0aW1hdGVBdmVyYWdlQmFsYW5jZVthY2NvdW50XSA9IHByZUJhbGFuY2U7CiAgICAgICAgICAgICAgICAvLyBUaGUgbGFzdCB0cmFuc2ZlciBvY2N1cnJlZCB3aXRoaW4gdGhlIG9uZS1iZWZvcmUtdGhlLWxhc3QgZmVlIHBlcmlvZC4KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gTm8gb3ZlcmZsb3cgcmlzayBoZXJlOiB0aGUgZmFpbGVkIGd1YXJkIGltcGxpZXMgKHBlbnVsdGltYXRlRmVlUGVyaW9kU3RhcnRUaW1lIDw9IGxhc3RUcmFuc2ZlclRpbWUpLgogICAgICAgICAgICAgICAgICAgIHBlbnVsdGltYXRlQXZlcmFnZUJhbGFuY2VbYWNjb3VudF0gPSBzYWZlRGl2KAogICAgICAgICAgICAgICAgICAgICAgICBzYWZlQWRkKGN1cnJlbnRCYWxhbmNlU3VtW2FjY291bnRdLCBzYWZlTXVsKHByZUJhbGFuY2UsIChsYXN0RmVlUGVyaW9kU3RhcnRUaW1lIC0gbGFzdFRyYW5zZmVyVGltZSkpKSwKICAgICAgICAgICAgICAgICAgICAgICAgKGxhc3RGZWVQZXJpb2RTdGFydFRpbWUgLSBwZW51bHRpbWF0ZUZlZVBlcmlvZFN0YXJ0VGltZSkKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIFRoZSBiYWxhbmNlIGRpZCBub3RoaW5nIGluIHRoZSBsYXN0IGZlZSBwZXJpb2QsIHNvIHRoZSBhdmVyYWdlIGJhbGFuY2UKICAgICAgICAgICAgICAgIC8vIGluIHRoaXMgcGVyaW9kIGlzIHRoZWlyIHByZS10cmFuc2ZlciBiYWxhbmNlLgogICAgICAgICAgICAgICAgbGFzdEF2ZXJhZ2VCYWxhbmNlW2FjY291bnRdID0gcHJlQmFsYW5jZTsKCiAgICAgICAgICAgIC8vIFRoZSBsYXN0IHRyYW5zZmVyIG9jY3VycmVkIHdpdGhpbiB0aGUgbGFzdCBmZWUgcGVyaW9kLgogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gVGhlIHByZXZpb3VzbHktbGFzdCBhdmVyYWdlIGJhbGFuY2UgYmVjb21lcyB0aGUgcGVudWx0aW1hdGUgYmFsYW5jZS4KICAgICAgICAgICAgICAgIHBlbnVsdGltYXRlQXZlcmFnZUJhbGFuY2VbYWNjb3VudF0gPSBsYXN0QXZlcmFnZUJhbGFuY2VbYWNjb3VudF07CgogICAgICAgICAgICAgICAgLy8gTm8gb3ZlcmZsb3cgcmlzayBoZXJlOiB0aGUgZmFpbGVkIGd1YXJkIGltcGxpZXMgKGxhc3RGZWVQZXJpb2RTdGFydFRpbWUgPD0gbGFzdFRyYW5zZmVyVGltZSkuCiAgICAgICAgICAgICAgICBsYXN0QXZlcmFnZUJhbGFuY2VbYWNjb3VudF0gPSBzYWZlRGl2KAogICAgICAgICAgICAgICAgICAgIHNhZmVBZGQoY3VycmVudEJhbGFuY2VTdW1bYWNjb3VudF0sIHNhZmVNdWwocHJlQmFsYW5jZSwgKGZlZVBlcmlvZFN0YXJ0VGltZSAtIGxhc3RUcmFuc2ZlclRpbWUpKSksCiAgICAgICAgICAgICAgICAgICAgKGZlZVBlcmlvZFN0YXJ0VGltZSAtIGxhc3RGZWVQZXJpb2RTdGFydFRpbWUpCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBSb2xsIG92ZXIgdG8gdGhlIG5leHQgZmVlIHBlcmlvZC4KICAgICAgICAgICAgY3VycmVudEJhbGFuY2VTdW1bYWNjb3VudF0gPSAwOwogICAgICAgICAgICBoYXNXaXRoZHJhd25MYXN0UGVyaW9kRmVlc1thY2NvdW50XSA9IGZhbHNlOwogICAgICAgICAgICBsYXN0VHJhbnNmZXJUaW1lc3RhbXBbYWNjb3VudF0gPSBmZWVQZXJpb2RTdGFydFRpbWU7CiAgICAgICAgfQogICAgfQoKICAgIC8qIFJlY29tcHV0ZSBhbmQgcmV0dXJuIHRoZSBnaXZlbiBhY2NvdW50J3MgYXZlcmFnZSBiYWxhbmNlIGluZm9ybWF0aW9uLgogICAgICogVGhpcyBhbHNvIHJvbGxzIG92ZXIgdGhlIGZlZSBwZXJpb2QgaWYgbmVjZXNzYXJ5LCBhbmQgYnJpbmdzCiAgICAgKiB0aGUgYWNjb3VudCdzIGN1cnJlbnQgYmFsYW5jZSBzdW0gdXAgdG8gZGF0ZS4gKi8KICAgIGZ1bmN0aW9uIF9yZWNvbXB1dGVBY2NvdW50TGFzdEF2ZXJhZ2VCYWxhbmNlKGFkZHJlc3MgYWNjb3VudCkKICAgICAgICBpbnRlcm5hbAogICAgICAgIHByZUNoZWNrRmVlUGVyaW9kUm9sbG92ZXIKICAgICAgICByZXR1cm5zICh1aW50KQogICAgewogICAgICAgIGFkanVzdEZlZUVudGl0bGVtZW50KGFjY291bnQsIHN0YXRlLmJhbGFuY2VPZihhY2NvdW50KSk7CiAgICAgICAgcmV0dXJuIGxhc3RBdmVyYWdlQmFsYW5jZVthY2NvdW50XTsKICAgIH0KCiAgICAvKiBSZWNvbXB1dGUgYW5kIHJldHVybiB0aGUgc2VuZGVyJ3MgYXZlcmFnZSBiYWxhbmNlIGluZm9ybWF0aW9uLiAqLwogICAgZnVuY3Rpb24gcmVjb21wdXRlTGFzdEF2ZXJhZ2VCYWxhbmNlKCkKICAgICAgICBleHRlcm5hbAogICAgICAgIG9wdGlvbmFsUHJveHkKICAgICAgICByZXR1cm5zICh1aW50KQogICAgewogICAgICAgIHJldHVybiBfcmVjb21wdXRlQWNjb3VudExhc3RBdmVyYWdlQmFsYW5jZShtZXNzYWdlU2VuZGVyKTsKICAgIH0KCiAgICAvKiBSZWNvbXB1dGUgYW5kIHJldHVybiB0aGUgZ2l2ZW4gYWNjb3VudCdzIGF2ZXJhZ2UgYmFsYW5jZSBpbmZvcm1hdGlvbi4gKi8KICAgIGZ1bmN0aW9uIHJlY29tcHV0ZUFjY291bnRMYXN0QXZlcmFnZUJhbGFuY2UoYWRkcmVzcyBhY2NvdW50KQogICAgICAgIGV4dGVybmFsCiAgICAgICAgcmV0dXJucyAodWludCkKICAgIHsKICAgICAgICByZXR1cm4gX3JlY29tcHV0ZUFjY291bnRMYXN0QXZlcmFnZUJhbGFuY2UoYWNjb3VudCk7CiAgICB9CgogICAgZnVuY3Rpb24gcm9sbG92ZXJGZWVQZXJpb2QoKQogICAgICAgIHB1YmxpYwogICAgewogICAgICAgIGNoZWNrRmVlUGVyaW9kUm9sbG92ZXIoKTsKICAgIH0KCgogICAgLyogPT09PT09PT09PSBNT0RJRklFUlMgPT09PT09PT09PSAqLwoKICAgIC8qIElmIHRoZSBmZWUgcGVyaW9kIGhhcyByb2xsZWQgb3ZlciwgdGhlbgogICAgICogc2F2ZSB0aGUgc3RhcnQgdGltZXMgb2YgdGhlIGxhc3QgZmVlIHBlcmlvZCwKICAgICAqIGFzIHdlbGwgYXMgdGhlIHBlbnVsdGltYXRlIGZlZSBwZXJpb2QuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNoZWNrRmVlUGVyaW9kUm9sbG92ZXIoKQogICAgICAgIGludGVybmFsCiAgICB7CiAgICAgICAgLy8gSWYgdGhlIGZlZSBwZXJpb2QgaGFzIHJvbGxlZCBvdmVyLi4uCiAgICAgICAgaWYgKGZlZVBlcmlvZFN0YXJ0VGltZSArIHRhcmdldEZlZVBlcmlvZER1cmF0aW9uU2Vjb25kcyA8PSBub3cpIHsKICAgICAgICAgICAgbGFzdEZlZXNDb2xsZWN0ZWQgPSBub21pbi5mZWVQb29sKCk7CgogICAgICAgICAgICAvLyBTaGlmdCB0aGUgdGhyZWUgcGVyaW9kIHN0YXJ0IHRpbWVzIGJhY2sgb25lIHBsYWNlCiAgICAgICAgICAgIHBlbnVsdGltYXRlRmVlUGVyaW9kU3RhcnRUaW1lID0gbGFzdEZlZVBlcmlvZFN0YXJ0VGltZTsKICAgICAgICAgICAgbGFzdEZlZVBlcmlvZFN0YXJ0VGltZSA9IGZlZVBlcmlvZFN0YXJ0VGltZTsKICAgICAgICAgICAgZmVlUGVyaW9kU3RhcnRUaW1lID0gbm93OwogICAgICAgICAgICAKICAgICAgICAgICAgZW1pdCBGZWVQZXJpb2RSb2xsb3Zlcihub3cpOwogICAgICAgIH0KICAgIH0KCiAgICBtb2RpZmllciBwb3N0Q2hlY2tGZWVQZXJpb2RSb2xsb3ZlcgogICAgewogICAgICAgIF87CiAgICAgICAgY2hlY2tGZWVQZXJpb2RSb2xsb3ZlcigpOwogICAgfQoKICAgIG1vZGlmaWVyIHByZUNoZWNrRmVlUGVyaW9kUm9sbG92ZXIKICAgIHsKICAgICAgICBjaGVja0ZlZVBlcmlvZFJvbGxvdmVyKCk7CiAgICAgICAgXzsKICAgIH0KCgogICAgLyogPT09PT09PT09PSBFVkVOVFMgPT09PT09PT09PSAqLwoKICAgIGV2ZW50IEZlZVBlcmlvZFJvbGxvdmVyKHVpbnQgdGltZXN0YW1wKTsKCiAgICBldmVudCBGZWVQZXJpb2REdXJhdGlvblVwZGF0ZWQodWludCBkdXJhdGlvbik7CgogICAgZXZlbnQgRmVlc1dpdGhkcmF3bihhZGRyZXNzIGFjY291bnQsIGFkZHJlc3MgaW5kZXhlZCBhY2NvdW50SW5kZXgsIHVpbnQgdmFsdWUpOwp9CgovKgotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQpDT05UUkFDVCBERVNDUklQVElPTgotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoKQSBjb250cmFjdCB0aGF0IGhvbGRzIHRoZSBzdGF0ZSBvZiBhbiBFUkMyMCBjb21wbGlhbnQgdG9rZW4uCgpUaGlzIGNvbnRyYWN0IGlzIHVzZWQgc2lkZSBieSBzaWRlIHdpdGggZXh0ZXJuYWwgc3RhdGUgdG9rZW4KY29udHJhY3RzLCBzdWNoIGFzIEhhdnZlbiBhbmQgRXRoZXJOb21pbi4KSXQgcHJvdmlkZXMgYW4gZWFzeSB3YXkgdG8gdXBncmFkZSBjb250cmFjdCBsb2dpYyB3aGlsZQptYWludGFpbmluZyBhbGwgdXNlciBiYWxhbmNlcyBhbmQgYWxsb3dhbmNlcy4gVGhpcyBpcyBkZXNpZ25lZAp0byB0byBtYWtlIHRoZSBjaGFuZ2VvdmVyIGFzIGVhc3kgYXMgcG9zc2libGUsIHNpbmNlIG1hcHBpbmdzCmFyZSBub3Qgc28gY2hlYXAgb3Igc3RyYWlnaHRmb3J3YXJkIHRvIG1pZ3JhdGUuCgpUaGUgZmlyc3QgZGVwbG95ZWQgY29udHJhY3Qgd291bGQgY3JlYXRlIHRoaXMgc3RhdGUgY29udHJhY3QsCnVzaW5nIGl0IGFzIGl0cyBzdG9yZSBvZiBiYWxhbmNlcy4KV2hlbiBhIG5ldyBjb250cmFjdCBpcyBkZXBsb3llZCwgaXQgbGlua3MgdG8gdGhlIGV4aXN0aW5nCnN0YXRlIGNvbnRyYWN0LCB3aG9zZSBvd25lciB3b3VsZCB0aGVuIGNoYW5nZSBpdHMgYXNzb2NpYXRlZApjb250cmFjdCB0byB0aGUgbmV3IG9uZS4KCi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiovCgpjb250cmFjdCBUb2tlblN0YXRlIGlzIE93bmVkIHsKCiAgICAvLyB0aGUgYWRkcmVzcyBvZiB0aGUgY29udHJhY3QgdGhhdCBjYW4gbW9kaWZ5IGJhbGFuY2VzIGFuZCBhbGxvd2FuY2VzCiAgICAvLyB0aGlzIGNhbiBvbmx5IGJlIGNoYW5nZWQgYnkgdGhlIG93bmVyIG9mIHRoaXMgY29udHJhY3QKICAgIGFkZHJlc3MgcHVibGljIGFzc29jaWF0ZWRDb250cmFjdDsKCiAgICAvLyBFUkMyMCBmaWVsZHMuCiAgICBtYXBwaW5nKGFkZHJlc3MgPT4gdWludCkgcHVibGljIGJhbGFuY2VPZjsKICAgIG1hcHBpbmcoYWRkcmVzcyA9PiBtYXBwaW5nKGFkZHJlc3MgPT4gdWludCkpIHB1YmxpYyBhbGxvd2FuY2U7CgogICAgZnVuY3Rpb24gVG9rZW5TdGF0ZShhZGRyZXNzIF9vd25lciwgYWRkcmVzcyBfYXNzb2NpYXRlZENvbnRyYWN0KQogICAgICAgIE93bmVkKF9vd25lcikKICAgICAgICBwdWJsaWMKICAgIHsKICAgICAgICBhc3NvY2lhdGVkQ29udHJhY3QgPSBfYXNzb2NpYXRlZENvbnRyYWN0OwogICAgICAgIGVtaXQgQXNzb2NpYXRlZENvbnRyYWN0VXBkYXRlZChfYXNzb2NpYXRlZENvbnRyYWN0KTsKICAgIH0KCiAgICAvKiA9PT09PT09PT09IFNFVFRFUlMgPT09PT09PT09PSAqLwoKICAgIC8vIENoYW5nZSB0aGUgYXNzb2NpYXRlZCBjb250cmFjdCB0byBhIG5ldyBhZGRyZXNzCiAgICBmdW5jdGlvbiBzZXRBc3NvY2lhdGVkQ29udHJhY3QoYWRkcmVzcyBfYXNzb2NpYXRlZENvbnRyYWN0KQogICAgICAgIGV4dGVybmFsCiAgICAgICAgb25seU93bmVyCiAgICB7CiAgICAgICAgYXNzb2NpYXRlZENvbnRyYWN0ID0gX2Fzc29jaWF0ZWRDb250cmFjdDsKICAgICAgICBlbWl0IEFzc29jaWF0ZWRDb250cmFjdFVwZGF0ZWQoX2Fzc29jaWF0ZWRDb250cmFjdCk7CiAgICB9CgogICAgZnVuY3Rpb24gc2V0QWxsb3dhbmNlKGFkZHJlc3MgdG9rZW5Pd25lciwgYWRkcmVzcyBzcGVuZGVyLCB1aW50IHZhbHVlKQogICAgICAgIGV4dGVybmFsCiAgICAgICAgb25seUFzc29jaWF0ZWRDb250cmFjdAogICAgewogICAgICAgIGFsbG93YW5jZVt0b2tlbk93bmVyXVtzcGVuZGVyXSA9IHZhbHVlOwogICAgfQoKICAgIGZ1bmN0aW9uIHNldEJhbGFuY2VPZihhZGRyZXNzIGFjY291bnQsIHVpbnQgdmFsdWUpCiAgICAgICAgZXh0ZXJuYWwKICAgICAgICBvbmx5QXNzb2NpYXRlZENvbnRyYWN0CiAgICB7CiAgICAgICAgYmFsYW5jZU9mW2FjY291bnRdID0gdmFsdWU7CiAgICB9CgoKICAgIC8qID09PT09PT09PT0gTU9ESUZJRVJTID09PT09PT09PT0gKi8KCiAgICBtb2RpZmllciBvbmx5QXNzb2NpYXRlZENvbnRyYWN0CiAgICB7CiAgICAgICAgcmVxdWlyZShtc2cuc2VuZGVyID09IGFzc29jaWF0ZWRDb250cmFjdCk7CiAgICAgICAgXzsKICAgIH0KCiAgICAvKiA9PT09PT09PT09IEVWRU5UUyA9PT09PT09PT09ICovCgogICAgZXZlbnQgQXNzb2NpYXRlZENvbnRyYWN0VXBkYXRlZChhZGRyZXNzIF9hc3NvY2lhdGVkQ29udHJhY3QpOwp9'.
	

]
