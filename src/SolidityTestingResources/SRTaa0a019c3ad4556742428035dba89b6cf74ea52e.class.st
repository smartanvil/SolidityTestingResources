Class {
	#name : #SRTaa0a019c3ad4556742428035dba89b6cf74ea52e,
	#superclass : #SRTContracts,
	#category : #SolidityTestingResources
}

{ #category : #base64 }
SRTaa0a019c3ad4556742428035dba89b6cf74ea52e >> base64 [
	^ 'Y29udHJhY3QgRUlQMjBJbnRlcmZhY2UgewogICAgLyogVGhpcyBpcyBhIHNsaWdodCBjaGFuZ2UgdG8gdGhlIEVSQzIwIGJhc2Ugc3RhbmRhcmQuCiAgICBmdW5jdGlvbiB0b3RhbFN1cHBseSgpIGNvbnN0YW50IHJldHVybnMgKHVpbnQyNTYgc3VwcGx5KTsKICAgIGlzIHJlcGxhY2VkIHdpdGg6CiAgICB1aW50MjU2IHB1YmxpYyB0b3RhbFN1cHBseTsKICAgIFRoaXMgYXV0b21hdGljYWxseSBjcmVhdGVzIGEgZ2V0dGVyIGZ1bmN0aW9uIGZvciB0aGUgdG90YWxTdXBwbHkuCiAgICBUaGlzIGlzIG1vdmVkIHRvIHRoZSBiYXNlIGNvbnRyYWN0IHNpbmNlIHB1YmxpYyBnZXR0ZXIgZnVuY3Rpb25zIGFyZSBub3QKICAgIGN1cnJlbnRseSByZWNvZ25pc2VkIGFzIGFuIGltcGxlbWVudGF0aW9uIG9mIHRoZSBtYXRjaGluZyBhYnN0cmFjdAogICAgZnVuY3Rpb24gYnkgdGhlIGNvbXBpbGVyLgogICAgKi8KICAgIC8vLyB0b3RhbCBhbW91bnQgb2YgdG9rZW5zCiAgICB1aW50MjU2IHB1YmxpYyB0b3RhbFN1cHBseTsKCiAgICAvLy8gQHBhcmFtIF9vd25lciBUaGUgYWRkcmVzcyBmcm9tIHdoaWNoIHRoZSBiYWxhbmNlIHdpbGwgYmUgcmV0cmlldmVkCiAgICAvLy8gQHJldHVybiBUaGUgYmFsYW5jZQogICAgZnVuY3Rpb24gYmFsYW5jZU9mKGFkZHJlc3MgX293bmVyKSBwdWJsaWMgdmlldyByZXR1cm5zICh1aW50MjU2IGJhbGFuY2UpOwoKICAgIC8vLyBAbm90aWNlIHNlbmQgYF92YWx1ZWAgdG9rZW4gdG8gYF90b2AgZnJvbSBgbXNnLnNlbmRlcmAKICAgIC8vLyBAcGFyYW0gX3RvIFRoZSBhZGRyZXNzIG9mIHRoZSByZWNpcGllbnQKICAgIC8vLyBAcGFyYW0gX3ZhbHVlIFRoZSBhbW91bnQgb2YgdG9rZW4gdG8gYmUgdHJhbnNmZXJyZWQKICAgIC8vLyBAcmV0dXJuIFdoZXRoZXIgdGhlIHRyYW5zZmVyIHdhcyBzdWNjZXNzZnVsIG9yIG5vdAogICAgZnVuY3Rpb24gdHJhbnNmZXIoYWRkcmVzcyBfdG8sIHVpbnQyNTYgX3ZhbHVlKSBwdWJsaWMgcmV0dXJucyAoYm9vbCBzdWNjZXNzKTsKCiAgICAvLy8gQG5vdGljZSBzZW5kIGBfdmFsdWVgIHRva2VuIHRvIGBfdG9gIGZyb20gYF9mcm9tYCBvbiB0aGUgY29uZGl0aW9uIGl0IGlzIGFwcHJvdmVkIGJ5IGBfZnJvbWAKICAgIC8vLyBAcGFyYW0gX2Zyb20gVGhlIGFkZHJlc3Mgb2YgdGhlIHNlbmRlcgogICAgLy8vIEBwYXJhbSBfdG8gVGhlIGFkZHJlc3Mgb2YgdGhlIHJlY2lwaWVudAogICAgLy8vIEBwYXJhbSBfdmFsdWUgVGhlIGFtb3VudCBvZiB0b2tlbiB0byBiZSB0cmFuc2ZlcnJlZAogICAgLy8vIEByZXR1cm4gV2hldGhlciB0aGUgdHJhbnNmZXIgd2FzIHN1Y2Nlc3NmdWwgb3Igbm90CiAgICBmdW5jdGlvbiB0cmFuc2ZlckZyb20oYWRkcmVzcyBfZnJvbSwgYWRkcmVzcyBfdG8sIHVpbnQyNTYgX3ZhbHVlKSBwdWJsaWMgcmV0dXJucyAoYm9vbCBzdWNjZXNzKTsKCiAgICAvLy8gQG5vdGljZSBgbXNnLnNlbmRlcmAgYXBwcm92ZXMgYF9zcGVuZGVyYCB0byBzcGVuZCBgX3ZhbHVlYCB0b2tlbnMKICAgIC8vLyBAcGFyYW0gX3NwZW5kZXIgVGhlIGFkZHJlc3Mgb2YgdGhlIGFjY291bnQgYWJsZSB0byB0cmFuc2ZlciB0aGUgdG9rZW5zCiAgICAvLy8gQHBhcmFtIF92YWx1ZSBUaGUgYW1vdW50IG9mIHRva2VucyB0byBiZSBhcHByb3ZlZCBmb3IgdHJhbnNmZXIKICAgIC8vLyBAcmV0dXJuIFdoZXRoZXIgdGhlIGFwcHJvdmFsIHdhcyBzdWNjZXNzZnVsIG9yIG5vdAogICAgZnVuY3Rpb24gYXBwcm92ZShhZGRyZXNzIF9zcGVuZGVyLCB1aW50MjU2IF92YWx1ZSkgcHVibGljIHJldHVybnMgKGJvb2wgc3VjY2Vzcyk7CgogICAgLy8vIEBwYXJhbSBfb3duZXIgVGhlIGFkZHJlc3Mgb2YgdGhlIGFjY291bnQgb3duaW5nIHRva2VucwogICAgLy8vIEBwYXJhbSBfc3BlbmRlciBUaGUgYWRkcmVzcyBvZiB0aGUgYWNjb3VudCBhYmxlIHRvIHRyYW5zZmVyIHRoZSB0b2tlbnMKICAgIC8vLyBAcmV0dXJuIEFtb3VudCBvZiByZW1haW5pbmcgdG9rZW5zIGFsbG93ZWQgdG8gc3BlbnQKICAgIGZ1bmN0aW9uIGFsbG93YW5jZShhZGRyZXNzIF9vd25lciwgYWRkcmVzcyBfc3BlbmRlcikgcHVibGljIHZpZXcgcmV0dXJucyAodWludDI1NiByZW1haW5pbmcpOwoKICAgIGV2ZW50IFRyYW5zZmVyKGFkZHJlc3MgaW5kZXhlZCBfZnJvbSwgYWRkcmVzcyBpbmRleGVkIF90bywgdWludDI1NiBfdmFsdWUpOwogICAgZXZlbnQgQXBwcm92YWwoYWRkcmVzcyBpbmRleGVkIF9vd25lciwgYWRkcmVzcyBpbmRleGVkIF9zcGVuZGVyLCB1aW50MjU2IF92YWx1ZSk7Cn0KCmNvbnRyYWN0IEVJUDIwIGlzIEVJUDIwSW50ZXJmYWNlIHsKCiAgICB1aW50MjU2IGNvbnN0YW50IE1BWF9VSU5UMjU2ID0gMioqMjU2IC0gMTsKCiAgICAvKgogICAgTk9URToKICAgIFRoZSBmb2xsb3dpbmcgdmFyaWFibGVzIGFyZSBPUFRJT05BTCB2YW5pdGllcy4gT25lIGRvZXMgbm90IGhhdmUgdG8gaW5jbHVkZSB0aGVtLgogICAgVGhleSBhbGxvdyBvbmUgdG8gY3VzdG9taXNlIHRoZSB0b2tlbiBjb250cmFjdCAmIGluIG5vIHdheSBpbmZsdWVuY2VzIHRoZSBjb3JlIGZ1bmN0aW9uYWxpdHkuCiAgICBTb21lIHdhbGxldHMvaW50ZXJmYWNlcyBtaWdodCBub3QgZXZlbiBib3RoZXIgdG8gbG9vayBhdCB0aGlzIGluZm9ybWF0aW9uLgogICAgKi8KICAgIHN0cmluZyBwdWJsaWMgbmFtZTsgICAgICAgICAgICAgICAgICAgLy9mYW5jeSBuYW1lOiBlZyBTaW1vbiBCdWNrcwogICAgdWludDggcHVibGljIGRlY2ltYWxzOyAgICAgICAgICAgICAgICAvL0hvdyBtYW55IGRlY2ltYWxzIHRvIHNob3cuCiAgICBzdHJpbmcgcHVibGljIHN5bWJvbDsgICAgICAgICAgICAgICAgIC8vQW4gaWRlbnRpZmllcjogZWcgU0JYCgogICAgIGZ1bmN0aW9uIEVJUDIwKAogICAgICAgIHVpbnQyNTYgX2luaXRpYWxBbW91bnQsCiAgICAgICAgc3RyaW5nIF90b2tlbk5hbWUsCiAgICAgICAgdWludDggX2RlY2ltYWxVbml0cywKICAgICAgICBzdHJpbmcgX3Rva2VuU3ltYm9sCiAgICAgICAgKSBwdWJsaWMgewogICAgICAgIGJhbGFuY2VzW21zZy5zZW5kZXJdID0gX2luaXRpYWxBbW91bnQ7ICAgICAgICAgICAgICAgLy8gR2l2ZSB0aGUgY3JlYXRvciBhbGwgaW5pdGlhbCB0b2tlbnMKICAgICAgICB0b3RhbFN1cHBseSA9IF9pbml0aWFsQW1vdW50OyAgICAgICAgICAgICAgICAgICAgICAgIC8vIFVwZGF0ZSB0b3RhbCBzdXBwbHkKICAgICAgICBuYW1lID0gX3Rva2VuTmFtZTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNldCB0aGUgbmFtZSBmb3IgZGlzcGxheSBwdXJwb3NlcwogICAgICAgIGRlY2ltYWxzID0gX2RlY2ltYWxVbml0czsgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gQW1vdW50IG9mIGRlY2ltYWxzIGZvciBkaXNwbGF5IHB1cnBvc2VzCiAgICAgICAgc3ltYm9sID0gX3Rva2VuU3ltYm9sOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBTZXQgdGhlIHN5bWJvbCBmb3IgZGlzcGxheSBwdXJwb3NlcwogICAgfQoKICAgIGZ1bmN0aW9uIHRyYW5zZmVyKGFkZHJlc3MgX3RvLCB1aW50MjU2IF92YWx1ZSkgcHVibGljIHJldHVybnMgKGJvb2wgc3VjY2VzcykgewogICAgICAgIC8vRGVmYXVsdCBhc3N1bWVzIHRvdGFsU3VwcGx5IGNhbid0IGJlIG92ZXIgbWF4ICgyXjI1NiAtIDEpLgogICAgICAgIC8vSWYgeW91ciB0b2tlbiBsZWF2ZXMgb3V0IHRvdGFsU3VwcGx5IGFuZCBjYW4gaXNzdWUgbW9yZSB0b2tlbnMgYXMgdGltZSBnb2VzIG9uLCB5b3UgbmVlZCB0byBjaGVjayBpZiBpdCBkb2Vzbid0IHdyYXAuCiAgICAgICAgLy9SZXBsYWNlIHRoZSBpZiB3aXRoIHRoaXMgb25lIGluc3RlYWQuCiAgICAgICAgLy9yZXF1aXJlKGJhbGFuY2VzW21zZy5zZW5kZXJdID49IF92YWx1ZSAmJiBiYWxhbmNlc1tfdG9dICsgX3ZhbHVlID4gYmFsYW5jZXNbX3RvXSk7CiAgICAgICAgcmVxdWlyZShiYWxhbmNlc1ttc2cuc2VuZGVyXSA+PSBfdmFsdWUpOwogICAgICAgIGJhbGFuY2VzW21zZy5zZW5kZXJdIC09IF92YWx1ZTsKICAgICAgICBiYWxhbmNlc1tfdG9dICs9IF92YWx1ZTsKICAgICAgICBUcmFuc2Zlcihtc2cuc2VuZGVyLCBfdG8sIF92YWx1ZSk7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgZnVuY3Rpb24gdHJhbnNmZXJGcm9tKGFkZHJlc3MgX2Zyb20sIGFkZHJlc3MgX3RvLCB1aW50MjU2IF92YWx1ZSkgcHVibGljIHJldHVybnMgKGJvb2wgc3VjY2VzcykgewogICAgICAgIC8vc2FtZSBhcyBhYm92ZS4gUmVwbGFjZSB0aGlzIGxpbmUgd2l0aCB0aGUgZm9sbG93aW5nIGlmIHlvdSB3YW50IHRvIHByb3RlY3QgYWdhaW5zdCB3cmFwcGluZyB1aW50cy4KICAgICAgICAvL3JlcXVpcmUoYmFsYW5jZXNbX2Zyb21dID49IF92YWx1ZSAmJiBhbGxvd2VkW19mcm9tXVttc2cuc2VuZGVyXSA+PSBfdmFsdWUgJiYgYmFsYW5jZXNbX3RvXSArIF92YWx1ZSA+IGJhbGFuY2VzW190b10pOwogICAgICAgIHVpbnQyNTYgYWxsb3dhbmNlID0gYWxsb3dlZFtfZnJvbV1bbXNnLnNlbmRlcl07CiAgICAgICAgcmVxdWlyZShiYWxhbmNlc1tfZnJvbV0gPj0gX3ZhbHVlICYmIGFsbG93YW5jZSA+PSBfdmFsdWUpOwogICAgICAgIGJhbGFuY2VzW190b10gKz0gX3ZhbHVlOwogICAgICAgIGJhbGFuY2VzW19mcm9tXSAtPSBfdmFsdWU7CiAgICAgICAgaWYgKGFsbG93YW5jZSA8IE1BWF9VSU5UMjU2KSB7CiAgICAgICAgICAgIGFsbG93ZWRbX2Zyb21dW21zZy5zZW5kZXJdIC09IF92YWx1ZTsKICAgICAgICB9CiAgICAgICAgVHJhbnNmZXIoX2Zyb20sIF90bywgX3ZhbHVlKTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICBmdW5jdGlvbiBiYWxhbmNlT2YoYWRkcmVzcyBfb3duZXIpIHZpZXcgcHVibGljIHJldHVybnMgKHVpbnQyNTYgYmFsYW5jZSkgewogICAgICAgIHJldHVybiBiYWxhbmNlc1tfb3duZXJdOwogICAgfQoKICAgIGZ1bmN0aW9uIGFwcHJvdmUoYWRkcmVzcyBfc3BlbmRlciwgdWludDI1NiBfdmFsdWUpIHB1YmxpYyByZXR1cm5zIChib29sIHN1Y2Nlc3MpIHsKICAgICAgICBhbGxvd2VkW21zZy5zZW5kZXJdW19zcGVuZGVyXSA9IF92YWx1ZTsKICAgICAgICBBcHByb3ZhbChtc2cuc2VuZGVyLCBfc3BlbmRlciwgX3ZhbHVlKTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICBmdW5jdGlvbiBhbGxvd2FuY2UoYWRkcmVzcyBfb3duZXIsIGFkZHJlc3MgX3NwZW5kZXIpCiAgICB2aWV3IHB1YmxpYyByZXR1cm5zICh1aW50MjU2IHJlbWFpbmluZykgewogICAgICByZXR1cm4gYWxsb3dlZFtfb3duZXJdW19zcGVuZGVyXTsKICAgIH0KCiAgICBtYXBwaW5nIChhZGRyZXNzID0+IHVpbnQyNTYpIGJhbGFuY2VzOwogICAgbWFwcGluZyAoYWRkcmVzcyA9PiBtYXBwaW5nIChhZGRyZXNzID0+IHVpbnQyNTYpKSBhbGxvd2VkOwp9CgpsaWJyYXJ5IERMTCB7CgogIHVpbnQgY29uc3RhbnQgTlVMTF9OT0RFX0lEID0gMDsKCiAgc3RydWN0IE5vZGUgewogICAgdWludCBuZXh0OwogICAgdWludCBwcmV2OwogIH0KCiAgc3RydWN0IERhdGEgewogICAgbWFwcGluZyh1aW50ID0+IE5vZGUpIGRsbDsKICB9CgogIGZ1bmN0aW9uIGlzRW1wdHkoRGF0YSBzdG9yYWdlIHNlbGYpIHB1YmxpYyB2aWV3IHJldHVybnMgKGJvb2wpIHsKICAgIHJldHVybiBnZXRTdGFydChzZWxmKSA9PSBOVUxMX05PREVfSUQ7CiAgfQoKICBmdW5jdGlvbiBjb250YWlucyhEYXRhIHN0b3JhZ2Ugc2VsZiwgdWludCBfY3VycikgcHVibGljIHZpZXcgcmV0dXJucyAoYm9vbCkgewogICAgaWYgKGlzRW1wdHkoc2VsZikgfHwgX2N1cnIgPT0gTlVMTF9OT0RFX0lEKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0gCgogICAgYm9vbCBpc1NpbmdsZU5vZGUgPSAoZ2V0U3RhcnQoc2VsZikgPT0gX2N1cnIpICYmIChnZXRFbmQoc2VsZikgPT0gX2N1cnIpOwogICAgYm9vbCBpc051bGxOb2RlID0gKGdldE5leHQoc2VsZiwgX2N1cnIpID09IE5VTExfTk9ERV9JRCkgJiYgKGdldFByZXYoc2VsZiwgX2N1cnIpID09IE5VTExfTk9ERV9JRCk7CiAgICByZXR1cm4gaXNTaW5nbGVOb2RlIHx8ICFpc051bGxOb2RlOwogIH0KCiAgZnVuY3Rpb24gZ2V0TmV4dChEYXRhIHN0b3JhZ2Ugc2VsZiwgdWludCBfY3VycikgcHVibGljIHZpZXcgcmV0dXJucyAodWludCkgewogICAgcmV0dXJuIHNlbGYuZGxsW19jdXJyXS5uZXh0OwogIH0KCiAgZnVuY3Rpb24gZ2V0UHJldihEYXRhIHN0b3JhZ2Ugc2VsZiwgdWludCBfY3VycikgcHVibGljIHZpZXcgcmV0dXJucyAodWludCkgewogICAgcmV0dXJuIHNlbGYuZGxsW19jdXJyXS5wcmV2OwogIH0KCiAgZnVuY3Rpb24gZ2V0U3RhcnQoRGF0YSBzdG9yYWdlIHNlbGYpIHB1YmxpYyB2aWV3IHJldHVybnMgKHVpbnQpIHsKICAgIHJldHVybiBnZXROZXh0KHNlbGYsIE5VTExfTk9ERV9JRCk7CiAgfQoKICBmdW5jdGlvbiBnZXRFbmQoRGF0YSBzdG9yYWdlIHNlbGYpIHB1YmxpYyB2aWV3IHJldHVybnMgKHVpbnQpIHsKICAgIHJldHVybiBnZXRQcmV2KHNlbGYsIE5VTExfTk9ERV9JRCk7CiAgfQoKICAvKioKICBAZGV2IEluc2VydHMgYSBuZXcgbm9kZSBiZXR3ZWVuIF9wcmV2IGFuZCBfbmV4dC4gV2hlbiBpbnNlcnRpbmcgYSBub2RlIGFscmVhZHkgZXhpc3RpbmcgaW4gCiAgdGhlIGxpc3QgaXQgd2lsbCBiZSBhdXRvbWF0aWNhbGx5IHJlbW92ZWQgZnJvbSB0aGUgb2xkIHBvc2l0aW9uLgogIEBwYXJhbSBfcHJldiB0aGUgbm9kZSB3aGljaCBfbmV3IHdpbGwgYmUgaW5zZXJ0ZWQgYWZ0ZXIKICBAcGFyYW0gX2N1cnIgdGhlIGlkIG9mIHRoZSBuZXcgbm9kZSBiZWluZyBpbnNlcnRlZAogIEBwYXJhbSBfbmV4dCB0aGUgbm9kZSB3aGljaCBfbmV3IHdpbGwgYmUgaW5zZXJ0ZWQgYmVmb3JlCiAgKi8KICBmdW5jdGlvbiBpbnNlcnQoRGF0YSBzdG9yYWdlIHNlbGYsIHVpbnQgX3ByZXYsIHVpbnQgX2N1cnIsIHVpbnQgX25leHQpIHB1YmxpYyB7CiAgICByZXF1aXJlKF9jdXJyICE9IE5VTExfTk9ERV9JRCk7CiAgICByZXF1aXJlKF9wcmV2ID09IE5VTExfTk9ERV9JRCB8fCBjb250YWlucyhzZWxmLCBfcHJldikpOwoKICAgIHJlbW92ZShzZWxmLCBfY3Vycik7CgogICAgcmVxdWlyZShnZXROZXh0KHNlbGYsIF9wcmV2KSA9PSBfbmV4dCk7CgogICAgc2VsZi5kbGxbX2N1cnJdLnByZXYgPSBfcHJldjsKICAgIHNlbGYuZGxsW19jdXJyXS5uZXh0ID0gX25leHQ7CgogICAgc2VsZi5kbGxbX3ByZXZdLm5leHQgPSBfY3VycjsKICAgIHNlbGYuZGxsW19uZXh0XS5wcmV2ID0gX2N1cnI7CiAgfQoKICBmdW5jdGlvbiByZW1vdmUoRGF0YSBzdG9yYWdlIHNlbGYsIHVpbnQgX2N1cnIpIHB1YmxpYyB7CiAgICBpZiAoIWNvbnRhaW5zKHNlbGYsIF9jdXJyKSkgewogICAgICByZXR1cm47CiAgICB9CgogICAgdWludCBuZXh0ID0gZ2V0TmV4dChzZWxmLCBfY3Vycik7CiAgICB1aW50IHByZXYgPSBnZXRQcmV2KHNlbGYsIF9jdXJyKTsKCiAgICBzZWxmLmRsbFtuZXh0XS5wcmV2ID0gcHJldjsKICAgIHNlbGYuZGxsW3ByZXZdLm5leHQgPSBuZXh0OwoKICAgIGRlbGV0ZSBzZWxmLmRsbFtfY3Vycl07CiAgfQp9CgpsaWJyYXJ5IEF0dHJpYnV0ZVN0b3JlIHsKICAgIHN0cnVjdCBEYXRhIHsKICAgICAgICBtYXBwaW5nKGJ5dGVzMzIgPT4gdWludCkgc3RvcmU7CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0QXR0cmlidXRlKERhdGEgc3RvcmFnZSBzZWxmLCBieXRlczMyIF9VVUlELCBzdHJpbmcgX2F0dHJOYW1lKQogICAgcHVibGljIHZpZXcgcmV0dXJucyAodWludCkgewogICAgICAgIGJ5dGVzMzIga2V5ID0ga2VjY2FrMjU2KF9VVUlELCBfYXR0ck5hbWUpOwogICAgICAgIHJldHVybiBzZWxmLnN0b3JlW2tleV07CiAgICB9CgogICAgZnVuY3Rpb24gc2V0QXR0cmlidXRlKERhdGEgc3RvcmFnZSBzZWxmLCBieXRlczMyIF9VVUlELCBzdHJpbmcgX2F0dHJOYW1lLCB1aW50IF9hdHRyVmFsKQogICAgcHVibGljIHsKICAgICAgICBieXRlczMyIGtleSA9IGtlY2NhazI1NihfVVVJRCwgX2F0dHJOYW1lKTsKICAgICAgICBzZWxmLnN0b3JlW2tleV0gPSBfYXR0clZhbDsKICAgIH0KfQoKY29udHJhY3QgUExDUlZvdGluZyB7CgogICAgLy8gPT09PT09PT09PT09CiAgICAvLyBFVkVOVFM6CiAgICAvLyA9PT09PT09PT09PT0KCiAgICBldmVudCBWb3RlQ29tbWl0dGVkKGFkZHJlc3Mgdm90ZXIsIHVpbnQgcG9sbElELCB1aW50IG51bVRva2Vucyk7CiAgICBldmVudCBWb3RlUmV2ZWFsZWQoYWRkcmVzcyB2b3RlciwgdWludCBwb2xsSUQsIHVpbnQgbnVtVG9rZW5zLCB1aW50IGNob2ljZSk7CiAgICBldmVudCBQb2xsQ3JlYXRlZCh1aW50IHZvdGVRdW9ydW0sIHVpbnQgY29tbWl0RHVyYXRpb24sIHVpbnQgcmV2ZWFsRHVyYXRpb24sIHVpbnQgcG9sbElEKTsKICAgIGV2ZW50IFZvdGluZ1JpZ2h0c0dyYW50ZWQoYWRkcmVzcyB2b3RlciwgdWludCBudW1Ub2tlbnMpOwogICAgZXZlbnQgVm90aW5nUmlnaHRzV2l0aGRyYXduKGFkZHJlc3Mgdm90ZXIsIHVpbnQgbnVtVG9rZW5zKTsKCiAgICAvLyA9PT09PT09PT09PT0KICAgIC8vIERBVEEgU1RSVUNUVVJFUzoKICAgIC8vID09PT09PT09PT09PQoKICAgIHVzaW5nIEF0dHJpYnV0ZVN0b3JlIGZvciBBdHRyaWJ1dGVTdG9yZS5EYXRhOwogICAgdXNpbmcgRExMIGZvciBETEwuRGF0YTsKCiAgICBzdHJ1Y3QgUG9sbCB7CiAgICAgICAgdWludCBjb21taXRFbmREYXRlOyAgICAgLy8vIGV4cGlyYXRpb24gZGF0ZSBvZiBjb21taXQgcGVyaW9kIGZvciBwb2xsCiAgICAgICAgdWludCByZXZlYWxFbmREYXRlOyAgICAgLy8vIGV4cGlyYXRpb24gZGF0ZSBvZiByZXZlYWwgcGVyaW9kIGZvciBwb2xsCiAgICAgICAgdWludCB2b3RlUXVvcnVtOwkgICAgLy8vIG51bWJlciBvZiB2b3RlcyByZXF1aXJlZCBmb3IgYSBwcm9wb3NhbCB0byBwYXNzCiAgICAgICAgdWludCB2b3Rlc0ZvcjsJCSAgICAvLy8gdGFsbHkgb2Ygdm90ZXMgc3VwcG9ydGluZyBwcm9wb3NhbAogICAgICAgIHVpbnQgdm90ZXNBZ2FpbnN0OyAgICAgIC8vLyB0YWxseSBvZiB2b3RlcyBjb3VudGVyaW5nIHByb3Bvc2FsCiAgICB9CiAgICAKICAgIC8vID09PT09PT09PT09PQogICAgLy8gU1RBVEUgVkFSSUFCTEVTOgogICAgLy8gPT09PT09PT09PT09CgogICAgdWludCBjb25zdGFudCBwdWJsaWMgSU5JVElBTF9QT0xMX05PTkNFID0gMDsKICAgIHVpbnQgcHVibGljIHBvbGxOb25jZTsKCiAgICBtYXBwaW5nKHVpbnQgPT4gUG9sbCkgcHVibGljIHBvbGxNYXA7IC8vIG1hcHMgcG9sbElEIHRvIFBvbGwgc3RydWN0CiAgICBtYXBwaW5nKGFkZHJlc3MgPT4gdWludCkgcHVibGljIHZvdGVUb2tlbkJhbGFuY2U7IC8vIG1hcHMgdXNlcidzIGFkZHJlc3MgdG8gdm90ZVRva2VuIGJhbGFuY2UKCiAgICBtYXBwaW5nKGFkZHJlc3MgPT4gRExMLkRhdGEpIGRsbE1hcDsKICAgIEF0dHJpYnV0ZVN0b3JlLkRhdGEgc3RvcmU7CgogICAgRUlQMjAgcHVibGljIHRva2VuOwoKICAgIC8vID09PT09PT09PT09PQogICAgLy8gQ09OU1RSVUNUT1I6CiAgICAvLyA9PT09PT09PT09PT0KCiAgICAvKioKICAgIEBkZXYgSW5pdGlhbGl6ZXMgdm90ZVF1b3J1bSwgY29tbWl0RHVyYXRpb24sIHJldmVhbER1cmF0aW9uLCBhbmQgcG9sbE5vbmNlIGluIGFkZGl0aW9uIHRvIHRva2VuIGNvbnRyYWN0IGFuZCB0cnVzdGVkIG1hcHBpbmcKICAgIEBwYXJhbSBfdG9rZW5BZGRyIFRoZSBhZGRyZXNzIHdoZXJlIHRoZSBFUkMyMCB0b2tlbiBjb250cmFjdCBpcyBkZXBsb3llZAogICAgKi8KICAgIGZ1bmN0aW9uIFBMQ1JWb3RpbmcoYWRkcmVzcyBfdG9rZW5BZGRyKSBwdWJsaWMgewogICAgICAgIHRva2VuID0gRUlQMjAoX3Rva2VuQWRkcik7CiAgICAgICAgcG9sbE5vbmNlID0gSU5JVElBTF9QT0xMX05PTkNFOwogICAgfQoKICAgIC8vID09PT09PT09PT09PT09PT0KICAgIC8vIFRPS0VOIElOVEVSRkFDRToKICAgIC8vID09PT09PT09PT09PT09PT0KCiAgICAvKiogICAgCiAgICBAbm90aWNlIExvYWRzIF9udW1Ub2tlbnMgRVJDMjAgdG9rZW5zIGludG8gdGhlIHZvdGluZyBjb250cmFjdCBmb3Igb25lLXRvLW9uZSB2b3RpbmcgcmlnaHRzCiAgICBAZGV2IEFzc3VtZXMgdGhhdCBtc2cuc2VuZGVyIGhhcyBhcHByb3ZlZCB2b3RpbmcgY29udHJhY3QgdG8gc3BlbmQgb24gdGhlaXIgYmVoYWxmCiAgICBAcGFyYW0gX251bVRva2VucyBUaGUgbnVtYmVyIG9mIHZvdGluZ1Rva2VucyBkZXNpcmVkIGluIGV4Y2hhbmdlIGZvciBFUkMyMCB0b2tlbnMKICAgICovCiAgICBmdW5jdGlvbiByZXF1ZXN0Vm90aW5nUmlnaHRzKHVpbnQgX251bVRva2VucykgZXh0ZXJuYWwgewogICAgICAgIHJlcXVpcmUodG9rZW4uYmFsYW5jZU9mKG1zZy5zZW5kZXIpID49IF9udW1Ub2tlbnMpOwogICAgICAgIHJlcXVpcmUodG9rZW4udHJhbnNmZXJGcm9tKG1zZy5zZW5kZXIsIHRoaXMsIF9udW1Ub2tlbnMpKTsKICAgICAgICB2b3RlVG9rZW5CYWxhbmNlW21zZy5zZW5kZXJdICs9IF9udW1Ub2tlbnM7CiAgICAgICAgVm90aW5nUmlnaHRzR3JhbnRlZChtc2cuc2VuZGVyLCBfbnVtVG9rZW5zKTsKICAgIH0KCiAgICAvKioKICAgIEBub3RpY2UgV2l0aGRyYXcgX251bVRva2VucyBFUkMyMCB0b2tlbnMgZnJvbSB0aGUgdm90aW5nIGNvbnRyYWN0LCByZXZva2luZyB0aGVzZSB2b3RpbmcgcmlnaHRzCiAgICBAcGFyYW0gX251bVRva2VucyBUaGUgbnVtYmVyIG9mIEVSQzIwIHRva2VucyBkZXNpcmVkIGluIGV4Y2hhbmdlIGZvciB2b3RpbmcgcmlnaHRzCiAgICAqLwogICAgZnVuY3Rpb24gd2l0aGRyYXdWb3RpbmdSaWdodHModWludCBfbnVtVG9rZW5zKSBleHRlcm5hbCB7CiAgICAgICAgdWludCBhdmFpbGFibGVUb2tlbnMgPSB2b3RlVG9rZW5CYWxhbmNlW21zZy5zZW5kZXJdIC0gZ2V0TG9ja2VkVG9rZW5zKG1zZy5zZW5kZXIpOwogICAgICAgIHJlcXVpcmUoYXZhaWxhYmxlVG9rZW5zID49IF9udW1Ub2tlbnMpOwogICAgICAgIHJlcXVpcmUodG9rZW4udHJhbnNmZXIobXNnLnNlbmRlciwgX251bVRva2VucykpOwogICAgICAgIHZvdGVUb2tlbkJhbGFuY2VbbXNnLnNlbmRlcl0gLT0gX251bVRva2VuczsKICAgICAgICBWb3RpbmdSaWdodHNXaXRoZHJhd24obXNnLnNlbmRlciwgX251bVRva2Vucyk7CiAgICB9CgogICAgLyoqCiAgICBAZGV2IFVubG9ja3MgdG9rZW5zIGxvY2tlZCBpbiB1bnJldmVhbGVkIHZvdGUgd2hlcmUgcG9sbCBoYXMgZW5kZWQKICAgIEBwYXJhbSBfcG9sbElEIEludGVnZXIgaWRlbnRpZmllciBhc3NvY2lhdGVkIHdpdGggdGhlIHRhcmdldCBwb2xsCiAgICAqLwogICAgZnVuY3Rpb24gcmVzY3VlVG9rZW5zKHVpbnQgX3BvbGxJRCkgZXh0ZXJuYWwgewogICAgICAgIHJlcXVpcmUocG9sbEVuZGVkKF9wb2xsSUQpKTsKICAgICAgICByZXF1aXJlKCFoYXNCZWVuUmV2ZWFsZWQobXNnLnNlbmRlciwgX3BvbGxJRCkpOwoKICAgICAgICBkbGxNYXBbbXNnLnNlbmRlcl0ucmVtb3ZlKF9wb2xsSUQpOwogICAgfQoKICAgIC8vID09PT09PT09PT09PT09PT09CiAgICAvLyBWT1RJTkcgSU5URVJGQUNFOgogICAgLy8gPT09PT09PT09PT09PT09PT0KCiAgICAvKioKICAgIEBub3RpY2UgQ29tbWl0cyB2b3RlIHVzaW5nIGhhc2ggb2YgY2hvaWNlIGFuZCBzZWNyZXQgc2FsdCB0byBjb25jZWFsIHZvdGUgdW50aWwgcmV2ZWFsCiAgICBAcGFyYW0gX3BvbGxJRCBJbnRlZ2VyIGlkZW50aWZpZXIgYXNzb2NpYXRlZCB3aXRoIHRhcmdldCBwb2xsCiAgICBAcGFyYW0gX3NlY3JldEhhc2ggQ29tbWl0IGtlY2NhazI1NiBoYXNoIG9mIHZvdGVyJ3MgY2hvaWNlIGFuZCBzYWx0ICh0aWdodGx5IHBhY2tlZCBpbiB0aGlzIG9yZGVyKQogICAgQHBhcmFtIF9udW1Ub2tlbnMgVGhlIG51bWJlciBvZiB0b2tlbnMgdG8gYmUgY29tbWl0dGVkIHRvd2FyZHMgdGhlIHRhcmdldCBwb2xsCiAgICBAcGFyYW0gX3ByZXZQb2xsSUQgVGhlIElEIG9mIHRoZSBwb2xsIHRoYXQgdGhlIHVzZXIgaGFzIHZvdGVkIHRoZSBtYXhpbXVtIG51bWJlciBvZiB0b2tlbnMgaW4gd2hpY2ggaXMgc3RpbGwgbGVzcyB0aGFuIG9yIGVxdWFsIHRvIG51bVRva2VucyAKICAgICovCiAgICBmdW5jdGlvbiBjb21taXRWb3RlKHVpbnQgX3BvbGxJRCwgYnl0ZXMzMiBfc2VjcmV0SGFzaCwgdWludCBfbnVtVG9rZW5zLCB1aW50IF9wcmV2UG9sbElEKSBleHRlcm5hbCB7CiAgICAgICAgcmVxdWlyZShjb21taXRQZXJpb2RBY3RpdmUoX3BvbGxJRCkpOwogICAgICAgIHJlcXVpcmUodm90ZVRva2VuQmFsYW5jZVttc2cuc2VuZGVyXSA+PSBfbnVtVG9rZW5zKTsgLy8gcHJldmVudCB1c2VyIGZyb20gb3ZlcnNwZW5kaW5nCiAgICAgICAgcmVxdWlyZShfcG9sbElEICE9IDApOyAgICAgICAgICAgICAgICAvLyBwcmV2ZW50IHVzZXIgZnJvbSBjb21taXR0aW5nIHRvIHplcm8gbm9kZSBwbGFjZWhvbGRlcgoKICAgICAgICAvLyBUT0RPOiBNb3ZlIGFsbCBpbnNlcnQgdmFsaWRhdGlvbiBpbnRvIHRoZSBETEwgbGliCiAgICAgICAgLy8gQ2hlY2sgaWYgX3ByZXZQb2xsSUQgZXhpc3RzCiAgICAgICAgcmVxdWlyZShfcHJldlBvbGxJRCA9PSAwIHx8IGdldENvbW1pdEhhc2gobXNnLnNlbmRlciwgX3ByZXZQb2xsSUQpICE9IDApOwoKICAgICAgICB1aW50IG5leHRQb2xsSUQgPSBkbGxNYXBbbXNnLnNlbmRlcl0uZ2V0TmV4dChfcHJldlBvbGxJRCk7CgogICAgICAgIC8vIGlmIG5leHRQb2xsSUQgaXMgZXF1YWwgdG8gX3BvbGxJRCwgX3BvbGxJRCBpcyBiZWluZyB1cGRhdGVkLAogICAgICAgIG5leHRQb2xsSUQgPSAobmV4dFBvbGxJRCA9PSBfcG9sbElEKSA/IGRsbE1hcFttc2cuc2VuZGVyXS5nZXROZXh0KF9wb2xsSUQpIDogbmV4dFBvbGxJRDsKCiAgICAgICAgcmVxdWlyZSh2YWxpZFBvc2l0aW9uKF9wcmV2UG9sbElELCBuZXh0UG9sbElELCBtc2cuc2VuZGVyLCBfbnVtVG9rZW5zKSk7CiAgICAgICAgZGxsTWFwW21zZy5zZW5kZXJdLmluc2VydChfcHJldlBvbGxJRCwgX3BvbGxJRCwgbmV4dFBvbGxJRCk7CgogICAgICAgIGJ5dGVzMzIgVVVJRCA9IGF0dHJVVUlEKG1zZy5zZW5kZXIsIF9wb2xsSUQpOwoKICAgICAgICBzdG9yZS5zZXRBdHRyaWJ1dGUoVVVJRCwgIm51bVRva2VucyIsIF9udW1Ub2tlbnMpOwogICAgICAgIHN0b3JlLnNldEF0dHJpYnV0ZShVVUlELCAiY29tbWl0SGFzaCIsIHVpbnQoX3NlY3JldEhhc2gpKTsKCiAgICAgICAgVm90ZUNvbW1pdHRlZChtc2cuc2VuZGVyLCBfcG9sbElELCBfbnVtVG9rZW5zKTsKICAgIH0KCiAgICAvKioKICAgIEBkZXYgQ29tcGFyZXMgcHJldmlvdXMgYW5kIG5leHQgcG9sbCdzIGNvbW1pdHRlZCB0b2tlbnMgZm9yIHNvcnRpbmcgcHVycG9zZXMKICAgIEBwYXJhbSBfcHJldklEIEludGVnZXIgaWRlbnRpZmllciBhc3NvY2lhdGVkIHdpdGggcHJldmlvdXMgcG9sbCBpbiBzb3J0ZWQgb3JkZXIKICAgIEBwYXJhbSBfbmV4dElEIEludGVnZXIgaWRlbnRpZmllciBhc3NvY2lhdGVkIHdpdGggbmV4dCBwb2xsIGluIHNvcnRlZCBvcmRlcgogICAgQHBhcmFtIF92b3RlciBBZGRyZXNzIG9mIHVzZXIgdG8gY2hlY2sgRExMIHBvc2l0aW9uIGZvcgogICAgQHBhcmFtIF9udW1Ub2tlbnMgVGhlIG51bWJlciBvZiB0b2tlbnMgdG8gYmUgY29tbWl0dGVkIHRvd2FyZHMgdGhlIHBvbGwgKHVzZWQgZm9yIHNvcnRpbmcpCiAgICBAcmV0dXJuIHZhbGlkIEJvb2xlYW4gaW5kaWNhdGlvbiBvZiBpZiB0aGUgc3BlY2lmaWVkIHBvc2l0aW9uIG1haW50YWlucyB0aGUgc29ydAogICAgKi8KICAgIGZ1bmN0aW9uIHZhbGlkUG9zaXRpb24odWludCBfcHJldklELCB1aW50IF9uZXh0SUQsIGFkZHJlc3MgX3ZvdGVyLCB1aW50IF9udW1Ub2tlbnMpIHB1YmxpYyBjb25zdGFudCByZXR1cm5zIChib29sIHZhbGlkKSB7CiAgICAgICAgYm9vbCBwcmV2VmFsaWQgPSAoX251bVRva2VucyA+PSBnZXROdW1Ub2tlbnMoX3ZvdGVyLCBfcHJldklEKSk7CiAgICAgICAgLy8gaWYgbmV4dCBpcyB6ZXJvIG5vZGUsIF9udW1Ub2tlbnMgZG9lcyBub3QgbmVlZCB0byBiZSBncmVhdGVyCiAgICAgICAgYm9vbCBuZXh0VmFsaWQgPSAoX251bVRva2VucyA8PSBnZXROdW1Ub2tlbnMoX3ZvdGVyLCBfbmV4dElEKSB8fCBfbmV4dElEID09IDApOyAKICAgICAgICByZXR1cm4gcHJldlZhbGlkICYmIG5leHRWYWxpZDsKICAgIH0KCiAgICAvKioKICAgIEBub3RpY2UgUmV2ZWFscyB2b3RlIHdpdGggY2hvaWNlIGFuZCBzZWNyZXQgc2FsdCB1c2VkIGluIGdlbmVyYXRpbmcgY29tbWl0SGFzaCB0byBhdHRyaWJ1dGUgY29tbWl0dGVkIHRva2VucwogICAgQHBhcmFtIF9wb2xsSUQgSW50ZWdlciBpZGVudGlmaWVyIGFzc29jaWF0ZWQgd2l0aCB0YXJnZXQgcG9sbAogICAgQHBhcmFtIF92b3RlT3B0aW9uIFZvdGUgY2hvaWNlIHVzZWQgdG8gZ2VuZXJhdGUgY29tbWl0SGFzaCBmb3IgYXNzb2NpYXRlZCBwb2xsCiAgICBAcGFyYW0gX3NhbHQgU2VjcmV0IG51bWJlciB1c2VkIHRvIGdlbmVyYXRlIGNvbW1pdEhhc2ggZm9yIGFzc29jaWF0ZWQgcG9sbAogICAgKi8KICAgIGZ1bmN0aW9uIHJldmVhbFZvdGUodWludCBfcG9sbElELCB1aW50IF92b3RlT3B0aW9uLCB1aW50IF9zYWx0KSBleHRlcm5hbCB7CiAgICAgICAgLy8gTWFrZSBzdXJlIHRoZSByZXZlYWwgcGVyaW9kIGlzIGFjdGl2ZQogICAgICAgIHJlcXVpcmUocmV2ZWFsUGVyaW9kQWN0aXZlKF9wb2xsSUQpKTsKICAgICAgICByZXF1aXJlKCFoYXNCZWVuUmV2ZWFsZWQobXNnLnNlbmRlciwgX3BvbGxJRCkpOyAgICAgICAgICAgICAgICAgICAgICAgIC8vIHByZXZlbnQgdXNlciBmcm9tIHJldmVhbGluZyBtdWx0aXBsZSB0aW1lcwogICAgICAgIHJlcXVpcmUoa2VjY2FrMjU2KF92b3RlT3B0aW9uLCBfc2FsdCkgPT0gZ2V0Q29tbWl0SGFzaChtc2cuc2VuZGVyLCBfcG9sbElEKSk7IC8vIGNvbXBhcmUgcmVzdWx0YW50IGhhc2ggZnJvbSBpbnB1dHMgdG8gb3JpZ2luYWwgY29tbWl0SGFzaAoKICAgICAgICB1aW50IG51bVRva2VucyA9IGdldE51bVRva2Vucyhtc2cuc2VuZGVyLCBfcG9sbElEKTsgCgogICAgICAgIGlmIChfdm90ZU9wdGlvbiA9PSAxKSAvLyBhcHBseSBudW1Ub2tlbnMgdG8gYXBwcm9wcmlhdGUgcG9sbCBjaG9pY2UKICAgICAgICAgICAgcG9sbE1hcFtfcG9sbElEXS52b3Rlc0ZvciArPSBudW1Ub2tlbnM7CiAgICAgICAgZWxzZQogICAgICAgICAgICBwb2xsTWFwW19wb2xsSURdLnZvdGVzQWdhaW5zdCArPSBudW1Ub2tlbnM7CiAgICAgICAgCiAgICAgICAgZGxsTWFwW21zZy5zZW5kZXJdLnJlbW92ZShfcG9sbElEKTsgLy8gcmVtb3ZlIHRoZSBub2RlIHJlZmVycmluZyB0byB0aGlzIHZvdGUgdXBvbiByZXZlYWwKCiAgICAgICAgVm90ZVJldmVhbGVkKG1zZy5zZW5kZXIsIF9wb2xsSUQsIG51bVRva2VucywgX3ZvdGVPcHRpb24pOwogICAgfQoKICAgIC8qKgogICAgQHBhcmFtIF9wb2xsSUQgSW50ZWdlciBpZGVudGlmaWVyIGFzc29jaWF0ZWQgd2l0aCB0YXJnZXQgcG9sbAogICAgQHBhcmFtIF9zYWx0IEFyYml0cmFyaWx5IGNob3NlbiBpbnRlZ2VyIHVzZWQgdG8gZ2VuZXJhdGUgc2VjcmV0SGFzaAogICAgQHJldHVybiBjb3JyZWN0Vm90ZXMgTnVtYmVyIG9mIHRva2VucyB2b3RlZCBmb3Igd2lubmluZyBvcHRpb24KICAgICovCiAgICBmdW5jdGlvbiBnZXROdW1QYXNzaW5nVG9rZW5zKGFkZHJlc3MgX3ZvdGVyLCB1aW50IF9wb2xsSUQsIHVpbnQgX3NhbHQpIHB1YmxpYyBjb25zdGFudCByZXR1cm5zICh1aW50IGNvcnJlY3RWb3RlcykgewogICAgICAgIHJlcXVpcmUocG9sbEVuZGVkKF9wb2xsSUQpKTsKICAgICAgICByZXF1aXJlKGhhc0JlZW5SZXZlYWxlZChfdm90ZXIsIF9wb2xsSUQpKTsKCiAgICAgICAgdWludCB3aW5uaW5nQ2hvaWNlID0gaXNQYXNzZWQoX3BvbGxJRCkgPyAxIDogMDsKICAgICAgICBieXRlczMyIHdpbm5lckhhc2ggPSBrZWNjYWsyNTYod2lubmluZ0Nob2ljZSwgX3NhbHQpOwogICAgICAgIGJ5dGVzMzIgY29tbWl0SGFzaCA9IGdldENvbW1pdEhhc2goX3ZvdGVyLCBfcG9sbElEKTsKCiAgICAgICAgcmVxdWlyZSh3aW5uZXJIYXNoID09IGNvbW1pdEhhc2gpOwoKICAgICAgICByZXR1cm4gZ2V0TnVtVG9rZW5zKF92b3RlciwgX3BvbGxJRCk7CiAgICB9CgogICAgLy8gPT09PT09PT09PT09PT09PT09CiAgICAvLyBQT0xMSU5HIElOVEVSRkFDRToKICAgIC8vID09PT09PT09PT09PT09PT09PSAKCiAgICAvKioKICAgIEBkZXYgSW5pdGlhdGVzIGEgcG9sbCB3aXRoIGNhbm9uaWNhbCBjb25maWd1cmVkIHBhcmFtZXRlcnMgYXQgcG9sbElEIGVtaXR0ZWQgYnkgUG9sbENyZWF0ZWQgZXZlbnQKICAgIEBwYXJhbSBfdm90ZVF1b3J1bSBUeXBlIG9mIG1ham9yaXR5IChvdXQgb2YgMTAwKSB0aGF0IGlzIG5lY2Vzc2FyeSBmb3IgcG9sbCB0byBiZSBzdWNjZXNzZnVsCiAgICBAcGFyYW0gX2NvbW1pdER1cmF0aW9uIExlbmd0aCBvZiBkZXNpcmVkIGNvbW1pdCBwZXJpb2QgaW4gc2Vjb25kcwogICAgQHBhcmFtIF9yZXZlYWxEdXJhdGlvbiBMZW5ndGggb2YgZGVzaXJlZCByZXZlYWwgcGVyaW9kIGluIHNlY29uZHMKICAgICovCiAgICBmdW5jdGlvbiBzdGFydFBvbGwodWludCBfdm90ZVF1b3J1bSwgdWludCBfY29tbWl0RHVyYXRpb24sIHVpbnQgX3JldmVhbER1cmF0aW9uKSBwdWJsaWMgcmV0dXJucyAodWludCBwb2xsSUQpIHsKICAgICAgICBwb2xsTm9uY2UgPSBwb2xsTm9uY2UgKyAxOwoKICAgICAgICBwb2xsTWFwW3BvbGxOb25jZV0gPSBQb2xsKHsKICAgICAgICAgICAgdm90ZVF1b3J1bTogX3ZvdGVRdW9ydW0sCiAgICAgICAgICAgIGNvbW1pdEVuZERhdGU6IGJsb2NrLnRpbWVzdGFtcCArIF9jb21taXREdXJhdGlvbiwKICAgICAgICAgICAgcmV2ZWFsRW5kRGF0ZTogYmxvY2sudGltZXN0YW1wICsgX2NvbW1pdER1cmF0aW9uICsgX3JldmVhbER1cmF0aW9uLAogICAgICAgICAgICB2b3Rlc0ZvcjogMCwKICAgICAgICAgICAgdm90ZXNBZ2FpbnN0OiAwCiAgICAgICAgfSk7CgogICAgICAgIFBvbGxDcmVhdGVkKF92b3RlUXVvcnVtLCBfY29tbWl0RHVyYXRpb24sIF9yZXZlYWxEdXJhdGlvbiwgcG9sbE5vbmNlKTsKICAgICAgICByZXR1cm4gcG9sbE5vbmNlOwogICAgfQogCiAgICAvKioKICAgIEBub3RpY2UgRGV0ZXJtaW5lcyBpZiBwcm9wb3NhbCBoYXMgcGFzc2VkCiAgICBAZGV2IENoZWNrIGlmIHZvdGVzRm9yIG91dCBvZiB0b3RhbFZvdGVzIGV4Y2VlZHMgdm90ZXNRdW9ydW0gKHJlcXVpcmVzIHBvbGxFbmRlZCkKICAgIEBwYXJhbSBfcG9sbElEIEludGVnZXIgaWRlbnRpZmllciBhc3NvY2lhdGVkIHdpdGggdGFyZ2V0IHBvbGwKICAgICovCiAgICBmdW5jdGlvbiBpc1Bhc3NlZCh1aW50IF9wb2xsSUQpIGNvbnN0YW50IHB1YmxpYyByZXR1cm5zIChib29sIHBhc3NlZCkgewogICAgICAgIHJlcXVpcmUocG9sbEVuZGVkKF9wb2xsSUQpKTsKCiAgICAgICAgUG9sbCBtZW1vcnkgcG9sbCA9IHBvbGxNYXBbX3BvbGxJRF07CiAgICAgICAgcmV0dXJuICgxMDAgKiBwb2xsLnZvdGVzRm9yKSA+IChwb2xsLnZvdGVRdW9ydW0gKiAocG9sbC52b3Rlc0ZvciArIHBvbGwudm90ZXNBZ2FpbnN0KSk7CiAgICB9CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gUE9MTElORyBIRUxQRVJTOgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLQoKICAgIC8qKgogICAgQGRldiBHZXRzIHRoZSB0b3RhbCB3aW5uaW5nIHZvdGVzIGZvciByZXdhcmQgZGlzdHJpYnV0aW9uIHB1cnBvc2VzCiAgICBAcGFyYW0gX3BvbGxJRCBJbnRlZ2VyIGlkZW50aWZpZXIgYXNzb2NpYXRlZCB3aXRoIHRhcmdldCBwb2xsCiAgICBAcmV0dXJuIFRvdGFsIG51bWJlciBvZiB2b3RlcyBjb21taXR0ZWQgdG8gdGhlIHdpbm5pbmcgb3B0aW9uIGZvciBzcGVjaWZpZWQgcG9sbAogICAgKi8KICAgIGZ1bmN0aW9uIGdldFRvdGFsTnVtYmVyT2ZUb2tlbnNGb3JXaW5uaW5nT3B0aW9uKHVpbnQgX3BvbGxJRCkgY29uc3RhbnQgcHVibGljIHJldHVybnMgKHVpbnQgbnVtVG9rZW5zKSB7CiAgICAgICAgcmVxdWlyZShwb2xsRW5kZWQoX3BvbGxJRCkpOwoKICAgICAgICBpZiAoaXNQYXNzZWQoX3BvbGxJRCkpCiAgICAgICAgICAgIHJldHVybiBwb2xsTWFwW19wb2xsSURdLnZvdGVzRm9yOwogICAgICAgIGVsc2UKICAgICAgICAgICAgcmV0dXJuIHBvbGxNYXBbX3BvbGxJRF0udm90ZXNBZ2FpbnN0OwogICAgfQoKICAgIC8qKgogICAgQG5vdGljZSBEZXRlcm1pbmVzIGlmIHBvbGwgaXMgb3ZlcgogICAgQGRldiBDaGVja3MgaXNFeHBpcmVkIGZvciBzcGVjaWZpZWQgcG9sbCdzIHJldmVhbEVuZERhdGUKICAgIEByZXR1cm4gQm9vbGVhbiBpbmRpY2F0aW9uIG9mIHdoZXRoZXIgcG9sbGluZyBwZXJpb2QgaXMgb3ZlcgogICAgKi8KICAgIGZ1bmN0aW9uIHBvbGxFbmRlZCh1aW50IF9wb2xsSUQpIGNvbnN0YW50IHB1YmxpYyByZXR1cm5zIChib29sIGVuZGVkKSB7CiAgICAgICAgcmVxdWlyZShwb2xsRXhpc3RzKF9wb2xsSUQpKTsKCiAgICAgICAgcmV0dXJuIGlzRXhwaXJlZChwb2xsTWFwW19wb2xsSURdLnJldmVhbEVuZERhdGUpOwogICAgfQoKICAgIC8qKgogICAgQG5vdGljZSBDaGVja3MgaWYgdGhlIGNvbW1pdCBwZXJpb2QgaXMgc3RpbGwgYWN0aXZlIGZvciB0aGUgc3BlY2lmaWVkIHBvbGwKICAgIEBkZXYgQ2hlY2tzIGlzRXhwaXJlZCBmb3IgdGhlIHNwZWNpZmllZCBwb2xsJ3MgY29tbWl0RW5kRGF0ZQogICAgQHBhcmFtIF9wb2xsSUQgSW50ZWdlciBpZGVudGlmaWVyIGFzc29jaWF0ZWQgd2l0aCB0YXJnZXQgcG9sbAogICAgQHJldHVybiBCb29sZWFuIGluZGljYXRpb24gb2YgaXNDb21taXRQZXJpb2RBY3RpdmUgZm9yIHRhcmdldCBwb2xsCiAgICAqLwogICAgZnVuY3Rpb24gY29tbWl0UGVyaW9kQWN0aXZlKHVpbnQgX3BvbGxJRCkgY29uc3RhbnQgcHVibGljIHJldHVybnMgKGJvb2wgYWN0aXZlKSB7CiAgICAgICAgcmVxdWlyZShwb2xsRXhpc3RzKF9wb2xsSUQpKTsKCiAgICAgICAgcmV0dXJuICFpc0V4cGlyZWQocG9sbE1hcFtfcG9sbElEXS5jb21taXRFbmREYXRlKTsKICAgIH0KCiAgICAvKioKICAgIEBub3RpY2UgQ2hlY2tzIGlmIHRoZSByZXZlYWwgcGVyaW9kIGlzIHN0aWxsIGFjdGl2ZSBmb3IgdGhlIHNwZWNpZmllZCBwb2xsCiAgICBAZGV2IENoZWNrcyBpc0V4cGlyZWQgZm9yIHRoZSBzcGVjaWZpZWQgcG9sbCdzIHJldmVhbEVuZERhdGUKICAgIEBwYXJhbSBfcG9sbElEIEludGVnZXIgaWRlbnRpZmllciBhc3NvY2lhdGVkIHdpdGggdGFyZ2V0IHBvbGwKICAgICovCiAgICBmdW5jdGlvbiByZXZlYWxQZXJpb2RBY3RpdmUodWludCBfcG9sbElEKSBjb25zdGFudCBwdWJsaWMgcmV0dXJucyAoYm9vbCBhY3RpdmUpIHsKICAgICAgICByZXF1aXJlKHBvbGxFeGlzdHMoX3BvbGxJRCkpOwoKICAgICAgICByZXR1cm4gIWlzRXhwaXJlZChwb2xsTWFwW19wb2xsSURdLnJldmVhbEVuZERhdGUpICYmICFjb21taXRQZXJpb2RBY3RpdmUoX3BvbGxJRCk7CiAgICB9CgogICAgLyoqCiAgICBAZGV2IENoZWNrcyBpZiB1c2VyIGhhcyBhbHJlYWR5IHJldmVhbGVkIGZvciBzcGVjaWZpZWQgcG9sbAogICAgQHBhcmFtIF92b3RlciBBZGRyZXNzIG9mIHVzZXIgdG8gY2hlY2sgYWdhaW5zdAogICAgQHBhcmFtIF9wb2xsSUQgSW50ZWdlciBpZGVudGlmaWVyIGFzc29jaWF0ZWQgd2l0aCB0YXJnZXQgcG9sbAogICAgQHJldHVybiBCb29sZWFuIGluZGljYXRpb24gb2Ygd2hldGhlciB1c2VyIGhhcyBhbHJlYWR5IHJldmVhbGVkCiAgICAqLwogICAgZnVuY3Rpb24gaGFzQmVlblJldmVhbGVkKGFkZHJlc3MgX3ZvdGVyLCB1aW50IF9wb2xsSUQpIGNvbnN0YW50IHB1YmxpYyByZXR1cm5zIChib29sIHJldmVhbGVkKSB7CiAgICAgICAgcmVxdWlyZShwb2xsRXhpc3RzKF9wb2xsSUQpKTsKCiAgICAgICAgcmV0dXJuICFkbGxNYXBbX3ZvdGVyXS5jb250YWlucyhfcG9sbElEKTsKICAgIH0KCiAgICAvKioKICAgIEBkZXYgQ2hlY2tzIGlmIGEgcG9sbCBleGlzdHMsIHRocm93cyBpZiB0aGUgcHJvdmlkZWQgcG9sbCBpcyBpbiBhbiBpbXBvc3NpYmxlIHN0YXRlCiAgICBAcGFyYW0gX3BvbGxJRCBUaGUgcG9sbElEIHdob3NlIGV4aXN0YW5jZSBpcyB0byBiZSBldmFsdWF0ZWQuCiAgICBAcmV0dXJuIEJvb2xlYW4gSW5kaWNhdGVzIHdoZXRoZXIgYSBwb2xsIGV4aXN0cyBmb3IgdGhlIHByb3ZpZGVkIHBvbGxJRAogICAgKi8KICAgIGZ1bmN0aW9uIHBvbGxFeGlzdHModWludCBfcG9sbElEKSBjb25zdGFudCBwdWJsaWMgcmV0dXJucyAoYm9vbCBleGlzdHMpIHsKICAgICAgICB1aW50IGNvbW1pdEVuZERhdGUgPSBwb2xsTWFwW19wb2xsSURdLmNvbW1pdEVuZERhdGU7CiAgICAgICAgdWludCByZXZlYWxFbmREYXRlID0gcG9sbE1hcFtfcG9sbElEXS5yZXZlYWxFbmREYXRlOwoKICAgICAgICBhc3NlcnQoIShjb21taXRFbmREYXRlID09IDAgJiYgcmV2ZWFsRW5kRGF0ZSAhPSAwKSk7CiAgICAgICAgYXNzZXJ0KCEoY29tbWl0RW5kRGF0ZSAhPSAwICYmIHJldmVhbEVuZERhdGUgPT0gMCkpOwoKICAgICAgICBpZihjb21taXRFbmREYXRlID09IDAgfHwgcmV2ZWFsRW5kRGF0ZSA9PSAwKSB7IHJldHVybiBmYWxzZTsgfQogICAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gRE9VQkxFLUxJTktFRC1MSVNUIEhFTFBFUlM6CiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KCiAgICAvKioKICAgIEBkZXYgR2V0cyB0aGUgYnl0ZXMzMiBjb21taXRIYXNoIHByb3BlcnR5IG9mIHRhcmdldCBwb2xsCiAgICBAcGFyYW0gX3ZvdGVyIEFkZHJlc3Mgb2YgdXNlciB0byBjaGVjayBhZ2FpbnN0CiAgICBAcGFyYW0gX3BvbGxJRCBJbnRlZ2VyIGlkZW50aWZpZXIgYXNzb2NpYXRlZCB3aXRoIHRhcmdldCBwb2xsCiAgICBAcmV0dXJuIEJ5dGVzMzIgaGFzaCBwcm9wZXJ0eSBhdHRhY2hlZCB0byB0YXJnZXQgcG9sbCAKICAgICovCiAgICBmdW5jdGlvbiBnZXRDb21taXRIYXNoKGFkZHJlc3MgX3ZvdGVyLCB1aW50IF9wb2xsSUQpIGNvbnN0YW50IHB1YmxpYyByZXR1cm5zIChieXRlczMyIGNvbW1pdEhhc2gpIHsgCiAgICAgICAgcmV0dXJuIGJ5dGVzMzIoc3RvcmUuZ2V0QXR0cmlidXRlKGF0dHJVVUlEKF92b3RlciwgX3BvbGxJRCksICJjb21taXRIYXNoIikpOyAgICAKICAgIH0gCgogICAgLyoqCiAgICBAZGV2IFdyYXBwZXIgZm9yIGdldEF0dHJpYnV0ZSB3aXRoIGF0dHJOYW1lPSJudW1Ub2tlbnMiCiAgICBAcGFyYW0gX3ZvdGVyIEFkZHJlc3Mgb2YgdXNlciB0byBjaGVjayBhZ2FpbnN0CiAgICBAcGFyYW0gX3BvbGxJRCBJbnRlZ2VyIGlkZW50aWZpZXIgYXNzb2NpYXRlZCB3aXRoIHRhcmdldCBwb2xsCiAgICBAcmV0dXJuIE51bWJlciBvZiB0b2tlbnMgY29tbWl0dGVkIHRvIHBvbGwgaW4gc29ydGVkIHBvbGwtbGlua2VkLWxpc3QKICAgICovCiAgICBmdW5jdGlvbiBnZXROdW1Ub2tlbnMoYWRkcmVzcyBfdm90ZXIsIHVpbnQgX3BvbGxJRCkgY29uc3RhbnQgcHVibGljIHJldHVybnMgKHVpbnQgbnVtVG9rZW5zKSB7CiAgICAgICAgcmV0dXJuIHN0b3JlLmdldEF0dHJpYnV0ZShhdHRyVVVJRChfdm90ZXIsIF9wb2xsSUQpLCAibnVtVG9rZW5zIik7CiAgICB9CgogICAgLyoqCiAgICBAZGV2IEdldHMgdG9wIGVsZW1lbnQgb2Ygc29ydGVkIHBvbGwtbGlua2VkLWxpc3QKICAgIEBwYXJhbSBfdm90ZXIgQWRkcmVzcyBvZiB1c2VyIHRvIGNoZWNrIGFnYWluc3QKICAgIEByZXR1cm4gSW50ZWdlciBpZGVudGlmaWVyIHRvIHBvbGwgd2l0aCBtYXhpbXVtIG51bWJlciBvZiB0b2tlbnMgY29tbWl0dGVkIHRvIGl0CiAgICAqLwogICAgZnVuY3Rpb24gZ2V0TGFzdE5vZGUoYWRkcmVzcyBfdm90ZXIpIGNvbnN0YW50IHB1YmxpYyByZXR1cm5zICh1aW50IHBvbGxJRCkgewogICAgICAgIHJldHVybiBkbGxNYXBbX3ZvdGVyXS5nZXRQcmV2KDApOwogICAgfQoKICAgIC8qKgogICAgQGRldiBHZXRzIHRoZSBudW1Ub2tlbnMgcHJvcGVydHkgb2YgZ2V0TGFzdE5vZGUKICAgIEBwYXJhbSBfdm90ZXIgQWRkcmVzcyBvZiB1c2VyIHRvIGNoZWNrIGFnYWluc3QKICAgIEByZXR1cm4gTWF4aW11bSBudW1iZXIgb2YgdG9rZW5zIGNvbW1pdHRlZCBpbiBwb2xsIHNwZWNpZmllZCAKICAgICovCiAgICBmdW5jdGlvbiBnZXRMb2NrZWRUb2tlbnMoYWRkcmVzcyBfdm90ZXIpIGNvbnN0YW50IHB1YmxpYyByZXR1cm5zICh1aW50IG51bVRva2VucykgewogICAgICAgIHJldHVybiBnZXROdW1Ub2tlbnMoX3ZvdGVyLCBnZXRMYXN0Tm9kZShfdm90ZXIpKTsKICAgIH0KCiAgICAvKioKICAgIEBkZXYgR2V0cyB0aGUgcHJldk5vZGUgYSBuZXcgbm9kZSBzaG91bGQgYmUgaW5zZXJ0ZWQgYWZ0ZXIgZ2l2ZW4gdGhlIHNvcnQgZmFjdG9yCiAgICBAcGFyYW0gX3ZvdGVyIFRoZSB2b3RlciB3aG9zZSBETEwgd2lsbCBiZSBzZWFyY2hlZAogICAgQHBhcmFtIF9udW1Ub2tlbnMgVGhlIHZhbHVlIGZvciB0aGUgbnVtVG9rZW5zIGF0dHJpYnV0ZSBpbiB0aGUgbm9kZSB0byBiZSBpbnNlcnRlZAogICAgQHJldHVybiB0aGUgbm9kZSB3aGljaCB0aGUgcHJvcG9kZWQgbm9kZSBzaG91bGQgYmUgaW5zZXJ0ZWQgYWZ0ZXIKICAgICovCiAgICBmdW5jdGlvbiBnZXRJbnNlcnRQb2ludEZvck51bVRva2VucyhhZGRyZXNzIF92b3RlciwgdWludCBfbnVtVG9rZW5zKQogICAgY29uc3RhbnQgcHVibGljIHJldHVybnMgKHVpbnQgcHJldk5vZGUpIHsKICAgICAgdWludCBub2RlSUQgPSBnZXRMYXN0Tm9kZShfdm90ZXIpOwogICAgICB1aW50IHRva2Vuc0luTm9kZSA9IGdldE51bVRva2Vucyhfdm90ZXIsIG5vZGVJRCk7CgogICAgICB3aGlsZSh0b2tlbnNJbk5vZGUgIT0gMCkgewogICAgICAgIHRva2Vuc0luTm9kZSA9IGdldE51bVRva2Vucyhfdm90ZXIsIG5vZGVJRCk7CiAgICAgICAgaWYodG9rZW5zSW5Ob2RlIDwgX251bVRva2VucykgewogICAgICAgICAgcmV0dXJuIG5vZGVJRDsKICAgICAgICB9CiAgICAgICAgbm9kZUlEID0gZGxsTWFwW192b3Rlcl0uZ2V0UHJldihub2RlSUQpOwogICAgICB9CgogICAgICByZXR1cm4gbm9kZUlEOwogICAgfQogCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBHRU5FUkFMIEhFTFBFUlM6CiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tCgogICAgLyoqCiAgICBAZGV2IENoZWNrcyBpZiBhbiBleHBpcmF0aW9uIGRhdGUgaGFzIGJlZW4gcmVhY2hlZAogICAgQHBhcmFtIF90ZXJtaW5hdGlvbkRhdGUgSW50ZWdlciB0aW1lc3RhbXAgb2YgZGF0ZSB0byBjb21wYXJlIGN1cnJlbnQgdGltZXN0YW1wIHdpdGgKICAgIEByZXR1cm4gZXhwaXJlZCBCb29sZWFuIGluZGljYXRpb24gb2Ygd2hldGhlciB0aGUgdGVybWluYXRpb25EYXRlIGhhcyBwYXNzZWQKICAgICovCiAgICBmdW5jdGlvbiBpc0V4cGlyZWQodWludCBfdGVybWluYXRpb25EYXRlKSBjb25zdGFudCBwdWJsaWMgcmV0dXJucyAoYm9vbCBleHBpcmVkKSB7CiAgICAgICAgcmV0dXJuIChibG9jay50aW1lc3RhbXAgPiBfdGVybWluYXRpb25EYXRlKTsKICAgIH0KCiAgICAvKioKICAgIEBkZXYgR2VuZXJhdGVzIGFuIGlkZW50aWZpZXIgd2hpY2ggYXNzb2NpYXRlcyBhIHVzZXIgYW5kIGEgcG9sbCB0b2dldGhlcgogICAgQHBhcmFtIF9wb2xsSUQgSW50ZWdlciBpZGVudGlmaWVyIGFzc29jaWF0ZWQgd2l0aCB0YXJnZXQgcG9sbAogICAgQHJldHVybiBVVUlEIEhhc2ggd2hpY2ggaXMgZGV0ZXJtaW5pc3RpYyBmcm9tIF91c2VyIGFuZCBfcG9sbElECiAgICAqLwogICAgZnVuY3Rpb24gYXR0clVVSUQoYWRkcmVzcyBfdXNlciwgdWludCBfcG9sbElEKSBwdWJsaWMgcHVyZSByZXR1cm5zIChieXRlczMyIFVVSUQpIHsKICAgICAgICByZXR1cm4ga2VjY2FrMjU2KF91c2VyLCBfcG9sbElEKTsKICAgIH0KfQoKY29udHJhY3QgUGFyYW1ldGVyaXplciB7CgogIC8vIC0tLS0tLQogIC8vIEVWRU5UUwogIC8vIC0tLS0tLQoKICBldmVudCBfUmVwYXJhbWV0ZXJpemF0aW9uUHJvcG9zYWwoYWRkcmVzcyBwcm9wb3Nlciwgc3RyaW5nIG5hbWUsIHVpbnQgdmFsdWUsIGJ5dGVzMzIgcHJvcElEKTsKICBldmVudCBfTmV3Q2hhbGxlbmdlKGFkZHJlc3MgY2hhbGxlbmdlciwgYnl0ZXMzMiBwcm9wSUQsIHVpbnQgcG9sbElEKTsKCgogIC8vIC0tLS0tLQogIC8vIERBVEEgU1RSVUNUVVJFUwogIC8vIC0tLS0tLQoKICBzdHJ1Y3QgUGFyYW1Qcm9wb3NhbCB7CiAgICB1aW50IGFwcEV4cGlyeTsKICAgIHVpbnQgY2hhbGxlbmdlSUQ7CiAgICB1aW50IGRlcG9zaXQ7CiAgICBzdHJpbmcgbmFtZTsKICAgIGFkZHJlc3Mgb3duZXI7CiAgICB1aW50IHByb2Nlc3NCeTsKICAgIHVpbnQgdmFsdWU7CiAgfQoKICBzdHJ1Y3QgQ2hhbGxlbmdlIHsKICAgIHVpbnQgcmV3YXJkUG9vbDsgICAgICAgIC8vIChyZW1haW5pbmcpIHBvb2wgb2YgdG9rZW5zIGRpc3RyaWJ1dGVkIGFtb25nc3Qgd2lubmluZyB2b3RlcnMKICAgIGFkZHJlc3MgY2hhbGxlbmdlcjsgICAgIC8vIG93bmVyIG9mIENoYWxsZW5nZQogICAgYm9vbCByZXNvbHZlZDsgICAgICAgICAgLy8gaW5kaWNhdGlvbiBvZiBpZiBjaGFsbGVuZ2UgaXMgcmVzb2x2ZWQKICAgIHVpbnQgc3Rha2U7ICAgICAgICAgICAgIC8vIG51bWJlciBvZiB0b2tlbnMgYXQgcmlzayBmb3IgZWl0aGVyIHBhcnR5IGR1cmluZyBjaGFsbGVuZ2UKICAgIHVpbnQgd2lubmluZ1Rva2VuczsgICAgIC8vIChyZW1haW5pbmcpIGFtb3VudCBvZiB0b2tlbnMgdXNlZCBmb3Igdm90aW5nIGJ5IHRoZSB3aW5uaW5nIHNpZGUKICAgIG1hcHBpbmcoYWRkcmVzcyA9PiBib29sKSB0b2tlbkNsYWltczsKICB9CgogIC8vIC0tLS0tLQogIC8vIFNUQVRFCiAgLy8gLS0tLS0tCgogIG1hcHBpbmcoYnl0ZXMzMiA9PiB1aW50KSBwdWJsaWMgcGFyYW1zOwoKICAvLyBtYXBzIGNoYWxsZW5nZUlEcyB0byBhc3NvY2lhdGVkIGNoYWxsZW5nZSBkYXRhCiAgbWFwcGluZyh1aW50ID0+IENoYWxsZW5nZSkgcHVibGljIGNoYWxsZW5nZXM7CiAKICAvLyBtYXBzIHBvbGxJRHMgdG8gaW50ZW5kZWQgZGF0YSBjaGFuZ2UgaWYgcG9sbCBwYXNzZXMKICBtYXBwaW5nKGJ5dGVzMzIgPT4gUGFyYW1Qcm9wb3NhbCkgcHVibGljIHByb3Bvc2FsczsgCgogIC8vIEdsb2JhbCBWYXJpYWJsZXMKICBFSVAyMCBwdWJsaWMgdG9rZW47CiAgUExDUlZvdGluZyBwdWJsaWMgdm90aW5nOwogIHVpbnQgcHVibGljIFBST0NFU1NCWSA9IDYwNDgwMDsgLy8gNyBkYXlzCgogIC8vIC0tLS0tLS0tLS0tLQogIC8vIENPTlNUUlVDVE9SCiAgLy8gLS0tLS0tLS0tLS0tCgogIC8qKgogIEBkZXYgY29uc3RydWN0b3IKICBAcGFyYW0gX3Rva2VuQWRkciAgICAgICAgYWRkcmVzcyBvZiB0aGUgdG9rZW4gd2hpY2ggcGFyYW1ldGVyaXplcyB0aGlzIHN5c3RlbQogIEBwYXJhbSBfcGxjckFkZHIgICAgICAgICBhZGRyZXNzIG9mIGEgUExDUiB2b3RpbmcgY29udHJhY3QgZm9yIHRoZSBwcm92aWRlZCB0b2tlbgogIEBwYXJhbSBfbWluRGVwb3NpdCAgICAgICBtaW5pbXVtIGRlcG9zaXQgZm9yIGxpc3RpbmcgdG8gYmUgd2hpdGVsaXN0ZWQgIAogIEBwYXJhbSBfcE1pbkRlcG9zaXQgICAgICBtaW5pbXVtIGRlcG9zaXQgdG8gcHJvcG9zZSBhIHJlcGFyYW1ldGVyaXphdGlvbgogIEBwYXJhbSBfYXBwbHlTdGFnZUxlbiAgICBwZXJpb2Qgb3ZlciB3aGljaCBhcHBsaWNhbnRzIHdhaXQgdG8gYmUgd2hpdGVsaXN0ZWQKICBAcGFyYW0gX3BBcHBseVN0YWdlTGVuICAgcGVyaW9kIG92ZXIgd2hpY2ggcmVwYXJtZXRlcml6YXRpb24gcHJvcG9zYWxzIHdhaXQgdG8gYmUgcHJvY2Vzc2VkIAogIEBwYXJhbSBfZGlzcGVuc2F0aW9uUGN0ICBwZXJjZW50YWdlIG9mIGxvc2luZyBwYXJ0eSdzIGRlcG9zaXQgZGlzdHJpYnV0ZWQgdG8gd2lubmluZyBwYXJ0eQogIEBwYXJhbSBfcERpc3BlbnNhdGlvblBjdCBwZXJjZW50YWdlIG9mIGxvc2luZyBwYXJ0eSdzIGRlcG9zaXQgZGlzdHJpYnV0ZWQgdG8gd2lubmluZyBwYXJ0eSBpbiBwYXJhbWV0ZXJpemVyCiAgQHBhcmFtIF9jb21taXRTdGFnZUxlbiAgbGVuZ3RoIG9mIGNvbW1pdCBwZXJpb2QgZm9yIHZvdGluZwogIEBwYXJhbSBfcENvbW1pdFN0YWdlTGVuIGxlbmd0aCBvZiBjb21taXQgcGVyaW9kIGZvciB2b3RpbmcgaW4gcGFyYW1ldGVyaXplcgogIEBwYXJhbSBfcmV2ZWFsU3RhZ2VMZW4gIGxlbmd0aCBvZiByZXZlYWwgcGVyaW9kIGZvciB2b3RpbmcKICBAcGFyYW0gX3BSZXZlYWxTdGFnZUxlbiBsZW5ndGggb2YgcmV2ZWFsIHBlcmlvZCBmb3Igdm90aW5nIGluIHBhcmFtZXRlcml6ZXIKICBAcGFyYW0gX3ZvdGVRdW9ydW0gICAgICAgdHlwZSBvZiBtYWpvcml0eSBvdXQgb2YgMTAwIG5lY2Vzc2FyeSBmb3Igdm90ZSBzdWNjZXNzCiAgQHBhcmFtIF9wVm90ZVF1b3J1bSAgICAgIHR5cGUgb2YgbWFqb3JpdHkgb3V0IG9mIDEwMCBuZWNlc3NhcnkgZm9yIHZvdGUgc3VjY2VzcyBpbiBwYXJhbWV0ZXJpemVyCiAgKi8KICBmdW5jdGlvbiBQYXJhbWV0ZXJpemVyKCAKICAgIGFkZHJlc3MgX3Rva2VuQWRkciwKICAgIGFkZHJlc3MgX3BsY3JBZGRyLAogICAgdWludCBfbWluRGVwb3NpdCwKICAgIHVpbnQgX3BNaW5EZXBvc2l0LAogICAgdWludCBfYXBwbHlTdGFnZUxlbiwKICAgIHVpbnQgX3BBcHBseVN0YWdlTGVuLAogICAgdWludCBfY29tbWl0U3RhZ2VMZW4sCiAgICB1aW50IF9wQ29tbWl0U3RhZ2VMZW4sCiAgICB1aW50IF9yZXZlYWxTdGFnZUxlbiwKICAgIHVpbnQgX3BSZXZlYWxTdGFnZUxlbiwKICAgIHVpbnQgX2Rpc3BlbnNhdGlvblBjdCwKICAgIHVpbnQgX3BEaXNwZW5zYXRpb25QY3QsCiAgICB1aW50IF92b3RlUXVvcnVtLAogICAgdWludCBfcFZvdGVRdW9ydW0KICAgICkgcHVibGljIHsKICAgICAgdG9rZW4gPSBFSVAyMChfdG9rZW5BZGRyKTsKICAgICAgdm90aW5nID0gUExDUlZvdGluZyhfcGxjckFkZHIpOwoKICAgICAgc2V0KCJtaW5EZXBvc2l0IiwgX21pbkRlcG9zaXQpOwogICAgICBzZXQoInBNaW5EZXBvc2l0IiwgX3BNaW5EZXBvc2l0KTsKICAgICAgc2V0KCJhcHBseVN0YWdlTGVuIiwgX2FwcGx5U3RhZ2VMZW4pOwogICAgICBzZXQoInBBcHBseVN0YWdlTGVuIiwgX3BBcHBseVN0YWdlTGVuKTsKICAgICAgc2V0KCJjb21taXRTdGFnZUxlbiIsIF9jb21taXRTdGFnZUxlbik7CiAgICAgIHNldCgicENvbW1pdFN0YWdlTGVuIiwgX3BDb21taXRTdGFnZUxlbik7CiAgICAgIHNldCgicmV2ZWFsU3RhZ2VMZW4iLCBfcmV2ZWFsU3RhZ2VMZW4pOwogICAgICBzZXQoInBSZXZlYWxTdGFnZUxlbiIsIF9wUmV2ZWFsU3RhZ2VMZW4pOwogICAgICBzZXQoImRpc3BlbnNhdGlvblBjdCIsIF9kaXNwZW5zYXRpb25QY3QpOwogICAgICBzZXQoInBEaXNwZW5zYXRpb25QY3QiLCBfcERpc3BlbnNhdGlvblBjdCk7CiAgICAgIHNldCgidm90ZVF1b3J1bSIsIF92b3RlUXVvcnVtKTsKICAgICAgc2V0KCJwVm90ZVF1b3J1bSIsIF9wVm90ZVF1b3J1bSk7CiAgfQoKICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogIC8vIFRPS0VOIEhPTERFUiBJTlRFUkZBQ0UKICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoKICAvKioKICBAbm90aWNlIHByb3Bvc2UgYSByZXBhcmFtYXRlcml6YXRpb24gb2YgdGhlIGtleSBfbmFtZSdzIHZhbHVlIHRvIF92YWx1ZS4KICBAcGFyYW0gX25hbWUgdGhlIG5hbWUgb2YgdGhlIHByb3Bvc2VkIHBhcmFtIHRvIGJlIHNldAogIEBwYXJhbSBfdmFsdWUgdGhlIHByb3Bvc2VkIHZhbHVlIHRvIHNldCB0aGUgcGFyYW0gdG8gYmUgc2V0CiAgKi8KICBmdW5jdGlvbiBwcm9wb3NlUmVwYXJhbWV0ZXJpemF0aW9uKHN0cmluZyBfbmFtZSwgdWludCBfdmFsdWUpIHB1YmxpYyByZXR1cm5zIChieXRlczMyKSB7CiAgICB1aW50IGRlcG9zaXQgPSBnZXQoInBNaW5EZXBvc2l0Iik7CiAgICBieXRlczMyIHByb3BJRCA9IGtlY2NhazI1NihfbmFtZSwgX3ZhbHVlKTsKCiAgICByZXF1aXJlKCFwcm9wRXhpc3RzKHByb3BJRCkpOyAvLyBGb3JiaWQgZHVwbGljYXRlIHByb3Bvc2FscwogICAgcmVxdWlyZShnZXQoX25hbWUpICE9IF92YWx1ZSk7IC8vIEZvcmJpZCBOT09QIHJlcGFyYW1ldGVyaXphdGlvbnMKICAgIHJlcXVpcmUodG9rZW4udHJhbnNmZXJGcm9tKG1zZy5zZW5kZXIsIHRoaXMsIGRlcG9zaXQpKTsgLy8gZXNjcm93IHRva2VucyAoZGVwb3NpdCBhbXQpCgogICAgLy8gYXR0YWNoIG5hbWUgYW5kIHZhbHVlIHRvIHBvbGxJRCAgICAKICAgIHByb3Bvc2Fsc1twcm9wSURdID0gUGFyYW1Qcm9wb3NhbCh7CiAgICAgIGFwcEV4cGlyeTogbm93ICsgZ2V0KCJwQXBwbHlTdGFnZUxlbiIpLAogICAgICBjaGFsbGVuZ2VJRDogMCwKICAgICAgZGVwb3NpdDogZGVwb3NpdCwKICAgICAgbmFtZTogX25hbWUsCiAgICAgIG93bmVyOiBtc2cuc2VuZGVyLAogICAgICBwcm9jZXNzQnk6IG5vdyArIGdldCgicEFwcGx5U3RhZ2VMZW4iKSArIGdldCgicENvbW1pdFN0YWdlTGVuIikgKwogICAgICAgIGdldCgicFJldmVhbFN0YWdlTGVuIikgKyBQUk9DRVNTQlksCiAgICAgIHZhbHVlOiBfdmFsdWUKICAgIH0pOwoKICAgIF9SZXBhcmFtZXRlcml6YXRpb25Qcm9wb3NhbChtc2cuc2VuZGVyLCBfbmFtZSwgX3ZhbHVlLCBwcm9wSUQpOwogICAgcmV0dXJuIHByb3BJRDsKICB9CgogIC8qKgogIEBub3RpY2UgY2hhbGxlbmdlIHRoZSBwcm92aWRlZCBwcm9wb3NhbCBJRCwgYW5kIHB1dCB0b2tlbnMgYXQgc3Rha2UgdG8gZG8gc28uCiAgQHBhcmFtIF9wcm9wSUQgdGhlIHByb3Bvc2FsIElEIHRvIGNoYWxsZW5nZQogICovCiAgZnVuY3Rpb24gY2hhbGxlbmdlUmVwYXJhbWV0ZXJpemF0aW9uKGJ5dGVzMzIgX3Byb3BJRCkgcHVibGljIHJldHVybnMgKHVpbnQgY2hhbGxlbmdlSUQpIHsKICAgIFBhcmFtUHJvcG9zYWwgbWVtb3J5IHByb3AgPSBwcm9wb3NhbHNbX3Byb3BJRF07CiAgICB1aW50IGRlcG9zaXQgPSBnZXQoInBNaW5EZXBvc2l0Iik7CgogICAgcmVxdWlyZShwcm9wRXhpc3RzKF9wcm9wSUQpICYmIHByb3AuY2hhbGxlbmdlSUQgPT0gMCk7IAoKICAgIC8vdGFrZSB0b2tlbnMgZnJvbSBjaGFsbGVuZ2VyCiAgICByZXF1aXJlKHRva2VuLnRyYW5zZmVyRnJvbShtc2cuc2VuZGVyLCB0aGlzLCBkZXBvc2l0KSk7CiAgICAvL3N0YXJ0IHBvbGwKICAgIHVpbnQgcG9sbElEID0gdm90aW5nLnN0YXJ0UG9sbCgKICAgICAgZ2V0KCJwVm90ZVF1b3J1bSIpLAogICAgICBnZXQoInBDb21taXRTdGFnZUxlbiIpLAogICAgICBnZXQoInBSZXZlYWxTdGFnZUxlbiIpCiAgICApOwoKICAgIGNoYWxsZW5nZXNbcG9sbElEXSA9IENoYWxsZW5nZSh7CiAgICAgIGNoYWxsZW5nZXI6IG1zZy5zZW5kZXIsCiAgICAgIHJld2FyZFBvb2w6ICgoMTAwIC0gZ2V0KCJwRGlzcGVuc2F0aW9uUGN0IikpICogZGVwb3NpdCkgLyAxMDAsIAogICAgICBzdGFrZTogZGVwb3NpdCwKICAgICAgcmVzb2x2ZWQ6IGZhbHNlLAogICAgICB3aW5uaW5nVG9rZW5zOiAwCiAgICB9KTsKCiAgICBwcm9wb3NhbHNbX3Byb3BJRF0uY2hhbGxlbmdlSUQgPSBwb2xsSUQ7ICAgICAgIC8vIHVwZGF0ZSBsaXN0aW5nIHRvIHN0b3JlIG1vc3QgcmVjZW50IGNoYWxsZW5nZQoKICAgIF9OZXdDaGFsbGVuZ2UobXNnLnNlbmRlciwgX3Byb3BJRCwgcG9sbElEKTsKICAgIHJldHVybiBwb2xsSUQ7CiAgfQoKICAvKioKICBAbm90aWNlIGZvciB0aGUgcHJvdmlkZWQgcHJvcG9zYWwgSUQsIHNldCBpdCwgcmVzb2x2ZSBpdHMgY2hhbGxlbmdlLCBvciBkZWxldGUgaXQgZGVwZW5kaW5nIG9uIHdoZXRoZXIgaXQgY2FuIGJlIHNldCwgaGFzIGEgY2hhbGxlbmdlIHdoaWNoIGNhbiBiZSByZXNvbHZlZCwgb3IgaWYgaXRzICJwcm9jZXNzIGJ5IiBkYXRlIGhhcyBwYXNzZWQKICBAcGFyYW0gX3Byb3BJRCB0aGUgcHJvcG9zYWwgSUQgdG8gbWFrZSBhIGRldGVybWluYXRpb24gYW5kIHN0YXRlIHRyYW5zaXRpb24gZm9yCiAgKi8KICBmdW5jdGlvbiBwcm9jZXNzUHJvcG9zYWwoYnl0ZXMzMiBfcHJvcElEKSBwdWJsaWMgewogICAgUGFyYW1Qcm9wb3NhbCBzdG9yYWdlIHByb3AgPSBwcm9wb3NhbHNbX3Byb3BJRF07CgogICAgaWYgKGNhbkJlU2V0KF9wcm9wSUQpKSB7CiAgICAgIHNldChwcm9wLm5hbWUsIHByb3AudmFsdWUpOwogICAgfSBlbHNlIGlmIChjaGFsbGVuZ2VDYW5CZVJlc29sdmVkKF9wcm9wSUQpKSB7CiAgICAgIHJlc29sdmVDaGFsbGVuZ2UoX3Byb3BJRCk7CiAgICB9IGVsc2UgaWYgKG5vdyA+IHByb3AucHJvY2Vzc0J5KSB7CiAgICAgIHJlcXVpcmUodG9rZW4udHJhbnNmZXIocHJvcC5vd25lciwgcHJvcC5kZXBvc2l0KSk7CiAgICB9IGVsc2UgewogICAgICByZXZlcnQoKTsKICAgIH0KCiAgICBkZWxldGUgcHJvcG9zYWxzW19wcm9wSURdOwogIH0KCiAgLyoqCiAgQG5vdGljZSBjbGFpbSB0aGUgdG9rZW5zIG93ZWQgZm9yIHRoZSBtc2cuc2VuZGVyIGluIHRoZSBwcm92aWRlZCBjaGFsbGVuZ2UKICBAcGFyYW0gX2NoYWxsZW5nZUlEIHRoZSBjaGFsbGVuZ2UgSUQgdG8gY2xhaW0gdG9rZW5zIGZvcgogIEBwYXJhbSBfc2FsdCB0aGUgc2FsdCB1c2VkIHRvIHZvdGUgaW4gdGhlIGNoYWxsZW5nZSBiZWluZyB3aXRoZHJhd24gZm9yCiAgKi8KICBmdW5jdGlvbiBjbGFpbVJld2FyZCh1aW50IF9jaGFsbGVuZ2VJRCwgdWludCBfc2FsdCkgcHVibGljIHsKICAgIC8vIGVuc3VyZSB2b3RlciBoYXMgbm90IGFscmVhZHkgY2xhaW1lZCB0b2tlbnMgYW5kIGNoYWxsZW5nZSByZXN1bHRzIGhhdmUgYmVlbiBwcm9jZXNzZWQKICAgIHJlcXVpcmUoY2hhbGxlbmdlc1tfY2hhbGxlbmdlSURdLnRva2VuQ2xhaW1zW21zZy5zZW5kZXJdID09IGZhbHNlKTsKICAgIHJlcXVpcmUoY2hhbGxlbmdlc1tfY2hhbGxlbmdlSURdLnJlc29sdmVkID09IHRydWUpOwoKICAgIHVpbnQgdm90ZXJUb2tlbnMgPSB2b3RpbmcuZ2V0TnVtUGFzc2luZ1Rva2Vucyhtc2cuc2VuZGVyLCBfY2hhbGxlbmdlSUQsIF9zYWx0KTsKICAgIHVpbnQgcmV3YXJkID0gdm90ZXJSZXdhcmQobXNnLnNlbmRlciwgX2NoYWxsZW5nZUlELCBfc2FsdCk7CgogICAgLy8gc3VidHJhY3Qgdm90ZXIncyBpbmZvcm1hdGlvbiB0byBwcmVzZXJ2ZSB0aGUgcGFydGljaXBhdGlvbiByYXRpb3Mgb2Ygb3RoZXIgdm90ZXJzCiAgICAvLyBjb21wYXJlZCB0byB0aGUgcmVtYWluaW5nIHBvb2wgb2YgcmV3YXJkcwogICAgY2hhbGxlbmdlc1tfY2hhbGxlbmdlSURdLndpbm5pbmdUb2tlbnMgLT0gdm90ZXJUb2tlbnM7CiAgICBjaGFsbGVuZ2VzW19jaGFsbGVuZ2VJRF0ucmV3YXJkUG9vbCAtPSByZXdhcmQ7CgogICAgcmVxdWlyZSh0b2tlbi50cmFuc2Zlcihtc2cuc2VuZGVyLCByZXdhcmQpKTsKICAgIAogICAgLy8gZW5zdXJlcyBhIHZvdGVyIGNhbm5vdCBjbGFpbSB0b2tlbnMgYWdhaW4KICAgIGNoYWxsZW5nZXNbX2NoYWxsZW5nZUlEXS50b2tlbkNsYWltc1ttc2cuc2VuZGVyXSA9IHRydWU7CiAgfQoKICAvLyAtLS0tLS0tLQogIC8vIEdFVFRFUlMKICAvLyAtLS0tLS0tLQoKICAvKioKICBAZGV2ICAgICAgICAgICAgICAgIENhbGN1bGF0ZXMgdGhlIHByb3ZpZGVkIHZvdGVyJ3MgdG9rZW4gcmV3YXJkIGZvciB0aGUgZ2l2ZW4gcG9sbC4KICBAcGFyYW0gX3ZvdGVyICAgICAgIFRoZSBhZGRyZXNzIG9mIHRoZSB2b3RlciB3aG9zZSByZXdhcmQgYmFsYW5jZSBpcyB0byBiZSByZXR1cm5lZAogIEBwYXJhbSBfY2hhbGxlbmdlSUQgVGhlIElEIG9mIHRoZSBjaGFsbGVuZ2UgdGhlIHZvdGVyJ3MgcmV3YXJkIGlzIGJlaW5nIGNhbGN1bGF0ZWQgZm9yCiAgQHBhcmFtIF9zYWx0ICAgICAgICBUaGUgc2FsdCBvZiB0aGUgdm90ZXIncyBjb21taXQgaGFzaCBpbiB0aGUgZ2l2ZW4gcG9sbAogIEByZXR1cm4gICAgICAgICAgICAgVGhlIHVpbnQgaW5kaWNhdGluZyB0aGUgdm90ZXIncyByZXdhcmQKICAqLwogIGZ1bmN0aW9uIHZvdGVyUmV3YXJkKGFkZHJlc3MgX3ZvdGVyLCB1aW50IF9jaGFsbGVuZ2VJRCwgdWludCBfc2FsdCkKICBwdWJsaWMgdmlldyByZXR1cm5zICh1aW50KSB7CiAgICB1aW50IHdpbm5pbmdUb2tlbnMgPSBjaGFsbGVuZ2VzW19jaGFsbGVuZ2VJRF0ud2lubmluZ1Rva2VuczsKICAgIHVpbnQgcmV3YXJkUG9vbCA9IGNoYWxsZW5nZXNbX2NoYWxsZW5nZUlEXS5yZXdhcmRQb29sOwogICAgdWludCB2b3RlclRva2VucyA9IHZvdGluZy5nZXROdW1QYXNzaW5nVG9rZW5zKF92b3RlciwgX2NoYWxsZW5nZUlELCBfc2FsdCk7CiAgICByZXR1cm4gKHZvdGVyVG9rZW5zICogcmV3YXJkUG9vbCkgLyB3aW5uaW5nVG9rZW5zOwogIH0KCiAgLyoqCiAgQG5vdGljZSBEZXRlcm1pbmVzIHdoZXRoZXIgYSBwcm9wb3NhbCBwYXNzZWQgaXRzIGFwcGxpY2F0aW9uIHN0YWdlIHdpdGhvdXQgYSBjaGFsbGVuZ2UKICBAcGFyYW0gX3Byb3BJRCBUaGUgcHJvcG9zYWwgSUQgZm9yIHdoaWNoIHRvIGRldGVybWluZSB3aGV0aGVyIGl0cyBhcHBsaWNhdGlvbiBzdGFnZSBwYXNzZWQgd2l0aG91dCBhIGNoYWxsZW5nZQogICovCiAgZnVuY3Rpb24gY2FuQmVTZXQoYnl0ZXMzMiBfcHJvcElEKSB2aWV3IHB1YmxpYyByZXR1cm5zIChib29sKSB7CiAgICBQYXJhbVByb3Bvc2FsIG1lbW9yeSBwcm9wID0gcHJvcG9zYWxzW19wcm9wSURdOwoKICAgIHJldHVybiAobm93ID4gcHJvcC5hcHBFeHBpcnkgJiYgbm93IDwgcHJvcC5wcm9jZXNzQnkgJiYgcHJvcC5jaGFsbGVuZ2VJRCA9PSAwKTsKICB9CgogIC8qKgogIEBub3RpY2UgRGV0ZXJtaW5lcyB3aGV0aGVyIGEgcHJvcG9zYWwgZXhpc3RzIGZvciB0aGUgcHJvdmlkZWQgcHJvcG9zYWwgSUQKICBAcGFyYW0gX3Byb3BJRCBUaGUgcHJvcG9zYWwgSUQgd2hvc2UgZXhpc3RhbmNlIGlzIHRvIGJlIGRldGVybWluZWQKICAqLwogIGZ1bmN0aW9uIHByb3BFeGlzdHMoYnl0ZXMzMiBfcHJvcElEKSB2aWV3IHB1YmxpYyByZXR1cm5zIChib29sKSB7CiAgICByZXR1cm4gcHJvcG9zYWxzW19wcm9wSURdLnByb2Nlc3NCeSA+IDA7CiAgfQoKICAvKioKICBAbm90aWNlIERldGVybWluZXMgd2hldGhlciB0aGUgcHJvdmlkZWQgcHJvcG9zYWwgSUQgaGFzIGEgY2hhbGxlbmdlIHdoaWNoIGNhbiBiZSByZXNvbHZlZAogIEBwYXJhbSBfcHJvcElEIFRoZSBwcm9wb3NhbCBJRCB3aG9zZSBjaGFsbGVuZ2UgdG8gaW5zcGVjdAogICovCiAgZnVuY3Rpb24gY2hhbGxlbmdlQ2FuQmVSZXNvbHZlZChieXRlczMyIF9wcm9wSUQpIHZpZXcgcHVibGljIHJldHVybnMgKGJvb2wpIHsKICAgIFBhcmFtUHJvcG9zYWwgbWVtb3J5IHByb3AgPSBwcm9wb3NhbHNbX3Byb3BJRF07CiAgICBDaGFsbGVuZ2UgbWVtb3J5IGNoYWxsZW5nZSA9IGNoYWxsZW5nZXNbcHJvcC5jaGFsbGVuZ2VJRF07CgogICAgcmV0dXJuIChwcm9wLmNoYWxsZW5nZUlEID4gMCAmJiBjaGFsbGVuZ2UucmVzb2x2ZWQgPT0gZmFsc2UgJiYKICAgICAgICAgICAgdm90aW5nLnBvbGxFbmRlZChwcm9wLmNoYWxsZW5nZUlEKSk7CiAgfQoKICAvKioKICBAbm90aWNlIERldGVybWluZXMgdGhlIG51bWJlciBvZiB0b2tlbnMgdG8gYXdhcmRlZCB0byB0aGUgd2lubmluZyBwYXJ0eSBpbiBhIGNoYWxsZW5nZQogIEBwYXJhbSBfY2hhbGxlbmdlSUQgVGhlIGNoYWxsZW5nZUlEIHRvIGRldGVybWluZSBhIHJld2FyZCBmb3IKICAqLwogIGZ1bmN0aW9uIGNoYWxsZW5nZVdpbm5lclJld2FyZCh1aW50IF9jaGFsbGVuZ2VJRCkgcHVibGljIHZpZXcgcmV0dXJucyAodWludCkgewogICAgaWYodm90aW5nLmdldFRvdGFsTnVtYmVyT2ZUb2tlbnNGb3JXaW5uaW5nT3B0aW9uKF9jaGFsbGVuZ2VJRCkgPT0gMCkgewogICAgICAvLyBFZGdlIGNhc2UsIG5vYm9keSB2b3RlZCwgZ2l2ZSBhbGwgdG9rZW5zIHRvIHRoZSB3aW5uZXIuCiAgICAgIHJldHVybiAyICogY2hhbGxlbmdlc1tfY2hhbGxlbmdlSURdLnN0YWtlOwogICAgfQogICAgCiAgICByZXR1cm4gKDIgKiBjaGFsbGVuZ2VzW19jaGFsbGVuZ2VJRF0uc3Rha2UpIC0gY2hhbGxlbmdlc1tfY2hhbGxlbmdlSURdLnJld2FyZFBvb2w7CiAgfQoKICAvKioKICBAbm90aWNlIGdldHMgdGhlIHBhcmFtZXRlciBrZXllZCBieSB0aGUgcHJvdmlkZWQgbmFtZSB2YWx1ZSBmcm9tIHRoZSBwYXJhbXMgbWFwcGluZwogIEBwYXJhbSBfbmFtZSB0aGUga2V5IHdob3NlIHZhbHVlIGlzIHRvIGJlIGRldGVybWluZWQKICAqLwogIGZ1bmN0aW9uIGdldChzdHJpbmcgX25hbWUpIHB1YmxpYyB2aWV3IHJldHVybnMgKHVpbnQgdmFsdWUpIHsKICAgIHJldHVybiBwYXJhbXNba2VjY2FrMjU2KF9uYW1lKV07CiAgfQoKICAvLyAtLS0tLS0tLS0tLS0tLS0tCiAgLy8gUFJJVkFURSBGVU5DVElPTlMKICAvLyAtLS0tLS0tLS0tLS0tLS0tCgogIC8qKgogIEBkZXYgcmVzb2x2ZXMgYSBjaGFsbGVuZ2UgZm9yIHRoZSBwcm92aWRlZCBfcHJvcElELiBJdCBtdXN0IGJlIGNoZWNrZWQgaW4gYWR2YW5jZSB3aGV0aGVyIHRoZSBfcHJvcElEIGhhcyBhIGNoYWxsZW5nZSBvbiBpdAogIEBwYXJhbSBfcHJvcElEIHRoZSBwcm9wb3NhbCBJRCB3aG9zZSBjaGFsbGVuZ2UgaXMgdG8gYmUgcmVzb2x2ZWQuCiAgKi8KICBmdW5jdGlvbiByZXNvbHZlQ2hhbGxlbmdlKGJ5dGVzMzIgX3Byb3BJRCkgcHJpdmF0ZSB7CiAgICBQYXJhbVByb3Bvc2FsIG1lbW9yeSBwcm9wID0gcHJvcG9zYWxzW19wcm9wSURdOwogICAgQ2hhbGxlbmdlIHN0b3JhZ2UgY2hhbGxlbmdlID0gY2hhbGxlbmdlc1twcm9wLmNoYWxsZW5nZUlEXTsKCiAgICAvLyB3aW5uZXIgZ2V0cyBiYWNrIHRoZWlyIGZ1bGwgc3Rha2VkIGRlcG9zaXQsIGFuZCBkaXNwZW5zYXRpb25QY3QqbG9zZXIncyBzdGFrZQogICAgdWludCByZXdhcmQgPSBjaGFsbGVuZ2VXaW5uZXJSZXdhcmQocHJvcC5jaGFsbGVuZ2VJRCk7CgogICAgaWYgKHZvdGluZy5pc1Bhc3NlZChwcm9wLmNoYWxsZW5nZUlEKSkgeyAvLyBUaGUgY2hhbGxlbmdlIGZhaWxlZAogICAgICBpZihwcm9wLnByb2Nlc3NCeSA+IG5vdykgewogICAgICAgIHNldChwcm9wLm5hbWUsIHByb3AudmFsdWUpOwogICAgICB9CiAgICAgIHJlcXVpcmUodG9rZW4udHJhbnNmZXIocHJvcC5vd25lciwgcmV3YXJkKSk7CiAgICB9IAogICAgZWxzZSB7IC8vIFRoZSBjaGFsbGVuZ2Ugc3VjY2VlZGVkCiAgICAgIHJlcXVpcmUodG9rZW4udHJhbnNmZXIoY2hhbGxlbmdlc1twcm9wLmNoYWxsZW5nZUlEXS5jaGFsbGVuZ2VyLCByZXdhcmQpKTsKICAgIH0KCiAgICBjaGFsbGVuZ2Uud2lubmluZ1Rva2VucyA9CiAgICAgIHZvdGluZy5nZXRUb3RhbE51bWJlck9mVG9rZW5zRm9yV2lubmluZ09wdGlvbihwcm9wLmNoYWxsZW5nZUlEKTsKICAgIGNoYWxsZW5nZS5yZXNvbHZlZCA9IHRydWU7CiAgfQoKICAvKioKICBAZGV2IHNldHMgdGhlIHBhcmFtIGtldGVkIGJ5IHRoZSBwcm92aWRlZCBuYW1lIHRvIHRoZSBwcm92aWRlZCB2YWx1ZQogIEBwYXJhbSBfbmFtZSB0aGUgbmFtZSBvZiB0aGUgcGFyYW0gdG8gYmUgc2V0CiAgQHBhcmFtIF92YWx1ZSB0aGUgdmFsdWUgdG8gc2V0IHRoZSBwYXJhbSB0byBiZSBzZXQKICAqLwogIGZ1bmN0aW9uIHNldChzdHJpbmcgX25hbWUsIHVpbnQgX3ZhbHVlKSBwcml2YXRlIHsKICAgIHBhcmFtc1trZWNjYWsyNTYoX25hbWUpXSA9IF92YWx1ZTsKICB9Cn0KY29udHJhY3QgUmVnaXN0cnkgewoKICAgIC8vIC0tLS0tLQogICAgLy8gRVZFTlRTCiAgICAvLyAtLS0tLS0KCiAgICBldmVudCBfQXBwbGljYXRpb24oYnl0ZXMzMiBsaXN0aW5nSGFzaCwgdWludCBkZXBvc2l0LCBzdHJpbmcgZGF0YSk7CiAgICBldmVudCBfQ2hhbGxlbmdlKGJ5dGVzMzIgbGlzdGluZ0hhc2gsIHVpbnQgZGVwb3NpdCwgdWludCBwb2xsSUQsIHN0cmluZyBkYXRhKTsKICAgIGV2ZW50IF9EZXBvc2l0KGJ5dGVzMzIgbGlzdGluZ0hhc2gsIHVpbnQgYWRkZWQsIHVpbnQgbmV3VG90YWwpOwogICAgZXZlbnQgX1dpdGhkcmF3YWwoYnl0ZXMzMiBsaXN0aW5nSGFzaCwgdWludCB3aXRoZHJldywgdWludCBuZXdUb3RhbCk7CiAgICBldmVudCBfTmV3TGlzdGluZ1doaXRlbGlzdGVkKGJ5dGVzMzIgbGlzdGluZ0hhc2gpOwogICAgZXZlbnQgX0FwcGxpY2F0aW9uUmVtb3ZlZChieXRlczMyIGxpc3RpbmdIYXNoKTsKICAgIGV2ZW50IF9MaXN0aW5nUmVtb3ZlZChieXRlczMyIGxpc3RpbmdIYXNoKTsKICAgIGV2ZW50IF9DaGFsbGVuZ2VGYWlsZWQodWludCBjaGFsbGVuZ2VJRCk7CiAgICBldmVudCBfQ2hhbGxlbmdlU3VjY2VlZGVkKHVpbnQgY2hhbGxlbmdlSUQpOwogICAgZXZlbnQgX1Jld2FyZENsYWltZWQoYWRkcmVzcyB2b3RlciwgdWludCBjaGFsbGVuZ2VJRCwgdWludCByZXdhcmQpOwoKICAgIHN0cnVjdCBMaXN0aW5nIHsKICAgICAgICB1aW50IGFwcGxpY2F0aW9uRXhwaXJ5OyAvLyBFeHBpcmF0aW9uIGRhdGUgb2YgYXBwbHkgc3RhZ2UKICAgICAgICBib29sIHdoaXRlbGlzdGVkOyAgICAgICAvLyBJbmRpY2F0ZXMgcmVnaXN0cnkgc3RhdHVzCiAgICAgICAgYWRkcmVzcyBvd25lcjsgICAgICAgICAgLy8gT3duZXIgb2YgTGlzdGluZwogICAgICAgIHVpbnQgdW5zdGFrZWREZXBvc2l0OyAgIC8vIE51bWJlciBvZiB0b2tlbnMgaW4gdGhlIGxpc3Rpbmcgbm90IGxvY2tlZCBpbiBhIGNoYWxsZW5nZQogICAgICAgIHVpbnQgY2hhbGxlbmdlSUQ7ICAgICAgIC8vIENvcnJlc3BvbmRzIHRvIGEgUG9sbElEIGluIFBMQ1JWb3RpbmcKICAgIH0KCiAgICBzdHJ1Y3QgQ2hhbGxlbmdlIHsKICAgICAgICB1aW50IHJld2FyZFBvb2w7ICAgICAgICAvLyAocmVtYWluaW5nKSBQb29sIG9mIHRva2VucyB0byBiZSBkaXN0cmlidXRlZCB0byB3aW5uaW5nIHZvdGVycwogICAgICAgIGFkZHJlc3MgY2hhbGxlbmdlcjsgICAgIC8vIE93bmVyIG9mIENoYWxsZW5nZQogICAgICAgIGJvb2wgcmVzb2x2ZWQ7ICAgICAgICAgIC8vIEluZGljYXRpb24gb2YgaWYgY2hhbGxlbmdlIGlzIHJlc29sdmVkCiAgICAgICAgdWludCBzdGFrZTsgICAgICAgICAgICAgLy8gTnVtYmVyIG9mIHRva2VucyBhdCBzdGFrZSBmb3IgZWl0aGVyIHBhcnR5IGR1cmluZyBjaGFsbGVuZ2UKICAgICAgICB1aW50IHRvdGFsVG9rZW5zOyAgICAgICAvLyAocmVtYWluaW5nKSBOdW1iZXIgb2YgdG9rZW5zIHVzZWQgaW4gdm90aW5nIGJ5IHRoZSB3aW5uaW5nIHNpZGUKICAgICAgICBtYXBwaW5nKGFkZHJlc3MgPT4gYm9vbCkgdG9rZW5DbGFpbXM7IC8vIEluZGljYXRlcyB3aGV0aGVyIGEgdm90ZXIgaGFzIGNsYWltZWQgYSByZXdhcmQgeWV0CiAgICB9CgogICAgLy8gTWFwcyBjaGFsbGVuZ2VJRHMgdG8gYXNzb2NpYXRlZCBjaGFsbGVuZ2UgZGF0YQogICAgbWFwcGluZyh1aW50ID0+IENoYWxsZW5nZSkgcHVibGljIGNoYWxsZW5nZXM7CgogICAgLy8gTWFwcyBsaXN0aW5nSGFzaGVzIHRvIGFzc29jaWF0ZWQgbGlzdGluZ0hhc2ggZGF0YQogICAgbWFwcGluZyhieXRlczMyID0+IExpc3RpbmcpIHB1YmxpYyBsaXN0aW5nczsKCiAgICAvLyBHbG9iYWwgVmFyaWFibGVzCiAgICBFSVAyMCBwdWJsaWMgdG9rZW47CiAgICBQTENSVm90aW5nIHB1YmxpYyB2b3Rpbmc7CiAgICBQYXJhbWV0ZXJpemVyIHB1YmxpYyBwYXJhbWV0ZXJpemVyOwogICAgc3RyaW5nIHB1YmxpYyB2ZXJzaW9uID0gJzEnOwoKICAgIC8vIC0tLS0tLS0tLS0tLQogICAgLy8gQ09OU1RSVUNUT1I6CiAgICAvLyAtLS0tLS0tLS0tLS0KCiAgICAvKioKICAgIEBkZXYgQ29udHJ1Y3RvciAgICAgICAgIFNldHMgdGhlIGFkZHJlc3NlcyBmb3IgdG9rZW4sIHZvdGluZywgYW5kIHBhcmFtZXRlcml6ZXIKICAgIEBwYXJhbSBfdG9rZW5BZGRyICAgICAgIEFkZHJlc3Mgb2YgdGhlIFRDUidzIGludHJpbnNpYyBFUkMyMCB0b2tlbgogICAgQHBhcmFtIF9wbGNyQWRkciAgICAgICAgQWRkcmVzcyBvZiBhIFBMQ1Igdm90aW5nIGNvbnRyYWN0IGZvciB0aGUgcHJvdmlkZWQgdG9rZW4KICAgIEBwYXJhbSBfcGFyYW1zQWRkciAgICAgIEFkZHJlc3Mgb2YgYSBQYXJhbWV0ZXJpemVyIGNvbnRyYWN0IAogICAgKi8KICAgIGZ1bmN0aW9uIFJlZ2lzdHJ5KAogICAgICAgIGFkZHJlc3MgX3Rva2VuQWRkciwKICAgICAgICBhZGRyZXNzIF9wbGNyQWRkciwKICAgICAgICBhZGRyZXNzIF9wYXJhbXNBZGRyCiAgICApIHB1YmxpYyB7CiAgICAgICAgdG9rZW4gPSBFSVAyMChfdG9rZW5BZGRyKTsKICAgICAgICB2b3RpbmcgPSBQTENSVm90aW5nKF9wbGNyQWRkcik7CiAgICAgICAgcGFyYW1ldGVyaXplciA9IFBhcmFtZXRlcml6ZXIoX3BhcmFtc0FkZHIpOwogICAgfQoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBQVUJMSVNIRVIgSU5URVJGQUNFOgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0KCiAgICAvKioKICAgIEBkZXYgICAgICAgICAgICAgICAgQWxsb3dzIGEgdXNlciB0byBzdGFydCBhbiBhcHBsaWNhdGlvbi4gVGFrZXMgdG9rZW5zIGZyb20gdXNlciBhbmQgc2V0cwogICAgICAgICAgICAgICAgICAgICAgICBhcHBseSBzdGFnZSBlbmQgdGltZS4KICAgIEBwYXJhbSBfbGlzdGluZ0hhc2ggVGhlIGhhc2ggb2YgYSBwb3RlbnRpYWwgbGlzdGluZyBhIHVzZXIgaXMgYXBwbHlpbmcgdG8gYWRkIHRvIHRoZSByZWdpc3RyeQogICAgQHBhcmFtIF9hbW91bnQgICAgICBUaGUgbnVtYmVyIG9mIEVSQzIwIHRva2VucyBhIHVzZXIgaXMgd2lsbGluZyB0byBwb3RlbnRpYWxseSBzdGFrZQogICAgQHBhcmFtIF9kYXRhICAgICAgICBFeHRyYSBkYXRhIHJlbGV2YW50IHRvIHRoZSBhcHBsaWNhdGlvbi4gVGhpbmsgSVBGUyBoYXNoZXMuCiAgICAqLwogICAgZnVuY3Rpb24gYXBwbHkoYnl0ZXMzMiBfbGlzdGluZ0hhc2gsIHVpbnQgX2Ftb3VudCwgc3RyaW5nIF9kYXRhKSBleHRlcm5hbCB7CiAgICAgICAgcmVxdWlyZSghaXNXaGl0ZWxpc3RlZChfbGlzdGluZ0hhc2gpKTsKICAgICAgICByZXF1aXJlKCFhcHBXYXNNYWRlKF9saXN0aW5nSGFzaCkpOwogICAgICAgIHJlcXVpcmUoX2Ftb3VudCA+PSBwYXJhbWV0ZXJpemVyLmdldCgibWluRGVwb3NpdCIpKTsKCiAgICAgICAgLy8gU2V0cyBvd25lcgogICAgICAgIExpc3Rpbmcgc3RvcmFnZSBsaXN0aW5nSGFzaCA9IGxpc3RpbmdzW19saXN0aW5nSGFzaF07CiAgICAgICAgbGlzdGluZ0hhc2gub3duZXIgPSBtc2cuc2VuZGVyOwoKICAgICAgICAvLyBUcmFuc2ZlcnMgdG9rZW5zIGZyb20gdXNlciB0byBSZWdpc3RyeSBjb250cmFjdAogICAgICAgIHJlcXVpcmUodG9rZW4udHJhbnNmZXJGcm9tKGxpc3RpbmdIYXNoLm93bmVyLCB0aGlzLCBfYW1vdW50KSk7CgogICAgICAgIC8vIFNldHMgYXBwbHkgc3RhZ2UgZW5kIHRpbWUKICAgICAgICBsaXN0aW5nSGFzaC5hcHBsaWNhdGlvbkV4cGlyeSA9IGJsb2NrLnRpbWVzdGFtcCArIHBhcmFtZXRlcml6ZXIuZ2V0KCJhcHBseVN0YWdlTGVuIik7CiAgICAgICAgbGlzdGluZ0hhc2gudW5zdGFrZWREZXBvc2l0ID0gX2Ftb3VudDsKCiAgICAgICAgX0FwcGxpY2F0aW9uKF9saXN0aW5nSGFzaCwgX2Ftb3VudCwgX2RhdGEpOwogICAgfQoKICAgIC8qKgogICAgQGRldiAgICAgICAgICAgICAgICBBbGxvd3MgdGhlIG93bmVyIG9mIGEgbGlzdGluZ0hhc2ggdG8gaW5jcmVhc2UgdGhlaXIgdW5zdGFrZWQgZGVwb3NpdC4KICAgIEBwYXJhbSBfbGlzdGluZ0hhc2ggQSBsaXN0aW5nSGFzaCBtc2cuc2VuZGVyIGlzIHRoZSBvd25lciBvZgogICAgQHBhcmFtIF9hbW91bnQgICAgICBUaGUgbnVtYmVyIG9mIEVSQzIwIHRva2VucyB0byBpbmNyZWFzZSBhIHVzZXIncyB1bnN0YWtlZCBkZXBvc2l0CiAgICAqLwogICAgZnVuY3Rpb24gZGVwb3NpdChieXRlczMyIF9saXN0aW5nSGFzaCwgdWludCBfYW1vdW50KSBleHRlcm5hbCB7CiAgICAgICAgTGlzdGluZyBzdG9yYWdlIGxpc3RpbmdIYXNoID0gbGlzdGluZ3NbX2xpc3RpbmdIYXNoXTsKCiAgICAgICAgcmVxdWlyZShsaXN0aW5nSGFzaC5vd25lciA9PSBtc2cuc2VuZGVyKTsKICAgICAgICByZXF1aXJlKHRva2VuLnRyYW5zZmVyRnJvbShtc2cuc2VuZGVyLCB0aGlzLCBfYW1vdW50KSk7CgogICAgICAgIGxpc3RpbmdIYXNoLnVuc3Rha2VkRGVwb3NpdCArPSBfYW1vdW50OwoKICAgICAgICBfRGVwb3NpdChfbGlzdGluZ0hhc2gsIF9hbW91bnQsIGxpc3RpbmdIYXNoLnVuc3Rha2VkRGVwb3NpdCk7CiAgICB9CgogICAgLyoqCiAgICBAZGV2ICAgICAgICAgICAgICAgIEFsbG93cyB0aGUgb3duZXIgb2YgYSBsaXN0aW5nSGFzaCB0byBkZWNyZWFzZSB0aGVpciB1bnN0YWtlZCBkZXBvc2l0LgogICAgQHBhcmFtIF9saXN0aW5nSGFzaCBBIGxpc3RpbmdIYXNoIG1zZy5zZW5kZXIgaXMgdGhlIG93bmVyIG9mLgogICAgQHBhcmFtIF9hbW91bnQgICAgICBUaGUgbnVtYmVyIG9mIEVSQzIwIHRva2VucyB0byB3aXRoZHJhdyBmcm9tIHRoZSB1bnN0YWtlZCBkZXBvc2l0LgogICAgKi8KICAgIGZ1bmN0aW9uIHdpdGhkcmF3KGJ5dGVzMzIgX2xpc3RpbmdIYXNoLCB1aW50IF9hbW91bnQpIGV4dGVybmFsIHsKICAgICAgICBMaXN0aW5nIHN0b3JhZ2UgbGlzdGluZ0hhc2ggPSBsaXN0aW5nc1tfbGlzdGluZ0hhc2hdOwoKICAgICAgICByZXF1aXJlKGxpc3RpbmdIYXNoLm93bmVyID09IG1zZy5zZW5kZXIpOwogICAgICAgIHJlcXVpcmUoX2Ftb3VudCA8PSBsaXN0aW5nSGFzaC51bnN0YWtlZERlcG9zaXQpOwogICAgICAgIHJlcXVpcmUobGlzdGluZ0hhc2gudW5zdGFrZWREZXBvc2l0IC0gX2Ftb3VudCA+PSBwYXJhbWV0ZXJpemVyLmdldCgibWluRGVwb3NpdCIpKTsKCiAgICAgICAgcmVxdWlyZSh0b2tlbi50cmFuc2Zlcihtc2cuc2VuZGVyLCBfYW1vdW50KSk7CgogICAgICAgIGxpc3RpbmdIYXNoLnVuc3Rha2VkRGVwb3NpdCAtPSBfYW1vdW50OwoKICAgICAgICBfV2l0aGRyYXdhbChfbGlzdGluZ0hhc2gsIF9hbW91bnQsIGxpc3RpbmdIYXNoLnVuc3Rha2VkRGVwb3NpdCk7CiAgICB9CgogICAgLyoqCiAgICBAZGV2ICAgICAgICAgICAgICAgIEFsbG93cyB0aGUgb3duZXIgb2YgYSBsaXN0aW5nSGFzaCB0byByZW1vdmUgdGhlIGxpc3RpbmdIYXNoIGZyb20gdGhlIHdoaXRlbGlzdAogICAgICAgICAgICAgICAgICAgICAgICBSZXR1cm5zIGFsbCB0b2tlbnMgdG8gdGhlIG93bmVyIG9mIHRoZSBsaXN0aW5nSGFzaAogICAgQHBhcmFtIF9saXN0aW5nSGFzaCBBIGxpc3RpbmdIYXNoIG1zZy5zZW5kZXIgaXMgdGhlIG93bmVyIG9mLgogICAgKi8KICAgIGZ1bmN0aW9uIGV4aXQoYnl0ZXMzMiBfbGlzdGluZ0hhc2gpIGV4dGVybmFsIHsKICAgICAgICBMaXN0aW5nIHN0b3JhZ2UgbGlzdGluZ0hhc2ggPSBsaXN0aW5nc1tfbGlzdGluZ0hhc2hdOwoKICAgICAgICByZXF1aXJlKG1zZy5zZW5kZXIgPT0gbGlzdGluZ0hhc2gub3duZXIpOwogICAgICAgIHJlcXVpcmUoaXNXaGl0ZWxpc3RlZChfbGlzdGluZ0hhc2gpKTsKCiAgICAgICAgLy8gQ2Fubm90IGV4aXQgZHVyaW5nIG9uZ29pbmcgY2hhbGxlbmdlCiAgICAgICAgcmVxdWlyZShsaXN0aW5nSGFzaC5jaGFsbGVuZ2VJRCA9PSAwIHx8IGNoYWxsZW5nZXNbbGlzdGluZ0hhc2guY2hhbGxlbmdlSURdLnJlc29sdmVkKTsKCiAgICAgICAgLy8gUmVtb3ZlIGxpc3RpbmdIYXNoICYgcmV0dXJuIHRva2VucwogICAgICAgIHJlc2V0TGlzdGluZyhfbGlzdGluZ0hhc2gpOwogICAgfQoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBUT0tFTiBIT0xERVIgSU5URVJGQUNFOgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KCiAgICAvKioKICAgIEBkZXYgICAgICAgICAgICAgICAgU3RhcnRzIGEgcG9sbCBmb3IgYSBsaXN0aW5nSGFzaCB3aGljaCBpcyBlaXRoZXIgaW4gdGhlIGFwcGx5IHN0YWdlIG9yCiAgICAgICAgICAgICAgICAgICAgICAgIGFscmVhZHkgaW4gdGhlIHdoaXRlbGlzdC4gVG9rZW5zIGFyZSB0YWtlbiBmcm9tIHRoZSBjaGFsbGVuZ2VyIGFuZCB0aGUKICAgICAgICAgICAgICAgICAgICAgICAgYXBwbGljYW50J3MgZGVwb3NpdHMgYXJlIGxvY2tlZC4KICAgIEBwYXJhbSBfbGlzdGluZ0hhc2ggVGhlIGxpc3RpbmdIYXNoIGJlaW5nIGNoYWxsZW5nZWQsIHdoZXRoZXIgbGlzdGVkIG9yIGluIGFwcGxpY2F0aW9uCiAgICBAcGFyYW0gX2RhdGEgICAgICAgIEV4dHJhIGRhdGEgcmVsZXZhbnQgdG8gdGhlIGNoYWxsZW5nZS4gVGhpbmsgSVBGUyBoYXNoZXMuCiAgICAqLwogICAgZnVuY3Rpb24gY2hhbGxlbmdlKGJ5dGVzMzIgX2xpc3RpbmdIYXNoLCBzdHJpbmcgX2RhdGEpIGV4dGVybmFsIHJldHVybnMgKHVpbnQgY2hhbGxlbmdlSUQpIHsKICAgICAgICBieXRlczMyIGxpc3RpbmdIYXNoSGFzaCA9IF9saXN0aW5nSGFzaDsKICAgICAgICBMaXN0aW5nIHN0b3JhZ2UgbGlzdGluZ0hhc2ggPSBsaXN0aW5nc1tsaXN0aW5nSGFzaEhhc2hdOwogICAgICAgIHVpbnQgZGVwb3NpdCA9IHBhcmFtZXRlcml6ZXIuZ2V0KCJtaW5EZXBvc2l0Iik7CgogICAgICAgIC8vIExpc3RpbmcgbXVzdCBiZSBpbiBhcHBseSBzdGFnZSBvciBhbHJlYWR5IG9uIHRoZSB3aGl0ZWxpc3QKICAgICAgICByZXF1aXJlKGFwcFdhc01hZGUoX2xpc3RpbmdIYXNoKSB8fCBsaXN0aW5nSGFzaC53aGl0ZWxpc3RlZCk7CiAgICAgICAgLy8gUHJldmVudCBtdWx0aXBsZSBjaGFsbGVuZ2VzCiAgICAgICAgcmVxdWlyZShsaXN0aW5nSGFzaC5jaGFsbGVuZ2VJRCA9PSAwIHx8IGNoYWxsZW5nZXNbbGlzdGluZ0hhc2guY2hhbGxlbmdlSURdLnJlc29sdmVkKTsKCiAgICAgICAgaWYgKGxpc3RpbmdIYXNoLnVuc3Rha2VkRGVwb3NpdCA8IGRlcG9zaXQpIHsKICAgICAgICAgICAgLy8gTm90IGVub3VnaCB0b2tlbnMsIGxpc3RpbmdIYXNoIGF1dG8tZGVsaXN0ZWQKICAgICAgICAgICAgcmVzZXRMaXN0aW5nKF9saXN0aW5nSGFzaCk7CiAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgIH0KCiAgICAgICAgLy8gVGFrZXMgdG9rZW5zIGZyb20gY2hhbGxlbmdlcgogICAgICAgIHJlcXVpcmUodG9rZW4udHJhbnNmZXJGcm9tKG1zZy5zZW5kZXIsIHRoaXMsIGRlcG9zaXQpKTsKCiAgICAgICAgLy8gU3RhcnRzIHBvbGwKICAgICAgICB1aW50IHBvbGxJRCA9IHZvdGluZy5zdGFydFBvbGwoCiAgICAgICAgICAgIHBhcmFtZXRlcml6ZXIuZ2V0KCJ2b3RlUXVvcnVtIiksCiAgICAgICAgICAgIHBhcmFtZXRlcml6ZXIuZ2V0KCJjb21taXRTdGFnZUxlbiIpLAogICAgICAgICAgICBwYXJhbWV0ZXJpemVyLmdldCgicmV2ZWFsU3RhZ2VMZW4iKQogICAgICAgICk7CgogICAgICAgIGNoYWxsZW5nZXNbcG9sbElEXSA9IENoYWxsZW5nZSh7CiAgICAgICAgICAgIGNoYWxsZW5nZXI6IG1zZy5zZW5kZXIsCiAgICAgICAgICAgIHJld2FyZFBvb2w6ICgoMTAwIC0gcGFyYW1ldGVyaXplci5nZXQoImRpc3BlbnNhdGlvblBjdCIpKSAqIGRlcG9zaXQpIC8gMTAwLAogICAgICAgICAgICBzdGFrZTogZGVwb3NpdCwKICAgICAgICAgICAgcmVzb2x2ZWQ6IGZhbHNlLAogICAgICAgICAgICB0b3RhbFRva2VuczogMAogICAgICAgIH0pOwoKICAgICAgICAvLyBVcGRhdGVzIGxpc3RpbmdIYXNoIHRvIHN0b3JlIG1vc3QgcmVjZW50IGNoYWxsZW5nZQogICAgICAgIGxpc3RpbmdzW2xpc3RpbmdIYXNoSGFzaF0uY2hhbGxlbmdlSUQgPSBwb2xsSUQ7CgogICAgICAgIC8vIExvY2tzIHRva2VucyBmb3IgbGlzdGluZ0hhc2ggZHVyaW5nIGNoYWxsZW5nZQogICAgICAgIGxpc3RpbmdzW2xpc3RpbmdIYXNoSGFzaF0udW5zdGFrZWREZXBvc2l0IC09IGRlcG9zaXQ7CgogICAgICAgIF9DaGFsbGVuZ2UoX2xpc3RpbmdIYXNoLCBkZXBvc2l0LCBwb2xsSUQsIF9kYXRhKTsKICAgICAgICByZXR1cm4gcG9sbElEOwogICAgfQoKICAgIC8qKgogICAgQGRldiAgICAgICAgICAgICAgICBVcGRhdGVzIGEgbGlzdGluZ0hhc2gncyBzdGF0dXMgZnJvbSAnYXBwbGljYXRpb24nIHRvICdsaXN0aW5nJyBvciByZXNvbHZlcwogICAgICAgICAgICAgICAgICAgICAgICBhIGNoYWxsZW5nZSBpZiBvbmUgZXhpc3RzLgogICAgQHBhcmFtIF9saXN0aW5nSGFzaCBUaGUgbGlzdGluZ0hhc2ggd2hvc2Ugc3RhdHVzIGlzIGJlaW5nIHVwZGF0ZWQKICAgICovCiAgICBmdW5jdGlvbiB1cGRhdGVTdGF0dXMoYnl0ZXMzMiBfbGlzdGluZ0hhc2gpIHB1YmxpYyB7CiAgICAgICAgaWYgKGNhbkJlV2hpdGVsaXN0ZWQoX2xpc3RpbmdIYXNoKSkgewogICAgICAgICAgd2hpdGVsaXN0QXBwbGljYXRpb24oX2xpc3RpbmdIYXNoKTsKICAgICAgICAgIF9OZXdMaXN0aW5nV2hpdGVsaXN0ZWQoX2xpc3RpbmdIYXNoKTsKICAgICAgICB9IGVsc2UgaWYgKGNoYWxsZW5nZUNhbkJlUmVzb2x2ZWQoX2xpc3RpbmdIYXNoKSkgewogICAgICAgICAgcmVzb2x2ZUNoYWxsZW5nZShfbGlzdGluZ0hhc2gpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXZlcnQoKTsKICAgICAgICB9CiAgICB9CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gVE9LRU4gRlVOQ1RJT05TOgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLQoKICAgIC8qKgogICAgQGRldiAgICAgICAgICAgICAgICBDYWxsZWQgYnkgYSB2b3RlciB0byBjbGFpbSB0aGVpciByZXdhcmQgZm9yIGVhY2ggY29tcGxldGVkIHZvdGUuIFNvbWVvbmUKICAgICAgICAgICAgICAgICAgICAgICAgbXVzdCBjYWxsIHVwZGF0ZVN0YXR1cygpIGJlZm9yZSB0aGlzIGNhbiBiZSBjYWxsZWQuCiAgICBAcGFyYW0gX2NoYWxsZW5nZUlEIFRoZSBQTENSIHBvbGxJRCBvZiB0aGUgY2hhbGxlbmdlIGEgcmV3YXJkIGlzIGJlaW5nIGNsYWltZWQgZm9yCiAgICBAcGFyYW0gX3NhbHQgICAgICAgIFRoZSBzYWx0IG9mIGEgdm90ZXIncyBjb21taXQgaGFzaCBpbiB0aGUgZ2l2ZW4gcG9sbAogICAgKi8KICAgIGZ1bmN0aW9uIGNsYWltUmV3YXJkKHVpbnQgX2NoYWxsZW5nZUlELCB1aW50IF9zYWx0KSBwdWJsaWMgewogICAgICAgIC8vIEVuc3VyZXMgdGhlIHZvdGVyIGhhcyBub3QgYWxyZWFkeSBjbGFpbWVkIHRva2VucyBhbmQgY2hhbGxlbmdlIHJlc3VsdHMgaGF2ZSBiZWVuIHByb2Nlc3NlZAogICAgICAgIHJlcXVpcmUoY2hhbGxlbmdlc1tfY2hhbGxlbmdlSURdLnRva2VuQ2xhaW1zW21zZy5zZW5kZXJdID09IGZhbHNlKTsKICAgICAgICByZXF1aXJlKGNoYWxsZW5nZXNbX2NoYWxsZW5nZUlEXS5yZXNvbHZlZCA9PSB0cnVlKTsKCiAgICAgICAgdWludCB2b3RlclRva2VucyA9IHZvdGluZy5nZXROdW1QYXNzaW5nVG9rZW5zKG1zZy5zZW5kZXIsIF9jaGFsbGVuZ2VJRCwgX3NhbHQpOwogICAgICAgIHVpbnQgcmV3YXJkID0gdm90ZXJSZXdhcmQobXNnLnNlbmRlciwgX2NoYWxsZW5nZUlELCBfc2FsdCk7CgogICAgICAgIC8vIFN1YnRyYWN0cyB0aGUgdm90ZXIncyBpbmZvcm1hdGlvbiB0byBwcmVzZXJ2ZSB0aGUgcGFydGljaXBhdGlvbiByYXRpb3MKICAgICAgICAvLyBvZiBvdGhlciB2b3RlcnMgY29tcGFyZWQgdG8gdGhlIHJlbWFpbmluZyBwb29sIG9mIHJld2FyZHMKICAgICAgICBjaGFsbGVuZ2VzW19jaGFsbGVuZ2VJRF0udG90YWxUb2tlbnMgLT0gdm90ZXJUb2tlbnM7CiAgICAgICAgY2hhbGxlbmdlc1tfY2hhbGxlbmdlSURdLnJld2FyZFBvb2wgLT0gcmV3YXJkOwoKICAgICAgICByZXF1aXJlKHRva2VuLnRyYW5zZmVyKG1zZy5zZW5kZXIsIHJld2FyZCkpOwoKICAgICAgICAvLyBFbnN1cmVzIGEgdm90ZXIgY2Fubm90IGNsYWltIHRva2VucyBhZ2FpbgogICAgICAgIGNoYWxsZW5nZXNbX2NoYWxsZW5nZUlEXS50b2tlbkNsYWltc1ttc2cuc2VuZGVyXSA9IHRydWU7CgogICAgICAgIF9SZXdhcmRDbGFpbWVkKG1zZy5zZW5kZXIsIF9jaGFsbGVuZ2VJRCwgcmV3YXJkKTsKICAgIH0KCiAgICAvLyAtLS0tLS0tLQogICAgLy8gR0VUVEVSUzoKICAgIC8vIC0tLS0tLS0tCgogICAgLyoqCiAgICBAZGV2ICAgICAgICAgICAgICAgIENhbGN1bGF0ZXMgdGhlIHByb3ZpZGVkIHZvdGVyJ3MgdG9rZW4gcmV3YXJkIGZvciB0aGUgZ2l2ZW4gcG9sbC4KICAgIEBwYXJhbSBfdm90ZXIgICAgICAgVGhlIGFkZHJlc3Mgb2YgdGhlIHZvdGVyIHdob3NlIHJld2FyZCBiYWxhbmNlIGlzIHRvIGJlIHJldHVybmVkCiAgICBAcGFyYW0gX2NoYWxsZW5nZUlEIFRoZSBwb2xsSUQgb2YgdGhlIGNoYWxsZW5nZSBhIHJld2FyZCBiYWxhbmNlIGlzIGJlaW5nIHF1ZXJpZWQgZm9yCiAgICBAcGFyYW0gX3NhbHQgICAgICAgIFRoZSBzYWx0IG9mIHRoZSB2b3RlcidzIGNvbW1pdCBoYXNoIGluIHRoZSBnaXZlbiBwb2xsCiAgICBAcmV0dXJuICAgICAgICAgICAgIFRoZSB1aW50IGluZGljYXRpbmcgdGhlIHZvdGVyJ3MgcmV3YXJkCiAgICAqLwogICAgZnVuY3Rpb24gdm90ZXJSZXdhcmQoYWRkcmVzcyBfdm90ZXIsIHVpbnQgX2NoYWxsZW5nZUlELCB1aW50IF9zYWx0KQogICAgcHVibGljIHZpZXcgcmV0dXJucyAodWludCkgewogICAgICAgIHVpbnQgdG90YWxUb2tlbnMgPSBjaGFsbGVuZ2VzW19jaGFsbGVuZ2VJRF0udG90YWxUb2tlbnM7CiAgICAgICAgdWludCByZXdhcmRQb29sID0gY2hhbGxlbmdlc1tfY2hhbGxlbmdlSURdLnJld2FyZFBvb2w7CiAgICAgICAgdWludCB2b3RlclRva2VucyA9IHZvdGluZy5nZXROdW1QYXNzaW5nVG9rZW5zKF92b3RlciwgX2NoYWxsZW5nZUlELCBfc2FsdCk7CiAgICAgICAgcmV0dXJuICh2b3RlclRva2VucyAqIHJld2FyZFBvb2wpIC8gdG90YWxUb2tlbnM7CiAgICB9CgogICAgLyoqCiAgICBAZGV2ICAgICAgICAgICAgICAgIERldGVybWluZXMgd2hldGhlciB0aGUgZ2l2ZW4gbGlzdGluZ0hhc2ggYmUgd2hpdGVsaXN0ZWQuCiAgICBAcGFyYW0gX2xpc3RpbmdIYXNoIFRoZSBsaXN0aW5nSGFzaCB3aG9zZSBzdGF0dXMgaXMgdG8gYmUgZXhhbWluZWQKICAgICovCiAgICBmdW5jdGlvbiBjYW5CZVdoaXRlbGlzdGVkKGJ5dGVzMzIgX2xpc3RpbmdIYXNoKSB2aWV3IHB1YmxpYyByZXR1cm5zIChib29sKSB7CiAgICAgICAgYnl0ZXMzMiBsaXN0aW5nSGFzaEhhc2ggPSBfbGlzdGluZ0hhc2g7CiAgICAgICAgdWludCBjaGFsbGVuZ2VJRCA9IGxpc3RpbmdzW2xpc3RpbmdIYXNoSGFzaF0uY2hhbGxlbmdlSUQ7CgogICAgICAgIC8vIEVuc3VyZXMgdGhhdCB0aGUgYXBwbGljYXRpb24gd2FzIG1hZGUsCiAgICAgICAgLy8gdGhlIGFwcGxpY2F0aW9uIHBlcmlvZCBoYXMgZW5kZWQsCiAgICAgICAgLy8gdGhlIGxpc3RpbmdIYXNoIGNhbiBiZSB3aGl0ZWxpc3RlZCwKICAgICAgICAvLyBhbmQgZWl0aGVyOiB0aGUgY2hhbGxlbmdlSUQgPT0gMCwgb3IgdGhlIGNoYWxsZW5nZSBoYXMgYmVlbiByZXNvbHZlZC4KICAgICAgICBpZiAoCiAgICAgICAgICAgIGFwcFdhc01hZGUoX2xpc3RpbmdIYXNoKSAmJgogICAgICAgICAgICBsaXN0aW5nc1tsaXN0aW5nSGFzaEhhc2hdLmFwcGxpY2F0aW9uRXhwaXJ5IDwgbm93ICYmCiAgICAgICAgICAgICFpc1doaXRlbGlzdGVkKF9saXN0aW5nSGFzaCkgJiYKICAgICAgICAgICAgKGNoYWxsZW5nZUlEID09IDAgfHwgY2hhbGxlbmdlc1tjaGFsbGVuZ2VJRF0ucmVzb2x2ZWQgPT0gdHJ1ZSkKICAgICAgICApIHsgcmV0dXJuIHRydWU7IH0KCiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIC8qKgogICAgQGRldiAgICAgICAgICAgICAgICBSZXR1cm5zIHRydWUgaWYgdGhlIHByb3ZpZGVkIGxpc3RpbmdIYXNoIGlzIHdoaXRlbGlzdGVkCiAgICBAcGFyYW0gX2xpc3RpbmdIYXNoIFRoZSBsaXN0aW5nSGFzaCB3aG9zZSBzdGF0dXMgaXMgdG8gYmUgZXhhbWluZWQKICAgICovCiAgICBmdW5jdGlvbiBpc1doaXRlbGlzdGVkKGJ5dGVzMzIgX2xpc3RpbmdIYXNoKSB2aWV3IHB1YmxpYyByZXR1cm5zIChib29sIHdoaXRlbGlzdGVkKSB7CiAgICAgICAgcmV0dXJuIGxpc3RpbmdzW19saXN0aW5nSGFzaF0ud2hpdGVsaXN0ZWQ7CiAgICB9CgogICAgLyoqCiAgICBAZGV2ICAgICAgICAgICAgICAgIFJldHVybnMgdHJ1ZSBpZiBhcHBseSB3YXMgY2FsbGVkIGZvciB0aGlzIGxpc3RpbmdIYXNoCiAgICBAcGFyYW0gX2xpc3RpbmdIYXNoIFRoZSBsaXN0aW5nSGFzaCB3aG9zZSBzdGF0dXMgaXMgdG8gYmUgZXhhbWluZWQKICAgICovCiAgICBmdW5jdGlvbiBhcHBXYXNNYWRlKGJ5dGVzMzIgX2xpc3RpbmdIYXNoKSB2aWV3IHB1YmxpYyByZXR1cm5zIChib29sIGV4aXN0cykgewogICAgICAgIHJldHVybiBsaXN0aW5nc1tfbGlzdGluZ0hhc2hdLmFwcGxpY2F0aW9uRXhwaXJ5ID4gMDsKICAgIH0KCiAgICAvKioKICAgIEBkZXYgICAgICAgICAgICAgICAgUmV0dXJucyB0cnVlIGlmIHRoZSBhcHBsaWNhdGlvbi9saXN0aW5nSGFzaCBoYXMgYW4gdW5yZXNvbHZlZCBjaGFsbGVuZ2UKICAgIEBwYXJhbSBfbGlzdGluZ0hhc2ggVGhlIGxpc3RpbmdIYXNoIHdob3NlIHN0YXR1cyBpcyB0byBiZSBleGFtaW5lZAogICAgKi8KICAgIGZ1bmN0aW9uIGNoYWxsZW5nZUV4aXN0cyhieXRlczMyIF9saXN0aW5nSGFzaCkgdmlldyBwdWJsaWMgcmV0dXJucyAoYm9vbCkgewogICAgICAgIGJ5dGVzMzIgbGlzdGluZ0hhc2hIYXNoID0gX2xpc3RpbmdIYXNoOwogICAgICAgIHVpbnQgY2hhbGxlbmdlSUQgPSBsaXN0aW5nc1tsaXN0aW5nSGFzaEhhc2hdLmNoYWxsZW5nZUlEOwoKICAgICAgICByZXR1cm4gKGxpc3RpbmdzW2xpc3RpbmdIYXNoSGFzaF0uY2hhbGxlbmdlSUQgPiAwICYmICFjaGFsbGVuZ2VzW2NoYWxsZW5nZUlEXS5yZXNvbHZlZCk7CiAgICB9CgogICAgLyoqCiAgICBAZGV2ICAgICAgICAgICAgICAgIERldGVybWluZXMgd2hldGhlciB2b3RpbmcgaGFzIGNvbmNsdWRlZCBpbiBhIGNoYWxsZW5nZSBmb3IgYSBnaXZlbgogICAgICAgICAgICAgICAgICAgICAgICBsaXN0aW5nSGFzaC4gVGhyb3dzIGlmIG5vIGNoYWxsZW5nZSBleGlzdHMuCiAgICBAcGFyYW0gX2xpc3RpbmdIYXNoIEEgbGlzdGluZ0hhc2ggd2l0aCBhbiB1bnJlc29sdmVkIGNoYWxsZW5nZQogICAgKi8KICAgIGZ1bmN0aW9uIGNoYWxsZW5nZUNhbkJlUmVzb2x2ZWQoYnl0ZXMzMiBfbGlzdGluZ0hhc2gpIHZpZXcgcHVibGljIHJldHVybnMgKGJvb2wpIHsKICAgICAgICBieXRlczMyIGxpc3RpbmdIYXNoSGFzaCA9IF9saXN0aW5nSGFzaDsKICAgICAgICB1aW50IGNoYWxsZW5nZUlEID0gbGlzdGluZ3NbbGlzdGluZ0hhc2hIYXNoXS5jaGFsbGVuZ2VJRDsKCiAgICAgICAgcmVxdWlyZShjaGFsbGVuZ2VFeGlzdHMoX2xpc3RpbmdIYXNoKSk7CgogICAgICAgIHJldHVybiB2b3RpbmcucG9sbEVuZGVkKGNoYWxsZW5nZUlEKTsKICAgIH0KCiAgICAvKioKICAgIEBkZXYgICAgICAgICAgICAgICAgRGV0ZXJtaW5lcyB0aGUgbnVtYmVyIG9mIHRva2VucyBhd2FyZGVkIHRvIHRoZSB3aW5uaW5nIHBhcnR5IGluIGEgY2hhbGxlbmdlLgogICAgQHBhcmFtIF9jaGFsbGVuZ2VJRCBUaGUgY2hhbGxlbmdlSUQgdG8gZGV0ZXJtaW5lIGEgcmV3YXJkIGZvcgogICAgKi8KICAgIGZ1bmN0aW9uIGRldGVybWluZVJld2FyZCh1aW50IF9jaGFsbGVuZ2VJRCkgcHVibGljIHZpZXcgcmV0dXJucyAodWludCkgewogICAgICAgIHJlcXVpcmUoIWNoYWxsZW5nZXNbX2NoYWxsZW5nZUlEXS5yZXNvbHZlZCAmJiB2b3RpbmcucG9sbEVuZGVkKF9jaGFsbGVuZ2VJRCkpOwoKICAgICAgICAvLyBFZGdlIGNhc2UsIG5vYm9keSB2b3RlZCwgZ2l2ZSBhbGwgdG9rZW5zIHRvIHRoZSBjaGFsbGVuZ2VyLgogICAgICAgIGlmICh2b3RpbmcuZ2V0VG90YWxOdW1iZXJPZlRva2Vuc0Zvcldpbm5pbmdPcHRpb24oX2NoYWxsZW5nZUlEKSA9PSAwKSB7CiAgICAgICAgICAgIHJldHVybiAyICogY2hhbGxlbmdlc1tfY2hhbGxlbmdlSURdLnN0YWtlOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuICgyICogY2hhbGxlbmdlc1tfY2hhbGxlbmdlSURdLnN0YWtlKSAtIGNoYWxsZW5nZXNbX2NoYWxsZW5nZUlEXS5yZXdhcmRQb29sOwogICAgfQoKICAgIC8qKgogICAgQGRldiAgICAgICAgICAgICAgICBHZXR0ZXIgZm9yIENoYWxsZW5nZSB0b2tlbkNsYWltcyBtYXBwaW5ncwogICAgQHBhcmFtIF9jaGFsbGVuZ2VJRCBUaGUgY2hhbGxlbmdlSUQgdG8gcXVlcnkKICAgIEBwYXJhbSBfdm90ZXIgICAgICAgVGhlIHZvdGVyIHdob3NlIGNsYWltIHN0YXR1cyB0byBxdWVyeSBmb3IgdGhlIHByb3ZpZGVkIGNoYWxsZW5nZUlECiAgICAqLwogICAgZnVuY3Rpb24gdG9rZW5DbGFpbXModWludCBfY2hhbGxlbmdlSUQsIGFkZHJlc3MgX3ZvdGVyKSBwdWJsaWMgdmlldyByZXR1cm5zIChib29sKSB7CiAgICAgIHJldHVybiBjaGFsbGVuZ2VzW19jaGFsbGVuZ2VJRF0udG9rZW5DbGFpbXNbX3ZvdGVyXTsKICAgIH0KCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBQUklWQVRFIEZVTkNUSU9OUzoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0KCiAgICAvKioKICAgIEBkZXYgICAgICAgICAgICAgICAgRGV0ZXJtaW5lcyB0aGUgd2lubmVyIGluIGEgY2hhbGxlbmdlLiBSZXdhcmRzIHRoZSB3aW5uZXIgdG9rZW5zIGFuZAogICAgICAgICAgICAgICAgICAgICAgICBlaXRoZXIgd2hpdGVsaXN0cyBvciBkZS13aGl0ZWxpc3RzIHRoZSBsaXN0aW5nSGFzaC4KICAgIEBwYXJhbSBfbGlzdGluZ0hhc2ggQSBsaXN0aW5nSGFzaCB3aXRoIGEgY2hhbGxlbmdlIHRoYXQgaXMgdG8gYmUgcmVzb2x2ZWQKICAgICovCiAgICBmdW5jdGlvbiByZXNvbHZlQ2hhbGxlbmdlKGJ5dGVzMzIgX2xpc3RpbmdIYXNoKSBwcml2YXRlIHsKICAgICAgICBieXRlczMyIGxpc3RpbmdIYXNoSGFzaCA9IF9saXN0aW5nSGFzaDsKICAgICAgICB1aW50IGNoYWxsZW5nZUlEID0gbGlzdGluZ3NbbGlzdGluZ0hhc2hIYXNoXS5jaGFsbGVuZ2VJRDsKCiAgICAgICAgLy8gQ2FsY3VsYXRlcyB0aGUgd2lubmVyJ3MgcmV3YXJkLAogICAgICAgIC8vIHdoaWNoIGlzOiAod2lubmVyJ3MgZnVsbCBzdGFrZSkgKyAoZGlzcGVuc2F0aW9uUGN0ICogbG9zZXIncyBzdGFrZSkKICAgICAgICB1aW50IHJld2FyZCA9IGRldGVybWluZVJld2FyZChjaGFsbGVuZ2VJRCk7CgogICAgICAgIC8vIFJlY29yZHMgd2hldGhlciB0aGUgbGlzdGluZ0hhc2ggaXMgYSBsaXN0aW5nSGFzaCBvciBhbiBhcHBsaWNhdGlvbgogICAgICAgIGJvb2wgd2FzV2hpdGVsaXN0ZWQgPSBpc1doaXRlbGlzdGVkKF9saXN0aW5nSGFzaCk7CgogICAgICAgIC8vIENhc2U6IGNoYWxsZW5nZSBmYWlsZWQKICAgICAgICBpZiAodm90aW5nLmlzUGFzc2VkKGNoYWxsZW5nZUlEKSkgewogICAgICAgICAgICB3aGl0ZWxpc3RBcHBsaWNhdGlvbihfbGlzdGluZ0hhc2gpOwogICAgICAgICAgICAvLyBVbmxvY2sgc3Rha2Ugc28gdGhhdCBpdCBjYW4gYmUgcmV0cmlldmVkIGJ5IHRoZSBhcHBsaWNhbnQKICAgICAgICAgICAgbGlzdGluZ3NbbGlzdGluZ0hhc2hIYXNoXS51bnN0YWtlZERlcG9zaXQgKz0gcmV3YXJkOwoKICAgICAgICAgICAgX0NoYWxsZW5nZUZhaWxlZChjaGFsbGVuZ2VJRCk7CiAgICAgICAgICAgIGlmICghd2FzV2hpdGVsaXN0ZWQpIHsgX05ld0xpc3RpbmdXaGl0ZWxpc3RlZChfbGlzdGluZ0hhc2gpOyB9CiAgICAgICAgfQogICAgICAgIC8vIENhc2U6IGNoYWxsZW5nZSBzdWNjZWVkZWQKICAgICAgICBlbHNlIHsKICAgICAgICAgICAgcmVzZXRMaXN0aW5nKF9saXN0aW5nSGFzaCk7CiAgICAgICAgICAgIC8vIFRyYW5zZmVyIHRoZSByZXdhcmQgdG8gdGhlIGNoYWxsZW5nZXIKICAgICAgICAgICAgcmVxdWlyZSh0b2tlbi50cmFuc2ZlcihjaGFsbGVuZ2VzW2NoYWxsZW5nZUlEXS5jaGFsbGVuZ2VyLCByZXdhcmQpKTsKCiAgICAgICAgICAgIF9DaGFsbGVuZ2VTdWNjZWVkZWQoY2hhbGxlbmdlSUQpOwogICAgICAgICAgICBpZiAod2FzV2hpdGVsaXN0ZWQpIHsgX0xpc3RpbmdSZW1vdmVkKF9saXN0aW5nSGFzaCk7IH0KICAgICAgICAgICAgZWxzZSB7IF9BcHBsaWNhdGlvblJlbW92ZWQoX2xpc3RpbmdIYXNoKTsgfQogICAgICAgIH0KCiAgICAgICAgLy8gU2V0cyBmbGFnIG9uIGNoYWxsZW5nZSBiZWluZyBwcm9jZXNzZWQKICAgICAgICBjaGFsbGVuZ2VzW2NoYWxsZW5nZUlEXS5yZXNvbHZlZCA9IHRydWU7CgogICAgICAgIC8vIFN0b3JlcyB0aGUgdG90YWwgdG9rZW5zIHVzZWQgZm9yIHZvdGluZyBieSB0aGUgd2lubmluZyBzaWRlIGZvciByZXdhcmQgcHVycG9zZXMKICAgICAgICBjaGFsbGVuZ2VzW2NoYWxsZW5nZUlEXS50b3RhbFRva2VucyA9CiAgICAgICAgICAgIHZvdGluZy5nZXRUb3RhbE51bWJlck9mVG9rZW5zRm9yV2lubmluZ09wdGlvbihjaGFsbGVuZ2VJRCk7CiAgICB9CgogICAgLyoqCiAgICBAZGV2ICAgICAgICAgICAgICAgIENhbGxlZCBieSB1cGRhdGVTdGF0dXMoKSBpZiB0aGUgYXBwbGljYXRpb25FeHBpcnkgZGF0ZSBwYXNzZWQgd2l0aG91dCBhCiAgICAgICAgICAgICAgICAgICAgICAgIGNoYWxsZW5nZSBiZWluZyBtYWRlLiBDYWxsZWQgYnkgcmVzb2x2ZUNoYWxsZW5nZSgpIGlmIGFuCiAgICAgICAgICAgICAgICAgICAgICAgIGFwcGxpY2F0aW9uL2xpc3RpbmcgYmVhdCBhIGNoYWxsZW5nZS4KICAgIEBwYXJhbSBfbGlzdGluZ0hhc2ggVGhlIGxpc3RpbmdIYXNoIG9mIGFuIGFwcGxpY2F0aW9uL2xpc3RpbmdIYXNoIHRvIGJlIHdoaXRlbGlzdGVkCiAgICAqLwogICAgZnVuY3Rpb24gd2hpdGVsaXN0QXBwbGljYXRpb24oYnl0ZXMzMiBfbGlzdGluZ0hhc2gpIHByaXZhdGUgewogICAgICAgIGxpc3RpbmdzW19saXN0aW5nSGFzaF0ud2hpdGVsaXN0ZWQgPSB0cnVlOwogICAgfQoKICAgIC8qKgogICAgQGRldiAgICAgICAgICAgICAgICBEZWxldGVzIGEgbGlzdGluZ0hhc2ggZnJvbSB0aGUgd2hpdGVsaXN0IGFuZCB0cmFuc2ZlcnMgdG9rZW5zIGJhY2sgdG8gb3duZXIKICAgIEBwYXJhbSBfbGlzdGluZ0hhc2ggVGhlIGxpc3RpbmcgaGFzaCB0byBkZWxldGUKICAgICovCiAgICBmdW5jdGlvbiByZXNldExpc3RpbmcoYnl0ZXMzMiBfbGlzdGluZ0hhc2gpIHByaXZhdGUgewogICAgICAgIGJ5dGVzMzIgbGlzdGluZ0hhc2hIYXNoID0gX2xpc3RpbmdIYXNoOwogICAgICAgIExpc3Rpbmcgc3RvcmFnZSBsaXN0aW5nSGFzaCA9IGxpc3RpbmdzW2xpc3RpbmdIYXNoSGFzaF07CgogICAgICAgIC8vIFRyYW5zZmVycyBhbnkgcmVtYWluaW5nIGJhbGFuY2UgYmFjayB0byB0aGUgb3duZXIKICAgICAgICBpZiAobGlzdGluZ0hhc2gudW5zdGFrZWREZXBvc2l0ID4gMCkKICAgICAgICAgICAgcmVxdWlyZSh0b2tlbi50cmFuc2ZlcihsaXN0aW5nSGFzaC5vd25lciwgbGlzdGluZ0hhc2gudW5zdGFrZWREZXBvc2l0KSk7CgogICAgICAgIGRlbGV0ZSBsaXN0aW5nc1tsaXN0aW5nSGFzaEhhc2hdOwogICAgfQp9'.
	

]
