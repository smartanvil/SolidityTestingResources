Class {
	#name : #SRTc9a37f947422f03162a6a8f3e9583613513324b3,
	#superclass : #SRTContracts,
	#category : #SolidityTestingResources
}

{ #category : #base64 }
SRTc9a37f947422f03162a6a8f3e9583613513324b3 >> base64 [
	^ 'cHJhZ21hIHNvbGlkaXR5IF4wLjQuMTM7CgovKioKICogQHRpdGxlIFNhZmVNYXRoCiAqIEBkZXYgTWF0aCBvcGVyYXRpb25zIHdpdGggc2FmZXR5IGNoZWNrcyB0aGF0IHRocm93IG9uIGVycm9yCiAqLwpsaWJyYXJ5IFNhZmVNYXRoIHsKICBmdW5jdGlvbiBtdWwodWludDI1NiBhLCB1aW50MjU2IGIpIGludGVybmFsIGNvbnN0YW50IHJldHVybnMgKHVpbnQyNTYpIHsKICAgIHVpbnQyNTYgYyA9IGEgKiBiOwogICAgYXNzZXJ0KGEgPT0gMCB8fCBjIC8gYSA9PSBiKTsKICAgIHJldHVybiBjOwogIH0KCiAgZnVuY3Rpb24gZGl2KHVpbnQyNTYgYSwgdWludDI1NiBiKSBpbnRlcm5hbCBjb25zdGFudCByZXR1cm5zICh1aW50MjU2KSB7CiAgICAvLyBhc3NlcnQoYiA+IDApOyAvLyBTb2xpZGl0eSBhdXRvbWF0aWNhbGx5IHRocm93cyB3aGVuIGRpdmlkaW5nIGJ5IDAKICAgIHVpbnQyNTYgYyA9IGEgLyBiOwogICAgLy8gYXNzZXJ0KGEgPT0gYiAqIGMgKyBhICUgYik7IC8vIFRoZXJlIGlzIG5vIGNhc2UgaW4gd2hpY2ggdGhpcyBkb2Vzbid0IGhvbGQKICAgIHJldHVybiBjOwogIH0KCiAgZnVuY3Rpb24gc3ViKHVpbnQyNTYgYSwgdWludDI1NiBiKSBpbnRlcm5hbCBjb25zdGFudCByZXR1cm5zICh1aW50MjU2KSB7CiAgICBhc3NlcnQoYiA8PSBhKTsKICAgIHJldHVybiBhIC0gYjsKICB9CgogIGZ1bmN0aW9uIGFkZCh1aW50MjU2IGEsIHVpbnQyNTYgYikgaW50ZXJuYWwgY29uc3RhbnQgcmV0dXJucyAodWludDI1NikgewogICAgdWludDI1NiBjID0gYSArIGI7CiAgICBhc3NlcnQoYyA+PSBhKTsKICAgIHJldHVybiBjOwogIH0KfQoKLyoqCiAqIEB0aXRsZSBPd25hYmxlCiAqIEBkZXYgVGhlIE93bmFibGUgY29udHJhY3QgaGFzIGFuIG93bmVyIGFkZHJlc3MsIGFuZCBwcm92aWRlcyBiYXNpYyBhdXRob3JpemF0aW9uIGNvbnRyb2wKICogZnVuY3Rpb25zLCB0aGlzIHNpbXBsaWZpZXMgdGhlIGltcGxlbWVudGF0aW9uIG9mICJ1c2VyIHBlcm1pc3Npb25zIi4KICovCmNvbnRyYWN0IE93bmFibGUgewogIGFkZHJlc3MgcHVibGljIG93bmVyOwoKCiAgZXZlbnQgT3duZXJzaGlwVHJhbnNmZXJyZWQoYWRkcmVzcyBpbmRleGVkIHByZXZpb3VzT3duZXIsIGFkZHJlc3MgaW5kZXhlZCBuZXdPd25lcik7CgoKICAvKioKICAgKiBAZGV2IFRoZSBPd25hYmxlIGNvbnN0cnVjdG9yIHNldHMgdGhlIG9yaWdpbmFsIGBvd25lcmAgb2YgdGhlIGNvbnRyYWN0IHRvIHRoZSBzZW5kZXIKICAgKiBhY2NvdW50LgogICAqLwogIGZ1bmN0aW9uIE93bmFibGUoKSB7CiAgICBvd25lciA9IG1zZy5zZW5kZXI7CiAgfQoKCiAgLyoqCiAgICogQGRldiBUaHJvd3MgaWYgY2FsbGVkIGJ5IGFueSBhY2NvdW50IG90aGVyIHRoYW4gdGhlIG93bmVyLgogICAqLwogIG1vZGlmaWVyIG9ubHlPd25lcigpIHsKICAgIHJlcXVpcmUobXNnLnNlbmRlciA9PSBvd25lcik7CiAgICBfOwogIH0KCgogIC8qKgogICAqIEBkZXYgQWxsb3dzIHRoZSBjdXJyZW50IG93bmVyIHRvIHRyYW5zZmVyIGNvbnRyb2wgb2YgdGhlIGNvbnRyYWN0IHRvIGEgbmV3T3duZXIuCiAgICogQHBhcmFtIG5ld093bmVyIFRoZSBhZGRyZXNzIHRvIHRyYW5zZmVyIG93bmVyc2hpcCB0by4KICAgKi8KICBmdW5jdGlvbiB0cmFuc2Zlck93bmVyc2hpcChhZGRyZXNzIG5ld093bmVyKSBvbmx5T3duZXIgcHVibGljIHsKICAgIHJlcXVpcmUobmV3T3duZXIgIT0gYWRkcmVzcygwKSk7CiAgICBPd25lcnNoaXBUcmFuc2ZlcnJlZChvd25lciwgbmV3T3duZXIpOwogICAgb3duZXIgPSBuZXdPd25lcjsKICB9Cgp9Cgpjb250cmFjdCBBYnN0cmFjdFN0YXJiYXNlVG9rZW4gewogICAgZnVuY3Rpb24gaXNGdW5kcmFpc2VyKGFkZHJlc3MgZnVuZHJhaXNlckFkZHJlc3MpIHB1YmxpYyByZXR1cm5zIChib29sKTsKICAgIGZ1bmN0aW9uIGNvbXBhbnkoKSBwdWJsaWMgcmV0dXJucyAoYWRkcmVzcyk7CiAgICBmdW5jdGlvbiBhbGxvY2F0ZVRvQ3Jvd2RzYWxlUHVyY2hhc2VyKGFkZHJlc3MgdG8sIHVpbnQyNTYgdmFsdWUpIHB1YmxpYyByZXR1cm5zIChib29sKTsKICAgIGZ1bmN0aW9uIGFsbG9jYXRlVG9NYXJrZXRpbmdTdXBwb3J0ZXIoYWRkcmVzcyB0bywgdWludDI1NiB2YWx1ZSkgcHVibGljIHJldHVybnMgKGJvb2wpOwp9Cgpjb250cmFjdCBBYnN0cmFjdFN0YXJiYXNlQ3Jvd2RzYWxlIHsKICAgIGZ1bmN0aW9uIHN0YXJ0RGF0ZSgpIGNvbnN0YW50IHJldHVybnMgKHVpbnQyNTYpIHt9CiAgICBmdW5jdGlvbiBlbmRlZEF0KCkgY29uc3RhbnQgcmV0dXJucyAodWludDI1Nikge30KICAgIGZ1bmN0aW9uIGlzRW5kZWQoKSBjb25zdGFudCByZXR1cm5zIChib29sKTsKICAgIGZ1bmN0aW9uIHRvdGFsUmFpc2VkQW1vdW50SW5DbnkoKSBjb25zdGFudCByZXR1cm5zICh1aW50MjU2KTsKICAgIGZ1bmN0aW9uIG51bU9mUHVyY2hhc2VkVG9rZW5zT25Dc0J5KGFkZHJlc3MgcHVyY2hhc2VyKSBjb25zdGFudCByZXR1cm5zICh1aW50MjU2KTsKICAgIGZ1bmN0aW9uIG51bU9mUHVyY2hhc2VkVG9rZW5zT25FcEJ5KGFkZHJlc3MgcHVyY2hhc2VyKSBjb25zdGFudCByZXR1cm5zICh1aW50MjU2KTsKfQoKY29udHJhY3QgU3RhcmJhc2VFYXJseVB1cmNoYXNlIHsKICAgIC8qCiAgICAgKiAgQ29uc3RhbnRzCiAgICAgKi8KICAgIHN0cmluZyBwdWJsaWMgY29uc3RhbnQgUFVSQ0hBU0VfQU1PVU5UX1VOSVQgPSAnQ05ZJzsgICAgLy8gQ2hpbmVzZSBZdWFuCiAgICBzdHJpbmcgcHVibGljIGNvbnN0YW50IFBVUkNIQVNFX0FNT1VOVF9SQVRFX1JFRkVSRU5DRSA9ICdodHRwOi8vd3d3LnhlLmNvbS9jdXJyZW5jeXRhYmxlcy8nOwogICAgdWludCBwdWJsaWMgY29uc3RhbnQgUFVSQ0hBU0VfQU1PVU5UX0NBUCA9IDkwMDAwMDA7CgogICAgLyoKICAgICAqICBUeXBlcwogICAgICovCiAgICBzdHJ1Y3QgRWFybHlQdXJjaGFzZSB7CiAgICAgICAgYWRkcmVzcyBwdXJjaGFzZXI7CiAgICAgICAgdWludCBhbW91bnQ7ICAgICAgICAvLyBDTlkgYmFzZWQgYW1vdW50CiAgICAgICAgdWludCBwdXJjaGFzZWRBdDsgICAvLyB0aW1lc3RhbXAKICAgIH0KCiAgICAvKgogICAgICogIEV4dGVybmFsIGNvbnRyYWN0cwogICAgICovCiAgICBBYnN0cmFjdFN0YXJiYXNlQ3Jvd2RzYWxlIHB1YmxpYyBzdGFyYmFzZUNyb3dkc2FsZTsKCiAgICAvKgogICAgICogIFN0b3JhZ2UKICAgICAqLwogICAgYWRkcmVzcyBwdWJsaWMgb3duZXI7CiAgICBFYXJseVB1cmNoYXNlW10gcHVibGljIGVhcmx5UHVyY2hhc2VzOwogICAgdWludCBwdWJsaWMgZWFybHlQdXJjaGFzZUNsb3NlZEF0OwoKICAgIC8qCiAgICAgKiAgTW9kaWZpZXJzCiAgICAgKi8KICAgIG1vZGlmaWVyIG5vRXRoZXIoKSB7CiAgICAgICAgaWYgKG1zZy52YWx1ZSA+IDApIHsKICAgICAgICAgICAgdGhyb3c7CiAgICAgICAgfQogICAgICAgIF87CiAgICB9CgogICAgbW9kaWZpZXIgb25seU93bmVyKCkgewogICAgICAgIGlmIChtc2cuc2VuZGVyICE9IG93bmVyKSB7CiAgICAgICAgICAgIHRocm93OwogICAgICAgIH0KICAgICAgICBfOwogICAgfQoKICAgIG1vZGlmaWVyIG9ubHlCZWZvcmVDcm93ZHNhbGUoKSB7CiAgICAgICAgaWYgKGFkZHJlc3Moc3RhcmJhc2VDcm93ZHNhbGUpICE9IDAgJiYKICAgICAgICAgICAgc3RhcmJhc2VDcm93ZHNhbGUuc3RhcnREYXRlKCkgPiAwKQogICAgICAgIHsKICAgICAgICAgICAgdGhyb3c7CiAgICAgICAgfQogICAgICAgIF87CiAgICB9CgogICAgbW9kaWZpZXIgb25seUVhcmx5UHVyY2hhc2VUZXJtKCkgewogICAgICAgIGlmIChlYXJseVB1cmNoYXNlQ2xvc2VkQXQgPiAwKSB7CiAgICAgICAgICAgIHRocm93OwogICAgICAgIH0KICAgICAgICBfOwogICAgfQoKICAgIC8qCiAgICAgKiAgQ29udHJhY3QgZnVuY3Rpb25zCiAgICAgKi8KICAgIC8vLyBAZGV2IFJldHVybnMgZWFybHkgcHVyY2hhc2VkIGFtb3VudCBieSBwdXJjaGFzZXIncyBhZGRyZXNzCiAgICAvLy8gQHBhcmFtIHB1cmNoYXNlciBQdXJjaGFzZXIgYWRkcmVzcwogICAgZnVuY3Rpb24gcHVyY2hhc2VkQW1vdW50QnkoYWRkcmVzcyBwdXJjaGFzZXIpCiAgICAgICAgZXh0ZXJuYWwKICAgICAgICBjb25zdGFudAogICAgICAgIG5vRXRoZXIKICAgICAgICByZXR1cm5zICh1aW50IGFtb3VudCkKICAgIHsKICAgICAgICBmb3IgKHVpbnQgaTsgaSA8IGVhcmx5UHVyY2hhc2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGlmIChlYXJseVB1cmNoYXNlc1tpXS5wdXJjaGFzZXIgPT0gcHVyY2hhc2VyKSB7CiAgICAgICAgICAgICAgICBhbW91bnQgKz0gZWFybHlQdXJjaGFzZXNbaV0uYW1vdW50OwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIC8vLyBAZGV2IFJldHVybnMgdG90YWwgYW1vdW50IG9mIHJhaXNlZCBmdW5kcyBieSBFYXJseSBQdXJjaGFzZXJzCiAgICBmdW5jdGlvbiB0b3RhbEFtb3VudE9mRWFybHlQdXJjaGFzZXMoKQogICAgICAgIGNvbnN0YW50CiAgICAgICAgbm9FdGhlcgogICAgICAgIHJldHVybnMgKHVpbnQgdG90YWxBbW91bnQpCiAgICB7CiAgICAgICAgZm9yICh1aW50IGk7IGkgPCBlYXJseVB1cmNoYXNlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB0b3RhbEFtb3VudCArPSBlYXJseVB1cmNoYXNlc1tpXS5hbW91bnQ7CiAgICAgICAgfQogICAgfQoKICAgIC8vLyBAZGV2IFJldHVybnMgbnVtYmVyIG9mIGVhcmx5IHB1cmNoYXNlcwogICAgZnVuY3Rpb24gbnVtYmVyT2ZFYXJseVB1cmNoYXNlcygpCiAgICAgICAgZXh0ZXJuYWwKICAgICAgICBjb25zdGFudAogICAgICAgIG5vRXRoZXIKICAgICAgICByZXR1cm5zICh1aW50KQogICAgewogICAgICAgIHJldHVybiBlYXJseVB1cmNoYXNlcy5sZW5ndGg7CiAgICB9CgogICAgLy8vIEBkZXYgQXBwZW5kIGFuIGVhcmx5IHB1cmNoYXNlIGxvZwogICAgLy8vIEBwYXJhbSBwdXJjaGFzZXIgUHVyY2hhc2VyIGFkZHJlc3MKICAgIC8vLyBAcGFyYW0gYW1vdW50IFB1cmNoYXNlIGFtb3VudAogICAgLy8vIEBwYXJhbSBwdXJjaGFzZWRBdCBUaW1lc3RhbXAgb2YgcHVyY2hhc2VkIGRhdGUKICAgIGZ1bmN0aW9uIGFwcGVuZEVhcmx5UHVyY2hhc2UoYWRkcmVzcyBwdXJjaGFzZXIsIHVpbnQgYW1vdW50LCB1aW50IHB1cmNoYXNlZEF0KQogICAgICAgIGV4dGVybmFsCiAgICAgICAgbm9FdGhlcgogICAgICAgIG9ubHlPd25lcgogICAgICAgIG9ubHlCZWZvcmVDcm93ZHNhbGUKICAgICAgICBvbmx5RWFybHlQdXJjaGFzZVRlcm0KICAgICAgICByZXR1cm5zIChib29sKQogICAgewogICAgICAgIGlmIChhbW91bnQgPT0gMCB8fAogICAgICAgICAgICB0b3RhbEFtb3VudE9mRWFybHlQdXJjaGFzZXMoKSArIGFtb3VudCA+IFBVUkNIQVNFX0FNT1VOVF9DQVApCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICBpZiAocHVyY2hhc2VkQXQgPT0gMCB8fCBwdXJjaGFzZWRBdCA+IG5vdykgewogICAgICAgICAgICB0aHJvdzsKICAgICAgICB9CgogICAgICAgIGVhcmx5UHVyY2hhc2VzLnB1c2goRWFybHlQdXJjaGFzZShwdXJjaGFzZXIsIGFtb3VudCwgcHVyY2hhc2VkQXQpKTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICAvLy8gQGRldiBDbG9zZSBlYXJseSBwdXJjaGFzZSB0ZXJtCiAgICBmdW5jdGlvbiBjbG9zZUVhcmx5UHVyY2hhc2UoKQogICAgICAgIGV4dGVybmFsCiAgICAgICAgbm9FdGhlcgogICAgICAgIG9ubHlPd25lcgogICAgICAgIHJldHVybnMgKGJvb2wpCiAgICB7CiAgICAgICAgZWFybHlQdXJjaGFzZUNsb3NlZEF0ID0gbm93OwogICAgfQoKICAgIC8vLyBAZGV2IFNldHVwIGZ1bmN0aW9uIHNldHMgZXh0ZXJuYWwgY29udHJhY3QncyBhZGRyZXNzCiAgICAvLy8gQHBhcmFtIHN0YXJiYXNlQ3Jvd2RzYWxlQWRkcmVzcyBUb2tlbiBhZGRyZXNzCiAgICBmdW5jdGlvbiBzZXR1cChhZGRyZXNzIHN0YXJiYXNlQ3Jvd2RzYWxlQWRkcmVzcykKICAgICAgICBleHRlcm5hbAogICAgICAgIG5vRXRoZXIKICAgICAgICBvbmx5T3duZXIKICAgICAgICByZXR1cm5zIChib29sKQogICAgewogICAgICAgIGlmIChhZGRyZXNzKHN0YXJiYXNlQ3Jvd2RzYWxlKSA9PSAwKSB7CiAgICAgICAgICAgIHN0YXJiYXNlQ3Jvd2RzYWxlID0gQWJzdHJhY3RTdGFyYmFzZUNyb3dkc2FsZShzdGFyYmFzZUNyb3dkc2FsZUFkZHJlc3MpOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIC8vLyBAZGV2IENvbnRyYWN0IGNvbnN0cnVjdG9yIGZ1bmN0aW9uCiAgICBmdW5jdGlvbiBTdGFyYmFzZUVhcmx5UHVyY2hhc2UoKSBub0V0aGVyIHsKICAgICAgICBvd25lciA9IG1zZy5zZW5kZXI7CiAgICB9CgogICAgLy8vIEBkZXYgRmFsbGJhY2sgZnVuY3Rpb24gYWx3YXlzIGZhaWxzCiAgICBmdW5jdGlvbiAoKSB7CiAgICAgICAgdGhyb3c7CiAgICB9Cn0KCgpjb250cmFjdCBTdGFyYmFzZUVhcmx5UHVyY2hhc2VBbWVuZG1lbnQgewogICAgLyoKICAgICAqICBFdmVudHMKICAgICAqLwogICAgZXZlbnQgRWFybHlQdXJjaGFzZUludmFsaWRhdGVkKHVpbnQgZXBJZHgpOwogICAgZXZlbnQgRWFybHlQdXJjaGFzZUFtZW5kZWQodWludCBlcElkeCk7CgogICAgLyoKICAgICAqICBFeHRlcm5hbCBjb250cmFjdHMKICAgICAqLwogICAgQWJzdHJhY3RTdGFyYmFzZUNyb3dkc2FsZSBwdWJsaWMgc3RhcmJhc2VDcm93ZHNhbGU7CiAgICBTdGFyYmFzZUVhcmx5UHVyY2hhc2UgcHVibGljIHN0YXJiYXNlRWFybHlQdXJjaGFzZTsKCiAgICAvKgogICAgICogIFN0b3JhZ2UKICAgICAqLwogICAgYWRkcmVzcyBwdWJsaWMgb3duZXI7CiAgICB1aW50W10gcHVibGljIGludmFsaWRFYXJseVB1cmNoYXNlSW5kZXhlczsKICAgIHVpbnRbXSBwdWJsaWMgYW1lbmRlZEVhcmx5UHVyY2hhc2VJbmRleGVzOwogICAgbWFwcGluZyAodWludCA9PiBTdGFyYmFzZUVhcmx5UHVyY2hhc2UuRWFybHlQdXJjaGFzZSkgcHVibGljIGFtZW5kZWRFYXJseVB1cmNoYXNlczsKCiAgICAvKgogICAgICogIE1vZGlmaWVycwogICAgICovCiAgICBtb2RpZmllciBub0V0aGVyKCkgewogICAgICAgIGlmIChtc2cudmFsdWUgPiAwKSB7CiAgICAgICAgICAgIHRocm93OwogICAgICAgIH0KICAgICAgICBfOwogICAgfQoKICAgIG1vZGlmaWVyIG9ubHlPd25lcigpIHsKICAgICAgICBpZiAobXNnLnNlbmRlciAhPSBvd25lcikgewogICAgICAgICAgICB0aHJvdzsKICAgICAgICB9CiAgICAgICAgXzsKICAgIH0KCiAgICBtb2RpZmllciBvbmx5QmVmb3JlQ3Jvd2RzYWxlKCkgewogICAgICAgIGlmIChhZGRyZXNzKHN0YXJiYXNlQ3Jvd2RzYWxlKSAhPSAwICYmCiAgICAgICAgICAgIHN0YXJiYXNlQ3Jvd2RzYWxlLnN0YXJ0RGF0ZSgpID4gMCkKICAgICAgICB7CiAgICAgICAgICAgIHRocm93OwogICAgICAgIH0KICAgICAgICBfOwogICAgfQoKICAgIG1vZGlmaWVyIG9ubHlFYXJseVB1cmNoYXNlc0xvYWRlZCgpIHsKICAgICAgICBpZiAoYWRkcmVzcyhzdGFyYmFzZUVhcmx5UHVyY2hhc2UpID09IDApIHsKICAgICAgICAgICAgdGhyb3c7CiAgICAgICAgfQogICAgICAgIF87CiAgICB9CgogICAgLyoKICAgICAqICBDb250cmFjdCBmdW5jdGlvbnMgYXJlIGNvbXBhdGlibGUgd2l0aCBvcmlnaW5hbCBvbmVzCiAgICAgKi8KICAgIC8vLyBAZGV2IFJldHVybnMgYW4gZWFybHkgcHVyY2hhc2UgcmVjb3JkCiAgICAvLy8gQHBhcmFtIGVhcmx5UHVyY2hhc2VJbmRleCBJbmRleCBudW1iZXIgb2YgYW4gZWFybHkgcHVyY2hhc2UKICAgIGZ1bmN0aW9uIGVhcmx5UHVyY2hhc2VzKHVpbnQgZWFybHlQdXJjaGFzZUluZGV4KQogICAgICAgIGV4dGVybmFsCiAgICAgICAgY29uc3RhbnQKICAgICAgICBvbmx5RWFybHlQdXJjaGFzZXNMb2FkZWQKICAgICAgICByZXR1cm5zIChhZGRyZXNzIHB1cmNoYXNlciwgdWludCBhbW91bnQsIHVpbnQgcHVyY2hhc2VkQXQpCiAgICB7CiAgICAgICAgcmV0dXJuIHN0YXJiYXNlRWFybHlQdXJjaGFzZS5lYXJseVB1cmNoYXNlcyhlYXJseVB1cmNoYXNlSW5kZXgpOwogICAgfQoKICAgIC8vLyBAZGV2IFJldHVybnMgZWFybHkgcHVyY2hhc2VkIGFtb3VudCBieSBwdXJjaGFzZXIncyBhZGRyZXNzCiAgICAvLy8gQHBhcmFtIHB1cmNoYXNlciBQdXJjaGFzZXIgYWRkcmVzcwogICAgZnVuY3Rpb24gcHVyY2hhc2VkQW1vdW50QnkoYWRkcmVzcyBwdXJjaGFzZXIpCiAgICAgICAgZXh0ZXJuYWwKICAgICAgICBjb25zdGFudAogICAgICAgIG5vRXRoZXIKICAgICAgICByZXR1cm5zICh1aW50IGFtb3VudCkKICAgIHsKICAgICAgICBTdGFyYmFzZUVhcmx5UHVyY2hhc2UuRWFybHlQdXJjaGFzZVtdIG1lbW9yeSBub3JtYWxpemVkRVAgPQogICAgICAgICAgICBub3JtYWxpemVkRWFybHlQdXJjaGFzZXMoKTsKICAgICAgICBmb3IgKHVpbnQgaTsgaSA8IG5vcm1hbGl6ZWRFUC5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBpZiAobm9ybWFsaXplZEVQW2ldLnB1cmNoYXNlciA9PSBwdXJjaGFzZXIpIHsKICAgICAgICAgICAgICAgIGFtb3VudCArPSBub3JtYWxpemVkRVBbaV0uYW1vdW50OwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIC8vLyBAZGV2IFJldHVybnMgdG90YWwgYW1vdW50IG9mIHJhaXNlZCBmdW5kcyBieSBFYXJseSBQdXJjaGFzZXJzCiAgICBmdW5jdGlvbiB0b3RhbEFtb3VudE9mRWFybHlQdXJjaGFzZXMoKQogICAgICAgIGNvbnN0YW50CiAgICAgICAgbm9FdGhlcgogICAgICAgIHJldHVybnMgKHVpbnQgdG90YWxBbW91bnQpCiAgICB7CiAgICAgICAgU3RhcmJhc2VFYXJseVB1cmNoYXNlLkVhcmx5UHVyY2hhc2VbXSBtZW1vcnkgbm9ybWFsaXplZEVQID0KICAgICAgICAgICAgbm9ybWFsaXplZEVhcmx5UHVyY2hhc2VzKCk7CiAgICAgICAgZm9yICh1aW50IGk7IGkgPCBub3JtYWxpemVkRVAubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdG90YWxBbW91bnQgKz0gbm9ybWFsaXplZEVQW2ldLmFtb3VudDsKICAgICAgICB9CiAgICB9CgogICAgLy8vIEBkZXYgUmV0dXJucyBudW1iZXIgb2YgZWFybHkgcHVyY2hhc2VzCiAgICBmdW5jdGlvbiBudW1iZXJPZkVhcmx5UHVyY2hhc2VzKCkKICAgICAgICBleHRlcm5hbAogICAgICAgIGNvbnN0YW50CiAgICAgICAgbm9FdGhlcgogICAgICAgIHJldHVybnMgKHVpbnQpCiAgICB7CiAgICAgICAgcmV0dXJuIG5vcm1hbGl6ZWRFYXJseVB1cmNoYXNlcygpLmxlbmd0aDsKICAgIH0KCiAgICAvLy8gQGRldiBTZXR1cCBmdW5jdGlvbiBzZXRzIGV4dGVybmFsIGNvbnRyYWN0J3MgYWRkcmVzcwogICAgLy8vIEBwYXJhbSBzdGFyYmFzZUNyb3dkc2FsZUFkZHJlc3MgVG9rZW4gYWRkcmVzcwogICAgZnVuY3Rpb24gc2V0dXAoYWRkcmVzcyBzdGFyYmFzZUNyb3dkc2FsZUFkZHJlc3MpCiAgICAgICAgZXh0ZXJuYWwKICAgICAgICBub0V0aGVyCiAgICAgICAgb25seU93bmVyCiAgICAgICAgcmV0dXJucyAoYm9vbCkKICAgIHsKICAgICAgICBpZiAoYWRkcmVzcyhzdGFyYmFzZUNyb3dkc2FsZSkgPT0gMCkgewogICAgICAgICAgICBzdGFyYmFzZUNyb3dkc2FsZSA9IEFic3RyYWN0U3RhcmJhc2VDcm93ZHNhbGUoc3RhcmJhc2VDcm93ZHNhbGVBZGRyZXNzKTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICAvKgogICAgICogIENvbnRyYWN0IGZ1bmN0aW9ucwogICAgICovCiAgICBmdW5jdGlvbiBpbnZhbGlkYXRlRWFybHlQdXJjaGFzZSh1aW50IGVhcmx5UHVyY2hhc2VJbmRleCkKICAgICAgICBleHRlcm5hbAogICAgICAgIG5vRXRoZXIKICAgICAgICBvbmx5T3duZXIKICAgICAgICBvbmx5RWFybHlQdXJjaGFzZXNMb2FkZWQKICAgICAgICBvbmx5QmVmb3JlQ3Jvd2RzYWxlCiAgICAgICAgcmV0dXJucyAoYm9vbCkKICAgIHsKICAgICAgICBpZiAobnVtYmVyT2ZSYXdFYXJseVB1cmNoYXNlcygpIDw9IGVhcmx5UHVyY2hhc2VJbmRleCkgewogICAgICAgICAgICB0aHJvdzsgIC8vIEFycmF5IEluZGV4IE91dCBvZiBCb3VuZHMgRXhjZXB0aW9uCiAgICAgICAgfQoKICAgICAgICBmb3IgKHVpbnQgaTsgaSA8IGludmFsaWRFYXJseVB1cmNoYXNlSW5kZXhlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBpZiAoaW52YWxpZEVhcmx5UHVyY2hhc2VJbmRleGVzW2ldID09IGVhcmx5UHVyY2hhc2VJbmRleCkgewogICAgICAgICAgICAgICAgdGhyb3c7ICAvLyBkaXNhbGxvdyBkdXBsaWNhdGVkIGludmFsaWRhdGlvbgogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpbnZhbGlkRWFybHlQdXJjaGFzZUluZGV4ZXMucHVzaChlYXJseVB1cmNoYXNlSW5kZXgpOwogICAgICAgIEVhcmx5UHVyY2hhc2VJbnZhbGlkYXRlZChlYXJseVB1cmNoYXNlSW5kZXgpOwogICAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIGZ1bmN0aW9uIGlzSW52YWxpZEVhcmx5UHVyY2hhc2UodWludCBlYXJseVB1cmNoYXNlSW5kZXgpCiAgICAgICAgY29uc3RhbnQKICAgICAgICBub0V0aGVyCiAgICAgICAgcmV0dXJucyAoYm9vbCkKICAgIHsKICAgICAgICBpZiAobnVtYmVyT2ZSYXdFYXJseVB1cmNoYXNlcygpIDw9IGVhcmx5UHVyY2hhc2VJbmRleCkgewogICAgICAgICAgICB0aHJvdzsgIC8vIEFycmF5IEluZGV4IE91dCBvZiBCb3VuZHMgRXhjZXB0aW9uCiAgICAgICAgfQoKICAgICAgICBmb3IgKHVpbnQgaTsgaSA8IGludmFsaWRFYXJseVB1cmNoYXNlSW5kZXhlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBpZiAoaW52YWxpZEVhcmx5UHVyY2hhc2VJbmRleGVzW2ldID09IGVhcmx5UHVyY2hhc2VJbmRleCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIGZ1bmN0aW9uIGFtZW5kRWFybHlQdXJjaGFzZSh1aW50IGVhcmx5UHVyY2hhc2VJbmRleCwgYWRkcmVzcyBwdXJjaGFzZXIsIHVpbnQgYW1vdW50LCB1aW50IHB1cmNoYXNlZEF0KQogICAgICAgIGV4dGVybmFsCiAgICAgICAgbm9FdGhlcgogICAgICAgIG9ubHlPd25lcgogICAgICAgIG9ubHlFYXJseVB1cmNoYXNlc0xvYWRlZAogICAgICAgIG9ubHlCZWZvcmVDcm93ZHNhbGUKICAgICAgICByZXR1cm5zIChib29sKQogICAgewogICAgICAgIGlmIChwdXJjaGFzZWRBdCA9PSAwIHx8IHB1cmNoYXNlZEF0ID4gbm93KSB7CiAgICAgICAgICAgIHRocm93OwogICAgICAgIH0KCiAgICAgICAgaWYgKG51bWJlck9mUmF3RWFybHlQdXJjaGFzZXMoKSA8PSBlYXJseVB1cmNoYXNlSW5kZXgpIHsKICAgICAgICAgICAgdGhyb3c7ICAvLyBBcnJheSBJbmRleCBPdXQgb2YgQm91bmRzIEV4Y2VwdGlvbgogICAgICAgIH0KCiAgICAgICAgaWYgKGlzSW52YWxpZEVhcmx5UHVyY2hhc2UoZWFybHlQdXJjaGFzZUluZGV4KSkgewogICAgICAgICAgICB0aHJvdzsgIC8vIEludmFsaWQgZWFybHkgcHVyY2hhc2UgY2Fubm90IGJlIGFtZW5kZWQKICAgICAgICB9CgogICAgICAgIGlmICghaXNBbWVuZGVkRWFybHlQdXJjaGFzZShlYXJseVB1cmNoYXNlSW5kZXgpKSB7CiAgICAgICAgICAgIGFtZW5kZWRFYXJseVB1cmNoYXNlSW5kZXhlcy5wdXNoKGVhcmx5UHVyY2hhc2VJbmRleCk7CiAgICAgICAgfQoKICAgICAgICBhbWVuZGVkRWFybHlQdXJjaGFzZXNbZWFybHlQdXJjaGFzZUluZGV4XSA9CiAgICAgICAgICAgIFN0YXJiYXNlRWFybHlQdXJjaGFzZS5FYXJseVB1cmNoYXNlKHB1cmNoYXNlciwgYW1vdW50LCBwdXJjaGFzZWRBdCk7CiAgICAgICAgRWFybHlQdXJjaGFzZUFtZW5kZWQoZWFybHlQdXJjaGFzZUluZGV4KTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICBmdW5jdGlvbiBpc0FtZW5kZWRFYXJseVB1cmNoYXNlKHVpbnQgZWFybHlQdXJjaGFzZUluZGV4KQogICAgICAgIGNvbnN0YW50CiAgICAgICAgbm9FdGhlcgogICAgICAgIHJldHVybnMgKGJvb2wpCiAgICB7CiAgICAgICAgaWYgKG51bWJlck9mUmF3RWFybHlQdXJjaGFzZXMoKSA8PSBlYXJseVB1cmNoYXNlSW5kZXgpIHsKICAgICAgICAgICAgdGhyb3c7ICAvLyBBcnJheSBJbmRleCBPdXQgb2YgQm91bmRzIEV4Y2VwdGlvbgogICAgICAgIH0KCiAgICAgICAgZm9yICh1aW50IGk7IGkgPCBhbWVuZGVkRWFybHlQdXJjaGFzZUluZGV4ZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgaWYgKGFtZW5kZWRFYXJseVB1cmNoYXNlSW5kZXhlc1tpXSA9PSBlYXJseVB1cmNoYXNlSW5kZXgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICBmdW5jdGlvbiBsb2FkU3RhcmJhc2VFYXJseVB1cmNoYXNlcyhhZGRyZXNzIHN0YXJiYXNlRWFybHlQdXJjaGFzZUFkZHJlc3MpCiAgICAgICAgZXh0ZXJuYWwKICAgICAgICBub0V0aGVyCiAgICAgICAgb25seU93bmVyCiAgICAgICAgb25seUJlZm9yZUNyb3dkc2FsZQogICAgICAgIHJldHVybnMgKGJvb2wpCiAgICB7CiAgICAgICAgaWYgKHN0YXJiYXNlRWFybHlQdXJjaGFzZUFkZHJlc3MgPT0gMCB8fAogICAgICAgICAgICBhZGRyZXNzKHN0YXJiYXNlRWFybHlQdXJjaGFzZSkgIT0gMCkKICAgICAgICB7CiAgICAgICAgICAgIHRocm93OwogICAgICAgIH0KCiAgICAgICAgc3RhcmJhc2VFYXJseVB1cmNoYXNlID0gU3RhcmJhc2VFYXJseVB1cmNoYXNlKHN0YXJiYXNlRWFybHlQdXJjaGFzZUFkZHJlc3MpOwogICAgICAgIGlmIChzdGFyYmFzZUVhcmx5UHVyY2hhc2UuZWFybHlQdXJjaGFzZUNsb3NlZEF0KCkgPT0gMCkgewogICAgICAgICAgICB0aHJvdzsgICAvLyB0aGUgZWFybHkgcHVyY2hhc2UgbXVzdCBiZSBjbG9zZWQKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgLy8vIEBkZXYgQ29udHJhY3QgY29uc3RydWN0b3IgZnVuY3Rpb24KICAgIGZ1bmN0aW9uIFN0YXJiYXNlRWFybHlQdXJjaGFzZUFtZW5kbWVudCgpIG5vRXRoZXIgewogICAgICAgIG93bmVyID0gbXNnLnNlbmRlcjsKICAgIH0KCiAgICAvLy8gQGRldiBGYWxsYmFjayBmdW5jdGlvbiBhbHdheXMgZmFpbHMKICAgIGZ1bmN0aW9uICgpIHsKICAgICAgICB0aHJvdzsKICAgIH0KCiAgICAvKioKICAgICAqIEludGVybmFsIGZ1bmN0aW9ucwogICAgICovCiAgICBmdW5jdGlvbiBub3JtYWxpemVkRWFybHlQdXJjaGFzZXMoKQogICAgICAgIGNvbnN0YW50CiAgICAgICAgaW50ZXJuYWwKICAgICAgICByZXR1cm5zIChTdGFyYmFzZUVhcmx5UHVyY2hhc2UuRWFybHlQdXJjaGFzZVtdIG5vcm1hbGl6ZWRFUCkKICAgIHsKICAgICAgICB1aW50IHJhd0VQQ291bnQgPSBudW1iZXJPZlJhd0Vhcmx5UHVyY2hhc2VzKCk7CiAgICAgICAgbm9ybWFsaXplZEVQID0gbmV3IFN0YXJiYXNlRWFybHlQdXJjaGFzZS5FYXJseVB1cmNoYXNlW10oCiAgICAgICAgICAgIHJhd0VQQ291bnQgLSBpbnZhbGlkRWFybHlQdXJjaGFzZUluZGV4ZXMubGVuZ3RoKTsKCiAgICAgICAgdWludCBub3JtYWxpemVkSWR4OwogICAgICAgIGZvciAodWludCBpOyBpIDwgcmF3RVBDb3VudDsgaSsrKSB7CiAgICAgICAgICAgIGlmIChpc0ludmFsaWRFYXJseVB1cmNoYXNlKGkpKSB7CiAgICAgICAgICAgICAgICBjb250aW51ZTsgICAvLyBpbnZhbGlkIGVhcmx5IHB1cmNoYXNlIHNob3VsZCBiZSBpZ25vcmVkCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIFN0YXJiYXNlRWFybHlQdXJjaGFzZS5FYXJseVB1cmNoYXNlIG1lbW9yeSBlcDsKICAgICAgICAgICAgaWYgKGlzQW1lbmRlZEVhcmx5UHVyY2hhc2UoaSkpIHsKICAgICAgICAgICAgICAgIGVwID0gYW1lbmRlZEVhcmx5UHVyY2hhc2VzW2ldOyAgLy8gYW1lbmRlZCBlYXJseSBwdXJjaGFzZSBzaG91bGQgdGFrZSBhIHByaW9yaXR5CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBlcCA9IGdldEVhcmx5UHVyY2hhc2UoaSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG5vcm1hbGl6ZWRFUFtub3JtYWxpemVkSWR4XSA9IGVwOwogICAgICAgICAgICBub3JtYWxpemVkSWR4Kys7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGdldEVhcmx5UHVyY2hhc2UodWludCBlYXJseVB1cmNoYXNlSW5kZXgpCiAgICAgICAgaW50ZXJuYWwKICAgICAgICBjb25zdGFudAogICAgICAgIG9ubHlFYXJseVB1cmNoYXNlc0xvYWRlZAogICAgICAgIHJldHVybnMgKFN0YXJiYXNlRWFybHlQdXJjaGFzZS5FYXJseVB1cmNoYXNlKQogICAgewogICAgICAgIHZhciAocHVyY2hhc2VyLCBhbW91bnQsIHB1cmNoYXNlZEF0KSA9CiAgICAgICAgICAgIHN0YXJiYXNlRWFybHlQdXJjaGFzZS5lYXJseVB1cmNoYXNlcyhlYXJseVB1cmNoYXNlSW5kZXgpOwogICAgICAgIHJldHVybiBTdGFyYmFzZUVhcmx5UHVyY2hhc2UuRWFybHlQdXJjaGFzZShwdXJjaGFzZXIsIGFtb3VudCwgcHVyY2hhc2VkQXQpOwogICAgfQoKICAgIGZ1bmN0aW9uIG51bWJlck9mUmF3RWFybHlQdXJjaGFzZXMoKQogICAgICAgIGludGVybmFsCiAgICAgICAgY29uc3RhbnQKICAgICAgICBvbmx5RWFybHlQdXJjaGFzZXNMb2FkZWQKICAgICAgICByZXR1cm5zICh1aW50KQogICAgewogICAgICAgIHJldHVybiBzdGFyYmFzZUVhcmx5UHVyY2hhc2UubnVtYmVyT2ZFYXJseVB1cmNoYXNlcygpOwogICAgfQp9Cgpjb250cmFjdCBDZXJ0aWZpZXIgewoJZXZlbnQgQ29uZmlybWVkKGFkZHJlc3MgaW5kZXhlZCB3aG8pOwoJZXZlbnQgUmV2b2tlZChhZGRyZXNzIGluZGV4ZWQgd2hvKTsKCWZ1bmN0aW9uIGNlcnRpZmllZChhZGRyZXNzKSBwdWJsaWMgY29uc3RhbnQgcmV0dXJucyAoYm9vbCk7CglmdW5jdGlvbiBnZXQoYWRkcmVzcywgc3RyaW5nKSBwdWJsaWMgY29uc3RhbnQgcmV0dXJucyAoYnl0ZXMzMik7CglmdW5jdGlvbiBnZXRBZGRyZXNzKGFkZHJlc3MsIHN0cmluZykgcHVibGljIGNvbnN0YW50IHJldHVybnMgKGFkZHJlc3MpOwoJZnVuY3Rpb24gZ2V0VWludChhZGRyZXNzLCBzdHJpbmcpIHB1YmxpYyBjb25zdGFudCByZXR1cm5zICh1aW50KTsKfQoKLyoqCiAqIEB0aXRsZSBDcm93ZHNhbGUgY29udHJhY3QgLSBTdGFyYmFzZSBjcm93ZHNhbGUgdG8gY3JlYXRlIFNUQVIuCiAqIEBhdXRob3IgU3RhcmJhc2UgUFRFLiBMVEQuIC0gPDxhIGhyZWY9Ii9jZG4tY2dpL2wvZW1haWwtcHJvdGVjdGlvbiIgY2xhc3M9Il9fY2ZfZW1haWxfXyIgZGF0YS1jZmVtYWlsPSJlZjg2ODE4OTgwYWY5YzliOGU5ZDhkOGU5YzhhYzE4YzgwIj5bZW1haWwmIzE2MDtwcm90ZWN0ZWRdPC9hPj4KICovCmNvbnRyYWN0IFN0YXJiYXNlQ3Jvd2RzYWxlIGlzIE93bmFibGUgewogICAgdXNpbmcgU2FmZU1hdGggZm9yIHVpbnQyNTY7CiAgICAvKgogICAgICogIEV2ZW50cwogICAgICovCiAgICBldmVudCBDcm93ZHNhbGVFbmRlZCh1aW50MjU2IGVuZGVkQXQpOwogICAgZXZlbnQgU3RhcmJhc2VQdXJjaGFzZWRXaXRoRXRoKGFkZHJlc3MgcHVyY2hhc2VyLCB1aW50MjU2IGFtb3VudCwgdWludDI1NiByYXdBbW91bnQsIHVpbnQyNTYgY255RXRoUmF0ZSk7CiAgICBldmVudCBDbnlFdGhSYXRlVXBkYXRlZCh1aW50MjU2IGNueUV0aFJhdGUpOwogICAgZXZlbnQgQ255QnRjUmF0ZVVwZGF0ZWQodWludDI1NiBjbnlCdGNSYXRlKTsKICAgIGV2ZW50IFF1YWxpZmllZFBhcnRuZXJBZGRyZXNzKGFkZHJlc3MgcXVhbGlmaWVkUGFydG5lcik7CgogICAgLyoqCiAgICAgKiAgRXh0ZXJuYWwgY29udHJhY3RzCiAgICAgKi8KICAgIEFic3RyYWN0U3RhcmJhc2VUb2tlbiBwdWJsaWMgc3RhcmJhc2VUb2tlbjsKICAgIFN0YXJiYXNlRWFybHlQdXJjaGFzZUFtZW5kbWVudCBwdWJsaWMgc3RhcmJhc2VFcEFtZW5kbWVudDsKICAgIENlcnRpZmllciBwdWJsaWMgcGljb3BzQ2VydGlmaWVyOwoKICAgIC8qKgogICAgICogIENvbnN0YW50cwogICAgICovCiAgICB1aW50MjU2IGNvbnN0YW50IHB1YmxpYyBjcm93ZHNhbGVUb2tlbkFtb3VudCA9IDEyNTAwMDAwMGUxODsKICAgIHVpbnQyNTYgY29uc3RhbnQgcHVibGljIGVhcmx5UHVyY2hhc2VUb2tlbkFtb3VudCA9IDUwMDAwMDAwZTE4OwogICAgdWludDI1NiBjb25zdGFudCBwdWJsaWMgTUlOX0lOVkVTVE1FTlQgPSAxOyAvLyBtaW4gaXMgMSBXZWkKICAgIHVpbnQyNTYgY29uc3RhbnQgcHVibGljIE1BWF9DQVAgPSA2NzAwMDAwMDsgLy8gaW4gQ05ZLiBhcHByb3hpbWF0ZWx5IDEwTSBVU0QuIChpbmNsdWRlcyByYWlzZWQgYW1vdW50IGZyb20gYm90aCBFUCBhbmQgQ1MpCiAgICBzdHJpbmcgcHVibGljIGNvbnN0YW50IFBVUkNIQVNFX0FNT1VOVF9VTklUID0gJ0NOWSc7ICAvLyBDaGluZXNlIFl1YW4KCiAgICAvKioKICAgICAqIFR5cGVzCiAgICAgKi8KICAgIHN0cnVjdCBDcm93ZHNhbGVQdXJjaGFzZSB7CiAgICAgICAgYWRkcmVzcyBwdXJjaGFzZXI7CiAgICAgICAgdWludDI1NiBhbW91bnQ7ICAgICAgICAvLyBDTlkgYmFzZWQgYW1vdW50IHdpdGggYm9udXMKICAgICAgICB1aW50MjU2IHJhd0Ftb3VudDsgICAgIC8vIENOWSBiYXNlZCBhbW91bnQgbm8gYm9udXMKICAgICAgICB1aW50MjU2IHB1cmNoYXNlZEF0OyAgIC8vIHRpbWVzdGFtcAogICAgfQoKICAgIHN0cnVjdCBRdWFsaWZpZWRQYXJ0bmVycyB7CiAgICAgICAgdWludDI1NiBhbW91bnRDYXA7CiAgICAgICAgdWludDI1NiBhbW91bnRSYWlzZWQ7CiAgICAgICAgYm9vbCAgICBib25hRmlkZTsKICAgICAgICB1aW50MjU2IGNvbW1pc3Npb25GZWVQZXJjZW50YWdlOyAvLyBleGFtcGxlIDUgd2lsbCBjYWxjdWxhdGUgdGhlIHBlcmNlbnRhZ2UgYXMgNSUKICAgIH0KCiAgICAvKgogICAgICogIEVudW1zCiAgICAgKi8KICAgIGVudW0gQm9udXNNaWxlc3RvbmVzIHsKICAgICAgICBGaXJzdCwKICAgICAgICBTZWNvbmQsCiAgICAgICAgVGhpcmQsCiAgICAgICAgRm91cnRoLAogICAgICAgIEZpZnRoCiAgICB9CgogICAgLy8gSW5pdGlhbGl6ZSBib251c01pbGVzdG9uZXMKICAgIEJvbnVzTWlsZXN0b25lcyBwdWJsaWMgYm9udXNNaWxlc3RvbmVzID0gQm9udXNNaWxlc3RvbmVzLkZpcnN0OwoKICAgIC8qKgogICAgICogIFN0b3JhZ2UKICAgICAqLwogICAgdWludCBwdWJsaWMgbnVtT2ZEZWxpdmVyZWRDcm93ZHNhbGVQdXJjaGFzZXM7ICAvLyBpbmRleCB0byBrZWVwIHRoZSBudW1iZXIgb2YgY3Jvd2RzYWxlIHB1cmNoYXNlcyBoYXZlIGFscmVhZHkgYmVlbiBwcm9jZXNzZWQgYnkgYHdpdGhkcmF3UHVyY2hhc2VkVG9rZW5zYAogICAgdWludCBwdWJsaWMgbnVtT2ZEZWxpdmVyZWRFYXJseVB1cmNoYXNlczsgIC8vIGluZGV4IHRvIGtlZXAgdGhlIG51bWJlciBvZiBlYXJseSBwdXJjaGFzZXMgaGF2ZSBhbHJlYWR5IGJlZW4gcHJvY2Vzc2VkIGJ5IGB3aXRoZHJhd1B1cmNoYXNlZFRva2Vuc2AKICAgIHVpbnQyNTYgcHVibGljIG51bU9mTG9hZGVkRWFybHlQdXJjaGFzZXM7IC8vIGluZGV4IHRvIGtlZXAgdGhlIG51bWJlciBvZiBlYXJseSBwdXJjaGFzZXMgdGhhdCBoYXZlIGFscmVhZHkgYmVlbiBsb2FkZWQgYnkgYGxvYWRFYXJseVB1cmNoYXNlc2AKCiAgICAvLyBlYXJseSBwdXJjaGFzZQogICAgYWRkcmVzc1tdIHB1YmxpYyBlYXJseVB1cmNoYXNlcnM7CiAgICBtYXBwaW5nIChhZGRyZXNzID0+IHVpbnQyNTYpIHB1YmxpYyBlYXJseVB1cmNoYXNlZEFtb3VudEJ5OyAvLyBlYXJseSBwdXJjaGFzZWQgYW1vdW50IGluIENOWSBwZXIgcHVyY2hhc2VycycgYWRkcmVzcwogICAgYm9vbCBwdWJsaWMgZWFybHlQdXJjaGFzZXNMb2FkZWQgPSBmYWxzZTsgIC8vIHJldHVybnMgd2hldGhlciBhbGwgZWFybHkgcHVyY2hhc2VzIGFyZSBsb2FkZWQgaW50byB0aGlzIGNvbnRyYWN0CiAgICB1aW50MjU2IHB1YmxpYyB0b3RhbEFtb3VudE9mRWFybHlQdXJjaGFzZXNJbkNueTsgLy8gaW5jbHVkaW5nIDIwJSBib251cwoKICAgIC8vIGNyb3dkc2FsZQogICAgdWludDI1NiBwdWJsaWMgbWF4Q3Jvd2RzYWxlQ2FwOyAgICAgLy8gPSA2N00gQ05ZIC0gKHRvdGFsIHJhaXNlZCBhbW91bnQgZnJvbSBFUCkKICAgIHVpbnQyNTYgcHVibGljIHRvdGFsQW1vdW50T2ZQdXJjaGFzZXNJbkNueTsgLy8gdG90YWxFUCArIHRvdGFsUHJlU2FsZSArIHRvdGFsQ3Jvd2RzYWxlIChpbmNsdWRpbmcgYm9udXNlcykKICAgIG1hcHBpbmcgKGFkZHJlc3MgPT4gUXVhbGlmaWVkUGFydG5lcnMpIHB1YmxpYyBxdWFsaWZpZWRQYXJ0bmVyczsKICAgIHVpbnQyNTYgcHVibGljIHB1cmNoYXNlU3RhcnRCbG9jazsgIC8vIGNyb3dkc2FsZSBwdXJjaGFzZXMgY2FuIGJlIGFjY2VwdGVkIGZyb20gdGhpcyBibG9jayBudW1iZXIKICAgIHVpbnQyNTYgcHVibGljIHN0YXJ0RGF0ZTsKICAgIHVpbnQyNTYgcHVibGljIGVuZGVkQXQ7CiAgICBDcm93ZHNhbGVQdXJjaGFzZVtdIHB1YmxpYyBjcm93ZHNhbGVQdXJjaGFzZXM7CiAgICBtYXBwaW5nIChhZGRyZXNzID0+IHVpbnQyNTYpIHB1YmxpYyBjcm93ZHNhbGVQdXJjaGFzZUFtb3VudEJ5OyAvLyBjcm93ZHNhbGUgcHVyY2hhc2UgYW1vdW50IGluIENOWSBwZXIgcHVyY2hhc2VycycgYWRkcmVzcwogICAgdWludDI1NiBwdWJsaWMgY255QnRjUmF0ZTsgLy8gdGhpcyByYXRlIHdvbid0IGJlIHVzZWQgZnJvbSBhIHNtYXJ0IGNvbnRyYWN0IGZ1bmN0aW9uIGJ1dCBleHRlcm5hbCBzeXN0ZW0KICAgIHVpbnQyNTYgcHVibGljIGNueUV0aFJhdGU7CgogICAgLy8gYm9udXMgbWlsZXN0b25lcwogICAgdWludDI1NiBwdWJsaWMgZmlyc3RCb251c0VuZHM7CiAgICB1aW50MjU2IHB1YmxpYyBzZWNvbmRCb251c0VuZHM7CiAgICB1aW50MjU2IHB1YmxpYyB0aGlyZEJvbnVzRW5kczsKICAgIHVpbnQyNTYgcHVibGljIGZvdXJ0aEJvbnVzRW5kczsKCiAgICAvLyBhZnRlciB0aGUgY3Jvd2RzYWxlCiAgICBtYXBwaW5nIChhZGRyZXNzID0+IHVpbnQyNTYpIHB1YmxpYyBudW1PZlB1cmNoYXNlZFRva2Vuc09uQ3NCeTsgICAgLy8gdGhlIG51bWJlciBvZiB0b2tlbnMgcHVyY2hhc2VkIG9uIHRoZSBjcm93ZHNhbGUgYnkgYSBwdXJjaGFzZXIKICAgIG1hcHBpbmcgKGFkZHJlc3MgPT4gdWludDI1NikgcHVibGljIG51bU9mUHVyY2hhc2VkVG9rZW5zT25FcEJ5OyAgICAvLyB0aGUgbnVtYmVyIG9mIHRva2VucyBlYXJseSBwdXJjaGFzZWQgYnkgYSBwdXJjaGFzZXIKCiAgICAvKioKICAgICAqICBNb2RpZmllcnMKICAgICAqLwogICAgbW9kaWZpZXIgbWluSW52ZXN0bWVudCgpIHsKICAgICAgICAvLyBVc2VyIGhhcyB0byBzZW5kIGF0IGxlYXN0IHRoZSBldGhlciB2YWx1ZSBvZiBvbmUgdG9rZW4uCiAgICAgICAgYXNzZXJ0KG1zZy52YWx1ZSA+PSBNSU5fSU5WRVNUTUVOVCk7CiAgICAgICAgXzsKICAgIH0KCiAgICBtb2RpZmllciB3aGVuRW5kZWQoKSB7CiAgICAgICAgYXNzZXJ0KGlzRW5kZWQoKSk7CiAgICAgICAgXzsKICAgIH0KCiAgICBtb2RpZmllciBoYXNCYWxhbmNlKCkgewogICAgICAgIGFzc2VydCh0aGlzLmJhbGFuY2UgPiAwKTsKICAgICAgICBfOwogICAgfQogICAgbW9kaWZpZXIgcmF0ZUlzU2V0KHVpbnQyNTYgX3JhdGUpIHsKICAgICAgICBhc3NlcnQoX3JhdGUgIT0gMCk7CiAgICAgICAgXzsKICAgIH0KCiAgICBtb2RpZmllciB3aGVuTm90RW5kZWQoKSB7CiAgICAgICAgYXNzZXJ0KCFpc0VuZGVkKCkpOwogICAgICAgIF87CiAgICB9CgogICAgbW9kaWZpZXIgdG9rZW5zTm90RGVsaXZlcmVkKCkgewogICAgICAgIGFzc2VydChudW1PZkRlbGl2ZXJlZENyb3dkc2FsZVB1cmNoYXNlcyA9PSAwKTsKICAgICAgICBhc3NlcnQobnVtT2ZEZWxpdmVyZWRFYXJseVB1cmNoYXNlcyA9PSAwKTsKICAgICAgICBfOwogICAgfQoKICAgIG1vZGlmaWVyIG9ubHlGdW5kcmFpc2VyKCkgewogICAgICAgIGFzc2VydChhZGRyZXNzKHN0YXJiYXNlVG9rZW4pICE9IDApOwogICAgICAgIGFzc2VydChzdGFyYmFzZVRva2VuLmlzRnVuZHJhaXNlcihtc2cuc2VuZGVyKSk7CiAgICAgICAgXzsKICAgIH0KCiAgICBtb2RpZmllciBvbmx5UXVhbGlmaWVkUGFydG5lcigpIHsKICAgICAgICBhc3NlcnQocXVhbGlmaWVkUGFydG5lcnNbbXNnLnNlbmRlcl0uYm9uYUZpZGUpOwogICAgICAgIF87CiAgICB9CgogICAgbW9kaWZpZXIgb25seVF1YWxpZmllZFBhcnRuZXJPUlBpY29wc0NlcnRpZmllZCgpIHsKICAgICAgICBhc3NlcnQocXVhbGlmaWVkUGFydG5lcnNbbXNnLnNlbmRlcl0uYm9uYUZpZGUgfHwgcGljb3BzQ2VydGlmaWVyLmNlcnRpZmllZChtc2cuc2VuZGVyKSk7CiAgICAgICAgXzsKICAgIH0KCiAgICAvKioKICAgICAqIENvbnRyYWN0IGZ1bmN0aW9ucwogICAgICovCiAgICAvKioKICAgICAqIEBkZXYgQ29udHJhY3QgY29uc3RydWN0b3IgZnVuY3Rpb24gc2V0cyBvd25lciBhZGRyZXNzIGFuZAogICAgICogICAgICBhZGRyZXNzIG9mIFN0YXJiYXNlRWFybHlQdXJjaGFzZUFtZW5kbWVudCBjb250cmFjdC4KICAgICAqIEBwYXJhbSBzdGFyYmFzZUVwQWRkciBUaGUgYWRkcmVzcyB0aGF0IGhvbGRzIHRoZSBlYXJseSBwdXJjaGFzZXJzIFN0YXIgdG9rZW5zCiAgICAgKiBAcGFyYW0gcGljb3BzQ2VydGlmaWVyQWRkciBUaGUgYWRkcmVzcyBvZiB0aGUgUElDT1BTIGNlcnRpZmllci4KICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgIFNlZSBhbHNvIGh0dHBzOi8vcGljb3BzLnBhcml0eS5pby8jL2RldGFpbHMKICAgICAqLwogICAgZnVuY3Rpb24gU3RhcmJhc2VDcm93ZHNhbGUoYWRkcmVzcyBzdGFyYmFzZUVwQWRkciwgYWRkcmVzcyBwaWNvcHNDZXJ0aWZpZXJBZGRyKSB7CiAgICAgICAgcmVxdWlyZShzdGFyYmFzZUVwQWRkciAhPSAwICYmIHBpY29wc0NlcnRpZmllckFkZHIgIT0gMCk7CiAgICAgICAgb3duZXIgPSBtc2cuc2VuZGVyOwogICAgICAgIHN0YXJiYXNlRXBBbWVuZG1lbnQgPSBTdGFyYmFzZUVhcmx5UHVyY2hhc2VBbWVuZG1lbnQoc3RhcmJhc2VFcEFkZHIpOwogICAgICAgIHBpY29wc0NlcnRpZmllciA9IENlcnRpZmllcihwaWNvcHNDZXJ0aWZpZXJBZGRyKTsKICAgIH0KCiAgICAvKioKICAgICAqIEBkZXYgRmFsbGJhY2sgYWNjZXB0cyBwYXltZW50IGZvciBTdGFyIHRva2VucyB3aXRoIEV0aAogICAgICovCiAgICBmdW5jdGlvbigpIHBheWFibGUgewogICAgICAgIHJlZGlyZWN0VG9QdXJjaGFzZSgpOwogICAgfQoKICAgIC8qKgogICAgICogRXh0ZXJuYWwgZnVuY3Rpb25zCiAgICAgKi8KCiAgICAvKioKICAgICAqIEBkZXYgU2V0dXAgZnVuY3Rpb24gc2V0cyBleHRlcm5hbCBjb250cmFjdHMnIGFkZHJlc3NlcyBhbmQgc2V0IHRoZSBtYXggY3Jvd2RzYWxlIGNhcAogICAgICogQHBhcmFtIHN0YXJiYXNlVG9rZW5BZGRyZXNzIFRva2VuIGFkZHJlc3MuCiAgICAgKiBAcGFyYW0gX3B1cmNoYXNlU3RhcnRCbG9jayBCbG9jayBudW1iZXIgdG8gc3RhcnQgY3Jvd2RzYWxlCiAgICAgKi8KICAgIGZ1bmN0aW9uIHNldHVwKGFkZHJlc3Mgc3RhcmJhc2VUb2tlbkFkZHJlc3MsIHVpbnQyNTYgX3B1cmNoYXNlU3RhcnRCbG9jaykKICAgICAgICBleHRlcm5hbAogICAgICAgIG9ubHlPd25lcgogICAgICAgIHJldHVybnMgKGJvb2wpCiAgICB7CiAgICAgICAgcmVxdWlyZShzdGFyYmFzZVRva2VuQWRkcmVzcyAhPSBhZGRyZXNzKDApKTsKICAgICAgICByZXF1aXJlKGFkZHJlc3Moc3RhcmJhc2VUb2tlbikgPT0gMCk7CiAgICAgICAgc3RhcmJhc2VUb2tlbiA9IEFic3RyYWN0U3RhcmJhc2VUb2tlbihzdGFyYmFzZVRva2VuQWRkcmVzcyk7CiAgICAgICAgcHVyY2hhc2VTdGFydEJsb2NrID0gX3B1cmNoYXNlU3RhcnRCbG9jazsKCiAgICAgICAgLy8gc2V0IHRoZSBtYXggY2FwIG9mIHRoaXMgY3Jvd2RzYWxlCiAgICAgICAgbWF4Q3Jvd2RzYWxlQ2FwID0gTUFYX0NBUC5zdWIodG90YWxBbW91bnRPZkVhcmx5UHVyY2hhc2VzV2l0aG91dEJvbnVzKCkpOwoKICAgICAgICBhc3NlcnQobWF4Q3Jvd2RzYWxlQ2FwID4gMCk7CgogICAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIC8qKgogICAgICogQGRldiBUcmFuc2ZlcnMgcmFpc2VkIGZ1bmRzIHRvIGNvbXBhbnkncyB3YWxsZXQgYWRkcmVzcyBhdCBhbnkgZ2l2ZW4gdGltZS4KICAgICAqLwogICAgZnVuY3Rpb24gd2l0aGRyYXdGb3JDb21wYW55KCkKICAgICAgICBleHRlcm5hbAogICAgICAgIG9ubHlGdW5kcmFpc2VyCiAgICAgICAgaGFzQmFsYW5jZQogICAgewogICAgICAgIGFkZHJlc3MgY29tcGFueSA9IHN0YXJiYXNlVG9rZW4uY29tcGFueSgpOwogICAgICAgIHJlcXVpcmUoY29tcGFueSAhPSBhZGRyZXNzKDApKTsKICAgICAgICBjb21wYW55LnRyYW5zZmVyKHRoaXMuYmFsYW5jZSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBAZGV2IFVwZGF0ZSB0aGUgQ05ZL0VUSCByYXRlIHRvIHJlY29yZCBwdXJjaGFzZXMgaW4gQ05ZCiAgICAgKi8KICAgIGZ1bmN0aW9uIHVwZGF0ZUNueUV0aFJhdGUodWludDI1NiByYXRlKQogICAgICAgIGV4dGVybmFsCiAgICAgICAgb25seUZ1bmRyYWlzZXIKICAgICAgICByZXR1cm5zIChib29sKQogICAgewogICAgICAgIGNueUV0aFJhdGUgPSByYXRlOwogICAgICAgIENueUV0aFJhdGVVcGRhdGVkKGNueUV0aFJhdGUpOwogICAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIC8qKgogICAgICogQGRldiBVcGRhdGUgdGhlIENOWS9CVEMgcmF0ZSB0byByZWNvcmQgcHVyY2hhc2VzIGluIENOWQogICAgICovCiAgICBmdW5jdGlvbiB1cGRhdGVDbnlCdGNSYXRlKHVpbnQyNTYgcmF0ZSkKICAgICAgICBleHRlcm5hbAogICAgICAgIG9ubHlGdW5kcmFpc2VyCiAgICAgICAgcmV0dXJucyAoYm9vbCkKICAgIHsKICAgICAgICBjbnlCdGNSYXRlID0gcmF0ZTsKICAgICAgICBDbnlCdGNSYXRlVXBkYXRlZChjbnlCdGNSYXRlKTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICAvKioKICAgICAqIEBkZXYgQWxsb3cgZm9yIHRoZSBwb3NzaWJpbGl0eSBmb3IgY29udHJhY3Qgb3duZXIgdG8gc3RhcnQgY3Jvd2RzYWxlCiAgICAgKi8KICAgIGZ1bmN0aW9uIG93bmVyU3RhcnRzQ3Jvd2RzYWxlKHVpbnQyNTYgdGltZXN0YW1wKQogICAgICAgIGV4dGVybmFsCiAgICAgICAgb25seU93bmVyCiAgICB7CiAgICAgICAgYXNzZXJ0KHN0YXJ0RGF0ZSA9PSAwICYmIGJsb2NrLm51bWJlciA+PSBwdXJjaGFzZVN0YXJ0QmxvY2spOyAgIC8vIG92ZXJ3cml0aW5nIHN0YXJ0RGF0ZSBpcyBub3QgcGVybWl0dGVkIGFuZCBpdCBzaG91bGQgYmUgYWZ0ZXIgdGhlIGNyb3dkc2FsZSBzdGFydCBibG9jawogICAgICAgIHN0YXJ0Q3Jvd2RzYWxlKHRpbWVzdGFtcCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBAZGV2IEVuZHMgY3Jvd2RzYWxlCiAgICAgKiBAcGFyYW0gdGltZXN0YW1wIFRpbWVzdGFtcCBhdCB0aGUgY3Jvd2RzYWxlIGVuZGVkCiAgICAgKi8KICAgIGZ1bmN0aW9uIGVuZENyb3dkc2FsZSh1aW50MjU2IHRpbWVzdGFtcCkKICAgICAgICBleHRlcm5hbAogICAgICAgIG9ubHlPd25lcgogICAgewogICAgICAgIGFzc2VydCh0aW1lc3RhbXAgPiAwICYmIHRpbWVzdGFtcCA8PSBub3cpOwogICAgICAgIGFzc2VydChibG9jay5udW1iZXIgPiBwdXJjaGFzZVN0YXJ0QmxvY2sgJiYgZW5kZWRBdCA9PSAwKTsgICAvLyBjYW5ub3QgZW5kIGJlZm9yZSBpdCBzdGFydHMgYW5kIG92ZXJ3cml0aW5nIHRpbWUgaXMgbm90IHBlcm1pdHRlZAogICAgICAgIGVuZGVkQXQgPSB0aW1lc3RhbXA7CiAgICAgICAgdG90YWxBbW91bnRPZkVhcmx5UHVyY2hhc2VzSW5DbnkgPSB0b3RhbEFtb3VudE9mRWFybHlQdXJjaGFzZXNXaXRoQm9udXMoKTsKICAgICAgICB0b3RhbEFtb3VudE9mUHVyY2hhc2VzSW5DbnkgPSB0b3RhbFJhaXNlZEFtb3VudEluQ255KCk7CiAgICAgICAgQ3Jvd2RzYWxlRW5kZWQoZW5kZWRBdCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBAZGV2IERlbGl2ZXIgdG9rZW5zIHRvIHB1cmNoYXNlcnMgYWNjb3JkaW5nIHRvIHRoZWlyIHB1cmNoYXNlIGFtb3VudCBpbiBDTlkKICAgICAqLwogICAgZnVuY3Rpb24gd2l0aGRyYXdQdXJjaGFzZWRUb2tlbnMoKQogICAgICAgIGV4dGVybmFsCiAgICAgICAgd2hlbkVuZGVkCiAgICAgICAgcmV0dXJucyAoYm9vbCkKICAgIHsKICAgICAgICBhc3NlcnQoZWFybHlQdXJjaGFzZXNMb2FkZWQpOwogICAgICAgIGFzc2VydChhZGRyZXNzKHN0YXJiYXNlVG9rZW4pICE9IDApOwoKICAgICAgICAvKgogICAgICAgICAqIOKAnFZhbHVl4oCdIHJlZmVycyB0byB0aGUgY29udHJpYnV0aW9uIG9mIHRoZSBVc2VyOgogICAgICAgICAqICB7Y3Jvd2RzYWxlX3B1cmNoYXNlcl90b2tlbl9hbW91bnR9ID0KICAgICAgICAgKiAge2Nyb3dkc2FsZV90b2tlbl9hbW91bnR9ICoge2Nyb3dkc2FsZVB1cmNoYXNlX3ZhbHVlfSAvIHtlYXJseXB1cmNoYXNlX3ZhbHVlfSArIHtjcm93ZHNhbGVfdmFsdWV9LgogICAgICAgICAqCiAgICAgICAgICogRXhhbXBsZTogSWYgYSBVc2VyIGNvbnRyaWJ1dGVzIGR1cmluZyB0aGUgQ29udHJpYnV0aW9uIFBlcmlvZCAxMDAgQ05ZIChpbmNsdWRpbmcgYXBwbGljYWJsZQogICAgICAgICAqIEJvbnVzLCBpZiBhbnkpIGFuZCB0aGUgdG90YWwgYW1vdW50IGVhcmx5IHB1cmNoYXNlcyBhbW91bnRzIHRvIDbigJkwMDDigJkwMDAgQ05ZCiAgICAgICAgICogYW5kIHRvdGFsIGFtb3VudCByYWlzZWQgZHVyaW5nIHRoZSBDb250cmlidXRpb24gUGVyaW9kIGlzIDMw4oCZMDAw4oCZMDAwLCB0aGVuIGhlIHdpbGwgZ2V0CiAgICAgICAgICogMzQ3LjIyIFNUQVIgPSAxMjXigJkwMDDigJkwMDAgU1RBUiAqIDEwMCBDTlkgLyAzMOKAmTAwMOKAmTAwMCBDTlkgKyA24oCZMDAw4oCZMDAwIENOWS4KICAgICAgICAqLwoKICAgICAgICBpZiAoY3Jvd2RzYWxlUHVyY2hhc2VBbW91bnRCeVttc2cuc2VuZGVyXSA+IDApIHsKICAgICAgICAgICAgdWludDI1NiBjcm93ZHNhbGVQdXJjaGFzZVZhbHVlID0gY3Jvd2RzYWxlUHVyY2hhc2VBbW91bnRCeVttc2cuc2VuZGVyXTsKICAgICAgICAgICAgY3Jvd2RzYWxlUHVyY2hhc2VBbW91bnRCeVttc2cuc2VuZGVyXSA9IDA7CgogICAgICAgICAgICB1aW50MjU2IHRva2VuQ291bnQgPQogICAgICAgICAgICAgICAgU2FmZU1hdGgubXVsKGNyb3dkc2FsZVRva2VuQW1vdW50LCBjcm93ZHNhbGVQdXJjaGFzZVZhbHVlKSAvCiAgICAgICAgICAgICAgICB0b3RhbEFtb3VudE9mUHVyY2hhc2VzSW5Dbnk7CgogICAgICAgICAgICBudW1PZlB1cmNoYXNlZFRva2Vuc09uQ3NCeVttc2cuc2VuZGVyXSA9CiAgICAgICAgICAgICAgICBTYWZlTWF0aC5hZGQobnVtT2ZQdXJjaGFzZWRUb2tlbnNPbkNzQnlbbXNnLnNlbmRlcl0sIHRva2VuQ291bnQpOwogICAgICAgICAgICBhc3NlcnQoc3RhcmJhc2VUb2tlbi5hbGxvY2F0ZVRvQ3Jvd2RzYWxlUHVyY2hhc2VyKG1zZy5zZW5kZXIsIHRva2VuQ291bnQpKTsKICAgICAgICAgICAgbnVtT2ZEZWxpdmVyZWRDcm93ZHNhbGVQdXJjaGFzZXMrKzsKICAgICAgICB9CgogICAgICAgIC8qCiAgICAgICAgICog4oCcVmFsdWXigJ0gcmVmZXJzIHRvIHRoZSBjb250cmlidXRpb24gb2YgdGhlIFVzZXI6CiAgICAgICAgICoge2Vhcmx5cHVyY2hhc2VyX3Rva2VuX2Ftb3VudH0gPQogICAgICAgICAqIHtlYXJseXB1cmNoYXNlcl90b2tlbl9hbW91bnR9ICogKHtlYXJseXB1cmNoYXNlX3ZhbHVlfSAvIHt0b3RhbF9lYXJseXB1cmNoYXNlX3ZhbHVlfSkKICAgICAgICAgKiAgKyB7Y3Jvd2RzYWxlX3Rva2VuX2Ftb3VudH0gKiAoe2Vhcmx5cHVyY2hhc2VfdmFsdWV9IC8ge2Vhcmx5cHVyY2hhc2VfdmFsdWV9ICsge2Nyb3dkc2FsZV92YWx1ZX0pLgogICAgICAgICAqCiAgICAgICAgICogRXhhbXBsZTogSWYgYW4gRWFybHkgUHVyY2hhc2VyIGNvbnRyaWJ1dGVzIDEwMCBDTlkgKGluY2x1ZGluZyBCb251cyBvZiAyMCUpIGFuZCB0aGUKICAgICAgICAgKiB0b3RhbCBhbW91bnQgb2YgZWFybHkgcHVyY2hhc2VzIGFtb3VudHMgdG8gNuKAmTAwMOKAmTAwMCBDTlkgYW5kIHRoZSB0b3RhbCBhbW91bnQgcmFpc2VkCiAgICAgICAgICogZHVyaW5nIHRoZSBDb250cmlidXRpb24gUGVyaW9kIGlzIDMw4oCZMDAw4oCZMDAwIENOWSwgdGhlbiBoZSB3aWxsIGdldCAxMTgwLjU1IFNUQVIgPQogICAgICAgICAqIDUw4oCZMDAw4oCZMDAwIFNUQVIgKiAxMDAgQ05ZIC8gNuKAmTAwMOKAmTAwMCBDTlkgKyAxMjXigJkwMDDigJkwMDAgU1RBUiAqIDEwMCBDTlkgLwogICAgICAgICAqIDMw4oCZMDAw4oCZMDAwIENOWSArIDbigJkwMDDigJkwMDAgQ05ZCiAgICAgICAgICovCgogICAgICAgIGlmIChlYXJseVB1cmNoYXNlZEFtb3VudEJ5W21zZy5zZW5kZXJdID4gMCkgeyAgLy8gc2tpcCBpZiBpcyBub3QgYW4gZWFybHkgcHVyY2hhc2VyCiAgICAgICAgICAgIHVpbnQyNTYgZWFybHlQdXJjaGFzZXJQdXJjaGFzZVZhbHVlID0gZWFybHlQdXJjaGFzZWRBbW91bnRCeVttc2cuc2VuZGVyXTsKICAgICAgICAgICAgZWFybHlQdXJjaGFzZWRBbW91bnRCeVttc2cuc2VuZGVyXSA9IDA7CgogICAgICAgICAgICB1aW50MjU2IGVwVG9rZW5DYWxjdWxhdGlvbkZyb21FUFRva2VuQW1vdW50ID0gU2FmZU1hdGgubXVsKGVhcmx5UHVyY2hhc2VUb2tlbkFtb3VudCwgZWFybHlQdXJjaGFzZXJQdXJjaGFzZVZhbHVlKSAvIHRvdGFsQW1vdW50T2ZFYXJseVB1cmNoYXNlc0luQ255OwoKICAgICAgICAgICAgdWludDI1NiBlcFRva2VuQ2FsY3VsYXRpb25Gcm9tQ3Jvd2RzYWxlVG9rZW5BbW91bnQgPSBTYWZlTWF0aC5tdWwoY3Jvd2RzYWxlVG9rZW5BbW91bnQsIGVhcmx5UHVyY2hhc2VyUHVyY2hhc2VWYWx1ZSkgLyB0b3RhbEFtb3VudE9mUHVyY2hhc2VzSW5Dbnk7CgogICAgICAgICAgICB1aW50MjU2IGVwVG9rZW5Db3VudCA9IFNhZmVNYXRoLmFkZChlcFRva2VuQ2FsY3VsYXRpb25Gcm9tRVBUb2tlbkFtb3VudCwgZXBUb2tlbkNhbGN1bGF0aW9uRnJvbUNyb3dkc2FsZVRva2VuQW1vdW50KTsKCiAgICAgICAgICAgIG51bU9mUHVyY2hhc2VkVG9rZW5zT25FcEJ5W21zZy5zZW5kZXJdID0gU2FmZU1hdGguYWRkKG51bU9mUHVyY2hhc2VkVG9rZW5zT25FcEJ5W21zZy5zZW5kZXJdLCBlcFRva2VuQ291bnQpOwogICAgICAgICAgICBhc3NlcnQoc3RhcmJhc2VUb2tlbi5hbGxvY2F0ZVRvQ3Jvd2RzYWxlUHVyY2hhc2VyKG1zZy5zZW5kZXIsIGVwVG9rZW5Db3VudCkpOwogICAgICAgICAgICBudW1PZkRlbGl2ZXJlZEVhcmx5UHVyY2hhc2VzKys7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICAvKioKICAgICAqIEBkZXYgTG9hZCBlYXJseSBwdXJjaGFzZXMgZnJvbSB0aGUgY29udHJhY3Qga2VlcHMgdHJhY2sgb2YgdGhlbQogICAgICovCiAgICBmdW5jdGlvbiBsb2FkRWFybHlQdXJjaGFzZXMoKSBleHRlcm5hbCBvbmx5T3duZXIgcmV0dXJucyAoYm9vbCkgewogICAgICAgIGlmIChlYXJseVB1cmNoYXNlc0xvYWRlZCkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7ICAgIC8vIGFsbCBFUHMgaGF2ZSBhbHJlYWR5IGJlZW4gbG9hZGVkCiAgICAgICAgfQoKICAgICAgICB1aW50MjU2IG51bU9mT3JpZ0VwID0gc3RhcmJhc2VFcEFtZW5kbWVudAogICAgICAgICAgICAuc3RhcmJhc2VFYXJseVB1cmNoYXNlKCkKICAgICAgICAgICAgLm51bWJlck9mRWFybHlQdXJjaGFzZXMoKTsKCiAgICAgICAgZm9yICh1aW50MjU2IGkgPSBudW1PZkxvYWRlZEVhcmx5UHVyY2hhc2VzOyBpIDwgbnVtT2ZPcmlnRXAgJiYgbXNnLmdhcyA+IDIwMDAwMDsgaSsrKSB7CiAgICAgICAgICAgIGlmIChzdGFyYmFzZUVwQW1lbmRtZW50LmlzSW52YWxpZEVhcmx5UHVyY2hhc2UoaSkpIHsKICAgICAgICAgICAgICAgIG51bU9mTG9hZGVkRWFybHlQdXJjaGFzZXMgPSBTYWZlTWF0aC5hZGQobnVtT2ZMb2FkZWRFYXJseVB1cmNoYXNlcywgMSk7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgKHB1cmNoYXNlciwgYW1vdW50LCkgPQogICAgICAgICAgICAgICAgc3RhcmJhc2VFcEFtZW5kbWVudC5pc0FtZW5kZWRFYXJseVB1cmNoYXNlKGkpCiAgICAgICAgICAgICAgICA/IHN0YXJiYXNlRXBBbWVuZG1lbnQuYW1lbmRlZEVhcmx5UHVyY2hhc2VzKGkpCiAgICAgICAgICAgICAgICA6IHN0YXJiYXNlRXBBbWVuZG1lbnQuZWFybHlQdXJjaGFzZXMoaSk7CiAgICAgICAgICAgIGlmIChhbW91bnQgPiAwKSB7CiAgICAgICAgICAgICAgICBpZiAoZWFybHlQdXJjaGFzZWRBbW91bnRCeVtwdXJjaGFzZXJdID09IDApIHsKICAgICAgICAgICAgICAgICAgICBlYXJseVB1cmNoYXNlcnMucHVzaChwdXJjaGFzZXIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy8gZWFjaCBlYXJseSBwdXJjaGFzZXIgcmVjZWl2ZXMgMjAlIGJvbnVzCiAgICAgICAgICAgICAgICB1aW50MjU2IGJvbnVzID0gU2FmZU1hdGgubXVsKGFtb3VudCwgMjApIC8gMTAwOwogICAgICAgICAgICAgICAgdWludDI1NiBhbW91bnRXaXRoQm9udXMgPSBTYWZlTWF0aC5hZGQoYW1vdW50LCBib251cyk7CgogICAgICAgICAgICAgICAgZWFybHlQdXJjaGFzZWRBbW91bnRCeVtwdXJjaGFzZXJdID0gU2FmZU1hdGguYWRkKGVhcmx5UHVyY2hhc2VkQW1vdW50QnlbcHVyY2hhc2VyXSwgYW1vdW50V2l0aEJvbnVzKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgbnVtT2ZMb2FkZWRFYXJseVB1cmNoYXNlcyA9IFNhZmVNYXRoLmFkZChudW1PZkxvYWRlZEVhcmx5UHVyY2hhc2VzLCAxKTsKICAgICAgICB9CgogICAgICAgIGFzc2VydChudW1PZkxvYWRlZEVhcmx5UHVyY2hhc2VzIDw9IG51bU9mT3JpZ0VwKTsKICAgICAgICBpZiAobnVtT2ZMb2FkZWRFYXJseVB1cmNoYXNlcyA9PSBudW1PZk9yaWdFcCkgewogICAgICAgICAgICBlYXJseVB1cmNoYXNlc0xvYWRlZCA9IHRydWU7ICAgIC8vIGVuYWJsZSB0aGUgZmxhZwogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICAvKioKICAgICAgKiBAZGV2IFNldCBxdWFsaWZpZWQgY3Jvd2RzYWxlIHBhcnRuZXIgaS5lLiBCaXRjb2luIFN1aXNzZSBhZGRyZXNzCiAgICAgICogQHBhcmFtIF9xdWFsaWZpZWRQYXJ0bmVyIEFkZHJlc3Mgb2YgdGhlIHF1YWxpZmllZCBwYXJ0bmVyIHRoYXQgY2FuIHB1cmNoYXNlIGR1cmluZyBjcm93ZHNhbGUKICAgICAgKiBAcGFyYW0gX2Ftb3VudENhcCBFdGhlciB2YWx1ZSB3aGljaCBwYXJ0bmVyIGlzIGFibGUgdG8gY29udHJpYnV0ZQogICAgICAqIEBwYXJhbSBfY29tbWlzc2lvbkZlZVBlcmNlbnRhZ2UgSW50ZWdlciB0aGF0IHJlcHJlc2VudHMgdGhlIGZlZSB0byBwYXkgcXVhbGlmaWVkIHBhcnRuZXIgNSBpcyA1JQogICAgICAqLwogICAgZnVuY3Rpb24gc2V0UXVhbGlmaWVkUGFydG5lcihhZGRyZXNzIF9xdWFsaWZpZWRQYXJ0bmVyLCB1aW50MjU2IF9hbW91bnRDYXAsIHVpbnQyNTYgX2NvbW1pc3Npb25GZWVQZXJjZW50YWdlKQogICAgICAgIGV4dGVybmFsCiAgICAgICAgb25seU93bmVyCiAgICB7CiAgICAgICAgYXNzZXJ0KCFxdWFsaWZpZWRQYXJ0bmVyc1tfcXVhbGlmaWVkUGFydG5lcl0uYm9uYUZpZGUpOwogICAgICAgIHF1YWxpZmllZFBhcnRuZXJzW19xdWFsaWZpZWRQYXJ0bmVyXS5ib25hRmlkZSA9IHRydWU7CiAgICAgICAgcXVhbGlmaWVkUGFydG5lcnNbX3F1YWxpZmllZFBhcnRuZXJdLmFtb3VudENhcCA9IF9hbW91bnRDYXA7CiAgICAgICAgcXVhbGlmaWVkUGFydG5lcnNbX3F1YWxpZmllZFBhcnRuZXJdLmNvbW1pc3Npb25GZWVQZXJjZW50YWdlID0gX2NvbW1pc3Npb25GZWVQZXJjZW50YWdlOwogICAgICAgIFF1YWxpZmllZFBhcnRuZXJBZGRyZXNzKF9xdWFsaWZpZWRQYXJ0bmVyKTsKICAgIH0KCiAgICAvKioKICAgICAqIEBkZXYgUmVtb3ZlIGFkZHJlc3MgZnJvbSBxdWFsaWZpZWQgcGFydG5lcnMgbGlzdC4KICAgICAqIEBwYXJhbSBfcXVhbGlmaWVkUGFydG5lciBBZGRyZXNzIHRvIGJlIHJlbW92ZWQgZnJvbSB0aGUgbGlzdC4KICAgICAqLwogICAgZnVuY3Rpb24gdW5saXN0UXVhbGlmaWVkUGFydG5lcihhZGRyZXNzIF9xdWFsaWZpZWRQYXJ0bmVyKSBleHRlcm5hbCBvbmx5T3duZXIgewogICAgICAgIGFzc2VydChxdWFsaWZpZWRQYXJ0bmVyc1tfcXVhbGlmaWVkUGFydG5lcl0uYm9uYUZpZGUpOwogICAgICAgIHF1YWxpZmllZFBhcnRuZXJzW19xdWFsaWZpZWRQYXJ0bmVyXS5ib25hRmlkZSA9IGZhbHNlOwogICAgfQoKICAgIC8qKgogICAgICogQGRldiBVcGRhdGUgd2hpdGVsaXN0ZWQgYWRkcmVzcyBhbW91bnQgYWxsb3dlZCB0byByYWlzZSBkdXJpbmcgdGhlIHByZXNhbGUuCiAgICAgKiBAcGFyYW0gX3F1YWxpZmllZFBhcnRuZXIgUXVhbGlmaWVkIFBhcnRuZXIgYWRkcmVzcyB0byBiZSB1cGRhdGVkLgogICAgICogQHBhcmFtIF9hbW91bnRDYXAgQW1vdW50IHRoYXQgdGhlIGFkZHJlc3MgaXMgYWJsZSB0byByYWlzZSBkdXJpbmcgdGhlIHByZXNhbGUuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHVwZGF0ZVF1YWxpZmllZFBhcnRuZXJDYXBBbW91bnQoYWRkcmVzcyBfcXVhbGlmaWVkUGFydG5lciwgdWludDI1NiBfYW1vdW50Q2FwKSBleHRlcm5hbCBvbmx5T3duZXIgewogICAgICAgIGFzc2VydChxdWFsaWZpZWRQYXJ0bmVyc1tfcXVhbGlmaWVkUGFydG5lcl0uYm9uYUZpZGUpOwogICAgICAgIHF1YWxpZmllZFBhcnRuZXJzW19xdWFsaWZpZWRQYXJ0bmVyXS5hbW91bnRDYXAgPSBfYW1vdW50Q2FwOwogICAgfQoKICAgIC8qKgogICAgICogUHVibGljIGZ1bmN0aW9ucwogICAgICovCgogICAgLyoqCiAgICAgKiBAZGV2IFJldHVybnMgYm9vbGVhbiBmb3Igd2hldGhlciBjcm93ZHNhbGUgaGFzIGVuZGVkCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzRW5kZWQoKSBjb25zdGFudCBwdWJsaWMgcmV0dXJucyAoYm9vbCkgewogICAgICAgIHJldHVybiAoZW5kZWRBdCA+IDAgJiYgZW5kZWRBdCA8PSBub3cpOwogICAgfQoKICAgIC8qKgogICAgICogQGRldiBSZXR1cm5zIG51bWJlciBvZiBwdXJjaGFzZXMgdG8gZGF0ZS4KICAgICAqLwogICAgZnVuY3Rpb24gbnVtT2ZQdXJjaGFzZXMoKSBjb25zdGFudCBwdWJsaWMgcmV0dXJucyAodWludDI1NikgewogICAgICAgIHJldHVybiBjcm93ZHNhbGVQdXJjaGFzZXMubGVuZ3RoOwogICAgfQoKICAgIC8qKgogICAgICogQGRldiBDYWxjdWxhdGVzIHRvdGFsIGFtb3VudCBvZiB0b2tlbnMgcHVyY2hhc2VkIGluY2x1ZGVzIGJvbnVzIHRva2Vucy4KICAgICAqLwogICAgZnVuY3Rpb24gdG90YWxBbW91bnRPZkNyb3dkc2FsZVB1cmNoYXNlcygpIGNvbnN0YW50IHB1YmxpYyByZXR1cm5zICh1aW50MjU2IGFtb3VudCkgewogICAgICAgIGZvciAodWludDI1NiBpOyBpIDwgY3Jvd2RzYWxlUHVyY2hhc2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGFtb3VudCA9IFNhZmVNYXRoLmFkZChhbW91bnQsIGNyb3dkc2FsZVB1cmNoYXNlc1tpXS5hbW91bnQpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIEBkZXYgQ2FsY3VsYXRlcyB0b3RhbCBhbW91bnQgb2YgdG9rZW5zIHB1cmNoYXNlZCB3aXRob3V0IGJvbnVzIGNvbnZlcnNpb24uCiAgICAgKi8KICAgIGZ1bmN0aW9uIHRvdGFsQW1vdW50T2ZDcm93ZHNhbGVQdXJjaGFzZXNXaXRob3V0Qm9udXMoKSBjb25zdGFudCBwdWJsaWMgcmV0dXJucyAodWludDI1NiBhbW91bnQpIHsKICAgICAgICBmb3IgKHVpbnQyNTYgaTsgaSA8IGNyb3dkc2FsZVB1cmNoYXNlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBhbW91bnQgPSBTYWZlTWF0aC5hZGQoYW1vdW50LCBjcm93ZHNhbGVQdXJjaGFzZXNbaV0ucmF3QW1vdW50KTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBAZGV2IFJldHVybnMgdG90YWwgcmFpc2VkIGFtb3VudCBpbiBDTlkgKGluY2x1ZGVzIEVQKSBhbmQgYm9udXNlcwogICAgICovCiAgICBmdW5jdGlvbiB0b3RhbFJhaXNlZEFtb3VudEluQ255KCkgY29uc3RhbnQgcHVibGljIHJldHVybnMgKHVpbnQyNTYpIHsKICAgICAgICByZXR1cm4gU2FmZU1hdGguYWRkKHRvdGFsQW1vdW50T2ZFYXJseVB1cmNoYXNlc1dpdGhCb251cygpLCB0b3RhbEFtb3VudE9mQ3Jvd2RzYWxlUHVyY2hhc2VzKCkpOwogICAgfQoKICAgIC8qKgogICAgICogQGRldiBSZXR1cm5zIHRvdGFsIGFtb3VudCBvZiBlYXJseSBwdXJjaGFzZXMgaW4gQ05ZIGFuZCBib251c2VzCiAgICAgKi8KICAgIGZ1bmN0aW9uIHRvdGFsQW1vdW50T2ZFYXJseVB1cmNoYXNlc1dpdGhCb251cygpIGNvbnN0YW50IHB1YmxpYyByZXR1cm5zKHVpbnQyNTYpIHsKICAgICAgIHJldHVybiBzdGFyYmFzZUVwQW1lbmRtZW50LnRvdGFsQW1vdW50T2ZFYXJseVB1cmNoYXNlcygpLm11bCgxMjApLmRpdigxMDApOwogICAgfQoKICAgIC8qKgogICAgICogQGRldiBSZXR1cm5zIHRvdGFsIGFtb3VudCBvZiBlYXJseSBwdXJjaGFzZXMgaW4gQ05ZCiAgICAgKi8KICAgIGZ1bmN0aW9uIHRvdGFsQW1vdW50T2ZFYXJseVB1cmNoYXNlc1dpdGhvdXRCb251cygpIGNvbnN0YW50IHB1YmxpYyByZXR1cm5zKHVpbnQyNTYpIHsKICAgICAgIHJldHVybiBzdGFyYmFzZUVwQW1lbmRtZW50LnRvdGFsQW1vdW50T2ZFYXJseVB1cmNoYXNlcygpOwogICAgfQoKICAgIC8qKgogICAgICogQGRldiBBbGxvd3MgcXVhbGlmaWVkIGNyb3dkc2FsZSBwYXJ0bmVyIHRvIHB1cmNoYXNlIFN0YXIgVG9rZW5zCiAgICAgKi8KICAgIGZ1bmN0aW9uIHB1cmNoYXNlQXNRdWFsaWZpZWRQYXJ0bmVyKCkKICAgICAgICBwYXlhYmxlCiAgICAgICAgcHVibGljCiAgICAgICAgcmF0ZUlzU2V0KGNueUV0aFJhdGUpCiAgICAgICAgb25seVF1YWxpZmllZFBhcnRuZXIKICAgICAgICByZXR1cm5zIChib29sKQogICAgewogICAgICAgIHJlcXVpcmUobXNnLnZhbHVlID4gMCk7CiAgICAgICAgcXVhbGlmaWVkUGFydG5lcnNbbXNnLnNlbmRlcl0uYW1vdW50UmFpc2VkID0gU2FmZU1hdGguYWRkKG1zZy52YWx1ZSwgcXVhbGlmaWVkUGFydG5lcnNbbXNnLnNlbmRlcl0uYW1vdW50UmFpc2VkKTsKCiAgICAgICAgYXNzZXJ0KHF1YWxpZmllZFBhcnRuZXJzW21zZy5zZW5kZXJdLmFtb3VudFJhaXNlZCA8PSBxdWFsaWZpZWRQYXJ0bmVyc1ttc2cuc2VuZGVyXS5hbW91bnRDYXApOwoKICAgICAgICB1aW50MjU2IHJhd0Ftb3VudCA9IFNhZmVNYXRoLm11bChtc2cudmFsdWUsIGNueUV0aFJhdGUpIC8gMWUxODsKICAgICAgICByZWNvcmRQdXJjaGFzZShtc2cuc2VuZGVyLCByYXdBbW91bnQsIG5vdyk7CgogICAgICAgIGlmIChxdWFsaWZpZWRQYXJ0bmVyc1ttc2cuc2VuZGVyXS5jb21taXNzaW9uRmVlUGVyY2VudGFnZSA+IDApIHsKICAgICAgICAgICAgc2VuZFF1YWxpZmllZFBhcnRuZXJDb21taXNzaW9uRmVlKG1zZy5zZW5kZXIsIG1zZy52YWx1ZSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICAvKioKICAgICAqIEBkZXYgQWxsb3dzIHVzZXIgdG8gcHVyY2hhc2UgU1RBUiB0b2tlbnMgd2l0aCBFdGhlcgogICAgICovCiAgICBmdW5jdGlvbiBwdXJjaGFzZVdpdGhFdGgoKQogICAgICAgIHBheWFibGUKICAgICAgICBwdWJsaWMKICAgICAgICBtaW5JbnZlc3RtZW50CiAgICAgICAgd2hlbk5vdEVuZGVkCiAgICAgICAgcmF0ZUlzU2V0KGNueUV0aFJhdGUpCiAgICAgICAgb25seVF1YWxpZmllZFBhcnRuZXJPUlBpY29wc0NlcnRpZmllZAogICAgICAgIHJldHVybnMgKGJvb2wpCiAgICB7CiAgICAgICAgcmVxdWlyZShwdXJjaGFzZVN0YXJ0QmxvY2sgPiAwICYmIGJsb2NrLm51bWJlciA+PSBwdXJjaGFzZVN0YXJ0QmxvY2spOwoKICAgICAgICBpZiAoc3RhcnREYXRlID09IDApIHsKICAgICAgICAgICAgc3RhcnRDcm93ZHNhbGUoYmxvY2sudGltZXN0YW1wKTsKICAgICAgICB9CgogICAgICAgIHVpbnQyNTYgcmF3QW1vdW50ID0gU2FmZU1hdGgubXVsKG1zZy52YWx1ZSwgY255RXRoUmF0ZSkgLyAxZTE4OwogICAgICAgIHJlY29yZFB1cmNoYXNlKG1zZy5zZW5kZXIsIHJhd0Ftb3VudCwgbm93KTsKCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgLyoqCiAgICAgKiBJbnRlcm5hbCBmdW5jdGlvbnMKICAgICAqLwoKICAgIC8qKgogICAgICogQGRldiBJbml0aWFsaXplcyBTdGFyYmFzZSBjcm93ZHNhbGUKICAgICAqLwogICAgZnVuY3Rpb24gc3RhcnRDcm93ZHNhbGUodWludDI1NiB0aW1lc3RhbXApIGludGVybmFsIHsKICAgICAgICBzdGFydERhdGUgPSB0aW1lc3RhbXA7CiAgICAgICAgdWludDI1NiBwcmVzYWxlQW1vdW50ID0gdG90YWxBbW91bnRPZkNyb3dkc2FsZVB1cmNoYXNlc1dpdGhvdXRCb251cygpOwogICAgICAgIGlmIChtYXhDcm93ZHNhbGVDYXAgPiBwcmVzYWxlQW1vdW50KSB7CiAgICAgICAgICAgIHVpbnQyNTYgbWFpblNhbGVDYXAgPSBtYXhDcm93ZHNhbGVDYXAuc3ViKHByZXNhbGVBbW91bnQpOwogICAgICAgICAgICB1aW50MjU2IHR3ZW50eVBlcmNlbnRPZkNyb3dkc2FsZVB1cmNoYXNlID0gbWFpblNhbGVDYXAubXVsKDIwKS5kaXYoMTAwKTsKCiAgICAgICAgICAgIC8vIHNldCB0b2tlbiBib251cyBtaWxlc3RvbmVzIGluIGNueSB0b3RhbCBjcm93ZHNhbGUgcHVyY2hhc2UKICAgICAgICAgICAgZmlyc3RCb251c0VuZHMgPSAgdHdlbnR5UGVyY2VudE9mQ3Jvd2RzYWxlUHVyY2hhc2U7CiAgICAgICAgICAgIHNlY29uZEJvbnVzRW5kcyA9IGZpcnN0Qm9udXNFbmRzLmFkZCh0d2VudHlQZXJjZW50T2ZDcm93ZHNhbGVQdXJjaGFzZSk7CiAgICAgICAgICAgIHRoaXJkQm9udXNFbmRzID0gIHNlY29uZEJvbnVzRW5kcy5hZGQodHdlbnR5UGVyY2VudE9mQ3Jvd2RzYWxlUHVyY2hhc2UpOwogICAgICAgICAgICBmb3VydGhCb251c0VuZHMgPSB0aGlyZEJvbnVzRW5kcy5hZGQodHdlbnR5UGVyY2VudE9mQ3Jvd2RzYWxlUHVyY2hhc2UpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIEBkZXYgQWJzdHJhY3QgcmVjb3JkIG9mIGEgcHVyY2hhc2UgdG8gVG9rZW5zCiAgICAgKiBAcGFyYW0gcHVyY2hhc2VyIEFkZHJlc3Mgb2YgdGhlIGJ1eWVyCiAgICAgKiBAcGFyYW0gcmF3QW1vdW50IEFtb3VudCBpbiBDTlkgYXMgcGVyIHRoZSBDTlkvRVRIIHJhdGUgdXNlZAogICAgICogQHBhcmFtIHRpbWVzdGFtcCBUaW1lc3RhbXAgYXQgdGhlIHB1cmNoYXNlIG1hZGUKICAgICAqLwogICAgZnVuY3Rpb24gcmVjb3JkUHVyY2hhc2UoCiAgICAgICAgYWRkcmVzcyBwdXJjaGFzZXIsCiAgICAgICAgdWludDI1NiByYXdBbW91bnQsCiAgICAgICAgdWludDI1NiB0aW1lc3RhbXAKICAgICkKICAgICAgICBpbnRlcm5hbAogICAgICAgIHJldHVybnModWludDI1NiBhbW91bnQpCiAgICB7CiAgICAgICAgYW1vdW50ID0gcmF3QW1vdW50OyAvLyBhbW91bnQgdG8gY2hlY2sgcmVhY2ggb2YgbWF4IGNhcC4gaXQgZG9lcyBub3QgY2FyZSBmb3IgYm9udXMgdG9rZW5zIGhlcmUKCiAgICAgICAgLy8gcHJlc2FsZSB0cmFuc2ZlcnMgd2hpY2ggb2NjdXJzIGJlZm9yZSB0aGUgY3Jvd2RzYWxlIGlnbm9yZXMgdGhlIGNyb3dkc2FsZSBoYXJkIGNhcAogICAgICAgIGlmIChibG9jay5udW1iZXIgPj0gcHVyY2hhc2VTdGFydEJsb2NrKSB7CiAgICAgICAgICAgIHJlcXVpcmUodG90YWxBbW91bnRPZkNyb3dkc2FsZVB1cmNoYXNlc1dpdGhvdXRCb251cygpIDwgbWF4Q3Jvd2RzYWxlQ2FwKTsgICAvLyBjaGVjayBpZiB0aGUgYW1vdW50IGhhcyBhbHJlYWR5IHJlYWNoZWQgdGhlIGNhcAoKICAgICAgICAgICAgdWludDI1NiBjcm93ZHNhbGVUb3RhbEFtb3VudEFmdGVyUHVyY2hhc2UgPQogICAgICAgICAgICAgICAgU2FmZU1hdGguYWRkKHRvdGFsQW1vdW50T2ZDcm93ZHNhbGVQdXJjaGFzZXNXaXRob3V0Qm9udXMoKSwgYW1vdW50KTsKCiAgICAgICAgICAgIC8vIGNoZWNrIHdoZXRoZXIgcHVyY2hhc2UgZ29lcyBvdmVyIHRoZSBjYXAgYW5kIHNlbmQgdGhlIGRpZmZlcmVuY2UgYmFjayB0byB0aGUgcHVyY2hhc2VyLgogICAgICAgICAgICBpZiAoY3Jvd2RzYWxlVG90YWxBbW91bnRBZnRlclB1cmNoYXNlID4gbWF4Q3Jvd2RzYWxlQ2FwKSB7CiAgICAgICAgICAgICAgdWludDI1NiBkaWZmZXJlbmNlID0gU2FmZU1hdGguc3ViKGNyb3dkc2FsZVRvdGFsQW1vdW50QWZ0ZXJQdXJjaGFzZSwgbWF4Q3Jvd2RzYWxlQ2FwKTsKICAgICAgICAgICAgICB1aW50MjU2IGV0aFZhbHVlVG9SZXR1cm4gPSBTYWZlTWF0aC5tdWwoZGlmZmVyZW5jZSwgMWUxOCkgLyBjbnlFdGhSYXRlOwogICAgICAgICAgICAgIHB1cmNoYXNlci50cmFuc2ZlcihldGhWYWx1ZVRvUmV0dXJuKTsKICAgICAgICAgICAgICBhbW91bnQgPSBTYWZlTWF0aC5zdWIoYW1vdW50LCBkaWZmZXJlbmNlKTsKICAgICAgICAgICAgICByYXdBbW91bnQgPSBhbW91bnQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgfQoKICAgICAgICBhbW91bnQgPSBnZXRCb251c0Ftb3VudENhbGN1bGF0aW9uKGFtb3VudCk7IC8vIGF0IHRoaXMgcG9pbnQgYW1vdW50IGJvbnVzIGlzIGNhbGN1bGF0ZWQKCiAgICAgICAgQ3Jvd2RzYWxlUHVyY2hhc2UgbWVtb3J5IHB1cmNoYXNlID0gQ3Jvd2RzYWxlUHVyY2hhc2UocHVyY2hhc2VyLCBhbW91bnQsIHJhd0Ftb3VudCwgdGltZXN0YW1wKTsKICAgICAgICBjcm93ZHNhbGVQdXJjaGFzZXMucHVzaChwdXJjaGFzZSk7CiAgICAgICAgU3RhcmJhc2VQdXJjaGFzZWRXaXRoRXRoKG1zZy5zZW5kZXIsIGFtb3VudCwgcmF3QW1vdW50LCBjbnlFdGhSYXRlKTsKICAgICAgICBjcm93ZHNhbGVQdXJjaGFzZUFtb3VudEJ5W3B1cmNoYXNlcl0gPSBTYWZlTWF0aC5hZGQoY3Jvd2RzYWxlUHVyY2hhc2VBbW91bnRCeVtwdXJjaGFzZXJdLCBhbW91bnQpOwogICAgICAgIHJldHVybiBhbW91bnQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBAZGV2IENhbGN1bGF0ZXMgYW1vdW50IHdpdGggYm9udXMgZm9yIGJvbnVzIG1pbGVzdG9uZXMKICAgICAqLwogICAgZnVuY3Rpb24gY2FsY3VsYXRlQm9udXMKICAgICAgICAoCiAgICAgICAgICAgIEJvbnVzTWlsZXN0b25lcyBuZXh0TWlsZXN0b25lLAogICAgICAgICAgICB1aW50MjU2IGFtb3VudCwKICAgICAgICAgICAgdWludDI1NiBib251c1JhbmdlLAogICAgICAgICAgICB1aW50MjU2IGJvbnVzVGllciwKICAgICAgICAgICAgdWludDI1NiByZXN1bHRzCiAgICAgICAgKQogICAgICAgIGludGVybmFsCiAgICAgICAgcmV0dXJucyAodWludDI1NiByZXN1bHQsIHVpbnQyNTYgbmV3QW1vdW50KQogICAgewogICAgICAgIHVpbnQyNTYgYm9udXNDYWxjOwoKICAgICAgICBpZiAoYW1vdW50IDw9IGJvbnVzUmFuZ2UpIHsKICAgICAgICAgICAgYm9udXNDYWxjID0gYW1vdW50Lm11bChib251c1RpZXIpLmRpdigxMDApOwoKICAgICAgICAgICAgaWYgKGFtb3VudC5hZGQodG90YWxBbW91bnRPZkNyb3dkc2FsZVB1cmNoYXNlc1dpdGhvdXRCb251cygpKSA+PSBib251c1JhbmdlKQogICAgICAgICAgICAgICAgYm9udXNNaWxlc3RvbmVzID0gbmV4dE1pbGVzdG9uZTsKCiAgICAgICAgICAgIHJlc3VsdCA9IHJlc3VsdHMuYWRkKGFtb3VudCkuYWRkKGJvbnVzQ2FsYyk7CiAgICAgICAgICAgIG5ld0Ftb3VudCA9IDA7CgogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGJvbnVzQ2FsYyA9IGJvbnVzUmFuZ2UubXVsKGJvbnVzVGllcikuZGl2KDEwMCk7CiAgICAgICAgICAgIGJvbnVzTWlsZXN0b25lcyA9IG5leHRNaWxlc3RvbmU7CiAgICAgICAgICAgIHJlc3VsdCA9IHJlc3VsdHMuYWRkKGJvbnVzUmFuZ2UpLmFkZChib251c0NhbGMpOwogICAgICAgICAgICBuZXdBbW91bnQgPSBhbW91bnQuc3ViKGJvbnVzUmFuZ2UpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIEBkZXYgRmV0Y2hzIEJvbnVzIHRpZXIgcGVyY2VudGFnZSBwZXIgYm9udXMgbWlsZXN0b25lcwogICAgICovCiAgICBmdW5jdGlvbiBnZXRCb251c0Ftb3VudENhbGN1bGF0aW9uKHVpbnQyNTYgYW1vdW50KSBpbnRlcm5hbCByZXR1cm5zICh1aW50MjU2KSB7CiAgICAgICAgaWYgKGJsb2NrLm51bWJlciA8IHB1cmNoYXNlU3RhcnRCbG9jaykgewogICAgICAgICAgICB1aW50MjU2IGJvbnVzRnJvbUFtb3VudCA9IGFtb3VudC5tdWwoMzApLmRpdigxMDApOyAvLyBwcmVzYWxlIGhhcyAzMCUgYm9udXMKICAgICAgICAgICAgcmV0dXJuIGFtb3VudC5hZGQoYm9udXNGcm9tQW1vdW50KTsKICAgICAgICB9CgogICAgICAgIC8vIHJhbmdlIG9mIGVhY2ggYm9udXMgbWlsZXN0b25lcwogICAgICAgIHVpbnQyNTYgZmlyc3RCb251c1JhbmdlID0gZmlyc3RCb251c0VuZHM7CiAgICAgICAgdWludDI1NiBzZWNvbmRCb251c1JhbmdlID0gc2Vjb25kQm9udXNFbmRzLnN1YihmaXJzdEJvbnVzRW5kcyk7CiAgICAgICAgdWludDI1NiB0aGlyZEJvbnVzUmFuZ2UgPSB0aGlyZEJvbnVzRW5kcy5zdWIoc2Vjb25kQm9udXNFbmRzKTsKICAgICAgICB1aW50MjU2IGZvdXJ0aEJvbnVzUmFuZ2UgPSBmb3VydGhCb251c0VuZHMuc3ViKHRoaXJkQm9udXNFbmRzKTsKICAgICAgICB1aW50MjU2IHJlc3VsdDsKCiAgICAgICAgaWYgKGJvbnVzTWlsZXN0b25lcyA9PSBCb251c01pbGVzdG9uZXMuRmlyc3QpCiAgICAgICAgICAgIChyZXN1bHQsIGFtb3VudCkgPSBjYWxjdWxhdGVCb251cyhCb251c01pbGVzdG9uZXMuU2Vjb25kLCBhbW91bnQsIGZpcnN0Qm9udXNSYW5nZSwgMjAsIHJlc3VsdCk7CgogICAgICAgIGlmIChib251c01pbGVzdG9uZXMgPT0gQm9udXNNaWxlc3RvbmVzLlNlY29uZCkKICAgICAgICAgICAgKHJlc3VsdCwgYW1vdW50KSA9IGNhbGN1bGF0ZUJvbnVzKEJvbnVzTWlsZXN0b25lcy5UaGlyZCwgYW1vdW50LCBzZWNvbmRCb251c1JhbmdlLCAxNSwgcmVzdWx0KTsKCiAgICAgICAgaWYgKGJvbnVzTWlsZXN0b25lcyA9PSBCb251c01pbGVzdG9uZXMuVGhpcmQpCiAgICAgICAgICAgIChyZXN1bHQsIGFtb3VudCkgPSBjYWxjdWxhdGVCb251cyhCb251c01pbGVzdG9uZXMuRm91cnRoLCBhbW91bnQsIHRoaXJkQm9udXNSYW5nZSwgMTAsIHJlc3VsdCk7CgogICAgICAgIGlmIChib251c01pbGVzdG9uZXMgPT0gQm9udXNNaWxlc3RvbmVzLkZvdXJ0aCkKICAgICAgICAgICAgKHJlc3VsdCwgYW1vdW50KSA9IGNhbGN1bGF0ZUJvbnVzKEJvbnVzTWlsZXN0b25lcy5GaWZ0aCwgYW1vdW50LCBmb3VydGhCb251c1JhbmdlLCA1LCByZXN1bHQpOwoKICAgICAgICByZXR1cm4gcmVzdWx0LmFkZChhbW91bnQpOwogICAgfQoKICAgIC8qKgogICAgICogQGRldiBGZXRjaHMgQm9udXMgdGllciBwZXJjZW50YWdlIHBlciBib251cyBtaWxlc3RvbmVzCiAgICAgKiBAZGV2IHF1YWxpZmllZFBhcnRuZXIgQWRkcmVzcyBvZiBwYXJ0bmVycyB0aGF0IHBhcnRpY2lwYXRlZCBpbiBwcmUgc2FsZQogICAgICogQGRldiBhbW91bnRTZW50IFZhbHVlIHNlbnQgYnkgcXVhbGlmaWVkIHBhcnRuZXIKICAgICAqLwogICAgZnVuY3Rpb24gc2VuZFF1YWxpZmllZFBhcnRuZXJDb21taXNzaW9uRmVlKGFkZHJlc3MgcXVhbGlmaWVkUGFydG5lciwgdWludDI1NiBhbW91bnRTZW50KSBpbnRlcm5hbCB7CiAgICAgICAgLy9jYWxjdWxhdGUgdGhlIGNvbW1pc3Npb24gZmVlIHRvIHNlbmQgdG8gcXVhbGlmaWVkIHBhcnRuZXIKICAgICAgICB1aW50MjU2IGNvbW1pc3Npb25GZWVQZXJjZW50YWdlQ2FsY3VsYXRpb25BbW91bnQgPSBTYWZlTWF0aC5tdWwoYW1vdW50U2VudCwgcXVhbGlmaWVkUGFydG5lcnNbcXVhbGlmaWVkUGFydG5lcl0uY29tbWlzc2lvbkZlZVBlcmNlbnRhZ2UpIC8gMTAwOwoKICAgICAgICAvLyBzZW5kIGNvbW1pc3Npb24gZmVlIGFtb3VudAogICAgICAgIHF1YWxpZmllZFBhcnRuZXIudHJhbnNmZXIoY29tbWlzc2lvbkZlZVBlcmNlbnRhZ2VDYWxjdWxhdGlvbkFtb3VudCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBAZGV2IHJlZGlyZWN0VG9QdXJjaGFzZSBSZWRpcmVjdCB0byBhZGVxdWF0ZSBwdXJjaGFzZSBmdW5jdGlvbiB3aXRoaW4gdGhlIHNtYXJ0IGNvbnRyYWN0CiAgICAgKi8KICAgIGZ1bmN0aW9uIHJlZGlyZWN0VG9QdXJjaGFzZSgpIGludGVybmFsIHsKICAgICAgICBpZiAoYmxvY2subnVtYmVyIDwgcHVyY2hhc2VTdGFydEJsb2NrKSB7CiAgICAgICAgICAgIHB1cmNoYXNlQXNRdWFsaWZpZWRQYXJ0bmVyKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcHVyY2hhc2VXaXRoRXRoKCk7CiAgICAgICAgfQogICAgfQp9'.
	

]
