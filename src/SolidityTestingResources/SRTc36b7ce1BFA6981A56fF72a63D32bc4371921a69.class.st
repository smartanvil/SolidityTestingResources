Class {
	#name : #SRTc36b7ce1BFA6981A56fF72a63D32bc4371921a69,
	#superclass : #SRTContracts,
	#category : #SolidityTestingResources
}

{ #category : #base64 }
SRTc36b7ce1BFA6981A56fF72a63D32bc4371921a69 >> base64 [
	^ 'cHJhZ21hIHNvbGlkaXR5IF4wLjQuMTE7CgovLyBOQjogdGhpcyBpcyB0aGUgbmV3ZXIgRVJDMjAgcmV0dXJuaW5nIGJvb2wsIG5lZWQgZGlmZmVyZW50IGJvb2sgY29udHJhY3QgZm9yIG9sZGVyIHN0eWxlIHRva2Vucwpjb250cmFjdCBFUkMyMCB7CiAgZnVuY3Rpb24gdG90YWxTdXBwbHkoKSBjb25zdGFudCByZXR1cm5zICh1aW50KTsKICBmdW5jdGlvbiBiYWxhbmNlT2YoYWRkcmVzcyBfb3duZXIpIGNvbnN0YW50IHJldHVybnMgKHVpbnQgYmFsYW5jZSk7CiAgZnVuY3Rpb24gdHJhbnNmZXIoYWRkcmVzcyBfdG8sIHVpbnQgX3ZhbHVlKSByZXR1cm5zIChib29sIHN1Y2Nlc3MpOwogIGZ1bmN0aW9uIHRyYW5zZmVyRnJvbShhZGRyZXNzIF9mcm9tLCBhZGRyZXNzIF90bywgdWludCBfdmFsdWUpIHJldHVybnMgKGJvb2wgc3VjY2Vzcyk7CiAgZnVuY3Rpb24gYXBwcm92ZShhZGRyZXNzIF9zcGVuZGVyLCB1aW50IF92YWx1ZSkgcmV0dXJucyAoYm9vbCBzdWNjZXNzKTsKICBmdW5jdGlvbiBhbGxvd2FuY2UoYWRkcmVzcyBfb3duZXIsIGFkZHJlc3MgX3NwZW5kZXIpIGNvbnN0YW50IHJldHVybnMgKHVpbnQgcmVtYWluaW5nKTsKICBldmVudCBUcmFuc2ZlcihhZGRyZXNzIGluZGV4ZWQgX2Zyb20sIGFkZHJlc3MgaW5kZXhlZCBfdG8sIHVpbnQgX3ZhbHVlKTsKICBldmVudCBBcHByb3ZhbChhZGRyZXNzIGluZGV4ZWQgX293bmVyLCBhZGRyZXNzIGluZGV4ZWQgX3NwZW5kZXIsIHVpbnQgX3ZhbHVlKTsKfQoKLy8gVWJpVG9rLmlvIG9uLWNoYWluIGNvbnRpbnVvdXMgbGltaXQgb3JkZXIgYm9vayBtYXRjaGluZyBlbmdpbmUuCi8vIFRoaXMgdmFyaWF0aW9uIGlzIGZvciBhICJuaWNlIiBFUkMyMCB0b2tlbiBhcyBiYXNlLCBFVEggYXMgcXVvdGVkLCBhbmQgc3RhbmRhcmQgZmVlcyB3aXRoIHJld2FyZCB0b2tlbi4KLy8gQ29weXJpZ2h0IChjKSBCb25uYWcgTGltaXRlZC4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KLy8gVmVyc2lvbiAxLjEuMC4KLy8gVGhpcyBjb250cmFjdCBhbGxvd3MgbWluUHJpY2VFeHBvbmVudCwgYmFzZU1pbkluaXRpYWxTaXplLCBhbmQgYmFzZU1pblJlbWFpbmluZ1NpemUKLy8gdG8gYmUgc2V0IGF0IGluaXQoKSB0aW1lIGFwcHJvcHJpYXRlbHkgZm9yIHRoZSB0b2tlbiBkZWNpbWFscyBhbmQgbGlrZWx5IHZhbHVlLgovLwpjb250cmFjdCBCb29rRVJDMjBFdGhWMXAxIHsKCiAgZW51bSBCb29rVHlwZSB7CiAgICBFUkMyMEV0aFYxCiAgfQoKICBlbnVtIERpcmVjdGlvbiB7CiAgICBJbnZhbGlkLAogICAgQnV5LAogICAgU2VsbAogIH0KCiAgZW51bSBTdGF0dXMgewogICAgVW5rbm93biwKICAgIFJlamVjdGVkLAogICAgT3BlbiwKICAgIERvbmUsCiAgICBOZWVkc0dhcywKICAgIFNlbmRpbmcsIC8vIG5vdCB1c2VkIGJ5IGNvbnRyYWN0IC0gd2ViIG9ubHkKICAgIEZhaWxlZFNlbmQsIC8vIG5vdCB1c2VkIGJ5IGNvbnRyYWN0IC0gd2ViIG9ubHkKICAgIEZhaWxlZFR4biAvLyBub3QgdXNlZCBieSBjb250cmFjdCAtIHdlYiBvbmx5CiAgfQoKICBlbnVtIFJlYXNvbkNvZGUgewogICAgTm9uZSwKICAgIEludmFsaWRQcmljZSwKICAgIEludmFsaWRTaXplLAogICAgSW52YWxpZFRlcm1zLAogICAgSW5zdWZmaWNpZW50RnVuZHMsCiAgICBXb3VsZFRha2UsCiAgICBVbm1hdGNoZWQsCiAgICBUb29NYW55TWF0Y2hlcywKICAgIENsaWVudENhbmNlbAogIH0KCiAgZW51bSBUZXJtcyB7CiAgICBHVENOb0dhc1RvcHVwLAogICAgR1RDV2l0aEdhc1RvcHVwLAogICAgSW1tZWRpYXRlT3JDYW5jZWwsCiAgICBNYWtlck9ubHkKICB9CgogIHN0cnVjdCBPcmRlciB7CiAgICAvLyB0aGVzZSBhcmUgaW1tdXRhYmxlIG9uY2UgcGxhY2VkOgoKICAgIGFkZHJlc3MgY2xpZW50OwogICAgdWludDE2IHByaWNlOyAgICAgICAgICAgICAgLy8gcGFja2VkIHJlcHJlc2VudGF0aW9uIG9mIHNpZGUgKyBwcmljZQogICAgdWludCBzaXplQmFzZTsKICAgIFRlcm1zIHRlcm1zOwoKICAgIC8vIHRoZXNlIGFyZSBtdXRhYmxlIHVudGlsIERvbmUgb3IgUmVqZWN0ZWQ6CiAgICAKICAgIFN0YXR1cyBzdGF0dXM7CiAgICBSZWFzb25Db2RlIHJlYXNvbkNvZGU7CiAgICB1aW50MTI4IGV4ZWN1dGVkQmFzZTsgICAgICAvLyBncm9zcyBhbW91bnQgZXhlY3V0ZWQgaW4gYmFzZSBjdXJyZW5jeSAoYmVmb3JlIGZlZSBkZWR1Y3Rpb24pCiAgICB1aW50MTI4IGV4ZWN1dGVkQ250cjsgICAgICAvLyBncm9zcyBhbW91bnQgZXhlY3V0ZWQgaW4gY291bnRlciBjdXJyZW5jeSAoYmVmb3JlIGZlZSBkZWR1Y3Rpb24pCiAgICB1aW50MTI4IGZlZXNCYXNlT3JDbnRyOyAgICAvLyBiYXNlIGZvciBidXksIGNudHIgZm9yIHNlbGwKICAgIHVpbnQxMjggZmVlc1J3cmQ7CiAgfQogIAogIHN0cnVjdCBPcmRlckNoYWluIHsKICAgIHVpbnQxMjggZmlyc3RPcmRlcklkOwogICAgdWludDEyOCBsYXN0T3JkZXJJZDsKICB9CgogIHN0cnVjdCBPcmRlckNoYWluTm9kZSB7CiAgICB1aW50MTI4IG5leHRPcmRlcklkOwogICAgdWludDEyOCBwcmV2T3JkZXJJZDsKICB9CiAgCiAgLy8gSXQgc2hvdWxkIGJlIHBvc3NpYmxlIHRvIHJlY29uc3RydWN0IHRoZSBleHBlY3RlZCBzdGF0ZSBvZiB0aGUgY29udHJhY3QgZ2l2ZW46CiAgLy8gIC0gQ2xpZW50UGF5bWVudEV2ZW50IGxvZyBoaXN0b3J5CiAgLy8gIC0gQ2xpZW50T3JkZXJFdmVudCBsb2cgaGlzdG9yeQogIC8vICAtIENhbGxpbmcgZ2V0T3JkZXIgZm9yIHRoZSBvdGhlciBpbW11dGFibGUgb3JkZXIgZmllbGRzIG9mIG9yZGVycyByZWZlcmVuY2VkIGJ5IENsaWVudE9yZGVyRXZlbnQKICAKICBlbnVtIENsaWVudFBheW1lbnRFdmVudFR5cGUgewogICAgRGVwb3NpdCwKICAgIFdpdGhkcmF3LAogICAgVHJhbnNmZXJGcm9tLAogICAgVHJhbnNmZXIKICB9CgogIGVudW0gQmFsYW5jZVR5cGUgewogICAgQmFzZSwKICAgIENudHIsCiAgICBSd3JkCiAgfQoKICBldmVudCBDbGllbnRQYXltZW50RXZlbnQoCiAgICBhZGRyZXNzIGluZGV4ZWQgY2xpZW50LAogICAgQ2xpZW50UGF5bWVudEV2ZW50VHlwZSBjbGllbnRQYXltZW50RXZlbnRUeXBlLAogICAgQmFsYW5jZVR5cGUgYmFsYW5jZVR5cGUsCiAgICBpbnQgY2xpZW50QmFsYW5jZURlbHRhCiAgKTsKCiAgZW51bSBDbGllbnRPcmRlckV2ZW50VHlwZSB7CiAgICBDcmVhdGUsCiAgICBDb250aW51ZSwKICAgIENhbmNlbAogIH0KCiAgZXZlbnQgQ2xpZW50T3JkZXJFdmVudCgKICAgIGFkZHJlc3MgaW5kZXhlZCBjbGllbnQsCiAgICBDbGllbnRPcmRlckV2ZW50VHlwZSBjbGllbnRPcmRlckV2ZW50VHlwZSwKICAgIHVpbnQxMjggb3JkZXJJZCwKICAgIHVpbnQgbWF4TWF0Y2hlcwogICk7CgogIGVudW0gTWFya2V0T3JkZXJFdmVudFR5cGUgewogICAgLy8gb3JkZXJDb3VudCsrLCBkZXB0aCArPSBkZXB0aEJhc2UKICAgIEFkZCwKICAgIC8vIG9yZGVyQ291bnQtLSwgZGVwdGggLT0gZGVwdGhCYXNlCiAgICBSZW1vdmUsCiAgICAvLyBvcmRlckNvdW50LS0sIGRlcHRoIC09IGRlcHRoQmFzZSwgdHJhZGVkICs9IHRyYWRlQmFzZQogICAgLy8gKGRlcHRoIGNoYW5nZSBhbmQgdHJhZGVkIGNoYW5nZSBkaWZmZXIgd2hlbiB0aW55IHJlbWFpbmluZyBhbW91bnQgcmVmdW5kZWQpCiAgICBDb21wbGV0ZUZpbGwsCiAgICAvLyBvcmRlckNvdW50IHVuY2hhbmdlZCwgZGVwdGggLT0gZGVwdGhCYXNlLCB0cmFkZWQgKz0gdHJhZGVCYXNlCiAgICBQYXJ0aWFsRmlsbAogIH0KCiAgLy8gVGVjaG5pY2FsbHkgbm90IG5lZWRlZCBidXQgdGhlc2UgZXZlbnRzIGNhbiBiZSB1c2VkIHRvIG1haW50YWluIGFuIG9yZGVyIGJvb2sgb3IKICAvLyB3YXRjaCBmb3IgZmlsbHMuIE5vdGUgdGhhdCB0aGUgb3JkZXJJZCBhbmQgcHJpY2UgYXJlIHRob3NlIG9mIHRoZSBtYWtlci4KCiAgZXZlbnQgTWFya2V0T3JkZXJFdmVudCgKICAgIHVpbnQyNTYgaW5kZXhlZCBldmVudFRpbWVzdGFtcCwKICAgIHVpbnQxMjggaW5kZXhlZCBvcmRlcklkLAogICAgTWFya2V0T3JkZXJFdmVudFR5cGUgbWFya2V0T3JkZXJFdmVudFR5cGUsCiAgICB1aW50MTYgcHJpY2UsCiAgICB1aW50IGRlcHRoQmFzZSwKICAgIHVpbnQgdHJhZGVCYXNlCiAgKTsKCiAgLy8gdGhlIGJhc2UgdG9rZW4gKGUuZy4gVEVTVCkKICAKICBFUkMyMCBiYXNlVG9rZW47CgogIC8vIG1pbmltdW0gb3JkZXIgc2l6ZSAoaW5jbHVzaXZlKQogIHVpbnQgYmFzZU1pbkluaXRpYWxTaXplOyAvLyBzZXQgYXQgaW5pdAoKICAvLyBpZiBmb2xsb3dpbmcgcGFydGlhbCBtYXRjaCwgdGhlIHJlbWFuaW5nIGdldHMgc21hbGxlciB0aGFuIHRoaXMsIHJlbW92ZSBmcm9tIGJvb2sgYW5kIHJlZnVuZDoKICAvLyBnZW5lcmFsbHkgd2UgbWFrZSB0aGlzIDEwJSBvZiBiYXNlTWluSW5pdGlhbFNpemUKICB1aW50IGJhc2VNaW5SZW1haW5pbmdTaXplOyAvLyBzZXQgYXQgaW5pdAoKICAvLyBtYXhpbXVtIG9yZGVyIHNpemUgKGV4Y2x1c2l2ZSkKICAvLyBjaG9zZW4gc28gdGhhdCBldmVuIG11bHRpcGxpZWQgYnkgdGhlIG1heCBwcmljZSAob3IgZGl2aWRlZCBieSB0aGUgbWluIHByaWNlKSwKICAvLyBhbmQgdGhlbiBtdWx0aXBsaWVkIGJ5IGV0aFJ3cmRSYXRlLCBpdCBzdGlsbCBmaXRzIGluIDJeMTI3LCBhbGxvd2luZyB1cyB0byBzYXZlCiAgLy8gc29tZSBnYXMgYnkgc3RvcmluZyBleGVjdXRlZCArIGZlZSBmaWVsZHMgYXMgdWludDEyOC4KICAvLyBldmVuIHdpdGggMTggZGVjaW1hbHMsIHRoaXMgc3RpbGwgYWxsb3dzIG9yZGVyIHNpemVzIHVwIHRvIDEsMDAwLDAwMCwwMDAuCiAgLy8gaWYgd2UgZW5jb3VudGVyIGEgdG9rZW4gd2l0aCBlLmcuIDM2IGRlY2ltYWxzIHdlJ2xsIGhhdmUgdG8gcmV2aXNpdCAuLi4KICB1aW50IGNvbnN0YW50IGJhc2VNYXhTaXplID0gMTAgKiogMzA7CgogIC8vIHRoZSBjb3VudGVyIGN1cnJlbmN5IChFVEgpCiAgLy8gKG5vIGFkZHJlc3MgYmVjYXVzZSBpdCBpcyBFVEgpCgogIC8vIGF2b2lkIHRoZSBib29rIGdldHRpbmcgY2x1dHRlcmVkIHVwIHdpdGggdGlueSBhbW91bnRzIG5vdCB3b3J0aCB0aGUgZ2FzCiAgdWludCBjb25zdGFudCBjbnRyTWluSW5pdGlhbFNpemUgPSAxMCBmaW5uZXk7CgogIC8vIHNlZSBjb21tZW50cyBmb3IgYmFzZU1heFNpemUKICB1aW50IGNvbnN0YW50IGNudHJNYXhTaXplID0gMTAgKiogMzA7CgogIC8vIHRoZSByZXdhcmQgdG9rZW4gdGhhdCBjYW4gYmUgdXNlZCB0byBwYXkgZmVlcyAoVUJJKQoKICBFUkMyMCByd3JkVG9rZW47IC8vIHNldCBhdCBpbml0CgogIC8vIHVzZWQgdG8gY29udmVydCBFVEggYW1vdW50IHRvIHJld2FyZCB0b2tlbnMgd2hlbiBwYXlpbmcgZmVlIHdpdGggcmV3YXJkIHRva2VucwogIHVpbnQgY29uc3RhbnQgZXRoUndyZFJhdGUgPSAxMDAwOwogIAogIC8vIGZ1bmRzIHRoYXQgYmVsb25nIHRvIGNsaWVudHMgKGJhc2UsIGNvdW50ZXIsIGFuZCByZXdhcmQpCgogIG1hcHBpbmcgKGFkZHJlc3MgPT4gdWludCkgYmFsYW5jZUJhc2VGb3JDbGllbnQ7CiAgbWFwcGluZyAoYWRkcmVzcyA9PiB1aW50KSBiYWxhbmNlQ250ckZvckNsaWVudDsKICBtYXBwaW5nIChhZGRyZXNzID0+IHVpbnQpIGJhbGFuY2VSd3JkRm9yQ2xpZW50OwoKICAvLyBmZWUgY2hhcmdlZCBvbiBsaXF1aWRpdHkgdGFrZW4sIGV4cHJlc3NlZCBhcyBhIGRpdmlzb3IKICAvLyAoZS5nLiAyMDAwIG1lYW5zIDEvMjAwMCwgb3IgMC4wNSUpCgogIHVpbnQgY29uc3RhbnQgZmVlRGl2aXNvciA9IDIwMDA7CiAgCiAgLy8gZmVlcyBjaGFyZ2VkIGFyZSBnaXZlbiB0bzoKICAKICBhZGRyZXNzIGZlZUNvbGxlY3RvcjsgLy8gc2V0IGF0IGluaXQKCiAgLy8gYWxsIG9yZGVycyBldmVyIGNyZWF0ZWQKICAKICBtYXBwaW5nICh1aW50MTI4ID0+IE9yZGVyKSBvcmRlckZvck9yZGVySWQ7CgogIC8vIEVmZmVjdGl2ZWx5IGEgY29tcGFjdCBtYXBwaW5nIGZyb20gcHJpY2UgdG8gd2hldGhlciB0aGVyZSBhcmUgYW55IG9wZW4gb3JkZXJzIGF0IHRoYXQgcHJpY2UuCiAgLy8gU2VlICJQcmljZSBDYWxjdWxhdGlvbiBDb25zdGFudHMiIGJlbG93IGFzIHRvIHdoeSA4NS4KCiAgdWludDI1Nls4NV0gb2NjdXBpZWRQcmljZUJpdG1hcHM7CgogIC8vIFRoZXNlIGFsbG93IHVzIHRvIHdhbGsgb3ZlciB0aGUgb3JkZXJzIGluIHRoZSBib29rIGF0IGEgZ2l2ZW4gcHJpY2UgbGV2ZWwgKGFuZCBhZGQgbW9yZSkuCgogIG1hcHBpbmcgKHVpbnQxNiA9PiBPcmRlckNoYWluKSBvcmRlckNoYWluRm9yT2NjdXBpZWRQcmljZTsKICBtYXBwaW5nICh1aW50MTI4ID0+IE9yZGVyQ2hhaW5Ob2RlKSBvcmRlckNoYWluTm9kZUZvck9wZW5PcmRlcklkOwoKICAvLyBUaGVzZSBhbGxvdyBhIGNsaWVudCB0byAocmVhc29uYWJseSkgZWZmaWNpZW50bHkgZmluZCB0aGVpciBvd24gb3JkZXJzCiAgLy8gd2l0aG91dCByZWx5aW5nIG9uIGV2ZW50cyAod2hpY2ggZXZlbiBpbmRleGVkIGFyZSBhIGJpdCBleHBlbnNpdmUgdG8gc2VhcmNoCiAgLy8gYW5kIGNhbm5vdCBiZSBhY2Nlc3NlZCBmcm9tIHNtYXJ0IGNvbnRyYWN0cykuIFNlZSB3YWxrT3JkZXJzLgoKICBtYXBwaW5nIChhZGRyZXNzID0+IHVpbnQxMjgpIG1vc3RSZWNlbnRPcmRlcklkRm9yQ2xpZW50OwogIG1hcHBpbmcgKHVpbnQxMjggPT4gdWludDEyOCkgY2xpZW50UHJldmlvdXNPcmRlcklkQmVmb3JlT3JkZXJJZDsKCiAgLy8gUHJpY2UgQ2FsY3VsYXRpb24gQ29uc3RhbnRzLgogIC8vCiAgLy8gV2UgcGFjayBkaXJlY3Rpb24gYW5kIHByaWNlIGludG8gYSBjcmFmdHkgZGVjaW1hbCBmbG9hdGluZyBwb2ludCByZXByZXNlbnRhdGlvbgogIC8vIGZvciBlZmZpY2llbnQgaW5kZXhpbmcgYnkgcHJpY2UsIHRoZSBtYWluIHRoaW5nIHdlIGxvc2UgYnkgZG9pbmcgc28gaXMgcHJlY2lzaW9uIC0KICAvLyB3ZSBvbmx5IGhhdmUgMyBzaWduaWZpY2FudCBmaWd1cmVzIGluIG91ciBwcmljZXMuCiAgLy8KICAvLyBBbiB1bnBhY2tlZCBwcmljZSBjb25zaXN0cyBvZjoKICAvLwogIC8vICAgZGlyZWN0aW9uIC0gaW52YWxpZCAvIGJ1eSAvIHNlbGwKICAvLyAgIG1hbnRpc3NhICAtIHJhbmdlcyBmcm9tIDEwMCB0byA5OTkgcmVwcmVzZW50aW5nIDAuMTAwIHRvIDAuOTk5CiAgLy8gICBleHBvbmVudCAgLSByYW5nZXMgZnJvbSBtaW5pbXVtUHJpY2VFeHBvbmVudCB0byBtaW5pbXVtUHJpY2VFeHBvbmVudCArIDExCiAgLy8gICAgICAgICAgICAgICAoZS5nLiAtNSB0byArNiBmb3IgYSB0eXBpY2FsIHBhaXIgd2hlcmUgbWluUHJpY2VFeHBvbmVudCA9IC01KQogIC8vCiAgLy8gVGhlIHBhY2tlZCByZXByZXNlbnRhdGlvbiBoYXMgMjE2MDEgZGlmZmVyZW50IHByaWNlIHZhbHVlczoKICAvLwogIC8vICAgICAgMCAgPSBpbnZhbGlkIChjYW4gYmUgdXNlZCBhcyBtYXJrZXIgdmFsdWUpCiAgLy8gICAgICAxICA9IGJ1eSBhdCBtYXhpbXVtIHByaWNlICgwLjk5OSAqIDEwICoqIDYpCiAgLy8gICAgLi4uICA9IG90aGVyIGJ1eSBwcmljZXMgaW4gZGVzY2VuZGluZyBvcmRlcgogIC8vICAgNTQwMCAgPSBidXkgYXQgMS4wMAogIC8vICAgIC4uLiAgPSBvdGhlciBidXkgcHJpY2VzIGluIGRlc2NlbmRpbmcgb3JkZXIKICAvLyAgMTA4MDAgID0gYnV5IGF0IG1pbmltdW0gcHJpY2UgKDAuMTAwICogMTAgKiogLTUpCiAgLy8gIDEwODAxICA9IHNlbGwgYXQgbWluaW11bSBwcmljZSAoMC4xMDAgKiAxMCAqKiAtNSkKICAvLyAgICAuLi4gID0gb3RoZXIgc2VsbCBwcmljZXMgaW4gZGVzY2VuZGluZyBvcmRlcgogIC8vICAxNjIwMSAgPSBzZWxsIGF0IDEuMDAKICAvLyAgICAuLi4gID0gb3RoZXIgc2VsbCBwcmljZXMgaW4gZGVzY2VuZGluZyBvcmRlcgogIC8vICAyMTYwMCAgPSBzZWxsIGF0IG1heGltdW0gcHJpY2UgKDAuOTk5ICogMTAgKiogNikKICAvLyAgMjE2MDErID0gZG8gbm90IHVzZQogIC8vCiAgLy8gSWYgd2Ugd2FudCB0byBtYXAgZWFjaCBwYWNrZWQgcHJpY2UgdG8gYSBib29sZWFuIHZhbHVlICh3aGljaCB3ZSBkbyksCiAgLy8gd2UgcmVxdWlyZSA4NSAyNTYtYml0IHdvcmRzLiBPciA0Mi41IGZvciBlYWNoIHNpZGUgb2YgdGhlIGJvb2suCiAgCiAgaW50OCBtaW5QcmljZUV4cG9uZW50OyAvLyBzZXQgYXQgaW5pdAoKICB1aW50IGNvbnN0YW50IGludmFsaWRQcmljZSA9IDA7CgogIC8vIGNhcmVmdWw6IG1heCA9IGxhcmdlc3QgdW5wYWNrZWQgdmFsdWUsIG5vdCBsYXJnZXN0IHBhY2tlZCB2YWx1ZQogIHVpbnQgY29uc3RhbnQgbWF4QnV5UHJpY2UgPSAxOyAKICB1aW50IGNvbnN0YW50IG1pbkJ1eVByaWNlID0gMTA4MDA7CiAgdWludCBjb25zdGFudCBtaW5TZWxsUHJpY2UgPSAxMDgwMTsKICB1aW50IGNvbnN0YW50IG1heFNlbGxQcmljZSA9IDIxNjAwOwoKICAvLyBDb25zdHJ1Y3Rvci4KICAvLwogIC8vIFNldHMgZmVlQ29sbGVjdG9yIHRvIHRoZSBjcmVhdG9yLiBDcmVhdG9yIG5lZWRzIHRvIGNhbGwgaW5pdCgpIHRvIGZpbmlzaCBzZXR1cC4KICAvLwogIGZ1bmN0aW9uIEJvb2tFUkMyMEV0aFYxcDEoKSB7CiAgICBhZGRyZXNzIGNyZWF0b3IgPSBtc2cuc2VuZGVyOwogICAgZmVlQ29sbGVjdG9yID0gY3JlYXRvcjsKICB9CgogIC8vICJQdWJsaWMiIE1hbmFnZW1lbnQgLSBzZXQgYWRkcmVzcyBvZiBiYXNlIGFuZCByZXdhcmQgdG9rZW5zLgogIC8vCiAgLy8gQ2FuIG9ubHkgYmUgZG9uZSBvbmNlIChub3JtYWxseSBpbW1lZGlhdGVseSBhZnRlciBjcmVhdGlvbikgYnkgdGhlIGZlZSBjb2xsZWN0b3IuCiAgLy8KICAvLyBVc2VkIGluc3RlYWQgb2YgYSBjb25zdHJ1Y3RvciB0byBtYWtlIGRlcGxveW1lbnQgZWFzaWVyLgogIC8vCiAgLy8gYmFzZU1pbkluaXRpYWxTaXplIGlzIHRoZSBtaW5pbXVtIG9yZGVyIHNpemUgaW4gdG9rZW4td2VpOwogIC8vIHRoZSBtaW5pbXVtIHJlc3Rpbmcgc2l6ZSB3aWxsIGJlIG9uZSB0ZW50aCBvZiB0aGF0LgogIC8vCiAgLy8gbWluUHJpY2VFeHBvbmVudCBjb250cm9scyB0aGUgcmFuZ2Ugb2YgcHJpY2VzIHN1cHBvcnRlZCBieSB0aGUgY29udHJhY3Q7CiAgLy8gdGhlIHJhbmdlIHdpbGwgYmUgMC4xMDAqMTAqKm1pblByaWNlRXhwb25lbnQgdG8gMC45OTkqMTAqKihtaW5QcmljZUV4cG9uZW50ICsgMTEpCiAgLy8gYnV0IGNhcmVmdWw7IHRoaXMgaXMgaW4gdG9rZW4td2VpIDogd2VpLCBpZ25vcmluZyB0aGUgbnVtYmVyIG9mIGRlY2ltYWxzIG9mIHRoZSB0b2tlbgogIC8vIGUuZy4gLTUgaW1wbGllcyAxIHRva2VuLXdlaSB3b3J0aCBiZXR3ZWVuIDAuMTAwZS01IHRvIDAuOTk5ZSs2IHdlaQogIC8vIHdoaWNoIGltcGxpZXMgc2FtZSB0b2tlbjpldGggZXhjaGFuZ2UgcmF0ZSBpZiB0b2tlbiBkZWNpbWFscyBhcmUgMTggbGlrZSBldGgsCiAgLy8gYnV0IGlmIHRva2VuIGRlY2ltYWxzIGFyZSA4LCB0aGF0IHdvdWxkIGltcGx5IDEgdG9rZW4gd29ydGggMTAgd2VpIHRvIDAuMDAwOTk5IEVUSC4KICAvLwogIGZ1bmN0aW9uIGluaXQoRVJDMjAgX2Jhc2VUb2tlbiwgRVJDMjAgX3J3cmRUb2tlbiwgdWludCBfYmFzZU1pbkluaXRpYWxTaXplLCBpbnQ4IF9taW5QcmljZUV4cG9uZW50KSBwdWJsaWMgewogICAgcmVxdWlyZShtc2cuc2VuZGVyID09IGZlZUNvbGxlY3Rvcik7CiAgICByZXF1aXJlKGFkZHJlc3MoYmFzZVRva2VuKSA9PSAwKTsKICAgIHJlcXVpcmUoYWRkcmVzcyhfYmFzZVRva2VuKSAhPSAwKTsKICAgIHJlcXVpcmUoYWRkcmVzcyhyd3JkVG9rZW4pID09IDApOwogICAgcmVxdWlyZShhZGRyZXNzKF9yd3JkVG9rZW4pICE9IDApOwogICAgcmVxdWlyZShfYmFzZU1pbkluaXRpYWxTaXplID49IDEwKTsKICAgIHJlcXVpcmUoX2Jhc2VNaW5Jbml0aWFsU2l6ZSA8IGJhc2VNYXhTaXplIC8gMTAwMDAwMCk7CiAgICByZXF1aXJlKF9taW5QcmljZUV4cG9uZW50ID49IC0yMCAmJiBfbWluUHJpY2VFeHBvbmVudCA8PSAyMCk7CiAgICBpZiAoX21pblByaWNlRXhwb25lbnQgPCAyKSB7CiAgICAgIHJlcXVpcmUoX2Jhc2VNaW5Jbml0aWFsU2l6ZSA+PSAxMCAqKiB1aW50KDMtaW50KG1pblByaWNlRXhwb25lbnQpKSk7CiAgICB9CiAgICBiYXNlTWluSW5pdGlhbFNpemUgPSBfYmFzZU1pbkluaXRpYWxTaXplOwogICAgLy8gZHVzdCBwcmV2ZW50aW9uLiB0cnVuY2F0aW9uIG9rLCBrbm93ID49IDEwCiAgICBiYXNlTWluUmVtYWluaW5nU2l6ZSA9IF9iYXNlTWluSW5pdGlhbFNpemUgLyAxMDsKICAgIG1pblByaWNlRXhwb25lbnQgPSBfbWluUHJpY2VFeHBvbmVudDsKICAgIC8vIGF0dGVtcHQgdG8gY2F0Y2ggYmFkIHRva2VuczoKICAgIHJlcXVpcmUoX2Jhc2VUb2tlbi50b3RhbFN1cHBseSgpID4gMCk7CiAgICBiYXNlVG9rZW4gPSBfYmFzZVRva2VuOwogICAgcmVxdWlyZShfcndyZFRva2VuLnRvdGFsU3VwcGx5KCkgPiAwKTsKICAgIHJ3cmRUb2tlbiA9IF9yd3JkVG9rZW47CiAgfQoKICAvLyAiUHVibGljIiBNYW5hZ2VtZW50IC0gY2hhbmdlIGZlZSBjb2xsZWN0b3IKICAvLwogIC8vIFRoZSBuZXcgZmVlIGNvbGxlY3RvciBvbmx5IGdldHMgZmVlcyBjaGFyZ2VkIGFmdGVyIHRoaXMgcG9pbnQuCiAgLy8KICBmdW5jdGlvbiBjaGFuZ2VGZWVDb2xsZWN0b3IoYWRkcmVzcyBuZXdGZWVDb2xsZWN0b3IpIHB1YmxpYyB7CiAgICBhZGRyZXNzIG9sZEZlZUNvbGxlY3RvciA9IGZlZUNvbGxlY3RvcjsKICAgIHJlcXVpcmUobXNnLnNlbmRlciA9PSBvbGRGZWVDb2xsZWN0b3IpOwogICAgcmVxdWlyZShuZXdGZWVDb2xsZWN0b3IgIT0gb2xkRmVlQ29sbGVjdG9yKTsKICAgIGZlZUNvbGxlY3RvciA9IG5ld0ZlZUNvbGxlY3RvcjsKICB9CiAgCiAgLy8gUHVibGljIEluZm8gVmlldyAtIHdoYXQgaXMgYmVpbmcgdHJhZGVkIGhlcmUsIHdoYXQgYXJlIHRoZSBsaW1pdHM/CiAgLy8KICBmdW5jdGlvbiBnZXRCb29rSW5mbygpIHB1YmxpYyBjb25zdGFudCByZXR1cm5zICgKICAgICAgQm9va1R5cGUgX2Jvb2tUeXBlLCBhZGRyZXNzIF9iYXNlVG9rZW4sIGFkZHJlc3MgX3J3cmRUb2tlbiwKICAgICAgdWludCBfYmFzZU1pbkluaXRpYWxTaXplLCB1aW50IF9jbnRyTWluSW5pdGlhbFNpemUsIGludDggX21pblByaWNlRXhwb25lbnQsCiAgICAgIHVpbnQgX2ZlZURpdmlzb3IsIGFkZHJlc3MgX2ZlZUNvbGxlY3RvcgogICAgKSB7CiAgICByZXR1cm4gKAogICAgICBCb29rVHlwZS5FUkMyMEV0aFYxLAogICAgICBhZGRyZXNzKGJhc2VUb2tlbiksCiAgICAgIGFkZHJlc3MocndyZFRva2VuKSwKICAgICAgYmFzZU1pbkluaXRpYWxTaXplLCAvLyBjYW4gYXNzdW1lIG1pbiByZXN0aW5nIHNpemUgaXMgb25lIHRlbnRoIG9mIHRoaXMKICAgICAgY250ck1pbkluaXRpYWxTaXplLAogICAgICBtaW5QcmljZUV4cG9uZW50LAogICAgICBmZWVEaXZpc29yLAogICAgICBmZWVDb2xsZWN0b3IKICAgICk7CiAgfQoKICAvLyBQdWJsaWMgRnVuZHMgVmlldyAtIGdldCBiYWxhbmNlcyBoZWxkIGJ5IGNvbnRyYWN0IG9uIGJlaGFsZiBvZiB0aGUgY2xpZW50LAogIC8vIG9yIGJhbGFuY2VzIGFwcHJvdmVkIGZvciBkZXBvc2l0IGJ1dCBub3QgeWV0IGNsYWltZWQgYnkgdGhlIGNvbnRyYWN0LgogIC8vCiAgLy8gRXhjbHVkZXMgZnVuZHMgaW4gb3BlbiBvcmRlcnMuCiAgLy8KICAvLyBIZWxwcyBhIHdlYiB1aSBnZXQgYSBjb25zaXN0ZW50IHNuYXBzaG90IG9mIGJhbGFuY2VzLgogIC8vCiAgLy8gSXQgd291bGQgYmUgbmljZSB0byByZXR1cm4gdGhlIG9mZi1leGNoYW5nZSBFVEggYmFsYW5jZSB0b28gYnV0IHRoZXJlJ3MgYQogIC8vIGJpemFycmUgYnVnIGluIGdldGggKGFuZCBhcHBhcmVudGx5IGFzIGEgcmVzdWx0IHZpYSBNZXRhTWFzaykgdGhhdCBsZWFkcwogIC8vIHRvIHVucHJlZGljdGFibGUgYmVoYXZpb3VyIHdoZW4gbG9va2luZyB1cCBjbGllbnQgYmFsYW5jZXMgaW4gY29uc3RhbnQKICAvLyBmdW5jdGlvbnMgLSBzZWUgZS5nLiBodHRwczovL2dpdGh1Yi5jb20vZXRoZXJldW0vc29saWRpdHkvaXNzdWVzLzIzMjUgLgogIC8vCiAgZnVuY3Rpb24gZ2V0Q2xpZW50QmFsYW5jZXMoYWRkcmVzcyBjbGllbnQpIHB1YmxpYyBjb25zdGFudCByZXR1cm5zICgKICAgICAgdWludCBib29rQmFsYW5jZUJhc2UsCiAgICAgIHVpbnQgYm9va0JhbGFuY2VDbnRyLAogICAgICB1aW50IGJvb2tCYWxhbmNlUndyZCwKICAgICAgdWludCBhcHByb3ZlZEJhbGFuY2VCYXNlLAogICAgICB1aW50IGFwcHJvdmVkQmFsYW5jZVJ3cmQsCiAgICAgIHVpbnQgb3duQmFsYW5jZUJhc2UsCiAgICAgIHVpbnQgb3duQmFsYW5jZVJ3cmQKICAgICkgewogICAgYm9va0JhbGFuY2VCYXNlID0gYmFsYW5jZUJhc2VGb3JDbGllbnRbY2xpZW50XTsKICAgIGJvb2tCYWxhbmNlQ250ciA9IGJhbGFuY2VDbnRyRm9yQ2xpZW50W2NsaWVudF07CiAgICBib29rQmFsYW5jZVJ3cmQgPSBiYWxhbmNlUndyZEZvckNsaWVudFtjbGllbnRdOwogICAgYXBwcm92ZWRCYWxhbmNlQmFzZSA9IGJhc2VUb2tlbi5hbGxvd2FuY2UoY2xpZW50LCBhZGRyZXNzKHRoaXMpKTsKICAgIGFwcHJvdmVkQmFsYW5jZVJ3cmQgPSByd3JkVG9rZW4uYWxsb3dhbmNlKGNsaWVudCwgYWRkcmVzcyh0aGlzKSk7CiAgICBvd25CYWxhbmNlQmFzZSA9IGJhc2VUb2tlbi5iYWxhbmNlT2YoY2xpZW50KTsKICAgIG93bkJhbGFuY2VSd3JkID0gcndyZFRva2VuLmJhbGFuY2VPZihjbGllbnQpOwogIH0KCiAgLy8gUHVibGljIEZ1bmRzIE1hbmlwdWxhdGlvbiAtIGRlcG9zaXQgcHJldmlvdXNseS1hcHByb3ZlZCBiYXNlIHRva2Vucy4KICAvLwogIGZ1bmN0aW9uIHRyYW5zZmVyRnJvbUJhc2UoKSBwdWJsaWMgewogICAgYWRkcmVzcyBjbGllbnQgPSBtc2cuc2VuZGVyOwogICAgYWRkcmVzcyBib29rID0gYWRkcmVzcyh0aGlzKTsKICAgIC8vIHdlIHRydXN0IHRoZSBFUkMyMCB0b2tlbiBjb250cmFjdCBub3QgdG8gZG8gbmFzdHkgdGhpbmdzIGxpa2UgY2FsbCBiYWNrIGludG8gdXMgLQogICAgLy8gaWYgd2UgY2Fubm90IHRydXN0IHRoZSB0b2tlbiB0aGVuIHdoeSBhcmUgd2UgYWxsb3dpbmcgaXQgdG8gYmUgdHJhZGVkPwogICAgdWludCBhbW91bnRCYXNlID0gYmFzZVRva2VuLmFsbG93YW5jZShjbGllbnQsIGJvb2spOwogICAgcmVxdWlyZShhbW91bnRCYXNlID4gMCk7CiAgICAvLyBOQjogbmVlZHMgY2hhbmdlIGZvciBvbGRlciBFUkMyMCB0b2tlbnMgdGhhdCBkb24ndCByZXR1cm4gYm9vbAogICAgcmVxdWlyZShiYXNlVG9rZW4udHJhbnNmZXJGcm9tKGNsaWVudCwgYm9vaywgYW1vdW50QmFzZSkpOwogICAgLy8gYmVsdCBhbmQgYnJhY2VzCiAgICBhc3NlcnQoYmFzZVRva2VuLmFsbG93YW5jZShjbGllbnQsIGJvb2spID09IDApOwogICAgYmFsYW5jZUJhc2VGb3JDbGllbnRbY2xpZW50XSArPSBhbW91bnRCYXNlOwogICAgQ2xpZW50UGF5bWVudEV2ZW50KGNsaWVudCwgQ2xpZW50UGF5bWVudEV2ZW50VHlwZS5UcmFuc2ZlckZyb20sIEJhbGFuY2VUeXBlLkJhc2UsIGludChhbW91bnRCYXNlKSk7CiAgfQoKICAvLyBQdWJsaWMgRnVuZHMgTWFuaXB1bGF0aW9uIC0gd2l0aGRyYXcgYmFzZSB0b2tlbnMgKGFzIGEgdHJhbnNmZXIpLgogIC8vCiAgZnVuY3Rpb24gdHJhbnNmZXJCYXNlKHVpbnQgYW1vdW50QmFzZSkgcHVibGljIHsKICAgIGFkZHJlc3MgY2xpZW50ID0gbXNnLnNlbmRlcjsKICAgIHJlcXVpcmUoYW1vdW50QmFzZSA+IDApOwogICAgcmVxdWlyZShhbW91bnRCYXNlIDw9IGJhbGFuY2VCYXNlRm9yQ2xpZW50W2NsaWVudF0pOwogICAgLy8gb3ZlcmZsb3cgc2FmZSBzaW5jZSB3ZSBjaGVja2VkIGxlc3MgdGhhbiBiYWxhbmNlIGFib3ZlCiAgICBiYWxhbmNlQmFzZUZvckNsaWVudFtjbGllbnRdIC09IGFtb3VudEJhc2U7CiAgICAvLyB3ZSB0cnVzdCB0aGUgRVJDMjAgdG9rZW4gY29udHJhY3Qgbm90IHRvIGRvIG5hc3R5IHRoaW5ncyBsaWtlIGNhbGwgYmFjayBpbnRvIHVzIC0KICAgIC8vIGlmIHdlIGNhbm5vdCB0cnVzdCB0aGUgdG9rZW4gdGhlbiB3aHkgYXJlIHdlIGFsbG93aW5nIGl0IHRvIGJlIHRyYWRlZD8KICAgIC8vIE5COiBuZWVkcyBjaGFuZ2UgZm9yIG9sZGVyIEVSQzIwIHRva2VucyB0aGF0IGRvbid0IHJldHVybiBib29sCiAgICByZXF1aXJlKGJhc2VUb2tlbi50cmFuc2ZlcihjbGllbnQsIGFtb3VudEJhc2UpKTsKICAgIENsaWVudFBheW1lbnRFdmVudChjbGllbnQsIENsaWVudFBheW1lbnRFdmVudFR5cGUuVHJhbnNmZXIsIEJhbGFuY2VUeXBlLkJhc2UsIC1pbnQoYW1vdW50QmFzZSkpOwogIH0KCiAgLy8gUHVibGljIEZ1bmRzIE1hbmlwdWxhdGlvbiAtIGRlcG9zaXQgY291bnRlciBjdXJyZW5jeSAoRVRIKS4KICAvLwogIGZ1bmN0aW9uIGRlcG9zaXRDbnRyKCkgcHVibGljIHBheWFibGUgewogICAgYWRkcmVzcyBjbGllbnQgPSBtc2cuc2VuZGVyOwogICAgdWludCBhbW91bnRDbnRyID0gbXNnLnZhbHVlOwogICAgcmVxdWlyZShhbW91bnRDbnRyID4gMCk7CiAgICAvLyBvdmVyZmxvdyBzYWZlIC0gaWYgc29tZW9uZSBvd25zIHBvdygyLDI1NSkgRVRIIHdlIGhhdmUgYmlnZ2VyIHByb2JsZW1zCiAgICBiYWxhbmNlQ250ckZvckNsaWVudFtjbGllbnRdICs9IGFtb3VudENudHI7CiAgICBDbGllbnRQYXltZW50RXZlbnQoY2xpZW50LCBDbGllbnRQYXltZW50RXZlbnRUeXBlLkRlcG9zaXQsIEJhbGFuY2VUeXBlLkNudHIsIGludChhbW91bnRDbnRyKSk7CiAgfQoKICAvLyBQdWJsaWMgRnVuZHMgTWFuaXB1bGF0aW9uIC0gd2l0aGRyYXcgY291bnRlciBjdXJyZW5jeSAoRVRIKS4KICAvLwogIGZ1bmN0aW9uIHdpdGhkcmF3Q250cih1aW50IGFtb3VudENudHIpIHB1YmxpYyB7CiAgICBhZGRyZXNzIGNsaWVudCA9IG1zZy5zZW5kZXI7CiAgICByZXF1aXJlKGFtb3VudENudHIgPiAwKTsKICAgIHJlcXVpcmUoYW1vdW50Q250ciA8PSBiYWxhbmNlQ250ckZvckNsaWVudFtjbGllbnRdKTsKICAgIC8vIG92ZXJmbG93IHNhZmUgLSBjaGVja2VkIGxlc3MgdGhhbiBiYWxhbmNlIGFib3ZlCiAgICBiYWxhbmNlQ250ckZvckNsaWVudFtjbGllbnRdIC09IGFtb3VudENudHI7CiAgICAvLyBzYWZlIC0gbm90IGVub3VnaCBnYXMgdG8gZG8gYW55dGhpbmcgaW50ZXJlc3RpbmcgaW4gZmFsbGJhY2ssIGFscmVhZHkgYWRqdXN0ZWQgYmFsYW5jZQogICAgY2xpZW50LnRyYW5zZmVyKGFtb3VudENudHIpOwogICAgQ2xpZW50UGF5bWVudEV2ZW50KGNsaWVudCwgQ2xpZW50UGF5bWVudEV2ZW50VHlwZS5XaXRoZHJhdywgQmFsYW5jZVR5cGUuQ250ciwgLWludChhbW91bnRDbnRyKSk7CiAgfQoKICAvLyBQdWJsaWMgRnVuZHMgTWFuaXB1bGF0aW9uIC0gZGVwb3NpdCBwcmV2aW91c2x5LWFwcHJvdmVkIHJld2FyZCB0b2tlbnMuCiAgLy8KICBmdW5jdGlvbiB0cmFuc2ZlckZyb21Sd3JkKCkgcHVibGljIHsKICAgIGFkZHJlc3MgY2xpZW50ID0gbXNnLnNlbmRlcjsKICAgIGFkZHJlc3MgYm9vayA9IGFkZHJlc3ModGhpcyk7CiAgICB1aW50IGFtb3VudFJ3cmQgPSByd3JkVG9rZW4uYWxsb3dhbmNlKGNsaWVudCwgYm9vayk7CiAgICByZXF1aXJlKGFtb3VudFJ3cmQgPiAwKTsKICAgIC8vIHdlIHdyb3RlIHRoZSByZXdhcmQgdG9rZW4gc28gd2Uga25vdyBpdCBzdXBwb3J0cyBFUkMyMCBwcm9wZXJseSBhbmQgaXMgbm90IGV2aWwKICAgIHJlcXVpcmUocndyZFRva2VuLnRyYW5zZmVyRnJvbShjbGllbnQsIGJvb2ssIGFtb3VudFJ3cmQpKTsKICAgIC8vIGJlbHQgYW5kIGJyYWNlcwogICAgYXNzZXJ0KHJ3cmRUb2tlbi5hbGxvd2FuY2UoY2xpZW50LCBib29rKSA9PSAwKTsKICAgIGJhbGFuY2VSd3JkRm9yQ2xpZW50W2NsaWVudF0gKz0gYW1vdW50UndyZDsKICAgIENsaWVudFBheW1lbnRFdmVudChjbGllbnQsIENsaWVudFBheW1lbnRFdmVudFR5cGUuVHJhbnNmZXJGcm9tLCBCYWxhbmNlVHlwZS5Sd3JkLCBpbnQoYW1vdW50UndyZCkpOwogIH0KCiAgLy8gUHVibGljIEZ1bmRzIE1hbmlwdWxhdGlvbiAtIHdpdGhkcmF3IGJhc2UgdG9rZW5zIChhcyBhIHRyYW5zZmVyKS4KICAvLwogIGZ1bmN0aW9uIHRyYW5zZmVyUndyZCh1aW50IGFtb3VudFJ3cmQpIHB1YmxpYyB7CiAgICBhZGRyZXNzIGNsaWVudCA9IG1zZy5zZW5kZXI7CiAgICByZXF1aXJlKGFtb3VudFJ3cmQgPiAwKTsKICAgIHJlcXVpcmUoYW1vdW50UndyZCA8PSBiYWxhbmNlUndyZEZvckNsaWVudFtjbGllbnRdKTsKICAgIC8vIG92ZXJmbG93IHNhZmUgLSBjaGVja2VkIGxlc3MgdGhhbiBiYWxhbmNlIGFib3ZlCiAgICBiYWxhbmNlUndyZEZvckNsaWVudFtjbGllbnRdIC09IGFtb3VudFJ3cmQ7CiAgICAvLyB3ZSB3cm90ZSB0aGUgcmV3YXJkIHRva2VuIHNvIHdlIGtub3cgaXQgc3VwcG9ydHMgRVJDMjAgcHJvcGVybHkgYW5kIGlzIG5vdCBldmlsCiAgICByZXF1aXJlKHJ3cmRUb2tlbi50cmFuc2ZlcihjbGllbnQsIGFtb3VudFJ3cmQpKTsKICAgIENsaWVudFBheW1lbnRFdmVudChjbGllbnQsIENsaWVudFBheW1lbnRFdmVudFR5cGUuVHJhbnNmZXIsIEJhbGFuY2VUeXBlLlJ3cmQsIC1pbnQoYW1vdW50UndyZCkpOwogIH0KCiAgLy8gUHVibGljIE9yZGVyIFZpZXcgLSBnZXQgZnVsbCBkZXRhaWxzIG9mIGFuIG9yZGVyLgogIC8vCiAgLy8gSWYgdGhlIG9yZGVySWQgZG9lcyBub3QgZXhpc3QsIHN0YXR1cyB3aWxsIGJlIFVua25vd24uCiAgLy8KICBmdW5jdGlvbiBnZXRPcmRlcih1aW50MTI4IG9yZGVySWQpIHB1YmxpYyBjb25zdGFudCByZXR1cm5zICgKICAgIGFkZHJlc3MgY2xpZW50LCB1aW50MTYgcHJpY2UsIHVpbnQgc2l6ZUJhc2UsIFRlcm1zIHRlcm1zLAogICAgU3RhdHVzIHN0YXR1cywgUmVhc29uQ29kZSByZWFzb25Db2RlLCB1aW50IGV4ZWN1dGVkQmFzZSwgdWludCBleGVjdXRlZENudHIsCiAgICB1aW50IGZlZXNCYXNlT3JDbnRyLCB1aW50IGZlZXNSd3JkKSB7CiAgICBPcmRlciBzdG9yYWdlIG9yZGVyID0gb3JkZXJGb3JPcmRlcklkW29yZGVySWRdOwogICAgcmV0dXJuIChvcmRlci5jbGllbnQsIG9yZGVyLnByaWNlLCBvcmRlci5zaXplQmFzZSwgb3JkZXIudGVybXMsCiAgICAgICAgICAgIG9yZGVyLnN0YXR1cywgb3JkZXIucmVhc29uQ29kZSwgb3JkZXIuZXhlY3V0ZWRCYXNlLCBvcmRlci5leGVjdXRlZENudHIsCiAgICAgICAgICAgIG9yZGVyLmZlZXNCYXNlT3JDbnRyLCBvcmRlci5mZWVzUndyZCk7CiAgfQoKICAvLyBQdWJsaWMgT3JkZXIgVmlldyAtIGdldCBtdXRhYmxlIGRldGFpbHMgb2YgYW4gb3JkZXIuCiAgLy8KICAvLyBJZiB0aGUgb3JkZXJJZCBkb2VzIG5vdCBleGlzdCwgc3RhdHVzIHdpbGwgYmUgVW5rbm93bi4KICAvLwogIGZ1bmN0aW9uIGdldE9yZGVyU3RhdGUodWludDEyOCBvcmRlcklkKSBwdWJsaWMgY29uc3RhbnQgcmV0dXJucyAoCiAgICBTdGF0dXMgc3RhdHVzLCBSZWFzb25Db2RlIHJlYXNvbkNvZGUsIHVpbnQgZXhlY3V0ZWRCYXNlLCB1aW50IGV4ZWN1dGVkQ250ciwKICAgIHVpbnQgZmVlc0Jhc2VPckNudHIsIHVpbnQgZmVlc1J3cmQpIHsKICAgIE9yZGVyIHN0b3JhZ2Ugb3JkZXIgPSBvcmRlckZvck9yZGVySWRbb3JkZXJJZF07CiAgICByZXR1cm4gKG9yZGVyLnN0YXR1cywgb3JkZXIucmVhc29uQ29kZSwgb3JkZXIuZXhlY3V0ZWRCYXNlLCBvcmRlci5leGVjdXRlZENudHIsCiAgICAgICAgICAgIG9yZGVyLmZlZXNCYXNlT3JDbnRyLCBvcmRlci5mZWVzUndyZCk7CiAgfQogIAogIC8vIFB1YmxpYyBPcmRlciBWaWV3IC0gZW51bWVyYXRlIGFsbCByZWNlbnQgb3JkZXJzICsgYWxsIG9wZW4gb3JkZXJzIGZvciBvbmUgY2xpZW50LgogIC8vCiAgLy8gTm90IHJlYWxseSBkZXNpZ25lZCBmb3IgdXNlIGZyb20gYSBzbWFydCBjb250cmFjdCB0cmFuc2FjdGlvbi4KICAvLwogIC8vIElkZWEgaXM6CiAgLy8gIC0gY2xpZW50IGVuc3VyZXMgb3JkZXIgaWRzIGFyZSBnZW5lcmF0ZWQgc28gdGhhdCBtb3N0LXNpZ25maWNhbnQgcGFydCBpcyB0aW1lLWJhc2VkOwogIC8vICAtIGNsaWVudCBkZWNpZGVzIHRoZXkgd2FudCBhbGwgb3JkZXJzIGFmdGVyIGEgY2VydGFpbiBwb2ludC1pbi10aW1lLAogIC8vICAgIGFuZCBjaG9vc2VzIG1pbkNsb3NlZE9yZGVySWRDdXRvZmYgYWNjb3JkaW5nbHk7CiAgLy8gIC0gYmVmb3JlIHRoYXQgcG9pbnQtaW4tdGltZSB0aGV5IGp1c3QgZ2V0IG9wZW4gYW5kIG5lZWRzIGdhcyBvcmRlcnMKICAvLyAgLSBjbGllbnQgY2FsbHMgd2Fsa0NsaWVudE9yZGVycyB3aXRoIG1heWJlTGFzdE9yZGVySWRSZXR1cm5lZCA9IDAgaW5pdGlhbGx5OwogIC8vICAtIHRoZW4gcmVwZWF0cyB3aXRoIHRoZSBvcmRlcklkIHJldHVybmVkIGJ5IHdhbGtDbGllbnRPcmRlcnM7CiAgLy8gIC0gKGFuZCBzdG9wcyBpZiBpdCByZXR1cm5zIGEgemVybyBvcmRlcklkKTsKICAvLwogIC8vIE5vdGUgdGhhdCBjbGllbnQgaXMgb25seSB1c2VkIHdoZW4gbWF5YmVMYXN0T3JkZXJJZFJldHVybmVkID0gMC4KICAvLwogIGZ1bmN0aW9uIHdhbGtDbGllbnRPcmRlcnMoCiAgICAgIGFkZHJlc3MgY2xpZW50LCB1aW50MTI4IG1heWJlTGFzdE9yZGVySWRSZXR1cm5lZCwgdWludDEyOCBtaW5DbG9zZWRPcmRlcklkQ3V0b2ZmCiAgICApIHB1YmxpYyBjb25zdGFudCByZXR1cm5zICgKICAgICAgdWludDEyOCBvcmRlcklkLCB1aW50MTYgcHJpY2UsIHVpbnQgc2l6ZUJhc2UsIFRlcm1zIHRlcm1zLAogICAgICBTdGF0dXMgc3RhdHVzLCBSZWFzb25Db2RlIHJlYXNvbkNvZGUsIHVpbnQgZXhlY3V0ZWRCYXNlLCB1aW50IGV4ZWN1dGVkQ250ciwKICAgICAgdWludCBmZWVzQmFzZU9yQ250ciwgdWludCBmZWVzUndyZCkgewogICAgaWYgKG1heWJlTGFzdE9yZGVySWRSZXR1cm5lZCA9PSAwKSB7CiAgICAgIG9yZGVySWQgPSBtb3N0UmVjZW50T3JkZXJJZEZvckNsaWVudFtjbGllbnRdOwogICAgfSBlbHNlIHsKICAgICAgb3JkZXJJZCA9IGNsaWVudFByZXZpb3VzT3JkZXJJZEJlZm9yZU9yZGVySWRbbWF5YmVMYXN0T3JkZXJJZFJldHVybmVkXTsKICAgIH0KICAgIHdoaWxlICh0cnVlKSB7CiAgICAgIGlmIChvcmRlcklkID09IDApIHJldHVybjsKICAgICAgT3JkZXIgc3RvcmFnZSBvcmRlciA9IG9yZGVyRm9yT3JkZXJJZFtvcmRlcklkXTsKICAgICAgaWYgKG9yZGVySWQgPj0gbWluQ2xvc2VkT3JkZXJJZEN1dG9mZikgYnJlYWs7CiAgICAgIGlmIChvcmRlci5zdGF0dXMgPT0gU3RhdHVzLk9wZW4gfHwgb3JkZXIuc3RhdHVzID09IFN0YXR1cy5OZWVkc0dhcykgYnJlYWs7CiAgICAgIG9yZGVySWQgPSBjbGllbnRQcmV2aW91c09yZGVySWRCZWZvcmVPcmRlcklkW29yZGVySWRdOwogICAgfQogICAgcmV0dXJuIChvcmRlcklkLCBvcmRlci5wcmljZSwgb3JkZXIuc2l6ZUJhc2UsIG9yZGVyLnRlcm1zLAogICAgICAgICAgICBvcmRlci5zdGF0dXMsIG9yZGVyLnJlYXNvbkNvZGUsIG9yZGVyLmV4ZWN1dGVkQmFzZSwgb3JkZXIuZXhlY3V0ZWRDbnRyLAogICAgICAgICAgICBvcmRlci5mZWVzQmFzZU9yQ250ciwgb3JkZXIuZmVlc1J3cmQpOwogIH0KIAogIC8vIEludGVybmFsIFByaWNlIENhbGN1bGF0aW9uIC0gdHVybiBwYWNrZWQgcHJpY2UgaW50byBhIGZyaWVuZGxpZXIgdW5wYWNrZWQgcHJpY2UuCiAgLy8KICBmdW5jdGlvbiB1bnBhY2tQcmljZSh1aW50MTYgcHJpY2UpIGludGVybmFsIGNvbnN0YW50IHJldHVybnMgKAogICAgICBEaXJlY3Rpb24gZGlyZWN0aW9uLCB1aW50MTYgbWFudGlzc2EsIGludDggZXhwb25lbnQKICAgICkgewogICAgdWludCBzaWRlZFByaWNlSW5kZXggPSB1aW50KHByaWNlKTsKICAgIHVpbnQgcHJpY2VJbmRleDsKICAgIGlmIChzaWRlZFByaWNlSW5kZXggPCAxIHx8IHNpZGVkUHJpY2VJbmRleCA+IG1heFNlbGxQcmljZSkgewogICAgICBkaXJlY3Rpb24gPSBEaXJlY3Rpb24uSW52YWxpZDsKICAgICAgbWFudGlzc2EgPSAwOwogICAgICBleHBvbmVudCA9IDA7CiAgICAgIHJldHVybjsKICAgIH0gZWxzZSBpZiAoc2lkZWRQcmljZUluZGV4IDw9IG1pbkJ1eVByaWNlKSB7CiAgICAgIGRpcmVjdGlvbiA9IERpcmVjdGlvbi5CdXk7CiAgICAgIHByaWNlSW5kZXggPSBtaW5CdXlQcmljZSAtIHNpZGVkUHJpY2VJbmRleDsKICAgIH0gZWxzZSB7CiAgICAgIGRpcmVjdGlvbiA9IERpcmVjdGlvbi5TZWxsOwogICAgICBwcmljZUluZGV4ID0gc2lkZWRQcmljZUluZGV4IC0gbWluU2VsbFByaWNlOwogICAgfQogICAgdWludCB6ZXJvQmFzZWRNYW50aXNzYSA9IHByaWNlSW5kZXggJSA5MDA7CiAgICB1aW50IHplcm9CYXNlZEV4cG9uZW50ID0gcHJpY2VJbmRleCAvIDkwMDsKICAgIG1hbnRpc3NhID0gdWludDE2KHplcm9CYXNlZE1hbnRpc3NhICsgMTAwKTsKICAgIGV4cG9uZW50ID0gaW50OCh6ZXJvQmFzZWRFeHBvbmVudCkgKyBtaW5QcmljZUV4cG9uZW50OwogICAgcmV0dXJuOwogIH0KICAKICAvLyBJbnRlcm5hbCBQcmljZSBDYWxjdWxhdGlvbiAtIGlzIGEgcGFja2VkIHByaWNlIG9uIHRoZSBidXkgc2lkZT8KICAvLwogIC8vIFRocm93cyBhbiBlcnJvciBpZiBwcmljZSBpcyBpbnZhbGlkLgogIC8vCiAgZnVuY3Rpb24gaXNCdXlQcmljZSh1aW50MTYgcHJpY2UpIGludGVybmFsIGNvbnN0YW50IHJldHVybnMgKGJvb2wgaXNCdXkpIHsKICAgIC8vIHllcywgdGhpcyBsb29rcyBvZGQsIGJ1dCBtYXggaGVyZSBpcyBoaWdoZXN0IF91bnBhY2tlZF8gcHJpY2UKICAgIHJldHVybiBwcmljZSA+PSBtYXhCdXlQcmljZSAmJiBwcmljZSA8PSBtaW5CdXlQcmljZTsKICB9CiAgCiAgLy8gSW50ZXJuYWwgUHJpY2UgQ2FsY3VsYXRpb24gLSB0dXJuIGEgcGFja2VkIGJ1eSBwcmljZSBpbnRvIGEgcGFja2VkIHNlbGwgcHJpY2UuCiAgLy8KICAvLyBJbnZhbGlkIHByaWNlIHJlbWFpbnMgaW52YWxpZC4KICAvLwogIGZ1bmN0aW9uIGNvbXB1dGVPcHBvc2l0ZVByaWNlKHVpbnQxNiBwcmljZSkgaW50ZXJuYWwgY29uc3RhbnQgcmV0dXJucyAodWludDE2IG9wcG9zaXRlKSB7CiAgICBpZiAocHJpY2UgPCBtYXhCdXlQcmljZSB8fCBwcmljZSA+IG1heFNlbGxQcmljZSkgewogICAgICByZXR1cm4gdWludDE2KGludmFsaWRQcmljZSk7CiAgICB9IGVsc2UgaWYgKHByaWNlIDw9IG1pbkJ1eVByaWNlKSB7CiAgICAgIHJldHVybiB1aW50MTYobWF4U2VsbFByaWNlIC0gKHByaWNlIC0gbWF4QnV5UHJpY2UpKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiB1aW50MTYobWF4QnV5UHJpY2UgKyAobWF4U2VsbFByaWNlIC0gcHJpY2UpKTsKICAgIH0KICB9CiAgCiAgLy8gSW50ZXJuYWwgUHJpY2UgQ2FsY3VsYXRpb24gLSBjb21wdXRlIGFtb3VudCBpbiBjb3VudGVyIGN1cnJlbmN5IHRoYXQgd291bGQKICAvLyBiZSBvYnRhaW5lZCBieSBzZWxsaW5nIGJhc2VBbW91bnQgYXQgdGhlIGdpdmVuIHVucGFja2VkIHByaWNlIChpZiBubyBmZWVzKS4KICAvLwogIC8vIE5vdGVzOgogIC8vICAtIERvZXMgbm90IHZhbGlkYXRlIHByaWNlIC0gY2FsbGVyIG11c3QgZW5zdXJlIHZhbGlkLgogIC8vICAtIENvdWxkIG92ZXJmbG93IHByb2R1Y2luZyB2ZXJ5IHVuZXhwZWN0ZWQgcmVzdWx0cyBpZiBiYXNlQW1vdW50IHZlcnkKICAvLyAgICBsYXJnZSAtIGNhbGxlciBtdXN0IGNoZWNrIHRoaXMuCiAgLy8gIC0gVGhpcyByb3VuZHMgdGhlIGFtb3VudCB0b3dhcmRzIHplcm8uCiAgLy8gIC0gTWF5IHRydW5jYXRlIHRvIHplcm8gaWYgYmFzZUFtb3VudCB2ZXJ5IHNtYWxsIC0gcG90ZW50aWFsbHkgYWxsb3dpbmcKICAvLyAgICB6ZXJvLWNvc3QgYnV5cyBvciBwb2ludGxlc3Mgc2FsZXMgLSBjYWxsZXIgbXVzdCBjaGVjayB0aGlzLgogIC8vCiAgZnVuY3Rpb24gY29tcHV0ZUNudHJBbW91bnRVc2luZ1VucGFja2VkKAogICAgICB1aW50IGJhc2VBbW91bnQsIHVpbnQxNiBtYW50aXNzYSwgaW50OCBleHBvbmVudAogICAgKSBpbnRlcm5hbCBjb25zdGFudCByZXR1cm5zICh1aW50IGNudHJBbW91bnQpIHsKICAgIGlmIChleHBvbmVudCA8IDApIHsKICAgICAgcmV0dXJuIGJhc2VBbW91bnQgKiB1aW50KG1hbnRpc3NhKSAvIDEwMDAgLyAxMCAqKiB1aW50KC1leHBvbmVudCk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gYmFzZUFtb3VudCAqIHVpbnQobWFudGlzc2EpIC8gMTAwMCAqIDEwICoqIHVpbnQoZXhwb25lbnQpOwogICAgfQogIH0KCiAgLy8gSW50ZXJuYWwgUHJpY2UgQ2FsY3VsYXRpb24gLSBjb21wdXRlIGFtb3VudCBpbiBjb3VudGVyIGN1cnJlbmN5IHRoYXQgd291bGQKICAvLyBiZSBvYnRhaW5lZCBieSBzZWxsaW5nIGJhc2VBbW91bnQgYXQgdGhlIGdpdmVuIHBhY2tlZCBwcmljZSAoaWYgbm8gZmVlcykuCiAgLy8KICAvLyBOb3RlczoKICAvLyAgLSBEb2VzIG5vdCB2YWxpZGF0ZSBwcmljZSAtIGNhbGxlciBtdXN0IGVuc3VyZSB2YWxpZC4KICAvLyAgLSBEaXJlY3Rpb24gb2YgdGhlIHBhY2tlZCBwcmljZSBpcyBpZ25vcmVkLgogIC8vICAtIENvdWxkIG92ZXJmbG93IHByb2R1Y2luZyB2ZXJ5IHVuZXhwZWN0ZWQgcmVzdWx0cyBpZiBiYXNlQW1vdW50IHZlcnkKICAvLyAgICBsYXJnZSAtIGNhbGxlciBtdXN0IGNoZWNrIHRoaXMuCiAgLy8gIC0gVGhpcyByb3VuZHMgdGhlIGFtb3VudCB0b3dhcmRzIHplcm8gKHJlZ2FyZGxlc3Mgb2YgQnV5IG9yIFNlbGwpLgogIC8vICAtIE1heSB0cnVuY2F0ZSB0byB6ZXJvIGlmIGJhc2VBbW91bnQgdmVyeSBzbWFsbCAtIHBvdGVudGlhbGx5IGFsbG93aW5nCiAgLy8gICAgemVyby1jb3N0IGJ1eXMgb3IgcG9pbnRsZXNzIHNhbGVzIC0gY2FsbGVyIG11c3QgY2hlY2sgdGhpcy4KICAvLwogIGZ1bmN0aW9uIGNvbXB1dGVDbnRyQW1vdW50VXNpbmdQYWNrZWQoCiAgICAgIHVpbnQgYmFzZUFtb3VudCwgdWludDE2IHByaWNlCiAgICApIGludGVybmFsIGNvbnN0YW50IHJldHVybnMgKHVpbnQpIHsKICAgIHZhciAoLCBtYW50aXNzYSwgZXhwb25lbnQpID0gdW5wYWNrUHJpY2UocHJpY2UpOwogICAgcmV0dXJuIGNvbXB1dGVDbnRyQW1vdW50VXNpbmdVbnBhY2tlZChiYXNlQW1vdW50LCBtYW50aXNzYSwgZXhwb25lbnQpOwogIH0KCiAgLy8gUHVibGljIE9yZGVyIFBsYWNlbWVudCAtIGNyZWF0ZSBvcmRlciBhbmQgdHJ5IHRvIG1hdGNoIGl0IGFuZC9vciBhZGQgaXQgdG8gdGhlIGJvb2suCiAgLy8KICBmdW5jdGlvbiBjcmVhdGVPcmRlcigKICAgICAgdWludDEyOCBvcmRlcklkLCB1aW50MTYgcHJpY2UsIHVpbnQgc2l6ZUJhc2UsIFRlcm1zIHRlcm1zLCB1aW50IG1heE1hdGNoZXMKICAgICkgcHVibGljIHsKICAgIGFkZHJlc3MgY2xpZW50ID0gbXNnLnNlbmRlcjsKICAgIHJlcXVpcmUob3JkZXJJZCAhPSAwICYmIG9yZGVyRm9yT3JkZXJJZFtvcmRlcklkXS5jbGllbnQgPT0gMCk7CiAgICBDbGllbnRPcmRlckV2ZW50KGNsaWVudCwgQ2xpZW50T3JkZXJFdmVudFR5cGUuQ3JlYXRlLCBvcmRlcklkLCBtYXhNYXRjaGVzKTsKICAgIG9yZGVyRm9yT3JkZXJJZFtvcmRlcklkXSA9CiAgICAgIE9yZGVyKGNsaWVudCwgcHJpY2UsIHNpemVCYXNlLCB0ZXJtcywgU3RhdHVzLlVua25vd24sIFJlYXNvbkNvZGUuTm9uZSwgMCwgMCwgMCwgMCk7CiAgICB1aW50MTI4IHByZXZpb3VzTW9zdFJlY2VudE9yZGVySWRGb3JDbGllbnQgPSBtb3N0UmVjZW50T3JkZXJJZEZvckNsaWVudFtjbGllbnRdOwogICAgbW9zdFJlY2VudE9yZGVySWRGb3JDbGllbnRbY2xpZW50XSA9IG9yZGVySWQ7CiAgICBjbGllbnRQcmV2aW91c09yZGVySWRCZWZvcmVPcmRlcklkW29yZGVySWRdID0gcHJldmlvdXNNb3N0UmVjZW50T3JkZXJJZEZvckNsaWVudDsKICAgIE9yZGVyIHN0b3JhZ2Ugb3JkZXIgPSBvcmRlckZvck9yZGVySWRbb3JkZXJJZF07CiAgICB2YXIgKGRpcmVjdGlvbiwgbWFudGlzc2EsIGV4cG9uZW50KSA9IHVucGFja1ByaWNlKHByaWNlKTsKICAgIGlmIChkaXJlY3Rpb24gPT0gRGlyZWN0aW9uLkludmFsaWQpIHsKICAgICAgb3JkZXIuc3RhdHVzID0gU3RhdHVzLlJlamVjdGVkOwogICAgICBvcmRlci5yZWFzb25Db2RlID0gUmVhc29uQ29kZS5JbnZhbGlkUHJpY2U7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmIChzaXplQmFzZSA8IGJhc2VNaW5Jbml0aWFsU2l6ZSB8fCBzaXplQmFzZSA+IGJhc2VNYXhTaXplKSB7CiAgICAgIG9yZGVyLnN0YXR1cyA9IFN0YXR1cy5SZWplY3RlZDsKICAgICAgb3JkZXIucmVhc29uQ29kZSA9IFJlYXNvbkNvZGUuSW52YWxpZFNpemU7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHVpbnQgc2l6ZUNudHIgPSBjb21wdXRlQ250ckFtb3VudFVzaW5nVW5wYWNrZWQoc2l6ZUJhc2UsIG1hbnRpc3NhLCBleHBvbmVudCk7CiAgICBpZiAoc2l6ZUNudHIgPCBjbnRyTWluSW5pdGlhbFNpemUgfHwgc2l6ZUNudHIgPiBjbnRyTWF4U2l6ZSkgewogICAgICBvcmRlci5zdGF0dXMgPSBTdGF0dXMuUmVqZWN0ZWQ7CiAgICAgIG9yZGVyLnJlYXNvbkNvZGUgPSBSZWFzb25Db2RlLkludmFsaWRTaXplOwogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAodGVybXMgPT0gVGVybXMuTWFrZXJPbmx5ICYmIG1heE1hdGNoZXMgIT0gMCkgewogICAgICBvcmRlci5zdGF0dXMgPSBTdGF0dXMuUmVqZWN0ZWQ7CiAgICAgIG9yZGVyLnJlYXNvbkNvZGUgPSBSZWFzb25Db2RlLkludmFsaWRUZXJtczsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKCFkZWJpdEZ1bmRzKGNsaWVudCwgZGlyZWN0aW9uLCBzaXplQmFzZSwgc2l6ZUNudHIpKSB7CiAgICAgIG9yZGVyLnN0YXR1cyA9IFN0YXR1cy5SZWplY3RlZDsKICAgICAgb3JkZXIucmVhc29uQ29kZSA9IFJlYXNvbkNvZGUuSW5zdWZmaWNpZW50RnVuZHM7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHByb2Nlc3NPcmRlcihvcmRlcklkLCBtYXhNYXRjaGVzKTsKICB9CgogIC8vIFB1YmxpYyBPcmRlciBQbGFjZW1lbnQgLSBjYW5jZWwgb3JkZXIKICAvLwogIGZ1bmN0aW9uIGNhbmNlbE9yZGVyKHVpbnQxMjggb3JkZXJJZCkgcHVibGljIHsKICAgIGFkZHJlc3MgY2xpZW50ID0gbXNnLnNlbmRlcjsKICAgIE9yZGVyIHN0b3JhZ2Ugb3JkZXIgPSBvcmRlckZvck9yZGVySWRbb3JkZXJJZF07CiAgICByZXF1aXJlKG9yZGVyLmNsaWVudCA9PSBjbGllbnQpOwogICAgU3RhdHVzIHN0YXR1cyA9IG9yZGVyLnN0YXR1czsKICAgIGlmIChzdGF0dXMgIT0gU3RhdHVzLk9wZW4gJiYgc3RhdHVzICE9IFN0YXR1cy5OZWVkc0dhcykgewogICAgICByZXR1cm47CiAgICB9CiAgICBDbGllbnRPcmRlckV2ZW50KGNsaWVudCwgQ2xpZW50T3JkZXJFdmVudFR5cGUuQ2FuY2VsLCBvcmRlcklkLCAwKTsKICAgIGlmIChzdGF0dXMgPT0gU3RhdHVzLk9wZW4pIHsKICAgICAgcmVtb3ZlT3Blbk9yZGVyRnJvbUJvb2sob3JkZXJJZCk7CiAgICAgIE1hcmtldE9yZGVyRXZlbnQoYmxvY2sudGltZXN0YW1wLCBvcmRlcklkLCBNYXJrZXRPcmRlckV2ZW50VHlwZS5SZW1vdmUsIG9yZGVyLnByaWNlLAogICAgICAgIG9yZGVyLnNpemVCYXNlIC0gb3JkZXIuZXhlY3V0ZWRCYXNlLCAwKTsKICAgIH0KICAgIHJlZnVuZFVubWF0Y2hlZEFuZEZpbmlzaChvcmRlcklkLCBTdGF0dXMuRG9uZSwgUmVhc29uQ29kZS5DbGllbnRDYW5jZWwpOwogIH0KCiAgLy8gUHVibGljIE9yZGVyIFBsYWNlbWVudCAtIGNvbnRpbnVlIHBsYWNpbmcgYW4gb3JkZXIgaW4gJ05lZWRzR2FzJyBzdGF0ZQogIC8vCiAgZnVuY3Rpb24gY29udGludWVPcmRlcih1aW50MTI4IG9yZGVySWQsIHVpbnQgbWF4TWF0Y2hlcykgcHVibGljIHsKICAgIGFkZHJlc3MgY2xpZW50ID0gbXNnLnNlbmRlcjsKICAgIE9yZGVyIHN0b3JhZ2Ugb3JkZXIgPSBvcmRlckZvck9yZGVySWRbb3JkZXJJZF07CiAgICByZXF1aXJlKG9yZGVyLmNsaWVudCA9PSBjbGllbnQpOwogICAgaWYgKG9yZGVyLnN0YXR1cyAhPSBTdGF0dXMuTmVlZHNHYXMpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgQ2xpZW50T3JkZXJFdmVudChjbGllbnQsIENsaWVudE9yZGVyRXZlbnRUeXBlLkNvbnRpbnVlLCBvcmRlcklkLCBtYXhNYXRjaGVzKTsKICAgIG9yZGVyLnN0YXR1cyA9IFN0YXR1cy5Vbmtub3duOwogICAgcHJvY2Vzc09yZGVyKG9yZGVySWQsIG1heE1hdGNoZXMpOwogIH0KCiAgLy8gSW50ZXJuYWwgT3JkZXIgUGxhY2VtZW50IC0gcmVtb3ZlIGEgc3RpbGwtb3BlbiBvcmRlciBmcm9tIHRoZSBib29rLgogIC8vCiAgLy8gQ2FsbGVyJ3Mgam9iIHRvIHVwZGF0ZS9yZWZ1bmQgdGhlIG9yZGVyICsgcmFpc2UgZXZlbnQsIHRoaXMganVzdAogIC8vIHVwZGF0ZXMgdGhlIG9yZGVyIGNoYWluIGFuZCBiaXRtYXNrLgogIC8vCiAgLy8gVG9vIGV4cGVuc2l2ZSB0byBkbyBvbiBlYWNoIHJlc3Rpbmcgb3JkZXIgbWF0Y2ggLSB3ZSBvbmx5IGRvIHRoaXMgZm9yIGFuCiAgLy8gb3JkZXIgYmVpbmcgY2FuY2VsbGVkLiBTZWUgbWF0Y2hXaXRoT2NjdXBpZWRQcmljZSBmb3Igc2ltaWxhciBsb2dpYy4KICAvLwogIGZ1bmN0aW9uIHJlbW92ZU9wZW5PcmRlckZyb21Cb29rKHVpbnQxMjggb3JkZXJJZCkgaW50ZXJuYWwgewogICAgT3JkZXIgc3RvcmFnZSBvcmRlciA9IG9yZGVyRm9yT3JkZXJJZFtvcmRlcklkXTsKICAgIHVpbnQxNiBwcmljZSA9IG9yZGVyLnByaWNlOwogICAgT3JkZXJDaGFpbiBzdG9yYWdlIG9yZGVyQ2hhaW4gPSBvcmRlckNoYWluRm9yT2NjdXBpZWRQcmljZVtwcmljZV07CiAgICBPcmRlckNoYWluTm9kZSBzdG9yYWdlIG9yZGVyQ2hhaW5Ob2RlID0gb3JkZXJDaGFpbk5vZGVGb3JPcGVuT3JkZXJJZFtvcmRlcklkXTsKICAgIHVpbnQxMjggbmV4dE9yZGVySWQgPSBvcmRlckNoYWluTm9kZS5uZXh0T3JkZXJJZDsKICAgIHVpbnQxMjggcHJldk9yZGVySWQgPSBvcmRlckNoYWluTm9kZS5wcmV2T3JkZXJJZDsKICAgIGlmIChuZXh0T3JkZXJJZCAhPSAwKSB7CiAgICAgIE9yZGVyQ2hhaW5Ob2RlIHN0b3JhZ2UgbmV4dE9yZGVyQ2hhaW5Ob2RlID0gb3JkZXJDaGFpbk5vZGVGb3JPcGVuT3JkZXJJZFtuZXh0T3JkZXJJZF07CiAgICAgIG5leHRPcmRlckNoYWluTm9kZS5wcmV2T3JkZXJJZCA9IHByZXZPcmRlcklkOwogICAgfSBlbHNlIHsKICAgICAgb3JkZXJDaGFpbi5sYXN0T3JkZXJJZCA9IHByZXZPcmRlcklkOwogICAgfQogICAgaWYgKHByZXZPcmRlcklkICE9IDApIHsKICAgICAgT3JkZXJDaGFpbk5vZGUgc3RvcmFnZSBwcmV2T3JkZXJDaGFpbk5vZGUgPSBvcmRlckNoYWluTm9kZUZvck9wZW5PcmRlcklkW3ByZXZPcmRlcklkXTsKICAgICAgcHJldk9yZGVyQ2hhaW5Ob2RlLm5leHRPcmRlcklkID0gbmV4dE9yZGVySWQ7CiAgICB9IGVsc2UgewogICAgICBvcmRlckNoYWluLmZpcnN0T3JkZXJJZCA9IG5leHRPcmRlcklkOwogICAgfQogICAgaWYgKG5leHRPcmRlcklkID09IDAgJiYgcHJldk9yZGVySWQgPT0gMCkgewogICAgICB1aW50IGJtaSA9IHByaWNlIC8gMjU2OyAgLy8gaW5kZXggaW50byBhcnJheSBvZiBiaXRtYXBzCiAgICAgIHVpbnQgYnRpID0gcHJpY2UgJSAyNTY7ICAvLyBiaXQgcG9zaXRpb24gd2l0aGluIGJpdG1hcAogICAgICAvLyB3ZSBrbm93IHdhcyBwcmV2aW91c2x5IG9jY3VwaWVkIHNvIFhPUiBjbGVhcnMKICAgICAgb2NjdXBpZWRQcmljZUJpdG1hcHNbYm1pXSBePSAyICoqIGJ0aTsKICAgIH0KICB9CgogIC8vIEludGVybmFsIE9yZGVyIFBsYWNlbWVudCAtIGNyZWRpdCBmdW5kcyByZWNlaXZlZCB3aGVuIHRha2luZyBsaXF1aWRpdHkgZnJvbSBib29rCiAgLy8KICBmdW5jdGlvbiBjcmVkaXRFeGVjdXRlZEZ1bmRzTGVzc0ZlZXModWludDEyOCBvcmRlcklkLCB1aW50IG9yaWdpbmFsRXhlY3V0ZWRCYXNlLCB1aW50IG9yaWdpbmFsRXhlY3V0ZWRDbnRyKSBpbnRlcm5hbCB7CiAgICBPcmRlciBzdG9yYWdlIG9yZGVyID0gb3JkZXJGb3JPcmRlcklkW29yZGVySWRdOwogICAgdWludCBsaXF1aWRpdHlUYWtlbkJhc2UgPSBvcmRlci5leGVjdXRlZEJhc2UgLSBvcmlnaW5hbEV4ZWN1dGVkQmFzZTsKICAgIHVpbnQgbGlxdWlkaXR5VGFrZW5DbnRyID0gb3JkZXIuZXhlY3V0ZWRDbnRyIC0gb3JpZ2luYWxFeGVjdXRlZENudHI7CiAgICAvLyBOb3JtYWxseSB3ZSBkZWR1Y3QgdGhlIGZlZSBmcm9tIHRoZSBjdXJyZW5jeSBib3VnaHQgKGJhc2UgZm9yIGJ1eSwgY250ciBmb3Igc2VsbCksCiAgICAvLyBob3dldmVyIHdlIGFsc28gYWNjZXB0IHJld2FyZCB0b2tlbnMgZnJvbSB0aGUgcmV3YXJkIGJhbGFuY2UgaWYgaXQgY292ZXJzIHRoZSBmZWUsCiAgICAvLyB3aXRoIHRoZSByZXdhcmQgYW1vdW50IGNvbnZlcnRlZCBmcm9tIHRoZSBFVEggYW1vdW50ICh0aGUgY291bnRlciBjdXJyZW5jeSBoZXJlKQogICAgLy8gYXQgYSBmaXhlZCBleGNoYW5nZSByYXRlLgogICAgLy8gT3ZlcmZsb3cgc2FmZSBzaW5jZSB3ZSBlbnN1cmUgb3JkZXIgc2l6ZSA8IDEwXjMwIGluIGJvdGggY3VycmVuY2llcyAoc2VlIGJhc2VNYXhTaXplKS4KICAgIC8vIENhbiB0cnVuY2F0ZSB0byB6ZXJvLCB3aGljaCBpcyBmaW5lLgogICAgdWludCBmZWVzUndyZCA9IGxpcXVpZGl0eVRha2VuQ250ciAvIGZlZURpdmlzb3IgKiBldGhSd3JkUmF0ZTsKICAgIHVpbnQgZmVlc0Jhc2VPckNudHI7CiAgICBhZGRyZXNzIGNsaWVudCA9IG9yZGVyLmNsaWVudDsKICAgIHVpbnQgYXZhaWxSd3JkID0gYmFsYW5jZVJ3cmRGb3JDbGllbnRbY2xpZW50XTsKICAgIGlmIChmZWVzUndyZCA8PSBhdmFpbFJ3cmQpIHsKICAgICAgYmFsYW5jZVJ3cmRGb3JDbGllbnRbY2xpZW50XSA9IGF2YWlsUndyZCAtIGZlZXNSd3JkOwogICAgICBiYWxhbmNlUndyZEZvckNsaWVudFtmZWVDb2xsZWN0b3JdID0gZmVlc1J3cmQ7CiAgICAgIC8vIE5lZWQgKz0gcmF0aGVyIHRoYW4gPSBiZWNhdXNlIGNvdWxkIGhhdmUgcGFpZCBzb21lIGZlZXMgZWFybGllciBpbiBOZWVkc0dhcyBzaXR1YXRpb24uCiAgICAgIC8vIE92ZXJmbG93IHNhZmUgc2luY2Ugd2UgZW5zdXJlIG9yZGVyIHNpemUgPCAxMF4zMCBpbiBib3RoIGN1cnJlbmNpZXMgKHNlZSBiYXNlTWF4U2l6ZSkuCiAgICAgIC8vIENhbiB0cnVuY2F0ZSB0byB6ZXJvLCB3aGljaCBpcyBmaW5lLgogICAgICBvcmRlci5mZWVzUndyZCArPSB1aW50MTI4KGZlZXNSd3JkKTsKICAgICAgaWYgKGlzQnV5UHJpY2Uob3JkZXIucHJpY2UpKSB7CiAgICAgICAgYmFsYW5jZUJhc2VGb3JDbGllbnRbY2xpZW50XSArPSBsaXF1aWRpdHlUYWtlbkJhc2U7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgYmFsYW5jZUNudHJGb3JDbGllbnRbY2xpZW50XSArPSBsaXF1aWRpdHlUYWtlbkNudHI7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoaXNCdXlQcmljZShvcmRlci5wcmljZSkpIHsKICAgICAgLy8gU2VlIGNvbW1lbnRzIGluIGJyYW5jaCBhYm92ZSByZTogdXNlIG9mICs9IGFuZCBvdmVyZmxvdyBzYWZldHkuCiAgICAgIGZlZXNCYXNlT3JDbnRyID0gbGlxdWlkaXR5VGFrZW5CYXNlIC8gZmVlRGl2aXNvcjsKICAgICAgYmFsYW5jZUJhc2VGb3JDbGllbnRbb3JkZXIuY2xpZW50XSArPSAobGlxdWlkaXR5VGFrZW5CYXNlIC0gZmVlc0Jhc2VPckNudHIpOwogICAgICBvcmRlci5mZWVzQmFzZU9yQ250ciArPSB1aW50MTI4KGZlZXNCYXNlT3JDbnRyKTsKICAgICAgYmFsYW5jZUJhc2VGb3JDbGllbnRbZmVlQ29sbGVjdG9yXSArPSBmZWVzQmFzZU9yQ250cjsKICAgIH0gZWxzZSB7CiAgICAgIC8vIFNlZSBjb21tZW50cyBpbiBicmFuY2ggYWJvdmUgcmU6IHVzZSBvZiArPSBhbmQgb3ZlcmZsb3cgc2FmZXR5LgogICAgICBmZWVzQmFzZU9yQ250ciA9IGxpcXVpZGl0eVRha2VuQ250ciAvIGZlZURpdmlzb3I7CiAgICAgIGJhbGFuY2VDbnRyRm9yQ2xpZW50W29yZGVyLmNsaWVudF0gKz0gKGxpcXVpZGl0eVRha2VuQ250ciAtIGZlZXNCYXNlT3JDbnRyKTsKICAgICAgb3JkZXIuZmVlc0Jhc2VPckNudHIgKz0gdWludDEyOChmZWVzQmFzZU9yQ250cik7CiAgICAgIGJhbGFuY2VDbnRyRm9yQ2xpZW50W2ZlZUNvbGxlY3Rvcl0gKz0gZmVlc0Jhc2VPckNudHI7CiAgICB9CiAgfQoKICAvLyBJbnRlcm5hbCBPcmRlciBQbGFjZW1lbnQgLSBwcm9jZXNzIGEgY3JlYXRlZCBhbmQgc2FuaXR5IGNoZWNrZWQgb3JkZXIuCiAgLy8KICAvLyBVc2VkIGJvdGggZm9yIG5ldyBvcmRlcnMgYW5kIGZvciBnYXMgdG9wdXAuCiAgLy8KICBmdW5jdGlvbiBwcm9jZXNzT3JkZXIodWludDEyOCBvcmRlcklkLCB1aW50IG1heE1hdGNoZXMpIGludGVybmFsIHsKICAgIE9yZGVyIHN0b3JhZ2Ugb3JkZXIgPSBvcmRlckZvck9yZGVySWRbb3JkZXJJZF07CgogICAgdWludCBvdXJPcmlnaW5hbEV4ZWN1dGVkQmFzZSA9IG9yZGVyLmV4ZWN1dGVkQmFzZTsKICAgIHVpbnQgb3VyT3JpZ2luYWxFeGVjdXRlZENudHIgPSBvcmRlci5leGVjdXRlZENudHI7CgogICAgdmFyIChvdXJEaXJlY3Rpb24sKSA9IHVucGFja1ByaWNlKG9yZGVyLnByaWNlKTsKICAgIHVpbnQgdGhlaXJQcmljZVN0YXJ0ID0gKG91ckRpcmVjdGlvbiA9PSBEaXJlY3Rpb24uQnV5KSA/IG1pblNlbGxQcmljZSA6IG1heEJ1eVByaWNlOwogICAgdWludCB0aGVpclByaWNlRW5kID0gY29tcHV0ZU9wcG9zaXRlUHJpY2Uob3JkZXIucHJpY2UpOwogICAKICAgIE1hdGNoU3RvcFJlYXNvbiBtYXRjaFN0b3BSZWFzb24gPQogICAgICBtYXRjaEFnYWluc3RCb29rKG9yZGVySWQsIHRoZWlyUHJpY2VTdGFydCwgdGhlaXJQcmljZUVuZCwgbWF4TWF0Y2hlcyk7CgogICAgY3JlZGl0RXhlY3V0ZWRGdW5kc0xlc3NGZWVzKG9yZGVySWQsIG91ck9yaWdpbmFsRXhlY3V0ZWRCYXNlLCBvdXJPcmlnaW5hbEV4ZWN1dGVkQ250cik7CgogICAgaWYgKG9yZGVyLnRlcm1zID09IFRlcm1zLkltbWVkaWF0ZU9yQ2FuY2VsKSB7CiAgICAgIGlmIChtYXRjaFN0b3BSZWFzb24gPT0gTWF0Y2hTdG9wUmVhc29uLlNhdGlzZmllZCkgewogICAgICAgIHJlZnVuZFVubWF0Y2hlZEFuZEZpbmlzaChvcmRlcklkLCBTdGF0dXMuRG9uZSwgUmVhc29uQ29kZS5Ob25lKTsKICAgICAgICByZXR1cm47CiAgICAgIH0gZWxzZSBpZiAobWF0Y2hTdG9wUmVhc29uID09IE1hdGNoU3RvcFJlYXNvbi5NYXhNYXRjaGVzKSB7CiAgICAgICAgcmVmdW5kVW5tYXRjaGVkQW5kRmluaXNoKG9yZGVySWQsIFN0YXR1cy5Eb25lLCBSZWFzb25Db2RlLlRvb01hbnlNYXRjaGVzKTsKICAgICAgICByZXR1cm47CiAgICAgIH0gZWxzZSBpZiAobWF0Y2hTdG9wUmVhc29uID09IE1hdGNoU3RvcFJlYXNvbi5Cb29rRXhoYXVzdGVkKSB7CiAgICAgICAgcmVmdW5kVW5tYXRjaGVkQW5kRmluaXNoKG9yZGVySWQsIFN0YXR1cy5Eb25lLCBSZWFzb25Db2RlLlVubWF0Y2hlZCk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICB9IGVsc2UgaWYgKG9yZGVyLnRlcm1zID09IFRlcm1zLk1ha2VyT25seSkgewogICAgICBpZiAobWF0Y2hTdG9wUmVhc29uID09IE1hdGNoU3RvcFJlYXNvbi5NYXhNYXRjaGVzKSB7CiAgICAgICAgcmVmdW5kVW5tYXRjaGVkQW5kRmluaXNoKG9yZGVySWQsIFN0YXR1cy5SZWplY3RlZCwgUmVhc29uQ29kZS5Xb3VsZFRha2UpOwogICAgICAgIHJldHVybjsKICAgICAgfSBlbHNlIGlmIChtYXRjaFN0b3BSZWFzb24gPT0gTWF0Y2hTdG9wUmVhc29uLkJvb2tFeGhhdXN0ZWQpIHsKICAgICAgICBlbnRlck9yZGVyKG9yZGVySWQpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgfSBlbHNlIGlmIChvcmRlci50ZXJtcyA9PSBUZXJtcy5HVENOb0dhc1RvcHVwKSB7CiAgICAgIGlmIChtYXRjaFN0b3BSZWFzb24gPT0gTWF0Y2hTdG9wUmVhc29uLlNhdGlzZmllZCkgewogICAgICAgIHJlZnVuZFVubWF0Y2hlZEFuZEZpbmlzaChvcmRlcklkLCBTdGF0dXMuRG9uZSwgUmVhc29uQ29kZS5Ob25lKTsKICAgICAgICByZXR1cm47CiAgICAgIH0gZWxzZSBpZiAobWF0Y2hTdG9wUmVhc29uID09IE1hdGNoU3RvcFJlYXNvbi5NYXhNYXRjaGVzKSB7CiAgICAgICAgcmVmdW5kVW5tYXRjaGVkQW5kRmluaXNoKG9yZGVySWQsIFN0YXR1cy5Eb25lLCBSZWFzb25Db2RlLlRvb01hbnlNYXRjaGVzKTsKICAgICAgICByZXR1cm47CiAgICAgIH0gZWxzZSBpZiAobWF0Y2hTdG9wUmVhc29uID09IE1hdGNoU3RvcFJlYXNvbi5Cb29rRXhoYXVzdGVkKSB7CiAgICAgICAgZW50ZXJPcmRlcihvcmRlcklkKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgIH0gZWxzZSBpZiAob3JkZXIudGVybXMgPT0gVGVybXMuR1RDV2l0aEdhc1RvcHVwKSB7CiAgICAgIGlmIChtYXRjaFN0b3BSZWFzb24gPT0gTWF0Y2hTdG9wUmVhc29uLlNhdGlzZmllZCkgewogICAgICAgIHJlZnVuZFVubWF0Y2hlZEFuZEZpbmlzaChvcmRlcklkLCBTdGF0dXMuRG9uZSwgUmVhc29uQ29kZS5Ob25lKTsKICAgICAgICByZXR1cm47CiAgICAgIH0gZWxzZSBpZiAobWF0Y2hTdG9wUmVhc29uID09IE1hdGNoU3RvcFJlYXNvbi5NYXhNYXRjaGVzKSB7CiAgICAgICAgb3JkZXIuc3RhdHVzID0gU3RhdHVzLk5lZWRzR2FzOwogICAgICAgIHJldHVybjsKICAgICAgfSBlbHNlIGlmIChtYXRjaFN0b3BSZWFzb24gPT0gTWF0Y2hTdG9wUmVhc29uLkJvb2tFeGhhdXN0ZWQpIHsKICAgICAgICBlbnRlck9yZGVyKG9yZGVySWQpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgfQogICAgYXNzZXJ0KGZhbHNlKTsgLy8gc2hvdWxkIG5vdCBiZSBwb3NzaWJsZSB0byByZWFjaCBoZXJlCiAgfQogCiAgLy8gVXNlZCBpbnRlcm5hbGx5IHRvIGluZGljYXRlIHdoeSB3ZSBzdG9wcGVkIG1hdGNoaW5nIGFuIG9yZGVyIGFnYWluc3QgdGhlIGJvb2suCgogIGVudW0gTWF0Y2hTdG9wUmVhc29uIHsKICAgIE5vbmUsCiAgICBNYXhNYXRjaGVzLAogICAgU2F0aXNmaWVkLAogICAgUHJpY2VFeGhhdXN0ZWQsCiAgICBCb29rRXhoYXVzdGVkCiAgfQogCiAgLy8gSW50ZXJuYWwgT3JkZXIgUGxhY2VtZW50IC0gTWF0Y2ggdGhlIGdpdmVuIG9yZGVyIGFnYWluc3QgdGhlIGJvb2suCiAgLy8KICAvLyBSZXN0aW5nIG9yZGVycyBtYXRjaGVkIHdpbGwgYmUgdXBkYXRlZCwgcmVtb3ZlZCBmcm9tIGJvb2sgYW5kIGZ1bmRzIGNyZWRpdGVkIHRvIHRoZWlyIG93bmVycy4KICAvLwogIC8vIE9ubHkgdXBkYXRlcyB0aGUgZXhlY3V0ZWRCYXNlIGFuZCBleGVjdXRlZENudHIgb2YgdGhlIGdpdmVuIG9yZGVyIC0gY2FsbGVyIGlzIHJlc3BvbnNpYmxlCiAgLy8gZm9yIGNyZWRpdGluZyBtYXRjaGVkIGZ1bmRzLCBjaGFyZ2luZyBmZWVzLCBtYXJraW5nIG9yZGVyIGFzIGRvbmUgLyBlbnRlcmluZyBpdCBpbnRvIHRoZSBib29rLgogIC8vCiAgLy8gbWF0Y2hTdG9wUmVhc29uIHJldHVybmVkIHdpbGwgYmUgb25lIG9mIE1heE1hdGNoZXMsIFNhdGlzZmllZCBvciBCb29rRXhoYXVzdGVkLgogIC8vCiAgLy8gQ2FsbGluZyB3aXRoIG1heE1hdGNoZXMgPT0gMCBpcyBvayAtIGFuZCBleHBlY3RlZCB3aGVuIHRoZSBvcmRlciBpcyBhIG1ha2VyLW9ubHkgb3JkZXIuCiAgLy8KICBmdW5jdGlvbiBtYXRjaEFnYWluc3RCb29rKAogICAgICB1aW50MTI4IG9yZGVySWQsIHVpbnQgdGhlaXJQcmljZVN0YXJ0LCB1aW50IHRoZWlyUHJpY2VFbmQsIHVpbnQgbWF4TWF0Y2hlcwogICAgKSBpbnRlcm5hbCByZXR1cm5zICgKICAgICAgTWF0Y2hTdG9wUmVhc29uIG1hdGNoU3RvcFJlYXNvbgogICAgKSB7CiAgICBPcmRlciBzdG9yYWdlIG9yZGVyID0gb3JkZXJGb3JPcmRlcklkW29yZGVySWRdOwogICAgCiAgICB1aW50IGJtaSA9IHRoZWlyUHJpY2VTdGFydCAvIDI1NjsgIC8vIGluZGV4IGludG8gYXJyYXkgb2YgYml0bWFwcwogICAgdWludCBidGkgPSB0aGVpclByaWNlU3RhcnQgJSAyNTY7ICAvLyBiaXQgcG9zaXRpb24gd2l0aGluIGJpdG1hcAogICAgdWludCBibWlFbmQgPSB0aGVpclByaWNlRW5kIC8gMjU2OyAvLyBsYXN0IGJpdG1hcCB0byBzZWFyY2gKICAgIHVpbnQgYnRpRW5kID0gdGhlaXJQcmljZUVuZCAlIDI1NjsgLy8gc3RvcCBhdCB0aGlzIGJpdCBpbiB0aGUgbGFzdCBiaXRtYXAKCiAgICB1aW50IGNibSA9IG9jY3VwaWVkUHJpY2VCaXRtYXBzW2JtaV07IC8vIG9yaWdpbmFsIGNvcHkgb2YgY3VycmVudCBiaXRtYXAKICAgIHVpbnQgZGJtID0gY2JtOyAvLyBkaXJ0eSB2ZXJzaW9uIG9mIGN1cnJlbnQgYml0bWFwIHdoZXJlIHdlIG1heSBoYXZlIGNsZWFyZWQgYml0cwogICAgdWludCB3Ym0gPSBjYm0gPj4gYnRpOyAvLyB3b3JraW5nIGNvcHkgb2YgY3VycmVudCBiaXRtYXAgd2hpY2ggd2Uga2VlcCBzaGlmdGluZwogICAgCiAgICAvLyB0aGVzZSBsb29wcyBhcmUgcHJldHR5IHVnbHksIGFuZCBzb21ld2hhdCB1bnByZWRpY2F0YWJsZSBpbiB0ZXJtcyBvZiBnYXMsCiAgICAvLyAuLi4gYnV0IG5vLW9uZSBlbHNlIGhhcyBjb21lIHVwIHdpdGggYSBiZXR0ZXIgbWF0Y2hpbmcgZW5naW5lIHlldCEKCiAgICBib29sIHJlbW92ZWRMYXN0QXRQcmljZTsKICAgIG1hdGNoU3RvcFJlYXNvbiA9IE1hdGNoU3RvcFJlYXNvbi5Ob25lOwoKICAgIHdoaWxlIChibWkgPCBibWlFbmQpIHsKICAgICAgaWYgKHdibSA9PSAwIHx8IGJ0aSA9PSAyNTYpIHsKICAgICAgICBpZiAoZGJtICE9IGNibSkgewogICAgICAgICAgb2NjdXBpZWRQcmljZUJpdG1hcHNbYm1pXSA9IGRibTsKICAgICAgICB9CiAgICAgICAgYnRpID0gMDsKICAgICAgICBibWkrKzsKICAgICAgICBjYm0gPSBvY2N1cGllZFByaWNlQml0bWFwc1tibWldOwogICAgICAgIHdibSA9IGNibTsKICAgICAgICBkYm0gPSBjYm07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKCh3Ym0gJiAxKSAhPSAwKSB7CiAgICAgICAgICAvLyBjYXJlZnVsIC0gY29weS1hbmQtcGFzdGVkIGluIGxvb3AgYmVsb3cgLi4uCiAgICAgICAgICAocmVtb3ZlZExhc3RBdFByaWNlLCBtYXhNYXRjaGVzLCBtYXRjaFN0b3BSZWFzb24pID0KICAgICAgICAgICAgbWF0Y2hXaXRoT2NjdXBpZWRQcmljZShvcmRlciwgdWludDE2KGJtaSAqIDI1NiArIGJ0aSksIG1heE1hdGNoZXMpOwogICAgICAgICAgaWYgKHJlbW92ZWRMYXN0QXRQcmljZSkgewogICAgICAgICAgICBkYm0gXj0gMiAqKiBidGk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobWF0Y2hTdG9wUmVhc29uID09IE1hdGNoU3RvcFJlYXNvbi5QcmljZUV4aGF1c3RlZCkgewogICAgICAgICAgICBtYXRjaFN0b3BSZWFzb24gPSBNYXRjaFN0b3BSZWFzb24uTm9uZTsKICAgICAgICAgIH0gZWxzZSBpZiAobWF0Y2hTdG9wUmVhc29uICE9IE1hdGNoU3RvcFJlYXNvbi5Ob25lKSB7CiAgICAgICAgICAgIC8vIHdlIG1pZ2h0IHN0aWxsIGhhdmUgY2hhbmdlcyBpbiBkYm0gdG8gd3JpdGUgYmFjayAtIHNlZSBsYXRlcgogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgYnRpICs9IDE7CiAgICAgICAgd2JtIC89IDI7CiAgICAgIH0KICAgIH0KICAgIGlmIChtYXRjaFN0b3BSZWFzb24gPT0gTWF0Y2hTdG9wUmVhc29uLk5vbmUpIHsKICAgICAgLy8gd2UndmUgcmVhY2hlZCB0aGUgbGFzdCBiaXRtYXAgd2UgbmVlZCB0byBzZWFyY2gsCiAgICAgIC8vIHdlJ2xsIHN0b3AgYXQgYnRpRW5kIG5vdCAyNTYgdGhpcyB0aW1lLgogICAgICB3aGlsZSAoYnRpIDw9IGJ0aUVuZCAmJiB3Ym0gIT0gMCkgewogICAgICAgIGlmICgod2JtICYgMSkgIT0gMCkgewogICAgICAgICAgLy8gY2FyZWZ1bCAtIGNvcHktYW5kLXBhc3RlZCBpbiBsb29wIGFib3ZlIC4uLgogICAgICAgICAgKHJlbW92ZWRMYXN0QXRQcmljZSwgbWF4TWF0Y2hlcywgbWF0Y2hTdG9wUmVhc29uKSA9CiAgICAgICAgICAgIG1hdGNoV2l0aE9jY3VwaWVkUHJpY2Uob3JkZXIsIHVpbnQxNihibWkgKiAyNTYgKyBidGkpLCBtYXhNYXRjaGVzKTsKICAgICAgICAgIGlmIChyZW1vdmVkTGFzdEF0UHJpY2UpIHsKICAgICAgICAgICAgZGJtIF49IDIgKiogYnRpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKG1hdGNoU3RvcFJlYXNvbiA9PSBNYXRjaFN0b3BSZWFzb24uUHJpY2VFeGhhdXN0ZWQpIHsKICAgICAgICAgICAgbWF0Y2hTdG9wUmVhc29uID0gTWF0Y2hTdG9wUmVhc29uLk5vbmU7CiAgICAgICAgICB9IGVsc2UgaWYgKG1hdGNoU3RvcFJlYXNvbiAhPSBNYXRjaFN0b3BSZWFzb24uTm9uZSkgewogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgYnRpICs9IDE7CiAgICAgICAgd2JtIC89IDI7CiAgICAgIH0KICAgIH0KICAgIC8vIENhcmVmdWwgLSBpZiB3ZSBleGl0ZWQgdGhlIGZpcnN0IGxvb3AgZWFybHksIG9yIHdlIHdlbnQgaW50byB0aGUgc2Vjb25kIGxvb3AsCiAgICAvLyAobHVja2lseSBjYW4ndCBib3RoIGhhcHBlbikgdGhlbiB3ZSBoYXZlbid0IGZsdXNoZWQgdGhlIGRpcnR5IGJpdG1hcCBiYWNrIHRvCiAgICAvLyBzdG9yYWdlIC0gZG8gdGhhdCBub3cgaWYgd2UgbmVlZCB0by4KICAgIGlmIChkYm0gIT0gY2JtKSB7CiAgICAgIG9jY3VwaWVkUHJpY2VCaXRtYXBzW2JtaV0gPSBkYm07CiAgICB9CiAgICBpZiAobWF0Y2hTdG9wUmVhc29uID09IE1hdGNoU3RvcFJlYXNvbi5Ob25lKSB7CiAgICAgIG1hdGNoU3RvcFJlYXNvbiA9IE1hdGNoU3RvcFJlYXNvbi5Cb29rRXhoYXVzdGVkOwogICAgfQogIH0KCiAgLy8gSW50ZXJuYWwgT3JkZXIgUGxhY2VtZW50LgogIC8vCiAgLy8gTWF0Y2ggb3VyIG9yZGVyIGFnYWluc3QgdXAgdG8gbWF4TWF0Y2hlcyByZXN0aW5nIG9yZGVycyBhdCB0aGUgZ2l2ZW4gcHJpY2UgKHdoaWNoCiAgLy8gaXMga25vd24gYnkgdGhlIGNhbGxlciB0byBoYXZlIGF0IGxlYXN0IG9uZSByZXN0aW5nIG9yZGVyKS4KICAvLwogIC8vIFRoZSBtYXRjaGVzIChwYXJ0aWFsIG9yIGNvbXBsZXRlKSBvZiB0aGUgcmVzdGluZyBvcmRlcnMgYXJlIHJlY29yZGVkLCBhbmQgdGhlaXIKICAvLyBmdW5kcyBhcmUgY3JlZGl0ZWQuCiAgLy8KICAvLyBUaGUgb3JkZXIgY2hhaW4gZm9yIHRoZSByZXN0aW5nIG9yZGVycyBpcyB1cGRhdGVkLCBidXQgdGhlIG9jY3VwaWVkIHByaWNlIGJpdG1hcCBpcyBOT1QgLQogIC8vIHRoZSBjYWxsZXIgbXVzdCBjbGVhciB0aGUgcmVsZXZhbnQgYml0IGlmIHJlbW92ZWRMYXN0QXRQcmljZSA9IHRydWUgaXMgcmV0dXJuZWQuCiAgLy8KICAvLyBPbmx5IHVwZGF0ZXMgdGhlIGV4ZWN1dGVkQmFzZSBhbmQgZXhlY3V0ZWRDbnRyIG9mIG91ciBvcmRlciAtIGNhbGxlciBpcyByZXNwb25zaWJsZQogIC8vIGZvciBlLmcuIGNyZWRpdGluZyBvdXIgbWF0Y2hlZCBmdW5kcywgdXBkYXRpbmcgc3RhdHVzLgogIC8vCiAgLy8gQ2FsbGluZyB3aXRoIG1heE1hdGNoZXMgPT0gMCBpcyBvayAtIGFuZCBleHBlY3RlZCB3aGVuIHRoZSBvcmRlciBpcyBhIG1ha2VyLW9ubHkgb3JkZXIuCiAgLy8KICAvLyBSZXR1cm5zOgogIC8vICAgcmVtb3ZlZExhc3RBdFByaWNlOgogIC8vICAgICB0cnVlIGlmZiB0aGVyZSBhcmUgbm8gbG9uZ2VyIGFueSByZXN0aW5nIG9yZGVycyBhdCB0aGlzIHByaWNlIC0gY2FsbGVyIHdpbGwgbmVlZAogIC8vICAgICB0byB1cGRhdGUgdGhlIG9jY3VwaWVkIHByaWNlIGJpdG1hcC4KICAvLwogIC8vICAgbWF0Y2hlc0xlZnQ6CiAgLy8gICAgIG1heE1hdGNoZXMgcGFzc2VkIGluIG1pbnVzIHRoZSBudW1iZXIgb2YgbWF0Y2hlcyBtYWRlIGJ5IHRoaXMgY2FsbAogIC8vCiAgLy8gICBtYXRjaFN0b3BSZWFzb246CiAgLy8gICAgIElmIG91ciBvcmRlciBpcyBjb21wbGV0ZWx5IG1hdGNoZWQsIG1hdGNoU3RvcFJlYXNvbiB3aWxsIGJlIFNhdGlzZmllZC4KICAvLyAgICAgSWYgb3VyIG9yZGVyIGlzIG5vdCBjb21wbGV0ZWx5IG1hdGNoZWQsIG1hdGNoU3RvcFJlYXNvbiB3aWxsIGJlIGVpdGhlcjoKICAvLyAgICAgICAgTWF4TWF0Y2hlcyAod2UgYXJlIG5vdCBhbGxvd2VkIHRvIG1hdGNoIGFueSBtb3JlIHRpbWVzKQogIC8vICAgICBvcjoKICAvLyAgICAgICAgUHJpY2VFeGhhdXN0ZWQgKG5vdGhpbmcgbGVmdCBvbiB0aGUgYm9vayBhdCB0aGlzIGV4YWN0IHByaWNlKQogIC8vCiAgZnVuY3Rpb24gbWF0Y2hXaXRoT2NjdXBpZWRQcmljZSgKICAgICAgT3JkZXIgc3RvcmFnZSBvdXJPcmRlciwgdWludDE2IHRoZWlyUHJpY2UsIHVpbnQgbWF4TWF0Y2hlcwogICAgKSBpbnRlcm5hbCByZXR1cm5zICgKICAgIGJvb2wgcmVtb3ZlZExhc3RBdFByaWNlLCB1aW50IG1hdGNoZXNMZWZ0LCBNYXRjaFN0b3BSZWFzb24gbWF0Y2hTdG9wUmVhc29uKSB7CiAgICBtYXRjaGVzTGVmdCA9IG1heE1hdGNoZXM7CiAgICB1aW50IHdvcmtpbmdPdXJFeGVjdXRlZEJhc2UgPSBvdXJPcmRlci5leGVjdXRlZEJhc2U7CiAgICB1aW50IHdvcmtpbmdPdXJFeGVjdXRlZENudHIgPSBvdXJPcmRlci5leGVjdXRlZENudHI7CiAgICB1aW50MTI4IHRoZWlyT3JkZXJJZCA9IG9yZGVyQ2hhaW5Gb3JPY2N1cGllZFByaWNlW3RoZWlyUHJpY2VdLmZpcnN0T3JkZXJJZDsKICAgIG1hdGNoU3RvcFJlYXNvbiA9IE1hdGNoU3RvcFJlYXNvbi5Ob25lOwogICAgd2hpbGUgKHRydWUpIHsKICAgICAgaWYgKG1hdGNoZXNMZWZ0ID09IDApIHsKICAgICAgICBtYXRjaFN0b3BSZWFzb24gPSBNYXRjaFN0b3BSZWFzb24uTWF4TWF0Y2hlczsKICAgICAgICBicmVhazsKICAgICAgfQogICAgICB1aW50IG1hdGNoQmFzZTsKICAgICAgdWludCBtYXRjaENudHI7CiAgICAgICh0aGVpck9yZGVySWQsIG1hdGNoQmFzZSwgbWF0Y2hDbnRyLCBtYXRjaFN0b3BSZWFzb24pID0KICAgICAgICBtYXRjaFdpdGhUaGVpcnMoKG91ck9yZGVyLnNpemVCYXNlIC0gd29ya2luZ091ckV4ZWN1dGVkQmFzZSksIHRoZWlyT3JkZXJJZCwgdGhlaXJQcmljZSk7CiAgICAgIHdvcmtpbmdPdXJFeGVjdXRlZEJhc2UgKz0gbWF0Y2hCYXNlOwogICAgICB3b3JraW5nT3VyRXhlY3V0ZWRDbnRyICs9IG1hdGNoQ250cjsKICAgICAgbWF0Y2hlc0xlZnQgLT0gMTsKICAgICAgaWYgKG1hdGNoU3RvcFJlYXNvbiAhPSBNYXRjaFN0b3BSZWFzb24uTm9uZSkgewogICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CiAgICBvdXJPcmRlci5leGVjdXRlZEJhc2UgPSB1aW50MTI4KHdvcmtpbmdPdXJFeGVjdXRlZEJhc2UpOwogICAgb3VyT3JkZXIuZXhlY3V0ZWRDbnRyID0gdWludDEyOCh3b3JraW5nT3VyRXhlY3V0ZWRDbnRyKTsKICAgIGlmICh0aGVpck9yZGVySWQgPT0gMCkgewogICAgICBvcmRlckNoYWluRm9yT2NjdXBpZWRQcmljZVt0aGVpclByaWNlXS5maXJzdE9yZGVySWQgPSAwOwogICAgICBvcmRlckNoYWluRm9yT2NjdXBpZWRQcmljZVt0aGVpclByaWNlXS5sYXN0T3JkZXJJZCA9IDA7CiAgICAgIHJlbW92ZWRMYXN0QXRQcmljZSA9IHRydWU7CiAgICB9IGVsc2UgewogICAgICAvLyBOQjogaW4gc29tZSBjYXNlcyAoZS5nLiBtYXhNYXRjaGVzID09IDApIHRoaXMgaXMgYSBuby1vcC4KICAgICAgb3JkZXJDaGFpbkZvck9jY3VwaWVkUHJpY2VbdGhlaXJQcmljZV0uZmlyc3RPcmRlcklkID0gdGhlaXJPcmRlcklkOwogICAgICBvcmRlckNoYWluTm9kZUZvck9wZW5PcmRlcklkW3RoZWlyT3JkZXJJZF0ucHJldk9yZGVySWQgPSAwOwogICAgICByZW1vdmVkTGFzdEF0UHJpY2UgPSBmYWxzZTsKICAgIH0KICB9CiAgCiAgLy8gSW50ZXJuYWwgT3JkZXIgUGxhY2VtZW50LgogIC8vCiAgLy8gTWF0Y2ggdXAgdG8gb3VyIHJlbWFpbmluZyBhbW91bnQgYWdhaW5zdCBhIHJlc3Rpbmcgb3JkZXIgaW4gdGhlIGJvb2suCiAgLy8KICAvLyBUaGUgbWF0Y2ggKHBhcnRpYWwsIGNvbXBsZXRlIG9yIGVmZmVjdGl2ZWx5LWNvbXBsZXRlKSBvZiB0aGUgcmVzdGluZyBvcmRlcgogIC8vIGlzIHJlY29yZGVkLCBhbmQgdGhlaXIgZnVuZHMgYXJlIGNyZWRpdGVkLgogIC8vCiAgLy8gVGhlaXIgb3JkZXIgaXMgTk9UIHJlbW92ZWQgZnJvbSB0aGUgYm9vayBieSB0aGlzIGNhbGwgLSB0aGUgY2FsbGVyIG11c3QgZG8gdGhhdAogIC8vIGlmIHRoZSBuZXh0VGhlaXJPcmRlcklkIHJldHVybmVkIGlzIG5vdCBlcXVhbCB0byB0aGUgdGhlaXJPcmRlcklkIHBhc3NlZCBpbi4KICAvLwogIC8vIFJldHVybnM6CiAgLy8KICAvLyAgIG5leHRUaGVpck9yZGVySWQ6CiAgLy8gICAgIElmIHdlIGRpZCBub3QgY29tcGxldGVseSBtYXRjaCB0aGVpciBvcmRlciwgd2lsbCBiZSBzYW1lIGFzIHRoZWlyT3JkZXJJZC4KICAvLyAgICAgSWYgd2UgY29tcGxldGVseSBtYXRjaGVkIHRoZWlyIG9yZGVyLCB3aWxsIGJlIG9yZGVySWQgb2YgbmV4dCBvcmRlciBhdCB0aGUKICAvLyAgICAgc2FtZSBwcmljZSAtIG9yIHplcm8gaWYgdGhpcyB3YXMgdGhlIGxhc3Qgb3JkZXIgYW5kIHdlJ3ZlIG5vdyBmaWxsZWQgaXQuCiAgLy8KICAvLyAgIG1hdGNoU3RvcFJlYXNvbjoKICAvLyAgICAgSWYgb3VyIG9yZGVyIGlzIGNvbXBsZXRlbHkgbWF0Y2hlZCwgbWF0Y2hTdG9wUmVhc29uIHdpbGwgYmUgU2F0aXNmaWVkLgogIC8vICAgICBJZiBvdXIgb3JkZXIgaXMgbm90IGNvbXBsZXRlbHkgbWF0Y2hlZCwgbWF0Y2hTdG9wUmVhc29uIHdpbGwgYmUgZWl0aGVyCiAgLy8gICAgIFByaWNlRXhoYXVzdGVkIChpZiBub3RoaW5nIGxlZnQgYXQgdGhpcyBleGFjdCBwcmljZSkgb3IgTm9uZSAoaWYgY2FuIGNvbnRpbnVlKS4KICAvLyAKICBmdW5jdGlvbiBtYXRjaFdpdGhUaGVpcnMoCiAgICB1aW50IG91clJlbWFpbmluZ0Jhc2UsIHVpbnQxMjggdGhlaXJPcmRlcklkLCB1aW50MTYgdGhlaXJQcmljZSkgaW50ZXJuYWwgcmV0dXJucyAoCiAgICB1aW50MTI4IG5leHRUaGVpck9yZGVySWQsIHVpbnQgbWF0Y2hCYXNlLCB1aW50IG1hdGNoQ250ciwgTWF0Y2hTdG9wUmVhc29uIG1hdGNoU3RvcFJlYXNvbikgewogICAgT3JkZXIgc3RvcmFnZSB0aGVpck9yZGVyID0gb3JkZXJGb3JPcmRlcklkW3RoZWlyT3JkZXJJZF07CiAgICB1aW50IHRoZWlyUmVtYWluaW5nQmFzZSA9IHRoZWlyT3JkZXIuc2l6ZUJhc2UgLSB0aGVpck9yZGVyLmV4ZWN1dGVkQmFzZTsKICAgIGlmIChvdXJSZW1haW5pbmdCYXNlIDwgdGhlaXJSZW1haW5pbmdCYXNlKSB7CiAgICAgIG1hdGNoQmFzZSA9IG91clJlbWFpbmluZ0Jhc2U7CiAgICB9IGVsc2UgewogICAgICBtYXRjaEJhc2UgPSB0aGVpclJlbWFpbmluZ0Jhc2U7CiAgICB9CiAgICBtYXRjaENudHIgPSBjb21wdXRlQ250ckFtb3VudFVzaW5nUGFja2VkKG1hdGNoQmFzZSwgdGhlaXJQcmljZSk7CiAgICAvLyBJdCBtYXkgc2VlbSBhIGJpdCBvZGQgdG8gc3RvcCBoZXJlIGlmIG91ciByZW1haW5pbmcgYW1vdW50IGlzIHZlcnkgc21hbGwgLQogICAgLy8gdGhlcmUgY291bGQgc3RpbGwgYmUgcmVzdGluZyBvcmRlcnMgd2UgY2FuIG1hdGNoIGl0IGFnYWluc3QuIEJ1dCB0aGUgZ2FzCiAgICAvLyBjb3N0IG9mIG1hdGNoaW5nIGVhY2ggb3JkZXIgaXMgcXVpdGUgaGlnaCAtIHBvdGVudGlhbGx5IGhpZ2ggZW5vdWdoIHRvCiAgICAvLyB3aXBlIG91dCB0aGUgcHJvZml0IHRoZSB0YWtlciBob3BlcyBmb3IgZnJvbSB0cmFkaW5nIHRoZSB0aW55IGFtb3VudCBsZWZ0LgogICAgaWYgKChvdXJSZW1haW5pbmdCYXNlIC0gbWF0Y2hCYXNlKSA8IGJhc2VNaW5SZW1haW5pbmdTaXplKSB7CiAgICAgIG1hdGNoU3RvcFJlYXNvbiA9IE1hdGNoU3RvcFJlYXNvbi5TYXRpc2ZpZWQ7CiAgICB9IGVsc2UgewogICAgICBtYXRjaFN0b3BSZWFzb24gPSBNYXRjaFN0b3BSZWFzb24uTm9uZTsKICAgIH0KICAgIGJvb2wgdGhlaXJzRGVhZCA9IHJlY29yZFRoZWlyTWF0Y2godGhlaXJPcmRlciwgdGhlaXJPcmRlcklkLCB0aGVpclByaWNlLCBtYXRjaEJhc2UsIG1hdGNoQ250cik7CiAgICBpZiAodGhlaXJzRGVhZCkgewogICAgICBuZXh0VGhlaXJPcmRlcklkID0gb3JkZXJDaGFpbk5vZGVGb3JPcGVuT3JkZXJJZFt0aGVpck9yZGVySWRdLm5leHRPcmRlcklkOwogICAgICBpZiAobWF0Y2hTdG9wUmVhc29uID09IE1hdGNoU3RvcFJlYXNvbi5Ob25lICYmIG5leHRUaGVpck9yZGVySWQgPT0gMCkgewogICAgICAgIG1hdGNoU3RvcFJlYXNvbiA9IE1hdGNoU3RvcFJlYXNvbi5QcmljZUV4aGF1c3RlZDsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgbmV4dFRoZWlyT3JkZXJJZCA9IHRoZWlyT3JkZXJJZDsKICAgIH0KICB9CgogIC8vIEludGVybmFsIE9yZGVyIFBsYWNlbWVudC4KICAvLwogIC8vIFJlY29yZCBtYXRjaCAocGFydGlhbCBvciBjb21wbGV0ZSkgb2YgcmVzdGluZyBvcmRlciwgYW5kIGNyZWRpdCB0aGVtIHRoZWlyIGZ1bmRzLgogIC8vCiAgLy8gSWYgdGhlaXIgb3JkZXIgaXMgY29tcGxldGVseSBtYXRjaGVkLCB0aGUgb3JkZXIgaXMgbWFya2VkIGFzIGRvbmUsCiAgLy8gYW5kICJ0aGVpcnNEZWFkIiBpcyByZXR1cm5lZCBhcyB0cnVlLgogIC8vCiAgLy8gVGhlIG9yZGVyIGlzIE5PVCByZW1vdmVkIGZyb20gdGhlIGJvb2sgYnkgdGhpcyBjYWxsIC0gdGhlIGNhbGxlcgogIC8vIG11c3QgZG8gdGhhdCBpZiB0aGVpcnNEZWFkIGlzIHRydWUuCiAgLy8KICAvLyBObyBzYW5pdHkgY2hlY2tzIGFyZSBtYWRlIC0gdGhlIGNhbGxlciBtdXN0IGJlIHN1cmUgdGhlIG9yZGVyIGlzCiAgLy8gbm90IGFscmVhZHkgZG9uZSBhbmQgaGFzIHN1ZmZpY2llbnQgcmVtYWluaW5nLiAoWWVzLCB3ZSdkIGxpa2UgdG8KICAvLyBjaGVjayBoZXJlIHRvbyBidXQgd2UgY2Fubm90IGFmZm9yZCB0aGUgZ2FzKS4KICAvLwogIGZ1bmN0aW9uIHJlY29yZFRoZWlyTWF0Y2goCiAgICAgIE9yZGVyIHN0b3JhZ2UgdGhlaXJPcmRlciwgdWludDEyOCB0aGVpck9yZGVySWQsIHVpbnQxNiB0aGVpclByaWNlLCB1aW50IG1hdGNoQmFzZSwgdWludCBtYXRjaENudHIKICAgICkgaW50ZXJuYWwgcmV0dXJucyAoYm9vbCB0aGVpcnNEZWFkKSB7CiAgICAvLyB0aGV5IGFyZSBhIG1ha2VyIHNvIG5vIGZlZXMKICAgIC8vIG92ZXJmbG93IHNhZmUgLSBzZWUgY29tbWVudHMgYWJvdXQgYmFzZU1heFNpemUKICAgIC8vIGV4ZWN1dGVkQmFzZSBjYW5ub3QgZ28gPiBzaXplQmFzZSBkdWUgdG8gbG9naWMgaW4gbWF0Y2hXaXRoVGhlaXJzCiAgICB0aGVpck9yZGVyLmV4ZWN1dGVkQmFzZSArPSB1aW50MTI4KG1hdGNoQmFzZSk7CiAgICB0aGVpck9yZGVyLmV4ZWN1dGVkQ250ciArPSB1aW50MTI4KG1hdGNoQ250cik7CiAgICBpZiAoaXNCdXlQcmljZSh0aGVpclByaWNlKSkgewogICAgICAvLyB0aGV5IGhhdmUgYm91Z2h0IGJhc2UgKHVzaW5nIHRoZSBjb3VudGVyIHRoZXkgYWxyZWFkeSBwYWlkIHdoZW4gY3JlYXRpbmcgdGhlIG9yZGVyKQogICAgICBiYWxhbmNlQmFzZUZvckNsaWVudFt0aGVpck9yZGVyLmNsaWVudF0gKz0gbWF0Y2hCYXNlOwogICAgfSBlbHNlIHsKICAgICAgLy8gdGhleSBoYXZlIGJvdWdodCBjb3VudGVyICh1c2luZyB0aGUgYmFzZSB0aGV5IGFscmVhZHkgcGFpZCB3aGVuIGNyZWF0aW5nIHRoZSBvcmRlcikKICAgICAgYmFsYW5jZUNudHJGb3JDbGllbnRbdGhlaXJPcmRlci5jbGllbnRdICs9IG1hdGNoQ250cjsKICAgIH0KICAgIHVpbnQgc3RpbGxSZW1haW5pbmdCYXNlID0gdGhlaXJPcmRlci5zaXplQmFzZSAtIHRoZWlyT3JkZXIuZXhlY3V0ZWRCYXNlOwogICAgLy8gYXZvaWQgbGVhdmluZyB0aW55IGFtb3VudHMgaW4gdGhlIGJvb2sgLSByZWZ1bmQgcmVtYWluaW5nIGlmIHRvbyBzbWFsbAogICAgaWYgKHN0aWxsUmVtYWluaW5nQmFzZSA8IGJhc2VNaW5SZW1haW5pbmdTaXplKSB7CiAgICAgIHJlZnVuZFVubWF0Y2hlZEFuZEZpbmlzaCh0aGVpck9yZGVySWQsIFN0YXR1cy5Eb25lLCBSZWFzb25Db2RlLk5vbmUpOwogICAgICAvLyBzb21lb25lIGJ1aWxkaW5nIGFuIFVJIG9uIHRvcCBuZWVkcyB0byBrbm93IGhvdyBtdWNoIHdhcyBtYXRjaCBhbmQgaG93IG11Y2ggd2FzIHJlZnVuZAogICAgICBNYXJrZXRPcmRlckV2ZW50KGJsb2NrLnRpbWVzdGFtcCwgdGhlaXJPcmRlcklkLCBNYXJrZXRPcmRlckV2ZW50VHlwZS5Db21wbGV0ZUZpbGwsCiAgICAgICAgdGhlaXJQcmljZSwgbWF0Y2hCYXNlICsgc3RpbGxSZW1haW5pbmdCYXNlLCBtYXRjaEJhc2UpOwogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0gZWxzZSB7CiAgICAgIE1hcmtldE9yZGVyRXZlbnQoYmxvY2sudGltZXN0YW1wLCB0aGVpck9yZGVySWQsIE1hcmtldE9yZGVyRXZlbnRUeXBlLlBhcnRpYWxGaWxsLAogICAgICAgIHRoZWlyUHJpY2UsIG1hdGNoQmFzZSwgbWF0Y2hCYXNlKTsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogIH0KCiAgLy8gSW50ZXJuYWwgT3JkZXIgUGxhY2VtZW50LgogIC8vCiAgLy8gUmVmdW5kIGFueSB1bm1hdGNoZWQgZnVuZHMgaW4gYW4gb3JkZXIgKGJhc2VkIG9uIGV4ZWN1dGVkIHZzIHNpemUpIGFuZCBtb3ZlIHRvIGEgZmluYWwgc3RhdGUuCiAgLy8KICAvLyBUaGUgb3JkZXIgaXMgTk9UIHJlbW92ZWQgZnJvbSB0aGUgYm9vayBieSB0aGlzIGNhbGwgYW5kIG5vIGV2ZW50IGlzIHJhaXNlZC4KICAvLwogIC8vIE5vIHNhbml0eSBjaGVja3MgYXJlIG1hZGUgLSB0aGUgY2FsbGVyIG11c3QgYmUgc3VyZSB0aGUgb3JkZXIgaGFzIG5vdCBhbHJlYWR5IGJlZW4gcmVmdW5kZWQuCiAgLy8KICBmdW5jdGlvbiByZWZ1bmRVbm1hdGNoZWRBbmRGaW5pc2godWludDEyOCBvcmRlcklkLCBTdGF0dXMgc3RhdHVzLCBSZWFzb25Db2RlIHJlYXNvbkNvZGUpIGludGVybmFsIHsKICAgIE9yZGVyIHN0b3JhZ2Ugb3JkZXIgPSBvcmRlckZvck9yZGVySWRbb3JkZXJJZF07CiAgICB1aW50MTYgcHJpY2UgPSBvcmRlci5wcmljZTsKICAgIGlmIChpc0J1eVByaWNlKHByaWNlKSkgewogICAgICB1aW50IHNpemVDbnRyID0gY29tcHV0ZUNudHJBbW91bnRVc2luZ1BhY2tlZChvcmRlci5zaXplQmFzZSwgcHJpY2UpOwogICAgICBiYWxhbmNlQ250ckZvckNsaWVudFtvcmRlci5jbGllbnRdICs9IHNpemVDbnRyIC0gb3JkZXIuZXhlY3V0ZWRDbnRyOwogICAgfSBlbHNlIHsKICAgICAgYmFsYW5jZUJhc2VGb3JDbGllbnRbb3JkZXIuY2xpZW50XSArPSBvcmRlci5zaXplQmFzZSAtIG9yZGVyLmV4ZWN1dGVkQmFzZTsKICAgIH0KICAgIG9yZGVyLnN0YXR1cyA9IHN0YXR1czsKICAgIG9yZGVyLnJlYXNvbkNvZGUgPSByZWFzb25Db2RlOwogIH0KCiAgLy8gSW50ZXJuYWwgT3JkZXIgUGxhY2VtZW50LgogIC8vCiAgLy8gRW50ZXIgYSBub3QgY29tcGxldGVseSBtYXRjaGVkIG9yZGVyIGludG8gdGhlIGJvb2ssIG1hcmtpbmcgdGhlIG9yZGVyIGFzIG9wZW4uCiAgLy8KICAvLyBUaGlzIHVwZGF0ZXMgdGhlIG9jY3VwaWVkIHByaWNlIGJpdG1hcCBhbmQgY2hhaW4uCiAgLy8KICAvLyBObyBzYW5pdHkgY2hlY2tzIGFyZSBtYWRlIC0gdGhlIGNhbGxlciBtdXN0IGJlIHN1cmUgdGhlIG9yZGVyCiAgLy8gaGFzIHNvbWUgdW5tYXRjaGVkIGFtb3VudCBhbmQgaGFzIGJlZW4gcGFpZCBmb3IhCiAgLy8KICBmdW5jdGlvbiBlbnRlck9yZGVyKHVpbnQxMjggb3JkZXJJZCkgaW50ZXJuYWwgewogICAgT3JkZXIgc3RvcmFnZSBvcmRlciA9IG9yZGVyRm9yT3JkZXJJZFtvcmRlcklkXTsKICAgIHVpbnQxNiBwcmljZSA9IG9yZGVyLnByaWNlOwogICAgT3JkZXJDaGFpbiBzdG9yYWdlIG9yZGVyQ2hhaW4gPSBvcmRlckNoYWluRm9yT2NjdXBpZWRQcmljZVtwcmljZV07CiAgICBPcmRlckNoYWluTm9kZSBzdG9yYWdlIG9yZGVyQ2hhaW5Ob2RlID0gb3JkZXJDaGFpbk5vZGVGb3JPcGVuT3JkZXJJZFtvcmRlcklkXTsKICAgIGlmIChvcmRlckNoYWluLmZpcnN0T3JkZXJJZCA9PSAwKSB7CiAgICAgIG9yZGVyQ2hhaW4uZmlyc3RPcmRlcklkID0gb3JkZXJJZDsKICAgICAgb3JkZXJDaGFpbi5sYXN0T3JkZXJJZCA9IG9yZGVySWQ7CiAgICAgIG9yZGVyQ2hhaW5Ob2RlLm5leHRPcmRlcklkID0gMDsKICAgICAgb3JkZXJDaGFpbk5vZGUucHJldk9yZGVySWQgPSAwOwogICAgICB1aW50IGJpdG1hcEluZGV4ID0gcHJpY2UgLyAyNTY7CiAgICAgIHVpbnQgYml0SW5kZXggPSBwcmljZSAlIDI1NjsKICAgICAgb2NjdXBpZWRQcmljZUJpdG1hcHNbYml0bWFwSW5kZXhdIHw9ICgyICoqIGJpdEluZGV4KTsKICAgIH0gZWxzZSB7CiAgICAgIHVpbnQxMjggZXhpc3RpbmdMYXN0T3JkZXJJZCA9IG9yZGVyQ2hhaW4ubGFzdE9yZGVySWQ7CiAgICAgIE9yZGVyQ2hhaW5Ob2RlIHN0b3JhZ2UgZXhpc3RpbmdMYXN0T3JkZXJDaGFpbk5vZGUgPSBvcmRlckNoYWluTm9kZUZvck9wZW5PcmRlcklkW2V4aXN0aW5nTGFzdE9yZGVySWRdOwogICAgICBvcmRlckNoYWluTm9kZS5uZXh0T3JkZXJJZCA9IDA7CiAgICAgIG9yZGVyQ2hhaW5Ob2RlLnByZXZPcmRlcklkID0gZXhpc3RpbmdMYXN0T3JkZXJJZDsKICAgICAgZXhpc3RpbmdMYXN0T3JkZXJDaGFpbk5vZGUubmV4dE9yZGVySWQgPSBvcmRlcklkOwogICAgICBvcmRlckNoYWluLmxhc3RPcmRlcklkID0gb3JkZXJJZDsKICAgIH0KICAgIE1hcmtldE9yZGVyRXZlbnQoYmxvY2sudGltZXN0YW1wLCBvcmRlcklkLCBNYXJrZXRPcmRlckV2ZW50VHlwZS5BZGQsCiAgICAgIHByaWNlLCBvcmRlci5zaXplQmFzZSAtIG9yZGVyLmV4ZWN1dGVkQmFzZSwgMCk7CiAgICBvcmRlci5zdGF0dXMgPSBTdGF0dXMuT3BlbjsKICB9CgogIC8vIEludGVybmFsIE9yZGVyIFBsYWNlbWVudC4KICAvLwogIC8vIENoYXJnZSB0aGUgY2xpZW50IGZvciB0aGUgY29zdCBvZiBwbGFjaW5nIGFuIG9yZGVyIGluIHRoZSBnaXZlbiBkaXJlY3Rpb24uCiAgLy8KICAvLyBSZXR1cm4gdHJ1ZSBpZiBzdWNjZXNzZnVsLCBmYWxzZSBvdGhlcndpc2UuCiAgLy8KICBmdW5jdGlvbiBkZWJpdEZ1bmRzKAogICAgICBhZGRyZXNzIGNsaWVudCwgRGlyZWN0aW9uIGRpcmVjdGlvbiwgdWludCBzaXplQmFzZSwgdWludCBzaXplQ250cgogICAgKSBpbnRlcm5hbCByZXR1cm5zIChib29sIHN1Y2Nlc3MpIHsKICAgIGlmIChkaXJlY3Rpb24gPT0gRGlyZWN0aW9uLkJ1eSkgewogICAgICB1aW50IGF2YWlsYWJsZUNudHIgPSBiYWxhbmNlQ250ckZvckNsaWVudFtjbGllbnRdOwogICAgICBpZiAoYXZhaWxhYmxlQ250ciA8IHNpemVDbnRyKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIGJhbGFuY2VDbnRyRm9yQ2xpZW50W2NsaWVudF0gPSBhdmFpbGFibGVDbnRyIC0gc2l6ZUNudHI7CiAgICAgIHJldHVybiB0cnVlOwogICAgfSBlbHNlIGlmIChkaXJlY3Rpb24gPT0gRGlyZWN0aW9uLlNlbGwpIHsKICAgICAgdWludCBhdmFpbGFibGVCYXNlID0gYmFsYW5jZUJhc2VGb3JDbGllbnRbY2xpZW50XTsKICAgICAgaWYgKGF2YWlsYWJsZUJhc2UgPCBzaXplQmFzZSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICBiYWxhbmNlQmFzZUZvckNsaWVudFtjbGllbnRdID0gYXZhaWxhYmxlQmFzZSAtIHNpemVCYXNlOwogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICB9CgogIC8vIFB1YmxpYyBCb29rIFZpZXcKICAvLyAKICAvLyBJbnRlbmRlZCBmb3IgcHVibGljIGJvb2sgZGVwdGggZW51bWVyYXRpb24gZnJvbSB3ZWIzIChvciBzaW1pbGFyKS4KICAvLwogIC8vIE5vdCBzdWl0YWJsZSBmb3IgdXNlIGZyb20gYSBzbWFydCBjb250cmFjdCB0cmFuc2FjdGlvbiAtIGdhcyB1c2FnZQogIC8vIGNvdWxkIGJlIHZlcnkgaGlnaCBpZiB3ZSBoYXZlIG1hbnkgb3JkZXJzIGF0IHRoZSBzYW1lIHByaWNlLgogIC8vCiAgLy8gU3RhcnQgYXQgdGhlIGdpdmVuIGluY2x1c2l2ZSBwcmljZSAoYW5kIHNpZGUpIGFuZCB3YWxrIGRvd24gdGhlIGJvb2sKICAvLyAoZ2V0dGluZyBsZXNzIGFnZ3Jlc3NpdmUpIHVudGlsIHdlIGZpbmQgc29tZSBvcGVuIG9yZGVycyBvciByZWFjaCB0aGUKICAvLyBsZWFzdCBhZ2dyZXNzaXZlIHByaWNlLgogIC8vCiAgLy8gUmV0dXJucyB0aGUgcHJpY2Ugd2hlcmUgd2UgZm91bmQgdGhlIG9yZGVyKHMpLCB0aGUgZGVwdGggYXQgdGhhdCBwcmljZQogIC8vICh6ZXJvIGlmIG5vbmUgZm91bmQpLCBvcmRlciBjb3VudCB0aGVyZSwgYW5kIHRoZSBjdXJyZW50IGJsb2NrTnVtYmVyLgogIC8vCiAgLy8gKFRoZSBibG9ja051bWJlciBpcyBoYW5keSBpZiB5b3UncmUgdGFraW5nIGEgc25hcHNob3Qgd2hpY2ggeW91IGludGVuZAogIC8vICB0byBrZWVwIHVwLXRvLWRhdGUgd2l0aCB0aGUgbWFya2V0IG9yZGVyIGV2ZW50cykuCiAgLy8KICAvLyBUbyB3YWxrIHRoZSBib29rLCB0aGUgY2FsbGVyIHNob3VsZCBzdGFydCBieSBjYWxsaW5nIHdhbGtCb29rIHdpdGggdGhlCiAgLy8gbW9zdCBhZ2dyZXNzaXZlIGJ1eSBwcmljZSAoQnV5IEAgOTk5MDAwKS4KICAvLyBJZiB0aGUgcHJpY2UgcmV0dXJuZWQgaXMgdGhlIGxlYXN0IGFnZ3Jlc3NpdmUgYnV5IHByaWNlIChCdXkgQCAwLjAwMDAwMSksCiAgLy8gdGhlIHNpZGUgaXMgY29tcGxldGUuCiAgLy8gT3RoZXJ3aXNlLCBjYWxsIHdhbGtCb29rIGFnYWluIHdpdGggdGhlIChwYWNrZWQpIHByaWNlIHJldHVybmVkICsgMS4KICAvLyBUaGVuIHJlcGVhdCBmb3IgdGhlIHNlbGwgc2lkZSwgc3RhcnRpbmcgd2l0aCBTZWxsIEAgMC4wMDAwMDEgYW5kIHN0b3BwaW5nCiAgLy8gd2hlbiBTZWxsIEAgOTk5MDAwIGlzIHJldHVybmVkLgogIC8vCiAgZnVuY3Rpb24gd2Fsa0Jvb2sodWludDE2IGZyb21QcmljZSkgcHVibGljIGNvbnN0YW50IHJldHVybnMgKAogICAgICB1aW50MTYgcHJpY2UsIHVpbnQgZGVwdGhCYXNlLCB1aW50IG9yZGVyQ291bnQsIHVpbnQgYmxvY2tOdW1iZXIKICAgICkgewogICAgdWludCBwcmljZVN0YXJ0ID0gZnJvbVByaWNlOwogICAgdWludCBwcmljZUVuZCA9IChpc0J1eVByaWNlKGZyb21QcmljZSkpID8gbWluQnV5UHJpY2UgOiBtYXhTZWxsUHJpY2U7CiAgICAKICAgIC8vIFNlZSBjb21tZW50cyBpbiBtYXRjaEFnYWluc3RCb29rIHJlOiBob3cgdGhlc2UgY3JhenkgbG9vcHMgd29yay4KICAgIAogICAgdWludCBibWkgPSBwcmljZVN0YXJ0IC8gMjU2OwogICAgdWludCBidGkgPSBwcmljZVN0YXJ0ICUgMjU2OwogICAgdWludCBibWlFbmQgPSBwcmljZUVuZCAvIDI1NjsKICAgIHVpbnQgYnRpRW5kID0gcHJpY2VFbmQgJSAyNTY7CgogICAgdWludCB3Ym0gPSBvY2N1cGllZFByaWNlQml0bWFwc1tibWldID4+IGJ0aTsKICAgIAogICAgd2hpbGUgKGJtaSA8IGJtaUVuZCkgewogICAgICBpZiAod2JtID09IDAgfHwgYnRpID09IDI1NikgewogICAgICAgIGJ0aSA9IDA7CiAgICAgICAgYm1pKys7CiAgICAgICAgd2JtID0gb2NjdXBpZWRQcmljZUJpdG1hcHNbYm1pXTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAoKHdibSAmIDEpICE9IDApIHsKICAgICAgICAgIC8vIGNhcmVmdWwgLSBjb3B5LXBhc3RlZCBpbiBiZWxvdyBsb29wCiAgICAgICAgICBwcmljZSA9IHVpbnQxNihibWkgKiAyNTYgKyBidGkpOwogICAgICAgICAgKGRlcHRoQmFzZSwgb3JkZXJDb3VudCkgPSBzdW1EZXB0aChvcmRlckNoYWluRm9yT2NjdXBpZWRQcmljZVtwcmljZV0uZmlyc3RPcmRlcklkKTsKICAgICAgICAgIHJldHVybiAocHJpY2UsIGRlcHRoQmFzZSwgb3JkZXJDb3VudCwgYmxvY2subnVtYmVyKTsKICAgICAgICB9CiAgICAgICAgYnRpICs9IDE7CiAgICAgICAgd2JtIC89IDI7CiAgICAgIH0KICAgIH0KICAgIC8vIHdlJ3ZlIHJlYWNoZWQgdGhlIGxhc3QgYml0bWFwIHdlIG5lZWQgdG8gc2VhcmNoLCBzdG9wIGF0IGJ0aUVuZCBub3QgMjU2IHRoaXMgdGltZS4KICAgIHdoaWxlIChidGkgPD0gYnRpRW5kICYmIHdibSAhPSAwKSB7CiAgICAgIGlmICgod2JtICYgMSkgIT0gMCkgewogICAgICAgIC8vIGNhcmVmdWwgLSBjb3B5LXBhc3RlZCBpbiBhYm92ZSBsb29wCiAgICAgICAgcHJpY2UgPSB1aW50MTYoYm1pICogMjU2ICsgYnRpKTsKICAgICAgICAoZGVwdGhCYXNlLCBvcmRlckNvdW50KSA9IHN1bURlcHRoKG9yZGVyQ2hhaW5Gb3JPY2N1cGllZFByaWNlW3ByaWNlXS5maXJzdE9yZGVySWQpOwogICAgICAgIHJldHVybiAocHJpY2UsIGRlcHRoQmFzZSwgb3JkZXJDb3VudCwgYmxvY2subnVtYmVyKTsKICAgICAgfQogICAgICBidGkgKz0gMTsKICAgICAgd2JtIC89IDI7CiAgICB9CiAgICByZXR1cm4gKHVpbnQxNihwcmljZUVuZCksIDAsIDAsIGJsb2NrLm51bWJlcik7CiAgfQoKICAvLyBJbnRlcm5hbCBCb29rIFZpZXcuCiAgLy8KICAvLyBTZWUgd2Fsa0Jvb2sgLSBhZGRzIHVwIG9wZW4gZGVwdGggYXQgYSBwcmljZSBzdGFydGluZyBmcm9tIGFuCiAgLy8gb3JkZXIgd2hpY2ggaXMgYXNzdW1lZCB0byBiZSBvcGVuLiBDYXJlZnVsIC0gdW5saW1pdGVkIGdhcyB1c2UuCiAgLy8KICBmdW5jdGlvbiBzdW1EZXB0aCh1aW50MTI4IG9yZGVySWQpIGludGVybmFsIGNvbnN0YW50IHJldHVybnMgKHVpbnQgZGVwdGgsIHVpbnQgb3JkZXJDb3VudCkgewogICAgd2hpbGUgKHRydWUpIHsKICAgICAgT3JkZXIgc3RvcmFnZSBvcmRlciA9IG9yZGVyRm9yT3JkZXJJZFtvcmRlcklkXTsKICAgICAgZGVwdGggKz0gb3JkZXIuc2l6ZUJhc2UgLSBvcmRlci5leGVjdXRlZEJhc2U7CiAgICAgIG9yZGVyQ291bnQrKzsKICAgICAgb3JkZXJJZCA9IG9yZGVyQ2hhaW5Ob2RlRm9yT3Blbk9yZGVySWRbb3JkZXJJZF0ubmV4dE9yZGVySWQ7CiAgICAgIGlmIChvcmRlcklkID09IDApIHsKICAgICAgICByZXR1cm4gKGRlcHRoLCBvcmRlckNvdW50KTsKICAgICAgfQogICAgfQogIH0KfQoKLy8gaGVscGVyIGZvciBhdXRvbWF0aW5nIGJvb2sgY3JlYXRpb24KY29udHJhY3QgQm9va0VSQzIwRXRoVjFwMUZhY3RvcnkgewoKICAgIGV2ZW50IEJvb2tDcmVhdGVkIChhZGRyZXNzIGJvb2tBZGRyZXNzKTsKCiAgICBmdW5jdGlvbiBCb29rRVJDMjBFdGhWMXAxRmFjdG9yeSgpIHsKICAgIH0KCiAgICBmdW5jdGlvbiBjcmVhdGVCb29rKEVSQzIwIF9iYXNlVG9rZW4sIEVSQzIwIF9yd3JkVG9rZW4sIGFkZHJlc3MgX2ZlZUNvbGxlY3RvciwgdWludCBfYmFzZU1pbkluaXRpYWxTaXplLCBpbnQ4IF9taW5QcmljZUV4cG9uZW50KSBwdWJsaWMgewogICAgICAgIEJvb2tFUkMyMEV0aFYxcDEgYm9vayA9IG5ldyBCb29rRVJDMjBFdGhWMXAxKCk7CiAgICAgICAgYm9vay5pbml0KF9iYXNlVG9rZW4sIF9yd3JkVG9rZW4sIF9iYXNlTWluSW5pdGlhbFNpemUsIF9taW5QcmljZUV4cG9uZW50KTsKICAgICAgICBib29rLmNoYW5nZUZlZUNvbGxlY3RvcihfZmVlQ29sbGVjdG9yKTsKICAgICAgICBCb29rQ3JlYXRlZChhZGRyZXNzKGJvb2spKTsKICAgIH0KfQ=='.
	

]
