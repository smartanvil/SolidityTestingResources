Class {
	#name : #SRT6A3DCd2Ad3C693aA8CBc3e5bCB075b674209A033,
	#superclass : #SRTContracts,
	#category : #SolidityTestingResources
}

{ #category : #base64 }
SRT6A3DCd2Ad3C693aA8CBc3e5bCB075b674209A033 >> base64 [
	^ 'cHJhZ21hIHNvbGlkaXR5IF4wLjQuODsKCi8qClRoaXMgZmlsZSBpcyBwYXJ0IG9mIFBhc3MgREFPLgoKUGFzcyBEQU8gaXMgZnJlZSBzb2Z0d2FyZTogeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yIG1vZGlmeQppdCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBsZXNzZXIgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhcyBwdWJsaXNoZWQgYnkKdGhlIEZyZWUgU29mdHdhcmUgRm91bmRhdGlvbiwgZWl0aGVyIHZlcnNpb24gMyBvZiB0aGUgTGljZW5zZSwgb3IKKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi4KClBhc3MgREFPIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsCmJ1dCBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dCBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mCk1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gIFNlZSB0aGUKR05VIGxlc3NlciBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuCgpZb3Ugc2hvdWxkIGhhdmUgcmVjZWl2ZWQgYSBjb3B5IG9mIHRoZSBHTlUgbGVzc2VyIEdlbmVyYWwgUHVibGljIExpY2Vuc2UKYWxvbmcgd2l0aCBQYXNzIERBTy4gIElmIG5vdCwgc2VlIDxodHRwOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvPi4KKi8KCi8qClNtYXJ0IGNvbnRyYWN0IGZvciBhIERlY2VudHJhbGl6ZWQgQXV0b25vbW91cyBPcmdhbml6YXRpb24gKERBTykKdG8gYXV0b21hdGUgb3JnYW5pemF0aW9uYWwgZ292ZXJuYW5jZSBhbmQgZGVjaXNpb24tbWFraW5nLgoqLwoKLy8vIEB0aXRsZSBQYXNzIERhbyBzbWFydCBjb250cmFjdApjb250cmFjdCBQYXNzRGFvIHsKICAgIAogICAgc3RydWN0IHJldmlzaW9uIHsKICAgICAgICAvLyBBZGRyZXNzIG9mIHRoZSBDb21taXR0ZWUgUm9vbSBzbWFydCBjb250cmFjdAogICAgICAgIGFkZHJlc3MgY29tbWl0dGVlUm9vbTsKICAgICAgICAvLyBBZGRyZXNzIG9mIHRoZSBzaGFyZSBtYW5hZ2VyIHNtYXJ0IGNvbnRyYWN0CiAgICAgICAgYWRkcmVzcyBzaGFyZU1hbmFnZXI7CiAgICAgICAgLy8gQWRkcmVzcyBvZiB0aGUgdG9rZW4gbWFuYWdlciBzbWFydCBjb250cmFjdAogICAgICAgIGFkZHJlc3MgdG9rZW5NYW5hZ2VyOwogICAgICAgIC8vIEFkZHJlc3Mgb2YgdGhlIHByb2plY3QgY3JlYXRvciBzbWFydCBjb250cmFjdAogICAgICAgIHVpbnQgc3RhcnREYXRlOwogICAgfQogICAgLy8gVGhlIHJldmlzaW9ucyBvZiB0aGUgYXBwbGljYXRpb24gdW50aWwgdG9kYXkKICAgIHJldmlzaW9uW10gcHVibGljIHJldmlzaW9uczsKCiAgICBzdHJ1Y3QgcHJvamVjdCB7CiAgICAgICAgLy8gVGhlIGFkZHJlc3Mgb2YgdGhlIHNtYXJ0IGNvbnRyYWN0CiAgICAgICAgYWRkcmVzcyBjb250cmFjdEFkZHJlc3M7CiAgICAgICAgLy8gVGhlIHVuaXggZWZmZWN0aXZlIHN0YXJ0IGRhdGUgb2YgdGhlIGNvbnRyYWN0CiAgICAgICAgdWludCBzdGFydERhdGU7CiAgICB9CiAgICAvLyBUaGUgcHJvamVjdHMgb2YgdGhlIERhbwogICAgcHJvamVjdFtdIHB1YmxpYyBwcm9qZWN0czsKCiAgICAvLyBNYXAgd2l0aCB0aGUgaW5kZXhlcyBvZiB0aGUgcHJvamVjdHMKICAgIG1hcHBpbmcgKGFkZHJlc3MgPT4gdWludCkgcHJvamVjdElEOwogICAgCiAgICAvLyBUaGUgYWRkcmVzcyBvZiB0aGUgbWV0YSBwcm9qZWN0CiAgICBhZGRyZXNzIG1ldGFQcm9qZWN0OwoKICAgIAovLyBFdmVudHMKCiAgICBldmVudCBVcGdyYWRlKHVpbnQgaW5kZXhlZCBSZXZpc2lvbklELCBhZGRyZXNzIENvbW1pdHRlZVJvb20sIGFkZHJlc3MgU2hhcmVNYW5hZ2VyLCBhZGRyZXNzIFRva2VuTWFuYWdlcik7CiAgICBldmVudCBOZXdQcm9qZWN0KGFkZHJlc3MgUHJvamVjdCk7CgovLyBDb25zdGFudCBmdW5jdGlvbnMgIAogICAgCiAgICAvLy8gQHJldHVybiBUaGUgZWZmZWN0aXZlIGNvbW1pdHRlZSByb29tCiAgICBmdW5jdGlvbiBBY3R1YWxDb21taXR0ZWVSb29tKCkgY29uc3RhbnQgcmV0dXJucyAoYWRkcmVzcykgewogICAgICAgIHJldHVybiByZXZpc2lvbnNbMF0uY29tbWl0dGVlUm9vbTsKICAgIH0KICAgIAogICAgLy8vIEByZXR1cm4gVGhlIG1ldGEgcHJvamVjdAogICAgZnVuY3Rpb24gTWV0YVByb2plY3QoKSBjb25zdGFudCByZXR1cm5zIChhZGRyZXNzKSB7CiAgICAgICAgcmV0dXJuIG1ldGFQcm9qZWN0OwogICAgfQoKICAgIC8vLyBAcmV0dXJuIFRoZSBlZmZlY3RpdmUgc2hhcmUgbWFuYWdlcgogICAgZnVuY3Rpb24gQWN0dWFsU2hhcmVNYW5hZ2VyKCkgY29uc3RhbnQgcmV0dXJucyAoYWRkcmVzcykgewogICAgICAgIHJldHVybiByZXZpc2lvbnNbMF0uc2hhcmVNYW5hZ2VyOwogICAgfQoKICAgIC8vLyBAcmV0dXJuIFRoZSBlZmZlY3RpdmUgdG9rZW4gbWFuYWdlcgogICAgZnVuY3Rpb24gQWN0dWFsVG9rZW5NYW5hZ2VyKCkgY29uc3RhbnQgcmV0dXJucyAoYWRkcmVzcykgewogICAgICAgIHJldHVybiByZXZpc2lvbnNbMF0udG9rZW5NYW5hZ2VyOwogICAgfQoKLy8gbW9kaWZpZXJzCgogICAgbW9kaWZpZXIgb25seVBhc3NDb21taXR0ZWVSb29tIHtpZiAobXNnLnNlbmRlciAhPSByZXZpc2lvbnNbMF0uY29tbWl0dGVlUm9vbSAgCiAgICAgICAgJiYgcmV2aXNpb25zWzBdLmNvbW1pdHRlZVJvb20gIT0gMCkgdGhyb3c7IF87fQogICAgCi8vIENvbnN0cnVjdG9yIGZ1bmN0aW9uCgogICAgZnVuY3Rpb24gUGFzc0RhbygpIHsKICAgICAgICBwcm9qZWN0cy5sZW5ndGggPSAxOwogICAgICAgIHJldmlzaW9ucy5sZW5ndGggPSAxOwogICAgfQogICAgCi8vIFJlZ2lzdGVyIGZ1bmN0aW9ucwoKICAgIC8vLyBAZGV2IEZ1bmN0aW9uIHRvIGFsbG93IHRoZSBhY3R1YWwgQ29tbWl0dGVlIFJvb20gdXBncmFkaW5nIHRoZSBhcHBsaWNhdGlvbgogICAgLy8vIEBwYXJhbSBfbmV3Q29tbWl0dGVlUm9vbSBUaGUgYWRkcmVzcyBvZiB0aGUgbmV3IGNvbW1pdHRlZSByb29tCiAgICAvLy8gQHBhcmFtIF9uZXdTaGFyZU1hbmFnZXIgVGhlIGFkZHJlc3Mgb2YgdGhlIG5ldyBzaGFyZSBtYW5hZ2VyCiAgICAvLy8gQHBhcmFtIF9uZXdUb2tlbk1hbmFnZXIgVGhlIGFkZHJlc3Mgb2YgdGhlIG5ldyB0b2tlbiBtYW5hZ2VyCiAgICAvLy8gQHJldHVybiBUaGUgaW5kZXggb2YgdGhlIHJldmlzaW9uCiAgICBmdW5jdGlvbiB1cGdyYWRlKAogICAgICAgIGFkZHJlc3MgX25ld0NvbW1pdHRlZVJvb20sIAogICAgICAgIGFkZHJlc3MgX25ld1NoYXJlTWFuYWdlciwgCiAgICAgICAgYWRkcmVzcyBfbmV3VG9rZW5NYW5hZ2VyKSBvbmx5UGFzc0NvbW1pdHRlZVJvb20gcmV0dXJucyAodWludCkgewogICAgICAgIAogICAgICAgIHVpbnQgX3JldmlzaW9uSUQgPSByZXZpc2lvbnMubGVuZ3RoKys7CiAgICAgICAgcmV2aXNpb24gciA9IHJldmlzaW9uc1tfcmV2aXNpb25JRF07CgogICAgICAgIGlmIChfbmV3Q29tbWl0dGVlUm9vbSAhPSAwKSByLmNvbW1pdHRlZVJvb20gPSBfbmV3Q29tbWl0dGVlUm9vbTsgZWxzZSByLmNvbW1pdHRlZVJvb20gPSByZXZpc2lvbnNbMF0uY29tbWl0dGVlUm9vbTsKICAgICAgICBpZiAoX25ld1NoYXJlTWFuYWdlciAhPSAwKSByLnNoYXJlTWFuYWdlciA9IF9uZXdTaGFyZU1hbmFnZXI7IGVsc2Ugci5zaGFyZU1hbmFnZXIgPSByZXZpc2lvbnNbMF0uc2hhcmVNYW5hZ2VyOwogICAgICAgIGlmIChfbmV3VG9rZW5NYW5hZ2VyICE9IDApIHIudG9rZW5NYW5hZ2VyID0gX25ld1Rva2VuTWFuYWdlcjsgZWxzZSByLnRva2VuTWFuYWdlciA9IHJldmlzaW9uc1swXS50b2tlbk1hbmFnZXI7CgogICAgICAgIHIuc3RhcnREYXRlID0gbm93OwogICAgICAgIAogICAgICAgIHJldmlzaW9uc1swXSA9IHI7CiAgICAgICAgCiAgICAgICAgVXBncmFkZShfcmV2aXNpb25JRCwgX25ld0NvbW1pdHRlZVJvb20sIF9uZXdTaGFyZU1hbmFnZXIsIF9uZXdUb2tlbk1hbmFnZXIpOwogICAgICAgICAgICAKICAgICAgICByZXR1cm4gX3JldmlzaW9uSUQ7CiAgICB9CgogICAgLy8vIEBkZXYgRnVuY3Rpb24gdG8gc2V0IHRoZSBtZXRhIHByb2plY3QKICAgIC8vLyBAcGFyYW0gX3Byb2plY3RBZGRyZXNzIFRoZSBhZGRyZXNzIG9mIHRoZSBtZXRhIHByb2plY3QKICAgIGZ1bmN0aW9uIGFkZE1ldGFQcm9qZWN0KGFkZHJlc3MgX3Byb2plY3RBZGRyZXNzKSBvbmx5UGFzc0NvbW1pdHRlZVJvb20gewoKICAgICAgICBtZXRhUHJvamVjdCA9IF9wcm9qZWN0QWRkcmVzczsKICAgIH0KICAgIAogICAgLy8vIEBkZXYgRnVuY3Rpb24gdG8gYWxsb3cgdGhlIGNvbW1pdHRlZSByb29tIHRvIGFkZCBhIHByb2plY3Qgd2hlbiBvcmRlcmluZwogICAgLy8vIEBwYXJhbSBfcHJvamVjdEFkZHJlc3MgVGhlIGFkZHJlc3Mgb2YgdGhlIHByb2plY3QKICAgIGZ1bmN0aW9uIGFkZFByb2plY3QoYWRkcmVzcyBfcHJvamVjdEFkZHJlc3MpIG9ubHlQYXNzQ29tbWl0dGVlUm9vbSB7CgogICAgICAgIGlmIChwcm9qZWN0SURbX3Byb2plY3RBZGRyZXNzXSA9PSAwKSB7CgogICAgICAgICAgICB1aW50IF9wcm9qZWN0SUQgPSBwcm9qZWN0cy5sZW5ndGgrKzsKICAgICAgICAgICAgcHJvamVjdCBwID0gcHJvamVjdHNbX3Byb2plY3RJRF07CiAgICAgICAgCiAgICAgICAgICAgIHByb2plY3RJRFtfcHJvamVjdEFkZHJlc3NdID0gX3Byb2plY3RJRDsKICAgICAgICAgICAgcC5jb250cmFjdEFkZHJlc3MgPSBfcHJvamVjdEFkZHJlc3M7IAogICAgICAgICAgICBwLnN0YXJ0RGF0ZSA9IG5vdzsKICAgICAgICAgICAgCiAgICAgICAgICAgIE5ld1Byb2plY3QoX3Byb2plY3RBZGRyZXNzKTsKICAgICAgICB9CiAgICB9CiAgICAKfQoKcHJhZ21hIHNvbGlkaXR5IF4wLjQuODsKCi8qCiAqCiAqIFRoaXMgZmlsZSBpcyBwYXJ0IG9mIFBhc3MgREFPLgogKgogKiBUaGUgTWFuYWdlciBzbWFydCBjb250cmFjdCBpcyB1c2VkIGZvciB0aGUgbWFuYWdlbWVudCBvZiBzaGFyZXMgYW5kIHRva2Vucy4KICoKKi8KCi8vLyBAdGl0bGUgVG9rZW4gTWFuYWdlciBzbWFydCBjb250cmFjdCBvZiB0aGUgUGFzcyBEZWNlbnRyYWxpemVkIEF1dG9ub21vdXMgT3JnYW5pc2F0aW9uCmNvbnRyYWN0IFBhc3NUb2tlbk1hbmFnZXJJbnRlcmZhY2UgewoKICAgIC8vIFRoZSBQYXNzIERhbyBzbWFydCBjb250cmFjdAogICAgUGFzc0RhbyBwdWJsaWMgcGFzc0RhbzsKICAgIC8vIFRoZSBhZHJlc3Mgb2YgdGhlIGNyZWF0b3Igb2YgdGhpcyBzbWFydCBjb250cmFjdAogICAgYWRkcmVzcyBjcmVhdG9yOwogICAgCiAgICAvLyBUaGUgdG9rZW4gbmFtZSBmb3IgZGlzcGxheSBwdXJwb3NlCiAgICBzdHJpbmcgcHVibGljIG5hbWU7CiAgICAvLyBUaGUgdG9rZW4gc3ltYm9sIGZvciBkaXNwbGF5IHB1cnBvc2UKICAgIHN0cmluZyBwdWJsaWMgc3ltYm9sOwogICAgLy8gVGhlIHF1YW50aXR5IG9mIGRlY2ltYWxzIGZvciBkaXNwbGF5IHB1cnBvc2UKICAgIHVpbnQ4IHB1YmxpYyBkZWNpbWFsczsKICAgIC8vIFRvdGFsIGFtb3VudCBvZiB0b2tlbnMKICAgIHVpbnQyNTYgdG90YWxUb2tlblN1cHBseTsKCiAgICAvLyBUcnVlIGlmIHRva2VucywgZmFsc2UgaWYgRGFvIHNoYXJlcwogICAgYm9vbCB0b2tlbjsKICAgIC8vIElmIHRydWUsIHRoZSBzaGFyZXMgb3IgdG9rZW5zIGNhbiBiZSB0cmFuc2ZlcnJlZAogICAgYm9vbCB0cmFuc2ZlcmFibGU7CgogICAgLy8gVGhlIGFkZHJlc3Mgb2YgdGhlIGxhc3QgTWFuYWdlciBiZWZvcmUgY2xvbmluZwogICAgYWRkcmVzcyBwdWJsaWMgY2xvbmVkRnJvbTsKICAgIC8vIFRydWUgaWYgdGhlIGluaXRpYWwgdG9rZW4gc3VwcGx5IGlzIG92ZXIKICAgIGJvb2wgaW5pdGlhbFRva2VuU3VwcGx5RG9uZTsKCiAgICAvLyBBcnJheSBvZiB0b2tlbiBvciBzaGFyZSBob2xkZXJzICh1c2VkIGZvciBjbG9uaW5nKQogICAgYWRkcmVzc1tdIGhvbGRlcnM7CiAgICAvLyBNYXAgd2l0aCB0aGUgaW5kZXhlcyBvZiB0aGUgaG9sZGVycyAodXNlZCBmb3IgY2xvbmluZykKICAgIG1hcHBpbmcgKGFkZHJlc3MgPT4gdWludCkgaG9sZGVySUQ7CiAgICAKICAgIC8vIEFycmF5IHdpdGggYWxsIGJhbGFuY2VzCiAgICBtYXBwaW5nIChhZGRyZXNzID0+IHVpbnQyNTYpIGJhbGFuY2VzOwogICAgLy8gQXJyYXkgd2l0aCBhbGwgYWxsb3dhbmNlcwogICAgbWFwcGluZyAoYWRkcmVzcyA9PiBtYXBwaW5nIChhZGRyZXNzID0+IHVpbnQyNTYpKSBhbGxvd2VkOwoKICAgIHN0cnVjdCBmdW5kaW5nIHsKICAgICAgICAvLyBUaGUgYWRkcmVzcyB3aGljaCBzZXRzIHBhcnRuZXJzIGFuZCBtYW5hZ2VzIHRoZSBmdW5kaW5nIChub3QgbWFuZGF0b3J5KQogICAgICAgIGFkZHJlc3MgbW9kZXJhdG9yOwogICAgICAgIC8vIFRoZSBhbW91bnQgKGluIHdlaSkgb2YgdGhlIGZ1bmRpbmcKICAgICAgICB1aW50IGFtb3VudFRvRnVuZDsKICAgICAgICAvLyBUaGUgZnVuZGVkIGFtb3VudCAoaW4gd2VpKQogICAgICAgIHVpbnQgZnVuZGVkQW1vdW50OwogICAgICAgIC8vIEEgdW5peCB0aW1lc3RhbXAsIGRlbm90aW5nIHRoZSBzdGFydCB0aW1lIG9mIHRoZSBmdW5kaW5nCiAgICAgICAgdWludCBzdGFydFRpbWU7IAogICAgICAgIC8vIEEgdW5peCB0aW1lc3RhbXAsIGRlbm90aW5nIHRoZSBjbG9zaW5nIHRpbWUgb2YgdGhlIGZ1bmRpbmcKICAgICAgICB1aW50IGNsb3NpbmdUaW1lOyAgCiAgICAgICAgLy8gVGhlIHByaWNlIG11bHRpcGxpZXIgZm9yIGEgc2hhcmUgb3IgYSB0b2tlbiB3aXRob3V0IGNvbnNpZGVyaW5nIHRoZSBpbmZsYXRpb24gcmF0ZQogICAgICAgIHVpbnQgaW5pdGlhbFByaWNlTXVsdGlwbGllcjsKICAgICAgICAvLyBSYXRlIHBlciB5ZWFyIGluIHBlcmNlbnRhZ2UgYXBwbGllZCB0byB0aGUgc2hhcmUgb3IgdG9rZW4gcHJpY2UgCiAgICAgICAgdWludCBpbmZsYXRpb25SYXRlOyAKICAgICAgICAvLyBUaGUgdG90YWwgYW1vdW50IG9mIHdlaSBnaXZlbgogICAgICAgIHVpbnQgdG90YWxXZWlHaXZlbjsKICAgIH0gCiAgICAvLyBNYXAgd2l0aCB0aGUgZnVuZGluZ3MgcnVsZXMgZm9yIGVhY2ggRGFvIHByb3Bvc2FsCiAgICBtYXBwaW5nICh1aW50ID0+IGZ1bmRpbmcpIHB1YmxpYyBmdW5kaW5nczsKCiAgICAvLyBUaGUgaW5kZXggb2YgdGhlIGxhc3QgZnVuZGluZyBhbmQgcHJvcG9zYWwKICAgIHVpbnQgbGFzdFByb3Bvc2FsSUQ7CiAgICAvLyBUaGUgaW5kZXggb2YgdGhlIGxhc3QgZnVlbGVkIGZ1bmRpbmcgYW5kIHByb3Bvc2FsCiAgICB1aW50IHB1YmxpYyBsYXN0RnVlbGVkRnVuZGluZ0lEOwogICAgCiAgICBzdHJ1Y3QgYW1vdW50c0dpdmVuIHsKICAgICAgICB1aW50IHdlaUFtb3VudDsKICAgICAgICB1aW50IHRva2VuQW1vdW50OwogICAgfQogICAgLy8gTWFwIHdpdGggdGhlIGFtb3VudHMgZ2l2ZW4gZm9yIGVhY2ggcHJvcG9zYWwgCiAgICBtYXBwaW5nICh1aW50ID0+IG1hcHBpbmcgKGFkZHJlc3MgPT4gYW1vdW50c0dpdmVuKSkgcHVibGljIEdpdmVuOwogICAgCiAgICAvLyBNYXAgb2YgYmxvY2tlZCBEYW8gc2hhcmUgYWNjb3VudHMuIFBvaW50cyB0byB0aGUgZGF0ZSB3aGVuIHRoZSBzaGFyZSBob2xkZXIgY2FuIHRyYW5zZmVyIHNoYXJlcwogICAgbWFwcGluZyAoYWRkcmVzcyA9PiB1aW50KSBwdWJsaWMgYmxvY2tlZERlYWRMaW5lOyAKCiAgICAvLyBAcmV0dXJuIFRoZSBjbGllbnQgb2YgdGhpcyBtYW5hZ2VyCiAgICBmdW5jdGlvbiBDbGllbnQoKSBjb25zdGFudCByZXR1cm5zIChhZGRyZXNzKTsKICAgIAogICAgLy8vIEByZXR1cm4gVGhlIHRvdGFsIHN1cHBseSBvZiBzaGFyZXMgb3IgdG9rZW5zIAogICAgZnVuY3Rpb24gdG90YWxTdXBwbHkoKSBjb25zdGFudCBleHRlcm5hbCByZXR1cm5zICh1aW50MjU2KTsKCiAgICAvLy8gQHBhcmFtIF9vd25lciBUaGUgYWRkcmVzcyBmcm9tIHdoaWNoIHRoZSBiYWxhbmNlIHdpbGwgYmUgcmV0cmlldmVkCiAgICAvLy8gQHJldHVybiBUaGUgYmFsYW5jZQogICAgIGZ1bmN0aW9uIGJhbGFuY2VPZihhZGRyZXNzIF9vd25lcikgY29uc3RhbnQgZXh0ZXJuYWwgcmV0dXJucyAodWludDI1NiBiYWxhbmNlKTsKCiAgICAvLy8gQHJldHVybiBUcnVlIGlmIHRva2VucyBjYW4gYmUgdHJhbnNmZXJyZWQKICAgIGZ1bmN0aW9uIFRyYW5zZmVyYWJsZSgpIGNvbnN0YW50IGV4dGVybmFsIHJldHVybnMgKGJvb2wpOwogICAgCiAgICAvLy8gQHBhcmFtIF9vd25lciBUaGUgYWRkcmVzcyBvZiB0aGUgYWNjb3VudCBvd25pbmcgdG9rZW5zCiAgICAvLy8gQHBhcmFtIF9zcGVuZGVyIFRoZSBhZGRyZXNzIG9mIHRoZSBhY2NvdW50IGFibGUgdG8gdHJhbnNmZXIgdGhlIHRva2VucwogICAgLy8vIEByZXR1cm4gUXVhbnRpdHkgb2YgcmVtYWluaW5nIHRva2VucyBvZiBfb3duZXIgdGhhdCBfc3BlbmRlciBpcyBhbGxvd2VkIHRvIHNwZW5kCiAgICBmdW5jdGlvbiBhbGxvd2FuY2UoYWRkcmVzcyBfb3duZXIsIGFkZHJlc3MgX3NwZW5kZXIpIGNvbnN0YW50IGV4dGVybmFsIHJldHVybnMgKHVpbnQyNTYgcmVtYWluaW5nKTsKICAgIAogICAgLy8vIEBwYXJhbSBfcHJvcG9zYWxJRCBJbmRleCBvZiB0aGUgZnVuZGluZyBvciBwcm9wb3NhbAogICAgLy8vIEByZXR1cm4gVGhlIHJlc3VsdCAoaW4gd2VpKSBvZiB0aGUgZnVuZGluZwogICAgZnVuY3Rpb24gRnVuZGVkQW1vdW50KHVpbnQgX3Byb3Bvc2FsSUQpIGNvbnN0YW50IGV4dGVybmFsIHJldHVybnMgKHVpbnQpOwoKICAgIC8vLyBAcGFyYW0gX3Byb3Bvc2FsSUQgSW5kZXggb2YgdGhlIGZ1bmRpbmcgb3IgcHJvcG9zYWwKICAgIC8vLyBAcmV0dXJuIFRoZSBhbW91bnQgdG8gZnVuZAogICAgZnVuY3Rpb24gQW1vdW50VG9GdW5kKHVpbnQgX3Byb3Bvc2FsSUQpIGNvbnN0YW50IGV4dGVybmFsIHJldHVybnMgKHVpbnQpOwogICAgCiAgICAvLy8gQHBhcmFtIF9wcm9wb3NhbElEIEluZGV4IG9mIHRoZSBmdW5kaW5nIG9yIHByb3Bvc2FsCiAgICAvLy8gQHJldHVybiB0aGUgdG9rZW4gcHJpY2UgbXVsdGlwbGllcgogICAgZnVuY3Rpb24gcHJpY2VNdWx0aXBsaWVyKHVpbnQgX3Byb3Bvc2FsSUQpIGNvbnN0YW50IGludGVybmFsIHJldHVybnMgKHVpbnQpOwogICAgCiAgICAvLy8gQHBhcmFtIF9wcm9wb3NhbElEIEluZGV4IG9mIHRoZSBmdW5kaW5nIG9yIHByb3Bvc2FsCiAgICAvLy8gQHBhcmFtIF9zYWxlRGF0ZSBpbiBjYXNlIG9mIHByZXNhbGUsIHRoZSBkYXRlIG9mIHRoZSBwcmVzYWxlCiAgICAvLy8gQHJldHVybiB0aGUgc2hhcmUgb3IgdG9rZW4gcHJpY2UgZGl2aXNvciBjb25kaWRlcmluZyB0aGUgc2FsZSBkYXRlIGFuZCB0aGUgaW5mbGF0aW9uIHJhdGUKICAgIGZ1bmN0aW9uIHByaWNlRGl2aXNvcigKICAgICAgICB1aW50IF9wcm9wb3NhbElELCAKICAgICAgICB1aW50IF9zYWxlRGF0ZSkgY29uc3RhbnQgaW50ZXJuYWwgcmV0dXJucyAodWludCk7CiAgICAKICAgIC8vLyBAcGFyYW0gX3Byb3Bvc2FsSUQgSW5kZXggb2YgdGhlIGZ1bmRpbmcgb3IgcHJvcG9zYWwKICAgIC8vLyBAcmV0dXJuIHRoZSBhY3R1YWwgcHJpY2UgZGl2aXNvciBvZiBhIHNoYXJlIG9yIHRva2VuCiAgICBmdW5jdGlvbiBhY3R1YWxQcmljZURpdmlzb3IodWludCBfcHJvcG9zYWxJRCkgY29uc3RhbnQgaW50ZXJuYWwgcmV0dXJucyAodWludCk7CgogICAgLy8vIEBkZXYgSW50ZXJuYWwgZnVuY3Rpb24gdG8gY2FsY3VsYXRlIHRoZSBhbW91bnQgaW4gdG9rZW5zIGFjY29yZGluZyB0byBhIHByaWNlICAgIAogICAgLy8vIEBwYXJhbSBfd2VpQW1vdW50IFRoZSBhbW91bnQgKGluIHdlaSkKICAgIC8vLyBAcGFyYW0gX3ByaWNlTXVsdGlwbGllciBUaGUgcHJpY2UgbXVsdGlwbGllcgogICAgLy8vIEBwYXJhbSBfcHJpY2VEaXZpc29yIFRoZSBwcmljZSBkaXZpc29yCiAgICAvLy8gQHJldHVybiB0aGUgYW1vdW50IGluIHRva2VucyAKICAgIGZ1bmN0aW9uIFRva2VuQW1vdW50KAogICAgICAgIHVpbnQgX3dlaUFtb3VudCwKICAgICAgICB1aW50IF9wcmljZU11bHRpcGxpZXIsIAogICAgICAgIHVpbnQgX3ByaWNlRGl2aXNvcikgY29uc3RhbnQgaW50ZXJuYWwgcmV0dXJucyAodWludCk7CgogICAgLy8vIEBkZXYgSW50ZXJuYWwgZnVuY3Rpb24gdG8gY2FsY3VsYXRlIHRoZSBhbW91bnQgaW4gd2VpIGFjY29yZGluZyB0byBhIHByaWNlICAgIAogICAgLy8vIEBwYXJhbSBfdG9rZW5BbW91bnQgVGhlIGFtb3VudCAoaW4gd2VpKQogICAgLy8vIEBwYXJhbSBfcHJpY2VNdWx0aXBsaWVyIFRoZSBwcmljZSBtdWx0aXBsaWVyCiAgICAvLy8gQHBhcmFtIF9wcmljZURpdmlzb3IgVGhlIHByaWNlIGRpdmlzb3IKICAgIC8vLyBAcmV0dXJuIHRoZSBhbW91bnQgaW4gd2VpCiAgICBmdW5jdGlvbiB3ZWlBbW91bnQoCiAgICAgICAgdWludCBfdG9rZW5BbW91bnQsIAogICAgICAgIHVpbnQgX3ByaWNlTXVsdGlwbGllciwgCiAgICAgICAgdWludCBfcHJpY2VEaXZpc29yKSBjb25zdGFudCBpbnRlcm5hbCByZXR1cm5zICh1aW50KTsKICAgICAgICAKICAgIC8vLyBAcGFyYW0gX3Rva2VuQW1vdW50IFRoZSBhbW91bnQgaW4gdG9rZW5zCiAgICAvLy8gQHBhcmFtIF9wcm9wb3NhbElEIEluZGV4IG9mIHRoZSBjbGllbnQgcHJvcG9zYWwuIDAgaWYgbm90IGxpbmtlZCB0byBhIHByb3Bvc2FsLgogICAgLy8vIEByZXR1cm4gdGhlIGFjdHVhbCB0b2tlbiBwcmljZSBpbiB3ZWkKICAgIGZ1bmN0aW9uIFRva2VuUHJpY2VJbldlaSh1aW50IF90b2tlbkFtb3VudCwgdWludCBfcHJvcG9zYWxJRCkgY29uc3RhbnQgcmV0dXJucyAodWludCk7CiAgICAKICAgIC8vLyBAcmV0dXJuIFRoZSBpbmRleCBvZiB0aGUgbGFzdCBmdW5kaW5nIGFuZCBjbGllbnQncyBwcm9wb3NhbCAKICAgIGZ1bmN0aW9uIExhc3RQcm9wb3NhbElEKCkgY29uc3RhbnQgcmV0dXJucyAodWludCk7CgogICAgLy8vIEByZXR1cm4gVGhlIG51bWJlciBvZiBzaGFyZSBvciB0b2tlbiBob2xkZXJzICh1c2VkIGZvciBjbG9uaW5nKQogICAgZnVuY3Rpb24gbnVtYmVyT2ZIb2xkZXJzKCkgY29uc3RhbnQgcmV0dXJucyAodWludCk7CgogICAgLy8vIEBwYXJhbSBfaW5kZXggVGhlIGluZGV4IG9mIHRoZSBob2xkZXIKICAgIC8vLyBAcmV0dXJuIHRoZSBhZGRyZXNzIG9mIHRoZSBob2xkZXIKICAgIGZ1bmN0aW9uIEhvbGRlckFkZHJlc3ModWludCBfaW5kZXgpIGNvbnN0YW50IGV4dGVybmFsIHJldHVybnMgKGFkZHJlc3MpOwogICAKICAgIC8vLyBAZGV2IFRoZSBjb25zdHJ1Y3RvciBmdW5jdGlvbgogICAgLy8vIEBwYXJhbSBfcGFzc0RhbyBBZGRyZXNzIG9mIHRoZSBwYXNzIERhbyBzbWFydCBjb250cmFjdAogICAgLy8vIEBwYXJhbSBfY2xvbmVkRnJvbSBUaGUgYWRkcmVzcyBvZiB0aGUgbGFzdCBNYW5hZ2VyIGJlZm9yZSBjbG9uaW5nCiAgICAvLy8gQHBhcmFtIF90b2tlbk5hbWUgVGhlIHRva2VuIG5hbWUgZm9yIGRpc3BsYXkgcHVycG9zZQogICAgLy8vIEBwYXJhbSBfdG9rZW5TeW1ib2wgVGhlIHRva2VuIHN5bWJvbCBmb3IgZGlzcGxheSBwdXJwb3NlCiAgICAvLy8gQHBhcmFtIF90b2tlbkRlY2ltYWxzIFRoZSBxdWFudGl0eSBvZiBkZWNpbWFscyBmb3IgZGlzcGxheSBwdXJwb3NlCiAgICAvLy8gQHBhcmFtICBfdG9rZW4gVHJ1ZSBpZiB0b2tlbnMsIGZhbHNlIGlmIHNoYXJlcwogICAgLy8vIEBwYXJhbSAgX3RyYW5zZmVyYWJsZSBUcnVlIGlmIHRva2VucyBjYW4gYmUgdHJhbnNmZXJyZWQKICAgIC8vLyBAcGFyYW0gX2luaXRpYWxQcmljZU11bHRpcGxpZXIgUHJpY2UgbXVsdGlwbGllciB3aXRob3V0IGNvbnNpZGVyaW5nIGFueSBpbmZsYXRpb24gcmF0ZQogICAgLy8vIEBwYXJhbSBfaW5mbGF0aW9uUmF0ZSBJZiAwLCB0aGUgdG9rZW4gcHJpY2UgZG9lc24ndCBjaGFuZ2UgZHVyaW5nIHRoZSBmdW5kaW5nCiAgICAvL2Z1bmN0aW9uIFBhc3NUb2tlbk1hbmFnZXIoCiAgICAvLyAgICBhZGRyZXNzIF9wYXNzRGFvLAogICAgLy8gICAgYWRkcmVzcyBfY2xvbmVkRnJvbSwKICAgIC8vICAgIHN0cmluZyBfdG9rZW5OYW1lLAogICAgLy8gICAgc3RyaW5nIF90b2tlblN5bWJvbCwKICAgIC8vICAgIHVpbnQ4IF90b2tlbkRlY2ltYWxzLAogICAgLy8gICAgYm9vbCBfdG9rZW4sCiAgICAvLyAgICBib29sIF90cmFuc2ZlcmFibGUsCiAgICAvLyAgICB1aW50IF9pbml0aWFsUHJpY2VNdWx0aXBsaWVyLAogICAgLy8gICAgdWludCBfaW5mbGF0aW9uUmF0ZSk7CiAgICAKICAgIC8vLyBAZGV2IEZ1bmN0aW9uIHRvIGNyZWF0ZSBpbml0aWFsIHRva2VucyAgICAKICAgIC8vLyBAcGFyYW0gX3JlY2lwaWVudCBUaGUgYmVuZWZpY2lhcnkgb2YgdGhlIGNyZWF0ZWQgdG9rZW5zCiAgICAvLy8gQHBhcmFtIF9xdWFudGl0eSBUaGUgcXVhbnRpdHkgb2YgdG9rZW5zIHRvIGNyZWF0ZSAgICAKICAgIC8vLyBAcGFyYW0gX2xhc3QgVHJ1ZSBpZiB0aGUgaW5pdGlhbCB0b2tlbiBzdXBweSBpcyBvdmVyCiAgICAvLy8gQHJldHVybiBXaGV0aGVyIHRoZSBmdW5jdGlvbiB3YXMgc3VjY2Vzc2Z1bCBvciBub3QgICAgIAogICAgZnVuY3Rpb24gaW5pdGlhbFRva2VuU3VwcGx5KAogICAgICAgIGFkZHJlc3MgX3JlY2lwaWVudCwgCiAgICAgICAgdWludCBfcXVhbnRpdHksCiAgICAgICAgYm9vbCBfbGFzdCkgcmV0dXJucyAoYm9vbCBzdWNjZXNzKTsKICAgICAgICAKICAgIC8vLyBAbm90aWNlIEZ1bmN0aW9uIHRvIGNsb25lIHRva2VucyBiZWZvcmUgdXBncmFkaW5nCiAgICAvLy8gQHBhcmFtIF9mcm9tIFRoZSBpbmRleCBvZiB0aGUgZmlyc3QgaG9sZGVyCiAgICAvLy8gQHBhcmFtIF90byBUaGUgaW5kZXggb2YgdGhlIGxhc3QgaG9sZGVyCiAgICAvLy8gQHJldHVybiBXaGV0aGVyIHRoZSBmdW5jdGlvbiB3YXMgc3VjY2Vzc2Z1bCBvciBub3QgCiAgICBmdW5jdGlvbiBjbG9uZVRva2VucygKICAgICAgICB1aW50IF9mcm9tLAogICAgICAgIHVpbnQgX3RvKSByZXR1cm5zIChib29sIHN1Y2Nlc3MpOwoKICAgIC8vLyBAZGV2IEludGVybmFsIGZ1bmN0aW9uIHRvIGFkZCBhIG5ldyB0b2tlbiBvciBzaGFyZSBob2xkZXIKICAgIC8vLyBAcGFyYW0gX2hvbGRlciBUaGUgYWRkcmVzcyBvZiB0aGUgdG9rZW4gb3Igc2hhcmUgaG9sZGVyCiAgICBmdW5jdGlvbiBhZGRIb2xkZXIoYWRkcmVzcyBfaG9sZGVyKSBpbnRlcm5hbDsKICAgIAogICAgLy8vIEBkZXYgSW50ZXJuYWwgZnVuY3Rpb24gdG8gY3JlYXRlIGluaXRpYWwgdG9rZW5zICAgIAogICAgLy8vIEBwYXJhbSBfaG9sZGVyIFRoZSBiZW5lZmljaWFyeSBvZiB0aGUgY3JlYXRlZCB0b2tlbnMKICAgIC8vLyBAcGFyYW0gX3Rva2VuQW1vdW50IFRoZSBhbW91bnQgaW4gdG9rZW5zIHRvIGNyZWF0ZQogICAgZnVuY3Rpb24gY3JlYXRlVG9rZW5zKAogICAgICAgIGFkZHJlc3MgX2hvbGRlciwgCiAgICAgICAgdWludCBfdG9rZW5BbW91bnQpIGludGVybmFsOwogICAgICAgIAogICAgLy8vIEBub3RpY2UgRnVuY3Rpb24gdXNlZCBieSB0aGUgY2xpZW50IHRvIHBheSB3aXRoIHNoYXJlcyBvciB0b2tlbnMKICAgIC8vLyBAcGFyYW0gX3JlY2lwaWVudCBUaGUgYWRkcmVzcyBvZiB0aGUgcmVjaXBpZW50IG9mIHNoYXJlcyBvciB0b2tlbnMKICAgIC8vLyBAcGFyYW0gX2Ftb3VudCBUaGUgYW1vdW50IChpbiBXZWkpIHRvIGNhbGN1bGF0ZSB0aGUgcXVhbnRpdHkgb2Ygc2hhcmVzIG9yIHRva2VucyB0byBjcmVhdGUKICAgIC8vLyBAcmV0dXJuIHRoZSByZXdhcmRlZCBhbW91bnQgaW4gdG9rZW5zIG9yIHNoYXJlcwogICAgZnVuY3Rpb24gcmV3YXJkVG9rZW5zRm9yQ2xpZW50KAogICAgICAgIGFkZHJlc3MgX3JlY2lwaWVudCwgCiAgICAgICAgdWludCBfYW1vdW50KSBleHRlcm5hbCAgcmV0dXJucyAodWludCk7CiAgICAgICAgCiAgICAvLy8gQG5vdGljZSBGdW5jdGlvbiB0byBzZXQgYSBmdW5kaW5nCiAgICAvLy8gQHBhcmFtIF9tb2RlcmF0b3IgVGhlIGFkZHJlc3Mgb2YgdGhlIHNtYXJ0IGNvbnRyYWN0IHRvIG1hbmFnZSBhIHByaXZhdGUgZnVuZGluZwogICAgLy8vIEBwYXJhbSBfaW5pdGlhbFByaWNlTXVsdGlwbGllciBQcmljZSBtdWx0aXBsaWVyIHdpdGhvdXQgY29uc2lkZXJpbmcgYW55IGluZmxhdGlvbiByYXRlCiAgICAvLy8gQHBhcmFtIF9hbW91bnRUb0Z1bmQgVGhlIGFtb3VudCAoaW4gd2VpKSBvZiB0aGUgZnVuZGluZwogICAgLy8vIEBwYXJhbSBfbWludXRlc0Z1bmRpbmdQZXJpb2QgUGVyaW9kIGluIG1pbnV0ZXMgb2YgdGhlIGZ1bmRpbmcKICAgIC8vLyBAcGFyYW0gX2luZmxhdGlvblJhdGUgSWYgMCwgdGhlIHRva2VuIHByaWNlIGRvZXNuJ3QgY2hhbmdlIGR1cmluZyB0aGUgZnVuZGluZwogICAgLy8vIEBwYXJhbSBfcHJvcG9zYWxJRCBJbmRleCBvZiB0aGUgY2xpZW50IHByb3Bvc2FsCiAgICBmdW5jdGlvbiBzZXRGdW5kaW5nUnVsZXMoCiAgICAgICAgYWRkcmVzcyBfbW9kZXJhdG9yLAogICAgICAgIHVpbnQgX2luaXRpYWxQcmljZU11bHRpcGxpZXIsCiAgICAgICAgdWludCBfYW1vdW50VG9GdW5kLAogICAgICAgIHVpbnQgX21pbnV0ZXNGdW5kaW5nUGVyaW9kLCAKICAgICAgICB1aW50IF9pbmZsYXRpb25SYXRlLAogICAgICAgIHVpbnQgX3Byb3Bvc2FsSUQpIGV4dGVybmFsOwoKICAgIC8vLyBAZGV2IEludGVybmFsIGZ1bmN0aW9uIGZvciB0aGUgc2FsZSBvZiBzaGFyZXMgb3IgdG9rZW5zCiAgICAvLy8gQHBhcmFtIF9wcm9wb3NhbElEIEluZGV4IG9mIHRoZSBjbGllbnQgcHJvcG9zYWwKICAgIC8vLyBAcGFyYW0gX3JlY2lwaWVudCBUaGUgcmVjaXBpZW50IGFkZHJlc3Mgb2Ygc2hhcmVzIG9yIHRva2VucwogICAgLy8vIEBwYXJhbSBfYW1vdW50IFRoZSBmdW5kZWQgYW1vdW50IChpbiB3ZWkpCiAgICAvLy8gQHBhcmFtIF9zYWxlRGF0ZSBJbiBjYXNlIG9mIHByZXNhbGUsIHRoZSBkYXRlIG9mIHRoZSBwcmVzYWxlCiAgICAvLy8gQHBhcmFtIF9wcmVzYWxlIFRydWUgaWYgcHJlc2FsZQogICAgLy8vIEByZXR1cm4gV2hldGhlciB0aGUgY3JlYXRpb24gd2FzIHN1Y2Nlc3NmdWwgb3Igbm90CiAgICBmdW5jdGlvbiBzYWxlKAogICAgICAgIHVpbnQgX3Byb3Bvc2FsSUQsCiAgICAgICAgYWRkcmVzcyBfcmVjaXBpZW50LCAKICAgICAgICB1aW50IF9hbW91bnQsCiAgICAgICAgdWludCBfc2FsZURhdGUsCiAgICAgICAgYm9vbCBfcHJlc2FsZQogICAgKSBpbnRlcm5hbCByZXR1cm5zIChib29sIHN1Y2Nlc3MpOwogICAgCiAgICAvLy8gQGRldiBJbnRlcm5hbCBmdW5jdGlvbiB0byBjbG9zZSB0aGUgYWN0dWFsIGZ1bmRpbmcKICAgIC8vLyBAcGFyYW0gX3Byb3Bvc2FsSUQgSW5kZXggb2YgdGhlIGNsaWVudCBwcm9wb3NhbAogICAgZnVuY3Rpb24gY2xvc2VGdW5kaW5nKHVpbnQgX3Byb3Bvc2FsSUQpIGludGVybmFsOwogICAKICAgIC8vLyBAbm90aWNlIEZ1bmN0aW9uIHRvIHNlbmQgdG9rZW5zIG9yIHJlZnVuZCBhZnRlciB0aGUgY2xvc2luZyB0aW1lIG9mIHRoZSBmdW5kaW5nIHByb3Bvc2FscwogICAgLy8vIEBwYXJhbSBfZnJvbSBUaGUgZmlyc3QgcHJvcG9zYWwuIDAgaWYgbm90IGxpbmtlZCB0byBhIHByb3Bvc2FsCiAgICAvLy8gQHBhcmFtIF90byBUaGUgbGFzdCBwcm9wb3NhbAogICAgLy8vIEBwYXJhbSBfYnV5ZXIgVGhlIGFkZHJlc3Mgb2YgdGhlIGJ1eWVyCiAgICAvLy8gQHJldHVybiBXaGV0aGVyIHRoZSBmdW5jdGlvbiB3YXMgc3VjY2Vzc2Z1bCBvciBub3QgCiAgICBmdW5jdGlvbiBzZW5kUGVuZGluZ0Ftb3VudHMoICAgICAgICAKICAgICAgICB1aW50IF9mcm9tLAogICAgICAgIHVpbnQgX3RvLAogICAgICAgIGFkZHJlc3MgX2J1eWVyKSByZXR1cm5zIChib29sKTsKICAgICAgICAKICAgIC8vLyBAbm90aWNlIEZ1bmN0aW9uIHRvIGdldCBmZWVzLCBzaGFyZXMgb3IgcmVmdW5kIGFmdGVyIHRoZSBjbG9zaW5nIHRpbWUgb2YgdGhlIGZ1bmRpbmcgcHJvcG9zYWxzCiAgICAvLy8gQHJldHVybiBXaGV0aGVyIHRoZSBmdW5jdGlvbiB3YXMgc3VjY2Vzc2Z1bCBvciBub3QKICAgIGZ1bmN0aW9uIHdpdGhkcmF3UGVuZGluZ0Ftb3VudHMoKSByZXR1cm5zIChib29sKTsKICAgIAogICAgLy8vIEBub3RpY2UgRnVuY3Rpb24gdXNlZCBieSB0aGUgbWFpbiBwYXJ0bmVyIHRvIHNldCB0aGUgc3RhcnQgdGltZSBvZiB0aGUgZnVuZGluZwogICAgLy8vIEBwYXJhbSBfcHJvcG9zYWxJRCBJbmRleCBvZiB0aGUgY2xpZW50IHByb3Bvc2FsCiAgICAvLy8gQHBhcmFtIF9zdGFydFRpbWUgVGhlIHVuaXggc3RhcnQgZGF0ZSBvZiB0aGUgZnVuZGluZyAKICAgIGZ1bmN0aW9uIHNldEZ1bmRpbmdTdGFydFRpbWUoCiAgICAgICAgdWludCBfcHJvcG9zYWxJRCwgCiAgICAgICAgdWludCBfc3RhcnRUaW1lKSBleHRlcm5hbDsKICAgIAogICAgLy8vIEBub3RpY2UgRnVuY3Rpb24gdXNlZCBieSB0aGUgbWFpbiBwYXJ0bmVyIHRvIHNldCB0aGUgZnVuZGluZyBmdWVsZWQKICAgIC8vLyBAcGFyYW0gX3Byb3Bvc2FsSUQgSW5kZXggb2YgdGhlIGNsaWVudCBwcm9wb3NhbAogICAgZnVuY3Rpb24gc2V0RnVuZGluZ0Z1ZWxlZCh1aW50IF9wcm9wb3NhbElEKSBleHRlcm5hbDsKCiAgICAvLy8gQG5vdGljZSBGdW5jdGlvbiB0byBhYmxlIHRoZSB0cmFuc2ZlciBvZiBEYW8gc2hhcmVzIG9yIGNvbnRyYWN0b3IgdG9rZW5zCiAgICBmdW5jdGlvbiBhYmxlVHJhbnNmZXIoKTsKCiAgICAvLy8gQG5vdGljZSBGdW5jdGlvbiB0byBkaXNhYmxlIHRoZSB0cmFuc2ZlciBvZiBEYW8gc2hhcmVzCiAgICBmdW5jdGlvbiBkaXNhYmxlVHJhbnNmZXIoKTsKCiAgICAvLy8gQG5vdGljZSBGdW5jdGlvbiB1c2VkIGJ5IHRoZSBjbGllbnQgdG8gYmxvY2sgdGhlIHRyYW5zZmVyIG9mIHNoYXJlcyBmcm9tIGFuZCB0byBhIHNoYXJlIGhvbGRlcgogICAgLy8vIEBwYXJhbSBfc2hhcmVIb2xkZXIgVGhlIGFkZHJlc3Mgb2YgdGhlIHNoYXJlIGhvbGRlcgogICAgLy8vIEBwYXJhbSBfZGVhZExpbmUgV2hlbiB0aGUgYWNjb3VudCB3aWxsIGJlIHVuYmxvY2tlZAogICAgZnVuY3Rpb24gYmxvY2tUcmFuc2ZlcigKICAgICAgICBhZGRyZXNzIF9zaGFyZUhvbGRlciwgCiAgICAgICAgdWludCBfZGVhZExpbmUpIGV4dGVybmFsOwogICAgCiAgICAvLy8gQGRldiBJbnRlcm5hbCBmdW5jdGlvbiB0byBzZW5kIGBfdmFsdWVgIHRva2VuIHRvIGBfdG9gIGZyb20gYF9Gcm9tYAogICAgLy8vIEBwYXJhbSBfZnJvbSBUaGUgYWRkcmVzcyBvZiB0aGUgc2VuZGVyCiAgICAvLy8gQHBhcmFtIF90byBUaGUgYWRkcmVzcyBvZiB0aGUgcmVjaXBpZW50CiAgICAvLy8gQHBhcmFtIF92YWx1ZSBUaGUgcXVhbnRpdHkgb2Ygc2hhcmVzIG9yIHRva2VucyB0byBiZSB0cmFuc2ZlcnJlZAogICAgLy8vIEByZXR1cm4gV2hldGhlciB0aGUgZnVuY3Rpb24gd2FzIHN1Y2Nlc3NmdWwgb3Igbm90IAogICAgZnVuY3Rpb24gdHJhbnNmZXJGcm9tVG8oCiAgICAgICAgYWRkcmVzcyBfZnJvbSwKICAgICAgICBhZGRyZXNzIF90bywgCiAgICAgICAgdWludDI1NiBfdmFsdWUKICAgICAgICApIGludGVybmFsIHJldHVybnMgKGJvb2wgc3VjY2Vzcyk7CiAgICAKICAgIC8vLyBAbm90aWNlIHNlbmQgYF92YWx1ZWAgdG9rZW4gdG8gYF90b2AgZnJvbSBgbXNnLnNlbmRlcmAKICAgIC8vLyBAcGFyYW0gX3RvIFRoZSBhZGRyZXNzIG9mIHRoZSByZWNpcGllbnQKICAgIC8vLyBAcGFyYW0gX3ZhbHVlIFRoZSBxdWFudGl0eSBvZiBzaGFyZXMgb3IgdG9rZW5zIHRvIGJlIHRyYW5zZmVycmVkCiAgICAvLy8gQHJldHVybiBXaGV0aGVyIHRoZSBmdW5jdGlvbiB3YXMgc3VjY2Vzc2Z1bCBvciBub3QgCiAgICBmdW5jdGlvbiB0cmFuc2ZlcihhZGRyZXNzIF90bywgdWludDI1NiBfdmFsdWUpIHJldHVybnMgKGJvb2wgc3VjY2Vzcyk7CgogICAgLy8vIEBub3RpY2Ugc2VuZCBgX3ZhbHVlYCB0b2tlbiB0byBgX3RvYCBmcm9tIGBfZnJvbWAgb24gdGhlIGNvbmRpdGlvbiBpdCBpcyBhcHByb3ZlZCBieSBgX2Zyb21gCiAgICAvLy8gQHBhcmFtIF9mcm9tIFRoZSBhZGRyZXNzIG9mIHRoZSBzZW5kZXIKICAgIC8vLyBAcGFyYW0gX3RvIFRoZSBhZGRyZXNzIG9mIHRoZSByZWNpcGllbnQKICAgIC8vLyBAcGFyYW0gX3ZhbHVlIFRoZSBxdWFudGl0eSBvZiBzaGFyZXMgb3IgdG9rZW5zIHRvIGJlIHRyYW5zZmVycmVkCiAgICBmdW5jdGlvbiB0cmFuc2ZlckZyb20oCiAgICAgICAgYWRkcmVzcyBfZnJvbSwgCiAgICAgICAgYWRkcmVzcyBfdG8sIAogICAgICAgIHVpbnQyNTYgX3ZhbHVlCiAgICAgICAgKSByZXR1cm5zIChib29sIHN1Y2Nlc3MpOwoKICAgIC8vLyBAbm90aWNlIGBtc2cuc2VuZGVyYCBhcHByb3ZlcyBgX3NwZW5kZXJgIHRvIHNwZW5kIGBfYW1vdW50YCB0b2tlbnMgb24gaXRzIGJlaGFsZgogICAgLy8vIEBwYXJhbSBfc3BlbmRlciBUaGUgYWRkcmVzcyBvZiB0aGUgYWNjb3VudCBhYmxlIHRvIHRyYW5zZmVyIHRoZSB0b2tlbnMKICAgIC8vLyBAcGFyYW0gX3ZhbHVlIFRoZSBhbW91bnQgb2YgdG9rZW5zIHRvIGJlIGFwcHJvdmVkIGZvciB0cmFuc2ZlcgogICAgLy8vIEByZXR1cm4gV2hldGhlciB0aGUgYXBwcm92YWwgd2FzIHN1Y2Nlc3NmdWwgb3Igbm90CiAgICBmdW5jdGlvbiBhcHByb3ZlKAogICAgICAgIGFkZHJlc3MgX3NwZW5kZXIsIAogICAgICAgIHVpbnQyNTYgX3ZhbHVlKSByZXR1cm5zIChib29sIHN1Y2Nlc3MpOwogICAgCiAgICBldmVudCBUb2tlbnNDcmVhdGVkKGFkZHJlc3MgaW5kZXhlZCBTZW5kZXIsIGFkZHJlc3MgaW5kZXhlZCBUb2tlbkhvbGRlciwgdWludCBUb2tlbkFtb3VudCk7CiAgICBldmVudCBGdW5kaW5nUnVsZXNTZXQoYWRkcmVzcyBpbmRleGVkIE1vZGVyYXRvciwgdWludCBpbmRleGVkIFByb3Bvc2FsSWQsIHVpbnQgQW1vdW50VG9GdW5kLCB1aW50IGluZGV4ZWQgU3RhcnRUaW1lLCB1aW50IENsb3NpbmdUaW1lKTsKICAgIGV2ZW50IEZ1bmRpbmdGdWVsZWQodWludCBpbmRleGVkIFByb3Bvc2FsSUQsIHVpbnQgRnVuZGVkQW1vdW50KTsKICAgIGV2ZW50IFRyYW5zZmVyQWJsZSgpOwogICAgZXZlbnQgVHJhbnNmZXJEaXNhYmxlKCk7CiAgICBldmVudCBUcmFuc2ZlcihhZGRyZXNzIGluZGV4ZWQgX2Zyb20sIGFkZHJlc3MgaW5kZXhlZCBfdG8sIHVpbnQyNTYgX3ZhbHVlKTsKICAgIGV2ZW50IFJlZnVuZChhZGRyZXNzIGluZGV4ZWQgQnV5ZXIsIHVpbnQgQW1vdW50KTsKICAgIAp9ICAgIAoKY29udHJhY3QgUGFzc1Rva2VuTWFuYWdlciBpcyBQYXNzVG9rZW5NYW5hZ2VySW50ZXJmYWNlIHsKCi8vIENvbnN0YW50IGZ1bmN0aW9ucwoKICAgIGZ1bmN0aW9uIENsaWVudCgpIGNvbnN0YW50IHJldHVybnMgKGFkZHJlc3MpIHsKICAgICAgICByZXR1cm4gcGFzc0Rhby5BY3R1YWxDb21taXR0ZWVSb29tKCk7CiAgICB9CiAgIAogICAgZnVuY3Rpb24gdG90YWxTdXBwbHkoKSBjb25zdGFudCBleHRlcm5hbCByZXR1cm5zICh1aW50MjU2KSB7CiAgICAgICAgcmV0dXJuIHRvdGFsVG9rZW5TdXBwbHk7CiAgICB9CiAgICAKICAgIGZ1bmN0aW9uIGJhbGFuY2VPZihhZGRyZXNzIF9vd25lcikgY29uc3RhbnQgZXh0ZXJuYWwgcmV0dXJucyAodWludDI1NiBiYWxhbmNlKSB7CiAgICAgICAgcmV0dXJuIGJhbGFuY2VzW19vd25lcl07CiAgICB9CiAgICAgCiAgICBmdW5jdGlvbiBUcmFuc2ZlcmFibGUoKSBjb25zdGFudCBleHRlcm5hbCByZXR1cm5zIChib29sKSB7CiAgICAgICAgcmV0dXJuIHRyYW5zZmVyYWJsZTsKICAgIH0KIAogICAgZnVuY3Rpb24gYWxsb3dhbmNlKAogICAgICAgIGFkZHJlc3MgX293bmVyLCAKICAgICAgICBhZGRyZXNzIF9zcGVuZGVyKSBjb25zdGFudCBleHRlcm5hbCByZXR1cm5zICh1aW50MjU2IHJlbWFpbmluZykgewogICAgICAgIHJldHVybiBhbGxvd2VkW19vd25lcl1bX3NwZW5kZXJdOwogICAgfQoKICAgIGZ1bmN0aW9uIEZ1bmRlZEFtb3VudCh1aW50IF9wcm9wb3NhbElEKSBjb25zdGFudCBleHRlcm5hbCByZXR1cm5zICh1aW50KSB7CiAgICAgICAgcmV0dXJuIGZ1bmRpbmdzW19wcm9wb3NhbElEXS5mdW5kZWRBbW91bnQ7CiAgICB9CiAgCiAgICBmdW5jdGlvbiBBbW91bnRUb0Z1bmQodWludCBfcHJvcG9zYWxJRCkgY29uc3RhbnQgZXh0ZXJuYWwgcmV0dXJucyAodWludCkgewoKICAgICAgICBpZiAobm93ID4gZnVuZGluZ3NbX3Byb3Bvc2FsSURdLmNsb3NpbmdUaW1lCiAgICAgICAgICAgIHx8IG5vdyA8IGZ1bmRpbmdzW19wcm9wb3NhbElEXS5zdGFydFRpbWUpIHsKICAgICAgICAgICAgcmV0dXJuIDA7ICAgCiAgICAgICAgICAgIH0gZWxzZSByZXR1cm4gZnVuZGluZ3NbX3Byb3Bvc2FsSURdLmFtb3VudFRvRnVuZDsKICAgIH0KICAgIAogICAgZnVuY3Rpb24gcHJpY2VNdWx0aXBsaWVyKHVpbnQgX3Byb3Bvc2FsSUQpIGNvbnN0YW50IGludGVybmFsIHJldHVybnMgKHVpbnQpIHsKICAgICAgICByZXR1cm4gZnVuZGluZ3NbX3Byb3Bvc2FsSURdLmluaXRpYWxQcmljZU11bHRpcGxpZXI7CiAgICB9CiAgICAKICAgIGZ1bmN0aW9uIHByaWNlRGl2aXNvcih1aW50IF9wcm9wb3NhbElELCB1aW50IF9zYWxlRGF0ZSkgY29uc3RhbnQgaW50ZXJuYWwgcmV0dXJucyAodWludCkgewogICAgICAgIHVpbnQgX2RhdGUgPSBfc2FsZURhdGU7CiAgICAgICAgCiAgICAgICAgaWYgKF9zYWxlRGF0ZSA+IGZ1bmRpbmdzW19wcm9wb3NhbElEXS5jbG9zaW5nVGltZSkgX2RhdGUgPSBmdW5kaW5nc1tfcHJvcG9zYWxJRF0uY2xvc2luZ1RpbWU7CiAgICAgICAgaWYgKF9zYWxlRGF0ZSA8IGZ1bmRpbmdzW19wcm9wb3NhbElEXS5zdGFydFRpbWUpIF9kYXRlID0gZnVuZGluZ3NbX3Byb3Bvc2FsSURdLnN0YXJ0VGltZTsKCiAgICAgICAgcmV0dXJuIDEwMCArIDEwMCpmdW5kaW5nc1tfcHJvcG9zYWxJRF0uaW5mbGF0aW9uUmF0ZSooX2RhdGUgLSBmdW5kaW5nc1tfcHJvcG9zYWxJRF0uc3RhcnRUaW1lKS8oMTAwKjM2NSBkYXlzKTsKICAgIH0KICAgIAogICAgZnVuY3Rpb24gYWN0dWFsUHJpY2VEaXZpc29yKHVpbnQgX3Byb3Bvc2FsSUQpIGNvbnN0YW50IGludGVybmFsIHJldHVybnMgKHVpbnQpIHsKICAgICAgICByZXR1cm4gcHJpY2VEaXZpc29yKF9wcm9wb3NhbElELCBub3cpOwogICAgfQogICAgCiAgICBmdW5jdGlvbiBUb2tlbkFtb3VudCgKICAgICAgICB1aW50IF93ZWlBbW91bnQsIAogICAgICAgIHVpbnQgX3ByaWNlTXVsdGlwbGllciwgCiAgICAgICAgdWludCBfcHJpY2VEaXZpc29yKSBjb25zdGFudCBpbnRlcm5hbCByZXR1cm5zICh1aW50KSB7CiAgICAgICAgCiAgICAgICAgdWludCBfYSA9IF93ZWlBbW91bnQqX3ByaWNlTXVsdGlwbGllcjsKICAgICAgICB1aW50IF9tdWx0aXBsaWVyID0gMTAwKl9hOwogICAgICAgIHVpbnQgX2Ftb3VudCA9IF9tdWx0aXBsaWVyL19wcmljZURpdmlzb3I7CiAgICAgICAgaWYgKF9hL193ZWlBbW91bnQgIT0gX3ByaWNlTXVsdGlwbGllcgogICAgICAgICAgICB8fCBfbXVsdGlwbGllci8xMDAgIT0gX2EpIHJldHVybiAwOyAKICAgICAgICAKICAgICAgICByZXR1cm4gX2Ftb3VudDsKICAgIH0KICAgIAogICAgZnVuY3Rpb24gd2VpQW1vdW50KAogICAgICAgIHVpbnQgX3Rva2VuQW1vdW50LCAKICAgICAgICB1aW50IF9wcmljZU11bHRpcGxpZXIsIAogICAgICAgIHVpbnQgX3ByaWNlRGl2aXNvcikgY29uc3RhbnQgaW50ZXJuYWwgcmV0dXJucyAodWludCkgewogICAgICAgIAogICAgICAgIHVpbnQgX211bHRpcGxpZXIgPSBfdG9rZW5BbW91bnQqX3ByaWNlRGl2aXNvcjsKICAgICAgICB1aW50IF9kaXZpc29yID0gMTAwKl9wcmljZU11bHRpcGxpZXI7CiAgICAgICAgdWludCBfYW1vdW50ID0gX211bHRpcGxpZXIvX2Rpdmlzb3I7CiAgICAgICAgaWYgKF9tdWx0aXBsaWVyL190b2tlbkFtb3VudCAhPSBfcHJpY2VEaXZpc29yCiAgICAgICAgICAgIHx8IF9kaXZpc29yLzEwMCAhPSBfcHJpY2VNdWx0aXBsaWVyKSByZXR1cm4gMDsgCgogICAgICAgIHJldHVybiBfYW1vdW50OwogICAgfQogICAgCiAgICBmdW5jdGlvbiBUb2tlblByaWNlSW5XZWkodWludCBfdG9rZW5BbW91bnQsIHVpbnQgX3Byb3Bvc2FsSUQpIGNvbnN0YW50IHJldHVybnMgKHVpbnQpIHsKICAgICAgICByZXR1cm4gd2VpQW1vdW50KF90b2tlbkFtb3VudCwgcHJpY2VNdWx0aXBsaWVyKF9wcm9wb3NhbElEKSwgYWN0dWFsUHJpY2VEaXZpc29yKF9wcm9wb3NhbElEKSk7CiAgICB9CiAgICAKICAgIGZ1bmN0aW9uIExhc3RQcm9wb3NhbElEKCkgY29uc3RhbnQgcmV0dXJucyAodWludCkgewogICAgICAgIHJldHVybiBsYXN0UHJvcG9zYWxJRDsKICAgIH0KICAgIAogICAgZnVuY3Rpb24gbnVtYmVyT2ZIb2xkZXJzKCkgY29uc3RhbnQgcmV0dXJucyAodWludCkgewogICAgICAgIHJldHVybiBob2xkZXJzLmxlbmd0aCAtIDE7CiAgICB9CiAgICAKICAgIGZ1bmN0aW9uIEhvbGRlckFkZHJlc3ModWludCBfaW5kZXgpIGNvbnN0YW50IGV4dGVybmFsIHJldHVybnMgKGFkZHJlc3MpIHsKICAgICAgICByZXR1cm4gaG9sZGVyc1tfaW5kZXhdOwogICAgfQoKLy8gTW9kaWZpZXJzCgogICAgLy8gTW9kaWZpZXIgdGhhdCBhbGxvd3Mgb25seSB0aGUgY2xpZW50IC4uCiAgICBtb2RpZmllciBvbmx5Q2xpZW50IHtpZiAobXNnLnNlbmRlciAhPSBDbGllbnQoKSkgdGhyb3c7IF87fQogICAgICAKICAgIC8vIE1vZGlmaWVyIGZvciBzaGFyZSBNYW5hZ2VyIGZ1bmN0aW9ucwogICAgbW9kaWZpZXIgb25seVNoYXJlTWFuYWdlciB7aWYgKHRva2VuKSB0aHJvdzsgXzt9CgogICAgLy8gTW9kaWZpZXIgZm9yIHRva2VuIE1hbmFnZXIgZnVuY3Rpb25zCiAgICBtb2RpZmllciBvbmx5VG9rZW5NYW5hZ2VyIHtpZiAoIXRva2VuKSB0aHJvdzsgXzt9CiAgCi8vIENvbnN0cnVjdG9yIGZ1bmN0aW9uCgogICAgZnVuY3Rpb24gUGFzc1Rva2VuTWFuYWdlcigKICAgICAgICBQYXNzRGFvIF9wYXNzRGFvLAogICAgICAgIGFkZHJlc3MgX2Nsb25lZEZyb20sCiAgICAgICAgc3RyaW5nIF90b2tlbk5hbWUsCiAgICAgICAgc3RyaW5nIF90b2tlblN5bWJvbCwKICAgICAgICB1aW50OCBfdG9rZW5EZWNpbWFscywKICAgICAgICBib29sIF90b2tlbiwKICAgICAgICBib29sIF90cmFuc2ZlcmFibGUsCiAgICAgICAgdWludCBfaW5pdGlhbFByaWNlTXVsdGlwbGllciwKICAgICAgICB1aW50IF9pbmZsYXRpb25SYXRlKSB7CgogICAgICAgIHBhc3NEYW8gPSBfcGFzc0RhbzsKICAgICAgICBjcmVhdG9yID0gbXNnLnNlbmRlcjsKICAgICAgICAKICAgICAgICBjbG9uZWRGcm9tID0gX2Nsb25lZEZyb207ICAgICAgICAgICAgCgogICAgICAgIG5hbWUgPSBfdG9rZW5OYW1lOwogICAgICAgIHN5bWJvbCA9IF90b2tlblN5bWJvbDsKICAgICAgICBkZWNpbWFscyA9IF90b2tlbkRlY2ltYWxzOwoKICAgICAgICB0b2tlbiA9IF90b2tlbjsKICAgICAgICB0cmFuc2ZlcmFibGUgPSBfdHJhbnNmZXJhYmxlOwoKICAgICAgICBmdW5kaW5nc1swXS5pbml0aWFsUHJpY2VNdWx0aXBsaWVyID0gX2luaXRpYWxQcmljZU11bHRpcGxpZXI7CiAgICAgICAgZnVuZGluZ3NbMF0uaW5mbGF0aW9uUmF0ZSA9IF9pbmZsYXRpb25SYXRlOwoKICAgICAgICBob2xkZXJzLmxlbmd0aCA9IDE7CiAgICB9CgovLyBTZXR0aW5nIGZ1bmN0aW9ucwoKICAgIGZ1bmN0aW9uIGluaXRpYWxUb2tlblN1cHBseSgKICAgICAgICBhZGRyZXNzIF9yZWNpcGllbnQsIAogICAgICAgIHVpbnQgX3F1YW50aXR5LAogICAgICAgIGJvb2wgX2xhc3QpIHJldHVybnMgKGJvb2wgc3VjY2VzcykgewoKICAgICAgICBpZiAoaW5pdGlhbFRva2VuU3VwcGx5RG9uZSkgdGhyb3c7CiAgICAgICAgCiAgICAgICAgYWRkSG9sZGVyKF9yZWNpcGllbnQpOwogICAgICAgIGlmIChfcmVjaXBpZW50ICE9IDAgJiYgX3F1YW50aXR5ICE9IDApIGNyZWF0ZVRva2VucyhfcmVjaXBpZW50LCBfcXVhbnRpdHkpOwogICAgICAgIAogICAgICAgIGlmIChfbGFzdCkgaW5pdGlhbFRva2VuU3VwcGx5RG9uZSA9IHRydWU7CiAgICAgICAgCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgZnVuY3Rpb24gY2xvbmVUb2tlbnMoCiAgICAgICAgdWludCBfZnJvbSwKICAgICAgICB1aW50IF90bykgcmV0dXJucyAoYm9vbCBzdWNjZXNzKSB7CiAgICAgICAgCiAgICAgICAgaW5pdGlhbFRva2VuU3VwcGx5RG9uZSA9IHRydWU7CiAgICAgICAgaWYgKF9mcm9tID09IDApIF9mcm9tID0gMTsKICAgICAgICAKICAgICAgICBQYXNzVG9rZW5NYW5hZ2VyIF9jbG9uZWRGcm9tID0gUGFzc1Rva2VuTWFuYWdlcihjbG9uZWRGcm9tKTsKICAgICAgICB1aW50IF9udW1iZXJPZkhvbGRlcnMgPSBfY2xvbmVkRnJvbS5udW1iZXJPZkhvbGRlcnMoKTsKICAgICAgICBpZiAoX3RvID09IDAgfHwgX3RvID4gX251bWJlck9mSG9sZGVycykgX3RvID0gX251bWJlck9mSG9sZGVyczsKICAgICAgICAKICAgICAgICBhZGRyZXNzIF9ob2xkZXI7CiAgICAgICAgdWludCBfYmFsYW5jZTsKCiAgICAgICAgZm9yICh1aW50IGkgPSBfZnJvbTsgaSA8PSBfdG87IGkrKykgewogICAgICAgICAgICBfaG9sZGVyID0gX2Nsb25lZEZyb20uSG9sZGVyQWRkcmVzcyhpKTsKICAgICAgICAgICAgX2JhbGFuY2UgPSBfY2xvbmVkRnJvbS5iYWxhbmNlT2YoX2hvbGRlcik7CiAgICAgICAgICAgIGlmIChiYWxhbmNlc1tfaG9sZGVyXSA9PSAwICYmIF9iYWxhbmNlICE9IDApIHsKICAgICAgICAgICAgICAgIGFkZEhvbGRlcihfaG9sZGVyKTsKICAgICAgICAgICAgICAgIGNyZWF0ZVRva2VucyhfaG9sZGVyLCBfYmFsYW5jZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICAgICAgCi8vIFRva2VuIGNyZWF0aW9uCgogICAgZnVuY3Rpb24gYWRkSG9sZGVyKGFkZHJlc3MgX2hvbGRlcikgaW50ZXJuYWwgewogICAgICAgIAogICAgICAgIGlmIChob2xkZXJJRFtfaG9sZGVyXSA9PSAwKSB7CiAgICAgICAgICAgIAogICAgICAgICAgICB1aW50IF9ob2xkZXJJRCA9IGhvbGRlcnMubGVuZ3RoKys7CiAgICAgICAgICAgIGhvbGRlcnNbX2hvbGRlcklEXSA9IF9ob2xkZXI7CiAgICAgICAgICAgIGhvbGRlcklEW19ob2xkZXJdID0gX2hvbGRlcklEOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBjcmVhdGVUb2tlbnMoCiAgICAgICAgYWRkcmVzcyBfaG9sZGVyLCAKICAgICAgICB1aW50IF90b2tlbkFtb3VudCkgaW50ZXJuYWwgewoKICAgICAgICBiYWxhbmNlc1tfaG9sZGVyXSArPSBfdG9rZW5BbW91bnQ7IAogICAgICAgIHRvdGFsVG9rZW5TdXBwbHkgKz0gX3Rva2VuQW1vdW50OwogICAgICAgIFRva2Vuc0NyZWF0ZWQobXNnLnNlbmRlciwgX2hvbGRlciwgX3Rva2VuQW1vdW50KTsKICAgIH0KICAgIAogICAgZnVuY3Rpb24gcmV3YXJkVG9rZW5zRm9yQ2xpZW50KAogICAgICAgIGFkZHJlc3MgX3JlY2lwaWVudCwgCiAgICAgICAgdWludCBfYW1vdW50CiAgICAgICAgKSBleHRlcm5hbCBvbmx5Q2xpZW50IHJldHVybnMgKHVpbnQpIHsKCiAgICAgICAgdWludCBfdG9rZW5BbW91bnQgPSBUb2tlbkFtb3VudChfYW1vdW50LCBwcmljZU11bHRpcGxpZXIoMCksIGFjdHVhbFByaWNlRGl2aXNvcigwKSk7CiAgICAgICAgaWYgKF90b2tlbkFtb3VudCA9PSAwKSB0aHJvdzsKCiAgICAgICAgYWRkSG9sZGVyKF9yZWNpcGllbnQpOwogICAgICAgIGNyZWF0ZVRva2VucyhfcmVjaXBpZW50LCBfdG9rZW5BbW91bnQpOwoKICAgICAgICByZXR1cm4gX3Rva2VuQW1vdW50OwogICAgfQogICAgCiAgICBmdW5jdGlvbiBzZXRGdW5kaW5nUnVsZXMoCiAgICAgICAgYWRkcmVzcyBfbW9kZXJhdG9yLAogICAgICAgIHVpbnQgX2luaXRpYWxQcmljZU11bHRpcGxpZXIsCiAgICAgICAgdWludCBfYW1vdW50VG9GdW5kLAogICAgICAgIHVpbnQgX21pbnV0ZXNGdW5kaW5nUGVyaW9kLCAKICAgICAgICB1aW50IF9pbmZsYXRpb25SYXRlLAogICAgICAgIHVpbnQgX3Byb3Bvc2FsSUQKICAgICkgZXh0ZXJuYWwgb25seUNsaWVudCB7CgogICAgICAgIGlmIChfbW9kZXJhdG9yID09IGFkZHJlc3ModGhpcykKICAgICAgICAgICAgfHwgX21vZGVyYXRvciA9PSBDbGllbnQoKQogICAgICAgICAgICB8fCBfYW1vdW50VG9GdW5kID09IDAKICAgICAgICAgICAgfHwgX21pbnV0ZXNGdW5kaW5nUGVyaW9kID09IDAKICAgICAgICAgICAgfHwgZnVuZGluZ3NbX3Byb3Bvc2FsSURdLnRvdGFsV2VpR2l2ZW4gIT0gMAogICAgICAgICAgICApIHRocm93OwogICAgICAgICAgICAKICAgICAgICBmdW5kaW5nc1tfcHJvcG9zYWxJRF0ubW9kZXJhdG9yID0gX21vZGVyYXRvcjsKCiAgICAgICAgZnVuZGluZ3NbX3Byb3Bvc2FsSURdLmFtb3VudFRvRnVuZCA9IF9hbW91bnRUb0Z1bmQ7CiAgICAgICAgZnVuZGluZ3NbX3Byb3Bvc2FsSURdLmZ1bmRlZEFtb3VudCA9IDA7CgogICAgICAgIGlmIChfaW5pdGlhbFByaWNlTXVsdGlwbGllciA9PSAwKSB7CiAgICAgICAgICAgIGlmIChub3cgPCBmdW5kaW5nc1swXS5jbG9zaW5nVGltZSkgewogICAgICAgICAgICAgICAgZnVuZGluZ3NbX3Byb3Bvc2FsSURdLmluaXRpYWxQcmljZU11bHRpcGxpZXIgPSAxMDAqcHJpY2VNdWx0aXBsaWVyKGxhc3RQcm9wb3NhbElEKS9hY3R1YWxQcmljZURpdmlzb3IobGFzdFByb3Bvc2FsSUQpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZnVuZGluZ3NbX3Byb3Bvc2FsSURdLmluaXRpYWxQcmljZU11bHRpcGxpZXIgPSAxMDAqcHJpY2VNdWx0aXBsaWVyKGxhc3RGdWVsZWRGdW5kaW5nSUQpL2FjdHVhbFByaWNlRGl2aXNvcihsYXN0RnVlbGVkRnVuZGluZ0lEKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmdW5kaW5nc1swXS5pbml0aWFsUHJpY2VNdWx0aXBsaWVyID0gZnVuZGluZ3NbX3Byb3Bvc2FsSURdLmluaXRpYWxQcmljZU11bHRpcGxpZXI7CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgICBmdW5kaW5nc1tfcHJvcG9zYWxJRF0uaW5pdGlhbFByaWNlTXVsdGlwbGllciA9IF9pbml0aWFsUHJpY2VNdWx0aXBsaWVyOwogICAgICAgICAgICBmdW5kaW5nc1swXS5pbml0aWFsUHJpY2VNdWx0aXBsaWVyID0gX2luaXRpYWxQcmljZU11bHRpcGxpZXI7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGlmIChfaW5mbGF0aW9uUmF0ZSA9PSAwKSBmdW5kaW5nc1tfcHJvcG9zYWxJRF0uaW5mbGF0aW9uUmF0ZSA9IGZ1bmRpbmdzWzBdLmluZmxhdGlvblJhdGU7CiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIGZ1bmRpbmdzW19wcm9wb3NhbElEXS5pbmZsYXRpb25SYXRlID0gX2luZmxhdGlvblJhdGU7CiAgICAgICAgICAgIGZ1bmRpbmdzWzBdLmluZmxhdGlvblJhdGUgPSBfaW5mbGF0aW9uUmF0ZTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgZnVuZGluZ3NbX3Byb3Bvc2FsSURdLnN0YXJ0VGltZSA9IG5vdzsKICAgICAgICBmdW5kaW5nc1swXS5zdGFydFRpbWUgPSBub3c7CiAgICAgICAgCiAgICAgICAgZnVuZGluZ3NbX3Byb3Bvc2FsSURdLmNsb3NpbmdUaW1lID0gbm93ICsgX21pbnV0ZXNGdW5kaW5nUGVyaW9kICogMSBtaW51dGVzOwogICAgICAgIGZ1bmRpbmdzWzBdLmNsb3NpbmdUaW1lID0gZnVuZGluZ3NbX3Byb3Bvc2FsSURdLmNsb3NpbmdUaW1lOwogICAgICAgIAogICAgICAgIGZ1bmRpbmdzW19wcm9wb3NhbElEXS50b3RhbFdlaUdpdmVuID0gMDsKICAgICAgICAKICAgICAgICBsYXN0UHJvcG9zYWxJRCA9IF9wcm9wb3NhbElEOwogICAgICAgIAogICAgICAgIEZ1bmRpbmdSdWxlc1NldChfbW9kZXJhdG9yLCBfcHJvcG9zYWxJRCwgIF9hbW91bnRUb0Z1bmQsIGZ1bmRpbmdzW19wcm9wb3NhbElEXS5zdGFydFRpbWUsIGZ1bmRpbmdzW19wcm9wb3NhbElEXS5jbG9zaW5nVGltZSk7CiAgICB9IAogICAgCiAgICBmdW5jdGlvbiBzYWxlKAogICAgICAgIHVpbnQgX3Byb3Bvc2FsSUQsCiAgICAgICAgYWRkcmVzcyBfcmVjaXBpZW50LCAKICAgICAgICB1aW50IF9hbW91bnQsCiAgICAgICAgdWludCBfc2FsZURhdGUsCiAgICAgICAgYm9vbCBfcHJlc2FsZSkgaW50ZXJuYWwgcmV0dXJucyAoYm9vbCBzdWNjZXNzKSB7CgogICAgICAgIGlmIChfc2FsZURhdGUgPT0gMCkgX3NhbGVEYXRlID0gbm93OwoKICAgICAgICBpZiAoX3NhbGVEYXRlID4gZnVuZGluZ3NbX3Byb3Bvc2FsSURdLmNsb3NpbmdUaW1lCiAgICAgICAgICAgIHx8IF9zYWxlRGF0ZSA8IGZ1bmRpbmdzW19wcm9wb3NhbElEXS5zdGFydFRpbWUKICAgICAgICAgICAgfHwgZnVuZGluZ3NbX3Byb3Bvc2FsSURdLnRvdGFsV2VpR2l2ZW4gKyBfYW1vdW50ID4gZnVuZGluZ3NbX3Byb3Bvc2FsSURdLmFtb3VudFRvRnVuZCkgcmV0dXJuOwoKICAgICAgICB1aW50IF90b2tlbkFtb3VudCA9IFRva2VuQW1vdW50KF9hbW91bnQsIHByaWNlTXVsdGlwbGllcihfcHJvcG9zYWxJRCksIHByaWNlRGl2aXNvcihfcHJvcG9zYWxJRCwgX3NhbGVEYXRlKSk7CiAgICAgICAgaWYgKF90b2tlbkFtb3VudCA9PSAwKSByZXR1cm47CiAgICAgICAgCiAgICAgICAgYWRkSG9sZGVyKF9yZWNpcGllbnQpOwogICAgICAgIGlmIChfcHJlc2FsZSkgewogICAgICAgICAgICBHaXZlbltfcHJvcG9zYWxJRF1bX3JlY2lwaWVudF0udG9rZW5BbW91bnQgKz0gX3Rva2VuQW1vdW50OwogICAgICAgIH0KICAgICAgICBlbHNlIGNyZWF0ZVRva2VucyhfcmVjaXBpZW50LCBfdG9rZW5BbW91bnQpOwoKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICBmdW5jdGlvbiBjbG9zZUZ1bmRpbmcodWludCBfcHJvcG9zYWxJRCkgaW50ZXJuYWwgewogICAgICAgIGZ1bmRpbmdzW19wcm9wb3NhbElEXS5mdW5kZWRBbW91bnQgPSBmdW5kaW5nc1tfcHJvcG9zYWxJRF0udG90YWxXZWlHaXZlbjsKICAgICAgICBsYXN0RnVlbGVkRnVuZGluZ0lEID0gX3Byb3Bvc2FsSUQ7CiAgICAgICAgZnVuZGluZ3NbX3Byb3Bvc2FsSURdLmNsb3NpbmdUaW1lID0gbm93OwogICAgICAgIEZ1bmRpbmdGdWVsZWQoX3Byb3Bvc2FsSUQsIGZ1bmRpbmdzW19wcm9wb3NhbElEXS5mdW5kZWRBbW91bnQpOwogICAgfQoKICAgIGZ1bmN0aW9uIHNlbmRQZW5kaW5nQW1vdW50cyggICAgICAgIAogICAgICAgIHVpbnQgX2Zyb20sCiAgICAgICAgdWludCBfdG8sCiAgICAgICAgYWRkcmVzcyBfYnV5ZXIpIHJldHVybnMgKGJvb2wpIHsKICAgICAgICAKICAgICAgICBpZiAoX2Zyb20gPT0gMCkgX2Zyb20gPSAxOwogICAgICAgIGlmIChfdG8gPT0gMCkgX3RvID0gbGFzdFByb3Bvc2FsSUQ7CiAgICAgICAgaWYgKF9idXllciA9PSAwKSBfYnV5ZXIgPSBtc2cuc2VuZGVyOwoKICAgICAgICB1aW50IF9hbW91bnQ7CiAgICAgICAgdWludCBfdG9rZW5BbW91bnQ7CiAgICAgICAgCiAgICAgICAgZm9yICh1aW50IGkgPSBfZnJvbTsgaSA8PSBfdG87IGkrKykgewoKICAgICAgICAgICAgaWYgKG5vdyA+IGZ1bmRpbmdzW2ldLmNsb3NpbmdUaW1lICYmIEdpdmVuW2ldW19idXllcl0ud2VpQW1vdW50ICE9IDApIHsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKGZ1bmRpbmdzW2ldLmZ1bmRlZEFtb3VudCA9PSAwKSBfYW1vdW50ICs9IEdpdmVuW2ldW19idXllcl0ud2VpQW1vdW50OwogICAgICAgICAgICAgICAgZWxzZSBfdG9rZW5BbW91bnQgKz0gR2l2ZW5baV1bX2J1eWVyXS50b2tlbkFtb3VudDsKCiAgICAgICAgICAgICAgICBmdW5kaW5nc1tpXS50b3RhbFdlaUdpdmVuIC09IEdpdmVuW2ldW19idXllcl0ud2VpQW1vdW50OwogICAgICAgICAgICAgICAgR2l2ZW5baV1bX2J1eWVyXS50b2tlbkFtb3VudCA9IDA7CiAgICAgICAgICAgICAgICBHaXZlbltpXVtfYnV5ZXJdLndlaUFtb3VudCA9IDA7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChfdG9rZW5BbW91bnQgPiAwKSB7CiAgICAgICAgICAgIGNyZWF0ZVRva2VucyhfYnV5ZXIsIF90b2tlbkFtb3VudCk7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBpZiAoX2Ftb3VudCA+IDApIHsKICAgICAgICAgICAgaWYgKCFfYnV5ZXIuc2VuZChfYW1vdW50KSkgdGhyb3c7CiAgICAgICAgICAgIFJlZnVuZChfYnV5ZXIsIF9hbW91bnQpOwogICAgICAgIH0gZWxzZSByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIAoKICAgIGZ1bmN0aW9uIHdpdGhkcmF3UGVuZGluZ0Ftb3VudHMoKSByZXR1cm5zIChib29sKSB7CiAgICAgICAgCiAgICAgICAgcmV0dXJuIHNlbmRQZW5kaW5nQW1vdW50cygwLCAwLCBtc2cuc2VuZGVyKTsKICAgIH0gICAgICAgIAoKLy8gRnVuZGluZyBNb2RlcmF0b3IgZnVuY3Rpb25zCgogICAgZnVuY3Rpb24gc2V0RnVuZGluZ1N0YXJ0VGltZSh1aW50IF9wcm9wb3NhbElELCB1aW50IF9zdGFydFRpbWUpIGV4dGVybmFsIHsKICAgICAgICBpZiAoKG1zZy5zZW5kZXIgIT0gIGZ1bmRpbmdzW19wcm9wb3NhbElEXS5tb2RlcmF0b3IpIHx8IG5vdyA+IGZ1bmRpbmdzW19wcm9wb3NhbElEXS5jbG9zaW5nVGltZSkgdGhyb3c7CiAgICAgICAgZnVuZGluZ3NbX3Byb3Bvc2FsSURdLnN0YXJ0VGltZSA9IF9zdGFydFRpbWU7CiAgICB9CgogICAgZnVuY3Rpb24gc2V0RnVuZGluZ0Z1ZWxlZCh1aW50IF9wcm9wb3NhbElEKSBleHRlcm5hbCB7CgogICAgICAgIGlmICgobXNnLnNlbmRlciAhPSAgZnVuZGluZ3NbX3Byb3Bvc2FsSURdLm1vZGVyYXRvcikgfHwgbm93ID4gZnVuZGluZ3NbX3Byb3Bvc2FsSURdLmNsb3NpbmdUaW1lKSB0aHJvdzsKCiAgICAgICAgY2xvc2VGdW5kaW5nKF9wcm9wb3NhbElEKTsKICAgIH0KICAgIAovLyBUb2tlbnMgdHJhbnNmZXIgbWFuYWdlbWVudCAgICAKICAgIAogICAgZnVuY3Rpb24gYWJsZVRyYW5zZmVyKCkgb25seUNsaWVudCB7CiAgICAgICAgaWYgKCF0cmFuc2ZlcmFibGUpIHsKICAgICAgICAgICAgdHJhbnNmZXJhYmxlID0gdHJ1ZTsKICAgICAgICAgICAgVHJhbnNmZXJBYmxlKCk7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGRpc2FibGVUcmFuc2ZlcigpIG9ubHlDbGllbnQgewogICAgICAgIGlmICh0cmFuc2ZlcmFibGUpIHsKICAgICAgICAgICAgdHJhbnNmZXJhYmxlID0gZmFsc2U7CiAgICAgICAgICAgIFRyYW5zZmVyRGlzYWJsZSgpOwogICAgICAgIH0KICAgIH0KICAgIAogICAgZnVuY3Rpb24gYmxvY2tUcmFuc2ZlcihhZGRyZXNzIF9zaGFyZUhvbGRlciwgdWludCBfZGVhZExpbmUpIGV4dGVybmFsIG9ubHlDbGllbnQgb25seVNoYXJlTWFuYWdlciB7CiAgICAgICAgaWYgKF9kZWFkTGluZSA+IGJsb2NrZWREZWFkTGluZVtfc2hhcmVIb2xkZXJdKSB7CiAgICAgICAgICAgIGJsb2NrZWREZWFkTGluZVtfc2hhcmVIb2xkZXJdID0gX2RlYWRMaW5lOwogICAgICAgIH0KICAgIH0KICAgIAogICAgZnVuY3Rpb24gdHJhbnNmZXJGcm9tVG8oCiAgICAgICAgYWRkcmVzcyBfZnJvbSwKICAgICAgICBhZGRyZXNzIF90bywgCiAgICAgICAgdWludDI1NiBfdmFsdWUKICAgICAgICApIGludGVybmFsIHJldHVybnMgKGJvb2wgc3VjY2VzcykgeyAgCgogICAgICAgIGlmICgodHJhbnNmZXJhYmxlKQogICAgICAgICAgICAmJiBub3cgPiBibG9ja2VkRGVhZExpbmVbX2Zyb21dCiAgICAgICAgICAgICYmIG5vdyA+IGJsb2NrZWREZWFkTGluZVtfdG9dCiAgICAgICAgICAgICYmIF90byAhPSBhZGRyZXNzKHRoaXMpCiAgICAgICAgICAgICYmIGJhbGFuY2VzW19mcm9tXSA+PSBfdmFsdWUKICAgICAgICAgICAgJiYgYmFsYW5jZXNbX3RvXSArIF92YWx1ZSA+IGJhbGFuY2VzW190b10pIHsKCiAgICAgICAgICAgIGFkZEhvbGRlcihfdG8pOwogICAgICAgICAgICBiYWxhbmNlc1tfZnJvbV0gLT0gX3ZhbHVlOwogICAgICAgICAgICBiYWxhbmNlc1tfdG9dICs9IF92YWx1ZTsKICAgICAgICAgICAgVHJhbnNmZXIoX2Zyb20sIF90bywgX3ZhbHVlKTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CgogICAgICAgIH0gZWxzZSByZXR1cm4gZmFsc2U7CiAgICB9CiAgICAKICAgIGZ1bmN0aW9uIHRyYW5zZmVyKGFkZHJlc3MgX3RvLCB1aW50MjU2IF92YWx1ZSkgcmV0dXJucyAoYm9vbCBzdWNjZXNzKSB7ICAKICAgICAgICBpZiAoIXRyYW5zZmVyRnJvbVRvKG1zZy5zZW5kZXIsIF90bywgX3ZhbHVlKSkgdGhyb3c7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgZnVuY3Rpb24gdHJhbnNmZXJGcm9tKAogICAgICAgIGFkZHJlc3MgX2Zyb20sIAogICAgICAgIGFkZHJlc3MgX3RvLCAKICAgICAgICB1aW50MjU2IF92YWx1ZQogICAgICAgICkgcmV0dXJucyAoYm9vbCBzdWNjZXNzKSB7IAogICAgICAgIAogICAgICAgIGlmIChhbGxvd2VkW19mcm9tXVttc2cuc2VuZGVyXSA8IF92YWx1ZQogICAgICAgICAgICB8fCAhdHJhbnNmZXJGcm9tVG8oX2Zyb20sIF90bywgX3ZhbHVlKSkgdGhyb3c7CiAgICAgICAgICAgIAogICAgICAgIGFsbG93ZWRbX2Zyb21dW21zZy5zZW5kZXJdIC09IF92YWx1ZTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICBmdW5jdGlvbiBhcHByb3ZlKGFkZHJlc3MgX3NwZW5kZXIsIHVpbnQyNTYgX3ZhbHVlKSByZXR1cm5zIChib29sIHN1Y2Nlc3MpIHsKICAgICAgICBhbGxvd2VkW21zZy5zZW5kZXJdW19zcGVuZGVyXSA9IF92YWx1ZTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIAp9CiAgICAKCgpwcmFnbWEgc29saWRpdHkgXjAuNC44OwoKLyoKICoKICogVGhpcyBmaWxlIGlzIHBhcnQgb2YgUGFzcyBEQU8uCiAqCiAqIFRoZSBNYW5hZ2VyIHNtYXJ0IGNvbnRyYWN0IGlzIHVzZWQgZm9yIHRoZSBtYW5hZ2VtZW50IG9mIHRoZSBEYW8gYWNjb3VudCwgc2hhcmVzIGFuZCB0b2tlbnMuCiAqCiovCgovLy8gQHRpdGxlIE1hbmFnZXIgc21hcnQgY29udHJhY3Qgb2YgdGhlIFBhc3MgRGVjZW50cmFsaXplZCBBdXRvbm9tb3VzIE9yZ2FuaXNhdGlvbgpjb250cmFjdCBQYXNzTWFuYWdlciBpcyBQYXNzVG9rZW5NYW5hZ2VyIHsKICAgIAogICAgc3RydWN0IG9yZGVyIHsKICAgICAgICBhZGRyZXNzIGJ1eWVyOwogICAgICAgIHVpbnQgd2VpR2l2ZW47CiAgICB9CiAgICAvLyBPcmRlcnMgdG8gYnV5IHRva2VucwogICAgb3JkZXJbXSBwdWJsaWMgb3JkZXJzOwogICAgLy8gTnVtYmVyIG9yIG9yZGVycyB0byBidXkgdG9rZW5zCiAgICB1aW50IG51bWJlck9mT3JkZXJzOwoKICAgIC8vIE1hcCB0byBrbm93IGlmIGFuIG9yZGVyIHdhcyBjbG9uZWQgZnJvbSB0aGUgcHJlY2VkZW50IG1hbmFnZXIgYWZ0ZXIgYW4gdXBncmFkZQogICAgbWFwcGluZyAodWludCA9PiBib29sKSBvcmRlckNsb25lZDsKICAgIAogICAgZnVuY3Rpb24gUGFzc01hbmFnZXIoCiAgICAgICAgUGFzc0RhbyBfcGFzc0RhbywKICAgICAgICBhZGRyZXNzIF9jbG9uZWRGcm9tLAogICAgICAgIHN0cmluZyBfdG9rZW5OYW1lLAogICAgICAgIHN0cmluZyBfdG9rZW5TeW1ib2wsCiAgICAgICAgdWludDggX3Rva2VuRGVjaW1hbHMsCiAgICAgICAgYm9vbCBfdG9rZW4sCiAgICAgICAgYm9vbCBfdHJhbnNmZXJhYmxlLAogICAgICAgIHVpbnQgX2luaXRpYWxQcmljZU11bHRpcGxpZXIsCiAgICAgICAgdWludCBfaW5mbGF0aW9uUmF0ZSkgCiAgICAgICAgUGFzc1Rva2VuTWFuYWdlciggX3Bhc3NEYW8sIF9jbG9uZWRGcm9tLCBfdG9rZW5OYW1lLCBfdG9rZW5TeW1ib2wsIF90b2tlbkRlY2ltYWxzLCAKICAgICAgICAgICAgX3Rva2VuLCBfdHJhbnNmZXJhYmxlLCBfaW5pdGlhbFByaWNlTXVsdGlwbGllciwgX2luZmxhdGlvblJhdGUpIHsgfQogICAgCiAgICAvLy8gQG5vdGljZSBGdW5jdGlvbiB0byByZWNlaXZlIHBheW1lbnRzCiAgICBmdW5jdGlvbiAoKSBwYXlhYmxlIG9ubHlTaGFyZU1hbmFnZXIgeyB9CiAgICAKICAgIC8vLyBAbm90aWNlIEZ1bmN0aW9uIHVzZWQgYnkgdGhlIGNsaWVudCB0byBzZW5kIGV0aGVycwogICAgLy8vIEBwYXJhbSBfcmVjaXBpZW50IFRoZSBhZGRyZXNzIHRvIHNlbmQgdG8KICAgIC8vLyBAcGFyYW0gX2Ftb3VudCBUaGUgYW1vdW50IChpbiB3ZWkpIHRvIHNlbmQKICAgIC8vLyBAcmV0dXJuIFdoZXRoZXIgdGhlIHRyYW5zZmVyIHdhcyBzdWNjZXNzZnVsIG9yIG5vdAogICAgZnVuY3Rpb24gc2VuZFRvKAogICAgICAgIGFkZHJlc3MgX3JlY2lwaWVudCwKICAgICAgICB1aW50IF9hbW91bnQKICAgICkgZXh0ZXJuYWwgb25seUNsaWVudCByZXR1cm5zIChib29sKSB7CgogICAgICAgIGlmIChfcmVjaXBpZW50LnNlbmQoX2Ftb3VudCkpIHJldHVybiB0cnVlOwogICAgICAgIGVsc2UgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIC8vLyBAZGV2IEludGVybmFsIGZ1bmN0aW9uIHRvIGJ1eSB0b2tlbnMgYW5kIHByb21vdGUgYSBwcm9wb3NhbCAKICAgIC8vLyBAcGFyYW0gX3Byb3Bvc2FsSUQgVGhlIGluZGV4IG9mIHRoZSBwcm9wb3NhbAogICAgLy8vIEBwYXJhbSBfYnV5ZXIgVGhlIGFkZHJlc3Mgb2YgdGhlIGJ1eWVyCiAgICAvLy8gQHBhcmFtIF9kYXRlIFRoZSB1bml4IGRhdGUgdG8gY29uc2lkZXIgZm9yIHRoZSBzaGFyZSBvciB0b2tlbiBwcmljZSBjYWxjdWxhdGlvbgogICAgLy8vIEBwYXJhbSBfcHJlc2FsZSBUcnVlIGlmIHByZXNhbGUKICAgIC8vLyBAcmV0dXJuIFdoZXRoZXIgdGhlIGZ1bmN0aW9uIHdhcyBzdWNjZXNzZnVsIG9yIG5vdCAKICAgIGZ1bmN0aW9uIGJ1eVRva2Vuc0ZvcigKICAgICAgICB1aW50IF9wcm9wb3NhbElELAogICAgICAgIGFkZHJlc3MgX2J1eWVyLCAKICAgICAgICB1aW50IF9kYXRlLAogICAgICAgIGJvb2wgX3ByZXNhbGUpIGludGVybmFsIHJldHVybnMgKGJvb2wpIHsKCiAgICAgICAgaWYgKF9wcm9wb3NhbElEID09IDAgfHwgIXNhbGUoX3Byb3Bvc2FsSUQsIF9idXllciwgbXNnLnZhbHVlLCBfZGF0ZSwgX3ByZXNhbGUpKSB0aHJvdzsKCiAgICAgICAgZnVuZGluZ3NbX3Byb3Bvc2FsSURdLnRvdGFsV2VpR2l2ZW4gKz0gbXNnLnZhbHVlOyAgICAgICAgCiAgICAgICAgaWYgKGZ1bmRpbmdzW19wcm9wb3NhbElEXS50b3RhbFdlaUdpdmVuID09IGZ1bmRpbmdzW19wcm9wb3NhbElEXS5hbW91bnRUb0Z1bmQpIGNsb3NlRnVuZGluZyhfcHJvcG9zYWxJRCk7CgogICAgICAgIEdpdmVuW19wcm9wb3NhbElEXVtfYnV5ZXJdLndlaUFtb3VudCArPSBtc2cudmFsdWU7CiAgICAgICAgCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICAKICAgIC8vLyBAbm90aWNlIEZ1bmN0aW9uIHRvIGJ1eSB0b2tlbnMgYW5kIHByb21vdGUgYSBwcm9wb3NhbCAKICAgIC8vLyBAcGFyYW0gX3Byb3Bvc2FsSUQgVGhlIGluZGV4IG9mIHRoZSBwcm9wb3NhbAogICAgLy8vIEBwYXJhbSBfYnV5ZXIgVGhlIGFkZHJlc3Mgb2YgdGhlIGJ1eWVyIChub3QgbWFuZGF0b3J5LCBtc2cuc2VuZGVyIGlmIDApCiAgICAvLy8gQHJldHVybiBXaGV0aGVyIHRoZSBmdW5jdGlvbiB3YXMgc3VjY2Vzc2Z1bCBvciBub3QgCiAgICBmdW5jdGlvbiBidXlUb2tlbnNGb3JQcm9wb3NhbCgKICAgICAgICB1aW50IF9wcm9wb3NhbElELCAKICAgICAgICBhZGRyZXNzIF9idXllcikgcGF5YWJsZSByZXR1cm5zIChib29sKSB7CgogICAgICAgIGlmIChfYnV5ZXIgPT0gMCkgX2J1eWVyID0gbXNnLnNlbmRlcjsKCiAgICAgICAgaWYgKGZ1bmRpbmdzW19wcm9wb3NhbElEXS5tb2RlcmF0b3IgIT0gMCkgdGhyb3c7CgogICAgICAgIHJldHVybiBidXlUb2tlbnNGb3IoX3Byb3Bvc2FsSUQsIF9idXllciwgbm93LCB0cnVlKTsKICAgIH0KCiAgICAvLy8gQG5vdGljZSBGdW5jdGlvbiB1c2VkIGJ5IHRoZSBtb2RlcmF0b3IgdG8gYnV5IHNoYXJlcyBvciB0b2tlbnMKICAgIC8vLyBAcGFyYW0gX3Byb3Bvc2FsSUQgSW5kZXggb2YgdGhlIGNsaWVudCBwcm9wb3NhbAogICAgLy8vIEBwYXJhbSBfYnV5ZXIgVGhlIGFkZHJlc3Mgb2YgdGhlIHJlY2lwaWVudCBvZiBzaGFyZXMgb3IgdG9rZW5zCiAgICAvLy8gQHBhcmFtIF9kYXRlIFRoZSB1bml4IGRhdGUgdG8gY29uc2lkZXIgZm9yIHRoZSBzaGFyZSBvciB0b2tlbiBwcmljZSBjYWxjdWxhdGlvbgogICAgLy8vIEBwYXJhbSBfcHJlc2FsZSBUcnVlIGlmIHByZXNhbGUKICAgIC8vLyBAcmV0dXJuIFdoZXRoZXIgdGhlIGZ1bmN0aW9uIHdhcyBzdWNjZXNzZnVsIG9yIG5vdCAKICAgIGZ1bmN0aW9uIGJ1eVRva2VuRnJvbU1vZGVyYXRvcigKICAgICAgICB1aW50IF9wcm9wb3NhbElELAogICAgICAgIGFkZHJlc3MgX2J1eWVyLCAKICAgICAgICB1aW50IF9kYXRlLAogICAgICAgIGJvb2wgX3ByZXNhbGUpIHBheWFibGUgZXh0ZXJuYWwgcmV0dXJucyAoYm9vbCl7CgogICAgICAgIGlmIChtc2cuc2VuZGVyICE9IGZ1bmRpbmdzW19wcm9wb3NhbElEXS5tb2RlcmF0b3IpIHRocm93OwoKICAgICAgICByZXR1cm4gYnV5VG9rZW5zRm9yKF9wcm9wb3NhbElELCBfYnV5ZXIsIF9kYXRlLCBfcHJlc2FsZSk7CiAgICB9CgogICAgLy8vIEBkZXYgSW50ZXJuYWwgZnVuY3Rpb24gdG8gY3JlYXRlIGEgYnV5IG9yZGVyCiAgICAvLy8gQHBhcmFtIF9idXllciBUaGUgYWRkcmVzcyBvZiB0aGUgYnV5ZXIKICAgIC8vLyBAcGFyYW0gX3dlaUdpdmVuIFRoZSBhbW91bnQgaW4gd2VpIGdpdmVuIGJ5IHRoZSBidXllcgogICAgZnVuY3Rpb24gYWRkT3JkZXIoCiAgICAgICAgYWRkcmVzcyBfYnV5ZXIsIAogICAgICAgIHVpbnQgX3dlaUdpdmVuKSBpbnRlcm5hbCB7CgogICAgICAgIHVpbnQgaTsKICAgICAgICBudW1iZXJPZk9yZGVycyArPSAxOwoKICAgICAgICBpZiAobnVtYmVyT2ZPcmRlcnMgPiBvcmRlcnMubGVuZ3RoKSBpID0gb3JkZXJzLmxlbmd0aCsrOwogICAgICAgIGVsc2UgaSA9IG51bWJlck9mT3JkZXJzIC0gMTsKICAgICAgICAKICAgICAgICBvcmRlcnNbaV0uYnV5ZXIgPSBfYnV5ZXI7CiAgICAgICAgb3JkZXJzW2ldLndlaUdpdmVuID0gX3dlaUdpdmVuOwogICAgfQoKICAgIC8vLyBAZGV2IEludGVybmFsIGZ1bmN0aW9uIHRvIHJlbW92ZSBhIGJ1eSBvcmRlcgogICAgLy8vIEBwYXJhbSBfb3JkZXIgVGhlIGluZGV4IG9mIHRoZSBvcmRlciB0byByZW1vdmUKICAgIGZ1bmN0aW9uIHJlbW92ZU9yZGVyKHVpbnQgX29yZGVyKSBpbnRlcm5hbCB7CiAgICAgICAgCiAgICAgICAgaWYgKG51bWJlck9mT3JkZXJzIC0gMSA8IF9vcmRlcikgcmV0dXJuOwoKICAgICAgICBudW1iZXJPZk9yZGVycyAtPSAxOwogICAgICAgIGlmIChudW1iZXJPZk9yZGVycyA+IDApIHsKICAgICAgICAgICAgZm9yICh1aW50IGkgPSBfb3JkZXI7IGkgPD0gbnVtYmVyT2ZPcmRlcnMgLSAxOyBpKyspIHsKICAgICAgICAgICAgICAgIG9yZGVyc1tpXS5idXllciA9IG9yZGVyc1tpKzFdLmJ1eWVyOwogICAgICAgICAgICAgICAgb3JkZXJzW2ldLndlaUdpdmVuID0gb3JkZXJzW2krMV0ud2VpR2l2ZW47CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgb3JkZXJzW251bWJlck9mT3JkZXJzXS5idXllciA9IDA7CiAgICAgICAgb3JkZXJzW251bWJlck9mT3JkZXJzXS53ZWlHaXZlbiA9IDA7CiAgICB9CiAgICAKICAgIC8vLyBAbm90aWNlIEZ1bmN0aW9uIHRvIGNyZWF0ZSBvcmRlcnMgdG8gYnV5IHRva2VucwogICAgLy8vIEByZXR1cm4gV2hldGhlciB0aGUgZnVuY3Rpb24gd2FzIHN1Y2Nlc3NmdWwgb3Igbm90CiAgICBmdW5jdGlvbiBidXlUb2tlbnMoKSBwYXlhYmxlIHJldHVybnMgKGJvb2wpIHsKCiAgICAgICAgaWYgKCF0cmFuc2ZlcmFibGUgfHwgbXNnLnZhbHVlIDwgMTAwIGZpbm5leSkgdGhyb3c7CiAgICAgICAgCiAgICAgICAgYWRkT3JkZXIobXNnLnNlbmRlciwgbXNnLnZhbHVlKTsKICAgICAgICAKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIAogICAgLy8vIEBub3RpY2UgRnVuY3Rpb24gdG8gc2VsbCB0b2tlbnMKICAgIC8vLyBAcGFyYW0gX3Rva2VuQW1vdW50IGluIHRva2VucyB0byBzZWxsCiAgICAvLy8gQHBhcmFtIF9mcm9tIEluZGV4IG9mIHRoZSBmaXJzdCBvcmRlcgogICAgLy8vIEBwYXJhbSBfdG8gSW5kZXggb2YgdGhlIGxhc3Qgb3JkZXIKICAgIC8vLyBAcmV0dXJuIHRoZSByZXZlbnVlIGluIHdlaQogICAgZnVuY3Rpb24gc2VsbFRva2VucygKICAgICAgICB1aW50IF90b2tlbkFtb3VudCwKICAgICAgICB1aW50IF9mcm9tLAogICAgICAgIHVpbnQgX3RvKSByZXR1cm5zICh1aW50KSB7CgogICAgICAgIGlmICghdHJhbnNmZXJhYmxlIAogICAgICAgICAgICB8fCB1aW50KGJhbGFuY2VzW21zZy5zZW5kZXJdKSA8IF9hbW91bnQgCiAgICAgICAgICAgIHx8IG51bWJlck9mT3JkZXJzID09IDApIHRocm93OwogICAgICAgIAogICAgICAgIGlmIChfdG8gPT0gMCB8fCBfdG8gPiBudW1iZXJPZk9yZGVycyAtIDEpIF90byA9IG51bWJlck9mT3JkZXJzIC0gMTsKICAgICAgICAKICAgICAgICAKICAgICAgICB1aW50IF90b2tlbkFtb3VudG87CiAgICAgICAgdWludCBfYW1vdW50OwogICAgICAgIHVpbnQgX3RvdGFsQW1vdW50OwogICAgICAgIHVpbnQgbyA9IF9mcm9tOwoKICAgICAgICBmb3IgKHVpbnQgaSA9IF9mcm9tOyBpIDw9IF90bzsgaSsrKSB7CgogICAgICAgICAgICBpZiAoX3Rva2VuQW1vdW50ID4gMCAmJiBvcmRlcnNbb10uYnV5ZXIgIT0gbXNnLnNlbmRlcikgewoKICAgICAgICAgICAgICAgIF90b2tlbkFtb3VudG8gPSBUb2tlbkFtb3VudChvcmRlcnNbb10ud2VpR2l2ZW4sIHByaWNlTXVsdGlwbGllcigwKSwgYWN0dWFsUHJpY2VEaXZpc29yKDApKTsKCiAgICAgICAgICAgICAgICBpZiAoX3Rva2VuQW1vdW50ID49IF90b2tlbkFtb3VudG8gCiAgICAgICAgICAgICAgICAgICAgJiYgdHJhbnNmZXJGcm9tVG8obXNnLnNlbmRlciwgb3JkZXJzW29dLmJ1eWVyLCBfdG9rZW5BbW91bnRvKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgX3Rva2VuQW1vdW50IC09IF90b2tlbkFtb3VudG87CiAgICAgICAgICAgICAgICAgICAgX3RvdGFsQW1vdW50ICs9IG9yZGVyc1tvXS53ZWlHaXZlbjsKICAgICAgICAgICAgICAgICAgICByZW1vdmVPcmRlcihvKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgaWYgKF90b2tlbkFtb3VudCA8IF90b2tlbkFtb3VudG8KICAgICAgICAgICAgICAgICAgICAmJiB0cmFuc2ZlckZyb21Ubyhtc2cuc2VuZGVyLCBvcmRlcnNbb10uYnV5ZXIsIF90b2tlbkFtb3VudCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgX2Ftb3VudCA9IHdlaUFtb3VudChfdG9rZW5BbW91bnQsIHByaWNlTXVsdGlwbGllcigwKSwgYWN0dWFsUHJpY2VEaXZpc29yKDApKTsKICAgICAgICAgICAgICAgICAgICBvcmRlcnNbb10ud2VpR2l2ZW4gLT0gX2Ftb3VudDsKICAgICAgICAgICAgICAgICAgICBfdG90YWxBbW91bnQgKz0gX2Ftb3VudDsKICAgICAgICAgICAgICAgICAgICBpID0gX3RvICsgMTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgbyArPSAxOwogICAgICAgICAgICB9IAogICAgICAgICAgICBlbHNlIG8gKz0gMTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgaWYgKCFtc2cuc2VuZGVyLnNlbmQoX3RvdGFsQW1vdW50KSkgdGhyb3c7CiAgICAgICAgZWxzZSByZXR1cm4gX3RvdGFsQW1vdW50OwogICAgfSAgICAKCiAgICAvLy8gQG5vdGljZSBGdW5jdGlvbiB0byByZW1vdmUgeW91ciBvcmRlcnMgYW5kIHJlZnVuZAogICAgLy8vIEBwYXJhbSBfZnJvbSBJbmRleCBvZiB0aGUgZmlyc3Qgb3JkZXIKICAgIC8vLyBAcGFyYW0gX3RvIEluZGV4IG9mIHRoZSBsYXN0IG9yZGVyCiAgICAvLy8gQHJldHVybiBXaGV0aGVyIHRoZSBmdW5jdGlvbiB3YXMgc3VjY2Vzc2Z1bCBvciBub3QKICAgIGZ1bmN0aW9uIHJlbW92ZU9yZGVycygKICAgICAgICB1aW50IF9mcm9tLAogICAgICAgIHVpbnQgX3RvKSByZXR1cm5zIChib29sKSB7CgogICAgICAgIGlmIChfdG8gPT0gMCB8fCBfdG8gPiBudW1iZXJPZk9yZGVycykgX3RvID0gbnVtYmVyT2ZPcmRlcnMgLTE7CiAgICAgICAgCiAgICAgICAgdWludCBfdG90YWxBbW91bnQ7CiAgICAgICAgdWludCBvID0gX2Zyb207CgogICAgICAgIGZvciAodWludCBpID0gX2Zyb207IGkgPD0gX3RvOyBpKyspIHsKCiAgICAgICAgICAgIGlmIChvcmRlcnNbb10uYnV5ZXIgPT0gbXNnLnNlbmRlcikgewogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfdG90YWxBbW91bnQgKz0gb3JkZXJzW29dLndlaUdpdmVuOwogICAgICAgICAgICAgICAgcmVtb3ZlT3JkZXIobyk7CgogICAgICAgICAgICB9IGVsc2UgbyArPSAxOwogICAgICAgIH0KCiAgICAgICAgaWYgKCFtc2cuc2VuZGVyLnNlbmQoX3RvdGFsQW1vdW50KSkgdGhyb3c7CiAgICAgICAgZWxzZSByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIAp9ICAgIAoKCnByYWdtYSBzb2xpZGl0eSBeMC40Ljg7CgovKgogKgogKiBUaGlzIGZpbGUgaXMgcGFydCBvZiBQYXNzIERBTy4KICoKICogVGhlIFByb2plY3Qgc21hcnQgY29udHJhY3QgaXMgdXNlZCBmb3IgdGhlIG1hbmFnZW1lbnQgb2YgdGhlIFBhc3MgRGFvIHByb2plY3RzLgogKgoqLwoKLy8vIEB0aXRsZSBQcm9qZWN0IHNtYXJ0IGNvbnRyYWN0IG9mIHRoZSBQYXNzIERlY2VudHJhbGl6ZWQgQXV0b25vbW91cyBPcmdhbmlzYXRpb24KY29udHJhY3QgUGFzc1Byb2plY3QgewoKICAgIC8vIFRoZSBQYXNzIERhbyBzbWFydCBjb250cmFjdAogICAgUGFzc0RhbyBwdWJsaWMgcGFzc0RhbzsKICAgIAogICAgLy8gVGhlIHByb2plY3QgbmFtZQogICAgc3RyaW5nIHB1YmxpYyBuYW1lOwogICAgLy8gVGhlIHByb2plY3QgZGVzY3JpcHRpb24KICAgIHN0cmluZyBwdWJsaWMgZGVzY3JpcHRpb247CiAgICAvLyBUaGUgSGFzaCBPZiB0aGUgcHJvamVjdCBEb2N1bWVudAogICAgYnl0ZXMzMiBwdWJsaWMgaGFzaE9mVGhlRG9jdW1lbnQ7CiAgICAvLyBUaGUgcHJvamVjdCBtYW5hZ2VyIHNtYXJ0IGNvbnRyYWN0CiAgICBhZGRyZXNzIHByb2plY3RNYW5hZ2VyOwoKICAgIHN0cnVjdCBvcmRlciB7CiAgICAgICAgLy8gVGhlIGFkZHJlc3Mgb2YgdGhlIGNvbnRyYWN0b3Igc21hcnQgY29udHJhY3QKICAgICAgICBhZGRyZXNzIGNvbnRyYWN0b3JBZGRyZXNzOwogICAgICAgIC8vIFRoZSBpbmRleCBvZiB0aGUgY29udHJhY3RvciBwcm9wb3NhbAogICAgICAgIHVpbnQgY29udHJhY3RvclByb3Bvc2FsSUQ7CiAgICAgICAgLy8gVGhlIGFtb3VudCBvZiB0aGUgb3JkZXIKICAgICAgICB1aW50IGFtb3VudDsKICAgICAgICAvLyBUaGUgZGF0ZSBvZiB0aGUgb3JkZXIKICAgICAgICB1aW50IG9yZGVyRGF0ZTsKICAgIH0KICAgIC8vIFRoZSBvcmRlcnMgb2YgdGhlIERhbyBmb3IgdGhpcyBwcm9qZWN0CiAgICBvcmRlcltdIHB1YmxpYyBvcmRlcnM7CiAgICAKICAgIC8vIFRoZSB0b3RhbCBhbW91bnQgb2Ygb3JkZXJzIGluIHdlaSBmb3IgdGhpcyBwcm9qZWN0CiAgICB1aW50IHB1YmxpYyB0b3RhbEFtb3VudE9mT3JkZXJzOwoKICAgIHN0cnVjdCByZXNvbHV0aW9uIHsKICAgICAgICAvLyBUaGUgbmFtZSBvZiB0aGUgcmVzb2x1dGlvbgogICAgICAgIHN0cmluZyBuYW1lOwogICAgICAgIC8vIEEgZGVzY3JpcHRpb24gb2YgdGhlIHJlc29sdXRpb24KICAgICAgICBzdHJpbmcgZGVzY3JpcHRpb247CiAgICAgICAgLy8gVGhlIGRhdGUgb2YgdGhlIHJlc29sdXRpb24KICAgICAgICB1aW50IGNyZWF0aW9uRGF0ZTsKICAgIH0KICAgIC8vIFJlc29sdXRpb25zIG9mIHRoZSBEYW8gZm9yIHRoaXMgcHJvamVjdAogICAgcmVzb2x1dGlvbltdIHB1YmxpYyByZXNvbHV0aW9uczsKICAgIAovLyBFdmVudHMKCiAgICBldmVudCBPcmRlckFkZGVkKGFkZHJlc3MgaW5kZXhlZCBDbGllbnQsIGFkZHJlc3MgaW5kZXhlZCBDb250cmFjdG9yQWRkcmVzcywgdWludCBpbmRleGVkIENvbnRyYWN0b3JQcm9wb3NhbElELCB1aW50IEFtb3VudCwgdWludCBPcmRlckRhdGUpOwogICAgZXZlbnQgUHJvamVjdERlc2NyaXB0aW9uVXBkYXRlZChhZGRyZXNzIGluZGV4ZWQgQnksIHN0cmluZyBOZXdEZXNjcmlwdGlvbiwgYnl0ZXMzMiBOZXdIYXNoT2ZUaGVEb2N1bWVudCk7CiAgICBldmVudCBSZXNvbHV0aW9uQWRkZWQoYWRkcmVzcyBpbmRleGVkIENsaWVudCwgdWludCBpbmRleGVkIFJlc29sdXRpb25JRCwgc3RyaW5nIE5hbWUsIHN0cmluZyBEZXNjcmlwdGlvbik7CgovLyBDb25zdGFudCBmdW5jdGlvbnMgIAoKICAgIC8vLyBAcmV0dXJuIHRoZSBhY3R1YWwgY29tbWl0dGVlIHJvb20gb2YgdGhlIERhbyAgIAogICAgZnVuY3Rpb24gQ2xpZW50KCkgY29uc3RhbnQgcmV0dXJucyAoYWRkcmVzcykgewogICAgICAgIHJldHVybiBwYXNzRGFvLkFjdHVhbENvbW1pdHRlZVJvb20oKTsKICAgIH0KICAgIAogICAgLy8vIEByZXR1cm4gVGhlIG51bWJlciBvZiBvcmRlcnMgCiAgICBmdW5jdGlvbiBudW1iZXJPZk9yZGVycygpIGNvbnN0YW50IHJldHVybnMgKHVpbnQpIHsKICAgICAgICByZXR1cm4gb3JkZXJzLmxlbmd0aCAtIDE7CiAgICB9CiAgICAKICAgIC8vLyBAcmV0dXJuIFRoZSBwcm9qZWN0IE1hbmFnZXIgYWRkcmVzcwogICAgZnVuY3Rpb24gUHJvamVjdE1hbmFnZXIoKSBjb25zdGFudCByZXR1cm5zIChhZGRyZXNzKSB7CiAgICAgICAgcmV0dXJuIHByb2plY3RNYW5hZ2VyOwogICAgfQoKICAgIC8vLyBAcmV0dXJuIFRoZSBudW1iZXIgb2YgcmVzb2x1dGlvbnMgCiAgICBmdW5jdGlvbiBudW1iZXJPZlJlc29sdXRpb25zKCkgY29uc3RhbnQgcmV0dXJucyAodWludCkgewogICAgICAgIHJldHVybiByZXNvbHV0aW9ucy5sZW5ndGggLSAxOwogICAgfQogICAgCi8vIG1vZGlmaWVycwoKICAgIC8vIE1vZGlmaWVyIGZvciBwcm9qZWN0IG1hbmFnZXIgZnVuY3Rpb25zIAogICAgbW9kaWZpZXIgb25seVByb2plY3RNYW5hZ2VyIHtpZiAobXNnLnNlbmRlciAhPSBwcm9qZWN0TWFuYWdlcikgdGhyb3c7IF87fQoKICAgIC8vIE1vZGlmaWVyIGZvciB0aGUgRGFvIGZ1bmN0aW9ucyAKICAgIG1vZGlmaWVyIG9ubHlDbGllbnQge2lmIChtc2cuc2VuZGVyICE9IENsaWVudCgpKSB0aHJvdzsgXzt9CgovLyBDb25zdHJ1Y3RvciBmdW5jdGlvbgoKICAgIGZ1bmN0aW9uIFBhc3NQcm9qZWN0KAogICAgICAgIFBhc3NEYW8gX3Bhc3NEYW8sIAogICAgICAgIHN0cmluZyBfbmFtZSwKICAgICAgICBzdHJpbmcgX2Rlc2NyaXB0aW9uLAogICAgICAgIGJ5dGVzMzIgX2hhc2hPZlRoZURvY3VtZW50KSB7CgogICAgICAgIHBhc3NEYW8gPSBfcGFzc0RhbzsKICAgICAgICBuYW1lID0gX25hbWU7CiAgICAgICAgZGVzY3JpcHRpb24gPSBfZGVzY3JpcHRpb247CiAgICAgICAgaGFzaE9mVGhlRG9jdW1lbnQgPSBfaGFzaE9mVGhlRG9jdW1lbnQ7CiAgICAgICAgCiAgICAgICAgb3JkZXJzLmxlbmd0aCA9IDE7CiAgICAgICAgcmVzb2x1dGlvbnMubGVuZ3RoID0gMTsKICAgIH0KICAgIAovLyBJbnRlcm5hbCBmdW5jdGlvbnMKCiAgICAvLy8gQGRldiBJbnRlcm5hbCBmdW5jdGlvbiB0byByZWdpc3RlciBhIG5ldyBvcmRlcgogICAgLy8vIEBwYXJhbSBfY29udHJhY3RvckFkZHJlc3MgVGhlIGFkZHJlc3Mgb2YgdGhlIGNvbnRyYWN0b3Igc21hcnQgY29udHJhY3QKICAgIC8vLyBAcGFyYW0gX2NvbnRyYWN0b3JQcm9wb3NhbElEIFRoZSBpbmRleCBvZiB0aGUgY29udHJhY3RvciBwcm9wb3NhbAogICAgLy8vIEBwYXJhbSBfYW1vdW50IFRoZSBhbW91bnQgaW4gd2VpIG9mIHRoZSBvcmRlcgogICAgLy8vIEBwYXJhbSBfb3JkZXJEYXRlIFRoZSBkYXRlIG9mIHRoZSBvcmRlciAKICAgIGZ1bmN0aW9uIGFkZE9yZGVyKAoKICAgICAgICBhZGRyZXNzIF9jb250cmFjdG9yQWRkcmVzcywgCiAgICAgICAgdWludCBfY29udHJhY3RvclByb3Bvc2FsSUQsIAogICAgICAgIHVpbnQgX2Ftb3VudCwgCiAgICAgICAgdWludCBfb3JkZXJEYXRlKSBpbnRlcm5hbCB7CgogICAgICAgIHVpbnQgX29yZGVySUQgPSBvcmRlcnMubGVuZ3RoKys7CiAgICAgICAgb3JkZXIgZCA9IG9yZGVyc1tfb3JkZXJJRF07CiAgICAgICAgZC5jb250cmFjdG9yQWRkcmVzcyA9IF9jb250cmFjdG9yQWRkcmVzczsKICAgICAgICBkLmNvbnRyYWN0b3JQcm9wb3NhbElEID0gX2NvbnRyYWN0b3JQcm9wb3NhbElEOwogICAgICAgIGQuYW1vdW50ID0gX2Ftb3VudDsKICAgICAgICBkLm9yZGVyRGF0ZSA9IF9vcmRlckRhdGU7CiAgICAgICAgCiAgICAgICAgdG90YWxBbW91bnRPZk9yZGVycyArPSBfYW1vdW50OwogICAgICAgIAogICAgICAgIE9yZGVyQWRkZWQobXNnLnNlbmRlciwgX2NvbnRyYWN0b3JBZGRyZXNzLCBfY29udHJhY3RvclByb3Bvc2FsSUQsIF9hbW91bnQsIF9vcmRlckRhdGUpOwogICAgfQogICAgCi8vIFNldHRpbmcgZnVuY3Rpb25zCgogICAgLy8vIEBub3RpY2UgRnVuY3Rpb24gdG8gYWxsb3cgY2xvbmluZyBvcmRlcnMgaW4gY2FzZSBvZiB1cGdyYWRlCiAgICAvLy8gQHBhcmFtIF9jb250cmFjdG9yQWRkcmVzcyBUaGUgYWRkcmVzcyBvZiB0aGUgY29udHJhY3RvciBzbWFydCBjb250cmFjdAogICAgLy8vIEBwYXJhbSBfY29udHJhY3RvclByb3Bvc2FsSUQgVGhlIGluZGV4IG9mIHRoZSBjb250cmFjdG9yIHByb3Bvc2FsCiAgICAvLy8gQHBhcmFtIF9vcmRlckFtb3VudCBUaGUgYW1vdW50IGluIHdlaSBvZiB0aGUgb3JkZXIKICAgIC8vLyBAcGFyYW0gX2xhc3RPcmRlckRhdGUgVGhlIHVuaXggZGF0ZSBvZiB0aGUgbGFzdCBvcmRlciAKICAgIGZ1bmN0aW9uIGNsb25lT3JkZXIoCiAgICAgICAgYWRkcmVzcyBfY29udHJhY3RvckFkZHJlc3MsIAogICAgICAgIHVpbnQgX2NvbnRyYWN0b3JQcm9wb3NhbElELCAKICAgICAgICB1aW50IF9vcmRlckFtb3VudCwgCiAgICAgICAgdWludCBfbGFzdE9yZGVyRGF0ZSkgewogICAgICAgIAogICAgICAgIGlmIChwcm9qZWN0TWFuYWdlciAhPSAwKSB0aHJvdzsKICAgICAgICAKICAgICAgICBhZGRPcmRlcihfY29udHJhY3RvckFkZHJlc3MsIF9jb250cmFjdG9yUHJvcG9zYWxJRCwgX29yZGVyQW1vdW50LCBfbGFzdE9yZGVyRGF0ZSk7CiAgICB9CiAgICAKICAgIC8vLyBAbm90aWNlIEZ1bmN0aW9uIHRvIHNldCB0aGUgcHJvamVjdCBtYW5hZ2VyCiAgICAvLy8gQHBhcmFtIF9wcm9qZWN0TWFuYWdlciBUaGUgYWRkcmVzcyBvZiB0aGUgcHJvamVjdCBtYW5hZ2VyIHNtYXJ0IGNvbnRyYWN0CiAgICAvLy8gQHJldHVybiBUcnVlIGlmIHN1Y2Nlc3NmdWwKICAgIGZ1bmN0aW9uIHNldFByb2plY3RNYW5hZ2VyKGFkZHJlc3MgX3Byb2plY3RNYW5hZ2VyKSByZXR1cm5zIChib29sKSB7CgogICAgICAgIGlmIChfcHJvamVjdE1hbmFnZXIgPT0gMCB8fCBwcm9qZWN0TWFuYWdlciAhPSAwKSByZXR1cm47CiAgICAgICAgCiAgICAgICAgcHJvamVjdE1hbmFnZXIgPSBfcHJvamVjdE1hbmFnZXI7CiAgICAgICAgCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgovLyBQcm9qZWN0IG1hbmFnZXIgZnVuY3Rpb25zCgogICAgLy8vIEBub3RpY2UgRnVuY3Rpb24gdG8gYWxsb3cgdGhlIHByb2plY3QgbWFuYWdlciB1cGRhdGluZyB0aGUgZGVzY3JpcHRpb24gb2YgdGhlIHByb2plY3QKICAgIC8vLyBAcGFyYW0gX3Byb2plY3REZXNjcmlwdGlvbiBBIGRlc2NyaXB0aW9uIG9mIHRoZSBwcm9qZWN0CiAgICAvLy8gQHBhcmFtIF9oYXNoT2ZUaGVEb2N1bWVudCBUaGUgaGFzaCBvZiB0aGUgbGFzdCBkb2N1bWVudAogICAgZnVuY3Rpb24gdXBkYXRlRGVzY3JpcHRpb24oc3RyaW5nIF9wcm9qZWN0RGVzY3JpcHRpb24sIGJ5dGVzMzIgX2hhc2hPZlRoZURvY3VtZW50KSBvbmx5UHJvamVjdE1hbmFnZXIgewogICAgICAgIGRlc2NyaXB0aW9uID0gX3Byb2plY3REZXNjcmlwdGlvbjsKICAgICAgICBoYXNoT2ZUaGVEb2N1bWVudCA9IF9oYXNoT2ZUaGVEb2N1bWVudDsKICAgICAgICBQcm9qZWN0RGVzY3JpcHRpb25VcGRhdGVkKG1zZy5zZW5kZXIsIF9wcm9qZWN0RGVzY3JpcHRpb24sIF9oYXNoT2ZUaGVEb2N1bWVudCk7CiAgICB9CgovLyBDbGllbnQgZnVuY3Rpb25zCgogICAgLy8vIEBkZXYgRnVuY3Rpb24gdG8gYWxsb3cgdGhlIERhbyB0byByZWdpc3RlciBhIG5ldyBvcmRlcgogICAgLy8vIEBwYXJhbSBfY29udHJhY3RvckFkZHJlc3MgVGhlIGFkZHJlc3Mgb2YgdGhlIGNvbnRyYWN0b3Igc21hcnQgY29udHJhY3QKICAgIC8vLyBAcGFyYW0gX2NvbnRyYWN0b3JQcm9wb3NhbElEIFRoZSBpbmRleCBvZiB0aGUgY29udHJhY3RvciBwcm9wb3NhbAogICAgLy8vIEBwYXJhbSBfYW1vdW50IFRoZSBhbW91bnQgaW4gd2VpIG9mIHRoZSBvcmRlcgogICAgZnVuY3Rpb24gbmV3T3JkZXIoCiAgICAgICAgYWRkcmVzcyBfY29udHJhY3RvckFkZHJlc3MsIAogICAgICAgIHVpbnQgX2NvbnRyYWN0b3JQcm9wb3NhbElELCAKICAgICAgICB1aW50IF9hbW91bnQpIG9ubHlDbGllbnQgewogICAgICAgICAgICAKICAgICAgICBhZGRPcmRlcihfY29udHJhY3RvckFkZHJlc3MsIF9jb250cmFjdG9yUHJvcG9zYWxJRCwgX2Ftb3VudCwgbm93KTsKICAgIH0KICAgIAogICAgLy8vIEBkZXYgRnVuY3Rpb24gdG8gYWxsb3cgdGhlIERhbyB0byByZWdpc3RlciBhIG5ldyByZXNvbHV0aW9uCiAgICAvLy8gQHBhcmFtIF9uYW1lIFRoZSBuYW1lIG9mIHRoZSByZXNvbHV0aW9uCiAgICAvLy8gQHBhcmFtIF9kZXNjcmlwdGlvbiBUaGUgZGVzY3JpcHRpb24gb2YgdGhlIHJlc29sdXRpb24KICAgIGZ1bmN0aW9uIG5ld1Jlc29sdXRpb24oCiAgICAgICAgc3RyaW5nIF9uYW1lLCAKICAgICAgICBzdHJpbmcgX2Rlc2NyaXB0aW9uKSBvbmx5Q2xpZW50IHsKCiAgICAgICAgdWludCBfcmVzb2x1dGlvbklEID0gcmVzb2x1dGlvbnMubGVuZ3RoKys7CiAgICAgICAgcmVzb2x1dGlvbiBkID0gcmVzb2x1dGlvbnNbX3Jlc29sdXRpb25JRF07CiAgICAgICAgCiAgICAgICAgZC5uYW1lID0gX25hbWU7CiAgICAgICAgZC5kZXNjcmlwdGlvbiA9IF9kZXNjcmlwdGlvbjsKICAgICAgICBkLmNyZWF0aW9uRGF0ZSA9IG5vdzsKCiAgICAgICAgUmVzb2x1dGlvbkFkZGVkKG1zZy5zZW5kZXIsIF9yZXNvbHV0aW9uSUQsIGQubmFtZSwgZC5kZXNjcmlwdGlvbik7CiAgICB9Cn0KCmNvbnRyYWN0IFBhc3NQcm9qZWN0Q3JlYXRvciB7CiAgICAKICAgIGV2ZW50IE5ld1Bhc3NQcm9qZWN0KFBhc3NEYW8gaW5kZXhlZCBEYW8sIFBhc3NQcm9qZWN0IGluZGV4ZWQgUHJvamVjdCwgc3RyaW5nIE5hbWUsIHN0cmluZyBEZXNjcmlwdGlvbiwgYnl0ZXMzMiBIYXNoT2ZUaGVEb2N1bWVudCk7CgogICAgLy8vIEBub3RpY2UgRnVuY3Rpb24gdG8gY3JlYXRlIGEgbmV3IFBhc3MgcHJvamVjdAogICAgLy8vIEBwYXJhbSBfcGFzc0RhbyBUaGUgUGFzcyBEYW8gc21hcnQgY29udHJhY3QKICAgIC8vLyBAcGFyYW0gX25hbWUgVGhlIHByb2plY3QgbmFtZQogICAgLy8vIEBwYXJhbSBfZGVzY3JpcHRpb24gVGhlIHByb2plY3QgZGVzY3JpcHRpb24gKG5vdCBtYW5kYXRvcnksIGNhbiBiZSB1cGRhdGVkIGFmdGVyIGJ5IHRoZSBjcmVhdG9yKQogICAgLy8vIEBwYXJhbSBfaGFzaE9mVGhlRG9jdW1lbnQgVGhlIEhhc2ggT2YgdGhlIHByb2plY3QgRG9jdW1lbnQgKG5vdCBtYW5kYXRvcnksIGNhbiBiZSB1cGRhdGVkIGFmdGVyIGJ5IHRoZSBjcmVhdG9yKQogICAgZnVuY3Rpb24gY3JlYXRlUHJvamVjdCgKICAgICAgICBQYXNzRGFvIF9wYXNzRGFvLAogICAgICAgIHN0cmluZyBfbmFtZSwgCiAgICAgICAgc3RyaW5nIF9kZXNjcmlwdGlvbiwgCiAgICAgICAgYnl0ZXMzMiBfaGFzaE9mVGhlRG9jdW1lbnQKICAgICAgICApIHJldHVybnMgKFBhc3NQcm9qZWN0KSB7CgogICAgICAgIFBhc3NQcm9qZWN0IF9wYXNzUHJvamVjdCA9IG5ldyBQYXNzUHJvamVjdChfcGFzc0RhbywgX25hbWUsIF9kZXNjcmlwdGlvbiwgX2hhc2hPZlRoZURvY3VtZW50KTsKCiAgICAgICAgTmV3UGFzc1Byb2plY3QoX3Bhc3NEYW8sIF9wYXNzUHJvamVjdCwgX25hbWUsIF9kZXNjcmlwdGlvbiwgX2hhc2hPZlRoZURvY3VtZW50KTsKCiAgICAgICAgcmV0dXJuIF9wYXNzUHJvamVjdDsKICAgIH0KfQogICAgCgpwcmFnbWEgc29saWRpdHkgXjAuNC44OwoKLyoKICoKICogVGhpcyBmaWxlIGlzIHBhcnQgb2YgUGFzcyBEQU8uCiAqCiAqIFRoZSBQcm9qZWN0IHNtYXJ0IGNvbnRyYWN0IGlzIHVzZWQgZm9yIHRoZSBtYW5hZ2VtZW50IG9mIHRoZSBQYXNzIERhbyBwcm9qZWN0cy4KICoKKi8KCi8vLyBAdGl0bGUgQ29udHJhY3RvciBzbWFydCBjb250cmFjdCBvZiB0aGUgUGFzcyBEZWNlbnRyYWxpemVkIEF1dG9ub21vdXMgT3JnYW5pc2F0aW9uCmNvbnRyYWN0IFBhc3NDb250cmFjdG9yIHsKICAgIAogICAgLy8gVGhlIHByb2plY3Qgc21hcnQgY29udHJhY3QKICAgIFBhc3NQcm9qZWN0IHBhc3NQcm9qZWN0OwogICAgCiAgICAvLyBUaGUgYWRkcmVzcyBvZiB0aGUgY3JlYXRvciBvZiB0aGlzIHNtYXJ0IGNvbnRyYWN0CiAgICBhZGRyZXNzIHB1YmxpYyBjcmVhdG9yOwogICAgLy8gQWRkcmVzcyBvZiB0aGUgcmVjaXBpZW50OwogICAgYWRkcmVzcyBwdWJsaWMgcmVjaXBpZW50OwoKICAgIC8vIEVuZCBkYXRlIG9mIHRoZSBzZXR1cCBwcm9jZWR1cmUKICAgIHVpbnQgcHVibGljIHNtYXJ0Q29udHJhY3RTdGFydERhdGU7CgogICAgc3RydWN0IHByb3Bvc2FsIHsKICAgICAgICAvLyBBbW91bnQgKGluIHdlaSkgb2YgdGhlIHByb3Bvc2FsCiAgICAgICAgdWludCBhbW91bnQ7CiAgICAgICAgLy8gQSBkZXNjcmlwdGlvbiBvZiB0aGUgcHJvcG9zYWwKICAgICAgICBzdHJpbmcgZGVzY3JpcHRpb247CiAgICAgICAgLy8gVGhlIGhhc2ggb2YgdGhlIHByb3Bvc2FsJ3MgZG9jdW1lbnQKICAgICAgICBieXRlczMyIGhhc2hPZlRoZURvY3VtZW50OwogICAgICAgIC8vIEEgdW5peCB0aW1lc3RhbXAsIGRlbm90aW5nIHRoZSBkYXRlIHdoZW4gdGhlIHByb3Bvc2FsIHdhcyBjcmVhdGVkCiAgICAgICAgdWludCBkYXRlT2ZQcm9wb3NhbDsKICAgICAgICAvLyBUaGUgYW1vdW50IHN1Ym1pdHRlZCB0byBhIHZvdGUKICAgICAgICB1aW50IHN1Ym1pdHRlZEFtb3VudDsKICAgICAgICAvLyBUaGUgc3VtIGFtb3VudCAoaW4gd2VpKSBvcmRlcmVkIGZvciB0aGlzIHByb3Bvc2FsIAogICAgICAgIHVpbnQgb3JkZXJBbW91bnQ7CiAgICAgICAgLy8gQSB1bml4IHRpbWVzdGFtcCwgZGVub3RpbmcgdGhlIGRhdGUgb2YgdGhlIGxhc3Qgb3JkZXIgZm9yIHRoZSBhcHByb3ZlZCBwcm9wb3NhbAogICAgICAgIHVpbnQgZGF0ZU9mTGFzdE9yZGVyOwogICAgfQogICAgLy8gUHJvcG9zYWxzIHRvIHdvcmsgZm9yIFBhc3MgRGFvCiAgICBwcm9wb3NhbFtdIHB1YmxpYyBwcm9wb3NhbHM7CgovLyBFdmVudHMKCiAgICBldmVudCBSZWNpcGllbnRVcGRhdGVkKGFkZHJlc3MgaW5kZXhlZCBCeSwgYWRkcmVzcyBMYXN0UmVjaXBpZW50LCBhZGRyZXNzIE5ld1JlY2lwaWVudCk7CiAgICBldmVudCBXaXRoZHJhd2FsKGFkZHJlc3MgaW5kZXhlZCBCeSwgYWRkcmVzcyBpbmRleGVkIFJlY2lwaWVudCwgdWludCBBbW91bnQpOwogICAgZXZlbnQgUHJvcG9zYWxBZGRlZChhZGRyZXNzIENyZWF0b3IsIHVpbnQgaW5kZXhlZCBQcm9wb3NhbElELCB1aW50IEFtb3VudCwgc3RyaW5nIERlc2NyaXB0aW9uLCBieXRlczMyIEhhc2hPZlRoZURvY3VtZW50KTsKICAgIGV2ZW50IFByb3Bvc2FsU3VibWl0dGVkKGFkZHJlc3MgaW5kZXhlZCBDbGllbnQsIHVpbnQgQW1vdW50KTsKICAgIGV2ZW50IE9yZGVyKGFkZHJlc3MgaW5kZXhlZCBDbGllbnQsIHVpbnQgaW5kZXhlZCBQcm9wb3NhbElELCB1aW50IEFtb3VudCk7CgovLyBDb25zdGFudCBmdW5jdGlvbnMKCiAgICAvLy8gQHJldHVybiB0aGUgYWN0dWFsIGNvbW1pdHRlZSByb29tIG9mIHRoZSBEYW8KICAgIGZ1bmN0aW9uIENsaWVudCgpIGNvbnN0YW50IHJldHVybnMgKGFkZHJlc3MpIHsKICAgICAgICByZXR1cm4gcGFzc1Byb2plY3QuQ2xpZW50KCk7CiAgICB9CgogICAgLy8vIEByZXR1cm4gdGhlIHByb2plY3Qgc21hcnQgY29udHJhY3QKICAgIGZ1bmN0aW9uIFByb2plY3QoKSBjb25zdGFudCByZXR1cm5zIChQYXNzUHJvamVjdCkgewogICAgICAgIHJldHVybiBwYXNzUHJvamVjdDsKICAgIH0KICAgIAogICAgLy8vIEBub3RpY2UgRnVuY3Rpb24gdXNlZCBieSB0aGUgY2xpZW50IHRvIGNoZWNrIHRoZSBwcm9wb3NhbCBiZWZvcmUgc3VibWl0dGluZwogICAgLy8vIEBwYXJhbSBfc2VuZGVyIFRoZSBjcmVhdG9yIG9mIHRoZSBEYW8gcHJvcG9zYWwKICAgIC8vLyBAcGFyYW0gX3Byb3Bvc2FsSUQgVGhlIGluZGV4IG9mIHRoZSBwcm9wb3NhbAogICAgLy8vIEBwYXJhbSBfYW1vdW50IFRoZSBhbW91bnQgb2YgdGhlIHByb3Bvc2FsCiAgICAvLy8gQHJldHVybiB0cnVlIGlmIHRoZSBwcm9wb3NhbCBjYW4gYmUgc3VibWl0dGVkCiAgICBmdW5jdGlvbiBwcm9wb3NhbENoZWNrZWQoCiAgICAgICAgYWRkcmVzcyBfc2VuZGVyLAogICAgICAgIHVpbnQgX3Byb3Bvc2FsSUQsIAogICAgICAgIHVpbnQgX2Ftb3VudCkgY29uc3RhbnQgZXh0ZXJuYWwgb25seUNsaWVudCByZXR1cm5zIChib29sKSB7CiAgICAgICAgaWYgKF9zZW5kZXIgIT0gcmVjaXBpZW50ICYmIF9zZW5kZXIgIT0gY3JlYXRvcikgcmV0dXJuOwogICAgICAgIGlmIChfYW1vdW50IDw9IHByb3Bvc2Fsc1tfcHJvcG9zYWxJRF0uYW1vdW50IC0gcHJvcG9zYWxzW19wcm9wb3NhbElEXS5zdWJtaXR0ZWRBbW91bnQpIHJldHVybiB0cnVlOwogICAgfQoKICAgIC8vLyBAcmV0dXJuIFRoZSBudW1iZXIgb2YgcHJvcG9zYWxzICAgICAKICAgIGZ1bmN0aW9uIG51bWJlck9mUHJvcG9zYWxzKCkgY29uc3RhbnQgcmV0dXJucyAodWludCkgewogICAgICAgIHJldHVybiBwcm9wb3NhbHMubGVuZ3RoIC0gMTsKICAgIH0KCgovLyBNb2RpZmllcnMKCiAgICAvLyBNb2RpZmllciBmb3IgY29udHJhY3RvciBmdW5jdGlvbnMKICAgIG1vZGlmaWVyIG9ubHlDb250cmFjdG9yIHtpZiAobXNnLnNlbmRlciAhPSByZWNpcGllbnQpIHRocm93OyBfO30KICAgIAogICAgLy8gTW9kaWZpZXIgZm9yIGNsaWVudCBmdW5jdGlvbnMKICAgIG1vZGlmaWVyIG9ubHlDbGllbnQge2lmIChtc2cuc2VuZGVyICE9IENsaWVudCgpKSB0aHJvdzsgXzt9CgovLyBDb25zdHJ1Y3RvciBmdW5jdGlvbgoKICAgIGZ1bmN0aW9uIFBhc3NDb250cmFjdG9yKAogICAgICAgIGFkZHJlc3MgX2NyZWF0b3IsIAogICAgICAgIFBhc3NQcm9qZWN0IF9wYXNzUHJvamVjdCwgCiAgICAgICAgYWRkcmVzcyBfcmVjaXBpZW50LAogICAgICAgIGJvb2wgX3Jlc3RvcmUpIHsgCgogICAgICAgIGlmIChhZGRyZXNzKF9wYXNzUHJvamVjdCkgPT0gMCkgdGhyb3c7CiAgICAgICAgCiAgICAgICAgY3JlYXRvciA9IF9jcmVhdG9yOwogICAgICAgIGlmIChfcmVjaXBpZW50ID09IDApIF9yZWNpcGllbnQgPSBfY3JlYXRvcjsKICAgICAgICByZWNpcGllbnQgPSBfcmVjaXBpZW50OwogICAgICAgIAogICAgICAgIHBhc3NQcm9qZWN0ID0gX3Bhc3NQcm9qZWN0OwogICAgICAgIAogICAgICAgIGlmICghX3Jlc3RvcmUpIHNtYXJ0Q29udHJhY3RTdGFydERhdGUgPSBub3c7CgogICAgICAgIHByb3Bvc2Fscy5sZW5ndGggPSAxOwogICAgfQoKLy8gU2V0dGluZyBmdW5jdGlvbnMKCiAgICAvLy8gQG5vdGljZSBGdW5jdGlvbiB0byBjbG9uZSBhIHByb3Bvc2FsIGZyb20gdGhlIGxhc3QgY29udHJhY3RvcgogICAgLy8vIEBwYXJhbSBfYW1vdW50IEFtb3VudCAoaW4gd2VpKSBvZiB0aGUgcHJvcG9zYWwKICAgIC8vLyBAcGFyYW0gX2Rlc2NyaXB0aW9uIEEgZGVzY3JpcHRpb24gb2YgdGhlIHByb3Bvc2FsCiAgICAvLy8gQHBhcmFtIF9oYXNoT2ZUaGVEb2N1bWVudCBUaGUgaGFzaCBvZiB0aGUgcHJvcG9zYWwncyBkb2N1bWVudAogICAgLy8vIEBwYXJhbSBfZGF0ZU9mUHJvcG9zYWwgQSB1bml4IHRpbWVzdGFtcCwgZGVub3RpbmcgdGhlIGRhdGUgd2hlbiB0aGUgcHJvcG9zYWwgd2FzIGNyZWF0ZWQKICAgIC8vLyBAcGFyYW0gX29yZGVyQW1vdW50IFRoZSBzdW0gYW1vdW50IChpbiB3ZWkpIG9yZGVyZWQgZm9yIHRoaXMgcHJvcG9zYWwgCiAgICAvLy8gQHBhcmFtIF9kYXRlT2ZPcmRlciBBIHVuaXggdGltZXN0YW1wLCBkZW5vdGluZyB0aGUgZGF0ZSBvZiB0aGUgbGFzdCBvcmRlciBmb3IgdGhlIGFwcHJvdmVkIHByb3Bvc2FsCiAgICAvLy8gQHBhcmFtIF9jbG9uZU9yZGVyIFRydWUgaWYgdGhlIG9yZGVyIGhhcyB0byBiZSBjbG9uZWQgaW4gdGhlIHByb2plY3Qgc21hcnQgY29udHJhY3QKICAgIC8vLyBAcmV0dXJuIFdoZXRoZXIgdGhlIGZ1bmN0aW9uIHdhcyBzdWNjZXNzZnVsIG9yIG5vdCAKICAgIGZ1bmN0aW9uIGNsb25lUHJvcG9zYWwoCiAgICAgICAgdWludCBfYW1vdW50LAogICAgICAgIHN0cmluZyBfZGVzY3JpcHRpb24sCiAgICAgICAgYnl0ZXMzMiBfaGFzaE9mVGhlRG9jdW1lbnQsCiAgICAgICAgdWludCBfZGF0ZU9mUHJvcG9zYWwsCiAgICAgICAgdWludCBfb3JkZXJBbW91bnQsCiAgICAgICAgdWludCBfZGF0ZU9mT3JkZXIsCiAgICAgICAgYm9vbCBfY2xvbmVPcmRlcgogICAgKSByZXR1cm5zIChib29sIHN1Y2Nlc3MpIHsKICAgICAgICAgICAgCiAgICAgICAgaWYgKHNtYXJ0Q29udHJhY3RTdGFydERhdGUgIT0gMCB8fCByZWNpcGllbnQgPT0gMAogICAgICAgIHx8IG1zZy5zZW5kZXIgIT0gY3JlYXRvcikgdGhyb3c7CiAgICAgICAgCiAgICAgICAgdWludCBfcHJvcG9zYWxJRCA9IHByb3Bvc2Fscy5sZW5ndGgrKzsKICAgICAgICBwcm9wb3NhbCBjID0gcHJvcG9zYWxzW19wcm9wb3NhbElEXTsKCiAgICAgICAgYy5hbW91bnQgPSBfYW1vdW50OwogICAgICAgIGMuZGVzY3JpcHRpb24gPSBfZGVzY3JpcHRpb247CiAgICAgICAgYy5oYXNoT2ZUaGVEb2N1bWVudCA9IF9oYXNoT2ZUaGVEb2N1bWVudDsgCiAgICAgICAgYy5kYXRlT2ZQcm9wb3NhbCA9IF9kYXRlT2ZQcm9wb3NhbDsKICAgICAgICBjLm9yZGVyQW1vdW50ID0gX29yZGVyQW1vdW50OwogICAgICAgIGMuZGF0ZU9mTGFzdE9yZGVyID0gX2RhdGVPZk9yZGVyOwoKICAgICAgICBQcm9wb3NhbEFkZGVkKG1zZy5zZW5kZXIsIF9wcm9wb3NhbElELCBfYW1vdW50LCBfZGVzY3JpcHRpb24sIF9oYXNoT2ZUaGVEb2N1bWVudCk7CiAgICAgICAgCiAgICAgICAgaWYgKF9jbG9uZU9yZGVyKSBwYXNzUHJvamVjdC5jbG9uZU9yZGVyKGFkZHJlc3ModGhpcyksIF9wcm9wb3NhbElELCBfb3JkZXJBbW91bnQsIF9kYXRlT2ZPcmRlcik7CiAgICAgICAgCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgLy8vIEBub3RpY2UgRnVuY3Rpb24gdG8gY2xvc2UgdGhlIHNldHRpbmcgcHJvY2VkdXJlIGFuZCBzdGFydCB0byB1c2UgdGhpcyBzbWFydCBjb250cmFjdAogICAgLy8vIEByZXR1cm4gVHJ1ZSBpZiBzdWNjZXNzZnVsCiAgICBmdW5jdGlvbiBjbG9zZVNldHVwKCkgcmV0dXJucyAoYm9vbCkgewogICAgICAgIAogICAgICAgIGlmIChzbWFydENvbnRyYWN0U3RhcnREYXRlICE9IDAgCiAgICAgICAgICAgIHx8IChtc2cuc2VuZGVyICE9IGNyZWF0b3IgJiYgbXNnLnNlbmRlciAhPSBDbGllbnQoKSkpIHJldHVybjsKCiAgICAgICAgc21hcnRDb250cmFjdFN0YXJ0RGF0ZSA9IG5vdzsKCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICAKLy8gQWNjb3VudCBNYW5hZ2VtZW50CgogICAgLy8vIEBub3RpY2UgRnVuY3Rpb24gdG8gdXBkYXRlIHRoZSByZWNpcGVudCBhZGRyZXNzCiAgICAvLy8gQHBhcmFtIF9uZXdSZWNpcGllbnQgVGhlIGFkcmVzcyBvZiB0aGUgcmVjaXBpZW50CiAgICBmdW5jdGlvbiB1cGRhdGVSZWNpcGllbnQoYWRkcmVzcyBfbmV3UmVjaXBpZW50KSBvbmx5Q29udHJhY3RvciB7CgogICAgICAgIGlmIChfbmV3UmVjaXBpZW50ID09IDApIHRocm93OwoKICAgICAgICBSZWNpcGllbnRVcGRhdGVkKG1zZy5zZW5kZXIsIHJlY2lwaWVudCwgX25ld1JlY2lwaWVudCk7CiAgICAgICAgcmVjaXBpZW50ID0gX25ld1JlY2lwaWVudDsKICAgIH0gCgogICAgLy8vIEBub3RpY2UgRnVuY3Rpb24gdG8gcmVjZWl2ZSBwYXltZW50cwogICAgZnVuY3Rpb24gKCkgcGF5YWJsZSB7IH0KICAgIAogICAgLy8vIEBub3RpY2UgRnVuY3Rpb24gdG8gYWxsb3cgY29udHJhY3RvcnMgdG8gd2l0aGRyYXcgZXRoZXJzCiAgICAvLy8gQHBhcmFtIF9hbW91bnQgVGhlIGFtb3VudCAoaW4gd2VpKSB0byB3aXRoZHJhdwogICAgZnVuY3Rpb24gd2l0aGRyYXcodWludCBfYW1vdW50KSBvbmx5Q29udHJhY3RvciB7CiAgICAgICAgaWYgKCFyZWNpcGllbnQuc2VuZChfYW1vdW50KSkgdGhyb3c7CiAgICAgICAgV2l0aGRyYXdhbChtc2cuc2VuZGVyLCByZWNpcGllbnQsIF9hbW91bnQpOwogICAgfQogICAgCi8vIFByb2plY3QgTWFuYWdlciBGdW5jdGlvbnMgICAgCgogICAgLy8vIEBub3RpY2UgRnVuY3Rpb24gdG8gYWxsb3cgdGhlIHByb2plY3QgbWFuYWdlciB1cGRhdGluZyB0aGUgZGVzY3JpcHRpb24gb2YgdGhlIHByb2plY3QKICAgIC8vLyBAcGFyYW0gX3Byb2plY3REZXNjcmlwdGlvbiBBIGRlc2NyaXB0aW9uIG9mIHRoZSBwcm9qZWN0CiAgICAvLy8gQHBhcmFtIF9oYXNoT2ZUaGVEb2N1bWVudCBUaGUgaGFzaCBvZiB0aGUgbGFzdCBkb2N1bWVudAogICAgZnVuY3Rpb24gdXBkYXRlUHJvamVjdERlc2NyaXB0aW9uKHN0cmluZyBfcHJvamVjdERlc2NyaXB0aW9uLCBieXRlczMyIF9oYXNoT2ZUaGVEb2N1bWVudCkgb25seUNvbnRyYWN0b3IgewogICAgICAgIHBhc3NQcm9qZWN0LnVwZGF0ZURlc2NyaXB0aW9uKF9wcm9qZWN0RGVzY3JpcHRpb24sIF9oYXNoT2ZUaGVEb2N1bWVudCk7CiAgICB9CiAgICAKLy8gTWFuYWdlbWVudCBvZiBwcm9wb3NhbHMKCiAgICAvLy8gQG5vdGljZSBGdW5jdGlvbiB0byBtYWtlIGEgcHJvcG9zYWwgdG8gd29yayBmb3IgdGhlIGNsaWVudAogICAgLy8vIEBwYXJhbSBfY3JlYXRvciBUaGUgYWRkcmVzcyBvZiB0aGUgY3JlYXRvciBvZiB0aGUgcHJvcG9zYWwKICAgIC8vLyBAcGFyYW0gX2Ftb3VudCBUaGUgYW1vdW50IChpbiB3ZWkpIG9mIHRoZSBwcm9wb3NhbAogICAgLy8vIEBwYXJhbSBfZGVzY3JpcHRpb24gU3RyaW5nIGRlc2NyaWJpbmcgdGhlIHByb3Bvc2FsCiAgICAvLy8gQHBhcmFtIF9oYXNoT2ZUaGVEb2N1bWVudCBUaGUgaGFzaCBvZiB0aGUgcHJvcG9zYWwgZG9jdW1lbnQKICAgIC8vLyBAcmV0dXJuIFRoZSBpbmRleCBvZiB0aGUgY29udHJhY3RvciBwcm9wb3NhbAogICAgZnVuY3Rpb24gbmV3UHJvcG9zYWwoCiAgICAgICAgYWRkcmVzcyBfY3JlYXRvciwKICAgICAgICB1aW50IF9hbW91bnQsCiAgICAgICAgc3RyaW5nIF9kZXNjcmlwdGlvbiwgCiAgICAgICAgYnl0ZXMzMiBfaGFzaE9mVGhlRG9jdW1lbnQKICAgICkgZXh0ZXJuYWwgcmV0dXJucyAodWludCkgewogICAgICAgIAogICAgICAgIGlmIChtc2cuc2VuZGVyID09IENsaWVudCgpICYmIF9jcmVhdG9yICE9IHJlY2lwaWVudCAmJiBfY3JlYXRvciAhPSBjcmVhdG9yKSB0aHJvdzsKICAgICAgICBpZiAobXNnLnNlbmRlciAhPSBDbGllbnQoKSAmJiBtc2cuc2VuZGVyICE9IHJlY2lwaWVudCAmJiBtc2cuc2VuZGVyICE9IGNyZWF0b3IpIHRocm93OwoKICAgICAgICBpZiAoX2Ftb3VudCA9PSAwKSB0aHJvdzsKICAgICAgICAKICAgICAgICB1aW50IF9wcm9wb3NhbElEID0gcHJvcG9zYWxzLmxlbmd0aCsrOwogICAgICAgIHByb3Bvc2FsIGMgPSBwcm9wb3NhbHNbX3Byb3Bvc2FsSURdOwoKICAgICAgICBjLmFtb3VudCA9IF9hbW91bnQ7CiAgICAgICAgYy5kZXNjcmlwdGlvbiA9IF9kZXNjcmlwdGlvbjsKICAgICAgICBjLmhhc2hPZlRoZURvY3VtZW50ID0gX2hhc2hPZlRoZURvY3VtZW50OyAKICAgICAgICBjLmRhdGVPZlByb3Bvc2FsID0gbm93OwogICAgICAgIAogICAgICAgIFByb3Bvc2FsQWRkZWQobXNnLnNlbmRlciwgX3Byb3Bvc2FsSUQsIGMuYW1vdW50LCBjLmRlc2NyaXB0aW9uLCBjLmhhc2hPZlRoZURvY3VtZW50KTsKICAgICAgICAKICAgICAgICByZXR1cm4gX3Byb3Bvc2FsSUQ7CiAgICB9CiAgICAKICAgIC8vLyBAbm90aWNlIEZ1bmN0aW9uIHVzZWQgYnkgdGhlIGNsaWVudCB0byBpbmZvciBhYm91dCB0aGUgc3VibWl0dGVkIGFtb3VudAogICAgLy8vIEBwYXJhbSBfc2VuZGVyIFRoZSBhZGRyZXNzIG9mIHRoZSBzZW5kZXIgd2hvIHN1Ym1pdHMgdGhlIHByb3Bvc2FsCiAgICAvLy8gQHBhcmFtIF9wcm9wb3NhbElEIFRoZSBpbmRleCBvZiB0aGUgY29udHJhY3RvciBwcm9wb3NhbAogICAgLy8vIEBwYXJhbSBfYW1vdW50IFRoZSBhbW91bnQgKGluIHdlaSkgc3VibWl0dGVkCiAgICBmdW5jdGlvbiBzdWJtaXRQcm9wb3NhbCgKICAgICAgICBhZGRyZXNzIF9zZW5kZXIsIAogICAgICAgIHVpbnQgX3Byb3Bvc2FsSUQsIAogICAgICAgIHVpbnQgX2Ftb3VudCkgb25seUNsaWVudCB7CgogICAgICAgIGlmIChfc2VuZGVyICE9IHJlY2lwaWVudCAmJiBfc2VuZGVyICE9IGNyZWF0b3IpIHRocm93OyAgICAKICAgICAgICBwcm9wb3NhbHNbX3Byb3Bvc2FsSURdLnN1Ym1pdHRlZEFtb3VudCArPSBfYW1vdW50OwogICAgICAgIFByb3Bvc2FsU3VibWl0dGVkKG1zZy5zZW5kZXIsIF9hbW91bnQpOwogICAgfQoKICAgIC8vLyBAbm90aWNlIEZ1bmN0aW9uIHVzZWQgYnkgdGhlIGNsaWVudCB0byBvcmRlciBhY2NvcmRpbmcgdG8gdGhlIGNvbnRyYWN0b3IgcHJvcG9zYWwKICAgIC8vLyBAcGFyYW0gX3Byb3Bvc2FsSUQgVGhlIGluZGV4IG9mIHRoZSBjb250cmFjdG9yIHByb3Bvc2FsCiAgICAvLy8gQHBhcmFtIF9vcmRlckFtb3VudCBUaGUgYW1vdW50IChpbiB3ZWkpIG9mIHRoZSBvcmRlcgogICAgLy8vIEByZXR1cm4gV2hldGhlciB0aGUgb3JkZXIgd2FzIG1hZGUgb3Igbm90CiAgICBmdW5jdGlvbiBvcmRlcigKICAgICAgICB1aW50IF9wcm9wb3NhbElELAogICAgICAgIHVpbnQgX29yZGVyQW1vdW50CiAgICApIGV4dGVybmFsIG9ubHlDbGllbnQgcmV0dXJucyAoYm9vbCkgewogICAgCiAgICAgICAgcHJvcG9zYWwgYyA9IHByb3Bvc2Fsc1tfcHJvcG9zYWxJRF07CiAgICAgICAgCiAgICAgICAgdWludCBfc3VtID0gYy5vcmRlckFtb3VudCArIF9vcmRlckFtb3VudDsKICAgICAgICBpZiAoX3N1bSA+IGMuYW1vdW50CiAgICAgICAgICAgIHx8IF9zdW0gPCBjLm9yZGVyQW1vdW50CiAgICAgICAgICAgIHx8IF9zdW0gPCBfb3JkZXJBbW91bnQpIHJldHVybjsgCgogICAgICAgIGMub3JkZXJBbW91bnQgPSBfc3VtOwogICAgICAgIGMuZGF0ZU9mTGFzdE9yZGVyID0gbm93OwogICAgICAgIAogICAgICAgIE9yZGVyKG1zZy5zZW5kZXIsIF9wcm9wb3NhbElELCBfb3JkZXJBbW91bnQpOwogICAgICAgIAogICAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgCn0KCmNvbnRyYWN0IFBhc3NDb250cmFjdG9yQ3JlYXRvciB7CiAgICAKICAgIC8vIEFkZHJlc3Mgb2YgdGhlIHBhc3MgRGFvIHNtYXJ0IGNvbnRyYWN0CiAgICBQYXNzRGFvIHB1YmxpYyBwYXNzRGFvOwogICAgLy8gQWRkcmVzcyBvZiB0aGUgUGFzcyBQcm9qZWN0IGNyZWF0b3IKICAgIFBhc3NQcm9qZWN0Q3JlYXRvciBwdWJsaWMgcHJvamVjdENyZWF0b3I7CiAgICAKICAgIHN0cnVjdCBjb250cmFjdG9yIHsKICAgICAgICAvLyBUaGUgYWRkcmVzcyBvZiB0aGUgY3JlYXRvciBvZiB0aGUgY29udHJhY3RvcgogICAgICAgIGFkZHJlc3MgY3JlYXRvcjsKICAgICAgICAvLyBUaGUgY29udHJhY3RvciBzbWFydCBjb250cmFjdAogICAgICAgIFBhc3NDb250cmFjdG9yIGNvbnRyYWN0b3I7CiAgICAgICAgLy8gVGhlIGFkZHJlc3Mgb2YgdGhlIHJlY2lwaWVudCBmb3Igd2l0aGRyYXdhbHMKICAgICAgICBhZGRyZXNzIHJlY2lwaWVudDsKICAgICAgICAvLyBUcnVlIGlmIG1ldGEgcHJvamVjdAogICAgICAgIGJvb2wgbWV0YVByb2plY3Q7CiAgICAgICAgLy8gVGhlIGFkZHJlc3Mgb2YgdGhlIGV4aXN0aW5nIHByb2plY3Qgc21hcnQgY29udHJhY3QKICAgICAgICBQYXNzUHJvamVjdCBwYXNzUHJvamVjdDsKICAgICAgICAvLyBUaGUgbmFtZSBvZiB0aGUgcHJvamVjdCAoaWYgdGhlIHByb2plY3Qgc21hcnQgY29udHJhY3QgZG9lc24ndCBleGlzdCkKICAgICAgICBzdHJpbmcgcHJvamVjdE5hbWU7CiAgICAgICAgLy8gQSBkZXNjcmlwdGlvbiBvZiB0aGUgcHJvamVjdCAoY2FuIGJlIHVwZGF0ZWQgYWZ0ZXIpCiAgICAgICAgc3RyaW5nIHByb2plY3REZXNjcmlwdGlvbjsKICAgICAgICAvLyBUaGUgdW5peCBjcmVhdGlvbiBkYXRlIG9mIHRoZSBjb250cmFjdG9yCiAgICAgICAgdWludCBjcmVhdGlvbkRhdGU7CiAgICB9CiAgICAvLyBjb250cmFjdG9ycyBjcmVhdGVkIHRvIHdvcmsgZm9yIFBhc3MgRGFvCiAgICBjb250cmFjdG9yW10gcHVibGljIGNvbnRyYWN0b3JzOwogICAgCiAgICBldmVudCBOZXdQYXNzQ29udHJhY3RvcihhZGRyZXNzIGluZGV4ZWQgQ3JlYXRvciwgYWRkcmVzcyBpbmRleGVkIFJlY2lwaWVudCwgUGFzc1Byb2plY3QgaW5kZXhlZCBQcm9qZWN0LCBQYXNzQ29udHJhY3RvciBDb250cmFjdG9yKTsKCiAgICBmdW5jdGlvbiBQYXNzQ29udHJhY3RvckNyZWF0b3IoUGFzc0RhbyBfcGFzc0RhbywgUGFzc1Byb2plY3RDcmVhdG9yIF9wcm9qZWN0Q3JlYXRvcikgewogICAgICAgIHBhc3NEYW8gPSBfcGFzc0RhbzsKICAgICAgICBwcm9qZWN0Q3JlYXRvciA9IF9wcm9qZWN0Q3JlYXRvcjsKICAgICAgICBjb250cmFjdG9ycy5sZW5ndGggPSAwOwogICAgfQoKICAgIC8vLyBAcmV0dXJuIFRoZSBudW1iZXIgb2YgY3JlYXRlZCBjb250cmFjdG9ycyAKICAgIGZ1bmN0aW9uIG51bWJlck9mQ29udHJhY3RvcnMoKSBjb25zdGFudCByZXR1cm5zICh1aW50KSB7CiAgICAgICAgcmV0dXJuIGNvbnRyYWN0b3JzLmxlbmd0aDsKICAgIH0KICAgIAogICAgLy8vIEBub3RpY2UgRnVuY3Rpb24gdG8gY3JlYXRlIGEgY29udHJhY3RvciBzbWFydCBjb250cmFjdAogICAgLy8vIEBwYXJhbSBfY3JlYXRvciBUaGUgYWRkcmVzcyBvZiB0aGUgY3JlYXRvciBvZiB0aGUgY29udHJhY3RvcgogICAgLy8vIEBwYXJhbSBfcmVjaXBpZW50IFRoZSBhZGRyZXNzIG9mIHRoZSByZWNpcGllbnQgZm9yIHdpdGhkcmF3YWxzCiAgICAvLy8gQHBhcmFtIF9tZXRhUHJvamVjdCBUcnVlIGlmIG1ldGEgcHJvamVjdAogICAgLy8vIEBwYXJhbSBfcGFzc1Byb2plY3QgVGhlIGFkZHJlc3Mgb2YgdGhlIGV4aXN0aW5nIHByb2plY3Qgc21hcnQgY29udHJhY3QKICAgIC8vLyBAcGFyYW0gX3Byb2plY3ROYW1lIFRoZSBuYW1lIG9mIHRoZSBwcm9qZWN0IChpZiB0aGUgcHJvamVjdCBzbWFydCBjb250cmFjdCBkb2Vzbid0IGV4aXN0KQogICAgLy8vIEBwYXJhbSBfcHJvamVjdERlc2NyaXB0aW9uIEEgZGVzY3JpcHRpb24gb2YgdGhlIHByb2plY3QgKGNhbiBiZSB1cGRhdGVkIGFmdGVyKQogICAgLy8vIEBwYXJhbSBfcmVzdG9yZSBUcnVlIGlmIG9yZGVycyBvciBwcm9wb3NhbHMgYXJlIHRvIGJlIGNsb25lZCBmcm9tIG90aGVyIGNvbnRyYWN0cwogICAgLy8vIEByZXR1cm4gVGhlIGFkZHJlc3Mgb2YgdGhlIGNyZWF0ZWQgY29udHJhY3RvciBzbWFydCBjb250cmFjdAogICAgZnVuY3Rpb24gY3JlYXRlQ29udHJhY3RvcigKICAgICAgICBhZGRyZXNzIF9jcmVhdG9yLAogICAgICAgIGFkZHJlc3MgX3JlY2lwaWVudCwgCiAgICAgICAgYm9vbCBfbWV0YVByb2plY3QsCiAgICAgICAgUGFzc1Byb2plY3QgX3Bhc3NQcm9qZWN0LAogICAgICAgIHN0cmluZyBfcHJvamVjdE5hbWUsIAogICAgICAgIHN0cmluZyBfcHJvamVjdERlc2NyaXB0aW9uLAogICAgICAgIGJvb2wgX3Jlc3RvcmUpIHJldHVybnMgKFBhc3NDb250cmFjdG9yKSB7CiAKICAgICAgICBQYXNzUHJvamVjdCBfcHJvamVjdDsKCiAgICAgICAgaWYgKF9jcmVhdG9yID09IDApIF9jcmVhdG9yID0gbXNnLnNlbmRlcjsKICAgICAgICAKICAgICAgICBpZiAoX21ldGFQcm9qZWN0KSBfcHJvamVjdCA9IFBhc3NQcm9qZWN0KHBhc3NEYW8uTWV0YVByb2plY3QoKSk7CiAgICAgICAgZWxzZSBpZiAoYWRkcmVzcyhfcGFzc1Byb2plY3QpID09IDApIAogICAgICAgICAgICBfcHJvamVjdCA9IHByb2plY3RDcmVhdG9yLmNyZWF0ZVByb2plY3QocGFzc0RhbywgX3Byb2plY3ROYW1lLCBfcHJvamVjdERlc2NyaXB0aW9uLCAwKTsKICAgICAgICBlbHNlIF9wcm9qZWN0ID0gX3Bhc3NQcm9qZWN0OwoKICAgICAgICBQYXNzQ29udHJhY3RvciBfY29udHJhY3RvciA9IG5ldyBQYXNzQ29udHJhY3RvcihfY3JlYXRvciwgX3Byb2plY3QsIF9yZWNpcGllbnQsIF9yZXN0b3JlKTsKICAgICAgICBpZiAoIV9tZXRhUHJvamVjdCAmJiBhZGRyZXNzKF9wYXNzUHJvamVjdCkgPT0gMCAmJiAhX3Jlc3RvcmUpIF9wcm9qZWN0LnNldFByb2plY3RNYW5hZ2VyKGFkZHJlc3MoX2NvbnRyYWN0b3IpKTsKICAgICAgICAKICAgICAgICB1aW50IF9jb250cmFjdG9ySUQgPSBjb250cmFjdG9ycy5sZW5ndGgrKzsKICAgICAgICBjb250cmFjdG9yIGMgPSBjb250cmFjdG9yc1tfY29udHJhY3RvcklEXTsKICAgICAgICBjLmNyZWF0b3IgPSBfY3JlYXRvcjsKICAgICAgICBjLmNvbnRyYWN0b3IgPSBfY29udHJhY3RvcjsKICAgICAgICBjLnJlY2lwaWVudCA9IF9yZWNpcGllbnQ7CiAgICAgICAgYy5tZXRhUHJvamVjdCA9IF9tZXRhUHJvamVjdDsKICAgICAgICBjLnBhc3NQcm9qZWN0ID0gX3Bhc3NQcm9qZWN0OwogICAgICAgIGMucHJvamVjdE5hbWUgPSBfcHJvamVjdE5hbWU7CiAgICAgICAgYy5wcm9qZWN0RGVzY3JpcHRpb24gPSBfcHJvamVjdERlc2NyaXB0aW9uOwogICAgICAgIGMuY3JlYXRpb25EYXRlID0gbm93OwoKICAgICAgICBOZXdQYXNzQ29udHJhY3RvcihfY3JlYXRvciwgX3JlY2lwaWVudCwgX3Byb2plY3QsIF9jb250cmFjdG9yKTsKIAogICAgICAgIHJldHVybiBfY29udHJhY3RvcjsKICAgIH0KICAgIAp9CgoKcHJhZ21hIHNvbGlkaXR5IF4wLjQuODsKCi8qCiAqCiAqIFRoaXMgZmlsZSBpcyBwYXJ0IG9mIFBhc3MgREFPLgogKgoKLyoKU21hcnQgY29udHJhY3QgZm9yIGEgRGVjZW50cmFsaXplZCBBdXRvbm9tb3VzIE9yZ2FuaXphdGlvbiAoREFPKQp0byBhdXRvbWF0ZSBvcmdhbml6YXRpb25hbCBnb3Zlcm5hbmNlIGFuZCBkZWNpc2lvbi1tYWtpbmcuCiovCgovLy8gQHRpdGxlIFBhc3MgQ29tbWl0dGVlIFJvb20KY29udHJhY3QgUGFzc0NvbW1pdHRlZVJvb21JbnRlcmZhY2UgewoKICAgIC8vIFRoZSBQYXNzIERhbyBzbWFydCBjb250cmFjdAogICAgUGFzc0RhbyBwdWJsaWMgcGFzc0RhbzsKCiAgICBlbnVtIFByb3Bvc2FsVHlwZXMgeyBjb250cmFjdG9yLCByZXNvbHV0aW9uLCBydWxlcywgdXBncmFkZSB9CgogICAgc3RydWN0IENvbW1pdHRlZSB7ICAgICAgICAKICAgICAgICAvLyBBZGRyZXNzIG9mIHRoZSBjcmVhdG9yIG9mIHRoZSBjb21taXR0ZWUKICAgICAgICBhZGRyZXNzIGNyZWF0b3I7ICAKICAgICAgICAvLyBUaGUgdHlwZSBvZiB0aGUgcHJvcG9zYWwKICAgICAgICBQcm9wb3NhbFR5cGVzIHByb3Bvc2FsVHlwZTsKICAgICAgICAvLyBJbmRleCB0byBpZGVudGlmeSB0aGUgcHJvcG9zYWwKICAgICAgICB1aW50IHByb3Bvc2FsSUQ7CiAgICAgICAgLy8gdW5peCB0aW1lc3RhbXAsIGRlbm90aW5nIHRoZSBlbmQgb2YgdGhlIHNldCBwZXJpb2Qgb2YgYSBwcm9wb3NhbCBiZWZvcmUgdGhlIGNvbW1pdHRlZSAKICAgICAgICB1aW50IHNldERlYWRsaW5lOwogICAgICAgIC8vIEZlZXMgKGluIHdlaSkgcGFpZCBieSB0aGUgY3JlYXRvciBvZiB0aGUgcHJvcG9zYWwKICAgICAgICB1aW50IGZlZXM7CiAgICAgICAgLy8gVG90YWwgb2YgZmVlcyAoaW4gd2VpKSByZXdhcmRlZCB0byB0aGUgdm90ZXJzCiAgICAgICAgdWludCB0b3RhbFJld2FyZGVkQW1vdW50OwogICAgICAgIC8vIEEgdW5peCB0aW1lc3RhbXAsIGRlbm90aW5nIHRoZSBlbmQgb2YgdGhlIHZvdGluZyBwZXJpb2QKICAgICAgICB1aW50IHZvdGluZ0RlYWRsaW5lOwogICAgICAgIC8vIFRydWUgaWYgdGhlIHByb3Bvc2FsJ3Mgdm90ZXMgaGF2ZSB5ZXQgdG8gYmUgY291bnRlZCwgb3RoZXJ3aXNlIEZhbHNlCiAgICAgICAgYm9vbCBvcGVuOyAKICAgICAgICAvLyBBIHVuaXggdGltZXN0YW1wLCBkZW5vdGluZyB0aGUgZGF0ZSBvZiB0aGUgZXhlY3V0aW9uIG9mIHRoZSBhcHByb3ZlZCBwcm9wb3NhbAogICAgICAgIHVpbnQgZGF0ZU9mRXhlY3V0aW9uOwogICAgICAgIC8vIE51bWJlciBvZiBzaGFyZXMgaW4gZmF2b3Igb2YgdGhlIHByb3Bvc2FsCiAgICAgICAgdWludCB5ZWE7IAogICAgICAgIC8vIE51bWJlciBvZiBzaGFyZXMgb3Bwb3NlZCB0byB0aGUgcHJvcG9zYWwKICAgICAgICB1aW50IG5heTsgCiAgICB9CiAgICAvLyBDb21taXR0ZWVzIG9yZ2FuaXplZCB0byB2b3RlIGZvciBvciBhZ2FpbnN0IGEgcHJvcG9zYWwKICAgIENvbW1pdHRlZVtdIHB1YmxpYyBDb21taXR0ZWVzOyAKICAgIC8vIG1hcHBpbmcgdG8gaW5kaWNhdGUgaWYgYSBzaGFyZWhvbGRlciBoYXMgdm90ZWQgYXQgYSBjb21taXR0ZWUgb3Igbm90CiAgICBtYXBwaW5nICh1aW50ID0+IG1hcHBpbmcgKGFkZHJlc3MgPT4gYm9vbCkpIGhhc1ZvdGVkOwoKICAgIHN0cnVjdCBQcm9wb3NhbCB7CiAgICAgICAgLy8gSW5kZXggdG8gaWRlbnRpZnkgdGhlIGNvbW1pdHRlZQogICAgICAgIHVpbnQgY29tbWl0dGVlSUQ7CiAgICAgICAgLy8gVGhlIGNvbnRyYWN0b3Igc21hcnQgY29udHJhY3QgKG5vdCBtYW5kYXRvcnkgaWYgZnVuZGluZykKICAgICAgICBQYXNzQ29udHJhY3RvciBjb250cmFjdG9yOwogICAgICAgIC8vIFRoZSBpbmRleCBvZiB0aGUgY29udHJhY3RvciBwcm9wb3NhbCBpbiB0aGUgY29udHJhY3RvciBjb250cmFjdCAobm90IG1hbmRhdG9yeSBpZiBmdW5kaW5nKQogICAgICAgIHVpbnQgY29udHJhY3RvclByb3Bvc2FsSUQ7CiAgICAgICAgLy8gVGhlIGFtb3VudCBvZiB0aGUgcHJvcG9zYWwgZnJvbSB0aGUgc2hhcmUgbWFuYWdlciBiYWxhbmNlIChmb3IgZnVuZGluZyBvciBjb250cmFjdG9yIHByb3Bvc2FscykKICAgICAgICB1aW50IGFtb3VudDsKICAgICAgICAvLyBUaGUgYWRkcmVzcyB3aGljaCBzZXRzIHBhcnRuZXJzIGFuZCBtYW5hZ2VzIHRoZSBmdW5kaW5nIChub3QgbWFuZGF0b3J5KQogICAgICAgIGFkZHJlc3MgbW9kZXJhdG9yOwogICAgICAgIC8vIEFtb3VudCBmcm9tIHRoZSBzYWxlIG9mIHNoYXJlcyAoZm9yIGZ1bmRpbmcgb3IgY29udHJhY3RvciBwcm9wb3NhbHMpCiAgICAgICAgdWludCBhbW91bnRGb3JTaGFyZXM7CiAgICAgICAgLy8gVGhlIGluaXRpYWwgcHJpY2UgbXVsdGlwbGllciBvZiBEYW8gc2hhcmVzIGF0IHRoZSBiZWdpbm5pbmcgb2YgdGhlIGZ1bmRpbmcgKG5vdCBtYW5kYXRvcnkpCiAgICAgICAgdWludCBpbml0aWFsU2hhcmVQcmljZU11bHRpcGxpZXI7IAogICAgICAgIC8vIEFtb3VudCBmcm9tIHRoZSBzYWxlIG9mIHRva2VucyAoZm9yIHByb2plY3QgbWFuYWdlciBwcm9wb3NhbHMpCiAgICAgICAgdWludCBhbW91bnRGb3JUb2tlbnM7CiAgICAgICAgLy8gQSB1bml4IHRpbWVzdGFtcCwgZGVub3RpbmcgdGhlIHN0YXJ0IHRpbWUgb2YgdGhlIGZ1bmRpbmcKICAgICAgICB1aW50IG1pbnV0ZXNGdW5kaW5nUGVyaW9kOwogICAgICAgIC8vIFRydWUgaWYgdGhlIHByb3Bvc2FsIGlzIGNsb3NlZAogICAgICAgIGJvb2wgb3BlbjsgCiAgICB9CiAgICAvLyBQcm9wb3NhbHMgdG8gcGF5IGEgY29udHJhY3RvciBvci9hbmQgZnVuZCB0aGUgRGFvCiAgICBQcm9wb3NhbFtdIHB1YmxpYyBQcm9wb3NhbHM7CgogICAgc3RydWN0IFF1ZXN0aW9uIHsKICAgICAgICAvLyBJbmRleCB0byBpZGVudGlmeSBhIGNvbW1pdHRlZQogICAgICAgIHVpbnQgY29tbWl0dGVlSUQ7IAogICAgICAgIC8vIFRoZSBwcm9qZWN0IHNtYXJ0IGNvbnRyYWN0CiAgICAgICAgUGFzc1Byb2plY3QgcHJvamVjdDsKICAgICAgICAvLyBUaGUgbmFtZSBvZiB0aGUgcXVlc3Rpb24gZm9yIGRpc3BsYXkgcHVycG9zZQogICAgICAgIHN0cmluZyBuYW1lOwogICAgICAgIC8vIEEgZGVzY3JpcHRpb24gb2YgdGhlIHF1ZXN0aW9uCiAgICAgICAgc3RyaW5nIGRlc2NyaXB0aW9uOwogICAgfQogICAgLy8gUXVlc3Rpb25zIHN1Ym1pdHRlZCB0byBhIHZvdGUgYnkgdGhlIHNoYXJlaG9sZGVycyAKICAgIFF1ZXN0aW9uW10gcHVibGljIFJlc29sdXRpb25Qcm9wb3NhbHM7CiAgICAKICAgIHN0cnVjdCBSdWxlcyB7CiAgICAgICAgLy8gSW5kZXggdG8gaWRlbnRpZnkgYSBjb21taXR0ZWUKICAgICAgICB1aW50IGNvbW1pdHRlZUlEOyAKICAgICAgICAvLyBUaGUgcXVvcnVtIG5lZWRlZCBmb3IgZWFjaCBwcm9wb3NhbCBpcyBjYWxjdWxhdGVkIGJ5IHRvdGFsU3VwcGx5IC8gbWluUXVvcnVtRGl2aXNvcgogICAgICAgIHVpbnQgbWluUXVvcnVtRGl2aXNvcjsgIAogICAgICAgIC8vIE1pbmltdW0gZmVlcyAoaW4gd2VpKSB0byBjcmVhdGUgYSBwcm9wb3NhbAogICAgICAgIHVpbnQgbWluQ29tbWl0dGVlRmVlczsgCiAgICAgICAgLy8gTWluaW11bSBwZXJjZW50YWdlIG9mIHZvdGVzIGZvciBhIHByb3Bvc2FsIHRvIHJld2FyZCB0aGUgY3JlYXRvcgogICAgICAgIHVpbnQgbWluUGVyY2VudGFnZU9mTGlrZXM7CiAgICAgICAgLy8gUGVyaW9kIGluIG1pbnV0ZXMgdG8gY29uc2lkZXIgb3Igc2V0IGEgcHJvcG9zYWwgYmVmb3JlIHRoZSB2b3RpbmcgcHJvY2VkdXJlCiAgICAgICAgdWludCBtaW51dGVzU2V0UHJvcG9zYWxQZXJpb2Q7IAogICAgICAgIC8vIFRoZSBtaW5pbXVtIGRlYmF0ZSBwZXJpb2QgaW4gbWludXRlcyB0aGF0IGEgZ2VuZXJpYyBwcm9wb3NhbCBjYW4gaGF2ZQogICAgICAgIHVpbnQgbWluTWludXRlc0RlYmF0ZVBlcmlvZDsKICAgICAgICAvLyBUaGUgaW5mbGF0aW9uIHJhdGUgdG8gY2FsY3VsYXRlIHRoZSByZXdhcmQgb2YgZmVlcyB0byB2b3RlcnMKICAgICAgICB1aW50IGZlZXNSZXdhcmRJbmZsYXRpb25SYXRlOwogICAgICAgIC8vIFRoZSBpbmZsYXRpb24gcmF0ZSB0byBjYWxjdWxhdGUgdGhlIHRva2VuIHByaWNlIChmb3IgcHJvamVjdCBtYW5hZ2VyIHByb3Bvc2FscykgCiAgICAgICAgdWludCB0b2tlblByaWNlSW5mbGF0aW9uUmF0ZTsKICAgICAgICAvLyBUaGUgZGVmYXVsdCBtaW51dGVzIGZ1bmRpbmcgcGVyaW9kCiAgICAgICAgdWludCBkZWZhdWx0TWludXRlc0Z1bmRpbmdQZXJpb2Q7CiAgICB9IAogICAgLy8gUHJvcG9zYWxzIHRvIHVwZGF0ZSB0aGUgY29tbWl0dGVlIHJ1bGVzCiAgICBSdWxlc1tdIHB1YmxpYyBydWxlc1Byb3Bvc2FsczsKCiAgICBzdHJ1Y3QgVXBncmFkZSB7CiAgICAgICAgLy8gSW5kZXggdG8gaWRlbnRpZnkgYSBjb21taXR0ZWUKICAgICAgICB1aW50IGNvbW1pdHRlZUlEOyAKICAgICAgICAvLyBBZGRyZXNzIG9mIHRoZSBwcm9wb3NlZCBDb21taXR0ZWUgUm9vbSBzbWFydCBjb250cmFjdAogICAgICAgIGFkZHJlc3MgbmV3Q29tbWl0dGVlUm9vbTsKICAgICAgICAvLyBBZGRyZXNzIG9mIHRoZSBwcm9wb3NlZCBzaGFyZSBtYW5hZ2VyIHNtYXJ0IGNvbnRyYWN0CiAgICAgICAgYWRkcmVzcyBuZXdTaGFyZU1hbmFnZXI7CiAgICAgICAgLy8gQWRkcmVzcyBvZiB0aGUgcHJvcG9zZWQgdG9rZW4gbWFuYWdlciBzbWFydCBjb250cmFjdAogICAgICAgIGFkZHJlc3MgbmV3VG9rZW5NYW5hZ2VyOwogICAgfQogICAgLy8gUHJvcG9zYWxzIHRvIHVwZ3JhZGUKICAgIFVwZ3JhZGVbXSBwdWJsaWMgVXBncmFkZVByb3Bvc2FsczsKICAgIAogICAgLy8gVGhlIG1pbmltdW0gcGVyaW9kcyBpbiBtaW51dGVzIAogICAgdWludCBtaW5NaW51dGVzUGVyaW9kczsKICAgIC8vIFRoZSBtYXhpbXVtIGluZmxhdGlvbiByYXRlIGZvciB0b2tlbiBwcmljZSBvciByZXdhcmRzIHRvIHZvdGVycwogICAgdWludCBtYXhJbmZsYXRpb25SYXRlOwogICAgCiAgICAvLy8gQHJldHVybiB0aGUgZWZmZWN0aXZlIHNoYXJlIG1hbmFnZXIKICAgIGZ1bmN0aW9uIFNoYXJlTWFuYWdlcigpIGNvbnN0YW50IHJldHVybnMgKFBhc3NNYW5hZ2VyKTsKCiAgICAvLy8gQHJldHVybiB0aGUgZWZmZWN0aXZlIHRva2VuIG1hbmFnZXIKICAgIGZ1bmN0aW9uIFRva2VuTWFuYWdlcigpIGNvbnN0YW50IHJldHVybnMgKFBhc3NNYW5hZ2VyKTsKCiAgICAvLy8gcmV0dXJuIHRoZSBiYWxhbmNlIG9mIHRoZSBEQU8KICAgIGZ1bmN0aW9uIEJhbGFuY2UoKSBjb25zdGFudCByZXR1cm5zICh1aW50KTsKICAgIAogICAgLy8vIEBwYXJhbSBfY29tbWl0dGVlSUQgVGhlIGluZGV4IG9mIHRoZSBjb21taXR0ZWUKICAgIC8vLyBAcGFyYW0gX3NoYXJlSG9sZGVyIFRoZSBzaGFyZWhvbGRlciAobm90IG1hbmRhdG9yeSwgZGVmYXVsdCA6IG1zZy5zZW5kZXIpCiAgICAvLy8gQHJldHVybiB0cnVlIGlmIHRoZSBzaGFyZWhvbGRlciBoYXMgdm90ZWQgYXQgdGhlIGNvbW1pdHRlZQogICAgZnVuY3Rpb24gSGFzVm90ZWQoCiAgICAgICAgdWludCBfY29tbWl0dGVlSUQsIAogICAgICAgIGFkZHJlc3MgX3NoYXJlSG9sZGVyKSBjb25zdGFudCBleHRlcm5hbCByZXR1cm5zIChib29sKTsKICAgIAogICAgLy8vIEByZXR1cm4gVGhlIG1pbmltdW0gcXVvcnVtIGZvciBwcm9wb3NhbHMgdG8gcGFzcyAKICAgIGZ1bmN0aW9uIG1pblF1b3J1bSgpIGNvbnN0YW50IHJldHVybnMgKHVpbnQpOwoKICAgIC8vLyBAcmV0dXJuIFRoZSBudW1iZXIgb2YgY29tbWl0dGVlcyAKICAgIGZ1bmN0aW9uIG51bWJlck9mQ29tbWl0dGVlcygpIGNvbnN0YW50IHJldHVybnMgKHVpbnQpOwogICAgCiAgICAvLy8gQGRldiBUaGUgY29uc3RydWN0b3IgZnVuY3Rpb24KICAgIC8vLyBAcGFyYW0gX3Bhc3NEYW8gQWRkcmVzcyBvZiBQYXNzIERhbwogICAgLy9mdW5jdGlvbiBQYXNzQ29tbWl0dGVlUm9vbShhZGRyZXNzIF9wYXNzRGFvKTsKCiAgICAvLy8gQG5vdGljZSBGdW5jdGlvbiB0byBpbml0IGFuIHNldCB0aGUgY29tbWl0dGVlIHJ1bGVzCiAgICAvLy8gQHBhcmFtIF9tYXhJbmZsYXRpb25SYXRlIFRoZSBtYXhpbXVtIGluZmxhdGlvbiByYXRlIGZvciBjb250cmFjdG9yIGFuZCBmdW5kaW5nIHByb3Bvc2FscwogICAgLy8vIEBwYXJhbSBfbWluTWludXRlc1BlcmlvZHMgVGhlIG1pbmltdW0gcGVyaW9kcyBpbiBtaW51dGVzCiAgICAvLy8gQHBhcmFtIF9taW5RdW9ydW1EaXZpc29yIFRoZSBpbml0aWFsIG1pbmltdW0gcXVvcnVtIGRpdmlzb3IgZm9yIHRoZSBwcm9wb3NhbHMKICAgIC8vLyBAcGFyYW0gX21pbkNvbW1pdHRlZUZlZXMgVGhlIG1pbmltdW0gYW1vdW50IChpbiB3ZWkpIHRvIG1ha2UgYSBwcm9wb3NhbAogICAgLy8vIEBwYXJhbSBfbWluUGVyY2VudGFnZU9mTGlrZXMgTWluaW11bSBwZXJjZW50YWdlIG9mIHZvdGVzIGZvciBhIHByb3Bvc2FsIHRvIHJld2FyZCB0aGUgY3JlYXRvcgogICAgLy8vIEBwYXJhbSBfbWludXRlc1NldFByb3Bvc2FsUGVyaW9kIFRoZSBtaW5pbXVtIHBlcmlvZCBpbiBtaW51dGVzIGJlZm9yZSBhIGNvbW1pdHRlZQogICAgLy8vIEBwYXJhbSBfbWluTWludXRlc0RlYmF0ZVBlcmlvZCBUaGUgbWluaW11bSBwZXJpb2QgaW4gbWludXRlcyBvZiB0aGUgYm9hcmQgbWVldGluZ3MKICAgIC8vLyBAcGFyYW0gX2ZlZXNSZXdhcmRJbmZsYXRpb25SYXRlIFRoZSBpbmZsYXRpb24gcmF0ZSB0byBjYWxjdWxhdGUgdGhlIHJld2FyZCBvZiBmZWVzIHRvIHZvdGVycyBkdXJpbmcgYSBjb21taXR0ZWUKICAgIC8vLyBAcGFyYW0gX3Rva2VuUHJpY2VJbmZsYXRpb25SYXRlIFRoZSBpbmZsYXRpb24gcmF0ZSB0byBjYWxjdWxhdGUgdGhlIHRva2VuIHByaWNlIGZvciBwcm9qZWN0IG1hbmFnZXIgcHJvcG9zYWxzCiAgICAvLy8gQHBhcmFtIF9kZWZhdWx0TWludXRlc0Z1bmRpbmdQZXJpb2QgRGVmYXVsdCBwZXJpb2QgaW4gbWludXRlcyBvZiB0aGUgZnVuZGluZwogICAgZnVuY3Rpb24gaW5pdCgKICAgICAgICB1aW50IF9tYXhJbmZsYXRpb25SYXRlLAogICAgICAgIHVpbnQgX21pbk1pbnV0ZXNQZXJpb2RzLAogICAgICAgIHVpbnQgX21pblF1b3J1bURpdmlzb3IsCiAgICAgICAgdWludCBfbWluQ29tbWl0dGVlRmVlcywKICAgICAgICB1aW50IF9taW5QZXJjZW50YWdlT2ZMaWtlcywKICAgICAgICB1aW50IF9taW51dGVzU2V0UHJvcG9zYWxQZXJpb2QsCiAgICAgICAgdWludCBfbWluTWludXRlc0RlYmF0ZVBlcmlvZCwKICAgICAgICB1aW50IF9mZWVzUmV3YXJkSW5mbGF0aW9uUmF0ZSwKICAgICAgICB1aW50IF90b2tlblByaWNlSW5mbGF0aW9uUmF0ZSwKICAgICAgICB1aW50IF9kZWZhdWx0TWludXRlc0Z1bmRpbmdQZXJpb2QpOwoKICAgIC8vLyBAbm90aWNlIEZ1bmN0aW9uIHRvIGNyZWF0ZSBhIGNvbnRyYWN0b3Igc21hcnQgY29udHJhY3QKICAgIC8vLyBAcGFyYW0gX2NvbnRyYWN0b3JDcmVhdG9yIFRoZSBjb250cmFjdG9yIGNyZWF0b3Igc21hcnQgY29udHJhY3QKICAgIC8vLyBAcGFyYW0gX3JlY2lwaWVudCBUaGUgcmVjaXBpZW50IG9mIHRoZSBjb250cmFjdG9yIHNtYXJ0IGNvbnRyYWN0CiAgICAvLy8gQHBhcmFtIF9tZXRhUHJvamVjdCBUcnVlIGlmIG1ldGEgcHJvamVjdAogICAgLy8vIEBwYXJhbSBfcGFzc1Byb2plY3QgVGhlIHByb2plY3Qgc21hcnQgY29udHJhY3QgKG5vdCBtYW5kYXRvcnkpCiAgICAvLy8gQHBhcmFtIF9wcm9qZWN0TmFtZSBUaGUgbmFtZSBvZiB0aGUgcHJvamVjdCAoaWYgdGhlIHByb2plY3Qgc21hcnQgY29udHJhY3QgZG9lc24ndCBleGlzdCkKICAgIC8vLyBAcGFyYW0gX3Byb2plY3REZXNjcmlwdGlvbiBBIGRlc2NyaXB0aW9uIG9mIHRoZSBwcm9qZWN0IChub3QgbWFuZGF0b3J5LCBjYW4gYmUgdXBkYXRlZCBhZnRlcikKICAgIC8vLyBAcmV0dXJuIFRoZSBjb250cmFjdG9yIHNtYXJ0IGNvbnRyYWN0CiAgICBmdW5jdGlvbiBjcmVhdGVDb250cmFjdG9yKAogICAgICAgIFBhc3NDb250cmFjdG9yQ3JlYXRvciBfY29udHJhY3RvckNyZWF0b3IsCiAgICAgICAgYWRkcmVzcyBfcmVjaXBpZW50LAogICAgICAgIGJvb2wgX21ldGFQcm9qZWN0LAogICAgICAgIFBhc3NQcm9qZWN0IF9wYXNzUHJvamVjdCwKICAgICAgICBzdHJpbmcgX3Byb2plY3ROYW1lLCAKICAgICAgICBzdHJpbmcgX3Byb2plY3REZXNjcmlwdGlvbikgcmV0dXJucyAoUGFzc0NvbnRyYWN0b3IpOwogICAgCiAgICAvLy8gQG5vdGljZSBGdW5jdGlvbiB0byBtYWtlIGEgcHJvcG9zYWwgdG8gcGF5IGEgY29udHJhY3RvciBvci9hbmQgZnVuZCB0aGUgRGFvCiAgICAvLy8gQHBhcmFtIF9hbW91bnQgQW1vdW50IG9mIHRoZSBwcm9wb3NhbAogICAgLy8vIEBwYXJhbSBfY29udHJhY3RvciBUaGUgY29udHJhY3RvciBzbWFydCBjb250cmFjdAogICAgLy8vIEBwYXJhbSBfY29udHJhY3RvclByb3Bvc2FsSUQgSW5kZXggb2YgdGhlIGNvbnRyYWN0b3IgcHJvcG9zYWwgaW4gdGhlIGNvbnRyYWN0b3Igc21hcnQgY29udHJhY3QgKG5vdCBtYW5kYXRvcnkpCiAgICAvLy8gQHBhcmFtIF9wcm9wb3NhbERlc2NyaXB0aW9uIFN0cmluZyBkZXNjcmliaW5nIHRoZSBwcm9wb3NhbCAoaWYgbm90IGV4aXN0aW5nIHByb3Bvc2FsKQogICAgLy8vIEBwYXJhbSBfaGFzaE9mVGhlQ29udHJhY3RvclByb3Bvc2FsRG9jdW1lbnQgVGhlIGhhc2ggb2YgdGhlIENvbnRyYWN0b3IgcHJvcG9zYWwgZG9jdW1lbnQgKGlmIG5vdCBleGlzdGluZyBwcm9wb3NhbCkKICAgIC8vLyBAcGFyYW0gX21vZGVyYXRvciBUaGUgYWRkcmVzcyB3aGljaCBzZXRzIHBhcnRuZXJzIGFuZCBtYW5hZ2UgdGhlIGZ1bmRpbmcgKG5vdCBtYW5kYXRvcnkpCiAgICAvLy8gQHBhcmFtIF9pbml0aWFsU2hhcmVQcmljZU11bHRpcGxpZXIgVGhlIGluaXRpYWwgcHJpY2UgbXVsdGlwbGllciBvZiBzaGFyZXMgKGZvciBmdW5kaW5nIG9yIGNvbnRyYWN0b3IgcHJvcG9zYWxzKQogICAgLy8vIEBwYXJhbSBfbWludXRlc0Z1bmRpbmdQZXJpb2QgUGVyaW9kIGluIG1pbnV0ZXMgb2YgdGhlIGZ1bmRpbmcgKG5vdCBtYW5kYXRvcnkpCiAgICAvLy8gQHBhcmFtIF9taW51dGVzRGViYXRpbmdQZXJpb2QgUGVyaW9kIGluIG1pbnV0ZXMgb2YgdGhlIGJvYXJkIG1lZXRpbmcgdG8gdm90ZSBvbiB0aGUgcHJvcG9zYWwgKG5vdCBtYW5kYXRvcnkpCiAgICAvLy8gQHJldHVybiBUaGUgaW5kZXggb2YgdGhlIHByb3Bvc2FsCiAgICBmdW5jdGlvbiBjb250cmFjdG9yUHJvcG9zYWwoCiAgICAgICAgdWludCBfYW1vdW50LAogICAgICAgIFBhc3NDb250cmFjdG9yIF9jb250cmFjdG9yLAogICAgICAgIHVpbnQgX2NvbnRyYWN0b3JQcm9wb3NhbElELAogICAgICAgIHN0cmluZyBfcHJvcG9zYWxEZXNjcmlwdGlvbiwgCiAgICAgICAgYnl0ZXMzMiBfaGFzaE9mVGhlQ29udHJhY3RvclByb3Bvc2FsRG9jdW1lbnQsCiAgICAgICAgYWRkcmVzcyBfbW9kZXJhdG9yLAogICAgICAgIHVpbnQgX2luaXRpYWxTaGFyZVByaWNlTXVsdGlwbGllciwgCiAgICAgICAgdWludCBfbWludXRlc0Z1bmRpbmdQZXJpb2QsCiAgICAgICAgdWludCBfbWludXRlc0RlYmF0aW5nUGVyaW9kKSBwYXlhYmxlIHJldHVybnMgKHVpbnQpOwoKICAgIC8vLyBAbm90aWNlIEZ1bmN0aW9uIHRvIHN1Ym1pdCBhIHF1ZXN0aW9uCiAgICAvLy8gQHBhcmFtIF9uYW1lIE5hbWUgb2YgdGhlIHF1ZXN0aW9uIGZvciBkaXNwbGF5IHB1cnBvc2UKICAgIC8vLyBAcGFyYW0gX2Rlc2NyaXB0aW9uIEEgZGVzY3JpcHRpb24gb2YgdGhlIHF1ZXN0aW9uCiAgICAvLy8gQHBhcmFtIF9wcm9qZWN0IFRoZSBwcm9qZWN0IHNtYXJ0IGNvbnRyYWN0CiAgICAvLy8gQHBhcmFtIF9taW51dGVzRGViYXRpbmdQZXJpb2QgUGVyaW9kIGluIG1pbnV0ZXMgb2YgdGhlIGJvYXJkIG1lZXRpbmcgdG8gdm90ZSBvbiB0aGUgcHJvcG9zYWwKICAgIC8vLyBAcmV0dXJuIFRoZSBpbmRleCBvZiB0aGUgcHJvcG9zYWwKICAgIGZ1bmN0aW9uIHJlc29sdXRpb25Qcm9wb3NhbCgKICAgICAgICBzdHJpbmcgX25hbWUsCiAgICAgICAgc3RyaW5nIF9kZXNjcmlwdGlvbiwKICAgICAgICBQYXNzUHJvamVjdCBfcHJvamVjdCwKICAgICAgICB1aW50IF9taW51dGVzRGViYXRpbmdQZXJpb2QpIHBheWFibGUgcmV0dXJucyAodWludCk7CiAgICAgICAgCiAgICAvLy8gQG5vdGljZSBGdW5jdGlvbiB0byBtYWtlIGEgcHJvcG9zYWwgdG8gY2hhbmdlIHRoZSBydWxlcyBvZiB0aGUgY29tbWl0dGVlIHJvb20gCiAgICAvLy8gQHBhcmFtIF9taW5RdW9ydW1EaXZpc29yIElmIDUsIHRoZSBtaW5pbXVtIHF1b3J1bSBpcyAyMCUKICAgIC8vLyBAcGFyYW0gX21pbkNvbW1pdHRlZUZlZXMgVGhlIG1pbmltdW0gYW1vdW50IChpbiB3ZWkpIHRvIG1ha2UgYSBwcm9wb3NhbAogICAgLy8vIEBwYXJhbSBfbWluUGVyY2VudGFnZU9mTGlrZXMgTWluaW11bSBwZXJjZW50YWdlIG9mIHZvdGVzIGZvciBhIHByb3Bvc2FsIHRvIHJld2FyZCB0aGUgY3JlYXRvcgogICAgLy8vIEBwYXJhbSBfbWludXRlc1NldFByb3Bvc2FsUGVyaW9kIE1pbmltdW0gcGVyaW9kIGluIG1pbnV0ZXMgYmVmb3JlIGEgY29tbWl0dGVlCiAgICAvLy8gQHBhcmFtIF9taW5NaW51dGVzRGViYXRlUGVyaW9kIFRoZSBtaW5pbXVtIHBlcmlvZCBpbiBtaW51dGVzIG9mIHRoZSBjb21taXR0ZWVzCiAgICAvLy8gQHBhcmFtIF9mZWVzUmV3YXJkSW5mbGF0aW9uUmF0ZSBUaGUgaW5mbGF0aW9uIHJhdGUgdG8gY2FsY3VsYXRlIHRoZSByZXdhcmQgb2YgZmVlcyB0byB2b3RlcnMgZHVyaW5nIGEgY29tbWl0dGVlCiAgICAvLy8gQHBhcmFtIF9kZWZhdWx0TWludXRlc0Z1bmRpbmdQZXJpb2QgUGVyaW9kIGluIG1pbnV0ZXMgb2YgdGhlIGZ1bmRpbmcKICAgIC8vLyBAcGFyYW0gX3Rva2VuUHJpY2VJbmZsYXRpb25SYXRlIFRoZSBpbmZsYXRpb24gcmF0ZSB0byBjYWxjdWxhdGUgdGhlIHRva2VuIHByaWNlIGZvciBwcm9qZWN0IG1hbmFnZXIgcHJvcG9zYWxzCiAgICAvLy8gQHJldHVybiBUaGUgaW5kZXggb2YgdGhlIHByb3Bvc2FsCiAgICBmdW5jdGlvbiBydWxlc1Byb3Bvc2FsKAogICAgICAgIHVpbnQgX21pblF1b3J1bURpdmlzb3IsIAogICAgICAgIHVpbnQgX21pbkNvbW1pdHRlZUZlZXMsCiAgICAgICAgdWludCBfbWluUGVyY2VudGFnZU9mTGlrZXMsCiAgICAgICAgdWludCBfbWludXRlc1NldFByb3Bvc2FsUGVyaW9kLAogICAgICAgIHVpbnQgX21pbk1pbnV0ZXNEZWJhdGVQZXJpb2QsCiAgICAgICAgdWludCBfZmVlc1Jld2FyZEluZmxhdGlvblJhdGUsCiAgICAgICAgdWludCBfZGVmYXVsdE1pbnV0ZXNGdW5kaW5nUGVyaW9kLAogICAgICAgIHVpbnQgX3Rva2VuUHJpY2VJbmZsYXRpb25SYXRlKSBwYXlhYmxlIHJldHVybnMgKHVpbnQpOwogICAgCiAgICAvLy8gQG5vdGljZSBGdW5jdGlvbiB0byBtYWtlIGEgcHJvcG9zYWwgdG8gdXBncmFkZSB0aGUgYXBwbGljYXRpb24KICAgIC8vLyBAcGFyYW0gX25ld0NvbW1pdHRlZVJvb20gQWRkcmVzcyBvZiBhIG5ldyBDb21taXR0ZWUgUm9vbSBzbWFydCBjb250cmFjdCAobm90IG1hbmRhdG9yeSkgICAKICAgIC8vLyBAcGFyYW0gX25ld1NoYXJlTWFuYWdlciBBZGRyZXNzIG9mIGEgbmV3IHNoYXJlIG1hbmFnZXIgc21hcnQgY29udHJhY3QgKG5vdCBtYW5kYXRvcnkpCiAgICAvLy8gQHBhcmFtIF9uZXdUb2tlbk1hbmFnZXIgQWRkcmVzcyBvZiBhIG5ldyB0b2tlbiBtYW5hZ2VyIHNtYXJ0IGNvbnRyYWN0IChub3QgbWFuZGF0b3J5KQogICAgLy8vIEBwYXJhbSBfbWludXRlc0RlYmF0aW5nUGVyaW9kIFBlcmlvZCBpbiBtaW51dGVzIG9mIHRoZSBjb21taXR0ZWUgdG8gdm90ZSBvbiB0aGUgcHJvcG9zYWwgKG5vdCBtYW5kYXRvcnkpCiAgICAvLy8gQHJldHVybiBUaGUgaW5kZXggb2YgdGhlIHByb3Bvc2FsCiAgICBmdW5jdGlvbiB1cGdyYWRlUHJvcG9zYWwoCiAgICAgICAgYWRkcmVzcyBfbmV3Q29tbWl0dGVlUm9vbSwKICAgICAgICBhZGRyZXNzIF9uZXdTaGFyZU1hbmFnZXIsCiAgICAgICAgYWRkcmVzcyBfbmV3VG9rZW5NYW5hZ2VyLAogICAgICAgIHVpbnQgX21pbnV0ZXNEZWJhdGluZ1BlcmlvZCkgcGF5YWJsZSByZXR1cm5zICh1aW50KTsKCiAgICAvLy8gQGRldiBJbnRlcm5hbCBmdW5jdGlvbiB0byBjcmVhdGUgYSBjb21taXR0ZWUKICAgIC8vLyBAcGFyYW0gX3Byb3Bvc2FsVHlwZSBUaGUgdHlwZSBvZiB0aGUgcHJvcG9zYWwKICAgIC8vLyBAcGFyYW0gX3Byb3Bvc2FsSUQgVGhlIGluZGV4IG9mIHRoZSBwcm9wb3NhbAogICAgLy8vIEBwYXJhbSBfbWludXRlc0RlYmF0aW5nUGVyaW9kIFRoZSBkdXJhdGlvbiBpbiBtaW51dGVzIG9mIHRoZSBjb21taXR0ZWUKICAgIC8vLyBAcmV0dXJuIHRoZSBpbmRleCBvZiB0aGUgYm9hcmQgbWVldGluZwogICAgZnVuY3Rpb24gbmV3Q29tbWl0dGVlKAogICAgICAgIFByb3Bvc2FsVHlwZXMgX3Byb3Bvc2FsVHlwZSwKICAgICAgICB1aW50IF9wcm9wb3NhbElELCAKICAgICAgICB1aW50IF9taW51dGVzRGViYXRpbmdQZXJpb2QpIGludGVybmFsIHJldHVybnMgKHVpbnQpOwogICAgICAgIAogICAgLy8vIEBub3RpY2UgRnVuY3Rpb24gdG8gdm90ZSBmb3Igb3IgYWdhaW5zdCBhIHByb3Bvc2FsIGR1cmluZyBhIGNvbW1pdHRlZQogICAgLy8vIEBwYXJhbSBfY29tbWl0dGVlSUQgVGhlIGluZGV4IG9mIHRoZSBjb21taXR0ZWUKICAgIC8vLyBAcGFyYW0gX3N1cHBvcnRzUHJvcG9zYWwgVHJ1ZSBpZiB0aGUgcHJvcG9zYWwgaXMgc3VwcG9ydGVkCiAgICBmdW5jdGlvbiB2b3RlKAogICAgICAgIHVpbnQgX2NvbW1pdHRlZUlELCAKICAgICAgICBib29sIF9zdXBwb3J0c1Byb3Bvc2FsKTsKICAgIAogICAgLy8vIEBub3RpY2UgRnVuY3Rpb24gdG8gZXhlY3V0ZSBhIGRlY2lzaW9uIGFuZCBjbG9zZSB0aGUgY29tbWl0dGVlCiAgICAvLy8gQHBhcmFtIF9jb21taXR0ZWVJRCBUaGUgaW5kZXggb2YgdGhlIGNvbW1pdHRlZQogICAgLy8vIEByZXR1cm4gV2hldGhlciB0aGUgcHJvcG9zYWwgd2FzIGV4ZWN1dGVkIG9yIG5vdAogICAgZnVuY3Rpb24gZXhlY3V0ZURlY2lzaW9uKHVpbnQgX2NvbW1pdHRlZUlEKSByZXR1cm5zIChib29sKTsKICAgIAogICAgLy8vIEBub3RpY2UgRnVuY3Rpb24gdG8gb3JkZXIgdG8gYSBjb250cmFjdG9yIGFuZCBjbG9zZSBhIGNvbnRyYWN0b3IgcHJvcG9zYWwKICAgIC8vLyBAcGFyYW0gX3Byb3Bvc2FsSUQgVGhlIGluZGV4IG9mIHRoZSBwcm9wb3NhbAogICAgLy8vIEByZXR1cm4gV2hldGhlciB0aGUgcHJvcG9zYWwgd2FzIG9yZGVyZWQgYW5kIHRoZSBwcm9wb3NhbCBhbW91bnQgc2VudCBvciBub3QKICAgIGZ1bmN0aW9uIG9yZGVyVG9Db250cmFjdG9yKHVpbnQgX3Byb3Bvc2FsSUQpIHJldHVybnMgKGJvb2wpOyAgIAoKICAgIC8vLyBAbm90aWNlIEZ1bmN0aW9uIHRvIGJ1eSBzaGFyZXMgYW5kIG9yL2FuZCBwcm9tb3RlIGEgY29udHJhY3RvciBwcm9wb3NhbCAKICAgIC8vLyBAcGFyYW0gX3Byb3Bvc2FsSUQgVGhlIGluZGV4IG9mIHRoZSBwcm9wb3NhbAogICAgLy8vIEByZXR1cm4gV2hldGhlciB0aGUgZnVuY3Rpb24gd2FzIHN1Y2Nlc3NmdWwgb3Igbm90CiAgICBmdW5jdGlvbiBidXlTaGFyZXNGb3JQcm9wb3NhbCh1aW50IF9wcm9wb3NhbElEKSBwYXlhYmxlIHJldHVybnMgKGJvb2wpOwogICAgCiAgICAvLy8gQG5vdGljZSBGdW5jdGlvbiB0byBzZW5kIHRva2VucyBvciByZWZ1bmQgYWZ0ZXIgdGhlIGNsb3NpbmcgdGltZSBvZiB0aGUgZnVuZGluZyBwcm9wb3NhbHMKICAgIC8vLyBAcGFyYW0gX2Zyb20gVGhlIGZpcnN0IHByb3Bvc2FsLiAwIGlmIG5vdCBsaW5rZWQgdG8gYSBwcm9wb3NhbAogICAgLy8vIEBwYXJhbSBfdG8gVGhlIGxhc3QgcHJvcG9zYWwKICAgIC8vLyBAcGFyYW0gX2J1eWVyIFRoZSBhZGRyZXNzIG9mIHRoZSBidXllcgogICAgLy8vIEByZXR1cm4gV2hldGhlciB0aGUgZnVuY3Rpb24gd2FzIHN1Y2Nlc3NmdWwgb3Igbm90IAogICAgZnVuY3Rpb24gc2VuZFBlbmRpbmdBbW91bnRzKCAgICAgICAgCiAgICAgICAgdWludCBfZnJvbSwKICAgICAgICB1aW50IF90bywKICAgICAgICBhZGRyZXNzIF9idXllcikgcmV0dXJucyAoYm9vbCk7CiAgICAgICAgCiAgICAvLy8gQG5vdGljZSBGdW5jdGlvbiB0byByZWNlaXZlIHRva2VucyBvciByZWZ1bmQgYWZ0ZXIgdGhlIGNsb3NpbmcgdGltZSBvZiB0aGUgZnVuZGluZyBwcm9wb3NhbHMKICAgIC8vLyBAcmV0dXJuIFdoZXRoZXIgdGhlIGZ1bmN0aW9uIHdhcyBzdWNjZXNzZnVsIG9yIG5vdAogICAgZnVuY3Rpb24gd2l0aGRyYXdQZW5kaW5nQW1vdW50cygpIHJldHVybnMgKGJvb2wpOwoKICAgIGV2ZW50IENvbW1pdHRlZUxpbWl0cyh1aW50IG1heEluZmxhdGlvblJhdGUsIHVpbnQgbWluTWludXRlc1BlcmlvZHMpOwogICAgCiAgICBldmVudCBDb250cmFjdG9yQ3JlYXRlZChQYXNzQ29udHJhY3RvckNyZWF0b3IgQ3JlYXRvciwgYWRkcmVzcyBpbmRleGVkIFNlbmRlciwgUGFzc0NvbnRyYWN0b3IgQ29udHJhY3RvciwgYWRkcmVzcyBSZWNpcGllbnQpOwoKICAgIGV2ZW50IFByb3Bvc2FsU3VibWl0dGVkKHVpbnQgaW5kZXhlZCBQcm9wb3NhbElELCB1aW50IENvbW1pdHRlZUlELCBQYXNzQ29udHJhY3RvciBpbmRleGVkIENvbnRyYWN0b3IsIHVpbnQgaW5kZXhlZCBDb250cmFjdG9yUHJvcG9zYWxJRCwgCiAgICAgICAgdWludCBBbW91bnQsIHN0cmluZyBEZXNjcmlwdGlvbiwgYWRkcmVzcyBNb2RlcmF0b3IsIHVpbnQgU2hhcmVQcmljZU11bHRpcGxpZXIsIHVpbnQgTWludXRlc0Z1bmRpbmdQZXJpb2QpOwogICAgZXZlbnQgUmVzb2x1dGlvblByb3Bvc2FsU3VibWl0dGVkKHVpbnQgaW5kZXhlZCBRdWVzdGlvbklELCB1aW50IGluZGV4ZWQgQ29tbWl0dGVlSUQsIFBhc3NQcm9qZWN0IGluZGV4ZWQgUHJvamVjdCwgc3RyaW5nIE5hbWUsIHN0cmluZyBEZXNjcmlwdGlvbik7CiAgICBldmVudCBSdWxlc1Byb3Bvc2FsU3VibWl0dGVkKHVpbnQgaW5kZXhlZCBydWxlc1Byb3Bvc2FsSUQsIHVpbnQgQ29tbWl0dGVlSUQsIHVpbnQgTWluUXVvcnVtRGl2aXNvciwgdWludCBNaW5Db21taXR0ZWVGZWVzLCB1aW50IE1pblBlcmNlbnRhZ2VPZkxpa2VzLCAKICAgICAgICB1aW50IE1pbnV0ZXNTZXRQcm9wb3NhbFBlcmlvZCwgdWludCBNaW5NaW51dGVzRGViYXRlUGVyaW9kLCB1aW50IEZlZXNSZXdhcmRJbmZsYXRpb25SYXRlLCB1aW50IERlZmF1bHRNaW51dGVzRnVuZGluZ1BlcmlvZCwgdWludCBUb2tlblByaWNlSW5mbGF0aW9uUmF0ZSk7CiAgICBldmVudCBVcGdyYWRlUHJvcG9zYWxTdWJtaXR0ZWQodWludCBpbmRleGVkIFVwZ3JhZGVQcm9wb3NhbElELCB1aW50IGluZGV4ZWQgQ29tbWl0dGVlSUQsIGFkZHJlc3MgTmV3Q29tbWl0dGVlUm9vbSwgCiAgICAgICAgYWRkcmVzcyBOZXdTaGFyZU1hbmFnZXIsIGFkZHJlc3MgTmV3VG9rZW5NYW5hZ2VyKTsKCiAgICBldmVudCBWb3RlZCh1aW50IGluZGV4ZWQgQ29tbWl0dGVlSUQsIGJvb2wgUG9zaXRpb24sIGFkZHJlc3MgaW5kZXhlZCBWb3RlciwgdWludCBSZXdhcmRlZEFtb3VudCk7CgogICAgZXZlbnQgUHJvcG9zYWxDbG9zZWQodWludCBpbmRleGVkIFByb3Bvc2FsSUQsIFByb3Bvc2FsVHlwZXMgaW5kZXhlZCBQcm9wb3NhbFR5cGUsIHVpbnQgQ29tbWl0dGVlSUQsIAogICAgICAgIHVpbnQgVG90YWxSZXdhcmRlZEFtb3VudCwgYm9vbCBQcm9wb3NhbEV4ZWN1dGVkLCB1aW50IFJld2FyZGVkU2hhcmVzQW1vdW50LCB1aW50IFNlbnRUb01hbmFnZXIpOwogICAgZXZlbnQgQ29udHJhY3RvclByb3Bvc2FsQ2xvc2VkKHVpbnQgaW5kZXhlZCBQcm9wb3NhbElELCB1aW50IGluZGV4ZWQgQ29udHJhY3RvclByb3Bvc2FsSUQsIFBhc3NDb250cmFjdG9yIGluZGV4ZWQgQ29udHJhY3RvciwgdWludCBBbW91bnRTZW50KTsKICAgIGV2ZW50IERhcHBVcGdyYWRlZChhZGRyZXNzIE5ld0NvbW1pdHRlZVJvb20sIGFkZHJlc3MgTmV3U2hhcmVNYW5hZ2VyLCBhZGRyZXNzIE5ld1Rva2VuTWFuYWdlcik7Cgp9Cgpjb250cmFjdCBQYXNzQ29tbWl0dGVlUm9vbSBpcyBQYXNzQ29tbWl0dGVlUm9vbUludGVyZmFjZSB7CgovLyBDb25zdGFudCBmdW5jdGlvbnMKCiAgICBmdW5jdGlvbiBTaGFyZU1hbmFnZXIoKSBjb25zdGFudCByZXR1cm5zIChQYXNzTWFuYWdlcikgewogICAgICAgIHJldHVybiBQYXNzTWFuYWdlcihwYXNzRGFvLkFjdHVhbFNoYXJlTWFuYWdlcigpKTsKICAgIH0KICAgIAogICAgZnVuY3Rpb24gVG9rZW5NYW5hZ2VyKCkgY29uc3RhbnQgcmV0dXJucyAoUGFzc01hbmFnZXIpIHsKICAgICAgICByZXR1cm4gUGFzc01hbmFnZXIocGFzc0Rhby5BY3R1YWxUb2tlbk1hbmFnZXIoKSk7CiAgICB9CiAgICAKICAgIGZ1bmN0aW9uIEJhbGFuY2UoKSBjb25zdGFudCByZXR1cm5zICh1aW50KSB7CiAgICAgICAgcmV0dXJuIHBhc3NEYW8uQWN0dWFsU2hhcmVNYW5hZ2VyKCkuYmFsYW5jZTsKICAgIH0KCiAgICBmdW5jdGlvbiBIYXNWb3RlZCgKICAgICAgICB1aW50IF9jb21taXR0ZWVJRCwgCiAgICAgICAgYWRkcmVzcyBfc2hhcmVIb2xkZXIpIGNvbnN0YW50IGV4dGVybmFsIHJldHVybnMgKGJvb2wpIHsKCiAgICAgICAgaWYgKF9zaGFyZUhvbGRlciA9PSAwKSByZXR1cm4gaGFzVm90ZWRbX2NvbW1pdHRlZUlEXVttc2cuc2VuZGVyXTsKICAgICAgICBlbHNlIHJldHVybiBoYXNWb3RlZFtfY29tbWl0dGVlSURdW19zaGFyZUhvbGRlcl07CiAgICB9CiAgICAKICAgIGZ1bmN0aW9uIG1pblF1b3J1bSgpIGNvbnN0YW50IHJldHVybnMgKHVpbnQpIHsKICAgICAgICByZXR1cm4gKHVpbnQoU2hhcmVNYW5hZ2VyKCkudG90YWxTdXBwbHkoKSkgLyBydWxlc1Byb3Bvc2Fsc1swXS5taW5RdW9ydW1EaXZpc29yKTsKICAgIH0KCiAgICBmdW5jdGlvbiBudW1iZXJPZkNvbW1pdHRlZXMoKSBjb25zdGFudCByZXR1cm5zICh1aW50KSB7CiAgICAgICAgcmV0dXJuIENvbW1pdHRlZXMubGVuZ3RoIC0gMTsKICAgIH0KICAgIAovLyBDb25zdHJ1Y3RvciBhbmQgaW5pdCBmdW5jdGlvbnMKCiAgICBmdW5jdGlvbiBQYXNzQ29tbWl0dGVlUm9vbShhZGRyZXNzIF9wYXNzRGFvKSB7CgogICAgICAgIHBhc3NEYW8gPSBQYXNzRGFvKF9wYXNzRGFvKTsKICAgICAgICBydWxlc1Byb3Bvc2Fscy5sZW5ndGggPSAxOyAKICAgICAgICBDb21taXR0ZWVzLmxlbmd0aCA9IDE7CiAgICAgICAgUHJvcG9zYWxzLmxlbmd0aCA9IDE7CiAgICAgICAgUmVzb2x1dGlvblByb3Bvc2Fscy5sZW5ndGggPSAxOwogICAgICAgIFVwZ3JhZGVQcm9wb3NhbHMubGVuZ3RoID0gMTsKICAgIH0KICAgIAogICAgZnVuY3Rpb24gaW5pdCgKICAgICAgICB1aW50IF9tYXhJbmZsYXRpb25SYXRlLAogICAgICAgIHVpbnQgX21pbk1pbnV0ZXNQZXJpb2RzLAogICAgICAgIHVpbnQgX21pblF1b3J1bURpdmlzb3IsCiAgICAgICAgdWludCBfbWluQ29tbWl0dGVlRmVlcywKICAgICAgICB1aW50IF9taW5QZXJjZW50YWdlT2ZMaWtlcywKICAgICAgICB1aW50IF9taW51dGVzU2V0UHJvcG9zYWxQZXJpb2QsCiAgICAgICAgdWludCBfbWluTWludXRlc0RlYmF0ZVBlcmlvZCwKICAgICAgICB1aW50IF9mZWVzUmV3YXJkSW5mbGF0aW9uUmF0ZSwKICAgICAgICB1aW50IF90b2tlblByaWNlSW5mbGF0aW9uUmF0ZSwKICAgICAgICB1aW50IF9kZWZhdWx0TWludXRlc0Z1bmRpbmdQZXJpb2QpIHsKCiAgICAgICAgbWF4SW5mbGF0aW9uUmF0ZSA9IF9tYXhJbmZsYXRpb25SYXRlOwogICAgICAgIG1pbk1pbnV0ZXNQZXJpb2RzID0gX21pbk1pbnV0ZXNQZXJpb2RzOwogICAgICAgIENvbW1pdHRlZUxpbWl0cyhtYXhJbmZsYXRpb25SYXRlLCBtaW5NaW51dGVzUGVyaW9kcyk7CiAgICAgICAgCiAgICAgICAgaWYgKHJ1bGVzUHJvcG9zYWxzWzBdLm1pblF1b3J1bURpdmlzb3IgIT0gMCkgdGhyb3c7CiAgICAgICAgcnVsZXNQcm9wb3NhbHNbMF0ubWluUXVvcnVtRGl2aXNvciA9IF9taW5RdW9ydW1EaXZpc29yOwogICAgICAgIHJ1bGVzUHJvcG9zYWxzWzBdLm1pbkNvbW1pdHRlZUZlZXMgPSBfbWluQ29tbWl0dGVlRmVlczsKICAgICAgICBydWxlc1Byb3Bvc2Fsc1swXS5taW5QZXJjZW50YWdlT2ZMaWtlcyA9IF9taW5QZXJjZW50YWdlT2ZMaWtlczsKICAgICAgICBydWxlc1Byb3Bvc2Fsc1swXS5taW51dGVzU2V0UHJvcG9zYWxQZXJpb2QgPSBfbWludXRlc1NldFByb3Bvc2FsUGVyaW9kOwogICAgICAgIHJ1bGVzUHJvcG9zYWxzWzBdLm1pbk1pbnV0ZXNEZWJhdGVQZXJpb2QgPSBfbWluTWludXRlc0RlYmF0ZVBlcmlvZDsKICAgICAgICBydWxlc1Byb3Bvc2Fsc1swXS5mZWVzUmV3YXJkSW5mbGF0aW9uUmF0ZSA9IF9mZWVzUmV3YXJkSW5mbGF0aW9uUmF0ZTsKICAgICAgICBydWxlc1Byb3Bvc2Fsc1swXS50b2tlblByaWNlSW5mbGF0aW9uUmF0ZSA9IF90b2tlblByaWNlSW5mbGF0aW9uUmF0ZTsKICAgICAgICBydWxlc1Byb3Bvc2Fsc1swXS5kZWZhdWx0TWludXRlc0Z1bmRpbmdQZXJpb2QgPSBfZGVmYXVsdE1pbnV0ZXNGdW5kaW5nUGVyaW9kOwoKICAgIH0KCi8vIFByb2plY3QgbWFuYWdlciBhbmQgY29udHJhY3RvciBtYW5hZ2VtZW50CgogICAgZnVuY3Rpb24gY3JlYXRlQ29udHJhY3RvcigKICAgICAgICBQYXNzQ29udHJhY3RvckNyZWF0b3IgX2NvbnRyYWN0b3JDcmVhdG9yLAogICAgICAgIGFkZHJlc3MgX3JlY2lwaWVudCwKICAgICAgICBib29sIF9tZXRhUHJvamVjdCwKICAgICAgICBQYXNzUHJvamVjdCBfcGFzc1Byb2plY3QsCiAgICAgICAgc3RyaW5nIF9wcm9qZWN0TmFtZSwgCiAgICAgICAgc3RyaW5nIF9wcm9qZWN0RGVzY3JpcHRpb24pIHJldHVybnMgKFBhc3NDb250cmFjdG9yKSB7CgogICAgICAgIFBhc3NDb250cmFjdG9yIF9jb250cmFjdG9yID0gX2NvbnRyYWN0b3JDcmVhdG9yLmNyZWF0ZUNvbnRyYWN0b3IobXNnLnNlbmRlciwgX3JlY2lwaWVudCwgCiAgICAgICAgICAgIF9tZXRhUHJvamVjdCwgX3Bhc3NQcm9qZWN0LCBfcHJvamVjdE5hbWUsIF9wcm9qZWN0RGVzY3JpcHRpb24sIGZhbHNlKTsKICAgICAgICBDb250cmFjdG9yQ3JlYXRlZChfY29udHJhY3RvckNyZWF0b3IsIG1zZy5zZW5kZXIsIF9jb250cmFjdG9yLCBfcmVjaXBpZW50KTsKICAgICAgICByZXR1cm4gX2NvbnRyYWN0b3I7CiAgICB9ICAgCgovLyBQcm9wb3NhbHMgTWFuYWdlbWVudAoKICAgIGZ1bmN0aW9uIGNvbnRyYWN0b3JQcm9wb3NhbCgKICAgICAgICB1aW50IF9hbW91bnQsCiAgICAgICAgUGFzc0NvbnRyYWN0b3IgX2NvbnRyYWN0b3IsCiAgICAgICAgdWludCBfY29udHJhY3RvclByb3Bvc2FsSUQsCiAgICAgICAgc3RyaW5nIF9wcm9wb3NhbERlc2NyaXB0aW9uLCAKICAgICAgICBieXRlczMyIF9oYXNoT2ZUaGVDb250cmFjdG9yUHJvcG9zYWxEb2N1bWVudCwgICAgICAgIAogICAgICAgIGFkZHJlc3MgX21vZGVyYXRvciwKICAgICAgICB1aW50IF9pbml0aWFsU2hhcmVQcmljZU11bHRpcGxpZXIsIAogICAgICAgIHVpbnQgX21pbnV0ZXNGdW5kaW5nUGVyaW9kLAogICAgICAgIHVpbnQgX21pbnV0ZXNEZWJhdGluZ1BlcmlvZAogICAgKSBwYXlhYmxlIHJldHVybnMgKHVpbnQpIHsKCiAgICAgICAgaWYgKF9taW51dGVzRnVuZGluZ1BlcmlvZCA9PSAwKSBfbWludXRlc0Z1bmRpbmdQZXJpb2QgPSBydWxlc1Byb3Bvc2Fsc1swXS5kZWZhdWx0TWludXRlc0Z1bmRpbmdQZXJpb2Q7CgogICAgICAgIGlmIChhZGRyZXNzKF9jb250cmFjdG9yKSAhPSAwICYmIF9jb250cmFjdG9yUHJvcG9zYWxJRCAhPSAwKSB7CiAgICAgICAgICAgIGlmIChfaGFzaE9mVGhlQ29udHJhY3RvclByb3Bvc2FsRG9jdW1lbnQgIT0gMCAKICAgICAgICAgICAgICAgIHx8IV9jb250cmFjdG9yLnByb3Bvc2FsQ2hlY2tlZChtc2cuc2VuZGVyLCBfY29udHJhY3RvclByb3Bvc2FsSUQsIF9hbW91bnQpKSB0aHJvdzsKICAgICAgICAgICAgZWxzZSBfcHJvcG9zYWxEZXNjcmlwdGlvbiA9ICJQcm9wb3NhbCBjaGVja2VkIjsKICAgICAgICB9CgogICAgICAgIGlmICgoYWRkcmVzcyhfY29udHJhY3RvcikgIT0gMCAmJiBfY29udHJhY3RvclByb3Bvc2FsSUQgPT0gMCAmJiBfaGFzaE9mVGhlQ29udHJhY3RvclByb3Bvc2FsRG9jdW1lbnQgPT0gMCkKICAgICAgICAgICAgfHwgX2Ftb3VudCA9PSAwCiAgICAgICAgICAgIHx8IF9taW51dGVzRnVuZGluZ1BlcmlvZCA8IG1pbk1pbnV0ZXNQZXJpb2RzKSB0aHJvdzsKCiAgICAgICAgdWludCBfcHJvcG9zYWxJRCA9IFByb3Bvc2Fscy5sZW5ndGgrKzsKICAgICAgICBQcm9wb3NhbCBwID0gUHJvcG9zYWxzW19wcm9wb3NhbElEXTsKCiAgICAgICAgcC5jb250cmFjdG9yID0gX2NvbnRyYWN0b3I7CiAgICAgICAgCiAgICAgICAgaWYgKF9jb250cmFjdG9yUHJvcG9zYWxJRCA9PSAwICYmIF9oYXNoT2ZUaGVDb250cmFjdG9yUHJvcG9zYWxEb2N1bWVudCAhPSAwKSB7CiAgICAgICAgICAgIF9jb250cmFjdG9yUHJvcG9zYWxJRCA9IF9jb250cmFjdG9yLm5ld1Byb3Bvc2FsKG1zZy5zZW5kZXIsIF9hbW91bnQsIF9wcm9wb3NhbERlc2NyaXB0aW9uLCBfaGFzaE9mVGhlQ29udHJhY3RvclByb3Bvc2FsRG9jdW1lbnQpOwogICAgICAgIH0KICAgICAgICBwLmNvbnRyYWN0b3JQcm9wb3NhbElEID0gX2NvbnRyYWN0b3JQcm9wb3NhbElEOwoKICAgICAgICBpZiAoYWRkcmVzcyhfY29udHJhY3RvcikgPT0gMCkgcC5hbW91bnRGb3JTaGFyZXMgPSBfYW1vdW50OwogICAgICAgIGVsc2UgewogICAgICAgICAgICBfY29udHJhY3Rvci5zdWJtaXRQcm9wb3NhbChtc2cuc2VuZGVyLCBfY29udHJhY3RvclByb3Bvc2FsSUQsIF9hbW91bnQpOwogICAgICAgICAgICBpZiAoX2NvbnRyYWN0b3IuUHJvamVjdCgpLlByb2plY3RNYW5hZ2VyKCkgPT0gYWRkcmVzcyhfY29udHJhY3RvcikpIHAuYW1vdW50Rm9yVG9rZW5zID0gX2Ftb3VudDsKICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBwLmFtb3VudCA9IEJhbGFuY2UoKTsKICAgICAgICAgICAgICAgIGlmIChfYW1vdW50ID4gcC5hbW91bnQpIHAuYW1vdW50Rm9yU2hhcmVzID0gX2Ftb3VudCAtIHAuYW1vdW50OwogICAgICAgICAgICAgICAgZWxzZSBwLmFtb3VudCA9IF9hbW91bnQ7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgcC5tb2RlcmF0b3IgPSBfbW9kZXJhdG9yOwoKICAgICAgICBwLmluaXRpYWxTaGFyZVByaWNlTXVsdGlwbGllciA9IF9pbml0aWFsU2hhcmVQcmljZU11bHRpcGxpZXI7CgogICAgICAgIHAubWludXRlc0Z1bmRpbmdQZXJpb2QgPSBfbWludXRlc0Z1bmRpbmdQZXJpb2Q7CgogICAgICAgIHAuY29tbWl0dGVlSUQgPSBuZXdDb21taXR0ZWUoUHJvcG9zYWxUeXBlcy5jb250cmFjdG9yLCBfcHJvcG9zYWxJRCwgX21pbnV0ZXNEZWJhdGluZ1BlcmlvZCk7ICAgCgogICAgICAgIHAub3BlbiA9IHRydWU7CiAgICAgICAgCiAgICAgICAgUHJvcG9zYWxTdWJtaXR0ZWQoX3Byb3Bvc2FsSUQsIHAuY29tbWl0dGVlSUQsIHAuY29udHJhY3RvciwgcC5jb250cmFjdG9yUHJvcG9zYWxJRCwgcC5hbW91bnQrcC5hbW91bnRGb3JTaGFyZXMrcC5hbW91bnRGb3JUb2tlbnMsIAogICAgICAgICAgICBfcHJvcG9zYWxEZXNjcmlwdGlvbiwgcC5tb2RlcmF0b3IsIHAuaW5pdGlhbFNoYXJlUHJpY2VNdWx0aXBsaWVyLCBwLm1pbnV0ZXNGdW5kaW5nUGVyaW9kKTsKCiAgICAgICAgcmV0dXJuIF9wcm9wb3NhbElEOwogICAgfQoKICAgIGZ1bmN0aW9uIHJlc29sdXRpb25Qcm9wb3NhbCgKICAgICAgICBzdHJpbmcgX25hbWUsCiAgICAgICAgc3RyaW5nIF9kZXNjcmlwdGlvbiwKICAgICAgICBQYXNzUHJvamVjdCBfcHJvamVjdCwKICAgICAgICB1aW50IF9taW51dGVzRGViYXRpbmdQZXJpb2QpIHBheWFibGUgcmV0dXJucyAodWludCkgewogICAgICAgIAogICAgICAgIGlmIChhZGRyZXNzKF9wcm9qZWN0KSA9PSAwKSBfcHJvamVjdCA9IFBhc3NQcm9qZWN0KHBhc3NEYW8uTWV0YVByb2plY3QoKSk7CiAgICAgICAgCiAgICAgICAgdWludCBfcXVlc3Rpb25JRCA9IFJlc29sdXRpb25Qcm9wb3NhbHMubGVuZ3RoKys7CiAgICAgICAgUXVlc3Rpb24gcSA9IFJlc29sdXRpb25Qcm9wb3NhbHNbX3F1ZXN0aW9uSURdOwogICAgICAgIAogICAgICAgIHEucHJvamVjdCA9IF9wcm9qZWN0OwogICAgICAgIHEubmFtZSA9IF9uYW1lOwogICAgICAgIHEuZGVzY3JpcHRpb24gPSBfZGVzY3JpcHRpb247CiAgICAgICAgCiAgICAgICAgcS5jb21taXR0ZWVJRCA9IG5ld0NvbW1pdHRlZShQcm9wb3NhbFR5cGVzLnJlc29sdXRpb24sIF9xdWVzdGlvbklELCBfbWludXRlc0RlYmF0aW5nUGVyaW9kKTsKICAgICAgICAKICAgICAgICBSZXNvbHV0aW9uUHJvcG9zYWxTdWJtaXR0ZWQoX3F1ZXN0aW9uSUQsIHEuY29tbWl0dGVlSUQsIHEucHJvamVjdCwgcS5uYW1lLCBxLmRlc2NyaXB0aW9uKTsKICAgICAgICAKICAgICAgICByZXR1cm4gX3F1ZXN0aW9uSUQ7CiAgICB9CgogICAgZnVuY3Rpb24gcnVsZXNQcm9wb3NhbCgKICAgICAgICB1aW50IF9taW5RdW9ydW1EaXZpc29yLCAKICAgICAgICB1aW50IF9taW5Db21taXR0ZWVGZWVzLAogICAgICAgIHVpbnQgX21pblBlcmNlbnRhZ2VPZkxpa2VzLAogICAgICAgIHVpbnQgX21pbnV0ZXNTZXRQcm9wb3NhbFBlcmlvZCwKICAgICAgICB1aW50IF9taW5NaW51dGVzRGViYXRlUGVyaW9kLAogICAgICAgIHVpbnQgX2ZlZXNSZXdhcmRJbmZsYXRpb25SYXRlLAogICAgICAgIHVpbnQgX2RlZmF1bHRNaW51dGVzRnVuZGluZ1BlcmlvZCwKICAgICAgICB1aW50IF90b2tlblByaWNlSW5mbGF0aW9uUmF0ZSkgcGF5YWJsZSByZXR1cm5zICh1aW50KSB7CgogICAgCiAgICAgICAgaWYgKF9taW5RdW9ydW1EaXZpc29yIDw9IDEKICAgICAgICAgICAgfHwgX21pblF1b3J1bURpdmlzb3IgPiAxMAogICAgICAgICAgICB8fCBfbWludXRlc1NldFByb3Bvc2FsUGVyaW9kIDwgbWluTWludXRlc1BlcmlvZHMKICAgICAgICAgICAgfHwgX21pbk1pbnV0ZXNEZWJhdGVQZXJpb2QgPCBtaW5NaW51dGVzUGVyaW9kcwogICAgICAgICAgICB8fCBfZmVlc1Jld2FyZEluZmxhdGlvblJhdGUgPiBtYXhJbmZsYXRpb25SYXRlCiAgICAgICAgICAgIHx8IF90b2tlblByaWNlSW5mbGF0aW9uUmF0ZSA+IG1heEluZmxhdGlvblJhdGUKICAgICAgICAgICAgfHwgX2RlZmF1bHRNaW51dGVzRnVuZGluZ1BlcmlvZCA8IG1pbk1pbnV0ZXNQZXJpb2RzKSB0aHJvdzsgCiAgICAgICAgCiAgICAgICAgdWludCBfcnVsZXNQcm9wb3NhbElEID0gcnVsZXNQcm9wb3NhbHMubGVuZ3RoKys7CiAgICAgICAgUnVsZXMgciA9IHJ1bGVzUHJvcG9zYWxzW19ydWxlc1Byb3Bvc2FsSURdOwoKICAgICAgICByLm1pblF1b3J1bURpdmlzb3IgPSBfbWluUXVvcnVtRGl2aXNvcjsKICAgICAgICByLm1pbkNvbW1pdHRlZUZlZXMgPSBfbWluQ29tbWl0dGVlRmVlczsKICAgICAgICByLm1pblBlcmNlbnRhZ2VPZkxpa2VzID0gX21pblBlcmNlbnRhZ2VPZkxpa2VzOwogICAgICAgIHIubWludXRlc1NldFByb3Bvc2FsUGVyaW9kID0gX21pbnV0ZXNTZXRQcm9wb3NhbFBlcmlvZDsKICAgICAgICByLm1pbk1pbnV0ZXNEZWJhdGVQZXJpb2QgPSBfbWluTWludXRlc0RlYmF0ZVBlcmlvZDsKICAgICAgICByLmZlZXNSZXdhcmRJbmZsYXRpb25SYXRlID0gX2ZlZXNSZXdhcmRJbmZsYXRpb25SYXRlOwogICAgICAgIHIuZGVmYXVsdE1pbnV0ZXNGdW5kaW5nUGVyaW9kID0gX2RlZmF1bHRNaW51dGVzRnVuZGluZ1BlcmlvZDsKICAgICAgICByLnRva2VuUHJpY2VJbmZsYXRpb25SYXRlID0gX3Rva2VuUHJpY2VJbmZsYXRpb25SYXRlOwoKICAgICAgICByLmNvbW1pdHRlZUlEID0gbmV3Q29tbWl0dGVlKFByb3Bvc2FsVHlwZXMucnVsZXMsIF9ydWxlc1Byb3Bvc2FsSUQsIDApOwoKICAgICAgICBSdWxlc1Byb3Bvc2FsU3VibWl0dGVkKF9ydWxlc1Byb3Bvc2FsSUQsIHIuY29tbWl0dGVlSUQsIF9taW5RdW9ydW1EaXZpc29yLCBfbWluQ29tbWl0dGVlRmVlcywgCiAgICAgICAgICAgIF9taW5QZXJjZW50YWdlT2ZMaWtlcywgX21pbnV0ZXNTZXRQcm9wb3NhbFBlcmlvZCwgX21pbk1pbnV0ZXNEZWJhdGVQZXJpb2QsIAogICAgICAgICAgICBfZmVlc1Jld2FyZEluZmxhdGlvblJhdGUsIF9kZWZhdWx0TWludXRlc0Z1bmRpbmdQZXJpb2QsIF90b2tlblByaWNlSW5mbGF0aW9uUmF0ZSk7CgogICAgICAgIHJldHVybiBfcnVsZXNQcm9wb3NhbElEOwogICAgfQogICAgCiAgICBmdW5jdGlvbiB1cGdyYWRlUHJvcG9zYWwoCiAgICAgICAgYWRkcmVzcyBfbmV3Q29tbWl0dGVlUm9vbSwKICAgICAgICBhZGRyZXNzIF9uZXdTaGFyZU1hbmFnZXIsCiAgICAgICAgYWRkcmVzcyBfbmV3VG9rZW5NYW5hZ2VyLAogICAgICAgIHVpbnQgX21pbnV0ZXNEZWJhdGluZ1BlcmlvZAogICAgKSBwYXlhYmxlIHJldHVybnMgKHVpbnQpIHsKICAgICAgICAKICAgICAgICB1aW50IF91cGdyYWRlUHJvcG9zYWxJRCA9IFVwZ3JhZGVQcm9wb3NhbHMubGVuZ3RoKys7CiAgICAgICAgVXBncmFkZSB1ID0gVXBncmFkZVByb3Bvc2Fsc1tfdXBncmFkZVByb3Bvc2FsSURdOwogICAgICAgIAogICAgICAgIHUubmV3Q29tbWl0dGVlUm9vbSA9IF9uZXdDb21taXR0ZWVSb29tOwogICAgICAgIHUubmV3U2hhcmVNYW5hZ2VyID0gX25ld1NoYXJlTWFuYWdlcjsKICAgICAgICB1Lm5ld1Rva2VuTWFuYWdlciA9IF9uZXdUb2tlbk1hbmFnZXI7CgogICAgICAgIHUuY29tbWl0dGVlSUQgPSBuZXdDb21taXR0ZWUoUHJvcG9zYWxUeXBlcy51cGdyYWRlLCBfdXBncmFkZVByb3Bvc2FsSUQsIF9taW51dGVzRGViYXRpbmdQZXJpb2QpOwogICAgICAgIAogICAgICAgIFVwZ3JhZGVQcm9wb3NhbFN1Ym1pdHRlZChfdXBncmFkZVByb3Bvc2FsSUQsIHUuY29tbWl0dGVlSUQsIHUubmV3Q29tbWl0dGVlUm9vbSwgdS5uZXdTaGFyZU1hbmFnZXIsIHUubmV3VG9rZW5NYW5hZ2VyKTsKICAgICAgICAKICAgICAgICByZXR1cm4gX3VwZ3JhZGVQcm9wb3NhbElEOwogICAgfQogICAgCi8vIENvbW1pdHRlZXMgbWFuYWdlbWVudAoKICAgIGZ1bmN0aW9uIG5ld0NvbW1pdHRlZSgKICAgICAgICBQcm9wb3NhbFR5cGVzIF9wcm9wb3NhbFR5cGUsCiAgICAgICAgdWludCBfcHJvcG9zYWxJRCwgCiAgICAgICAgdWludCBfbWludXRlc0RlYmF0aW5nUGVyaW9kCiAgICApIGludGVybmFsIHJldHVybnMgKHVpbnQpIHsKCiAgICAgICAgaWYgKF9taW51dGVzRGViYXRpbmdQZXJpb2QgPT0gMCkgX21pbnV0ZXNEZWJhdGluZ1BlcmlvZCA9IHJ1bGVzUHJvcG9zYWxzWzBdLm1pbk1pbnV0ZXNEZWJhdGVQZXJpb2Q7CiAgICAgICAgCiAgICAgICAgaWYgKHBhc3NEYW8uQWN0dWFsQ29tbWl0dGVlUm9vbSgpICE9IGFkZHJlc3ModGhpcykKICAgICAgICAgICAgfHwgbXNnLnZhbHVlIDwgcnVsZXNQcm9wb3NhbHNbMF0ubWluQ29tbWl0dGVlRmVlcwogICAgICAgICAgICB8fCBub3cgKyAoKHJ1bGVzUHJvcG9zYWxzWzBdLm1pbnV0ZXNTZXRQcm9wb3NhbFBlcmlvZCArIF9taW51dGVzRGViYXRpbmdQZXJpb2QpICogMSBtaW51dGVzKSA8IG5vdwogICAgICAgICAgICB8fCBfbWludXRlc0RlYmF0aW5nUGVyaW9kIDwgcnVsZXNQcm9wb3NhbHNbMF0ubWluTWludXRlc0RlYmF0ZVBlcmlvZAogICAgICAgICAgICB8fCBtc2cuc2VuZGVyID09IGFkZHJlc3ModGhpcykpIHRocm93OwoKICAgICAgICB1aW50IF9jb21taXR0ZWVJRCA9IENvbW1pdHRlZXMubGVuZ3RoKys7CiAgICAgICAgQ29tbWl0dGVlIGIgPSBDb21taXR0ZWVzW19jb21taXR0ZWVJRF07CgogICAgICAgIGIuY3JlYXRvciA9IG1zZy5zZW5kZXI7CgogICAgICAgIGIucHJvcG9zYWxUeXBlID0gX3Byb3Bvc2FsVHlwZTsKICAgICAgICBiLnByb3Bvc2FsSUQgPSBfcHJvcG9zYWxJRDsKCiAgICAgICAgYi5mZWVzID0gbXNnLnZhbHVlOwogICAgICAgIAogICAgICAgIGIuc2V0RGVhZGxpbmUgPSBub3cgKyAocnVsZXNQcm9wb3NhbHNbMF0ubWludXRlc1NldFByb3Bvc2FsUGVyaW9kICogMSBtaW51dGVzKTsgICAgICAgIAogICAgICAgIGIudm90aW5nRGVhZGxpbmUgPSBiLnNldERlYWRsaW5lICsgKF9taW51dGVzRGViYXRpbmdQZXJpb2QgKiAxIG1pbnV0ZXMpOyAKCiAgICAgICAgYi5vcGVuID0gdHJ1ZTsgCgogICAgICAgIHJldHVybiBfY29tbWl0dGVlSUQ7CiAgICB9CiAgICAKICAgIGZ1bmN0aW9uIHZvdGUoCiAgICAgICAgdWludCBfY29tbWl0dGVlSUQsIAogICAgICAgIGJvb2wgX3N1cHBvcnRzUHJvcG9zYWwpIHsKICAgICAgICAKICAgICAgICBDb21taXR0ZWUgYiA9IENvbW1pdHRlZXNbX2NvbW1pdHRlZUlEXTsKCiAgICAgICAgaWYgKGhhc1ZvdGVkW19jb21taXR0ZWVJRF1bbXNnLnNlbmRlcl0gCiAgICAgICAgICAgIHx8IG5vdyA8IGIuc2V0RGVhZGxpbmUKICAgICAgICAgICAgfHwgbm93ID4gYi52b3RpbmdEZWFkbGluZSkgdGhyb3c7CiAgICAgICAgICAgIAogICAgICAgIFBhc3NNYW5hZ2VyIF9zaGFyZU1hbmFnZXIgPSBTaGFyZU1hbmFnZXIoKTsKCiAgICAgICAgdWludCBfYmFsYW5jZSA9IHVpbnQoX3NoYXJlTWFuYWdlci5iYWxhbmNlT2YobXNnLnNlbmRlcikpOwogICAgICAgIGlmIChfYmFsYW5jZSA9PSAwKSB0aHJvdzsKICAgICAgICAKICAgICAgICBoYXNWb3RlZFtfY29tbWl0dGVlSURdW21zZy5zZW5kZXJdID0gdHJ1ZTsKCiAgICAgICAgX3NoYXJlTWFuYWdlci5ibG9ja1RyYW5zZmVyKG1zZy5zZW5kZXIsIGIudm90aW5nRGVhZGxpbmUpOwoKICAgICAgICBpZiAoX3N1cHBvcnRzUHJvcG9zYWwpIGIueWVhICs9IF9iYWxhbmNlOwogICAgICAgIGVsc2UgYi5uYXkgKz0gX2JhbGFuY2U7IAoKICAgICAgICB1aW50IF9hID0gMTAwKmIuZmVlczsKICAgICAgICBpZiAoKF9hLzEwMCAhPSBiLmZlZXMpIHx8ICgoX2EqX2JhbGFuY2UpL19hICE9IF9iYWxhbmNlKSkgdGhyb3c7CiAgICAgICAgdWludCBfbXVsdGlwbGllciA9IChfYSpfYmFsYW5jZSkvdWludChfc2hhcmVNYW5hZ2VyLnRvdGFsU3VwcGx5KCkpOwogICAgICAgIHVpbnQgX2Rpdmlzb3IgPSAxMDAgKyAxMDAqcnVsZXNQcm9wb3NhbHNbMF0uZmVlc1Jld2FyZEluZmxhdGlvblJhdGUqKG5vdyAtIGIuc2V0RGVhZGxpbmUpLygxMDAqMzY1IGRheXMpOwogICAgICAgIHVpbnQgX3Jld2FyZGVkYW1vdW50ID0gX211bHRpcGxpZXIvX2Rpdmlzb3I7CiAgICAgICAgaWYgKGIudG90YWxSZXdhcmRlZEFtb3VudCArIF9yZXdhcmRlZGFtb3VudCA+IGIuZmVlcykgX3Jld2FyZGVkYW1vdW50ID0gYi5mZWVzIC0gYi50b3RhbFJld2FyZGVkQW1vdW50OwogICAgICAgIGIudG90YWxSZXdhcmRlZEFtb3VudCArPSBfcmV3YXJkZWRhbW91bnQ7CiAgICAgICAgaWYgKCFtc2cuc2VuZGVyLnNlbmQoX3Jld2FyZGVkYW1vdW50KSkgdGhyb3c7CgogICAgICAgIFZvdGVkKF9jb21taXR0ZWVJRCwgX3N1cHBvcnRzUHJvcG9zYWwsIG1zZy5zZW5kZXIsIF9yZXdhcmRlZGFtb3VudCk7ICAgIAp9CgovLyBEZWNpc2lvbnMgbWFuYWdlbWVudAoKICAgIGZ1bmN0aW9uIGV4ZWN1dGVEZWNpc2lvbih1aW50IF9jb21taXR0ZWVJRCkgcmV0dXJucyAoYm9vbCkgewoKICAgICAgICBDb21taXR0ZWUgYiA9IENvbW1pdHRlZXNbX2NvbW1pdHRlZUlEXTsKICAgICAgICAKICAgICAgICBpZiAobm93IDwgYi52b3RpbmdEZWFkbGluZSB8fCAhYi5vcGVuKSByZXR1cm47CiAgICAgICAgCiAgICAgICAgYi5vcGVuID0gZmFsc2U7CgogICAgICAgIFBhc3NNYW5hZ2VyIF9zaGFyZU1hbmFnZXIgPSBTaGFyZU1hbmFnZXIoKTsKICAgICAgICB1aW50IF9xdWFudGl0eU9mU2hhcmVzOwogICAgICAgIFBhc3NNYW5hZ2VyIF90b2tlbk1hbmFnZXIgPSBUb2tlbk1hbmFnZXIoKTsKCiAgICAgICAgaWYgKDEwMCpiLnllYSA+IHJ1bGVzUHJvcG9zYWxzWzBdLm1pblBlcmNlbnRhZ2VPZkxpa2VzICogdWludChfc2hhcmVNYW5hZ2VyLnRvdGFsU3VwcGx5KCkpKSB7ICAgICAgIAogICAgICAgICAgICBfcXVhbnRpdHlPZlNoYXJlcyA9IF9zaGFyZU1hbmFnZXIucmV3YXJkVG9rZW5zRm9yQ2xpZW50KGIuY3JlYXRvciwgcnVsZXNQcm9wb3NhbHNbMF0ubWluQ29tbWl0dGVlRmVlcyk7CiAgICAgICAgfSAgICAgICAgCgogICAgICAgIHVpbnQgX3NlbnRUb0Rhb01hbmFnZXIgPSBiLmZlZXMgLSBiLnRvdGFsUmV3YXJkZWRBbW91bnQ7CiAgICAgICAgaWYgKF9zZW50VG9EYW9NYW5hZ2VyID4gMCkgewogICAgICAgICAgICBpZiAoIWFkZHJlc3MoX3NoYXJlTWFuYWdlcikuc2VuZChfc2VudFRvRGFvTWFuYWdlcikpIHRocm93OwogICAgICAgIH0KICAgICAgICAKICAgICAgICBpZiAoYi55ZWEgKyBiLm5heSA8IG1pblF1b3J1bSgpIHx8IGIueWVhIDw9IGIubmF5KSB7CiAgICAgICAgICAgIGlmIChiLnByb3Bvc2FsVHlwZSA9PSBQcm9wb3NhbFR5cGVzLmNvbnRyYWN0b3IpIFByb3Bvc2Fsc1tiLnByb3Bvc2FsSURdLm9wZW4gPSBmYWxzZTsKICAgICAgICAgICAgUHJvcG9zYWxDbG9zZWQoYi5wcm9wb3NhbElELCBiLnByb3Bvc2FsVHlwZSwgX2NvbW1pdHRlZUlELCBiLnRvdGFsUmV3YXJkZWRBbW91bnQsIGZhbHNlLCBfcXVhbnRpdHlPZlNoYXJlcywgX3NlbnRUb0Rhb01hbmFnZXIpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBiLmRhdGVPZkV4ZWN1dGlvbiA9IG5vdzsKCiAgICAgICAgaWYgKGIucHJvcG9zYWxUeXBlID09IFByb3Bvc2FsVHlwZXMuY29udHJhY3RvcikgewoKICAgICAgICAgICAgUHJvcG9zYWwgcCA9IFByb3Bvc2Fsc1tiLnByb3Bvc2FsSURdOwogICAgCiAgICAgICAgICAgIGlmIChwLmNvbnRyYWN0b3JQcm9wb3NhbElEID09IDApIHAub3BlbiA9IGZhbHNlOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHAuYW1vdW50Rm9yU2hhcmVzID09IDAgJiYgcC5hbW91bnRGb3JUb2tlbnMgPT0gMCkgb3JkZXJUb0NvbnRyYWN0b3IoYi5wcm9wb3NhbElEKTsKICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAocC5hbW91bnRGb3JTaGFyZXMgIT0gMCkgewogICAgICAgICAgICAgICAgICAgIF9zaGFyZU1hbmFnZXIuc2V0RnVuZGluZ1J1bGVzKHAubW9kZXJhdG9yLCBwLmluaXRpYWxTaGFyZVByaWNlTXVsdGlwbGllciwgcC5hbW91bnRGb3JTaGFyZXMsIHAubWludXRlc0Z1bmRpbmdQZXJpb2QsIDAsIGIucHJvcG9zYWxJRCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHAuYW1vdW50Rm9yVG9rZW5zICE9IDApIHsKICAgICAgICAgICAgICAgICAgICBfdG9rZW5NYW5hZ2VyLnNldEZ1bmRpbmdSdWxlcyhwLm1vZGVyYXRvciwgMCwgcC5hbW91bnRGb3JUb2tlbnMsIHAubWludXRlc0Z1bmRpbmdQZXJpb2QsIHJ1bGVzUHJvcG9zYWxzWzBdLnRva2VuUHJpY2VJbmZsYXRpb25SYXRlLCBiLnByb3Bvc2FsSUQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgIH0gZWxzZSBpZiAoYi5wcm9wb3NhbFR5cGUgPT0gUHJvcG9zYWxUeXBlcy5yZXNvbHV0aW9uKSB7CiAgICAgICAgICAgIAogICAgICAgICAgICBRdWVzdGlvbiBxID0gUmVzb2x1dGlvblByb3Bvc2Fsc1tiLnByb3Bvc2FsSURdOwogICAgICAgICAgICAKICAgICAgICAgICAgcS5wcm9qZWN0Lm5ld1Jlc29sdXRpb24ocS5uYW1lLCBxLmRlc2NyaXB0aW9uKTsKICAgICAgICAgICAgCiAgICAgICAgfSBlbHNlIGlmIChiLnByb3Bvc2FsVHlwZSA9PSBQcm9wb3NhbFR5cGVzLnJ1bGVzKSB7CgogICAgICAgICAgICBSdWxlcyByID0gcnVsZXNQcm9wb3NhbHNbYi5wcm9wb3NhbElEXTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHJ1bGVzUHJvcG9zYWxzWzBdLmNvbW1pdHRlZUlEID0gci5jb21taXR0ZWVJRDsKICAgICAgICAgICAgcnVsZXNQcm9wb3NhbHNbMF0ubWluUXVvcnVtRGl2aXNvciA9IHIubWluUXVvcnVtRGl2aXNvcjsKICAgICAgICAgICAgcnVsZXNQcm9wb3NhbHNbMF0ubWluTWludXRlc0RlYmF0ZVBlcmlvZCA9IHIubWluTWludXRlc0RlYmF0ZVBlcmlvZDsgCiAgICAgICAgICAgIHJ1bGVzUHJvcG9zYWxzWzBdLm1pbkNvbW1pdHRlZUZlZXMgPSByLm1pbkNvbW1pdHRlZUZlZXM7CiAgICAgICAgICAgIHJ1bGVzUHJvcG9zYWxzWzBdLm1pblBlcmNlbnRhZ2VPZkxpa2VzID0gci5taW5QZXJjZW50YWdlT2ZMaWtlczsKICAgICAgICAgICAgcnVsZXNQcm9wb3NhbHNbMF0ubWludXRlc1NldFByb3Bvc2FsUGVyaW9kID0gci5taW51dGVzU2V0UHJvcG9zYWxQZXJpb2Q7CiAgICAgICAgICAgIHJ1bGVzUHJvcG9zYWxzWzBdLmZlZXNSZXdhcmRJbmZsYXRpb25SYXRlID0gci5mZWVzUmV3YXJkSW5mbGF0aW9uUmF0ZTsKICAgICAgICAgICAgcnVsZXNQcm9wb3NhbHNbMF0udG9rZW5QcmljZUluZmxhdGlvblJhdGUgPSByLnRva2VuUHJpY2VJbmZsYXRpb25SYXRlOwogICAgICAgICAgICBydWxlc1Byb3Bvc2Fsc1swXS5kZWZhdWx0TWludXRlc0Z1bmRpbmdQZXJpb2QgPSByLmRlZmF1bHRNaW51dGVzRnVuZGluZ1BlcmlvZDsKCiAgICAgICAgfSBlbHNlIGlmIChiLnByb3Bvc2FsVHlwZSA9PSBQcm9wb3NhbFR5cGVzLnVwZ3JhZGUpIHsKCiAgICAgICAgICAgIFVwZ3JhZGUgdSA9IFVwZ3JhZGVQcm9wb3NhbHNbYi5wcm9wb3NhbElEXTsKCiAgICAgICAgICAgIGlmICgodS5uZXdTaGFyZU1hbmFnZXIgIT0gMCkgJiYgKHUubmV3U2hhcmVNYW5hZ2VyICE9IGFkZHJlc3MoX3NoYXJlTWFuYWdlcikpKSB7CiAgICAgICAgICAgICAgICBfc2hhcmVNYW5hZ2VyLmRpc2FibGVUcmFuc2ZlcigpOwogICAgICAgICAgICAgICAgaWYgKF9zaGFyZU1hbmFnZXIuYmFsYW5jZSA+IDApIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIV9zaGFyZU1hbmFnZXIuc2VuZFRvKHUubmV3U2hhcmVNYW5hZ2VyLCBfc2hhcmVNYW5hZ2VyLmJhbGFuY2UpKSB0aHJvdzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCh1Lm5ld1Rva2VuTWFuYWdlciAhPSAwKSAmJiAodS5uZXdUb2tlbk1hbmFnZXIgIT0gYWRkcmVzcyhfdG9rZW5NYW5hZ2VyKSkpIHsKICAgICAgICAgICAgICAgIF90b2tlbk1hbmFnZXIuZGlzYWJsZVRyYW5zZmVyKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHBhc3NEYW8udXBncmFkZSh1Lm5ld0NvbW1pdHRlZVJvb20sIHUubmV3U2hhcmVNYW5hZ2VyLCB1Lm5ld1Rva2VuTWFuYWdlcik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgRGFwcFVwZ3JhZGVkKHUubmV3Q29tbWl0dGVlUm9vbSwgdS5uZXdTaGFyZU1hbmFnZXIsIHUubmV3VG9rZW5NYW5hZ2VyKTsKICAgICAgICAgICAgCiAgICAgICAgfQoKICAgICAgICBQcm9wb3NhbENsb3NlZChiLnByb3Bvc2FsSUQsIGIucHJvcG9zYWxUeXBlLCBfY29tbWl0dGVlSUQgLCBiLnRvdGFsUmV3YXJkZWRBbW91bnQsIHRydWUsIF9xdWFudGl0eU9mU2hhcmVzLCBfc2VudFRvRGFvTWFuYWdlcik7CiAgICAgICAgICAgIAogICAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgCiAgICBmdW5jdGlvbiBvcmRlclRvQ29udHJhY3Rvcih1aW50IF9wcm9wb3NhbElEKSByZXR1cm5zIChib29sKSB7CiAgICAgICAgCiAgICAgICAgUHJvcG9zYWwgcCA9IFByb3Bvc2Fsc1tfcHJvcG9zYWxJRF07CiAgICAgICAgQ29tbWl0dGVlIGIgPSBDb21taXR0ZWVzW3AuY29tbWl0dGVlSURdOwoKICAgICAgICBpZiAoYi5vcGVuIHx8ICFwLm9wZW4pIHJldHVybjsKICAgICAgICAKICAgICAgICB1aW50IF9hbW91bnRGb3JTaGFyZXM7CiAgICAgICAgdWludCBfYW1vdW50Rm9yVG9rZW5zOwoKICAgICAgICBpZiAocC5hbW91bnRGb3JTaGFyZXMgIT0gMCkgewogICAgICAgICAgICBfYW1vdW50Rm9yU2hhcmVzID0gU2hhcmVNYW5hZ2VyKCkuRnVuZGVkQW1vdW50KF9wcm9wb3NhbElEKTsKICAgICAgICAgICAgaWYgKF9hbW91bnRGb3JTaGFyZXMgPT0gMCAmJiBub3cgPD0gYi5kYXRlT2ZFeGVjdXRpb24gKyAocC5taW51dGVzRnVuZGluZ1BlcmlvZCAqIDEgbWludXRlcykpIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGlmIChwLmFtb3VudEZvclRva2VucyAhPSAwKSB7CiAgICAgICAgICAgIF9hbW91bnRGb3JUb2tlbnMgPSBUb2tlbk1hbmFnZXIoKS5GdW5kZWRBbW91bnQoX3Byb3Bvc2FsSUQpOwogICAgICAgICAgICBpZiAoX2Ftb3VudEZvclRva2VucyA9PSAwICYmIG5vdyA8PSBiLmRhdGVPZkV4ZWN1dGlvbiArIChwLm1pbnV0ZXNGdW5kaW5nUGVyaW9kICogMSBtaW51dGVzKSkgcmV0dXJuOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBwLm9wZW4gPSBmYWxzZTsgICAKCiAgICAgICAgdWludCBfYW1vdW50ID0gcC5hbW91bnQgKyBfYW1vdW50Rm9yU2hhcmVzICsgX2Ftb3VudEZvclRva2VuczsKCiAgICAgICAgUGFzc1Byb2plY3QgX3Byb2plY3QgPSBQYXNzUHJvamVjdChwLmNvbnRyYWN0b3IuUHJvamVjdCgpKTsKCiAgICAgICAgaWYgKF9hbW91bnQgPT0gMCkgewogICAgICAgICAgICBDb250cmFjdG9yUHJvcG9zYWxDbG9zZWQoX3Byb3Bvc2FsSUQsIHAuY29udHJhY3RvclByb3Bvc2FsSUQsIHAuY29udHJhY3RvciwgMCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9ICAgIAoKICAgICAgICBpZiAoIXAuY29udHJhY3Rvci5vcmRlcihwLmNvbnRyYWN0b3JQcm9wb3NhbElELCBfYW1vdW50KSkgdGhyb3c7CiAgICAgICAgCiAgICAgICAgaWYgKHAuYW1vdW50ICsgX2Ftb3VudEZvclNoYXJlcyA+IDApIHsKICAgICAgICAgICAgaWYgKCFTaGFyZU1hbmFnZXIoKS5zZW5kVG8ocC5jb250cmFjdG9yLCBwLmFtb3VudCArIF9hbW91bnRGb3JTaGFyZXMpKSB0aHJvdzsKICAgICAgICB9CiAgICAgICAgaWYgKF9hbW91bnRGb3JUb2tlbnMgPiAwKSB7CiAgICAgICAgICAgIGlmICghVG9rZW5NYW5hZ2VyKCkuc2VuZFRvKHAuY29udHJhY3RvciwgX2Ftb3VudEZvclRva2VucykpIHRocm93OwogICAgICAgIH0KCiAgICAgICAgQ29udHJhY3RvclByb3Bvc2FsQ2xvc2VkKF9wcm9wb3NhbElELCBwLmNvbnRyYWN0b3JQcm9wb3NhbElELCBwLmNvbnRyYWN0b3IsIF9hbW91bnQpOwogICAgICAgIAogICAgICAgIHBhc3NEYW8uYWRkUHJvamVjdChfcHJvamVjdCk7CiAgICAgICAgX3Byb2plY3QubmV3T3JkZXIocC5jb250cmFjdG9yLCBwLmNvbnRyYWN0b3JQcm9wb3NhbElELCBfYW1vdW50KTsKICAgICAgICAKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCi8vIEhvbGRlciBBY2NvdW50IG1hbmFnZW1lbnQKCiAgICBmdW5jdGlvbiBidXlTaGFyZXNGb3JQcm9wb3NhbCh1aW50IF9wcm9wb3NhbElEKSBwYXlhYmxlIHJldHVybnMgKGJvb2wpIHsKICAgICAgICAKICAgICAgICByZXR1cm4gU2hhcmVNYW5hZ2VyKCkuYnV5VG9rZW5zRm9yUHJvcG9zYWwudmFsdWUobXNnLnZhbHVlKShfcHJvcG9zYWxJRCwgbXNnLnNlbmRlcik7CiAgICB9ICAgCgogICAgZnVuY3Rpb24gc2VuZFBlbmRpbmdBbW91bnRzKAogICAgICAgIHVpbnQgX2Zyb20sCiAgICAgICAgdWludCBfdG8sCiAgICAgICAgYWRkcmVzcyBfYnV5ZXIpIHJldHVybnMgKGJvb2wpIHsKICAgICAgICAKICAgICAgICByZXR1cm4gU2hhcmVNYW5hZ2VyKCkuc2VuZFBlbmRpbmdBbW91bnRzKF9mcm9tLCBfdG8sIF9idXllcik7CiAgICB9ICAgICAgICAKICAgIAogICAgZnVuY3Rpb24gd2l0aGRyYXdQZW5kaW5nQW1vdW50cygpIHJldHVybnMgKGJvb2wpIHsKICAgICAgICAKICAgICAgICBpZiAoIVNoYXJlTWFuYWdlcigpLnNlbmRQZW5kaW5nQW1vdW50cygwLCAwLCBtc2cuc2VuZGVyKSkgdGhyb3c7CiAgICB9ICAgICAgICAKICAgICAgICAgICAgCn0='.
	

]
