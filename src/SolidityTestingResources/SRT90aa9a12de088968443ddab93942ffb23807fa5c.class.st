Class {
	#name : #SRT90aa9a12de088968443ddab93942ffb23807fa5c,
	#superclass : #SRTContracts,
	#category : #SolidityTestingResources
}

{ #category : #base64 }
SRT90aa9a12de088968443ddab93942ffb23807fa5c >> base64 [
	^ 'cHJhZ21hIHNvbGlkaXR5IF4wLjQuMTM7CgovKioKICogQHRpdGxlIFdhbGxldCBBZG1pbiBMaWJyYXJ5CiAqIEBhdXRob3IgTWFqb29sci5pbwogKgogKiB2ZXJzaW9uIDEuMC4wCiAqIENvcHlyaWdodCAoYykgMjAxNyBNYWpvb2xyLCBMTEMKICogVGhlIE1JVCBMaWNlbnNlIChNSVQpCiAqIGh0dHBzOi8vZ2l0aHViLmNvbS9NYWpvb2xyL2V0aGVyZXVtLWxpYnJhcmllcy9ibG9iL21hc3Rlci9MSUNFTlNFCiAqCiAqIFRoZSBXYWxsZXQgTGlicmFyeSBmYW1pbHkgaXMgaW5zcGlyZWQgYnkgdGhlIG11bHRpc2lnIHdhbGxldHMgYnVpbHQgYnkgQ29uc2Vuc3lzCiAqIGF0IGh0dHBzOi8vZ2l0aHViLmNvbS9Db25zZW5TeXMvTXVsdGlTaWdXYWxsZXQgYW5kIFBhcml0eSBhdAogKiBodHRwczovL2dpdGh1Yi5jb20vcGFyaXR5dGVjaC9jb250cmFjdHMvYmxvYi9tYXN0ZXIvV2FsbGV0LnNvbCB3aXRoIGFkZGVkCiAqIGZ1bmN0aW9uYWxpdHkuIE1ham9vbHIgd29ya3Mgb24gb3BlbiBzb3VyY2UgcHJvamVjdHMgaW4gdGhlIEV0aGVyZXVtCiAqIGNvbW11bml0eSB3aXRoIHRoZSBwdXJwb3NlIG9mIHRlc3RpbmcsIGRvY3VtZW50aW5nLCBhbmQgZGVwbG95aW5nIHJldXNhYmxlCiAqIGNvZGUgb250byB0aGUgYmxvY2tjaGFpbiB0byBpbXByb3ZlIHNlY3VyaXR5IGFuZCB1c2FiaWxpdHkgb2Ygc21hcnQgY29udHJhY3RzLgogKiBNYWpvb2xyIGFsc28gc3RyaXZlcyB0byBlZHVjYXRlIG5vbi1wcm9maXRzLCBzY2hvb2xzLCBhbmQgb3RoZXIgY29tbXVuaXR5CiAqIG1lbWJlcnMgYWJvdXQgdGhlIGFwcGxpY2F0aW9uIG9mIGJsb2NrY2hhaW4gdGVjaG5vbG9neS4gRm9yIGZ1cnRoZXIKICogaW5mb3JtYXRpb246IG1ham9vbHIuaW8sIGNvbnNlbnN5cy5uZXQsIHBhcml0eXRlY2guaW8KICoKICogVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MKICogT1IgSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRgogKiBNRVJDSEFOVEFCSUxJVFksIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuCiAqIElOIE5PIEVWRU5UIFNIQUxMIFRIRSBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZCiAqIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsCiAqIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFCiAqIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4gVEhFIFNPRlRXQVJFLgogKi8KCmxpYnJhcnkgV2FsbGV0QWRtaW5MaWIgewogIHVzaW5nIFdhbGxldE1haW5MaWIgZm9yIFdhbGxldE1haW5MaWIuV2FsbGV0RGF0YTsKCiAgLypFdmVudHMqLwogIGV2ZW50IExvZ1RyYW5zYWN0aW9uQ29uZmlybWVkKGJ5dGVzMzIgdHhpZCwgYWRkcmVzcyBzZW5kZXIsIHVpbnQgY29uZmlybXNOZWVkZWQpOwogIGV2ZW50IExvZ093bmVyQWRkZWQoYWRkcmVzcyBuZXdPd25lcik7CiAgZXZlbnQgTG9nT3duZXJSZW1vdmVkKGFkZHJlc3Mgb3duZXJSZW1vdmVkKTsKICBldmVudCBMb2dPd25lckNoYW5nZWQoYWRkcmVzcyBmcm9tLCBhZGRyZXNzIHRvKTsKICBldmVudCBMb2dSZXF1aXJlbWVudENoYW5nZSh1aW50IG5ld1JlcXVpcmVkKTsKICBldmVudCBMb2dUaHJlc2hvbGRDaGFuZ2UoYWRkcmVzcyB0b2tlbiwgdWludCBuZXdUaHJlc2hvbGQpOwogIGV2ZW50IExvZ0Vyck1zZyhzdHJpbmcgbXNnKTsKCiAgLypDaGVja3MqLwoKICAvLy8gQGRldiBWYWxpZGF0ZXMgYXJndW1lbnRzIGZvciBjaGFuZ2VPd25lciBmdW5jdGlvbgogIC8vLyBAcGFyYW0gX2Zyb20gSW5kZXggb2YgY3VycmVudCBvd25lciByZW1vdmluZwogIC8vLyBAcGFyYW0gX3RvIEluZGV4IG9mIG5ldyBwb3RlbnRpYWwgb3duZXIsIHNob3VsZCBiZSAwCiAgLy8vIEByZXR1cm4gUmV0dXJucyB0cnVlIGlmIGNoZWNrIHBhc3NlcywgZmFsc2Ugb3RoZXJ3aXNlCiAgZnVuY3Rpb24gY2hlY2tDaGFuZ2VPd25lckFyZ3ModWludCBfZnJvbSwgdWludCBfdG8pIGNvbnN0YW50IHJldHVybnMgKGJvb2wpIHsKICAgIGlmKF9mcm9tID09IDApewogICAgICBMb2dFcnJNc2coIkNoYW5nZSBmcm9tIGFkZHJlc3MgaXMgbm90IGFuIG93bmVyIik7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIGlmKF90byAhPSAwKXsKICAgICAgTG9nRXJyTXNnKCJDaGFuZ2UgdG8gYWRkcmVzcyBpcyBhbiBvd25lciIpOwogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICByZXR1cm4gdHJ1ZTsKICB9CgogIC8vLyBAZGV2IFZhbGlkYXRlcyBhcmd1bWVudHMgZm9yIGFkZE93bmVyIGZ1bmN0aW9uCiAgLy8vIEBwYXJhbSBfaW5kZXggSW5kZXggb2YgbmV3IG93bmVyLCBzaG91bGQgYmUgMAogIC8vLyBAcGFyYW0gX2xlbmd0aCBDdXJyZW50IGxlbmd0aCBvZiBvd25lciBhcnJheQogIC8vLyBAcmV0dXJuIFJldHVybnMgdHJ1ZSBpZiBjaGVjayBwYXNzZXMsIGZhbHNlIG90aGVyd2lzZQogIGZ1bmN0aW9uIGNoZWNrTmV3T3duZXJBcmdzKHVpbnQgX2luZGV4LCB1aW50IF9sZW5ndGgsIHVpbnQgX21heCkKICAgICAgICAgICBjb25zdGFudCByZXR1cm5zIChib29sKQogIHsKICAgIGlmKF9pbmRleCAhPSAwKXsKICAgICAgTG9nRXJyTXNnKCJOZXcgb3duZXIgYWxyZWFkeSBvd25lciIpOwogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICBpZigoX2xlbmd0aCArIDEpID4gX21heCl7CiAgICAgIExvZ0Vyck1zZygiVG9vIG1hbnkgb3duZXJzIik7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIHJldHVybiB0cnVlOwogIH0KCiAgLy8vIEBkZXYgVmFsaWRhdGVzIGFyZ3VtZW50cyBmb3IgcmVtb3ZlT3duZXIgZnVuY3Rpb24KICAvLy8gQHBhcmFtIF9pbmRleCBJbmRleCBvZiBvd25lciByZW1vdmluZwogIC8vLyBAcGFyYW0gX2xlbmd0aCBDdXJyZW50IG51bWJlciBvZiBvd25lcnMKICAvLy8gQHBhcmFtIF9taW4gTWluaW11bSBvd25lcnMgY3VycmVudGx5IHJlcXVpcmVkIHRvIG1lZXQgc2lnIHJlcXVpcmVtZW50cwogIC8vLyBAcmV0dXJuIFJldHVycyB0cnVlIGlmIGNoZWNrIHBhc3NlcywgZmFsc2Ugb3RoZXJ3aXNlCiAgZnVuY3Rpb24gY2hlY2tSZW1vdmVPd25lckFyZ3ModWludCBfaW5kZXgsIHVpbnQgX2xlbmd0aCwgdWludCBfbWluKQogICAgICAgICAgIGNvbnN0YW50IHJldHVybnMgKGJvb2wpCiAgewogICAgaWYoX2luZGV4ID09IDApewogICAgICBMb2dFcnJNc2coIk93bmVyIHJlbW92aW5nIG5vdCBhbiBvd25lciIpOwogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICBpZihfbGVuZ3RoIC0gMSA8IF9taW4pewogICAgICBMb2dFcnJNc2coIk11c3QgcmVkdWNlIHJlcXVpcmVkQWRtaW4gZmlyc3QiKTsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgcmV0dXJuIHRydWU7CiAgfQoKICAvLy8gQGRldiBWYWxpZGF0ZXMgYXJndW1lbnRzIGZvciBjaGFuZ2luZyBhbnkgb2YgdGhlIHNpZyByZXF1aXJlbWVudCBwYXJhbWV0ZXJzCiAgLy8vIEBwYXJhbSBfbmV3UmVxdWlyZWQgVGhlIG5ldyBzaWcgcmVxdWlyZW1lbnQKICAvLy8gQHBhcmFtIF9sZW5ndGggQ3VycmVudCBudW1iZXIgb2Ygb3duZXJzCiAgLy8vIEByZXR1cm4gUmV0dXJucyB0cnVlIGlmIGNoZWNrcyBwYXNzLCBmYWxzZSBvdGhlcndpc2UKICBmdW5jdGlvbiBjaGVja1JlcXVpcmVkQ2hhbmdlKHVpbnQgX25ld1JlcXVpcmVkLCB1aW50IF9sZW5ndGgpCiAgICAgICAgICAgY29uc3RhbnQgcmV0dXJucyAoYm9vbCkKICB7CiAgICBpZihfbmV3UmVxdWlyZWQgPT0gMCl7CiAgICAgIExvZ0Vyck1zZygiQ2FudCByZWR1Y2UgdG8gMCIpOwogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICBpZihfbGVuZ3RoIC0gMSA8IF9uZXdSZXF1aXJlZCl7CiAgICAgIExvZ0Vyck1zZygiTWFraW5nIHJlcXVpcmVtZW50IHRvbyBoaWdoIik7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIHJldHVybiB0cnVlOwogIH0KCiAgLypVdGlsaXR5IEZ1bmN0aW9ucyovCgogIC8vLyBAZGV2IFVzZWQgbGF0ZXIgdG8gY2FsY3VsYXRlIHRoZSBudW1iZXIgb2YgY29uZmlybWF0aW9ucyBuZWVkZWQgZm9yIHR4CiAgLy8vIEBwYXJhbSBfcmVxdWlyZWQgTnVtYmVyIG9mIHNpZ3MgcmVxdWlyZWQKICAvLy8gQHBhcmFtIF9jb3VudCBDdXJyZW50IG51bWJlciBvZiBzaWdzCiAgZnVuY3Rpb24gY2FsY0NvbmZpcm1zTmVlZGVkKHVpbnQgX3JlcXVpcmVkLCB1aW50IF9jb3VudCkgY29uc3RhbnQgcmV0dXJucyAodWludCl7CiAgICByZXR1cm4gX3JlcXVpcmVkIC0gX2NvdW50OwogIH0KCiAgLypBZG1pbmlzdHJhdGl2ZSBGdW5jdGlvbnMqLwoKICAvLy8gQGRldiBDaGFuZ2VzIG93bmVyIGFkZHJlc3MgdG8gYSBuZXcgYWRkcmVzcwogIC8vLyBAcGFyYW0gc2VsZiBXYWxsZXQgaW4gY29udHJhY3Qgc3RvcmFnZQogIC8vLyBAcGFyYW0gX2Zyb20gQ3VycmVudCBvd25lciBhZGRyZXNzCiAgLy8vIEBwYXJhbSBfdG8gTmV3IGFkZHJlc3MKICAvLy8gQHBhcmFtIF9jb25maXJtIFRydWUgaWYgY29uZmlybWluZywgZmFsc2UgaWYgcmV2b2tpbmcgY29uZmlybWF0aW9uCiAgLy8vIEBwYXJhbSBfZGF0YSBNZXNzYWdlIGRhdGEgcGFzc2VkIGZyb20gd2FsbGV0IGNvbnRyYWN0CiAgLy8vIEByZXR1cm4gYm9vbCBSZXR1cm5zIHRydWUgaWYgc3VjY2Vzc2Z1bCwgZmFsc2Ugb3RoZXJ3aXNlCiAgLy8vIEByZXR1cm4gYnl0ZXMzMiBSZXR1cm5zIHRoZSB0eCBJRCwgY2FuIGJlIHVzZWQgZm9yIGNvbmZpcm0vcmV2b2tlIGZ1bmN0aW9ucwogIGZ1bmN0aW9uIGNoYW5nZU93bmVyKFdhbGxldE1haW5MaWIuV2FsbGV0RGF0YSBzdG9yYWdlIHNlbGYsCiAgICAgICAgICAgICAgICAgICAgICAgYWRkcmVzcyBfZnJvbSwKICAgICAgICAgICAgICAgICAgICAgICBhZGRyZXNzIF90bywKICAgICAgICAgICAgICAgICAgICAgICBib29sIF9jb25maXJtLAogICAgICAgICAgICAgICAgICAgICAgIGJ5dGVzIF9kYXRhKQogICAgICAgICAgICAgICAgICAgICAgIHJldHVybnMgKGJvb2wsYnl0ZXMzMikKICB7CiAgICBieXRlczMyIF9pZCA9IHNoYTMoImNoYW5nZU93bmVyIixfZnJvbSxfdG8pOwogICAgdWludCBfbnVtYmVyID0gc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXS5sZW5ndGg7CiAgICBib29sIGFsbEdvb2Q7CgogICAgaWYobXNnLnNlbmRlciAhPSBhZGRyZXNzKHRoaXMpKXsKICAgICAgaWYoIV9jb25maXJtKSB7CiAgICAgICAgYWxsR29vZCA9IHNlbGYucmV2b2tlQ29uZmlybShfaWQpOwogICAgICAgIHJldHVybiAoYWxsR29vZCxfaWQpOwogICAgICB9IGVsc2UgewogICAgICAgIGlmKF9udW1iZXIgPT0gMCB8fCBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW19udW1iZXIgLSAxXS5zdWNjZXNzKXsKICAgICAgICAgIHJlcXVpcmUoc2VsZi5vd25lckluZGV4W21zZy5zZW5kZXJdID4gMCk7CiAgICAgICAgICBhbGxHb29kID0gY2hlY2tDaGFuZ2VPd25lckFyZ3Moc2VsZi5vd25lckluZGV4W19mcm9tXSwgc2VsZi5vd25lckluZGV4W190b10pOwogICAgICAgICAgaWYoIWFsbEdvb2QpCiAgICAgICAgICAgIHJldHVybiAoZmFsc2UsMCk7CgogICAgICAgICAgc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXS5sZW5ndGgrKzsKICAgICAgICAgIHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX251bWJlcl0uY29uZmlybVJlcXVpcmVkID0gc2VsZi5yZXF1aXJlZEFkbWluOwogICAgICAgICAgc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfbnVtYmVyXS5kYXkgPSBub3cgLyAxIGRheXM7CiAgICAgICAgICBzZWxmLnRyYW5zYWN0aW9uc1tub3cgLyAxIGRheXNdLnB1c2goX2lkKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgX251bWJlci0tOwogICAgICAgICAgYWxsR29vZCA9IHNlbGYuY2hlY2tOb3RDb25maXJtZWQoX2lkLCBfbnVtYmVyKTsKICAgICAgICAgIGlmKCFhbGxHb29kKQogICAgICAgICAgICByZXR1cm4gKGZhbHNlLF9pZCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX251bWJlcl0uY29uZmlybWVkT3duZXJzLnB1c2godWludDI1Nihtc2cuc2VuZGVyKSk7CiAgICAgIHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX251bWJlcl0uY29uZmlybUNvdW50Kys7CiAgICB9IGVsc2UgewogICAgICBfbnVtYmVyLS07CiAgICB9CgogICAgaWYoc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfbnVtYmVyXS5jb25maXJtQ291bnQgPT0KICAgICAgIHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX251bWJlcl0uY29uZmlybVJlcXVpcmVkKQogICAgewogICAgICBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW19udW1iZXJdLnN1Y2Nlc3MgPSB0cnVlOwogICAgICB1aW50IGkgPSBzZWxmLm93bmVySW5kZXhbX2Zyb21dOwogICAgICBzZWxmLm93bmVySW5kZXhbX2Zyb21dID0gMDsKICAgICAgc2VsZi5vd25lcnNbaV0gPSBfdG87CiAgICAgIHNlbGYub3duZXJJbmRleFtfdG9dID0gaTsKICAgICAgZGVsZXRlIHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX251bWJlcl0uZGF0YTsKICAgICAgTG9nT3duZXJDaGFuZ2VkKF9mcm9tLCBfdG8pOwogICAgfSBlbHNlIHsKICAgICAgaWYoc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfbnVtYmVyXS5kYXRhLmxlbmd0aCA9PSAwKQogICAgICAgIHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX251bWJlcl0uZGF0YSA9IF9kYXRhOwoKICAgICAgdWludCBjb25maXJtc05lZWRlZCA9IGNhbGNDb25maXJtc05lZWRlZChzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW19udW1iZXJdLmNvbmZpcm1SZXF1aXJlZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW19udW1iZXJdLmNvbmZpcm1Db3VudCk7CgogICAgICBMb2dUcmFuc2FjdGlvbkNvbmZpcm1lZChfaWQsIG1zZy5zZW5kZXIsIGNvbmZpcm1zTmVlZGVkKTsKICAgIH0KCiAgICByZXR1cm4gKHRydWUsX2lkKTsKCX0KCiAgLy8vIEBkZXYgQWRkcyBvd25lciB0byB3YWxsZXQKICAvLy8gQHBhcmFtIHNlbGYgV2FsbGV0IGluIGNvbnRyYWN0IHN0b3JhZ2UKICAvLy8gQHBhcmFtIF9uZXdPd25lciBBZGRyZXNzIGZvciBuZXcgb3duZXIKICAvLy8gQHBhcmFtIF9jb25maXJtIFRydWUgaWYgY29uZmlybWluZywgZmFsc2UgaWYgcmV2b2tpbmcgY29uZmlybWF0aW9uCiAgLy8vIEBwYXJhbSBfZGF0YSBNZXNzYWdlIGRhdGEgcGFzc2VkIGZyb20gd2FsbGV0IGNvbnRyYWN0CiAgLy8vIEByZXR1cm4gYm9vbCBSZXR1cm5zIHRydWUgaWYgc3VjY2Vzc2Z1bCwgZmFsc2Ugb3RoZXJ3aXNlCiAgLy8vIEByZXR1cm4gYnl0ZXMzMiBSZXR1cm5zIHRoZSB0eCBJRCwgY2FuIGJlIHVzZWQgZm9yIGNvbmZpcm0vcmV2b2tlIGZ1bmN0aW9ucwogIGZ1bmN0aW9uIGFkZE93bmVyKFdhbGxldE1haW5MaWIuV2FsbGV0RGF0YSBzdG9yYWdlIHNlbGYsCiAgICAgICAgICAgICAgICAgICAgYWRkcmVzcyBfbmV3T3duZXIsCiAgICAgICAgICAgICAgICAgICAgYm9vbCBfY29uZmlybSwKICAgICAgICAgICAgICAgICAgICBieXRlcyBfZGF0YSkKICAgICAgICAgICAgICAgICAgICByZXR1cm5zIChib29sLGJ5dGVzMzIpCiAgewogICAgYnl0ZXMzMiBfaWQgPSBzaGEzKCJhZGRPd25lciIsX25ld093bmVyKTsKICAgIHVpbnQgX251bWJlciA9IHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF0ubGVuZ3RoOwogICAgYm9vbCBhbGxHb29kOwoKICAgIGlmKG1zZy5zZW5kZXIgIT0gYWRkcmVzcyh0aGlzKSl7CiAgICAgIHJlcXVpcmUoX25ld093bmVyICE9IDApOwoKICAgICAgaWYoIV9jb25maXJtKSB7CiAgICAgICAgYWxsR29vZCA9IHNlbGYucmV2b2tlQ29uZmlybShfaWQpOwogICAgICAgIHJldHVybiAoYWxsR29vZCxfaWQpOwogICAgICB9IGVsc2UgewogICAgICAgIGlmKF9udW1iZXIgPT0gMCB8fCBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW19udW1iZXIgLSAxXS5zdWNjZXNzKXsKICAgICAgICAgIHJlcXVpcmUoc2VsZi5vd25lckluZGV4W21zZy5zZW5kZXJdID4gMCk7CiAgICAgICAgICBhbGxHb29kID0gY2hlY2tOZXdPd25lckFyZ3Moc2VsZi5vd25lckluZGV4W19uZXdPd25lcl0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5vd25lcnMubGVuZ3RoLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubWF4T3duZXJzKTsKICAgICAgICAgIGlmKCFhbGxHb29kKQogICAgICAgICAgICByZXR1cm4gKGZhbHNlLDApOwoKICAgICAgICAgIHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF0ubGVuZ3RoKys7CiAgICAgICAgICBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW19udW1iZXJdLmNvbmZpcm1SZXF1aXJlZCA9IHNlbGYucmVxdWlyZWRBZG1pbjsKICAgICAgICAgIHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX251bWJlcl0uZGF5ID0gbm93IC8gMSBkYXlzOwogICAgICAgICAgc2VsZi50cmFuc2FjdGlvbnNbbm93IC8gMSBkYXlzXS5wdXNoKF9pZCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIF9udW1iZXItLTsKICAgICAgICAgIGFsbEdvb2QgPSBzZWxmLmNoZWNrTm90Q29uZmlybWVkKF9pZCwgX251bWJlcik7CiAgICAgICAgICBpZighYWxsR29vZCkKICAgICAgICAgICAgcmV0dXJuIChmYWxzZSxfaWQpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfbnVtYmVyXS5jb25maXJtZWRPd25lcnMucHVzaCh1aW50KG1zZy5zZW5kZXIpKTsKICAgICAgc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfbnVtYmVyXS5jb25maXJtQ291bnQrKzsKICAgIH0gZWxzZSB7CiAgICAgIF9udW1iZXItLTsKICAgIH0KCiAgICBpZihzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW19udW1iZXJdLmNvbmZpcm1Db3VudCA9PQogICAgICAgc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfbnVtYmVyXS5jb25maXJtUmVxdWlyZWQpCiAgICB7CiAgICAgIHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX251bWJlcl0uc3VjY2VzcyA9IHRydWU7CiAgICAgIHNlbGYub3duZXJzLnB1c2goX25ld093bmVyKTsKICAgICAgc2VsZi5vd25lckluZGV4W19uZXdPd25lcl0gPSBzZWxmLm93bmVycy5sZW5ndGggLSAxOwogICAgICBkZWxldGUgc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfbnVtYmVyXS5kYXRhOwogICAgICBMb2dPd25lckFkZGVkKF9uZXdPd25lcik7CiAgICB9IGVsc2UgewogICAgICBpZihzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW19udW1iZXJdLmRhdGEubGVuZ3RoID09IDApCiAgICAgICAgc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfbnVtYmVyXS5kYXRhID0gX2RhdGE7CgogICAgICB1aW50IGNvbmZpcm1zTmVlZGVkID0gY2FsY0NvbmZpcm1zTmVlZGVkKHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX251bWJlcl0uY29uZmlybVJlcXVpcmVkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX251bWJlcl0uY29uZmlybUNvdW50KTsKICAgICAgTG9nVHJhbnNhY3Rpb25Db25maXJtZWQoX2lkLCBtc2cuc2VuZGVyLCBjb25maXJtc05lZWRlZCk7CiAgICB9CgogICAgcmV0dXJuICh0cnVlLF9pZCk7Cgl9CgogIC8vLyBAZGV2IFJlbW92ZXMgb3duZXIgZnJvbSB3YWxsZXQKICAvLy8gQHBhcmFtIHNlbGYgV2FsbGV0IGluIGNvbnRyYWN0IHN0b3JhZ2UKICAvLy8gQHBhcmFtIF9vd25lclJlbW92aW5nIEFkZHJlc3Mgb2Ygb3duZXIgdG8gYmUgcmVtb3ZlZAogIC8vLyBAcGFyYW0gX2NvbmZpcm0gVHJ1ZSBpZiBjb25maXJtaW5nLCBmYWxzZSBpZiByZXZva2luZyBjb25maXJtYXRpb24KICAvLy8gQHBhcmFtIF9kYXRhIE1lc3NhZ2UgZGF0YSBwYXNzZWQgZnJvbSB3YWxsZXQgY29udHJhY3QKICAvLy8gQHJldHVybiBib29sIFJldHVybnMgdHJ1ZSBpZiBzdWNjZXNzZnVsLCBmYWxzZSBvdGhlcndpc2UKICAvLy8gQHJldHVybiBieXRlczMyIFJldHVybnMgdGhlIHR4IElELCBjYW4gYmUgdXNlZCBmb3IgY29uZmlybS9yZXZva2UgZnVuY3Rpb25zCiAgZnVuY3Rpb24gcmVtb3ZlT3duZXIoV2FsbGV0TWFpbkxpYi5XYWxsZXREYXRhIHN0b3JhZ2Ugc2VsZiwKICAgICAgICAgICAgICAgICAgICAgICBhZGRyZXNzIF9vd25lclJlbW92aW5nLAogICAgICAgICAgICAgICAgICAgICAgIGJvb2wgX2NvbmZpcm0sCiAgICAgICAgICAgICAgICAgICAgICAgYnl0ZXMgX2RhdGEpCiAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJucyAoYm9vbCxieXRlczMyKQogIHsKICAgIGJ5dGVzMzIgX2lkID0gc2hhMygicmVtb3ZlT3duZXIiLF9vd25lclJlbW92aW5nKTsKICAgIHVpbnQgX251bWJlciA9IHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF0ubGVuZ3RoOwogICAgYm9vbCBhbGxHb29kOwoKICAgIGlmKG1zZy5zZW5kZXIgIT0gYWRkcmVzcyh0aGlzKSl7CiAgICAgIGlmKCFfY29uZmlybSkgewogICAgICAgIGFsbEdvb2QgPSBzZWxmLnJldm9rZUNvbmZpcm0oX2lkKTsKICAgICAgICByZXR1cm4gKGFsbEdvb2QsX2lkKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZihfbnVtYmVyID09IDAgfHwgc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfbnVtYmVyIC0gMV0uc3VjY2Vzcyl7CiAgICAgICAgICByZXF1aXJlKHNlbGYub3duZXJJbmRleFttc2cuc2VuZGVyXSA+IDApOwogICAgICAgICAgYWxsR29vZCA9IGNoZWNrUmVtb3ZlT3duZXJBcmdzKHNlbGYub3duZXJJbmRleFtfb3duZXJSZW1vdmluZ10sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5vd25lcnMubGVuZ3RoLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYucmVxdWlyZWRBZG1pbik7CiAgICAgICAgICBpZighYWxsR29vZCkKICAgICAgICAgICAgcmV0dXJuIChmYWxzZSwwKTsKCiAgICAgICAgICBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdLmxlbmd0aCsrOwogICAgICAgICAgc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfbnVtYmVyXS5jb25maXJtUmVxdWlyZWQgPSBzZWxmLnJlcXVpcmVkQWRtaW47CiAgICAgICAgICBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW19udW1iZXJdLmRheSA9IG5vdyAvIDEgZGF5czsKICAgICAgICAgIHNlbGYudHJhbnNhY3Rpb25zW25vdyAvIDEgZGF5c10ucHVzaChfaWQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBfbnVtYmVyLS07CiAgICAgICAgICBhbGxHb29kID0gc2VsZi5jaGVja05vdENvbmZpcm1lZChfaWQsIF9udW1iZXIpOwogICAgICAgICAgaWYoIWFsbEdvb2QpCiAgICAgICAgICAgIHJldHVybiAoZmFsc2UsX2lkKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX251bWJlcl0uY29uZmlybWVkT3duZXJzLnB1c2godWludChtc2cuc2VuZGVyKSk7CiAgICAgIHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX251bWJlcl0uY29uZmlybUNvdW50Kys7CiAgICB9IGVsc2UgewogICAgICBfbnVtYmVyLS07CiAgICB9CgogICAgaWYoc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfbnVtYmVyXS5jb25maXJtQ291bnQgPT0KICAgICAgIHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX251bWJlcl0uY29uZmlybVJlcXVpcmVkKQogICAgewogICAgICBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW19udW1iZXJdLnN1Y2Nlc3MgPSB0cnVlOwogICAgICBzZWxmLm93bmVyc1tzZWxmLm93bmVySW5kZXhbX293bmVyUmVtb3ZpbmddXSA9IHNlbGYub3duZXJzW3NlbGYub3duZXJzLmxlbmd0aCAtIDFdOwogICAgICBzZWxmLm93bmVySW5kZXhbc2VsZi5vd25lcnNbc2VsZi5vd25lcnMubGVuZ3RoIC0gMV1dID0gc2VsZi5vd25lckluZGV4W19vd25lclJlbW92aW5nXTsKICAgICAgc2VsZi5vd25lckluZGV4W19vd25lclJlbW92aW5nXSA9IDA7CiAgICAgIHNlbGYub3duZXJzLmxlbmd0aC0tOwogICAgICBkZWxldGUgc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfbnVtYmVyXS5kYXRhOwogICAgICBMb2dPd25lclJlbW92ZWQoX293bmVyUmVtb3ZpbmcpOwogICAgfSBlbHNlIHsKICAgICAgaWYoc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfbnVtYmVyXS5kYXRhLmxlbmd0aCA9PSAwKQogICAgICAgIHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX251bWJlcl0uZGF0YSA9IF9kYXRhOwoKICAgICAgdWludCBjb25maXJtc05lZWRlZCA9IGNhbGNDb25maXJtc05lZWRlZChzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW19udW1iZXJdLmNvbmZpcm1SZXF1aXJlZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW19udW1iZXJdLmNvbmZpcm1Db3VudCk7CiAgICAgIExvZ1RyYW5zYWN0aW9uQ29uZmlybWVkKF9pZCwgbXNnLnNlbmRlciwgY29uZmlybXNOZWVkZWQpOwogICAgfQoKICAgIHJldHVybiAodHJ1ZSxfaWQpOwoJfQoKICAvLy8gQGRldiBDaGFuZ2VzIHJlcXVpcmVkIHNpZ3MgdG8gY2hhbmdlIHdhbGxldCBwYXJhbWV0ZXJzCiAgLy8vIEBwYXJhbSBzZWxmIFdhbGxldCBpbiBjb250cmFjdCBzdG9yYWdlCiAgLy8vIEBwYXJhbSBfcmVxdWlyZWRBZG1pbiBUaGUgbmV3IHNpZ25hdHVyZSByZXF1aXJlbWVudAogIC8vLyBAcGFyYW0gX2NvbmZpcm0gVHJ1ZSBpZiBjb25maXJtaW5nLCBmYWxzZSBpZiByZXZva2luZyBjb25maXJtYXRpb24KICAvLy8gQHBhcmFtIF9kYXRhIE1lc3NhZ2UgZGF0YSBwYXNzZWQgZnJvbSB3YWxsZXQgY29udHJhY3QKICAvLy8gQHJldHVybiBib29sIFJldHVybnMgdHJ1ZSBpZiBzdWNjZXNzZnVsLCBmYWxzZSBvdGhlcndpc2UKICAvLy8gQHJldHVybiBieXRlczMyIFJldHVybnMgdGhlIHR4IElELCBjYW4gYmUgdXNlZCBmb3IgY29uZmlybS9yZXZva2UgZnVuY3Rpb25zCiAgZnVuY3Rpb24gY2hhbmdlUmVxdWlyZWRBZG1pbihXYWxsZXRNYWluTGliLldhbGxldERhdGEgc3RvcmFnZSBzZWxmLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdWludCBfcmVxdWlyZWRBZG1pbiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJvb2wgX2NvbmZpcm0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBieXRlcyBfZGF0YSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybnMgKGJvb2wsYnl0ZXMzMikKICB7CiAgICBieXRlczMyIF9pZCA9IHNoYTMoImNoYW5nZVJlcXVpcmVkQWRtaW4iLF9yZXF1aXJlZEFkbWluKTsKICAgIHVpbnQgX251bWJlciA9IHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF0ubGVuZ3RoOwoKICAgIGlmKG1zZy5zZW5kZXIgIT0gYWRkcmVzcyh0aGlzKSl7CiAgICAgIGJvb2wgYWxsR29vZDsKCiAgICAgIGlmKCFfY29uZmlybSkgewogICAgICAgIGFsbEdvb2QgPSBzZWxmLnJldm9rZUNvbmZpcm0oX2lkKTsKICAgICAgICByZXR1cm4gKGFsbEdvb2QsX2lkKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZihfbnVtYmVyID09IDAgfHwgc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfbnVtYmVyIC0gMV0uc3VjY2Vzcyl7CiAgICAgICAgICByZXF1aXJlKHNlbGYub3duZXJJbmRleFttc2cuc2VuZGVyXSA+IDApOwogICAgICAgICAgYWxsR29vZCA9IGNoZWNrUmVxdWlyZWRDaGFuZ2UoX3JlcXVpcmVkQWRtaW4sIHNlbGYub3duZXJzLmxlbmd0aCk7CiAgICAgICAgICBpZighYWxsR29vZCkKICAgICAgICAgICAgcmV0dXJuIChmYWxzZSwwKTsKCiAgICAgICAgICBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdLmxlbmd0aCsrOwogICAgICAgICAgc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfbnVtYmVyXS5jb25maXJtUmVxdWlyZWQgPSBzZWxmLnJlcXVpcmVkQWRtaW47CiAgICAgICAgICBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW19udW1iZXJdLmRheSA9IG5vdyAvIDEgZGF5czsKICAgICAgICAgIHNlbGYudHJhbnNhY3Rpb25zW25vdyAvIDEgZGF5c10ucHVzaChfaWQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBfbnVtYmVyLS07CiAgICAgICAgICBhbGxHb29kID0gc2VsZi5jaGVja05vdENvbmZpcm1lZChfaWQsIF9udW1iZXIpOwogICAgICAgICAgaWYoIWFsbEdvb2QpCiAgICAgICAgICAgIHJldHVybiAoZmFsc2UsX2lkKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX251bWJlcl0uY29uZmlybWVkT3duZXJzLnB1c2godWludChtc2cuc2VuZGVyKSk7CiAgICAgIHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX251bWJlcl0uY29uZmlybUNvdW50Kys7CiAgICB9IGVsc2UgewogICAgICBfbnVtYmVyLS07CiAgICB9CgogICAgaWYoc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfbnVtYmVyXS5jb25maXJtQ291bnQgPT0KICAgICAgc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfbnVtYmVyXS5jb25maXJtUmVxdWlyZWQpCiAgICB7CiAgICAgIHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX251bWJlcl0uc3VjY2VzcyA9IHRydWU7CiAgICAgIHNlbGYucmVxdWlyZWRBZG1pbiA9IF9yZXF1aXJlZEFkbWluOwogICAgICBkZWxldGUgc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfbnVtYmVyXS5kYXRhOwogICAgICBMb2dSZXF1aXJlbWVudENoYW5nZShfcmVxdWlyZWRBZG1pbik7CiAgICB9IGVsc2UgewogICAgICBpZihzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW19udW1iZXJdLmRhdGEubGVuZ3RoID09IDApCiAgICAgICAgc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfbnVtYmVyXS5kYXRhID0gX2RhdGE7CgogICAgICB1aW50IGNvbmZpcm1zTmVlZGVkID0gY2FsY0NvbmZpcm1zTmVlZGVkKHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX251bWJlcl0uY29uZmlybVJlcXVpcmVkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX251bWJlcl0uY29uZmlybUNvdW50KTsKICAgICAgTG9nVHJhbnNhY3Rpb25Db25maXJtZWQoX2lkLCBtc2cuc2VuZGVyLCBjb25maXJtc05lZWRlZCk7CiAgICB9CgogICAgcmV0dXJuICh0cnVlLF9pZCk7Cgl9CgogIC8vLyBAZGV2IENoYW5nZXMgcmVxdWlyZWQgc2lncyBmb3IgbWFqb3IgdHJhbnNhY3Rpb25zCiAgLy8vIEBwYXJhbSBzZWxmIFdhbGxldCBpbiBjb250cmFjdCBzdG9yYWdlCiAgLy8vIEBwYXJhbSBfcmVxdWlyZWRNYWpvciBUaGUgbmV3IHNpZ25hdHVyZSByZXF1aXJlbWVudAogIC8vLyBAcGFyYW0gX2NvbmZpcm0gVHJ1ZSBpZiBjb25maXJtaW5nLCBmYWxzZSBpZiByZXZva2luZyBjb25maXJtYXRpb24KICAvLy8gQHBhcmFtIF9kYXRhIE1lc3NhZ2UgZGF0YSBwYXNzZWQgZnJvbSB3YWxsZXQgY29udHJhY3QKICAvLy8gQHJldHVybiBib29sIFJldHVybnMgdHJ1ZSBpZiBzdWNjZXNzZnVsLCBmYWxzZSBvdGhlcndpc2UKICAvLy8gQHJldHVybiBieXRlczMyIFJldHVybnMgdGhlIHR4IElELCBjYW4gYmUgdXNlZCBmb3IgY29uZmlybS9yZXZva2UgZnVuY3Rpb25zCiAgZnVuY3Rpb24gY2hhbmdlUmVxdWlyZWRNYWpvcihXYWxsZXRNYWluTGliLldhbGxldERhdGEgc3RvcmFnZSBzZWxmLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdWludCBfcmVxdWlyZWRNYWpvciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJvb2wgX2NvbmZpcm0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBieXRlcyBfZGF0YSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybnMgKGJvb2wsYnl0ZXMzMikKICB7CiAgICBieXRlczMyIF9pZCA9IHNoYTMoImNoYW5nZVJlcXVpcmVkTWFqb3IiLF9yZXF1aXJlZE1ham9yKTsKICAgIHVpbnQgX251bWJlciA9IHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF0ubGVuZ3RoOwoKICAgIGlmKG1zZy5zZW5kZXIgIT0gYWRkcmVzcyh0aGlzKSl7CiAgICAgIGJvb2wgYWxsR29vZDsKCiAgICAgIGlmKCFfY29uZmlybSkgewogICAgICAgIGFsbEdvb2QgPSBzZWxmLnJldm9rZUNvbmZpcm0oX2lkKTsKICAgICAgICByZXR1cm4gKGFsbEdvb2QsX2lkKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZihfbnVtYmVyID09IDAgfHwgc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfbnVtYmVyIC0gMV0uc3VjY2Vzcyl7CiAgICAgICAgICByZXF1aXJlKHNlbGYub3duZXJJbmRleFttc2cuc2VuZGVyXSA+IDApOwogICAgICAgICAgYWxsR29vZCA9IGNoZWNrUmVxdWlyZWRDaGFuZ2UoX3JlcXVpcmVkTWFqb3IsIHNlbGYub3duZXJzLmxlbmd0aCk7CiAgICAgICAgICBpZighYWxsR29vZCkKICAgICAgICAgICAgcmV0dXJuIChmYWxzZSwwKTsKCiAgICAgICAgICBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdLmxlbmd0aCsrOwogICAgICAgICAgc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfbnVtYmVyXS5jb25maXJtUmVxdWlyZWQgPSBzZWxmLnJlcXVpcmVkQWRtaW47CiAgICAgICAgICBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW19udW1iZXJdLmRheSA9IG5vdyAvIDEgZGF5czsKICAgICAgICAgIHNlbGYudHJhbnNhY3Rpb25zW25vdyAvIDEgZGF5c10ucHVzaChfaWQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBfbnVtYmVyLS07CiAgICAgICAgICBhbGxHb29kID0gc2VsZi5jaGVja05vdENvbmZpcm1lZChfaWQsIF9udW1iZXIpOwogICAgICAgICAgaWYoIWFsbEdvb2QpCiAgICAgICAgICAgIHJldHVybiAoZmFsc2UsX2lkKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX251bWJlcl0uY29uZmlybWVkT3duZXJzLnB1c2godWludChtc2cuc2VuZGVyKSk7CiAgICAgIHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX251bWJlcl0uY29uZmlybUNvdW50Kys7CiAgICB9IGVsc2UgewogICAgICBfbnVtYmVyLS07CiAgICB9CgogICAgaWYoc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfbnVtYmVyXS5jb25maXJtQ291bnQgPT0KICAgICAgIHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX251bWJlcl0uY29uZmlybVJlcXVpcmVkKQogICAgewogICAgICBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW19udW1iZXJdLnN1Y2Nlc3MgPSB0cnVlOwogICAgICBzZWxmLnJlcXVpcmVkTWFqb3IgPSBfcmVxdWlyZWRNYWpvcjsKICAgICAgZGVsZXRlIHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX251bWJlcl0uZGF0YTsKICAgICAgTG9nUmVxdWlyZW1lbnRDaGFuZ2UoX3JlcXVpcmVkTWFqb3IpOwogICAgfSBlbHNlIHsKICAgICAgaWYoc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfbnVtYmVyXS5kYXRhLmxlbmd0aCA9PSAwKQogICAgICAgIHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX251bWJlcl0uZGF0YSA9IF9kYXRhOwoKICAgICAgdWludCBjb25maXJtc05lZWRlZCA9IGNhbGNDb25maXJtc05lZWRlZChzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW19udW1iZXJdLmNvbmZpcm1SZXF1aXJlZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW19udW1iZXJdLmNvbmZpcm1Db3VudCk7CiAgICAgIExvZ1RyYW5zYWN0aW9uQ29uZmlybWVkKF9pZCwgbXNnLnNlbmRlciwgY29uZmlybXNOZWVkZWQpOwogICAgfQoKICAgIHJldHVybiAodHJ1ZSxfaWQpOwoJfQoKICAvLy8gQGRldiBDaGFuZ2VzIHJlcXVpcmVkIHNpZ3MgZm9yIG1pbm9yIHRyYW5zYWN0aW9ucwogIC8vLyBAcGFyYW0gc2VsZiBXYWxsZXQgaW4gY29udHJhY3Qgc3RvcmFnZQogIC8vLyBAcGFyYW0gX3JlcXVpcmVkTWlub3IgVGhlIG5ldyBzaWduYXR1cmUgcmVxdWlyZW1lbnQKICAvLy8gQHBhcmFtIF9jb25maXJtIFRydWUgaWYgY29uZmlybWluZywgZmFsc2UgaWYgcmV2b2tpbmcgY29uZmlybWF0aW9uCiAgLy8vIEBwYXJhbSBfZGF0YSBNZXNzYWdlIGRhdGEgcGFzc2VkIGZyb20gd2FsbGV0IGNvbnRyYWN0CiAgLy8vIEByZXR1cm4gYm9vbCBSZXR1cm5zIHRydWUgaWYgc3VjY2Vzc2Z1bCwgZmFsc2Ugb3RoZXJ3aXNlCiAgLy8vIEByZXR1cm4gYnl0ZXMzMiBSZXR1cm5zIHRoZSB0eCBJRCwgY2FuIGJlIHVzZWQgZm9yIGNvbmZpcm0vcmV2b2tlIGZ1bmN0aW9ucwogIGZ1bmN0aW9uIGNoYW5nZVJlcXVpcmVkTWlub3IoV2FsbGV0TWFpbkxpYi5XYWxsZXREYXRhIHN0b3JhZ2Ugc2VsZiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVpbnQgX3JlcXVpcmVkTWlub3IsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBib29sIF9jb25maXJtLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnl0ZXMgX2RhdGEpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm5zIChib29sLGJ5dGVzMzIpCiAgewogICAgYnl0ZXMzMiBfaWQgPSBzaGEzKCJjaGFuZ2VSZXF1aXJlZE1pbm9yIixfcmVxdWlyZWRNaW5vcik7CiAgICB1aW50IF9udW1iZXIgPSBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdLmxlbmd0aDsKCiAgICBpZihtc2cuc2VuZGVyICE9IGFkZHJlc3ModGhpcykpewogICAgICBib29sIGFsbEdvb2Q7CgogICAgICBpZighX2NvbmZpcm0pIHsKICAgICAgICBhbGxHb29kID0gc2VsZi5yZXZva2VDb25maXJtKF9pZCk7CiAgICAgICAgcmV0dXJuIChhbGxHb29kLF9pZCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYoX251bWJlciA9PSAwIHx8IHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX251bWJlciAtIDFdLnN1Y2Nlc3MpewogICAgICAgICAgcmVxdWlyZShzZWxmLm93bmVySW5kZXhbbXNnLnNlbmRlcl0gPiAwKTsKICAgICAgICAgIGFsbEdvb2QgPSBjaGVja1JlcXVpcmVkQ2hhbmdlKF9yZXF1aXJlZE1pbm9yLCBzZWxmLm93bmVycy5sZW5ndGgpOwogICAgICAgICAgaWYoIWFsbEdvb2QpCiAgICAgICAgICAgIHJldHVybiAoZmFsc2UsMCk7CgogICAgICAgICAgc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXS5sZW5ndGgrKzsKICAgICAgICAgIHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX251bWJlcl0uY29uZmlybVJlcXVpcmVkID0gc2VsZi5yZXF1aXJlZEFkbWluOwogICAgICAgICAgc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfbnVtYmVyXS5kYXkgPSBub3cgLyAxIGRheXM7CiAgICAgICAgICBzZWxmLnRyYW5zYWN0aW9uc1tub3cgLyAxIGRheXNdLnB1c2goX2lkKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgX251bWJlci0tOwogICAgICAgICAgYWxsR29vZCA9IHNlbGYuY2hlY2tOb3RDb25maXJtZWQoX2lkLCBfbnVtYmVyKTsKICAgICAgICAgIGlmKCFhbGxHb29kKQogICAgICAgICAgICByZXR1cm4gKGZhbHNlLF9pZCk7CiAgICAgICAgfQogICAgICB9CgogICAgICBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW19udW1iZXJdLmNvbmZpcm1lZE93bmVycy5wdXNoKHVpbnQobXNnLnNlbmRlcikpOwogICAgICBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW19udW1iZXJdLmNvbmZpcm1Db3VudCsrOwogICAgfSBlbHNlIHsKICAgICAgX251bWJlci0tOwogICAgfQoKICAgIGlmKHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX251bWJlcl0uY29uZmlybUNvdW50ID09CiAgICAgICBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW19udW1iZXJdLmNvbmZpcm1SZXF1aXJlZCkKICAgIHsKICAgICAgc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfbnVtYmVyXS5zdWNjZXNzID0gdHJ1ZTsKICAgICAgc2VsZi5yZXF1aXJlZE1pbm9yID0gX3JlcXVpcmVkTWlub3I7CiAgICAgIGRlbGV0ZSBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW19udW1iZXJdLmRhdGE7CiAgICAgIExvZ1JlcXVpcmVtZW50Q2hhbmdlKF9yZXF1aXJlZE1pbm9yKTsKICAgIH0gZWxzZSB7CiAgICAgIGlmKHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX251bWJlcl0uZGF0YS5sZW5ndGggPT0gMCkKICAgICAgICBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW19udW1iZXJdLmRhdGEgPSBfZGF0YTsKCiAgICAgIHVpbnQgY29uZmlybXNOZWVkZWQgPSBjYWxjQ29uZmlybXNOZWVkZWQoc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfbnVtYmVyXS5jb25maXJtUmVxdWlyZWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfbnVtYmVyXS5jb25maXJtQ291bnQpOwogICAgICBMb2dUcmFuc2FjdGlvbkNvbmZpcm1lZChfaWQsIG1zZy5zZW5kZXIsIGNvbmZpcm1zTmVlZGVkKTsKICAgIH0KCiAgICByZXR1cm4gKHRydWUsX2lkKTsKCX0KCiAgLy8vIEBkZXYgQ2hhbmdlcyB0aHJlc2hvbGQgZm9yIG1ham9yIHRyYW5zYWN0aW9uIGRheSBzcGVuZCBwZXIgdG9rZW4KICAvLy8gQHBhcmFtIHNlbGYgV2FsbGV0IGluIGNvbnRyYWN0IHN0b3JhZ2UKICAvLy8gQHBhcmFtIF90b2tlbiBBZGRyZXNzIG9mIHRva2VuLCBldGhlciBpcyAwCiAgLy8vIEBwYXJhbSBfbWFqb3JUaHJlc2hvbGQgTmV3IHRocmVzaG9sZAogIC8vLyBAcGFyYW0gX2NvbmZpcm0gVHJ1ZSBpZiBjb25maXJtaW5nLCBmYWxzZSBpZiByZXZva2luZyBjb25maXJtYXRpb24KICAvLy8gQHBhcmFtIF9kYXRhIE1lc3NhZ2UgZGF0YSBwYXNzZWQgZnJvbSB3YWxsZXQgY29udHJhY3QKICAvLy8gQHJldHVybiBib29sIFJldHVybnMgdHJ1ZSBpZiBzdWNjZXNzZnVsLCBmYWxzZSBvdGhlcndpc2UKICAvLy8gQHJldHVybiBieXRlczMyIFJldHVybnMgdGhlIHR4IElELCBjYW4gYmUgdXNlZCBmb3IgY29uZmlybS9yZXZva2UgZnVuY3Rpb25zCiAgZnVuY3Rpb24gY2hhbmdlTWFqb3JUaHJlc2hvbGQoV2FsbGV0TWFpbkxpYi5XYWxsZXREYXRhIHN0b3JhZ2Ugc2VsZiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRyZXNzIF90b2tlbiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1aW50IF9tYWpvclRocmVzaG9sZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBib29sIF9jb25maXJtLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJ5dGVzIF9kYXRhKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybnMgKGJvb2wsYnl0ZXMzMikKICB7CiAgICBieXRlczMyIF9pZCA9IHNoYTMoImNoYW5nZU1ham9yVGhyZXNob2xkIiwgX3Rva2VuLCBfbWFqb3JUaHJlc2hvbGQpOwogICAgdWludCBfbnVtYmVyID0gc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXS5sZW5ndGg7CgogICAgaWYobXNnLnNlbmRlciAhPSBhZGRyZXNzKHRoaXMpKXsKICAgICAgYm9vbCBhbGxHb29kOwoKICAgICAgaWYoIV9jb25maXJtKSB7CiAgICAgICAgYWxsR29vZCA9IHNlbGYucmV2b2tlQ29uZmlybShfaWQpOwogICAgICAgIHJldHVybiAoYWxsR29vZCxfaWQpOwogICAgICB9IGVsc2UgewogICAgICAgIGlmKF9udW1iZXIgPT0gMCB8fCBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW19udW1iZXIgLSAxXS5zdWNjZXNzKXsKICAgICAgICAgIHJlcXVpcmUoc2VsZi5vd25lckluZGV4W21zZy5zZW5kZXJdID4gMCk7CgogICAgICAgICAgc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXS5sZW5ndGgrKzsKICAgICAgICAgIHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX251bWJlcl0uY29uZmlybVJlcXVpcmVkID0gc2VsZi5yZXF1aXJlZEFkbWluOwogICAgICAgICAgc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfbnVtYmVyXS5kYXkgPSBub3cgLyAxIGRheXM7CiAgICAgICAgICBzZWxmLnRyYW5zYWN0aW9uc1tub3cgLyAxIGRheXNdLnB1c2goX2lkKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgX251bWJlci0tOwogICAgICAgICAgYWxsR29vZCA9IHNlbGYuY2hlY2tOb3RDb25maXJtZWQoX2lkLCBfbnVtYmVyKTsKICAgICAgICAgIGlmKCFhbGxHb29kKQogICAgICAgICAgICByZXR1cm4gKGZhbHNlLF9pZCk7CiAgICAgICAgfQogICAgICB9CgogICAgICBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW19udW1iZXJdLmNvbmZpcm1lZE93bmVycy5wdXNoKHVpbnQobXNnLnNlbmRlcikpOwogICAgICBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW19udW1iZXJdLmNvbmZpcm1Db3VudCsrOwogICAgfSBlbHNlIHsKICAgICAgX251bWJlci0tOwogICAgfQoKICAgIGlmKHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX251bWJlcl0uY29uZmlybUNvdW50ID09CiAgICAgICBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW19udW1iZXJdLmNvbmZpcm1SZXF1aXJlZCkKICAgIHsKICAgICAgc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfbnVtYmVyXS5zdWNjZXNzID0gdHJ1ZTsKICAgICAgc2VsZi5tYWpvclRocmVzaG9sZFtfdG9rZW5dID0gX21ham9yVGhyZXNob2xkOwogICAgICBkZWxldGUgc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfbnVtYmVyXS5kYXRhOwogICAgICBMb2dUaHJlc2hvbGRDaGFuZ2UoX3Rva2VuLCBfbWFqb3JUaHJlc2hvbGQpOwogICAgfSBlbHNlIHsKICAgICAgaWYoc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfbnVtYmVyXS5kYXRhLmxlbmd0aCA9PSAwKQogICAgICAgIHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX251bWJlcl0uZGF0YSA9IF9kYXRhOwoKICAgICAgdWludCBjb25maXJtc05lZWRlZCA9IGNhbGNDb25maXJtc05lZWRlZChzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW19udW1iZXJdLmNvbmZpcm1SZXF1aXJlZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW19udW1iZXJdLmNvbmZpcm1Db3VudCk7CiAgICAgIExvZ1RyYW5zYWN0aW9uQ29uZmlybWVkKF9pZCwgbXNnLnNlbmRlciwgY29uZmlybXNOZWVkZWQpOwogICAgfQoKICAgIHJldHVybiAodHJ1ZSxfaWQpOwoJfQp9CgpwcmFnbWEgc29saWRpdHkgXjAuNC4xMzsKCi8qKgogKiBAdGl0bGUgV2FsbGV0IE1haW4gTGlicmFyeQogKiBAYXV0aG9yIE1ham9vbHIuaW8KICoKICogdmVyc2lvbiAxLjAuMAogKiBDb3B5cmlnaHQgKGMpIDIwMTcgTWFqb29sciwgTExDCiAqIFRoZSBNSVQgTGljZW5zZSAoTUlUKQogKiBodHRwczovL2dpdGh1Yi5jb20vTWFqb29sci9ldGhlcmV1bS1saWJyYXJpZXMvYmxvYi9tYXN0ZXIvTElDRU5TRQogKgogKiBUaGUgV2FsbGV0IExpYnJhcnkgZmFtaWx5IGlzIGluc3BpcmVkIGJ5IHRoZSBtdWx0aXNpZyB3YWxsZXRzIGJ1aWx0IGJ5IENvbnNlbnN5cwogKiBhdCBodHRwczovL2dpdGh1Yi5jb20vQ29uc2VuU3lzL011bHRpU2lnV2FsbGV0IGFuZCBQYXJpdHkgYXQKICogaHR0cHM6Ly9naXRodWIuY29tL3Bhcml0eXRlY2gvY29udHJhY3RzL2Jsb2IvbWFzdGVyL1dhbGxldC5zb2wgd2l0aCBhZGRlZAogKiBmdW5jdGlvbmFsaXR5LiBNYWpvb2xyIHdvcmtzIG9uIG9wZW4gc291cmNlIHByb2plY3RzIGluIHRoZSBFdGhlcmV1bQogKiBjb21tdW5pdHkgd2l0aCB0aGUgcHVycG9zZSBvZiB0ZXN0aW5nLCBkb2N1bWVudGluZywgYW5kIGRlcGxveWluZyByZXVzYWJsZQogKiBjb2RlIG9udG8gdGhlIGJsb2NrY2hhaW4gdG8gaW1wcm92ZSBzZWN1cml0eSBhbmQgdXNhYmlsaXR5IG9mIHNtYXJ0IGNvbnRyYWN0cy4KICogTWFqb29sciBhbHNvIHN0cml2ZXMgdG8gZWR1Y2F0ZSBub24tcHJvZml0cywgc2Nob29scywgYW5kIG90aGVyIGNvbW11bml0eQogKiBtZW1iZXJzIGFib3V0IHRoZSBhcHBsaWNhdGlvbiBvZiBibG9ja2NoYWluIHRlY2hub2xvZ3kuIEZvciBmdXJ0aGVyCiAqIGluZm9ybWF0aW9uOiBtYWpvb2xyLmlvLCBjb25zZW5zeXMubmV0LCBwYXJpdHl0ZWNoLmlvCiAqCiAqIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTCiAqIE9SIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YKICogTUVSQ0hBTlRBQklMSVRZLCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULgogKiBJTiBOTyBFVkVOVCBTSEFMTCBUSEUgQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWQogKiBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULAogKiBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLCBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRQogKiBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOIFRIRSBTT0ZUV0FSRS4KICovCgpsaWJyYXJ5IFdhbGxldE1haW5MaWIgewogIHVzaW5nIEFycmF5MjU2TGliIGZvciB1aW50MjU2W107CiAgdXNpbmcgQmFzaWNNYXRoTGliIGZvciB1aW50OwoKICBzdHJ1Y3QgV2FsbGV0RGF0YSB7CiAgICB1aW50IG1heE93bmVyczsgLy9NYXhpbXVtIHdhbGxldCBvd25lcnMsIHNob3VsZCBiZSA1MAogICAgYWRkcmVzc1tdIG93bmVyczsgLy9BcnJheSBvZiBhbGwgb3duZXJzCiAgICB1aW50IHJlcXVpcmVkQWRtaW47IC8vTnVtYmVyIG9mIHNpZ3MgcmVxdWlyZWQgZm9yIGFkbWluaXN0cmF0aXZlIGNoYW5nZXMKICAgIHVpbnQgcmVxdWlyZWRNYWpvcjsgLy9OdW1iZXIgb2Ygc2lncyByZXF1aXJlZCBmb3IgbWFqb3IgdHJhbnNhY3Rpb25zCiAgICB1aW50IHJlcXVpcmVkTWlub3I7IC8vTnVtYmVyIG9mIHNpZ3MgcmVxdWlyZWQgZm9yIG1pbm9yIHRyYW5zYWN0aW9ucwoKICAgIC8vIFRoZSBhbW91bnQgb2YgYSB0b2tlbiBzcGVudCBwZXIgZGF5LCBldGhlciBpcyBhdCBhZGRyZXNzIG1hcHBpbmcgMCwKICAgIC8vIGFsbCBvdGhlciB0b2tlbnMgZGVmaW5lZCBieSBhZGRyZXNzLiB1aW50WzBdIGNvcnJlc3BvbmRzIHRvIHRoZSBjdXJyZW50CiAgICAvLyBkYXksICB1aW50WzFdIGlzIHRoZSBzcGVuZCBhbW91bnQKICAgIG1hcHBpbmcgKGFkZHJlc3MgPT4gdWludFsyXSkgY3VycmVudFNwZW5kOwogICAgLy9UaGUgZGF5IHNwZW5kIHRocmVzaG9sZCBmb3IgdHJhbnNhY3Rpb25zIHRvIGJlIG1ham9yLCBldGhlciBhdCAwLCBhbGwgb3RoZXJzIGJ5IGFkZHJlc3MKICAgIG1hcHBpbmcgKGFkZHJlc3MgPT4gdWludCkgbWFqb3JUaHJlc2hvbGQ7CiAgICAvL0FycmF5IG9mIHRyYW5zYWN0aW9ucyBwZXIgZGF5LCB1aW50IGlzIHRoZSBkYXkgdGltZXN0YW1wLCBieXRlczMyIGlzIHRoZSB0cmFuc2FjdGlvbiBpZAogICAgbWFwcGluZyAodWludCA9PiBieXRlczMyW10pIHRyYW5zYWN0aW9uczsKICAgIC8vVHJhY2tzIHRoZSBpbmRleCBvZiBlYWNoIG93bmVyIGluIHRoZSBvd25lcnMgQXJyYXkKICAgIG1hcHBpbmcgKGFkZHJlc3MgPT4gdWludCkgb3duZXJJbmRleDsKICAgIC8vQXJyYXkgb2YgVHJhbnNhY3Rpb24ncyBieSBpZCwgbmV3IHR4J3Mgd2l0aCBleGFjdCBpbnB1dHMgYXMgcHJldmlvdXMgdHggd2lsbCBhZGQgdG8gYXJyYXkKICAgIG1hcHBpbmcgKGJ5dGVzMzIgPT4gVHJhbnNhY3Rpb25bXSkgdHJhbnNhY3Rpb25JbmZvOwoKICB9CgogIHN0cnVjdCBUcmFuc2FjdGlvbiB7CiAgICB1aW50IGRheTsgLy9UaW1lc3RhbXAgb2YgdGhlIGRheSBpbml0aWFsaXplZAogICAgdWludCB2YWx1ZTsgLy9BbW91bnQgb2YgZXRoZXIgYmVpbmcgc2VudAogICAgYWRkcmVzcyB0b2tlbkFkcmVzczsgLy9BZGRyZXNzIG9mIHRva2VuIHRyYW5zZmVycmVkCiAgICB1aW50IGFtb3VudDsgLy9BbW91bnQgb2YgdG9rZW5zIHRyYW5zZmVycmVkCiAgICBieXRlcyBkYXRhOyAvL1RlbXAgbG9jYXRpb24gZm9yIHBlbmRpbmcgdHJhbnNhY3Rpb25zLCBlcmFzZWQgYWZ0ZXIgZmluYWwgY29uZmlybWF0aW9uCiAgICB1aW50MjU2W10gY29uZmlybWVkT3duZXJzOyAvL0FycmF5IG9mIG93bmVycyBjb25maXJtaW5nIHRyYW5zYWN0aW9uCiAgICB1aW50IGNvbmZpcm1Db3VudDsgLy9UcmFja3MgdGhlIG51bWJlciBvZiBjb25maXJtcwogICAgdWludCBjb25maXJtUmVxdWlyZWQ7IC8vTnVtYmVyIG9mIHNpZ3MgcmVxdWlyZWQgZm9yIHRoaXMgdHJhbnNhY3Rpb24KICAgIGJvb2wgc3VjY2VzczsgLy9UcnVlIGFmdGVyIGZpbmFsIGNvbmZpcm1hdGlvbgogIH0KCiAgLypFdmVudHMqLwogIGV2ZW50IExvZ1Jldm9rZU5vdGljZShieXRlczMyIHR4aWQsIGFkZHJlc3Mgc2VuZGVyLCB1aW50IGNvbmZpcm1zTmVlZGVkKTsKICBldmVudCBMb2dUcmFuc2FjdGlvbkZhaWxlZChieXRlczMyIHR4aWQsIGFkZHJlc3Mgc2VuZGVyKTsKICBldmVudCBMb2dUcmFuc2FjdGlvbkNvbmZpcm1lZChieXRlczMyIHR4aWQsIGFkZHJlc3Mgc2VuZGVyLCB1aW50IGNvbmZpcm1zTmVlZGVkKTsKICBldmVudCBMb2dUcmFuc2FjdGlvbkNvbXBsZXRlKGJ5dGVzMzIgdHhpZCwgYWRkcmVzcyB0YXJnZXQsIHVpbnQgdmFsdWUsIGJ5dGVzIGRhdGEpOwogIGV2ZW50IExvZ0NvbnRyYWN0Q3JlYXRlZChhZGRyZXNzIG5ld0NvbnRyYWN0LCB1aW50IHZhbHVlKTsKICBldmVudCBMb2dFcnJNc2coc3RyaW5nIG1zZyk7CgogIC8vLyBAZGV2IENvbnN0cnVjdG9yCiAgLy8vIEBwYXJhbSBzZWxmIFRoZSB3YWxsZXQgaW4gY29udHJhY3Qgc3RvcmFnZQogIC8vLyBAcGFyYW0gX293bmVycyBBcnJheSBvZiBpbml0aWFsIG93bmVycwogIC8vLyBAcGFyYW0gX3JlcXVpcmVkQWRtaW4gU2V0IG51bWJlciBvZiBzaWdzIGZvciBhZG1pbmlzdHJhdGl2ZSB0YXNrcwogIC8vLyBAcGFyYW0gX3JlcXVpcmVkTWFqb3IgU2V0IG51bWJlciBvZiBzaWdzIGZvciBtYWpvciB0eAogIC8vLyBAcGFyYW0gX3JlcXVpcmVkTWlub3IgU2V0IG51bWJlciBvZiBzaWdzIGZvciBtaW5vciB0eAogIC8vLyBAcGFyYW0gX21ham9yVGhyZXNob2xkIFNldCBtYWpvciB0eCB0aHJlc2hvbGQgYW1vdW50IGZvciBldGhlcgogIC8vLyBAcmV0dXJuIFdpbGwgcmV0dXJuIHRydWUgd2hlbiBjb21wbGV0ZQogIGZ1bmN0aW9uIGluaXQoV2FsbGV0RGF0YSBzdG9yYWdlIHNlbGYsCiAgICAgICAgICAgICAgICBhZGRyZXNzW10gX293bmVycywKICAgICAgICAgICAgICAgIHVpbnQgX3JlcXVpcmVkQWRtaW4sCiAgICAgICAgICAgICAgICB1aW50IF9yZXF1aXJlZE1ham9yLAogICAgICAgICAgICAgICAgdWludCBfcmVxdWlyZWRNaW5vciwKICAgICAgICAgICAgICAgIHVpbnQgX21ham9yVGhyZXNob2xkKSByZXR1cm5zIChib29sKQogIHsKICAgIHJlcXVpcmUoc2VsZi5vd25lcnMubGVuZ3RoID09IDApOwogICAgcmVxdWlyZShfb3duZXJzLmxlbmd0aCA+PSBfcmVxdWlyZWRBZG1pbiAmJiBfcmVxdWlyZWRBZG1pbiA+IDApOwogICAgcmVxdWlyZShfb3duZXJzLmxlbmd0aCA+PSBfcmVxdWlyZWRNYWpvciAmJiBfcmVxdWlyZWRNYWpvciA+IDApOwogICAgcmVxdWlyZShfb3duZXJzLmxlbmd0aCA+PSBfcmVxdWlyZWRNaW5vciAmJiBfcmVxdWlyZWRNaW5vciA+IDApOwogICAgc2VsZi5vd25lcnMucHVzaCgwKTsgLy9MZWF2ZSBpbmRleC0wIGVtcHR5IGZvciBlYXNpZXIgb3duZXIgY2hlY2tzCgogICAgZm9yICh1aW50IGk9MDsgaTxfb3duZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHJlcXVpcmUoX293bmVyc1tpXSAhPSAwKTsKICAgICAgc2VsZi5vd25lcnMucHVzaChfb3duZXJzW2ldKTsKICAgICAgc2VsZi5vd25lckluZGV4W19vd25lcnNbaV1dID0gaSsxOwogICAgfQogICAgc2VsZi5yZXF1aXJlZEFkbWluID0gX3JlcXVpcmVkQWRtaW47CiAgICBzZWxmLnJlcXVpcmVkTWFqb3IgPSBfcmVxdWlyZWRNYWpvcjsKICAgIHNlbGYucmVxdWlyZWRNaW5vciA9IF9yZXF1aXJlZE1pbm9yOwogICAgc2VsZi5tYXhPd25lcnMgPSA1MDsgLy9MaW1pdHMgdG8gNTAgb3duZXJzLCBzaG91bGQgY3JlYXRlIHdhbGxldCBwb29scyBmb3IgbW9yZSBvd25lcnMKICAgIHNlbGYubWFqb3JUaHJlc2hvbGRbMF0gPSBfbWFqb3JUaHJlc2hvbGQ7IC8vU2V0cyBldGhlciB0aHJlc2hvbGQgYXQgYWRkcmVzcyAwCgogICAgcmV0dXJuIHRydWU7CiAgfQoKICAvKkNoZWNrcyovCgogIC8vLyBAZGV2IFZlcmlmaWVzIGEgY29uZmlybWluZyBvd25lciBoYXMgbm90IGNvbmZpcm1lZCBhbHJlYWR5CiAgLy8vIEBwYXJhbSBzZWxmIENvbnRyYWN0IHdhbGxldCBpbiBzdG9yYWdlCiAgLy8vIEBwYXJhbSBfaWQgSUQgb2YgdGhlIHR4IGJlaW5nIGNoZWNrZWQKICAvLy8gQHBhcmFtIF9udW1iZXIgSW5kZXggbnVtYmVyIG9mIHRoaXMgdHgKICAvLy8gQHJldHVybiBSZXR1cm5zIHRydWUgaWYgY2hlY2sgcGFzc2VzLCBmYWxzZSBvdGhlcndpc2UKICBmdW5jdGlvbiBjaGVja05vdENvbmZpcm1lZChXYWxsZXREYXRhIHN0b3JhZ2Ugc2VsZiwgYnl0ZXMzMiBfaWQsIHVpbnQgX251bWJlcikKICAgICAgICAgICBjb25zdGFudCByZXR1cm5zIChib29sKQogIHsKICAgIHJlcXVpcmUoc2VsZi5vd25lckluZGV4W21zZy5zZW5kZXJdID4gMCk7CiAgICB1aW50IF90eExlbiA9IHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF0ubGVuZ3RoOwoKICAgIGlmKF90eExlbiA9PSAwIHx8IF9udW1iZXIgPj0gX3R4TGVuKXsKICAgICAgTG9nRXJyTXNnKCJUeCBub3QgaW5pdGlhdGVkIik7CiAgICAgIExvZ1RyYW5zYWN0aW9uRmFpbGVkKF9pZCwgbXNnLnNlbmRlcik7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICBpZihzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW19udW1iZXJdLnN1Y2Nlc3MpewogICAgICBMb2dFcnJNc2coIlRyYW5zYWN0aW9uIGFscmVhZHkgY29tcGxldGUiKTsKICAgICAgTG9nVHJhbnNhY3Rpb25GYWlsZWQoX2lkLCBtc2cuc2VuZGVyKTsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIC8vRnVuY3Rpb24gZnJvbSBNYWpvb2xyLmlvIGFycmF5IHV0aWxpdHkgbGlicmFyeQogICAgYm9vbCBmb3VuZDsKICAgIHVpbnQgaW5kZXg7CiAgICAoZm91bmQsIGluZGV4KSA9IHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX251bWJlcl0uY29uZmlybWVkT3duZXJzLmluZGV4T2YodWludChtc2cuc2VuZGVyKSwgZmFsc2UpOwogICAgaWYoZm91bmQpewogICAgICBMb2dFcnJNc2coIk93bmVyIGFscmVhZHkgY29uZmlybWVkIik7CiAgICAgIExvZ1RyYW5zYWN0aW9uRmFpbGVkKF9pZCwgbXNnLnNlbmRlcik7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICByZXR1cm4gdHJ1ZTsKICB9CgogIC8qVXRpbGl0eSBGdW5jdGlvbnMqLwoKICAvLy8gQGRldiBVc2VkIGxhdGVyIHRvIGNhbGN1bGF0ZSB0aGUgbnVtYmVyIG9mIGNvbmZpcm1hdGlvbnMgbmVlZGVkIGZvciB0eAogIC8vLyBAcGFyYW0gX3JlcXVpcmVkIE51bWJlciBvZiBzaWdzIHJlcXVpcmVkCiAgLy8vIEBwYXJhbSBfY291bnQgQ3VycmVudCBudW1iZXIgb2Ygc2lncwogIGZ1bmN0aW9uIGNhbGNDb25maXJtc05lZWRlZCh1aW50IF9yZXF1aXJlZCwgdWludCBfY291bnQpIGNvbnN0YW50IHJldHVybnMgKHVpbnQpewogICAgcmV0dXJuIF9yZXF1aXJlZCAtIF9jb3VudDsKICB9CgogIC8vLyBAZGV2IFVzZWQgdG8gY2hlY2sgaWYgdHggaXMgbW92aW5nIHRva2VucyBhbmQgcGFyc2VzIGFtb3VudAogIC8vLyBAcGFyYW0gX3R4RGF0YSBEYXRhIGZvciBwcm9wb3NlZCB0eAogIC8vLyBAcmV0dXJuIGJvb2wgVHJ1ZSBpZiB0cmFuc2FjdGlvbiBpcyBtb3ZpbmcgdG9rZW5zCiAgLy8vIEByZXR1cm4gdWludCBBbW91bnQgb2YgdG9rZW5zIGludm9sdmVkLCAwIGlmIG5vdCBzcGVuZGluZyB0eAogIGZ1bmN0aW9uIGdldEFtb3VudChieXRlcyBfdHhEYXRhKSBjb25zdGFudCByZXR1cm5zIChib29sLHVpbnQpIHsKICAgIGJ5dGVzMzIgZ2V0U2lnOwogICAgYnl0ZXM0IHNpZzsKICAgIGJ5dGVzNCB0U2lnID0gMHhhOTA1OWNiYjsgLy90cmFuc2ZlciBmdW5jIHNpZ25hdHVyZQogICAgYnl0ZXM0IGFTaWcgPSAweDA5NWVhN2IzOyAvL2FwcHJvdmUgZnVuYyBzaWduYXR1cmUKICAgIGJ5dGVzNCB0ZlNpZyA9IDB4MjNiODcyZGQ7IC8vdHJhbnNmZXJGcm9tIGZ1bmMgc2lnbmF0dXJlCiAgICBib29sIHRyYW5zZmVyOwogICAgYnl0ZXMzMiBfYW1vdW50RGF0YTsKICAgIHVpbnQgX2Ftb3VudDsKCiAgICBhc3NlbWJseSB7IGdldFNpZyA6PSBtbG9hZChhZGQoX3R4RGF0YSwweDIwKSkgfQogICAgc2lnID0gYnl0ZXM0KGdldFNpZyk7CiAgICBpZihzaWcgPT0gIHRTaWcgfHwgc2lnID09IGFTaWcpewogICAgICB0cmFuc2ZlciA9IHRydWU7CiAgICAgIGFzc2VtYmx5IHsgX2Ftb3VudERhdGEgOj0gbWxvYWQoYWRkKF90eERhdGEsMHg0NCkpIH0KICAgICAgX2Ftb3VudCA9IHVpbnQoX2Ftb3VudERhdGEpOwogICAgfSBlbHNlIGlmKHNpZyA9PSB0ZlNpZyl7CiAgICAgIHRyYW5zZmVyID0gdHJ1ZTsKICAgICAgYXNzZW1ibHkgeyBfYW1vdW50RGF0YSA6PSBtbG9hZChhZGQoX3R4RGF0YSwweDY0KSkgfQogICAgICBfYW1vdW50ID0gdWludChfYW1vdW50RGF0YSk7CiAgICB9CiAgICByZXR1cm4gKHRyYW5zZmVyLF9hbW91bnQpOwogIH0KCiAgLy8vIEBkZXYgUmV0cmlldmVzIHNpZyByZXF1aXJlbWVudCBmb3Igc3BlbmRpbmcgdHgKICAvLy8gQHBhcmFtIHNlbGYgQ29udHJhY3Qgd2FsbGV0IGluIHN0b3JhZ2UKICAvLy8gQHBhcmFtIF90byBUYXJnZXQgYWRkcmVzcyBvZiB0cmFuc2FjdGlvbgogIC8vLyBAcGFyYW0gX3ZhbHVlIEFtb3VudCBvZiBldGhlciBzcGVuZAogIC8vLyBAcGFyYW0gX2lzVHJhbnNmZXIgVHJ1ZSBpZiB0cmFuc2ZlcnJpbmcgb3RoZXIgdG9rZW5zLCBmYWxzZSBvdGhlcndpc2UKICAvLy8gQHBhcmFtIF9hbW91bnQgQW1vdW50IG9mIHRva2VucyBiZWluZyB0cmFuc2ZlcnJlZCwgMCBpZiBub3QgYSB0cmFuc2ZlciB0eAogIC8vLyBAcmV0dXJuIHVpbnQgVGhlIHJlcXVpcmVkIHNpZ3MgZm9yIHR4CiAgZnVuY3Rpb24gZ2V0UmVxdWlyZWQoV2FsbGV0RGF0YSBzdG9yYWdlIHNlbGYsCiAgICAgICAgICAgICAgICAgICAgICAgYWRkcmVzcyBfdG8sCiAgICAgICAgICAgICAgICAgICAgICAgdWludCBfdmFsdWUsCiAgICAgICAgICAgICAgICAgICAgICAgYm9vbCBfaXNUcmFuc2ZlciwKICAgICAgICAgICAgICAgICAgICAgICB1aW50IF9hbW91bnQpCiAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJucyAodWludCkKICB7CiAgICBib29sIGVycjsKICAgIHVpbnQgcmVzOwogICAgYm9vbCBtYWpvciA9IHRydWU7CiAgICAvL1Jlc2V0IHNwZW5kIGlmIHRoaXMgaXMgZmlyc3QgY2hlY2sgb2YgdGhlIGRheQogICAgaWYoKG5vdy8gMSBkYXlzKSA+IHNlbGYuY3VycmVudFNwZW5kWzBdWzBdKXsKICAgICAgc2VsZi5jdXJyZW50U3BlbmRbMF1bMF0gPSBub3cgLyAxIGRheXM7CiAgICAgIHNlbGYuY3VycmVudFNwZW5kWzBdWzFdID0gMDsKICAgIH0KCiAgICAoZXJyLCByZXMpID0gc2VsZi5jdXJyZW50U3BlbmRbMF1bMV0ucGx1cyhfdmFsdWUpOwogICAgaWYoZXJyKXsKICAgICAgTG9nRXJyTXNnKCJPdmVyZmxvdyBldGggc3BlbmQiKTsKICAgICAgcmV0dXJuIDA7CiAgICB9CgogICAgaWYocmVzIDwgc2VsZi5tYWpvclRocmVzaG9sZFswXSkKICAgICAgbWFqb3IgPSBmYWxzZTsKCiAgICBpZihfdG8gIT0gMCAmJiBfaXNUcmFuc2Zlcil7CiAgICAgIGlmKChub3cgLyAxIGRheXMpID4gc2VsZi5jdXJyZW50U3BlbmRbX3RvXVswXSl7CiAgICAgICAgc2VsZi5jdXJyZW50U3BlbmRbX3RvXVswXSA9IG5vdyAvIDEgZGF5czsKICAgICAgICBzZWxmLmN1cnJlbnRTcGVuZFtfdG9dWzFdID0gMDsKICAgICAgfQoKICAgICAgKGVyciwgcmVzKSA9IHNlbGYuY3VycmVudFNwZW5kW190b11bMV0ucGx1cyhfYW1vdW50KTsKICAgICAgaWYoZXJyKXsKICAgICAgICBMb2dFcnJNc2coIk92ZXJmbG93IHRva2VuIHNwZW5kIik7CiAgICAgICAgcmV0dXJuIDA7CiAgICAgIH0KICAgICAgaWYocmVzID49IHNlbGYubWFqb3JUaHJlc2hvbGRbX3RvXSkKICAgICAgICBtYWpvciA9IHRydWU7CiAgICB9CgogICAgcmV0dXJuIG1ham9yID8gc2VsZi5yZXF1aXJlZE1ham9yIDogc2VsZi5yZXF1aXJlZE1pbm9yOwogIH0KCiAgLy8vIEBkZXYgRnVuY3Rpb24gdG8gY3JlYXRlIG5ldyBjb250cmFjdAogIC8vLyBAcGFyYW0gX3R4RGF0YSBUcmFuc2FjdGlvbiBkYXRhCiAgLy8vIEBwYXJhbSBfdmFsdWUgQW1vdW50IG9mIGV0aCBzZW5kaW5nIHRvIG5ldyBjb250cmFjdAogIGZ1bmN0aW9uIGNyZWF0ZUNvbnRyYWN0KGJ5dGVzIF90eERhdGEsIHVpbnQgX3ZhbHVlKSB7CiAgICBhZGRyZXNzIF9uZXdDb250cmFjdDsKICAgIGJvb2wgYWxsR29vZDsKCiAgICBhc3NlbWJseSB7CiAgICAgIF9uZXdDb250cmFjdCA6PSBjcmVhdGUoX3ZhbHVlLCBhZGQoX3R4RGF0YSwgMHgyMCksIG1sb2FkKF90eERhdGEpKQogICAgICBhbGxHb29kIDo9IGd0KGV4dGNvZGVzaXplKF9uZXdDb250cmFjdCksMCkKICAgIH0KICAgIHJlcXVpcmUoYWxsR29vZCk7CiAgICBMb2dDb250cmFjdENyZWF0ZWQoX25ld0NvbnRyYWN0LCBfdmFsdWUpOwogIH0KCiAgLypQcmltYXJ5IEZ1bmN0aW9uKi8KCiAgLy8vIEBkZXYgQ3JlYXRlIGFuZCBleGVjdXRlIHRyYW5zYWN0aW9uIGZyb20gd2FsbGV0CiAgLy8vIEBwYXJhbSBzZWxmIFdhbGxldCBpbiBjb250cmFjdCBzdG9yYWdlCiAgLy8vIEBwYXJhbSBfdG8gQWRkcmVzcyBvZiB0YXJnZXQKICAvLy8gQHBhcmFtIF92YWx1ZSBBbW91bnQgb2YgZXRoZXIgc2VuZGluZwogIC8vLyBAcGFyYW0gX3R4RGF0YSBEYXRhIGZvciBleGVjdXRpbmcgdHJhbnNhY3Rpb24KICAvLy8gQHBhcmFtIF9jb25maXJtIFRydWUgaWYgY29uZmlybWluZywgZmFsc2UgaWYgcmV2b2tpbmcgY29uZmlybWF0aW9uCiAgLy8vIEBwYXJhbSBfZGF0YSBNZXNzYWdlIGRhdGEgcGFzc2VkIGZyb20gd2FsbGV0IGNvbnRyYWN0CiAgLy8vIEByZXR1cm4gYm9vbCBSZXR1cm5zIHRydWUgaWYgc3VjY2Vzc2Z1bCwgZmFsc2Ugb3RoZXJ3aXNlCiAgLy8vIEByZXR1cm4gYnl0ZXMzMiBSZXR1cm5zIHRoZSB0eCBJRCwgY2FuIGJlIHVzZWQgZm9yIGNvbmZpcm0vcmV2b2tlIGZ1bmN0aW9ucwogIGZ1bmN0aW9uIHNlcnZlVHgoV2FsbGV0RGF0YSBzdG9yYWdlIHNlbGYsCiAgICAgICAgICAgICAgICAgICBhZGRyZXNzIF90bywKICAgICAgICAgICAgICAgICAgIHVpbnQgX3ZhbHVlLAogICAgICAgICAgICAgICAgICAgYnl0ZXMgX3R4RGF0YSwKICAgICAgICAgICAgICAgICAgIGJvb2wgX2NvbmZpcm0sCiAgICAgICAgICAgICAgICAgICBieXRlcyBfZGF0YSkKICAgICAgICAgICAgICAgICAgIHJldHVybnMgKGJvb2wsYnl0ZXMzMikKICB7CiAgICBieXRlczMyIF9pZCA9IHNoYTMoInNlcnZlVHgiLF90byxfdmFsdWUsX3R4RGF0YSk7CiAgICB1aW50IF9udW1iZXIgPSBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdLmxlbmd0aDsKICAgIHVpbnQgX3JlcXVpcmVkID0gc2VsZi5yZXF1aXJlZE1ham9yOwoKICAgIC8vUnVuIGNoZWNrcyBpZiBub3QgY2FsbGVkIGZyb20gZ2VuZXJpYyBjb25maXJtL3Jldm9rZSBmdW5jdGlvbgogICAgaWYobXNnLnNlbmRlciAhPSBhZGRyZXNzKHRoaXMpKXsKICAgICAgYm9vbCBhbGxHb29kOwogICAgICB1aW50IF9hbW91bnQ7CiAgICAgIC8vIGlmIHRoZSBvd25lciBpcyByZXZva2luZyBoaXMvaGVyIGNvbmZpcm1hdGlvbiBidXQgZG9lc24ndCBrbm93IHRoZQogICAgICAvLyBzcGVjaWZpYyB0cmFuc2FjdGlvbiBpZCBoYXNoCiAgICAgIGlmKCFfY29uZmlybSkgewogICAgICAgIGFsbEdvb2QgPSByZXZva2VDb25maXJtKHNlbGYsIF9pZCk7CiAgICAgICAgcmV0dXJuIChhbGxHb29kLF9pZCk7CiAgICAgIH0gZWxzZSB7IC8vIGVsc2UgY29uZmlybWluZyB0aGUgdHJhbnNhY3Rpb24KICAgICAgICAvL2lmIHRoaXMgaXMgYSBuZXcgdHJhbnNhY3Rpb24gaWQgb3IgaWYgYSBwcmV2aW91cyBpZGVudGljYWwgdHJhbnNhY3Rpb24gaGFkIGFscmVhZHkgc3VjY2VlZGVkCiAgICAgICAgaWYoX251bWJlciA9PSAwIHx8IHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX251bWJlciAtIDFdLnN1Y2Nlc3MpewogICAgICAgICAgcmVxdWlyZShzZWxmLm93bmVySW5kZXhbbXNnLnNlbmRlcl0gPiAwKTsKCiAgICAgICAgICAvL1JldXNlIGFsbEdvb2QgZHVlIHRvIHN0YWNrIGxpbWl0CiAgICAgICAgICBpZihfdG8gIT0gMCkKICAgICAgICAgICAgKGFsbEdvb2QsX2Ftb3VudCkgPSBnZXRBbW91bnQoX3R4RGF0YSk7CgogICAgICAgICAgX3JlcXVpcmVkID0gZ2V0UmVxdWlyZWQoc2VsZiwgX3RvLCBfdmFsdWUsIGFsbEdvb2QsX2Ftb3VudCk7CiAgICAgICAgICBpZihfcmVxdWlyZWQgPT0gMCkKICAgICAgICAgICAgcmV0dXJuIChmYWxzZSwgX2lkKTsKCiAgICAgICAgICAvLyBhZGQgdGhpcyB0cmFuc2FjdGlvbiB0byB0aGUgd2FsbGV0cyByZWNvcmQgYW5kIGluaXRpYWxpemUgdGhlIHNldHRpbmdzCiAgICAgICAgICBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdLmxlbmd0aCsrOwogICAgICAgICAgc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfbnVtYmVyXS5jb25maXJtUmVxdWlyZWQgPSBfcmVxdWlyZWQ7CiAgICAgICAgICBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW19udW1iZXJdLmRheSA9IG5vdyAvIDEgZGF5czsKICAgICAgICAgIHNlbGYudHJhbnNhY3Rpb25zW25vdyAvIDEgZGF5c10ucHVzaChfaWQpOwogICAgICAgIH0gZWxzZSB7IC8vIGVsc2UgdGhlIHRyYW5zYWN0aW9uIGlzIGFscmVhZHkgcGVuZGluZwogICAgICAgICAgX251bWJlci0tOyAvLyBzZXQgdGhlIGluZGV4IHRvIHRoZSBpbmRleCBvZiB0aGUgZXhpc3RpbmcgdHJhbnNhY3Rpb24KICAgICAgICAgIC8vbWFrZSBzdXJlIHRoZSBzZW5kZXIgaXNuJ3QgYWxyZWFkeSBjb25maXJtZWQKICAgICAgICAgIGFsbEdvb2QgPSBjaGVja05vdENvbmZpcm1lZChzZWxmLCBfaWQsIF9udW1iZXIpOwogICAgICAgICAgaWYoIWFsbEdvb2QpCiAgICAgICAgICAgIHJldHVybiAoZmFsc2UsX2lkKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIGFkZCB0aGUgc2VuZGVycyBjb25maXJtYXRpb24gdG8gdGhlIHRyYW5zYWN0aW9uCiAgICAgIHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX251bWJlcl0uY29uZmlybWVkT3duZXJzLnB1c2godWludChtc2cuc2VuZGVyKSk7CiAgICAgIHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX251bWJlcl0uY29uZmlybUNvdW50Kys7CiAgICB9ZWxzZSB7CiAgICAgIC8vIGVsc2Ugd2VyZSBjYWxsaW5nIGZyb20gZ2VuZXJpYyBjb25maXJtL3Jldm9rZSBmdW5jdGlvbiwgc2V0IHRoZQogICAgICAvLyBfbnVtYmVyIGluZGV4IHRvIHRoZSBpbmRleCBvZiB0aGUgZXhpc3RpbmcgdHJhbnNhY3Rpb24KICAgICAgX251bWJlci0tOwogICAgfQoKICAgIC8vIGlmIHRoZXJlIGFyZSBlbm91Z2ggY29uZmlybWF0aW9ucwogICAgaWYoc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfbnVtYmVyXS5jb25maXJtQ291bnQgPT0KICAgICAgIHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX251bWJlcl0uY29uZmlybVJlcXVpcmVkKQogICAgewogICAgICAvLyBleGVjdXRlIHRoZSB0cmFuc2FjdGlvbgogICAgICBzZWxmLmN1cnJlbnRTcGVuZFswXVsxXSArPSBfdmFsdWU7CiAgICAgIHNlbGYuY3VycmVudFNwZW5kW190b11bMV0gKz0gX2Ftb3VudDsKICAgICAgc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfbnVtYmVyXS5zdWNjZXNzID0gdHJ1ZTsKCiAgICAgIGlmKF90byA9PSAwKXsKICAgICAgICAvL0ZhaWx1cmUgaXMgc2VsZiBjb250YWluZWQgaW4gbWV0aG9kCiAgICAgICAgY3JlYXRlQ29udHJhY3QoX3R4RGF0YSwgX3ZhbHVlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXF1aXJlKF90by5jYWxsLnZhbHVlKF92YWx1ZSkoX3R4RGF0YSkpOwogICAgICB9CiAgICAgIGRlbGV0ZSBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW19udW1iZXJdLmRhdGE7CiAgICAgIExvZ1RyYW5zYWN0aW9uQ29tcGxldGUoX2lkLCBfdG8sIF92YWx1ZSwgX2RhdGEpOwogICAgfSBlbHNlIHsKICAgICAgaWYoc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfbnVtYmVyXS5kYXRhLmxlbmd0aCA9PSAwKQogICAgICAgIHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX251bWJlcl0uZGF0YSA9IF9kYXRhOwoKICAgICAgdWludCBjb25maXJtc05lZWRlZCA9IGNhbGNDb25maXJtc05lZWRlZChzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW19udW1iZXJdLmNvbmZpcm1SZXF1aXJlZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW19udW1iZXJdLmNvbmZpcm1Db3VudCk7CiAgICAgIExvZ1RyYW5zYWN0aW9uQ29uZmlybWVkKF9pZCwgbXNnLnNlbmRlciwgY29uZmlybXNOZWVkZWQpOwogICAgfQoKICAgIHJldHVybiAodHJ1ZSxfaWQpOwogIH0KCiAgLypDb25maXJtL1Jldm9rZSBmdW5jdGlvbnMgdXNpbmcgdHggSUQqLwoKICAvLy8gQGRldiBDb25maXJtcyBhIGN1cnJlbnQgcGVuZGluZyB0eCwgd2lsbCBleGVjdXRlIGlmIGZpbmFsIGNvbmZpcm1hdGlvbgogIC8vLyBAcGFyYW0gc2VsZiBXYWxsZXQgaW4gY29udHJhY3Qgc3RvcmFnZQogIC8vLyBAcGFyYW0gX2lkIElEIG9mIHRoZSB0cmFuc2FjdGlvbgogIC8vLyBAcmV0dXJuIFJldHVybnMgdHJ1ZSBpZiBzdWNjZXNzZnVsLCBmYWxzZSBvdGhlcndpc2UKICBmdW5jdGlvbiBjb25maXJtVHgoV2FsbGV0RGF0YSBzdG9yYWdlIHNlbGYsIGJ5dGVzMzIgX2lkKSByZXR1cm5zIChib29sKXsKICAgIHJlcXVpcmUoc2VsZi5vd25lckluZGV4W21zZy5zZW5kZXJdID4gMCk7CiAgICB1aW50IF9udW1iZXIgPSBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdLmxlbmd0aDsKICAgIGJvb2wgcmV0OwoKICAgIGlmKF9udW1iZXIgPT0gMCl7CiAgICAgIExvZ0Vyck1zZygiVHggbm90IGluaXRpYXRlZCIpOwogICAgICBMb2dUcmFuc2FjdGlvbkZhaWxlZChfaWQsIG1zZy5zZW5kZXIpOwogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgX251bWJlci0tOwogICAgYm9vbCBhbGxHb29kID0gY2hlY2tOb3RDb25maXJtZWQoc2VsZiwgX2lkLCBfbnVtYmVyKTsKICAgIGlmKCFhbGxHb29kKQogICAgICByZXR1cm4gZmFsc2U7CgogICAgc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfbnVtYmVyXS5jb25maXJtZWRPd25lcnMucHVzaCh1aW50MjU2KG1zZy5zZW5kZXIpKTsKICAgIHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX251bWJlcl0uY29uZmlybUNvdW50Kys7CgogICAgaWYoc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfbnVtYmVyXS5jb25maXJtQ291bnQgPT0KICAgICAgIHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX251bWJlcl0uY29uZmlybVJlcXVpcmVkKQogICAgewogICAgICBhZGRyZXNzIGEgPSBhZGRyZXNzKHRoaXMpOwogICAgICByZXF1aXJlKGEuY2FsbChzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW19udW1iZXJdLmRhdGEpKTsKICAgIH0gZWxzZSB7CiAgICAgIHVpbnQgY29uZmlybXNOZWVkZWQgPSBjYWxjQ29uZmlybXNOZWVkZWQoc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfbnVtYmVyXS5jb25maXJtUmVxdWlyZWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfbnVtYmVyXS5jb25maXJtQ291bnQpOwoKICAgICAgTG9nVHJhbnNhY3Rpb25Db25maXJtZWQoX2lkLCBtc2cuc2VuZGVyLCBjb25maXJtc05lZWRlZCk7CiAgICAgIHJldCA9IHRydWU7CiAgICB9CgogICAgcmV0dXJuIHJldDsKICB9CgogIC8vLyBAZGV2IFJldm9rZXMgYSBwcmlvciBjb25maXJtYXRpb24gZnJvbSBzZW5kZXIsIGNhbGwgd2l0aCB0eCBJRAogIC8vLyBAcGFyYW0gc2VsZiBXYWxsZXQgaW4gY29udHJhY3Qgc3RvcmFnZQogIC8vLyBAcGFyYW0gX2lkIElEIG9mIHRoZSB0cmFuc2FjdGlvbgogIC8vLyBAcmV0dXJuIFJldHVybnMgdHJ1ZSBpZiBzdWNjZXNzZnVsLCBmYWxzZSBvdGhlcndpc2UKICBmdW5jdGlvbiByZXZva2VDb25maXJtKFdhbGxldERhdGEgc3RvcmFnZSBzZWxmLCBieXRlczMyIF9pZCkKICAgICAgICAgICByZXR1cm5zIChib29sKQogIHsKICAgIHJlcXVpcmUoc2VsZi5vd25lckluZGV4W21zZy5zZW5kZXJdID4gMCk7CiAgICB1aW50IF9udW1iZXIgPSBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdLmxlbmd0aDsKCiAgICBpZihfbnVtYmVyID09IDApewogICAgICBMb2dFcnJNc2coIlR4IG5vdCBpbml0aWF0ZWQiKTsKICAgICAgTG9nVHJhbnNhY3Rpb25GYWlsZWQoX2lkLCBtc2cuc2VuZGVyKTsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIF9udW1iZXItLTsKICAgIGlmKHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX251bWJlcl0uc3VjY2Vzcyl7CiAgICAgIExvZ0Vyck1zZygiVHJhbnNhY3Rpb24gYWxyZWFkeSBjb21wbGV0ZSIpOwogICAgICBMb2dUcmFuc2FjdGlvbkZhaWxlZChfaWQsIG1zZy5zZW5kZXIpOwogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgLy9GdW5jdGlvbiBmcm9tIE1ham9vbHIuaW8gYXJyYXkgdXRpbGl0eSBsaWJyYXJ5CiAgICBib29sIGZvdW5kOwogICAgdWludCBpbmRleDsKICAgIChmb3VuZCwgaW5kZXgpID0gc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfbnVtYmVyXS5jb25maXJtZWRPd25lcnMuaW5kZXhPZih1aW50KG1zZy5zZW5kZXIpLCBmYWxzZSk7CiAgICBpZighZm91bmQpewogICAgICBMb2dFcnJNc2coIk93bmVyIGhhcyBub3QgY29uZmlybWVkIHR4Iik7CiAgICAgIExvZ1RyYW5zYWN0aW9uRmFpbGVkKF9pZCwgbXNnLnNlbmRlcik7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX251bWJlcl0uY29uZmlybWVkT3duZXJzW2luZGV4XSA9IDA7CiAgICBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW19udW1iZXJdLmNvbmZpcm1Db3VudC0tOwoKICAgIHVpbnQgY29uZmlybXNOZWVkZWQgPSBjYWxjQ29uZmlybXNOZWVkZWQoc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfbnVtYmVyXS5jb25maXJtUmVxdWlyZWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX251bWJlcl0uY29uZmlybUNvdW50KTsKICAgIC8vVHJhbnNhY3Rpb24gcmVtb3ZlZCBpZiBhbGwgc2lncyByZXZva2VkIGJ1dCBpZCByZW1haW5zIGluIHdhbGxldCB0cmFuc2FjdGlvbiBsaXN0CiAgICBpZihzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW19udW1iZXJdLmNvbmZpcm1Db3VudCA9PSAwKQogICAgICBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdLmxlbmd0aC0tOwoKICAgIExvZ1Jldm9rZU5vdGljZShfaWQsIG1zZy5zZW5kZXIsIGNvbmZpcm1zTmVlZGVkKTsKICAgIHJldHVybiB0cnVlOwogIH0KfQoKcHJhZ21hIHNvbGlkaXR5IF4wLjQuMTM7CgovKioKICogQHRpdGxlIEFycmF5MjU2IExpYnJhcnkKICogQGF1dGhvciBNYWpvb2xyLmlvCiAqCiAqIHZlcnNpb24gMS4wLjAKICogQ29weXJpZ2h0IChjKSAyMDE3IE1ham9vbHIsIExMQwogKiBUaGUgTUlUIExpY2Vuc2UgKE1JVCkKICogaHR0cHM6Ly9naXRodWIuY29tL01ham9vbHIvZXRoZXJldW0tbGlicmFyaWVzL2Jsb2IvbWFzdGVyL0xJQ0VOU0UKICoKICogVGhlIEFycmF5MjU2IExpYnJhcnkgcHJvdmlkZXMgYSBmZXcgdXRpbGl0eSBmdW5jdGlvbnMgdG8gd29yayB3aXRoCiAqIHN0b3JhZ2UgdWludDI1NltdIHR5cGVzIGluIHBsYWNlLiBNYWpvb2xyIHdvcmtzIG9uIG9wZW4gc291cmNlIHByb2plY3RzIGluCiAqIHRoZSBFdGhlcmV1bSBjb21tdW5pdHkgd2l0aCB0aGUgcHVycG9zZSBvZiB0ZXN0aW5nLCBkb2N1bWVudGluZywgYW5kIGRlcGxveWluZwogKiByZXVzYWJsZSBjb2RlIG9udG8gdGhlIGJsb2NrY2hhaW4gdG8gaW1wcm92ZSBzZWN1cml0eSBhbmQgdXNhYmlsaXR5IG9mIHNtYXJ0CiAqIGNvbnRyYWN0cy4gTWFqb29sciBhbHNvIHN0cml2ZXMgdG8gZWR1Y2F0ZSBub24tcHJvZml0cywgc2Nob29scywgYW5kIG90aGVyCiAqIGNvbW11bml0eSBtZW1iZXJzIGFib3V0IHRoZSBhcHBsaWNhdGlvbiBvZiBibG9ja2NoYWluIHRlY2hub2xvZ3kuCiAqIEZvciBmdXJ0aGVyIGluZm9ybWF0aW9uOiBtYWpvb2xyLmlvCiAqCiAqIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTCiAqIE9SIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YKICogTUVSQ0hBTlRBQklMSVRZLCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULgogKiBJTiBOTyBFVkVOVCBTSEFMTCBUSEUgQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWQogKiBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULAogKiBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLCBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRQogKiBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOIFRIRSBTT0ZUV0FSRS4KICovCgpsaWJyYXJ5IEFycmF5MjU2TGliIHsKCiAgLy8vIEBkZXYgU3VtIHZlY3RvcgogIC8vLyBAcGFyYW0gc2VsZiBTdG9yYWdlIGFycmF5IGNvbnRhaW5pbmcgdWludDI1NiB0eXBlIHZhcmlhYmxlcwogIC8vLyBAcmV0dXJuIHN1bSBUaGUgc3VtIG9mIGFsbCBlbGVtZW50cywgZG9lcyBub3QgY2hlY2sgZm9yIG92ZXJmbG93CiAgZnVuY3Rpb24gc3VtRWxlbWVudHModWludDI1NltdIHN0b3JhZ2Ugc2VsZikgY29uc3RhbnQgcmV0dXJucyh1aW50MjU2IHN1bSkgewogICAgYXNzZW1ibHkgewogICAgICBtc3RvcmUoMHg2MCxzZWxmX3Nsb3QpCgogICAgICBmb3IgeyBsZXQgaSA6PSAwIH0gbHQoaSwgc2xvYWQoc2VsZl9zbG90KSkgeyBpIDo9IGFkZChpLCAxKSB9IHsKICAgICAgICBzdW0gOj0gYWRkKHNsb2FkKGFkZChzaGEzKDB4NjAsMHgyMCksaSkpLHN1bSkKICAgICAgfQogICAgfQogIH0KCiAgLy8vIEBkZXYgUmV0dXJucyB0aGUgbWF4IHZhbHVlIGluIGFuIGFycmF5LgogIC8vLyBAcGFyYW0gc2VsZiBTdG9yYWdlIGFycmF5IGNvbnRhaW5pbmcgdWludDI1NiB0eXBlIHZhcmlhYmxlcwogIC8vLyBAcmV0dXJuIG1heFZhbHVlIFRoZSBoaWdoZXN0IHZhbHVlIGluIHRoZSBhcnJheQogIGZ1bmN0aW9uIGdldE1heCh1aW50MjU2W10gc3RvcmFnZSBzZWxmKSBjb25zdGFudCByZXR1cm5zKHVpbnQyNTYgbWF4VmFsdWUpIHsKICAgIGFzc2VtYmx5IHsKICAgICAgbXN0b3JlKDB4NjAsc2VsZl9zbG90KQogICAgICBtYXhWYWx1ZSA6PSBzbG9hZChzaGEzKDB4NjAsMHgyMCkpCgogICAgICBmb3IgeyBsZXQgaSA6PSAwIH0gbHQoaSwgc2xvYWQoc2VsZl9zbG90KSkgeyBpIDo9IGFkZChpLCAxKSB9IHsKICAgICAgICBzd2l0Y2ggZ3Qoc2xvYWQoYWRkKHNoYTMoMHg2MCwweDIwKSxpKSksIG1heFZhbHVlKQogICAgICAgIGNhc2UgMSB7CiAgICAgICAgICBtYXhWYWx1ZSA6PSBzbG9hZChhZGQoc2hhMygweDYwLDB4MjApLGkpKQogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KCiAgLy8vIEBkZXYgUmV0dXJucyB0aGUgbWluaW11bSB2YWx1ZSBpbiBhbiBhcnJheS4KICAvLy8gQHBhcmFtIHNlbGYgU3RvcmFnZSBhcnJheSBjb250YWluaW5nIHVpbnQyNTYgdHlwZSB2YXJpYWJsZXMKICAvLy8gQHJldHVybiBtaW5WYWx1ZSBUaGUgaGlnaGVzdCB2YWx1ZSBpbiB0aGUgYXJyYXkKICBmdW5jdGlvbiBnZXRNaW4odWludDI1NltdIHN0b3JhZ2Ugc2VsZikgY29uc3RhbnQgcmV0dXJucyh1aW50MjU2IG1pblZhbHVlKSB7CiAgICBhc3NlbWJseSB7CiAgICAgIG1zdG9yZSgweDYwLHNlbGZfc2xvdCkKICAgICAgbWluVmFsdWUgOj0gc2xvYWQoc2hhMygweDYwLDB4MjApKQoKICAgICAgZm9yIHsgbGV0IGkgOj0gMCB9IGx0KGksIHNsb2FkKHNlbGZfc2xvdCkpIHsgaSA6PSBhZGQoaSwgMSkgfSB7CiAgICAgICAgc3dpdGNoIGd0KHNsb2FkKGFkZChzaGEzKDB4NjAsMHgyMCksaSkpLCBtaW5WYWx1ZSkKICAgICAgICBjYXNlIDAgewogICAgICAgICAgbWluVmFsdWUgOj0gc2xvYWQoYWRkKHNoYTMoMHg2MCwweDIwKSxpKSkKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CgogIC8vLyBAZGV2IEZpbmRzIHRoZSBpbmRleCBvZiBhIGdpdmVuIHZhbHVlIGluIGFuIGFycmF5CiAgLy8vIEBwYXJhbSBzZWxmIFN0b3JhZ2UgYXJyYXkgY29udGFpbmluZyB1aW50MjU2IHR5cGUgdmFyaWFibGVzCiAgLy8vIEBwYXJhbSB2YWx1ZSBUaGUgdmFsdWUgdG8gc2VhcmNoIGZvcgogIC8vLyBAcGFyYW0gaXNTb3J0ZWQgVHJ1ZSBpZiB0aGUgYXJyYXkgaXMgc29ydGVkLCBmYWxzZSBvdGhlcndpc2UKICAvLy8gQHJldHVybiBmb3VuZCBUcnVlIGlmIHRoZSB2YWx1ZSB3YXMgZm91bmQsIGZhbHNlIG90aGVyd2lzZQogIC8vLyBAcmV0dXJuIGluZGV4IFRoZSBpbmRleCBvZiB0aGUgZ2l2ZW4gdmFsdWUsIHJldHVybnMgMCBpZiBmb3VuZCBpcyBmYWxzZQogIGZ1bmN0aW9uIGluZGV4T2YodWludDI1NltdIHN0b3JhZ2Ugc2VsZiwgdWludDI1NiB2YWx1ZSwgYm9vbCBpc1NvcnRlZCkgY29uc3RhbnQKICAgICAgICAgICByZXR1cm5zKGJvb2wgZm91bmQsIHVpbnQyNTYgaW5kZXgpIHsKICAgIGFzc2VtYmx5ewogICAgICBtc3RvcmUoMHg2MCxzZWxmX3Nsb3QpCiAgICAgIHN3aXRjaCBpc1NvcnRlZAogICAgICBjYXNlIDEgewogICAgICAgIGxldCBoaWdoIDo9IHN1YihzbG9hZChzZWxmX3Nsb3QpLDEpCiAgICAgICAgbGV0IG1pZCA6PSAwCiAgICAgICAgbGV0IGxvdyA6PSAwCiAgICAgICAgZm9yIHsgfSBpc3plcm8oZ3QobG93LCBoaWdoKSkgeyB9IHsKICAgICAgICAgIG1pZCA6PSBkaXYoYWRkKGxvdyxoaWdoKSwyKQoKICAgICAgICAgIHN3aXRjaCBsdChzbG9hZChhZGQoc2hhMygweDYwLDB4MjApLG1pZCkpLHZhbHVlKQogICAgICAgICAgY2FzZSAxIHsKICAgICAgICAgICAgIGxvdyA6PSBhZGQobWlkLDEpCiAgICAgICAgICB9CiAgICAgICAgICBjYXNlIDAgewogICAgICAgICAgICBzd2l0Y2ggZ3Qoc2xvYWQoYWRkKHNoYTMoMHg2MCwweDIwKSxtaWQpKSx2YWx1ZSkKICAgICAgICAgICAgY2FzZSAxIHsKICAgICAgICAgICAgICBoaWdoIDo9IHN1YihtaWQsMSkKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIDAgewogICAgICAgICAgICAgIGZvdW5kIDo9IDEKICAgICAgICAgICAgICBpbmRleCA6PSBtaWQKICAgICAgICAgICAgICBsb3cgOj0gYWRkKGhpZ2gsMSkKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICBjYXNlIDAgewogICAgICAgIGZvciB7IGxldCBsb3cgOj0gMCB9IGx0KGxvdywgc2xvYWQoc2VsZl9zbG90KSkgeyBsb3cgOj0gYWRkKGxvdywgMSkgfSB7CiAgICAgICAgICBzd2l0Y2ggZXEoc2xvYWQoYWRkKHNoYTMoMHg2MCwweDIwKSxsb3cpKSwgdmFsdWUpCiAgICAgICAgICBjYXNlIDEgewogICAgICAgICAgICBmb3VuZCA6PSAxCiAgICAgICAgICAgIGluZGV4IDo9IGxvdwogICAgICAgICAgICBsb3cgOj0gc2xvYWQoc2VsZl9zbG90KQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KCiAgLy8vIEBkZXYgVXRpbGl0eSBmdW5jdGlvbiBmb3IgaGVhcFNvcnQKICAvLy8gQHBhcmFtIGluZGV4IFRoZSBpbmRleCBvZiBjaGlsZCBub2RlCiAgLy8vIEByZXR1cm4gcEkgVGhlIHBhcmVudCBub2RlIGluZGV4CiAgZnVuY3Rpb24gZ2V0UGFyZW50SSh1aW50MjU2IGluZGV4KSBjb25zdGFudCBwcml2YXRlIHJldHVybnMgKHVpbnQyNTYgcEkpIHsKICAgIHVpbnQyNTYgaSA9IGluZGV4IC0gMTsKICAgIHBJID0gaS8yOwogIH0KCiAgLy8vIEBkZXYgVXRpbGl0eSBmdW5jdGlvbiBmb3IgaGVhcFNvcnQKICAvLy8gQHBhcmFtIGluZGV4IFRoZSBpbmRleCBvZiBwYXJlbnQgbm9kZQogIC8vLyBAcmV0dXJuIGxjSSBUaGUgaW5kZXggb2YgbGVmdCBjaGlsZAogIGZ1bmN0aW9uIGdldExlZnRDaGlsZEkodWludDI1NiBpbmRleCkgY29uc3RhbnQgcHJpdmF0ZSByZXR1cm5zICh1aW50MjU2IGxjSSkgewogICAgdWludDI1NiBpID0gaW5kZXggKiAyOwogICAgbGNJID0gaSArIDE7CiAgfQoKICAvLy8gQGRldiBTb3J0cyBnaXZlbiBhcnJheSBpbiBwbGFjZQogIC8vLyBAcGFyYW0gc2VsZiBTdG9yYWdlIGFycmF5IGNvbnRhaW5pbmcgdWludDI1NiB0eXBlIHZhcmlhYmxlcwogIGZ1bmN0aW9uIGhlYXBTb3J0KHVpbnQyNTZbXSBzdG9yYWdlIHNlbGYpIHsKICAgIHVpbnQyNTYgZW5kID0gc2VsZi5sZW5ndGggLSAxOwogICAgdWludDI1NiBzdGFydCA9IGdldFBhcmVudEkoZW5kKTsKICAgIHVpbnQyNTYgcm9vdCA9IHN0YXJ0OwogICAgdWludDI1NiBsQ2hpbGQ7CiAgICB1aW50MjU2IHJDaGlsZDsKICAgIHVpbnQyNTYgc3dhcDsKICAgIHVpbnQyNTYgdGVtcDsKICAgIHdoaWxlKHN0YXJ0ID49IDApewogICAgICByb290ID0gc3RhcnQ7CiAgICAgIGxDaGlsZCA9IGdldExlZnRDaGlsZEkoc3RhcnQpOwogICAgICB3aGlsZShsQ2hpbGQgPD0gZW5kKXsKICAgICAgICByQ2hpbGQgPSBsQ2hpbGQgKyAxOwogICAgICAgIHN3YXAgPSByb290OwogICAgICAgIGlmKHNlbGZbc3dhcF0gPCBzZWxmW2xDaGlsZF0pCiAgICAgICAgICBzd2FwID0gbENoaWxkOwogICAgICAgIGlmKChyQ2hpbGQgPD0gZW5kKSAmJiAoc2VsZltzd2FwXTxzZWxmW3JDaGlsZF0pKQogICAgICAgICAgc3dhcCA9IHJDaGlsZDsKICAgICAgICBpZihzd2FwID09IHJvb3QpCiAgICAgICAgICBsQ2hpbGQgPSBlbmQrMTsKICAgICAgICBlbHNlIHsKICAgICAgICAgIHRlbXAgPSBzZWxmW3N3YXBdOwogICAgICAgICAgc2VsZltzd2FwXSA9IHNlbGZbcm9vdF07CiAgICAgICAgICBzZWxmW3Jvb3RdID0gdGVtcDsKICAgICAgICAgIHJvb3QgPSBzd2FwOwogICAgICAgICAgbENoaWxkID0gZ2V0TGVmdENoaWxkSShyb290KTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYoc3RhcnQgPT0gMCkKICAgICAgICBicmVhazsKICAgICAgZWxzZQogICAgICAgIHN0YXJ0ID0gc3RhcnQgLSAxOwogICAgfQogICAgd2hpbGUoZW5kID4gMCl7CiAgICAgIHRlbXAgPSBzZWxmW2VuZF07CiAgICAgIHNlbGZbZW5kXSA9IHNlbGZbMF07CiAgICAgIHNlbGZbMF0gPSB0ZW1wOwogICAgICBlbmQgPSBlbmQgLSAxOwogICAgICByb290ID0gMDsKICAgICAgbENoaWxkID0gZ2V0TGVmdENoaWxkSSgwKTsKICAgICAgd2hpbGUobENoaWxkIDw9IGVuZCl7CiAgICAgICAgckNoaWxkID0gbENoaWxkICsgMTsKICAgICAgICBzd2FwID0gcm9vdDsKICAgICAgICBpZihzZWxmW3N3YXBdIDwgc2VsZltsQ2hpbGRdKQogICAgICAgICAgc3dhcCA9IGxDaGlsZDsKICAgICAgICBpZigockNoaWxkIDw9IGVuZCkgJiYgKHNlbGZbc3dhcF08c2VsZltyQ2hpbGRdKSkKICAgICAgICAgIHN3YXAgPSByQ2hpbGQ7CiAgICAgICAgaWYoc3dhcCA9PSByb290KQogICAgICAgICAgbENoaWxkID0gZW5kICsgMTsKICAgICAgICBlbHNlIHsKICAgICAgICAgIHRlbXAgPSBzZWxmW3N3YXBdOwogICAgICAgICAgc2VsZltzd2FwXSA9IHNlbGZbcm9vdF07CiAgICAgICAgICBzZWxmW3Jvb3RdID0gdGVtcDsKICAgICAgICAgIHJvb3QgPSBzd2FwOwogICAgICAgICAgbENoaWxkID0gZ2V0TGVmdENoaWxkSShyb290KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9Cn0KCnByYWdtYSBzb2xpZGl0eSBeMC40LjEzOwoKLyoqCiAqIEB0aXRsZSBCYXNpYyBNYXRoIExpYnJhcnkKICogQGF1dGhvciBNYWpvb2xyLmlvCiAqCiAqIHZlcnNpb24gMS4xLjAKICogQ29weXJpZ2h0IChjKSAyMDE3IE1ham9vbHIsIExMQwogKiBUaGUgTUlUIExpY2Vuc2UgKE1JVCkKICogaHR0cHM6Ly9naXRodWIuY29tL01ham9vbHIvZXRoZXJldW0tbGlicmFyaWVzL2Jsb2IvbWFzdGVyL0xJQ0VOU0UKICoKICogVGhlIEJhc2ljIE1hdGggTGlicmFyeSBpcyBpbnNwaXJlZCBieSB0aGUgU2FmZSBNYXRoIGxpYnJhcnkgd3JpdHRlbiBieQogKiBPcGVuWmVwcGVsaW4gYXQgaHR0cHM6Ly9naXRodWIuY29tL09wZW5aZXBwZWxpbi96ZXBwZWxpbi1zb2xpZGl0eS8gLgogKiBNYWpvb2xyIHdvcmtzIG9uIG9wZW4gc291cmNlIHByb2plY3RzIGluIHRoZSBFdGhlcmV1bSBjb21tdW5pdHkgd2l0aCB0aGUKICogcHVycG9zZSBvZiB0ZXN0aW5nLCBkb2N1bWVudGluZywgYW5kIGRlcGxveWluZyByZXVzYWJsZSBjb2RlIG9udG8gdGhlCiAqIGJsb2NrY2hhaW4gdG8gaW1wcm92ZSBzZWN1cml0eSBhbmQgdXNhYmlsaXR5IG9mIHNtYXJ0IGNvbnRyYWN0cy4gTWFqb29scgogKiBhbHNvIHN0cml2ZXMgdG8gZWR1Y2F0ZSBub24tcHJvZml0cywgc2Nob29scywgYW5kIG90aGVyIGNvbW11bml0eSBtZW1iZXJzCiAqIGFib3V0IHRoZSBhcHBsaWNhdGlvbiBvZiBibG9ja2NoYWluIHRlY2hub2xvZ3kuCiAqIEZvciBmdXJ0aGVyIGluZm9ybWF0aW9uOiBtYWpvb2xyLmlvLCBvcGVuemVwcGVsaW4ub3JnCiAqCiAqIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTCiAqIE9SIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YKICogTUVSQ0hBTlRBQklMSVRZLCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULgogKiBJTiBOTyBFVkVOVCBTSEFMTCBUSEUgQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWQogKiBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULAogKiBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLCBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRQogKiBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOIFRIRSBTT0ZUV0FSRS4KICovCgpsaWJyYXJ5IEJhc2ljTWF0aExpYiB7CiAgZXZlbnQgRXJyKHN0cmluZyB0eXBlRXJyKTsKCiAgLy8vIEBkZXYgTXVsdGlwbGllcyB0d28gbnVtYmVycyBhbmQgY2hlY2tzIGZvciBvdmVyZmxvdyBiZWZvcmUgcmV0dXJuaW5nLgogIC8vLyBEb2VzIG5vdCB0aHJvdyBidXQgcmF0aGVyIGxvZ3MgYW4gRXJyIGV2ZW50IGlmIHRoZXJlIGlzIG92ZXJmbG93LgogIC8vLyBAcGFyYW0gYSBGaXJzdCBudW1iZXIKICAvLy8gQHBhcmFtIGIgU2Vjb25kIG51bWJlcgogIC8vLyBAcmV0dXJuIGVyciBGYWxzZSBub3JtYWxseSwgb3IgdHJ1ZSBpZiB0aGVyZSBpcyBvdmVyZmxvdwogIC8vLyBAcmV0dXJuIHJlcyBUaGUgcHJvZHVjdCBvZiBhIGFuZCBiLCBvciAwIGlmIHRoZXJlIGlzIG92ZXJmbG93CiAgZnVuY3Rpb24gdGltZXModWludDI1NiBhLCB1aW50MjU2IGIpIGNvbnN0YW50IHJldHVybnMgKGJvb2wgZXJyLHVpbnQyNTYgcmVzKSB7CiAgICBhc3NlbWJseXsKICAgICAgcmVzIDo9IG11bChhLGIpCiAgICAgIHN3aXRjaCBvcihpc3plcm8oYiksIGVxKGRpdihyZXMsYiksIGEpKQogICAgICBjYXNlIDAgewogICAgICAgIGVyciA6PSAxCiAgICAgICAgcmVzIDo9IDAKICAgICAgfQogICAgfQogICAgaWYgKGVycikKICAgICAgRXJyKCJ0aW1lcyBmdW5jIG92ZXJmbG93Iik7CiAgfQoKICAvLy8gQGRldiBEaXZpZGVzIHR3byBudW1iZXJzIGJ1dCBjaGVja3MgZm9yIDAgaW4gdGhlIGRpdmlzb3IgZmlyc3QuCiAgLy8vIERvZXMgbm90IHRocm93IGJ1dCByYXRoZXIgbG9ncyBhbiBFcnIgZXZlbnQgaWYgMCBpcyBpbiB0aGUgZGl2aXNvci4KICAvLy8gQHBhcmFtIGEgRmlyc3QgbnVtYmVyCiAgLy8vIEBwYXJhbSBiIFNlY29uZCBudW1iZXIKICAvLy8gQHJldHVybiBlcnIgRmFsc2Ugbm9ybWFsbHksIG9yIHRydWUgaWYgYGJgIGlzIDAKICAvLy8gQHJldHVybiByZXMgVGhlIHF1b3RpZW50IG9mIGEgYW5kIGIsIG9yIDAgaWYgYGJgIGlzIDAKICBmdW5jdGlvbiBkaXZpZGVkQnkodWludDI1NiBhLCB1aW50MjU2IGIpIGNvbnN0YW50IHJldHVybnMgKGJvb2wgZXJyLHVpbnQyNTYgcmVzKSB7CiAgICBhc3NlbWJseXsKICAgICAgc3dpdGNoIGlzemVybyhiKQogICAgICBjYXNlIDAgewogICAgICAgIHJlcyA6PSBkaXYoYSxiKQogICAgICAgIG1zdG9yZShhZGQobWxvYWQoMHg0MCksMHgyMCkscmVzKQogICAgICAgIHJldHVybihtbG9hZCgweDQwKSwweDQwKQogICAgICB9CiAgICB9CiAgICBFcnIoInRyaWVkIHRvIGRpdmlkZSBieSB6ZXJvIik7CiAgICByZXR1cm4gKHRydWUsIDApOwogIH0KCiAgLy8vIEBkZXYgQWRkcyB0d28gbnVtYmVycyBhbmQgY2hlY2tzIGZvciBvdmVyZmxvdyBiZWZvcmUgcmV0dXJuaW5nLgogIC8vLyBEb2VzIG5vdCB0aHJvdyBidXQgcmF0aGVyIGxvZ3MgYW4gRXJyIGV2ZW50IGlmIHRoZXJlIGlzIG92ZXJmbG93LgogIC8vLyBAcGFyYW0gYSBGaXJzdCBudW1iZXIKICAvLy8gQHBhcmFtIGIgU2Vjb25kIG51bWJlcgogIC8vLyBAcmV0dXJuIGVyciBGYWxzZSBub3JtYWxseSwgb3IgdHJ1ZSBpZiB0aGVyZSBpcyBvdmVyZmxvdwogIC8vLyBAcmV0dXJuIHJlcyBUaGUgc3VtIG9mIGEgYW5kIGIsIG9yIDAgaWYgdGhlcmUgaXMgb3ZlcmZsb3cKICBmdW5jdGlvbiBwbHVzKHVpbnQyNTYgYSwgdWludDI1NiBiKSBjb25zdGFudCByZXR1cm5zIChib29sIGVyciwgdWludDI1NiByZXMpIHsKICAgIGFzc2VtYmx5ewogICAgICByZXMgOj0gYWRkKGEsYikKICAgICAgc3dpdGNoIGFuZChlcShzdWIocmVzLGIpLCBhKSwgb3IoZ3QocmVzLGIpLGVxKHJlcyxiKSkpCiAgICAgIGNhc2UgMCB7CiAgICAgICAgZXJyIDo9IDEKICAgICAgICByZXMgOj0gMAogICAgICB9CiAgICB9CiAgICBpZiAoZXJyKQogICAgICBFcnIoInBsdXMgZnVuYyBvdmVyZmxvdyIpOwogIH0KCiAgLy8vIEBkZXYgU3VidHJhY3RzIHR3byBudW1iZXJzIGFuZCBjaGVja3MgZm9yIHVuZGVyZmxvdyBiZWZvcmUgcmV0dXJuaW5nLgogIC8vLyBEb2VzIG5vdCB0aHJvdyBidXQgcmF0aGVyIGxvZ3MgYW4gRXJyIGV2ZW50IGlmIHRoZXJlIGlzIHVuZGVyZmxvdy4KICAvLy8gQHBhcmFtIGEgRmlyc3QgbnVtYmVyCiAgLy8vIEBwYXJhbSBiIFNlY29uZCBudW1iZXIKICAvLy8gQHJldHVybiBlcnIgRmFsc2Ugbm9ybWFsbHksIG9yIHRydWUgaWYgdGhlcmUgaXMgdW5kZXJmbG93CiAgLy8vIEByZXR1cm4gcmVzIFRoZSBkaWZmZXJlbmNlIGJldHdlZW4gYSBhbmQgYiwgb3IgMCBpZiB0aGVyZSBpcyB1bmRlcmZsb3cKICBmdW5jdGlvbiBtaW51cyh1aW50MjU2IGEsIHVpbnQyNTYgYikgY29uc3RhbnQgcmV0dXJucyAoYm9vbCBlcnIsdWludDI1NiByZXMpIHsKICAgIGFzc2VtYmx5ewogICAgICByZXMgOj0gc3ViKGEsYikKICAgICAgc3dpdGNoIGVxKGFuZChlcShhZGQocmVzLGIpLCBhKSwgb3IobHQocmVzLGEpLCBlcShyZXMsYSkpKSwgMSkKICAgICAgY2FzZSAwIHsKICAgICAgICBlcnIgOj0gMQogICAgICAgIHJlcyA6PSAwCiAgICAgIH0KICAgIH0KICAgIGlmIChlcnIpCiAgICAgIEVycigibWludXMgZnVuYyB1bmRlcmZsb3ciKTsKICB9Cn0='.
	

]
