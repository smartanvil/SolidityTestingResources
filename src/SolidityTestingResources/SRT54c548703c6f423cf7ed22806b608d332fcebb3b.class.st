Class {
	#name : #SRT54c548703c6f423cf7ed22806b608d332fcebb3b,
	#superclass : #SRTContracts,
	#category : #SolidityTestingResources
}

{ #category : #base64 }
SRT54c548703c6f423cf7ed22806b608d332fcebb3b >> base64 [
	^ 'cHJhZ21hIHNvbGlkaXR5IF4wLjQuMTM7CgovKioKICogQHRpdGxlIFNhZmVNYXRoCiAqIEBkZXYgTWF0aCBvcGVyYXRpb25zIHdpdGggc2FmZXR5IGNoZWNrcyB0aGF0IHRocm93IG9uIGVycm9yCiAqLwpsaWJyYXJ5IFNhZmVNYXRoIHsKICBmdW5jdGlvbiBtdWwodWludDI1NiBhLCB1aW50MjU2IGIpIGludGVybmFsIGNvbnN0YW50IHJldHVybnMgKHVpbnQyNTYpIHsKICAgIHVpbnQyNTYgYyA9IGEgKiBiOwogICAgYXNzZXJ0KGEgPT0gMCB8fCBjIC8gYSA9PSBiKTsKICAgIHJldHVybiBjOwogIH0KCiAgZnVuY3Rpb24gZGl2KHVpbnQyNTYgYSwgdWludDI1NiBiKSBpbnRlcm5hbCBjb25zdGFudCByZXR1cm5zICh1aW50MjU2KSB7CiAgICAvLyBhc3NlcnQoYiA+IDApOyAvLyBTb2xpZGl0eSBhdXRvbWF0aWNhbGx5IHRocm93cyB3aGVuIGRpdmlkaW5nIGJ5IDAKICAgIHVpbnQyNTYgYyA9IGEgLyBiOwogICAgLy8gYXNzZXJ0KGEgPT0gYiAqIGMgKyBhICUgYik7IC8vIFRoZXJlIGlzIG5vIGNhc2UgaW4gd2hpY2ggdGhpcyBkb2Vzbid0IGhvbGQKICAgIHJldHVybiBjOwogIH0KCiAgZnVuY3Rpb24gc3ViKHVpbnQyNTYgYSwgdWludDI1NiBiKSBpbnRlcm5hbCBjb25zdGFudCByZXR1cm5zICh1aW50MjU2KSB7CiAgICBhc3NlcnQoYiA8PSBhKTsKICAgIHJldHVybiBhIC0gYjsKICB9CgogIGZ1bmN0aW9uIGFkZCh1aW50MjU2IGEsIHVpbnQyNTYgYikgaW50ZXJuYWwgY29uc3RhbnQgcmV0dXJucyAodWludDI1NikgewogICAgdWludDI1NiBjID0gYSArIGI7CiAgICBhc3NlcnQoYyA+PSBhKTsKICAgIHJldHVybiBjOwogIH0KfQoKLyoqCiAqIEB0aXRsZSBPd25hYmxlCiAqIEBkZXYgVGhlIE93bmFibGUgY29udHJhY3QgaGFzIGFuIG93bmVyIGFkZHJlc3MsIGFuZCBwcm92aWRlcyBiYXNpYyBhdXRob3JpemF0aW9uIGNvbnRyb2wKICogZnVuY3Rpb25zLCB0aGlzIHNpbXBsaWZpZXMgdGhlIGltcGxlbWVudGF0aW9uIG9mICJ1c2VyIHBlcm1pc3Npb25zIi4KICovCmNvbnRyYWN0IE93bmFibGUgewogIGFkZHJlc3MgcHVibGljIG93bmVyOwoKCiAgZXZlbnQgT3duZXJzaGlwVHJhbnNmZXJyZWQoYWRkcmVzcyBpbmRleGVkIHByZXZpb3VzT3duZXIsIGFkZHJlc3MgaW5kZXhlZCBuZXdPd25lcik7CgoKICAvKioKICAgKiBAZGV2IFRoZSBPd25hYmxlIGNvbnN0cnVjdG9yIHNldHMgdGhlIG9yaWdpbmFsIGBvd25lcmAgb2YgdGhlIGNvbnRyYWN0IHRvIHRoZSBzZW5kZXIKICAgKiBhY2NvdW50LgogICAqLwogIGZ1bmN0aW9uIE93bmFibGUoKSB7CiAgICBvd25lciA9IG1zZy5zZW5kZXI7CiAgfQoKCiAgLyoqCiAgICogQGRldiBUaHJvd3MgaWYgY2FsbGVkIGJ5IGFueSBhY2NvdW50IG90aGVyIHRoYW4gdGhlIG93bmVyLgogICAqLwogIG1vZGlmaWVyIG9ubHlPd25lcigpIHsKICAgIHJlcXVpcmUobXNnLnNlbmRlciA9PSBvd25lcik7CiAgICBfOwogIH0KCgogIC8qKgogICAqIEBkZXYgQWxsb3dzIHRoZSBjdXJyZW50IG93bmVyIHRvIHRyYW5zZmVyIGNvbnRyb2wgb2YgdGhlIGNvbnRyYWN0IHRvIGEgbmV3T3duZXIuCiAgICogQHBhcmFtIG5ld093bmVyIFRoZSBhZGRyZXNzIHRvIHRyYW5zZmVyIG93bmVyc2hpcCB0by4KICAgKi8KICBmdW5jdGlvbiB0cmFuc2Zlck93bmVyc2hpcChhZGRyZXNzIG5ld093bmVyKSBvbmx5T3duZXIgcHVibGljIHsKICAgIHJlcXVpcmUobmV3T3duZXIgIT0gYWRkcmVzcygwKSk7CiAgICBPd25lcnNoaXBUcmFuc2ZlcnJlZChvd25lciwgbmV3T3duZXIpOwogICAgb3duZXIgPSBuZXdPd25lcjsKICB9Cgp9Cgpjb250cmFjdCBBYnN0cmFjdFN0YXJiYXNlVG9rZW4gewogICAgZnVuY3Rpb24gaXNGdW5kcmFpc2VyKGFkZHJlc3MgZnVuZHJhaXNlckFkZHJlc3MpIHB1YmxpYyByZXR1cm5zIChib29sKTsKICAgIGZ1bmN0aW9uIGNvbXBhbnkoKSBwdWJsaWMgcmV0dXJucyAoYWRkcmVzcyk7CiAgICBmdW5jdGlvbiBhbGxvY2F0ZVRvQ3Jvd2RzYWxlUHVyY2hhc2VyKGFkZHJlc3MgdG8sIHVpbnQyNTYgdmFsdWUpIHB1YmxpYyByZXR1cm5zIChib29sKTsKICAgIGZ1bmN0aW9uIGFsbG9jYXRlVG9NYXJrZXRpbmdTdXBwb3J0ZXIoYWRkcmVzcyB0bywgdWludDI1NiB2YWx1ZSkgcHVibGljIHJldHVybnMgKGJvb2wpOwp9CgoKY29udHJhY3QgQWJzdHJhY3RTdGFyYmFzZUNyb3dkc2FsZSB7CiAgICBmdW5jdGlvbiBzdGFydERhdGUoKSBjb25zdGFudCByZXR1cm5zICh1aW50MjU2KSB7fQogICAgZnVuY3Rpb24gZW5kZWRBdCgpIGNvbnN0YW50IHJldHVybnMgKHVpbnQyNTYpIHt9CiAgICBmdW5jdGlvbiBpc0VuZGVkKCkgY29uc3RhbnQgcmV0dXJucyAoYm9vbCk7CiAgICBmdW5jdGlvbiB0b3RhbFJhaXNlZEFtb3VudEluQ255KCkgY29uc3RhbnQgcmV0dXJucyAodWludDI1Nik7CiAgICBmdW5jdGlvbiBudW1PZlB1cmNoYXNlZFRva2Vuc09uQ3NCeShhZGRyZXNzIHB1cmNoYXNlcikgY29uc3RhbnQgcmV0dXJucyAodWludDI1Nik7CiAgICBmdW5jdGlvbiBudW1PZlB1cmNoYXNlZFRva2Vuc09uRXBCeShhZGRyZXNzIHB1cmNoYXNlcikgY29uc3RhbnQgcmV0dXJucyAodWludDI1Nik7Cn0KCi8vLyBAdGl0bGUgRWFybHlQdXJjaGFzZSBjb250cmFjdCAtIEtlZXAgdHJhY2sgb2YgcHVyY2hhc2VkIGFtb3VudCBieSBFYXJseSBQdXJjaGFzZXJzCi8vLyBAYXV0aG9yIFN0YXJiYXNlIFBURS4gTFRELiAtIDw8c3BhbiBjbGFzcz0iX19jZl9lbWFpbF9fIiBkYXRhLWNmZW1haWw9IjQ0MmQyYTIyMmIwNDM3MzAyNTM2MjYyNTM3MjE2YTI3MmIiPltlbWFpbCYjMTYwO3Byb3RlY3RlZF08L3NwYW4+Pgpjb250cmFjdCBTdGFyYmFzZUVhcmx5UHVyY2hhc2UgewogICAgLyoKICAgICAqICBDb25zdGFudHMKICAgICAqLwogICAgc3RyaW5nIHB1YmxpYyBjb25zdGFudCBQVVJDSEFTRV9BTU9VTlRfVU5JVCA9ICdDTlknOyAgICAvLyBDaGluZXNlIFl1YW4KICAgIHN0cmluZyBwdWJsaWMgY29uc3RhbnQgUFVSQ0hBU0VfQU1PVU5UX1JBVEVfUkVGRVJFTkNFID0gJ2h0dHA6Ly93d3cueGUuY29tL2N1cnJlbmN5dGFibGVzLyc7CiAgICB1aW50MjU2IHB1YmxpYyBjb25zdGFudCBQVVJDSEFTRV9BTU9VTlRfQ0FQID0gOTAwMDAwMDsKCiAgICAvKgogICAgICogIFR5cGVzCiAgICAgKi8KICAgIHN0cnVjdCBFYXJseVB1cmNoYXNlIHsKICAgICAgICBhZGRyZXNzIHB1cmNoYXNlcjsKICAgICAgICB1aW50MjU2IGFtb3VudDsgICAgICAgIC8vIENOWSBiYXNlZCBhbW91bnQKICAgICAgICB1aW50MjU2IHB1cmNoYXNlZEF0OyAgIC8vIHRpbWVzdGFtcAogICAgfQoKICAgIC8qCiAgICAgKiAgRXh0ZXJuYWwgY29udHJhY3RzCiAgICAgKi8KICAgIEFic3RyYWN0U3RhcmJhc2VDcm93ZHNhbGUgcHVibGljIHN0YXJiYXNlQ3Jvd2RzYWxlOwoKICAgIC8qCiAgICAgKiAgU3RvcmFnZQogICAgICovCiAgICBhZGRyZXNzIHB1YmxpYyBvd25lcjsKICAgIEVhcmx5UHVyY2hhc2VbXSBwdWJsaWMgZWFybHlQdXJjaGFzZXM7CiAgICB1aW50MjU2IHB1YmxpYyBlYXJseVB1cmNoYXNlQ2xvc2VkQXQ7CgogICAgLyoKICAgICAqICBNb2RpZmllcnMKICAgICAqLwogICAgbW9kaWZpZXIgbm9FdGhlcigpIHsKICAgICAgICByZXF1aXJlKG1zZy52YWx1ZSA9PSAwKTsKICAgICAgICBfOwogICAgfQoKICAgIG1vZGlmaWVyIG9ubHlPd25lcigpIHsKICAgICAgICByZXF1aXJlKG1zZy5zZW5kZXIgPT0gb3duZXIpOwogICAgICAgIF87CiAgICB9CgogICAgbW9kaWZpZXIgb25seUJlZm9yZUNyb3dkc2FsZSgpIHsKICAgICAgICBhc3NlcnQoYWRkcmVzcyhzdGFyYmFzZUNyb3dkc2FsZSkgPT0gYWRkcmVzcygwKSB8fCBzdGFyYmFzZUNyb3dkc2FsZS5zdGFydERhdGUoKSA9PSAwKTsKICAgICAgICBfOwogICAgfQoKICAgIG1vZGlmaWVyIG9ubHlFYXJseVB1cmNoYXNlVGVybSgpIHsKICAgICAgICBhc3NlcnQoZWFybHlQdXJjaGFzZUNsb3NlZEF0IDw9IDApOwogICAgICAgIF87CiAgICB9CgogICAgLyoKICAgICAqICBDb250cmFjdCBmdW5jdGlvbnMKICAgICAqLwoKICAgIC8qKgogICAgICogQGRldiBSZXR1cm5zIGVhcmx5IHB1cmNoYXNlZCBhbW91bnQgYnkgcHVyY2hhc2VyJ3MgYWRkcmVzcwogICAgICogQHBhcmFtIHB1cmNoYXNlciBQdXJjaGFzZXIgYWRkcmVzcwogICAgICovCiAgICBmdW5jdGlvbiBwdXJjaGFzZWRBbW91bnRCeShhZGRyZXNzIHB1cmNoYXNlcikKICAgICAgICBleHRlcm5hbAogICAgICAgIGNvbnN0YW50CiAgICAgICAgbm9FdGhlcgogICAgICAgIHJldHVybnMgKHVpbnQyNTYgYW1vdW50KQogICAgewogICAgICAgIGZvciAodWludDI1NiBpOyBpIDwgZWFybHlQdXJjaGFzZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgaWYgKGVhcmx5UHVyY2hhc2VzW2ldLnB1cmNoYXNlciA9PSBwdXJjaGFzZXIpIHsKICAgICAgICAgICAgICAgIGFtb3VudCArPSBlYXJseVB1cmNoYXNlc1tpXS5hbW91bnQ7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBAZGV2IFJldHVybnMgdG90YWwgYW1vdW50IG9mIHJhaXNlZCBmdW5kcyBieSBFYXJseSBQdXJjaGFzZXJzCiAgICAgKi8KICAgIGZ1bmN0aW9uIHRvdGFsQW1vdW50T2ZFYXJseVB1cmNoYXNlcygpCiAgICAgICAgY29uc3RhbnQKICAgICAgICBub0V0aGVyCiAgICAgICAgcHVibGljCiAgICAgICAgcmV0dXJucyAodWludDI1NiB0b3RhbEFtb3VudCkKICAgIHsKICAgICAgICBmb3IgKHVpbnQyNTYgaTsgaSA8IGVhcmx5UHVyY2hhc2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHRvdGFsQW1vdW50ICs9IGVhcmx5UHVyY2hhc2VzW2ldLmFtb3VudDsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBAZGV2IFJldHVybnMgbnVtYmVyIG9mIGVhcmx5IHB1cmNoYXNlcwogICAgICovCiAgICBmdW5jdGlvbiBudW1iZXJPZkVhcmx5UHVyY2hhc2VzKCkKICAgICAgICBleHRlcm5hbAogICAgICAgIGNvbnN0YW50CiAgICAgICAgbm9FdGhlcgogICAgICAgIHJldHVybnMgKHVpbnQyNTYpCiAgICB7CiAgICAgICAgcmV0dXJuIGVhcmx5UHVyY2hhc2VzLmxlbmd0aDsKICAgIH0KCiAgICAvKioKICAgICAqIEBkZXYgQXBwZW5kIGFuIGVhcmx5IHB1cmNoYXNlIGxvZwogICAgICogQHBhcmFtIHB1cmNoYXNlciBQdXJjaGFzZXIgYWRkcmVzcwogICAgICogQHBhcmFtIGFtb3VudCBQdXJjaGFzZSBhbW91bnQKICAgICAqIEBwYXJhbSBwdXJjaGFzZWRBdCBUaW1lc3RhbXAgb2YgcHVyY2hhc2VkIGRhdGUKICAgICAqLwogICAgZnVuY3Rpb24gYXBwZW5kRWFybHlQdXJjaGFzZShhZGRyZXNzIHB1cmNoYXNlciwgdWludDI1NiBhbW91bnQsIHVpbnQyNTYgcHVyY2hhc2VkQXQpCiAgICAgICAgZXh0ZXJuYWwKICAgICAgICBub0V0aGVyCiAgICAgICAgb25seU93bmVyCiAgICAgICAgb25seUJlZm9yZUNyb3dkc2FsZQogICAgICAgIG9ubHlFYXJseVB1cmNoYXNlVGVybQogICAgICAgIHJldHVybnMgKGJvb2wpCiAgICB7CiAgICAgICAgaWYgKGFtb3VudCA9PSAwIHx8CiAgICAgICAgICAgIHRvdGFsQW1vdW50T2ZFYXJseVB1cmNoYXNlcygpICsgYW1vdW50ID4gUFVSQ0hBU0VfQU1PVU5UX0NBUCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIGFzc2VydChwdXJjaGFzZWRBdCAhPSAwIHx8IHB1cmNoYXNlZEF0IDw9IG5vdyk7CgogICAgICAgIGVhcmx5UHVyY2hhc2VzLnB1c2goRWFybHlQdXJjaGFzZShwdXJjaGFzZXIsIGFtb3VudCwgcHVyY2hhc2VkQXQpKTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICAvKioKICAgICAqIEBkZXYgQ2xvc2UgZWFybHkgcHVyY2hhc2UgdGVybQogICAgICovCiAgICBmdW5jdGlvbiBjbG9zZUVhcmx5UHVyY2hhc2UoKQogICAgICAgIGV4dGVybmFsCiAgICAgICAgbm9FdGhlcgogICAgICAgIG9ubHlPd25lcgogICAgICAgIHJldHVybnMgKGJvb2wpCiAgICB7CiAgICAgICAgZWFybHlQdXJjaGFzZUNsb3NlZEF0ID0gbm93OwogICAgfQoKICAgIC8qKgogICAgICogQGRldiBTZXR1cCBmdW5jdGlvbiBzZXRzIGV4dGVybmFsIGNvbnRyYWN0J3MgYWRkcmVzcwogICAgICogQHBhcmFtIHN0YXJiYXNlQ3Jvd2RzYWxlQWRkcmVzcyBUb2tlbiBhZGRyZXNzCiAgICAgKi8KICAgIGZ1bmN0aW9uIHNldHVwKGFkZHJlc3Mgc3RhcmJhc2VDcm93ZHNhbGVBZGRyZXNzKQogICAgICAgIGV4dGVybmFsCiAgICAgICAgbm9FdGhlcgogICAgICAgIG9ubHlPd25lcgogICAgICAgIHJldHVybnMgKGJvb2wpCiAgICB7CiAgICAgICAgaWYgKGFkZHJlc3Moc3RhcmJhc2VDcm93ZHNhbGUpID09IDApIHsKICAgICAgICAgICAgc3RhcmJhc2VDcm93ZHNhbGUgPSBBYnN0cmFjdFN0YXJiYXNlQ3Jvd2RzYWxlKHN0YXJiYXNlQ3Jvd2RzYWxlQWRkcmVzcyk7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgLyoqCiAgICAgKiBAZGV2IENvbnRyYWN0IGNvbnN0cnVjdG9yIGZ1bmN0aW9uCiAgICAgKi8KICAgIGZ1bmN0aW9uIFN0YXJiYXNlRWFybHlQdXJjaGFzZSgpIG5vRXRoZXIgewogICAgICAgIG93bmVyID0gbXNnLnNlbmRlcjsKICAgIH0KfQoKLy8vIEB0aXRsZSBFYXJseVB1cmNoYXNlQW1lbmRtZW50IGNvbnRyYWN0IC0gQW1lbmQgZWFybHkgcHVyY2hhc2UgcmVjb3JkcyBvZiB0aGUgb3JpZ2luYWwgY29udHJhY3QKLy8vIEBhdXRob3IgU3RhcmJhc2UgUFRFLiBMVEQuIC0gPDxzcGFuIGNsYXNzPSJfX2NmX2VtYWlsX18iIGRhdGEtY2ZlbWFpbD0iYzZiNWIzYjZiNmE5YjRiMjg2YjViMmE3YjRhNGE3YjVhM2U4YTVhOSI+W2VtYWlsJiMxNjA7cHJvdGVjdGVkXTwvc3Bhbj4+CmNvbnRyYWN0IFN0YXJiYXNlRWFybHlQdXJjaGFzZUFtZW5kbWVudCB7CiAgICAvKgogICAgICogIEV2ZW50cwogICAgICovCiAgICBldmVudCBFYXJseVB1cmNoYXNlSW52YWxpZGF0ZWQodWludDI1NiBlcElkeCk7CiAgICBldmVudCBFYXJseVB1cmNoYXNlQW1lbmRlZCh1aW50MjU2IGVwSWR4KTsKCiAgICAvKgogICAgICogIEV4dGVybmFsIGNvbnRyYWN0cwogICAgICovCiAgICBBYnN0cmFjdFN0YXJiYXNlQ3Jvd2RzYWxlIHB1YmxpYyBzdGFyYmFzZUNyb3dkc2FsZTsKICAgIFN0YXJiYXNlRWFybHlQdXJjaGFzZSBwdWJsaWMgc3RhcmJhc2VFYXJseVB1cmNoYXNlOwoKICAgIC8qCiAgICAgKiAgU3RvcmFnZQogICAgICovCiAgICBhZGRyZXNzIHB1YmxpYyBvd25lcjsKICAgIHVpbnQyNTZbXSBwdWJsaWMgaW52YWxpZEVhcmx5UHVyY2hhc2VJbmRleGVzOwogICAgdWludDI1NltdIHB1YmxpYyBhbWVuZGVkRWFybHlQdXJjaGFzZUluZGV4ZXM7CiAgICBtYXBwaW5nICh1aW50MjU2ID0+IFN0YXJiYXNlRWFybHlQdXJjaGFzZS5FYXJseVB1cmNoYXNlKSBwdWJsaWMgYW1lbmRlZEVhcmx5UHVyY2hhc2VzOwoKICAgIC8qCiAgICAgKiAgTW9kaWZpZXJzCiAgICAgKi8KICAgIG1vZGlmaWVyIG5vRXRoZXIoKSB7CiAgICAgICAgcmVxdWlyZShtc2cudmFsdWUgPT0gMCk7CiAgICAgICAgXzsKICAgIH0KCiAgICBtb2RpZmllciBvbmx5T3duZXIoKSB7CiAgICAgICAgcmVxdWlyZShtc2cuc2VuZGVyID09IG93bmVyKTsKICAgICAgICBfOwogICAgfQoKICAgIG1vZGlmaWVyIG9ubHlCZWZvcmVDcm93ZHNhbGUoKSB7CiAgICAgICAgYXNzZXJ0KGFkZHJlc3Moc3RhcmJhc2VDcm93ZHNhbGUpID09IGFkZHJlc3MoMCkgfHwgc3RhcmJhc2VDcm93ZHNhbGUuc3RhcnREYXRlKCkgPT0gMCk7CiAgICAgICAgXzsKICAgIH0KCiAgICBtb2RpZmllciBvbmx5RWFybHlQdXJjaGFzZXNMb2FkZWQoKSB7CiAgICAgICAgYXNzZXJ0KGFkZHJlc3Moc3RhcmJhc2VFYXJseVB1cmNoYXNlKSAhPSBhZGRyZXNzKDApKTsKICAgICAgICBfOwogICAgfQoKICAgIC8qCiAgICAgKiAgRnVuY3Rpb25zIGJlbG93IGFyZSBjb21wYXRpYmxlIHdpdGggc3RhcmJhc2VFYXJseVB1cmNoYXNlIGNvbnRyYWN0CiAgICAgKi8KCiAgICAvKioKICAgICAqIEBkZXYgUmV0dXJucyBhbiBlYXJseSBwdXJjaGFzZSByZWNvcmQKICAgICAqIEBwYXJhbSBlYXJseVB1cmNoYXNlSW5kZXggSW5kZXggbnVtYmVyIG9mIGFuIGVhcmx5IHB1cmNoYXNlCiAgICAgKi8KICAgIGZ1bmN0aW9uIGVhcmx5UHVyY2hhc2VzKHVpbnQyNTYgZWFybHlQdXJjaGFzZUluZGV4KQogICAgICAgIGV4dGVybmFsCiAgICAgICAgY29uc3RhbnQKICAgICAgICBvbmx5RWFybHlQdXJjaGFzZXNMb2FkZWQKICAgICAgICByZXR1cm5zIChhZGRyZXNzIHB1cmNoYXNlciwgdWludDI1NiBhbW91bnQsIHVpbnQyNTYgcHVyY2hhc2VkQXQpCiAgICB7CiAgICAgICAgcmV0dXJuIHN0YXJiYXNlRWFybHlQdXJjaGFzZS5lYXJseVB1cmNoYXNlcyhlYXJseVB1cmNoYXNlSW5kZXgpOwogICAgfQoKICAgIC8qKgogICAgICogQGRldiBSZXR1cm5zIGVhcmx5IHB1cmNoYXNlZCBhbW91bnQgYnkgcHVyY2hhc2VyJ3MgYWRkcmVzcwogICAgICogQHBhcmFtIHB1cmNoYXNlciBQdXJjaGFzZXIgYWRkcmVzcwogICAgICovCiAgICBmdW5jdGlvbiBwdXJjaGFzZWRBbW91bnRCeShhZGRyZXNzIHB1cmNoYXNlcikKICAgICAgICBleHRlcm5hbAogICAgICAgIGNvbnN0YW50CiAgICAgICAgbm9FdGhlcgogICAgICAgIHJldHVybnMgKHVpbnQyNTYgYW1vdW50KQogICAgewogICAgICAgIFN0YXJiYXNlRWFybHlQdXJjaGFzZS5FYXJseVB1cmNoYXNlW10gbWVtb3J5IG5vcm1hbGl6ZWRFUCA9CiAgICAgICAgICAgIG5vcm1hbGl6ZWRFYXJseVB1cmNoYXNlcygpOwogICAgICAgIGZvciAodWludDI1NiBpOyBpIDwgbm9ybWFsaXplZEVQLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGlmIChub3JtYWxpemVkRVBbaV0ucHVyY2hhc2VyID09IHB1cmNoYXNlcikgewogICAgICAgICAgICAgICAgYW1vdW50ICs9IG5vcm1hbGl6ZWRFUFtpXS5hbW91bnQ7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBAZGV2IFJldHVybnMgdG90YWwgYW1vdW50IG9mIHJhaXNlZCBmdW5kcyBieSBFYXJseSBQdXJjaGFzZXJzCiAgICAgKi8KICAgIGZ1bmN0aW9uIHRvdGFsQW1vdW50T2ZFYXJseVB1cmNoYXNlcygpCiAgICAgICAgY29uc3RhbnQKICAgICAgICBub0V0aGVyCiAgICAgICAgcHVibGljCiAgICAgICAgcmV0dXJucyAodWludDI1NiB0b3RhbEFtb3VudCkKICAgIHsKICAgICAgICBTdGFyYmFzZUVhcmx5UHVyY2hhc2UuRWFybHlQdXJjaGFzZVtdIG1lbW9yeSBub3JtYWxpemVkRVAgPQogICAgICAgICAgICBub3JtYWxpemVkRWFybHlQdXJjaGFzZXMoKTsKICAgICAgICBmb3IgKHVpbnQyNTYgaTsgaSA8IG5vcm1hbGl6ZWRFUC5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB0b3RhbEFtb3VudCArPSBub3JtYWxpemVkRVBbaV0uYW1vdW50OwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIEBkZXYgUmV0dXJucyBudW1iZXIgb2YgZWFybHkgcHVyY2hhc2VzCiAgICAgKi8KICAgIGZ1bmN0aW9uIG51bWJlck9mRWFybHlQdXJjaGFzZXMoKQogICAgICAgIGV4dGVybmFsCiAgICAgICAgY29uc3RhbnQKICAgICAgICBub0V0aGVyCiAgICAgICAgcmV0dXJucyAodWludDI1NikKICAgIHsKICAgICAgICByZXR1cm4gbm9ybWFsaXplZEVhcmx5UHVyY2hhc2VzKCkubGVuZ3RoOwogICAgfQoKICAgIC8qKgogICAgICogQGRldiBTZXRzIHVwIGZ1bmN0aW9uIHNldHMgZXh0ZXJuYWwgY29udHJhY3QncyBhZGRyZXNzCiAgICAgKiBAcGFyYW0gc3RhcmJhc2VDcm93ZHNhbGVBZGRyZXNzIFRva2VuIGFkZHJlc3MKICAgICAqLwogICAgZnVuY3Rpb24gc2V0dXAoYWRkcmVzcyBzdGFyYmFzZUNyb3dkc2FsZUFkZHJlc3MpCiAgICAgICAgZXh0ZXJuYWwKICAgICAgICBub0V0aGVyCiAgICAgICAgb25seU93bmVyCiAgICAgICAgcmV0dXJucyAoYm9vbCkKICAgIHsKICAgICAgICBpZiAoYWRkcmVzcyhzdGFyYmFzZUNyb3dkc2FsZSkgPT0gMCkgewogICAgICAgICAgICBzdGFyYmFzZUNyb3dkc2FsZSA9IEFic3RyYWN0U3RhcmJhc2VDcm93ZHNhbGUoc3RhcmJhc2VDcm93ZHNhbGVBZGRyZXNzKTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICAvKgogICAgICogIENvbnRyYWN0IGZ1bmN0aW9ucyB1bmlxdWUgdG8gU3RhcmJhc2VFYXJseVB1cmNoYXNlQW1lbmRtZW50CiAgICAgKi8KCiAgICAgLyoqCiAgICAgICogQGRldiBJbnZhbGlkYXRlIGVhcmx5IHB1cmNoYXNlCiAgICAgICogQHBhcmFtIGVhcmx5UHVyY2hhc2VJbmRleCBJbmRleCBudW1iZXIgb2YgdGhlIHB1cmNoYXNlCiAgICAgICovCiAgICBmdW5jdGlvbiBpbnZhbGlkYXRlRWFybHlQdXJjaGFzZSh1aW50MjU2IGVhcmx5UHVyY2hhc2VJbmRleCkKICAgICAgICBleHRlcm5hbAogICAgICAgIG5vRXRoZXIKICAgICAgICBvbmx5T3duZXIKICAgICAgICBvbmx5RWFybHlQdXJjaGFzZXNMb2FkZWQKICAgICAgICBvbmx5QmVmb3JlQ3Jvd2RzYWxlCiAgICAgICAgcmV0dXJucyAoYm9vbCkKICAgIHsKICAgICAgICBhc3NlcnQobnVtYmVyT2ZSYXdFYXJseVB1cmNoYXNlcygpID4gZWFybHlQdXJjaGFzZUluZGV4KTsgLy8gQXJyYXkgSW5kZXggT3V0IG9mIEJvdW5kcyBFeGNlcHRpb24KCiAgICAgICAgZm9yICh1aW50MjU2IGk7IGkgPCBpbnZhbGlkRWFybHlQdXJjaGFzZUluZGV4ZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgYXNzZXJ0KGludmFsaWRFYXJseVB1cmNoYXNlSW5kZXhlc1tpXSAhPSBlYXJseVB1cmNoYXNlSW5kZXgpOwogICAgICAgIH0KCiAgICAgICAgaW52YWxpZEVhcmx5UHVyY2hhc2VJbmRleGVzLnB1c2goZWFybHlQdXJjaGFzZUluZGV4KTsKICAgICAgICBFYXJseVB1cmNoYXNlSW52YWxpZGF0ZWQoZWFybHlQdXJjaGFzZUluZGV4KTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICAvKioKICAgICAqIEBkZXYgQ2hlY2tzIHdoZXRoZXIgZWFybHkgcHVyY2hhc2UgaXMgaW52YWxpZAogICAgICogQHBhcmFtIGVhcmx5UHVyY2hhc2VJbmRleCBJbmRleCBudW1iZXIgb2YgdGhlIHB1cmNoYXNlCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzSW52YWxpZEVhcmx5UHVyY2hhc2UodWludDI1NiBlYXJseVB1cmNoYXNlSW5kZXgpCiAgICAgICAgY29uc3RhbnQKICAgICAgICBub0V0aGVyCiAgICAgICAgcHVibGljCiAgICAgICAgcmV0dXJucyAoYm9vbCkKICAgIHsKICAgICAgICBhc3NlcnQobnVtYmVyT2ZSYXdFYXJseVB1cmNoYXNlcygpID4gZWFybHlQdXJjaGFzZUluZGV4KTsgLy8gQXJyYXkgSW5kZXggT3V0IG9mIEJvdW5kcyBFeGNlcHRpb24KCgogICAgICAgIGZvciAodWludDI1NiBpOyBpIDwgaW52YWxpZEVhcmx5UHVyY2hhc2VJbmRleGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGlmIChpbnZhbGlkRWFybHlQdXJjaGFzZUluZGV4ZXNbaV0gPT0gZWFybHlQdXJjaGFzZUluZGV4KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgLyoqCiAgICAgKiBAZGV2IEFtZW5kcyBhIGdpdmVuIGVhcmx5IHB1cmNoYXNlIHdpdGggZGF0YQogICAgICogQHBhcmFtIGVhcmx5UHVyY2hhc2VJbmRleCBJbmRleCBudW1iZXIgb2YgdGhlIHB1cmNoYXNlCiAgICAgKiBAcGFyYW0gcHVyY2hhc2VyIFB1cmNoYXNlcidzIGFkZHJlc3MKICAgICAqIEBwYXJhbSBhbW91bnQgVmFsdWUgb2YgcHVyY2hhc2UKICAgICAqIEBwYXJhbSBwdXJjaGFzZWRBdCBQdXJjaGFzZSB0aW1lc3RhbXAKICAgICAqLwogICAgZnVuY3Rpb24gYW1lbmRFYXJseVB1cmNoYXNlKHVpbnQyNTYgZWFybHlQdXJjaGFzZUluZGV4LCBhZGRyZXNzIHB1cmNoYXNlciwgdWludDI1NiBhbW91bnQsIHVpbnQyNTYgcHVyY2hhc2VkQXQpCiAgICAgICAgZXh0ZXJuYWwKICAgICAgICBub0V0aGVyCiAgICAgICAgb25seU93bmVyCiAgICAgICAgb25seUVhcmx5UHVyY2hhc2VzTG9hZGVkCiAgICAgICAgb25seUJlZm9yZUNyb3dkc2FsZQogICAgICAgIHJldHVybnMgKGJvb2wpCiAgICB7CiAgICAgICAgYXNzZXJ0KHB1cmNoYXNlZEF0ICE9IDAgfHwgcHVyY2hhc2VkQXQgPD0gbm93KTsKCiAgICAgICAgYXNzZXJ0KG51bWJlck9mUmF3RWFybHlQdXJjaGFzZXMoKSA+IGVhcmx5UHVyY2hhc2VJbmRleCk7CgogICAgICAgIGFzc2VydCghaXNJbnZhbGlkRWFybHlQdXJjaGFzZShlYXJseVB1cmNoYXNlSW5kZXgpKTsgLy8gSW52YWxpZCBlYXJseSBwdXJjaGFzZSBjYW5ub3QgYmUgYW1lbmRlZAoKICAgICAgICBpZiAoIWlzQW1lbmRlZEVhcmx5UHVyY2hhc2UoZWFybHlQdXJjaGFzZUluZGV4KSkgewogICAgICAgICAgICBhbWVuZGVkRWFybHlQdXJjaGFzZUluZGV4ZXMucHVzaChlYXJseVB1cmNoYXNlSW5kZXgpOwogICAgICAgIH0KCiAgICAgICAgYW1lbmRlZEVhcmx5UHVyY2hhc2VzW2Vhcmx5UHVyY2hhc2VJbmRleF0gPQogICAgICAgICAgICBTdGFyYmFzZUVhcmx5UHVyY2hhc2UuRWFybHlQdXJjaGFzZShwdXJjaGFzZXIsIGFtb3VudCwgcHVyY2hhc2VkQXQpOwogICAgICAgIEVhcmx5UHVyY2hhc2VBbWVuZGVkKGVhcmx5UHVyY2hhc2VJbmRleCk7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgLyoqCiAgICAgKiBAZGV2IENoZWNrcyB3aGV0aGVyIGVhcmx5IHB1cmNoYXNlIGlzIGFtZW5kZWQKICAgICAqIEBwYXJhbSBlYXJseVB1cmNoYXNlSW5kZXggSW5kZXggbnVtYmVyIG9mIHRoZSBwdXJjaGFzZQogICAgICovCiAgICBmdW5jdGlvbiBpc0FtZW5kZWRFYXJseVB1cmNoYXNlKHVpbnQyNTYgZWFybHlQdXJjaGFzZUluZGV4KQogICAgICAgIGNvbnN0YW50CiAgICAgICAgbm9FdGhlcgogICAgICAgIHJldHVybnMgKGJvb2wpCiAgICB7CiAgICAgICAgYXNzZXJ0KG51bWJlck9mUmF3RWFybHlQdXJjaGFzZXMoKSA+IGVhcmx5UHVyY2hhc2VJbmRleCk7IC8vIEFycmF5IEluZGV4IE91dCBvZiBCb3VuZHMgRXhjZXB0aW9uCgogICAgICAgIGZvciAodWludDI1NiBpOyBpIDwgYW1lbmRlZEVhcmx5UHVyY2hhc2VJbmRleGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGlmIChhbWVuZGVkRWFybHlQdXJjaGFzZUluZGV4ZXNbaV0gPT0gZWFybHlQdXJjaGFzZUluZGV4KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgLyoqCiAgICAgKiBAZGV2IExvYWRzIGVhcmx5IHB1cmNoYXNlcyBkYXRhIHRvIFN0YXJiYXNlRWFybHlQdXJjaGFzZUFtZW5kbWVudCBjb250cmFjdAogICAgICogQHBhcmFtIHN0YXJiYXNlRWFybHlQdXJjaGFzZUFkZHJlc3MgQWRkcmVzcyBmcm9tIHN0YXJiYXNlIGVhcmx5IHB1cmNoYXNlCiAgICAgKi8KICAgIGZ1bmN0aW9uIGxvYWRTdGFyYmFzZUVhcmx5UHVyY2hhc2VzKGFkZHJlc3Mgc3RhcmJhc2VFYXJseVB1cmNoYXNlQWRkcmVzcykKICAgICAgICBleHRlcm5hbAogICAgICAgIG5vRXRoZXIKICAgICAgICBvbmx5T3duZXIKICAgICAgICBvbmx5QmVmb3JlQ3Jvd2RzYWxlCiAgICAgICAgcmV0dXJucyAoYm9vbCkKICAgIHsKICAgICAgICBhc3NlcnQoc3RhcmJhc2VFYXJseVB1cmNoYXNlQWRkcmVzcyAhPSAwIHx8CiAgICAgICAgICAgIGFkZHJlc3Moc3RhcmJhc2VFYXJseVB1cmNoYXNlKSA9PSAwKTsKCiAgICAgICAgc3RhcmJhc2VFYXJseVB1cmNoYXNlID0gU3RhcmJhc2VFYXJseVB1cmNoYXNlKHN0YXJiYXNlRWFybHlQdXJjaGFzZUFkZHJlc3MpOwogICAgICAgIGFzc2VydChzdGFyYmFzZUVhcmx5UHVyY2hhc2UuZWFybHlQdXJjaGFzZUNsb3NlZEF0KCkgIT0gMCk7IC8vIHRoZSBlYXJseSBwdXJjaGFzZSBtdXN0IGJlIGNsb3NlZAoKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICAvKioKICAgICAqIEBkZXYgQ29udHJhY3QgY29uc3RydWN0b3IgZnVuY3Rpb24uIEl0IHNldHMgb3duZXIKICAgICAqLwogICAgZnVuY3Rpb24gU3RhcmJhc2VFYXJseVB1cmNoYXNlQW1lbmRtZW50KCkgbm9FdGhlciB7CiAgICAgICAgb3duZXIgPSBtc2cuc2VuZGVyOwogICAgfQoKICAgIC8qKgogICAgICogSW50ZXJuYWwgZnVuY3Rpb25zCiAgICAgKi8KCiAgICAvKioKICAgICAqIEBkZXYgTm9ybWFsaXplcyBlYXJseSBwdXJjaGFzZXMgZGF0YQogICAgICovCiAgICBmdW5jdGlvbiBub3JtYWxpemVkRWFybHlQdXJjaGFzZXMoKQogICAgICAgIGNvbnN0YW50CiAgICAgICAgaW50ZXJuYWwKICAgICAgICByZXR1cm5zIChTdGFyYmFzZUVhcmx5UHVyY2hhc2UuRWFybHlQdXJjaGFzZVtdIG5vcm1hbGl6ZWRFUCkKICAgIHsKICAgICAgICB1aW50MjU2IHJhd0VQQ291bnQgPSBudW1iZXJPZlJhd0Vhcmx5UHVyY2hhc2VzKCk7CiAgICAgICAgbm9ybWFsaXplZEVQID0gbmV3IFN0YXJiYXNlRWFybHlQdXJjaGFzZS5FYXJseVB1cmNoYXNlW10oCiAgICAgICAgICAgIHJhd0VQQ291bnQgLSBpbnZhbGlkRWFybHlQdXJjaGFzZUluZGV4ZXMubGVuZ3RoKTsKCiAgICAgICAgdWludDI1NiBub3JtYWxpemVkSWR4OwogICAgICAgIGZvciAodWludDI1NiBpOyBpIDwgcmF3RVBDb3VudDsgaSsrKSB7CiAgICAgICAgICAgIGlmIChpc0ludmFsaWRFYXJseVB1cmNoYXNlKGkpKSB7CiAgICAgICAgICAgICAgICBjb250aW51ZTsgICAvLyBpbnZhbGlkIGVhcmx5IHB1cmNoYXNlIHNob3VsZCBiZSBpZ25vcmVkCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIFN0YXJiYXNlRWFybHlQdXJjaGFzZS5FYXJseVB1cmNoYXNlIG1lbW9yeSBlcDsKICAgICAgICAgICAgaWYgKGlzQW1lbmRlZEVhcmx5UHVyY2hhc2UoaSkpIHsKICAgICAgICAgICAgICAgIGVwID0gYW1lbmRlZEVhcmx5UHVyY2hhc2VzW2ldOyAgLy8gYW1lbmRlZCBlYXJseSBwdXJjaGFzZSBzaG91bGQgdGFrZSBhIHByaW9yaXR5CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBlcCA9IGdldEVhcmx5UHVyY2hhc2UoaSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG5vcm1hbGl6ZWRFUFtub3JtYWxpemVkSWR4XSA9IGVwOwogICAgICAgICAgICBub3JtYWxpemVkSWR4Kys7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogQGRldiBGZXRjaGVzIGVhcmx5IHB1cmNoYXNlcyBkYXRhCiAgICAgKi8KICAgIGZ1bmN0aW9uIGdldEVhcmx5UHVyY2hhc2UodWludDI1NiBlYXJseVB1cmNoYXNlSW5kZXgpCiAgICAgICAgaW50ZXJuYWwKICAgICAgICBjb25zdGFudAogICAgICAgIG9ubHlFYXJseVB1cmNoYXNlc0xvYWRlZAogICAgICAgIHJldHVybnMgKFN0YXJiYXNlRWFybHlQdXJjaGFzZS5FYXJseVB1cmNoYXNlKQogICAgewogICAgICAgIHZhciAocHVyY2hhc2VyLCBhbW91bnQsIHB1cmNoYXNlZEF0KSA9CiAgICAgICAgICAgIHN0YXJiYXNlRWFybHlQdXJjaGFzZS5lYXJseVB1cmNoYXNlcyhlYXJseVB1cmNoYXNlSW5kZXgpOwogICAgICAgIHJldHVybiBTdGFyYmFzZUVhcmx5UHVyY2hhc2UuRWFybHlQdXJjaGFzZShwdXJjaGFzZXIsIGFtb3VudCwgcHVyY2hhc2VkQXQpOwogICAgfQoKICAgIC8qKgogICAgICogQGRldiBSZXR1cm5zIHJhdyBudW1iZXIgb2YgZWFybHkgcHVyY2hhc2VzCiAgICAgKi8KICAgIGZ1bmN0aW9uIG51bWJlck9mUmF3RWFybHlQdXJjaGFzZXMoKQogICAgICAgIGludGVybmFsCiAgICAgICAgY29uc3RhbnQKICAgICAgICBvbmx5RWFybHlQdXJjaGFzZXNMb2FkZWQKICAgICAgICByZXR1cm5zICh1aW50MjU2KQogICAgewogICAgICAgIHJldHVybiBzdGFyYmFzZUVhcmx5UHVyY2hhc2UubnVtYmVyT2ZFYXJseVB1cmNoYXNlcygpOwogICAgfQp9CgoKY29udHJhY3QgQ2VydGlmaWVyIHsKCWV2ZW50IENvbmZpcm1lZChhZGRyZXNzIGluZGV4ZWQgd2hvKTsKCWV2ZW50IFJldm9rZWQoYWRkcmVzcyBpbmRleGVkIHdobyk7CglmdW5jdGlvbiBjZXJ0aWZpZWQoYWRkcmVzcykgcHVibGljIGNvbnN0YW50IHJldHVybnMgKGJvb2wpOwoJZnVuY3Rpb24gZ2V0KGFkZHJlc3MsIHN0cmluZykgcHVibGljIGNvbnN0YW50IHJldHVybnMgKGJ5dGVzMzIpOwoJZnVuY3Rpb24gZ2V0QWRkcmVzcyhhZGRyZXNzLCBzdHJpbmcpIHB1YmxpYyBjb25zdGFudCByZXR1cm5zIChhZGRyZXNzKTsKCWZ1bmN0aW9uIGdldFVpbnQoYWRkcmVzcywgc3RyaW5nKSBwdWJsaWMgY29uc3RhbnQgcmV0dXJucyAodWludCk7Cn0KCi8qKgogKiBAdGl0bGUgQ3Jvd2RzYWxlIGNvbnRyYWN0IC0gU3RhcmJhc2UgY3Jvd2RzYWxlIHRvIGNyZWF0ZSBTVEFSLgogKiBAYXV0aG9yIFN0YXJiYXNlIFBURS4gTFRELiAtIDw8c3BhbiBjbGFzcz0iX19jZl9lbWFpbF9fIiBkYXRhLWNmZW1haWw9ImUxODg4Zjg3OGVhMTkyOTU4MDkzODM4MDkyODRjZjgyOGUiPltlbWFpbCYjMTYwO3Byb3RlY3RlZF08L3NwYW4+PgogKi8KY29udHJhY3QgU3RhcmJhc2VDcm93ZHNhbGUgaXMgT3duYWJsZSB7CiAgICB1c2luZyBTYWZlTWF0aCBmb3IgdWludDI1NjsKICAgIC8qCiAgICAgKiAgRXZlbnRzCiAgICAgKi8KICAgIGV2ZW50IENyb3dkc2FsZUVuZGVkKHVpbnQyNTYgZW5kZWRBdCk7CiAgICBldmVudCBTdGFyYmFzZVB1cmNoYXNlZFdpdGhFdGgoYWRkcmVzcyBwdXJjaGFzZXIsIHVpbnQyNTYgYW1vdW50LCB1aW50MjU2IHJhd0Ftb3VudCwgdWludDI1NiBjbnlFdGhSYXRlKTsKICAgIGV2ZW50IENueUV0aFJhdGVVcGRhdGVkKHVpbnQyNTYgY255RXRoUmF0ZSk7CiAgICBldmVudCBDbnlCdGNSYXRlVXBkYXRlZCh1aW50MjU2IGNueUJ0Y1JhdGUpOwogICAgZXZlbnQgUXVhbGlmaWVkUGFydG5lckFkZHJlc3MoYWRkcmVzcyBxdWFsaWZpZWRQYXJ0bmVyKTsKCiAgICAvKioKICAgICAqICBFeHRlcm5hbCBjb250cmFjdHMKICAgICAqLwogICAgQWJzdHJhY3RTdGFyYmFzZVRva2VuIHB1YmxpYyBzdGFyYmFzZVRva2VuOwogICAgU3RhcmJhc2VFYXJseVB1cmNoYXNlQW1lbmRtZW50IHB1YmxpYyBzdGFyYmFzZUVwQW1lbmRtZW50OwogICAgQ2VydGlmaWVyIHB1YmxpYyBwaWNvcHNDZXJ0aWZpZXI7CgogICAgLyoqCiAgICAgKiAgQ29uc3RhbnRzCiAgICAgKi8KICAgIHVpbnQyNTYgY29uc3RhbnQgcHVibGljIGNyb3dkc2FsZVRva2VuQW1vdW50ID0gMTI1MDAwMDAwZTE4OwogICAgdWludDI1NiBjb25zdGFudCBwdWJsaWMgZWFybHlQdXJjaGFzZVRva2VuQW1vdW50ID0gNTAwMDAwMDBlMTg7CiAgICB1aW50MjU2IGNvbnN0YW50IHB1YmxpYyBNSU5fSU5WRVNUTUVOVCA9IDE7IC8vIG1pbiBpcyAxIFdlaQogICAgdWludDI1NiBjb25zdGFudCBwdWJsaWMgTUFYX0NBUCA9IDY3MDAwMDAwOyAvLyBpbiBDTlkuIGFwcHJveGltYXRlbHkgMTBNIFVTRC4gKGluY2x1ZGVzIHJhaXNlZCBhbW91bnQgZnJvbSBib3RoIEVQIGFuZCBDUykKICAgIHN0cmluZyBwdWJsaWMgY29uc3RhbnQgUFVSQ0hBU0VfQU1PVU5UX1VOSVQgPSAnQ05ZJzsgIC8vIENoaW5lc2UgWXVhbgoKICAgIC8qKgogICAgICogVHlwZXMKICAgICAqLwogICAgc3RydWN0IENyb3dkc2FsZVB1cmNoYXNlIHsKICAgICAgICBhZGRyZXNzIHB1cmNoYXNlcjsKICAgICAgICB1aW50MjU2IGFtb3VudDsgICAgICAgIC8vIENOWSBiYXNlZCBhbW91bnQgd2l0aCBib251cwogICAgICAgIHVpbnQyNTYgcmF3QW1vdW50OyAgICAgLy8gQ05ZIGJhc2VkIGFtb3VudCBubyBib251cwogICAgICAgIHVpbnQyNTYgcHVyY2hhc2VkQXQ7ICAgLy8gdGltZXN0YW1wCiAgICB9CgogICAgc3RydWN0IFF1YWxpZmllZFBhcnRuZXJzIHsKICAgICAgICB1aW50MjU2IGFtb3VudENhcDsKICAgICAgICB1aW50MjU2IGFtb3VudFJhaXNlZDsKICAgICAgICBib29sICAgIGJvbmFGaWRlOwogICAgICAgIHVpbnQyNTYgY29tbWlzc2lvbkZlZVBlcmNlbnRhZ2U7IC8vIGV4YW1wbGUgNSB3aWxsIGNhbGN1bGF0ZSB0aGUgcGVyY2VudGFnZSBhcyA1JQogICAgfQoKICAgIC8qCiAgICAgKiAgRW51bXMKICAgICAqLwogICAgZW51bSBCb251c01pbGVzdG9uZXMgewogICAgICAgIEZpcnN0LAogICAgICAgIFNlY29uZCwKICAgICAgICBUaGlyZCwKICAgICAgICBGb3VydGgsCiAgICAgICAgRmlmdGgKICAgIH0KCiAgICAvLyBJbml0aWFsaXplIGJvbnVzTWlsZXN0b25lcwogICAgQm9udXNNaWxlc3RvbmVzIHB1YmxpYyBib251c01pbGVzdG9uZXMgPSBCb251c01pbGVzdG9uZXMuRmlyc3Q7CgogICAgLyoqCiAgICAgKiAgU3RvcmFnZQogICAgICovCiAgICB1aW50IHB1YmxpYyBudW1PZkRlbGl2ZXJlZENyb3dkc2FsZVB1cmNoYXNlczsgIC8vIGluZGV4IHRvIGtlZXAgdGhlIG51bWJlciBvZiBjcm93ZHNhbGUgcHVyY2hhc2VzIGhhdmUgYWxyZWFkeSBiZWVuIHByb2Nlc3NlZCBieSBgd2l0aGRyYXdQdXJjaGFzZWRUb2tlbnNgCiAgICB1aW50IHB1YmxpYyBudW1PZkRlbGl2ZXJlZEVhcmx5UHVyY2hhc2VzOyAgLy8gaW5kZXggdG8ga2VlcCB0aGUgbnVtYmVyIG9mIGVhcmx5IHB1cmNoYXNlcyBoYXZlIGFscmVhZHkgYmVlbiBwcm9jZXNzZWQgYnkgYHdpdGhkcmF3UHVyY2hhc2VkVG9rZW5zYAogICAgdWludDI1NiBwdWJsaWMgbnVtT2ZMb2FkZWRFYXJseVB1cmNoYXNlczsgLy8gaW5kZXggdG8ga2VlcCB0aGUgbnVtYmVyIG9mIGVhcmx5IHB1cmNoYXNlcyB0aGF0IGhhdmUgYWxyZWFkeSBiZWVuIGxvYWRlZCBieSBgbG9hZEVhcmx5UHVyY2hhc2VzYAoKICAgIC8vIGVhcmx5IHB1cmNoYXNlCiAgICBhZGRyZXNzW10gcHVibGljIGVhcmx5UHVyY2hhc2VyczsKICAgIG1hcHBpbmcgKGFkZHJlc3MgPT4gdWludDI1NikgcHVibGljIGVhcmx5UHVyY2hhc2VkQW1vdW50Qnk7IC8vIGVhcmx5IHB1cmNoYXNlZCBhbW91bnQgaW4gQ05ZIHBlciBwdXJjaGFzZXJzJyBhZGRyZXNzCiAgICBib29sIHB1YmxpYyBlYXJseVB1cmNoYXNlc0xvYWRlZCA9IGZhbHNlOyAgLy8gcmV0dXJucyB3aGV0aGVyIGFsbCBlYXJseSBwdXJjaGFzZXMgYXJlIGxvYWRlZCBpbnRvIHRoaXMgY29udHJhY3QKICAgIHVpbnQyNTYgcHVibGljIHRvdGFsQW1vdW50T2ZFYXJseVB1cmNoYXNlczsgLy8gaW5jbHVkaW5nIDIwJSBib251cwoKICAgIC8vIGNyb3dkc2FsZQogICAgYm9vbCBwdWJsaWMgcHJlc2FsZVB1cmNoYXNlc0xvYWRlZCA9IGZhbHNlOyAvLyByZXR1cm5zIHdoZXRoZXIgYWxsIHByZXNhbGUgcHVyY2hhc2VzIGFyZSBsb2FkZWQgaW50byB0aGlzIGNvbnRyYWN0CiAgICB1aW50MjU2IHB1YmxpYyBtYXhDcm93ZHNhbGVDYXA7ICAgICAvLyA9IDY3TSBDTlkgLSAodG90YWwgcmFpc2VkIGFtb3VudCBmcm9tIEVQKQogICAgdWludDI1NiBwdWJsaWMgdG90YWxBbW91bnRPZkNyb3dkc2FsZVB1cmNoYXNlczsgLy8gaW4gQ05ZLCBpbmNsdWRpbmcgYm9udXNlcwogICAgdWludDI1NiBwdWJsaWMgdG90YWxBbW91bnRPZkNyb3dkc2FsZVB1cmNoYXNlc1dpdGhvdXRCb251czsgLy8gaW4gQ05ZCiAgICBtYXBwaW5nIChhZGRyZXNzID0+IFF1YWxpZmllZFBhcnRuZXJzKSBwdWJsaWMgcXVhbGlmaWVkUGFydG5lcnM7CiAgICB1aW50MjU2IHB1YmxpYyBwdXJjaGFzZVN0YXJ0QmxvY2s7ICAvLyBjcm93ZHNhbGUgcHVyY2hhc2VzIGNhbiBiZSBhY2NlcHRlZCBmcm9tIHRoaXMgYmxvY2sgbnVtYmVyCiAgICB1aW50MjU2IHB1YmxpYyBzdGFydERhdGU7CiAgICB1aW50MjU2IHB1YmxpYyBlbmRlZEF0OwogICAgQ3Jvd2RzYWxlUHVyY2hhc2VbXSBwdWJsaWMgY3Jvd2RzYWxlUHVyY2hhc2VzOwogICAgbWFwcGluZyAoYWRkcmVzcyA9PiB1aW50MjU2KSBwdWJsaWMgY3Jvd2RzYWxlUHVyY2hhc2VBbW91bnRCeTsgLy8gY3Jvd2RzYWxlIHB1cmNoYXNlIGFtb3VudCBpbiBDTlkgcGVyIHB1cmNoYXNlcnMnIGFkZHJlc3MKICAgIHVpbnQyNTYgcHVibGljIGNueUJ0Y1JhdGU7IC8vIHRoaXMgcmF0ZSB3b24ndCBiZSB1c2VkIGZyb20gYSBzbWFydCBjb250cmFjdCBmdW5jdGlvbiBidXQgZXh0ZXJuYWwgc3lzdGVtCiAgICB1aW50MjU2IHB1YmxpYyBjbnlFdGhSYXRlOwoKICAgIC8vIGJvbnVzIG1pbGVzdG9uZXMKICAgIHVpbnQyNTYgcHVibGljIGZpcnN0Qm9udXNFbmRzOwogICAgdWludDI1NiBwdWJsaWMgc2Vjb25kQm9udXNFbmRzOwogICAgdWludDI1NiBwdWJsaWMgdGhpcmRCb251c0VuZHM7CiAgICB1aW50MjU2IHB1YmxpYyBmb3VydGhCb251c0VuZHM7CgogICAgLy8gYWZ0ZXIgdGhlIGNyb3dkc2FsZQogICAgbWFwcGluZyAoYWRkcmVzcyA9PiB1aW50MjU2KSBwdWJsaWMgbnVtT2ZQdXJjaGFzZWRUb2tlbnNPbkNzQnk7ICAgIC8vIHRoZSBudW1iZXIgb2YgdG9rZW5zIHB1cmNoYXNlZCBvbiB0aGUgY3Jvd2RzYWxlIGJ5IGEgcHVyY2hhc2VyCiAgICBtYXBwaW5nIChhZGRyZXNzID0+IHVpbnQyNTYpIHB1YmxpYyBudW1PZlB1cmNoYXNlZFRva2Vuc09uRXBCeTsgICAgLy8gdGhlIG51bWJlciBvZiB0b2tlbnMgZWFybHkgcHVyY2hhc2VkIGJ5IGEgcHVyY2hhc2VyCgogICAgLyoqCiAgICAgKiAgTW9kaWZpZXJzCiAgICAgKi8KICAgIG1vZGlmaWVyIG1pbkludmVzdG1lbnQoKSB7CiAgICAgICAgLy8gVXNlciBoYXMgdG8gc2VuZCBhdCBsZWFzdCB0aGUgZXRoZXIgdmFsdWUgb2Ygb25lIHRva2VuLgogICAgICAgIGFzc2VydChtc2cudmFsdWUgPj0gTUlOX0lOVkVTVE1FTlQpOwogICAgICAgIF87CiAgICB9CgogICAgbW9kaWZpZXIgd2hlbk5vdFN0YXJ0ZWQoKSB7CiAgICAgICAgYXNzZXJ0KHN0YXJ0RGF0ZSA9PSAwKTsKICAgICAgICBfOwogICAgfQoKICAgIG1vZGlmaWVyIHdoZW5FbmRlZCgpIHsKICAgICAgICBhc3NlcnQoaXNFbmRlZCgpKTsKICAgICAgICBfOwogICAgfQoKICAgIG1vZGlmaWVyIGhhc0JhbGFuY2UoKSB7CiAgICAgICAgYXNzZXJ0KHRoaXMuYmFsYW5jZSA+IDApOwogICAgICAgIF87CiAgICB9CiAgICBtb2RpZmllciByYXRlSXNTZXQodWludDI1NiBfcmF0ZSkgewogICAgICAgIGFzc2VydChfcmF0ZSAhPSAwKTsKICAgICAgICBfOwogICAgfQoKICAgIG1vZGlmaWVyIHdoZW5Ob3RFbmRlZCgpIHsKICAgICAgICBhc3NlcnQoIWlzRW5kZWQoKSk7CiAgICAgICAgXzsKICAgIH0KCiAgICBtb2RpZmllciB0b2tlbnNOb3REZWxpdmVyZWQoKSB7CiAgICAgICAgYXNzZXJ0KG51bU9mRGVsaXZlcmVkQ3Jvd2RzYWxlUHVyY2hhc2VzID09IDApOwogICAgICAgIGFzc2VydChudW1PZkRlbGl2ZXJlZEVhcmx5UHVyY2hhc2VzID09IDApOwogICAgICAgIF87CiAgICB9CgogICAgbW9kaWZpZXIgb25seUZ1bmRyYWlzZXIoKSB7CiAgICAgICAgYXNzZXJ0KGFkZHJlc3Moc3RhcmJhc2VUb2tlbikgIT0gMCk7CiAgICAgICAgYXNzZXJ0KHN0YXJiYXNlVG9rZW4uaXNGdW5kcmFpc2VyKG1zZy5zZW5kZXIpKTsKICAgICAgICBfOwogICAgfQoKICAgIG1vZGlmaWVyIG9ubHlRdWFsaWZpZWRQYXJ0bmVyKCkgewogICAgICAgIGFzc2VydChxdWFsaWZpZWRQYXJ0bmVyc1ttc2cuc2VuZGVyXS5ib25hRmlkZSk7CiAgICAgICAgXzsKICAgIH0KCiAgICBtb2RpZmllciBvbmx5UXVhbGlmaWVkUGFydG5lck9SUGljb3BzQ2VydGlmaWVkKCkgewogICAgICAgIGFzc2VydChxdWFsaWZpZWRQYXJ0bmVyc1ttc2cuc2VuZGVyXS5ib25hRmlkZSB8fCBwaWNvcHNDZXJ0aWZpZXIuY2VydGlmaWVkKG1zZy5zZW5kZXIpKTsKICAgICAgICBfOwogICAgfQoKICAgIC8qKgogICAgICogQ29udHJhY3QgZnVuY3Rpb25zCiAgICAgKi8KICAgIC8qKgogICAgICogQGRldiBDb250cmFjdCBjb25zdHJ1Y3RvciBmdW5jdGlvbiBzZXRzIG93bmVyIGFkZHJlc3MgYW5kCiAgICAgKiAgICAgIGFkZHJlc3Mgb2YgU3RhcmJhc2VFYXJseVB1cmNoYXNlQW1lbmRtZW50IGNvbnRyYWN0LgogICAgICogQHBhcmFtIHN0YXJiYXNlRXBBZGRyIFRoZSBhZGRyZXNzIHRoYXQgaG9sZHMgdGhlIGVhcmx5IHB1cmNoYXNlcnMgU3RhciB0b2tlbnMKICAgICAqIEBwYXJhbSBwaWNvcHNDZXJ0aWZpZXJBZGRyIFRoZSBhZGRyZXNzIG9mIHRoZSBQSUNPUFMgY2VydGlmaWVyLgogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgU2VlIGFsc28gaHR0cHM6Ly9waWNvcHMucGFyaXR5LmlvLyMvZGV0YWlscwogICAgICovCiAgICBmdW5jdGlvbiBTdGFyYmFzZUNyb3dkc2FsZShhZGRyZXNzIHN0YXJiYXNlRXBBZGRyLCBhZGRyZXNzIHBpY29wc0NlcnRpZmllckFkZHIpIHsKICAgICAgICByZXF1aXJlKHN0YXJiYXNlRXBBZGRyICE9IDAgJiYgcGljb3BzQ2VydGlmaWVyQWRkciAhPSAwKTsKICAgICAgICBvd25lciA9IG1zZy5zZW5kZXI7CiAgICAgICAgc3RhcmJhc2VFcEFtZW5kbWVudCA9IFN0YXJiYXNlRWFybHlQdXJjaGFzZUFtZW5kbWVudChzdGFyYmFzZUVwQWRkcik7CiAgICAgICAgcGljb3BzQ2VydGlmaWVyID0gQ2VydGlmaWVyKHBpY29wc0NlcnRpZmllckFkZHIpOwogICAgfQoKICAgIC8qKgogICAgICogQGRldiBGYWxsYmFjayBhY2NlcHRzIHBheW1lbnQgZm9yIFN0YXIgdG9rZW5zIHdpdGggRXRoCiAgICAgKi8KICAgIGZ1bmN0aW9uKCkgcGF5YWJsZSB7CiAgICAgICAgcmVkaXJlY3RUb1B1cmNoYXNlKCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBFeHRlcm5hbCBmdW5jdGlvbnMKICAgICAqLwoKICAgIC8qKgogICAgICogQGRldiBTZXR1cCBmdW5jdGlvbiBzZXRzIGV4dGVybmFsIGNvbnRyYWN0cycgYWRkcmVzc2VzIGFuZCBzZXQgdGhlIG1heCBjcm93ZHNhbGUgY2FwCiAgICAgKiBAcGFyYW0gc3RhcmJhc2VUb2tlbkFkZHJlc3MgVG9rZW4gYWRkcmVzcy4KICAgICAqIEBwYXJhbSBfcHVyY2hhc2VTdGFydEJsb2NrIEJsb2NrIG51bWJlciB0byBzdGFydCBjcm93ZHNhbGUKICAgICAqLwogICAgZnVuY3Rpb24gc2V0dXAoYWRkcmVzcyBzdGFyYmFzZVRva2VuQWRkcmVzcywgdWludDI1NiBfcHVyY2hhc2VTdGFydEJsb2NrKQogICAgICAgIGV4dGVybmFsCiAgICAgICAgb25seU93bmVyCiAgICAgICAgcmV0dXJucyAoYm9vbCkKICAgIHsKICAgICAgICByZXF1aXJlKHN0YXJiYXNlVG9rZW5BZGRyZXNzICE9IGFkZHJlc3MoMCkpOwogICAgICAgIHJlcXVpcmUoYWRkcmVzcyhzdGFyYmFzZVRva2VuKSA9PSAwKTsKICAgICAgICBzdGFyYmFzZVRva2VuID0gQWJzdHJhY3RTdGFyYmFzZVRva2VuKHN0YXJiYXNlVG9rZW5BZGRyZXNzKTsKICAgICAgICBwdXJjaGFzZVN0YXJ0QmxvY2sgPSBfcHVyY2hhc2VTdGFydEJsb2NrOwoKICAgICAgICAvLyBzZXQgdGhlIG1heCBjYXAgb2YgdGhpcyBjcm93ZHNhbGUKICAgICAgICBtYXhDcm93ZHNhbGVDYXAgPSBNQVhfQ0FQLnN1Yih0b3RhbEFtb3VudE9mRWFybHlQdXJjaGFzZXNXaXRob3V0Qm9udXMoKSk7CgogICAgICAgIGFzc2VydChtYXhDcm93ZHNhbGVDYXAgPiAwKTsKCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgLyoqCiAgICAgKiBAZGV2IFRyYW5zZmVycyByYWlzZWQgZnVuZHMgdG8gY29tcGFueSdzIHdhbGxldCBhZGRyZXNzIGF0IGFueSBnaXZlbiB0aW1lLgogICAgICovCiAgICBmdW5jdGlvbiB3aXRoZHJhd0ZvckNvbXBhbnkoKQogICAgICAgIGV4dGVybmFsCiAgICAgICAgb25seUZ1bmRyYWlzZXIKICAgICAgICBoYXNCYWxhbmNlCiAgICB7CiAgICAgICAgYWRkcmVzcyBjb21wYW55ID0gc3RhcmJhc2VUb2tlbi5jb21wYW55KCk7CiAgICAgICAgcmVxdWlyZShjb21wYW55ICE9IGFkZHJlc3MoMCkpOwogICAgICAgIGNvbXBhbnkudHJhbnNmZXIodGhpcy5iYWxhbmNlKTsKICAgIH0KCiAgICAvKioKICAgICAqIEBkZXYgVXBkYXRlIHN0YXJ0IGJsb2NrIE51bWJlciBmb3IgdGhlIGNyb3dkc2FsZQogICAgICovCiAgICBmdW5jdGlvbiB1cGRhdGVQdXJjaGFzZVN0YXJ0QmxvY2sodWludDI1NiBfcHVyY2hhc2VTdGFydEJsb2NrKQogICAgICAgIGV4dGVybmFsCiAgICAgICAgd2hlbk5vdFN0YXJ0ZWQKICAgICAgICBvbmx5RnVuZHJhaXNlcgogICAgICAgIHJldHVybnMgKGJvb2wpCiAgICB7CiAgICAgICAgcHVyY2hhc2VTdGFydEJsb2NrID0gX3B1cmNoYXNlU3RhcnRCbG9jazsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICAvKioKICAgICAqIEBkZXYgVXBkYXRlIHRoZSBDTlkvRVRIIHJhdGUgdG8gcmVjb3JkIHB1cmNoYXNlcyBpbiBDTlkKICAgICAqLwogICAgZnVuY3Rpb24gdXBkYXRlQ255RXRoUmF0ZSh1aW50MjU2IHJhdGUpCiAgICAgICAgZXh0ZXJuYWwKICAgICAgICBvbmx5RnVuZHJhaXNlcgogICAgICAgIHJldHVybnMgKGJvb2wpCiAgICB7CiAgICAgICAgY255RXRoUmF0ZSA9IHJhdGU7CiAgICAgICAgQ255RXRoUmF0ZVVwZGF0ZWQoY255RXRoUmF0ZSk7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgLyoqCiAgICAgKiBAZGV2IFVwZGF0ZSB0aGUgQ05ZL0JUQyByYXRlIHRvIHJlY29yZCBwdXJjaGFzZXMgaW4gQ05ZCiAgICAgKi8KICAgIGZ1bmN0aW9uIHVwZGF0ZUNueUJ0Y1JhdGUodWludDI1NiByYXRlKQogICAgICAgIGV4dGVybmFsCiAgICAgICAgb25seUZ1bmRyYWlzZXIKICAgICAgICByZXR1cm5zIChib29sKQogICAgewogICAgICAgIGNueUJ0Y1JhdGUgPSByYXRlOwogICAgICAgIENueUJ0Y1JhdGVVcGRhdGVkKGNueUJ0Y1JhdGUpOwogICAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIC8qKgogICAgICogQGRldiBBbGxvdyBmb3IgdGhlIHBvc3NpYmlsaXR5IGZvciBjb250cmFjdCBvd25lciB0byBzdGFydCBjcm93ZHNhbGUKICAgICAqLwogICAgZnVuY3Rpb24gb3duZXJTdGFydHNDcm93ZHNhbGUodWludDI1NiB0aW1lc3RhbXApCiAgICAgICAgZXh0ZXJuYWwKICAgICAgICB3aGVuTm90U3RhcnRlZAogICAgICAgIG9ubHlPd25lcgogICAgewogICAgICAgIGFzc2VydChibG9jay5udW1iZXIgPj0gcHVyY2hhc2VTdGFydEJsb2NrKTsgICAvLyB0aGlzIHNob3VsZCBiZSBhZnRlciB0aGUgY3Jvd2RzYWxlIHN0YXJ0IGJsb2NrCiAgICAgICAgc3RhcnRDcm93ZHNhbGUodGltZXN0YW1wKTsKICAgIH0KCiAgICAvKioKICAgICAqIEBkZXYgRW5kcyBjcm93ZHNhbGUKICAgICAqICAgICAgVGhpcyBtYXkgYmUgZXhlY3V0ZWQgYnkgYW4gb3duZXIgaWYgdGhlIHJhaXNlZCBmdW5kcyBkaWQgbm90IHJlYWNoIHRoZSBtYXAgY2FwCiAgICAgKiBAcGFyYW0gdGltZXN0YW1wIFRpbWVzdGFtcCBhdCB0aGUgY3Jvd2RzYWxlIGVuZGVkCiAgICAgKi8KICAgIGZ1bmN0aW9uIGVuZENyb3dkc2FsZSh1aW50MjU2IHRpbWVzdGFtcCkKICAgICAgICBleHRlcm5hbAogICAgICAgIG9ubHlPd25lcgogICAgewogICAgICAgIGFzc2VydCh0aW1lc3RhbXAgPiAwICYmIHRpbWVzdGFtcCA8PSBub3cpOwogICAgICAgIGFzc2VydChibG9jay5udW1iZXIgPj0gcHVyY2hhc2VTdGFydEJsb2NrICYmIGVuZGVkQXQgPT0gMCk7ICAgLy8gY2Fubm90IGVuZCBiZWZvcmUgaXQgc3RhcnRzIGFuZCBvdmVyd3JpdGluZyB0aW1lIGlzIG5vdCBwZXJtaXR0ZWQKICAgICAgICBlbmRlZEF0ID0gdGltZXN0YW1wOwogICAgICAgIENyb3dkc2FsZUVuZGVkKGVuZGVkQXQpOwogICAgfQoKICAgIC8qKgogICAgICogQGRldiBFbmRzIGNyb3dkc2FsZQogICAgICogICAgICBUaGlzIG1heSBiZSBleGVjdXRlZCBieSBwdXJjaGFzZVdpdGhFdGggd2hlbiB0aGUgcmFpc2VkIGZ1bmRzIHJlYWNoIHRoZSBtYXAgY2FwCiAgICAgKi8KICAgIGZ1bmN0aW9uIGVuZENyb3dkc2FsZSgpIGludGVybmFsIHsKICAgICAgICBhc3NlcnQoYmxvY2subnVtYmVyID49IHB1cmNoYXNlU3RhcnRCbG9jayAmJiBlbmRlZEF0ID09IDApOwogICAgICAgIGVuZGVkQXQgPSBub3c7CiAgICAgICAgQ3Jvd2RzYWxlRW5kZWQoZW5kZWRBdCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBAZGV2IERlbGl2ZXIgdG9rZW5zIHRvIHB1cmNoYXNlcnMgYWNjb3JkaW5nIHRvIHRoZWlyIHB1cmNoYXNlIGFtb3VudCBpbiBDTlkKICAgICAqLwogICAgZnVuY3Rpb24gd2l0aGRyYXdQdXJjaGFzZWRUb2tlbnMoKQogICAgICAgIGV4dGVybmFsCiAgICAgICAgd2hlbkVuZGVkCiAgICAgICAgcmV0dXJucyAoYm9vbCkKICAgIHsKICAgICAgICBhc3NlcnQoZWFybHlQdXJjaGFzZXNMb2FkZWQpOwogICAgICAgIGFzc2VydChhZGRyZXNzKHN0YXJiYXNlVG9rZW4pICE9IDApOwoKICAgICAgICAvKgogICAgICAgICAqIOKAnFZhbHVl4oCdIHJlZmVycyB0byB0aGUgY29udHJpYnV0aW9uIG9mIHRoZSBVc2VyOgogICAgICAgICAqICB7Y3Jvd2RzYWxlX3B1cmNoYXNlcl90b2tlbl9hbW91bnR9ID0KICAgICAgICAgKiAge2Nyb3dkc2FsZV90b2tlbl9hbW91bnR9ICoge2Nyb3dkc2FsZVB1cmNoYXNlX3ZhbHVlfSAvIHtlYXJseXB1cmNoYXNlX3ZhbHVlfSArIHtjcm93ZHNhbGVfdmFsdWV9LgogICAgICAgICAqCiAgICAgICAgICogRXhhbXBsZTogSWYgYSBVc2VyIGNvbnRyaWJ1dGVzIGR1cmluZyB0aGUgQ29udHJpYnV0aW9uIFBlcmlvZCAxMDAgQ05ZIChpbmNsdWRpbmcgYXBwbGljYWJsZQogICAgICAgICAqIEJvbnVzLCBpZiBhbnkpIGFuZCB0aGUgdG90YWwgYW1vdW50IGVhcmx5IHB1cmNoYXNlcyBhbW91bnRzIHRvIDbigJkwMDDigJkwMDAgQ05ZCiAgICAgICAgICogYW5kIHRvdGFsIGFtb3VudCByYWlzZWQgZHVyaW5nIHRoZSBDb250cmlidXRpb24gUGVyaW9kIGlzIDMw4oCZMDAw4oCZMDAwLCB0aGVuIGhlIHdpbGwgZ2V0CiAgICAgICAgICogMzQ3LjIyIFNUQVIgPSAxMjXigJkwMDDigJkwMDAgU1RBUiAqIDEwMCBDTlkgLyAzMOKAmTAwMOKAmTAwMCBDTlkgKyA24oCZMDAw4oCZMDAwIENOWS4KICAgICAgICAqLwoKICAgICAgICBpZiAoY3Jvd2RzYWxlUHVyY2hhc2VBbW91bnRCeVttc2cuc2VuZGVyXSA+IDApIHsKICAgICAgICAgICAgdWludDI1NiBjcm93ZHNhbGVQdXJjaGFzZVZhbHVlID0gY3Jvd2RzYWxlUHVyY2hhc2VBbW91bnRCeVttc2cuc2VuZGVyXTsKICAgICAgICAgICAgY3Jvd2RzYWxlUHVyY2hhc2VBbW91bnRCeVttc2cuc2VuZGVyXSA9IDA7CgogICAgICAgICAgICB1aW50MjU2IHRva2VuQ291bnQgPQogICAgICAgICAgICAgICAgU2FmZU1hdGgubXVsKGNyb3dkc2FsZVRva2VuQW1vdW50LCBjcm93ZHNhbGVQdXJjaGFzZVZhbHVlKSAvCiAgICAgICAgICAgICAgICB0b3RhbFJhaXNlZEFtb3VudEluQ255KCk7CgogICAgICAgICAgICBudW1PZlB1cmNoYXNlZFRva2Vuc09uQ3NCeVttc2cuc2VuZGVyXSA9CiAgICAgICAgICAgICAgICBTYWZlTWF0aC5hZGQobnVtT2ZQdXJjaGFzZWRUb2tlbnNPbkNzQnlbbXNnLnNlbmRlcl0sIHRva2VuQ291bnQpOwogICAgICAgICAgICBhc3NlcnQoc3RhcmJhc2VUb2tlbi5hbGxvY2F0ZVRvQ3Jvd2RzYWxlUHVyY2hhc2VyKG1zZy5zZW5kZXIsIHRva2VuQ291bnQpKTsKICAgICAgICAgICAgbnVtT2ZEZWxpdmVyZWRDcm93ZHNhbGVQdXJjaGFzZXMrKzsKICAgICAgICB9CgogICAgICAgIC8qCiAgICAgICAgICog4oCcVmFsdWXigJ0gcmVmZXJzIHRvIHRoZSBjb250cmlidXRpb24gb2YgdGhlIFVzZXI6CiAgICAgICAgICoge2Vhcmx5cHVyY2hhc2VyX3Rva2VuX2Ftb3VudH0gPQogICAgICAgICAqIHtlYXJseXB1cmNoYXNlcl90b2tlbl9hbW91bnR9ICogKHtlYXJseXB1cmNoYXNlX3ZhbHVlfSAvIHt0b3RhbF9lYXJseXB1cmNoYXNlX3ZhbHVlfSkKICAgICAgICAgKiAgKyB7Y3Jvd2RzYWxlX3Rva2VuX2Ftb3VudH0gKiAoe2Vhcmx5cHVyY2hhc2VfdmFsdWV9IC8ge2Vhcmx5cHVyY2hhc2VfdmFsdWV9ICsge2Nyb3dkc2FsZV92YWx1ZX0pLgogICAgICAgICAqCiAgICAgICAgICogRXhhbXBsZTogSWYgYW4gRWFybHkgUHVyY2hhc2VyIGNvbnRyaWJ1dGVzIDEwMCBDTlkgKGluY2x1ZGluZyBCb251cyBvZiAyMCUpIGFuZCB0aGUKICAgICAgICAgKiB0b3RhbCBhbW91bnQgb2YgZWFybHkgcHVyY2hhc2VzIGFtb3VudHMgdG8gNuKAmTAwMOKAmTAwMCBDTlkgYW5kIHRoZSB0b3RhbCBhbW91bnQgcmFpc2VkCiAgICAgICAgICogZHVyaW5nIHRoZSBDb250cmlidXRpb24gUGVyaW9kIGlzIDMw4oCZMDAw4oCZMDAwIENOWSwgdGhlbiBoZSB3aWxsIGdldCAxMTgwLjU1IFNUQVIgPQogICAgICAgICAqIDUw4oCZMDAw4oCZMDAwIFNUQVIgKiAxMDAgQ05ZIC8gNuKAmTAwMOKAmTAwMCBDTlkgKyAxMjXigJkwMDDigJkwMDAgU1RBUiAqIDEwMCBDTlkgLwogICAgICAgICAqIDMw4oCZMDAw4oCZMDAwIENOWSArIDbigJkwMDDigJkwMDAgQ05ZCiAgICAgICAgICovCgogICAgICAgIGlmIChlYXJseVB1cmNoYXNlZEFtb3VudEJ5W21zZy5zZW5kZXJdID4gMCkgeyAgLy8gc2tpcCBpZiBpcyBub3QgYW4gZWFybHkgcHVyY2hhc2VyCiAgICAgICAgICAgIHVpbnQyNTYgZWFybHlQdXJjaGFzZXJQdXJjaGFzZVZhbHVlID0gZWFybHlQdXJjaGFzZWRBbW91bnRCeVttc2cuc2VuZGVyXTsKICAgICAgICAgICAgZWFybHlQdXJjaGFzZWRBbW91bnRCeVttc2cuc2VuZGVyXSA9IDA7CgogICAgICAgICAgICB1aW50MjU2IGVwVG9rZW5DYWxjdWxhdGlvbkZyb21FUFRva2VuQW1vdW50ID0gU2FmZU1hdGgubXVsKGVhcmx5UHVyY2hhc2VUb2tlbkFtb3VudCwgZWFybHlQdXJjaGFzZXJQdXJjaGFzZVZhbHVlKSAvIHRvdGFsQW1vdW50T2ZFYXJseVB1cmNoYXNlczsKCiAgICAgICAgICAgIHVpbnQyNTYgZXBUb2tlbkNhbGN1bGF0aW9uRnJvbUNyb3dkc2FsZVRva2VuQW1vdW50ID0gU2FmZU1hdGgubXVsKGNyb3dkc2FsZVRva2VuQW1vdW50LCBlYXJseVB1cmNoYXNlclB1cmNoYXNlVmFsdWUpIC8gdG90YWxSYWlzZWRBbW91bnRJbkNueSgpOwoKICAgICAgICAgICAgdWludDI1NiBlcFRva2VuQ291bnQgPSBTYWZlTWF0aC5hZGQoZXBUb2tlbkNhbGN1bGF0aW9uRnJvbUVQVG9rZW5BbW91bnQsIGVwVG9rZW5DYWxjdWxhdGlvbkZyb21Dcm93ZHNhbGVUb2tlbkFtb3VudCk7CgogICAgICAgICAgICBudW1PZlB1cmNoYXNlZFRva2Vuc09uRXBCeVttc2cuc2VuZGVyXSA9IFNhZmVNYXRoLmFkZChudW1PZlB1cmNoYXNlZFRva2Vuc09uRXBCeVttc2cuc2VuZGVyXSwgZXBUb2tlbkNvdW50KTsKICAgICAgICAgICAgYXNzZXJ0KHN0YXJiYXNlVG9rZW4uYWxsb2NhdGVUb0Nyb3dkc2FsZVB1cmNoYXNlcihtc2cuc2VuZGVyLCBlcFRva2VuQ291bnQpKTsKICAgICAgICAgICAgbnVtT2ZEZWxpdmVyZWRFYXJseVB1cmNoYXNlcysrOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgLyoqCiAgICAgKiBAZGV2IExvYWQgZWFybHkgcHVyY2hhc2VzIGZyb20gdGhlIGNvbnRyYWN0IGtlZXBzIHRyYWNrIG9mIHRoZW0KICAgICAqLwogICAgZnVuY3Rpb24gbG9hZEVhcmx5UHVyY2hhc2VzKCkgZXh0ZXJuYWwgb25seU93bmVyIHJldHVybnMgKGJvb2wpIHsKICAgICAgICBpZiAoZWFybHlQdXJjaGFzZXNMb2FkZWQpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOyAgICAvLyBhbGwgRVBzIGhhdmUgYWxyZWFkeSBiZWVuIGxvYWRlZAogICAgICAgIH0KCiAgICAgICAgdWludDI1NiBudW1PZk9yaWdFcCA9IHN0YXJiYXNlRXBBbWVuZG1lbnQKICAgICAgICAgICAgLnN0YXJiYXNlRWFybHlQdXJjaGFzZSgpCiAgICAgICAgICAgIC5udW1iZXJPZkVhcmx5UHVyY2hhc2VzKCk7CgogICAgICAgIGZvciAodWludDI1NiBpID0gbnVtT2ZMb2FkZWRFYXJseVB1cmNoYXNlczsgaSA8IG51bU9mT3JpZ0VwICYmIG1zZy5nYXMgPiAyMDAwMDA7IGkrKykgewogICAgICAgICAgICBpZiAoc3RhcmJhc2VFcEFtZW5kbWVudC5pc0ludmFsaWRFYXJseVB1cmNoYXNlKGkpKSB7CiAgICAgICAgICAgICAgICBudW1PZkxvYWRlZEVhcmx5UHVyY2hhc2VzID0gU2FmZU1hdGguYWRkKG51bU9mTG9hZGVkRWFybHlQdXJjaGFzZXMsIDEpOwogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIChwdXJjaGFzZXIsIGFtb3VudCwpID0KICAgICAgICAgICAgICAgIHN0YXJiYXNlRXBBbWVuZG1lbnQuaXNBbWVuZGVkRWFybHlQdXJjaGFzZShpKQogICAgICAgICAgICAgICAgPyBzdGFyYmFzZUVwQW1lbmRtZW50LmFtZW5kZWRFYXJseVB1cmNoYXNlcyhpKQogICAgICAgICAgICAgICAgOiBzdGFyYmFzZUVwQW1lbmRtZW50LmVhcmx5UHVyY2hhc2VzKGkpOwogICAgICAgICAgICBpZiAoYW1vdW50ID4gMCkgewogICAgICAgICAgICAgICAgaWYgKGVhcmx5UHVyY2hhc2VkQW1vdW50QnlbcHVyY2hhc2VyXSA9PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgZWFybHlQdXJjaGFzZXJzLnB1c2gocHVyY2hhc2VyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIGVhY2ggZWFybHkgcHVyY2hhc2VyIHJlY2VpdmVzIDIwJSBib251cwogICAgICAgICAgICAgICAgdWludDI1NiBib251cyA9IFNhZmVNYXRoLm11bChhbW91bnQsIDIwKSAvIDEwMDsKICAgICAgICAgICAgICAgIHVpbnQyNTYgYW1vdW50V2l0aEJvbnVzID0gU2FmZU1hdGguYWRkKGFtb3VudCwgYm9udXMpOwoKICAgICAgICAgICAgICAgIGVhcmx5UHVyY2hhc2VkQW1vdW50QnlbcHVyY2hhc2VyXSA9IFNhZmVNYXRoLmFkZChlYXJseVB1cmNoYXNlZEFtb3VudEJ5W3B1cmNoYXNlcl0sIGFtb3VudFdpdGhCb251cyk7CiAgICAgICAgICAgICAgICB0b3RhbEFtb3VudE9mRWFybHlQdXJjaGFzZXMgPSB0b3RhbEFtb3VudE9mRWFybHlQdXJjaGFzZXMuYWRkKGFtb3VudFdpdGhCb251cyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG51bU9mTG9hZGVkRWFybHlQdXJjaGFzZXMgPSBTYWZlTWF0aC5hZGQobnVtT2ZMb2FkZWRFYXJseVB1cmNoYXNlcywgMSk7CiAgICAgICAgfQoKICAgICAgICBhc3NlcnQobnVtT2ZMb2FkZWRFYXJseVB1cmNoYXNlcyA8PSBudW1PZk9yaWdFcCk7CiAgICAgICAgaWYgKG51bU9mTG9hZGVkRWFybHlQdXJjaGFzZXMgPT0gbnVtT2ZPcmlnRXApIHsKICAgICAgICAgICAgZWFybHlQdXJjaGFzZXNMb2FkZWQgPSB0cnVlOyAgICAvLyBlbmFibGUgdGhlIGZsYWcKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgLyoqCiAgICAgKiBAZGV2IExvYWQgcHJlc2FsZSBwdXJjaGFzZXMgZnJvbSB0aGUgY29udHJhY3Qga2VlcHMgdHJhY2sgb2YgdGhlbQogICAgICogQHBhcmFtIHN0YXJiYXNlQ3Jvd2RzYWxlUHJlc2FsZSBTdGFyYmFzZSBwcmVzYWxlIGNvbnRyYWN0IGFkZHJlc3MKICAgICAqLwogICAgZnVuY3Rpb24gbG9hZFByZXNhbGVQdXJjaGFzZXMoYWRkcmVzcyBzdGFyYmFzZUNyb3dkc2FsZVByZXNhbGUpCiAgICAgICAgZXh0ZXJuYWwKICAgICAgICBvbmx5T3duZXIKICAgICAgICB3aGVuTm90RW5kZWQKICAgIHsKICAgICAgICByZXF1aXJlKHN0YXJiYXNlQ3Jvd2RzYWxlUHJlc2FsZSAhPSAwKTsKICAgICAgICByZXF1aXJlKCFwcmVzYWxlUHVyY2hhc2VzTG9hZGVkKTsKICAgICAgICBTdGFyYmFzZUNyb3dkc2FsZSBwcmVzYWxlID0gU3RhcmJhc2VDcm93ZHNhbGUoc3RhcmJhc2VDcm93ZHNhbGVQcmVzYWxlKTsKICAgICAgICBmb3IgKHVpbnQgaTsgaSA8IHByZXNhbGUubnVtT2ZQdXJjaGFzZXMoKTsgaSsrKSB7CiAgICAgICAgICAgIHZhciAocHVyY2hhc2VyLCBhbW91bnQsIHJhd0Ftb3VudCwgcHVyY2hhc2VkQXQpID0KICAgICAgICAgICAgICAgIHByZXNhbGUuY3Jvd2RzYWxlUHVyY2hhc2VzKGkpOyAgLy8gcHJlc2FsZSBwdXJjaGFzZQogICAgICAgICAgICBjcm93ZHNhbGVQdXJjaGFzZXMucHVzaChDcm93ZHNhbGVQdXJjaGFzZShwdXJjaGFzZXIsIGFtb3VudCwgcmF3QW1vdW50LCBwdXJjaGFzZWRBdCkpOwoKICAgICAgICAgICAgLy8gSW5jcmVhc2UgdGhlIHN1bXMKICAgICAgICAgICAgY3Jvd2RzYWxlUHVyY2hhc2VBbW91bnRCeVtwdXJjaGFzZXJdID0gU2FmZU1hdGguYWRkKGNyb3dkc2FsZVB1cmNoYXNlQW1vdW50QnlbcHVyY2hhc2VyXSwgYW1vdW50KTsKICAgICAgICAgICAgdG90YWxBbW91bnRPZkNyb3dkc2FsZVB1cmNoYXNlcyA9IHRvdGFsQW1vdW50T2ZDcm93ZHNhbGVQdXJjaGFzZXMuYWRkKGFtb3VudCk7CiAgICAgICAgICAgIHRvdGFsQW1vdW50T2ZDcm93ZHNhbGVQdXJjaGFzZXNXaXRob3V0Qm9udXMgPSB0b3RhbEFtb3VudE9mQ3Jvd2RzYWxlUHVyY2hhc2VzV2l0aG91dEJvbnVzLmFkZChyYXdBbW91bnQpOwogICAgICAgIH0KICAgICAgICBwcmVzYWxlUHVyY2hhc2VzTG9hZGVkID0gdHJ1ZTsKICAgIH0KCiAgICAvKioKICAgICAgKiBAZGV2IFNldCBxdWFsaWZpZWQgY3Jvd2RzYWxlIHBhcnRuZXIgaS5lLiBCaXRjb2luIFN1aXNzZSBhZGRyZXNzCiAgICAgICogQHBhcmFtIF9xdWFsaWZpZWRQYXJ0bmVyIEFkZHJlc3Mgb2YgdGhlIHF1YWxpZmllZCBwYXJ0bmVyIHRoYXQgY2FuIHB1cmNoYXNlIGR1cmluZyBjcm93ZHNhbGUKICAgICAgKiBAcGFyYW0gX2Ftb3VudENhcCBFdGhlciB2YWx1ZSB3aGljaCBwYXJ0bmVyIGlzIGFibGUgdG8gY29udHJpYnV0ZQogICAgICAqIEBwYXJhbSBfY29tbWlzc2lvbkZlZVBlcmNlbnRhZ2UgSW50ZWdlciB0aGF0IHJlcHJlc2VudHMgdGhlIGZlZSB0byBwYXkgcXVhbGlmaWVkIHBhcnRuZXIgNSBpcyA1JQogICAgICAqLwogICAgZnVuY3Rpb24gc2V0UXVhbGlmaWVkUGFydG5lcihhZGRyZXNzIF9xdWFsaWZpZWRQYXJ0bmVyLCB1aW50MjU2IF9hbW91bnRDYXAsIHVpbnQyNTYgX2NvbW1pc3Npb25GZWVQZXJjZW50YWdlKQogICAgICAgIGV4dGVybmFsCiAgICAgICAgb25seU93bmVyCiAgICB7CiAgICAgICAgYXNzZXJ0KCFxdWFsaWZpZWRQYXJ0bmVyc1tfcXVhbGlmaWVkUGFydG5lcl0uYm9uYUZpZGUpOwogICAgICAgIHF1YWxpZmllZFBhcnRuZXJzW19xdWFsaWZpZWRQYXJ0bmVyXS5ib25hRmlkZSA9IHRydWU7CiAgICAgICAgcXVhbGlmaWVkUGFydG5lcnNbX3F1YWxpZmllZFBhcnRuZXJdLmFtb3VudENhcCA9IF9hbW91bnRDYXA7CiAgICAgICAgcXVhbGlmaWVkUGFydG5lcnNbX3F1YWxpZmllZFBhcnRuZXJdLmNvbW1pc3Npb25GZWVQZXJjZW50YWdlID0gX2NvbW1pc3Npb25GZWVQZXJjZW50YWdlOwogICAgICAgIFF1YWxpZmllZFBhcnRuZXJBZGRyZXNzKF9xdWFsaWZpZWRQYXJ0bmVyKTsKICAgIH0KCiAgICAvKioKICAgICAqIEBkZXYgUmVtb3ZlIGFkZHJlc3MgZnJvbSBxdWFsaWZpZWQgcGFydG5lcnMgbGlzdC4KICAgICAqIEBwYXJhbSBfcXVhbGlmaWVkUGFydG5lciBBZGRyZXNzIHRvIGJlIHJlbW92ZWQgZnJvbSB0aGUgbGlzdC4KICAgICAqLwogICAgZnVuY3Rpb24gdW5saXN0UXVhbGlmaWVkUGFydG5lcihhZGRyZXNzIF9xdWFsaWZpZWRQYXJ0bmVyKSBleHRlcm5hbCBvbmx5T3duZXIgewogICAgICAgIGFzc2VydChxdWFsaWZpZWRQYXJ0bmVyc1tfcXVhbGlmaWVkUGFydG5lcl0uYm9uYUZpZGUpOwogICAgICAgIHF1YWxpZmllZFBhcnRuZXJzW19xdWFsaWZpZWRQYXJ0bmVyXS5ib25hRmlkZSA9IGZhbHNlOwogICAgfQoKICAgIC8qKgogICAgICogQGRldiBVcGRhdGUgd2hpdGVsaXN0ZWQgYWRkcmVzcyBhbW91bnQgYWxsb3dlZCB0byByYWlzZSBkdXJpbmcgdGhlIHByZXNhbGUuCiAgICAgKiBAcGFyYW0gX3F1YWxpZmllZFBhcnRuZXIgUXVhbGlmaWVkIFBhcnRuZXIgYWRkcmVzcyB0byBiZSB1cGRhdGVkLgogICAgICogQHBhcmFtIF9hbW91bnRDYXAgQW1vdW50IHRoYXQgdGhlIGFkZHJlc3MgaXMgYWJsZSB0byByYWlzZSBkdXJpbmcgdGhlIHByZXNhbGUuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHVwZGF0ZVF1YWxpZmllZFBhcnRuZXJDYXBBbW91bnQoYWRkcmVzcyBfcXVhbGlmaWVkUGFydG5lciwgdWludDI1NiBfYW1vdW50Q2FwKSBleHRlcm5hbCBvbmx5T3duZXIgewogICAgICAgIGFzc2VydChxdWFsaWZpZWRQYXJ0bmVyc1tfcXVhbGlmaWVkUGFydG5lcl0uYm9uYUZpZGUpOwogICAgICAgIHF1YWxpZmllZFBhcnRuZXJzW19xdWFsaWZpZWRQYXJ0bmVyXS5hbW91bnRDYXAgPSBfYW1vdW50Q2FwOwogICAgfQoKICAgIC8qKgogICAgICogUHVibGljIGZ1bmN0aW9ucwogICAgICovCgogICAgLyoqCiAgICAgKiBAZGV2IFJldHVybnMgYm9vbGVhbiBmb3Igd2hldGhlciBjcm93ZHNhbGUgaGFzIGVuZGVkCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzRW5kZWQoKSBjb25zdGFudCBwdWJsaWMgcmV0dXJucyAoYm9vbCkgewogICAgICAgIHJldHVybiAoZW5kZWRBdCA+IDAgJiYgZW5kZWRBdCA8PSBub3cpOwogICAgfQoKICAgIC8qKgogICAgICogQGRldiBSZXR1cm5zIG51bWJlciBvZiBwdXJjaGFzZXMgdG8gZGF0ZS4KICAgICAqLwogICAgZnVuY3Rpb24gbnVtT2ZQdXJjaGFzZXMoKSBjb25zdGFudCBwdWJsaWMgcmV0dXJucyAodWludDI1NikgewogICAgICAgIHJldHVybiBjcm93ZHNhbGVQdXJjaGFzZXMubGVuZ3RoOwogICAgfQoKICAgIC8qKgogICAgICogQGRldiBSZXR1cm5zIHRvdGFsIHJhaXNlZCBhbW91bnQgaW4gQ05ZIChpbmNsdWRlcyBFUCkgYW5kIGJvbnVzZXMKICAgICAqLwogICAgZnVuY3Rpb24gdG90YWxSYWlzZWRBbW91bnRJbkNueSgpIGNvbnN0YW50IHB1YmxpYyByZXR1cm5zICh1aW50MjU2KSB7CiAgICAgICAgcmV0dXJuIHRvdGFsQW1vdW50T2ZFYXJseVB1cmNoYXNlcy5hZGQodG90YWxBbW91bnRPZkNyb3dkc2FsZVB1cmNoYXNlcyk7CiAgICB9CgogICAgLyoqCiAgICAgKiBAZGV2IFJldHVybnMgdG90YWwgYW1vdW50IG9mIGVhcmx5IHB1cmNoYXNlcyBpbiBDTlkgYW5kIGJvbnVzZXMKICAgICAqLwogICAgZnVuY3Rpb24gdG90YWxBbW91bnRPZkVhcmx5UHVyY2hhc2VzV2l0aEJvbnVzKCkgY29uc3RhbnQgcHVibGljIHJldHVybnModWludDI1NikgewogICAgICAgcmV0dXJuIHN0YXJiYXNlRXBBbWVuZG1lbnQudG90YWxBbW91bnRPZkVhcmx5UHVyY2hhc2VzKCkubXVsKDEyMCkuZGl2KDEwMCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBAZGV2IFJldHVybnMgdG90YWwgYW1vdW50IG9mIGVhcmx5IHB1cmNoYXNlcyBpbiBDTlkKICAgICAqLwogICAgZnVuY3Rpb24gdG90YWxBbW91bnRPZkVhcmx5UHVyY2hhc2VzV2l0aG91dEJvbnVzKCkgY29uc3RhbnQgcHVibGljIHJldHVybnModWludDI1NikgewogICAgICAgcmV0dXJuIHN0YXJiYXNlRXBBbWVuZG1lbnQudG90YWxBbW91bnRPZkVhcmx5UHVyY2hhc2VzKCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBAZGV2IEFsbG93cyBxdWFsaWZpZWQgY3Jvd2RzYWxlIHBhcnRuZXIgdG8gcHVyY2hhc2UgU3RhciBUb2tlbnMKICAgICAqLwogICAgZnVuY3Rpb24gcHVyY2hhc2VBc1F1YWxpZmllZFBhcnRuZXIoKQogICAgICAgIHBheWFibGUKICAgICAgICBwdWJsaWMKICAgICAgICByYXRlSXNTZXQoY255RXRoUmF0ZSkKICAgICAgICBvbmx5UXVhbGlmaWVkUGFydG5lcgogICAgICAgIHJldHVybnMgKGJvb2wpCiAgICB7CiAgICAgICAgcmVxdWlyZShtc2cudmFsdWUgPiAwKTsKICAgICAgICBxdWFsaWZpZWRQYXJ0bmVyc1ttc2cuc2VuZGVyXS5hbW91bnRSYWlzZWQgPSBTYWZlTWF0aC5hZGQobXNnLnZhbHVlLCBxdWFsaWZpZWRQYXJ0bmVyc1ttc2cuc2VuZGVyXS5hbW91bnRSYWlzZWQpOwoKICAgICAgICBhc3NlcnQocXVhbGlmaWVkUGFydG5lcnNbbXNnLnNlbmRlcl0uYW1vdW50UmFpc2VkIDw9IHF1YWxpZmllZFBhcnRuZXJzW21zZy5zZW5kZXJdLmFtb3VudENhcCk7CgogICAgICAgIHVpbnQyNTYgcmF3QW1vdW50ID0gU2FmZU1hdGgubXVsKG1zZy52YWx1ZSwgY255RXRoUmF0ZSkgLyAxZTE4OwogICAgICAgIHJlY29yZFB1cmNoYXNlKG1zZy5zZW5kZXIsIHJhd0Ftb3VudCwgbm93KTsKCiAgICAgICAgaWYgKHF1YWxpZmllZFBhcnRuZXJzW21zZy5zZW5kZXJdLmNvbW1pc3Npb25GZWVQZXJjZW50YWdlID4gMCkgewogICAgICAgICAgICBzZW5kUXVhbGlmaWVkUGFydG5lckNvbW1pc3Npb25GZWUobXNnLnNlbmRlciwgbXNnLnZhbHVlKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIC8qKgogICAgICogQGRldiBBbGxvd3MgdXNlciB0byBwdXJjaGFzZSBTVEFSIHRva2VucyB3aXRoIEV0aGVyCiAgICAgKi8KICAgIGZ1bmN0aW9uIHB1cmNoYXNlV2l0aEV0aCgpCiAgICAgICAgcGF5YWJsZQogICAgICAgIHB1YmxpYwogICAgICAgIG1pbkludmVzdG1lbnQKICAgICAgICB3aGVuTm90RW5kZWQKICAgICAgICByYXRlSXNTZXQoY255RXRoUmF0ZSkKICAgICAgICBvbmx5UXVhbGlmaWVkUGFydG5lck9SUGljb3BzQ2VydGlmaWVkCiAgICAgICAgcmV0dXJucyAoYm9vbCkKICAgIHsKICAgICAgICByZXF1aXJlKHB1cmNoYXNlU3RhcnRCbG9jayA+IDAgJiYgYmxvY2subnVtYmVyID49IHB1cmNoYXNlU3RhcnRCbG9jayk7CgogICAgICAgIGlmIChzdGFydERhdGUgPT0gMCkgewogICAgICAgICAgICBzdGFydENyb3dkc2FsZShibG9jay50aW1lc3RhbXApOwogICAgICAgIH0KCiAgICAgICAgdWludDI1NiByYXdBbW91bnQgPSBTYWZlTWF0aC5tdWwobXNnLnZhbHVlLCBjbnlFdGhSYXRlKSAvIDFlMTg7CiAgICAgICAgcmVjb3JkUHVyY2hhc2UobXNnLnNlbmRlciwgcmF3QW1vdW50LCBub3cpOwoKICAgICAgICBpZiAodG90YWxBbW91bnRPZkNyb3dkc2FsZVB1cmNoYXNlc1dpdGhvdXRCb251cyA+PSBtYXhDcm93ZHNhbGVDYXApIHsKICAgICAgICAgICAgZW5kQ3Jvd2RzYWxlKCk7IC8vIGVuZHMgdGhpcyBjcm93ZHNhbGUgYXV0b21hdGljYWxseQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgLyoqCiAgICAgKiBJbnRlcm5hbCBmdW5jdGlvbnMKICAgICAqLwoKICAgIC8qKgogICAgICogQGRldiBJbml0aWFsaXplcyBTdGFyYmFzZSBjcm93ZHNhbGUKICAgICAqLwogICAgZnVuY3Rpb24gc3RhcnRDcm93ZHNhbGUodWludDI1NiB0aW1lc3RhbXApIGludGVybmFsIHsKICAgICAgICBzdGFydERhdGUgPSB0aW1lc3RhbXA7CiAgICAgICAgdWludDI1NiBwcmVzYWxlQW1vdW50ID0gdG90YWxBbW91bnRPZkNyb3dkc2FsZVB1cmNoYXNlc1dpdGhvdXRCb251czsKICAgICAgICBpZiAobWF4Q3Jvd2RzYWxlQ2FwID4gcHJlc2FsZUFtb3VudCkgewogICAgICAgICAgICB1aW50MjU2IG1haW5TYWxlQ2FwID0gbWF4Q3Jvd2RzYWxlQ2FwLnN1YihwcmVzYWxlQW1vdW50KTsKICAgICAgICAgICAgdWludDI1NiB0d2VudHlQZXJjZW50T2ZDcm93ZHNhbGVQdXJjaGFzZSA9IG1haW5TYWxlQ2FwLm11bCgyMCkuZGl2KDEwMCk7CgogICAgICAgICAgICAvLyBzZXQgdG9rZW4gYm9udXMgbWlsZXN0b25lcyBpbiBjbnkgdG90YWwgY3Jvd2RzYWxlIHB1cmNoYXNlCiAgICAgICAgICAgIGZpcnN0Qm9udXNFbmRzID0gIHR3ZW50eVBlcmNlbnRPZkNyb3dkc2FsZVB1cmNoYXNlOwogICAgICAgICAgICBzZWNvbmRCb251c0VuZHMgPSBmaXJzdEJvbnVzRW5kcy5hZGQodHdlbnR5UGVyY2VudE9mQ3Jvd2RzYWxlUHVyY2hhc2UpOwogICAgICAgICAgICB0aGlyZEJvbnVzRW5kcyA9ICBzZWNvbmRCb251c0VuZHMuYWRkKHR3ZW50eVBlcmNlbnRPZkNyb3dkc2FsZVB1cmNoYXNlKTsKICAgICAgICAgICAgZm91cnRoQm9udXNFbmRzID0gdGhpcmRCb251c0VuZHMuYWRkKHR3ZW50eVBlcmNlbnRPZkNyb3dkc2FsZVB1cmNoYXNlKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBAZGV2IEFic3RyYWN0IHJlY29yZCBvZiBhIHB1cmNoYXNlIHRvIFRva2VucwogICAgICogQHBhcmFtIHB1cmNoYXNlciBBZGRyZXNzIG9mIHRoZSBidXllcgogICAgICogQHBhcmFtIHJhd0Ftb3VudCBBbW91bnQgaW4gQ05ZIGFzIHBlciB0aGUgQ05ZL0VUSCByYXRlIHVzZWQKICAgICAqIEBwYXJhbSB0aW1lc3RhbXAgVGltZXN0YW1wIGF0IHRoZSBwdXJjaGFzZSBtYWRlCiAgICAgKi8KICAgIGZ1bmN0aW9uIHJlY29yZFB1cmNoYXNlKAogICAgICAgIGFkZHJlc3MgcHVyY2hhc2VyLAogICAgICAgIHVpbnQyNTYgcmF3QW1vdW50LAogICAgICAgIHVpbnQyNTYgdGltZXN0YW1wCiAgICApCiAgICAgICAgaW50ZXJuYWwKICAgICAgICByZXR1cm5zKHVpbnQyNTYgYW1vdW50KQogICAgewogICAgICAgIGFtb3VudCA9IHJhd0Ftb3VudDsgLy8gYW1vdW50IHRvIGNoZWNrIHJlYWNoIG9mIG1heCBjYXAuIGl0IGRvZXMgbm90IGNhcmUgZm9yIGJvbnVzIHRva2VucyBoZXJlCgogICAgICAgIC8vIHByZXNhbGUgdHJhbnNmZXJzIHdoaWNoIG9jY3VycyBiZWZvcmUgdGhlIGNyb3dkc2FsZSBpZ25vcmVzIHRoZSBjcm93ZHNhbGUgaGFyZCBjYXAKICAgICAgICBpZiAoYmxvY2subnVtYmVyID49IHB1cmNoYXNlU3RhcnRCbG9jaykgewogICAgICAgICAgICByZXF1aXJlKHRvdGFsQW1vdW50T2ZDcm93ZHNhbGVQdXJjaGFzZXNXaXRob3V0Qm9udXMgPCBtYXhDcm93ZHNhbGVDYXApOyAgIC8vIGNoZWNrIGlmIHRoZSBhbW91bnQgaGFzIGFscmVhZHkgcmVhY2hlZCB0aGUgY2FwCgogICAgICAgICAgICB1aW50MjU2IGNyb3dkc2FsZVRvdGFsQW1vdW50QWZ0ZXJQdXJjaGFzZSA9CiAgICAgICAgICAgICAgICBTYWZlTWF0aC5hZGQodG90YWxBbW91bnRPZkNyb3dkc2FsZVB1cmNoYXNlc1dpdGhvdXRCb251cywgYW1vdW50KTsKCiAgICAgICAgICAgIC8vIGNoZWNrIHdoZXRoZXIgcHVyY2hhc2UgZ29lcyBvdmVyIHRoZSBjYXAgYW5kIHNlbmQgdGhlIGRpZmZlcmVuY2UgYmFjayB0byB0aGUgcHVyY2hhc2VyLgogICAgICAgICAgICBpZiAoY3Jvd2RzYWxlVG90YWxBbW91bnRBZnRlclB1cmNoYXNlID4gbWF4Q3Jvd2RzYWxlQ2FwKSB7CiAgICAgICAgICAgICAgdWludDI1NiBkaWZmZXJlbmNlID0gU2FmZU1hdGguc3ViKGNyb3dkc2FsZVRvdGFsQW1vdW50QWZ0ZXJQdXJjaGFzZSwgbWF4Q3Jvd2RzYWxlQ2FwKTsKICAgICAgICAgICAgICB1aW50MjU2IGV0aFZhbHVlVG9SZXR1cm4gPSBTYWZlTWF0aC5tdWwoZGlmZmVyZW5jZSwgMWUxOCkgLyBjbnlFdGhSYXRlOwogICAgICAgICAgICAgIHB1cmNoYXNlci50cmFuc2ZlcihldGhWYWx1ZVRvUmV0dXJuKTsKICAgICAgICAgICAgICBhbW91bnQgPSBTYWZlTWF0aC5zdWIoYW1vdW50LCBkaWZmZXJlbmNlKTsKICAgICAgICAgICAgICByYXdBbW91bnQgPSBhbW91bnQ7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGFtb3VudCA9IGdldEJvbnVzQW1vdW50Q2FsY3VsYXRpb24oYW1vdW50KTsgLy8gYXQgdGhpcyBwb2ludCBhbW91bnQgYm9udXMgaXMgY2FsY3VsYXRlZAoKICAgICAgICBDcm93ZHNhbGVQdXJjaGFzZSBtZW1vcnkgcHVyY2hhc2UgPSBDcm93ZHNhbGVQdXJjaGFzZShwdXJjaGFzZXIsIGFtb3VudCwgcmF3QW1vdW50LCB0aW1lc3RhbXApOwogICAgICAgIGNyb3dkc2FsZVB1cmNoYXNlcy5wdXNoKHB1cmNoYXNlKTsKICAgICAgICBTdGFyYmFzZVB1cmNoYXNlZFdpdGhFdGgobXNnLnNlbmRlciwgYW1vdW50LCByYXdBbW91bnQsIGNueUV0aFJhdGUpOwogICAgICAgIGNyb3dkc2FsZVB1cmNoYXNlQW1vdW50QnlbcHVyY2hhc2VyXSA9IFNhZmVNYXRoLmFkZChjcm93ZHNhbGVQdXJjaGFzZUFtb3VudEJ5W3B1cmNoYXNlcl0sIGFtb3VudCk7CiAgICAgICAgdG90YWxBbW91bnRPZkNyb3dkc2FsZVB1cmNoYXNlcyA9IHRvdGFsQW1vdW50T2ZDcm93ZHNhbGVQdXJjaGFzZXMuYWRkKGFtb3VudCk7CiAgICAgICAgdG90YWxBbW91bnRPZkNyb3dkc2FsZVB1cmNoYXNlc1dpdGhvdXRCb251cyA9IHRvdGFsQW1vdW50T2ZDcm93ZHNhbGVQdXJjaGFzZXNXaXRob3V0Qm9udXMuYWRkKHJhd0Ftb3VudCk7CiAgICAgICAgcmV0dXJuIGFtb3VudDsKICAgIH0KCiAgICAvKioKICAgICAqIEBkZXYgQ2FsY3VsYXRlcyBhbW91bnQgd2l0aCBib251cyBmb3IgYm9udXMgbWlsZXN0b25lcwogICAgICovCiAgICBmdW5jdGlvbiBjYWxjdWxhdGVCb251cwogICAgICAgICgKICAgICAgICAgICAgQm9udXNNaWxlc3RvbmVzIG5leHRNaWxlc3RvbmUsCiAgICAgICAgICAgIHVpbnQyNTYgYW1vdW50LAogICAgICAgICAgICB1aW50MjU2IGJvbnVzUmFuZ2UsCiAgICAgICAgICAgIHVpbnQyNTYgYm9udXNUaWVyLAogICAgICAgICAgICB1aW50MjU2IHJlc3VsdHMKICAgICAgICApCiAgICAgICAgaW50ZXJuYWwKICAgICAgICByZXR1cm5zICh1aW50MjU2IHJlc3VsdCwgdWludDI1NiBuZXdBbW91bnQpCiAgICB7CiAgICAgICAgdWludDI1NiBib251c0NhbGM7CgogICAgICAgIGlmIChhbW91bnQgPD0gYm9udXNSYW5nZSkgewogICAgICAgICAgICBib251c0NhbGMgPSBhbW91bnQubXVsKGJvbnVzVGllcikuZGl2KDEwMCk7CgogICAgICAgICAgICBpZiAoYW1vdW50LmFkZCh0b3RhbEFtb3VudE9mQ3Jvd2RzYWxlUHVyY2hhc2VzV2l0aG91dEJvbnVzKSA+PSBib251c1JhbmdlKQogICAgICAgICAgICAgICAgYm9udXNNaWxlc3RvbmVzID0gbmV4dE1pbGVzdG9uZTsKCiAgICAgICAgICAgIHJlc3VsdCA9IHJlc3VsdHMuYWRkKGFtb3VudCkuYWRkKGJvbnVzQ2FsYyk7CiAgICAgICAgICAgIG5ld0Ftb3VudCA9IDA7CgogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGJvbnVzQ2FsYyA9IGJvbnVzUmFuZ2UubXVsKGJvbnVzVGllcikuZGl2KDEwMCk7CiAgICAgICAgICAgIGJvbnVzTWlsZXN0b25lcyA9IG5leHRNaWxlc3RvbmU7CiAgICAgICAgICAgIHJlc3VsdCA9IHJlc3VsdHMuYWRkKGJvbnVzUmFuZ2UpLmFkZChib251c0NhbGMpOwogICAgICAgICAgICBuZXdBbW91bnQgPSBhbW91bnQuc3ViKGJvbnVzUmFuZ2UpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIEBkZXYgRmV0Y2hzIEJvbnVzIHRpZXIgcGVyY2VudGFnZSBwZXIgYm9udXMgbWlsZXN0b25lcwogICAgICovCiAgICBmdW5jdGlvbiBnZXRCb251c0Ftb3VudENhbGN1bGF0aW9uKHVpbnQyNTYgYW1vdW50KSBpbnRlcm5hbCByZXR1cm5zICh1aW50MjU2KSB7CiAgICAgICAgaWYgKGJsb2NrLm51bWJlciA8IHB1cmNoYXNlU3RhcnRCbG9jaykgewogICAgICAgICAgICB1aW50MjU2IGJvbnVzRnJvbUFtb3VudCA9IGFtb3VudC5tdWwoMzApLmRpdigxMDApOyAvLyBwcmVzYWxlIGhhcyAzMCUgYm9udXMKICAgICAgICAgICAgcmV0dXJuIGFtb3VudC5hZGQoYm9udXNGcm9tQW1vdW50KTsKICAgICAgICB9CgogICAgICAgIC8vIHJhbmdlIG9mIGVhY2ggYm9udXMgbWlsZXN0b25lcwogICAgICAgIHVpbnQyNTYgZmlyc3RCb251c1JhbmdlID0gZmlyc3RCb251c0VuZHM7CiAgICAgICAgdWludDI1NiBzZWNvbmRCb251c1JhbmdlID0gc2Vjb25kQm9udXNFbmRzLnN1YihmaXJzdEJvbnVzRW5kcyk7CiAgICAgICAgdWludDI1NiB0aGlyZEJvbnVzUmFuZ2UgPSB0aGlyZEJvbnVzRW5kcy5zdWIoc2Vjb25kQm9udXNFbmRzKTsKICAgICAgICB1aW50MjU2IGZvdXJ0aEJvbnVzUmFuZ2UgPSBmb3VydGhCb251c0VuZHMuc3ViKHRoaXJkQm9udXNFbmRzKTsKICAgICAgICB1aW50MjU2IHJlc3VsdDsKCiAgICAgICAgaWYgKGJvbnVzTWlsZXN0b25lcyA9PSBCb251c01pbGVzdG9uZXMuRmlyc3QpCiAgICAgICAgICAgIChyZXN1bHQsIGFtb3VudCkgPSBjYWxjdWxhdGVCb251cyhCb251c01pbGVzdG9uZXMuU2Vjb25kLCBhbW91bnQsIGZpcnN0Qm9udXNSYW5nZSwgMjAsIHJlc3VsdCk7CgogICAgICAgIGlmIChib251c01pbGVzdG9uZXMgPT0gQm9udXNNaWxlc3RvbmVzLlNlY29uZCkKICAgICAgICAgICAgKHJlc3VsdCwgYW1vdW50KSA9IGNhbGN1bGF0ZUJvbnVzKEJvbnVzTWlsZXN0b25lcy5UaGlyZCwgYW1vdW50LCBzZWNvbmRCb251c1JhbmdlLCAxNSwgcmVzdWx0KTsKCiAgICAgICAgaWYgKGJvbnVzTWlsZXN0b25lcyA9PSBCb251c01pbGVzdG9uZXMuVGhpcmQpCiAgICAgICAgICAgIChyZXN1bHQsIGFtb3VudCkgPSBjYWxjdWxhdGVCb251cyhCb251c01pbGVzdG9uZXMuRm91cnRoLCBhbW91bnQsIHRoaXJkQm9udXNSYW5nZSwgMTAsIHJlc3VsdCk7CgogICAgICAgIGlmIChib251c01pbGVzdG9uZXMgPT0gQm9udXNNaWxlc3RvbmVzLkZvdXJ0aCkKICAgICAgICAgICAgKHJlc3VsdCwgYW1vdW50KSA9IGNhbGN1bGF0ZUJvbnVzKEJvbnVzTWlsZXN0b25lcy5GaWZ0aCwgYW1vdW50LCBmb3VydGhCb251c1JhbmdlLCA1LCByZXN1bHQpOwoKICAgICAgICByZXR1cm4gcmVzdWx0LmFkZChhbW91bnQpOwogICAgfQoKICAgIC8qKgogICAgICogQGRldiBGZXRjaHMgQm9udXMgdGllciBwZXJjZW50YWdlIHBlciBib251cyBtaWxlc3RvbmVzCiAgICAgKiBAZGV2IHF1YWxpZmllZFBhcnRuZXIgQWRkcmVzcyBvZiBwYXJ0bmVycyB0aGF0IHBhcnRpY2lwYXRlZCBpbiBwcmUgc2FsZQogICAgICogQGRldiBhbW91bnRTZW50IFZhbHVlIHNlbnQgYnkgcXVhbGlmaWVkIHBhcnRuZXIKICAgICAqLwogICAgZnVuY3Rpb24gc2VuZFF1YWxpZmllZFBhcnRuZXJDb21taXNzaW9uRmVlKGFkZHJlc3MgcXVhbGlmaWVkUGFydG5lciwgdWludDI1NiBhbW91bnRTZW50KSBpbnRlcm5hbCB7CiAgICAgICAgLy9jYWxjdWxhdGUgdGhlIGNvbW1pc3Npb24gZmVlIHRvIHNlbmQgdG8gcXVhbGlmaWVkIHBhcnRuZXIKICAgICAgICB1aW50MjU2IGNvbW1pc3Npb25GZWVQZXJjZW50YWdlQ2FsY3VsYXRpb25BbW91bnQgPSBTYWZlTWF0aC5tdWwoYW1vdW50U2VudCwgcXVhbGlmaWVkUGFydG5lcnNbcXVhbGlmaWVkUGFydG5lcl0uY29tbWlzc2lvbkZlZVBlcmNlbnRhZ2UpIC8gMTAwOwoKICAgICAgICAvLyBzZW5kIGNvbW1pc3Npb24gZmVlIGFtb3VudAogICAgICAgIHF1YWxpZmllZFBhcnRuZXIudHJhbnNmZXIoY29tbWlzc2lvbkZlZVBlcmNlbnRhZ2VDYWxjdWxhdGlvbkFtb3VudCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBAZGV2IHJlZGlyZWN0VG9QdXJjaGFzZSBSZWRpcmVjdCB0byBhZGVxdWF0ZSBwdXJjaGFzZSBmdW5jdGlvbiB3aXRoaW4gdGhlIHNtYXJ0IGNvbnRyYWN0CiAgICAgKi8KICAgIGZ1bmN0aW9uIHJlZGlyZWN0VG9QdXJjaGFzZSgpIGludGVybmFsIHsKICAgICAgICBpZiAoYmxvY2subnVtYmVyIDwgcHVyY2hhc2VTdGFydEJsb2NrKSB7CiAgICAgICAgICAgIHB1cmNoYXNlQXNRdWFsaWZpZWRQYXJ0bmVyKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcHVyY2hhc2VXaXRoRXRoKCk7CiAgICAgICAgfQogICAgfQp9CgovKioKICogQHRpdGxlIFN0YXJiYXNlIENyb3dkc2FsZSBDb250cmFjdCBXaXRoZHJhd2FsIGNvbnRyYWN0IC0gUHJvdmlkZXMgYW4gZnVuY3Rpb24KICAgICAgICAgIHRvIHdpdGhkcmF3IFNUQVIgdG9rZW4gYWNjb3JkaW5nIHRvIGNyb3dkc2FsZSByZXN1bHRzCiAqIEBhdXRob3IgU3RhcmJhc2UgUFRFLiBMVEQuIC0gPDxzcGFuIGNsYXNzPSJfX2NmX2VtYWlsX18iIGRhdGEtY2ZlbWFpbD0iMGQ2NDYzNmI2MjRkN2U3OTZjN2Y2ZjZjN2U2ODIzNmU2MiI+W2VtYWlsJiMxNjA7cHJvdGVjdGVkXTwvc3Bhbj4+CiAqLwpjb250cmFjdCBTdGFyYmFzZUNyb3dkc2FsZUNvbnRyYWN0VyBpcyBPd25hYmxlIHsKICAgIHVzaW5nIFNhZmVNYXRoIGZvciB1aW50MjU2OwoKICAgIC8qCiAgICAgKiAgRXZlbnRzCiAgICAgKi8KICAgIGV2ZW50IFRva2VuV2l0aGRyYXduKGFkZHJlc3MgcHVyY2hhc2VyLCB1aW50MjU2IHRva2VuQ291bnQpOwogICAgZXZlbnQgQ3Jvd2RzYWxlUHVyY2hhc2VCb251c0xvZygKICAgICAgICB1aW50MjU2IHB1cmNoYXNlSWR4LCB1aW50MjU2IHJhd0Ftb3VudCwgdWludDI1NiBib251cyk7CgogICAgLyoqCiAgICAgKiAgRXh0ZXJuYWwgY29udHJhY3RzCiAgICAgKi8KICAgIEFic3RyYWN0U3RhcmJhc2VUb2tlbiBwdWJsaWMgc3RhcmJhc2VUb2tlbjsKICAgIFN0YXJiYXNlQ3Jvd2RzYWxlIHB1YmxpYyBzdGFyYmFzZUNyb3dkc2FsZTsKICAgIFN0YXJiYXNlRWFybHlQdXJjaGFzZUFtZW5kbWVudCBwdWJsaWMgc3RhcmJhc2VFcEFtZW5kbWVudDsKCiAgICAvKioKICAgICAqICBDb25zdGFudHMKICAgICAqLwogICAgdWludDI1NiBjb25zdGFudCBwdWJsaWMgY3Jvd2RzYWxlVG9rZW5BbW91bnQgPSAxMjUwMDAwMDBlMTg7CiAgICB1aW50MjU2IGNvbnN0YW50IHB1YmxpYyBlYXJseVB1cmNoYXNlVG9rZW5BbW91bnQgPSA1MDAwMDAwMGUxODsKCiAgICAvKioKICAgICAqICBTdG9yYWdlCiAgICAgKi8KCiAgICAvLyBlYXJseSBwdXJjaGFzZQogICAgYWRkcmVzc1tdIHB1YmxpYyBlYXJseVB1cmNoYXNlcnM7CiAgICBtYXBwaW5nIChhZGRyZXNzID0+IHVpbnQyNTYpIHB1YmxpYyBlYXJseVB1cmNoYXNlZEFtb3VudEJ5OyAvLyBlYXJseSBwdXJjaGFzZWQgYW1vdW50IGluIENOWSBwZXIgcHVyY2hhc2VycycgYWRkcmVzcwogICAgYm9vbCBwdWJsaWMgZWFybHlQdXJjaGFzZXNMb2FkZWQgPSBmYWxzZTsgIC8vIHJldHVybnMgd2hldGhlciBhbGwgZWFybHkgcHVyY2hhc2VzIGFyZSBsb2FkZWQgaW50byB0aGlzIGNvbnRyYWN0CiAgICB1aW50MjU2IHB1YmxpYyB0b3RhbEFtb3VudE9mRWFybHlQdXJjaGFzZXM7IC8vIGluY2x1ZGluZyBib251cwogICAgdWludCBwdWJsaWMgbnVtT2ZEZWxpdmVyZWRFYXJseVB1cmNoYXNlczsgIC8vIGluZGV4IHRvIGtlZXAgdGhlIG51bWJlciBvZiBlYXJseSBwdXJjaGFzZXMgaGF2ZSBhbHJlYWR5IGJlZW4gcHJvY2Vzc2VkIGJ5IGB3aXRoZHJhd1B1cmNoYXNlZFRva2Vuc2AKICAgIHVpbnQyNTYgcHVibGljIG51bU9mTG9hZGVkRWFybHlQdXJjaGFzZXM7IC8vIGluZGV4IHRvIGtlZXAgdGhlIG51bWJlciBvZiBlYXJseSBwdXJjaGFzZXMgdGhhdCBoYXZlIGFscmVhZHkgYmVlbiBsb2FkZWQgYnkgYGxvYWRFYXJseVB1cmNoYXNlc2AKCiAgICAvLyBjcm93ZHNhbGUKICAgIHVpbnQyNTYgcHVibGljIHRvdGFsQW1vdW50T2ZDcm93ZHNhbGVQdXJjaGFzZXM7IC8vIGluIENOWSwgaW5jbHVkaW5nIGJvbnVzZXMKICAgIHVpbnQyNTYgcHVibGljIHRvdGFsQW1vdW50T2ZDcm93ZHNhbGVQdXJjaGFzZXNXaXRob3V0Qm9udXM7IC8vIGluIENOWQogICAgdWludDI1NiBwdWJsaWMgc3RhcnREYXRlOwogICAgdWludDI1NiBwdWJsaWMgZW5kZWRBdDsKICAgIG1hcHBpbmcgKGFkZHJlc3MgPT4gdWludDI1NikgcHVibGljIGNyb3dkc2FsZVB1cmNoYXNlQW1vdW50Qnk7IC8vIGNyb3dkc2FsZSBwdXJjaGFzZSBhbW91bnQgaW4gQ05ZIHBlciBwdXJjaGFzZXJzJyBhZGRyZXNzCiAgICB1aW50IHB1YmxpYyBudW1PZkRlbGl2ZXJlZENyb3dkc2FsZVB1cmNoYXNlczsgIC8vIGluZGV4IHRvIGtlZXAgdGhlIG51bWJlciBvZiBjcm93ZHNhbGUgcHVyY2hhc2VzIGhhdmUgYWxyZWFkeSBiZWVuIHByb2Nlc3NlZCBieSBgd2l0aGRyYXdQdXJjaGFzZWRUb2tlbnNgCgogICAgLy8gY3Jvd2RzYWxlIGNvbnRyYWN0IHdpdGhkcmF3YWwKICAgIGJvb2wgcHVibGljIGNyb3dkc2FsZVB1cmNoYXNlc0xvYWRlZCA9IGZhbHNlOyAgIC8vIHJldHVybnMgd2hldGhlciBhbGwgY3Jvd2RzYWxlIHB1cmNoYXNlcyBhcmUgbG9hZGVkIGludG8gdGhpcyBjb250cmFjdAogICAgdWludDI1NiBwdWJsaWMgbnVtT2ZMb2FkZWRDcm93ZHNhbGVQdXJjaGFzZXM7IC8vIGluZGV4IHRvIGtlZXAgdGhlIG51bWJlciBvZiBjcm93ZHNhbGUgcHVyY2hhc2VzIHRoYXQgaGF2ZSBhbHJlYWR5IGJlZW4gbG9hZGVkIGJ5IGBsb2FkQ3Jvd2RzYWxlUHVyY2hhc2VzYAogICAgdWludDI1NiBwdWJsaWMgdG90YWxBbW91bnRPZlByZXNhbGVQdXJjaGFzZXNXaXRob3V0Qm9udXM7ICAvLyBpbiBDTlkKCiAgICAvLyBhZnRlciB0aGUgY3Jvd2RzYWxlCiAgICBtYXBwaW5nIChhZGRyZXNzID0+IGJvb2wpIHB1YmxpYyB0b2tlbldpdGhkcmF3bjsgICAgLy8gcmV0dXJucyB3aGV0aGVyIHB1cmNoYXNlZCB0b2tlbnMgd2VyZSB3aXRoZHJhd24gYnkgYSBwdXJjaGFzZXIKICAgIG1hcHBpbmcgKGFkZHJlc3MgPT4gdWludDI1NikgcHVibGljIG51bU9mUHVyY2hhc2VkVG9rZW5zT25Dc0J5OyAgICAvLyB0aGUgbnVtYmVyIG9mIHRva2VucyBwdXJjaGFzZWQgb24gdGhlIGNyb3dkc2FsZSBieSBhIHB1cmNoYXNlcgogICAgbWFwcGluZyAoYWRkcmVzcyA9PiB1aW50MjU2KSBwdWJsaWMgbnVtT2ZQdXJjaGFzZWRUb2tlbnNPbkVwQnk7ICAgIC8vIHRoZSBudW1iZXIgb2YgdG9rZW5zIGVhcmx5IHB1cmNoYXNlZCBieSBhIHB1cmNoYXNlcgoKICAgIC8qKgogICAgICogIE1vZGlmaWVycwogICAgICovCiAgICBtb2RpZmllciB3aGVuRW5kZWQoKSB7CiAgICAgICAgYXNzZXJ0KGlzRW5kZWQoKSk7CiAgICAgICAgXzsKICAgIH0KCiAgICAvKioKICAgICAqIENvbnRyYWN0IGZ1bmN0aW9ucwogICAgICovCgogICAgLyoqCiAgICAgKiBAZGV2IFJlamVjdCBhbGwgaW5jb21pbmcgRXRoZXIgdHJhbnNmZXJzCiAgICAgKi8KICAgIGZ1bmN0aW9uICgpIHsgcmV2ZXJ0KCk7IH0KCiAgICAvKioKICAgICAqIEV4dGVybmFsIGZ1bmN0aW9ucwogICAgICovCgogICAgLyoqCiAgICAgKiBAZGV2IFNldHVwIGZ1bmN0aW9uIHNldHMgZXh0ZXJuYWwgY29udHJhY3RzJyBhZGRyZXNzCiAgICAgKiBAcGFyYW0gc3RhcmJhc2VUb2tlbkFkZHJlc3MgVG9rZW4gYWRkcmVzcy4KICAgICAqIEBwYXJhbSBTdGFyYmFzZUNyb3dkc2FsZUFkZHJlc3MgVG9rZW4gYWRkcmVzcy4KICAgICAqLwogICAgZnVuY3Rpb24gc2V0dXAoYWRkcmVzcyBzdGFyYmFzZVRva2VuQWRkcmVzcywgYWRkcmVzcyBTdGFyYmFzZUNyb3dkc2FsZUFkZHJlc3MpCiAgICAgICAgZXh0ZXJuYWwKICAgICAgICBvbmx5T3duZXIKICAgIHsKICAgICAgICByZXF1aXJlKHN0YXJiYXNlVG9rZW5BZGRyZXNzICE9IGFkZHJlc3MoMCkgJiYgU3RhcmJhc2VDcm93ZHNhbGVBZGRyZXNzICE9IGFkZHJlc3MoMCkpOwogICAgICAgIHJlcXVpcmUoYWRkcmVzcyhzdGFyYmFzZVRva2VuKSA9PSAwICYmIGFkZHJlc3Moc3RhcmJhc2VDcm93ZHNhbGUpID09IDApOwoKICAgICAgICBzdGFyYmFzZVRva2VuID0gQWJzdHJhY3RTdGFyYmFzZVRva2VuKHN0YXJiYXNlVG9rZW5BZGRyZXNzKTsKICAgICAgICBzdGFyYmFzZUNyb3dkc2FsZSA9IFN0YXJiYXNlQ3Jvd2RzYWxlKFN0YXJiYXNlQ3Jvd2RzYWxlQWRkcmVzcyk7CiAgICAgICAgc3RhcmJhc2VFcEFtZW5kbWVudCA9IFN0YXJiYXNlRWFybHlQdXJjaGFzZUFtZW5kbWVudChzdGFyYmFzZUNyb3dkc2FsZS5zdGFyYmFzZUVwQW1lbmRtZW50KCkpOwoKICAgICAgICByZXF1aXJlKHN0YXJiYXNlQ3Jvd2RzYWxlLnN0YXJ0RGF0ZSgpID4gMCk7CiAgICAgICAgc3RhcnREYXRlID0gc3RhcmJhc2VDcm93ZHNhbGUuc3RhcnREYXRlKCk7CgogICAgICAgIHJlcXVpcmUoc3RhcmJhc2VDcm93ZHNhbGUuZW5kZWRBdCgpID4gMCk7CiAgICAgICAgZW5kZWRBdCA9IHN0YXJiYXNlQ3Jvd2RzYWxlLmVuZGVkQXQoKTsKICAgIH0KCiAgICAvKioKICAgICAqIEBkZXYgTG9hZCBjcm93ZHNhbGUgcHVyY2hhc2VzIGZyb20gdGhlIGNvbnRyYWN0IGtlZXBzIHRyYWNrIG9mIHRoZW0KICAgICAqIEBwYXJhbSBudW1PZlByZXNhbGVQdXJjaGFzZXMgTnVtYmVyIG9mIHByZXNhbGUgcHVyY2hhc2UKICAgICAqLwogICAgZnVuY3Rpb24gbG9hZENyb3dkc2FsZVB1cmNoYXNlcyh1aW50MjU2IG51bU9mUHJlc2FsZVB1cmNoYXNlcykKICAgICAgICBleHRlcm5hbAogICAgICAgIG9ubHlPd25lcgogICAgICAgIHdoZW5FbmRlZAogICAgewogICAgICAgIHJlcXVpcmUoIWNyb3dkc2FsZVB1cmNoYXNlc0xvYWRlZCk7CgogICAgICAgIHVpbnQyNTYgbnVtT2ZQdXJjaGFzZXMgPSBzdGFyYmFzZUNyb3dkc2FsZS5udW1PZlB1cmNoYXNlcygpOwoKICAgICAgICBmb3IgKHVpbnQyNTYgaSA9IG51bU9mTG9hZGVkQ3Jvd2RzYWxlUHVyY2hhc2VzOyBpIDwgbnVtT2ZQdXJjaGFzZXMgJiYgbXNnLmdhcyA+IDIwMDAwMDsgaSsrKSB7CiAgICAgICAgICAgIHZhciAocHVyY2hhc2VyLCBhbW91bnQsIHJhd0Ftb3VudCwpID0KICAgICAgICAgICAgICAgIHN0YXJiYXNlQ3Jvd2RzYWxlLmNyb3dkc2FsZVB1cmNoYXNlcyhpKTsKCiAgICAgICAgICAgIHVpbnQyNTYgYm9udXM7CiAgICAgICAgICAgIGlmIChpIDwgbnVtT2ZQcmVzYWxlUHVyY2hhc2VzKSB7CiAgICAgICAgICAgICAgICBib251cyA9IHJhd0Ftb3VudCAqIDMwIC8gMTAwOyAgIC8vIHByZXNhbGU6IDMwJSBib251cwogICAgICAgICAgICAgICAgdG90YWxBbW91bnRPZlByZXNhbGVQdXJjaGFzZXNXaXRob3V0Qm9udXMgPQogICAgICAgICAgICAgICAgICAgIHRvdGFsQW1vdW50T2ZQcmVzYWxlUHVyY2hhc2VzV2l0aG91dEJvbnVzLmFkZChyYXdBbW91bnQpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgYm9udXMgPSBjYWxjdWxhdGVCb251cyhyYXdBbW91bnQpOyAvLyBtYWluc2FsZTogMjAlIH4gMCUgYm9udXMKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gVXBkYXRlIGFtb3VudCB3aXRoIGJvbnVzCiAgICAgICAgICAgIENyb3dkc2FsZVB1cmNoYXNlQm9udXNMb2coaSwgcmF3QW1vdW50LCBib251cyk7CiAgICAgICAgICAgIGFtb3VudCA9IHJhd0Ftb3VudCArIGJvbnVzOwoKICAgICAgICAgICAgLy8gSW5jcmVhc2UgdGhlIHN1bXMKICAgICAgICAgICAgY3Jvd2RzYWxlUHVyY2hhc2VBbW91bnRCeVtwdXJjaGFzZXJdID0gU2FmZU1hdGguYWRkKGNyb3dkc2FsZVB1cmNoYXNlQW1vdW50QnlbcHVyY2hhc2VyXSwgYW1vdW50KTsKICAgICAgICAgICAgdG90YWxBbW91bnRPZkNyb3dkc2FsZVB1cmNoYXNlcyA9IHRvdGFsQW1vdW50T2ZDcm93ZHNhbGVQdXJjaGFzZXMuYWRkKGFtb3VudCk7CiAgICAgICAgICAgIHRvdGFsQW1vdW50T2ZDcm93ZHNhbGVQdXJjaGFzZXNXaXRob3V0Qm9udXMgPSB0b3RhbEFtb3VudE9mQ3Jvd2RzYWxlUHVyY2hhc2VzV2l0aG91dEJvbnVzLmFkZChyYXdBbW91bnQpOwoKICAgICAgICAgICAgbnVtT2ZMb2FkZWRDcm93ZHNhbGVQdXJjaGFzZXMrKzsgICAgLy8gSW5jcmVhc2UgdGhlIGluZGV4CiAgICAgICAgfQoKICAgICAgICBhc3NlcnQobnVtT2ZMb2FkZWRDcm93ZHNhbGVQdXJjaGFzZXMgPD0gbnVtT2ZQdXJjaGFzZXMpOwogICAgICAgIGlmIChudW1PZkxvYWRlZENyb3dkc2FsZVB1cmNoYXNlcyA9PSBudW1PZlB1cmNoYXNlcykgewogICAgICAgICAgICBjcm93ZHNhbGVQdXJjaGFzZXNMb2FkZWQgPSB0cnVlOyAgICAvLyBlbmFibGUgdGhlIGZsYWcKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBAZGV2IEFkZCBlYXJseSBwdXJjaGFzZXMKICAgICAqLwogICAgZnVuY3Rpb24gYWRkRWFybHlQdXJjaGFzZXMoKSBleHRlcm5hbCBvbmx5T3duZXIgcmV0dXJucyAoYm9vbCkgewogICAgICAgIGlmIChlYXJseVB1cmNoYXNlc0xvYWRlZCkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7ICAgIC8vIGFsbCBFUHMgaGF2ZSBhbHJlYWR5IGJlZW4gbG9hZGVkCiAgICAgICAgfQoKICAgICAgICB1aW50MjU2IG51bU9mT3JpZ0VwID0gc3RhcmJhc2VFcEFtZW5kbWVudAogICAgICAgICAgICAuc3RhcmJhc2VFYXJseVB1cmNoYXNlKCkKICAgICAgICAgICAgLm51bWJlck9mRWFybHlQdXJjaGFzZXMoKTsKCiAgICAgICAgZm9yICh1aW50MjU2IGkgPSBudW1PZkxvYWRlZEVhcmx5UHVyY2hhc2VzOyBpIDwgbnVtT2ZPcmlnRXAgJiYgbXNnLmdhcyA+IDIwMDAwMDsgaSsrKSB7CiAgICAgICAgICAgIGlmIChzdGFyYmFzZUVwQW1lbmRtZW50LmlzSW52YWxpZEVhcmx5UHVyY2hhc2UoaSkpIHsKICAgICAgICAgICAgICAgIG51bU9mTG9hZGVkRWFybHlQdXJjaGFzZXMgPSBTYWZlTWF0aC5hZGQobnVtT2ZMb2FkZWRFYXJseVB1cmNoYXNlcywgMSk7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgKHB1cmNoYXNlciwgYW1vdW50LCkgPQogICAgICAgICAgICAgICAgc3RhcmJhc2VFcEFtZW5kbWVudC5pc0FtZW5kZWRFYXJseVB1cmNoYXNlKGkpCiAgICAgICAgICAgICAgICA/IHN0YXJiYXNlRXBBbWVuZG1lbnQuYW1lbmRlZEVhcmx5UHVyY2hhc2VzKGkpCiAgICAgICAgICAgICAgICA6IHN0YXJiYXNlRXBBbWVuZG1lbnQuZWFybHlQdXJjaGFzZXMoaSk7CiAgICAgICAgICAgIGlmIChhbW91bnQgPiAwKSB7CiAgICAgICAgICAgICAgICBpZiAoZWFybHlQdXJjaGFzZWRBbW91bnRCeVtwdXJjaGFzZXJdID09IDApIHsKICAgICAgICAgICAgICAgICAgICBlYXJseVB1cmNoYXNlcnMucHVzaChwdXJjaGFzZXIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy8gZWFjaCBlYXJseSBwdXJjaGFzZXIgcmVjZWl2ZXMgMTAlIGJvbnVzCiAgICAgICAgICAgICAgICB1aW50MjU2IGJvbnVzID0gU2FmZU1hdGgubXVsKGFtb3VudCwgMTApIC8gMTAwOwogICAgICAgICAgICAgICAgdWludDI1NiBhbW91bnRXaXRoQm9udXMgPSBTYWZlTWF0aC5hZGQoYW1vdW50LCBib251cyk7CgogICAgICAgICAgICAgICAgZWFybHlQdXJjaGFzZWRBbW91bnRCeVtwdXJjaGFzZXJdID0gU2FmZU1hdGguYWRkKGVhcmx5UHVyY2hhc2VkQW1vdW50QnlbcHVyY2hhc2VyXSwgYW1vdW50V2l0aEJvbnVzKTsKICAgICAgICAgICAgICAgIHRvdGFsQW1vdW50T2ZFYXJseVB1cmNoYXNlcyA9IHRvdGFsQW1vdW50T2ZFYXJseVB1cmNoYXNlcy5hZGQoYW1vdW50V2l0aEJvbnVzKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgbnVtT2ZMb2FkZWRFYXJseVB1cmNoYXNlcyA9IFNhZmVNYXRoLmFkZChudW1PZkxvYWRlZEVhcmx5UHVyY2hhc2VzLCAxKTsKICAgICAgICB9CgogICAgICAgIGFzc2VydChudW1PZkxvYWRlZEVhcmx5UHVyY2hhc2VzIDw9IG51bU9mT3JpZ0VwKTsKICAgICAgICBpZiAobnVtT2ZMb2FkZWRFYXJseVB1cmNoYXNlcyA9PSBudW1PZk9yaWdFcCkgewogICAgICAgICAgICBlYXJseVB1cmNoYXNlc0xvYWRlZCA9IHRydWU7ICAgIC8vIGVuYWJsZSB0aGUgZmxhZwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgLyoqCiAgICAgKiBAZGV2IERlbGl2ZXIgdG9rZW5zIHRvIHB1cmNoYXNlcnMgYWNjb3JkaW5nIHRvIHRoZWlyIHB1cmNoYXNlIGFtb3VudCBpbiBDTlkKICAgICAqLwogICAgZnVuY3Rpb24gd2l0aGRyYXdQdXJjaGFzZWRUb2tlbnMoKQogICAgICAgIGV4dGVybmFsCiAgICAgICAgd2hlbkVuZGVkCiAgICB7CiAgICAgICAgcmVxdWlyZShjcm93ZHNhbGVQdXJjaGFzZXNMb2FkZWQpOwogICAgICAgIGFzc2VydChlYXJseVB1cmNoYXNlc0xvYWRlZCk7CiAgICAgICAgYXNzZXJ0KGFkZHJlc3Moc3RhcmJhc2VUb2tlbikgIT0gMCk7CgogICAgICAgIC8vIHByZXZlbnQgZG91YmxlIHdpdGhkcmF3YWwKICAgICAgICByZXF1aXJlKCF0b2tlbldpdGhkcmF3blttc2cuc2VuZGVyXSk7CiAgICAgICAgdG9rZW5XaXRoZHJhd25bbXNnLnNlbmRlcl0gPSB0cnVlOwoKICAgICAgICAvKgogICAgICAgICAqIOKAnFZhbHVl4oCdIHJlZmVycyB0byB0aGUgY29udHJpYnV0aW9uIG9mIHRoZSBVc2VyOgogICAgICAgICAqICB7Y3Jvd2RzYWxlX3B1cmNoYXNlcl90b2tlbl9hbW91bnR9ID0KICAgICAgICAgKiAge2Nyb3dkc2FsZV90b2tlbl9hbW91bnR9ICoge2Nyb3dkc2FsZVB1cmNoYXNlX3ZhbHVlfSAvIHtlYXJseXB1cmNoYXNlX3ZhbHVlfSArIHtjcm93ZHNhbGVfdmFsdWV9LgogICAgICAgICAqCiAgICAgICAgICogRXhhbXBsZTogSWYgYSBVc2VyIGNvbnRyaWJ1dGVzIGR1cmluZyB0aGUgQ29udHJpYnV0aW9uIFBlcmlvZCAxMDAgQ05ZIChpbmNsdWRpbmcgYXBwbGljYWJsZQogICAgICAgICAqIEJvbnVzLCBpZiBhbnkpIGFuZCB0aGUgdG90YWwgYW1vdW50IGVhcmx5IHB1cmNoYXNlcyBhbW91bnRzIHRvIDbigJkwMDDigJkwMDAgQ05ZCiAgICAgICAgICogYW5kIHRvdGFsIGFtb3VudCByYWlzZWQgZHVyaW5nIHRoZSBDb250cmlidXRpb24gUGVyaW9kIGlzIDMw4oCZMDAw4oCZMDAwLCB0aGVuIGhlIHdpbGwgZ2V0CiAgICAgICAgICogMzQ3LjIyIFNUQVIgPSAxMjXigJkwMDDigJkwMDAgU1RBUiAqIDEwMCBDTlkgLyAzMOKAmTAwMOKAmTAwMCBDTlkgKyA24oCZMDAw4oCZMDAwIENOWS4KICAgICAgICAqLwoKICAgICAgICBpZiAoY3Jvd2RzYWxlUHVyY2hhc2VBbW91bnRCeVttc2cuc2VuZGVyXSA+IDApIHsKICAgICAgICAgICAgdWludDI1NiBjcm93ZHNhbGVQdXJjaGFzZVZhbHVlID0gY3Jvd2RzYWxlUHVyY2hhc2VBbW91bnRCeVttc2cuc2VuZGVyXTsKICAgICAgICAgICAgdWludDI1NiB0b2tlbkNvdW50ID0KICAgICAgICAgICAgICAgIFNhZmVNYXRoLm11bChjcm93ZHNhbGVUb2tlbkFtb3VudCwgY3Jvd2RzYWxlUHVyY2hhc2VWYWx1ZSkgLwogICAgICAgICAgICAgICAgdG90YWxSYWlzZWRBbW91bnRJbkNueSgpOwoKICAgICAgICAgICAgbnVtT2ZQdXJjaGFzZWRUb2tlbnNPbkNzQnlbbXNnLnNlbmRlcl0gPQogICAgICAgICAgICAgICAgU2FmZU1hdGguYWRkKG51bU9mUHVyY2hhc2VkVG9rZW5zT25Dc0J5W21zZy5zZW5kZXJdLCB0b2tlbkNvdW50KTsKICAgICAgICAgICAgYXNzZXJ0KHN0YXJiYXNlVG9rZW4uYWxsb2NhdGVUb0Nyb3dkc2FsZVB1cmNoYXNlcihtc2cuc2VuZGVyLCB0b2tlbkNvdW50KSk7CiAgICAgICAgICAgIG51bU9mRGVsaXZlcmVkQ3Jvd2RzYWxlUHVyY2hhc2VzKys7CiAgICAgICAgICAgIFRva2VuV2l0aGRyYXduKG1zZy5zZW5kZXIsIHRva2VuQ291bnQpOwogICAgICAgIH0KCiAgICAgICAgLyoKICAgICAgICAgKiDigJxWYWx1ZeKAnSByZWZlcnMgdG8gdGhlIGNvbnRyaWJ1dGlvbiBvZiB0aGUgVXNlcjoKICAgICAgICAgKiB7ZWFybHlwdXJjaGFzZXJfdG9rZW5fYW1vdW50fSA9CiAgICAgICAgICoge2Vhcmx5cHVyY2hhc2VyX3Rva2VuX2Ftb3VudH0gKiAoe2Vhcmx5cHVyY2hhc2VfdmFsdWV9IC8ge3RvdGFsX2Vhcmx5cHVyY2hhc2VfdmFsdWV9KQogICAgICAgICAqICArIHtjcm93ZHNhbGVfdG9rZW5fYW1vdW50fSAqICh7ZWFybHlwdXJjaGFzZV92YWx1ZX0gLyB7ZWFybHlwdXJjaGFzZV92YWx1ZX0gKyB7Y3Jvd2RzYWxlX3ZhbHVlfSkuCiAgICAgICAgICoKICAgICAgICAgKiBFeGFtcGxlOiBJZiBhbiBFYXJseSBQdXJjaGFzZXIgY29udHJpYnV0ZXMgMTAwIENOWSAoaW5jbHVkaW5nIEJvbnVzKSBhbmQgdGhlCiAgICAgICAgICogdG90YWwgYW1vdW50IG9mIGVhcmx5IHB1cmNoYXNlcyBhbW91bnRzIHRvIDbigJkwMDDigJkwMDAgQ05ZIGFuZCB0aGUgdG90YWwgYW1vdW50IHJhaXNlZAogICAgICAgICAqIGR1cmluZyB0aGUgQ29udHJpYnV0aW9uIFBlcmlvZCBpcyAzMOKAmTAwMOKAmTAwMCBDTlksIHRoZW4gaGUgd2lsbCBnZXQgMTE4MC41NSBTVEFSID0KICAgICAgICAgKiA1MOKAmTAwMOKAmTAwMCBTVEFSICogMTAwIENOWSAvIDbigJkwMDDigJkwMDAgQ05ZICsgMTI14oCZMDAw4oCZMDAwIFNUQVIgKiAxMDAgQ05ZIC8KICAgICAgICAgKiAzMOKAmTAwMOKAmTAwMCBDTlkgKyA24oCZMDAw4oCZMDAwIENOWQogICAgICAgICAqLwoKICAgICAgICBpZiAoZWFybHlQdXJjaGFzZWRBbW91bnRCeVttc2cuc2VuZGVyXSA+IDApIHsgIC8vIHNraXAgaWYgaXMgbm90IGFuIGVhcmx5IHB1cmNoYXNlcgogICAgICAgICAgICB1aW50MjU2IGVhcmx5UHVyY2hhc2VyUHVyY2hhc2VWYWx1ZSA9IGVhcmx5UHVyY2hhc2VkQW1vdW50QnlbbXNnLnNlbmRlcl07CiAgICAgICAgICAgIHVpbnQyNTYgZXBUb2tlbkNhbGN1bGF0aW9uRnJvbUVQVG9rZW5BbW91bnQgPSBTYWZlTWF0aC5tdWwoZWFybHlQdXJjaGFzZVRva2VuQW1vdW50LCBlYXJseVB1cmNoYXNlclB1cmNoYXNlVmFsdWUpIC8gdG90YWxBbW91bnRPZkVhcmx5UHVyY2hhc2VzOwogICAgICAgICAgICB1aW50MjU2IGVwVG9rZW5DYWxjdWxhdGlvbkZyb21Dcm93ZHNhbGVUb2tlbkFtb3VudCA9IFNhZmVNYXRoLm11bChjcm93ZHNhbGVUb2tlbkFtb3VudCwgZWFybHlQdXJjaGFzZXJQdXJjaGFzZVZhbHVlKSAvIHRvdGFsUmFpc2VkQW1vdW50SW5DbnkoKTsKICAgICAgICAgICAgdWludDI1NiBlcFRva2VuQ291bnQgPSBTYWZlTWF0aC5hZGQoZXBUb2tlbkNhbGN1bGF0aW9uRnJvbUVQVG9rZW5BbW91bnQsIGVwVG9rZW5DYWxjdWxhdGlvbkZyb21Dcm93ZHNhbGVUb2tlbkFtb3VudCk7CgogICAgICAgICAgICBudW1PZlB1cmNoYXNlZFRva2Vuc09uRXBCeVttc2cuc2VuZGVyXSA9IFNhZmVNYXRoLmFkZChudW1PZlB1cmNoYXNlZFRva2Vuc09uRXBCeVttc2cuc2VuZGVyXSwgZXBUb2tlbkNvdW50KTsKICAgICAgICAgICAgYXNzZXJ0KHN0YXJiYXNlVG9rZW4uYWxsb2NhdGVUb0Nyb3dkc2FsZVB1cmNoYXNlcihtc2cuc2VuZGVyLCBlcFRva2VuQ291bnQpKTsKICAgICAgICAgICAgbnVtT2ZEZWxpdmVyZWRFYXJseVB1cmNoYXNlcysrOwogICAgICAgICAgICBUb2tlbldpdGhkcmF3bihtc2cuc2VuZGVyLCBlcFRva2VuQ291bnQpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFB1YmxpYyBmdW5jdGlvbnMKICAgICAqLwoKICAgIC8qKgogICAgICogQGRldiBSZXR1cm5zIGJvb2xlYW4gZm9yIHdoZXRoZXIgY3Jvd2RzYWxlIGhhcyBlbmRlZAogICAgICovCiAgICBmdW5jdGlvbiBpc0VuZGVkKCkgY29uc3RhbnQgcHVibGljIHJldHVybnMgKGJvb2wpIHsKICAgICAgICByZXR1cm4gKHN0YXJiYXNlQ3Jvd2RzYWxlICE9IGFkZHJlc3MoMCkgJiYgZW5kZWRBdCA+IDApOwogICAgfQoKICAgIC8qKgogICAgICogQGRldiBSZXR1cm5zIHRvdGFsIHJhaXNlZCBhbW91bnQgaW4gQ05ZIChpbmNsdWRlcyBFUCkgYW5kIGJvbnVzZXMKICAgICAqLwogICAgZnVuY3Rpb24gdG90YWxSYWlzZWRBbW91bnRJbkNueSgpIGNvbnN0YW50IHB1YmxpYyByZXR1cm5zICh1aW50MjU2KSB7CiAgICAgICAgcmV0dXJuIHRvdGFsQW1vdW50T2ZFYXJseVB1cmNoYXNlcy5hZGQodG90YWxBbW91bnRPZkNyb3dkc2FsZVB1cmNoYXNlcyk7CiAgICB9CgogICAgLyoqCiAgICAgKiBJbnRlcm5hbCBmdW5jdGlvbnMKICAgICAqLwoKICAgIC8qKgogICAgICogQGRldiBDYWxjdWxhdGVzIGJvbnVzIG9mIGEgcHVyY2hhc2UKICAgICAqLwogICAgZnVuY3Rpb24gY2FsY3VsYXRlQm9udXModWludDI1NiByYXdBbW91bnQpCiAgICAgICAgaW50ZXJuYWwKICAgICAgICByZXR1cm5zICh1aW50MjU2IGJvbnVzKQogICAgewogICAgICAgIHVpbnQyNTYgcHVyY2hhc2VkQW1vdW50ID0KICAgICAgICAgICAgdG90YWxBbW91bnRPZkNyb3dkc2FsZVB1cmNoYXNlc1dpdGhvdXRCb251cwogICAgICAgICAgICAgICAgLnN1Yih0b3RhbEFtb3VudE9mUHJlc2FsZVB1cmNoYXNlc1dpdGhvdXRCb251cyk7CiAgICAgICAgdWludDI1NiBlMSA9IHN0YXJiYXNlQ3Jvd2RzYWxlLmZpcnN0Qm9udXNFbmRzKCk7CiAgICAgICAgdWludDI1NiBlMiA9IHN0YXJiYXNlQ3Jvd2RzYWxlLnNlY29uZEJvbnVzRW5kcygpOwogICAgICAgIHVpbnQyNTYgZTMgPSBzdGFyYmFzZUNyb3dkc2FsZS50aGlyZEJvbnVzRW5kcygpOwogICAgICAgIHVpbnQyNTYgZTQgPSBzdGFyYmFzZUNyb3dkc2FsZS5mb3VydGhCb251c0VuZHMoKTsKICAgICAgICByZXR1cm4gY2FsY3VsYXRlQm9udXNJblJhbmdlKHB1cmNoYXNlZEFtb3VudCwgcmF3QW1vdW50LCAwLCBlMSwgMjApCiAgICAgICAgICAgIC5hZGQoY2FsY3VsYXRlQm9udXNJblJhbmdlKHB1cmNoYXNlZEFtb3VudCwgcmF3QW1vdW50LCBlMSwgZTIsIDE1KSkKICAgICAgICAgICAgLmFkZChjYWxjdWxhdGVCb251c0luUmFuZ2UocHVyY2hhc2VkQW1vdW50LCByYXdBbW91bnQsIGUyLCBlMywgMTApKQogICAgICAgICAgICAuYWRkKGNhbGN1bGF0ZUJvbnVzSW5SYW5nZShwdXJjaGFzZWRBbW91bnQsIHJhd0Ftb3VudCwgZTMsIGU0LCA1KSk7CiAgICB9CgogICAgZnVuY3Rpb24gY2FsY3VsYXRlQm9udXNJblJhbmdlKAogICAgICAgIHVpbnQyNTYgcHVyY2hhc2VkQW1vdW50LAogICAgICAgIHVpbnQyNTYgcmF3QW1vdW50LAogICAgICAgIHVpbnQyNTYgYm9udXNCZWdpbiwKICAgICAgICB1aW50MjU2IGJvbnVzRW5kLAogICAgICAgIHVpbnQyNTYgYm9udXNUaWVyCiAgICApCiAgICAgICAgcHVibGljCiAgICAgICAgY29uc3RhbnQKICAgICAgICByZXR1cm5zICh1aW50MjU2IGJvbnVzKQogICAgewogICAgICAgIHVpbnQyNTYgc3VtID0gcHVyY2hhc2VkQW1vdW50ICsgcmF3QW1vdW50OwogICAgICAgIGlmIChwdXJjaGFzZWRBbW91bnQgPiBib251c0VuZCB8fCBzdW0gPCBib251c0JlZ2luKSB7CiAgICAgICAgICAgIHJldHVybiAwOyAgIC8vIG91dCBvZiB0aGlzIHJhbmdlCiAgICAgICAgfQoKICAgICAgICB1aW50MjU2IG1pbiA9IHB1cmNoYXNlZEFtb3VudCA8PSBib251c0JlZ2luID8gYm9udXNCZWdpbiA6IHB1cmNoYXNlZEFtb3VudDsKICAgICAgICB1aW50MjU2IG1heCA9IGJvbnVzRW5kIDw9IHN1bSA/IGJvbnVzRW5kIDogc3VtOwogICAgICAgIHJldHVybiBtYXguc3ViKG1pbikgKiBib251c1RpZXIgLyAxMDA7CiAgICB9Cn0='.
	

]
