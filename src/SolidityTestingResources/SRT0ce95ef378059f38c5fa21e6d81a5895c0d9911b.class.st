Class {
	#name : #SRT0ce95ef378059f38c5fa21e6d81a5895c0d9911b,
	#superclass : #SRTContracts,
	#category : #SolidityTestingResources
}

{ #category : #base64 }
SRT0ce95ef378059f38c5fa21e6d81a5895c0d9911b >> base64 [
	^ 'cHJhZ21hIHNvbGlkaXR5IF4wLjQuMTM7Cgpjb250cmFjdCBBYnN0cmFjdERhdGFiYXNlCnsKICAgIGZ1bmN0aW9uKCkgcHVibGljIHBheWFibGU7CiAgICBmdW5jdGlvbiBDaGFuZ2VPd25lcihhZGRyZXNzIG5ld19vd25lcikgcHVibGljOwogICAgZnVuY3Rpb24gQ2hhbmdlT3duZXIyKGFkZHJlc3MgbmV3X293bmVyKSBwdWJsaWM7CiAgICBmdW5jdGlvbiBTdG9yZShhZGRyZXNzIHVzZXIsIHVpbnQyNTYgY2F0ZWdvcnksIHVpbnQyNTYgc2xvdCwgYnl0ZXMzMiBkYXRhKSBwdWJsaWM7CiAgICBmdW5jdGlvbiBMb2FkKGFkZHJlc3MgdXNlciwgdWludDI1NiBjYXRlZ29yeSwgdWludDI1NiBpbmRleCkgcHVibGljIHZpZXcgcmV0dXJucyAoYnl0ZXMzMik7CiAgICBmdW5jdGlvbiBUcmFuc2ZlckZ1bmRzKGFkZHJlc3MgdGFyZ2V0LCB1aW50MjU2IHRyYW5zZmVyX2Ftb3VudCkgcHVibGljOwp9Cgpjb250cmFjdCBBYnN0cmFjdEdhbWVIaWRkZW4KewogICAgZnVuY3Rpb24gQ2FsY3VsYXRlRmluYWxEaXN0YW5jZShieXRlczMyIHJhdzAsIGJ5dGVzMzIgcmF3MSwgYnl0ZXMzMiByYXcyLCBieXRlczMyIHJhdzMpIHB1cmUgcHVibGljIHJldHVybnMgKGludDY0LCBpbnQ2NCwgdWludDY0KTsKfQoKbGlicmFyeSBDb21wZXRpdGlvblNjb3JlVHlwZXMKewogICAgdXNpbmcgU2VyaWFsaXplciBmb3IgU2VyaWFsaXplci5EYXRhQ29tcG9uZW50OwoKICAgIHN0cnVjdCBDb21wZXRpdGlvblNjb3JlCiAgICB7CiAgICAgICAgYWRkcmVzcyBtX093bmVyOyAvLyAwCiAgICAgICAgdWludDY0IG1fRGlzdGFuY2U7IC8vIDIwCiAgICAgICAgdWludDMyIG1fUm9ja2V0SWQ7IC8vIDI4CiAgICB9CgogICAgZnVuY3Rpb24gU2VyaWFsaXplQ29tcGV0aXRpb25TY29yZShDb21wZXRpdGlvblNjb3JlIHNjb3JlKSBpbnRlcm5hbCBwdXJlIHJldHVybnMgKGJ5dGVzMzIpCiAgICB7CiAgICAgICAgU2VyaWFsaXplci5EYXRhQ29tcG9uZW50IG1lbW9yeSBkYXRhOwogICAgICAgIGRhdGEuV3JpdGVBZGRyZXNzKDAsIHNjb3JlLm1fT3duZXIpOwogICAgICAgIGRhdGEuV3JpdGVVaW50NjQoMjAsIHNjb3JlLm1fRGlzdGFuY2UpOwogICAgICAgIGRhdGEuV3JpdGVVaW50MzIoMjgsIHNjb3JlLm1fUm9ja2V0SWQpOwogICAgICAgIHJldHVybiBkYXRhLm1fUmF3OwogICAgfQoKICAgIGZ1bmN0aW9uIERlc2VyaWFsaXplQ29tcGV0aXRpb25TY29yZShieXRlczMyIHJhdykgaW50ZXJuYWwgcHVyZSByZXR1cm5zIChDb21wZXRpdGlvblNjb3JlKQogICAgewogICAgICAgIENvbXBldGl0aW9uU2NvcmUgbWVtb3J5IHNjb3JlOwoKICAgICAgICBTZXJpYWxpemVyLkRhdGFDb21wb25lbnQgbWVtb3J5IGRhdGE7CiAgICAgICAgZGF0YS5tX1JhdyA9IHJhdzsKCiAgICAgICAgc2NvcmUubV9Pd25lciA9IGRhdGEuUmVhZEFkZHJlc3MoMCk7CiAgICAgICAgc2NvcmUubV9EaXN0YW5jZSA9IGRhdGEuUmVhZFVpbnQ2NCgyMCk7CiAgICAgICAgc2NvcmUubV9Sb2NrZXRJZCA9IGRhdGEuUmVhZFVpbnQzMigyOCk7CgogICAgICAgIHJldHVybiBzY29yZTsKICAgIH0KfQoKY29udHJhY3QgR2FtZQp7CiAgICB1c2luZyBHbG9iYWxUeXBlcyBmb3IgR2xvYmFsVHlwZXMuR2xvYmFsOwogICAgdXNpbmcgTWFya2V0VHlwZXMgZm9yIE1hcmtldFR5cGVzLk1hcmtldExpc3Rpbmc7CiAgICB1c2luZyBNaXNzaW9uUGFyYW1ldGVyc1R5cGVzIGZvciBNaXNzaW9uUGFyYW1ldGVyc1R5cGVzLk1pc3Npb25QYXJhbWV0ZXJzOwogICAgdXNpbmcgR2FtZUNvbW1vbiBmb3IgR2FtZUNvbW1vbi5MYXVuY2hSb2NrZXRTdGFja0ZyYW1lOwoKICAgIGFkZHJlc3MgcHVibGljIG1fT3duZXI7CiAgICBBYnN0cmFjdERhdGFiYXNlIHB1YmxpYyBtX0RhdGFiYXNlOwogICAgQWJzdHJhY3RHYW1lSGlkZGVuIHB1YmxpYyBtX0dhbWVIaWRkZW47CiAgICBib29sIHB1YmxpYyBtX1BhdXNlZDsKCiAgICB1aW50MjU2IGNvbnN0YW50IEdsb2JhbENhdGVnb3J5ID0gMDsKICAgIHVpbnQyNTYgY29uc3RhbnQgUm9ja2V0Q2F0ZWdvcnkgPSAxOwogICAgdWludDI1NiBjb25zdGFudCBPd25lcnNoaXBDYXRlZ29yeSA9IDI7CiAgICB1aW50MjU2IGNvbnN0YW50IEludmVudG9yeUNhdGVnb3J5ID0gMzsKICAgIHVpbnQyNTYgY29uc3RhbnQgTWFya2V0Q2F0ZWdvcnkgPSA0OwogICAgdWludDI1NiBjb25zdGFudCBQcm9maXRGdW5kc0NhdGVnb3J5ID0gNTsKICAgIHVpbnQyNTYgY29uc3RhbnQgQ29tcGV0aXRpb25GdW5kc0NhdGVnb3J5ID0gNjsKICAgIHVpbnQyNTYgY29uc3RhbnQgTWlzc2lvblBhcmFtZXRlcnNDYXRlZ29yeSA9IDc7CiAgICB1aW50MjU2IGNvbnN0YW50IENvbXBldGl0aW9uU2NvcmVzQ2F0ZWdvcnkgPSA4OwogICAgdWludDI1NiBjb25zdGFudCBXaXRoZHJhd2FsRnVuZHNDYXRlZ29yeSA9IDk7CiAgICB1aW50MjU2IGNvbnN0YW50IFJlZmVycmFsQ2F0ZWdvcnkgPSAxMDsKICAgIHVpbnQyNTYgY29uc3RhbnQgUm9ja2V0U3RvY2tDYXRlZ29yeSA9IDExOwogICAgdWludDI1NiBjb25zdGFudCBSb2NrZXRTdG9ja0luaXRpYWxpemVkQ2F0ZWdvcnkgPSAxMjsKCiAgICBhZGRyZXNzIGNvbnN0YW50IE51bGxBZGRyZXNzID0gMDsKICAgIHVpbnQyNTYgY29uc3RhbnQgTWF4Q29tcGV0aXRpb25TY29yZXMgPSAxMDsKCiAgICBtYXBwaW5nKHVpbnQzMiA9PiBSb2NrZXRUeXBlcy5TdG9ja1JvY2tldCkgbV9Jbml0aWFsUm9ja2V0czsKCiAgICBtb2RpZmllciBPbmx5T3duZXIoKQogICAgewogICAgICAgIHJlcXVpcmUobXNnLnNlbmRlciA9PSBtX093bmVyKTsKCiAgICAgICAgXzsKICAgIH0KCiAgICBtb2RpZmllciBOb3RXaGlsZVBhdXNlZCgpCiAgICB7CiAgICAgICAgcmVxdWlyZShtX1BhdXNlZCA9PSBmYWxzZSk7CgogICAgICAgIF87CiAgICB9CgogICAgZnVuY3Rpb24gR2FtZSgpIHB1YmxpYwogICAgewogICAgICAgIG1fT3duZXIgPSBtc2cuc2VuZGVyOwogICAgICAgIG1fUGF1c2VkID0gdHJ1ZTsKICAgIH0KCiAgICBldmVudCBCdXlTdG9ja1JvY2tldEV2ZW50KGFkZHJlc3MgaW5kZXhlZCBidXllciwgdWludDMyIHN0b2NrX2lkLCB1aW50MzIgcm9ja2V0X2lkLCBhZGRyZXNzIHJlZmVycmVyKTsKICAgIGV2ZW50IFBsYWNlUm9ja2V0Rm9yU2FsZUV2ZW50KGFkZHJlc3MgaW5kZXhlZCBzZWxsZXIsIHVpbnQzMiByb2NrZXRfaWQsIHVpbnQ4MCBwcmljZSk7CiAgICBldmVudCBSZW1vdmVSb2NrZXRGb3JTYWxlRXZlbnQoYWRkcmVzcyBpbmRleGVkIHNlbGxlciwgdWludDMyIHJvY2tldF9pZCk7CiAgICBldmVudCBCdXlSb2NrZXRGb3JTYWxlRXZlbnQoYWRkcmVzcyBpbmRleGVkIGJ1eWVyLCBhZGRyZXNzIGluZGV4ZWQgc2VsbGVyLCB1aW50MzIgcm9ja2V0X2lkKTsKICAgIGV2ZW50IExhdW5jaFJvY2tldEV2ZW50KGFkZHJlc3MgaW5kZXhlZCBsYXVuY2hlciwgdWludDMyIGNvbXBldGl0aW9uX2lkLCBpbnQ2NCBsZW9fZGlzcGxhY2VtZW50LCBpbnQ2NCBwbGFuZXRfZGlzcGxhY2VtZW50KTsKICAgIGV2ZW50IFN0YXJ0Q29tcGV0aXRpb25FdmVudCh1aW50MzIgY29tcGV0aXRpb25faWQpOwogICAgZXZlbnQgRmluaXNoQ29tcGV0aXRpb25FdmVudCh1aW50MzIgY29tcGV0aXRpb25faWQpOwoKICAgIGZ1bmN0aW9uIENoYW5nZU93bmVyKGFkZHJlc3MgbmV3X293bmVyKSBwdWJsaWMgT25seU93bmVyKCkKICAgIHsKICAgICAgICBtX093bmVyID0gbmV3X293bmVyOwogICAgfQoKICAgIGZ1bmN0aW9uIENoYW5nZURhdGFiYXNlKGFkZHJlc3MgZGIpIHB1YmxpYyBPbmx5T3duZXIoKQogICAgewogICAgICAgIG1fRGF0YWJhc2UgPSBBYnN0cmFjdERhdGFiYXNlKGRiKTsKICAgIH0KCiAgICBmdW5jdGlvbiBDaGFuZ2VHYW1lSGlkZGVuKGFkZHJlc3MgaGlkZGVuKSBwdWJsaWMgT25seU93bmVyKCkKICAgIHsKICAgICAgICBtX0dhbWVIaWRkZW4gPSBBYnN0cmFjdEdhbWVIaWRkZW4oaGlkZGVuKTsKICAgIH0KCiAgICBmdW5jdGlvbiBVbnBhdXNlKCkgcHVibGljIE9ubHlPd25lcigpCiAgICB7CiAgICAgICAgbV9QYXVzZWQgPSBmYWxzZTsKICAgIH0KCiAgICBmdW5jdGlvbiBQYXVzZSgpIHB1YmxpYyBPbmx5T3duZXIoKQogICAgewogICAgICAgIHJlcXVpcmUobV9QYXVzZWQgPT0gZmFsc2UpOwoKICAgICAgICBtX1BhdXNlZCA9IHRydWU7CiAgICB9CgogICAgZnVuY3Rpb24gSXNQYXVzZWQoKSBwdWJsaWMgdmlldyByZXR1cm5zIChib29sKQogICAgewogICAgICAgIHJldHVybiBtX1BhdXNlZDsKICAgIH0KCiAgICAvLyAxIHdyaXRlCiAgICBmdW5jdGlvbiBXaXRoZHJhd1Byb2ZpdEZ1bmRzKHVpbnQyNTYgd2l0aGRyYXdfYW1vdW50LCBhZGRyZXNzIGJlbmVmaWNpYXJ5KSBwdWJsaWMgTm90V2hpbGVQYXVzZWQoKSBPbmx5T3duZXIoKQogICAgewogICAgICAgIHVpbnQyNTYgcHJvZml0X2Z1bmRzID0gdWludDI1NihtX0RhdGFiYXNlLkxvYWQoTnVsbEFkZHJlc3MsIFByb2ZpdEZ1bmRzQ2F0ZWdvcnksIDApKTsKCiAgICAgICAgcmVxdWlyZSh3aXRoZHJhd19hbW91bnQgPiAwKTsKICAgICAgICByZXF1aXJlKHdpdGhkcmF3X2Ftb3VudCA8PSBwcm9maXRfZnVuZHMpOwogICAgICAgIHJlcXVpcmUoYmVuZWZpY2lhcnkgIT0gYWRkcmVzcygwKSk7CiAgICAgICAgcmVxdWlyZShiZW5lZmljaWFyeSAhPSBhZGRyZXNzKHRoaXMpKTsKICAgICAgICByZXF1aXJlKGJlbmVmaWNpYXJ5ICE9IGFkZHJlc3MobV9EYXRhYmFzZSkpOwoKICAgICAgICBwcm9maXRfZnVuZHMgLT0gd2l0aGRyYXdfYW1vdW50OwoKICAgICAgICBtX0RhdGFiYXNlLlN0b3JlKE51bGxBZGRyZXNzLCBQcm9maXRGdW5kc0NhdGVnb3J5LCAwLCBieXRlczMyKHByb2ZpdF9mdW5kcykpOwoKICAgICAgICBtX0RhdGFiYXNlLlRyYW5zZmVyRnVuZHMoYmVuZWZpY2lhcnksIHdpdGhkcmF3X2Ftb3VudCk7CiAgICB9CgogICAgLy8gMSB3cml0ZQogICAgZnVuY3Rpb24gV2l0aGRyYXdXaW5uaW5ncyh1aW50MjU2IHdpdGhkcmF3X2Ftb3VudCkgcHVibGljIE5vdFdoaWxlUGF1c2VkKCkKICAgIHsKICAgICAgICByZXF1aXJlKHdpdGhkcmF3X2Ftb3VudCA+IDApOwoKICAgICAgICB1aW50MjU2IHdpdGhkcmF3YWxfZnVuZHMgPSB1aW50MjU2KG1fRGF0YWJhc2UuTG9hZChtc2cuc2VuZGVyLCBXaXRoZHJhd2FsRnVuZHNDYXRlZ29yeSwgMCkpOwogICAgICAgIHJlcXVpcmUod2l0aGRyYXdfYW1vdW50IDw9IHdpdGhkcmF3YWxfZnVuZHMpOwoKICAgICAgICB3aXRoZHJhd2FsX2Z1bmRzIC09IHdpdGhkcmF3X2Ftb3VudDsKCiAgICAgICAgbV9EYXRhYmFzZS5TdG9yZShtc2cuc2VuZGVyLCBXaXRoZHJhd2FsRnVuZHNDYXRlZ29yeSwgMCwgYnl0ZXMzMih3aXRoZHJhd2FsX2Z1bmRzKSk7CgogICAgICAgIG1fRGF0YWJhc2UuVHJhbnNmZXJGdW5kcyhtc2cuc2VuZGVyLCB3aXRoZHJhd19hbW91bnQpOwogICAgfQoKICAgIGZ1bmN0aW9uIEdldFJvY2tldCh1aW50MzIgcm9ja2V0X2lkKSB2aWV3IHB1YmxpYyByZXR1cm5zIChib29sIGlzX3ZhbGlkLCB1aW50MzIgdG9wX3NwZWVkLCB1aW50MzIgdGhydXN0LCB1aW50MzIgd2VpZ2h0LCB1aW50MzIgZnVlbF9jYXBhY2l0eSwgdWludDE2IHN0b2NrX2lkLCB1aW50NjQgbWF4X2Rpc3RhbmNlLCBib29sIGlzX2Zvcl9zYWxlLCBhZGRyZXNzIG93bmVyKQogICAgewogICAgICAgIFJvY2tldFR5cGVzLlJvY2tldCBtZW1vcnkgcm9ja2V0ID0gUm9ja2V0VHlwZXMuRGVzZXJpYWxpemVSb2NrZXQobV9EYXRhYmFzZS5Mb2FkKE51bGxBZGRyZXNzLCBSb2NrZXRDYXRlZ29yeSwgcm9ja2V0X2lkKSk7CgogICAgICAgIGlzX3ZhbGlkID0gcm9ja2V0Lm1fVmVyc2lvbiA+PSAxOwogICAgICAgIGlzX2Zvcl9zYWxlID0gcm9ja2V0Lm1fSXNGb3JTYWxlID09IDE7CiAgICAgICAgdG9wX3NwZWVkID0gcm9ja2V0Lm1fVG9wU3BlZWQ7CiAgICAgICAgdGhydXN0ID0gcm9ja2V0Lm1fVGhydXN0OwogICAgICAgIHdlaWdodCA9IHJvY2tldC5tX1dlaWdodDsKICAgICAgICBmdWVsX2NhcGFjaXR5ID0gcm9ja2V0Lm1fRnVlbENhcGFjaXR5OwogICAgICAgIHN0b2NrX2lkID0gcm9ja2V0Lm1fU3RvY2tJZDsKICAgICAgICBtYXhfZGlzdGFuY2UgPSByb2NrZXQubV9NYXhEaXN0YW5jZTsKCiAgICAgICAgb3duZXIgPSBHZXRSb2NrZXRPd25lcihyb2NrZXRfaWQpOwogICAgfQoKICAgIGZ1bmN0aW9uIEdldFdpdGhkcmF3YWxGdW5kcyhhZGRyZXNzIHRhcmdldCkgdmlldyBwdWJsaWMgTm90V2hpbGVQYXVzZWQoKSByZXR1cm5zICh1aW50MjU2IGZ1bmRzKQogICAgewogICAgICAgIGZ1bmRzID0gdWludDI1NihtX0RhdGFiYXNlLkxvYWQodGFyZ2V0LCBXaXRoZHJhd2FsRnVuZHNDYXRlZ29yeSwgMCkpOwogICAgfQoKICAgIGZ1bmN0aW9uIEdldFByb2ZpdEZ1bmRzKCkgdmlldyBwdWJsaWMgT25seU93bmVyKCkgcmV0dXJucyAodWludDI1NiBmdW5kcykKICAgIHsKICAgICAgICB1aW50MjU2IHByb2ZpdF9mdW5kcyA9IHVpbnQyNTYobV9EYXRhYmFzZS5Mb2FkKE51bGxBZGRyZXNzLCBQcm9maXRGdW5kc0NhdGVnb3J5LCAwKSk7CiAgICAgICAgcmV0dXJuIHByb2ZpdF9mdW5kczsKICAgIH0KCiAgICBmdW5jdGlvbiBHZXRDb21wZXRpdGlvbkZ1bmRzKHVpbnQzMiBjb21wZXRpdGlvbl9pZCkgdmlldyBwdWJsaWMgcmV0dXJucyAodWludDI1NiBmdW5kcykKICAgIHsKICAgICAgICByZXR1cm4gdWludDI1NihtX0RhdGFiYXNlLkxvYWQoTnVsbEFkZHJlc3MsIENvbXBldGl0aW9uRnVuZHNDYXRlZ29yeSwgY29tcGV0aXRpb25faWQpKTsKICAgIH0KCiAgICBmdW5jdGlvbiBHZXRSb2NrZXRPd25lcih1aW50MzIgcm9ja2V0X2lkKSB2aWV3IGludGVybmFsIHJldHVybnMgKGFkZHJlc3Mgb3duZXIpCiAgICB7CiAgICAgICAgT3duZXJzaGlwVHlwZXMuT3duZXJzaGlwIG1lbW9yeSBvd25lcnNoaXAgPSBPd25lcnNoaXBUeXBlcy5EZXNlcmlhbGl6ZU93bmVyc2hpcChtX0RhdGFiYXNlLkxvYWQoTnVsbEFkZHJlc3MsIE93bmVyc2hpcENhdGVnb3J5LCByb2NrZXRfaWQpKTsKICAgICAgICBvd25lciA9IG93bmVyc2hpcC5tX093bmVyOwogICAgfQoKICAgIGZ1bmN0aW9uIEdldEF1Y3Rpb24odWludDMyIHJvY2tldF9pZCkgdmlldyBwdWJsaWMgcmV0dXJucyAoYm9vbCBpc19mb3Jfc2FsZSwgYWRkcmVzcyBvd25lciwgdWludDgwIHByaWNlKQogICAgewogICAgICAgIFJvY2tldFR5cGVzLlJvY2tldCBtZW1vcnkgcm9ja2V0ID0gUm9ja2V0VHlwZXMuRGVzZXJpYWxpemVSb2NrZXQobV9EYXRhYmFzZS5Mb2FkKE51bGxBZGRyZXNzLCBSb2NrZXRDYXRlZ29yeSwgcm9ja2V0X2lkKSk7CiAgICAgICAgaXNfZm9yX3NhbGUgPSByb2NrZXQubV9Jc0ZvclNhbGUgPT0gMTsKCiAgICAgICAgT3duZXJzaGlwVHlwZXMuT3duZXJzaGlwIG1lbW9yeSBvd25lcnNoaXAgPSBPd25lcnNoaXBUeXBlcy5EZXNlcmlhbGl6ZU93bmVyc2hpcChtX0RhdGFiYXNlLkxvYWQoTnVsbEFkZHJlc3MsIE93bmVyc2hpcENhdGVnb3J5LCByb2NrZXRfaWQpKTsKICAgICAgICBvd25lciA9IG93bmVyc2hpcC5tX093bmVyOwoKICAgICAgICBNYXJrZXRUeXBlcy5NYXJrZXRMaXN0aW5nIG1lbW9yeSBsaXN0aW5nID0gTWFya2V0VHlwZXMuRGVzZXJpYWxpemVNYXJrZXRMaXN0aW5nKG1fRGF0YWJhc2UuTG9hZChOdWxsQWRkcmVzcywgTWFya2V0Q2F0ZWdvcnksIHJvY2tldF9pZCkpOwogICAgICAgIHByaWNlID0gbGlzdGluZy5tX1ByaWNlOwogICAgfQoKICAgIGZ1bmN0aW9uIEdldEludmVudG9yeUNvdW50KGFkZHJlc3MgdGFyZ2V0KSB2aWV3IHB1YmxpYyByZXR1cm5zICh1aW50MjU2KQogICAgewogICAgICAgIHJlcXVpcmUodGFyZ2V0ICE9IGFkZHJlc3MoMCkpOwoKICAgICAgICB1aW50MjU2IGludmVudG9yeV9jb3VudCA9IHVpbnQyNTYobV9EYXRhYmFzZS5Mb2FkKHRhcmdldCwgSW52ZW50b3J5Q2F0ZWdvcnksIDApKTsKCiAgICAgICAgcmV0dXJuIGludmVudG9yeV9jb3VudDsKICAgIH0KCiAgICBmdW5jdGlvbiBHZXRJbnZlbnRvcnkoYWRkcmVzcyB0YXJnZXQsIHVpbnQyNTYgc3RhcnRfaW5kZXgpIHZpZXcgcHVibGljIHJldHVybnMgKHVpbnQzMls4XSByb2NrZXRfaWRzKQogICAgewogICAgICAgIHJlcXVpcmUodGFyZ2V0ICE9IGFkZHJlc3MoMCkpOwoKICAgICAgICB1aW50MjU2IGludmVudG9yeV9jb3VudCA9IEdldEludmVudG9yeUNvdW50KHRhcmdldCk7CgogICAgICAgIHVpbnQyNTYgZW5kID0gc3RhcnRfaW5kZXggKyA4OwogICAgICAgIGlmIChlbmQgPiBpbnZlbnRvcnlfY291bnQpCiAgICAgICAgICAgIGVuZCA9IGludmVudG9yeV9jb3VudDsKCiAgICAgICAgZm9yICh1aW50MjU2IGkgPSBzdGFydF9pbmRleDsgaSA8IGVuZDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgcm9ja2V0X2lkc1tpIC0gc3RhcnRfaW5kZXhdID0gdWludDMyKHVpbnQyNTYobV9EYXRhYmFzZS5Mb2FkKHRhcmdldCwgSW52ZW50b3J5Q2F0ZWdvcnksIGkgKyAxKSkpOwogICAgICAgIH0KICAgIH0KCiAgICAvLyAxIHdyaXRlCiAgICBmdW5jdGlvbiBBZGRSb2NrZXQodWludDMyIHN0b2NrX2lkLCB1aW50NjQgY29zdCwgdWludDMyIG1pbl90b3Bfc3BlZWQsIHVpbnQzMiBtYXhfdG9wX3NwZWVkLCB1aW50MzIgbWluX3RocnVzdCwgdWludDMyIG1heF90aHJ1c3QsIHVpbnQzMiBtaW5fd2VpZ2h0LCB1aW50MzIgbWF4X3dlaWdodCwgdWludDMyIG1pbl9mdWVsX2NhcGFjaXR5LCB1aW50MzIgbWF4X2Z1ZWxfY2FwYWNpdHksIHVpbnQ2NCBkaXN0YW5jZSwgdWludDMyIG1heF9zdG9jaykgT25seU93bmVyKCkgcHVibGljCiAgICB7CiAgICAgICAgbV9Jbml0aWFsUm9ja2V0c1tzdG9ja19pZF0gPSBSb2NrZXRUeXBlcy5TdG9ja1JvY2tldCh7CiAgICAgICAgICAgIG1fSXNWYWxpZDogdHJ1ZSwKICAgICAgICAgICAgbV9Db3N0OiBjb3N0LAogICAgICAgICAgICBtX01pblRvcFNwZWVkOiBtaW5fdG9wX3NwZWVkLAogICAgICAgICAgICBtX01heFRvcFNwZWVkOiBtYXhfdG9wX3NwZWVkLAogICAgICAgICAgICBtX01pblRocnVzdDogbWluX3RocnVzdCwKICAgICAgICAgICAgbV9NYXhUaHJ1c3Q6IG1heF90aHJ1c3QsCiAgICAgICAgICAgIG1fTWluV2VpZ2h0OiBtaW5fd2VpZ2h0LAogICAgICAgICAgICBtX01heFdlaWdodDogbWF4X3dlaWdodCwKICAgICAgICAgICAgbV9NaW5GdWVsQ2FwYWNpdHk6IG1pbl9mdWVsX2NhcGFjaXR5LAogICAgICAgICAgICBtX01heEZ1ZWxDYXBhY2l0eTogbWF4X2Z1ZWxfY2FwYWNpdHksCiAgICAgICAgICAgIG1fRGlzdGFuY2U6IGRpc3RhbmNlCiAgICAgICAgfSk7CgogICAgICAgIG1pbl90b3Bfc3BlZWQgPSB1aW50MzIobV9EYXRhYmFzZS5Mb2FkKE51bGxBZGRyZXNzLCBSb2NrZXRTdG9ja0luaXRpYWxpemVkQ2F0ZWdvcnksIHN0b2NrX2lkKSk7CgogICAgICAgIGlmIChtaW5fdG9wX3NwZWVkID09IDApCiAgICAgICAgewogICAgICAgICAgICBtX0RhdGFiYXNlLlN0b3JlKE51bGxBZGRyZXNzLCBSb2NrZXRTdG9ja0NhdGVnb3J5LCBzdG9ja19pZCwgYnl0ZXMzMihtYXhfc3RvY2spKTsKICAgICAgICAgICAgbV9EYXRhYmFzZS5TdG9yZShOdWxsQWRkcmVzcywgUm9ja2V0U3RvY2tJbml0aWFsaXplZENhdGVnb3J5LCBzdG9ja19pZCwgYnl0ZXMzMigxKSk7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIEdldFJvY2tldFN0b2NrKHVpbnQxNiBzdG9ja19pZCkgcHVibGljIHZpZXcgcmV0dXJucyAodWludDMyKQogICAgewogICAgICAgIHJldHVybiB1aW50MzIobV9EYXRhYmFzZS5Mb2FkKE51bGxBZGRyZXNzLCBSb2NrZXRTdG9ja0NhdGVnb3J5LCBzdG9ja19pZCkpOwogICAgfQoKICAgIC8vIDYgd3JpdGVzCiAgICBmdW5jdGlvbiBCdXlTdG9ja1JvY2tldCh1aW50MTYgc3RvY2tfaWQsIGFkZHJlc3MgcmVmZXJyZXIpIHBheWFibGUgTm90V2hpbGVQYXVzZWQoKSBwdWJsaWMKICAgIHsKICAgICAgICAvL3JlcXVpcmUocmVmZXJyZXIgIT0gbXNnLnNlbmRlcik7CiAgICAgICAgdWludDMyIHN0b2NrID0gR2V0Um9ja2V0U3RvY2soc3RvY2tfaWQpOwoKICAgICAgICByZXF1aXJlKHN0b2NrID4gMCk7CgogICAgICAgIEdpdmVSb2NrZXRJbnRlcm5hbChzdG9ja19pZCwgbXNnLnNlbmRlciwgdHJ1ZSwgcmVmZXJyZXIpOwoKICAgICAgICBzdG9jay0tOwoKICAgICAgICBtX0RhdGFiYXNlLlN0b3JlKE51bGxBZGRyZXNzLCBSb2NrZXRTdG9ja0NhdGVnb3J5LCBzdG9ja19pZCwgYnl0ZXMzMihzdG9jaykpOwogICAgfQoKICAgIGZ1bmN0aW9uIEdpdmVSZWZlcnJhbFJvY2tldCh1aW50MTYgc3RvY2tfaWQsIGFkZHJlc3MgdGFyZ2V0KSBwdWJsaWMgTm90V2hpbGVQYXVzZWQoKSBPbmx5T3duZXIoKQogICAgewogICAgICAgIHVpbnQyNTYgYWxyZWFkeV9yZWNlaXZlZCA9IHVpbnQyNTYobV9EYXRhYmFzZS5Mb2FkKHRhcmdldCwgUmVmZXJyYWxDYXRlZ29yeSwgMCkpOwogICAgICAgIHJlcXVpcmUoYWxyZWFkeV9yZWNlaXZlZCA9PSAwKTsKCiAgICAgICAgYWxyZWFkeV9yZWNlaXZlZCA9IDE7CiAgICAgICAgbV9EYXRhYmFzZS5TdG9yZSh0YXJnZXQsIFJlZmVycmFsQ2F0ZWdvcnksIDAsIGJ5dGVzMzIoYWxyZWFkeV9yZWNlaXZlZCkpOwoKICAgICAgICBHaXZlUm9ja2V0SW50ZXJuYWwoc3RvY2tfaWQsIHRhcmdldCwgZmFsc2UsIGFkZHJlc3MoMCkpOwogICAgfQoKICAgIGZ1bmN0aW9uIEdpdmVSb2NrZXRJbnRlcm5hbCh1aW50MTYgc3RvY2tfaWQsIGFkZHJlc3MgdGFyZ2V0LCBib29sIGJ1eWluZywgYWRkcmVzcyByZWZlcnJlcikgaW50ZXJuYWwKICAgIHsKICAgICAgICBSb2NrZXRUeXBlcy5TdG9ja1JvY2tldCBzdG9yYWdlIHN0b2NrX3JvY2tldCA9IG1fSW5pdGlhbFJvY2tldHNbc3RvY2tfaWRdOwoKICAgICAgICByZXF1aXJlKHN0b2NrX3JvY2tldC5tX0lzVmFsaWQpOwogICAgICAgIGlmIChidXlpbmcpCiAgICAgICAgewogICAgICAgICAgICByZXF1aXJlKG1zZy52YWx1ZSA9PSBzdG9ja19yb2NrZXQubV9Db3N0KTsKICAgICAgICB9CgogICAgICAgIEdsb2JhbFR5cGVzLkdsb2JhbCBtZW1vcnkgZ2xvYmFsID0gR2xvYmFsVHlwZXMuRGVzZXJpYWxpemVHbG9iYWwobV9EYXRhYmFzZS5Mb2FkKE51bGxBZGRyZXNzLCBHbG9iYWxDYXRlZ29yeSwgMCkpOwoKICAgICAgICB1aW50MjU2IHByb2ZpdF9mdW5kcyA9IHVpbnQyNTYobV9EYXRhYmFzZS5Mb2FkKE51bGxBZGRyZXNzLCBQcm9maXRGdW5kc0NhdGVnb3J5LCAwKSk7CgogICAgICAgIGdsb2JhbC5tX0xhc3RSb2NrZXRJZCsrOwogICAgICAgIHVpbnQzMiBuZXh0X3JvY2tldF9pZCA9IGdsb2JhbC5tX0xhc3RSb2NrZXRJZDsKCiAgICAgICAgdWludDI1NiBpbnZlbnRvcnlfY291bnQgPSBHZXRJbnZlbnRvcnlDb3VudCh0YXJnZXQpOwogICAgICAgIGludmVudG9yeV9jb3VudCsrOwoKICAgICAgICBSb2NrZXRUeXBlcy5Sb2NrZXQgbWVtb3J5IHJvY2tldDsKICAgICAgICByb2NrZXQubV9WZXJzaW9uID0gMTsKICAgICAgICByb2NrZXQubV9TdG9ja0lkID0gc3RvY2tfaWQ7CiAgICAgICAgcm9ja2V0Lm1fSXNGb3JTYWxlID0gMDsKCiAgICAgICAgYnl0ZXMzMiByYW5kID0gc2hhMjU2KGJsb2NrLnRpbWVzdGFtcCwgYmxvY2suY29pbmJhc2UsIGdsb2JhbC5tX0xhc3RSb2NrZXRJZCk7CgogICAgICAgIC8vIEZpeCBMZXJwRXh0cmEgY2FsbHMgaW4gRmluaXNoQ29tcGV0aXRpb24gaWYgYW55dGhpbmcgaXMgYWRkZWQgaGVyZQogICAgICAgIHJvY2tldC5tX1RvcFNwZWVkID0gdWludDMyKExlcnAoc3RvY2tfcm9ja2V0Lm1fTWluVG9wU3BlZWQsIHN0b2NrX3JvY2tldC5tX01heFRvcFNwZWVkLCByYW5kWzBdKSk7CiAgICAgICAgcm9ja2V0Lm1fVGhydXN0ID0gdWludDMyKExlcnAoc3RvY2tfcm9ja2V0Lm1fTWluVGhydXN0LCBzdG9ja19yb2NrZXQubV9NYXhUaHJ1c3QsIHJhbmRbMV0pKTsKICAgICAgICByb2NrZXQubV9XZWlnaHQgPSB1aW50MzIoTGVycChzdG9ja19yb2NrZXQubV9NaW5XZWlnaHQsIHN0b2NrX3JvY2tldC5tX01heFdlaWdodCwgcmFuZFsyXSkpOwogICAgICAgIHJvY2tldC5tX0Z1ZWxDYXBhY2l0eSA9IHVpbnQzMihMZXJwKHN0b2NrX3JvY2tldC5tX01pbkZ1ZWxDYXBhY2l0eSwgc3RvY2tfcm9ja2V0Lm1fTWF4RnVlbENhcGFjaXR5LCByYW5kWzNdKSk7CiAgICAgICAgcm9ja2V0Lm1fTWF4RGlzdGFuY2UgPSB1aW50NjQoc3RvY2tfcm9ja2V0Lm1fRGlzdGFuY2UpOwogICAgICAgIC8vCgogICAgICAgIE93bmVyc2hpcFR5cGVzLk93bmVyc2hpcCBtZW1vcnkgb3duZXJzaGlwOwogICAgICAgIG93bmVyc2hpcC5tX093bmVyID0gdGFyZ2V0OwogICAgICAgIG93bmVyc2hpcC5tX093bmVySW52ZW50b3J5SW5kZXggPSB1aW50MzIoaW52ZW50b3J5X2NvdW50KSAtIDE7CgogICAgICAgIHByb2ZpdF9mdW5kcyArPSBtc2cudmFsdWU7CgogICAgICAgIG1fRGF0YWJhc2UuU3RvcmUodGFyZ2V0LCBJbnZlbnRvcnlDYXRlZ29yeSwgaW52ZW50b3J5X2NvdW50LCBieXRlczMyKG5leHRfcm9ja2V0X2lkKSk7CiAgICAgICAgbV9EYXRhYmFzZS5TdG9yZSh0YXJnZXQsIEludmVudG9yeUNhdGVnb3J5LCAwLCBieXRlczMyKGludmVudG9yeV9jb3VudCkpOwogICAgICAgIG1fRGF0YWJhc2UuU3RvcmUoTnVsbEFkZHJlc3MsIFJvY2tldENhdGVnb3J5LCBuZXh0X3JvY2tldF9pZCwgUm9ja2V0VHlwZXMuU2VyaWFsaXplUm9ja2V0KHJvY2tldCkpOwogICAgICAgIG1fRGF0YWJhc2UuU3RvcmUoTnVsbEFkZHJlc3MsIE93bmVyc2hpcENhdGVnb3J5LCBuZXh0X3JvY2tldF9pZCwgT3duZXJzaGlwVHlwZXMuU2VyaWFsaXplT3duZXJzaGlwKG93bmVyc2hpcCkpOwogICAgICAgIG1fRGF0YWJhc2UuU3RvcmUoTnVsbEFkZHJlc3MsIEdsb2JhbENhdGVnb3J5LCAwLCBHbG9iYWxUeXBlcy5TZXJpYWxpemVHbG9iYWwoZ2xvYmFsKSk7CiAgICAgICAgaWYgKGJ1eWluZykKICAgICAgICB7CiAgICAgICAgICAgIG1fRGF0YWJhc2UuU3RvcmUoTnVsbEFkZHJlc3MsIFByb2ZpdEZ1bmRzQ2F0ZWdvcnksIDAsIGJ5dGVzMzIocHJvZml0X2Z1bmRzKSk7CgogICAgICAgICAgICBtX0RhdGFiYXNlLnRyYW5zZmVyKG1zZy52YWx1ZSk7CiAgICAgICAgfQogICAgICAgIEJ1eVN0b2NrUm9ja2V0RXZlbnQodGFyZ2V0LCBzdG9ja19pZCwgbmV4dF9yb2NrZXRfaWQsIHJlZmVycmVyKTsKICAgIH0KCiAgICAvLyAyIHdyaXRlcwogICAgZnVuY3Rpb24gUGxhY2VSb2NrZXRGb3JTYWxlKHVpbnQzMiByb2NrZXRfaWQsIHVpbnQ4MCBwcmljZSkgTm90V2hpbGVQYXVzZWQoKSBwdWJsaWMKICAgIHsKICAgICAgICBSb2NrZXRUeXBlcy5Sb2NrZXQgbWVtb3J5IHJvY2tldCA9IFJvY2tldFR5cGVzLkRlc2VyaWFsaXplUm9ja2V0KG1fRGF0YWJhc2UuTG9hZChOdWxsQWRkcmVzcywgUm9ja2V0Q2F0ZWdvcnksIHJvY2tldF9pZCkpOwogICAgICAgIHJlcXVpcmUocm9ja2V0Lm1fVmVyc2lvbiA+IDApOwoKICAgICAgICBPd25lcnNoaXBUeXBlcy5Pd25lcnNoaXAgbWVtb3J5IG93bmVyc2hpcCA9IE93bmVyc2hpcFR5cGVzLkRlc2VyaWFsaXplT3duZXJzaGlwKG1fRGF0YWJhc2UuTG9hZChOdWxsQWRkcmVzcywgT3duZXJzaGlwQ2F0ZWdvcnksIHJvY2tldF9pZCkpOwogICAgICAgIHJlcXVpcmUob3duZXJzaGlwLm1fT3duZXIgPT0gbXNnLnNlbmRlcik7CgogICAgICAgIHJlcXVpcmUocm9ja2V0Lm1fSXNGb3JTYWxlID09IDApOwoKICAgICAgICBNYXJrZXRUeXBlcy5NYXJrZXRMaXN0aW5nIG1lbW9yeSBsaXN0aW5nOwogICAgICAgIGxpc3RpbmcubV9QcmljZSA9IHByaWNlOwoKICAgICAgICByb2NrZXQubV9Jc0ZvclNhbGUgPSAxOwoKICAgICAgICBtX0RhdGFiYXNlLlN0b3JlKE51bGxBZGRyZXNzLCBSb2NrZXRDYXRlZ29yeSwgcm9ja2V0X2lkLCBSb2NrZXRUeXBlcy5TZXJpYWxpemVSb2NrZXQocm9ja2V0KSk7CiAgICAgICAgbV9EYXRhYmFzZS5TdG9yZShOdWxsQWRkcmVzcywgTWFya2V0Q2F0ZWdvcnksIHJvY2tldF9pZCwgTWFya2V0VHlwZXMuU2VyaWFsaXplTWFya2V0TGlzdGluZyhsaXN0aW5nKSk7CgogICAgICAgIFBsYWNlUm9ja2V0Rm9yU2FsZUV2ZW50KG1zZy5zZW5kZXIsIHJvY2tldF9pZCwgcHJpY2UpOwogICAgfQoKICAgIC8vIDEgd3JpdGUKICAgIGZ1bmN0aW9uIFJlbW92ZVJvY2tldEZvclNhbGUodWludDMyIHJvY2tldF9pZCkgTm90V2hpbGVQYXVzZWQoKSBwdWJsaWMKICAgIHsKICAgICAgICBSb2NrZXRUeXBlcy5Sb2NrZXQgbWVtb3J5IHJvY2tldCA9IFJvY2tldFR5cGVzLkRlc2VyaWFsaXplUm9ja2V0KG1fRGF0YWJhc2UuTG9hZChOdWxsQWRkcmVzcywgUm9ja2V0Q2F0ZWdvcnksIHJvY2tldF9pZCkpOwogICAgICAgIHJlcXVpcmUocm9ja2V0Lm1fVmVyc2lvbiA+IDApOwogICAgICAgIHJlcXVpcmUocm9ja2V0Lm1fSXNGb3JTYWxlID09IDEpOwoKICAgICAgICBPd25lcnNoaXBUeXBlcy5Pd25lcnNoaXAgbWVtb3J5IG93bmVyc2hpcCA9IE93bmVyc2hpcFR5cGVzLkRlc2VyaWFsaXplT3duZXJzaGlwKG1fRGF0YWJhc2UuTG9hZChOdWxsQWRkcmVzcywgT3duZXJzaGlwQ2F0ZWdvcnksIHJvY2tldF9pZCkpOwogICAgICAgIHJlcXVpcmUob3duZXJzaGlwLm1fT3duZXIgPT0gbXNnLnNlbmRlcik7CgogICAgICAgIHJvY2tldC5tX0lzRm9yU2FsZSA9IDA7CgogICAgICAgIG1fRGF0YWJhc2UuU3RvcmUoTnVsbEFkZHJlc3MsIFJvY2tldENhdGVnb3J5LCByb2NrZXRfaWQsIFJvY2tldFR5cGVzLlNlcmlhbGl6ZVJvY2tldChyb2NrZXQpKTsKCiAgICAgICAgUmVtb3ZlUm9ja2V0Rm9yU2FsZUV2ZW50KG1zZy5zZW5kZXIsIHJvY2tldF9pZCk7CiAgICB9CgogICAgLy8gOS0xMSB3cml0ZXMKICAgIGZ1bmN0aW9uIEJ1eVJvY2tldEZvclNhbGUodWludDMyIHJvY2tldF9pZCkgcGF5YWJsZSBOb3RXaGlsZVBhdXNlZCgpIHB1YmxpYwogICAgewogICAgICAgIFJvY2tldFR5cGVzLlJvY2tldCBtZW1vcnkgcm9ja2V0ID0gUm9ja2V0VHlwZXMuRGVzZXJpYWxpemVSb2NrZXQobV9EYXRhYmFzZS5Mb2FkKE51bGxBZGRyZXNzLCBSb2NrZXRDYXRlZ29yeSwgcm9ja2V0X2lkKSk7CiAgICAgICAgcmVxdWlyZShyb2NrZXQubV9WZXJzaW9uID4gMCk7CgogICAgICAgIHJlcXVpcmUocm9ja2V0Lm1fSXNGb3JTYWxlID09IDEpOwoKICAgICAgICBPd25lcnNoaXBUeXBlcy5Pd25lcnNoaXAgbWVtb3J5IG93bmVyc2hpcCA9IE93bmVyc2hpcFR5cGVzLkRlc2VyaWFsaXplT3duZXJzaGlwKG1fRGF0YWJhc2UuTG9hZChOdWxsQWRkcmVzcywgT3duZXJzaGlwQ2F0ZWdvcnksIHJvY2tldF9pZCkpOwogICAgICAgIHJlcXVpcmUob3duZXJzaGlwLm1fT3duZXIgIT0gbXNnLnNlbmRlcik7CgogICAgICAgIE1hcmtldFR5cGVzLk1hcmtldExpc3RpbmcgbWVtb3J5IGxpc3RpbmcgPSBNYXJrZXRUeXBlcy5EZXNlcmlhbGl6ZU1hcmtldExpc3RpbmcobV9EYXRhYmFzZS5Mb2FkKE51bGxBZGRyZXNzLCBNYXJrZXRDYXRlZ29yeSwgcm9ja2V0X2lkKSk7CiAgICAgICAgcmVxdWlyZShtc2cudmFsdWUgPT0gbGlzdGluZy5tX1ByaWNlKTsKCiAgICAgICAgdWludDI1NiBzZWxsZXJfaW52ZW50b3J5X2NvdW50ID0gdWludDI1NihtX0RhdGFiYXNlLkxvYWQob3duZXJzaGlwLm1fT3duZXIsIEludmVudG9yeUNhdGVnb3J5LCAwKSk7CiAgICAgICAgdWludDI1NiBidXllcl9pbnZlbnRvcnlfY291bnQgPSB1aW50MjU2KG1fRGF0YWJhc2UuTG9hZChtc2cuc2VuZGVyLCBJbnZlbnRvcnlDYXRlZ29yeSwgMCkpOwoKICAgICAgICB1aW50MjU2IHByb2ZpdF9mdW5kc19vcl9sYXN0X3JvY2tldF9pZDsKICAgICAgICB1aW50MjU2IHdlaV9mb3JfcHJvZml0X2Z1bmRzOwogICAgICAgIHVpbnQyNTYgYnV5ZXJfcHJpY2Vfb3Jfd2VpX2Zvcl9zZWxsZXIgPSB1aW50MjU2KGxpc3RpbmcubV9QcmljZSk7CgogICAgICAgIGFkZHJlc3MgYmVuZWZpY2lhcnkgPSBvd25lcnNoaXAubV9Pd25lcjsKICAgICAgICBvd25lcnNoaXAubV9Pd25lciA9IG1zZy5zZW5kZXI7CiAgICAgICAgcm9ja2V0Lm1fSXNGb3JTYWxlID0gMDsKCiAgICAgICAgbGlzdGluZy5tX1ByaWNlID0gMDsKCiAgICAgICAgYnV5ZXJfaW52ZW50b3J5X2NvdW50Kys7CiAgICAgICAgcHJvZml0X2Z1bmRzX29yX2xhc3Rfcm9ja2V0X2lkID0gdWludDI1NihtX0RhdGFiYXNlLkxvYWQoYmVuZWZpY2lhcnksIEludmVudG9yeUNhdGVnb3J5LCBzZWxsZXJfaW52ZW50b3J5X2NvdW50KSk7CgogICAgICAgIG1fRGF0YWJhc2UuU3RvcmUoYmVuZWZpY2lhcnksIEludmVudG9yeUNhdGVnb3J5LCBzZWxsZXJfaW52ZW50b3J5X2NvdW50LCBieXRlczMyKDApKTsKCiAgICAgICAgaWYgKG93bmVyc2hpcC5tX093bmVySW52ZW50b3J5SW5kZXggKyAxICE9IHNlbGxlcl9pbnZlbnRvcnlfY291bnQpCiAgICAgICAgewogICAgICAgICAgICBtX0RhdGFiYXNlLlN0b3JlKGJlbmVmaWNpYXJ5LCBJbnZlbnRvcnlDYXRlZ29yeSwgb3duZXJzaGlwLm1fT3duZXJJbnZlbnRvcnlJbmRleCArIDEsIGJ5dGVzMzIocHJvZml0X2Z1bmRzX29yX2xhc3Rfcm9ja2V0X2lkKSk7CgogICAgICAgICAgICBPd25lcnNoaXBUeXBlcy5Pd25lcnNoaXAgbWVtb3J5IGxhc3Rfcm9ja2V0X293bmVyc2hpcCA9IE93bmVyc2hpcFR5cGVzLkRlc2VyaWFsaXplT3duZXJzaGlwKG1fRGF0YWJhc2UuTG9hZChOdWxsQWRkcmVzcywgT3duZXJzaGlwQ2F0ZWdvcnksIHByb2ZpdF9mdW5kc19vcl9sYXN0X3JvY2tldF9pZCkpOwogICAgICAgICAgICBsYXN0X3JvY2tldF9vd25lcnNoaXAubV9Pd25lckludmVudG9yeUluZGV4ID0gdWludDMyKG93bmVyc2hpcC5tX093bmVySW52ZW50b3J5SW5kZXgpOwoKICAgICAgICAgICAgbV9EYXRhYmFzZS5TdG9yZShOdWxsQWRkcmVzcywgT3duZXJzaGlwQ2F0ZWdvcnksIHByb2ZpdF9mdW5kc19vcl9sYXN0X3JvY2tldF9pZCwgT3duZXJzaGlwVHlwZXMuU2VyaWFsaXplT3duZXJzaGlwKGxhc3Rfcm9ja2V0X293bmVyc2hpcCkpOwogICAgICAgIH0KCiAgICAgICAgb3duZXJzaGlwLm1fT3duZXJJbnZlbnRvcnlJbmRleCA9IHVpbnQzMihidXllcl9pbnZlbnRvcnlfY291bnQpOwogICAgICAgIG1fRGF0YWJhc2UuU3RvcmUobXNnLnNlbmRlciwgSW52ZW50b3J5Q2F0ZWdvcnksIGJ1eWVyX2ludmVudG9yeV9jb3VudCwgYnl0ZXMzMihyb2NrZXRfaWQpKTsKCiAgICAgICAgd2VpX2Zvcl9wcm9maXRfZnVuZHMgPSBidXllcl9wcmljZV9vcl93ZWlfZm9yX3NlbGxlciAvIDIwOwogICAgICAgIGJ1eWVyX3ByaWNlX29yX3dlaV9mb3Jfc2VsbGVyID0gYnV5ZXJfcHJpY2Vfb3Jfd2VpX2Zvcl9zZWxsZXIgLSB3ZWlfZm9yX3Byb2ZpdF9mdW5kczsKCiAgICAgICAgcHJvZml0X2Z1bmRzX29yX2xhc3Rfcm9ja2V0X2lkID0gdWludDI1NihtX0RhdGFiYXNlLkxvYWQoTnVsbEFkZHJlc3MsIFByb2ZpdEZ1bmRzQ2F0ZWdvcnksIDApKTsKICAgICAgICBwcm9maXRfZnVuZHNfb3JfbGFzdF9yb2NrZXRfaWQgKz0gd2VpX2Zvcl9wcm9maXRfZnVuZHM7CgogICAgICAgIHNlbGxlcl9pbnZlbnRvcnlfY291bnQtLTsKICAgICAgICBtX0RhdGFiYXNlLlN0b3JlKG1zZy5zZW5kZXIsIEludmVudG9yeUNhdGVnb3J5LCAwLCBieXRlczMyKGJ1eWVyX2ludmVudG9yeV9jb3VudCkpOwogICAgICAgIG1fRGF0YWJhc2UuU3RvcmUoYmVuZWZpY2lhcnksIEludmVudG9yeUNhdGVnb3J5LCAwLCBieXRlczMyKHNlbGxlcl9pbnZlbnRvcnlfY291bnQpKTsKCiAgICAgICAgbV9EYXRhYmFzZS5TdG9yZShOdWxsQWRkcmVzcywgT3duZXJzaGlwQ2F0ZWdvcnksIHJvY2tldF9pZCwgT3duZXJzaGlwVHlwZXMuU2VyaWFsaXplT3duZXJzaGlwKG93bmVyc2hpcCkpOwogICAgICAgIG1fRGF0YWJhc2UuU3RvcmUoTnVsbEFkZHJlc3MsIFJvY2tldENhdGVnb3J5LCByb2NrZXRfaWQsIFJvY2tldFR5cGVzLlNlcmlhbGl6ZVJvY2tldChyb2NrZXQpKTsKICAgICAgICBtX0RhdGFiYXNlLlN0b3JlKE51bGxBZGRyZXNzLCBNYXJrZXRDYXRlZ29yeSwgcm9ja2V0X2lkLCBNYXJrZXRUeXBlcy5TZXJpYWxpemVNYXJrZXRMaXN0aW5nKGxpc3RpbmcpKTsKICAgICAgICBtX0RhdGFiYXNlLlN0b3JlKE51bGxBZGRyZXNzLCBQcm9maXRGdW5kc0NhdGVnb3J5LCAwLCBieXRlczMyKHByb2ZpdF9mdW5kc19vcl9sYXN0X3JvY2tldF9pZCkpOwoKICAgICAgICBidXllcl9wcmljZV9vcl93ZWlfZm9yX3NlbGxlciArPSB1aW50MjU2KG1fRGF0YWJhc2UuTG9hZChiZW5lZmljaWFyeSwgV2l0aGRyYXdhbEZ1bmRzQ2F0ZWdvcnksIDApKTsgLy8gUmV1c2UgdmFyaWFibGUKICAgICAgICBtX0RhdGFiYXNlLlN0b3JlKGJlbmVmaWNpYXJ5LCBXaXRoZHJhd2FsRnVuZHNDYXRlZ29yeSwgMCwgYnl0ZXMzMihidXllcl9wcmljZV9vcl93ZWlfZm9yX3NlbGxlcikpOwoKICAgICAgICBtX0RhdGFiYXNlLnRyYW5zZmVyKG1zZy52YWx1ZSk7CiAgICAgICAgQnV5Um9ja2V0Rm9yU2FsZUV2ZW50KG1zZy5zZW5kZXIsIGJlbmVmaWNpYXJ5LCByb2NrZXRfaWQpOwogICAgfQoKICAgIC8vIDMgd3JpdGVzICsgMS0xMiB3cml0ZXMgPSA0LTE1IHdyaXRlcwogICAgZnVuY3Rpb24gTGF1bmNoUm9ja2V0KHVpbnQzMiBjb21wZXRpdGlvbl9pZCwgdWludDMyIHJvY2tldF9pZCwgdWludDMyIGxhdW5jaF90aHJ1c3QsIHVpbnQzMiBmdWVsX3RvX3VzZSwgdWludDMyIGZ1ZWxfYWxsb2NhdGlvbl9mb3JfbGF1bmNoLCB1aW50MzIgc3RhYmlsaXplcl9zZXR0aW5nKSBwYXlhYmxlIE5vdFdoaWxlUGF1c2VkKCkgcHVibGljCiAgICB7CiAgICAgICAgR2FtZUNvbW1vbi5MYXVuY2hSb2NrZXRTdGFja0ZyYW1lIG1lbW9yeSBzdGFjazsKICAgICAgICBzdGFjay5tX1JvY2tldCA9IFJvY2tldFR5cGVzLkRlc2VyaWFsaXplUm9ja2V0KG1fRGF0YWJhc2UuTG9hZChOdWxsQWRkcmVzcywgUm9ja2V0Q2F0ZWdvcnksIHJvY2tldF9pZCkpOwogICAgICAgIHN0YWNrLm1fTWlzc2lvbiA9ICBNaXNzaW9uUGFyYW1ldGVyc1R5cGVzLkRlc2VyaWFsaXplTWlzc2lvblBhcmFtZXRlcnMobV9EYXRhYmFzZS5Mb2FkKE51bGxBZGRyZXNzLCBNaXNzaW9uUGFyYW1ldGVyc0NhdGVnb3J5LCBjb21wZXRpdGlvbl9pZCkpOwogICAgICAgIHN0YWNrLm1fT3duZXJzaGlwID0gT3duZXJzaGlwVHlwZXMuRGVzZXJpYWxpemVPd25lcnNoaXAobV9EYXRhYmFzZS5Mb2FkKE51bGxBZGRyZXNzLCBPd25lcnNoaXBDYXRlZ29yeSwgcm9ja2V0X2lkKSk7CgogICAgICAgIHJlcXVpcmUoc3RhY2subV9NaXNzaW9uLm1fSXNTdGFydGVkID09IDEpOwogICAgICAgIHJlcXVpcmUoc3RhY2subV9Sb2NrZXQubV9WZXJzaW9uID4gMCk7CiAgICAgICAgcmVxdWlyZShzdGFjay5tX1JvY2tldC5tX0lzRm9yU2FsZSA9PSAwKTsKICAgICAgICByZXF1aXJlKG1zZy52YWx1ZSA9PSB1aW50MjU2KHN0YWNrLm1fTWlzc2lvbi5tX0xhdW5jaENvc3QpKTsKICAgICAgICByZXF1aXJlKHN0YWNrLm1fT3duZXJzaGlwLm1fT3duZXIgPT0gbXNnLnNlbmRlcik7CiAgICAgICAgcmVxdWlyZShsYXVuY2hfdGhydXN0IDw9IHN0YWNrLm1fUm9ja2V0Lm1fVGhydXN0KTsKCiAgICAgICAgc3RhY2subV9NaXNzaW9uV2luZFNwZWVkID0gc3RhY2subV9NaXNzaW9uLm1fV2luZFNwZWVkOwogICAgICAgIHN0YWNrLm1fTWlzc2lvbkxhdW5jaExvY2F0aW9uID0gc3RhY2subV9NaXNzaW9uLm1fTGF1bmNoTG9jYXRpb247CiAgICAgICAgc3RhY2subV9NaXNzaW9uV2VhdGhlclR5cGUgPSBzdGFjay5tX01pc3Npb24ubV9XZWF0aGVyVHlwZTsKICAgICAgICBzdGFjay5tX01pc3Npb25XZWF0aGVyQ292ZXJhZ2UgPSBzdGFjay5tX01pc3Npb24ubV9XZWF0aGVyQ292ZXJhZ2U7CiAgICAgICAgc3RhY2subV9NaXNzaW9uVGFyZ2V0RGlzdGFuY2UgPSBzdGFjay5tX01pc3Npb24ubV9UYXJnZXREaXN0YW5jZTsKICAgICAgICBzdGFjay5tX0RlYnVnRXh0cmFEaXN0YW5jZSA9IHN0YWNrLm1fTWlzc2lvbi5tX0RlYnVnRXh0cmFEaXN0YW5jZTsKCiAgICAgICAgc3RhY2subV9Sb2NrZXRUb3BTcGVlZCA9IHN0YWNrLm1fUm9ja2V0Lm1fVG9wU3BlZWQ7CiAgICAgICAgc3RhY2subV9Sb2NrZXRUaHJ1c3QgPSBzdGFjay5tX1JvY2tldC5tX1RocnVzdDsKICAgICAgICBzdGFjay5tX1JvY2tldE1hc3MgPSBzdGFjay5tX1JvY2tldC5tX1dlaWdodDsKICAgICAgICBzdGFjay5tX1JvY2tldEZ1ZWxDYXBhY2l0eSA9IHN0YWNrLm1fUm9ja2V0Lm1fRnVlbENhcGFjaXR5OwogICAgICAgIHN0YWNrLm1fUm9ja2V0TWF4RGlzdGFuY2UgPSBpbnQ2NChzdGFjay5tX1JvY2tldC5tX01heERpc3RhbmNlKTsKCiAgICAgICAgc3RhY2subV9Db21wZXRpdGlvbklkID0gY29tcGV0aXRpb25faWQ7CiAgICAgICAgc3RhY2subV9Sb2NrZXRJZCA9IHJvY2tldF9pZDsKICAgICAgICBzdGFjay5tX0xhdW5jaFRocnVzdCA9IGxhdW5jaF90aHJ1c3QgKiAxMDAgLyBzdGFjay5tX1JvY2tldC5tX1RocnVzdDsKICAgICAgICBzdGFjay5tX0Z1ZWxUb1VzZSA9IGZ1ZWxfdG9fdXNlOwogICAgICAgIHN0YWNrLm1fRnVlbEFsbG9jYXRpb25Gb3JMYXVuY2ggPSBmdWVsX2FsbG9jYXRpb25fZm9yX2xhdW5jaDsKICAgICAgICBzdGFjay5tX1N0YWJpbGl6ZXJTZXR0aW5nID0gc3RhYmlsaXplcl9zZXR0aW5nOwogICAgICAgIHN0YWNrLm1fTGF1bmNoZXIgPSBtc2cuc2VuZGVyOwoKICAgICAgICBMYXVuY2hSb2NrZXRJbnRlcm5hbChzdGFjayk7CiAgICB9CgogICAgLy8gMyB3cml0ZXMKICAgIGZ1bmN0aW9uIExhdW5jaFJvY2tldEludGVybmFsKEdhbWVDb21tb24uTGF1bmNoUm9ja2V0U3RhY2tGcmFtZSBtZW1vcnkgc3RhY2spIGludGVybmFsCiAgICB7CiAgICAgICAgc3RhY2suU2VyaWFsaXplTGF1bmNoUm9ja2V0U3RhY2tGcmFtZSgpOwoKICAgICAgICAoc3RhY2subV9EaXNwbGFjZW1lbnRGcm9tTG93RWFydGhPcmJpdCwgc3RhY2subV9EaXNwbGFjZW1lbnRGcm9tUGxhbmV0LCBzdGFjay5tX0ZpbmFsRGlzdGFuY2UpID0gbV9HYW1lSGlkZGVuLkNhbGN1bGF0ZUZpbmFsRGlzdGFuY2UoCiAgICAgICAgICAgIHN0YWNrLm1fUmF3MCwKICAgICAgICAgICAgc3RhY2subV9SYXcxLAogICAgICAgICAgICBzdGFjay5tX1JhdzIsCiAgICAgICAgICAgIHN0YWNrLm1fUmF3MwogICAgICAgICk7CgogICAgICAgIEFkZFNjb3JlKHN0YWNrKTsKCiAgICAgICAgc3RhY2subV9Qcm9maXRGdW5kcyA9IG1zZy52YWx1ZSAvIDEwOwogICAgICAgIHN0YWNrLm1fQ29tcGV0aXRpb25GdW5kcyA9IG1zZy52YWx1ZSAtIHN0YWNrLm1fUHJvZml0RnVuZHM7CgogICAgICAgIHN0YWNrLm1fUHJvZml0RnVuZHMgKz0gdWludDI1NihtX0RhdGFiYXNlLkxvYWQoTnVsbEFkZHJlc3MsIFByb2ZpdEZ1bmRzQ2F0ZWdvcnksIDApKTsKICAgICAgICBzdGFjay5tX0NvbXBldGl0aW9uRnVuZHMgKz0gdWludDI1NihtX0RhdGFiYXNlLkxvYWQoTnVsbEFkZHJlc3MsIENvbXBldGl0aW9uRnVuZHNDYXRlZ29yeSwgc3RhY2subV9Db21wZXRpdGlvbklkKSk7CgogICAgICAgIG1fRGF0YWJhc2UuU3RvcmUoTnVsbEFkZHJlc3MsIFByb2ZpdEZ1bmRzQ2F0ZWdvcnksIDAsIGJ5dGVzMzIoc3RhY2subV9Qcm9maXRGdW5kcykpOwogICAgICAgIG1fRGF0YWJhc2UuU3RvcmUoTnVsbEFkZHJlc3MsIENvbXBldGl0aW9uRnVuZHNDYXRlZ29yeSwgc3RhY2subV9Db21wZXRpdGlvbklkLCBieXRlczMyKHN0YWNrLm1fQ29tcGV0aXRpb25GdW5kcykpOwogICAgICAgIG1fRGF0YWJhc2UuU3RvcmUoTnVsbEFkZHJlc3MsIE1pc3Npb25QYXJhbWV0ZXJzQ2F0ZWdvcnksIHN0YWNrLm1fQ29tcGV0aXRpb25JZCwgc3RhY2subV9NaXNzaW9uLlNlcmlhbGl6ZU1pc3Npb25QYXJhbWV0ZXJzKCkpOwoKICAgICAgICBtX0RhdGFiYXNlLnRyYW5zZmVyKG1zZy52YWx1ZSk7CiAgICAgICAgTGF1bmNoUm9ja2V0RXZlbnQobXNnLnNlbmRlciwgc3RhY2subV9Db21wZXRpdGlvbklkLCBzdGFjay5tX0Rpc3BsYWNlbWVudEZyb21Mb3dFYXJ0aE9yYml0LCBzdGFjay5tX0Rpc3BsYWNlbWVudEZyb21QbGFuZXQpOwogICAgfQoKICAgIC8vIDAtMSB3cml0ZXMKICAgIGZ1bmN0aW9uIEFkZFNjb3JlKEdhbWVDb21tb24uTGF1bmNoUm9ja2V0U3RhY2tGcmFtZSBtZW1vcnkgc3RhY2spIGludGVybmFsCiAgICB7CiAgICAgICAgQ29tcGV0aXRpb25TY29yZVR5cGVzLkNvbXBldGl0aW9uU2NvcmUgbWVtb3J5IG5ld19zY29yZTsKICAgICAgICBuZXdfc2NvcmUubV9Pd25lciA9IHN0YWNrLm1fTGF1bmNoZXI7CiAgICAgICAgbmV3X3Njb3JlLm1fRGlzdGFuY2UgPSBzdGFjay5tX0ZpbmFsRGlzdGFuY2U7CiAgICAgICAgbmV3X3Njb3JlLm1fUm9ja2V0SWQgPSBzdGFjay5tX1JvY2tldElkOwoKICAgICAgICBDb21wZXRpdGlvblNjb3JlVHlwZXMuQ29tcGV0aXRpb25TY29yZSBtZW1vcnkgc2NvcmU7CgogICAgICAgIGZvciAodWludDMyIGkgPSAwOyBpIDwgc3RhY2subV9NaXNzaW9uLm1fVmFsaWRDb21wZXRpdGlvblNjb3JlczsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgLy8gQ2hlY2sgaWYgdGhlIG5ldyBzY29yZSBpcyBiZXR0ZXIgdGhhbiB0aGUgc2NvcmUgdGhhdCB0aGlzIHVzZXIgYWxyZWFkeSBoYXMgKGlmIHRoZXkgYXJlIGluIHRoZSB0b3AgeCkKICAgICAgICAgICAgc2NvcmUgPSBDb21wZXRpdGlvblNjb3JlVHlwZXMuRGVzZXJpYWxpemVDb21wZXRpdGlvblNjb3JlKG1fRGF0YWJhc2UuTG9hZChzdGFjay5tX0NvbXBldGl0aW9uSWQsIENvbXBldGl0aW9uU2NvcmVzQ2F0ZWdvcnksIGkpKTsKCiAgICAgICAgICAgIGlmIChzY29yZS5tX093bmVyID09IHN0YWNrLm1fTGF1bmNoZXIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmIChzdGFjay5tX0ZpbmFsRGlzdGFuY2UgPCBzY29yZS5tX0Rpc3RhbmNlKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIG1fRGF0YWJhc2UuU3RvcmUoc3RhY2subV9Db21wZXRpdGlvbklkLCBDb21wZXRpdGlvblNjb3Jlc0NhdGVnb3J5LCBpLCBDb21wZXRpdGlvblNjb3JlVHlwZXMuU2VyaWFsaXplQ29tcGV0aXRpb25TY29yZShuZXdfc2NvcmUpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKHN0YWNrLm1fTWlzc2lvbi5tX1ZhbGlkQ29tcGV0aXRpb25TY29yZXMgPCBNYXhDb21wZXRpdGlvblNjb3JlcykKICAgICAgICB7CiAgICAgICAgICAgIC8vIE5vdCBlbm91Z2ggc2NvcmVzLCBzbyB0aGlzIG9uZSBpcyBhdXRvbWF0aWNhbGx5IG9uZSBvZiB0aGUgYmVzdAogICAgICAgICAgICBtX0RhdGFiYXNlLlN0b3JlKHN0YWNrLm1fQ29tcGV0aXRpb25JZCwgQ29tcGV0aXRpb25TY29yZXNDYXRlZ29yeSwgc3RhY2subV9NaXNzaW9uLm1fVmFsaWRDb21wZXRpdGlvblNjb3JlcywgQ29tcGV0aXRpb25TY29yZVR5cGVzLlNlcmlhbGl6ZUNvbXBldGl0aW9uU2NvcmUobmV3X3Njb3JlKSk7CgogICAgICAgICAgICBzdGFjay5tX01pc3Npb24ubV9WYWxpZENvbXBldGl0aW9uU2NvcmVzKys7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHVpbnQ2NCBoaWdoZXN0X2Rpc3RhbmNlID0gMDsKICAgICAgICB1aW50MzIgaGlnaGVzdF9pbmRleCA9IDB4RkZGRkZGRkY7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IHN0YWNrLm1fTWlzc2lvbi5tX1ZhbGlkQ29tcGV0aXRpb25TY29yZXM7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIHNjb3JlID0gQ29tcGV0aXRpb25TY29yZVR5cGVzLkRlc2VyaWFsaXplQ29tcGV0aXRpb25TY29yZShtX0RhdGFiYXNlLkxvYWQoc3RhY2subV9Db21wZXRpdGlvbklkLCBDb21wZXRpdGlvblNjb3Jlc0NhdGVnb3J5LCBpKSk7CgogICAgICAgICAgICBpZiAoc2NvcmUubV9EaXN0YW5jZSA+IGhpZ2hlc3RfZGlzdGFuY2UpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGhpZ2hlc3RfZGlzdGFuY2UgPSBzY29yZS5tX0Rpc3RhbmNlOwogICAgICAgICAgICAgICAgaGlnaGVzdF9pbmRleCA9IGk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChoaWdoZXN0X2luZGV4ICE9IDB4RkZGRkZGRkYpCiAgICAgICAgewogICAgICAgICAgICBzY29yZSA9IENvbXBldGl0aW9uU2NvcmVUeXBlcy5EZXNlcmlhbGl6ZUNvbXBldGl0aW9uU2NvcmUobV9EYXRhYmFzZS5Mb2FkKHN0YWNrLm1fQ29tcGV0aXRpb25JZCwgQ29tcGV0aXRpb25TY29yZXNDYXRlZ29yeSwgaGlnaGVzdF9pbmRleCkpOwoKICAgICAgICAgICAgLy8gQ2hlY2sgaWYgdGhlIG5ldyBzY29yZSBpcyBiZXR0ZXIgdGhhbiB0aGUgaGlnaGVzdCBzY29yZQogICAgICAgICAgICBpZiAoc3RhY2subV9GaW5hbERpc3RhbmNlIDwgc2NvcmUubV9EaXN0YW5jZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbV9EYXRhYmFzZS5TdG9yZShzdGFjay5tX0NvbXBldGl0aW9uSWQsIENvbXBldGl0aW9uU2NvcmVzQ2F0ZWdvcnksIGhpZ2hlc3RfaW5kZXgsIENvbXBldGl0aW9uU2NvcmVUeXBlcy5TZXJpYWxpemVDb21wZXRpdGlvblNjb3JlKG5ld19zY29yZSkpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIEdldENvbXBldGl0aW9uSW5mbyh1aW50MzIgY29tcGV0aXRpb25faWQpIHZpZXcgTm90V2hpbGVQYXVzZWQoKSBwdWJsaWMgcmV0dXJucyAoYm9vbCBpbl9wcm9ncmVzcywgdWludDggd2luZF9zcGVlZCwgdWludDggbGF1bmNoX2xvY2F0aW9uLCB1aW50OCB3ZWF0aGVyX3R5cGUsIHVpbnQ4IHdlYXRoZXJfY292ZXJhZ2UsIHVpbnQ4MCBsYXVuY2hfY29zdCwgdWludDMyIHRhcmdldF9kaXN0YW5jZSkKICAgIHsKICAgICAgICBNaXNzaW9uUGFyYW1ldGVyc1R5cGVzLk1pc3Npb25QYXJhbWV0ZXJzIG1lbW9yeSBwYXJhbWV0ZXJzID0gTWlzc2lvblBhcmFtZXRlcnNUeXBlcy5EZXNlcmlhbGl6ZU1pc3Npb25QYXJhbWV0ZXJzKG1fRGF0YWJhc2UuTG9hZChOdWxsQWRkcmVzcywgTWlzc2lvblBhcmFtZXRlcnNDYXRlZ29yeSwgY29tcGV0aXRpb25faWQpKTsKCiAgICAgICAgaW5fcHJvZ3Jlc3MgPSBwYXJhbWV0ZXJzLm1fSXNTdGFydGVkID09IDE7CiAgICAgICAgd2luZF9zcGVlZCA9IHBhcmFtZXRlcnMubV9XaW5kU3BlZWQ7CiAgICAgICAgbGF1bmNoX2xvY2F0aW9uID0gcGFyYW1ldGVycy5tX0xhdW5jaExvY2F0aW9uOwogICAgICAgIHdlYXRoZXJfdHlwZSA9IHBhcmFtZXRlcnMubV9XZWF0aGVyVHlwZTsKICAgICAgICB3ZWF0aGVyX2NvdmVyYWdlID0gcGFyYW1ldGVycy5tX1dlYXRoZXJDb3ZlcmFnZTsKICAgICAgICBsYXVuY2hfY29zdCA9IHBhcmFtZXRlcnMubV9MYXVuY2hDb3N0OwogICAgICAgIHRhcmdldF9kaXN0YW5jZSA9IHBhcmFtZXRlcnMubV9UYXJnZXREaXN0YW5jZTsKICAgIH0KCiAgICBmdW5jdGlvbiBTZXREZWJ1Z0V4dHJhKHVpbnQzMiBjb21wZXRpdGlvbl9pZCwgdWludDggZXh0cmEpIHB1YmxpYyBPbmx5T3duZXIoKQogICAgewogICAgICAgIE1pc3Npb25QYXJhbWV0ZXJzVHlwZXMuTWlzc2lvblBhcmFtZXRlcnMgbWVtb3J5IHBhcmFtZXRlcnMgPSBNaXNzaW9uUGFyYW1ldGVyc1R5cGVzLkRlc2VyaWFsaXplTWlzc2lvblBhcmFtZXRlcnMobV9EYXRhYmFzZS5Mb2FkKE51bGxBZGRyZXNzLCBNaXNzaW9uUGFyYW1ldGVyc0NhdGVnb3J5LCBjb21wZXRpdGlvbl9pZCkpOwoKICAgICAgICBwYXJhbWV0ZXJzLm1fRGVidWdFeHRyYURpc3RhbmNlID0gZXh0cmE7CgogICAgICAgIG1fRGF0YWJhc2UuU3RvcmUoTnVsbEFkZHJlc3MsIE1pc3Npb25QYXJhbWV0ZXJzQ2F0ZWdvcnksIGNvbXBldGl0aW9uX2lkLCBwYXJhbWV0ZXJzLlNlcmlhbGl6ZU1pc3Npb25QYXJhbWV0ZXJzKCkpOwogICAgfQoKICAgIC8vIDIgd3JpdGVzCiAgICBmdW5jdGlvbiBTdGFydENvbXBldGl0aW9uKHVpbnQ4IHdpbmRfc3BlZWQsIHVpbnQ4IGxhdW5jaF9sb2NhdGlvbiwgdWludDggd2VhdGhlcl90eXBlLCB1aW50OCB3ZWF0aGVyX2NvdmVyYWdlLCB1aW50ODAgbGF1bmNoX2Nvc3QsIHVpbnQzMiB0YXJnZXRfZGlzdGFuY2UpIHB1YmxpYyBOb3RXaGlsZVBhdXNlZCgpIE9ubHlPd25lcigpCiAgICB7CiAgICAgICAgR2xvYmFsVHlwZXMuR2xvYmFsIG1lbW9yeSBnbG9iYWwgPSBHbG9iYWxUeXBlcy5EZXNlcmlhbGl6ZUdsb2JhbChtX0RhdGFiYXNlLkxvYWQoTnVsbEFkZHJlc3MsIEdsb2JhbENhdGVnb3J5LCAwKSk7CgogICAgICAgIE1pc3Npb25QYXJhbWV0ZXJzVHlwZXMuTWlzc2lvblBhcmFtZXRlcnMgbWVtb3J5IHBhcmFtZXRlcnM7CiAgICAgICAgcGFyYW1ldGVycy5tX1dpbmRTcGVlZCA9IHdpbmRfc3BlZWQ7CiAgICAgICAgcGFyYW1ldGVycy5tX0xhdW5jaExvY2F0aW9uID0gbGF1bmNoX2xvY2F0aW9uOwogICAgICAgIHBhcmFtZXRlcnMubV9XZWF0aGVyVHlwZSA9IHdlYXRoZXJfdHlwZTsKICAgICAgICBwYXJhbWV0ZXJzLm1fV2VhdGhlckNvdmVyYWdlID0gd2VhdGhlcl9jb3ZlcmFnZTsKICAgICAgICBwYXJhbWV0ZXJzLm1fTGF1bmNoQ29zdCA9IGxhdW5jaF9jb3N0OwogICAgICAgIHBhcmFtZXRlcnMubV9UYXJnZXREaXN0YW5jZSA9IHRhcmdldF9kaXN0YW5jZTsKICAgICAgICBwYXJhbWV0ZXJzLm1fSXNTdGFydGVkID0gMTsKCiAgICAgICAgZ2xvYmFsLm1fQ29tcGV0aXRpb25OdW1iZXIrKzsKCiAgICAgICAgdWludDMyIGNvbXBldGl0aW9uX2lkID0gZ2xvYmFsLm1fQ29tcGV0aXRpb25OdW1iZXI7CgogICAgICAgIG1fRGF0YWJhc2UuU3RvcmUoTnVsbEFkZHJlc3MsIE1pc3Npb25QYXJhbWV0ZXJzQ2F0ZWdvcnksIGNvbXBldGl0aW9uX2lkLCBwYXJhbWV0ZXJzLlNlcmlhbGl6ZU1pc3Npb25QYXJhbWV0ZXJzKCkpOwogICAgICAgIG1fRGF0YWJhc2UuU3RvcmUoTnVsbEFkZHJlc3MsIEdsb2JhbENhdGVnb3J5LCAwLCBHbG9iYWxUeXBlcy5TZXJpYWxpemVHbG9iYWwoZ2xvYmFsKSk7CgogICAgICAgIFN0YXJ0Q29tcGV0aXRpb25FdmVudChjb21wZXRpdGlvbl9pZCk7CiAgICB9CgogICAgZnVuY3Rpb24gR2V0Q29tcGV0aXRpb25SZXN1bHRzKHVpbnQzMiBjb21wZXRpdGlvbl9pZCwgYm9vbCBmaXJzdF9oYWxmKSBwdWJsaWMgdmlldyByZXR1cm5zIChhZGRyZXNzW10sIHVpbnQ2NFtdKQogICAgewogICAgICAgIENvbXBldGl0aW9uU2NvcmVUeXBlcy5Db21wZXRpdGlvblNjb3JlIG1lbW9yeSBzY29yZTsKCiAgICAgICAgdWludDI1NiBvZmZzZXQgPSAoZmlyc3RfaGFsZiA9PSB0cnVlID8gMCA6IDUpOwogICAgICAgIGFkZHJlc3NbXSBtZW1vcnkgd2lubmVycyA9IG5ldyBhZGRyZXNzW10oNSk7CiAgICAgICAgdWludDY0W10gbWVtb3J5IGRpc3RhbmNlcyA9IG5ldyB1aW50NjRbXSg1KTsKCiAgICAgICAgZm9yICh1aW50MzIgaSA9IDA7IGkgPCA1OyBpKyspCiAgICAgICAgewogICAgICAgICAgICBzY29yZSA9IENvbXBldGl0aW9uU2NvcmVUeXBlcy5EZXNlcmlhbGl6ZUNvbXBldGl0aW9uU2NvcmUobV9EYXRhYmFzZS5Mb2FkKGNvbXBldGl0aW9uX2lkLCBDb21wZXRpdGlvblNjb3Jlc0NhdGVnb3J5LCBvZmZzZXQgKyBpKSk7CiAgICAgICAgICAgIHdpbm5lcnNbaV0gPSBzY29yZS5tX093bmVyOwogICAgICAgICAgICBkaXN0YW5jZXNbaV0gPSBzY29yZS5tX0Rpc3RhbmNlOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuICh3aW5uZXJzLCBkaXN0YW5jZXMpOwogICAgfQoKICAgIGZ1bmN0aW9uIFNvcnRDb21wZXRpdGlvblNjb3Jlcyh1aW50MzIgY29tcGV0aXRpb25faWQpIHB1YmxpYyBOb3RXaGlsZVBhdXNlZCgpIE9ubHlPd25lcigpCiAgICB7CiAgICAgICAgQ29tcGV0aXRpb25TY29yZVR5cGVzLkNvbXBldGl0aW9uU2NvcmVbXSBtZW1vcnkgc2NvcmVzOwogICAgICAgIE1pc3Npb25QYXJhbWV0ZXJzVHlwZXMuTWlzc2lvblBhcmFtZXRlcnMgbWVtb3J5IHBhcmFtZXRlcnM7CgogICAgICAgIChzY29yZXMsIHBhcmFtZXRlcnMpID0gTWFrZUFuZFNvcnRDb21wZXRpdGlvblNjb3Jlcyhjb21wZXRpdGlvbl9pZCk7CgogICAgICAgIGZvciAodWludDI1NiBpID0gMDsgaSA8IHBhcmFtZXRlcnMubV9WYWxpZENvbXBldGl0aW9uU2NvcmVzOyBpKyspCiAgICAgICAgewogICAgICAgICAgICBtX0RhdGFiYXNlLlN0b3JlKGNvbXBldGl0aW9uX2lkLCBDb21wZXRpdGlvblNjb3Jlc0NhdGVnb3J5LCBpLCBDb21wZXRpdGlvblNjb3JlVHlwZXMuU2VyaWFsaXplQ29tcGV0aXRpb25TY29yZShzY29yZXNbaV0pKTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gTWFrZUFuZFNvcnRDb21wZXRpdGlvblNjb3Jlcyh1aW50MzIgY29tcGV0aXRpb25faWQpIGludGVybmFsIHZpZXcgcmV0dXJucyAoQ29tcGV0aXRpb25TY29yZVR5cGVzLkNvbXBldGl0aW9uU2NvcmVbXSBtZW1vcnkgc2NvcmVzLCBNaXNzaW9uUGFyYW1ldGVyc1R5cGVzLk1pc3Npb25QYXJhbWV0ZXJzIG1lbW9yeSBwYXJhbWV0ZXJzKQogICAgewogICAgICAgIHBhcmFtZXRlcnMgPSBNaXNzaW9uUGFyYW1ldGVyc1R5cGVzLkRlc2VyaWFsaXplTWlzc2lvblBhcmFtZXRlcnMobV9EYXRhYmFzZS5Mb2FkKE51bGxBZGRyZXNzLCBNaXNzaW9uUGFyYW1ldGVyc0NhdGVnb3J5LCBjb21wZXRpdGlvbl9pZCkpOwogICAgICAgIHNjb3JlcyA9IG5ldyBDb21wZXRpdGlvblNjb3JlVHlwZXMuQ29tcGV0aXRpb25TY29yZVtdKE1heENvbXBldGl0aW9uU2NvcmVzICsgMSk7CgogICAgICAgIGZvciAodWludDI1NiBpID0gMDsgaSA8IHBhcmFtZXRlcnMubV9WYWxpZENvbXBldGl0aW9uU2NvcmVzOyBpKyspCiAgICAgICAgewogICAgICAgICAgICBzY29yZXNbaV0gPSBDb21wZXRpdGlvblNjb3JlVHlwZXMuRGVzZXJpYWxpemVDb21wZXRpdGlvblNjb3JlKG1fRGF0YWJhc2UuTG9hZChjb21wZXRpdGlvbl9pZCwgQ29tcGV0aXRpb25TY29yZXNDYXRlZ29yeSwgaSkpOwogICAgICAgIH0KCiAgICAgICAgQnViYmxlU29ydChzY29yZXMsIHBhcmFtZXRlcnMubV9WYWxpZENvbXBldGl0aW9uU2NvcmVzKTsKICAgIH0KCiAgICAvLyAyMiB3cml0ZXMgKGZ1bGwgY29tcGV0aXRpb24pCiAgICBmdW5jdGlvbiBGaW5pc2hDb21wZXRpdGlvbih1aW50MzIgY29tcGV0aXRpb25faWQpIHB1YmxpYyBOb3RXaGlsZVBhdXNlZCgpIE9ubHlPd25lcigpCiAgICB7CiAgICAgICAgQ29tcGV0aXRpb25TY29yZVR5cGVzLkNvbXBldGl0aW9uU2NvcmVbXSBtZW1vcnkgc2NvcmVzOwogICAgICAgIE1pc3Npb25QYXJhbWV0ZXJzVHlwZXMuTWlzc2lvblBhcmFtZXRlcnMgbWVtb3J5IHBhcmFtZXRlcnM7CgogICAgICAgIChzY29yZXMsIHBhcmFtZXRlcnMpID0gTWFrZUFuZFNvcnRDb21wZXRpdGlvblNjb3Jlcyhjb21wZXRpdGlvbl9pZCk7CgogICAgICAgIHJlcXVpcmUocGFyYW1ldGVycy5tX0lzU3RhcnRlZCA9PSAxKTsKCiAgICAgICAgcGFyYW1ldGVycy5tX0lzU3RhcnRlZCA9IDA7CgogICAgICAgIHVpbnQyNTYgb3JpZ2luYWxfY29tcGV0aXRpb25fZnVuZHMgPSB1aW50MjU2KG1fRGF0YWJhc2UuTG9hZChOdWxsQWRkcmVzcywgQ29tcGV0aXRpb25GdW5kc0NhdGVnb3J5LCBjb21wZXRpdGlvbl9pZCkpOwogICAgICAgIHVpbnQyNTYgY29tcGV0aXRpb25fZnVuZHNfcmVtYWluaW5nID0gb3JpZ2luYWxfY29tcGV0aXRpb25fZnVuZHM7CgogICAgICAgIGZvciAodWludDI1NiBpID0gMDsgaSA8IHBhcmFtZXRlcnMubV9WYWxpZENvbXBldGl0aW9uU2NvcmVzOyBpKyspCiAgICAgICAgewogICAgICAgICAgICBSb2NrZXRUeXBlcy5Sb2NrZXQgbWVtb3J5IHJvY2tldCA9IFJvY2tldFR5cGVzLkRlc2VyaWFsaXplUm9ja2V0KG1fRGF0YWJhc2UuTG9hZChOdWxsQWRkcmVzcywgUm9ja2V0Q2F0ZWdvcnksIHNjb3Jlc1tpXS5tX1JvY2tldElkKSk7CiAgICAgICAgICAgIFJvY2tldFR5cGVzLlN0b2NrUm9ja2V0IHN0b3JhZ2Ugc3RvY2tfcm9ja2V0ID0gbV9Jbml0aWFsUm9ja2V0c1tyb2NrZXQubV9TdG9ja0lkXTsKCiAgICAgICAgICAgIC8vIEZpeCBMZXJwcyBpbiBCdXlTdG9ja1JvY2tldCBpZiBhbnl0aGluZyBpcyBhZGRlZCBoZXJlCiAgICAgICAgICAgIC8vIFRoaXMgd2lsbCBpbmNyZWFzZSBldmVuIGlmIHRoZXkgY2hhbmdlIG93bmVycywgd2hpY2ggaXMgZmluZQogICAgICAgICAgICByb2NrZXQubV9Ub3BTcGVlZCA9IHVpbnQzMihMZXJwRXh0cmEoc3RvY2tfcm9ja2V0Lm1fTWluVG9wU3BlZWQsIHN0b2NrX3JvY2tldC5tX01heFRvcFNwZWVkLCByb2NrZXQubV9Ub3BTcGVlZCwgYnl0ZXMxKDEwIC0gaSkpKTsKICAgICAgICAgICAgcm9ja2V0Lm1fVGhydXN0ID0gdWludDMyKExlcnBFeHRyYShzdG9ja19yb2NrZXQubV9NaW5UaHJ1c3QsIHN0b2NrX3JvY2tldC5tX01heFRocnVzdCwgcm9ja2V0Lm1fVGhydXN0LCBieXRlczEoMTAgLSBpKSkpOwogICAgICAgICAgICByb2NrZXQubV9XZWlnaHQgPSB1aW50MzIoTGVycExlc3Moc3RvY2tfcm9ja2V0Lm1fTWluV2VpZ2h0LCBzdG9ja19yb2NrZXQubV9NYXhXZWlnaHQsIHJvY2tldC5tX1dlaWdodCwgYnl0ZXMxKDEwIC0gaSkpKTsKICAgICAgICAgICAgcm9ja2V0Lm1fRnVlbENhcGFjaXR5ID0gdWludDMyKExlcnBFeHRyYShzdG9ja19yb2NrZXQubV9NaW5GdWVsQ2FwYWNpdHksIHN0b2NrX3JvY2tldC5tX01heEZ1ZWxDYXBhY2l0eSwgcm9ja2V0Lm1fRnVlbENhcGFjaXR5LCBieXRlczEoMTAgLSBpKSkpOwogICAgICAgICAgICAvLwoKICAgICAgICAgICAgbV9EYXRhYmFzZS5TdG9yZShOdWxsQWRkcmVzcywgUm9ja2V0Q2F0ZWdvcnksIHNjb3Jlc1tpXS5tX1JvY2tldElkLCBSb2NrZXRUeXBlcy5TZXJpYWxpemVSb2NrZXQocm9ja2V0KSk7CgogICAgICAgICAgICB1aW50MjU2IGV4aXN0aW5nX2Z1bmRzID0gdWludDI1NihtX0RhdGFiYXNlLkxvYWQoc2NvcmVzW2ldLm1fT3duZXIsIFdpdGhkcmF3YWxGdW5kc0NhdGVnb3J5LCAwKSk7CgogICAgICAgICAgICB1aW50MjU2IGZ1bmRzX3dvbiA9IG9yaWdpbmFsX2NvbXBldGl0aW9uX2Z1bmRzIC8gKDIgKiogKGkgKyAxKSk7CgogICAgICAgICAgICBpZiAoZnVuZHNfd29uID4gY29tcGV0aXRpb25fZnVuZHNfcmVtYWluaW5nKQogICAgICAgICAgICAgICAgZnVuZHNfd29uID0gY29tcGV0aXRpb25fZnVuZHNfcmVtYWluaW5nOwoKICAgICAgICAgICAgZXhpc3RpbmdfZnVuZHMgKz0gZnVuZHNfd29uOwogICAgICAgICAgICBjb21wZXRpdGlvbl9mdW5kc19yZW1haW5pbmcgLT0gZnVuZHNfd29uOwoKICAgICAgICAgICAgbV9EYXRhYmFzZS5TdG9yZShzY29yZXNbaV0ubV9Pd25lciwgV2l0aGRyYXdhbEZ1bmRzQ2F0ZWdvcnksIDAsIGJ5dGVzMzIoZXhpc3RpbmdfZnVuZHMpKTsKICAgICAgICB9CgogICAgICAgIGlmIChjb21wZXRpdGlvbl9mdW5kc19yZW1haW5pbmcgPiAwKQogICAgICAgIHsKICAgICAgICAgICAgc2NvcmVzW01heENvbXBldGl0aW9uU2NvcmVzXSA9IENvbXBldGl0aW9uU2NvcmVUeXBlcy5EZXNlcmlhbGl6ZUNvbXBldGl0aW9uU2NvcmUobV9EYXRhYmFzZS5Mb2FkKGNvbXBldGl0aW9uX2lkLCBDb21wZXRpdGlvblNjb3Jlc0NhdGVnb3J5LCAwKSk7CiAgICAgICAgICAgIGV4aXN0aW5nX2Z1bmRzID0gdWludDI1NihtX0RhdGFiYXNlLkxvYWQoc2NvcmVzW01heENvbXBldGl0aW9uU2NvcmVzXS5tX093bmVyLCBXaXRoZHJhd2FsRnVuZHNDYXRlZ29yeSwgMCkpOwogICAgICAgICAgICBleGlzdGluZ19mdW5kcyArPSBjb21wZXRpdGlvbl9mdW5kc19yZW1haW5pbmc7CiAgICAgICAgICAgIG1fRGF0YWJhc2UuU3RvcmUoc2NvcmVzW01heENvbXBldGl0aW9uU2NvcmVzXS5tX093bmVyLCBXaXRoZHJhd2FsRnVuZHNDYXRlZ29yeSwgMCwgYnl0ZXMzMihleGlzdGluZ19mdW5kcykpOwogICAgICAgIH0KCiAgICAgICAgbV9EYXRhYmFzZS5TdG9yZShOdWxsQWRkcmVzcywgTWlzc2lvblBhcmFtZXRlcnNDYXRlZ29yeSwgY29tcGV0aXRpb25faWQsIHBhcmFtZXRlcnMuU2VyaWFsaXplTWlzc2lvblBhcmFtZXRlcnMoKSk7CgogICAgICAgIEZpbmlzaENvbXBldGl0aW9uRXZlbnQoY29tcGV0aXRpb25faWQpOwogICAgfQoKICAgIGZ1bmN0aW9uIExlcnAodWludDI1NiBtaW4sIHVpbnQyNTYgbWF4LCBieXRlczEgcGVyY2VudCkgaW50ZXJuYWwgcHVyZSByZXR1cm5zKHVpbnQyNTYpCiAgICB7CiAgICAgICAgdWludDI1NiByZWFsX3BlcmNlbnQgPSAodWludDI1NihwZXJjZW50KSAlIDEwMCk7CiAgICAgICAgcmV0dXJuIHVpbnQyNTYobWluICsgKHJlYWxfcGVyY2VudCAqIChtYXggLSBtaW4pKSAvIDEwMCk7CiAgICB9CgogICAgZnVuY3Rpb24gTGVycEV4dHJhKHVpbnQyNTYgbWluLCB1aW50MjU2IG1heCwgdWludDI1NiBjdXJyZW50LCBieXRlczEgdG90YWxfZXh0cmFfcGVyY2VudCkgaW50ZXJuYWwgcHVyZSByZXR1cm5zICh1aW50MjU2KQogICAgewogICAgICAgIGN1cnJlbnQgKz0gTGVycChtaW4sIG1heCwgdG90YWxfZXh0cmFfcGVyY2VudCkgLSBtaW47CiAgICAgICAgaWYgKGN1cnJlbnQgPCBtaW4gfHwgY3VycmVudCA+IG1heCkKICAgICAgICAgICAgY3VycmVudCA9IG1heDsKICAgICAgICByZXR1cm4gY3VycmVudDsKICAgIH0KCiAgICBmdW5jdGlvbiBMZXJwTGVzcyh1aW50MjU2IG1pbiwgdWludDI1NiBtYXgsIHVpbnQyNTYgY3VycmVudCwgYnl0ZXMxIHRvdGFsX2xlc3NfcGVyY2VudCkgaW50ZXJuYWwgcHVyZSByZXR1cm5zICh1aW50MjU2KQogICAgewogICAgICAgIGN1cnJlbnQgLT0gTGVycChtaW4sIG1heCwgdG90YWxfbGVzc19wZXJjZW50KSAtIG1pbjsKICAgICAgICBpZiAoY3VycmVudCA8IG1pbiB8fCBjdXJyZW50ID4gbWF4KQogICAgICAgICAgICBjdXJyZW50ID0gbWluOwogICAgICAgIHJldHVybiBjdXJyZW50OwogICAgfQoKICAgIGZ1bmN0aW9uIEJ1YmJsZVNvcnQoQ29tcGV0aXRpb25TY29yZVR5cGVzLkNvbXBldGl0aW9uU2NvcmVbXSBtZW1vcnkgc2NvcmVzLCB1aW50MzIgbGVuZ3RoKSBpbnRlcm5hbCBwdXJlCiAgICB7CiAgICAgICAgdWludDMyIG4gPSBsZW5ndGg7CiAgICAgICAgd2hpbGUgKHRydWUpCiAgICAgICAgewogICAgICAgICAgICBib29sIHN3YXBwZWQgPSBmYWxzZTsKICAgICAgICAgICAgZm9yICh1aW50MzIgaSA9IDE7IGkgPCBuOyBpKyspCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmIChzY29yZXNbaSAtIDFdLm1fRGlzdGFuY2UgPiBzY29yZXNbaV0ubV9EaXN0YW5jZSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBzY29yZXNbTWF4Q29tcGV0aXRpb25TY29yZXNdID0gc2NvcmVzW2kgLSAxXTsKICAgICAgICAgICAgICAgICAgICBzY29yZXNbaSAtIDFdID0gc2NvcmVzW2ldOwogICAgICAgICAgICAgICAgICAgIHNjb3Jlc1tpXSA9IHNjb3Jlc1tNYXhDb21wZXRpdGlvblNjb3Jlc107CiAgICAgICAgICAgICAgICAgICAgc3dhcHBlZCA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbi0tOwogICAgICAgICAgICBpZiAoIXN3YXBwZWQpCiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICB9Cn0KCmxpYnJhcnkgR2FtZUNvbW1vbgp7CiAgICB1c2luZyBTZXJpYWxpemVyIGZvciBTZXJpYWxpemVyLkRhdGFDb21wb25lbnQ7CgogICAgc3RydWN0IExhdW5jaFJvY2tldFN0YWNrRnJhbWUKICAgIHsKICAgICAgICBpbnQ2NCBtX1JvY2tldFRvcFNwZWVkOyAvLyAwCiAgICAgICAgaW50NjQgbV9Sb2NrZXRUaHJ1c3Q7IC8vIDgKICAgICAgICBpbnQ2NCBtX1JvY2tldE1hc3M7IC8vIDE2CiAgICAgICAgaW50NjQgbV9Sb2NrZXRGdWVsQ2FwYWNpdHk7IC8vIDI0CgogICAgICAgIGludDY0IG1fUm9ja2V0TWF4RGlzdGFuY2U7IC8vIDAKICAgICAgICBpbnQ2NCBtX01pc3Npb25XaW5kU3BlZWQ7IC8vIDgKICAgICAgICBpbnQ2NCBtX01pc3Npb25MYXVuY2hMb2NhdGlvbjsgLy8gMTYKICAgICAgICBpbnQ2NCBtX01pc3Npb25XZWF0aGVyVHlwZTsgLy8gMjQKCiAgICAgICAgaW50NjQgbV9NaXNzaW9uV2VhdGhlckNvdmVyYWdlOyAvLyAwCiAgICAgICAgaW50NjQgbV9NaXNzaW9uVGFyZ2V0RGlzdGFuY2U7IC8vIDgKICAgICAgICBpbnQ2NCBtX0Z1ZWxUb1VzZTsgLy8gMTYKICAgICAgICBpbnQ2NCBtX0Z1ZWxBbGxvY2F0aW9uRm9yTGF1bmNoOyAvLyAyNAoKICAgICAgICBpbnQ2NCBtX1N0YWJpbGl6ZXJTZXR0aW5nOyAvLyAwCiAgICAgICAgaW50NjQgbV9EZWJ1Z0V4dHJhRGlzdGFuY2U7IC8vIDgKICAgICAgICBpbnQ2NCBtX0xhdW5jaFRocnVzdDsgLy8gMTYKCiAgICAgICAgUm9ja2V0VHlwZXMuUm9ja2V0IG1fUm9ja2V0OwogICAgICAgIE93bmVyc2hpcFR5cGVzLk93bmVyc2hpcCBtX093bmVyc2hpcDsKICAgICAgICBNaXNzaW9uUGFyYW1ldGVyc1R5cGVzLk1pc3Npb25QYXJhbWV0ZXJzIG1fTWlzc2lvbjsKCiAgICAgICAgYnl0ZXMzMiBtX1JhdzA7CiAgICAgICAgYnl0ZXMzMiBtX1JhdzE7CiAgICAgICAgYnl0ZXMzMiBtX1JhdzI7CiAgICAgICAgYnl0ZXMzMiBtX1JhdzM7CgogICAgICAgIHVpbnQzMiBtX0NvbXBldGl0aW9uSWQ7CiAgICAgICAgdWludDMyIG1fUm9ja2V0SWQ7CiAgICAgICAgaW50NjQgbV9Mb3dFYXJ0aE9yYml0UG9zaXRpb247CiAgICAgICAgaW50NjQgbV9EaXNwbGFjZW1lbnRGcm9tTG93RWFydGhPcmJpdDsKICAgICAgICBpbnQ2NCBtX0Rpc3BsYWNlbWVudEZyb21QbGFuZXQ7CiAgICAgICAgYWRkcmVzcyBtX0xhdW5jaGVyOwogICAgICAgIHVpbnQyNTYgbV9Qcm9maXRGdW5kczsKICAgICAgICB1aW50MjU2IG1fQ29tcGV0aXRpb25GdW5kczsKICAgICAgICB1aW50NjQgbV9GaW5hbERpc3RhbmNlOwogICAgfQoKICAgIGZ1bmN0aW9uIFNlcmlhbGl6ZUxhdW5jaFJvY2tldFN0YWNrRnJhbWUoTGF1bmNoUm9ja2V0U3RhY2tGcmFtZSBtZW1vcnkgc3RhY2spIGludGVybmFsIHB1cmUKICAgIHsKICAgICAgICBTZXJpYWxpemVSYXcwKHN0YWNrKTsKICAgICAgICBTZXJpYWxpemVSYXcxKHN0YWNrKTsKICAgICAgICBTZXJpYWxpemVSYXcyKHN0YWNrKTsKICAgICAgICBTZXJpYWxpemVSYXczKHN0YWNrKTsKICAgIH0KCiAgICBmdW5jdGlvbiBEZXNlcmlhbGl6ZUxhdW5jaFJvY2tldFN0YWNrRnJhbWUoTGF1bmNoUm9ja2V0U3RhY2tGcmFtZSBtZW1vcnkgc3RhY2spIGludGVybmFsIHB1cmUKICAgIHsKICAgICAgICBEZXNlcmlhbGl6ZVJhdzAoc3RhY2spOwogICAgICAgIERlc2VyaWFsaXplUmF3MShzdGFjayk7CiAgICAgICAgRGVzZXJpYWxpemVSYXcyKHN0YWNrKTsKICAgICAgICBEZXNlcmlhbGl6ZVJhdzMoc3RhY2spOwogICAgfQoKICAgIGZ1bmN0aW9uIFNlcmlhbGl6ZVJhdzAoTGF1bmNoUm9ja2V0U3RhY2tGcmFtZSBtZW1vcnkgc3RhY2spIGludGVybmFsIHB1cmUKICAgIHsKICAgICAgICBTZXJpYWxpemVyLkRhdGFDb21wb25lbnQgbWVtb3J5IGRhdGE7CgogICAgICAgIGRhdGEuV3JpdGVVaW50NjQoMCwgdWludDY0KHN0YWNrLm1fUm9ja2V0VG9wU3BlZWQpKTsKICAgICAgICBkYXRhLldyaXRlVWludDY0KDgsIHVpbnQ2NChzdGFjay5tX1JvY2tldFRocnVzdCkpOwogICAgICAgIGRhdGEuV3JpdGVVaW50NjQoMTYsIHVpbnQ2NChzdGFjay5tX1JvY2tldE1hc3MpKTsKICAgICAgICBkYXRhLldyaXRlVWludDY0KDI0LCB1aW50NjQoc3RhY2subV9Sb2NrZXRGdWVsQ2FwYWNpdHkpKTsKCiAgICAgICAgc3RhY2subV9SYXcwID0gZGF0YS5tX1JhdzsKICAgIH0KCiAgICBmdW5jdGlvbiBEZXNlcmlhbGl6ZVJhdzAoTGF1bmNoUm9ja2V0U3RhY2tGcmFtZSBtZW1vcnkgc3RhY2spIGludGVybmFsIHB1cmUKICAgIHsKICAgICAgICBTZXJpYWxpemVyLkRhdGFDb21wb25lbnQgbWVtb3J5IGRhdGE7CiAgICAgICAgZGF0YS5tX1JhdyA9IHN0YWNrLm1fUmF3MDsKCiAgICAgICAgc3RhY2subV9Sb2NrZXRUb3BTcGVlZCA9IGludDY0KGRhdGEuUmVhZFVpbnQ2NCgwKSk7CiAgICAgICAgc3RhY2subV9Sb2NrZXRUaHJ1c3QgPSBpbnQ2NChkYXRhLlJlYWRVaW50NjQoOCkpOwogICAgICAgIHN0YWNrLm1fUm9ja2V0TWFzcyA9IGludDY0KGRhdGEuUmVhZFVpbnQ2NCgxNikpOwogICAgICAgIHN0YWNrLm1fUm9ja2V0RnVlbENhcGFjaXR5ID0gaW50NjQoZGF0YS5SZWFkVWludDY0KDI0KSk7CiAgICB9CgogICAgZnVuY3Rpb24gU2VyaWFsaXplUmF3MShMYXVuY2hSb2NrZXRTdGFja0ZyYW1lIG1lbW9yeSBzdGFjaykgaW50ZXJuYWwgcHVyZQogICAgewogICAgICAgIFNlcmlhbGl6ZXIuRGF0YUNvbXBvbmVudCBtZW1vcnkgZGF0YTsKCiAgICAgICAgZGF0YS5Xcml0ZVVpbnQ2NCgwLCB1aW50NjQoc3RhY2subV9Sb2NrZXRNYXhEaXN0YW5jZSkpOwogICAgICAgIGRhdGEuV3JpdGVVaW50NjQoOCwgdWludDY0KHN0YWNrLm1fTWlzc2lvbldpbmRTcGVlZCkpOwogICAgICAgIGRhdGEuV3JpdGVVaW50NjQoMTYsIHVpbnQ2NChzdGFjay5tX01pc3Npb25MYXVuY2hMb2NhdGlvbikpOwogICAgICAgIGRhdGEuV3JpdGVVaW50NjQoMjQsIHVpbnQ2NChzdGFjay5tX01pc3Npb25XZWF0aGVyVHlwZSkpOwoKICAgICAgICBzdGFjay5tX1JhdzEgPSBkYXRhLm1fUmF3OwogICAgfQoKICAgIGZ1bmN0aW9uIERlc2VyaWFsaXplUmF3MShMYXVuY2hSb2NrZXRTdGFja0ZyYW1lIG1lbW9yeSBzdGFjaykgaW50ZXJuYWwgcHVyZQogICAgewogICAgICAgIFNlcmlhbGl6ZXIuRGF0YUNvbXBvbmVudCBtZW1vcnkgZGF0YTsKICAgICAgICBkYXRhLm1fUmF3ID0gc3RhY2subV9SYXcxOwoKICAgICAgICBzdGFjay5tX1JvY2tldE1heERpc3RhbmNlID0gaW50NjQoZGF0YS5SZWFkVWludDY0KDApKTsKICAgICAgICBzdGFjay5tX01pc3Npb25XaW5kU3BlZWQgPSBpbnQ2NChkYXRhLlJlYWRVaW50NjQoOCkpOwogICAgICAgIHN0YWNrLm1fTWlzc2lvbkxhdW5jaExvY2F0aW9uID0gaW50NjQoZGF0YS5SZWFkVWludDY0KDE2KSk7CiAgICAgICAgc3RhY2subV9NaXNzaW9uV2VhdGhlclR5cGUgPSBpbnQ2NChkYXRhLlJlYWRVaW50NjQoMjQpKTsKICAgIH0KCiAgICBmdW5jdGlvbiBTZXJpYWxpemVSYXcyKExhdW5jaFJvY2tldFN0YWNrRnJhbWUgbWVtb3J5IHN0YWNrKSBpbnRlcm5hbCBwdXJlCiAgICB7CiAgICAgICAgU2VyaWFsaXplci5EYXRhQ29tcG9uZW50IG1lbW9yeSBkYXRhOwoKICAgICAgICBkYXRhLldyaXRlVWludDY0KDAsIHVpbnQ2NChzdGFjay5tX01pc3Npb25XZWF0aGVyQ292ZXJhZ2UpKTsKICAgICAgICBkYXRhLldyaXRlVWludDY0KDgsIHVpbnQ2NChzdGFjay5tX01pc3Npb25UYXJnZXREaXN0YW5jZSkpOwogICAgICAgIGRhdGEuV3JpdGVVaW50NjQoMTYsIHVpbnQ2NChzdGFjay5tX0Z1ZWxUb1VzZSkpOwogICAgICAgIGRhdGEuV3JpdGVVaW50NjQoMjQsIHVpbnQ2NChzdGFjay5tX0Z1ZWxBbGxvY2F0aW9uRm9yTGF1bmNoKSk7CgogICAgICAgIHN0YWNrLm1fUmF3MiA9IGRhdGEubV9SYXc7CiAgICB9CgogICAgZnVuY3Rpb24gRGVzZXJpYWxpemVSYXcyKExhdW5jaFJvY2tldFN0YWNrRnJhbWUgbWVtb3J5IHN0YWNrKSBpbnRlcm5hbCBwdXJlCiAgICB7CiAgICAgICAgU2VyaWFsaXplci5EYXRhQ29tcG9uZW50IG1lbW9yeSBkYXRhOwogICAgICAgIGRhdGEubV9SYXcgPSBzdGFjay5tX1JhdzI7CgogICAgICAgIHN0YWNrLm1fTWlzc2lvbldlYXRoZXJDb3ZlcmFnZSA9IGludDY0KGRhdGEuUmVhZFVpbnQ2NCgwKSk7CiAgICAgICAgc3RhY2subV9NaXNzaW9uVGFyZ2V0RGlzdGFuY2UgPSBpbnQ2NChkYXRhLlJlYWRVaW50NjQoOCkpOwogICAgICAgIHN0YWNrLm1fRnVlbFRvVXNlID0gaW50NjQoZGF0YS5SZWFkVWludDY0KDE2KSk7CiAgICAgICAgc3RhY2subV9GdWVsQWxsb2NhdGlvbkZvckxhdW5jaCA9IGludDY0KGRhdGEuUmVhZFVpbnQ2NCgyNCkpOwogICAgfQoKICAgIGZ1bmN0aW9uIFNlcmlhbGl6ZVJhdzMoTGF1bmNoUm9ja2V0U3RhY2tGcmFtZSBtZW1vcnkgc3RhY2spIGludGVybmFsIHB1cmUKICAgIHsKICAgICAgICBTZXJpYWxpemVyLkRhdGFDb21wb25lbnQgbWVtb3J5IGRhdGE7CgogICAgICAgIGRhdGEuV3JpdGVVaW50NjQoMCwgdWludDY0KHN0YWNrLm1fU3RhYmlsaXplclNldHRpbmcpKTsKICAgICAgICBkYXRhLldyaXRlVWludDY0KDgsIHVpbnQ2NChzdGFjay5tX0RlYnVnRXh0cmFEaXN0YW5jZSkpOwogICAgICAgIGRhdGEuV3JpdGVVaW50NjQoMTYsIHVpbnQ2NChzdGFjay5tX0xhdW5jaFRocnVzdCkpOwoKICAgICAgICBzdGFjay5tX1JhdzMgPSBkYXRhLm1fUmF3OwogICAgfQoKICAgIGZ1bmN0aW9uIERlc2VyaWFsaXplUmF3MyhMYXVuY2hSb2NrZXRTdGFja0ZyYW1lIG1lbW9yeSBzdGFjaykgaW50ZXJuYWwgcHVyZQogICAgewogICAgICAgIFNlcmlhbGl6ZXIuRGF0YUNvbXBvbmVudCBtZW1vcnkgZGF0YTsKICAgICAgICBkYXRhLm1fUmF3ID0gc3RhY2subV9SYXczOwoKICAgICAgICBzdGFjay5tX1N0YWJpbGl6ZXJTZXR0aW5nID0gaW50NjQoZGF0YS5SZWFkVWludDY0KDApKTsKICAgICAgICBzdGFjay5tX0RlYnVnRXh0cmFEaXN0YW5jZSA9IGludDY0KGRhdGEuUmVhZFVpbnQ2NCg4KSk7CiAgICAgICAgc3RhY2subV9MYXVuY2hUaHJ1c3QgPSBpbnQ2NChkYXRhLlJlYWRVaW50NjQoMTYpKTsKICAgIH0KfQoKbGlicmFyeSBHbG9iYWxUeXBlcwp7CiAgICB1c2luZyBTZXJpYWxpemVyIGZvciBTZXJpYWxpemVyLkRhdGFDb21wb25lbnQ7CgogICAgc3RydWN0IEdsb2JhbAogICAgewogICAgICAgIHVpbnQzMiBtX0xhc3RSb2NrZXRJZDsgLy8gMAogICAgICAgIHVpbnQzMiBtX0NvbXBldGl0aW9uTnVtYmVyOyAvLyA0CiAgICAgICAgdWludDggbV9VbnVzZWQ4OyAvLyA4CiAgICAgICAgdWludDggbV9VbnVzZWQ5OyAvLyA5CiAgICAgICAgdWludDggbV9VbnVzZWQxMDsgLy8gMTAKICAgICAgICB1aW50OCBtX1VudXNlZDExOyAvLyAxMQogICAgfQoKICAgIGZ1bmN0aW9uIFNlcmlhbGl6ZUdsb2JhbChHbG9iYWwgZ2xvYmFsKSBpbnRlcm5hbCBwdXJlIHJldHVybnMgKGJ5dGVzMzIpCiAgICB7CiAgICAgICAgU2VyaWFsaXplci5EYXRhQ29tcG9uZW50IG1lbW9yeSBkYXRhOwogICAgICAgIGRhdGEuV3JpdGVVaW50MzIoMCwgZ2xvYmFsLm1fTGFzdFJvY2tldElkKTsKICAgICAgICBkYXRhLldyaXRlVWludDMyKDQsIGdsb2JhbC5tX0NvbXBldGl0aW9uTnVtYmVyKTsKICAgICAgICBkYXRhLldyaXRlVWludDgoOCwgZ2xvYmFsLm1fVW51c2VkOCk7CiAgICAgICAgZGF0YS5Xcml0ZVVpbnQ4KDksIGdsb2JhbC5tX1VudXNlZDkpOwogICAgICAgIGRhdGEuV3JpdGVVaW50OCgxMCwgZ2xvYmFsLm1fVW51c2VkMTApOwogICAgICAgIGRhdGEuV3JpdGVVaW50OCgxMSwgZ2xvYmFsLm1fVW51c2VkMTEpOwoKICAgICAgICByZXR1cm4gZGF0YS5tX1JhdzsKICAgIH0KCiAgICBmdW5jdGlvbiBEZXNlcmlhbGl6ZUdsb2JhbChieXRlczMyIHJhdykgaW50ZXJuYWwgcHVyZSByZXR1cm5zIChHbG9iYWwpCiAgICB7CiAgICAgICAgR2xvYmFsIG1lbW9yeSBnbG9iYWw7CgogICAgICAgIFNlcmlhbGl6ZXIuRGF0YUNvbXBvbmVudCBtZW1vcnkgZGF0YTsKICAgICAgICBkYXRhLm1fUmF3ID0gcmF3OwoKICAgICAgICBnbG9iYWwubV9MYXN0Um9ja2V0SWQgPSBkYXRhLlJlYWRVaW50MzIoMCk7CiAgICAgICAgZ2xvYmFsLm1fQ29tcGV0aXRpb25OdW1iZXIgPSBkYXRhLlJlYWRVaW50MzIoNCk7CiAgICAgICAgZ2xvYmFsLm1fVW51c2VkOCA9IGRhdGEuUmVhZFVpbnQ4KDgpOwogICAgICAgIGdsb2JhbC5tX1VudXNlZDkgPSBkYXRhLlJlYWRVaW50OCg5KTsKICAgICAgICBnbG9iYWwubV9VbnVzZWQxMCA9IGRhdGEuUmVhZFVpbnQ4KDEwKTsKICAgICAgICBnbG9iYWwubV9VbnVzZWQxMSA9IGRhdGEuUmVhZFVpbnQ4KDExKTsKCiAgICAgICAgcmV0dXJuIGdsb2JhbDsKICAgIH0KfQoKbGlicmFyeSBNYXJrZXRUeXBlcwp7CiAgICB1c2luZyBTZXJpYWxpemVyIGZvciBTZXJpYWxpemVyLkRhdGFDb21wb25lbnQ7CgogICAgc3RydWN0IE1hcmtldExpc3RpbmcKICAgIHsKICAgICAgICB1aW50ODAgbV9QcmljZTsgLy8gMAogICAgfQoKICAgIGZ1bmN0aW9uIFNlcmlhbGl6ZU1hcmtldExpc3RpbmcoTWFya2V0TGlzdGluZyBsaXN0aW5nKSBpbnRlcm5hbCBwdXJlIHJldHVybnMgKGJ5dGVzMzIpCiAgICB7CiAgICAgICAgU2VyaWFsaXplci5EYXRhQ29tcG9uZW50IG1lbW9yeSBkYXRhOwogICAgICAgIGRhdGEuV3JpdGVVaW50ODAoMCwgbGlzdGluZy5tX1ByaWNlKTsKCiAgICAgICAgcmV0dXJuIGRhdGEubV9SYXc7CiAgICB9CgogICAgZnVuY3Rpb24gRGVzZXJpYWxpemVNYXJrZXRMaXN0aW5nKGJ5dGVzMzIgcmF3KSBpbnRlcm5hbCBwdXJlIHJldHVybnMgKE1hcmtldExpc3RpbmcpCiAgICB7CiAgICAgICAgTWFya2V0TGlzdGluZyBtZW1vcnkgbGlzdGluZzsKCiAgICAgICAgU2VyaWFsaXplci5EYXRhQ29tcG9uZW50IG1lbW9yeSBkYXRhOwogICAgICAgIGRhdGEubV9SYXcgPSByYXc7CgogICAgICAgIGxpc3RpbmcubV9QcmljZSA9IGRhdGEuUmVhZFVpbnQ4MCgwKTsKCiAgICAgICAgcmV0dXJuIGxpc3Rpbmc7CiAgICB9Cn0KCmxpYnJhcnkgTWlzc2lvblBhcmFtZXRlcnNUeXBlcwp7CiAgICB1c2luZyBTZXJpYWxpemVyIGZvciBTZXJpYWxpemVyLkRhdGFDb21wb25lbnQ7CgogICAgc3RydWN0IE1pc3Npb25QYXJhbWV0ZXJzCiAgICB7CiAgICAgICAgdWludDggbV9XaW5kU3BlZWQ7IC8vIDAKICAgICAgICB1aW50OCBtX0xhdW5jaExvY2F0aW9uOyAvLyAxCiAgICAgICAgdWludDggbV9XZWF0aGVyVHlwZTsgLy8gMgogICAgICAgIHVpbnQ4IG1fV2VhdGhlckNvdmVyYWdlOyAvLyAzCiAgICAgICAgdWludDgwIG1fTGF1bmNoQ29zdDsgLy8gNAogICAgICAgIHVpbnQ4IG1fSXNTdGFydGVkOyAvLyAxNAogICAgICAgIHVpbnQzMiBtX1RhcmdldERpc3RhbmNlOyAvLyAxNQogICAgICAgIHVpbnQzMiBtX1ZhbGlkQ29tcGV0aXRpb25TY29yZXM7IC8vIDE5CiAgICAgICAgdWludDggbV9EZWJ1Z0V4dHJhRGlzdGFuY2U7IC8vIDIzCiAgICB9CgogICAgZnVuY3Rpb24gU2VyaWFsaXplTWlzc2lvblBhcmFtZXRlcnMoTWlzc2lvblBhcmFtZXRlcnMgbWlzc2lvbikgaW50ZXJuYWwgcHVyZSByZXR1cm5zIChieXRlczMyKQogICAgewogICAgICAgIFNlcmlhbGl6ZXIuRGF0YUNvbXBvbmVudCBtZW1vcnkgZGF0YTsKCiAgICAgICAgZGF0YS5Xcml0ZVVpbnQ4KDAsIG1pc3Npb24ubV9XaW5kU3BlZWQpOwogICAgICAgIGRhdGEuV3JpdGVVaW50OCgxLCBtaXNzaW9uLm1fTGF1bmNoTG9jYXRpb24pOwogICAgICAgIGRhdGEuV3JpdGVVaW50OCgyLCBtaXNzaW9uLm1fV2VhdGhlclR5cGUpOwogICAgICAgIGRhdGEuV3JpdGVVaW50OCgzLCBtaXNzaW9uLm1fV2VhdGhlckNvdmVyYWdlKTsKICAgICAgICBkYXRhLldyaXRlVWludDgwKDQsIG1pc3Npb24ubV9MYXVuY2hDb3N0KTsKICAgICAgICBkYXRhLldyaXRlVWludDgoMTQsIG1pc3Npb24ubV9Jc1N0YXJ0ZWQpOwogICAgICAgIGRhdGEuV3JpdGVVaW50MzIoMTUsIG1pc3Npb24ubV9UYXJnZXREaXN0YW5jZSk7CiAgICAgICAgZGF0YS5Xcml0ZVVpbnQzMigxOSwgbWlzc2lvbi5tX1ZhbGlkQ29tcGV0aXRpb25TY29yZXMpOwogICAgICAgIGRhdGEuV3JpdGVVaW50OCgyMywgbWlzc2lvbi5tX0RlYnVnRXh0cmFEaXN0YW5jZSk7CgogICAgICAgIHJldHVybiBkYXRhLm1fUmF3OwogICAgfQoKICAgIGZ1bmN0aW9uIERlc2VyaWFsaXplTWlzc2lvblBhcmFtZXRlcnMoYnl0ZXMzMiByYXcpIGludGVybmFsIHB1cmUgcmV0dXJucyAoTWlzc2lvblBhcmFtZXRlcnMpCiAgICB7CiAgICAgICAgTWlzc2lvblBhcmFtZXRlcnMgbWVtb3J5IG1pc3Npb247CgogICAgICAgIFNlcmlhbGl6ZXIuRGF0YUNvbXBvbmVudCBtZW1vcnkgZGF0YTsKICAgICAgICBkYXRhLm1fUmF3ID0gcmF3OwoKICAgICAgICBtaXNzaW9uLm1fV2luZFNwZWVkID0gZGF0YS5SZWFkVWludDgoMCk7CiAgICAgICAgbWlzc2lvbi5tX0xhdW5jaExvY2F0aW9uID0gZGF0YS5SZWFkVWludDgoMSk7CiAgICAgICAgbWlzc2lvbi5tX1dlYXRoZXJUeXBlID0gZGF0YS5SZWFkVWludDgoMik7CiAgICAgICAgbWlzc2lvbi5tX1dlYXRoZXJDb3ZlcmFnZSA9IGRhdGEuUmVhZFVpbnQ4KDMpOwogICAgICAgIG1pc3Npb24ubV9MYXVuY2hDb3N0ID0gZGF0YS5SZWFkVWludDgwKDQpOwogICAgICAgIG1pc3Npb24ubV9Jc1N0YXJ0ZWQgPSBkYXRhLlJlYWRVaW50OCgxNCk7CiAgICAgICAgbWlzc2lvbi5tX1RhcmdldERpc3RhbmNlID0gZGF0YS5SZWFkVWludDMyKDE1KTsKICAgICAgICBtaXNzaW9uLm1fVmFsaWRDb21wZXRpdGlvblNjb3JlcyA9IGRhdGEuUmVhZFVpbnQzMigxOSk7CiAgICAgICAgbWlzc2lvbi5tX0RlYnVnRXh0cmFEaXN0YW5jZSA9IGRhdGEuUmVhZFVpbnQ4KDIzKTsKCiAgICAgICAgcmV0dXJuIG1pc3Npb247CiAgICB9Cn0KCmxpYnJhcnkgT3duZXJzaGlwVHlwZXMKewogICAgdXNpbmcgU2VyaWFsaXplciBmb3IgU2VyaWFsaXplci5EYXRhQ29tcG9uZW50OwoKICAgIHN0cnVjdCBPd25lcnNoaXAKICAgIHsKICAgICAgICBhZGRyZXNzIG1fT3duZXI7IC8vIDAKICAgICAgICB1aW50MzIgbV9Pd25lckludmVudG9yeUluZGV4OyAvLyAyMAogICAgfQoKICAgIGZ1bmN0aW9uIFNlcmlhbGl6ZU93bmVyc2hpcChPd25lcnNoaXAgb3duZXJzaGlwKSBpbnRlcm5hbCBwdXJlIHJldHVybnMgKGJ5dGVzMzIpCiAgICB7CiAgICAgICAgU2VyaWFsaXplci5EYXRhQ29tcG9uZW50IG1lbW9yeSBkYXRhOwogICAgICAgIGRhdGEuV3JpdGVBZGRyZXNzKDAsIG93bmVyc2hpcC5tX093bmVyKTsKICAgICAgICBkYXRhLldyaXRlVWludDMyKDIwLCBvd25lcnNoaXAubV9Pd25lckludmVudG9yeUluZGV4KTsKCiAgICAgICAgcmV0dXJuIGRhdGEubV9SYXc7CiAgICB9CgogICAgZnVuY3Rpb24gRGVzZXJpYWxpemVPd25lcnNoaXAoYnl0ZXMzMiByYXcpIGludGVybmFsIHB1cmUgcmV0dXJucyAoT3duZXJzaGlwKQogICAgewogICAgICAgIE93bmVyc2hpcCBtZW1vcnkgb3duZXJzaGlwOwoKICAgICAgICBTZXJpYWxpemVyLkRhdGFDb21wb25lbnQgbWVtb3J5IGRhdGE7CiAgICAgICAgZGF0YS5tX1JhdyA9IHJhdzsKCiAgICAgICAgb3duZXJzaGlwLm1fT3duZXIgPSBkYXRhLlJlYWRBZGRyZXNzKDApOwogICAgICAgIG93bmVyc2hpcC5tX093bmVySW52ZW50b3J5SW5kZXggPSBkYXRhLlJlYWRVaW50MzIoMjApOwoKICAgICAgICByZXR1cm4gb3duZXJzaGlwOwogICAgfQp9CgpsaWJyYXJ5IFJvY2tldFR5cGVzCnsKICAgIHVzaW5nIFNlcmlhbGl6ZXIgZm9yIFNlcmlhbGl6ZXIuRGF0YUNvbXBvbmVudDsKCiAgICBzdHJ1Y3QgUm9ja2V0CiAgICB7CiAgICAgICAgdWludDggbV9WZXJzaW9uOyAvLyAwCiAgICAgICAgdWludDggbV9VbnVzZWQxOyAvLyAxCiAgICAgICAgdWludDggbV9Jc0ZvclNhbGU7IC8vIDIKICAgICAgICB1aW50OCBtX1VudXNlZDM7IC8vIDMKCiAgICAgICAgdWludDMyIG1fVG9wU3BlZWQ7IC8vIDQKICAgICAgICB1aW50MzIgbV9UaHJ1c3Q7IC8vIDgKICAgICAgICB1aW50MzIgbV9XZWlnaHQ7IC8vIDEyCiAgICAgICAgdWludDMyIG1fRnVlbENhcGFjaXR5OyAvLyAxNgoKICAgICAgICB1aW50MTYgbV9TdG9ja0lkOyAvLyAyMAogICAgICAgIHVpbnQxNiBtX1VudXNlZDIyOyAvLyAyMgogICAgICAgIHVpbnQ2NCBtX01heERpc3RhbmNlOyAvLyAyNAogICAgfQoKICAgIHN0cnVjdCBTdG9ja1JvY2tldAogICAgewogICAgICAgIGJvb2wgbV9Jc1ZhbGlkOyAvLyAwCiAgICAgICAgdWludDY0IG1fQ29zdDsgLy8gMQoKICAgICAgICB1aW50MzIgbV9NaW5Ub3BTcGVlZDsgLy8gNQogICAgICAgIHVpbnQzMiBtX01heFRvcFNwZWVkOyAvLyA5CgogICAgICAgIHVpbnQzMiBtX01pblRocnVzdDsgLy8gMTMKICAgICAgICB1aW50MzIgbV9NYXhUaHJ1c3Q7IC8vIDE3CgogICAgICAgIHVpbnQzMiBtX01pbldlaWdodDsgLy8gMjEKICAgICAgICB1aW50MzIgbV9NYXhXZWlnaHQ7IC8vIDI1CgogICAgICAgIHVpbnQzMiBtX01pbkZ1ZWxDYXBhY2l0eTsgLy8gMjkKICAgICAgICB1aW50MzIgbV9NYXhGdWVsQ2FwYWNpdHk7IC8vIDMzCgogICAgICAgIHVpbnQ2NCBtX0Rpc3RhbmNlOyAvLyAzNwogICAgfQoKICAgIGZ1bmN0aW9uIFNlcmlhbGl6ZVJvY2tldChSb2NrZXQgcm9ja2V0KSBpbnRlcm5hbCBwdXJlIHJldHVybnMgKGJ5dGVzMzIpCiAgICB7CiAgICAgICAgU2VyaWFsaXplci5EYXRhQ29tcG9uZW50IG1lbW9yeSBkYXRhOwogICAgICAgIGRhdGEuV3JpdGVVaW50OCgwLCByb2NrZXQubV9WZXJzaW9uKTsKICAgICAgICAvL2RhdGEuV3JpdGVVaW50OCgxLCByb2NrZXQubV9VbnVzZWQxKTsKICAgICAgICBkYXRhLldyaXRlVWludDgoMiwgcm9ja2V0Lm1fSXNGb3JTYWxlKTsKICAgICAgICAvL2RhdGEuV3JpdGVVaW50OCgzLCByb2NrZXQubV9VbnVzZWQzKTsKICAgICAgICBkYXRhLldyaXRlVWludDMyKDQsIHJvY2tldC5tX1RvcFNwZWVkKTsKICAgICAgICBkYXRhLldyaXRlVWludDMyKDgsIHJvY2tldC5tX1RocnVzdCk7CiAgICAgICAgZGF0YS5Xcml0ZVVpbnQzMigxMiwgcm9ja2V0Lm1fV2VpZ2h0KTsKICAgICAgICBkYXRhLldyaXRlVWludDMyKDE2LCByb2NrZXQubV9GdWVsQ2FwYWNpdHkpOwogICAgICAgIGRhdGEuV3JpdGVVaW50MTYoMjAsIHJvY2tldC5tX1N0b2NrSWQpOwogICAgICAgIC8vZGF0YS5Xcml0ZVVpbnQxNigyMiwgcm9ja2V0Lm1fVW51c2VkMjIpOwogICAgICAgIGRhdGEuV3JpdGVVaW50NjQoMjQsIHJvY2tldC5tX01heERpc3RhbmNlKTsKCiAgICAgICAgcmV0dXJuIGRhdGEubV9SYXc7CiAgICB9CgogICAgZnVuY3Rpb24gRGVzZXJpYWxpemVSb2NrZXQoYnl0ZXMzMiByYXcpIGludGVybmFsIHB1cmUgcmV0dXJucyAoUm9ja2V0KQogICAgewogICAgICAgIFJvY2tldCBtZW1vcnkgcm9ja2V0OwoKICAgICAgICBTZXJpYWxpemVyLkRhdGFDb21wb25lbnQgbWVtb3J5IGRhdGE7CiAgICAgICAgZGF0YS5tX1JhdyA9IHJhdzsKCiAgICAgICAgcm9ja2V0Lm1fVmVyc2lvbiA9IGRhdGEuUmVhZFVpbnQ4KDApOwogICAgICAgIC8vcm9ja2V0Lm1fVW51c2VkMSA9IGRhdGEuUmVhZFVpbnQ4KDEpOwogICAgICAgIHJvY2tldC5tX0lzRm9yU2FsZSA9IGRhdGEuUmVhZFVpbnQ4KDIpOwogICAgICAgIC8vcm9ja2V0Lm1fVW51c2VkMyA9IGRhdGEuUmVhZFVpbnQ4KDMpOwogICAgICAgIHJvY2tldC5tX1RvcFNwZWVkID0gZGF0YS5SZWFkVWludDMyKDQpOwogICAgICAgIHJvY2tldC5tX1RocnVzdCA9IGRhdGEuUmVhZFVpbnQzMig4KTsKICAgICAgICByb2NrZXQubV9XZWlnaHQgPSBkYXRhLlJlYWRVaW50MzIoMTIpOwogICAgICAgIHJvY2tldC5tX0Z1ZWxDYXBhY2l0eSA9IGRhdGEuUmVhZFVpbnQzMigxNik7CiAgICAgICAgcm9ja2V0Lm1fU3RvY2tJZCA9IGRhdGEuUmVhZFVpbnQxNigyMCk7CiAgICAgICAgLy9yb2NrZXQubV9VbnVzZWQyMiA9IGRhdGEuUmVhZFVpbnQxNigyMik7CiAgICAgICAgcm9ja2V0Lm1fTWF4RGlzdGFuY2UgPSBkYXRhLlJlYWRVaW50NjQoMjQpOwoKICAgICAgICByZXR1cm4gcm9ja2V0OwogICAgfQp9CgpsaWJyYXJ5IFNlcmlhbGl6ZXIKewogICAgc3RydWN0IERhdGFDb21wb25lbnQKICAgIHsKICAgICAgICBieXRlczMyIG1fUmF3OwogICAgfQoKICAgIGZ1bmN0aW9uIFJlYWRVaW50OChEYXRhQ29tcG9uZW50IG1lbW9yeSBzZWxmLCB1aW50MzIgb2Zmc2V0KSBpbnRlcm5hbCBwdXJlIHJldHVybnMgKHVpbnQ4KQogICAgewogICAgICAgIHJldHVybiB1aW50OCgoc2VsZi5tX1JhdyA+PiAob2Zmc2V0ICogOCkpICYgMHhGRik7CiAgICB9CgogICAgZnVuY3Rpb24gV3JpdGVVaW50OChEYXRhQ29tcG9uZW50IG1lbW9yeSBzZWxmLCB1aW50MzIgb2Zmc2V0LCB1aW50OCB2YWx1ZSkgaW50ZXJuYWwgcHVyZQogICAgewogICAgICAgIHNlbGYubV9SYXcgfD0gKGJ5dGVzMzIodmFsdWUpIDw8IChvZmZzZXQgKiA4KSk7CiAgICB9CgogICAgZnVuY3Rpb24gUmVhZFVpbnQxNihEYXRhQ29tcG9uZW50IG1lbW9yeSBzZWxmLCB1aW50MzIgb2Zmc2V0KSBpbnRlcm5hbCBwdXJlIHJldHVybnMgKHVpbnQxNikKICAgIHsKICAgICAgICByZXR1cm4gdWludDE2KChzZWxmLm1fUmF3ID4+IChvZmZzZXQgKiA4KSkgJiAweEZGRkYpOwogICAgfQoKICAgIGZ1bmN0aW9uIFdyaXRlVWludDE2KERhdGFDb21wb25lbnQgbWVtb3J5IHNlbGYsIHVpbnQzMiBvZmZzZXQsIHVpbnQxNiB2YWx1ZSkgaW50ZXJuYWwgcHVyZQogICAgewogICAgICAgIHNlbGYubV9SYXcgfD0gKGJ5dGVzMzIodmFsdWUpIDw8IChvZmZzZXQgKiA4KSk7CiAgICB9CgogICAgZnVuY3Rpb24gUmVhZFVpbnQzMihEYXRhQ29tcG9uZW50IG1lbW9yeSBzZWxmLCB1aW50MzIgb2Zmc2V0KSBpbnRlcm5hbCBwdXJlIHJldHVybnMgKHVpbnQzMikKICAgIHsKICAgICAgICByZXR1cm4gdWludDMyKChzZWxmLm1fUmF3ID4+IChvZmZzZXQgKiA4KSkgJiAweEZGRkZGRkZGKTsKICAgIH0KCiAgICBmdW5jdGlvbiBXcml0ZVVpbnQzMihEYXRhQ29tcG9uZW50IG1lbW9yeSBzZWxmLCB1aW50MzIgb2Zmc2V0LCB1aW50MzIgdmFsdWUpIGludGVybmFsIHB1cmUKICAgIHsKICAgICAgICBzZWxmLm1fUmF3IHw9IChieXRlczMyKHZhbHVlKSA8PCAob2Zmc2V0ICogOCkpOwogICAgfQoKICAgIGZ1bmN0aW9uIFJlYWRVaW50NjQoRGF0YUNvbXBvbmVudCBtZW1vcnkgc2VsZiwgdWludDMyIG9mZnNldCkgaW50ZXJuYWwgcHVyZSByZXR1cm5zICh1aW50NjQpCiAgICB7CiAgICAgICAgcmV0dXJuIHVpbnQ2NCgoc2VsZi5tX1JhdyA+PiAob2Zmc2V0ICogOCkpICYgMHhGRkZGRkZGRkZGRkZGRkZGKTsKICAgIH0KCiAgICBmdW5jdGlvbiBXcml0ZVVpbnQ2NChEYXRhQ29tcG9uZW50IG1lbW9yeSBzZWxmLCB1aW50MzIgb2Zmc2V0LCB1aW50NjQgdmFsdWUpIGludGVybmFsIHB1cmUKICAgIHsKICAgICAgICBzZWxmLm1fUmF3IHw9IChieXRlczMyKHZhbHVlKSA8PCAob2Zmc2V0ICogOCkpOwogICAgfQoKICAgIGZ1bmN0aW9uIFJlYWRVaW50ODAoRGF0YUNvbXBvbmVudCBtZW1vcnkgc2VsZiwgdWludDMyIG9mZnNldCkgaW50ZXJuYWwgcHVyZSByZXR1cm5zICh1aW50ODApCiAgICB7CiAgICAgICAgcmV0dXJuIHVpbnQ4MCgoc2VsZi5tX1JhdyA+PiAob2Zmc2V0ICogOCkpICYgMHhGRkZGRkZGRkZGRkZGRkZGRkZGRik7CiAgICB9CgogICAgZnVuY3Rpb24gV3JpdGVVaW50ODAoRGF0YUNvbXBvbmVudCBtZW1vcnkgc2VsZiwgdWludDMyIG9mZnNldCwgdWludDgwIHZhbHVlKSBpbnRlcm5hbCBwdXJlCiAgICB7CiAgICAgICAgc2VsZi5tX1JhdyB8PSAoYnl0ZXMzMih2YWx1ZSkgPDwgKG9mZnNldCAqIDgpKTsKICAgIH0KCiAgICBmdW5jdGlvbiBSZWFkQWRkcmVzcyhEYXRhQ29tcG9uZW50IG1lbW9yeSBzZWxmLCB1aW50MzIgb2Zmc2V0KSBpbnRlcm5hbCBwdXJlIHJldHVybnMgKGFkZHJlc3MpCiAgICB7CiAgICAgICAgcmV0dXJuIGFkZHJlc3MoKHNlbGYubV9SYXcgPj4gKG9mZnNldCAqIDgpKSAmICgKICAgICAgICAgICAgKDB4RkZGRkZGRkYgPDwgMCkgIHwKICAgICAgICAgICAgKDB4RkZGRkZGRkYgPDwgMzIpIHwKICAgICAgICAgICAgKDB4RkZGRkZGRkYgPDwgNjQpIHwKICAgICAgICAgICAgKDB4RkZGRkZGRkYgPDwgOTYpIHwKICAgICAgICAgICAgKDB4RkZGRkZGRkYgPDwgMTI4KQogICAgICAgICkpOwogICAgfQoKICAgIGZ1bmN0aW9uIFdyaXRlQWRkcmVzcyhEYXRhQ29tcG9uZW50IG1lbW9yeSBzZWxmLCB1aW50MzIgb2Zmc2V0LCBhZGRyZXNzIHZhbHVlKSBpbnRlcm5hbCBwdXJlCiAgICB7CiAgICAgICAgc2VsZi5tX1JhdyB8PSAoYnl0ZXMzMih2YWx1ZSkgPDwgKG9mZnNldCAqIDgpKTsKICAgIH0KfQ=='.
	

]
