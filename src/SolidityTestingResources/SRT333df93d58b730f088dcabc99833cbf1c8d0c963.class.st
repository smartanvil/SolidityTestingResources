Class {
	#name : #SRT333df93d58b730f088dcabc99833cbf1c8d0c963,
	#superclass : #SRTContracts,
	#category : #SolidityTestingResources
}

{ #category : #base64 }
SRT333df93d58b730f088dcabc99833cbf1c8d0c963 >> base64 [
	^ 'cHJhZ21hIHNvbGlkaXR5IF4wLjQuMTg7CgovLyBQcm9qZWN0OiBJbWlnaXplCi8vIHYyLCAyMDE4LTAxLTE0Ci8vIFRoaXMgY29kZSBpcyB0aGUgcHJvcGVydHkgb2YgQ3J5cHRvQjJCLmlvCi8vIENvcHlpbmcgaW4gd2hvbGUgb3IgaW4gcGFydCBpcyBwcm9oaWJpdGVkLgovLyBBdXRob3JzOiBJdmFuIEZlZG9yb3YgYW5kIERtaXRyeSBCb3JvZGluCi8vIERvIHlvdSB3YW50IHRoZSBzYW1lIFRva2VuU2FsZSBwbGF0Zm9ybT8gd3d3LmNyeXB0b2IyYi5pbwoKLy8gKEExKQovLyBUaGUgbWFpbiBjb250cmFjdCBmb3IgdGhlIHNhbGUgYW5kIG1hbmFnZW1lbnQgb2Ygcm91bmRzLgpjb250cmFjdCBDcm93ZHNhbGVMewoKCS8vIEZvciBSb3VuZDAsIGZpcnN0TWludCBpczoKCS8vIDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwNjllMTBkZTc2Njc2ZDA4MDAwMDAKCS8vIChleHRyYSA1MDBLIHRva2VucyBmb3IgbWFya2V0aW5nKQogICAgCiAgICB1c2luZyBTYWZlTWF0aCBmb3IgdWludDI1NjsKCiAgICBlbnVtIFRva2VuU2FsZVR5cGUge3JvdW5kMSwgcm91bmQyfQogICAgZW51bSBSb2xlcyB7YmVuZWZpY2lhcnksIGFjY291bnRhbnQsIG1hbmFnZXIsIG9ic2VydmVyLCBib3VudHksIHRlYW0sIGNvbXBhbnl9CiAgICAKICAgIC8vIEV4dHJhIGZlZQogICAgYWRkcmVzcyBjb25zdGFudCBUYXhDb2xsZWN0b3IgPSAweDA7CgkvLyBmZWUgZm9yIHJvdW5kIDEgJiAyCiAgICB1aW50MjU2WzJdIFRheFZhbHVlcyA9IFswIGZpbm5leSwgMCBmaW5uZXldOwogICAgdWludDggdmF1bHROdW07CgogICAgVG9rZW5MIHB1YmxpYyB0b2tlbjsKCiAgICBib29sIHB1YmxpYyBpc0ZpbmFsaXplZDsKICAgIGJvb2wgcHVibGljIGlzSW5pdGlhbGl6ZWQ7CiAgICBib29sIHB1YmxpYyBpc1BhdXNlZENyb3dkc2FsZTsKCiAgICBtYXBwaW5nICh1aW50OCA9PiBhZGRyZXNzKSBwdWJsaWMgd2FsbGV0czsKCiAgICBzdHJ1Y3QgUHJvZml0ewoJICAgIHVpbnQyNTYgbWluOyAgICAvLyBwZXJjZW50IGZyb20gMCB0byA1MAoJICAgIHVpbnQyNTYgbWF4OyAgICAvLyBwZXJjZW50IGZyb20gMCB0byA1MAoJICAgIHVpbnQyNTYgc3RlcDsgICAvLyBwZXJjZW50IHN0ZXAsIGZyb20gMSB0byA1MCAocGxlYXNlLCByZWFkIGRvYyEpCgkgICAgdWludDI1NiBtYXhBbGxQcm9maXQ7IAogICAgfQogICAgc3RydWN0IEJvbnVzIHsKCSAgICB1aW50MjU2IHZhbHVlOwoJICAgIHVpbnQyNTYgcHJvY2VudDsKCSAgICB1aW50MjU2IGZyZWV6ZVRpbWU7CiAgICB9CgogICAgQm9udXNbXSBwdWJsaWMgYm9udXNlczsKCiAgICBQcm9maXQgcHVibGljIHByb2ZpdCA9IFByb2ZpdCgwLCAyMCwgNSwgMTAwKTsKICAgIAogICAgdWludDI1NiBwdWJsaWMgc3RhcnRUaW1lPSAxNTE1OTc0NDAwOwogICAgdWludDI1NiBwdWJsaWMgZW5kRGlzY291bnRUaW1lID0gMTUyMDI5NDQwMDsKICAgIHVpbnQyNTYgcHVibGljIGVuZFRpbWUgPSAxNTIwMjk0NDAwOwoKICAgIC8vIEhvdyBtYW55IHRva2VucyAoZXhjbHVkaW5nIHRoZSBib251cykgYXJlIHRyYW5zZmVycmVkIHRvIHRoZSBpbnZlc3RvciBpbiBleGNoYW5nZSBmb3IgMSBFVEgKICAgIC8vICoqVEhPVVNBTkRTKiogMTBeMyBmb3IgaHVtYW4sICoxMCoqMyBmb3IgU29saWRpdHksIDFlMyBmb3IgTXlFdGhlcldhbGxldCAoTUVXKS4KICAgIC8vIEV4YW1wbGU6IGlmIDFFVEggPSA0MC41IFRva2VuID09PiB1c2UgNDA1MDAKICAgIHVpbnQyNTYgcHVibGljIHJhdGUgPSA1NjY4MDAwOwoKICAgIC8vIElmIHRoZSByb3VuZCBkb2VzIG5vdCBhdHRhaW4gdGhpcyB2YWx1ZSBiZWZvcmUgdGhlIGNsb3NpbmcgZGF0ZSwgdGhlIHJvdW5kIGlzIHJlY29nbml6ZWQgYXMgYQogICAgLy8gZmFpbHVyZSBhbmQgaW52ZXN0b3JzIHRha2UgdGhlIG1vbmV5IGJhY2sgKHRoZSBmb3VuZGVycyB3aWxsIG5vdCBpbnRlcmZlcmUgaW4gYW55IHdheSkuCiAgICAvLyAqKlFVSU5USUxMSU9OUyoqIDEwXjE4IC8gKjEwKioxOCAvIDFlMTguIEV4YW1wbGU6IHNvZnRjYXA9MTVFVEggPT0+IHVzZSAxNSoxMCoqMTggKFNvbGlkaXR5KSBvciAxNWUxOCAoTUVXKQogICAgdWludDI1NiBwdWJsaWMgc29mdENhcCA9IDAgZXRoZXI7CgogICAgLy8gVGhlIG1heGltdW0gcG9zc2libGUgYW1vdW50IG9mIGluY29tZQogICAgLy8gKipRVUlOVElMTElPTlMqKiAxMF4xOCAvICoxMCoqMTggLyAxZTE4LiBFeGFtcGxlOiBoYXJkY2FwPTEyMy40NUVUSCA9PT4gdXNlIDEyMzQ1MCoxMCoqMTUgKFNvbGlkaXR5KSBvciAxMjM0NWUxNSAoTUVXKQogICAgdWludDI1NiBwdWJsaWMgaGFyZENhcCA9IDgwMiBldGhlcjsKCiAgICAvLyBJZiB0aGUgbGFzdCBwYXltZW50IGlzIHNsaWdodGx5IGhpZ2hlciB0aGFuIHRoZSBoYXJkY2FwLCB0aGVuIHRoZSB1c3VhbCBjb250cmFjdHMgZG8KICAgIC8vIG5vdCBhY2NlcHQgaXQsIGJlY2F1c2UgaXQgZ29lcyBiZXlvbmQgdGhlIGhhcmRjYXAuIEhvd2V2ZXIgaXQgaXMgbW9yZSByZWFzb25hYmxlIHRvIGFjY2VwdCB0aGUKICAgIC8vIGxhc3QgcGF5bWVudCwgdmVyeSBzbGlnaHRseSByYWlzaW5nIHRoZSBoYXJkY2FwLiBUaGUgdmFsdWUgaW5kaWNhdGVzIGJ5IGhvdyBtYW55IEVUSCB0aGUKICAgIC8vIGxhc3QgcGF5bWVudCBjYW4gZXhjZWVkIHRoZSBoYXJkY2FwIHRvIGFsbG93IGl0IHRvIGJlIHBhaWQuIEltbWVkaWF0ZWx5IGFmdGVyIHRoaXMgcGF5bWVudCwgdGhlCiAgICAvLyByb3VuZCBjbG9zZXMuIFRoZSBmdW5kZXJzIHNob3VsZCB3cml0ZSBoZXJlIGEgc21hbGwgbnVtYmVyLCBub3QgbW9yZSB0aGFuIDElIG9mIHRoZSBDQVAuCiAgICAvLyBDYW4gYmUgZXF1YWwgdG8gemVybywgdG8gY2FuY2VsLgogICAgLy8gKipRVUlOVElMTElPTlMqKiAxMF4xOCAvICoxMCoqMTggLyAxZTE4CiAgICB1aW50MjU2IHB1YmxpYyBvdmVyTGltaXQgPSAyMCBldGhlcjsKCiAgICAvLyBUaGUgbWluaW11bSBwb3NzaWJsZSBwYXltZW50IGZyb20gYW4gaW52ZXN0b3IgaW4gRVRILiBQYXltZW50cyBiZWxvdyB0aGlzIHZhbHVlIHdpbGwgYmUgcmVqZWN0ZWQuCiAgICAvLyAqKlFVSU5USUxMSU9OUyoqIDEwXjE4IC8gKjEwKioxOCAvIDFlMTguIEV4YW1wbGU6IG1pblBheT0wLjFFVEggPT0+IHVzZSAxMDAqMTAqKjE1IChTb2xpZGl0eSkgb3IgMTAwZTE1IChNRVcpCiAgICB1aW50MjU2IHB1YmxpYyBtaW5QYXkgPSA3MCBmaW5uZXk7CgogICAgdWludDI1NiBldGhXZWlSYWlzZWQ7CiAgICB1aW50MjU2IG5vbkV0aFdlaVJhaXNlZDsKICAgIHVpbnQyNTYgd2VpUm91bmQxOwogICAgdWludDI1NiBwdWJsaWMgdG9rZW5SZXNlcnZlZDsKCiAgICBSZWZ1bmRWYXVsdCBwdWJsaWMgdmF1bHQ7CiAgICBTVlRBbGxvY2F0aW9uIHB1YmxpYyBsb2NrZWRBbGxvY2F0aW9uOwoKICAgIFRva2VuU2FsZVR5cGUgVG9rZW5TYWxlID0gVG9rZW5TYWxlVHlwZS5yb3VuZDE7CgogICAgdWludDI1NiBhbGxUb2tlbjsKCiAgICBib29sIHB1YmxpYyBib3VudHk7CiAgICBib29sIHB1YmxpYyB0ZWFtOwogICAgYm9vbCBwdWJsaWMgY29tcGFueTsKICAgIC8vYm9vbCBwdWJsaWMgcGFydG5lcnM7CgogICAgZXZlbnQgVG9rZW5QdXJjaGFzZShhZGRyZXNzIGluZGV4ZWQgcHVyY2hhc2VyLCBhZGRyZXNzIGluZGV4ZWQgYmVuZWZpY2lhcnksIHVpbnQyNTYgdmFsdWUsIHVpbnQyNTYgYW1vdW50KTsKCiAgICBldmVudCBGaW5hbGl6ZWQoKTsKICAgIGV2ZW50IEluaXRpYWxpemVkKCk7CgogICAgZnVuY3Rpb24gQ3Jvd2RzYWxlTChUb2tlbkwgX3Rva2VuLCB1aW50MjU2IGZpcnN0TWludCkgcHVibGljCiAgICB7CiAgICAgICAgLy8gSW5pdGlhbGx5LCBhbGwgbmV4dCA3IHJvbGVzL3dhbGxldHMgYXJlIGdpdmVuIHRvIHRoZSBNYW5hZ2VyLiBUaGUgTWFuYWdlciBpcyBhbiBlbXBsb3llZSBvZiB0aGUgY29tcGFueQogICAgICAgIC8vIHdpdGgga25vd2xlZGdlIG9mIElULCB3aG8gcHVibGlzaGVzIHRoZSBjb250cmFjdCBhbmQgc2V0cyBpdCB1cC4gSG93ZXZlciwgbW9uZXkgYW5kIHRva2VucyByZXF1aXJlCiAgICAgICAgLy8gYSBCZW5lZmljaWFyeSBhbmQgb3RoZXIgcm9sZXMgKEFjY291bnRhbnQsIFRlYW0sIGV0Yy4pLiBUaGUgTWFuYWdlciB3aWxsIG5vdCBoYXZlIHRoZSByaWdodAogICAgICAgIC8vIHRvIHJlY2VpdmUgdGhlbS4gVG8gZW5hYmxlIHRoaXMsIHRoZSBNYW5hZ2VyIG11c3QgZWl0aGVyIGVudGVyIHNwZWNpZmljIHdhbGxldHMgaGVyZSwgb3IgcGVyZm9ybQogICAgICAgIC8vIHRoaXMgdmlhIG1ldGhvZCBjaGFuZ2VXYWxsZXQuIEluIHRoZSBmaW5hbGl6YXRpb24gbWV0aG9kcyBpdCBpcyB3cml0dGVuIHdoaWNoIHdhbGxldCBhbmQKICAgICAgICAvLyB3aGF0IHBlcmNlbnRhZ2Ugb2YgdG9rZW5zIGFyZSByZWNlaXZlZC4KCiAgICAgICAgLy8gUmVjZWl2ZXMgYWxsIHRoZSBtb25leSAod2hlbiBmaW5hbGl6aW5nIFJvdW5kMSAmIFJvdW5kMikKICAgICAgICB3YWxsZXRzW3VpbnQ4KFJvbGVzLmJlbmVmaWNpYXJ5KV0gPSAweDA3NTQ0ZWRkZTA1NDI4NTcyNzcxODg1OTg2MDZCMzJGMkMyODA2MkY7IC8vbXNnLnNlbmRlcjsKCiAgICAgICAgLy8gUmVjZWl2ZXMgYWxsIHRoZSB0b2tlbnMgZm9yIG5vbi1FVEggaW52ZXN0b3JzICh3aGVuIGZpbmFsaXppbmcgUm91bmQxICYgUm91bmQyKQogICAgICAgIHdhbGxldHNbdWludDgoUm9sZXMuYWNjb3VudGFudCldID0gMHgzMWU3ODU2OGE1RTUzQzU2ODcxMWRkMTM5RWM5OWQ3NzVFOWZCODBiOyAvL21zZy5zZW5kZXI7CgogICAgICAgIC8vIEFsbCByaWdodHMgZXhjZXB0IHRoZSByaWdodHMgdG8gcmVjZWl2ZSB0b2tlbnMgb3IgbW9uZXkuIEhhcyB0aGUgcmlnaHQgdG8gY2hhbmdlIGFueSBvdGhlcgogICAgICAgIC8vIHdhbGxldHMgKEJlbmVmaWNpYXJ5LCBBY2NvdW50YW50LCAuLi4pLCBidXQgb25seSBpZiB0aGUgcm91bmQgaGFzIG5vdCBzdGFydGVkLiBPbmNlIHRoZQogICAgICAgIC8vIHJvdW5kIGlzIGluaXRpYWxpemVkLCB0aGUgTWFuYWdlciBoYXMgbG9zdCBhbGwgcmlnaHRzIHRvIGNoYW5nZSB0aGUgd2FsbGV0cy4KICAgICAgICAvLyBJZiB0aGUgVG9rZW5TYWxlIGlzIGNvbmR1Y3RlZCBieSBvbmUgcGVyc29uLCB0aGVuIG5vdGhpbmcgbmVlZHMgdG8gYmUgY2hhbmdlZC4gUGVybWl0IGFsbCA3IHJvbGVzCiAgICAgICAgLy8gcG9pbnQgdG8gYSBzaW5nbGUgd2FsbGV0LgogICAgICAgIHdhbGxldHNbdWludDgoUm9sZXMubWFuYWdlcildID0gbXNnLnNlbmRlcjsKCiAgICAgICAgLy8gSGFzIG9ubHkgdGhlIHJpZ2h0IHRvIGNhbGwgcGF5bWVudHNJbk90aGVyQ3VycmVuY3kgKHBsZWFzZSByZWFkIHRoZSBkb2N1bWVudCkKICAgICAgICB3YWxsZXRzW3VpbnQ4KFJvbGVzLm9ic2VydmVyKV0gPSAweDdGRjgzQzY4OENhQzYyZjU5NDRDNjk0Q0YwNGJGM2YzMGVjMTk2MDg7IC8vbXNnLnNlbmRlcjsKCiAgICAgICAgd2FsbGV0c1t1aW50OChSb2xlcy5ib3VudHkpXSA9IDB4MTcxOTRkMmNBNDgxZDI1MzNBMTQ3Nzc2QmVCNDcxREM0MGRjNDU4MDsgLy9tc2cuc2VuZGVyOwoKICAgICAgICAvLyBXaGVuIHRoZSByb3VuZCBpcyBmaW5hbGl6ZWQsIGFsbCB0ZWFtIHRva2VucyBhcmUgdHJhbnNmZXJyZWQgdG8gYSBzcGVjaWFsIGZyZWV6aW5nCiAgICAgICAgLy8gY29udHJhY3QuIEFzIHNvb24gYXMgZGVmcm9zdGluZyBpcyBvdmVyLCBvbmx5IHRoZSBUZWFtIHdhbGxldCB3aWxsIGJlIGFibGUgdG8KICAgICAgICAvLyBjb2xsZWN0IGFsbCB0aGUgdG9rZW5zLiBJdCBkb2VzIG5vdCBzdG9yZSB0aGUgYWRkcmVzcyBvZiB0aGUgZnJlZXppbmcgY29udHJhY3QsCiAgICAgICAgLy8gYnV0IHRoZSBmaW5hbCB3YWxsZXQgb2YgdGhlIHByb2plY3QgdGVhbS4KICAgICAgICB3YWxsZXRzW3VpbnQ4KFJvbGVzLnRlYW0pXSA9IDB4NDQzZjRCZTBmNTBmOTczZTM5NzAzNDNjNkE1MGJjZjFBYzY2YzZDMzsgLy9tc2cuc2VuZGVyOwoKICAgICAgICB3YWxsZXRzW3VpbnQ4KFJvbGVzLmNvbXBhbnkpXSA9IDB4YjRENDI5QjMyNDA2MTZGQTY3RDE1MDljMEMwRTQ4RDExOTAwZGQxODsgLy9tc2cuc2VuZGVyOwoKICAgICAgICB0b2tlbiA9IF90b2tlbjsKICAgICAgICB0b2tlbi5zZXRPd25lcigpOwoKICAgICAgICB0b2tlbi5wYXVzZSgpOyAvLyBibG9jayBleGNoYW5nZSB0b2tlbnMKCiAgICAgICAgdG9rZW4uYWRkVW5wYXVzZWRXYWxsZXQod2FsbGV0c1t1aW50OChSb2xlcy5hY2NvdW50YW50KV0pOwogICAgICAgIHRva2VuLmFkZFVucGF1c2VkV2FsbGV0KG1zZy5zZW5kZXIpOwogICAgICAgIHRva2VuLmFkZFVucGF1c2VkV2FsbGV0KHdhbGxldHNbdWludDgoUm9sZXMuYm91bnR5KV0pOwogICAgICAgIHRva2VuLmFkZFVucGF1c2VkV2FsbGV0KHdhbGxldHNbdWludDgoUm9sZXMuY29tcGFueSldKTsKCiAgICAgICAgaWYgKGZpcnN0TWludCA+IDApIHsKICAgICAgICAgICAgdG9rZW4ubWludChtc2cuc2VuZGVyLCBmaXJzdE1pbnQpOwogICAgICAgIH0KCiAgICB9CgogICAgLy8gUmV0dXJucyB0aGUgbmFtZSBvZiB0aGUgY3VycmVudCByb3VuZCBpbiBwbGFpbiB0ZXh0LiBDb25zdGFudC4KICAgIGZ1bmN0aW9uIGdldFRva2VuU2FsZVR5cGUoKSAgcHVibGljIGNvbnN0YW50IHJldHVybnMoc3RyaW5nKXsKICAgICAgICByZXR1cm4gKFRva2VuU2FsZSA9PSBUb2tlblNhbGVUeXBlLnJvdW5kMSk/J3JvdW5kMSc6J3JvdW5kMic7CiAgICB9CgogICAgLy8gVHJhbnNmZXJzIHRoZSBmdW5kcyBvZiB0aGUgaW52ZXN0b3IgdG8gdGhlIGNvbnRyYWN0IG9mIHJldHVybiBvZiBmdW5kcy4gSW50ZXJuYWwuCiAgICBmdW5jdGlvbiBmb3J3YXJkRnVuZHMoKSBpbnRlcm5hbCB7CiAgICAgICAgdmF1bHQuZGVwb3NpdC52YWx1ZShtc2cudmFsdWUpKG1zZy5zZW5kZXIpOwogICAgfQoKICAgIC8vIENoZWNrIGZvciB0aGUgcG9zc2liaWxpdHkgb2YgYnV5aW5nIHRva2Vucy4gSW5zaWRlLiBDb25zdGFudC4KICAgIGZ1bmN0aW9uIHZhbGlkUHVyY2hhc2UoKSBpbnRlcm5hbCBjb25zdGFudCByZXR1cm5zIChib29sKSB7CgogICAgICAgIC8vIFRoZSByb3VuZCBzdGFydGVkIGFuZCBkaWQgbm90IGVuZAogICAgICAgIGJvb2wgd2l0aGluUGVyaW9kID0gKG5vdyA+IHN0YXJ0VGltZSAmJiBub3cgPCBlbmRUaW1lKTsKCiAgICAgICAgLy8gUmF0ZSBpcyBncmVhdGVyIHRoYW4gb3IgZXF1YWwgdG8gdGhlIG1pbmltdW0KICAgICAgICBib29sIG5vblplcm9QdXJjaGFzZSA9IG1zZy52YWx1ZSA+PSBtaW5QYXk7CgogICAgICAgIC8vIGhhcmRDYXAgaXMgbm90IHJlYWNoZWQsIGFuZCBpbiB0aGUgZXZlbnQgb2YgYSB0cmFuc2FjdGlvbiwgaXQgd2lsbCBub3QgYmUgZXhjZWVkZWQgYnkgbW9yZSB0aGFuIE92ZXJMaW1pdAogICAgICAgIGJvb2wgd2l0aGluQ2FwID0gbXNnLnZhbHVlIDw9IGhhcmRDYXAuc3ViKHdlaVJhaXNlZCgpKS5hZGQob3ZlckxpbWl0KTsKCiAgICAgICAgLy8gcm91bmQgaXMgaW5pdGlhbGl6ZWQgYW5kIG5vICJQYXVzZSBvZiB0cmFkaW5nIiBpcyBzZXQKICAgICAgICByZXR1cm4gd2l0aGluUGVyaW9kICYmIG5vblplcm9QdXJjaGFzZSAmJiB3aXRoaW5DYXAgJiYgaXNJbml0aWFsaXplZCAmJiAhaXNQYXVzZWRDcm93ZHNhbGU7CiAgICB9CgogICAgLy8gQ2hlY2sgZm9yIHRoZSBhYmlsaXR5IHRvIGZpbmFsaXplIHRoZSByb3VuZC4gQ29uc3RhbnQuCiAgICBmdW5jdGlvbiBoYXNFbmRlZCgpIHB1YmxpYyBjb25zdGFudCByZXR1cm5zIChib29sKSB7CgogICAgICAgIGJvb2wgdGltZVJlYWNoZWQgPSBub3cgPiBlbmRUaW1lOwoKICAgICAgICBib29sIGNhcFJlYWNoZWQgPSB3ZWlSYWlzZWQoKSA+PSBoYXJkQ2FwOwoKICAgICAgICByZXR1cm4gKHRpbWVSZWFjaGVkIHx8IGNhcFJlYWNoZWQpICYmIGlzSW5pdGlhbGl6ZWQ7CiAgICB9CiAgICAKICAgIGZ1bmN0aW9uIGZpbmFsaXplQWxsKCkgZXh0ZXJuYWwgewogICAgICAgIGZpbmFsaXplKCk7CiAgICAgICAgZmluYWxpemUxKCk7CiAgICAgICAgZmluYWxpemUyKCk7CiAgICAgICAgZmluYWxpemUzKCk7CiAgICB9CgogICAgLy8gRmluYWxpemUuIE9ubHkgYXZhaWxhYmxlIHRvIHRoZSBNYW5hZ2VyIGFuZCB0aGUgQmVuZWZpY2lhcnkuIElmIHRoZSByb3VuZCBmYWlsZWQsIHRoZW4KICAgIC8vIGFueW9uZSBjYW4gY2FsbCB0aGUgZmluYWxpemF0aW9uIHRvIHVubG9jayB0aGUgcmV0dXJuIG9mIGZ1bmRzIHRvIGludmVzdG9ycwogICAgLy8gWW91IG11c3QgY2FsbCBhIGZ1bmN0aW9uIHRvIGZpbmFsaXplIGVhY2ggcm91bmQgKGFmdGVyIHRoZSBSb3VuZDEgJiBhZnRlciB0aGUgUm91bmQyKQogICAgZnVuY3Rpb24gZmluYWxpemUoKSBwdWJsaWMgewoKICAgICAgICByZXF1aXJlKHdhbGxldHNbdWludDgoUm9sZXMubWFuYWdlcildID09IG1zZy5zZW5kZXIgfHwgd2FsbGV0c1t1aW50OChSb2xlcy5iZW5lZmljaWFyeSldID09IG1zZy5zZW5kZXIgfHwgIWdvYWxSZWFjaGVkKCkpOwogICAgICAgIHJlcXVpcmUoIWlzRmluYWxpemVkKTsKICAgICAgICByZXF1aXJlKGhhc0VuZGVkKCkpOwoKICAgICAgICBpc0ZpbmFsaXplZCA9IHRydWU7CiAgICAgICAgZmluYWxpemF0aW9uKCk7CiAgICAgICAgRmluYWxpemVkKCk7CiAgICB9CgogICAgLy8gVGhlIGxvZ2ljIG9mIGZpbmFsaXphdGlvbi4gSW50ZXJuYWwKICAgIGZ1bmN0aW9uIGZpbmFsaXphdGlvbigpIGludGVybmFsIHsKCiAgICAgICAgLy8gSWYgdGhlIGdvYWwgb2YgdGhlIGFjaGlldmVtZW50CiAgICAgICAgaWYgKGdvYWxSZWFjaGVkKCkpIHsKCiAgICAgICAgICAgIC8vIFNlbmQgZXRoZXIgdG8gQmVuZWZpY2lhcnkKICAgICAgICAgICAgdmF1bHQuY2xvc2Uod2FsbGV0c1t1aW50OChSb2xlcy5iZW5lZmljaWFyeSldKTsKCiAgICAgICAgICAgIC8vIGlmIHRoZXJlIGlzIGFueXRoaW5nIHRvIGdpdmUKICAgICAgICAgICAgaWYgKHRva2VuUmVzZXJ2ZWQgPiAwKSB7CgogICAgICAgICAgICAgICAgLy8gSXNzdWUgdG9rZW5zIG9mIG5vbi1ldGggaW52ZXN0b3JzIHRvIEFjY291bnRhbnQgYWNjb3VudAogICAgICAgICAgICAgICAgdG9rZW4ubWludCh3YWxsZXRzW3VpbnQ4KFJvbGVzLmFjY291bnRhbnQpXSx0b2tlblJlc2VydmVkKTsKCiAgICAgICAgICAgICAgICAvLyBSZXNldCB0aGUgY291bnRlcgogICAgICAgICAgICAgICAgdG9rZW5SZXNlcnZlZCA9IDA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIElmIHRoZSBmaW5hbGl6YXRpb24gaXMgUm91bmQgMQogICAgICAgICAgICBpZiAoVG9rZW5TYWxlID09IFRva2VuU2FsZVR5cGUucm91bmQxKSB7CgogICAgICAgICAgICAgICAgLy8gUmVzZXQgc2V0dGluZ3MKICAgICAgICAgICAgICAgIGlzSW5pdGlhbGl6ZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgIGlzRmluYWxpemVkID0gZmFsc2U7CgogICAgICAgICAgICAgICAgLy8gU3dpdGNoIHRvIHRoZSBzZWNvbmQgcm91bmQgKHRvIFJvdW5kMikKICAgICAgICAgICAgICAgIFRva2VuU2FsZSA9IFRva2VuU2FsZVR5cGUucm91bmQyOwoKICAgICAgICAgICAgICAgIC8vIFJlc2V0IHRoZSBjb2xsZWN0aW9uIGNvdW50ZXIKICAgICAgICAgICAgICAgIHdlaVJvdW5kMSA9IHdlaVJhaXNlZCgpOwogICAgICAgICAgICAgICAgZXRoV2VpUmFpc2VkID0gMDsKICAgICAgICAgICAgICAgIG5vbkV0aFdlaVJhaXNlZCA9IDA7CgoKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIC8vIElmIHRoZSBzZWNvbmQgcm91bmQgaXMgZmluYWxpemVkCiAgICAgICAgICAgIHsKCiAgICAgICAgICAgICAgICAvLyBSZWNvcmQgaG93IG1hbnkgdG9rZW5zIHdlIGhhdmUgaXNzdWVkCiAgICAgICAgICAgICAgICBhbGxUb2tlbiA9IHRva2VuLnRvdGFsU3VwcGx5KCk7CgogICAgICAgICAgICAgICAgLy8gUGVybWlzc2lvbiB0byBjb2xsZWN0IHRva2VucyB0byB0aG9zZSB3aG8gY2FuIHBpY2sgdGhlbSB1cAogICAgICAgICAgICAgICAgYm91bnR5ID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRlYW0gPSB0cnVlOwogICAgICAgICAgICAgICAgY29tcGFueSA9IHRydWU7CiAgICAgICAgICAgICAgICAvL3BhcnRuZXJzID0gdHJ1ZTsKCiAgICAgICAgICAgIH0KCiAgICAgICAgfQogICAgICAgIGVsc2UgLy8gSWYgdGhleSBmYWlsZWQgcm91bmQKICAgICAgICB7CiAgICAgICAgICAgIC8vIEFsbG93IGludmVzdG9ycyB0byB3aXRoZHJhdyB0aGVpciBmdW5kcwogICAgICAgICAgICB2YXVsdC5lbmFibGVSZWZ1bmRzKCk7CiAgICAgICAgfQogICAgfQoKICAgIC8vIFRoZSBNYW5hZ2VyIGZyZWV6ZXMgdGhlIHRva2VucyBmb3IgdGhlIFRlYW0uCiAgICAvLyBZb3UgbXVzdCBjYWxsIGEgZnVuY3Rpb24gdG8gZmluYWxpemUgUm91bmQgMiAob25seSBhZnRlciB0aGUgUm91bmQyKQogICAgZnVuY3Rpb24gZmluYWxpemUxKCkgcHVibGljIHsKICAgICAgICByZXF1aXJlKHdhbGxldHNbdWludDgoUm9sZXMubWFuYWdlcildID09IG1zZy5zZW5kZXIgfHwgd2FsbGV0c1t1aW50OChSb2xlcy5iZW5lZmljaWFyeSldID09IG1zZy5zZW5kZXIpOwogICAgICAgIHJlcXVpcmUodGVhbSk7CiAgICAgICAgdGVhbSA9IGZhbHNlOwogICAgICAgIGxvY2tlZEFsbG9jYXRpb24gPSBuZXcgU1ZUQWxsb2NhdGlvbih0b2tlbiwgd2FsbGV0c1t1aW50OChSb2xlcy50ZWFtKV0pOwogICAgICAgIHRva2VuLmFkZFVucGF1c2VkV2FsbGV0KGxvY2tlZEFsbG9jYXRpb24pOwogICAgICAgIC8vIDEyJSAtIHRva2VucyB0byBUZWFtIHdhbGxldCBhZnRlciBmcmVlemUgKDc3JSBmb3IgaW52ZXN0b3JzKQogICAgICAgIC8vICoqKiBDSEVDSyBUSEVTRSBOVU1CRVJTICoqKgogICAgICAgIHRva2VuLm1pbnQobG9ja2VkQWxsb2NhdGlvbixhbGxUb2tlbi5tdWwoMTIpLmRpdig3NykpOwogICAgfQoKICAgIGZ1bmN0aW9uIGZpbmFsaXplMigpIHB1YmxpYyB7CiAgICAgICAgcmVxdWlyZSh3YWxsZXRzW3VpbnQ4KFJvbGVzLm1hbmFnZXIpXSA9PSBtc2cuc2VuZGVyIHx8IHdhbGxldHNbdWludDgoUm9sZXMuYmVuZWZpY2lhcnkpXSA9PSBtc2cuc2VuZGVyKTsKICAgICAgICByZXF1aXJlKGJvdW50eSk7CiAgICAgICAgYm91bnR5ID0gZmFsc2U7CiAgICAgICAgLy8gMiUgLSB0b2tlbnMgdG8gYm91bnR5IHdhbGxldCBhZnRlciBmcmVlemUgKDc3JSBmb3IgaW52ZXN0b3JzKQogICAgICAgIC8vICoqKiBDSEVDSyBUSEVTRSBOVU1CRVJTICoqKgogICAgICAgIHRva2VuLm1pbnQod2FsbGV0c1t1aW50OChSb2xlcy5ib3VudHkpXSxhbGxUb2tlbi5tdWwoMikuZGl2KDc3KSk7CiAgICB9CgogICAgLy8gRm9yIG1hcmtldGluZywgcmVmZXJyYWwsIHJlc2VydmUgCiAgICAvLyBZb3UgbXVzdCBjYWxsIGEgZnVuY3Rpb24gdG8gZmluYWxpemUgUm91bmQgMiAob25seSBhZnRlciB0aGUgUm91bmQyKQogICAgZnVuY3Rpb24gZmluYWxpemUzKCkgcHVibGljIHsKICAgICAgICByZXF1aXJlKHdhbGxldHNbdWludDgoUm9sZXMubWFuYWdlcildID09IG1zZy5zZW5kZXIgfHwgd2FsbGV0c1t1aW50OChSb2xlcy5iZW5lZmljaWFyeSldID09IG1zZy5zZW5kZXIpOwogICAgICAgIHJlcXVpcmUoY29tcGFueSk7CiAgICAgICAgY29tcGFueSA9IGZhbHNlOwogICAgICAgIC8vIDklIC0gdG9rZW5zIHRvIGNvbXBhbnkgd2FsbGV0IGFmdGVyIGZyZWV6ZSAoNzclIGZvciBpbnZlc3RvcnMpCiAgICAgICAgLy8gKioqIENIRUNLIFRIRVNFIE5VTUJFUlMgKioqCiAgICAgICAgdG9rZW4ubWludCh3YWxsZXRzW3VpbnQ4KFJvbGVzLmNvbXBhbnkpXSxhbGxUb2tlbi5tdWwoOSkuZGl2KDc3KSk7CiAgICB9CgoKICAgIC8vIEluaXRpYWxpemluZyB0aGUgcm91bmQuIEF2YWlsYWJsZSB0byB0aGUgbWFuYWdlci4gQWZ0ZXIgY2FsbGluZyB0aGUgZnVuY3Rpb24sCiAgICAvLyB0aGUgTWFuYWdlciBsb3NlcyBhbGwgcmlnaHRzOiBNYW5hZ2VyIGNhbiBub3QgY2hhbmdlIHRoZSBzZXR0aW5ncyAoc2V0dXApLCBjaGFuZ2UKICAgIC8vIHdhbGxldHMsIHByZXZlbnQgdGhlIGJlZ2lubmluZyBvZiB0aGUgcm91bmQsIGV0Yy4gWW91IG11c3QgY2FsbCBhIGZ1bmN0aW9uIGFmdGVyIHNldHVwCiAgICAvLyBmb3IgdGhlIGluaXRpYWwgcm91bmQgKGJlZm9yZSB0aGUgUm91bmQxIGFuZCBiZWZvcmUgdGhlIFJvdW5kMikKICAgIGZ1bmN0aW9uIGluaXRpYWxpemUoKSBwdWJsaWMgewoKICAgICAgICAvLyBPbmx5IHRoZSBNYW5hZ2VyCiAgICAgICAgcmVxdWlyZSh3YWxsZXRzW3VpbnQ4KFJvbGVzLm1hbmFnZXIpXSA9PSBtc2cuc2VuZGVyKTsKCiAgICAgICAgLy8gSWYgbm90IHlldCBpbml0aWFsaXplZAogICAgICAgIHJlcXVpcmUoIWlzSW5pdGlhbGl6ZWQpOwoKICAgICAgICAvLyBBbmQgdGhlIHNwZWNpZmllZCBzdGFydCB0aW1lIGhhcyBub3QgeWV0IGNvbWUKICAgICAgICAvLyBJZiBpbml0aWFsaXphdGlvbiByZXR1cm4gYW4gZXJyb3IsIGNoZWNrIHRoZSBzdGFydCBkYXRlIQogICAgICAgIHJlcXVpcmUobm93IDw9IHN0YXJ0VGltZSk7CgogICAgICAgIGluaXRpYWxpemF0aW9uKCk7CgogICAgICAgIEluaXRpYWxpemVkKCk7CgogICAgICAgIGlzSW5pdGlhbGl6ZWQgPSB0cnVlOwogICAgfQoKICAgIGZ1bmN0aW9uIGluaXRpYWxpemF0aW9uKCkgaW50ZXJuYWwgewogICAgICAgIHVpbnQyNTYgdGF4VmFsdWUgPSBUYXhWYWx1ZXNbdmF1bHROdW1dOwogICAgICAgIHZhdWx0TnVtKys7CiAgICAgICAgdWludDI1NiBhcnJlYXI7CiAgICAgICAgaWYgKGFkZHJlc3ModmF1bHQpICE9IDB4MCl7CiAgICAgICAgICAgIGFycmVhciA9IERpc3RyaWJ1dG9yUmVmdW5kVmF1bHQodmF1bHQpLnRheFZhbHVlKCk7CiAgICAgICAgICAgIHZhdWx0LmRlbCh3YWxsZXRzW3VpbnQ4KFJvbGVzLmJlbmVmaWNpYXJ5KV0pOwogICAgICAgIH0KICAgICAgICB2YXVsdCA9IG5ldyBEaXN0cmlidXRvclJlZnVuZFZhdWx0KFRheENvbGxlY3RvciwgdGF4VmFsdWUuYWRkKGFycmVhcikpOwogICAgfQoKICAgIC8vIEF0IHRoZSByZXF1ZXN0IG9mIHRoZSBpbnZlc3Rvciwgd2UgcmFpc2UgdGhlIGZ1bmRzIChpZiB0aGUgcm91bmQgaGFzIGZhaWxlZCBiZWNhdXNlIG9mIHRoZSBoYXJkY2FwKQogICAgZnVuY3Rpb24gY2xhaW1SZWZ1bmQoKSBwdWJsaWN7CiAgICAgICAgdmF1bHQucmVmdW5kKG1zZy5zZW5kZXIpOwogICAgfQoKICAgIC8vIFdlIGNoZWNrIHdoZXRoZXIgd2UgY29sbGVjdGVkIHRoZSBuZWNlc3NhcnkgbWluaW11bSBmdW5kcy4gQ29uc3RhbnQuCiAgICBmdW5jdGlvbiBnb2FsUmVhY2hlZCgpIHB1YmxpYyBjb25zdGFudCByZXR1cm5zIChib29sKSB7CiAgICAgICAgcmV0dXJuIHdlaVJhaXNlZCgpID49IHNvZnRDYXA7CiAgICB9CgogICAgLy8gQ3VzdG9taXplLiBUaGUgYXJndW1lbnRzIGFyZSBkZXNjcmliZWQgaW4gdGhlIGNvbnN0cnVjdG9yIGFib3ZlLgogICAgZnVuY3Rpb24gc2V0dXAodWludDI1NiBfc3RhcnRUaW1lLCB1aW50MjU2IF9lbmREaXNjb3VudFRpbWUsIHVpbnQyNTYgX2VuZFRpbWUsIHVpbnQyNTYgX3NvZnRDYXAsIHVpbnQyNTYgX2hhcmRDYXAsIHVpbnQyNTYgX3JhdGUsIHVpbnQyNTYgX292ZXJMaW1pdCwgdWludDI1NiBfbWluUGF5LCB1aW50MjU2IF9taW5Qcm9maXQsIHVpbnQyNTYgX21heFByb2ZpdCwgdWludDI1NiBfc3RlcFByb2ZpdCwgdWludDI1NiBfbWF4QWxsUHJvZml0LCB1aW50MjU2W10gX3ZhbHVlLCB1aW50MjU2W10gX3Byb2NlbnQsIHVpbnQyNTZbXSBfZnJlZXplVGltZSkgcHVibGljewogICAgICAgIGNoYW5nZVBlcmlvZChfc3RhcnRUaW1lLCBfZW5kRGlzY291bnRUaW1lLCBfZW5kVGltZSk7CiAgICAgICAgY2hhbmdlVGFyZ2V0cyhfc29mdENhcCwgX2hhcmRDYXApOwogICAgICAgIGNoYW5nZVJhdGUoX3JhdGUsIF9vdmVyTGltaXQsIF9taW5QYXkpOwogICAgICAgIGNoYW5nZURpc2NvdW50KF9taW5Qcm9maXQsIF9tYXhQcm9maXQsIF9zdGVwUHJvZml0LCBfbWF4QWxsUHJvZml0KTsKICAgICAgICBzZXRCb251c2VzKF92YWx1ZSwgX3Byb2NlbnQsIF9mcmVlemVUaW1lKTsKICAgIH0KCiAgICAvLyBDaGFuZ2UgdGhlIGRhdGUgYW5kIHRpbWU6IHRoZSBiZWdpbm5pbmcgb2YgdGhlIHJvdW5kLCB0aGUgZW5kIG9mIHRoZSBib251cywgdGhlIGVuZCBvZiB0aGUgcm91bmQuIEF2YWlsYWJsZSB0byBNYW5hZ2VyCiAgICAvLyBEZXNjcmlwdGlvbiBpbiB0aGUgQ3Jvd2RzYWxlIGNvbnN0cnVjdG9yCiAgICBmdW5jdGlvbiBjaGFuZ2VQZXJpb2QodWludDI1NiBfc3RhcnRUaW1lLCB1aW50MjU2IF9lbmREaXNjb3VudFRpbWUsIHVpbnQyNTYgX2VuZFRpbWUpIHB1YmxpY3sKCiAgICAgICAgcmVxdWlyZSh3YWxsZXRzW3VpbnQ4KFJvbGVzLm1hbmFnZXIpXSA9PSBtc2cuc2VuZGVyKTsKCiAgICAgICAgcmVxdWlyZSghaXNJbml0aWFsaXplZCk7CgogICAgICAgIC8vIERhdGUgYW5kIHRpbWUgYXJlIGNvcnJlY3QKICAgICAgICByZXF1aXJlKG5vdyA8PSBfc3RhcnRUaW1lKTsKICAgICAgICByZXF1aXJlKF9lbmREaXNjb3VudFRpbWUgPiBfc3RhcnRUaW1lICYmIF9lbmREaXNjb3VudFRpbWUgPD0gX2VuZFRpbWUpOwoKICAgICAgICBzdGFydFRpbWUgPSBfc3RhcnRUaW1lOwogICAgICAgIGVuZFRpbWUgPSBfZW5kVGltZTsKICAgICAgICBlbmREaXNjb3VudFRpbWUgPSBfZW5kRGlzY291bnRUaW1lOwoKICAgIH0KCiAgICAvLyBXZSBjaGFuZ2UgdGhlIHB1cnBvc2Ugb2YgcmFpc2luZyBmdW5kcy4gQXZhaWxhYmxlIHRvIHRoZSBtYW5hZ2VyLgogICAgLy8gRGVzY3JpcHRpb24gaW4gdGhlIENyb3dkc2FsZSBjb25zdHJ1Y3Rvci4KICAgIGZ1bmN0aW9uIGNoYW5nZVRhcmdldHModWludDI1NiBfc29mdENhcCwgdWludDI1NiBfaGFyZENhcCkgcHVibGljIHsKCiAgICAgICAgcmVxdWlyZSh3YWxsZXRzW3VpbnQ4KFJvbGVzLm1hbmFnZXIpXSA9PSBtc2cuc2VuZGVyKTsKCiAgICAgICAgcmVxdWlyZSghaXNJbml0aWFsaXplZCk7CgogICAgICAgIC8vIFRoZSBwYXJhbWV0ZXJzIGFyZSBjb3JyZWN0CiAgICAgICAgcmVxdWlyZShfc29mdENhcCA8PSBfaGFyZENhcCk7CgogICAgICAgIHNvZnRDYXAgPSBfc29mdENhcDsKICAgICAgICBoYXJkQ2FwID0gX2hhcmRDYXA7CiAgICB9CgogICAgLy8gQ2hhbmdlIHRoZSBwcmljZSAodGhlIG51bWJlciBvZiB0b2tlbnMgcGVyIDEgZXRoKSwgdGhlIG1heGltdW0gaGFyZENhcCBmb3IgdGhlIGxhc3QgYmV0LAogICAgLy8gdGhlIG1pbmltdW0gYmV0LiBBdmFpbGFibGUgdG8gdGhlIE1hbmFnZXIuCiAgICAvLyBEZXNjcmlwdGlvbiBpbiB0aGUgQ3Jvd2RzYWxlIGNvbnN0cnVjdG9yCiAgICBmdW5jdGlvbiBjaGFuZ2VSYXRlKHVpbnQyNTYgX3JhdGUsIHVpbnQyNTYgX292ZXJMaW1pdCwgdWludDI1NiBfbWluUGF5KSBwdWJsaWMgewoKICAgICAgICByZXF1aXJlKHdhbGxldHNbdWludDgoUm9sZXMubWFuYWdlcildID09IG1zZy5zZW5kZXIpOwoKICAgICAgICByZXF1aXJlKCFpc0luaXRpYWxpemVkKTsKCiAgICAgICAgcmVxdWlyZShfcmF0ZSA+IDApOwoKICAgICAgICByYXRlID0gX3JhdGU7CiAgICAgICAgb3ZlckxpbWl0ID0gX292ZXJMaW1pdDsKICAgICAgICBtaW5QYXkgPSBfbWluUGF5OwogICAgfQoKICAgIC8vIFdlIGNoYW5nZSB0aGUgcGFyYW1ldGVycyBvZiB0aGUgZGlzY291bnQ6JSBtaW4gYm9udXMsJSBtYXggYm9udXMsIG51bWJlciBvZiBzdGVwcy4KICAgIC8vIEF2YWlsYWJsZSB0byB0aGUgbWFuYWdlci4gRGVzY3JpcHRpb24gaW4gdGhlIENyb3dkc2FsZSBjb25zdHJ1Y3RvcgogICAgZnVuY3Rpb24gY2hhbmdlRGlzY291bnQodWludDI1NiBfbWluUHJvZml0LCB1aW50MjU2IF9tYXhQcm9maXQsIHVpbnQyNTYgX3N0ZXBQcm9maXQsIHVpbnQyNTYgX21heEFsbFByb2ZpdCkgcHVibGljIHsKCiAgICAgICAgcmVxdWlyZSh3YWxsZXRzW3VpbnQ4KFJvbGVzLm1hbmFnZXIpXSA9PSBtc2cuc2VuZGVyKTsKCiAgICAgICAgcmVxdWlyZSghaXNJbml0aWFsaXplZCk7CiAgICAgICAgCiAgICAgICAgcmVxdWlyZShfbWF4UHJvZml0IDw9IF9tYXhBbGxQcm9maXQpOwoKICAgICAgICAvLyBUaGUgcGFyYW1ldGVycyBhcmUgY29ycmVjdAogICAgICAgIHJlcXVpcmUoX3N0ZXBQcm9maXQgPD0gX21heFByb2ZpdC5zdWIoX21pblByb2ZpdCkpOwoKICAgICAgICAvLyBJZiBub3QgemVybyBzdGVwcwogICAgICAgIGlmKF9zdGVwUHJvZml0ID4gMCl7CiAgICAgICAgICAgIC8vIFdlIHdpbGwgc3BlY2lmeSB0aGUgbWF4aW11bSBwZXJjZW50YWdlIGF0IHdoaWNoIGl0IGlzIHBvc3NpYmxlIHRvIHByb3ZpZGUKICAgICAgICAgICAgLy8gdGhlIHNwZWNpZmllZCBudW1iZXIgb2Ygc3RlcHMgd2l0aG91dCBmcmFjdGlvbmFsIHBhcnRzCiAgICAgICAgICAgIHByb2ZpdC5tYXggPSBfbWF4UHJvZml0LnN1YihfbWluUHJvZml0KS5kaXYoX3N0ZXBQcm9maXQpLm11bChfc3RlcFByb2ZpdCkuYWRkKF9taW5Qcm9maXQpOwogICAgICAgIH1lbHNlewogICAgICAgICAgICAvLyB0byBhdm9pZCBhIGRpdmlkZSB0byB6ZXJvIGVycm9yLCBzZXQgdGhlIGJvbnVzIGFzIHN0YXRpYwogICAgICAgICAgICBwcm9maXQubWF4ID0gX21pblByb2ZpdDsKICAgICAgICB9CgogICAgICAgIHByb2ZpdC5taW4gPSBfbWluUHJvZml0OwogICAgICAgIHByb2ZpdC5zdGVwID0gX3N0ZXBQcm9maXQ7CiAgICAgICAgcHJvZml0Lm1heEFsbFByb2ZpdCA9IF9tYXhBbGxQcm9maXQ7CiAgICB9CgogICAgZnVuY3Rpb24gc2V0Qm9udXNlcyh1aW50MjU2W10gX3ZhbHVlLCB1aW50MjU2W10gX3Byb2NlbnQsIHVpbnQyNTZbXSBfZGF0ZVVuZnJlZXplKSBwdWJsaWMgewoKICAgICAgICByZXF1aXJlKHdhbGxldHNbdWludDgoUm9sZXMubWFuYWdlcildID09IG1zZy5zZW5kZXIpOwogICAgICAgIHJlcXVpcmUoIWlzSW5pdGlhbGl6ZWQpOwoKICAgICAgICByZXF1aXJlKF92YWx1ZS5sZW5ndGggPT0gX3Byb2NlbnQubGVuZ3RoICYmIF92YWx1ZS5sZW5ndGggPT0gX2RhdGVVbmZyZWV6ZS5sZW5ndGgpOwogICAgICAgIGJvbnVzZXMubGVuZ3RoID0gX3ZhbHVlLmxlbmd0aDsKICAgICAgICBmb3IodWludDI1NiBpID0gMDsgaSA8IF92YWx1ZS5sZW5ndGg7IGkrKyl7CiAgICAgICAgICAgIGJvbnVzZXNbaV0gPSBCb251cyhfdmFsdWVbaV0sX3Byb2NlbnRbaV0sX2RhdGVVbmZyZWV6ZVtpXSk7CiAgICAgICAgfQogICAgfQoKICAgIC8vIENvbGxlY3RlZCBmdW5kcyBmb3IgdGhlIGN1cnJlbnQgcm91bmQuIENvbnN0YW50LgogICAgZnVuY3Rpb24gd2VpUmFpc2VkKCkgcHVibGljIGNvbnN0YW50IHJldHVybnModWludDI1Nil7CiAgICAgICAgcmV0dXJuIGV0aFdlaVJhaXNlZC5hZGQobm9uRXRoV2VpUmFpc2VkKTsKICAgIH0KCiAgICAvLyBSZXR1cm5zIHRoZSBhbW91bnQgb2YgZmVlcyBmb3IgYm90aCBwaGFzZXMuIENvbnN0YW50LgogICAgZnVuY3Rpb24gd2VpVG90YWxSYWlzZWQoKSBwdWJsaWMgY29uc3RhbnQgcmV0dXJucyh1aW50MjU2KXsKICAgICAgICByZXR1cm4gd2VpUm91bmQxLmFkZCh3ZWlSYWlzZWQoKSk7CiAgICB9CgogICAgLy8gUmV0dXJucyB0aGUgcGVyY2VudGFnZSBvZiB0aGUgYm9udXMgb24gdGhlIGN1cnJlbnQgZGF0ZS4gQ29uc3RhbnQuCiAgICBmdW5jdGlvbiBnZXRQcm9maXRQZXJjZW50KCkgcHVibGljIGNvbnN0YW50IHJldHVybnMgKHVpbnQyNTYpewogICAgICAgIHJldHVybiBnZXRQcm9maXRQZXJjZW50Rm9yRGF0YShub3cpOwogICAgfQoKICAgIC8vIFJldHVybnMgdGhlIHBlcmNlbnRhZ2Ugb2YgdGhlIGJvbnVzIG9uIHRoZSBnaXZlbiBkYXRlLiBDb25zdGFudC4KICAgIGZ1bmN0aW9uIGdldFByb2ZpdFBlcmNlbnRGb3JEYXRhKHVpbnQyNTYgdGltZU5vdykgcHVibGljIGNvbnN0YW50IHJldHVybnMgKHVpbnQyNTYpewogICAgICAgIC8vIGlmIHRoZSBkaXNjb3VudCBpcyAwIG9yIHplcm8gc3RlcHMsIG9yIHRoZSByb3VuZCBkb2VzIG5vdCBzdGFydCwgd2UgcmV0dXJuIHRoZSBtaW5pbXVtIGRpc2NvdW50CiAgICAgICAgaWYgKHByb2ZpdC5tYXggPT0gMCB8fCBwcm9maXQuc3RlcCA9PSAwIHx8IHRpbWVOb3cgPiBlbmREaXNjb3VudFRpbWUpewogICAgICAgICAgICByZXR1cm4gcHJvZml0Lm1pbjsKICAgICAgICB9CgogICAgICAgIC8vIGlmIHRoZSByb3VuZCBpcyBvdmVyIC0gdGhlIG1heGltdW0KICAgICAgICBpZiAodGltZU5vdzw9c3RhcnRUaW1lKXsKICAgICAgICAgICAgcmV0dXJuIHByb2ZpdC5tYXg7CiAgICAgICAgfQoKICAgICAgICAvLyBib251cyBwZXJpb2QKICAgICAgICB1aW50MjU2IHJhbmdlID0gZW5kRGlzY291bnRUaW1lLnN1YihzdGFydFRpbWUpOwoKICAgICAgICAvLyBkZWx0YSBib251cyBwZXJjZW50YWdlCiAgICAgICAgdWludDI1NiBwcm9maXRSYW5nZSA9IHByb2ZpdC5tYXguc3ViKHByb2ZpdC5taW4pOwoKICAgICAgICAvLyBUaW1lIGxlZnQKICAgICAgICB1aW50MjU2IHRpbWVSZXN0ID0gZW5kRGlzY291bnRUaW1lLnN1Yih0aW1lTm93KTsKCiAgICAgICAgLy8gRGl2aWRlIHRoZSBkZWx0YSBvZiB0aW1lIGludG8KICAgICAgICB1aW50MjU2IHByb2ZpdFByb2NlbnQgPSBwcm9maXRSYW5nZS5kaXYocHJvZml0LnN0ZXApLm11bCh0aW1lUmVzdC5tdWwocHJvZml0LnN0ZXAuYWRkKDEpKS5kaXYocmFuZ2UpKTsKICAgICAgICByZXR1cm4gcHJvZml0UHJvY2VudC5hZGQocHJvZml0Lm1pbik7CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0Qm9udXNlcyh1aW50MjU2IF92YWx1ZSkgcHVibGljIGNvbnN0YW50IHJldHVybnModWludDI1NiBwcm9jZW50LCB1aW50MjU2IF9kYXRlVW5mcmVlemUpewogICAgICAgIGlmKGJvbnVzZXMubGVuZ3RoID09IDAgfHwgYm9udXNlc1swXS52YWx1ZSA+IF92YWx1ZSl7CiAgICAgICAgICAgIHJldHVybiAoMCwwKTsKICAgICAgICB9CiAgICAgICAgdWludDE2IGkgPSAxOwogICAgICAgIGZvcihpOyBpIDwgYm9udXNlcy5sZW5ndGg7IGkrKyl7CiAgICAgICAgICAgIGlmKGJvbnVzZXNbaV0udmFsdWUgPiBfdmFsdWUpewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIChib251c2VzW2ktMV0ucHJvY2VudCxib251c2VzW2ktMV0uZnJlZXplVGltZSk7CiAgICB9CgogICAgLy8gVGhlIGFiaWxpdHkgdG8gcXVpY2tseSBjaGVjayBSb3VuZDEgKG9ubHkgZm9yIFJvdW5kMSwgb25seSAxIHRpbWUpLiBDb21wbGV0ZXMgdGhlIFJvdW5kMSBieQogICAgLy8gdHJhbnNmZXJyaW5nIHRoZSBzcGVjaWZpZWQgbnVtYmVyIG9mIHRva2VucyB0byB0aGUgQWNjb3VudGFudCdzIHdhbGxldC4gQXZhaWxhYmxlIHRvIHRoZSBNYW5hZ2VyLgogICAgLy8gVXNlIG9ubHkgaWYgdGhpcyBpcyBwcm92aWRlZCBieSB0aGUgc2NyaXB0IGFuZCB3aGl0ZSBwYXBlci4gSW4gdGhlIG5vcm1hbCBzY2VuYXJpbywgaXQKICAgIC8vIGRvZXMgbm90IGNhbGwgYW5kIHRoZSBmdW5kcyBhcmUgcmFpc2VkIG5vcm1hbGx5LiBXZSByZWNvbW1lbmQgdGhhdCB5b3UgZGVsZXRlIHRoaXMKICAgIC8vIGZ1bmN0aW9uIGVudGlyZWx5LCBzbyBhcyBub3QgdG8gY29uZnVzZSB0aGUgYXVkaXRvcnMuIEluaXRpYWxpemUgJiBGaW5hbGl6ZSBub3QgbmVlZGVkLgogICAgLy8gKiogUVVJTlRJTElPTlMgKiogIDEwXjE4IC8gMSoqMTggLyAxZTE4CiAgICBmdW5jdGlvbiBmYXN0VG9rZW5TYWxlKHVpbnQyNTYgX3RvdGFsU3VwcGx5KSBwdWJsaWMgewogICAgICAgIHJlcXVpcmUod2FsbGV0c1t1aW50OChSb2xlcy5tYW5hZ2VyKV0gPT0gbXNnLnNlbmRlcik7CiAgICAgICAgcmVxdWlyZShUb2tlblNhbGUgPT0gVG9rZW5TYWxlVHlwZS5yb3VuZDEgJiYgIWlzSW5pdGlhbGl6ZWQpOwogICAgICAgIHRva2VuLm1pbnQod2FsbGV0c1t1aW50OChSb2xlcy5hY2NvdW50YW50KV0sIF90b3RhbFN1cHBseSk7CiAgICAgICAgVG9rZW5TYWxlID0gVG9rZW5TYWxlVHlwZS5yb3VuZDI7CiAgICB9CgogICAgLy8gUmVtb3ZlIHRoZSAiUGF1c2Ugb2YgZXhjaGFuZ2UiLiBBdmFpbGFibGUgdG8gdGhlIG1hbmFnZXIgYXQgYW55IHRpbWUuIElmIHRoZQogICAgLy8gbWFuYWdlciByZWZ1c2VzIHRvIHJlbW92ZSB0aGUgcGF1c2UsIHRoZW4gMzAtMTIwIGRheXMgYWZ0ZXIgdGhlIHN1Y2Nlc3NmdWwKICAgIC8vIGNvbXBsZXRpb24gb2YgdGhlIFRva2VuU2FsZSwgYW55b25lIGNhbiByZW1vdmUgYSBwYXVzZSBhbmQgYWxsb3cgdGhlIGV4Y2hhbmdlIHRvIGNvbnRpbnVlLgogICAgLy8gVGhlIG1hbmFnZXIgZG9lcyBub3QgaW50ZXJmZXJlIGFuZCB3aWxsIG5vdCBiZSBhYmxlIHRvIGRlbGF5IHRoZSB0ZXJtLgogICAgLy8gSGUgY2FuIG9ubHkgY2FuY2VsIHRoZSBwYXVzZSBiZWZvcmUgdGhlIGFwcG9pbnRlZCB0aW1lLgogICAgZnVuY3Rpb24gdG9rZW5VbnBhdXNlKCkgcHVibGljIHsKICAgICAgICByZXF1aXJlKHdhbGxldHNbdWludDgoUm9sZXMubWFuYWdlcildID09IG1zZy5zZW5kZXIKICAgICAgICAgICAgfHwgKG5vdyA+IGVuZFRpbWUgKyA2MCBkYXlzICYmIFRva2VuU2FsZSA9PSBUb2tlblNhbGVUeXBlLnJvdW5kMiAmJiBpc0ZpbmFsaXplZCAmJiBnb2FsUmVhY2hlZCgpKSk7CiAgICAgICAgdG9rZW4udW5wYXVzZSgpOwogICAgfQoKICAgIC8vIEVuYWJsZSB0aGUgIlBhdXNlIG9mIGV4Y2hhbmdlIi4gQXZhaWxhYmxlIHRvIHRoZSBtYW5hZ2VyIHVudGlsIHRoZSBUb2tlblNhbGUgaXMgY29tcGxldGVkLgogICAgLy8gVGhlIG1hbmFnZXIgY2Fubm90IHR1cm4gb24gdGhlIHBhdXNlLCBmb3IgZXhhbXBsZSwgMyB5ZWFycyBhZnRlciB0aGUgZW5kIG9mIHRoZSBUb2tlblNhbGUuCiAgICBmdW5jdGlvbiB0b2tlblBhdXNlKCkgcHVibGljIHsKICAgICAgICByZXF1aXJlKHdhbGxldHNbdWludDgoUm9sZXMubWFuYWdlcildID09IG1zZy5zZW5kZXIgJiYgIWlzRmluYWxpemVkKTsKICAgICAgICB0b2tlbi5wYXVzZSgpOwogICAgfQoKICAgIC8vIFBhdXNlIG9mIHNhbGUuIEF2YWlsYWJsZSB0byB0aGUgbWFuYWdlci4KICAgIGZ1bmN0aW9uIGNyb3dkc2FsZVBhdXNlKCkgcHVibGljIHsKICAgICAgICByZXF1aXJlKHdhbGxldHNbdWludDgoUm9sZXMubWFuYWdlcildID09IG1zZy5zZW5kZXIpOwogICAgICAgIHJlcXVpcmUoaXNQYXVzZWRDcm93ZHNhbGUgPT0gZmFsc2UpOwogICAgICAgIGlzUGF1c2VkQ3Jvd2RzYWxlID0gdHJ1ZTsKICAgIH0KCiAgICAvLyBXaXRoZHJhd2FsIGZyb20gdGhlIHBhdXNlIG9mIHNhbGUuIEF2YWlsYWJsZSB0byB0aGUgbWFuYWdlci4KICAgIGZ1bmN0aW9uIGNyb3dkc2FsZVVucGF1c2UoKSBwdWJsaWMgewogICAgICAgIHJlcXVpcmUod2FsbGV0c1t1aW50OChSb2xlcy5tYW5hZ2VyKV0gPT0gbXNnLnNlbmRlcik7CiAgICAgICAgcmVxdWlyZShpc1BhdXNlZENyb3dkc2FsZSA9PSB0cnVlKTsKICAgICAgICBpc1BhdXNlZENyb3dkc2FsZSA9IGZhbHNlOwogICAgfQoKICAgIC8vIENoZWNraW5nIHdoZXRoZXIgdGhlIHJpZ2h0cyB0byBhZGRyZXNzIGlnbm9yZSB0aGUgIlBhdXNlIG9mIGV4Y2hhbmdlIi4gSWYgdGhlCiAgICAvLyB3YWxsZXQgaXMgaW5jbHVkZWQgaW4gdGhpcyBsaXN0LCBpdCBjYW4gdHJhbnNsYXRlIHRva2VucywgaWdub3JpbmcgdGhlIHBhdXNlLiBCeSBkZWZhdWx0LAogICAgLy8gb25seSB0aGUgZm9sbG93aW5nIHdhbGxldHMgYXJlIGluY2x1ZGVkOgogICAgLy8gICAgLSBBY2NvdW50YW50IHdhbGxldCAoaGUgc2hvdWxkIGltbWVkaWF0ZWx5IHRyYW5zZmVyIHRva2VucywgYnV0IG5vdCB0byBub24tRVRIIGludmVzdG9ycykKICAgIC8vICAgIC0gQ29udHJhY3QgZm9yIGZyZWV6aW5nIHRoZSB0b2tlbnMgZm9yIHRoZSBUZWFtIChidXQgVGVhbSB3YWxsZXQgbm90IGluY2x1ZGVkKQogICAgLy8gSW5zaWRlLiBDb25zdGFudC4KICAgIGZ1bmN0aW9uIHVucGF1c2VkV2FsbGV0KGFkZHJlc3MgX3dhbGxldCkgaW50ZXJuYWwgY29uc3RhbnQgcmV0dXJucyhib29sKSB7CiAgICAgICAgYm9vbCBfYWNjb3VudGFudCA9IHdhbGxldHNbdWludDgoUm9sZXMuYWNjb3VudGFudCldID09IF93YWxsZXQ7CiAgICAgICAgYm9vbCBfbWFuYWdlciA9IHdhbGxldHNbdWludDgoUm9sZXMubWFuYWdlcildID09IF93YWxsZXQ7CiAgICAgICAgYm9vbCBfYm91bnR5ID0gd2FsbGV0c1t1aW50OChSb2xlcy5ib3VudHkpXSA9PSBfd2FsbGV0OwogICAgICAgIGJvb2wgX2NvbXBhbnkgPSB3YWxsZXRzW3VpbnQ4KFJvbGVzLmNvbXBhbnkpXSA9PSBfd2FsbGV0OwogICAgICAgIHJldHVybiBfYWNjb3VudGFudCB8fCBfbWFuYWdlciB8fCBfYm91bnR5IHx8IF9jb21wYW55OwogICAgfQoKICAgIC8vIEZvciBleGFtcGxlIC0gQWZ0ZXIgNSB5ZWFycyBvZiB0aGUgcHJvamVjdCdzIGV4aXN0ZW5jZSwgYWxsIG9mIHVzIHN1ZGRlbmx5IGRlY2lkZWQgY29sbGVjdGl2ZWx5CiAgICAvLyAoY29tcGFueSArIGludmVzdG9ycykgdGhhdCBpdCB3b3VsZCBiZSBtb3JlIHByb2ZpdGFibGUgZm9yIGV2ZXJ5b25lIHRvIHN3aXRjaCB0byBhbm90aGVyIHNtYXJ0CiAgICAvLyBjb250cmFjdCByZXNwb25zaWJsZSBmb3IgdG9rZW5zLiBUaGUgY29tcGFueSB0aGVuIHByZXBhcmVzIGEgbmV3IHRva2VuLCBpbnZlc3RvcnMKICAgIC8vIGRpc2Fzc2VtYmxlLCBzdHVkeSwgZGlzY3VzcywgZXRjLiBBZnRlciBhIGdlbmVyYWwgYWdyZWVtZW50LCB0aGUgbWFuYWdlciBhbGxvd3MgYW55IGludmVzdG9yOgogICAgLy8gICAgICAtIHRvIGJ1cm4gdGhlIHRva2VucyBvZiB0aGUgcHJldmlvdXMgY29udHJhY3QKICAgIC8vICAgICAgLSBnZW5lcmF0ZSBuZXcgdG9rZW5zIGZvciBhIG5ldyBjb250cmFjdAogICAgLy8gSXQgaXMgdW5kZXJzdG9vZCB0aGF0IGFmdGVyIGEgZ2VuZXJhbCBzb2x1dGlvbiB0aHJvdWdoIHRoaXMgZnVuY3Rpb24gYWxsIGludmVzdG9ycwogICAgLy8gd2lsbCBjb2xsZWN0aXZlbHkgKGFuZCB2b2x1bnRhcmlseSkgbW92ZSB0byBhIG5ldyB0b2tlbi4KICAgIGZ1bmN0aW9uIG1vdmVUb2tlbnMoYWRkcmVzcyBfbWlncmF0aW9uQWdlbnQpIHB1YmxpYyB7CiAgICAgICAgcmVxdWlyZSh3YWxsZXRzW3VpbnQ4KFJvbGVzLm1hbmFnZXIpXSA9PSBtc2cuc2VuZGVyKTsKICAgICAgICB0b2tlbi5zZXRNaWdyYXRpb25BZ2VudChfbWlncmF0aW9uQWdlbnQpOwogICAgfQoKICAgIGZ1bmN0aW9uIG1pZ3JhdGVBbGwoYWRkcmVzc1tdIF9ob2xkZXJzKSBwdWJsaWMgewogICAgICAgIHJlcXVpcmUod2FsbGV0c1t1aW50OChSb2xlcy5tYW5hZ2VyKV0gPT0gbXNnLnNlbmRlcik7CiAgICAgICAgdG9rZW4ubWlncmF0ZUFsbChfaG9sZGVycyk7CiAgICB9CgogICAgLy8gQ2hhbmdlIHRoZSBhZGRyZXNzIGZvciB0aGUgc3BlY2lmaWVkIHJvbGUuCiAgICAvLyBBdmFpbGFibGUgdG8gYW55IHdhbGxldCBvd25lciBleGNlcHQgdGhlIG9ic2VydmVyLgogICAgLy8gQXZhaWxhYmxlIHRvIHRoZSBtYW5hZ2VyIHVudGlsIHRoZSByb3VuZCBpcyBpbml0aWFsaXplZC4KICAgIC8vIFRoZSBPYnNlcnZlcidzIHdhbGxldCBvciBoaXMgb3duIG1hbmFnZXIgY2FuIGNoYW5nZSBhdCBhbnkgdGltZS4KICAgIGZ1bmN0aW9uIGNoYW5nZVdhbGxldChSb2xlcyBfcm9sZSwgYWRkcmVzcyBfd2FsbGV0KSBwdWJsaWMKICAgIHsKICAgICAgICByZXF1aXJlKAogICAgICAgIChtc2cuc2VuZGVyID09IHdhbGxldHNbdWludDgoX3JvbGUpXSAmJiBfcm9sZSAhPSBSb2xlcy5vYnNlcnZlcikKICAgICAgICB8fAogICAgICAgIChtc2cuc2VuZGVyID09IHdhbGxldHNbdWludDgoUm9sZXMubWFuYWdlcildICYmICghaXNJbml0aWFsaXplZCB8fCBfcm9sZSA9PSBSb2xlcy5vYnNlcnZlcikpCiAgICAgICAgKTsKICAgICAgICBhZGRyZXNzIG9sZFdhbGxldCA9IHdhbGxldHNbdWludDgoX3JvbGUpXTsKICAgICAgICB3YWxsZXRzW3VpbnQ4KF9yb2xlKV0gPSBfd2FsbGV0OwogICAgICAgIGlmKCF1bnBhdXNlZFdhbGxldChvbGRXYWxsZXQpKQogICAgICAgIHRva2VuLmRlbFVucGF1c2VkV2FsbGV0KG9sZFdhbGxldCk7CiAgICAgICAgaWYodW5wYXVzZWRXYWxsZXQoX3dhbGxldCkpCiAgICAgICAgdG9rZW4uYWRkVW5wYXVzZWRXYWxsZXQoX3dhbGxldCk7CiAgICB9CgogICAgLy8gSWYgYSBsaXR0bGUgbW9yZSB0aGFuIGEgeWVhciBoYXMgZWxhcHNlZCAoUm91bmQyIHN0YXJ0IGRhdGUgKyA0MDAgZGF5cyksIGEgc21hcnQgY29udHJhY3QKICAgIC8vIHdpbGwgYWxsb3cgeW91IHRvIHNlbmQgYWxsIHRoZSBtb25leSB0byB0aGUgQmVuZWZpY2lhcnksIGlmIGFueSBtb25leSBpcyBwcmVzZW50LiBUaGlzIGlzCiAgICAvLyBwb3NzaWJsZSBpZiB5b3UgbWlzdGFrZW5seSBsYXVuY2ggdGhlIFJvdW5kMiBmb3IgMzAgeWVhcnMgKG5vdCAzMCBkYXlzKSwgaW52ZXN0b3JzIHdpbGwgdHJhbnNmZXIKICAgIC8vIG1vbmV5IHRoZXJlIGFuZCB5b3Ugd2lsbCBub3QgYmUgYWJsZSB0byBwaWNrIHRoZW0gdXAgd2l0aGluIGEgcmVhc29uYWJsZSB0aW1lLiBJdCBpcyBhbHNvCiAgICAvLyBwb3NzaWJsZSB0aGF0IGluIG91ciBjaGVja2VkIHNjcmlwdCBzb21lb25lIHdpbGwgbWFrZSB1bmZvcmVzZWVuIG1pc3Rha2VzLCBzcG9pbGluZyB0aGUKICAgIC8vIGZpbmFsaXphdGlvbi4gV2l0aG91dCBmaW5hbGl6YXRpb24sIG1vbmV5IGNhbm5vdCBiZSByZXR1cm5lZC4gVGhpcyBpcyBhIHJlc2N1ZSBvcHRpb24gdG8KICAgIC8vIGdldCBhcm91bmQgdGhpcyBwcm9ibGVtLCBidXQgYXZhaWxhYmxlIG9ubHkgYWZ0ZXIgYSB5ZWFyICg0MDAgZGF5cykuCgogICAgLy8gQW5vdGhlciByZWFzb24gLSB0aGUgVG9rZW5TYWxlIHdhcyBhIGZhaWx1cmUsIGJ1dCBub3QgYWxsIEVUSCBpbnZlc3RvcnMgdG9vayB0aGVpciBtb25leSBkdXJpbmcgdGhlIHllYXIgYWZ0ZXIuCiAgICAvLyBTb21lIGludmVzdG9ycyBtYXkgaGF2ZSBsb3N0IGEgd2FsbGV0IGtleSwgZm9yIGV4YW1wbGUuCgogICAgLy8gVGhlIG1ldGhvZCB3b3JrcyBlcXVhbGx5IHdpdGggdGhlIFJvdW5kMSBhbmQgUm91bmQyLiBXaGVuIHRoZSBSb3VuZDEgc3RhcnRzLCB0aGUgdGltZSBmb3IgdW5sb2NraW5nCiAgICAvLyB0aGUgZGlzdHJ1Y3RWYXVsdCBiZWdpbnMuIElmIHRoZSBUb2tlblNhbGUgaXMgdGhlbiBzdGFydGVkLCB0aGVuIHRoZSB0ZXJtIHN0YXJ0cyBhbmV3IGZyb20gdGhlIGZpcnN0IGRheSBvZiB0aGUgVG9rZW5TYWxlLgoKICAgIC8vIE5leHQsIGFjdCBpbmRlcGVuZGVudGx5LCBpbiBhY2NvcmRhbmNlIHdpdGggb2JsaWdhdGlvbnMgdG8gaW52ZXN0b3JzLgoKICAgIC8vIFdpdGhpbiA0MDAgZGF5cyBvZiB0aGUgc3RhcnQgb2YgdGhlIFJvdW5kLCBpZiBpdCBmYWlscyBvbmx5IGludmVzdG9ycyBjYW4gdGFrZSBtb25leS4gQWZ0ZXIKICAgIC8vIHRoZSBkZWFkbGluZSB0aGlzIGNhbiBhbHNvIGluY2x1ZGUgdGhlIGNvbXBhbnkgYXMgd2VsbCBhcyBpbnZlc3RvcnMsIGRlcGVuZGluZyBvbiB3aG8gaXMgdGhlIGZpcnN0IHRvIHVzZSB0aGUgbWV0aG9kLgogICAgZnVuY3Rpb24gZGlzdHJ1Y3RWYXVsdCgpIHB1YmxpYyB7CiAgICAgICAgcmVxdWlyZSh3YWxsZXRzW3VpbnQ4KFJvbGVzLmJlbmVmaWNpYXJ5KV0gPT0gbXNnLnNlbmRlcik7CiAgICAgICAgcmVxdWlyZShub3cgPiBzdGFydFRpbWUgKyA0MDAgZGF5cyk7CiAgICAgICAgdmF1bHQuZGVsKHdhbGxldHNbdWludDgoUm9sZXMuYmVuZWZpY2lhcnkpXSk7CiAgICB9CgoKICAgIC8vIFdlIGFjY2VwdCBwYXltZW50cyBvdGhlciB0aGFuIEV0aGVyZXVtIChFVEgpIGFuZCBvdGhlciBjdXJyZW5jaWVzLCBmb3IgZXhhbXBsZSwgQml0Y29pbiAoQlRDKS4KICAgIC8vIFBlcmhhcHMgb3RoZXIgdHlwZXMgb2YgY3J5cHRvY3VycmVuY3kgLSBzZWUgdGhlIG9yaWdpbmFsIHRlcm1zIGluIHRoZSB3aGl0ZSBwYXBlciBhbmQgb24gdGhlIFRva2VuU2FsZSB3ZWJzaXRlLgoKICAgIC8vIFdlIHJlbGVhc2UgdG9rZW5zIG9uIEV0aGVyZXVtLiBEdXJpbmcgdGhlIFJvdW5kMSBhbmQgUm91bmQyIHdpdGggYSBzbWFydCBjb250cmFjdCwgeW91IGRpcmVjdGx5IHRyYW5zZmVyCiAgICAvLyB0aGUgdG9rZW5zIHRoZXJlIGFuZCBpbW1lZGlhdGVseSwgd2l0aCB0aGUgc2FtZSB0cmFuc2FjdGlvbiwgcmVjZWl2ZSB0b2tlbnMgaW4geW91ciB3YWxsZXQuCgogICAgLy8gV2hlbiBwYXlpbmcgaW4gYW55IG90aGVyIGN1cnJlbmN5LCBmb3IgZXhhbXBsZSBpbiBCVEMsIHdlIGFjY2VwdCB5b3VyIG1vbmV5IHZpYSBvbmUgY29tbW9uIHdhbGxldC4KICAgIC8vIE91ciBtYW5hZ2VyIGZpeGVzIHRoZSBhbW91bnQgcmVjZWl2ZWQgZm9yIHRoZSBiaXRjb2luIHdhbGxldCBhbmQgY2FsbHMgdGhlIG1ldGhvZCBvZiB0aGUgc21hcnQKICAgIC8vIGNvbnRyYWN0IHBheW1lbnRzSW5PdGhlckN1cnJlbmN5IHRvIGluZm9ybSBoaW0gaG93IG11Y2ggZm9yZWlnbiBjdXJyZW5jeSBoYXMgYmVlbiByZWNlaXZlZCAtIG9uIGEgZGFpbHkgYmFzaXMuCiAgICAvLyBUaGUgc21hcnQgY29udHJhY3QgcGlucyB0aGUgbnVtYmVyIG9mIGFjY2VwdGVkIEVUSCBkaXJlY3RseSBhbmQgdGhlIG51bWJlciBvZiBCVEMuIFNtYXJ0IGNvbnRyYWN0CiAgICAvLyBtb25pdG9ycyBzb2Z0Y2FwIGFuZCBoYXJkY2FwLCBzbyBhcyBub3QgdG8gZ28gYmV5b25kIHRoaXMgZnJhbWV3b3JrLgoKICAgIC8vIEluIHRoZW9yeSwgaXQgaXMgcG9zc2libGUgdGhhdCB3aGVuIGFwcHJvYWNoaW5nIGhhcmRjYXAsIHdlIHdpbGwgcmVjZWl2ZSBhIHRyYW5zZmVyIChvbmUgb3Igc2V2ZXJhbAogICAgLy8gdHJhbnNmZXJzKSB0byB0aGUgd2FsbGV0IG9mIEJUQywgdGhhdCB0b2dldGhlciB3aXRoIHByZXZpb3VzbHkgcmVjZWl2ZWQgbW9uZXkgd2lsbCBleGNlZWQgdGhlIGhhcmRjYXAgaW4gdG90YWwuCiAgICAvLyBJbiB0aGlzIGNhc2UsIHdlIHdpbGwgcmVmdW5kIGFsbCB0aGUgYW1vdW50cyBhYm92ZSwgaW4gb3JkZXIgbm90IHRvIGV4Y2VlZCB0aGUgaGFyZGNhcC4KCiAgICAvLyBDb2xsZWN0aW9uIG9mIG1vbmV5IGluIEJUQyB3aWxsIGJlIGNhcnJpZWQgb3V0IHZpYSBvbmUgY29tbW9uIHdhbGxldC4gVGhlIHdhbGxldCdzIGFkZHJlc3Mgd2lsbCBiZSBwdWJsaXNoZWQKICAgIC8vIGV2ZXJ5d2hlcmUgKGluIGEgd2hpdGUgcGFwZXIsIG9uIHRoZSBUb2tlblNhbGUgd2Vic2l0ZSwgb24gVGVsZWdyYW0sIG9uIEJpdGNvaW50YWxrLCBpbiB0aGlzIGNvZGUsIGV0Yy4pCiAgICAvLyBBbnlvbmUgaW50ZXJlc3RlZCBjYW4gY2hlY2sgdGhhdCB0aGUgYWRtaW5pc3RyYXRvciBvZiB0aGUgc21hcnQgY29udHJhY3Qgd3JpdGVzIGRvd24gZXhhY3RseSB0aGUgYW1vdW50CiAgICAvLyBpbiBFVEggKGluIGVxdWl2YWxlbnQgZm9yIEJUQykgdGhlcmUuIEluIHRoZW9yeSwgdGhlIGFiaWxpdHkgdG8gYnlwYXNzIGEgc21hcnQgY29udHJhY3QgdG8gYWNjZXB0IG1vbmV5IGluCiAgICAvLyBCVEMgYW5kIG5vdCByZWdpc3RlciB0aGVtIGluIEVUSCBjcmVhdGVzIGEgcG9zc2liaWxpdHkgZm9yIG1hbmlwdWxhdGlvbiBieSB0aGUgY29tcGFueS4gVGhhbmtzIHRvCiAgICAvLyBwYXltZW50c0luT3RoZXJDdXJyZW5jeSBob3dldmVyLCB0aGlzIHRocmVhdCBpcyBsZXZlbGVkLgoKICAgIC8vIEFueSB1c2VyIGNhbiBjaGVjayB0aGUgYW1vdW50cyBpbiBCVEMgYW5kIHRoZSB2YXJpYWJsZSBvZiB0aGUgc21hcnQgY29udHJhY3QgdGhhdCBhY2NvdW50cyBmb3IgdGhpcwogICAgLy8gKHBheW1lbnRzSW5PdGhlckN1cnJlbmN5IG1ldGhvZCkuIEFueSB1c2VyIGNhbiBlYXNpbHkgY2hlY2sgdGhlIGluY29taW5nIHRyYW5zYWN0aW9ucyBpbiBhIHNtYXJ0IGNvbnRyYWN0CiAgICAvLyBvbiBhIGRhaWx5IGJhc2lzLiBBbnkgaHlwb3RoZXRpY2FsIHRyaWNrcyBvbiB0aGUgcGFydCBvZiB0aGUgY29tcGFueSBjYW4gYmUgZXhwb3NlZCBhbmQgcGFuaWMgZHVyaW5nIHRoZSBUb2tlblNhbGUsCiAgICAvLyBzaW1wbHkgcG9pbnRpbmcgb3V0IHRoZSBpbmNvbXBhdGliaWxpdHkgb2YgcGF5bWVudHNJbk90aGVyQ3VycmVuY3kgKGllLCB0aGUgYW1vdW50IG9mIEVUSCArIEJUQyBjb2xsZWN0aW9uKQogICAgLy8gYW5kIHRoZSBhY3R1YWwgdHJhbnNhY3Rpb25zIGluIEJUQy4gVGhlIGNvbXBhbnkgc3RyaWN0bHkgYWRoZXJlcyB0byB0aGUgZGVzY3JpYmVkIHByaW5jaXBsZXMgb2Ygb3Blbm5lc3MuCgogICAgLy8gVGhlIGNvbXBhbnkgYWRtaW5pc3RyYXRvciBpcyByZXF1aXJlZCB0byBzeW5jaHJvbml6ZSBwYXltZW50c0luT3RoZXJDdXJyZW5jeSBldmVyeSB3b3JraW5nIGRheSAoYnV0IHlvdQogICAgLy8gY2Fubm90IHN5bmNocm9uaXplIGlmIHRoZXJlIGFyZSBubyBuZXcgQlRDIHBheW1lbnRzKS4gSW4gdGhlIGNhc2Ugb2YgdW5mb3Jlc2VlbiBwcm9ibGVtcywgc3VjaCBhcwogICAgLy8gYnJha2VzIG9uIHRoZSBFdGhlcmV1bSBuZXR3b3JrLCB0aGlzIG9wZXJhdGlvbiBtYXkgYmUgZGlmZmljdWx0LiBZb3Ugc2hvdWxkIG9ubHkgd29ycnkgaWYgdGhlCiAgICAvLyBhZG1pbmlzdHJhdG9yIGRvZXMgbm90IHN5bmNocm9uaXplIHRoZSBhbW91bnQgZm9yIG1vcmUgdGhhbiA5NiBob3VycyBpbiBhIHJvdywgYW5kIHRoZSBCVEMgd2FsbGV0CiAgICAvLyByZWNlaXZlcyBzaWduaWZpY2FudCBhbW91bnRzLgoKICAgIC8vIFRoaXMgc2NlbmFyaW8gZW5zdXJlcyB0aGF0IGZvciB0aGUgc3VtIG9mIGFsbCBmZWVzIGluIGFsbCBjdXJyZW5jaWVzIHRoaXMgdmFsdWUgZG9lcyBub3QgZXhjZWVkIGhhcmRjYXAuCgogICAgLy8gQlRDIC0gMUhRYWhpdlBYMmNVNU5xOTIxd1N1VUxwdVp5aTlBY1hDWQoKICAgIC8vICoqIFFVSU5USUxMSU9OUyAqKiAxMF4xOCAvIDEqKjE4IC8gMWUxOAogICAgZnVuY3Rpb24gcGF5bWVudHNJbk90aGVyQ3VycmVuY3kodWludDI1NiBfdG9rZW4sIHVpbnQyNTYgX3ZhbHVlKSBwdWJsaWMgewogICAgICAgIHJlcXVpcmUod2FsbGV0c1t1aW50OChSb2xlcy5vYnNlcnZlcildID09IG1zZy5zZW5kZXIpOwogICAgICAgIGJvb2wgd2l0aGluUGVyaW9kID0gKG5vdyA+PSBzdGFydFRpbWUgJiYgbm93IDw9IGVuZFRpbWUpOwoKICAgICAgICBib29sIHdpdGhpbkNhcCA9IF92YWx1ZS5hZGQoZXRoV2VpUmFpc2VkKSA8PSBoYXJkQ2FwLmFkZChvdmVyTGltaXQpOwogICAgICAgIHJlcXVpcmUod2l0aGluUGVyaW9kICYmIHdpdGhpbkNhcCAmJiBpc0luaXRpYWxpemVkKTsKCiAgICAgICAgbm9uRXRoV2VpUmFpc2VkID0gX3ZhbHVlOwogICAgICAgIHRva2VuUmVzZXJ2ZWQgPSBfdG9rZW47CgogICAgfQogICAgCiAgICBmdW5jdGlvbiBjaGFuZ2VMb2NrKGFkZHJlc3MgX293bmVyLCB1aW50MjU2IF92YWx1ZSwgdWludDI1NiBfZGF0ZSkgZXh0ZXJuYWwgewogICAgICAgIHJlcXVpcmUod2FsbGV0c1t1aW50OChSb2xlcy5tYW5hZ2VyKV0gPT0gbXNnLnNlbmRlcik7CiAgICAgICAgdG9rZW4uY2hhbmdlTG9jayhfb3duZXIsIF92YWx1ZSwgX2RhdGUpOwogICAgfQoKICAgIGZ1bmN0aW9uIGxva2VkTWludChhZGRyZXNzIF9iZW5lZmljaWFyeSwgdWludDI1NiBfdmFsdWUsIHVpbnQyNTYgX2ZyZWV6ZVRpbWUpIGludGVybmFsIHsKICAgICAgICBpZihfZnJlZXplVGltZSA+IDApewogICAgICAgICAgICAKICAgICAgICAgICAgdWludDI1NiB0b3RhbEJsb2tlZCA9IHRva2VuLnZhbHVlQmxvY2tlZChfYmVuZWZpY2lhcnkpLmFkZChfdmFsdWUpOwogICAgICAgICAgICB1aW50MjU2IHBhc3REYXRlVW5mcmVlemUgPSB0b2tlbi5ibGlrZWRVbnRpbChfYmVuZWZpY2lhcnkpOwogICAgICAgICAgICB1aW50MjU2IG5ld0RhdGVVbmZyZWV6ZSA9IF9mcmVlemVUaW1lICsgbm93OyAKICAgICAgICAgICAgbmV3RGF0ZVVuZnJlZXplID0gKHBhc3REYXRlVW5mcmVlemUgPiBuZXdEYXRlVW5mcmVlemUgKSA/IHBhc3REYXRlVW5mcmVlemUgOiBuZXdEYXRlVW5mcmVlemU7CgogICAgICAgICAgICB0b2tlbi5jaGFuZ2VMb2NrKF9iZW5lZmljaWFyeSx0b3RhbEJsb2tlZCxuZXdEYXRlVW5mcmVlemUpOwogICAgICAgIH0KICAgICAgICB0b2tlbi5taW50KF9iZW5lZmljaWFyeSxfdmFsdWUpOwogICAgfQoKCiAgICAvLyBUaGUgZnVuY3Rpb24gZm9yIG9idGFpbmluZyBzbWFydCBjb250cmFjdCBmdW5kcyBpbiBFVEguIElmIGFsbCB0aGUgY2hlY2tzIGFyZSB0cnVlLCB0aGUgdG9rZW4gaXMKICAgIC8vIHRyYW5zZmVycmVkIHRvIHRoZSBidXllciwgdGFraW5nIGludG8gYWNjb3VudCB0aGUgY3VycmVudCBib251cy4KICAgIGZ1bmN0aW9uIGJ1eVRva2VucyhhZGRyZXNzIGJlbmVmaWNpYXJ5KSBwdWJsaWMgcGF5YWJsZSB7CiAgICAgICAgcmVxdWlyZShiZW5lZmljaWFyeSAhPSAweDApOwogICAgICAgIHJlcXVpcmUodmFsaWRQdXJjaGFzZSgpKTsKCiAgICAgICAgdWludDI1NiB3ZWlBbW91bnQgPSBtc2cudmFsdWU7CgogICAgICAgIHVpbnQyNTYgUHJvZml0UHJvY2VudCA9IGdldFByb2ZpdFBlcmNlbnQoKTsKCiAgICAgICAgdmFyIChib251cywgZGF0ZVVuZnJlZXplKSA9IGdldEJvbnVzZXMod2VpQW1vdW50KTsKICAgICAgICAKICAgICAgICAvLyBTY2VuYXJpbyAxIC0gc2VsZWN0IG1heCBmcm9tIGFsbCBib251c2VzICsgY2hlY2sgcHJvZml0Lm1heEFsbFByb2ZpdAogICAgICAgIC8vdWludDI1NiB0b3RhbFByb2ZpdCA9IFByb2ZpdFByb2NlbnQ7CiAgICAgICAgLy90b3RhbFByb2ZpdCA9ICh0b3RhbFByb2ZpdCA8IGJvbnVzKSA/IGJvbnVzIDogdG90YWxQcm9maXQ7CiAgICAgICAgLy90b3RhbFByb2ZpdCA9ICh0b3RhbFByb2ZpdCA+IHByb2ZpdC5tYXhBbGxQcm9maXQpID8gcHJvZml0Lm1heEFsbFByb2ZpdCA6IHRvdGFsUHJvZml0OwogICAgICAgIAogICAgICAgIC8vIFNjZW5hcmlvIDIgLSBzdW0gYm90aCBib251c2VzICsgY2hlY2sgcHJvZml0Lm1heEFsbFByb2ZpdAogICAgICAgIHVpbnQyNTYgdG90YWxQcm9maXQgPSBib251cy5hZGQoUHJvZml0UHJvY2VudCk7CiAgICAgICAgdG90YWxQcm9maXQgPSAodG90YWxQcm9maXQgPiBwcm9maXQubWF4QWxsUHJvZml0KT8gcHJvZml0Lm1heEFsbFByb2ZpdDogdG90YWxQcm9maXQ7CiAgICAgICAgCiAgICAgICAgLy8gY2FsY3VsYXRlIHRva2VuIGFtb3VudCB0byBiZSBjcmVhdGVkCiAgICAgICAgdWludDI1NiB0b2tlbnMgPSB3ZWlBbW91bnQubXVsKHJhdGUpLm11bCh0b3RhbFByb2ZpdCArIDEwMCkuZGl2KDEwMDAwMCk7CgogICAgICAgIC8vIHVwZGF0ZSBzdGF0ZQogICAgICAgIGV0aFdlaVJhaXNlZCA9IGV0aFdlaVJhaXNlZC5hZGQod2VpQW1vdW50KTsKCiAgICAgICAgbG9rZWRNaW50KGJlbmVmaWNpYXJ5LCB0b2tlbnMsIGRhdGVVbmZyZWV6ZSk7CgogICAgICAgIFRva2VuUHVyY2hhc2UobXNnLnNlbmRlciwgYmVuZWZpY2lhcnksIHdlaUFtb3VudCwgdG9rZW5zKTsKCiAgICAgICAgZm9yd2FyZEZ1bmRzKCk7CiAgICB9CgogICAgLy8gYnV5VG9rZW5zIGFsaWFzCiAgICBmdW5jdGlvbiAoKSBwdWJsaWMgcGF5YWJsZSB7CiAgICAgICAgYnV5VG9rZW5zKG1zZy5zZW5kZXIpOwogICAgfQoKfQoKCi8qKgogKiBAdGl0bGUgU2FmZU1hdGgKICogQGRldiBNYXRoIG9wZXJhdGlvbnMgd2l0aCBzYWZldHkgY2hlY2tzIHRoYXQgdGhyb3cgb24gZXJyb3IKICovCmxpYnJhcnkgU2FmZU1hdGggewogICAgZnVuY3Rpb24gbXVsKHVpbnQyNTYgYSwgdWludDI1NiBiKSBpbnRlcm5hbCBwdXJlIHJldHVybnMgKHVpbnQyNTYpIHsKICAgICAgICB1aW50MjU2IGMgPSBhICogYjsKICAgICAgICBhc3NlcnQoYSA9PSAwIHx8IGMgLyBhID09IGIpOwogICAgICAgIHJldHVybiBjOwogICAgfQoKICAgIGZ1bmN0aW9uIGRpdih1aW50MjU2IGEsIHVpbnQyNTYgYikgaW50ZXJuYWwgcHVyZSByZXR1cm5zICh1aW50MjU2KSB7CiAgICAgICAgLy8gYXNzZXJ0KGIgPiAwKTsgLy8gU29saWRpdHkgYXV0b21hdGljYWxseSB0aHJvd3Mgd2hlbiBkaXZpZGluZyBieSAwCiAgICAgICAgdWludDI1NiBjID0gYSAvIGI7CiAgICAgICAgLy8gYXNzZXJ0KGEgPT0gYiAqIGMgKyBhICUgYik7IC8vIFRoZXJlIGlzIG5vIGNhc2UgaW4gd2hpY2ggdGhpcyBkb2VzIG5vdCBob2xkCiAgICAgICAgcmV0dXJuIGM7CiAgICB9CgogICAgZnVuY3Rpb24gc3ViKHVpbnQyNTYgYSwgdWludDI1NiBiKSBpbnRlcm5hbCBwdXJlIHJldHVybnMgKHVpbnQyNTYpIHsKICAgICAgICBhc3NlcnQoYiA8PSBhKTsKICAgICAgICByZXR1cm4gYSAtIGI7CiAgICB9CgogICAgZnVuY3Rpb24gYWRkKHVpbnQyNTYgYSwgdWludDI1NiBiKSBpbnRlcm5hbCBwdXJlIHJldHVybnMgKHVpbnQyNTYpIHsKICAgICAgICB1aW50MjU2IGMgPSBhICsgYjsKICAgICAgICBhc3NlcnQoYyA+PSBhKTsKICAgICAgICByZXR1cm4gYzsKICAgIH0KfQoKLyoqCiAqIEB0aXRsZSBPd25hYmxlCiAqIEBkZXYgVGhlIE93bmFibGUgY29udHJhY3QgaGFzIGFuIG93bmVyIGFkZHJlc3MsIGFuZCBwcm92aWRlcyBiYXNpYyBhdXRob3JpemF0aW9uIGNvbnRyb2wKICogZnVuY3Rpb25zLCB0aGlzIHNpbXBsaWZpZXMgdGhlIGltcGxlbWVudGF0aW9uIG9mICJ1c2VyIHBlcm1pc3Npb25zIi4KICovCmNvbnRyYWN0IE93bmFibGUgewogICAgYWRkcmVzcyBwdWJsaWMgb3duZXI7CgoKICAgIC8qKgogICAgICogQGRldiBUaGUgT3duYWJsZSBjb25zdHJ1Y3RvciBzZXRzIHRoZSBvcmlnaW5hbCBgb3duZXJgIG9mIHRoZSBjb250cmFjdCB0byB0aGUgc2VuZGVyCiAgICAgKiBhY2NvdW50LgogICAgICovCiAgICBmdW5jdGlvbiBPd25hYmxlKCkgcHVibGljIHsKICAgICAgICBvd25lciA9IG1zZy5zZW5kZXI7CiAgICB9CgoKICAgIC8qKgogICAgICogQGRldiBUaHJvd3MgaWYgY2FsbGVkIGJ5IGFueSBhY2NvdW50IG90aGVyIHRoYW4gdGhlIG93bmVyLgogICAgICovCiAgICBtb2RpZmllciBvbmx5T3duZXIoKSB7CiAgICAgICAgcmVxdWlyZShtc2cuc2VuZGVyID09IG93bmVyKTsKICAgICAgICBfOwogICAgfQoKCiAgICAvKioKICAgICAqIEBkZXYgQWxsb3dzIHRoZSBjdXJyZW50IG93bmVyIHRvIHRyYW5zZmVyIGNvbnRyb2wgb2YgdGhlIGNvbnRyYWN0IHRvIGEgbmV3T3duZXIuCiAgICAgKiBAcGFyYW0gbmV3T3duZXIgVGhlIGFkZHJlc3MgdG8gdHJhbnNmZXIgb3duZXJzaGlwIHRvLgogICAgICovCiAgICBmdW5jdGlvbiB0cmFuc2Zlck93bmVyc2hpcChhZGRyZXNzIG5ld093bmVyKSBvbmx5T3duZXIgcHVibGljewogICAgICAgIHJlcXVpcmUobmV3T3duZXIgIT0gYWRkcmVzcygwKSk7CiAgICAgICAgb3duZXIgPSBuZXdPd25lcjsKICAgIH0KCn0KCi8qKgogKiBAdGl0bGUgUGF1c2FibGUKICogQGRldiBCYXNlIGNvbnRyYWN0IHdoaWNoIGFsbG93cyBjaGlsZHJlbiB0byBpbXBsZW1lbnQgYW4gZW1lcmdlbmN5IHN0b3AgbWVjaGFuaXNtLgogKi8KY29udHJhY3QgUGF1c2FibGUgaXMgT3duYWJsZSB7CiAgICBldmVudCBQYXVzZSgpOwogICAgZXZlbnQgVW5wYXVzZSgpOwoKICAgIGJvb2wgX3BhdXNlZCA9IGZhbHNlOwoKICAgIGZ1bmN0aW9uIHBhdXNlZCgpIHB1YmxpYyBjb25zdGFudCByZXR1cm5zKGJvb2wpCiAgICB7CiAgICAgICAgcmV0dXJuIF9wYXVzZWQ7CiAgICB9CgoKICAgIC8qKgogICAgICogQGRldiBtb2RpZmllciB0byBhbGxvdyBhY3Rpb25zIG9ubHkgd2hlbiB0aGUgY29udHJhY3QgSVMgcGF1c2VkCiAgICAgKi8KICAgIG1vZGlmaWVyIHdoZW5Ob3RQYXVzZWQoKSB7CiAgICAgICAgcmVxdWlyZSghcGF1c2VkKCkpOwogICAgICAgIF87CiAgICB9CgogICAgLyoqCiAgICAgKiBAZGV2IGNhbGxlZCBieSB0aGUgb3duZXIgdG8gcGF1c2UsIHRyaWdnZXJzIHN0b3BwZWQgc3RhdGUKICAgICAqLwogICAgZnVuY3Rpb24gcGF1c2UoKSBvbmx5T3duZXIgcHVibGljIHsKICAgICAgICByZXF1aXJlKCFfcGF1c2VkKTsKICAgICAgICBfcGF1c2VkID0gdHJ1ZTsKICAgICAgICBQYXVzZSgpOwogICAgfQoKICAgIC8qKgogICAgICogQGRldiBjYWxsZWQgYnkgdGhlIG93bmVyIHRvIHVucGF1c2UsIHJldHVybnMgdG8gbm9ybWFsIHN0YXRlCiAgICAgKi8KICAgIGZ1bmN0aW9uIHVucGF1c2UoKSBvbmx5T3duZXIgcHVibGljIHsKICAgICAgICByZXF1aXJlKF9wYXVzZWQpOwogICAgICAgIF9wYXVzZWQgPSBmYWxzZTsKICAgICAgICBVbnBhdXNlKCk7CiAgICB9Cn0KCgovLyBDb250cmFjdCBpbnRlcmZhY2UgZm9yIHRyYW5zZmVycmluZyBjdXJyZW50IHRva2VucyB0byBhbm90aGVyCmNvbnRyYWN0IE1pZ3JhdGlvbkFnZW50CnsKICAgIGZ1bmN0aW9uIG1pZ3JhdGVGcm9tKGFkZHJlc3MgX2Zyb20sIHVpbnQyNTYgX3ZhbHVlKSBwdWJsaWM7Cn0KCmNvbnRyYWN0IEJsb2NrZWRUb2tlbiBpcyBPd25hYmxlIHsKICAgIHVzaW5nIFNhZmVNYXRoIGZvciB1aW50MjU2OwoKICAgIHN0cnVjdCBsb2NrZWQge3VpbnQyNTYgdmFsdWU7IHVpbnQyNTYgZGF0ZTt9CgogICAgbWFwcGluZyAoYWRkcmVzcyA9PiBsb2NrZWQpIGxvY2tzOwoKICAgIGZ1bmN0aW9uIGJsaWtlZFVudGlsKGFkZHJlc3MgX293bmVyKSBleHRlcm5hbCBjb25zdGFudCByZXR1cm5zICh1aW50MjU2KSB7CiAgICAgICAgaWYobm93IDwgbG9ja3NbX293bmVyXS5kYXRlKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGxvY2tzW19vd25lcl0uZGF0ZTsKICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIHZhbHVlQmxvY2tlZChhZGRyZXNzIF9vd25lcikgcHVibGljIGNvbnN0YW50IHJldHVybnMgKHVpbnQyNTYpIHsKICAgICAgICBpZihub3cgPCBsb2Nrc1tfb3duZXJdLmRhdGUpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gbG9ja3NbX293bmVyXS52YWx1ZTsKICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGNoYW5nZUxvY2soYWRkcmVzcyBfb3duZXIsIHVpbnQyNTYgX3ZhbHVlLCB1aW50MjU2IF9kYXRlKSBleHRlcm5hbCBvbmx5T3duZXIgewogICAgICAgIGxvY2tzW19vd25lcl0gPSBsb2NrZWQoX3ZhbHVlLF9kYXRlKTsKICAgIH0KfQoKCi8vIChBMikKLy8gQ29udHJhY3QgdG9rZW4KY29udHJhY3QgVG9rZW5MIGlzIFBhdXNhYmxlLCBCbG9ja2VkVG9rZW4gewogICAgdXNpbmcgU2FmZU1hdGggZm9yIHVpbnQyNTY7CgogICAgc3RyaW5nIHB1YmxpYyBjb25zdGFudCBuYW1lID0gIkltaWdpemUiOwogICAgc3RyaW5nIHB1YmxpYyBjb25zdGFudCBzeW1ib2wgPSAiSU1HWiI7CiAgICB1aW50OCBwdWJsaWMgY29uc3RhbnQgZGVjaW1hbHMgPSAxODsKCiAgICB1aW50MjU2IHB1YmxpYyB0b3RhbFN1cHBseTsKCiAgICBtYXBwaW5nKGFkZHJlc3MgPT4gdWludDI1NikgYmFsYW5jZXM7CiAgICBtYXBwaW5nIChhZGRyZXNzID0+IG1hcHBpbmcgKGFkZHJlc3MgPT4gdWludDI1NikpIGFsbG93ZWQ7CgogICAgbWFwcGluZyAoYWRkcmVzcyA9PiBib29sKSBwdWJsaWMgdW5wYXVzZWRXYWxsZXQ7CgogICAgYm9vbCBwdWJsaWMgbWludGluZ0ZpbmlzaGVkID0gZmFsc2U7CgogICAgdWludDI1NiBwdWJsaWMgdG90YWxNaWdyYXRlZDsKICAgIGFkZHJlc3MgcHVibGljIG1pZ3JhdGlvbkFnZW50OwoKICAgIGV2ZW50IFRyYW5zZmVyKGFkZHJlc3MgaW5kZXhlZCBmcm9tLCBhZGRyZXNzIGluZGV4ZWQgdG8sIHVpbnQyNTYgdmFsdWUpOwogICAgZXZlbnQgQXBwcm92YWwoYWRkcmVzcyBpbmRleGVkIG93bmVyLCBhZGRyZXNzIGluZGV4ZWQgc3BlbmRlciwgdWludDI1NiB2YWx1ZSk7CgogICAgZXZlbnQgTWludChhZGRyZXNzIGluZGV4ZWQgdG8sIHVpbnQyNTYgYW1vdW50KTsKICAgIGV2ZW50IE1pbnRGaW5pc2hlZCgpOwoKICAgIGV2ZW50IE1pZ3JhdGUoYWRkcmVzcyBpbmRleGVkIF9mcm9tLCBhZGRyZXNzIGluZGV4ZWQgX3RvLCB1aW50MjU2IF92YWx1ZSk7CgogICAgbW9kaWZpZXIgY2FuTWludCgpIHsKICAgICAgICByZXF1aXJlKCFtaW50aW5nRmluaXNoZWQpOwogICAgICAgIF87CiAgICB9CgogICAgZnVuY3Rpb24gVG9rZW5MKCkgcHVibGljewogICAgICAgIG93bmVyID0gMHgwOwogICAgfQoKICAgIGZ1bmN0aW9uIHNldE93bmVyKCkgcHVibGljewogICAgICAgIHJlcXVpcmUob3duZXIgPT0gMHgwKTsKICAgICAgICBvd25lciA9IG1zZy5zZW5kZXI7CiAgICB9CgogICAgLy8gQmFsYW5jZSBvZiB0aGUgc3BlY2lmaWVkIGFkZHJlc3MKICAgIGZ1bmN0aW9uIGJhbGFuY2VPZihhZGRyZXNzIF9vd25lcikgcHVibGljIGNvbnN0YW50IHJldHVybnMgKHVpbnQyNTYgYmFsYW5jZSkgewogICAgICAgIHJldHVybiBiYWxhbmNlc1tfb3duZXJdOwogICAgfQoKCiAgICAvLyBUcmFuc2ZlciBvZiB0b2tlbnMgZnJvbSBvbmUgYWNjb3VudCB0byBhbm90aGVyCiAgICBmdW5jdGlvbiB0cmFuc2ZlcihhZGRyZXNzIF90bywgdWludDI1NiBfdmFsdWUpIHB1YmxpYyB3aGVuTm90UGF1c2VkIHJldHVybnMgKGJvb2wpIHsKICAgICAgICB1aW50MjU2IGF2YWlsYWJsZSA9IGJhbGFuY2VzW21zZy5zZW5kZXJdLnN1Yih2YWx1ZUJsb2NrZWQobXNnLnNlbmRlcikpOwogICAgICAgIHJlcXVpcmUoX3ZhbHVlIDw9IGF2YWlsYWJsZSk7CiAgICAgICAgcmVxdWlyZSAoX3ZhbHVlID4gMCk7CiAgICAgICAgYmFsYW5jZXNbbXNnLnNlbmRlcl0gPSBiYWxhbmNlc1ttc2cuc2VuZGVyXS5zdWIoX3ZhbHVlKTsKICAgICAgICBiYWxhbmNlc1tfdG9dID0gYmFsYW5jZXNbX3RvXS5hZGQoX3ZhbHVlKTsKICAgICAgICBUcmFuc2Zlcihtc2cuc2VuZGVyLCBfdG8sIF92YWx1ZSk7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgLy8gUmV0dXJucyB0aGUgbnVtYmVyIG9mIHRva2VucyB0aGF0IF9vd25lciB0cnVzdGVkIHRvIHNwZW5kIGZyb20gaGlzIGFjY291bnQgX3NwZW5kZXIKICAgIGZ1bmN0aW9uIGFsbG93YW5jZShhZGRyZXNzIF9vd25lciwgYWRkcmVzcyBfc3BlbmRlcikgcHVibGljIGNvbnN0YW50IHJldHVybnMgKHVpbnQyNTYgcmVtYWluaW5nKSB7CiAgICAgICAgcmV0dXJuIGFsbG93ZWRbX293bmVyXVtfc3BlbmRlcl07CiAgICB9CgogICAgLy8gVHJ1c3QgX3NlbmRlciBhbmQgc3BlbmQgX3ZhbHVlIHRva2VucyBmcm9tIHlvdXIgYWNjb3VudAogICAgZnVuY3Rpb24gYXBwcm92ZShhZGRyZXNzIF9zcGVuZGVyLCB1aW50MjU2IF92YWx1ZSkgcHVibGljIHJldHVybnMgKGJvb2wpIHsKCiAgICAgICAgLy8gVG8gY2hhbmdlIHRoZSBhcHByb3ZlIGFtb3VudCB5b3UgZmlyc3QgaGF2ZSB0byByZWR1Y2UgdGhlIGFkZHJlc3NlcwogICAgICAgIC8vICBhbGxvd2FuY2UgdG8gemVybyBieSBjYWxsaW5nIGBhcHByb3ZlKF9zcGVuZGVyLCAwKWAgaWYgaXQgaXMgbm90CiAgICAgICAgLy8gIGFscmVhZHkgMCB0byBtaXRpZ2F0ZSB0aGUgcmFjZSBjb25kaXRpb24gZGVzY3JpYmVkIGhlcmU6CiAgICAgICAgLy8gIGh0dHBzOi8vZ2l0aHViLmNvbS9ldGhlcmV1bS9FSVBzL2lzc3Vlcy8yMCNpc3N1ZWNvbW1lbnQtMjYzNTI0NzI5CiAgICAgICAgcmVxdWlyZSgoX3ZhbHVlID09IDApIHx8IChhbGxvd2VkW21zZy5zZW5kZXJdW19zcGVuZGVyXSA9PSAwKSk7CgogICAgICAgIGFsbG93ZWRbbXNnLnNlbmRlcl1bX3NwZW5kZXJdID0gX3ZhbHVlOwogICAgICAgIEFwcHJvdmFsKG1zZy5zZW5kZXIsIF9zcGVuZGVyLCBfdmFsdWUpOwogICAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIC8vIFRyYW5zZmVyIG9mIHRva2VucyBmcm9tIHRoZSB0cnVzdGVkIGFkZHJlc3MgX2Zyb20gdG8gdGhlIGFkZHJlc3MgX3RvIGluIHRoZSBudW1iZXIgX3ZhbHVlCiAgICBmdW5jdGlvbiB0cmFuc2ZlckZyb20oYWRkcmVzcyBfZnJvbSwgYWRkcmVzcyBfdG8sIHVpbnQyNTYgX3ZhbHVlKSBwdWJsaWMgd2hlbk5vdFBhdXNlZCByZXR1cm5zIChib29sKSB7CgogICAgICAgIHVpbnQyNTYgYXZhaWxhYmxlID0gYmFsYW5jZXNbX2Zyb21dLnN1Yih2YWx1ZUJsb2NrZWQoX2Zyb20pKTsKICAgICAgICByZXF1aXJlKF92YWx1ZSA8PSBhdmFpbGFibGUpOwoKICAgICAgICB2YXIgX2FsbG93YW5jZSA9IGFsbG93ZWRbX2Zyb21dW21zZy5zZW5kZXJdOwoKICAgICAgICAvLyBDaGVjayBpcyBub3QgbmVlZGVkIGJlY2F1c2Ugc3ViKF9hbGxvd2FuY2UsIF92YWx1ZSkgd2lsbCBhbHJlYWR5IHRocm93IGlmIHRoaXMgY29uZGl0aW9uIGlzIG5vdCBtZXQKICAgICAgICAvLyByZXF1aXJlIChfdmFsdWUgPD0gX2FsbG93YW5jZSk7CgogICAgICAgIHJlcXVpcmUgKF92YWx1ZSA+IDApOwoKICAgICAgICBiYWxhbmNlc1tfZnJvbV0gPSBiYWxhbmNlc1tfZnJvbV0uc3ViKF92YWx1ZSk7CiAgICAgICAgYmFsYW5jZXNbX3RvXSA9IGJhbGFuY2VzW190b10uYWRkKF92YWx1ZSk7CiAgICAgICAgYWxsb3dlZFtfZnJvbV1bbXNnLnNlbmRlcl0gPSBfYWxsb3dhbmNlLnN1YihfdmFsdWUpOwogICAgICAgIFRyYW5zZmVyKF9mcm9tLCBfdG8sIF92YWx1ZSk7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgLy8gSXNzdWUgbmV3IHRva2VucyB0byB0aGUgYWRkcmVzcyBfdG8gaW4gdGhlIGFtb3VudCBfYW1vdW50LiBBdmFpbGFibGUgdG8gdGhlIG93bmVyIG9mIHRoZSBjb250cmFjdCAoY29udHJhY3QgQ3Jvd2RzYWxlKQogICAgZnVuY3Rpb24gbWludChhZGRyZXNzIF90bywgdWludDI1NiBfYW1vdW50KSBwdWJsaWMgb25seU93bmVyIGNhbk1pbnQgcmV0dXJucyAoYm9vbCkgewogICAgICAgIHRvdGFsU3VwcGx5ID0gdG90YWxTdXBwbHkuYWRkKF9hbW91bnQpOwogICAgICAgIGJhbGFuY2VzW190b10gPSBiYWxhbmNlc1tfdG9dLmFkZChfYW1vdW50KTsKICAgICAgICBNaW50KF90bywgX2Ftb3VudCk7CiAgICAgICAgVHJhbnNmZXIoMHgwLCBfdG8sIF9hbW91bnQpOwogICAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIC8vIFN0b3AgdGhlIHJlbGVhc2Ugb2YgdG9rZW5zLiBUaGlzIGlzIG5vdCBwb3NzaWJsZSB0byBjYW5jZWwuIEF2YWlsYWJsZSB0byB0aGUgb3duZXIgb2YgdGhlIGNvbnRyYWN0LgogICAgZnVuY3Rpb24gZmluaXNoTWludGluZygpIHB1YmxpYyBvbmx5T3duZXIgcmV0dXJucyAoYm9vbCkgewogICAgCW1pbnRpbmdGaW5pc2hlZCA9IHRydWU7CiAgICAgICAgTWludEZpbmlzaGVkKCk7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgLy8gUmVkZWZpbml0aW9uIG9mIHRoZSBtZXRob2Qgb2YgdGhlIHJldHVybmluZyBzdGF0dXMgb2YgdGhlICJFeGNoYW5nZSBwYXVzZSIuCiAgICAvLyBOZXZlciBmb3IgdGhlIG93bmVyIG9mIGFuIHVucGF1c2VkIHdhbGxldC4KICAgIGZ1bmN0aW9uIHBhdXNlZCgpIHB1YmxpYyBjb25zdGFudCByZXR1cm5zKGJvb2wpIHsKICAgICAgICByZXR1cm4gc3VwZXIucGF1c2VkKCkgJiYgIXVucGF1c2VkV2FsbGV0W21zZy5zZW5kZXJdOwogICAgfQoKICAgIC8vIEFkZCBhIHdhbGxldCBpZ25vcmluZyB0aGUgIkV4Y2hhbmdlIHBhdXNlIi4gQXZhaWxhYmxlIHRvIHRoZSBvd25lciBvZiB0aGUgY29udHJhY3QuCiAgICBmdW5jdGlvbiBhZGRVbnBhdXNlZFdhbGxldChhZGRyZXNzIF93YWxsZXQpIHB1YmxpYyBvbmx5T3duZXIgewogICAgICAgIHVucGF1c2VkV2FsbGV0W193YWxsZXRdID0gdHJ1ZTsKICAgIH0KCiAgICAvLyBSZW1vdmUgdGhlIHdhbGxldCBpZ25vcmluZyB0aGUgIkV4Y2hhbmdlIHBhdXNlIi4gQXZhaWxhYmxlIHRvIHRoZSBvd25lciBvZiB0aGUgY29udHJhY3QuCiAgICBmdW5jdGlvbiBkZWxVbnBhdXNlZFdhbGxldChhZGRyZXNzIF93YWxsZXQpIHB1YmxpYyBvbmx5T3duZXIgewogICAgICAgIHVucGF1c2VkV2FsbGV0W193YWxsZXRdID0gZmFsc2U7CiAgICB9CgogICAgLy8gRW5hYmxlIHRoZSB0cmFuc2ZlciBvZiBjdXJyZW50IHRva2VucyB0byBvdGhlcnMuIE9ubHkgMSB0aW1lLiBEaXNhYmxpbmcgdGhpcyBpcyBub3QgcG9zc2libGUuCiAgICAvLyBBdmFpbGFibGUgdG8gdGhlIG93bmVyIG9mIHRoZSBjb250cmFjdC4KICAgIGZ1bmN0aW9uIHNldE1pZ3JhdGlvbkFnZW50KGFkZHJlc3MgX21pZ3JhdGlvbkFnZW50KSBwdWJsaWMgb25seU93bmVyIHsKICAgICAgICByZXF1aXJlKG1pZ3JhdGlvbkFnZW50ID09IDB4MCk7CiAgICAgICAgbWlncmF0aW9uQWdlbnQgPSBfbWlncmF0aW9uQWdlbnQ7CiAgICB9CgogICAgZnVuY3Rpb24gbWlncmF0ZUFsbChhZGRyZXNzW10gX2hvbGRlcnMpIHB1YmxpYyBvbmx5T3duZXIgewogICAgICAgIHJlcXVpcmUobWlncmF0aW9uQWdlbnQgIT0gMHgwKTsKICAgICAgICB1aW50MjU2IHRvdGFsID0gMDsKICAgICAgICB1aW50MjU2IHZhbHVlOwogICAgICAgIGZvcih1aW50IGkgPSAwOyBpIDwgX2hvbGRlcnMubGVuZ3RoOyBpKyspewogICAgICAgICAgICB2YWx1ZSA9IGJhbGFuY2VzW19ob2xkZXJzW2ldXTsKICAgICAgICAgICAgaWYodmFsdWUgPiAwKXsKICAgICAgICAgICAgICAgIGJhbGFuY2VzW19ob2xkZXJzW2ldXSA9IDA7CiAgICAgICAgICAgICAgICB0b3RhbCA9IHRvdGFsLmFkZCh2YWx1ZSk7CiAgICAgICAgICAgICAgICBNaWdyYXRpb25BZ2VudChtaWdyYXRpb25BZ2VudCkubWlncmF0ZUZyb20oX2hvbGRlcnNbaV0sIHZhbHVlKTsKICAgICAgICAgICAgICAgIE1pZ3JhdGUoX2hvbGRlcnNbaV0sbWlncmF0aW9uQWdlbnQsdmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRvdGFsU3VwcGx5ID0gdG90YWxTdXBwbHkuc3ViKHRvdGFsKTsKICAgICAgICAgICAgdG90YWxNaWdyYXRlZCA9IHRvdGFsTWlncmF0ZWQuYWRkKHRvdGFsKTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gbWlncmF0aW9uKGFkZHJlc3MgX2hvbGRlcikgaW50ZXJuYWwgewogICAgICAgIHJlcXVpcmUobWlncmF0aW9uQWdlbnQgIT0gMHgwKTsKICAgICAgICB1aW50MjU2IHZhbHVlID0gYmFsYW5jZXNbX2hvbGRlcl07CiAgICAgICAgcmVxdWlyZSh2YWx1ZSA+IDApOwogICAgICAgIGJhbGFuY2VzW19ob2xkZXJdID0gMDsKICAgICAgICB0b3RhbFN1cHBseSA9IHRvdGFsU3VwcGx5LnN1Yih2YWx1ZSk7CiAgICAgICAgdG90YWxNaWdyYXRlZCA9IHRvdGFsTWlncmF0ZWQuYWRkKHZhbHVlKTsKICAgICAgICBNaWdyYXRpb25BZ2VudChtaWdyYXRpb25BZ2VudCkubWlncmF0ZUZyb20oX2hvbGRlciwgdmFsdWUpOwogICAgICAgIE1pZ3JhdGUoX2hvbGRlcixtaWdyYXRpb25BZ2VudCx2YWx1ZSk7CgogICAgfQoKICAgIC8vIFJlaXNzdWUgeW91ciB0b2tlbnMuCiAgICBmdW5jdGlvbiBtaWdyYXRlKCkgcHVibGljCiAgICB7CiAgICAgICAgbWlncmF0aW9uKG1zZy5zZW5kZXIpOwogICAgfQp9CgoKLy8gKEEzKQovLyBDb250cmFjdCBmb3IgZnJlZXppbmcgb2YgaW52ZXN0b3JzJyBmdW5kcy4gSGVuY2UsIGludmVzdG9ycyB3aWxsIGJlIGFibGUgdG8gd2l0aGRyYXcgbW9uZXkgaWYgdGhlCi8vIHJvdW5kIGRvZXMgbm90IGF0dGFpbiB0aGUgc29mdGNhcC4gRnJvbSBoZXJlIHRoZSB3YWxsZXQgb2YgdGhlIGJlbmVmaWNpYXJ5IHdpbGwgcmVjZWl2ZSBhbGwgdGhlCi8vIG1vbmV5IChuYW1lbHksIHRoZSBiZW5lZmljaWFyeSwgbm90IHRoZSBtYW5hZ2VyJ3Mgd2FsbGV0KS4KY29udHJhY3QgUmVmdW5kVmF1bHQgaXMgT3duYWJsZSB7CiAgICB1c2luZyBTYWZlTWF0aCBmb3IgdWludDI1NjsKCiAgICBlbnVtIFN0YXRlIHsgQWN0aXZlLCBSZWZ1bmRpbmcsIENsb3NlZCB9CgogICAgbWFwcGluZyAoYWRkcmVzcyA9PiB1aW50MjU2KSBwdWJsaWMgZGVwb3NpdGVkOwogICAgU3RhdGUgcHVibGljIHN0YXRlOwoKICAgIGV2ZW50IENsb3NlZCgpOwogICAgZXZlbnQgUmVmdW5kc0VuYWJsZWQoKTsKICAgIGV2ZW50IFJlZnVuZGVkKGFkZHJlc3MgaW5kZXhlZCBiZW5lZmljaWFyeSwgdWludDI1NiB3ZWlBbW91bnQpOwogICAgZXZlbnQgRGVwb3NpdGVkKGFkZHJlc3MgaW5kZXhlZCBiZW5lZmljaWFyeSwgdWludDI1NiB3ZWlBbW91bnQpOwoKICAgIGZ1bmN0aW9uIFJlZnVuZFZhdWx0KCkgcHVibGljIHsKICAgICAgICBzdGF0ZSA9IFN0YXRlLkFjdGl2ZTsKICAgIH0KCiAgICAvLyBEZXBvc2l0aW5nIGZ1bmRzIG9uIGJlaGFsZiBvZiBhbiBUb2tlblNhbGUgaW52ZXN0b3IuIEF2YWlsYWJsZSB0byB0aGUgb3duZXIgb2YgdGhlIGNvbnRyYWN0IChDcm93ZHNhbGUgQ29udHJhY3QpLgogICAgZnVuY3Rpb24gZGVwb3NpdChhZGRyZXNzIGludmVzdG9yKSBvbmx5T3duZXIgcHVibGljIHBheWFibGUgewogICAgICAgIHJlcXVpcmUoc3RhdGUgPT0gU3RhdGUuQWN0aXZlKTsKICAgICAgICBkZXBvc2l0ZWRbaW52ZXN0b3JdID0gZGVwb3NpdGVkW2ludmVzdG9yXS5hZGQobXNnLnZhbHVlKTsKICAgICAgICBEZXBvc2l0ZWQoaW52ZXN0b3IsbXNnLnZhbHVlKTsKICAgIH0KCiAgICAvLyBNb3ZlIHRoZSBjb2xsZWN0ZWQgZnVuZHMgdG8gYSBzcGVjaWZpZWQgYWRkcmVzcy4gQXZhaWxhYmxlIHRvIHRoZSBvd25lciBvZiB0aGUgY29udHJhY3QuCiAgICBmdW5jdGlvbiBjbG9zZShhZGRyZXNzIF93YWxsZXQpIG9ubHlPd25lciBwdWJsaWMgewogICAgICAgIHJlcXVpcmUoc3RhdGUgPT0gU3RhdGUuQWN0aXZlKTsKICAgICAgICByZXF1aXJlKF93YWxsZXQgIT0gMHgwKTsKICAgICAgICBzdGF0ZSA9IFN0YXRlLkNsb3NlZDsKICAgICAgICBDbG9zZWQoKTsKICAgICAgICBfd2FsbGV0LnRyYW5zZmVyKHRoaXMuYmFsYW5jZSk7CiAgICB9CgogICAgLy8gQWxsb3cgcmVmdW5kIHRvIGludmVzdG9ycy4gQXZhaWxhYmxlIHRvIHRoZSBvd25lciBvZiB0aGUgY29udHJhY3QuCiAgICBmdW5jdGlvbiBlbmFibGVSZWZ1bmRzKCkgb25seU93bmVyIHB1YmxpYyB7CiAgICAgICAgcmVxdWlyZShzdGF0ZSA9PSBTdGF0ZS5BY3RpdmUpOwogICAgICAgIHN0YXRlID0gU3RhdGUuUmVmdW5kaW5nOwogICAgICAgIFJlZnVuZHNFbmFibGVkKCk7CiAgICB9CgogICAgLy8gUmV0dXJuIHRoZSBmdW5kcyB0byBhIHNwZWNpZmllZCBpbnZlc3Rvci4gSW4gY2FzZSBvZiBmYWlsdXJlIG9mIHRoZSByb3VuZCwgdGhlIGludmVzdG9yCiAgICAvLyBzaG91bGQgY2FsbCB0aGlzIG1ldGhvZCBvZiB0aGlzIGNvbnRyYWN0IChSZWZ1bmRWYXVsdCkgb3IgY2FsbCB0aGUgbWV0aG9kIGNsYWltUmVmdW5kIG9mIENyb3dkc2FsZQogICAgLy8gY29udHJhY3QuIFRoaXMgZnVuY3Rpb24gc2hvdWxkIGJlIGNhbGxlZCBlaXRoZXIgYnkgdGhlIGludmVzdG9yIGhpbXNlbGYsIG9yIHRoZSBjb21wYW55CiAgICAvLyAob3IgYW55b25lKSBjYW4gY2FsbCB0aGlzIGZ1bmN0aW9uIGluIHRoZSBsb29wIHRvIHJldHVybiBmdW5kcyB0byBhbGwgaW52ZXN0b3JzIGVuIG1hc3NlLgogICAgZnVuY3Rpb24gcmVmdW5kKGFkZHJlc3MgaW52ZXN0b3IpIHB1YmxpYyB7CiAgICAgICAgcmVxdWlyZShzdGF0ZSA9PSBTdGF0ZS5SZWZ1bmRpbmcpOwogICAgICAgIHJlcXVpcmUoZGVwb3NpdGVkW2ludmVzdG9yXSA+IDApOwogICAgICAgIHVpbnQyNTYgZGVwb3NpdGVkVmFsdWUgPSBkZXBvc2l0ZWRbaW52ZXN0b3JdOwogICAgICAgIGRlcG9zaXRlZFtpbnZlc3Rvcl0gPSAwOwogICAgICAgIGludmVzdG9yLnRyYW5zZmVyKGRlcG9zaXRlZFZhbHVlKTsKICAgICAgICBSZWZ1bmRlZChpbnZlc3RvciwgZGVwb3NpdGVkVmFsdWUpOwogICAgfQoKICAgIC8vIERlc3RydWN0aW9uIG9mIHRoZSBjb250cmFjdCB3aXRoIHJldHVybiBvZiBmdW5kcyB0byB0aGUgc3BlY2lmaWVkIGFkZHJlc3MuIEF2YWlsYWJsZSB0bwogICAgLy8gdGhlIG93bmVyIG9mIHRoZSBjb250cmFjdC4KICAgIGZ1bmN0aW9uIGRlbChhZGRyZXNzIF93YWxsZXQpIGV4dGVybmFsIG9ubHlPd25lciB7CiAgICAgICAgc2VsZmRlc3RydWN0KF93YWxsZXQpOwogICAgfQp9Cgpjb250cmFjdCBEaXN0cmlidXRvclJlZnVuZFZhdWx0IGlzIFJlZnVuZFZhdWx0ewogCiAgICBhZGRyZXNzIHB1YmxpYyB0YXhDb2xsZWN0b3I7CiAgICB1aW50MjU2IHB1YmxpYyB0YXhWYWx1ZTsKICAgIAogICAgZnVuY3Rpb24gRGlzdHJpYnV0b3JSZWZ1bmRWYXVsdChhZGRyZXNzIF90YXhDb2xsZWN0b3IsIHVpbnQyNTYgX3RheFZhbHVlKSBSZWZ1bmRWYXVsdCgpIHB1YmxpY3sKICAgICAgICB0YXhDb2xsZWN0b3IgPSBfdGF4Q29sbGVjdG9yOwogICAgICAgIHRheFZhbHVlID0gX3RheFZhbHVlOwogICAgfQogICAKICAgIGZ1bmN0aW9uIGNsb3NlKGFkZHJlc3MgX3dhbGxldCkgb25seU93bmVyIHB1YmxpYyB7CiAgICAKICAgICAgICByZXF1aXJlKHN0YXRlID09IFN0YXRlLkFjdGl2ZSk7CiAgICAgICAgcmVxdWlyZShfd2FsbGV0ICE9IDB4MCk7CiAgICAgICAgCiAgICAgICAgc3RhdGUgPSBTdGF0ZS5DbG9zZWQ7CiAgICAgICAgQ2xvc2VkKCk7CiAgICAgICAgdWludDI1NiBhbGxQYXkgPSB0aGlzLmJhbGFuY2U7CiAgICAgICAgdWludDI1NiBmb3JUYXJnZXQxOwogICAgICAgIHVpbnQyNTYgZm9yVGFyZ2V0MjsKICAgICAgICBpZih0YXhWYWx1ZSA8PSBhbGxQYXkpewogICAgICAgICAgIGZvclRhcmdldDEgPSB0YXhWYWx1ZTsKICAgICAgICAgICBmb3JUYXJnZXQyID0gYWxsUGF5LnN1Yih0YXhWYWx1ZSk7CiAgICAgICAgICAgdGF4VmFsdWUgPSAwOwogICAgICAgIH1lbHNlIHsKICAgICAgICAgICAgdGF4VmFsdWUgPSB0YXhWYWx1ZS5zdWIoYWxsUGF5KTsKICAgICAgICAgICAgZm9yVGFyZ2V0MSA9IGFsbFBheTsKICAgICAgICAgICAgZm9yVGFyZ2V0MiA9IDA7CiAgICAgICAgfQogICAgICAgIGlmKGZvclRhcmdldDEgIT0gMCl7CiAgICAgICAgICAgIHRheENvbGxlY3Rvci50cmFuc2Zlcihmb3JUYXJnZXQxKTsKICAgICAgICB9CiAgICAgICAKICAgICAgICBpZihmb3JUYXJnZXQyICE9IDApewogICAgICAgICAgICBfd2FsbGV0LnRyYW5zZmVyKGZvclRhcmdldDIpOwogICAgICAgIH0KCiAgICB9Cgp9CgoKLy8gKEIpCi8vIFRoZSBjb250cmFjdCBmb3IgZnJlZXppbmcgdG9rZW5zIGZvciB0aGUgdGVhbS4uCmNvbnRyYWN0IFNWVEFsbG9jYXRpb24gewogICAgdXNpbmcgU2FmZU1hdGggZm9yIHVpbnQyNTY7CgogICAgVG9rZW5MIHB1YmxpYyB0b2tlbjsKCiAgICBhZGRyZXNzIHB1YmxpYyBvd25lcjsKCiAgICB1aW50MjU2IHB1YmxpYyB1bmxvY2tlZEF0OwoKICAgIC8vIFRoZSBjb250cmFjdCB0YWtlcyB0aGUgRVJDMjAgY29pbiBhZGRyZXNzIGZyb20gd2hpY2ggdGhpcyBjb250cmFjdCB3aWxsIHdvcmsgYW5kIGZyb20gdGhlCiAgICAvLyBvd25lciAoVGVhbSB3YWxsZXQpIHdobyBvd25zIHRoZSBmdW5kcy4KICAgIGZ1bmN0aW9uIFNWVEFsbG9jYXRpb24oVG9rZW5MIF90b2tlbiwgYWRkcmVzcyBfb3duZXIpIHB1YmxpY3sKCiAgICAgICAgLy8gSG93IG1hbnkgZGF5cyB0byBmcmVlemUgZnJvbSB0aGUgbW9tZW50IG9mIGZpbmFsaXppbmcgUm91bmQyCiAgICAgICAgdW5sb2NrZWRBdCA9IG5vdyArIDEgeWVhcnM7CgogICAgICAgIHRva2VuID0gX3Rva2VuOwogICAgICAgIG93bmVyID0gX293bmVyOwogICAgfQoKICAgIGZ1bmN0aW9uIGNoYW5nZVRva2VuKFRva2VuTCBfdG9rZW4pIGV4dGVybmFsewogICAgICAgIHJlcXVpcmUobXNnLnNlbmRlciA9PSBvd25lcik7CiAgICAgICAgdG9rZW4gPSBfdG9rZW47CiAgICB9CgoKICAgIC8vIElmIHRoZSB0aW1lIG9mIGZyZWV6aW5nIGV4cGlyZWQgd2lsbCByZXR1cm4gdGhlIGZ1bmRzIHRvIHRoZSBvd25lci4KICAgIGZ1bmN0aW9uIHVubG9jaygpIGV4dGVybmFsewogICAgICAgIHJlcXVpcmUobm93ID49IHVubG9ja2VkQXQpOwogICAgICAgIHJlcXVpcmUodG9rZW4udHJhbnNmZXIob3duZXIsdG9rZW4uYmFsYW5jZU9mKHRoaXMpKSk7CiAgICB9Cn0='.
	

]
