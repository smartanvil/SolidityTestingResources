Class {
	#name : #SRTfc668AE14b0F7702c04b105448fE733D96C558DF,
	#superclass : #SRTContracts,
	#category : #SolidityTestingResources
}

{ #category : #base64 }
SRTfc668AE14b0F7702c04b105448fE733D96C558DF >> base64 [
	^ 'cHJhZ21hIHNvbGlkaXR5IF4wLjQuODsKCi8vc29sYyAtLWJpbiAtLWFiaSAtLW9wdGltaXplICAtLW9wdGltaXplLXJ1bnMgMjAwMDAgLW8gLiBUZXN0cG9vbC5zb2wgCgpjb250cmFjdCBTSEEzXzUxMiB7CiAgICBmdW5jdGlvbiBTSEEzXzUxMigpIHt9CiAgICAKICAgIGZ1bmN0aW9uIGtlY2Nha19mKHVpbnRbMjVdIEEpIGNvbnN0YW50IGludGVybmFsIHJldHVybnModWludFsyNV0pIHsKICAgICAgICB1aW50WzVdIG1lbW9yeSBDOwogICAgICAgIHVpbnRbNV0gbWVtb3J5IEQ7CiAgICAgICAgdWludCB4OwogICAgICAgIHVpbnQgeTsKICAgICAgICAvL3VpbnQgRF8wOyB1aW50IERfMTsgdWludCBEXzI7IHVpbnQgRF8zOyB1aW50IERfNDsKICAgICAgICB1aW50WzI1XSBtZW1vcnkgQjsKICAgICAgICAKICAgICAgICB1aW50WzI0XSBtZW1vcnkgUkM9IFsKICAgICAgICAgICAgICAgICAgIHVpbnQoMHgwMDAwMDAwMDAwMDAwMDAxKSwKICAgICAgICAgICAgICAgICAgIDB4MDAwMDAwMDAwMDAwODA4MiwKICAgICAgICAgICAgICAgICAgIDB4ODAwMDAwMDAwMDAwODA4QSwKICAgICAgICAgICAgICAgICAgIDB4ODAwMDAwMDA4MDAwODAwMCwKICAgICAgICAgICAgICAgICAgIDB4MDAwMDAwMDAwMDAwODA4QiwKICAgICAgICAgICAgICAgICAgIDB4MDAwMDAwMDA4MDAwMDAwMSwKICAgICAgICAgICAgICAgICAgIDB4ODAwMDAwMDA4MDAwODA4MSwKICAgICAgICAgICAgICAgICAgIDB4ODAwMDAwMDAwMDAwODAwOSwKICAgICAgICAgICAgICAgICAgIDB4MDAwMDAwMDAwMDAwMDA4QSwKICAgICAgICAgICAgICAgICAgIDB4MDAwMDAwMDAwMDAwMDA4OCwKICAgICAgICAgICAgICAgICAgIDB4MDAwMDAwMDA4MDAwODAwOSwKICAgICAgICAgICAgICAgICAgIDB4MDAwMDAwMDA4MDAwMDAwQSwKICAgICAgICAgICAgICAgICAgIDB4MDAwMDAwMDA4MDAwODA4QiwKICAgICAgICAgICAgICAgICAgIDB4ODAwMDAwMDAwMDAwMDA4QiwKICAgICAgICAgICAgICAgICAgIDB4ODAwMDAwMDAwMDAwODA4OSwKICAgICAgICAgICAgICAgICAgIDB4ODAwMDAwMDAwMDAwODAwMywKICAgICAgICAgICAgICAgICAgIDB4ODAwMDAwMDAwMDAwODAwMiwKICAgICAgICAgICAgICAgICAgIDB4ODAwMDAwMDAwMDAwMDA4MCwKICAgICAgICAgICAgICAgICAgIDB4MDAwMDAwMDAwMDAwODAwQSwKICAgICAgICAgICAgICAgICAgIDB4ODAwMDAwMDA4MDAwMDAwQSwKICAgICAgICAgICAgICAgICAgIDB4ODAwMDAwMDA4MDAwODA4MSwKICAgICAgICAgICAgICAgICAgIDB4ODAwMDAwMDAwMDAwODA4MCwKICAgICAgICAgICAgICAgICAgIDB4MDAwMDAwMDA4MDAwMDAwMSwKICAgICAgICAgICAgICAgICAgIDB4ODAwMDAwMDA4MDAwODAwOCBdOwogICAgICAgIAogICAgICAgIGZvciggdWludCBpID0gMCA7IGkgPCAyNCA7IGkrKyApIHsKICAgICAgICAgICAgLyoKICAgICAgICAgICAgZm9yKCB4ID0gMCA7IHggPCA1IDsgeCsrICkgewogICAgICAgICAgICAgICAgQ1t4XSA9IEFbNSp4XV5BWzUqeCsxXV5BWzUqeCsyXV5BWzUqeCszXV5BWzUqeCs0XTsgICAgICAgICAgICAgICAgCiAgICAgICAgICAgIH0qLwogICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICBDWzBdPUFbMF1eQVsxXV5BWzJdXkFbM11eQVs0XTsKICAgICAgICAgICAgQ1sxXT1BWzVdXkFbNl1eQVs3XV5BWzhdXkFbOV07CiAgICAgICAgICAgIENbMl09QVsxMF1eQVsxMV1eQVsxMl1eQVsxM11eQVsxNF07CiAgICAgICAgICAgIENbM109QVsxNV1eQVsxNl1eQVsxN11eQVsxOF1eQVsxOV07CiAgICAgICAgICAgIENbNF09QVsyMF1eQVsyMV1eQVsyMl1eQVsyM11eQVsyNF07CgogICAgICAgICAgICAvKgogICAgICAgICAgICBmb3IoIHggPSAwIDsgeCA8IDUgOyB4KysgKSB7CiAgICAgICAgICAgICAgICBEW3hdID0gQ1soeCs0KSU1XV4oKENbKHgrMSklNV0gKiAyKSYweGZmZmZmZmZmZmZmZmZmZmYgfCAoQ1soeCsxKSU1XS8oMioqNjMpKSk7CiAgICAgICAgICAgIH0qLwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgIERbMF09Q1s0XSBeICgoQ1sxXSAqIDIpJjB4ZmZmZmZmZmZmZmZmZmZmZiB8IChDWzFdIC8gKDIgKiogNjMpKSk7CiAgICAgICAgICAgIERbMV09Q1swXSBeICgoQ1syXSAqIDIpJjB4ZmZmZmZmZmZmZmZmZmZmZiB8IChDWzJdIC8gKDIgKiogNjMpKSk7CiAgICAgICAgICAgIERbMl09Q1sxXSBeICgoQ1szXSAqIDIpJjB4ZmZmZmZmZmZmZmZmZmZmZiB8IChDWzNdIC8gKDIgKiogNjMpKSk7CiAgICAgICAgICAgIERbM109Q1syXSBeICgoQ1s0XSAqIDIpJjB4ZmZmZmZmZmZmZmZmZmZmZiB8IChDWzRdIC8gKDIgKiogNjMpKSk7CiAgICAgICAgICAgIERbNF09Q1szXSBeICgoQ1swXSAqIDIpJjB4ZmZmZmZmZmZmZmZmZmZmZiB8IChDWzBdIC8gKDIgKiogNjMpKSk7CgogICAgICAgICAgICAvKgogICAgICAgICAgICBmb3IoIHggPSAwIDsgeCA8IDUgOyB4KysgKSB7CiAgICAgICAgICAgICAgICBmb3IoIHkgPSAwIDsgeSA8IDUgOyB5KysgKSB7CiAgICAgICAgICAgICAgICAgICAgQVs1KngreV0gPSBBWzUqeCt5XSBeIERbeF07CiAgICAgICAgICAgICAgICB9ICAgICAgICAgICAgCiAgICAgICAgICAgIH0qLwogICAgICAgICAgICAKCiAgICAgICAgICAgIAogICAgICAgICAgICBBWzBdPUFbMF0gXiBEWzBdOwogICAgICAgICAgICBBWzFdPUFbMV0gXiBEWzBdOwogICAgICAgICAgICBBWzJdPUFbMl0gXiBEWzBdOwogICAgICAgICAgICBBWzNdPUFbM10gXiBEWzBdOwogICAgICAgICAgICBBWzRdPUFbNF0gXiBEWzBdOwogICAgICAgICAgICBBWzVdPUFbNV0gXiBEWzFdOwogICAgICAgICAgICBBWzZdPUFbNl0gXiBEWzFdOwogICAgICAgICAgICBBWzddPUFbN10gXiBEWzFdOwogICAgICAgICAgICBBWzhdPUFbOF0gXiBEWzFdOwogICAgICAgICAgICBBWzldPUFbOV0gXiBEWzFdOwogICAgICAgICAgICBBWzEwXT1BWzEwXSBeIERbMl07CiAgICAgICAgICAgIEFbMTFdPUFbMTFdIF4gRFsyXTsKICAgICAgICAgICAgQVsxMl09QVsxMl0gXiBEWzJdOwogICAgICAgICAgICBBWzEzXT1BWzEzXSBeIERbMl07CiAgICAgICAgICAgIEFbMTRdPUFbMTRdIF4gRFsyXTsKICAgICAgICAgICAgQVsxNV09QVsxNV0gXiBEWzNdOwogICAgICAgICAgICBBWzE2XT1BWzE2XSBeIERbM107CiAgICAgICAgICAgIEFbMTddPUFbMTddIF4gRFszXTsKICAgICAgICAgICAgQVsxOF09QVsxOF0gXiBEWzNdOwogICAgICAgICAgICBBWzE5XT1BWzE5XSBeIERbM107CiAgICAgICAgICAgIEFbMjBdPUFbMjBdIF4gRFs0XTsKICAgICAgICAgICAgQVsyMV09QVsyMV0gXiBEWzRdOwogICAgICAgICAgICBBWzIyXT1BWzIyXSBeIERbNF07CiAgICAgICAgICAgIEFbMjNdPUFbMjNdIF4gRFs0XTsKICAgICAgICAgICAgQVsyNF09QVsyNF0gXiBEWzRdOwoKICAgICAgICAgICAgLypSaG8gYW5kIHBpIHN0ZXBzKi8gICAgICAgICAgICAKICAgICAgICAgICAgQlswXT1BWzBdOwogICAgICAgICAgICBCWzhdPSgoQVsxXSAqICgyICoqIDM2KSkmMHhmZmZmZmZmZmZmZmZmZmZmIHwgKEFbMV0gLyAoMiAqKiAyOCkpKTsKICAgICAgICAgICAgQlsxMV09KChBWzJdICogKDIgKiogMykpJjB4ZmZmZmZmZmZmZmZmZmZmZiB8IChBWzJdIC8gKDIgKiogNjEpKSk7CiAgICAgICAgICAgIEJbMTldPSgoQVszXSAqICgyICoqIDQxKSkmMHhmZmZmZmZmZmZmZmZmZmZmIHwgKEFbM10gLyAoMiAqKiAyMykpKTsKICAgICAgICAgICAgQlsyMl09KChBWzRdICogKDIgKiogMTgpKSYweGZmZmZmZmZmZmZmZmZmZmYgfCAoQVs0XSAvICgyICoqIDQ2KSkpOwogICAgICAgICAgICBCWzJdPSgoQVs1XSAqICgyICoqIDEpKSYweGZmZmZmZmZmZmZmZmZmZmYgfCAoQVs1XSAvICgyICoqIDYzKSkpOwogICAgICAgICAgICBCWzVdPSgoQVs2XSAqICgyICoqIDQ0KSkmMHhmZmZmZmZmZmZmZmZmZmZmIHwgKEFbNl0gLyAoMiAqKiAyMCkpKTsKICAgICAgICAgICAgQlsxM109KChBWzddICogKDIgKiogMTApKSYweGZmZmZmZmZmZmZmZmZmZmYgfCAoQVs3XSAvICgyICoqIDU0KSkpOwogICAgICAgICAgICBCWzE2XT0oKEFbOF0gKiAoMiAqKiA0NSkpJjB4ZmZmZmZmZmZmZmZmZmZmZiB8IChBWzhdIC8gKDIgKiogMTkpKSk7CiAgICAgICAgICAgIEJbMjRdPSgoQVs5XSAqICgyICoqIDIpKSYweGZmZmZmZmZmZmZmZmZmZmYgfCAoQVs5XSAvICgyICoqIDYyKSkpOwogICAgICAgICAgICBCWzRdPSgoQVsxMF0gKiAoMiAqKiA2MikpJjB4ZmZmZmZmZmZmZmZmZmZmZiB8IChBWzEwXSAvICgyICoqIDIpKSk7CiAgICAgICAgICAgIEJbN109KChBWzExXSAqICgyICoqIDYpKSYweGZmZmZmZmZmZmZmZmZmZmYgfCAoQVsxMV0gLyAoMiAqKiA1OCkpKTsKICAgICAgICAgICAgQlsxMF09KChBWzEyXSAqICgyICoqIDQzKSkmMHhmZmZmZmZmZmZmZmZmZmZmIHwgKEFbMTJdIC8gKDIgKiogMjEpKSk7CiAgICAgICAgICAgIEJbMThdPSgoQVsxM10gKiAoMiAqKiAxNSkpJjB4ZmZmZmZmZmZmZmZmZmZmZiB8IChBWzEzXSAvICgyICoqIDQ5KSkpOwogICAgICAgICAgICBCWzIxXT0oKEFbMTRdICogKDIgKiogNjEpKSYweGZmZmZmZmZmZmZmZmZmZmYgfCAoQVsxNF0gLyAoMiAqKiAzKSkpOwogICAgICAgICAgICBCWzFdPSgoQVsxNV0gKiAoMiAqKiAyOCkpJjB4ZmZmZmZmZmZmZmZmZmZmZiB8IChBWzE1XSAvICgyICoqIDM2KSkpOwogICAgICAgICAgICBCWzldPSgoQVsxNl0gKiAoMiAqKiA1NSkpJjB4ZmZmZmZmZmZmZmZmZmZmZiB8IChBWzE2XSAvICgyICoqIDkpKSk7CiAgICAgICAgICAgIEJbMTJdPSgoQVsxN10gKiAoMiAqKiAyNSkpJjB4ZmZmZmZmZmZmZmZmZmZmZiB8IChBWzE3XSAvICgyICoqIDM5KSkpOwogICAgICAgICAgICBCWzE1XT0oKEFbMThdICogKDIgKiogMjEpKSYweGZmZmZmZmZmZmZmZmZmZmYgfCAoQVsxOF0gLyAoMiAqKiA0MykpKTsKICAgICAgICAgICAgQlsyM109KChBWzE5XSAqICgyICoqIDU2KSkmMHhmZmZmZmZmZmZmZmZmZmZmIHwgKEFbMTldIC8gKDIgKiogOCkpKTsKICAgICAgICAgICAgQlszXT0oKEFbMjBdICogKDIgKiogMjcpKSYweGZmZmZmZmZmZmZmZmZmZmYgfCAoQVsyMF0gLyAoMiAqKiAzNykpKTsKICAgICAgICAgICAgQls2XT0oKEFbMjFdICogKDIgKiogMjApKSYweGZmZmZmZmZmZmZmZmZmZmYgfCAoQVsyMV0gLyAoMiAqKiA0NCkpKTsKICAgICAgICAgICAgQlsxNF09KChBWzIyXSAqICgyICoqIDM5KSkmMHhmZmZmZmZmZmZmZmZmZmZmIHwgKEFbMjJdIC8gKDIgKiogMjUpKSk7CiAgICAgICAgICAgIEJbMTddPSgoQVsyM10gKiAoMiAqKiA4KSkmMHhmZmZmZmZmZmZmZmZmZmZmIHwgKEFbMjNdIC8gKDIgKiogNTYpKSk7CiAgICAgICAgICAgIEJbMjBdPSgoQVsyNF0gKiAoMiAqKiAxNCkpJjB4ZmZmZmZmZmZmZmZmZmZmZiB8IChBWzI0XSAvICgyICoqIDUwKSkpOwoKICAgICAgICAgICAgLypYaSBzdGF0ZSovCiAgICAgICAgICAgIC8qCiAgICAgICAgICAgIGZvciggeCA9IDAgOyB4IDwgNSA7IHgrKyApIHsKICAgICAgICAgICAgICAgIGZvciggeSA9IDAgOyB5IDwgNSA7IHkrKyApIHsKICAgICAgICAgICAgICAgICAgICBBWzUqeCt5XSA9IEJbNSp4K3ldXigofkJbNSooKHgrMSklNSkreV0pICYgQls1KigoeCsyKSU1KSt5XSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0qLwogICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgIEFbMF09QlswXV4oKH5CWzVdKSAmIEJbMTBdKTsKICAgICAgICAgICAgQVsxXT1CWzFdXigofkJbNl0pICYgQlsxMV0pOwogICAgICAgICAgICBBWzJdPUJbMl1eKCh+Qls3XSkgJiBCWzEyXSk7CiAgICAgICAgICAgIEFbM109QlszXV4oKH5CWzhdKSAmIEJbMTNdKTsKICAgICAgICAgICAgQVs0XT1CWzRdXigofkJbOV0pICYgQlsxNF0pOwogICAgICAgICAgICBBWzVdPUJbNV1eKCh+QlsxMF0pICYgQlsxNV0pOwogICAgICAgICAgICBBWzZdPUJbNl1eKCh+QlsxMV0pICYgQlsxNl0pOwogICAgICAgICAgICBBWzddPUJbN11eKCh+QlsxMl0pICYgQlsxN10pOwogICAgICAgICAgICBBWzhdPUJbOF1eKCh+QlsxM10pICYgQlsxOF0pOwogICAgICAgICAgICBBWzldPUJbOV1eKCh+QlsxNF0pICYgQlsxOV0pOwogICAgICAgICAgICBBWzEwXT1CWzEwXV4oKH5CWzE1XSkgJiBCWzIwXSk7CiAgICAgICAgICAgIEFbMTFdPUJbMTFdXigofkJbMTZdKSAmIEJbMjFdKTsKICAgICAgICAgICAgQVsxMl09QlsxMl1eKCh+QlsxN10pICYgQlsyMl0pOwogICAgICAgICAgICBBWzEzXT1CWzEzXV4oKH5CWzE4XSkgJiBCWzIzXSk7CiAgICAgICAgICAgIEFbMTRdPUJbMTRdXigofkJbMTldKSAmIEJbMjRdKTsKICAgICAgICAgICAgQVsxNV09QlsxNV1eKCh+QlsyMF0pICYgQlswXSk7CiAgICAgICAgICAgIEFbMTZdPUJbMTZdXigofkJbMjFdKSAmIEJbMV0pOwogICAgICAgICAgICBBWzE3XT1CWzE3XV4oKH5CWzIyXSkgJiBCWzJdKTsKICAgICAgICAgICAgQVsxOF09QlsxOF1eKCh+QlsyM10pICYgQlszXSk7CiAgICAgICAgICAgIEFbMTldPUJbMTldXigofkJbMjRdKSAmIEJbNF0pOwogICAgICAgICAgICBBWzIwXT1CWzIwXV4oKH5CWzBdKSAmIEJbNV0pOwogICAgICAgICAgICBBWzIxXT1CWzIxXV4oKH5CWzFdKSAmIEJbNl0pOwogICAgICAgICAgICBBWzIyXT1CWzIyXV4oKH5CWzJdKSAmIEJbN10pOwogICAgICAgICAgICBBWzIzXT1CWzIzXV4oKH5CWzNdKSAmIEJbOF0pOwogICAgICAgICAgICBBWzI0XT1CWzI0XV4oKH5CWzRdKSAmIEJbOV0pOwoKICAgICAgICAgICAgLypMYXN0IHN0ZXAqLwogICAgICAgICAgICBBWzBdPUFbMF1eUkNbaV07ICAgICAgICAgICAgCiAgICAgICAgfQoKICAgICAgICAKICAgICAgICByZXR1cm4gQTsKICAgIH0KIAogICAgCiAgICBmdW5jdGlvbiBzcG9uZ2UodWludFs5XSBNKSBjb25zdGFudCBpbnRlcm5hbCByZXR1cm5zKHVpbnRbMTZdKSB7CiAgICAgICAgaWYoIChNLmxlbmd0aCAqIDgpICE9IDcyICkgdGhyb3c7CiAgICAgICAgTVs1XSA9IDB4MDE7CiAgICAgICAgTVs4XSA9IDB4ODAwMDAwMDAwMDAwMDAwMDsKICAgICAgICAKICAgICAgICB1aW50IHIgPSA3MjsKICAgICAgICB1aW50IHcgPSA4OwogICAgICAgIHVpbnQgc2l6ZSA9IE0ubGVuZ3RoICogODsKICAgICAgICAKICAgICAgICB1aW50WzI1XSBtZW1vcnkgUzsKICAgICAgICB1aW50IGk7IHVpbnQgeTsgdWludCB4OwogICAgICAgIC8qQWJzb3JiaW5nIFBoYXNlKi8KICAgICAgICBmb3IoIGkgPSAwIDsgaSA8IHNpemUvciA7IGkrKyApIHsKICAgICAgICAgICAgZm9yKCB5ID0gMCA7IHkgPCA1IDsgeSsrICkgewogICAgICAgICAgICAgICAgZm9yKCB4ID0gMCA7IHggPCA1IDsgeCsrICkgewogICAgICAgICAgICAgICAgICAgIGlmKCAoeCs1KnkpIDwgKHIvdykgKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIFNbNSp4K3ldID0gU1s1KngreV0gXiBNW2kqOSArIHggKyA1KnldOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBTID0ga2VjY2FrX2YoUyk7CiAgICAgICAgfQoKICAgICAgICAvKlNxdWVlemluZyBwaGFzZSovCiAgICAgICAgdWludFsxNl0gbWVtb3J5IHJlc3VsdDsKICAgICAgICB1aW50IGIgPSAwOwogICAgICAgIHdoaWxlKCBiIDwgMTYgKSB7CiAgICAgICAgICAgIGZvciggeSA9IDAgOyB5IDwgNSA7IHkrKyApIHsKICAgICAgICAgICAgICAgIGZvciggeCA9IDAgOyB4IDwgNSA7IHgrKyApIHsKICAgICAgICAgICAgICAgICAgICBpZiggKHgrNSp5KTwoci93KSAmJiAoYjwxNikgKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdFtiXSA9IFNbNSp4K3ldICYgMHhGRkZGRkZGRjsgCiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdFtiKzFdID0gU1s1KngreV0gLyAweDEwMDAwMDAwMDsKICAgICAgICAgICAgICAgICAgICAgICAgYis9MjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgIAogICAgICAgIHJldHVybiByZXN1bHQ7CiAgIH0KCn0KCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgpjb250cmFjdCBFdGhhc2ggaXMgU0hBM181MTIgewogICAgCiAgICBtYXBwaW5nKGFkZHJlc3M9PmJvb2wpIHB1YmxpYyBvd25lcnM7CiAgICAKICAgIGZ1bmN0aW9uIEV0aGFzaChhZGRyZXNzWzNdIF9vd25lcnMpIHsKICAgICAgICBvd25lcnNbX293bmVyc1swXV0gPSB0cnVlOwogICAgICAgIG93bmVyc1tfb3duZXJzWzFdXSA9IHRydWU7CiAgICAgICAgb3duZXJzW19vd25lcnNbMl1dID0gdHJ1ZTsgICAgICAgICAgICAgICAgCiAgICB9CiAgICAgCiAgICBmdW5jdGlvbiBmbnYoIHVpbnQgdjEsIHVpbnQgdjIgKSBjb25zdGFudCBpbnRlcm5hbCByZXR1cm5zKHVpbnQpIHsKICAgICAgICByZXR1cm4gKCh2MSoweDAxMDAwMTkzKSBeIHYyKSAmIDB4RkZGRkZGRkY7CiAgICB9CgoKCiAgICBmdW5jdGlvbiBjb21wdXRlQ2FjaGVSb290KCB1aW50IGluZGV4LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdWludCBpbmRleEluRWxlbWVudHNBcnJheSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVpbnRbXSBlbGVtZW50cywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVpbnRbXSB3aXRuZXNzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdWludCBicmFuY2hTaXplICkgY29uc3RhbnQgcHJpdmF0ZSByZXR1cm5zKHVpbnQpIHsKIAogICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgIHVpbnQgbGVhZiA9IGNvbXB1dGVMZWFmKGVsZW1lbnRzLCBpbmRleEluRWxlbWVudHNBcnJheSkgJiAweEZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGOwoKICAgICAgICB1aW50IGxlZnQ7CiAgICAgICAgdWludCByaWdodDsKICAgICAgICB1aW50IG5vZGU7CiAgICAgICAgYm9vbCBvZGRCcmFuY2hTaXplID0gKGJyYW5jaFNpemUgJSAyKSA+IDA7CiAgICAgICAgIAogICAgICAgIGFzc2VtYmx5IHsKICAgICAgICAgICAgYnJhbmNoU2l6ZSA6PSBkaXYoYnJhbmNoU2l6ZSwyKQogICAgICAgICAgICAvL2JyYW5jaFNpemUgLz0gMjsKICAgICAgICB9CiAgICAgICAgdWludCB3aXRuZXNzSW5kZXggPSBpbmRleEluRWxlbWVudHNBcnJheSAqIGJyYW5jaFNpemU7CiAgICAgICAgaWYoIG9kZEJyYW5jaFNpemUgKSB3aXRuZXNzSW5kZXggKz0gaW5kZXhJbkVsZW1lbnRzQXJyYXk7ICAKCiAgICAgICAgZm9yKCB1aW50IGRlcHRoID0gMCA7IGRlcHRoIDwgYnJhbmNoU2l6ZSA7IGRlcHRoKysgKSB7CiAgICAgICAgICAgIGFzc2VtYmx5IHsKICAgICAgICAgICAgICAgIG5vZGUgOj0gbWxvYWQoYWRkKGFkZCh3aXRuZXNzLDB4MjApLG11bChhZGQoZGVwdGgsd2l0bmVzc0luZGV4KSwweDIwKSkpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy9ub2RlICA9IHdpdG5lc3Nbd2l0bmVzc0luZGV4ICsgZGVwdGhdICYgMHhGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRjsKICAgICAgICAgICAgaWYoIGluZGV4ICYgMHgxID09IDAgKSB7CiAgICAgICAgICAgICAgICBsZWZ0ID0gbGVhZjsKICAgICAgICAgICAgICAgIGFzc2VtYmx5ewogICAgICAgICAgICAgICAgICAgIC8vcmlnaHQgPSBub2RlICYgMHhGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRjsgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgcmlnaHQgOj0gYW5kKG5vZGUsMHhGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRikKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgYXNzZW1ibHl7CiAgICAgICAgICAgICAgICAgICAgLy9sZWZ0ID0gbm9kZSAmIDB4RkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkY7CiAgICAgICAgICAgICAgICAgICAgbGVmdCA6PSBhbmQobm9kZSwweEZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGKQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmlnaHQgPSBsZWFmOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBsZWFmID0gdWludChzaGEzKGxlZnQscmlnaHQpKSAmIDB4RkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkY7CiAgICAgICAgICAgIGFzc2VtYmx5IHsKICAgICAgICAgICAgICAgIGluZGV4IDo9IGRpdihpbmRleCwyKSAKICAgICAgICAgICAgfQogICAgICAgICAgICAvL2luZGV4ID0gaW5kZXggLyAyOwoKICAgICAgICAgICAgLy9ub2RlICA9IHdpdG5lc3Nbd2l0bmVzc0luZGV4ICsgZGVwdGhdIC8gKDIqKjEyOCk7CiAgICAgICAgICAgIGlmKCBpbmRleCAmIDB4MSA9PSAwICkgewogICAgICAgICAgICAgICAgbGVmdCA9IGxlYWY7CiAgICAgICAgICAgICAgICBhc3NlbWJseXsKICAgICAgICAgICAgICAgICAgICByaWdodCA6PSBkaXYobm9kZSwweDEwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMCkKICAgICAgICAgICAgICAgICAgICAvL3JpZ2h0ID0gbm9kZSAvIDB4MTAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgYXNzZW1ibHkgewogICAgICAgICAgICAgICAgICAgIC8vbGVmdCA9IG5vZGUgLyAweDEwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDsKICAgICAgICAgICAgICAgICAgICBsZWZ0IDo9IGRpdihub2RlLDB4MTAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwKQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmlnaHQgPSBsZWFmOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBsZWFmID0gdWludChzaGEzKGxlZnQscmlnaHQpKSAmIDB4RkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkY7CiAgICAgICAgICAgIGFzc2VtYmx5IHsKICAgICAgICAgICAgICAgIGluZGV4IDo9IGRpdihpbmRleCwyKSAKICAgICAgICAgICAgfQogICAgICAgICAgICAvL2luZGV4ID0gaW5kZXggLyAyOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBpZiggb2RkQnJhbmNoU2l6ZSApIHsKICAgICAgICAgICAgYXNzZW1ibHkgewogICAgICAgICAgICAgICAgbm9kZSA6PSBtbG9hZChhZGQoYWRkKHdpdG5lc3MsMHgyMCksbXVsKGFkZChkZXB0aCx3aXRuZXNzSW5kZXgpLDB4MjApKSkKICAgICAgICAgICAgfQogICAgICAgIAogICAgICAgICAgICAvL25vZGUgID0gd2l0bmVzc1t3aXRuZXNzSW5kZXggKyBkZXB0aF0gJiAweEZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGOwogICAgICAgICAgICBpZiggaW5kZXggJiAweDEgPT0gMCApIHsKICAgICAgICAgICAgICAgIGxlZnQgPSBsZWFmOwogICAgICAgICAgICAgICAgYXNzZW1ibHl7CiAgICAgICAgICAgICAgICAgICAgLy9yaWdodCA9IG5vZGUgJiAweEZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGOyAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICByaWdodCA6PSBhbmQobm9kZSwweEZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGKQogICAgICAgICAgICAgICAgfSAgICAgICAgICAgICAgICAKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIGFzc2VtYmx5ewogICAgICAgICAgICAgICAgICAgIC8vbGVmdCA9IG5vZGUgJiAweEZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGOyAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBsZWZ0IDo9IGFuZChub2RlLDB4RkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkYpCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgcmlnaHQgPSBsZWFmOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBsZWFmID0gdWludChzaGEzKGxlZnQscmlnaHQpKSAmIDB4RkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkY7ICAgICAgICAKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgCiAgICAgICAgcmV0dXJuIGxlYWY7CiAgICB9CgogICAgCiAgICBmdW5jdGlvbiB0b0JFKCB1aW50IHggKSBjb25zdGFudCBpbnRlcm5hbCByZXR1cm5zKHVpbnQpIHsKICAgICAgICB1aW50IHkgPSAwOwogICAgICAgIGZvciggdWludCBpID0gMCA7IGkgPCAzMiA7IGkrKyApIHsKICAgICAgICAgICAgeSA9IHkgKiAyNTY7CiAgICAgICAgICAgIHkgKz0gKHggJiAweEZGKTsKICAgICAgICAgICAgeCA9IHggLyAyNTY7ICAgICAgICAgICAgCiAgICAgICAgfQogICAgICAgIAogICAgICAgIHJldHVybiB5OwogICAgICAgIAogICAgfQogICAgCiAgICBmdW5jdGlvbiBjb21wdXRlU2hhMyggdWludFsxNl0gcywgdWludFs4XSBjbWl4ICkgY29uc3RhbnQgaW50ZXJuYWwgcmV0dXJucyh1aW50KSB7CiAgICAgICAgdWludCBzMCA9IHNbMF0gKyBzWzFdICogKDIqKjMyKSArIHNbMl0gKiAoMioqNjQpICsgc1szXSAqICgyKio5NikgKwogICAgICAgICAgICAgICAgICAoc1s0XSArIHNbNV0gKiAoMioqMzIpICsgc1s2XSAqICgyKio2NCkgKyBzWzddICogKDIqKjk2KSkqKDIqKjEyOCk7CgogICAgICAgIHVpbnQgczEgPSBzWzhdICsgc1s5XSAqICgyKiozMikgKyBzWzEwXSAqICgyKio2NCkgKyBzWzExXSAqICgyKio5NikgKwogICAgICAgICAgICAgICAgICAoc1sxMl0gKyBzWzEzXSAqICgyKiozMikgKyBzWzE0XSAqICgyKio2NCkgKyBzWzE1XSAqICgyKio5NikpKigyKioxMjgpOwogICAgICAgICAgICAgICAgICAKICAgICAgICB1aW50IGMgPSBjbWl4WzBdICsgY21peFsxXSAqICgyKiozMikgKyBjbWl4WzJdICogKDIqKjY0KSArIGNtaXhbM10gKiAoMioqOTYpICsKICAgICAgICAgICAgICAgICAgKGNtaXhbNF0gKyBjbWl4WzVdICogKDIqKjMyKSArIGNtaXhbNl0gKiAoMioqNjQpICsgY21peFs3XSAqICgyKio5NikpKigyKioxMjgpOwoKICAgICAgICAKICAgICAgICAvKiBnb2Qga25vd3Mgd2h5IG5lZWQgdG8gY29udmVydCB0byBiaWcgZW5kaWFuICovCiAgICAgICAgcmV0dXJuIHVpbnQoIHNoYTModG9CRShzMCksdG9CRShzMSksdG9CRShjKSkgKTsKICAgIH0KIAogCiAgICBmdW5jdGlvbiBjb21wdXRlTGVhZiggdWludFtdIGRhdGFTZXRMb29rdXAsIHVpbnQgaW5kZXggKSBjb25zdGFudCBpbnRlcm5hbCByZXR1cm5zKHVpbnQpIHsKICAgICAgICByZXR1cm4gdWludCggc2hhMyhkYXRhU2V0TG9va3VwWzQqaW5kZXhdLAogICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFTZXRMb29rdXBbNCppbmRleCArIDFdLAogICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFTZXRMb29rdXBbNCppbmRleCArIDJdLAogICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFTZXRMb29rdXBbNCppbmRleCArIDNdKSApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgIH0KIAogICAgZnVuY3Rpb24gY29tcHV0ZVMoIHVpbnQgaGVhZGVyLCB1aW50IG5vbmNlTGUgKSBjb25zdGFudCBpbnRlcm5hbCByZXR1cm5zKHVpbnRbMTZdKSB7CiAgICAgICAgdWludFs5XSAgbWVtb3J5IE07CiAgICAgICAgCiAgICAgICAgaGVhZGVyID0gcmV2ZXJzZUJ5dGVzKGhlYWRlcik7CiAgICAgICAgCiAgICAgICAgTVswXSA9IHVpbnQoaGVhZGVyKSAmIDB4RkZGRkZGRkZGRkZGRkZGRjsKICAgICAgICBoZWFkZXIgPSBoZWFkZXIgLyAyKio2NDsKICAgICAgICBNWzFdID0gdWludChoZWFkZXIpICYgMHhGRkZGRkZGRkZGRkZGRkZGOwogICAgICAgIGhlYWRlciA9IGhlYWRlciAvIDIqKjY0OwogICAgICAgIE1bMl0gPSB1aW50KGhlYWRlcikgJiAweEZGRkZGRkZGRkZGRkZGRkY7CiAgICAgICAgaGVhZGVyID0gaGVhZGVyIC8gMioqNjQ7CiAgICAgICAgTVszXSA9IHVpbnQoaGVhZGVyKSAmIDB4RkZGRkZGRkZGRkZGRkZGRjsKCiAgICAgICAgLy8gbWFrZSBsaXR0bGUgZW5kaWFuIG5vbmNlCiAgICAgICAgTVs0XSA9IG5vbmNlTGU7CiAgICAgICAgcmV0dXJuIHNwb25nZShNKTsKICAgIH0KICAgIAogICAgZnVuY3Rpb24gcmV2ZXJzZUJ5dGVzKCB1aW50IGlucHV0ICkgY29uc3RhbnQgaW50ZXJuYWwgcmV0dXJucyh1aW50KSB7CiAgICAgICAgdWludCByZXN1bHQgPSAwOwogICAgICAgIGZvcih1aW50IGkgPSAwIDsgaSA8IDMyIDsgaSsrICkgewogICAgICAgICAgICByZXN1bHQgPSByZXN1bHQgKiAyNTY7CiAgICAgICAgICAgIHJlc3VsdCArPSBpbnB1dCAmIDB4ZmY7CiAgICAgICAgICAgIAogICAgICAgICAgICBpbnB1dCAvPSAyNTY7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICAKICAgIHN0cnVjdCBFdGhhc2hDYWNoZU9wdERhdGEgewogICAgICAgIHVpbnRbNTEyXSAgICBtZXJrbGVOb2RlczsKICAgICAgICB1aW50ICAgICAgICAgZnVsbFNpemVJbjEyOFJlc3VsdGlvbjsKICAgICAgICB1aW50ICAgICAgICAgYnJhbmNoRGVwdGg7CiAgICB9CiAgICAKICAgIG1hcHBpbmcodWludD0+RXRoYXNoQ2FjaGVPcHREYXRhKSBlcG9jaERhdGE7CiAgICAKICAgIGZ1bmN0aW9uIGdldEVwb2NoRGF0YSggdWludCBlcG9jaEluZGV4LCB1aW50IG5vZGVJbmRleCApIGNvbnN0YW50IHJldHVybnModWludFszXSkgewogICAgICAgIHJldHVybiBbZXBvY2hEYXRhW2Vwb2NoSW5kZXhdLm1lcmtsZU5vZGVzW25vZGVJbmRleF0sCiAgICAgICAgICAgICAgICBlcG9jaERhdGFbZXBvY2hJbmRleF0uZnVsbFNpemVJbjEyOFJlc3VsdGlvbiwKICAgICAgICAgICAgICAgIGVwb2NoRGF0YVtlcG9jaEluZGV4XS5icmFuY2hEZXB0aF07CiAgICB9CiAgICAKICAgIGZ1bmN0aW9uIGlzRXBvY2hEYXRhU2V0KCB1aW50IGVwb2NoSW5kZXggKSBjb25zdGFudCByZXR1cm5zKGJvb2wpIHsKICAgICAgICByZXR1cm4gZXBvY2hEYXRhW2Vwb2NoSW5kZXhdLmZ1bGxTaXplSW4xMjhSZXN1bHRpb24gIT0gMDsKICAgIAogICAgfQogICAgICAgIAogICAgZXZlbnQgU2V0RXBvY2hEYXRhKCBhZGRyZXNzIGluZGV4ZWQgc2VuZGVyLCB1aW50IGVycm9yLCB1aW50IGVycm9ySW5mbyApOyAgICAKICAgIGZ1bmN0aW9uIHNldEVwb2NoRGF0YSggdWludCBlcG9jaCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgdWludCBmdWxsU2l6ZUluMTI4UmVzdWx0aW9uLAogICAgICAgICAgICAgICAgICAgICAgICAgICB1aW50IGJyYW5jaERlcHRoLAogICAgICAgICAgICAgICAgICAgICAgICAgICB1aW50W10gbWVya2xlTm9kZXMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgIHVpbnQgc3RhcnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgIHVpbnQgbnVtRWxlbXMgKSB7CgogICAgICAgIGlmKCAhIG93bmVyc1ttc2cuc2VuZGVyXSApIHsKICAgICAgICAgICAgLy9FcnJvckxvZyggInNldEVwb2NoRGF0YTogb25seSBvd25lciBjYW4gc2V0IGRhdGEiLCB1aW50KG1zZy5zZW5kZXIpICk7CiAgICAgICAgICAgIFNldEVwb2NoRGF0YSggbXNnLnNlbmRlciwgMHg4MjAwMDAwMCwgdWludChtc2cuc2VuZGVyKSApOwogICAgICAgICAgICByZXR1cm47ICAgICAgICAKICAgICAgICB9ICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgIGZvciggdWludCBpID0gMCA7IGkgPCBudW1FbGVtcyA7IGkrKyApIHsKICAgICAgICAgICAgaWYoIGVwb2NoRGF0YVtlcG9jaF0ubWVya2xlTm9kZXNbc3RhcnQraV0gPiAwICkgewogICAgICAgICAgICAgICAgLy9FcnJvckxvZygiZXBvY2ggYWxyZWFkeSBzZXQiLCBlcG9jaFtpXSk7CiAgICAgICAgICAgICAgICBTZXRFcG9jaERhdGEoIG1zZy5zZW5kZXIsIDB4ODIwMDAwMDEsIGVwb2NoICogKDIqKjEyOCkgKyBzdGFydCArIGkgKTsKICAgICAgICAgICAgICAgIHJldHVybjsgICAgICAgICAgICAKCiAgICAgICAgICAgIH0gCiAgICAgICAgICAgIGVwb2NoRGF0YVtlcG9jaF0ubWVya2xlTm9kZXNbc3RhcnQraV0gPSBtZXJrbGVOb2Rlc1tpXTsKICAgICAgICB9CiAgICAgICAgZXBvY2hEYXRhW2Vwb2NoXS5mdWxsU2l6ZUluMTI4UmVzdWx0aW9uID0gZnVsbFNpemVJbjEyOFJlc3VsdGlvbjsKICAgICAgICBlcG9jaERhdGFbZXBvY2hdLmJyYW5jaERlcHRoID0gYnJhbmNoRGVwdGg7CiAgICAgICAgCiAgICAgICAgU2V0RXBvY2hEYXRhKCBtc2cuc2VuZGVyLCAwICwgMCApOyAgICAgICAgCiAgICB9CgogICAgZnVuY3Rpb24gZ2V0TWVya2xlTGVhdmUoIHVpbnQgZXBvY2hJbmRleCwgdWludCBwICkgY29uc3RhbnQgaW50ZXJuYWwgcmV0dXJucyh1aW50KSB7ICAgICAgICAKICAgICAgICB1aW50IHJvb3RJbmRleCA9IHAgPj4gZXBvY2hEYXRhW2Vwb2NoSW5kZXhdLmJyYW5jaERlcHRoOwogICAgICAgIHVpbnQgZXhwZWN0ZWRSb290ID0gZXBvY2hEYXRhW2Vwb2NoSW5kZXhdLm1lcmtsZU5vZGVzWyhyb290SW5kZXgvMildOwogICAgICAgIGlmKCAocm9vdEluZGV4ICUgMikgPT0gMCApIGV4cGVjdGVkUm9vdCA9IGV4cGVjdGVkUm9vdCAmIDB4RkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkY7CiAgICAgICAgZWxzZSBleHBlY3RlZFJvb3QgPSBleHBlY3RlZFJvb3QgLyAoMioqMTI4KTsKICAgICAgICAKICAgICAgICByZXR1cm4gZXhwZWN0ZWRSb290OwogICAgfQoKCiAgICBmdW5jdGlvbiBoYXNoaW1vdG8oIGJ5dGVzMzIgICAgICBoZWFkZXIsCiAgICAgICAgICAgICAgICAgICAgICAgIGJ5dGVzOCAgICAgICBub25jZUxlLAogICAgICAgICAgICAgICAgICAgICAgICB1aW50W10gICAgICAgZGF0YVNldExvb2t1cCwKICAgICAgICAgICAgICAgICAgICAgICAgdWludFtdICAgICAgIHdpdG5lc3NGb3JMb29rdXAsCiAgICAgICAgICAgICAgICAgICAgICAgIHVpbnQgICAgICAgICBlcG9jaEluZGV4ICkgY29uc3RhbnQgcmV0dXJucyh1aW50KSB7CiAgICAgICAgIAogICAgICAgIHVpbnRbMTZdIG1lbW9yeSBzOwogICAgICAgIHVpbnRbMzJdIG1lbW9yeSBtaXg7CiAgICAgICAgdWludFs4XSAgbWVtb3J5IGNtaXg7CiAgICAgICAgCiAgICAgICAgdWludFsyXSAgbWVtb3J5IGRlcHRoQW5kRnVsbFNpemUgPSBbZXBvY2hEYXRhW2Vwb2NoSW5kZXhdLmJyYW5jaERlcHRoLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcG9jaERhdGFbZXBvY2hJbmRleF0uZnVsbFNpemVJbjEyOFJlc3VsdGlvbl07CiAgICAgICAgICAgICAgICAKICAgICAgICB1aW50IGk7CiAgICAgICAgdWludCBqOwogICAgICAgIAogICAgICAgIGlmKCAhIGlzRXBvY2hEYXRhU2V0KCBlcG9jaEluZGV4ICkgKSByZXR1cm4gMHhGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZFOwogICAgICAgIAogICAgICAgIGlmKCBkZXB0aEFuZEZ1bGxTaXplWzFdID09IDAgKSB7CiAgICAgICAgICAgIHJldHVybiAweEZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkY7CiAgICAgICAgfQoKICAgICAgICAKICAgICAgICBzID0gY29tcHV0ZVModWludChoZWFkZXIpLCB1aW50KG5vbmNlTGUpKTsKICAgICAgICBmb3IoIGkgPSAwIDsgaSA8IDE2IDsgaSsrICkgeyAgICAgICAgICAgIAogICAgICAgICAgICBhc3NlbWJseSB7CiAgICAgICAgICAgICAgICBsZXQgb2Zmc2V0IDo9IG11bChpLDB4MjApCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vbWl4W2ldID0gc1tpXTsKICAgICAgICAgICAgICAgIG1zdG9yZShhZGQobWl4LG9mZnNldCksbWxvYWQoYWRkKHMsb2Zmc2V0KSkpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIG1peFtpKzE2XSA9IHNbaV07CiAgICAgICAgICAgICAgICBtc3RvcmUoYWRkKG1peCxhZGQoMHgyMDAsb2Zmc2V0KSksbWxvYWQoYWRkKHMsb2Zmc2V0KSkpICAgIAogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmb3IoIGkgPSAwIDsgaSA8IDY0IDsgaSsrICkgewogICAgICAgICAgICB1aW50IHAgPSBmbnYoIGkgXiBzWzBdLCBtaXhbaSAlIDMyXSkgJSBkZXB0aEFuZEZ1bGxTaXplWzFdOwogICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmKCBjb21wdXRlQ2FjaGVSb290KCBwLCBpLCBkYXRhU2V0TG9va3VwLCAgd2l0bmVzc0Zvckxvb2t1cCwgZGVwdGhBbmRGdWxsU2l6ZVswXSApICAhPSBnZXRNZXJrbGVMZWF2ZSggZXBvY2hJbmRleCwgcCApICkgewogICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFBvVyBmYWlsZWQKICAgICAgICAgICAgICAgIHJldHVybiAweEZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkY7CiAgICAgICAgICAgIH0gICAgICAgCgogICAgICAgICAgICBmb3IoIGogPSAwIDsgaiA8IDggOyBqKysgKSB7CgogICAgICAgICAgICAgICAgYXNzZW1ibHl7CiAgICAgICAgICAgICAgICAgICAgLy9taXhbal0gPSBmbnYobWl4W2pdLCBkYXRhU2V0TG9va3VwWzQqaV0gJiB2YXJGRkZGRkZGRiApOwogICAgICAgICAgICAgICAgICAgIGxldCBkYXRhT2Zmc2V0IDo9IGFkZChtdWwoMHg4MCxpKSxhZGQoZGF0YVNldExvb2t1cCwweDIwKSkKICAgICAgICAgICAgICAgICAgICBsZXQgZGF0YVZhbHVlICAgOj0gYW5kKG1sb2FkKGRhdGFPZmZzZXQpLDB4RkZGRkZGRkYpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgbGV0IG1peE9mZnNldCA6PSBhZGQobWl4LG11bCgweDIwLGopKQogICAgICAgICAgICAgICAgICAgIGxldCBtaXhWYWx1ZSAgOj0gbWxvYWQobWl4T2Zmc2V0KQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIGZudiA9IHJldHVybiAoKHYxKjB4MDEwMDAxOTMpIF4gdjIpICYgMHhGRkZGRkZGRjsKICAgICAgICAgICAgICAgICAgICBsZXQgZm52VmFsdWUgOj0gYW5kKHhvcihtdWwobWl4VmFsdWUsMHgwMTAwMDE5MyksZGF0YVZhbHVlKSwweEZGRkZGRkZGKSAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgbXN0b3JlKG1peE9mZnNldCxmbnZWYWx1ZSkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvL21peFtqKzhdID0gZm52KG1peFtqKzhdLCBkYXRhU2V0TG9va3VwWzQqaSArIDFdICYgMHhGRkZGRkZGRiApOwogICAgICAgICAgICAgICAgICAgIGRhdGFPZmZzZXQgOj0gYWRkKGRhdGFPZmZzZXQsMHgyMCkKICAgICAgICAgICAgICAgICAgICBkYXRhVmFsdWUgICA6PSBhbmQobWxvYWQoZGF0YU9mZnNldCksMHhGRkZGRkZGRikKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBtaXhPZmZzZXQgOj0gYWRkKG1peE9mZnNldCwweDEwMCkKICAgICAgICAgICAgICAgICAgICBtaXhWYWx1ZSAgOj0gbWxvYWQobWl4T2Zmc2V0KQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIGZudiA9IHJldHVybiAoKHYxKjB4MDEwMDAxOTMpIF4gdjIpICYgMHhGRkZGRkZGRjsKICAgICAgICAgICAgICAgICAgICBmbnZWYWx1ZSA6PSBhbmQoeG9yKG11bChtaXhWYWx1ZSwweDAxMDAwMTkzKSxkYXRhVmFsdWUpLDB4RkZGRkZGRkYpICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBtc3RvcmUobWl4T2Zmc2V0LGZudlZhbHVlKQoKICAgICAgICAgICAgICAgICAgICAvL21peFtqKzE2XSA9IGZudihtaXhbaisxNl0sIGRhdGFTZXRMb29rdXBbNCppICsgMl0gJiAweEZGRkZGRkZGICk7CiAgICAgICAgICAgICAgICAgICAgZGF0YU9mZnNldCA6PSBhZGQoZGF0YU9mZnNldCwweDIwKQogICAgICAgICAgICAgICAgICAgIGRhdGFWYWx1ZSAgIDo9IGFuZChtbG9hZChkYXRhT2Zmc2V0KSwweEZGRkZGRkZGKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIG1peE9mZnNldCA6PSBhZGQobWl4T2Zmc2V0LDB4MTAwKQogICAgICAgICAgICAgICAgICAgIG1peFZhbHVlICA6PSBtbG9hZChtaXhPZmZzZXQpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gZm52ID0gcmV0dXJuICgodjEqMHgwMTAwMDE5MykgXiB2MikgJiAweEZGRkZGRkZGOwogICAgICAgICAgICAgICAgICAgIGZudlZhbHVlIDo9IGFuZCh4b3IobXVsKG1peFZhbHVlLDB4MDEwMDAxOTMpLGRhdGFWYWx1ZSksMHhGRkZGRkZGRikgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIG1zdG9yZShtaXhPZmZzZXQsZm52VmFsdWUpCgogICAgICAgICAgICAgICAgICAgIC8vbWl4W2orMjRdID0gZm52KG1peFtqKzI0XSwgZGF0YVNldExvb2t1cFs0KmkgKyAzXSAmIDB4RkZGRkZGRkYgKTsKICAgICAgICAgICAgICAgICAgICBkYXRhT2Zmc2V0IDo9IGFkZChkYXRhT2Zmc2V0LDB4MjApCiAgICAgICAgICAgICAgICAgICAgZGF0YVZhbHVlICAgOj0gYW5kKG1sb2FkKGRhdGFPZmZzZXQpLDB4RkZGRkZGRkYpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgbWl4T2Zmc2V0IDo9IGFkZChtaXhPZmZzZXQsMHgxMDApCiAgICAgICAgICAgICAgICAgICAgbWl4VmFsdWUgIDo9IG1sb2FkKG1peE9mZnNldCkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBmbnYgPSByZXR1cm4gKCh2MSoweDAxMDAwMTkzKSBeIHYyKSAmIDB4RkZGRkZGRkY7CiAgICAgICAgICAgICAgICAgICAgZm52VmFsdWUgOj0gYW5kKHhvcihtdWwobWl4VmFsdWUsMHgwMTAwMDE5MyksZGF0YVZhbHVlKSwweEZGRkZGRkZGKSAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgbXN0b3JlKG1peE9mZnNldCxmbnZWYWx1ZSkgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvL21peFtqXSA9IGZudihtaXhbal0sIGRhdGFTZXRMb29rdXBbNCppXSAmIDB4RkZGRkZGRkYgKTsKICAgICAgICAgICAgICAgIC8vbWl4W2orOF0gPSBmbnYobWl4W2orOF0sIGRhdGFTZXRMb29rdXBbNCppICsgMV0gJiAweEZGRkZGRkZGICk7CiAgICAgICAgICAgICAgICAvL21peFtqKzE2XSA9IGZudihtaXhbaisxNl0sIGRhdGFTZXRMb29rdXBbNCppICsgMl0gJiAweEZGRkZGRkZGICk7ICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy9taXhbaisyNF0gPSBmbnYobWl4W2orMjRdLCBkYXRhU2V0TG9va3VwWzQqaSArIDNdICYgMHhGRkZGRkZGRiApOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vZGF0YVNldExvb2t1cFs0KmkgICAgXSA9IGRhdGFTZXRMb29rdXBbNCppICAgIF0vKDIqKjMyKTsKICAgICAgICAgICAgICAgIC8vZGF0YVNldExvb2t1cFs0KmkgKyAxXSA9IGRhdGFTZXRMb29rdXBbNCppICsgMV0vKDIqKjMyKTsKICAgICAgICAgICAgICAgIC8vZGF0YVNldExvb2t1cFs0KmkgKyAyXSA9IGRhdGFTZXRMb29rdXBbNCppICsgMl0vKDIqKjMyKTsKICAgICAgICAgICAgICAgIC8vZGF0YVNldExvb2t1cFs0KmkgKyAzXSA9IGRhdGFTZXRMb29rdXBbNCppICsgM10vKDIqKjMyKTsgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGFzc2VtYmx5ewogICAgICAgICAgICAgICAgICAgIGxldCBvZmZzZXQgOj0gYWRkKGFkZChkYXRhU2V0TG9va3VwLDB4MjApLG11bChpLDB4ODApKQogICAgICAgICAgICAgICAgICAgIGxldCB2YWx1ZSAgOj0gZGl2KG1sb2FkKG9mZnNldCksMHgxMDAwMDAwMDApCiAgICAgICAgICAgICAgICAgICAgbXN0b3JlKG9mZnNldCx2YWx1ZSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgb2Zmc2V0IDo9IGFkZChvZmZzZXQsMHgyMCkKICAgICAgICAgICAgICAgICAgICB2YWx1ZSAgOj0gZGl2KG1sb2FkKG9mZnNldCksMHgxMDAwMDAwMDApCiAgICAgICAgICAgICAgICAgICAgbXN0b3JlKG9mZnNldCx2YWx1ZSkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBvZmZzZXQgOj0gYWRkKG9mZnNldCwweDIwKQogICAgICAgICAgICAgICAgICAgIHZhbHVlICA6PSBkaXYobWxvYWQob2Zmc2V0KSwweDEwMDAwMDAwMCkKICAgICAgICAgICAgICAgICAgICBtc3RvcmUob2Zmc2V0LHZhbHVlKSAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgb2Zmc2V0IDo9IGFkZChvZmZzZXQsMHgyMCkKICAgICAgICAgICAgICAgICAgICB2YWx1ZSAgOj0gZGl2KG1sb2FkKG9mZnNldCksMHgxMDAwMDAwMDApCiAgICAgICAgICAgICAgICAgICAgbXN0b3JlKG9mZnNldCx2YWx1ZSkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgfSAgICAgICAgICAgICAgICAKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAKICAgICAgICAKICAgICAgICBmb3IoIGkgPSAwIDsgaSA8IDMyIDsgaSArPSA0KSB7CiAgICAgICAgICAgIGNtaXhbaS80XSA9IChmbnYoZm52KGZudihtaXhbaV0sIG1peFtpKzFdKSwgbWl4W2krMl0pLCBtaXhbaSszXSkpOwogICAgICAgIH0KICAgICAgICAKCiAgICAgICAgdWludCByZXN1bHQgPSBjb21wdXRlU2hhMyhzLGNtaXgpOyAKCiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAKICAgIH0KfQoKLyoqCiogQHRpdGxlIFJMUFJlYWRlcgoqCiogUkxQUmVhZGVyIGlzIHVzZWQgdG8gcmVhZCBhbmQgcGFyc2UgUkxQIGVuY29kZWQgZGF0YSBpbiBtZW1vcnkuCioKKiBAYXV0aG9yIEFuZHJlYXMgT2xvZnNzb24gKDxzcGFuIGNsYXNzPSJfX2NmX2VtYWlsX18iIGRhdGEtY2ZlbWFpbD0iMjQ0NTRhNDA1NjRiNDg0YjE1MWQxYzE0NjQ0MzQ5NDU0ZDQ4MGE0NzRiNDkiPltlbWFpbCYjMTYwO3Byb3RlY3RlZF08L3NwYW4+KQoqLwpsaWJyYXJ5IFJMUCB7CgogdWludCBjb25zdGFudCBEQVRBX1NIT1JUX1NUQVJUID0gMHg4MDsKIHVpbnQgY29uc3RhbnQgREFUQV9MT05HX1NUQVJUID0gMHhCODsKIHVpbnQgY29uc3RhbnQgTElTVF9TSE9SVF9TVEFSVCA9IDB4QzA7CiB1aW50IGNvbnN0YW50IExJU1RfTE9OR19TVEFSVCA9IDB4Rjg7CgogdWludCBjb25zdGFudCBEQVRBX0xPTkdfT0ZGU0VUID0gMHhCNzsKIHVpbnQgY29uc3RhbnQgTElTVF9MT05HX09GRlNFVCA9IDB4Rjc7CgoKIHN0cnVjdCBSTFBJdGVtIHsKICAgICB1aW50IF91bnNhZmVfbWVtUHRyOyAgICAvLyBQb2ludGVyIHRvIHRoZSBSTFAtZW5jb2RlZCBieXRlcy4KICAgICB1aW50IF91bnNhZmVfbGVuZ3RoOyAgICAvLyBOdW1iZXIgb2YgYnl0ZXMuIFRoaXMgaXMgdGhlIGZ1bGwgbGVuZ3RoIG9mIHRoZSBzdHJpbmcuCiB9Cgogc3RydWN0IEl0ZXJhdG9yIHsKICAgICBSTFBJdGVtIF91bnNhZmVfaXRlbTsgICAvLyBJdGVtIHRoYXQncyBiZWluZyBpdGVyYXRlZCBvdmVyLgogICAgIHVpbnQgX3Vuc2FmZV9uZXh0UHRyOyAgIC8vIFBvc2l0aW9uIG9mIHRoZSBuZXh0IGl0ZW0gaW4gdGhlIGxpc3QuCiB9CgogLyogSXRlcmF0b3IgKi8KCiBmdW5jdGlvbiBuZXh0KEl0ZXJhdG9yIG1lbW9yeSBzZWxmKSBpbnRlcm5hbCBjb25zdGFudCByZXR1cm5zIChSTFBJdGVtIG1lbW9yeSBzdWJJdGVtKSB7CiAgICAgaWYoaGFzTmV4dChzZWxmKSkgewogICAgICAgICB2YXIgcHRyID0gc2VsZi5fdW5zYWZlX25leHRQdHI7CiAgICAgICAgIHZhciBpdGVtTGVuZ3RoID0gX2l0ZW1MZW5ndGgocHRyKTsKICAgICAgICAgc3ViSXRlbS5fdW5zYWZlX21lbVB0ciA9IHB0cjsKICAgICAgICAgc3ViSXRlbS5fdW5zYWZlX2xlbmd0aCA9IGl0ZW1MZW5ndGg7CiAgICAgICAgIHNlbGYuX3Vuc2FmZV9uZXh0UHRyID0gcHRyICsgaXRlbUxlbmd0aDsKICAgICB9CiAgICAgZWxzZQogICAgICAgICB0aHJvdzsKIH0KCiBmdW5jdGlvbiBuZXh0KEl0ZXJhdG9yIG1lbW9yeSBzZWxmLCBib29sIHN0cmljdCkgaW50ZXJuYWwgY29uc3RhbnQgcmV0dXJucyAoUkxQSXRlbSBtZW1vcnkgc3ViSXRlbSkgewogICAgIHN1Ykl0ZW0gPSBuZXh0KHNlbGYpOwogICAgIGlmKHN0cmljdCAmJiAhX3ZhbGlkYXRlKHN1Ykl0ZW0pKQogICAgICAgICB0aHJvdzsKICAgICByZXR1cm47CiB9CgogZnVuY3Rpb24gaGFzTmV4dChJdGVyYXRvciBtZW1vcnkgc2VsZikgaW50ZXJuYWwgY29uc3RhbnQgcmV0dXJucyAoYm9vbCkgewogICAgIHZhciBpdGVtID0gc2VsZi5fdW5zYWZlX2l0ZW07CiAgICAgcmV0dXJuIHNlbGYuX3Vuc2FmZV9uZXh0UHRyIDwgaXRlbS5fdW5zYWZlX21lbVB0ciArIGl0ZW0uX3Vuc2FmZV9sZW5ndGg7CiB9CgogLyogUkxQSXRlbSAqLwoKIC8vLyBAZGV2IENyZWF0ZXMgYW4gUkxQSXRlbSBmcm9tIGFuIGFycmF5IG9mIFJMUCBlbmNvZGVkIGJ5dGVzLgogLy8vIEBwYXJhbSBzZWxmIFRoZSBSTFAgZW5jb2RlZCBieXRlcy4KIC8vLyBAcmV0dXJuIEFuIFJMUEl0ZW0KIGZ1bmN0aW9uIHRvUkxQSXRlbShieXRlcyBtZW1vcnkgc2VsZikgaW50ZXJuYWwgY29uc3RhbnQgcmV0dXJucyAoUkxQSXRlbSBtZW1vcnkpIHsKICAgICB1aW50IGxlbiA9IHNlbGYubGVuZ3RoOwogICAgIGlmIChsZW4gPT0gMCkgewogICAgICAgICByZXR1cm4gUkxQSXRlbSgwLCAwKTsKICAgICB9CiAgICAgdWludCBtZW1QdHI7CiAgICAgYXNzZW1ibHkgewogICAgICAgICBtZW1QdHIgOj0gYWRkKHNlbGYsIDB4MjApCiAgICAgfQogICAgIHJldHVybiBSTFBJdGVtKG1lbVB0ciwgbGVuKTsKIH0KCiAvLy8gQGRldiBDcmVhdGVzIGFuIFJMUEl0ZW0gZnJvbSBhbiBhcnJheSBvZiBSTFAgZW5jb2RlZCBieXRlcy4KIC8vLyBAcGFyYW0gc2VsZiBUaGUgUkxQIGVuY29kZWQgYnl0ZXMuCiAvLy8gQHBhcmFtIHN0cmljdCBXaWxsIHRocm93IGlmIHRoZSBkYXRhIGlzIG5vdCBSTFAgZW5jb2RlZC4KIC8vLyBAcmV0dXJuIEFuIFJMUEl0ZW0KIGZ1bmN0aW9uIHRvUkxQSXRlbShieXRlcyBtZW1vcnkgc2VsZiwgYm9vbCBzdHJpY3QpIGludGVybmFsIGNvbnN0YW50IHJldHVybnMgKFJMUEl0ZW0gbWVtb3J5KSB7CiAgICAgdmFyIGl0ZW0gPSB0b1JMUEl0ZW0oc2VsZik7CiAgICAgaWYoc3RyaWN0KSB7CiAgICAgICAgIHVpbnQgbGVuID0gc2VsZi5sZW5ndGg7CiAgICAgICAgIGlmKF9wYXlsb2FkT2Zmc2V0KGl0ZW0pID4gbGVuKQogICAgICAgICAgICAgdGhyb3c7CiAgICAgICAgIGlmKF9pdGVtTGVuZ3RoKGl0ZW0uX3Vuc2FmZV9tZW1QdHIpICE9IGxlbikKICAgICAgICAgICAgIHRocm93OwogICAgICAgICBpZighX3ZhbGlkYXRlKGl0ZW0pKQogICAgICAgICAgICAgdGhyb3c7CiAgICAgfQogICAgIHJldHVybiBpdGVtOwogfQoKIC8vLyBAZGV2IENoZWNrIGlmIHRoZSBSTFAgaXRlbSBpcyBudWxsLgogLy8vIEBwYXJhbSBzZWxmIFRoZSBSTFAgaXRlbS4KIC8vLyBAcmV0dXJuICd0cnVlJyBpZiB0aGUgaXRlbSBpcyBudWxsLgogZnVuY3Rpb24gaXNOdWxsKFJMUEl0ZW0gbWVtb3J5IHNlbGYpIGludGVybmFsIGNvbnN0YW50IHJldHVybnMgKGJvb2wgcmV0KSB7CiAgICAgcmV0dXJuIHNlbGYuX3Vuc2FmZV9sZW5ndGggPT0gMDsKIH0KCiAvLy8gQGRldiBDaGVjayBpZiB0aGUgUkxQIGl0ZW0gaXMgYSBsaXN0LgogLy8vIEBwYXJhbSBzZWxmIFRoZSBSTFAgaXRlbS4KIC8vLyBAcmV0dXJuICd0cnVlJyBpZiB0aGUgaXRlbSBpcyBhIGxpc3QuCiBmdW5jdGlvbiBpc0xpc3QoUkxQSXRlbSBtZW1vcnkgc2VsZikgaW50ZXJuYWwgY29uc3RhbnQgcmV0dXJucyAoYm9vbCByZXQpIHsKICAgICBpZiAoc2VsZi5fdW5zYWZlX2xlbmd0aCA9PSAwKQogICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgdWludCBtZW1QdHIgPSBzZWxmLl91bnNhZmVfbWVtUHRyOwogICAgIGFzc2VtYmx5IHsKICAgICAgICAgcmV0IDo9IGlzemVybyhsdChieXRlKDAsIG1sb2FkKG1lbVB0cikpLCAweEMwKSkKICAgICB9CiB9CgogLy8vIEBkZXYgQ2hlY2sgaWYgdGhlIFJMUCBpdGVtIGlzIGRhdGEuCiAvLy8gQHBhcmFtIHNlbGYgVGhlIFJMUCBpdGVtLgogLy8vIEByZXR1cm4gJ3RydWUnIGlmIHRoZSBpdGVtIGlzIGRhdGEuCiBmdW5jdGlvbiBpc0RhdGEoUkxQSXRlbSBtZW1vcnkgc2VsZikgaW50ZXJuYWwgY29uc3RhbnQgcmV0dXJucyAoYm9vbCByZXQpIHsKICAgICBpZiAoc2VsZi5fdW5zYWZlX2xlbmd0aCA9PSAwKQogICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgdWludCBtZW1QdHIgPSBzZWxmLl91bnNhZmVfbWVtUHRyOwogICAgIGFzc2VtYmx5IHsKICAgICAgICAgcmV0IDo9IGx0KGJ5dGUoMCwgbWxvYWQobWVtUHRyKSksIDB4QzApCiAgICAgfQogfQoKIC8vLyBAZGV2IENoZWNrIGlmIHRoZSBSTFAgaXRlbSBpcyBlbXB0eSAoc3RyaW5nIG9yIGxpc3QpLgogLy8vIEBwYXJhbSBzZWxmIFRoZSBSTFAgaXRlbS4KIC8vLyBAcmV0dXJuICd0cnVlJyBpZiB0aGUgaXRlbSBpcyBudWxsLgogZnVuY3Rpb24gaXNFbXB0eShSTFBJdGVtIG1lbW9yeSBzZWxmKSBpbnRlcm5hbCBjb25zdGFudCByZXR1cm5zIChib29sIHJldCkgewogICAgIGlmKGlzTnVsbChzZWxmKSkKICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgIHVpbnQgYjA7CiAgICAgdWludCBtZW1QdHIgPSBzZWxmLl91bnNhZmVfbWVtUHRyOwogICAgIGFzc2VtYmx5IHsKICAgICAgICAgYjAgOj0gYnl0ZSgwLCBtbG9hZChtZW1QdHIpKQogICAgIH0KICAgICByZXR1cm4gKGIwID09IERBVEFfU0hPUlRfU1RBUlQgfHwgYjAgPT0gTElTVF9TSE9SVF9TVEFSVCk7CiB9CgogLy8vIEBkZXYgR2V0IHRoZSBudW1iZXIgb2YgaXRlbXMgaW4gYW4gUkxQIGVuY29kZWQgbGlzdC4KIC8vLyBAcGFyYW0gc2VsZiBUaGUgUkxQIGl0ZW0uCiAvLy8gQHJldHVybiBUaGUgbnVtYmVyIG9mIGl0ZW1zLgogZnVuY3Rpb24gaXRlbXMoUkxQSXRlbSBtZW1vcnkgc2VsZikgaW50ZXJuYWwgY29uc3RhbnQgcmV0dXJucyAodWludCkgewogICAgIGlmICghaXNMaXN0KHNlbGYpKQogICAgICAgICByZXR1cm4gMDsKICAgICB1aW50IGIwOwogICAgIHVpbnQgbWVtUHRyID0gc2VsZi5fdW5zYWZlX21lbVB0cjsKICAgICBhc3NlbWJseSB7CiAgICAgICAgIGIwIDo9IGJ5dGUoMCwgbWxvYWQobWVtUHRyKSkKICAgICB9CiAgICAgdWludCBwb3MgPSBtZW1QdHIgKyBfcGF5bG9hZE9mZnNldChzZWxmKTsKICAgICB1aW50IGxhc3QgPSBtZW1QdHIgKyBzZWxmLl91bnNhZmVfbGVuZ3RoIC0gMTsKICAgICB1aW50IGl0bXM7CiAgICAgd2hpbGUocG9zIDw9IGxhc3QpIHsKICAgICAgICAgcG9zICs9IF9pdGVtTGVuZ3RoKHBvcyk7CiAgICAgICAgIGl0bXMrKzsKICAgICB9CiAgICAgcmV0dXJuIGl0bXM7CiB9CgogLy8vIEBkZXYgQ3JlYXRlIGFuIGl0ZXJhdG9yLgogLy8vIEBwYXJhbSBzZWxmIFRoZSBSTFAgaXRlbS4KIC8vLyBAcmV0dXJuIEFuICdJdGVyYXRvcicgb3ZlciB0aGUgaXRlbS4KIGZ1bmN0aW9uIGl0ZXJhdG9yKFJMUEl0ZW0gbWVtb3J5IHNlbGYpIGludGVybmFsIGNvbnN0YW50IHJldHVybnMgKEl0ZXJhdG9yIG1lbW9yeSBpdCkgewogICAgIGlmICghaXNMaXN0KHNlbGYpKQogICAgICAgICB0aHJvdzsKICAgICB1aW50IHB0ciA9IHNlbGYuX3Vuc2FmZV9tZW1QdHIgKyBfcGF5bG9hZE9mZnNldChzZWxmKTsKICAgICBpdC5fdW5zYWZlX2l0ZW0gPSBzZWxmOwogICAgIGl0Ll91bnNhZmVfbmV4dFB0ciA9IHB0cjsKIH0KCiAvLy8gQGRldiBSZXR1cm4gdGhlIFJMUCBlbmNvZGVkIGJ5dGVzLgogLy8vIEBwYXJhbSBzZWxmIFRoZSBSTFBJdGVtLgogLy8vIEByZXR1cm4gVGhlIGJ5dGVzLgogZnVuY3Rpb24gdG9CeXRlcyhSTFBJdGVtIG1lbW9yeSBzZWxmKSBpbnRlcm5hbCBjb25zdGFudCByZXR1cm5zIChieXRlcyBtZW1vcnkgYnRzKSB7CiAgICAgdmFyIGxlbiA9IHNlbGYuX3Vuc2FmZV9sZW5ndGg7CiAgICAgaWYgKGxlbiA9PSAwKQogICAgICAgICByZXR1cm47CiAgICAgYnRzID0gbmV3IGJ5dGVzKGxlbik7CiAgICAgX2NvcHlUb0J5dGVzKHNlbGYuX3Vuc2FmZV9tZW1QdHIsIGJ0cywgbGVuKTsKIH0KCiAvLy8gQGRldiBEZWNvZGUgYW4gUkxQSXRlbSBpbnRvIGJ5dGVzLiBUaGlzIHdpbGwgbm90IHdvcmsgaWYgdGhlCiAvLy8gUkxQSXRlbSBpcyBhIGxpc3QuCiAvLy8gQHBhcmFtIHNlbGYgVGhlIFJMUEl0ZW0uCiAvLy8gQHJldHVybiBUaGUgZGVjb2RlZCBzdHJpbmcuCiBmdW5jdGlvbiB0b0RhdGEoUkxQSXRlbSBtZW1vcnkgc2VsZikgaW50ZXJuYWwgY29uc3RhbnQgcmV0dXJucyAoYnl0ZXMgbWVtb3J5IGJ0cykgewogICAgIGlmKCFpc0RhdGEoc2VsZikpCiAgICAgICAgIHRocm93OwogICAgIHZhciAoclN0YXJ0UG9zLCBsZW4pID0gX2RlY29kZShzZWxmKTsKICAgICBidHMgPSBuZXcgYnl0ZXMobGVuKTsKICAgICBfY29weVRvQnl0ZXMoclN0YXJ0UG9zLCBidHMsIGxlbik7CiB9CgogLy8vIEBkZXYgR2V0IHRoZSBsaXN0IG9mIHN1Yi1pdGVtcyBmcm9tIGFuIFJMUCBlbmNvZGVkIGxpc3QuCiAvLy8gV2FybmluZzogVGhpcyBpcyBpbmVmZmljaWVudCwgYXMgaXQgcmVxdWlyZXMgdGhhdCB0aGUgbGlzdCBpcyByZWFkIHR3aWNlLgogLy8vIEBwYXJhbSBzZWxmIFRoZSBSTFAgaXRlbS4KIC8vLyBAcmV0dXJuIEFycmF5IG9mIFJMUEl0ZW1zLgogZnVuY3Rpb24gdG9MaXN0KFJMUEl0ZW0gbWVtb3J5IHNlbGYpIGludGVybmFsIGNvbnN0YW50IHJldHVybnMgKFJMUEl0ZW1bXSBtZW1vcnkgbGlzdCkgewogICAgIGlmKCFpc0xpc3Qoc2VsZikpCiAgICAgICAgIHRocm93OwogICAgIHZhciBudW1JdGVtcyA9IGl0ZW1zKHNlbGYpOwogICAgIGxpc3QgPSBuZXcgUkxQSXRlbVtdKG51bUl0ZW1zKTsKICAgICB2YXIgaXQgPSBpdGVyYXRvcihzZWxmKTsKICAgICB1aW50IGlkeDsKICAgICB3aGlsZShoYXNOZXh0KGl0KSkgewogICAgICAgICBsaXN0W2lkeF0gPSBuZXh0KGl0KTsKICAgICAgICAgaWR4Kys7CiAgICAgfQogfQoKIC8vLyBAZGV2IERlY29kZSBhbiBSTFBJdGVtIGludG8gYW4gYXNjaWkgc3RyaW5nLiBUaGlzIHdpbGwgbm90IHdvcmsgaWYgdGhlCiAvLy8gUkxQSXRlbSBpcyBhIGxpc3QuCiAvLy8gQHBhcmFtIHNlbGYgVGhlIFJMUEl0ZW0uCiAvLy8gQHJldHVybiBUaGUgZGVjb2RlZCBzdHJpbmcuCiBmdW5jdGlvbiB0b0FzY2lpKFJMUEl0ZW0gbWVtb3J5IHNlbGYpIGludGVybmFsIGNvbnN0YW50IHJldHVybnMgKHN0cmluZyBtZW1vcnkgc3RyKSB7CiAgICAgaWYoIWlzRGF0YShzZWxmKSkKICAgICAgICAgdGhyb3c7CiAgICAgdmFyIChyU3RhcnRQb3MsIGxlbikgPSBfZGVjb2RlKHNlbGYpOwogICAgIGJ5dGVzIG1lbW9yeSBidHMgPSBuZXcgYnl0ZXMobGVuKTsKICAgICBfY29weVRvQnl0ZXMoclN0YXJ0UG9zLCBidHMsIGxlbik7CiAgICAgc3RyID0gc3RyaW5nKGJ0cyk7CiB9CgogLy8vIEBkZXYgRGVjb2RlIGFuIFJMUEl0ZW0gaW50byBhIHVpbnQuIFRoaXMgd2lsbCBub3Qgd29yayBpZiB0aGUKIC8vLyBSTFBJdGVtIGlzIGEgbGlzdC4KIC8vLyBAcGFyYW0gc2VsZiBUaGUgUkxQSXRlbS4KIC8vLyBAcmV0dXJuIFRoZSBkZWNvZGVkIHN0cmluZy4KIGZ1bmN0aW9uIHRvVWludChSTFBJdGVtIG1lbW9yeSBzZWxmKSBpbnRlcm5hbCBjb25zdGFudCByZXR1cm5zICh1aW50IGRhdGEpIHsKICAgICBpZighaXNEYXRhKHNlbGYpKQogICAgICAgICB0aHJvdzsKICAgICB2YXIgKHJTdGFydFBvcywgbGVuKSA9IF9kZWNvZGUoc2VsZik7CiAgICAgaWYgKGxlbiA+IDMyIHx8IGxlbiA9PSAwKQogICAgICAgICB0aHJvdzsKICAgICBhc3NlbWJseSB7CiAgICAgICAgIGRhdGEgOj0gZGl2KG1sb2FkKHJTdGFydFBvcyksIGV4cCgyNTYsIHN1YigzMiwgbGVuKSkpCiAgICAgfQogfQoKIC8vLyBAZGV2IERlY29kZSBhbiBSTFBJdGVtIGludG8gYSBib29sZWFuLiBUaGlzIHdpbGwgbm90IHdvcmsgaWYgdGhlCiAvLy8gUkxQSXRlbSBpcyBhIGxpc3QuCiAvLy8gQHBhcmFtIHNlbGYgVGhlIFJMUEl0ZW0uCiAvLy8gQHJldHVybiBUaGUgZGVjb2RlZCBzdHJpbmcuCiBmdW5jdGlvbiB0b0Jvb2woUkxQSXRlbSBtZW1vcnkgc2VsZikgaW50ZXJuYWwgY29uc3RhbnQgcmV0dXJucyAoYm9vbCBkYXRhKSB7CiAgICAgaWYoIWlzRGF0YShzZWxmKSkKICAgICAgICAgdGhyb3c7CiAgICAgdmFyIChyU3RhcnRQb3MsIGxlbikgPSBfZGVjb2RlKHNlbGYpOwogICAgIGlmIChsZW4gIT0gMSkKICAgICAgICAgdGhyb3c7CiAgICAgdWludCB0ZW1wOwogICAgIGFzc2VtYmx5IHsKICAgICAgICAgdGVtcCA6PSBieXRlKDAsIG1sb2FkKHJTdGFydFBvcykpCiAgICAgfQogICAgIGlmICh0ZW1wID4gMSkKICAgICAgICAgdGhyb3c7CiAgICAgcmV0dXJuIHRlbXAgPT0gMSA/IHRydWUgOiBmYWxzZTsKIH0KCiAvLy8gQGRldiBEZWNvZGUgYW4gUkxQSXRlbSBpbnRvIGEgYnl0ZS4gVGhpcyB3aWxsIG5vdCB3b3JrIGlmIHRoZQogLy8vIFJMUEl0ZW0gaXMgYSBsaXN0LgogLy8vIEBwYXJhbSBzZWxmIFRoZSBSTFBJdGVtLgogLy8vIEByZXR1cm4gVGhlIGRlY29kZWQgc3RyaW5nLgogZnVuY3Rpb24gdG9CeXRlKFJMUEl0ZW0gbWVtb3J5IHNlbGYpIGludGVybmFsIGNvbnN0YW50IHJldHVybnMgKGJ5dGUgZGF0YSkgewogICAgIGlmKCFpc0RhdGEoc2VsZikpCiAgICAgICAgIHRocm93OwogICAgIHZhciAoclN0YXJ0UG9zLCBsZW4pID0gX2RlY29kZShzZWxmKTsKICAgICBpZiAobGVuICE9IDEpCiAgICAgICAgIHRocm93OwogICAgIHVpbnQgdGVtcDsKICAgICBhc3NlbWJseSB7CiAgICAgICAgIHRlbXAgOj0gYnl0ZSgwLCBtbG9hZChyU3RhcnRQb3MpKQogICAgIH0KICAgICByZXR1cm4gYnl0ZSh0ZW1wKTsKIH0KCiAvLy8gQGRldiBEZWNvZGUgYW4gUkxQSXRlbSBpbnRvIGFuIGludC4gVGhpcyB3aWxsIG5vdCB3b3JrIGlmIHRoZQogLy8vIFJMUEl0ZW0gaXMgYSBsaXN0LgogLy8vIEBwYXJhbSBzZWxmIFRoZSBSTFBJdGVtLgogLy8vIEByZXR1cm4gVGhlIGRlY29kZWQgc3RyaW5nLgogZnVuY3Rpb24gdG9JbnQoUkxQSXRlbSBtZW1vcnkgc2VsZikgaW50ZXJuYWwgY29uc3RhbnQgcmV0dXJucyAoaW50IGRhdGEpIHsKICAgICByZXR1cm4gaW50KHRvVWludChzZWxmKSk7CiB9CgogLy8vIEBkZXYgRGVjb2RlIGFuIFJMUEl0ZW0gaW50byBhIGJ5dGVzMzIuIFRoaXMgd2lsbCBub3Qgd29yayBpZiB0aGUKIC8vLyBSTFBJdGVtIGlzIGEgbGlzdC4KIC8vLyBAcGFyYW0gc2VsZiBUaGUgUkxQSXRlbS4KIC8vLyBAcmV0dXJuIFRoZSBkZWNvZGVkIHN0cmluZy4KIGZ1bmN0aW9uIHRvQnl0ZXMzMihSTFBJdGVtIG1lbW9yeSBzZWxmKSBpbnRlcm5hbCBjb25zdGFudCByZXR1cm5zIChieXRlczMyIGRhdGEpIHsKICAgICByZXR1cm4gYnl0ZXMzMih0b1VpbnQoc2VsZikpOwogfQoKIC8vLyBAZGV2IERlY29kZSBhbiBSTFBJdGVtIGludG8gYW4gYWRkcmVzcy4gVGhpcyB3aWxsIG5vdCB3b3JrIGlmIHRoZQogLy8vIFJMUEl0ZW0gaXMgYSBsaXN0LgogLy8vIEBwYXJhbSBzZWxmIFRoZSBSTFBJdGVtLgogLy8vIEByZXR1cm4gVGhlIGRlY29kZWQgc3RyaW5nLgogZnVuY3Rpb24gdG9BZGRyZXNzKFJMUEl0ZW0gbWVtb3J5IHNlbGYpIGludGVybmFsIGNvbnN0YW50IHJldHVybnMgKGFkZHJlc3MgZGF0YSkgewogICAgIGlmKCFpc0RhdGEoc2VsZikpCiAgICAgICAgIHRocm93OwogICAgIHZhciAoclN0YXJ0UG9zLCBsZW4pID0gX2RlY29kZShzZWxmKTsKICAgICBpZiAobGVuICE9IDIwKQogICAgICAgICB0aHJvdzsKICAgICBhc3NlbWJseSB7CiAgICAgICAgIGRhdGEgOj0gZGl2KG1sb2FkKHJTdGFydFBvcyksIGV4cCgyNTYsIDEyKSkKICAgICB9CiB9CgogLy8gR2V0IHRoZSBwYXlsb2FkIG9mZnNldC4KIGZ1bmN0aW9uIF9wYXlsb2FkT2Zmc2V0KFJMUEl0ZW0gbWVtb3J5IHNlbGYpIHByaXZhdGUgY29uc3RhbnQgcmV0dXJucyAodWludCkgewogICAgIGlmKHNlbGYuX3Vuc2FmZV9sZW5ndGggPT0gMCkKICAgICAgICAgcmV0dXJuIDA7CiAgICAgdWludCBiMDsKICAgICB1aW50IG1lbVB0ciA9IHNlbGYuX3Vuc2FmZV9tZW1QdHI7CiAgICAgYXNzZW1ibHkgewogICAgICAgICBiMCA6PSBieXRlKDAsIG1sb2FkKG1lbVB0cikpCiAgICAgfQogICAgIGlmKGIwIDwgREFUQV9TSE9SVF9TVEFSVCkKICAgICAgICAgcmV0dXJuIDA7CiAgICAgaWYoYjAgPCBEQVRBX0xPTkdfU1RBUlQgfHwgKGIwID49IExJU1RfU0hPUlRfU1RBUlQgJiYgYjAgPCBMSVNUX0xPTkdfU1RBUlQpKQogICAgICAgICByZXR1cm4gMTsKICAgICBpZihiMCA8IExJU1RfU0hPUlRfU1RBUlQpCiAgICAgICAgIHJldHVybiBiMCAtIERBVEFfTE9OR19PRkZTRVQgKyAxOwogICAgIHJldHVybiBiMCAtIExJU1RfTE9OR19PRkZTRVQgKyAxOwogfQoKIC8vIEdldCB0aGUgZnVsbCBsZW5ndGggb2YgYW4gUkxQIGl0ZW0uCiBmdW5jdGlvbiBfaXRlbUxlbmd0aCh1aW50IG1lbVB0cikgcHJpdmF0ZSBjb25zdGFudCByZXR1cm5zICh1aW50IGxlbikgewogICAgIHVpbnQgYjA7CiAgICAgYXNzZW1ibHkgewogICAgICAgICBiMCA6PSBieXRlKDAsIG1sb2FkKG1lbVB0cikpCiAgICAgfQogICAgIGlmIChiMCA8IERBVEFfU0hPUlRfU1RBUlQpCiAgICAgICAgIGxlbiA9IDE7CiAgICAgZWxzZSBpZiAoYjAgPCBEQVRBX0xPTkdfU1RBUlQpCiAgICAgICAgIGxlbiA9IGIwIC0gREFUQV9TSE9SVF9TVEFSVCArIDE7CiAgICAgZWxzZSBpZiAoYjAgPCBMSVNUX1NIT1JUX1NUQVJUKSB7CiAgICAgICAgIGFzc2VtYmx5IHsKICAgICAgICAgICAgIGxldCBiTGVuIDo9IHN1YihiMCwgMHhCNykgLy8gYnl0ZXMgbGVuZ3RoIChEQVRBX0xPTkdfT0ZGU0VUKQogICAgICAgICAgICAgbGV0IGRMZW4gOj0gZGl2KG1sb2FkKGFkZChtZW1QdHIsIDEpKSwgZXhwKDI1Niwgc3ViKDMyLCBiTGVuKSkpIC8vIGRhdGEgbGVuZ3RoCiAgICAgICAgICAgICBsZW4gOj0gYWRkKDEsIGFkZChiTGVuLCBkTGVuKSkgLy8gdG90YWwgbGVuZ3RoCiAgICAgICAgIH0KICAgICB9CiAgICAgZWxzZSBpZiAoYjAgPCBMSVNUX0xPTkdfU1RBUlQpCiAgICAgICAgIGxlbiA9IGIwIC0gTElTVF9TSE9SVF9TVEFSVCArIDE7CiAgICAgZWxzZSB7CiAgICAgICAgIGFzc2VtYmx5IHsKICAgICAgICAgICAgIGxldCBiTGVuIDo9IHN1YihiMCwgMHhGNykgLy8gYnl0ZXMgbGVuZ3RoIChMSVNUX0xPTkdfT0ZGU0VUKQogICAgICAgICAgICAgbGV0IGRMZW4gOj0gZGl2KG1sb2FkKGFkZChtZW1QdHIsIDEpKSwgZXhwKDI1Niwgc3ViKDMyLCBiTGVuKSkpIC8vIGRhdGEgbGVuZ3RoCiAgICAgICAgICAgICBsZW4gOj0gYWRkKDEsIGFkZChiTGVuLCBkTGVuKSkgLy8gdG90YWwgbGVuZ3RoCiAgICAgICAgIH0KICAgICB9CiB9CgogLy8gR2V0IHN0YXJ0IHBvc2l0aW9uIGFuZCBsZW5ndGggb2YgdGhlIGRhdGEuCiBmdW5jdGlvbiBfZGVjb2RlKFJMUEl0ZW0gbWVtb3J5IHNlbGYpIHByaXZhdGUgY29uc3RhbnQgcmV0dXJucyAodWludCBtZW1QdHIsIHVpbnQgbGVuKSB7CiAgICAgaWYoIWlzRGF0YShzZWxmKSkKICAgICAgICAgdGhyb3c7CiAgICAgdWludCBiMDsKICAgICB1aW50IHN0YXJ0ID0gc2VsZi5fdW5zYWZlX21lbVB0cjsKICAgICBhc3NlbWJseSB7CiAgICAgICAgIGIwIDo9IGJ5dGUoMCwgbWxvYWQoc3RhcnQpKQogICAgIH0KICAgICBpZiAoYjAgPCBEQVRBX1NIT1JUX1NUQVJUKSB7CiAgICAgICAgIG1lbVB0ciA9IHN0YXJ0OwogICAgICAgICBsZW4gPSAxOwogICAgICAgICByZXR1cm47CiAgICAgfQogICAgIGlmIChiMCA8IERBVEFfTE9OR19TVEFSVCkgewogICAgICAgICBsZW4gPSBzZWxmLl91bnNhZmVfbGVuZ3RoIC0gMTsKICAgICAgICAgbWVtUHRyID0gc3RhcnQgKyAxOwogICAgIH0gZWxzZSB7CiAgICAgICAgIHVpbnQgYkxlbjsKICAgICAgICAgYXNzZW1ibHkgewogICAgICAgICAgICAgYkxlbiA6PSBzdWIoYjAsIDB4QjcpIC8vIERBVEFfTE9OR19PRkZTRVQKICAgICAgICAgfQogICAgICAgICBsZW4gPSBzZWxmLl91bnNhZmVfbGVuZ3RoIC0gMSAtIGJMZW47CiAgICAgICAgIG1lbVB0ciA9IHN0YXJ0ICsgYkxlbiArIDE7CiAgICAgfQogICAgIHJldHVybjsKIH0KCiAvLyBBc3N1bWVzIHRoYXQgZW5vdWdoIG1lbW9yeSBoYXMgYmVlbiBhbGxvY2F0ZWQgdG8gc3RvcmUgaW4gdGFyZ2V0LgogZnVuY3Rpb24gX2NvcHlUb0J5dGVzKHVpbnQgYnRzUHRyLCBieXRlcyBtZW1vcnkgdGd0LCB1aW50IGJ0c0xlbikgcHJpdmF0ZSBjb25zdGFudCB7CiAgICAgLy8gRXhwbG9pdGluZyB0aGUgZmFjdCB0aGF0ICd0Z3QnIHdhcyB0aGUgbGFzdCB0aGluZyB0byBiZSBhbGxvY2F0ZWQsCiAgICAgLy8gd2UgY2FuIHdyaXRlIGVudGlyZSB3b3JkcywgYW5kIGp1c3Qgb3ZlcndyaXRlIGFueSBleGNlc3MuCiAgICAgYXNzZW1ibHkgewogICAgICAgICB7CiAgICAgICAgICAgICAgICAgbGV0IGkgOj0gMCAvLyBTdGFydCBhdCBhcnIgKyAweDIwCiAgICAgICAgICAgICAgICAgbGV0IHdvcmRzIDo9IGRpdihhZGQoYnRzTGVuLCAzMSksIDMyKQogICAgICAgICAgICAgICAgIGxldCByT2Zmc2V0IDo9IGJ0c1B0cgogICAgICAgICAgICAgICAgIGxldCB3T2Zmc2V0IDo9IGFkZCh0Z3QsIDB4MjApCiAgICAgICAgICAgICB0YWdfbG9vcDoKICAgICAgICAgICAgICAgICBqdW1waShlbmQsIGVxKGksIHdvcmRzKSkKICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgIGxldCBvZmZzZXQgOj0gbXVsKGksIDB4MjApCiAgICAgICAgICAgICAgICAgICAgIG1zdG9yZShhZGQod09mZnNldCwgb2Zmc2V0KSwgbWxvYWQoYWRkKHJPZmZzZXQsIG9mZnNldCkpKQogICAgICAgICAgICAgICAgICAgICBpIDo9IGFkZChpLCAxKQogICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICBqdW1wKHRhZ19sb29wKQogICAgICAgICAgICAgZW5kOgogICAgICAgICAgICAgICAgIG1zdG9yZShhZGQodGd0LCBhZGQoMHgyMCwgbWxvYWQodGd0KSkpLCAwKQogICAgICAgICB9CiAgICAgfQogfQoKICAgICAvLyBDaGVjayB0aGF0IGFuIFJMUCBpdGVtIGlzIHZhbGlkLgogICAgIGZ1bmN0aW9uIF92YWxpZGF0ZShSTFBJdGVtIG1lbW9yeSBzZWxmKSBwcml2YXRlIGNvbnN0YW50IHJldHVybnMgKGJvb2wgcmV0KSB7CiAgICAgICAgIC8vIENoZWNrIHRoYXQgUkxQIGlzIHdlbGwtZm9ybWVkLgogICAgICAgICB1aW50IGIwOwogICAgICAgICB1aW50IGIxOwogICAgICAgICB1aW50IG1lbVB0ciA9IHNlbGYuX3Vuc2FmZV9tZW1QdHI7CiAgICAgICAgIGFzc2VtYmx5IHsKICAgICAgICAgICAgIGIwIDo9IGJ5dGUoMCwgbWxvYWQobWVtUHRyKSkKICAgICAgICAgICAgIGIxIDo9IGJ5dGUoMSwgbWxvYWQobWVtUHRyKSkKICAgICAgICAgfQogICAgICAgICBpZihiMCA9PSBEQVRBX1NIT1JUX1NUQVJUICsgMSAmJiBiMSA8IERBVEFfU0hPUlRfU1RBUlQpCiAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgIHJldHVybiB0cnVlOwogICAgIH0KfQoKCgoKY29udHJhY3QgQWd0IHsKICAgIHVzaW5nIFJMUCBmb3IgUkxQLlJMUEl0ZW07CiAgICB1c2luZyBSTFAgZm9yIFJMUC5JdGVyYXRvcjsKICAgIHVzaW5nIFJMUCBmb3IgYnl0ZXM7CiAKICAgIHN0cnVjdCBCbG9ja0hlYWRlciB7CiAgICAgICAgdWludCAgICAgICBwcmV2QmxvY2tIYXNoOyAvLyAwCiAgICAgICAgdWludCAgICAgICBjb2luYmFzZTsgICAgICAvLyAxCiAgICAgICAgdWludCAgICAgICBibG9ja051bWJlcjsgICAvLyA4CiAgICAgICAgLy91aW50ICAgICAgIGdhc1VzZWQ7ICAgICAgIC8vIDEwCiAgICAgICAgdWludCAgICAgICB0aW1lc3RhbXA7ICAgICAvLyAxMQogICAgICAgIGJ5dGVzMzIgICAgZXh0cmFEYXRhOyAgICAgLy8gMTIKICAgIH0KIAogICAgZnVuY3Rpb24gQWd0KCkge30KICAgICAKICAgIGZ1bmN0aW9uIHBhcnNlQmxvY2tIZWFkZXIoIGJ5dGVzIHJscEhlYWRlciApIGNvbnN0YW50IGludGVybmFsIHJldHVybnMoQmxvY2tIZWFkZXIpIHsKICAgICAgICBCbG9ja0hlYWRlciBtZW1vcnkgaGVhZGVyOwogICAgICAgIAogICAgICAgIHZhciBpdCA9IHJscEhlYWRlci50b1JMUEl0ZW0oKS5pdGVyYXRvcigpOyAgICAgICAgCiAgICAgICAgdWludCBpZHg7CiAgICAgICAgd2hpbGUoaXQuaGFzTmV4dCgpKSB7CiAgICAgICAgICAgIGlmKCBpZHggPT0gMCApIGhlYWRlci5wcmV2QmxvY2tIYXNoID0gaXQubmV4dCgpLnRvVWludCgpOwogICAgICAgICAgICBlbHNlIGlmICggaWR4ID09IDIgKSBoZWFkZXIuY29pbmJhc2UgPSBpdC5uZXh0KCkudG9VaW50KCk7CiAgICAgICAgICAgIGVsc2UgaWYgKCBpZHggPT0gOCApIGhlYWRlci5ibG9ja051bWJlciA9IGl0Lm5leHQoKS50b1VpbnQoKTsKICAgICAgICAgICAgZWxzZSBpZiAoIGlkeCA9PSAxMSApIGhlYWRlci50aW1lc3RhbXAgPSBpdC5uZXh0KCkudG9VaW50KCk7CiAgICAgICAgICAgIGVsc2UgaWYgKCBpZHggPT0gMTIgKSBoZWFkZXIuZXh0cmFEYXRhID0gYnl0ZXMzMihpdC5uZXh0KCkudG9VaW50KCkpOwogICAgICAgICAgICBlbHNlIGl0Lm5leHQoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlkeCsrOwogICAgICAgIH0KIAogICAgICAgIHJldHVybiBoZWFkZXI7ICAgICAgICAKICAgIH0KICAgICAgICAgICAgCiAgICAvL2V2ZW50IFZlcmlmeUFndCggc3RyaW5nIG1zZywgdWludCBpbmRleCApOwogICAgZXZlbnQgVmVyaWZ5QWd0KCB1aW50IGVycm9yLCB1aW50IGluZGV4ICk7ICAgIAogICAgCiAgICBzdHJ1Y3QgVmVyaWZ5QWd0RGF0YSB7CiAgICAgICAgdWludCByb290SGFzaDsKICAgICAgICB1aW50IHJvb3RNaW47CiAgICAgICAgdWludCByb290TWF4OwogICAgICAgIAogICAgICAgIHVpbnQgbGVhZkhhc2g7CiAgICAgICAgdWludCBsZWFmQ291bnRlcjsgICAgICAgIAogICAgfQoKICAgIGZ1bmN0aW9uIHZlcmlmeUFndCggVmVyaWZ5QWd0RGF0YSBkYXRhLAogICAgICAgICAgICAgICAgICAgICAgICB1aW50ICAgYnJhbmNoSW5kZXgsCiAgICAgICAgICAgICAgICAgICAgICAgIHVpbnRbXSBjb3VudGVyc0JyYW5jaCwKICAgICAgICAgICAgICAgICAgICAgICAgdWludFtdIGhhc2hlc0JyYW5jaCApIGNvbnN0YW50IGludGVybmFsIHJldHVybnMoYm9vbCkgewogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICB1aW50IGN1cnJlbnRIYXNoID0gZGF0YS5sZWFmSGFzaCAmIDB4RkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkY7CiAgICAgICAgCiAgICAgICAgdWludCBsZWZ0Q291bnRlck1pbjsKICAgICAgICB1aW50IGxlZnRDb3VudGVyTWF4OyAgICAgICAgCiAgICAgICAgdWludCBsZWZ0SGFzaDsKICAgICAgICAKICAgICAgICB1aW50IHJpZ2h0Q291bnRlck1pbjsKICAgICAgICB1aW50IHJpZ2h0Q291bnRlck1heDsgICAgICAgIAogICAgICAgIHVpbnQgcmlnaHRIYXNoOwogICAgICAgIAogICAgICAgIHVpbnQgbWluID0gZGF0YS5sZWFmQ291bnRlcjsKICAgICAgICB1aW50IG1heCA9IGRhdGEubGVhZkNvdW50ZXI7CiAgICAgICAgCiAgICAgICAgZm9yKCB1aW50IGkgPSAwIDsgaSA8IGNvdW50ZXJzQnJhbmNoLmxlbmd0aCA7IGkrKyApIHsKICAgICAgICAgICAgaWYoIGJyYW5jaEluZGV4ICYgMHgxID4gMCApIHsKICAgICAgICAgICAgICAgIGxlZnRDb3VudGVyTWluID0gY291bnRlcnNCcmFuY2hbaV0gJiAweEZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGOwogICAgICAgICAgICAgICAgbGVmdENvdW50ZXJNYXggPSBjb3VudGVyc0JyYW5jaFtpXSA+PiAxMjg7ICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbGVmdEhhc2ggICAgPSBoYXNoZXNCcmFuY2hbaV07CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHJpZ2h0Q291bnRlck1pbiA9IG1pbjsKICAgICAgICAgICAgICAgIHJpZ2h0Q291bnRlck1heCA9IG1heDsKICAgICAgICAgICAgICAgIHJpZ2h0SGFzaCAgICA9IGN1cnJlbnRIYXNoOyAgICAgICAgICAgICAgICAKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBsZWZ0Q291bnRlck1pbiA9IG1pbjsKICAgICAgICAgICAgICAgIGxlZnRDb3VudGVyTWF4ID0gbWF4OwogICAgICAgICAgICAgICAgbGVmdEhhc2ggICAgPSBjdXJyZW50SGFzaDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgcmlnaHRDb3VudGVyTWluID0gY291bnRlcnNCcmFuY2hbaV0gJiAweEZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGOwogICAgICAgICAgICAgICAgcmlnaHRDb3VudGVyTWF4ID0gY291bnRlcnNCcmFuY2hbaV0gPj4gMTI4OyAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHJpZ2h0SGFzaCAgICA9IGhhc2hlc0JyYW5jaFtpXTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBjdXJyZW50SGFzaCA9IHVpbnQoc2hhMyhsZWZ0Q291bnRlck1pbiArIChsZWZ0Q291bnRlck1heCA8PCAxMjgpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZWZ0SGFzaCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmlnaHRDb3VudGVyTWluICsgKHJpZ2h0Q291bnRlck1heCA8PCAxMjgpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByaWdodEhhc2gpKSAmIDB4RkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkY7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiggKGxlZnRDb3VudGVyTWluID49IGxlZnRDb3VudGVyTWF4KSB8fCAocmlnaHRDb3VudGVyTWluID49IHJpZ2h0Q291bnRlck1heCkgKSB7CiAgICAgICAgICAgICAgICBpZiggaSA+IDAgKSB7CiAgICAgICAgICAgICAgICAgICAgLy9WZXJpZnlBZ3QoICJjb3VudGVycyBtaXNtYXRjaCIsaSk7CiAgICAgICAgICAgICAgICAgICAgVmVyaWZ5QWd0KCAweDgwMDAwMDAwLCBpICk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYoIGxlZnRDb3VudGVyTWluID4gbGVmdENvdW50ZXJNYXggKSB7CiAgICAgICAgICAgICAgICAgICAgLy9WZXJpZnlBZ3QoICJjb3VudGVycyBtaXNtYXRjaCIsaSk7CiAgICAgICAgICAgICAgICAgICAgVmVyaWZ5QWd0KCAweDgwMDAwMDAxLCBpICk7ICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmKCByaWdodENvdW50ZXJNaW4gPiByaWdodENvdW50ZXJNYXggKSB7CiAgICAgICAgICAgICAgICAgICAgLy9WZXJpZnlBZ3QoICJjb3VudGVycyBtaXNtYXRjaCIsaSk7CiAgICAgICAgICAgICAgICAgICAgVmVyaWZ5QWd0KCAweDgwMDAwMDAyLCBpICk7ICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIH0gICAgICAgICAgICAgICAgCiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGlmKCBsZWZ0Q291bnRlck1heCA+PSByaWdodENvdW50ZXJNaW4gKSB7CiAgICAgICAgICAgICAgICBWZXJpZnlBZ3QoIDB4ODAwMDAwMDksIGkgKTsgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgbWluID0gbGVmdENvdW50ZXJNaW47CiAgICAgICAgICAgIG1heCA9IHJpZ2h0Q291bnRlck1heDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGJyYW5jaEluZGV4ID0gYnJhbmNoSW5kZXggLyAyOwogICAgICAgIH0KCiAgICAgICAgaWYoIG1pbiAhPSBkYXRhLnJvb3RNaW4gKSB7CiAgICAgICAgICAgIC8vVmVyaWZ5QWd0KCAibWluIGRvZXMgbm90IG1hdGNoIHJvb3QgbWluIixtaW4pOwogICAgICAgICAgICBWZXJpZnlBZ3QoIDB4ODAwMDAwMDMsIG1pbiApOyAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGlmKCBtYXggIT0gZGF0YS5yb290TWF4ICkgewogICAgICAgICAgICAvL1ZlcmlmeUFndCggIm1heCBkb2VzIG5vdCBtYXRjaCByb290IG1heCIsbWF4KTsKICAgICAgICAgICAgVmVyaWZ5QWd0KCAweDgwMDAwMDA0LCBtYXggKTsgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGlmKCBjdXJyZW50SGFzaCAhPSBkYXRhLnJvb3RIYXNoICkgewogICAgICAgICAgICAvL1ZlcmlmeUFndCggImhhc2ggZG9lcyBub3QgbWF0Y2ggcm9vdCBoYXNoIixjdXJyZW50SGFzaCk7ICAgICAgICAKICAgICAgICAgICAgVmVyaWZ5QWd0KCAweDgwMDAwMDA1LCBjdXJyZW50SGFzaCApOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgCiAgICBmdW5jdGlvbiB2ZXJpZnlBZ3REZWJ1Z0ZvclRlc3RpbmcoIHVpbnQgcm9vdEhhc2gsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVpbnQgcm9vdE1pbiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdWludCByb290TWF4LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1aW50IGxlYWZIYXNoLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1aW50IGxlYWZDb3VudGVyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1aW50IGJyYW5jaEluZGV4LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1aW50W10gY291bnRlcnNCcmFuY2gsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVpbnRbXSBoYXNoZXNCcmFuY2ggKSByZXR1cm5zKGJvb2wpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgVmVyaWZ5QWd0RGF0YSBtZW1vcnkgZGF0YTsKICAgICAgICBkYXRhLnJvb3RIYXNoID0gcm9vdEhhc2g7CiAgICAgICAgZGF0YS5yb290TWluID0gcm9vdE1pbjsKICAgICAgICBkYXRhLnJvb3RNYXggPSByb290TWF4OwogICAgICAgIGRhdGEubGVhZkhhc2ggPSBsZWFmSGFzaDsKICAgICAgICBkYXRhLmxlYWZDb3VudGVyID0gbGVhZkNvdW50ZXI7CiAgICAgICAgCiAgICAgICAgcmV0dXJuIHZlcmlmeUFndCggZGF0YSwgYnJhbmNoSW5kZXgsIGNvdW50ZXJzQnJhbmNoLCBoYXNoZXNCcmFuY2ggKTsKICAgIH0gICAgICAgICAKfQoKY29udHJhY3QgV2VpZ2h0ZWRTdWJtaXNzaW9uIHsKICAgIGZ1bmN0aW9uIFdlaWdodGVkU3VibWlzc2lvbigpe30KICAgIAogICAgc3RydWN0IFNpbmdsZVN1Ym1pc3Npb25EYXRhIHsKICAgICAgICB1aW50MTI4IG51bVNoYXJlczsKICAgICAgICB1aW50MTI4IHN1Ym1pc3Npb25WYWx1ZTsKICAgICAgICB1aW50MTI4IHRvdGFsUHJldmlvdXNTdWJtaXNzaW9uVmFsdWU7CiAgICAgICAgdWludDEyOCBtaW47CiAgICAgICAgdWludDEyOCBtYXg7CiAgICAgICAgdWludDEyOCBhdWdSb290OwogICAgfQogICAgCiAgICBzdHJ1Y3QgU3VibWlzc2lvbk1ldGFEYXRhIHsKICAgICAgICB1aW50NjQgIG51bVBlbmRpbmdTdWJtaXNzaW9uczsKICAgICAgICB1aW50MzIgIHJlYWR5Rm9yVmVyaWZpY2F0aW9uOyAvLyBzdXBwb3NlIHRvIGJlIGJvb2wKICAgICAgICB1aW50MzIgIGxhc3RTdWJtaXNzaW9uQmxvY2tOdW1iZXI7CiAgICAgICAgdWludDEyOCB0b3RhbFN1Ym1pc3Npb25WYWx1ZTsKICAgICAgICB1aW50MTI4IGRpZmZpY3VsdHk7CiAgICAgICAgdWludDEyOCBsYXN0Q291bnRlcjsKICAgICAgICAKICAgICAgICB1aW50ICAgIHN1Ym1pc3Npb25TZWVkOwogICAgICAgIAogICAgfQogICAgCiAgICBtYXBwaW5nKGFkZHJlc3M9PlN1Ym1pc3Npb25NZXRhRGF0YSkgc3VibWlzc2lvbnNNZXRhRGF0YTsKICAgIAogICAgLy8gKHVzZXIsIHN1Ym1pc3Npb24gbnVtYmVyKT0+ZGF0YQogICAgbWFwcGluZyhhZGRyZXNzPT5tYXBwaW5nKHVpbnQ9PlNpbmdsZVN1Ym1pc3Npb25EYXRhKSkgc3VibWlzc2lvbnNEYXRhOwogICAgCiAgICBldmVudCBTdWJtaXRDbGFpbSggYWRkcmVzcyBpbmRleGVkIHNlbmRlciwgdWludCBlcnJvciwgdWludCBlcnJvckluZm8gKTsKICAgIGZ1bmN0aW9uIHN1Ym1pdENsYWltKCB1aW50IG51bVNoYXJlcywgdWludCBkaWZmaWN1bHR5LCB1aW50IG1pbiwgdWludCBtYXgsIHVpbnQgYXVnUm9vdCwgYm9vbCBsYXN0Q2xhaW1CZWZvcmVWZXJpZmljYXRpb24gKSB7CiAgICAgICAgU3VibWlzc2lvbk1ldGFEYXRhIG1lbW9yeSBtZXRhRGF0YSA9IHN1Ym1pc3Npb25zTWV0YURhdGFbbXNnLnNlbmRlcl07CiAgICAgICAgCiAgICAgICAgaWYoIG1ldGFEYXRhLmxhc3RDb3VudGVyID49IG1pbiApIHsKICAgICAgICAgICAgLy8gbWluZXIgY2hlYXRlZC4gbWluIGNvdW50ZXIgaXMgdG9vIGxvdwogICAgICAgICAgICBTdWJtaXRDbGFpbSggbXNnLnNlbmRlciwgMHg4MTAwMDAwMSwgbWV0YURhdGEubGFzdENvdW50ZXIgKTsgCiAgICAgICAgICAgIHJldHVybjsgICAgICAgIAogICAgICAgIH0KICAgICAgICAKICAgICAgICBpZiggbWV0YURhdGEucmVhZHlGb3JWZXJpZmljYXRpb24gPiAwICkgewogICAgICAgICAgICAvLyBtaW5lciBjaGVhdGVkIC0gc2hvdWxkIGdvIHZlcmlmaWNhdGlvbiBmaXJzdAogICAgICAgICAgICBTdWJtaXRDbGFpbSggbXNnLnNlbmRlciwgMHg4MTAwMDAwMiwgMCApOyAKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBpZiggbWV0YURhdGEubnVtUGVuZGluZ1N1Ym1pc3Npb25zID4gMCApIHsKICAgICAgICAgICAgaWYoIG1ldGFEYXRhLmRpZmZpY3VsdHkgIT0gZGlmZmljdWx0eSApIHsKICAgICAgICAgICAgICAgIC8vIGNvdWxkIG5vdCBjaGFuZ2UgZGlmZmljdWx0eSBiZWZvcmUgdmVyaWZpY2F0aW9uCiAgICAgICAgICAgICAgICBTdWJtaXRDbGFpbSggbXNnLnNlbmRlciwgMHg4MTAwMDAwMywgbWV0YURhdGEuZGlmZmljdWx0eSApOyAKICAgICAgICAgICAgICAgIHJldHVybjsgICAgICAgICAgICAKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAKICAgICAgICBTaW5nbGVTdWJtaXNzaW9uRGF0YSBtZW1vcnkgc3VibWlzc2lvbkRhdGE7CiAgICAgICAgCiAgICAgICAgc3VibWlzc2lvbkRhdGEubnVtU2hhcmVzID0gdWludDY0KG51bVNoYXJlcyk7CiAgICAgICAgdWludCBibG9ja0RpZmZpY3VsdHk7CiAgICAgICAgaWYoIGJsb2NrLmRpZmZpY3VsdHkgPT0gMCApIHsKICAgICAgICAgICAgLy8gdGVzdHJwYyAtIGZha2UgaW5jcmVhc2luZyBkaWZmaWN1bHR5CiAgICAgICAgICAgIGJsb2NrRGlmZmljdWx0eSA9ICg5MDAwMDAwMDAgKiAobWV0YURhdGEubnVtUGVuZGluZ1N1Ym1pc3Npb25zKzEpKTsgCiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgICBibG9ja0RpZmZpY3VsdHkgPSBibG9jay5kaWZmaWN1bHR5OwogICAgICAgIH0KICAgICAgICAKICAgICAgICBzdWJtaXNzaW9uRGF0YS5zdWJtaXNzaW9uVmFsdWUgPSB1aW50MTI4KCh1aW50KG51bVNoYXJlcyAqIGRpZmZpY3VsdHkpICogKDUgZXRoZXIpKSAvIGJsb2NrRGlmZmljdWx0eSk7CiAgICAgICAgCiAgICAgICAgc3VibWlzc2lvbkRhdGEudG90YWxQcmV2aW91c1N1Ym1pc3Npb25WYWx1ZSA9IG1ldGFEYXRhLnRvdGFsU3VibWlzc2lvblZhbHVlOwogICAgICAgIHN1Ym1pc3Npb25EYXRhLm1pbiA9IHVpbnQxMjgobWluKTsKICAgICAgICBzdWJtaXNzaW9uRGF0YS5tYXggPSB1aW50MTI4KG1heCk7CiAgICAgICAgc3VibWlzc2lvbkRhdGEuYXVnUm9vdCA9IHVpbnQxMjgoYXVnUm9vdCk7CiAgICAgICAgCiAgICAgICAgKHN1Ym1pc3Npb25zRGF0YVttc2cuc2VuZGVyXSlbbWV0YURhdGEubnVtUGVuZGluZ1N1Ym1pc3Npb25zXSA9IHN1Ym1pc3Npb25EYXRhOwogICAgICAgIAogICAgICAgIC8vIHVwZGF0ZSBtZXRhIGRhdGEKICAgICAgICBtZXRhRGF0YS5udW1QZW5kaW5nU3VibWlzc2lvbnMrKzsKICAgICAgICBtZXRhRGF0YS5sYXN0U3VibWlzc2lvbkJsb2NrTnVtYmVyID0gdWludDMyKGJsb2NrLm51bWJlcik7CiAgICAgICAgbWV0YURhdGEuZGlmZmljdWx0eSA9IHVpbnQxMjgoZGlmZmljdWx0eSk7CiAgICAgICAgbWV0YURhdGEubGFzdENvdW50ZXIgPSB1aW50MTI4KG1heCk7CiAgICAgICAgbWV0YURhdGEucmVhZHlGb3JWZXJpZmljYXRpb24gPSBsYXN0Q2xhaW1CZWZvcmVWZXJpZmljYXRpb24gPyB1aW50MzIoMSkgOiB1aW50MzIoMCk7CgogICAgICAgIHVpbnQxMjggdGVtcDEyODsKICAgICAgICAKICAgICAgICAKICAgICAgICB0ZW1wMTI4ID0gbWV0YURhdGEudG90YWxTdWJtaXNzaW9uVmFsdWU7IAoKICAgICAgICBtZXRhRGF0YS50b3RhbFN1Ym1pc3Npb25WYWx1ZSArPSBzdWJtaXNzaW9uRGF0YS5zdWJtaXNzaW9uVmFsdWU7CiAgICAgICAgCiAgICAgICAgaWYoIHRlbXAxMjggPiBtZXRhRGF0YS50b3RhbFN1Ym1pc3Npb25WYWx1ZSApIHsKICAgICAgICAgICAgLy8gb3ZlcmZsb3cgaW4gY2FsY3VsYXRpb24KICAgICAgICAgICAgLy8gbm90ZSB0aGF0IHRoaXMgY29kZSBpcyByZWFjaGFibGUgaWYgdXNlciBpcyBkaXNob25lc3QgYW5kIGdpdmUgZmFsc2UKICAgICAgICAgICAgLy8gcmVwb3J0IG9uIGhpcyBzdWJtaXNzaW9uLiBidXQgZXZlbiB3aXRob3V0CiAgICAgICAgICAgIC8vIHRoaXMgdmFsaWRhdGlvbiwgdXNlciBjYW5ub3QgYmVuaWZpdCBmcm9tIHRoZSBvdmVyZmxvdwogICAgICAgICAgICBTdWJtaXRDbGFpbSggbXNnLnNlbmRlciwgMHg4MTAwMDAwNSwgMCApOyAKICAgICAgICAgICAgcmV0dXJuOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgCiAgICAgICAgc3VibWlzc2lvbnNNZXRhRGF0YVttc2cuc2VuZGVyXSA9IG1ldGFEYXRhOwogICAgICAgIAogICAgICAgIC8vIGV2ZXJ5dGhpbmcgaXMgb2sKICAgICAgICBTdWJtaXRDbGFpbSggbXNnLnNlbmRlciwgMCwgbnVtU2hhcmVzICogZGlmZmljdWx0eSApOwogICAgfQoKICAgIGZ1bmN0aW9uIGdldENsYWltU2VlZChhZGRyZXNzIHNlbmRlcikgY29uc3RhbnQgcmV0dXJucyh1aW50KXsKICAgICAgICBTdWJtaXNzaW9uTWV0YURhdGEgbWVtb3J5IG1ldGFEYXRhID0gc3VibWlzc2lvbnNNZXRhRGF0YVtzZW5kZXJdOwogICAgICAgIGlmKCBtZXRhRGF0YS5yZWFkeUZvclZlcmlmaWNhdGlvbiA9PSAwICkgcmV0dXJuIDA7CiAgICAgICAgCiAgICAgICAgaWYoIG1ldGFEYXRhLnN1Ym1pc3Npb25TZWVkICE9IDAgKSByZXR1cm4gbWV0YURhdGEuc3VibWlzc2lvblNlZWQ7IAogICAgICAgIAogICAgICAgIHVpbnQgbGFzdEJsb2NrTnVtYmVyID0gdWludChtZXRhRGF0YS5sYXN0U3VibWlzc2lvbkJsb2NrTnVtYmVyKTsKICAgICAgICAKICAgICAgICBpZiggYmxvY2subnVtYmVyID4gbGFzdEJsb2NrTnVtYmVyICsgMjAwICkgcmV0dXJuIDA7CiAgICAgICAgaWYoIGJsb2NrLm51bWJlciA8PSBsYXN0QmxvY2tOdW1iZXIgKyAxNSApIHJldHVybiAwOwogICAgICAgICAgICAgICAgCiAgICAgICAgcmV0dXJuIHVpbnQoYmxvY2suYmxvY2toYXNoKGxhc3RCbG9ja051bWJlciArIDEwKSk7CiAgICB9CiAgICAKICAgIGV2ZW50IFN0b3JlQ2xhaW1TZWVkKCBhZGRyZXNzIGluZGV4ZWQgc2VuZGVyLCB1aW50IGVycm9yLCB1aW50IGVycm9ySW5mbyApOwogICAgZnVuY3Rpb24gc3RvcmVDbGFpbVNlZWQoIGFkZHJlc3MgbWluZXIgKSB7CiAgICAgICAgLy8gYW55b25lIHdobyBpcyB3aWxsaW5nIHRvIHBheSBnYXMgZmVlcyBjYW4gY2FsbCB0aGlzIGZ1bmN0aW9uCiAgICAgICAgdWludCBzZWVkID0gZ2V0Q2xhaW1TZWVkKCBtaW5lciApOwogICAgICAgIGlmKCBzZWVkICE9IDAgKSB7CiAgICAgICAgICAgIHN1Ym1pc3Npb25zTWV0YURhdGFbbWluZXJdLnN1Ym1pc3Npb25TZWVkID0gc2VlZDsKICAgICAgICAgICAgU3RvcmVDbGFpbVNlZWQoIG1zZy5zZW5kZXIsIDAsIHVpbnQobWluZXIpICk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLy8gZWxzZQogICAgICAgIFN1Ym1pc3Npb25NZXRhRGF0YSBtZW1vcnkgbWV0YURhdGEgPSBzdWJtaXNzaW9uc01ldGFEYXRhW21pbmVyXTsKICAgICAgICB1aW50IGxhc3RCbG9ja051bWJlciA9IHVpbnQobWV0YURhdGEubGFzdFN1Ym1pc3Npb25CbG9ja051bWJlcik7CiAgICAgICAgICAgICAgICAKICAgICAgICBpZiggbWV0YURhdGEucmVhZHlGb3JWZXJpZmljYXRpb24gPT0gMCApIHsKICAgICAgICAgICAgLy8gc3VibWlzc2lvbiBpcyBub3QgcmVhZHkgZm9yIHZlcmlmaWNhdGlvbgogICAgICAgICAgICBTdG9yZUNsYWltU2VlZCggbXNnLnNlbmRlciwgMHg4MDAwMDAwLCB1aW50KG1pbmVyKSApOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmKCBibG9jay5udW1iZXIgPiBsYXN0QmxvY2tOdW1iZXIgKyAyMDAgKSB7CiAgICAgICAgICAgIC8vIHN1Ym1pc3Npb24gaXMgbm90IHJlYWR5IGZvciB2ZXJpZmljYXRpb24KICAgICAgICAgICAgU3RvcmVDbGFpbVNlZWQoIG1zZy5zZW5kZXIsIDB4ODAwMDAwMSwgdWludChtaW5lcikgKTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiggYmxvY2subnVtYmVyIDw9IGxhc3RCbG9ja051bWJlciArIDE1ICkgewogICAgICAgICAgICAvLyBpdCBpcyB0b28gbGF0ZSB0byBjYWxsIHN0b3JlIGZ1bmN0aW9uCiAgICAgICAgICAgIFN0b3JlQ2xhaW1TZWVkKCBtc2cuc2VuZGVyLCAweDgwMDAwMDIsIHVpbnQobWluZXIpICk7CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgICAvLyB1bmtub3duIGVycm9yCiAgICAgICAgICAgIFN0b3JlQ2xhaW1TZWVkKCBtc2cuc2VuZGVyLCAweDgwMDAwMDMsIHVpbnQobWluZXIpICk7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIHZlcmlmeVN1Ym1pc3Npb25JbmRleCggYWRkcmVzcyBzZW5kZXIsIHVpbnQgc2VlZCwgdWludCBzdWJtaXNzaW9uTnVtYmVyLCB1aW50IHNoYXJlSW5kZXggKSBjb25zdGFudCByZXR1cm5zKGJvb2wpIHsKICAgICAgICBpZiggc2VlZCA9PSAwICkgcmV0dXJuIGZhbHNlOwogICAgCiAgICAgICAgdWludCB0b3RhbFZhbHVlID0gdWludChzdWJtaXNzaW9uc01ldGFEYXRhW3NlbmRlcl0udG90YWxTdWJtaXNzaW9uVmFsdWUpOwogICAgICAgIHVpbnQgbnVtUGVuZGluZ1N1Ym1pc3Npb25zID0gdWludChzdWJtaXNzaW9uc01ldGFEYXRhW3NlbmRlcl0ubnVtUGVuZGluZ1N1Ym1pc3Npb25zKTsKCiAgICAgICAgU2luZ2xlU3VibWlzc2lvbkRhdGEgbWVtb3J5IHN1Ym1pc3Npb25EYXRhID0gKHN1Ym1pc3Npb25zRGF0YVtzZW5kZXJdKVtzdWJtaXNzaW9uTnVtYmVyXTsgICAgICAgIAogICAgICAgIAogICAgICAgIGlmKCBzdWJtaXNzaW9uTnVtYmVyID49IG51bVBlbmRpbmdTdWJtaXNzaW9ucyApIHJldHVybiBmYWxzZTsKICAgICAgICAKICAgICAgICB1aW50IHNlZWQxID0gc2VlZCAmIDB4RkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkY7CiAgICAgICAgdWludCBzZWVkMiA9IHNlZWQgLyAoMioqMTI4KTsKICAgICAgICAKICAgICAgICB1aW50IHNlbGVjdGVkVmFsdWUgPSBzZWVkMSAlIHRvdGFsVmFsdWU7CiAgICAgICAgaWYoIHVpbnQoc3VibWlzc2lvbkRhdGEudG90YWxQcmV2aW91c1N1Ym1pc3Npb25WYWx1ZSkgPj0gc2VsZWN0ZWRWYWx1ZSApIHJldHVybiBmYWxzZTsKICAgICAgICBpZiggdWludChzdWJtaXNzaW9uRGF0YS50b3RhbFByZXZpb3VzU3VibWlzc2lvblZhbHVlICsgc3VibWlzc2lvbkRhdGEuc3VibWlzc2lvblZhbHVlKSA8IHNlbGVjdGVkVmFsdWUgKSByZXR1cm4gZmFsc2U7ICAKCiAgICAgICAgdWludCBleHBlY3RlZFNoYXJlc2hhcmVJbmRleCA9IChzZWVkMiAlIHVpbnQoc3VibWlzc2lvbkRhdGEubnVtU2hhcmVzKSk7CiAgICAgICAgaWYoIGV4cGVjdGVkU2hhcmVzaGFyZUluZGV4ICE9IHNoYXJlSW5kZXggKSByZXR1cm4gZmFsc2U7CiAgICAgICAgCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICAKICAgIGZ1bmN0aW9uIGNhbGN1bGF0ZVN1Ym1pc3Npb25JbmRleCggYWRkcmVzcyBzZW5kZXIsIHVpbnQgc2VlZCApIGNvbnN0YW50IHJldHVybnModWludFsyXSkgewogICAgICAgIC8vIHRoaXMgZnVuY3Rpb24gc2hvdWxkIGJlIGV4ZWN1dGVkIG9mZiBjaGFpbiAtIGhlbmUsIGl0IGlzIG5vdCBvcHRpbWl6ZWQKICAgICAgICB1aW50IHNlZWQxID0gc2VlZCAmIDB4RkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkY7CiAgICAgICAgdWludCBzZWVkMiA9IHNlZWQgLyAoMioqMTI4KTsKCiAgICAgICAgdWludCB0b3RhbFZhbHVlID0gdWludChzdWJtaXNzaW9uc01ldGFEYXRhW3NlbmRlcl0udG90YWxTdWJtaXNzaW9uVmFsdWUpOwogICAgICAgIHVpbnQgbnVtUGVuZGluZ1N1Ym1pc3Npb25zID0gdWludChzdWJtaXNzaW9uc01ldGFEYXRhW3NlbmRlcl0ubnVtUGVuZGluZ1N1Ym1pc3Npb25zKTsKCiAgICAgICAgdWludCBzZWxlY3RlZFZhbHVlID0gc2VlZDEgJSB0b3RhbFZhbHVlOwogICAgICAgIAogICAgICAgIFNpbmdsZVN1Ym1pc3Npb25EYXRhIG1lbW9yeSBzdWJtaXNzaW9uRGF0YTsgICAgICAgIAogICAgICAgIAogICAgICAgIGZvciggdWludCBzdWJtaXNzaW9uSW5kID0gMCA7IHN1Ym1pc3Npb25JbmQgPCBudW1QZW5kaW5nU3VibWlzc2lvbnMgOyBzdWJtaXNzaW9uSW5kKysgKSB7CiAgICAgICAgICAgIHN1Ym1pc3Npb25EYXRhID0gKHN1Ym1pc3Npb25zRGF0YVtzZW5kZXJdKVtzdWJtaXNzaW9uSW5kXTsgICAgICAgIAogICAgICAgICAgICBpZiggdWludChzdWJtaXNzaW9uRGF0YS50b3RhbFByZXZpb3VzU3VibWlzc2lvblZhbHVlICsgc3VibWlzc2lvbkRhdGEuc3VibWlzc2lvblZhbHVlKSA+PSBzZWxlY3RlZFZhbHVlICkgYnJlYWs7ICAKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLy8gdW5leHBlY3RlZCBlcnJvcgogICAgICAgIGlmKCBzdWJtaXNzaW9uSW5kID09IG51bVBlbmRpbmdTdWJtaXNzaW9ucyApIHJldHVybiBbdWludCgweEZGRkZGRkZGRkZGRkZGRkYpLDB4RkZGRkZGRkZGRkZGRkZGRl07CgogICAgICAgIHVpbnQgc2hhcmVJbmRleCA9IHNlZWQyICUgdWludChzdWJtaXNzaW9uRGF0YS5udW1TaGFyZXMpOyAKICAgICAgICAKICAgICAgICByZXR1cm4gW3N1Ym1pc3Npb25JbmQsIHNoYXJlSW5kZXhdOwogICAgfQogICAgCiAgICAvLyBzaG91bGQgYmUgY2FsbGVkIG9ubHkgZnJvbSB2ZXJpZnkgY2xhaW0KICAgIGZ1bmN0aW9uIGNsb3NlU3VibWlzc2lvbiggYWRkcmVzcyBzZW5kZXIgKSBpbnRlcm5hbCB7CiAgICAgICAgU3VibWlzc2lvbk1ldGFEYXRhIG1lbW9yeSBtZXRhRGF0YSA9IHN1Ym1pc3Npb25zTWV0YURhdGFbc2VuZGVyXTsKICAgICAgICBtZXRhRGF0YS5udW1QZW5kaW5nU3VibWlzc2lvbnMgPSAwOwogICAgICAgIG1ldGFEYXRhLnRvdGFsU3VibWlzc2lvblZhbHVlID0gMDsKICAgICAgICBtZXRhRGF0YS5yZWFkeUZvclZlcmlmaWNhdGlvbiA9IDA7CiAgICAgICAgbWV0YURhdGEuc3VibWlzc2lvblNlZWQgPSAwOwogICAgICAgIAogICAgICAgIC8vIGxhc3QgY291bnRlciBtdXN0IG5vdCBiZSByZXNldAogICAgICAgIC8vIGxhc3Qgc3VibWlzc2lvbiBibG9jayBudW1iZXIgYW5kIGRpZmZpY3VsdHkgYXJlIGFsc28ga2VwdCwgYnV0IGl0IGlzIG5vdCBhIG11c3QKICAgICAgICAvLyBvbmx5IHRvIHNhdmUgc29tZSBnYXMgICAgICAgIAogICAgICAgIAogICAgICAgIHN1Ym1pc3Npb25zTWV0YURhdGFbc2VuZGVyXSA9IG1ldGFEYXRhOwogICAgfQogICAgCiAgICBzdHJ1Y3QgU3VibWlzc2lvbkRhdGFGb3JDbGFpbVZlcmlmaWNhdGlvbiB7CiAgICAgICAgdWludCBsYXN0Q291bnRlcjsKICAgICAgICB1aW50IHNoYXJlRGlmZmljdWx0eTsKICAgICAgICB1aW50IHRvdGFsU3VibWlzc2lvblZhbHVlOwogICAgICAgIHVpbnQgbWluOwogICAgICAgIHVpbnQgbWF4OwogICAgICAgIHVpbnQgYXVnTWVya2xlOwogICAgICAgIAogICAgICAgIGJvb2wgaW5kaWNlc0FyZVZhbGlkOwogICAgICAgIGJvb2wgcmVhZHlGb3JWZXJpZmljYXRpb247CiAgICB9CiAgICAKICAgIGZ1bmN0aW9uIGdldENsYWltRGF0YSggYWRkcmVzcyBzZW5kZXIsIHVpbnQgc3VibWlzc2lvbkluZGV4LCB1aW50IHNoYXJlSW5kZXgsIHVpbnQgc2VlZCApCiAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0YW50IGludGVybmFsIHJldHVybnMoU3VibWlzc2lvbkRhdGFGb3JDbGFpbVZlcmlmaWNhdGlvbil7CiAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgIFN1Ym1pc3Npb25EYXRhRm9yQ2xhaW1WZXJpZmljYXRpb24gbWVtb3J5IG91dHB1dDsKCiAgICAgICAgU3VibWlzc2lvbk1ldGFEYXRhIG1lbW9yeSBtZXRhRGF0YSA9IHN1Ym1pc3Npb25zTWV0YURhdGFbc2VuZGVyXTsKICAgICAgICAKICAgICAgICBvdXRwdXQubGFzdENvdW50ZXIgPSB1aW50KG1ldGFEYXRhLmxhc3RDb3VudGVyKTsKICAgICAgICBvdXRwdXQuc2hhcmVEaWZmaWN1bHR5ID0gdWludChtZXRhRGF0YS5kaWZmaWN1bHR5KTsKICAgICAgICBvdXRwdXQudG90YWxTdWJtaXNzaW9uVmFsdWUgPSBtZXRhRGF0YS50b3RhbFN1Ym1pc3Npb25WYWx1ZTsKICAgICAgICAKCiAgICAgICAgU2luZ2xlU3VibWlzc2lvbkRhdGEgbWVtb3J5IHN1Ym1pc3Npb25EYXRhID0gKHN1Ym1pc3Npb25zRGF0YVtzZW5kZXJdKVtzdWJtaXNzaW9uSW5kZXhdOwogICAgICAgIAogICAgICAgIG91dHB1dC5taW4gPSB1aW50KHN1Ym1pc3Npb25EYXRhLm1pbik7CiAgICAgICAgb3V0cHV0Lm1heCA9IHVpbnQoc3VibWlzc2lvbkRhdGEubWF4KTsKICAgICAgICBvdXRwdXQuYXVnTWVya2xlID0gdWludChzdWJtaXNzaW9uRGF0YS5hdWdSb290KTsKICAgICAgICAKICAgICAgICBvdXRwdXQuaW5kaWNlc0FyZVZhbGlkID0gdmVyaWZ5U3VibWlzc2lvbkluZGV4KCBzZW5kZXIsIHNlZWQsIHN1Ym1pc3Npb25JbmRleCwgc2hhcmVJbmRleCApOwogICAgICAgIG91dHB1dC5yZWFkeUZvclZlcmlmaWNhdGlvbiA9IChtZXRhRGF0YS5yZWFkeUZvclZlcmlmaWNhdGlvbiA+IDApOwogICAgICAgIAogICAgICAgIHJldHVybiBvdXRwdXQ7IAogICAgfQogICAgCiAgICBmdW5jdGlvbiBkZWJ1Z0dldE51bVBlbmRpbmdTdWJtaXNzaW9ucyggYWRkcmVzcyBzZW5kZXIgKSBjb25zdGFudCByZXR1cm5zKHVpbnQpIHsKICAgICAgICByZXR1cm4gdWludChzdWJtaXNzaW9uc01ldGFEYXRhW3NlbmRlcl0ubnVtUGVuZGluZ1N1Ym1pc3Npb25zKTsKICAgIH0KICAgIAogICAgZXZlbnQgRGVidWdSZXNldFN1Ym1pc3Npb25zKCBhZGRyZXNzIGluZGV4ZWQgc2VuZGVyLCB1aW50IGVycm9yLCB1aW50IGVycm9ySW5mbyApOwogICAgZnVuY3Rpb24gZGVidWdSZXNldFN1Ym1pc3Npb25zKCApIHsKICAgICAgICAvLyBzaG91bGQgYmUgY2FsbGVkIG9ubHkgaW4gZW1lcmdlbmN5CiAgICAgICAgLy8gbXNnLnNlbmRlciB3aWxsIGxvb3NlIGFsbCBpdHMgcGVuZGluZyBzaGFyZXMKICAgICAgICBjbG9zZVN1Ym1pc3Npb24obXNnLnNlbmRlcik7CiAgICAgICAgRGVidWdSZXNldFN1Ym1pc3Npb25zKCBtc2cuc2VuZGVyLCAwLCAwICk7CiAgICB9ICAgIAp9CgoKY29udHJhY3QgU21hcnRQb29sIGlzIEFndCwgV2VpZ2h0ZWRTdWJtaXNzaW9uIHsgICAgCiAgICBzdHJpbmcgIHB1YmxpYyB2ZXJzaW9uID0gIjAuMS4xIjsKICAgIAogICAgRXRoYXNoICBwdWJsaWMgZXRoYXNoQ29udHJhY3Q7IAogICAgYWRkcmVzcyBwdWJsaWMgd2l0aGRyYXdhbEFkZHJlc3M7CiAgICBtYXBwaW5nKGFkZHJlc3M9PmJvb2wpIHB1YmxpYyBvd25lcnM7IAogICAgCiAgICBib29sIHB1YmxpYyBuZXdWZXJzaW9uUmVsZWFzZWQgPSBmYWxzZTsKICAgICAgICAKICAgIHN0cnVjdCBNaW5lckRhdGEgewogICAgICAgIGJ5dGVzMzIgICAgICAgIG1pbmVySWQ7CiAgICAgICAgYWRkcmVzcyAgICAgICAgcGF5bWVudEFkZHJlc3M7CiAgICB9CgogICAgbWFwcGluZyhhZGRyZXNzPT5NaW5lckRhdGEpIG1pbmVyc0RhdGE7CiAgICBtYXBwaW5nKGJ5dGVzMzI9PmJvb2wpICAgICAgcHVibGljIGV4aXN0aW5nSWRzOyAgICAgICAgCiAgICAKICAgIGJvb2wgcHVibGljIHdoaXRlTGlzdEVuYWJsZWQ7CiAgICBib29sIHB1YmxpYyBibGFja0xpc3RFbmFibGVkOwogICAgbWFwcGluZyhhZGRyZXNzPT5ib29sKSB3aGl0ZUxpc3Q7CiAgICBtYXBwaW5nKGFkZHJlc3M9PmJvb2wpIGJsYWNrTGlzdDsgICAgCiAgICAKICAgIGZ1bmN0aW9uIFNtYXJ0UG9vbCggYWRkcmVzc1tdIF9vd25lcnMsCiAgICAgICAgICAgICAgICAgICAgICAgIEV0aGFzaCBfZXRoYXNoQ29udHJhY3QsCiAgICAgICAgICAgICAgICAgICAgICAgIGFkZHJlc3MgX3dpdGhkcmF3YWxBZGRyZXNzLAogICAgICAgICAgICAgICAgICAgICAgICBib29sIF93aGl0ZUxpc3RFbmFiZWxlZCwKICAgICAgICAgICAgICAgICAgICAgICAgYm9vbCBfYmxhY2tMaXN0RW5hYmxlZCApIHBheWFibGUgewogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICBmb3IoIHVpbnQgaSA9IDAgOyBpIDwgX293bmVycy5sZW5ndGggOyBpKysgKSB7CiAgICAgICAgICAgIG93bmVyc1tfb3duZXJzWzBdXSA9IHRydWU7IAogICAgICAgICAgICBvd25lcnNbX293bmVyc1sxXV0gPSB0cnVlOwogICAgICAgICAgICBvd25lcnNbX293bmVyc1syXV0gPSB0cnVlOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBldGhhc2hDb250cmFjdCA9IF9ldGhhc2hDb250cmFjdDsKICAgICAgICB3aXRoZHJhd2FsQWRkcmVzcyA9IF93aXRoZHJhd2FsQWRkcmVzczsKICAgICAgICAKICAgICAgICB3aGl0ZUxpc3RFbmFibGVkID0gX3doaXRlTGlzdEVuYWJlbGVkOwogICAgICAgIGJsYWNrTGlzdEVuYWJsZWQgPSBfYmxhY2tMaXN0RW5hYmxlZDsgICAgICAgICAgICAgICAKICAgIH0KICAgIAogICAgZnVuY3Rpb24gZGVjbGFyZU5ld2VyVmVyc2lvbigpIHsKICAgICAgICBpZiggISBvd25lcnNbbXNnLnNlbmRlcl0gKSB0aHJvdzsKICAgICAgICAKICAgICAgICBuZXdWZXJzaW9uUmVsZWFzZWQgPSB0cnVlOwogICAgICAgIAogICAgICAgIC8vaWYoICEgbXNnLnNlbmRlci5zZW5kKHRoaXMuYmFsYW5jZSkgKSB0aHJvdzsKICAgIH0KICAgIAogICAgZXZlbnQgV2l0aGRyYXcoIGFkZHJlc3MgaW5kZXhlZCBzZW5kZXIsIHVpbnQgZXJyb3IsIHVpbnQgZXJyb3JJbmZvICk7CiAgICBmdW5jdGlvbiB3aXRoZHJhdyggdWludCBhbW91bnQgKSB7CiAgICAgICAgaWYoICEgb3duZXJzW21zZy5zZW5kZXJdICkgewogICAgICAgICAgICAvLyBvbmx5IG93bmRlciBjYW4gd2l0aGRyYXcKICAgICAgICAgICAgV2l0aGRyYXcoIG1zZy5zZW5kZXIsIDB4ODAwMDAwMDAsIGFtb3VudCApOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGlmKCAhIHdpdGhkcmF3YWxBZGRyZXNzLnNlbmQoIGFtb3VudCApICkgdGhyb3c7CiAgICAgICAgCiAgICAgICAgV2l0aGRyYXcoIG1zZy5zZW5kZXIsIDAsIGFtb3VudCApOyAgICAgICAgICAgIAogICAgfQogICAgCiAgICBmdW5jdGlvbiB0bzYyRW5jb2RpbmcoIHVpbnQgaWQsIHVpbnQgbnVtQ2hhcnMgKSBjb25zdGFudCByZXR1cm5zKGJ5dGVzMzIpIHsKICAgICAgICBpZiggaWQgPj0gKDI2KzI2KzEwKSoqbnVtQ2hhcnMgKSB0aHJvdzsKICAgICAgICB1aW50IHJlc3VsdCA9IDA7CiAgICAgICAgZm9yKCB1aW50IGkgPSAwIDsgaSA8IG51bUNoYXJzIDsgaSsrICkgewogICAgICAgICAgICB1aW50IGIgPSBpZCAlICgyNisyNisxMCk7CiAgICAgICAgICAgIHVpbnQ4IGNoYXI7CiAgICAgICAgICAgIGlmKCBiIDwgMTAgKSB7CiAgICAgICAgICAgICAgICBjaGFyID0gdWludDgoYiArIDB4MzApOyAvLyAweDMwID0gJzAnIAogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYoIGIgPCAyNiArIDEwICkgewogICAgICAgICAgICAgICAgY2hhciA9IHVpbnQ4KGIgKyAweDYxIC0gMTApOyAvLzB4NjEgPSAnYScKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIGNoYXIgPSB1aW50OChiICsgMHg0MSAtIDI2IC0gMTApOyAvLyAweDQxID0gJ0EnICAgICAgICAgCiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIHJlc3VsdCA9IChyZXN1bHQgKiAyNTYpICsgY2hhcjsKICAgICAgICAgICAgaWQgLz0gKDI2KzI2KzEwKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBieXRlczMyKHJlc3VsdCk7CiAgICB9CiAgICAgICAgCiAgICBldmVudCBSZWdpc3RlciggYWRkcmVzcyBpbmRleGVkIHNlbmRlciwgdWludCBlcnJvciwgdWludCBlcnJvckluZm8gKTsgICAgCiAgICBmdW5jdGlvbiByZWdpc3RlciggYWRkcmVzcyBwYXltZW50QWRkcmVzcyApIHsKICAgICAgICBhZGRyZXNzIG1pbmVyQWRkcmVzcyA9IG1zZy5zZW5kZXI7CiAgICAgICAgCiAgICAgICAgLy8gYnVpbGQgaWQKICAgICAgICB1aW50IGlkID0gdWludChtaW5lckFkZHJlc3MpICUgKDI2KzI2KzEwKSoqMTE7ICAgICAgICAKICAgICAgICBieXRlczMyIG1pbmVySWQgPSB0bzYyRW5jb2RpbmcoaWQsMTEpOwogICAgICAgIAogICAgICAgIGlmKCBleGlzdGluZ0lkc1ttaW5lcnNEYXRhW21pbmVyQWRkcmVzc10ubWluZXJJZF0gKSB7CiAgICAgICAgICAgIC8vIG1pbmVyIGlkIGlzIGFscmVhZHkgaW4gdXNlCiAgICAgICAgICAgIFJlZ2lzdGVyKCBtc2cuc2VuZGVyLCAweDgwMDAwMDAwLCB1aW50KG1pbmVySWQpICk7IAogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGlmKCBwYXltZW50QWRkcmVzcyA9PSBhZGRyZXNzKDApICkgewogICAgICAgICAgICAvLyBwYXltZW50IGFkZHJlc3MgaXMgMAogICAgICAgICAgICBSZWdpc3RlciggbXNnLnNlbmRlciwgMHg4MDAwMDAwMSwgdWludChwYXltZW50QWRkcmVzcykgKTsgCiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgaWYoIHdoaXRlTGlzdEVuYWJsZWQgKSB7CiAgICAgICAgICAgIGlmKCAhIHdoaXRlTGlzdFsgbXNnLnNlbmRlciBdICkgewogICAgICAgICAgICAgICAgLy8gbWluZXIgbm90IGluIHdoaXRlIGxpc3QKICAgICAgICAgICAgICAgIFJlZ2lzdGVyKCBtc2cuc2VuZGVyLCAweDgwMDAwMDAyLCB1aW50KG1pbmVySWQpICk7CiAgICAgICAgICAgICAgICByZXR1cm47ICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAKICAgICAgICBpZiggYmxhY2tMaXN0RW5hYmxlZCApIHsKICAgICAgICAgICAgaWYoIGJsYWNrTGlzdFsgbXNnLnNlbmRlciBdICkgewogICAgICAgICAgICAgICAgLy8gbWluZXIgb24gYmxhY2sgbGlzdAogICAgICAgICAgICAgICAgUmVnaXN0ZXIoIG1zZy5zZW5kZXIsIDB4ODAwMDAwMDMsIHVpbnQobWluZXJJZCkgKTsKICAgICAgICAgICAgICAgIHJldHVybjsgICAgICAgICAgICAgICAgIAogICAgICAgICAgICB9ICAgICAgICAKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgCiAgICAgICAgCiAgICAgICAgLy8gbGFzdCBjb3VudGVyIGlzIHNldCB0byAwLiAKICAgICAgICAvLyBJdCBtaWdodCBiZSBzYWZlciB0byBjaGFuZ2UgaXQgdG8gbm93LgogICAgICAgIC8vbWluZXJzRGF0YVttaW5lckFkZHJlc3NdLmxhc3RDb3VudGVyID0gbm93ICogKDIqKjY0KTsKICAgICAgICBtaW5lcnNEYXRhW21pbmVyQWRkcmVzc10ucGF5bWVudEFkZHJlc3MgPSBwYXltZW50QWRkcmVzczsgICAgICAgIAogICAgICAgIG1pbmVyc0RhdGFbbWluZXJBZGRyZXNzXS5taW5lcklkID0gbWluZXJJZDsKICAgICAgICBleGlzdGluZ0lkc1ttaW5lcnNEYXRhW21pbmVyQWRkcmVzc10ubWluZXJJZF0gPSB0cnVlOwogICAgICAgIAogICAgICAgIC8vIHN1Y2Nlc2Z1bCByZWdpc3RyYXRpb24KICAgICAgICBSZWdpc3RlciggbXNnLnNlbmRlciwgMCwgMCApOyAKICAgIH0KCiAgICBmdW5jdGlvbiBjYW5SZWdpc3RlcihhZGRyZXNzIHNlbmRlcikgY29uc3RhbnQgcmV0dXJucyhib29sKSB7CiAgICAgICAgdWludCBpZCA9IHVpbnQoc2VuZGVyKSAlICgyNisyNisxMCkqKjExOwogICAgICAgIGJ5dGVzMzIgZXhwZWN0ZWRJZCA9IHRvNjJFbmNvZGluZyhpZCwxMSk7CiAgICAgICAgCiAgICAgICAgaWYoIHdoaXRlTGlzdEVuYWJsZWQgKSB7CiAgICAgICAgICAgIGlmKCAhIHdoaXRlTGlzdFsgc2VuZGVyIF0gKSByZXR1cm4gZmFsc2U7IAogICAgICAgIH0KICAgICAgICBpZiggYmxhY2tMaXN0RW5hYmxlZCApIHsKICAgICAgICAgICAgaWYoIGJsYWNrTGlzdFsgc2VuZGVyIF0gKSByZXR1cm4gZmFsc2U7ICAgICAgICAKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgcmV0dXJuICEgZXhpc3RpbmdJZHNbZXhwZWN0ZWRJZF07CiAgICB9CiAgICAKICAgIGZ1bmN0aW9uIGlzUmVnaXN0ZXJlZChhZGRyZXNzIHNlbmRlcikgY29uc3RhbnQgcmV0dXJucyhib29sKSB7CiAgICAgICAgcmV0dXJuIG1pbmVyc0RhdGFbc2VuZGVyXS5wYXltZW50QWRkcmVzcyAhPSBhZGRyZXNzKDApOwogICAgfQogICAgCiAgICBmdW5jdGlvbiBnZXRNaW5lcklkKGFkZHJlc3Mgc2VuZGVyKSBjb25zdGFudCByZXR1cm5zKGJ5dGVzMzIpIHsKICAgICAgICByZXR1cm4gbWluZXJzRGF0YVtzZW5kZXJdLm1pbmVySWQ7CiAgICB9CgogICAgZXZlbnQgVXBkYXRlV2hpdGVMaXN0KCBhZGRyZXNzIGluZGV4ZWQgbWluZXIsIHVpbnQgZXJyb3IsIHVpbnQgZXJyb3JJbmZvLCBib29sIGFkZCApOwogICAgZXZlbnQgVXBkYXRlQmxhY2tMaXN0KCBhZGRyZXNzIGluZGV4ZWQgbWluZXIsIHVpbnQgZXJyb3IsIHVpbnQgZXJyb3JJbmZvLCBib29sIGFkZCApOyAgICAKCiAgICBmdW5jdGlvbiB1blJlZ2lzdGVyKCBhZGRyZXNzIG1pbmVyICkgaW50ZXJuYWwgewogICAgICAgIG1pbmVyc0RhdGFbbWluZXJdLnBheW1lbnRBZGRyZXNzID0gYWRkcmVzcygwKTsKICAgICAgICBleGlzdGluZ0lkc1ttaW5lcnNEYXRhW21pbmVyXS5taW5lcklkXSA9IGZhbHNlOyAgICAgICAgICAgIAogICAgfQogICAgCiAgICBmdW5jdGlvbiB1cGRhdGVXaGl0ZUxpc3QoIGFkZHJlc3MgbWluZXIsIGJvb2wgYWRkICkgewogICAgICAgIGlmKCAhIG93bmVyc1sgbXNnLnNlbmRlciBdICkgewogICAgICAgICAgICAvLyBvbmx5IG93bmVyIGNhbiB1cGRhdGUgbGlzdAogICAgICAgICAgICBVcGRhdGVXaGl0ZUxpc3QoIG1zZy5zZW5kZXIsIDB4ODAwMDAwMDAsIDAsIGFkZCApOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmKCAhIHdoaXRlTGlzdEVuYWJsZWQgKSB7CiAgICAgICAgICAgIC8vIHdoaXRlIGxpc3QgaXMgbm90IGVuYWJlbGVkCiAgICAgICAgICAgIFVwZGF0ZVdoaXRlTGlzdCggbXNnLnNlbmRlciwgMHg4MDAwMDAwMSwgMCwgYWRkICk7ICAgICAgICAKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICAKICAgICAgICB3aGl0ZUxpc3RbIG1pbmVyIF0gPSBhZGQ7CiAgICAgICAgaWYoICEgYWRkICYmIGlzUmVnaXN0ZXJlZCggbWluZXIgKSApIHsKICAgICAgICAgICAgLy8gdW5yZWdpc3RlcgogICAgICAgICAgICB1blJlZ2lzdGVyKCBtaW5lciApOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBVcGRhdGVXaGl0ZUxpc3QoIG1zZy5zZW5kZXIsIDAsIHVpbnQobWluZXIpLCBhZGQgKTsKICAgIH0KCiAgICBmdW5jdGlvbiB1cGRhdGVCbGFja0xpc3QoIGFkZHJlc3MgbWluZXIsIGJvb2wgYWRkICkgewogICAgICAgIGlmKCAhIG93bmVyc1sgbXNnLnNlbmRlciBdICkgewogICAgICAgICAgICAvLyBvbmx5IG93bmVyIGNhbiB1cGRhdGUgbGlzdAogICAgICAgICAgICBVcGRhdGVCbGFja0xpc3QoIG1zZy5zZW5kZXIsIDB4ODAwMDAwMDAsIDAsIGFkZCApOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmKCAhIGJsYWNrTGlzdEVuYWJsZWQgKSB7CiAgICAgICAgICAgIC8vIHdoaXRlIGxpc3QgaXMgbm90IGVuYWJlbGVkCiAgICAgICAgICAgIFVwZGF0ZUJsYWNrTGlzdCggbXNnLnNlbmRlciwgMHg4MDAwMDAwMSwgMCwgYWRkICk7ICAgICAgICAKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBibGFja0xpc3RbIG1pbmVyIF0gPSBhZGQ7CiAgICAgICAgaWYoIGFkZCAmJiBpc1JlZ2lzdGVyZWQoIG1pbmVyICkgKSB7CiAgICAgICAgICAgIC8vIHVucmVnaXN0ZXIKICAgICAgICAgICAgdW5SZWdpc3RlciggbWluZXIgKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgVXBkYXRlQmxhY2tMaXN0KCBtc2cuc2VuZGVyLCAwLCB1aW50KG1pbmVyKSwgYWRkICk7CiAgICB9CiAgICAKICAgIGV2ZW50IERpc2FibGVCbGFja0xpc3RGb3JldmVyKCBhZGRyZXNzIGluZGV4ZWQgc2VuZGVyLCB1aW50IGVycm9yLCB1aW50IGVycm9ySW5mbyApOyAgICAKICAgIGZ1bmN0aW9uIGRpc2FibGVCbGFja0xpc3RGb3JldmVyKCkgewogICAgICAgIGlmKCAhIG93bmVyc1sgbXNnLnNlbmRlciBdICkgewogICAgICAgICAgICAvLyBvbmx5IG93bmVyIGNhbiB1cGRhdGUgbGlzdAogICAgICAgICAgICBEaXNhYmxlQmxhY2tMaXN0Rm9yZXZlciggbXNnLnNlbmRlciwgMHg4MDAwMDAwMCwgMCApOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGJsYWNrTGlzdEVuYWJsZWQgPSBmYWxzZTsKICAgICAgICAKICAgICAgICBEaXNhYmxlQmxhY2tMaXN0Rm9yZXZlciggbXNnLnNlbmRlciwgMCwgMCApOyAgICAgICAgCiAgICB9CgogICAgZXZlbnQgRGlzYWJsZVdoaXRlTGlzdEZvcmV2ZXIoIGFkZHJlc3MgaW5kZXhlZCBzZW5kZXIsIHVpbnQgZXJyb3IsIHVpbnQgZXJyb3JJbmZvICk7CiAgICBmdW5jdGlvbiBkaXNhYmxlV2hpdGVMaXN0Rm9yZXZlcigpIHsKICAgICAgICBpZiggISBvd25lcnNbIG1zZy5zZW5kZXIgXSApIHsKICAgICAgICAgICAgLy8gb25seSBvd25lciBjYW4gdXBkYXRlIGxpc3QKICAgICAgICAgICAgRGlzYWJsZVdoaXRlTGlzdEZvcmV2ZXIoIG1zZy5zZW5kZXIsIDB4ODAwMDAwMDAsIDAgKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICAKICAgICAgICB3aGl0ZUxpc3RFbmFibGVkID0gZmFsc2U7CiAgICAgICAgCiAgICAgICAgRGlzYWJsZVdoaXRlTGlzdEZvcmV2ZXIoIG1zZy5zZW5kZXIsIDAsIDAgKTsgICAgICAgICAgICAKICAgIH0KICAgIAogICAgZXZlbnQgVmVyaWZ5RXh0cmFEYXRhKCBhZGRyZXNzIGluZGV4ZWQgc2VuZGVyLCB1aW50IGVycm9yLCB1aW50IGVycm9ySW5mbyApOyAgICAKICAgIGZ1bmN0aW9uIHZlcmlmeUV4dHJhRGF0YSggYnl0ZXMzMiBleHRyYURhdGEsIGJ5dGVzMzIgbWluZXJJZCwgdWludCBkaWZmaWN1bHR5ICkgY29uc3RhbnQgaW50ZXJuYWwgcmV0dXJucyhib29sKSB7CiAgICAgICAgdWludCBpOwogICAgICAgIC8vIGNvbXBhcmUgaWQKICAgICAgICBmb3IoIGkgPSAwIDsgaSA8IDExIDsgaSsrICkgewogICAgICAgICAgICBpZiggZXh0cmFEYXRhWzEwK2ldICE9IG1pbmVySWRbMjEraV0gKSB7CiAgICAgICAgICAgICAgICAvL0Vycm9yTG9nKCAidmVyaWZ5RXh0cmFEYXRhOiBtaW5lciBpZCBub3QgYXMgZXhwZWN0ZWQiLCAwICk7CiAgICAgICAgICAgICAgICBWZXJpZnlFeHRyYURhdGEoIG1zZy5zZW5kZXIsIDB4ODMwMDAwMDAsIHVpbnQobWluZXJJZCkgKTsgICAgICAgICAKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsgICAgICAgICAgICAKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAKICAgICAgICAvLyBjb21wYXJlIGRpZmZpY3VsdHkKICAgICAgICBieXRlczMyIGVuY29kZWREaWZmID0gdG82MkVuY29kaW5nKGRpZmZpY3VsdHksMTEpOwogICAgICAgIGZvciggaSA9IDAgOyBpIDwgMTEgOyBpKysgKSB7CiAgICAgICAgICAgIGlmKGV4dHJhRGF0YVtpKzIxXSAhPSBlbmNvZGVkRGlmZlsyMStpXSkgewogICAgICAgICAgICAgICAgLy9FcnJvckxvZyggInZlcmlmeUV4dHJhRGF0YTogZGlmZmljdWx0eSBpcyBub3QgYXMgZXhwZWN0ZWQiLCB1aW50KGVuY29kZWREaWZmKSApOwogICAgICAgICAgICAgICAgVmVyaWZ5RXh0cmFEYXRhKCBtc2cuc2VuZGVyLCAweDgzMDAwMDAxLCB1aW50KGVuY29kZWREaWZmKSApOwogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOyAgICAgICAgICAgIAogICAgICAgICAgICB9ICAKICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICByZXR1cm4gdHJ1ZTsgICAgICAgICAgICAKICAgIH0gICAgCiAgICAKICAgIGV2ZW50IFZlcmlmeUNsYWltKCBhZGRyZXNzIGluZGV4ZWQgc2VuZGVyLCB1aW50IGVycm9yLCB1aW50IGVycm9ySW5mbyApOwogICAgCiAgICAgICAgCiAgICBmdW5jdGlvbiB2ZXJpZnlDbGFpbSggYnl0ZXMgcmxwSGVhZGVyLAogICAgICAgICAgICAgICAgICAgICAgICAgIHVpbnQgIG5vbmNlLAogICAgICAgICAgICAgICAgICAgICAgICAgIHVpbnQgIHN1Ym1pc3Npb25JbmRleCwKICAgICAgICAgICAgICAgICAgICAgICAgICB1aW50ICBzaGFyZUluZGV4LAogICAgICAgICAgICAgICAgICAgICAgICAgIHVpbnRbXSBkYXRhU2V0TG9va3VwLAogICAgICAgICAgICAgICAgICAgICAgICAgIHVpbnRbXSB3aXRuZXNzRm9yTG9va3VwLAogICAgICAgICAgICAgICAgICAgICAgICAgIHVpbnRbXSBhdWdDb3VudGVyc0JyYW5jaCwKICAgICAgICAgICAgICAgICAgICAgICAgICB1aW50W10gYXVnSGFzaGVzQnJhbmNoICkgewoKICAgICAgICBpZiggISBpc1JlZ2lzdGVyZWQobXNnLnNlbmRlcikgKSB7CiAgICAgICAgICAgIC8vIG1pbmVyIGlzIG5vdCByZWdpc3RlcmVkCiAgICAgICAgICAgIFZlcmlmeUNsYWltKCBtc2cuc2VuZGVyLCAweDg0MDAwMDBjLCAwICk7CiAgICAgICAgICAgIHJldHVybjsgICAgICAgICAKICAgICAgICB9CgogICAgICAgIFN1Ym1pc3Npb25EYXRhRm9yQ2xhaW1WZXJpZmljYXRpb24gbWVtb3J5IHN1Ym1pc3Npb25EYXRhID0gZ2V0Q2xhaW1EYXRhKCBtc2cuc2VuZGVyLAogICAgICAgICAgICBzdWJtaXNzaW9uSW5kZXgsIHNoYXJlSW5kZXgsIGdldENsYWltU2VlZCggbXNnLnNlbmRlciApICk7IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICBpZiggISBzdWJtaXNzaW9uRGF0YS5yZWFkeUZvclZlcmlmaWNhdGlvbiApIHsKICAgICAgICAgICAgLy9FcnJvckxvZyggInRoZXJlIGFyZSBubyBwZW5kaW5nIGNsYWltcyIsIDAgKTsKICAgICAgICAgICAgVmVyaWZ5Q2xhaW0oIG1zZy5zZW5kZXIsIDB4ODQwMDAwMDMsIDAgKTsgICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBCbG9ja0hlYWRlciBtZW1vcnkgaGVhZGVyID0gcGFyc2VCbG9ja0hlYWRlcihybHBIZWFkZXIpOwoKICAgICAgICAvLyBjaGVjayBleHRyYSBkYXRhCiAgICAgICAgaWYoICEgdmVyaWZ5RXh0cmFEYXRhKCBoZWFkZXIuZXh0cmFEYXRhLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWluZXJzRGF0YVsgbXNnLnNlbmRlciBdLm1pbmVySWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdWJtaXNzaW9uRGF0YS5zaGFyZURpZmZpY3VsdHkgKSApIHsKICAgICAgICAgICAgLy9FcnJvckxvZyggImV4dHJhIGRhdGEgbm90IGFzIGV4cGVjdGVkIiwgdWludChoZWFkZXIuZXh0cmFEYXRhKSApOwogICAgICAgICAgICBWZXJpZnlDbGFpbSggbXNnLnNlbmRlciwgMHg4NDAwMDAwNCwgdWludChoZWFkZXIuZXh0cmFEYXRhKSApOyAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm47ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgIH0KICAgICAgICAKICAgICAgICAvLyBjaGVjayBjb2luYmFzZSBkYXRhCiAgICAgICAgaWYoIGhlYWRlci5jb2luYmFzZSAhPSB1aW50KHRoaXMpICkgewogICAgICAgICAgICAvL0Vycm9yTG9nKCAiY29pbmJhc2Ugbm90IGFzIGV4cGVjdGVkIiwgdWludChoZWFkZXIuY29pbmJhc2UpICk7CiAgICAgICAgICAgIFZlcmlmeUNsYWltKCBtc2cuc2VuZGVyLCAweDg0MDAwMDA1LCB1aW50KGhlYWRlci5jb2luYmFzZSkgKTsgICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICAgCiAgICAgICAgCiAgICAgICAgLy8gY2hlY2sgY291bnRlcgogICAgICAgIHVpbnQgY291bnRlciA9IGhlYWRlci50aW1lc3RhbXAgKiAoMiAqKiA2NCkgKyBub25jZTsKICAgICAgICBpZiggY291bnRlciA8IHN1Ym1pc3Npb25EYXRhLm1pbiApIHsKICAgICAgICAgICAgLy9FcnJvckxvZyggImNvdW50ZXIgaXMgc21hbGxlciB0aGFuIG1pbiIsY291bnRlcik7CiAgICAgICAgICAgIFZlcmlmeUNsYWltKCBtc2cuc2VuZGVyLCAweDg0MDAwMDA3LCBjb3VudGVyICk7ICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybjsgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgfQogICAgICAgIGlmKCBjb3VudGVyID4gc3VibWlzc2lvbkRhdGEubWF4ICkgewogICAgICAgICAgICAvL0Vycm9yTG9nKCAiY291bnRlciBpcyBzbWFsbGVyIHRoYW4gbWF4Iixjb3VudGVyKTsKICAgICAgICAgICAgVmVyaWZ5Q2xhaW0oIG1zZy5zZW5kZXIsIDB4ODQwMDAwMDgsIGNvdW50ZXIgKTsgICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuOyAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLy8gdmVyaWZ5IGFndAogICAgICAgIHVpbnQgbGVhZkhhc2ggPSB1aW50KHNoYTMocmxwSGVhZGVyKSk7CiAgICAgICAgVmVyaWZ5QWd0RGF0YSBtZW1vcnkgYWd0RGF0YTsKICAgICAgICBhZ3REYXRhLnJvb3RIYXNoID0gc3VibWlzc2lvbkRhdGEuYXVnTWVya2xlOwogICAgICAgIGFndERhdGEucm9vdE1pbiA9IHN1Ym1pc3Npb25EYXRhLm1pbjsKICAgICAgICBhZ3REYXRhLnJvb3RNYXggPSBzdWJtaXNzaW9uRGF0YS5tYXg7CiAgICAgICAgYWd0RGF0YS5sZWFmSGFzaCA9IGxlYWZIYXNoOwogICAgICAgIGFndERhdGEubGVhZkNvdW50ZXIgPSBjb3VudGVyOwogICAgICAgICAgICAgICAgCgogICAgICAgIGlmKCAhIHZlcmlmeUFndCggYWd0RGF0YSwKICAgICAgICAgICAgICAgICAgICAgICAgIHNoYXJlSW5kZXgsCiAgICAgICAgICAgICAgICAgICAgICAgICBhdWdDb3VudGVyc0JyYW5jaCwKICAgICAgICAgICAgICAgICAgICAgICAgIGF1Z0hhc2hlc0JyYW5jaCApICkgewogICAgICAgICAgICAvL0Vycm9yTG9nKCAidmVyaWZ5QWd0IGZhaWxlZCIsMCk7CiAgICAgICAgICAgIFZlcmlmeUNsYWltKCBtc2cuc2VuZGVyLCAweDg0MDAwMDA5LCAwICk7ICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgCiAgICAgICAgLyoKICAgICAgICAvLyBjaGVjayBlcG9jaCBkYXRhIC0gZG9uZSBpbnNpZGUgaGFzaGltb3RvCiAgICAgICAgaWYoICEgZXRoYXNoQ29udHJhY3QuaXNFcG9jaERhdGFTZXQoIGhlYWRlci5ibG9ja051bWJlciAvIDMwMDAwICkgKSB7CiAgICAgICAgICAgIC8vRXJyb3JMb2coICJlcG9jaCBkYXRhIHdhcyBub3Qgc2V0IixoZWFkZXIuYmxvY2tOdW1iZXIgLyAzMDAwMCk7CiAgICAgICAgICAgIFZlcmlmeUNsYWltKCBtc2cuc2VuZGVyLCAweDg0MDAwMDBhLCBoZWFkZXIuYmxvY2tOdW1iZXIgLyAzMDAwMCApOyAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm47ICAgICAgICAKICAgICAgICB9Ki8KCgogICAgICAgIC8vIHZlcmlmeSBldGhhc2gKICAgICAgICB1aW50IGV0aGFzaCA9IGV0aGFzaENvbnRyYWN0Lmhhc2hpbW90byggYnl0ZXMzMihsZWFmSGFzaCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJ5dGVzOChub25jZSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFTZXRMb29rdXAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpdG5lc3NGb3JMb29rdXAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhlYWRlci5ibG9ja051bWJlciAvIDMwMDAwICk7CiAgICAgICAgaWYoIGV0aGFzaCA+ICgoMioqMjU2LTEpL3N1Ym1pc3Npb25EYXRhLnNoYXJlRGlmZmljdWx0eSApKSB7CiAgICAgICAgICAgIGlmKCBldGhhc2ggPT0gMHhGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZFICkgewogICAgICAgICAgICAgICAgLy9FcnJvckxvZyggImVwb2NoIGRhdGEgd2FzIG5vdCBzZXQiLGhlYWRlci5ibG9ja051bWJlciAvIDMwMDAwKTsKICAgICAgICAgICAgICAgIFZlcmlmeUNsYWltKCBtc2cuc2VuZGVyLCAweDg0MDAwMDBhLCBoZWFkZXIuYmxvY2tOdW1iZXIgLyAzMDAwMCApOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIC8vRXJyb3JMb2coICJldGhhc2ggZGlmZmljdWx0eSB0b28gbG93IixldGhhc2gpOwogICAgICAgICAgICAgICAgVmVyaWZ5Q2xhaW0oIG1zZy5zZW5kZXIsIDB4ODQwMDAwMGIsIGV0aGFzaCApOwogICAgICAgICAgICB9ICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybjsgICAgICAgIAogICAgICAgIH0KICAgICAgICAKICAgICAgICBpZiggZ2V0Q2xhaW1TZWVkKG1zZy5zZW5kZXIpID09IDAgKSB7CiAgICAgICAgICAgIC8vRXJyb3JMb2coICJjbGFpbSBzZWVkIGlzIDAiLCAwICk7CiAgICAgICAgICAgIFZlcmlmeUNsYWltKCBtc2cuc2VuZGVyLCAweDg0MDAwMDAxLCAwICk7CiAgICAgICAgICAgIHJldHVybjsgICAgICAgIAogICAgICAgIH0KICAgICAgICAKICAgICAgICBpZiggISBzdWJtaXNzaW9uRGF0YS5pbmRpY2VzQXJlVmFsaWQgKSB7CiAgICAgICAgICAgIC8vRXJyb3JMb2coICJzaGFyZSBpbmRleCBvciBzdWJtaXNzaW9uIGFyZSBub3QgYXMgZXhwZWN0ZWQuIHNob3VsZCBiZToiLCBnZXRTaGFyZUluZGV4KCkgKTsKICAgICAgICAgICAgVmVyaWZ5Q2xhaW0oIG1zZy5zZW5kZXIsIDB4ODQwMDAwMDIsIDAgKTsKICAgICAgICAgICAgcmV0dXJuOyAgICAgICAgICAgICAgICAKICAgICAgICB9IAogICAgICAgIAogICAgICAgIC8vIHJlY3J1c2l2ZSBhdHRhY2sgaXMgbm90IHBvc3NpYmxlIGFzIGRvUGF5bWVudCBpcyB1c2luZyBzZW5kIGFuZCBub3QgY2FsbC4KICAgICAgICBpZiggISBkb1BheW1lbnQoc3VibWlzc2lvbkRhdGEudG90YWxTdWJtaXNzaW9uVmFsdWUsCiAgICAgICAgICAgICAgICAgICAgICAgIG1pbmVyc0RhdGFbIG1zZy5zZW5kZXIgXS5wYXltZW50QWRkcmVzcykgKSB7CiAgICAgICAgICAgIC8vIGVycm9yIG1zZyBpcyBnaXZlbiBpbiBkb1BheW1lbnQgZnVuY3Rpb24KICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBjbG9zZVN1Ym1pc3Npb24oIG1zZy5zZW5kZXIgKTsKICAgICAgICAvL21pbmVyc0RhdGFbIG1zZy5zZW5kZXIgXS5wZW5kaW5nQ2xhaW0gPSBmYWxzZTsKICAgICAgICAKICAgICAgICAKICAgICAgICBWZXJpZnlDbGFpbSggbXNnLnNlbmRlciwgMCwgMCApOyAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgIAogICAgICAgIAogICAgICAgIHJldHVybjsKICAgIH0gICAgCiAgICAKCiAgICAvLyAxMDAwMCA9IDEwMCUKICAgIHVpbnQgcHVibGljIHVuY2xlUmF0ZSA9IDUwMDsgLy8gNSUKICAgIC8vIDEwMDAwID0gMTAwJQogICAgdWludCBwdWJsaWMgcG9vbEZlZXMgPSAwOwoKCiAgICBldmVudCBJbmNvbWluZ0Z1bmRzKCBhZGRyZXNzIHNlbmRlciwgdWludCBhbW91bnRJbldlaSApOwogICAgZnVuY3Rpb24oKSBwYXlhYmxlIHsKICAgICAgICBJbmNvbWluZ0Z1bmRzKCBtc2cuc2VuZGVyLCBtc2cudmFsdWUgKTsKICAgIH0KCiAgICBldmVudCBTZXRVbmxjZVJhdGVBbmRGZWVzKCBhZGRyZXNzIGluZGV4ZWQgc2VuZGVyLCB1aW50IGVycm9yLCB1aW50IGVycm9ySW5mbyApOwogICAgZnVuY3Rpb24gc2V0VW5sY2VSYXRlQW5kRmVlcyggdWludCBfdW5jbGVSYXRlLCB1aW50IF9wb29sRmVlcyApIHsKICAgICAgICBpZiggISBvd25lcnNbbXNnLnNlbmRlcl0gKSB7CiAgICAgICAgICAgIC8vIG9ubHkgb3duZXIgc2hvdWxkIGNoYW5nZSByYXRlcwogICAgICAgICAgICBTZXRVbmxjZVJhdGVBbmRGZWVzKCBtc2cuc2VuZGVyLCAweDgwMDAwMDAwLCAwICk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgdW5jbGVSYXRlID0gX3VuY2xlUmF0ZTsKICAgICAgICBwb29sRmVlcyA9IF9wb29sRmVlczsKICAgICAgICAKICAgICAgICBTZXRVbmxjZVJhdGVBbmRGZWVzKCBtc2cuc2VuZGVyLCAwLCAwICk7CiAgICB9CiAgICAgICAgCiAgICBldmVudCBEb1BheW1lbnQoIGFkZHJlc3MgaW5kZXhlZCBzZW5kZXIsIGFkZHJlc3MgcGF5bWVudEFkZHJlc3MsIHVpbnQgdmFsdWVJbldlaSApOwogICAgZnVuY3Rpb24gZG9QYXltZW50KCB1aW50IHN1Ym1pc3Npb25WYWx1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgYWRkcmVzcyBwYXltZW50QWRkcmVzcyApIGludGVybmFsIHJldHVybnMoYm9vbCkgewoKICAgICAgICB1aW50IHBheW1lbnQgPSBzdWJtaXNzaW9uVmFsdWU7CiAgICAgICAgLy8gdGFrZSB1bmNsZSByYXRlIGludG8gYWNjb3VudAogICAgICAgIAogICAgICAgIC8vIHBheW1lbnQgPSBwYXltZW50ICogKDEtMC4yNSp1bmNsZVJhdGUpCiAgICAgICAgLy8gdW5jbGVSYXRlIGluIFswLDEwMDAwXQogICAgICAgIHBheW1lbnQgPSAocGF5bWVudCAqICg0KjEwMDAwIC0gdW5jbGVSYXRlKSkgLyAoNCoxMDAwMCk7CiAgICAgICAgCiAgICAgICAgLy8gZmVlcwogICAgICAgIHBheW1lbnQgPSAocGF5bWVudCAqICgxMDAwMCAtIHBvb2xGZWVzKSkgLyAxMDAwMDsKCiAgICAgICAgaWYoIHBheW1lbnQgPiB0aGlzLmJhbGFuY2UgKXsKICAgICAgICAgICAgLy9FcnJvckxvZyggImNhbm5vdCBhZmZvcmQgdG8gcGF5IiwgY2FsY1BheW1lbnQoIHN1Ym1pc3Npb25EYXRhLm51bVNoYXJlcywgc3VibWlzc2lvbkRhdGEuZGlmZmljdWx0eSApICk7CiAgICAgICAgICAgIFZlcmlmeUNsYWltKCBtc2cuc2VuZGVyLCAweDg0MDAwMDAwLCBwYXltZW50ICk7ICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgIGlmKCAhIHBheW1lbnRBZGRyZXNzLnNlbmQoIHBheW1lbnQgKSApIHRocm93OwogICAgICAgIAogICAgICAgIERvUGF5bWVudCggbXNnLnNlbmRlciwgcGF5bWVudEFkZHJlc3MsIHBheW1lbnQgKTsgCiAgICAgICAgCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICAKICAgIGZ1bmN0aW9uIGdldFBvb2xFVEhCYWxhbmNlKCApIGNvbnN0YW50IHJldHVybnModWludCkgewogICAgICAgIC8vIGRlYnVnIGZ1bmN0aW9uIGZvciB0ZXN0cnBjCiAgICAgICAgcmV0dXJuIHRoaXMuYmFsYW5jZTsKICAgIH0KCiAgICBldmVudCBHZXRTaGFyZUluZGV4RGVidWdGb3JUZXN0UlBDU3VibWlzc2lvbkluZGV4KCB1aW50IGluZGV4ICk7ICAgIAogICAgZXZlbnQgR2V0U2hhcmVJbmRleERlYnVnRm9yVGVzdFJQQ1NoYXJlSW5kZXgoIHVpbnQgaW5kZXggKTsKICAgICAKICAgIGZ1bmN0aW9uIGdldFNoYXJlSW5kZXhEZWJ1Z0ZvclRlc3RSUEMoIGFkZHJlc3Mgc2VuZGVyICkgewogICAgICAgIHVpbnQgc2VlZCA9IGdldENsYWltU2VlZCggc2VuZGVyICk7CiAgICAgICAgdWludFsyXSBtZW1vcnkgcmVzdWx0ID0gY2FsY3VsYXRlU3VibWlzc2lvbkluZGV4KCBzZW5kZXIsIHNlZWQgKTsKICAgICAgICAKICAgICAgICBHZXRTaGFyZUluZGV4RGVidWdGb3JUZXN0UlBDU3VibWlzc2lvbkluZGV4KCByZXN1bHRbMF0gKTsKICAgICAgICBHZXRTaGFyZUluZGV4RGVidWdGb3JUZXN0UlBDU2hhcmVJbmRleCggcmVzdWx0WzFdICk7ICAgICAgICAKICAgICAgICAgICAgCiAgICB9ICAgICAgICAKfQ=='.
	

]
