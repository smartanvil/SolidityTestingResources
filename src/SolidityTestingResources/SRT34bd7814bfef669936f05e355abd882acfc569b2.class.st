Class {
	#name : #SRT34bd7814bfef669936f05e355abd882acfc569b2,
	#superclass : #SRTContracts,
	#category : #SolidityTestingResources
}

{ #category : #base64 }
SRT34bd7814bfef669936f05e355abd882acfc569b2 >> base64 [
	^ 'cHJhZ21hIHNvbGlkaXR5IF4wLjQuMTg7CgovLyBGaWxlOiB6ZXBwZWxpbi1zb2xpZGl0eS9jb250cmFjdHMvb3duZXJzaGlwL093bmFibGUuc29sCgovKioKICogQHRpdGxlIE93bmFibGUKICogQGRldiBUaGUgT3duYWJsZSBjb250cmFjdCBoYXMgYW4gb3duZXIgYWRkcmVzcywgYW5kIHByb3ZpZGVzIGJhc2ljIGF1dGhvcml6YXRpb24gY29udHJvbAogKiBmdW5jdGlvbnMsIHRoaXMgc2ltcGxpZmllcyB0aGUgaW1wbGVtZW50YXRpb24gb2YgInVzZXIgcGVybWlzc2lvbnMiLgogKi8KY29udHJhY3QgT3duYWJsZSB7CiAgYWRkcmVzcyBwdWJsaWMgb3duZXI7CgoKICBldmVudCBPd25lcnNoaXBUcmFuc2ZlcnJlZChhZGRyZXNzIGluZGV4ZWQgcHJldmlvdXNPd25lciwgYWRkcmVzcyBpbmRleGVkIG5ld093bmVyKTsKCgogIC8qKgogICAqIEBkZXYgVGhlIE93bmFibGUgY29uc3RydWN0b3Igc2V0cyB0aGUgb3JpZ2luYWwgYG93bmVyYCBvZiB0aGUgY29udHJhY3QgdG8gdGhlIHNlbmRlcgogICAqIGFjY291bnQuCiAgICovCiAgZnVuY3Rpb24gT3duYWJsZSgpIHB1YmxpYyB7CiAgICBvd25lciA9IG1zZy5zZW5kZXI7CiAgfQoKICAvKioKICAgKiBAZGV2IFRocm93cyBpZiBjYWxsZWQgYnkgYW55IGFjY291bnQgb3RoZXIgdGhhbiB0aGUgb3duZXIuCiAgICovCiAgbW9kaWZpZXIgb25seU93bmVyKCkgewogICAgcmVxdWlyZShtc2cuc2VuZGVyID09IG93bmVyKTsKICAgIF87CiAgfQoKICAvKioKICAgKiBAZGV2IEFsbG93cyB0aGUgY3VycmVudCBvd25lciB0byB0cmFuc2ZlciBjb250cm9sIG9mIHRoZSBjb250cmFjdCB0byBhIG5ld093bmVyLgogICAqIEBwYXJhbSBuZXdPd25lciBUaGUgYWRkcmVzcyB0byB0cmFuc2ZlciBvd25lcnNoaXAgdG8uCiAgICovCiAgZnVuY3Rpb24gdHJhbnNmZXJPd25lcnNoaXAoYWRkcmVzcyBuZXdPd25lcikgcHVibGljIG9ubHlPd25lciB7CiAgICByZXF1aXJlKG5ld093bmVyICE9IGFkZHJlc3MoMCkpOwogICAgT3duZXJzaGlwVHJhbnNmZXJyZWQob3duZXIsIG5ld093bmVyKTsKICAgIG93bmVyID0gbmV3T3duZXI7CiAgfQoKfQoKLy8gRmlsZTogemVwcGVsaW4tc29saWRpdHkvY29udHJhY3RzL2xpZmVjeWNsZS9EZXN0cnVjdGlibGUuc29sCgovKioKICogQHRpdGxlIERlc3RydWN0aWJsZQogKiBAZGV2IEJhc2UgY29udHJhY3QgdGhhdCBjYW4gYmUgZGVzdHJveWVkIGJ5IG93bmVyLiBBbGwgZnVuZHMgaW4gY29udHJhY3Qgd2lsbCBiZSBzZW50IHRvIHRoZSBvd25lci4KICovCmNvbnRyYWN0IERlc3RydWN0aWJsZSBpcyBPd25hYmxlIHsKCiAgZnVuY3Rpb24gRGVzdHJ1Y3RpYmxlKCkgcHVibGljIHBheWFibGUgeyB9CgogIC8qKgogICAqIEBkZXYgVHJhbnNmZXJzIHRoZSBjdXJyZW50IGJhbGFuY2UgdG8gdGhlIG93bmVyIGFuZCB0ZXJtaW5hdGVzIHRoZSBjb250cmFjdC4KICAgKi8KICBmdW5jdGlvbiBkZXN0cm95KCkgb25seU93bmVyIHB1YmxpYyB7CiAgICBzZWxmZGVzdHJ1Y3Qob3duZXIpOwogIH0KCiAgZnVuY3Rpb24gZGVzdHJveUFuZFNlbmQoYWRkcmVzcyBfcmVjaXBpZW50KSBvbmx5T3duZXIgcHVibGljIHsKICAgIHNlbGZkZXN0cnVjdChfcmVjaXBpZW50KTsKICB9Cn0KCi8vIEZpbGU6IHplcHBlbGluLXNvbGlkaXR5L2NvbnRyYWN0cy9saWZlY3ljbGUvUGF1c2FibGUuc29sCgovKioKICogQHRpdGxlIFBhdXNhYmxlCiAqIEBkZXYgQmFzZSBjb250cmFjdCB3aGljaCBhbGxvd3MgY2hpbGRyZW4gdG8gaW1wbGVtZW50IGFuIGVtZXJnZW5jeSBzdG9wIG1lY2hhbmlzbS4KICovCmNvbnRyYWN0IFBhdXNhYmxlIGlzIE93bmFibGUgewogIGV2ZW50IFBhdXNlKCk7CiAgZXZlbnQgVW5wYXVzZSgpOwoKICBib29sIHB1YmxpYyBwYXVzZWQgPSBmYWxzZTsKCgogIC8qKgogICAqIEBkZXYgTW9kaWZpZXIgdG8gbWFrZSBhIGZ1bmN0aW9uIGNhbGxhYmxlIG9ubHkgd2hlbiB0aGUgY29udHJhY3QgaXMgbm90IHBhdXNlZC4KICAgKi8KICBtb2RpZmllciB3aGVuTm90UGF1c2VkKCkgewogICAgcmVxdWlyZSghcGF1c2VkKTsKICAgIF87CiAgfQoKICAvKioKICAgKiBAZGV2IE1vZGlmaWVyIHRvIG1ha2UgYSBmdW5jdGlvbiBjYWxsYWJsZSBvbmx5IHdoZW4gdGhlIGNvbnRyYWN0IGlzIHBhdXNlZC4KICAgKi8KICBtb2RpZmllciB3aGVuUGF1c2VkKCkgewogICAgcmVxdWlyZShwYXVzZWQpOwogICAgXzsKICB9CgogIC8qKgogICAqIEBkZXYgY2FsbGVkIGJ5IHRoZSBvd25lciB0byBwYXVzZSwgdHJpZ2dlcnMgc3RvcHBlZCBzdGF0ZQogICAqLwogIGZ1bmN0aW9uIHBhdXNlKCkgb25seU93bmVyIHdoZW5Ob3RQYXVzZWQgcHVibGljIHsKICAgIHBhdXNlZCA9IHRydWU7CiAgICBQYXVzZSgpOwogIH0KCiAgLyoqCiAgICogQGRldiBjYWxsZWQgYnkgdGhlIG93bmVyIHRvIHVucGF1c2UsIHJldHVybnMgdG8gbm9ybWFsIHN0YXRlCiAgICovCiAgZnVuY3Rpb24gdW5wYXVzZSgpIG9ubHlPd25lciB3aGVuUGF1c2VkIHB1YmxpYyB7CiAgICBwYXVzZWQgPSBmYWxzZTsKICAgIFVucGF1c2UoKTsKICB9Cn0KCi8vIEZpbGU6IHplcHBlbGluLXNvbGlkaXR5L2NvbnRyYWN0cy9tYXRoL1NhZmVNYXRoLnNvbAoKLyoqCiAqIEB0aXRsZSBTYWZlTWF0aAogKiBAZGV2IE1hdGggb3BlcmF0aW9ucyB3aXRoIHNhZmV0eSBjaGVja3MgdGhhdCB0aHJvdyBvbiBlcnJvcgogKi8KbGlicmFyeSBTYWZlTWF0aCB7CgogIC8qKgogICogQGRldiBNdWx0aXBsaWVzIHR3byBudW1iZXJzLCB0aHJvd3Mgb24gb3ZlcmZsb3cuCiAgKi8KICBmdW5jdGlvbiBtdWwodWludDI1NiBhLCB1aW50MjU2IGIpIGludGVybmFsIHB1cmUgcmV0dXJucyAodWludDI1NikgewogICAgaWYgKGEgPT0gMCkgewogICAgICByZXR1cm4gMDsKICAgIH0KICAgIHVpbnQyNTYgYyA9IGEgKiBiOwogICAgYXNzZXJ0KGMgLyBhID09IGIpOwogICAgcmV0dXJuIGM7CiAgfQoKICAvKioKICAqIEBkZXYgSW50ZWdlciBkaXZpc2lvbiBvZiB0d28gbnVtYmVycywgdHJ1bmNhdGluZyB0aGUgcXVvdGllbnQuCiAgKi8KICBmdW5jdGlvbiBkaXYodWludDI1NiBhLCB1aW50MjU2IGIpIGludGVybmFsIHB1cmUgcmV0dXJucyAodWludDI1NikgewogICAgLy8gYXNzZXJ0KGIgPiAwKTsgLy8gU29saWRpdHkgYXV0b21hdGljYWxseSB0aHJvd3Mgd2hlbiBkaXZpZGluZyBieSAwCiAgICB1aW50MjU2IGMgPSBhIC8gYjsKICAgIC8vIGFzc2VydChhID09IGIgKiBjICsgYSAlIGIpOyAvLyBUaGVyZSBpcyBubyBjYXNlIGluIHdoaWNoIHRoaXMgZG9lc24ndCBob2xkCiAgICByZXR1cm4gYzsKICB9CgogIC8qKgogICogQGRldiBTdWJzdHJhY3RzIHR3byBudW1iZXJzLCB0aHJvd3Mgb24gb3ZlcmZsb3cgKGkuZS4gaWYgc3VidHJhaGVuZCBpcyBncmVhdGVyIHRoYW4gbWludWVuZCkuCiAgKi8KICBmdW5jdGlvbiBzdWIodWludDI1NiBhLCB1aW50MjU2IGIpIGludGVybmFsIHB1cmUgcmV0dXJucyAodWludDI1NikgewogICAgYXNzZXJ0KGIgPD0gYSk7CiAgICByZXR1cm4gYSAtIGI7CiAgfQoKICAvKioKICAqIEBkZXYgQWRkcyB0d28gbnVtYmVycywgdGhyb3dzIG9uIG92ZXJmbG93LgogICovCiAgZnVuY3Rpb24gYWRkKHVpbnQyNTYgYSwgdWludDI1NiBiKSBpbnRlcm5hbCBwdXJlIHJldHVybnMgKHVpbnQyNTYpIHsKICAgIHVpbnQyNTYgYyA9IGEgKyBiOwogICAgYXNzZXJ0KGMgPj0gYSk7CiAgICByZXR1cm4gYzsKICB9Cn0KCi8vIEZpbGU6IHplcHBlbGluLXNvbGlkaXR5L2NvbnRyYWN0cy9wYXltZW50L1B1bGxQYXltZW50LnNvbAoKLyoqCiAqIEB0aXRsZSBQdWxsUGF5bWVudAogKiBAZGV2IEJhc2UgY29udHJhY3Qgc3VwcG9ydGluZyBhc3luYyBzZW5kIGZvciBwdWxsIHBheW1lbnRzLiBJbmhlcml0IGZyb20gdGhpcwogKiBjb250cmFjdCBhbmQgdXNlIGFzeW5jU2VuZCBpbnN0ZWFkIG9mIHNlbmQuCiAqLwpjb250cmFjdCBQdWxsUGF5bWVudCB7CiAgdXNpbmcgU2FmZU1hdGggZm9yIHVpbnQyNTY7CgogIG1hcHBpbmcoYWRkcmVzcyA9PiB1aW50MjU2KSBwdWJsaWMgcGF5bWVudHM7CiAgdWludDI1NiBwdWJsaWMgdG90YWxQYXltZW50czsKCiAgLyoqCiAgKiBAZGV2IHdpdGhkcmF3IGFjY3VtdWxhdGVkIGJhbGFuY2UsIGNhbGxlZCBieSBwYXllZS4KICAqLwogIGZ1bmN0aW9uIHdpdGhkcmF3UGF5bWVudHMoKSBwdWJsaWMgewogICAgYWRkcmVzcyBwYXllZSA9IG1zZy5zZW5kZXI7CiAgICB1aW50MjU2IHBheW1lbnQgPSBwYXltZW50c1twYXllZV07CgogICAgcmVxdWlyZShwYXltZW50ICE9IDApOwogICAgcmVxdWlyZSh0aGlzLmJhbGFuY2UgPj0gcGF5bWVudCk7CgogICAgdG90YWxQYXltZW50cyA9IHRvdGFsUGF5bWVudHMuc3ViKHBheW1lbnQpOwogICAgcGF5bWVudHNbcGF5ZWVdID0gMDsKCiAgICBhc3NlcnQocGF5ZWUuc2VuZChwYXltZW50KSk7CiAgfQoKICAvKioKICAqIEBkZXYgQ2FsbGVkIGJ5IHRoZSBwYXllciB0byBzdG9yZSB0aGUgc2VudCBhbW91bnQgYXMgY3JlZGl0IHRvIGJlIHB1bGxlZC4KICAqIEBwYXJhbSBkZXN0IFRoZSBkZXN0aW5hdGlvbiBhZGRyZXNzIG9mIHRoZSBmdW5kcy4KICAqIEBwYXJhbSBhbW91bnQgVGhlIGFtb3VudCB0byB0cmFuc2Zlci4KICAqLwogIGZ1bmN0aW9uIGFzeW5jU2VuZChhZGRyZXNzIGRlc3QsIHVpbnQyNTYgYW1vdW50KSBpbnRlcm5hbCB7CiAgICBwYXltZW50c1tkZXN0XSA9IHBheW1lbnRzW2Rlc3RdLmFkZChhbW91bnQpOwogICAgdG90YWxQYXltZW50cyA9IHRvdGFsUGF5bWVudHMuYWRkKGFtb3VudCk7CiAgfQp9CgovLyBGaWxlOiBjb250cmFjdHMvR29HbG9iYWxzLnNvbAoKLy8vIEB0aXRsZSBUaGUgYmFzZSBjb250cmFjdCBmb3IgRXRoZXJuYWxHbywgY29udGFpbnMgdGhlIGFkbWluIGZ1bmN0aW9ucyBhbmQgdGhlIGdsb2JhbHMgdXNlZCB0aHJvdWdodCB0aGUgZ2FtZQovLy8gQGF1dGhvciBodHRwczovL3d3dy5FdGhlcm5hbEdvLmNvbQovLy8gQGRldiBTZWUgdGhlIEdvR2FtZUxvZ2ljIGFuZCBHb0JvYXJkTWV0YURldGFpbHMgY29udHJhY3QgZG9jdW1lbnRhdGlvbiB0byB1bmRlcnN0YW5kIHRoZSBhY3R1YWwgZ2FtZSBtZWNoYW5pY3MuCmNvbnRyYWN0IEdvR2xvYmFscyBpcyBPd25hYmxlLCBQdWxsUGF5bWVudCwgRGVzdHJ1Y3RpYmxlLCBQYXVzYWJsZSB7CgogICAgLy8gVXNlZCBmb3Igc2ltcGxpZnlpbmcgY2FwdHVyZSBjYWxjdWxhdGlvbnMKICAgIHVpbnQ4IGNvbnN0YW50IE1BWF9VSU5UOCA9IDI1NTsKCiAgICAvLyBVc2VkIHRvIGRlcm1pbmUgcGxheWVyIGNvbG9yIGFuZCB3aG8gaXMgdXAgbmV4dAogICAgZW51bSBQbGF5ZXJDb2xvciB7Tm9uZSwgQmxhY2ssIFdoaXRlfQoKICAgIC8vLyAgICBAZGV2IEJvYXJkIHN0YXR1cyBpcyBhIGNyaXRpY2FsIGNvbmNlcHQgdGhhdCBkZXRlcm1pbmVzIHdoaWNoIGFjdGlvbnMgY2FuIGJlIHRha2VuIHdpdGhpbiBlYWNoIHBoYXNlCiAgICAvLy8gICAgICAgIFdhaXRGb3JPcHBvbmVudCAtIFdoZW4gdGhlIGZpcnN0IHBsYXllciBoYXMgcmVnaXN0ZXJlZCBhbmQgd2FpdGluZyBmb3IgYSBzZWNvbmQgcGxheWVyCiAgICAvLy8gICAgICAgIEluUHJvZ3Jlc3MgLSBUaGUgbWF0Y2ggaXMgb24hIFRoZSBhY3RpbmcgcGxheWVyIGNhbiBjaG9vc2UgYmV0d2VlbiBwbGFjaW5nIGEgc3RvbmUgb3IgcGFzc2luZyAob3IgcmVzaWduaW5nKQogICAgLy8vICAgICAgICBXYWl0aW5nVG9SZXNvbHZlIC0gQm90aCBwbGF5ZXJzIGNob3NlIHRvIHBhc3MgdGhlaXIgdHVybiBhbmQgd2UgYXJlIHdhaXRpbmcgZm9yIHRoZSB3aW5uZXIgdG8gYXNrIHRoZSBjb250cmFjdCBmb3IgIHNjb3JlIGNvdW50CiAgICAvLy8gICAgICAgIEJsYWNrV2luLCBXaGl0ZVdpbiwgRHJhdyAtIFByZXR0eSBzZWxmIGV4cGxhbmF0b3J5CiAgICAvLy8gICAgICAgIENhbmNlbGVkIC0gVGhlIGZpcnN0IHBsYXllciB3aG8gam9pbmVkIHRoZSBib2FyZCBpcyBhbGxvd2VkIHRvIGNhbmNlbCBhIG1hdGNoIGlmIG5vIG9wcG9uZW50IGhhcyBqb2luZWQgeWV0CiAgICBlbnVtIEJvYXJkU3RhdHVzIHtXYWl0Rm9yT3Bwb25lbnQsIEluUHJvZ3Jlc3MsIFdhaXRpbmdUb1Jlc29sdmUsIEJsYWNrV2luLCBXaGl0ZVdpbiwgRHJhdywgQ2FuY2VsZWR9CgogICAgLy8gV2Ugc3RhcmV0ZCB3aXRoIGEgOXg5IHJvd3MKICAgIHVpbnQ4IGNvbnN0YW50IEJPQVJEX1JPV19TSVpFID0gOTsKICAgIHVpbnQ4IGNvbnN0YW50IEJPQVJEX1NJWkUgPSBCT0FSRF9ST1dfU0laRSAqKiAyOwoKICAgIC8vIFdlIHVzZSBhIHNocmlua2VkIGJvYXJkIHNpemUgdG8gb3B0aW1pemUgZ2FzIGNvc3RzCiAgICB1aW50OCBjb25zdGFudCBTSFJJTktFRF9CT0FSRF9TSVpFID0gMjE7CgogICAgLy8gVGhlc2UgYXJlIHRoZSBzaGFyZXMgZWFjaCBwbGF5ZXIgYW5kIEV0aGVybmFsR28gYXJlIGdldHRpbmcgZm9yIGVhY2ggZ2FtZQogICAgdWludCBwdWJsaWMgV0lOTkVSX1NIQVJFOwogICAgdWludCBwdWJsaWMgSE9TVF9TSEFSRTsKICAgIHVpbnQgcHVibGljIEhPTk9SQUJMRV9MT1NTX0JPTlVTOwoKICAgIC8vIEVhY2ggcGxheWVyIGdldHMgUExBWUVSX1RVUk5fU0lOR0xFX1BFUklPRCB4IFBMQVlFUl9TVEFSVF9QRVJJT0RTIHRvIGFjdC4gVGhlc2UgbWF5IGNoYW5nZSBhY2NvcmRpbmcgdG8gcGxheWVyIGZlZWRiYWNrIGFuZCBuZXR3b3JrIGNvbmp1bmN0aW9uIHRvIG9wdGltaXplIHRoZSBwbGF5aW5nIGV4cGVyaWVuY2UKICAgIHVpbnQgIHB1YmxpYyBQTEFZRVJfVFVSTl9TSU5HTEVfUEVSSU9EID0gNCBtaW51dGVzOwogICAgdWludDggcHVibGljIFBMQVlFUl9TVEFSVF9QRVJJT0RTID0gNTsKICAgIAogICAgLy8gV2UgZGVjaWRlZCB0byByZXN0cmljdCB0aGUgdGFibGUgc3Rha2VzIHRvIHNldmVyYWwgb3B0aW9ucyB0byBhbGxvdyBmb3IgZWFzaWVyIG1hdGNoLW1ha2luZwogICAgdWludFtdIHB1YmxpYyB0YWJsZVN0YWtlc09wdGlvbnM7CgogICAgLy8gVGhpcyBpcyB0aGUgbWFpbiBkYXRhIGZpZWxkIHRoYXQgY29udGFpbnMgYWNjZXNzIHRvIGFsbCBvZiB0aGUgR29Cb2FyZHMgdGhhdCB3ZXJlIGNyZWF0ZWQKICAgIEdvQm9hcmRbXSBpbnRlcm5hbCBhbGxCb2FyZHM7CgogICAgLy8gVGhlIENGTyBpcyB0aGUgb25seSBhY2NvdW50IHRoYXQgaXMgYWxsb3dlZCB0byB3aXRoZHJhdyBmdW5kcwogICAgYWRkcmVzcyBwdWJsaWMgQ0ZPOwoKICAgIC8vIFRoaXMgaXMgdGhlIG1haW4gYm9hcmQgc3RydWN0dXJlIGFuZCBpcyBpbnN0YW50aWF0ZWQgZm9yIGV2ZXJ5IG5ldyBnYW1lCiAgICBzdHJ1Y3QgR29Cb2FyZCB7ICAgICAgICAKICAgICAgICAvLyBXZSB1c2UgdGhlIGxhc3QgdXBkYXRlIHRvIGRldGVybWluZSBob3cgbG9uZyBoYXMgaXQgYmVlbiBzaW5jZSB0aGUgcGxheWVyIGNvdWxkIGFjdAogICAgICAgIHVpbnQgbGFzdFVwZGF0ZTsKICAgICAgICAKICAgICAgICAvLyBUaGUgdGFibGUgc3Rha2VzIG1hcmtzIGhvdyBtdWNoIEVUSCBlYWNoIHBhcnRpY2lwYW50IG5lZWRzIHRvIHBheSB0byByZWdpc3RlciBmb3IgdGhlIGJvYXJkCiAgICAgICAgdWludCB0YWJsZVN0YWtlczsKICAgICAgICAKICAgICAgICAvLyBUaGUgYm9hcmQgYmFsYW5jZSBrZWVwcyB0cmFjayBvZiBob3cgbXVjaCBFVEggdGhpcyBib2FyZCBoYXMgaW4gb3JkZXIgdG8gc2VlIGlmIHdlIGFscmVhZHkgZGlzdHJpYnV0ZWQgdGhlIHBheW1lbnRzIGZvciB0aGlzIG1hdGNoCiAgICAgICAgdWludCBib2FyZEJhbGFuY2U7CgogICAgICAgIC8vIEJsYWNrIGFuZCB3aGl0ZSBwbGF5ZXIgYWRkcmVzc2VzCiAgICAgICAgYWRkcmVzcyBibGFja0FkZHJlc3M7CiAgICAgICAgYWRkcmVzcyB3aGl0ZUFkZHJlc3M7CgogICAgICAgIC8vIEJsYWNrIGFuZCB3aGl0ZSB0aW1lIHBlcmlvZHMgcmVtYWluaW5nIChpbml0aWFsbHkgdGhleSB3aWxsIGJlIFBMQVlFUl9TVEFSVF9QRVJJT0RTKQogICAgICAgIHVpbnQ4IGJsYWNrUGVyaW9kc1JlbWFpbmluZzsKICAgICAgICB1aW50OCB3aGl0ZVBlcmlvZHNSZW1haW5pbmc7CgogICAgICAgIC8vIEtlZXAgdHJhY2sgb2YgZG91YmxlIHBhc3MgdG8gZmluaXNoIHRoZSBnYW1lCiAgICAgICAgYm9vbCBkaWRQYXNzUHJldlR1cm47CiAgICAgICAgCiAgICAgICAgLy8gS2VlcCB0cmFjayBvZiBkb3VibGUgcGFzcyB0byBmaW5pc2ggdGhlIGdhbWUKICAgICAgICBib29sIGlzSG9ub3JhYmxlTG9zczsKCiAgICAgICAgLy8gV2hvJ3MgbmV4dAogICAgICAgIFBsYXllckNvbG9yIG5leHRUdXJuQ29sb3I7CgogICAgICAgIC8vIFVzZSBhIG1hcHBpbmcgdG8gZmlndXJlIG91dCB3aGljaCBzdG9uZSBpcyBzZXQgaW4gd2hpY2ggcG9zaXRpb24uIChQb3NpdGlvbnMgY2FuIGJlIDAtQk9BUkRfU0laRSkKICAgICAgICAvLyBAZGV2IFdlIGRlY2lkZWQgbm90IHVzZSBhbiBhcnJheSB0byBtaW5pbWl6ZSB0aGUgc3RvcmFnZSBjb3N0CiAgICAgICAgbWFwcGluZyh1aW50OD0+dWludDgpIHBvc2l0aW9uVG9Db2xvcjsKCiAgICAgICAgLy8gVGhlIGJvYXJkJ3MgY3VycmVudCBzdGF0dXMgICAgICAgIAogICAgICAgIEJvYXJkU3RhdHVzIHN0YXR1czsKICAgIH0KCiAgICAvLy8gQG5vdGljZSBUaGUgY29uc3RydWN0b3IgaXMgY2FsbGVkIHdpdGggb3VyIGluaXRhbCB2YWx1ZXMsIHRoZXkgd2lsbCBwcm9iYWJseSBjaGFuZ2UgYnV0IHRoaXMgaXMgd2hhdCBoYWQgaW4gbWluZCB3aGVuIGRldmVsb3BpbmcgdGhlIGdhbWUuCiAgICBmdW5jdGlvbiBHb0dsb2JhbHMoKSBwdWJsaWMgT3duYWJsZSgpIFB1bGxQYXltZW50KCkgRGVzdHJ1Y3RpYmxlKCkgewoKICAgICAgICAvLyBBZGQgaW5pdGlhbCBwcmljZSB0aWVycyBzbyBmcm9tIHZhcmlvdW9zIHJhbmdlcwogICAgICAgIGFkZFByaWNlVGllcigwLjUgZXRoZXIpOwogICAgICAgIGFkZFByaWNlVGllcigxIGV0aGVyKTsKICAgICAgICBhZGRQcmljZVRpZXIoNSBldGhlcik7CgogICAgICAgIC8vIFRoZXNlIGFyZSB0aGUgaW5pdGFsIHNoYXJlcyB3ZSd2ZSBoYWQgaW4gbWluZCB3aGVuIGRldmVsb3BpbmcgdGhlIGdhbWUKICAgICAgICB1cGRhdGVTaGFyZXMoOTUwLCA1MCwgNSk7CiAgICAgICAgCiAgICAgICAgLy8gVGhlIENGTyB3aWxsIGJlIHRoZSBvd25lciwgYnV0IGl0IHdpbGwgY2hhbmdlIHNvb24gYWZ0ZXIgdGhlIGNvbnRyYWN0IGlzIGRlcGxveWVkCiAgICAgICAgQ0ZPID0gb3duZXI7CiAgICB9CgogICAgLy8vIEBub3RpY2UgSW4gY2FzZSB3ZSBuZWVkIGV4dHJhIHByaWNlIHRpZXJzICh0YWJsZSBzdGFrZXMgd2hlcmUgcGVvcGxlIGNhbiBwbGF5KSB3ZSBjYW4gYWRkIGFkZGl0aW9uYWwgb25lcwogICAgLy8vIEBwYXJhbSBwcmljZSB0aGUgcHJpY2UgZm9yIHRoZSBuZXcgcHJpY2UgdGllciBpbiBXRUkKICAgIGZ1bmN0aW9uIGFkZFByaWNlVGllcih1aW50IHByaWNlKSBwdWJsaWMgb25seU93bmVyIHsKICAgICAgICB0YWJsZVN0YWtlc09wdGlvbnMucHVzaChwcmljZSk7CiAgICB9CgogICAgLy8vIElmIHdlIG5lZWQgdG8gdXBkYXRlIHByaWNlIHRpZXJzCiAgICAvLy8gQHBhcmFtIHByaWNlVGllciB0aGUgdGllciBpbmRleCBmcm9tIHRoZSBhcnJheQogICAgLy8vIEBwYXJhbSBwcmljZSB0aGUgbmV3IHByaWNlIHRvIHNldAogICAgZnVuY3Rpb24gdXBkYXRlUHJpY2VUaWVyKHVpbnQ4IHByaWNlVGllciwgdWludCBwcmljZSkgcHVibGljIG9ubHlPd25lciB7CiAgICAgICAgdGFibGVTdGFrZXNPcHRpb25zW3ByaWNlVGllcl0gPSBwcmljZTsKICAgIH0KCiAgICAvLy8gQG5vdGljZSBJZiB3ZSBuZWVkIHRvIGFkanVzdCB0aGUgYW1vdW50cyBwbGF5ZXJzIG9yIEV0aGVybmFsR28gZ2V0cyBmb3IgZWFjaCBnYW1lCiAgICAvLy8gQHBhcmFtIG5ld1dpbm5lclNoYXJlIHRoZSB3aW5uZXIncyBzaGFyZSAob3V0IG9mIDEwMDApCiAgICAvLy8gQHBhcmFtIG5ld0hvc3RTaGFyZSBFdGhlcm5hbEdvJ3Mgc2hhcmUgKG91dCBvZiAxMDAwKQogICAgLy8vIEBwYXJhbSBuZXdCb251c1NoYXJlIEJvbnVzIHRoYXQgY29tZXMgb3VyIG9mIEV0aGVybmFsR28gYW5kIGdvZXMgdG8gdGhlIGxvc2VyIGluIGNhc2Ugb2YgYW4gaG9ub3JhYmxlIGxvc3MgKG91dCBvZiAxMDAwKQogICAgZnVuY3Rpb24gdXBkYXRlU2hhcmVzKHVpbnQgbmV3V2lubmVyU2hhcmUsIHVpbnQgbmV3SG9zdFNoYXJlLCB1aW50IG5ld0JvbnVzU2hhcmUpIHB1YmxpYyBvbmx5T3duZXIgewogICAgICAgIHJlcXVpcmUobmV3V2lubmVyU2hhcmUgKyBuZXdIb3N0U2hhcmUgPT0gMTAwMCk7CiAgICAgICAgV0lOTkVSX1NIQVJFID0gbmV3V2lubmVyU2hhcmU7CiAgICAgICAgSE9TVF9TSEFSRSA9IG5ld0hvc3RTaGFyZTsKICAgICAgICBIT05PUkFCTEVfTE9TU19CT05VUyA9IG5ld0JvbnVzU2hhcmU7CiAgICB9CgogICAgLy8vIEBub3RpY2UgU2VwYXJhdGluZyB0aGUgQ0ZPIGFuZCB0aGUgQ0VPIHJlc3BvbnNpYmlsaXRpZXMgcmVxdWlyZXMgdGhlIGFiaWxpdHkgdG8gc2V0IHRoZSBDRk8gYWNjb3VudAogICAgLy8vIEBwYXJhbSBuZXdDRk8gdGhlIG5ldyBDRk8KICAgIGZ1bmN0aW9uIHNldE5ld0NGTyhhZGRyZXNzIG5ld0NGTykgcHVibGljIG9ubHlPd25lciB7CiAgICAgICAgcmVxdWlyZShuZXdDRk8gIT0gMCk7CiAgICAgICAgQ0ZPID0gbmV3Q0ZPOwogICAgfQoKICAgIC8vLyBAbm90aWNlIFNlcGFyYXRpbmcgdGhlIENGTyBhbmQgdGhlIENFTyByZXNwb25zaWJpbGl0aWVzIHJlcXVpcmVzIHRoZSBhYmlsaXR5IHRvIHNldCB0aGUgQ0ZPIGFjY291bnQKICAgIC8vLyBAcGFyYW0gc2Vjb25kc1BlclBlcmlvZCBUaGUgbnVtYmVyIG9mIHNlY29uZHMgd2Ugd291bGQgbGlrZSBlYWNoIHBlcmlvZCB0byBsYXN0CiAgICAvLy8gQHBhcmFtIG51bWJlck9mUGVyaW9kcyBUaGUgbnVtYmVyIG9mIG9mIHBlcmlvZHMgZWFjaCBwbGF5ZXIgaW5pdGlhbGx5IGhhcwogICAgZnVuY3Rpb24gdXBkYXRlR2FtZVRpbWVzKHVpbnQgc2Vjb25kc1BlclBlcmlvZCwgdWludDggbnVtYmVyT2ZQZXJpb2RzKSBwdWJsaWMgb25seU93bmVyIHsKCiAgICAgICAgUExBWUVSX1RVUk5fU0lOR0xFX1BFUklPRCA9IHNlY29uZHNQZXJQZXJpb2Q7CiAgICAgICAgUExBWUVSX1NUQVJUX1BFUklPRFMgPSBudW1iZXJPZlBlcmlvZHM7CiAgICB9CgogICAgLy8vIEBkZXYgQ29udmluaWVuY2UgZnVuY3Rpb24gdG8gYWNjZXNzIHRoZSBzaGFyZXMKICAgIGZ1bmN0aW9uIGdldFNoYXJlcygpIHB1YmxpYyB2aWV3IHJldHVybnModWludCwgdWludCwgdWludCkgewogICAgICAgIHJldHVybiAoV0lOTkVSX1NIQVJFLCBIT1NUX1NIQVJFLCBIT05PUkFCTEVfTE9TU19CT05VUyk7CiAgICB9Cn0KCi8vIEZpbGU6IGNvbnRyYWN0cy9Hb0JvYXJkTWV0YURldGFpbHMuc29sCgovLy8gQHRpdGxlIFRoaXMgY29udHJhY3QgbWFuYWdlcyB0aGUgbWV0YSBkZXRhaWxzIG9mIEV0aGVybmFsR28uIAovLy8gICAgIFJlZ2lzdGVyaW5nIHRvIGEgYm9hcmQsIHNwbGl0dGluZyB0aGUgcmV2ZW51ZXMgYW5kIG90aGVyIGRheS10by1kYXkgYWN0aW9ucyB0aGF0IGFyZSB1bnJlbGF0ZWQgdG8gdGhlIGFjdHVhbCBnYW1lCi8vLyBAYXV0aG9yIGh0dHBzOi8vd3d3LkV0aGVybmFsR28uY29tCi8vLyBAZGV2IFNlZSB0aGUgR29HYW1lTG9naWMgdG8gdW5kZXJzdGFuZCB0aGUgYWN0dWFsIGdhbWUgbWVjaGFuaWNzIGFuZCBydWxlcwpjb250cmFjdCBHb0JvYXJkTWV0YURldGFpbHMgaXMgR29HbG9iYWxzIHsKICAgIAogICAgLy8vIEBkZXYgVGhlIHBsYXllciBhZGRlZCB0byBib2FyZCBldmVudCBjYW4gYmUgdXNlZCB0byBjaGVjayB1cG9uIHJlZ2lzdHJhdGlvbiBzdWNjZXNzCiAgICBldmVudCBQbGF5ZXJBZGRlZFRvQm9hcmQodWludCBib2FyZElkLCBhZGRyZXNzIHBsYXllckFkZHJlc3MpOwogICAgCiAgICAvLy8gQGRldiBUaGUgYm9hcmQgdXBkYXRlZCBzdGF0dXMgY2FuIGJlIHVzZWQgdG8gZ2V0IHRoZSBuZXcgYm9hcmQgc3RhdHVzCiAgICBldmVudCBCb2FyZFN0YXR1c1VwZGF0ZWQodWludCBib2FyZElkLCBCb2FyZFN0YXR1cyBuZXdTdGF0dXMpOwogICAgCiAgICAvLy8gQGRldiBUaGUgcGxheWVyIHdpdGhkcmF3biBoaXMgYWNjdW11bGF0ZWQgYmFsYW5jZSAKICAgIGV2ZW50IFBsYXllcldpdGhkcmF3bkJhbGFuY2UoYWRkcmVzcyBwbGF5ZXJBZGRyZXNzKTsKICAgIAogICAgLy8vIEBkZXYgU2ltcGxlIHdyYXBwZXIgdG8gcmV0dXJuIHRoZSBudW1iZXIgb2YgYm9hcmRzIGluIHRvdGFsCiAgICBmdW5jdGlvbiBnZXRUb3RhbE51bWJlck9mQm9hcmRzKCkgcHVibGljIHZpZXcgcmV0dXJucyh1aW50KSB7CiAgICAgICAgcmV0dXJuIGFsbEJvYXJkcy5sZW5ndGg7CiAgICB9CgogICAgLy8vIEBub3RpY2UgV2Ugd291bGQgbGlrZSB0byBlYXNpbHkgYW5kIHRyYW5zcGFyYW50bHkgc2hhcmUgdGhlIGdhbWUncyBzdGF0aXN0aWNzIHdpdGggYW55b25lIGFuZCBwcmVzZW50IG9uIHRoZSB3ZWItYXBwCiAgICBmdW5jdGlvbiBnZXRDb21wbGV0ZWRHYW1lc1N0YXRpc3RpY3MoKSBwdWJsaWMgdmlldyByZXR1cm5zKHVpbnQsIHVpbnQpIHsKICAgICAgICB1aW50IGNvbXBsZXRlZCA9IDA7CiAgICAgICAgdWludCBldGhQYWlkID0gMDsKICAgICAgICAKICAgICAgICAvLyBAZGV2IEdvIHRocm91Z2ggYWxsIHRoZSBib2FyZHMsIHdlIHN0YXJ0IHdpdGggMSBhcyBpdCdzIGFuIHVuc2lnbmVkIGludAogICAgICAgIGZvciAodWludCBpID0gMTsgaSA8PSBhbGxCb2FyZHMubGVuZ3RoOyBpKyspIHsKCiAgICAgICAgICAgIC8vIEdldCB0aGUgY3VycmVudCBib2FyZAogICAgICAgICAgICBHb0JvYXJkIHN0b3JhZ2UgYm9hcmQgPSBhbGxCb2FyZHNbaSAtIDFdOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQ2hlY2sgaWYgaXQgd2FzIGEgdmljdG9yeSwgb3RoZXJ3aXNlIGl0J3Mgbm90IGludGVyZXN0aW5nIGFzIHRoZSBwbGF5ZXJzIGp1c3QgZ290IHRoZWlyIGRlcG9zaXQgYmFjawogICAgICAgICAgICBpZiAoKGJvYXJkLnN0YXR1cyA9PSBCb2FyZFN0YXR1cy5CbGFja1dpbikgfHwgKGJvYXJkLnN0YXR1cyA9PSBCb2FyZFN0YXR1cy5XaGl0ZVdpbikpIHsKICAgICAgICAgICAgICAgICsrY29tcGxldGVkOwoKICAgICAgICAgICAgICAgIC8vIFdlIG5lZWQgdG8gcXVlcnkgdGhlIHRhYmxlIHN0YWtlcyBhcyB0aGUgYm9hcmQncyBiYWxhbmNlIHdpbGwgYmUgemVybyBvbmNlIGEgZ2FtZSBpcyBmaW5pc2hlZAogICAgICAgICAgICAgICAgZXRoUGFpZCArPSBib2FyZC50YWJsZVN0YWtlcy5tdWwoMik7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiAoY29tcGxldGVkLCBldGhQYWlkKTsKICAgIH0KCiAgICAvLy8gQGRldiBBdCB0aGlzIHBvaW50IHRoZXJlIGlzIG5vIHN1cHBvcnQgZm9yIHJldHVybmluZyBkeW5hbWljIGFycmF5cyAoaXQncyBzdXBwb3J0ZWQgZm9yIHdlYjMgY2FsbHMgYnV0IG5vdCBmb3IgaW50ZXJuYWwgdGVzdGluZykgc28gd2Ugd2lsbCAib25seSIgcHJlc2VudCB0aGUgcmVjZW50IDUwIGdhbWVzIHBlciBwbGF5ZXIuCiAgICB1aW50OCBjb25zdGFudCBQQUdFX1NJWkUgPSA1MDsKCiAgICAvLy8gQGRldiBNYWtlIHN1cmUgdGhpcyBib2FyZCBpcyBpbiB3YWl0aW5nIGZvciByZXN1bHQgc3RhdHVzCiAgICBtb2RpZmllciBib2FyZFdhaXRpbmdUb1Jlc29sdmUodWludCBib2FyZElkKXsKICAgICAgICByZXF1aXJlKGFsbEJvYXJkc1tib2FyZElkXS5zdGF0dXMgPT0gQm9hcmRTdGF0dXMuV2FpdGluZ1RvUmVzb2x2ZSk7CiAgICAgICAgXzsKICAgIH0KCiAgICAvLy8gQGRldiBNYWtlIHN1cmUgdGhpcyBib2FyZCBpcyBpbiBvbmUgb2YgdGhlIGVuZCBvZiBnYW1lIHN0YXRlcwogICAgbW9kaWZpZXIgYm9hcmRHYW1lRW5kZWQoR29Cb2FyZCBzdG9yYWdlIGJvYXJkKXsKICAgICAgICByZXF1aXJlKGlzRW5kR2FtZVN0YXR1cyhib2FyZC5zdGF0dXMpKTsKICAgICAgICBfOwogICAgfQoKICAgIC8vLyBAZGV2IE1ha2Ugc3VyZSB0aGlzIGJvYXJkIHN0aWxsIGhhcyBiYWxhbmNlCiAgICBtb2RpZmllciBib2FyZE5vdFBhaWQoR29Cb2FyZCBzdG9yYWdlIGJvYXJkKXsKICAgICAgICByZXF1aXJlKGJvYXJkLmJvYXJkQmFsYW5jZSA+IDApOwogICAgICAgIF87CiAgICB9CgogICAgLy8vIEBkZXYgTWFrZSBzdXJlIHRoaXMgYm9hcmQgc3RpbGwgaGFzIGEgc3BvdCBmb3IgYXQgbGVhc3Qgb25lIHBsYXllciB0byBqb2luCiAgICBtb2RpZmllciBib2FyZFdhaXRpbmdGb3JQbGF5ZXJzKHVpbnQgYm9hcmRJZCl7CiAgICAgICAgcmVxdWlyZShhbGxCb2FyZHNbYm9hcmRJZF0uc3RhdHVzID09IEJvYXJkU3RhdHVzLldhaXRGb3JPcHBvbmVudCAmJgogICAgICAgICAgICAgICAgKGFsbEJvYXJkc1tib2FyZElkXS5ibGFja0FkZHJlc3MgPT0gMCB8fCAKICAgICAgICAgICAgICAgICBhbGxCb2FyZHNbYm9hcmRJZF0ud2hpdGVBZGRyZXNzID09IDApKTsKICAgICAgICBfOwogICAgfQoKICAgIC8vLyBAZGV2IFJlc3RyaWN0cyBnYW1lcyBmb3IgdGhlIGFsbG93ZWQgdGFibGUgc3Rha2VzCiAgICAvLy8gQHBhcmFtIHZhbHVlIHRoZSB2YWx1ZSB3ZSBhcmUgbG9va2luZyBmb3IgdG8gcmVnaXN0ZXIKICAgIG1vZGlmaWVyIGFsbG93ZWRWYWx1ZXNPbmx5KHVpbnQgdmFsdWUpewogICAgICAgIGJvb2wgZGlkRmluZFZhbHVlID0gZmFsc2U7CiAgICAgICAgCiAgICAgICAgLy8gVGhlIG51bWJlciBvZiB0YWJsZVN0YWtlc09wdGlvbnMgY2FuIGNoYW5nZSBoZW5jZSBpdCBoYXMgdG8gYmUgZHluYW1pYwogICAgICAgIGZvciAodWludDggaSA9IDA7IGkgPCB0YWJsZVN0YWtlc09wdGlvbnMubGVuZ3RoOyArKyBpKSB7CiAgICAgICAgICAgaWYgKHZhbHVlID09IHRhYmxlU3Rha2VzT3B0aW9uc1tpXSkKICAgICAgICAgICAgZGlkRmluZFZhbHVlID0gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIHJlcXVpcmUgKGRpZEZpbmRWYWx1ZSk7CiAgICAgICAgXzsKICAgIH0KCiAgICAvLy8gQGRldiBDaGVja3MgYSBzdGF0dXMgaWYgYW5kIHJldHVybnMgaWYgaXQncyBhbiBlbmQgZ2FtZQogICAgLy8vIEBwYXJhbSBzdGF0dXMgdGhlIHZhbHVlIHdlIGFyZSBjaGVja2luZwogICAgLy8vIEByZXR1cm4gdHJ1ZSBpZiBpdCdzIGFuIGVuZC1nYW1lIHN0YXR1cwogICAgZnVuY3Rpb24gaXNFbmRHYW1lU3RhdHVzKEJvYXJkU3RhdHVzIHN0YXR1cykgcHVibGljIHB1cmUgcmV0dXJucyhib29sKSB7CiAgICAgICAgcmV0dXJuIChzdGF0dXMgPT0gQm9hcmRTdGF0dXMuQmxhY2tXaW4pIHx8IChzdGF0dXMgPT0gQm9hcmRTdGF0dXMuV2hpdGVXaW4pIHx8IChzdGF0dXMgPT0gQm9hcmRTdGF0dXMuRHJhdykgfHwgKHN0YXR1cyA9PSBCb2FyZFN0YXR1cy5DYW5jZWxlZCk7CiAgICB9CgogICAgLy8vIEBkZXYgR2V0cyB0aGUgdXBkYXRlIHRpbWUgZm9yIGEgYm9hcmQKICAgIC8vLyBAcGFyYW0gYm9hcmRJZCBUaGUgaWQgb2YgdGhlIGJvYXJkIHRvIGNoZWNrCiAgICAvLy8gQHJldHVybiB0aGUgdXBkYXRlIHRpbWVzdGFtcCBpbiBzZWNvbmRzCiAgICBmdW5jdGlvbiBnZXRCb2FyZFVwZGF0ZVRpbWUodWludCBib2FyZElkKSBwdWJsaWMgdmlldyByZXR1cm5zKHVpbnQpIHsKICAgICAgICBHb0JvYXJkIHN0b3JhZ2UgYm9hcmQgPSBhbGxCb2FyZHNbYm9hcmRJZF07CiAgICAgICAgcmV0dXJuIChib2FyZC5sYXN0VXBkYXRlKTsKICAgIH0KCiAgICAvLy8gQGRldiBHZXRzIHRoZSBjdXJyZW50IGJvYXJkIHN0YXR1cwogICAgLy8vIEBwYXJhbSBib2FyZElkIFRoZSBpZCBvZiB0aGUgYm9hcmQgdG8gY2hlY2sKICAgIC8vLyBAcmV0dXJuIHRoZSBjdXJyZW50IGJvYXJkIHN0YXR1cwogICAgZnVuY3Rpb24gZ2V0Qm9hcmRTdGF0dXModWludCBib2FyZElkKSBwdWJsaWMgdmlldyByZXR1cm5zKEJvYXJkU3RhdHVzKSB7CiAgICAgICAgR29Cb2FyZCBzdG9yYWdlIGJvYXJkID0gYWxsQm9hcmRzW2JvYXJkSWRdOwogICAgICAgIHJldHVybiAoYm9hcmQuc3RhdHVzKTsKICAgIH0KCiAgICAvLy8gQGRldiBHZXRzIHRoZSBjdXJyZW50IGJhbGFuY2Ugb2YgdGhlIGJvYXJkCiAgICAvLy8gQHBhcmFtIGJvYXJkSWQgVGhlIGlkIG9mIHRoZSBib2FyZCB0byBjaGVjawogICAgLy8vIEByZXR1cm4gdGhlIGN1cnJlbnQgYm9hcmQgYmFsYW5jZSBpbiBXRUkKICAgIGZ1bmN0aW9uIGdldEJvYXJkQmFsYW5jZSh1aW50IGJvYXJkSWQpIHB1YmxpYyB2aWV3IHJldHVybnModWludCkgewogICAgICAgIEdvQm9hcmQgc3RvcmFnZSBib2FyZCA9IGFsbEJvYXJkc1tib2FyZElkXTsKICAgICAgICByZXR1cm4gKGJvYXJkLmJvYXJkQmFsYW5jZSk7CiAgICB9CgogICAgLy8vIEBkZXYgU2V0cyB0aGUgY3VycmVudCBiYWxhbmNlIG9mIHRoZSBib2FyZCwgdGhpcyBpcyBpbnRlcm5hbCBhbmQgaXMgdHJpZ2dlcnJlZCBieSBmdW5jdGlvbnMgcnVuIGJ5IGV4dGVybmFsIHBsYXllciBhY3Rpb25zCiAgICAvLy8gQHBhcmFtIGJvYXJkIFRoZSBib2FyZCB0byB1cGRhdGUKICAgIC8vLyBAcGFyYW0gYm9hcmRJZCBUaGUgYm9hcmQncyBJZAogICAgLy8vIEBwYXJhbSBuZXdTdGF0dXMgVGhlIG5ldyBzdGF0dXMgdG8gc2V0CiAgICBmdW5jdGlvbiB1cGRhdGVCb2FyZFN0YXR1cyhHb0JvYXJkIHN0b3JhZ2UgYm9hcmQsIHVpbnQgYm9hcmRJZCwgQm9hcmRTdGF0dXMgbmV3U3RhdHVzKSBpbnRlcm5hbCB7ICAgIAogICAgICAgIAogICAgICAgIC8vIFNhdmUgZ2FzIGlmIHdlIGFjY2lkZW50YWxseSBhcmUgdHJ5aW5nIHRvIHVwZGF0ZSB0byBhbiBleGlzdGluZyB1cGRhdGUKICAgICAgICBpZiAobmV3U3RhdHVzICE9IGJvYXJkLnN0YXR1cykgewogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU2V0IHRoZSBuZXcgYm9hcmQgc3RhdHVzCiAgICAgICAgICAgIGJvYXJkLnN0YXR1cyA9IG5ld1N0YXR1czsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFVwZGF0ZSB0aGUgdGltZSAoaW1wb3J0YW50IGZvciBzdGFydCBhbmQgZmluaXNoIHN0YXRlcykKICAgICAgICAgICAgYm9hcmQubGFzdFVwZGF0ZSA9IG5vdzsKCiAgICAgICAgICAgIC8vIElmIHRoaXMgaXMgYW4gZW5kIGdhbWUgc3RhdHVzCiAgICAgICAgICAgIGlmIChpc0VuZEdhbWVTdGF0dXMobmV3U3RhdHVzKSkgewoKICAgICAgICAgICAgICAgIC8vIENyZWRpdCB0aGUgcGxheWVycyBhY2NvcmlkaW5nIHRvIHRoZSBib2FyZCBzY29yZQogICAgICAgICAgICAgICAgY3JlZGl0Qm9hcmRHYW1lUmV2ZW51ZXMoYm9hcmQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBOb3RpZnkgc3RhdHVzIHVwZGF0ZQogICAgICAgICAgICBCb2FyZFN0YXR1c1VwZGF0ZWQoYm9hcmRJZCwgbmV3U3RhdHVzKTsKICAgICAgICB9CiAgICB9CgogICAgLy8vIEBkZXYgT3ZlcmxvYWQgdG8gc2V0IHRoZSBib2FyZCBzdGF0dXMgd2hlbiB3ZSBvbmx5IGhhdmUgYSBib2FyZElkCiAgICAvLy8gQHBhcmFtIGJvYXJkSWQgVGhlIGJvYXJkSWQgdG8gdXBkYXRlCiAgICAvLy8gQHBhcmFtIG5ld1N0YXR1cyBUaGUgbmV3IHN0YXR1cyB0byBzZXQKICAgIGZ1bmN0aW9uIHVwZGF0ZUJvYXJkU3RhdHVzKHVpbnQgYm9hcmRJZCwgQm9hcmRTdGF0dXMgbmV3U3RhdHVzKSBpbnRlcm5hbCB7CiAgICAgICAgdXBkYXRlQm9hcmRTdGF0dXMoYWxsQm9hcmRzW2JvYXJkSWRdLCBib2FyZElkLCBuZXdTdGF0dXMpOwogICAgfQoKICAgIC8vLyBAZGV2IEdldHMgdGhlIHBsYXllciBjb2xvciBnaXZlbiBhbiBhZGRyZXNzIGFuZCBib2FyZCAob3ZlcmxvYWQgZm9yIHdoZW4gd2Ugb25seSBoYXZlIGJvYXJkSWQpCiAgICAvLy8gQHBhcmFtIGJvYXJkSWQgVGhlIGJvYXJkSWQgdG8gY2hlY2sKICAgIC8vLyBAcGFyYW0gc2VhcmNoQWRkcmVzcyBUaGUgcGxheWVyJ3MgYWRkcmVzcyB3ZSBhcmUgc2VhcmNoaW5nIGZvcgogICAgLy8vIEByZXR1cm4gdGhlIHBsYXllcidzIGNvbG9yCiAgICBmdW5jdGlvbiBnZXRQbGF5ZXJDb2xvcih1aW50IGJvYXJkSWQsIGFkZHJlc3Mgc2VhcmNoQWRkcmVzcykgaW50ZXJuYWwgdmlldyByZXR1cm5zIChQbGF5ZXJDb2xvcikgewogICAgICAgIHJldHVybiAoZ2V0UGxheWVyQ29sb3IoYWxsQm9hcmRzW2JvYXJkSWRdLCBzZWFyY2hBZGRyZXNzKSk7CiAgICB9CiAgICAKICAgIC8vLyBAZGV2IEdldHMgdGhlIHBsYXllciBjb2xvciBnaXZlbiBhbiBhZGRyZXNzIGFuZCBib2FyZAogICAgLy8vIEBwYXJhbSBib2FyZCBUaGUgYm9hcmQgdG8gY2hlY2sKICAgIC8vLyBAcGFyYW0gc2VhcmNoQWRkcmVzcyBUaGUgcGxheWVyJ3MgYWRkcmVzcyB3ZSBhcmUgc2VhcmNoaW5nIGZvcgogICAgLy8vIEByZXR1cm4gdGhlIHBsYXllcidzIGNvbG9yCiAgICBmdW5jdGlvbiBnZXRQbGF5ZXJDb2xvcihHb0JvYXJkIHN0b3JhZ2UgYm9hcmQsIGFkZHJlc3Mgc2VhcmNoQWRkcmVzcykgaW50ZXJuYWwgdmlldyByZXR1cm5zIChQbGF5ZXJDb2xvcikgewoKICAgICAgICAvLyBDaGVjayBpZiB0aGlzIGlzIHRoZSBibGFjayBwbGF5ZXIKICAgICAgICBpZiAoYm9hcmQuYmxhY2tBZGRyZXNzID09IHNlYXJjaEFkZHJlc3MpIHsKICAgICAgICAgICAgcmV0dXJuIChQbGF5ZXJDb2xvci5CbGFjayk7CiAgICAgICAgfQoKICAgICAgICAvLyBDaGVjayBpZiB0aGlzIGlzIHRoZSB3aGl0ZSBwbGF5ZXIKICAgICAgICBpZiAoYm9hcmQud2hpdGVBZGRyZXNzID09IHNlYXJjaEFkZHJlc3MpIHsKICAgICAgICAgICAgcmV0dXJuIChQbGF5ZXJDb2xvci5XaGl0ZSk7CiAgICAgICAgfQoKICAgICAgICAvLyBXZSBhcmVuJ3Qgc3VwcG9zZSB0byB0cnkgYW5kIGdldCB0aGUgY29sb3Igb2YgYSBwbGF5ZXIgaWYgdGhleSBhcmVuJ3Qgb24gdGhlIGJvYXJkCiAgICAgICAgcmV2ZXJ0KCk7CiAgICB9CgogICAgLy8vIEBkZXYgR2V0cyB0aGUgcGxheWVyIGFkZHJlc3MgZ2l2ZW4gYSBjb2xvciBvbiB0aGUgYm9hcmQKICAgIC8vLyBAcGFyYW0gYm9hcmRJZCBUaGUgYm9hcmQgdG8gY2hlY2sKICAgIC8vLyBAcGFyYW0gY29sb3IgVGhlIGNvbG9yIG9mIHRoZSBwbGF5ZXIgd2Ugd2FudAogICAgLy8vIEByZXR1cm4gdGhlIHBsYXllcidzIGFkZHJlc3MKICAgIGZ1bmN0aW9uIGdldFBsYXllckFkZHJlc3ModWludCBib2FyZElkLCBQbGF5ZXJDb2xvciBjb2xvcikgcHVibGljIHZpZXcgcmV0dXJucyhhZGRyZXNzKSB7CgogICAgICAgIC8vIElmIGl0J3MgdGhlIGJsYWNrIHBsYXllcgogICAgICAgIGlmIChjb2xvciA9PSBQbGF5ZXJDb2xvci5CbGFjaykgewogICAgICAgICAgICByZXR1cm4gYWxsQm9hcmRzW2JvYXJkSWRdLmJsYWNrQWRkcmVzczsKICAgICAgICB9CgogICAgICAgIC8vIElmIGl0J3MgdGhlIHdoaXRlIHBsYXllcgogICAgICAgIGlmIChjb2xvciA9PSBQbGF5ZXJDb2xvci5XaGl0ZSkgewogICAgICAgICAgICByZXR1cm4gYWxsQm9hcmRzW2JvYXJkSWRdLndoaXRlQWRkcmVzczsKICAgICAgICB9CgogICAgICAgIC8vIFdlIGFyZW4ndCBzdXBwb3NlIHRvIHRyeSBhbmQgZ2V0IHRoZSBjb2xvciBvZiBhIHBsYXllciBpZiB0aGV5IGFyZW4ndCBvbiB0aGUgYm9hcmQKICAgICAgICByZXZlcnQoKTsKICAgIH0KCiAgICAvLy8gQGRldiBDaGVjayBpZiBhIHBsYXllciBpcyBvbiBib2FyZCAob3ZlcmxvYWQgZm9yIGJvYXJkSWQpCiAgICAvLy8gQHBhcmFtIGJvYXJkSWQgVGhlIGJvYXJkIHRvIGNoZWNrCiAgICAvLy8gQHBhcmFtIHNlYXJjaEFkZHJlc3MgdGhlIHBsYXllcidzIGFkZHJlc3Mgd2Ugd2FudCB0byBjaGVjawogICAgLy8vIEByZXR1cm4gdHJ1ZSBpZiB0aGUgcGxheWVyIGlzIHBsYXlpbmcgaW4gdGhlIGJvYXJkCiAgICBmdW5jdGlvbiBpc1BsYXllck9uQm9hcmQodWludCBib2FyZElkLCBhZGRyZXNzIHNlYXJjaEFkZHJlc3MpIHB1YmxpYyB2aWV3IHJldHVybnMoYm9vbCkgewogICAgICAgIHJldHVybiAoaXNQbGF5ZXJPbkJvYXJkKGFsbEJvYXJkc1tib2FyZElkXSwgc2VhcmNoQWRkcmVzcykpOwogICAgfQoKICAgIC8vLyBAZGV2IENoZWNrIGlmIGEgcGxheWVyIGlzIG9uIGJvYXJkCiAgICAvLy8gQHBhcmFtIGJvYXJkIFRoZSBib2FyZCB0byBjaGVjawogICAgLy8vIEBwYXJhbSBzZWFyY2hBZGRyZXNzIHRoZSBwbGF5ZXIncyBhZGRyZXNzIHdlIHdhbnQgdG8gY2hlY2sKICAgIC8vLyBAcmV0dXJuIHRydWUgaWYgdGhlIHBsYXllciBpcyBwbGF5aW5nIGluIHRoZSBib2FyZAogICAgZnVuY3Rpb24gaXNQbGF5ZXJPbkJvYXJkKEdvQm9hcmQgc3RvcmFnZSBib2FyZCwgYWRkcmVzcyBzZWFyY2hBZGRyZXNzKSBwcml2YXRlIHZpZXcgcmV0dXJucyhib29sKSB7CiAgICAgICAgcmV0dXJuIChib2FyZC5ibGFja0FkZHJlc3MgPT0gc2VhcmNoQWRkcmVzcyB8fCBib2FyZC53aGl0ZUFkZHJlc3MgPT0gc2VhcmNoQWRkcmVzcyk7CiAgICB9CgogICAgLy8vIEBkZXYgQ2hlY2sgd2hpY2ggcGxheWVyIGFjdHMgbmV4dAogICAgLy8vIEBwYXJhbSBib2FyZElkIFRoZSBib2FyZCB0byBjaGVjawogICAgLy8vIEByZXR1cm4gVGhlIGNvbG9yIG9mIHRoZSBjdXJyZW50IHBsYXllciB0byBhY3QKICAgIGZ1bmN0aW9uIGdldE5leHRUdXJuQ29sb3IodWludCBib2FyZElkKSBwdWJsaWMgdmlldyByZXR1cm5zKFBsYXllckNvbG9yKSB7CiAgICAgICAgcmV0dXJuIGFsbEJvYXJkc1tib2FyZElkXS5uZXh0VHVybkNvbG9yOwogICAgfQoKICAgIC8vLyBAbm90aWNlIFRoaXMgaXMgdGhlIGZpcnN0IGZ1bmN0aW9uIGEgcGxheWVyIHdpbGwgYmUgdXNpbmcgaW4gb3JkZXIgdG8gc3RhcnQgcGxheWluZy4gVGhpcyBmdW5jdGlvbiBhbGxvd3MgCiAgICAvLy8gIHRvIHJlZ2lzdGVyIHRvIGFuIGV4aXN0aW5nIG9yIGEgbmV3IGJvYXJkLCBkZXBlbmRpbmcgb24gdGhlIGN1cnJlbnQgYXZhaWxhYmxlIGJvYXJkcy4KICAgIC8vLyAgVXBvbiByZWdpc3RlcmF0aW9uIHRoZSBwbGF5ZXIgd2lsbCBwYXkgdGhlIGJvYXJkJ3Mgc3Rha2VzIGFuZCB3aWxsIGJlIHRoZSBibGFjayBvciB3aGl0ZSBwbGF5ZXIuCiAgICAvLy8gIFRoZSBibGFjayBwbGF5ZXIgYWxzbyBjcmVhdGVzIHRoZSBib2FyZCwgYW5kIGlzIHRoZSBmaXJzdCBwbGF5ZXIgd2hpY2ggZ2l2ZXMgYSBzbWFsbCBhZHZhbnRhZ2UgaW4gdGhlCiAgICAvLy8gIGdhbWUsIHRoZXJlZm9yZSB3ZSBkZWNpZGVkIHRoYXQgdGhlIGJsYWNrIHBsYXllciB3aWxsIGJlIHRoZSBvbmUgcGF5aW5nIGZvciB0aGUgYWRkaXRpb25hbCBnYXMKICAgIC8vLyAgdGhhdCBpcyByZXF1aXJlZCB0byBjcmVhdGUgdGhlIGJvYXJkLgogICAgLy8vIEBwYXJhbSAgdGFibGVTdGFrZXMgVGhlIHRhYmxlc3Rha2VzIHRvIHVzZSwgYWx0aG91Z2ggdGhpcyBhcHBlYXJzIGluIHRoZSAidmFsdWUiIG9mIHRoZSBtZXNzYWdlLCB3ZSBwcmVmZXJyZWQgdG8KICAgIC8vLyAgYWRkIGl0IGFzIGFuIGFkZGl0aW9uYWwgcGFyYW1ldGVyIGZvciBjbGllbnQgdXNlIGZvciBjbGllbnRzIHRoYXQgYWxsb3cgdG8gY3VzdG9taXplIHRoZSB2YWx1ZSBwYXJhbWV0ZXIuCiAgICAvLy8gQHJldHVybiBUaGUgYm9hcmRJZCB0aGUgcGxheWVyIHJlZ2lzdGVyZWQgdG8gKGVpdGhlciBhIG5ldyBib2FyZCBvciBhbiBleGlzdGluZyBib2FyZCkKICAgIGZ1bmN0aW9uIHJlZ2lzdGVyUGxheWVyVG9Cb2FyZCh1aW50IHRhYmxlU3Rha2VzKSBleHRlcm5hbCBwYXlhYmxlIGFsbG93ZWRWYWx1ZXNPbmx5KG1zZy52YWx1ZSkgd2hlbk5vdFBhdXNlZCByZXR1cm5zKHVpbnQpIHsKICAgICAgICAvLyBNYWtlIHN1cmUgdGhlIHZhbHVlIGFuZCB0YWJsZVN0YWtlcyBhcmUgdGhlIHNhbWUKICAgICAgICByZXF1aXJlIChtc2cudmFsdWUgPT0gdGFibGVTdGFrZXMpOwogICAgICAgIEdvQm9hcmQgc3RvcmFnZSBib2FyZFRvSm9pbjsKICAgICAgICB1aW50IGJvYXJkSURUb0pvaW47CiAgICAgICAgCiAgICAgICAgLy8gQ2hlY2sgd2hpY2ggYm9hcmQgdG8gY29ubmVjdCB0bwogICAgICAgIChib2FyZElEVG9Kb2luLCBib2FyZFRvSm9pbikgPSBnZXRPckNyZWF0ZVdhaXRpbmdCb2FyZCh0YWJsZVN0YWtlcyk7CiAgICAgICAgCiAgICAgICAgLy8gQWRkIHRoZSBwbGF5ZXIgdG8gdGhlIGJvYXJkICh0aGV5IGFscmVhZHkgcGFpZCkKICAgICAgICBib29sIHNob3VsZFN0YXJ0R2FtZSA9IGFkZFBsYXllclRvQm9hcmQoYm9hcmRUb0pvaW4sIHRhYmxlU3Rha2VzKTsKCiAgICAgICAgLy8gRmlyZSB0aGUgZXZlbnQgZm9yIGFueW9uZSBsaXN0ZW5pbmcKICAgICAgICBQbGF5ZXJBZGRlZFRvQm9hcmQoYm9hcmRJRFRvSm9pbiwgbXNnLnNlbmRlcik7CgogICAgICAgIC8vIElmIHdlIGhhdmUgYm90aCBwbGF5ZXJzLCBzdGFydCB0aGUgZ2FtZQogICAgICAgIGlmIChzaG91bGRTdGFydEdhbWUpIHsKCiAgICAgICAgICAgIC8vIFN0YXJ0IHRoZSBnYW1lCiAgICAgICAgICAgIHN0YXJ0Qm9hcmRHYW1lKGJvYXJkVG9Kb2luLCBib2FyZElEVG9Kb2luKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBib2FyZElEVG9Kb2luOwogICAgfQoKICAgIC8vLyBAbm90aWNlIFRoaXMgZnVuY3Rpb24gYWxsb3dzIGEgcGxheWVyIHRvIGNhbmNlbCBhIG1hdGNoIGluIHRoZSBjYXNlIHRoZXkgd2VyZSB3YWl0aW5nIGZvciBhbiBvcHBvbmVudCBmb3IKICAgIC8vLyAgYSBsb25nIHRpbWUgYnV0IGRpZG4ndCBmaW5kIGFueW9uZSBhbmQgd291bGQgd2FudCB0byBnZXQgdGhlaXIgZGVwb3NpdCBvZiB0YWJsZSBzdGFrZXMgYmFjay4KICAgIC8vLyAgVGhhdCBwbGF5ZXIgbWF5IGNhbmNlbCB0aGUgZ2FtZSBhcyBsb25nIGFzIG5vIG9wcG9uZW50IHdhcyBmb3VuZCBhbmQgdGhlIGRlcG9zaXQgd2lsbCBiZSByZXR1cm5lZCBpbiBmdWxsICh0aG91Z2ggZ2FzIGZlZXMgc3RpbGwgYXBwbHkpLiBUaGUgcGxheWVyIHdpbGwgYWxzbyBuZWVkIHRvIHdpdGhkcmF3IGZ1bmRzIGZyb20gdGhlIGNvbnRyYWN0IGFmdGVyIHRoaXMgYWN0aW9uLgogICAgLy8vIEBwYXJhbSBib2FyZElkIFRoZSBib2FyZCB0byBjYW5jZWwKICAgIGZ1bmN0aW9uIGNhbmNlbE1hdGNoKHVpbnQgYm9hcmRJZCkgZXh0ZXJuYWwgewogICAgICAgIAogICAgICAgIC8vIEdldCB0aGUgcGxheWVyCiAgICAgICAgR29Cb2FyZCBzdG9yYWdlIGJvYXJkID0gYWxsQm9hcmRzW2JvYXJkSWRdOwoKICAgICAgICAvLyBNYWtlIHN1cmUgdGhpcyBwbGF5ZXIgaXMgb24gYm9hcmQKICAgICAgICByZXF1aXJlKGlzUGxheWVyT25Cb2FyZChib2FyZElkLCBtc2cuc2VuZGVyKSk7CgogICAgICAgIC8vIE1ha2Ugc3VyZSB0aGF0IHRoZSBnYW1lIGhhc24ndCBzdGFydGVkCiAgICAgICAgcmVxdWlyZShib2FyZC5zdGF0dXMgPT0gQm9hcmRTdGF0dXMuV2FpdEZvck9wcG9uZW50KTsKCiAgICAgICAgLy8gVXBkYXRlIHRoZSBib2FyZCBzdGF0dXMgdG8gY2FuY2VsICh3aGljaCBhbHNvIHRyaWdnZXJzIHRoZSByZXZlbnVlIHNoYXJpbmcgZnVuY3Rpb24pCiAgICAgICAgdXBkYXRlQm9hcmRTdGF0dXMoYm9hcmQsIGJvYXJkSWQsIEJvYXJkU3RhdHVzLkNhbmNlbGVkKTsKICAgIH0KCiAgICAvLy8gQGRldiBHZXRzIHRoZSBjdXJyZW50IHBsYXllciBib2FyZHMgdG8gcHJlc2VudCB0byB0aGUgcGxheWVyIGFzIG5lZWRlZAogICAgLy8vIEBwYXJhbSBhY3RpdmVUdXJuc09ubHkgV2UgbWlnaHQgd2FudCB0byBoaWdobGlnaHQgdGhlIGJvYXJkcyB3aGVyZSB0aGUgcGxheWVyIGlzIGV4cGVjdGVkIHRvIGFjdAogICAgLy8vIEByZXR1cm4gYW4gYXJyYXkgb2YgUEFHRV9TSVpFIHdpdGggdGhlIG51bWJlciBvZiBib2FyZHMgZm91bmQgYW5kIHRoZSBhY3R1YWwgSURzCiAgICBmdW5jdGlvbiBnZXRQbGF5ZXJCb2FyZHNJRHMoYm9vbCBhY3RpdmVUdXJuc09ubHkpIHB1YmxpYyB2aWV3IHJldHVybnMgKHVpbnQsIHVpbnRbUEFHRV9TSVpFXSkgewogICAgICAgIHVpbnRbUEFHRV9TSVpFXSBtZW1vcnkgcGxheWVyQm9hcmRJRHNUb1JldHVybjsKICAgICAgICB1aW50IG51bWJlck9mUGxheWVyQm9hcmRzVG9SZXR1cm4gPSAwOwogICAgICAgIAogICAgICAgIC8vIExvb2sgYXQgdGhlIHJlY2VudCBib2FyZHMgdW50aWwgeW91IGZpbmQgYSBwbGF5ZXIgYm9hcmQKICAgICAgICBmb3IgKHVpbnQgY3VyckJvYXJkID0gYWxsQm9hcmRzLmxlbmd0aDsgY3VyckJvYXJkID4gMCAmJiBudW1iZXJPZlBsYXllckJvYXJkc1RvUmV0dXJuIDwgUEFHRV9TSVpFOyBjdXJyQm9hcmQtLSkgewogICAgICAgICAgICB1aW50IGJvYXJkSUQgPSBjdXJyQm9hcmQgLSAxOyAgICAgICAgICAgIAoKICAgICAgICAgICAgLy8gV2Ugb25seSBjYXJlIGFib3V0IGJvYXJkcyB0aGUgcGxheWVyIGlzIGluCiAgICAgICAgICAgIGlmIChpc1BsYXllck9uQm9hcmQoYm9hcmRJRCwgbXNnLnNlbmRlcikpIHsKCiAgICAgICAgICAgICAgICAvLyBDaGVjayBpZiB0aGUgcGxheWVyIGlzIHRoZSBuZXh0IHRvIGFjdCwgb3IganVzdCBpbmNsdWRlIGl0IGlmIGl0IHdhc24ndCByZXF1ZXN0ZWQKICAgICAgICAgICAgICAgIGlmICghYWN0aXZlVHVybnNPbmx5IHx8IGdldE5leHRUdXJuQ29sb3IoYm9hcmRJRCkgPT0gZ2V0UGxheWVyQ29sb3IoYm9hcmRJRCwgbXNnLnNlbmRlcikpIHsKICAgICAgICAgICAgICAgICAgICBwbGF5ZXJCb2FyZElEc1RvUmV0dXJuW251bWJlck9mUGxheWVyQm9hcmRzVG9SZXR1cm5dID0gYm9hcmRJRDsKICAgICAgICAgICAgICAgICAgICArK251bWJlck9mUGxheWVyQm9hcmRzVG9SZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiAobnVtYmVyT2ZQbGF5ZXJCb2FyZHNUb1JldHVybiwgcGxheWVyQm9hcmRJRHNUb1JldHVybik7CiAgICB9CgogICAgLy8vIEBkZXYgQ3JlYXRlcyBhIG5ldyBib2FyZCBpbiBjYXNlIG5vIGJvYXJkIHdhcyBmb3VuZCBmb3IgYSBwbGF5ZXIgdG8gcmVnaXN0ZXIKICAgIC8vLyBAcGFyYW0gdGFibGVTdGFrZXNUb1VzZSBUaGUgdmFsdWUgdXNlZCB0byBzZXQgdGhlIGJvYXJkCiAgICAvLy8gQHJldHVybiB0aGUgaWQgb2YgbmV3IGJvYXJkICh3aGljaCBpcyBpdCdzIHBvc2l0aW9uIGluIHRoZSBhbGxCb2FyZHMgYXJyYXkpCiAgICBmdW5jdGlvbiBjcmVhdGVOZXdHb0JvYXJkKHVpbnQgdGFibGVTdGFrZXNUb1VzZSkgcHJpdmF0ZSByZXR1cm5zKHVpbnQsIEdvQm9hcmQgc3RvcmFnZSkgewogICAgICAgIEdvQm9hcmQgbWVtb3J5IG5ld0JvYXJkID0gR29Cb2FyZCh7bGFzdFVwZGF0ZTogbm93LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXNIb25vcmFibGVMb3NzOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhYmxlU3Rha2VzOiB0YWJsZVN0YWtlc1RvVXNlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYm9hcmRCYWxhbmNlOiAwLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmxhY2tBZGRyZXNzOiAwLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpdGVBZGRyZXNzOiAwLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmxhY2tQZXJpb2RzUmVtYWluaW5nOiBQTEFZRVJfU1RBUlRfUEVSSU9EUywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoaXRlUGVyaW9kc1JlbWFpbmluZzogUExBWUVSX1NUQVJUX1BFUklPRFMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXh0VHVybkNvbG9yOiBQbGF5ZXJDb2xvci5Ob25lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdHVzOkJvYXJkU3RhdHVzLldhaXRGb3JPcHBvbmVudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpZFBhc3NQcmV2VHVybjpmYWxzZX0pOwoKICAgICAgICB1aW50IGJvYXJkSWQgPSBhbGxCb2FyZHMucHVzaChuZXdCb2FyZCkgLSAxOwogICAgICAgIHJldHVybiAoYm9hcmRJZCwgYWxsQm9hcmRzW2JvYXJkSWRdKTsKICAgIH0KCiAgICAvLy8gQGRldiBDcmVhdGVzIGEgbmV3IGJvYXJkIGluIGNhc2Ugbm8gYm9hcmQgd2FzIGZvdW5kIGZvciBhIHBsYXllciB0byByZWdpc3RlcgogICAgLy8vIEBwYXJhbSB0YWJsZVN0YWtlcyBUaGUgdmFsdWUgdXNlZCB0byBzZXQgdGhlIGJvYXJkCiAgICAvLy8gQHJldHVybiB0aGUgaWQgb2YgbmV3IGJvYXJkICh3aGljaCBpcyBpdCdzIHBvc2l0aW9uIGluIHRoZSBhbGxCb2FyZHMgYXJyYXkpCiAgICBmdW5jdGlvbiBnZXRPckNyZWF0ZVdhaXRpbmdCb2FyZCh1aW50IHRhYmxlU3Rha2VzKSBwcml2YXRlIHJldHVybnModWludCwgR29Cb2FyZCBzdG9yYWdlKSB7CiAgICAgICAgYm9vbCB3YXNGb3VuZCA9IGZhbHNlOwogICAgICAgIHVpbnQgc2VsZWN0ZWRCb2FyZElkID0gMDsKICAgICAgICBHb0JvYXJkIHN0b3JhZ2UgYm9hcmQ7CgogICAgICAgIC8vIEZpcnN0LCB0cnkgdG8gZmluZCBhIGJvYXJkIHRoYXQgaGFzIGFuIGVtcHR5IHNwb3QgYW5kIHRoZSByaWdodCB0YWJsZSBzdGFrZXMKICAgICAgICBmb3IgKHVpbnQgaSA9IGFsbEJvYXJkcy5sZW5ndGg7IGkgPiAwICYmICF3YXNGb3VuZDsgLS1pKSB7CiAgICAgICAgICAgIGJvYXJkID0gYWxsQm9hcmRzW2kgLSAxXTsKCiAgICAgICAgICAgIC8vIE1ha2Ugc3VyZSB0aGlzIGJvYXJkIGlzIGFscmVhZHkgd2FpdGluZyBhbmQgaXQncyBzdGFrZXMgYXJlIHRoZSBzYW1lCiAgICAgICAgICAgIGlmIChib2FyZC50YWJsZVN0YWtlcyA9PSB0YWJsZVN0YWtlcykgewogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBJZiB0aGlzIGJvYXJkIGlzIHdhaXRpbmcgZm9yIGFuIG9wcG9uZW50CiAgICAgICAgICAgICAgICBpZiAoYm9hcmQuc3RhdHVzID09IEJvYXJkU3RhdHVzLldhaXRGb3JPcHBvbmVudCkgewogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEF3ZXNvbWUsIHdlIGhhdmUgdGhlIGJvYXJkIGFuZCB3ZSBhcmUgZG9uZQogICAgICAgICAgICAgICAgICAgIHdhc0ZvdW5kID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZEJvYXJkSWQgPSBpIC0gMTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBJZiB3ZSBmb3VuZCB0aGUgcmlnaHRzIHN0YWtlcyBib2FyZCBidXQgaXQgaXNuJ3Qgd2FpdGluZyBmb3IgcGxheWVyIHdlIHdvbid0IGhhdmUgYW5vdGhlciBlbXB0eSBib2FyZC4KICAgICAgICAgICAgICAgIC8vIFdlIG5lZWQgdG8gY3JlYXRlIGEgbmV3IG9uZQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIENyZWF0ZSBhIG5ldyBib2FyZCBpZiB3ZSBjb3VsZG4ndCBmaW5kIG9uZQogICAgICAgIGlmICghd2FzRm91bmQpIHsKICAgICAgICAgICAgKHNlbGVjdGVkQm9hcmRJZCwgYm9hcmQpID0gY3JlYXRlTmV3R29Cb2FyZCh0YWJsZVN0YWtlcyk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gKHNlbGVjdGVkQm9hcmRJZCwgYm9hcmQpOwogICAgfQoKICAgIC8vLyBAZGV2IFN0YXJ0cyB0aGUgZ2FtZSBhbmQgc2V0cyBldmVyeXRoaW5nIHVwIGZvciB0aGUgbWF0Y2gKICAgIC8vLyBAcGFyYW0gYm9hcmQgVGhlIGJvYXJkIHRvIHVwZGF0ZSB3aXRoIHRoZSBzdGFydGluZyBkYXRhCiAgICAvLy8gQHBhcmFtIGJvYXJkSWQgVGhlIGJvYXJkJ3MgSWQKICAgIGZ1bmN0aW9uIHN0YXJ0Qm9hcmRHYW1lKEdvQm9hcmQgc3RvcmFnZSBib2FyZCwgdWludCBib2FyZElkKSBwcml2YXRlIHsKICAgICAgICAKICAgICAgICAvLyBNYWtlIHN1cmUgYm90aCBwbGF5ZXJzIGFyZSBwcmVzZW50CiAgICAgICAgcmVxdWlyZShib2FyZC5ibGFja0FkZHJlc3MgIT0gMCAmJiBib2FyZC53aGl0ZUFkZHJlc3MgIT0gMCk7CiAgICAgICAgCiAgICAgICAgLy8gVGhlIGJsYWNrIGlzIGFsd2F5cyB0aGUgZmlyc3QgcGxheWVyIGluIEdPCiAgICAgICAgYm9hcmQubmV4dFR1cm5Db2xvciA9IFBsYXllckNvbG9yLkJsYWNrOwoKICAgICAgICAvLyBTYXZlIHRoZSBnYW1lIHN0YXJ0IHRpbWUgYW5kIHNldCB0aGUgZ2FtZSBzdGF0dXMgdG8gaW4gcHJvZ3Jlc3MKICAgICAgICB1cGRhdGVCb2FyZFN0YXR1cyhib2FyZCwgYm9hcmRJZCwgQm9hcmRTdGF0dXMuSW5Qcm9ncmVzcyk7CiAgICB9CgogICAgLy8vIEBkZXYgSGFuZGxlcyB0aGUgcmVnaXN0cmF0aW9uIG9mIGEgcGxheWVyIHRvIGEgYm9hcmQKICAgIC8vLyBAcGFyYW0gYm9hcmQgVGhlIGJvYXJkIHRvIHVwZGF0ZSB3aXRoIHRoZSBzdGFydGluZyBkYXRhCiAgICAvLy8gQHBhcmFtIHBhaWRBbW91bnQgVGhlIGFtb3VudCB0aGUgcGxheWVyIHBhaWQgdG8gc3RhcnQgcGxheWluZyAod2lsbCBiZSBhZGRlZCB0byB0aGUgYm9hcmQgYmFsYW5jZSkKICAgIC8vLyBAcmV0dXJuIHRydWUgaWYgdGhlIGdhbWUgc2hvdWxkIGJlIHN0YXJ0ZWQKICAgIGZ1bmN0aW9uIGFkZFBsYXllclRvQm9hcmQoR29Cb2FyZCBzdG9yYWdlIGJvYXJkLCB1aW50IHBhaWRBbW91bnQpIHByaXZhdGUgcmV0dXJucyhib29sKSB7CiAgICAgICAgCiAgICAgICAgLy8gTWFrZSBzdWV3IHdlIGFyZSBzdGlsbCB3YWl0aW5mIGZvciBvcHBvbmVudCAob3RoZXJ3aXNlIHdlIGNhbid0IGFkZCBwbGF5ZXJzKQogICAgICAgIGJvb2wgc2hvdWxkU3RhcnRUaGVHYW1lID0gZmFsc2U7CiAgICAgICAgcmVxdWlyZShib2FyZC5zdGF0dXMgPT0gQm9hcmRTdGF0dXMuV2FpdEZvck9wcG9uZW50KTsKCiAgICAgICAgLy8gQ2hlY2sgdGhhdCB0aGUgcGxheWVyIGlzbid0IGFscmVhZHkgb24gdGhlIGJvYXJkLCBvdGhlcndpc2UgdGhleSB3b3VsZCBwYXkgdHdpY2UgZm9yIGEgc2luZ2xlIGJvYXJkLi4uIDooIAogICAgICAgIHJlcXVpcmUoIWlzUGxheWVyT25Cb2FyZChib2FyZCwgbXNnLnNlbmRlcikpOwoKICAgICAgICAvLyBXZSBhbHdheXMgYWRkIHRoZSBibGFjayBwbGF5ZXIgZmlyc3QgYXMgdGhleSBjcmVhdGVkIHRoZSBib2FyZAogICAgICAgIGlmIChib2FyZC5ibGFja0FkZHJlc3MgPT0gMCkgewogICAgICAgICAgICBib2FyZC5ibGFja0FkZHJlc3MgPSBtc2cuc2VuZGVyOwogICAgICAgIAogICAgICAgIC8vIElmIHdlIGhhdmUgYSBibGFjayBwbGF5ZXIsIGFkZCB0aGUgd2hpdGUgcGxheWVyCiAgICAgICAgfSBlbHNlIGlmIChib2FyZC53aGl0ZUFkZHJlc3MgPT0gMCkgewogICAgICAgICAgICBib2FyZC53aGl0ZUFkZHJlc3MgPSBtc2cuc2VuZGVyOwogICAgICAgIAogICAgICAgICAgICAvLyBPbmNlIHRoZSB3aGl0ZSBwbGF5ZXIgaGFzIGJlZW4gYWRkZWQsIHdlIGNhbiBzdGFydCB0aGUgbWF0Y2gKICAgICAgICAgICAgc2hvdWxkU3RhcnRUaGVHYW1lID0gdHJ1ZTsgICAgICAgICAgIAoKICAgICAgICAvLyBJZiBib3RoIGFkZHJlc3NlcyBhcmUgb2NjdWlwaWVkIGFuZCB3ZSBnb3QgaGVyZSwgaXQncyBhIHByb2JsZW0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXZlcnQoKTsKICAgICAgICB9CgogICAgICAgIC8vIENyZWRpdCB0aGUgYm9hcmQgd2l0aCB3aGF0IHdlIGtub3cgCiAgICAgICAgYm9hcmQuYm9hcmRCYWxhbmNlICs9IHBhaWRBbW91bnQ7CgogICAgICAgIHJldHVybiBzaG91bGRTdGFydFRoZUdhbWU7CiAgICB9CgogICAgLy8vIEBkZXYgSGVscGVyIGZ1bmN0aW9uIHRvIGNhY2x1bGF0ZSBob3cgbXVjaCB0aW1lIGEgcGxheWVyIHVzZWQgc2luY2Ugbm93CiAgICAvLy8gQHBhcmFtIGxhc3RVcGRhdGUgdGhlIHRpbWVzdGFtcCBvZiBsYXN0IHVwZGF0ZSBvZiB0aGUgYm9hcmQKICAgIC8vLyBAcmV0dXJuIHRoZSBudW1iZXIgb2YgcGVyaW9kcyB1c2VkIGZvciB0aGlzIHRpbWUKICAgIGZ1bmN0aW9uIGdldFRpbWVQZXJpb2RzVXNlZCh1aW50IGxhc3RVcGRhdGUpIHByaXZhdGUgdmlldyByZXR1cm5zKHVpbnQ4KSB7CiAgICAgICAgcmV0dXJuIHVpbnQ4KG5vdy5zdWIobGFzdFVwZGF0ZSkuZGl2KFBMQVlFUl9UVVJOX1NJTkdMRV9QRVJJT0QpKTsKICAgIH0KCiAgICAvLy8gQG5vdGljZSBDb252aW5pZW5jZSBmdW5jdGlvbiB0byBoZWxwIHByZXNlbnQgaG93IG11Y2ggdGltZSBhIHBsYXllciBoYXMuCiAgICAvLy8gQHBhcmFtIGJvYXJkSWQgdGhlIGJvYXJkIHRvIGNoZWNrLgogICAgLy8vIEBwYXJhbSBjb2xvciB0aGUgY29sb3Igb2YgdGhlIHBsYXllciB0byBjaGVjay4KICAgIC8vLyBAcmV0dXJuIFRoZSBudW1iZXIgb2YgdGltZSBwZXJpb2RzIHRoZSBwbGF5ZXIgaGFzLCB0aGUgbnVtYmVyIG9mIHNlY29uZHMgcGVyIGVhY2ggcGVyaW9kIGFuZCB0aGUgdG90YWwgbnVtYmVyIG9mIHNlY29uZHMgZm9yIGNvbnZpbmllbmNlLgogICAgZnVuY3Rpb24gZ2V0UGxheWVyUmVtYWluaW5nVGltZSh1aW50IGJvYXJkSWQsIFBsYXllckNvbG9yIGNvbG9yKSB2aWV3IGV4dGVybmFsIHJldHVybnMgKHVpbnQsIHVpbnQsIHVpbnQpIHsKICAgICAgICBHb0JvYXJkIHN0b3JhZ2UgYm9hcmQgPSBhbGxCb2FyZHNbYm9hcmRJZF07CgogICAgICAgIC8vIEFsd2F5cyB2ZXJpZnkgd2UgY2FuIGFjdAogICAgICAgIHJlcXVpcmUoYm9hcmQuc3RhdHVzID09IEJvYXJkU3RhdHVzLkluUHJvZ3Jlc3MpOwoKICAgICAgICAvLyBHZXQgdGhlIHRvdGFsIHJlbWFpbmluZyB0aW1lOgogICAgICAgIHVpbnQgdGltZVBlcmlvZHMgPSBnZXRQbGF5ZXJUaW1lUGVyaW9kcyhib2FyZCwgY29sb3IpOwogICAgICAgIHVpbnQgdG90YWxUaW1lUmVtYWluaW5nID0gdGltZVBlcmlvZHMgKiBQTEFZRVJfVFVSTl9TSU5HTEVfUEVSSU9EOwoKICAgICAgICAvLyBJZiB0aGlzIGlzIHRoZSBhY3RpbmcgcGxheWVyCiAgICAgICAgaWYgKGNvbG9yID09IGJvYXJkLm5leHRUdXJuQ29sb3IpIHsKCiAgICAgICAgICAgIC8vIENhbGMgdGltZSBwZXJpb2RzIGZvciBwbGF5ZXIKICAgICAgICAgICAgdWludCB0aW1lUGVyaW9kc1VzZWQgPSBnZXRUaW1lUGVyaW9kc1VzZWQoYm9hcmQubGFzdFVwZGF0ZSk7CiAgICAgICAgICAgIGlmICh0aW1lUGVyaW9kcyA+IHRpbWVQZXJpb2RzVXNlZCkgewogICAgICAgICAgICAgICAgdGltZVBlcmlvZHMgLT0gdGltZVBlcmlvZHNVc2VkOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGltZVBlcmlvZHMgPSAwOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBDYWxjIHRvdGFsIHRpbWUgcmVtYWluaW5nICBmb3IgcGxheWVyCiAgICAgICAgICAgIHVpbnQgdGltZVVzZWQgPSAobm93IC0gYm9hcmQubGFzdFVwZGF0ZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTYWZlbHkgcmVkdWNlIHRoZSB0aW1lIHVzZWQKICAgICAgICAgICAgaWYgKHRvdGFsVGltZVJlbWFpbmluZyA+IHRpbWVVc2VkKSB7CiAgICAgICAgICAgICAgICB0b3RhbFRpbWVSZW1haW5pbmcgLT0gdGltZVVzZWQ7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBIHBsYXllciBjYW4ndCBoYXZlIGxlc3MgdGhhbiB6ZXJvIHRpbWUgdG8gYWN0CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0b3RhbFRpbWVSZW1haW5pbmcgPSAwOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHJldHVybiAodGltZVBlcmlvZHMsIFBMQVlFUl9UVVJOX1NJTkdMRV9QRVJJT0QsIHRvdGFsVGltZVJlbWFpbmluZyk7CiAgICB9CgogICAgLy8vIEBkZXYgQWZ0ZXIgYSBwbGF5ZXIgYWN0ZWQgd2UgbWlnaHQgbmVlZCB0byByZWR1Y2UgdGhlIG51bWJlciBvZiByZW1haW5pbmcgdGltZSBwZXJpb2RzLgogICAgLy8vIEBwYXJhbSBib2FyZCBUaGUgYm9hcmQgdGhlIHBsYXllciBhY3RlZCB1cG9uLgogICAgLy8vIEBwYXJhbSBjb2xvciB0aGUgY29sb3Igb2YgdGhlIHBsYXllciB0aGF0IGFjdGVkLgogICAgLy8vIEBwYXJhbSB0aW1lUGVyaW9kc1VzZWQgdGhlIG51bWJlciBvZiBwZXJpb2RzIHRoZSBwbGF5ZXIgdXNlZC4KICAgIGZ1bmN0aW9uIHVwZGF0ZVBsYXllclRpbWVQZXJpb2RzKEdvQm9hcmQgc3RvcmFnZSBib2FyZCwgUGxheWVyQ29sb3IgY29sb3IsIHVpbnQ4IHRpbWVQZXJpb2RzVXNlZCkgaW50ZXJuYWwgewoKICAgICAgICAvLyBSZWR1Y2UgZnJvbSB0aGUgYmxhY2sgcGxheWVyCiAgICAgICAgaWYgKGNvbG9yID09IFBsYXllckNvbG9yLkJsYWNrKSB7CgogICAgICAgICAgICAvLyBUaGUgcGxheWVyIGNhbid0IGhhdmUgbGVzcyB0aGFuIDAgcGVyaW9kcyByZW1haW5pbmcKICAgICAgICAgICAgYm9hcmQuYmxhY2tQZXJpb2RzUmVtYWluaW5nID0gYm9hcmQuYmxhY2tQZXJpb2RzUmVtYWluaW5nID4gdGltZVBlcmlvZHNVc2VkID8gYm9hcmQuYmxhY2tQZXJpb2RzUmVtYWluaW5nIC0gdGltZVBlcmlvZHNVc2VkIDogMDsKICAgICAgICAvLyBSZWR1Y2UgZnJvbSB0aGUgd2hpdGUgcGxheWVyCiAgICAgICAgfSBlbHNlIGlmIChjb2xvciA9PSBQbGF5ZXJDb2xvci5XaGl0ZSkgewogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVGhlIHBsYXllciBjYW4ndCBoYXZlIGxlc3MgdGhhbiAwIHBlcmlvZHMgcmVtYWluaW5nCiAgICAgICAgICAgIGJvYXJkLndoaXRlUGVyaW9kc1JlbWFpbmluZyA9IGJvYXJkLndoaXRlUGVyaW9kc1JlbWFpbmluZyA+IHRpbWVQZXJpb2RzVXNlZCA/IGJvYXJkLndoaXRlUGVyaW9kc1JlbWFpbmluZyAtIHRpbWVQZXJpb2RzVXNlZCA6IDA7CgogICAgICAgIC8vIFdlIGFyZSBub3Qgc3VwcG9zZWQgdG8gZ2V0IGhlcmUKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXZlcnQoKTsKICAgICAgICB9CiAgICB9CgogICAgLy8vIEBkZXYgSGVscGVyIGZ1bmN0aW9uIHRvIGFjY2VzcyB0aGUgdGltZSBwZXJpb2RzIG9mIGEgcGxheWVyIGluIGEgYm9hcmQuCiAgICAvLy8gQHBhcmFtIGJvYXJkIFRoZSBib2FyZCB0byBjaGVjay4KICAgIC8vLyBAcGFyYW0gY29sb3IgdGhlIGNvbG9yIG9mIHRoZSBwbGF5ZXIgdG8gY2hlY2suCiAgICAvLy8gQHJldHVybiBUaGUgbnVtYmVyIG9mIHRpbWUgcGVyaW9kcyByZW1haW5pbmcgZm9yIHRoaXMgcGxheWVyCiAgICBmdW5jdGlvbiBnZXRQbGF5ZXJUaW1lUGVyaW9kcyhHb0JvYXJkIHN0b3JhZ2UgYm9hcmQsIFBsYXllckNvbG9yIGNvbG9yKSBpbnRlcm5hbCB2aWV3IHJldHVybnMgKHVpbnQ4KSB7CgogICAgICAgIC8vIEZvciB0aGUgYmxhY2sgcGxheWVyCiAgICAgICAgaWYgKGNvbG9yID09IFBsYXllckNvbG9yLkJsYWNrKSB7CiAgICAgICAgICAgIHJldHVybiBib2FyZC5ibGFja1BlcmlvZHNSZW1haW5pbmc7CgogICAgICAgIC8vIEZvciB0aGUgd2hpdGUgcGxheWVyCiAgICAgICAgfSBlbHNlIGlmIChjb2xvciA9PSBQbGF5ZXJDb2xvci5XaGl0ZSkgewogICAgICAgICAgICByZXR1cm4gYm9hcmQud2hpdGVQZXJpb2RzUmVtYWluaW5nOwoKICAgICAgICAvLyBXZSBhcmUgbm90IHN1cHBvc2VkIHRvIGdldCBoZXJlCiAgICAgICAgfSBlbHNlIHsKCiAgICAgICAgICAgIHJldmVydCgpOwogICAgICAgIH0KICAgIH0KCiAgICAvLy8gQG5vdGljZSBUaGUgbWFpbiBmdW5jdGlvbiB0byBzcGxpdCBnYW1lIHJldmVudWVzLCB0aGlzIGlzIHRyaWdnZXJlZCBvbmx5IGJ5IGNoYW5naW5nIHRoZSBnYW1lJ3Mgc3RhdGUKICAgIC8vLyAgdG8gb25lIG9mIHRoZSBlbmRpbmcgZ2FtZSBzdGF0ZXMuCiAgICAvLy8gIFdlIG1ha2Ugc3VyZSB0aGlzIGJvYXJkIGhhcyBhIGJhbGFuY2UgYW5kIHRoYXQgaXQncyBvbmx5IHJ1bm5pbmcgb25jZSBhIGJvYXJkIGdhbWUgaGFzIGVuZGVkCiAgICAvLy8gIFdlIHVzZWQgbnVtYmVycyBmb3IgZWFzaWVyIHJlYWQgdGhyb3VnaCBhcyB0aGlzIGZ1bmN0aW9uIGlzIGNyaXRpY2FsIGZvciB0aGUgcmV2ZW51ZSBzaGFyaW5nIG1vZGVsCiAgICAvLy8gQHBhcmFtIGJvYXJkIFRoZSBib2FyZCB0aGUgY3JlZGl0IHdpbGwgY29tZSBmcm9tLgogICAgZnVuY3Rpb24gY3JlZGl0Qm9hcmRHYW1lUmV2ZW51ZXMoR29Cb2FyZCBzdG9yYWdlIGJvYXJkKSBwcml2YXRlIGJvYXJkR2FtZUVuZGVkKGJvYXJkKSBib2FyZE5vdFBhaWQoYm9hcmQpIHsKICAgICAgICAgICAgICAgIAogICAgICAgIC8vIEdldCB0aGUgc2hhcmVzIGZyb20gdGhlIGdsb2JhbHMKICAgICAgICB1aW50IHVwZGF0ZWRIb3N0U2hhcmUgPSBIT1NUX1NIQVJFOwogICAgICAgIHVpbnQgdXBkYXRlZExvc2VyU2hhcmUgPSAwOwoKICAgICAgICAvLyBTdGFydCBhY2N1bXVsYXRpbmcgZnVuZHMgZm9yIGVhY2ggcGFydGljaXBhbnQgYW5kIEV0aGVybmFsR28ncyBDRk8KICAgICAgICB1aW50IGFtb3VudEJsYWNrID0gMDsKICAgICAgICB1aW50IGFtb3VudFdoaXRlID0gMDsKICAgICAgICB1aW50IGFtb3VudENGTyA9IDA7CiAgICAgICAgdWludCBmdWxsQW1vdW50ID0gMTAwMDsKCiAgICAgICAgLy8gSW5jZW50aXZpemUgcmVzaWducyBhbmQgcXVpY2sgZW5kLWdhbWVzIGZvciB0aGUgbG9zZXIKICAgICAgICBpZiAoYm9hcmQuc3RhdHVzID09IEJvYXJkU3RhdHVzLkJsYWNrV2luIHx8IGJvYXJkLnN0YXR1cyA9PSBCb2FyZFN0YXR1cy5XaGl0ZVdpbikgewogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSW4gY2FzZSB0aGUgZ2FtZSBlbmRlZCBob25vcmFibHkgKG5vdCBieSB0aW1lIG91dCksIHRoZSBsb3NlciB3aWxsIGdldCBjcmVkaXQgKGZyb20gdGhlIENGTydzIHNoYXJlKQogICAgICAgICAgICBpZiAoYm9hcmQuaXNIb25vcmFibGVMb3NzKSB7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJlZHVjZSB0aGUgY3JlZGl0IGZyb20gdGhlIENGTwogICAgICAgICAgICAgICAgdXBkYXRlZEhvc3RTaGFyZSA9IEhPU1RfU0hBUkUgLSBIT05PUkFCTEVfTE9TU19CT05VUzsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQWRkIHRvIHRoZSBsb3NlciBzaGFyZQogICAgICAgICAgICAgICAgdXBkYXRlZExvc2VyU2hhcmUgPSBIT05PUkFCTEVfTE9TU19CT05VUzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gSWYgYmxhY2sgd29uCiAgICAgICAgICAgIGlmIChib2FyZC5zdGF0dXMgPT0gQm9hcmRTdGF0dXMuQmxhY2tXaW4pIHsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQmxhY2sgc2hvdWxkIGdldCB0aGUgd2lubmVyIHNoYXJlCiAgICAgICAgICAgICAgICBhbW91bnRCbGFjayA9IGJvYXJkLmJvYXJkQmFsYW5jZS5tdWwoV0lOTkVSX1NIQVJFKS5kaXYoZnVsbEFtb3VudCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFdoaXRlIHBsYXllciBzaG91bGQgZ2V0IHRoZSB1cGRhdGVkIGxvc2VyIHNoYXJlICh3aXRoIG9yIHdpdGhvdXQgdGhlIGJvbnVzKQogICAgICAgICAgICAgICAgYW1vdW50V2hpdGUgPSBib2FyZC5ib2FyZEJhbGFuY2UubXVsKHVwZGF0ZWRMb3NlclNoYXJlKS5kaXYoZnVsbEFtb3VudCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIElmIHdoaXRlIHdvbgogICAgICAgICAgICBpZiAoYm9hcmQuc3RhdHVzID09IEJvYXJkU3RhdHVzLldoaXRlV2luKSB7CgogICAgICAgICAgICAgICAgLy8gV2hpdGUgc2hvdWxkIGdldCB0aGUgd2lubmVyIHNoYXJlCiAgICAgICAgICAgICAgICBhbW91bnRXaGl0ZSA9IGJvYXJkLmJvYXJkQmFsYW5jZS5tdWwoV0lOTkVSX1NIQVJFKS5kaXYoZnVsbEFtb3VudCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEJsYWNrIHNob3VsZCBnZXQgdGhlIHVwZGF0ZWQgbG9zZXIgc2hhcmUgKHdpdGggb3Igd2l0aG91dCB0aGUgYm9udXMpCiAgICAgICAgICAgICAgICBhbW91bnRCbGFjayA9IGJvYXJkLmJvYXJkQmFsYW5jZS5tdWwodXBkYXRlZExvc2VyU2hhcmUpLmRpdihmdWxsQW1vdW50KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gVGhlIENGTyBzaG91bGQgZ2V0IHRoZSB1cGRhdGVzIHNoYXJlIGlmIHRoZSBnYW1lIGVuZGVkIGFzIGV4cGVjdGVkCiAgICAgICAgICAgIGFtb3VudENGTyA9IGJvYXJkLmJvYXJkQmFsYW5jZS5tdWwodXBkYXRlZEhvc3RTaGFyZSkuZGl2KGZ1bGxBbW91bnQpOwogICAgICAgIH0KCiAgICAgICAgLy8gSWYgdGhlIG1hdGNoIGVuZGVkIGluIGEgZHJhdyBvciBpdCB3YXMgY2FuY2VsbGVkCiAgICAgICAgaWYgKGJvYXJkLnN0YXR1cyA9PSBCb2FyZFN0YXR1cy5EcmF3IHx8IGJvYXJkLnN0YXR1cyA9PSBCb2FyZFN0YXR1cy5DYW5jZWxlZCkgewogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVGhlIENGTyBpcyBub3QgdGFraW5nIGEgc2hhcmUgZnJvbSBkcmF3IG9yIGEgY2FuY2VsbGVkIG1hdGNoCiAgICAgICAgICAgIGFtb3VudENGTyA9IDA7CgogICAgICAgICAgICAvLyBJZiB0aGUgd2hpdGUgcGxheWVyIHdhcyBvbiBib2FyZCwgd2Ugc2hvdWxkIHNwbGl0IHRoZSBiYWxhbmNlIGluIGhhbGYKICAgICAgICAgICAgaWYgKGJvYXJkLndoaXRlQWRkcmVzcyAhPSAwKSB7CgogICAgICAgICAgICAgICAgLy8gRWFjaCBwbGF5ZXIgZ2V0cyBoYWxmIG9mIHRoZSBiYWxhbmNlCiAgICAgICAgICAgICAgICBhbW91bnRCbGFjayA9IGJvYXJkLmJvYXJkQmFsYW5jZS5kaXYoMik7CiAgICAgICAgICAgICAgICBhbW91bnRXaGl0ZSA9IGJvYXJkLmJvYXJkQmFsYW5jZS5kaXYoMik7CgogICAgICAgICAgICAvLyBJZiB0aGVyZSB3YXMgb25seSB0aGUgYmxhY2sgcGxheWVyLCB0aGV5IHNob3VsZCBnZXQgdGhlIGVudGlyZSBiYWxhbmNlCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBhbW91bnRCbGFjayA9IGJvYXJkLmJvYXJkQmFsYW5jZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gTWFrZSBzdXJlIHdlIGFyZSBnb2luZyB0byBzcGxpdCB0aGUgZW50aXJlIGFtb3VudCBhbmQgbm90aGluZyBnZXRzIGxlZnQgYmVoaW5kCiAgICAgICAgYXNzZXJ0KGFtb3VudEJsYWNrICsgYW1vdW50V2hpdGUgKyBhbW91bnRDRk8gPT0gYm9hcmQuYm9hcmRCYWxhbmNlKTsKICAgICAgICAKICAgICAgICAvLyBSZXNldCB0aGUgYmFsYW5jZQogICAgICAgIGJvYXJkLmJvYXJkQmFsYW5jZSA9IDA7CgogICAgICAgIC8vIEFzeW5jIHNlbmRzIHRvIHRoZSBwYXJ0aWNpcGFudHMgKHRoaXMgbWVhbnMgZWFjaCBwYXJ0aWNpcGFudCB3aWxsIGJlIHJlcXVpcmVkIHRvIHdpdGhkcmF3IGZ1bmRzKQogICAgICAgIGFzeW5jU2VuZChib2FyZC5ibGFja0FkZHJlc3MsIGFtb3VudEJsYWNrKTsKICAgICAgICBhc3luY1NlbmQoYm9hcmQud2hpdGVBZGRyZXNzLCBhbW91bnRXaGl0ZSk7CiAgICAgICAgYXN5bmNTZW5kKENGTywgYW1vdW50Q0ZPKTsKICAgIH0KCiAgICAvLy8gQGRldiB3aXRoZHJhdyBhY2N1bXVsYXRlZCBiYWxhbmNlLCBjYWxsZWQgYnkgcGF5ZWUuCiAgICBmdW5jdGlvbiB3aXRoZHJhd1BheW1lbnRzKCkgcHVibGljIHsKCiAgICAgICAgLy8gQ2FsbCBaZXBwZWxpbidzIHdpdGhkcmF3UGF5bWVudHMKICAgICAgICBzdXBlci53aXRoZHJhd1BheW1lbnRzKCk7CgogICAgICAgIC8vIFNlbmQgYW4gZXZlbnQKICAgICAgICBQbGF5ZXJXaXRoZHJhd25CYWxhbmNlKG1zZy5zZW5kZXIpOwogICAgfQp9CgovLyBGaWxlOiBjb250cmFjdHMvR29HYW1lTG9naWMuc29sCgovLy8gQHRpdGxlIFRoZSBhY3R1YWwgZ2FtZSBsb2dpYyBmb3IgRXRoZXJuYWxHbyAtIHNldHRpbmcgc3RvbmVzLCBjYXB0dXJpbmcsIGV0Yy4KLy8vIEBhdXRob3IgaHR0cHM6Ly93d3cuRXRoZXJuYWxHby5jb20KY29udHJhY3QgR29HYW1lTG9naWMgaXMgR29Cb2FyZE1ldGFEZXRhaWxzIHsKCiAgICAvLy8gQGRldiBUaGUgU3RvbmVBZGRlZFRvQm9hcmQgZXZlbnQgaXMgZmlyZWQgd2hlbiBhIG5ldyBzdG9uZSBpcyBhZGRlZCB0byB0aGUgYm9hcmQsIAogICAgLy8vICBhbmQgaW5jbHVkZXMgdGhlIGJvYXJkIElkLCBzdG9uZSBjb2xvciwgcm93ICYgY29sdW1uLiBUaGlzIGV2ZW50IHdpbGwgZmlyZSBldmVuIGlmIGl0IHdhcyBhIHN1aWNpZGUgc3RvbmUuCiAgICBldmVudCBTdG9uZUFkZGVkVG9Cb2FyZCh1aW50IGJvYXJkSWQsIFBsYXllckNvbG9yIGNvbG9yLCB1aW50OCByb3csIHVpbnQ4IGNvbCk7CgogICAgLy8vIEBkZXYgVGhlIFBsYXllclBhc3NlZFR1cm4gZXZlbnQgaXMgZmlyZWQgd2hlbiBhIHBsYXllciBwYXNzZXMgdHVybiAKICAgIC8vLyAgYW5kIGluY2x1ZGVzIHRoZSBib2FyZCBJZCwgY29sb3IuCiAgICBldmVudCBQbGF5ZXJQYXNzZWRUdXJuKHVpbnQgYm9hcmRJZCwgUGxheWVyQ29sb3IgY29sb3IpOwogICAgCiAgICAvLy8gQGRldiBVcGRhdGluZyB0aGUgcGxheWVyJ3MgdGltZSBwZXJpb2RzIGxlZnQsIGFjY29yZGluZyB0byB0aGUgY3VycmVudCB0aW1lIC0gYm9hcmQgbGFzdCB1cGRhdGUgdGltZS4KICAgIC8vLyAgSWYgdGhlIHBsYXllciBkb2VzIG5vdCBoYXZlIGVub3VnaCB0aW1lIGFuZCBjaG9zZSB0byBhY3QsIHRoZSBnYW1lIHdpbGwgZW5kIGFuZCB0aGUgcGxheWVyIHdpbGwgbG9zZS4KICAgIC8vLyBAcGFyYW0gYm9hcmQgaXMgdGhlIHJlbGV2YW50IGJvYXJkLgogICAgLy8vIEBwYXJhbSBib2FyZElkIGlzIHRoZSBib2FyZCdzIElkLgogICAgLy8vIEBwYXJhbSBjb2xvciBpcyB0aGUgY29sb3Igb2YgdGhlIHBsYXllciB3ZSB3YW50IHRvIHVwZGF0ZS4KICAgIC8vLyBAcmV0dXJuIHRydWUgaWYgdGhlIHBsYXllciBjYW4gY29udGludWUgcGxheWluZywgb3RoZXJ3aXNlIGZhbHNlLgogICAgZnVuY3Rpb24gdXBkYXRlUGxheWVyVGltZShHb0JvYXJkIHN0b3JhZ2UgYm9hcmQsIHVpbnQgYm9hcmRJZCwgUGxheWVyQ29sb3IgY29sb3IpIHByaXZhdGUgcmV0dXJucyhib29sKSB7CgogICAgICAgIC8vIFZlcmlmeSB0aGF0IHRoZSBib2FyZCBpcyBpbiBwcm9ncmVzcyBhbmQgdGhhdCBpdCdzIHRoZSBjdXJyZW50IHBsYXllcgogICAgICAgIHJlcXVpcmUoYm9hcmQuc3RhdHVzID09IEJvYXJkU3RhdHVzLkluUHJvZ3Jlc3MgJiYgYm9hcmQubmV4dFR1cm5Db2xvciA9PSBjb2xvcik7CgogICAgICAgIC8vIENhbGN1bGF0ZSB0aW1lIHBlcmlvZHMgdXNlZCBieSB0aGUgcGxheWVyCiAgICAgICAgdWludCB0aW1lUGVyaW9kc1VzZWQgPSB1aW50KG5vdy5zdWIoYm9hcmQubGFzdFVwZGF0ZSkuZGl2KFBMQVlFUl9UVVJOX1NJTkdMRV9QRVJJT0QpKTsKCiAgICAgICAgLy8gU3VidHJhY3QgdGltZSBwZXJpb2RzIGlmIG5lZWRlZAogICAgICAgIGlmICh0aW1lUGVyaW9kc1VzZWQgPiAwKSB7CgogICAgICAgICAgICAvLyBDYW4ndCBzcGVuZCBtb3JlIHRoYW4gTUFYX1VJTlQ4CiAgICAgICAgICAgIHVwZGF0ZVBsYXllclRpbWVQZXJpb2RzKGJvYXJkLCBjb2xvciwgdGltZVBlcmlvZHNVc2VkID4gTUFYX1VJTlQ4ID8gTUFYX1VJTlQ4IDogdWludDgodGltZVBlcmlvZHNVc2VkKSk7CgogICAgICAgICAgICAvLyBUaGUgcGxheWVyIGxvc3NlcyB3aGVuIHRoZXJlIGFyZW4ndCBhbnkgdGltZSBwZXJpb2RzIGxlZnQKICAgICAgICAgICAgaWYgKGdldFBsYXllclRpbWVQZXJpb2RzKGJvYXJkLCBjb2xvcikgPT0gMCkgewogICAgICAgICAgICAgICAgcGxheWVyTG9zdChib2FyZCwgYm9hcmRJZCwgY29sb3IpOwogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICAvLy8gQG5vdGljZSBVcGRhdGVzIHRoZSBib2FyZCBzdGF0dXMgYWNjb3JkaW5nIHRvIHRoZSBwbGF5ZXJzIHNjb3JlLgogICAgLy8vICBDYW4gb25seSBiZSBjYWxsZWQgd2hlbiB0aGUgYm9hcmQgaXMgaW4gYSAnd2FpdGluZ1RvUmVzb2x2ZScgc3RhdHVzLgogICAgLy8vIEBwYXJhbSBib2FyZElkIGlzIHRoZSBib2FyZCB0byBjaGVjayBhbmQgdXBkYXRlCiAgICBmdW5jdGlvbiBjaGVja1ZpY3RvcnlCeVNjb3JlKHVpbnQgYm9hcmRJZCkgZXh0ZXJuYWwgYm9hcmRXYWl0aW5nVG9SZXNvbHZlKGJvYXJkSWQpIHsKICAgICAgICAKICAgICAgICB1aW50OCBibGFja1Njb3JlOwogICAgICAgIHVpbnQ4IHdoaXRlU2NvcmU7CgogICAgICAgIC8vIEdldCB0aGUgcGxheWVycycgc2NvcmUKICAgICAgICAoYmxhY2tTY29yZSwgd2hpdGVTY29yZSkgPSBjYWxjdWxhdGVCb2FyZFNjb3JlKGJvYXJkSWQpOwoKICAgICAgICAvLyBEZWZhdWx0IHRvIERyYXcKICAgICAgICBCb2FyZFN0YXR1cyBzdGF0dXMgPSBCb2FyZFN0YXR1cy5EcmF3OwoKICAgICAgICAvLyBJZiBibGFjaydzIHNjb3JlIGlzIGJpZ2dlciB0aGFuIHdoaXRlJ3Mgc2NvcmUsIGJsYWNrIGlzIHRoZSB3aW5uZXIKICAgICAgICBpZiAoYmxhY2tTY29yZSA+IHdoaXRlU2NvcmUpIHsKCiAgICAgICAgICAgIHN0YXR1cyA9IEJvYXJkU3RhdHVzLkJsYWNrV2luOwogICAgICAgIC8vIElmIHdoaXRlJ3Mgc2NvcmUgaXMgYmlnZ2VyLCB3aGl0ZSBpcyB0aGUgd2lubmVyCiAgICAgICAgfSBlbHNlIGlmICh3aGl0ZVNjb3JlID4gYmxhY2tTY29yZSkgewoKICAgICAgICAgICAgc3RhdHVzID0gQm9hcmRTdGF0dXMuV2hpdGVXaW47CiAgICAgICAgfQoKICAgICAgICAvLyBVcGRhdGUgdGhlIGJvYXJkJ3Mgc3RhdHVzCiAgICAgICAgdXBkYXRlQm9hcmRTdGF0dXMoYm9hcmRJZCwgc3RhdHVzKTsKICAgIH0KCiAgICAvLy8gQG5vdGljZSBQZXJmb3JtcyBhIHBhc3MgYWN0aW9uIG9uIGEgcHNlY2lmaWMgYm9hcmQsIG9ubHkgYnkgdGhlIGN1cnJlbnQgYWN0aXZlIGNvbG9yIHBsYXllci4KICAgIC8vLyBAcGFyYW0gYm9hcmRJZCBpcyB0aGUgYm9hcmQgdG8gcGVyZm9ybSBwYXNzIG9uLgogICAgZnVuY3Rpb24gcGFzc1R1cm4odWludCBib2FyZElkKSBleHRlcm5hbCB7CgogICAgICAgIC8vIEdldCB0aGUgYm9hcmQgJiBwbGF5ZXIKICAgICAgICBHb0JvYXJkIHN0b3JhZ2UgYm9hcmQgPSBhbGxCb2FyZHNbYm9hcmRJZF07CiAgICAgICAgUGxheWVyQ29sb3IgYWN0aXZlQ29sb3IgPSBnZXRQbGF5ZXJDb2xvcihib2FyZCwgbXNnLnNlbmRlcik7CgogICAgICAgIC8vIFZlcmlmeSB0aGUgcGxheWVyIGNhbiBhY3QKICAgICAgICByZXF1aXJlKGJvYXJkLnN0YXR1cyA9PSBCb2FyZFN0YXR1cy5JblByb2dyZXNzICYmIGJvYXJkLm5leHRUdXJuQ29sb3IgPT0gYWN0aXZlQ29sb3IpOwogICAgICAgIAogICAgICAgIC8vIENoZWNrIGlmIHRoaXMgcGxheWVyIGNhbiBhY3QKICAgICAgICBpZiAodXBkYXRlUGxheWVyVGltZShib2FyZCwgYm9hcmRJZCwgYWN0aXZlQ29sb3IpKSB7CgogICAgICAgICAgICAvLyBJZiBpdCdzIHRoZSBzZWNvbmQgc3RyYWlnaHQgcGFzcywgdGhlIGdhbWUgaXMgb3ZlcgogICAgICAgICAgICBpZiAoYm9hcmQuZGlkUGFzc1ByZXZUdXJuKSB7CgogICAgICAgICAgICAgICAgLy8gRmluaXNoaW5nIHRoZSBnYW1lIGxpa2UgdGhpcyBpcyBjb25zaWRlcmVkIGhvbm9yYWJsZQogICAgICAgICAgICAgICAgYm9hcmQuaXNIb25vcmFibGVMb3NzID0gdHJ1ZTsKCiAgICAgICAgICAgICAgICAvLyBPbiBzZWNvbmQgcGFzcywgdGhlIGJvYXJkIHN0YXR1cyBjaGFuZ2VzIHRvICdXYWl0aW5nVG9SZXNvbHZlJwogICAgICAgICAgICAgICAgdXBkYXRlQm9hcmRTdGF0dXMoYm9hcmQsIGJvYXJkSWQsIEJvYXJkU3RhdHVzLldhaXRpbmdUb1Jlc29sdmUpOwoKICAgICAgICAgICAgLy8gSWYgaXQncyB0aGUgZmlyc3QgcGFzcywgd2UgY2FuIHNpbXBseSBjb250aW51ZQogICAgICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgICAgIC8vIE1vdmUgdG8gdGhlIG5leHQgcGxheWVyLCBmbGFnIHRoYXQgaXQgd2FzIGEgcGFzcyBhY3Rpb24KICAgICAgICAgICAgICAgIG5leHRUdXJuKGJvYXJkKTsKICAgICAgICAgICAgICAgIGJvYXJkLmRpZFBhc3NQcmV2VHVybiA9IHRydWU7CgogICAgICAgICAgICAgICAgLy8gTm90aWZ5IHRoZSBwbGF5ZXIgcGFzc2VkIHR1cm4KICAgICAgICAgICAgICAgIFBsYXllclBhc3NlZFR1cm4oYm9hcmRJZCwgYWN0aXZlQ29sb3IpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIC8vLyBAbm90aWNlIFJlc2lnbnMgYSBwbGF5ZXIgZnJvbSBhIHNwZWNpZmljIGJvYXJkLCBjYW4gZ2V0IGNhbGxlZCBieSBlaXRoZXIgcGxheWVyIG9uIHRoZSBib2FyZC4KICAgIC8vLyBAcGFyYW0gYm9hcmRJZCBpcyB0aGUgYm9hcmQgdG8gcmVzaWduIGZyb20uCiAgICBmdW5jdGlvbiByZXNpZ25Gcm9tTWF0Y2godWludCBib2FyZElkKSBleHRlcm5hbCB7CgogICAgICAgIC8vIEdldCB0aGUgYm9hcmQsIG1ha2Ugc3VyZSBpdCdzIGluIHByb2dyZXNzCiAgICAgICAgR29Cb2FyZCBzdG9yYWdlIGJvYXJkID0gYWxsQm9hcmRzW2JvYXJkSWRdOwogICAgICAgIHJlcXVpcmUoYm9hcmQuc3RhdHVzID09IEJvYXJkU3RhdHVzLkluUHJvZ3Jlc3MpOwoKICAgICAgICAvLyBHZXQgdGhlIHNlbmRlcidzIGNvbG9yCiAgICAgICAgUGxheWVyQ29sb3IgYWN0aXZlQ29sb3IgPSBnZXRQbGF5ZXJDb2xvcihib2FyZCwgbXNnLnNlbmRlcik7CiAgICAgICAgICAgICAgICAKICAgICAgICAvLyBGaW5pc2hpbmcgdGhlIGdhbWUgbGlrZSB0aGlzIGlzIGNvbnNpZGVyZWQgaG9ub3JhYmxlCiAgICAgICAgYm9hcmQuaXNIb25vcmFibGVMb3NzID0gdHJ1ZTsKCiAgICAgICAgLy8gU2V0IHRoYXQgY29sb3IgYXMgdGhlIGxvc2luZyBwbGF5ZXIKICAgICAgICBwbGF5ZXJMb3N0KGJvYXJkLCBib2FyZElkLCBhY3RpdmVDb2xvcik7CiAgICB9CgogICAgLy8vIEBub3RpY2UgQ2xhaW1pbmcgdGhlIGN1cnJlbnQgYWN0aW5nIHBsYXllciBvbiB0aGUgYm9hcmQgaXMgb3V0IG9mIHRpbWUsIHRodXMgbG9zc2VzIHRoZSBnYW1lLgogICAgLy8vIEBwYXJhbSBib2FyZElkIGlzIHRoZSBib2FyZCB0byBjbGFpbSBpdCBvbi4KICAgIGZ1bmN0aW9uIGNsYWltQWN0aW5nUGxheWVyT3V0T2ZUaW1lKHVpbnQgYm9hcmRJZCkgZXh0ZXJuYWwgewoKICAgICAgICAvLyBHZXQgdGhlIGJvYXJkLCBtYWtlIHN1cmUgaXQncyBpbiBwcm9ncmVzcwogICAgICAgIEdvQm9hcmQgc3RvcmFnZSBib2FyZCA9IGFsbEJvYXJkc1tib2FyZElkXTsKICAgICAgICByZXF1aXJlKGJvYXJkLnN0YXR1cyA9PSBCb2FyZFN0YXR1cy5JblByb2dyZXNzKTsKCiAgICAgICAgLy8gR2V0IHRoZSBhY3RpbmcgcGxheWVyIGNvbG9yCiAgICAgICAgUGxheWVyQ29sb3IgYWN0aW5nUGxheWVyQ29sb3IgPSBnZXROZXh0VHVybkNvbG9yKGJvYXJkSWQpOwoKICAgICAgICAvLyBDYWxjdWxhdGUgcmVtYWluaW5nIGFsbG93ZWQgdGltZSBmb3IgdGhlIGFjdGluZyBwbGF5ZXIKICAgICAgICB1aW50IHBsYXllclRpbWVSZW1haW5pbmcgPSBQTEFZRVJfVFVSTl9TSU5HTEVfUEVSSU9EICogZ2V0UGxheWVyVGltZVBlcmlvZHMoYm9hcmQsIGFjdGluZ1BsYXllckNvbG9yKTsKCiAgICAgICAgLy8gSWYgdGhlIHBsYXllciBkb2Vzbid0IGhhdmUgZW5vdWdoIHRpbWUgbGVmdCwgdGhlIHBsYXllciBsb3NzZXMKICAgICAgICBpZiAocGxheWVyVGltZVJlbWFpbmluZyA8IG5vdyAtIGJvYXJkLmxhc3RVcGRhdGUpIHsKICAgICAgICAgICAgcGxheWVyTG9zdChib2FyZCwgYm9hcmRJZCwgYWN0aW5nUGxheWVyQ29sb3IpOwogICAgICAgIH0KICAgIH0KCiAgICAvLy8gQGRldiBVcGRhdGUgYSBib2FyZCBzdGF0dXMgd2l0aCBhIGxvc2luZyBjb2xvcgogICAgLy8vIEBwYXJhbSBib2FyZCBpcyB0aGUgYm9hcmQgdG8gdXBkYXRlLgogICAgLy8vIEBwYXJhbSBib2FyZElkIGlzIHRoZSBib2FyZCdzIElkLgogICAgLy8vIEBwYXJhbSBjb2xvciBpcyB0aGUgbG9zaW5nIHBsYXllcidzIGNvbG9yLgogICAgZnVuY3Rpb24gcGxheWVyTG9zdChHb0JvYXJkIHN0b3JhZ2UgYm9hcmQsIHVpbnQgYm9hcmRJZCwgUGxheWVyQ29sb3IgY29sb3IpIHByaXZhdGUgewoKICAgICAgICAvLyBJZiBibGFjayBpcyB0aGUgbG9zaW5nIGNvbG9yLCB3aGl0ZSB3aW5zCiAgICAgICAgaWYgKGNvbG9yID09IFBsYXllckNvbG9yLkJsYWNrKSB7CiAgICAgICAgICAgIHVwZGF0ZUJvYXJkU3RhdHVzKGJvYXJkLCBib2FyZElkLCBCb2FyZFN0YXR1cy5XaGl0ZVdpbik7CiAgICAgICAgCiAgICAgICAgLy8gSWYgd2hpdGUgaXMgdGhlIGxvc2luZyBjb2xvciwgYmxhY2sgd2lucwogICAgICAgIH0gZWxzZSBpZiAoY29sb3IgPT0gUGxheWVyQ29sb3IuV2hpdGUpIHsKICAgICAgICAgICAgdXBkYXRlQm9hcmRTdGF0dXMoYm9hcmQsIGJvYXJkSWQsIEJvYXJkU3RhdHVzLkJsYWNrV2luKTsKCiAgICAgICAgLy8gVGhlcmUncyBhbiBlcnJvciwgcmV2ZXJ0CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV2ZXJ0KCk7CiAgICAgICAgfQogICAgfQoKICAgIC8vLyBAZGV2IEludGVybmFsbHkgdXNlZCB0byBtb3ZlIHRvIHRoZSBuZXh0IHR1cm4sIGJ5IHN3aXRjaGluZyBzaWRlcyBhbmQgdXBkYXRpbmcgdGhlIGJvYXJkIGxhc3QgdXBkYXRlIHRpbWUuCiAgICAvLy8gQHBhcmFtIGJvYXJkIGlzIHRoZSBib2FyZCB0byB1cGRhdGUuCiAgICBmdW5jdGlvbiBuZXh0VHVybihHb0JvYXJkIHN0b3JhZ2UgYm9hcmQpIHByaXZhdGUgewogICAgICAgIAogICAgICAgIC8vIFN3aXRjaCBzaWRlcwogICAgICAgIGJvYXJkLm5leHRUdXJuQ29sb3IgPSBib2FyZC5uZXh0VHVybkNvbG9yID09IFBsYXllckNvbG9yLkJsYWNrID8gUGxheWVyQ29sb3IuV2hpdGUgOiBQbGF5ZXJDb2xvci5CbGFjazsKCiAgICAgICAgLy8gTGFzdCB1cGRhdGUgdGltZQogICAgICAgIGJvYXJkLmxhc3RVcGRhdGUgPSBub3c7CiAgICB9CiAgICAKICAgIC8vLyBAbm90aWNlIEFkZGluZyBhIHN0b25lIHRvIGEgc3BlY2lmaWMgYm9hcmQgYW5kIHBvc2l0aW9uIChyb3cgJiBjb2wpLgogICAgLy8vICBSZXF1aXJlcyB0aGUgYm9hcmQgdG8gYmUgaW4gcHJvZ3Jlc3MsIHRoYXQgdGhlIGNhbGxlciBpcyB0aGUgYWN0aW5nIHBsYXllciwgCiAgICAvLy8gIGFuZCB0aGF0IHRoZSBzcG90IG9uIHRoZSBib2FyZCBpcyBlbXB0eS4KICAgIC8vLyBAcGFyYW0gYm9hcmRJZCBpcyB0aGUgYm9hcmQgdG8gYWRkIHRoZSBzdG9uZSB0by4KICAgIC8vLyBAcGFyYW0gcm93IGlzIHRoZSByb3cgZm9yIHRoZSBuZXcgc3RvbmUuCiAgICAvLy8gQHBhcmFtIGNvbCBpcyB0aGUgY29sdW1uIGZvciB0aGUgbmV3IHN0b25lLgogICAgZnVuY3Rpb24gYWRkU3RvbmVUb0JvYXJkKHVpbnQgYm9hcmRJZCwgdWludDggcm93LCB1aW50OCBjb2wpIGV4dGVybmFsIHsKICAgICAgICAKICAgICAgICAvLyBHZXQgdGhlIGJvYXJkICYgc2VuZGVyJ3MgY29sb3IKICAgICAgICBHb0JvYXJkIHN0b3JhZ2UgYm9hcmQgPSBhbGxCb2FyZHNbYm9hcmRJZF07CiAgICAgICAgUGxheWVyQ29sb3IgYWN0aXZlQ29sb3IgPSBnZXRQbGF5ZXJDb2xvcihib2FyZCwgbXNnLnNlbmRlcik7CgogICAgICAgIC8vIFZlcmlmeSB0aGUgcGxheWVyIGNhbiBhY3QKICAgICAgICByZXF1aXJlKGJvYXJkLnN0YXR1cyA9PSBCb2FyZFN0YXR1cy5JblByb2dyZXNzICYmIGJvYXJkLm5leHRUdXJuQ29sb3IgPT0gYWN0aXZlQ29sb3IpOwoKICAgICAgICAvLyBDYWxjdWxhdGUgdGhlIHBvc2l0aW9uCiAgICAgICAgdWludDggcG9zaXRpb24gPSByb3cgKiBCT0FSRF9ST1dfU0laRSArIGNvbDsKICAgICAgICAKICAgICAgICAvLyBDaGVjayB0aGF0IGl0J3MgYW4gZW1wdHkgc3BvdAogICAgICAgIHJlcXVpcmUoYm9hcmQucG9zaXRpb25Ub0NvbG9yW3Bvc2l0aW9uXSA9PSAwKTsKCiAgICAgICAgLy8gVXBkYXRlIHRoZSBwbGF5ZXIgdGltZW91dCAoaWYgdGhlIHBsYXllciBkb2Vzbid0IGhhdmUgdGltZSBsZWZ0LCBkaXNjb250aW51ZSkKICAgICAgICBpZiAodXBkYXRlUGxheWVyVGltZShib2FyZCwgYm9hcmRJZCwgYWN0aXZlQ29sb3IpKSB7CgogICAgICAgICAgICAvLyBTZXQgdGhlIHN0b25lIG9uIHRoZSBib2FyZAogICAgICAgICAgICBib2FyZC5wb3NpdGlvblRvQ29sb3JbcG9zaXRpb25dID0gdWludDgoYWN0aXZlQ29sb3IpOwoKICAgICAgICAgICAgLy8gUnVuIGNhcHR1cmUgLyBzdWlkaWNlIGxvZ2ljCiAgICAgICAgICAgIHVwZGF0ZUNhcHR1cmVzKGJvYXJkLCBwb3NpdGlvbiwgdWludDgoYWN0aXZlQ29sb3IpKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE5leHQgdHVybiBsb2dpYwogICAgICAgICAgICBuZXh0VHVybihib2FyZCk7CgogICAgICAgICAgICAvLyBDbGVhciB0aGUgcGFzcyBmbGFnCiAgICAgICAgICAgIGlmIChib2FyZC5kaWRQYXNzUHJldlR1cm4pIHsKICAgICAgICAgICAgICAgIGJvYXJkLmRpZFBhc3NQcmV2VHVybiA9IGZhbHNlOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBGaXJlIHRoZSBldmVudAogICAgICAgICAgICBTdG9uZUFkZGVkVG9Cb2FyZChib2FyZElkLCBhY3RpdmVDb2xvciwgcm93LCBjb2wpOwogICAgICAgIH0KICAgIH0KCiAgICAvLy8gQG5vdGljZSBSZXR1cm5zIGEgYm9hcmQncyByb3cgZGV0YWlscywgc3BlY2lmaWVzIHdoaWNoIGNvbG9yIG9jY3VwaWVzIHdoaWNoIGNlbGwgaW4gdGhhdCByb3cuCiAgICAvLy8gQGRldiBJdCByZXR1cm5zIGEgcm93IGFuZCBub3QgdGhlIGVudGlyZSBib2FyZCBiZWNhdXNlIHNvbWUgbm9kZXMgbWlnaHQgZmFpbCB0byByZXR1cm4gYXJyYXlzIGxhcmdlciB0aGFuIH41MC4KICAgIC8vLyBAcGFyYW0gYm9hcmRJZCBpcyB0aGUgYm9hcmQgdG8gaW5xdWlyZS4KICAgIC8vLyBAcGFyYW0gcm93IGlzIHRoZSByb3cgdG8gZ2V0IGRldGFpbHMgb24uCiAgICAvLy8gQHJldHVybiBhbiBhcnJheSB0aGF0IGNvbnRhaW5zIHRoZSBjb2xvcnMgb2NjdXB5aW5nIGVhY2ggY2VsbCBpbiB0aGF0IHJvdy4KICAgIGZ1bmN0aW9uIGdldEJvYXJkUm93RGV0YWlscyh1aW50IGJvYXJkSWQsIHVpbnQ4IHJvdykgZXh0ZXJuYWwgdmlldyByZXR1cm5zICh1aW50OFtCT0FSRF9ST1dfU0laRV0pIHsKICAgICAgICAKICAgICAgICAvLyBUaGUgYXJyYXkgdG8gcmV0dXJuCiAgICAgICAgdWludDhbQk9BUkRfUk9XX1NJWkVdIG1lbW9yeSByb3dUb1JldHVybjsKCiAgICAgICAgLy8gRm9yIGFsbCBjb2x1bW5zLCBjYWxjdWxhdGUgdGhlIHBvc2l0aW9uIGFuZCBnZXQgdGhlIGN1cnJlbnQgc3RhdHVzCiAgICAgICAgZm9yICh1aW50OCBjb2wgPSAwOyBjb2wgPCBCT0FSRF9ST1dfU0laRTsgY29sKyspIHsKICAgICAgICAgICAgCiAgICAgICAgICAgIHVpbnQ4IHBvc2l0aW9uID0gcm93ICogQk9BUkRfUk9XX1NJWkUgKyBjb2w7CiAgICAgICAgICAgIHJvd1RvUmV0dXJuW2NvbF0gPSBhbGxCb2FyZHNbYm9hcmRJZF0ucG9zaXRpb25Ub0NvbG9yW3Bvc2l0aW9uXTsKICAgICAgICB9CgogICAgICAgIC8vIFJldHVybiB0aGUgYXJyYXkKICAgICAgICByZXR1cm4gKHJvd1RvUmV0dXJuKTsKICAgIH0KCiAgICAvLy8gQG5vdGljZSBSZXR1cm5zIHRoZSBjdXJyZW50IGNvbG9yIG9mIGEgc3BlY2lmaWMgcG9zaXRpb24gaW4gYSBib2FyZC4KICAgIC8vLyBAcGFyYW0gYm9hcmRJZCBpcyB0aGUgYm9hcmQgdG8gaW5xdWlyZS4KICAgIC8vLyBAcGFyYW0gcm93IGlzIHBhcnQgb2YgdGhlIHBvc2l0aW9uIHRvIGdldCBkZXRhaWxzIG9uLgogICAgLy8vIEBwYXJhbSBjb2wgaXMgcGFydCBvZiB0aGUgcG9zaXRpb24gdG8gZ2V0IGRldGFpbHMgb24uCiAgICAvLy8gQHJldHVybiB0aGUgY29sb3Igb2NjdXB5aW5nIHRoYXQgcG9zaXRpb24uCiAgICBmdW5jdGlvbiBnZXRCb2FyZFNpbmdsZVNwYWNlRGV0YWlscyh1aW50IGJvYXJkSWQsIHVpbnQ4IHJvdywgdWludDggY29sKSBleHRlcm5hbCB2aWV3IHJldHVybnMgKHVpbnQ4KSB7CgogICAgICAgIHVpbnQ4IHBvc2l0aW9uID0gcm93ICogQk9BUkRfUk9XX1NJWkUgKyBjb2w7CiAgICAgICAgcmV0dXJuIGFsbEJvYXJkc1tib2FyZElkXS5wb3NpdGlvblRvQ29sb3JbcG9zaXRpb25dOwogICAgfQoKICAgIC8vLyBAZGV2IENhbGN1bHRlcyB3aGV0aGVyIGEgcG9zaXRpb24gY2FwdHVyZXMgYW4gZW5lbXkgZ3JvdXAsIG9yIHdoZXRoZXIgaXQncyBhIHN1aWNpZGUuIAogICAgLy8vICBVcGRhdGVzIHRoZSBib2FyZCBhY2NvcmlkbmdseSAoY2xlYXJzIGNhcHR1cmVkIGdyb3Vwcywgb3IgdGhlIHN1aWNpZGluZyBzdG9uZSkuCiAgICAvLy8gQHBhcmFtIGJvYXJkIHRoZSBib2FyZCB0byBjaGVjayBhbmQgdXBkYXRlCiAgICAvLy8gQHBhcmFtIHBvc2l0aW9uIHRoZSBwb3NpdGlvbiBvZiB0aGUgbmV3IHN0b25lCiAgICAvLy8gQHBhcmFtIHBvc2l0aW9uQ29sb3IgdGhlIGNvbG9yIG9mIHRoZSBuZXcgc3RvbmUgKHRoaXMgcGFyYW0gaXMgc2VudCB0byBzcGFyZSBhbm90aGVyIHJlYWRpbmcgb3ApCiAgICBmdW5jdGlvbiB1cGRhdGVDYXB0dXJlcyhHb0JvYXJkIHN0b3JhZ2UgYm9hcmQsIHVpbnQ4IHBvc2l0aW9uLCB1aW50OCBwb3NpdGlvbkNvbG9yKSBwcml2YXRlIHsKCiAgICAgICAgLy8gR3JvdXAgcG9zaXRpb25zLCB1c2VkIGxhdGVyCiAgICAgICAgdWludDhbQk9BUkRfU0laRV0gbWVtb3J5IGdyb3VwOwoKICAgICAgICAvLyBJcyBncm91cCBjYXB0dXJlZCwgb3IgZnJlZQogICAgICAgIGJvb2wgaXNHcm91cENhcHR1cmVkOwoKICAgICAgICAvLyBJbiBvcmRlciB0byBzYXZlIGdhcywgd2UgY2hlY2sgc3VpY2lkZSBvbmx5IGlmIHRoZSBwb3NpdGlvbiBpcyBmdWxseSBzdXJyb3VuZGVkIGFuZCBkb2Vzbid0IGNhcHR1cmUgZW5lbXkgZ3JvdXBzIAogICAgICAgIGJvb2wgc2hvdWxkQ2hlY2tTdWljaWRlID0gdHJ1ZTsKCiAgICAgICAgLy8gR2V0IHRoZSBwb3NpdGlvbidzIGFkamFjZW50IGNlbGxzCiAgICAgICAgdWludDhbTUFYX0FESkFDRU5UX0NFTExTXSBtZW1vcnkgYWRqYWNlbnRBcnJheSA9IGdldEFkamFjZW50Q2VsbHMocG9zaXRpb24pOwoKICAgICAgICAvLyBSdW4gYXMgbG9uZyBhcyB0aGVyZSBhbiBhZGphY2VudCBjZWxsLCBvciB1bnRpbCB3ZSByZWFjaCB0aGUgZW5kIG9mIHRoZSBhcnJheQogICAgICAgIGZvciAodWludDggY3VyckFkamFjZW50SW5kZXggPSAwOyBjdXJyQWRqYWNlbnRJbmRleCA8IE1BWF9BREpBQ0VOVF9DRUxMUyAmJiBhZGphY2VudEFycmF5W2N1cnJBZGphY2VudEluZGV4XSA8IE1BWF9VSU5UODsgY3VyckFkamFjZW50SW5kZXgrKykgewoKICAgICAgICAgICAgLy8gR2V0IHRoZSBhZGphY2VudCBjZWxsJ3MgY29sb3IKICAgICAgICAgICAgdWludDggY3VyckNvbG9yID0gYm9hcmQucG9zaXRpb25Ub0NvbG9yW2FkamFjZW50QXJyYXlbY3VyckFkamFjZW50SW5kZXhdXTsKCiAgICAgICAgICAgIC8vIElmIHRoZSBlbmVteSdzIGNvbG9yCiAgICAgICAgICAgIGlmIChjdXJyQ29sb3IgIT0gMCAmJiBjdXJyQ29sb3IgIT0gcG9zaXRpb25Db2xvcikgewoKICAgICAgICAgICAgICAgIC8vIEdldCB0aGUgZ3JvdXAncyBpbmZvCiAgICAgICAgICAgICAgICAoZ3JvdXAsIGlzR3JvdXBDYXB0dXJlZCkgPSBnZXRHcm91cChib2FyZCwgYWRqYWNlbnRBcnJheVtjdXJyQWRqYWNlbnRJbmRleF0sIGN1cnJDb2xvcik7CgogICAgICAgICAgICAgICAgLy8gQ2FwdHVyZWQgYSBncm91cAogICAgICAgICAgICAgICAgaWYgKGlzR3JvdXBDYXB0dXJlZCkgewogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIENsZWFyIHRoZSBncm91cCBmcm9tIHRoZSBib2FyZAogICAgICAgICAgICAgICAgICAgIGZvciAodWludDggY3Vyckdyb3VwSW5kZXggPSAwOyBjdXJyR3JvdXBJbmRleCA8IEJPQVJEX1NJWkUgJiYgZ3JvdXBbY3Vyckdyb3VwSW5kZXhdIDwgTUFYX1VJTlQ4OyBjdXJyR3JvdXBJbmRleCsrKSB7CgogICAgICAgICAgICAgICAgICAgICAgICBib2FyZC5wb3NpdGlvblRvQ29sb3JbZ3JvdXBbY3Vyckdyb3VwSW5kZXhdXSA9IDA7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBTaG91bGRuJ3QgY2hlY2sgc3VpY2lkZQogICAgICAgICAgICAgICAgICAgIHNob3VsZENoZWNrU3VpY2lkZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBUaGVyZSdzIGFuIGVtcHR5IGFkamFjZW50IGNlbGwKICAgICAgICAgICAgfSBlbHNlIGlmIChjdXJyQ29sb3IgPT0gMCkgewoKICAgICAgICAgICAgICAgIC8vIFNob3VsZG4ndCBjaGVjayBzdWljaWRlCiAgICAgICAgICAgICAgICBzaG91bGRDaGVja1N1aWNpZGUgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gRGV0ZWN0IHN1aWNpZGUgaWYgbmVlZGVkCiAgICAgICAgaWYgKHNob3VsZENoZWNrU3VpY2lkZSkgewoKICAgICAgICAgICAgLy8gR2V0IHRoZSBuZXcgc3RvbmUncyBzdXJyb3VuZGluZyBncm91cAogICAgICAgICAgICAoZ3JvdXAsIGlzR3JvdXBDYXB0dXJlZCkgPSBnZXRHcm91cChib2FyZCwgcG9zaXRpb24sIHBvc2l0aW9uQ29sb3IpOwoKICAgICAgICAgICAgLy8gSWYgdGhlIGdyb3VwIGlzIGNhcHR1cmVkLCBpdCdzIGEgc3VpY2lkZSBtb3ZlLCByZW1vdmUgaXQKICAgICAgICAgICAgaWYgKGlzR3JvdXBDYXB0dXJlZCkgewoKICAgICAgICAgICAgICAgIC8vIENsZWFyIGFkZGVkIHN0b25lCiAgICAgICAgICAgICAgICBib2FyZC5wb3NpdGlvblRvQ29sb3JbcG9zaXRpb25dID0gMDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICAvLy8gQGRldiBJbnRlcm5hbGx5IHVzZWQgdG8gc2V0IGEgZmxhZyBpbiBhIHNocmlua2VkIGJvYXJkIGFycmF5ICh1c2VkIHRvIHNhdmUgZ2FzIGNvc3RzKS4KICAgIC8vLyBAcGFyYW0gdmlzaXRlZCB0aGUgYXJyYXkgdG8gdXBkYXRlLgogICAgLy8vIEBwYXJhbSBwb3NpdGlvbiB0aGUgcG9zaXRpb24gb24gdGhlIGJvYXJkIHdlIHdhbnQgdG8gZmxhZy4KICAgIC8vLyBAcGFyYW0gZmxhZyB0aGUgZmxhZyB3ZSB3YW50IHRvIHNldCAoZWl0aGVyIDEgb3IgMikuCiAgICBmdW5jdGlvbiBzZXRGbGFnKHVpbnQ4W1NIUklOS0VEX0JPQVJEX1NJWkVdIHZpc2l0ZWQsIHVpbnQ4IHBvc2l0aW9uLCB1aW50OCBmbGFnKSBwcml2YXRlIHB1cmUgewogICAgICAgIHZpc2l0ZWRbcG9zaXRpb24gLyA0XSB8PSBmbGFnIDw8ICgocG9zaXRpb24gJSA0KSAqIDIpOwogICAgfQoKICAgIC8vLyBAZGV2IEludGVybmFsbHkgdXNlZCB0byBjaGVjayB3aGV0aGVyIGEgZmxhZyBpbiBhIHNocmlua2VkIGJvYXJkIGFycmF5IGlzIHNldC4KICAgIC8vLyBAcGFyYW0gdmlzaXRlZCB0aGUgYXJyYXkgdG8gY2hlY2suCiAgICAvLy8gQHBhcmFtIHBvc2l0aW9uIHRoZSBwb3NpdGlvbiBvbiB0aGUgYm9hcmQgd2Ugd2FudCB0byBjaGVjay4KICAgIC8vLyBAcGFyYW0gZmxhZyB0aGUgZmxhZyB3ZSB3YW50IHRvIGNoZWNrIChlaXRoZXIgMSBvciAyKS4KICAgIC8vLyBAcmV0dXJuIHRydWUgaWYgdGhhdCBmbGFnIGlzIHNldCwgZmFsc2Ugb3RoZXJ3aXNlLgogICAgZnVuY3Rpb24gaXNGbGFnU2V0KHVpbnQ4W1NIUklOS0VEX0JPQVJEX1NJWkVdIHZpc2l0ZWQsIHVpbnQ4IHBvc2l0aW9uLCB1aW50OCBmbGFnKSBwcml2YXRlIHB1cmUgcmV0dXJucyAoYm9vbCkgewogICAgICAgIHJldHVybiAodmlzaXRlZFtwb3NpdGlvbiAvIDRdICYgKGZsYWcgPDwgKChwb3NpdGlvbiAlIDQpICogMikpID4gMCk7CiAgICB9CgogICAgLy8gR2V0IGdyb3VwIHZpc2l0ZWQgZmxhZ3MKICAgIHVpbnQ4IGNvbnN0YW50IEZMQUdfUE9TSVRJT05fV0FTX0lOX1NUQUNLID0gMTsKICAgIHVpbnQ4IGNvbnN0YW50IEZMQUdfRElEX1ZJU0lUX1BPU0lUSU9OID0gMjsKCiAgICAvLy8gQGRldiBHZXRzIGEgZ3JvdXAgc3RhcnRpbmcgZnJvbSB0aGUgcG9zaXRpb24gJiBjb2xvciBzZW50LiBJbiBvcmRlciBmb3IgYSBzdG9uZSB0byBiZSBwYXJ0IG9mIHRoZSBncm91cCwKICAgIC8vLyAgaXQgbXVzdCBtYXRjaCB0aGUgb3JpZ2luYWwgc3RvbmUncyBjb2xvciwgYW5kIGJlIGNvbm5lY3RlZCB0byBpdCAtIGVpdGhlciBkaXJlY3RseSwgb3IgdGhyb3VnaCBhZGphY2VudCBjZWxscy4KICAgIC8vLyAgQSBncm91cCBpcyBjYXB0dXJlZCBpZiB0aGVyZSBhcmVuJ3QgYW55IGVtcHR5IGNlbGxzIGFyb3VuZCBpdC4KICAgIC8vLyAgVGhlIGZ1bmN0aW9uIHN1cHBvcnRzIGJvdGggcmV0dXJuaW5nIGNvbG9yZWQgZ3JvdXBzIC0gd2hpdGUvYmxhY2ssIGFuZCBlbXB0eSBncm91cHMgKGZvciB0aGF0IGNhc2UsIGlzR3JvdXBDYXB0dXJlZCBpc24ndCByZWxldmFudCkuCiAgICAvLy8gQHBhcmFtIGJvYXJkIHRoZSBib2FyZCB0byBjaGVjayBhbmQgdXBkYXRlCiAgICAvLy8gQHBhcmFtIHBvc2l0aW9uIHRoZSBwb3NpdGlvbiBvZiB0aGUgc3RhcnRpbmcgc3RvbmUKICAgIC8vLyBAcGFyYW0gcG9zaXRpb25Db2xvciB0aGUgY29sb3Igb2YgdGhlIHN0YXJ0aW5nIHN0b25lICh0aGlzIHBhcmFtIGlzIHNlbnQgdG8gc3BhcmUgYW5vdGhlciByZWFkaW5nIG9wKQogICAgLy8vIEByZXR1cm4gYW4gYXJyYXkgdGhhdCBjb250YWlucyB0aGUgcG9zaXRpb25zIG9mIHRoZSBncm91cCwgCiAgICAvLy8gIGEgYm9vbGVhbiB0aGF0IHNwZWNpZmllcyB3aGV0aGVyIHRoZSBncm91cCBpcyBjYXB0dXJlZCBvciBub3QuCiAgICAvLy8gIEluIG9yZGVyIHRvIHNhdmUgZ2FzLCBpZiBhIGdyb3VwIGlzbid0IGNhcHR1cmVkLCB0aGUgYXJyYXkgbWlnaHQgbm90IGNvbnRhaW4gdGhlIGVuaXRyZSBncm91cC4KICAgIGZ1bmN0aW9uIGdldEdyb3VwKEdvQm9hcmQgc3RvcmFnZSBib2FyZCwgdWludDggcG9zaXRpb24sIHVpbnQ4IHBvc2l0aW9uQ29sb3IpIHByaXZhdGUgdmlldyByZXR1cm5zICh1aW50OFtCT0FSRF9TSVpFXSwgYm9vbCBpc0dyb3VwQ2FwdHVyZWQpIHsKCiAgICAgICAgLy8gVGhlIHJldHVybiBhcnJheSwgYW5kIGl0cyBzaXplCiAgICAgICAgdWludDhbQk9BUkRfU0laRV0gbWVtb3J5IGdyb3VwUG9zaXRpb25zOwogICAgICAgIHVpbnQ4IGdyb3VwU2l6ZSA9IDA7CiAgICAgICAgCiAgICAgICAgLy8gRmxhZ2dpbmcgdmlzaXRlZCBsb2NhdGlvbnMKICAgICAgICB1aW50OFtTSFJJTktFRF9CT0FSRF9TSVpFXSBtZW1vcnkgdmlzaXRlZDsKCiAgICAgICAgLy8gU3RhY2sgb2Ygd2FpdGluZyBwb3NpdGlvbnMsIHRoZSBmaXJzdCBwb3NpdGlvbiB0byBjaGVjayBpcyB0aGUgc2VudCBwb3NpdGlvbgogICAgICAgIHVpbnQ4W0JPQVJEX1NJWkVdIG1lbW9yeSBzdGFjazsKICAgICAgICBzdGFja1swXSA9IHBvc2l0aW9uOwogICAgICAgIHVpbnQ4IHN0YWNrU2l6ZSA9IDE7CgogICAgICAgIC8vIFRoYXQgcG9zaXRpb24gd2FzIGFkZGVkIHRvIHRoZSBzdGFjawogICAgICAgIHNldEZsYWcodmlzaXRlZCwgcG9zaXRpb24sIEZMQUdfUE9TSVRJT05fV0FTX0lOX1NUQUNLKTsKCiAgICAgICAgLy8gUnVuIGFzIGxvbmcgYXMgdGhlcmUgYXJlIHBvc2l0aW9ucyBpbiB0aGUgc3RhY2sKICAgICAgICB3aGlsZSAoc3RhY2tTaXplID4gMCkgewoKICAgICAgICAgICAgLy8gVGFrZSB0aGUgbGFzdCBwb3NpdGlvbiBhbmQgY2xlYXIgaXQKICAgICAgICAgICAgcG9zaXRpb24gPSBzdGFja1stLXN0YWNrU2l6ZV07CiAgICAgICAgICAgIHN0YWNrW3N0YWNrU2l6ZV0gPSAwOwoKICAgICAgICAgICAgLy8gT25seSBpZiB3ZSBkaWRuJ3QgdmlzaXQgdGhhdCBzdG9uZSBiZWZvcmUKICAgICAgICAgICAgaWYgKCFpc0ZsYWdTZXQodmlzaXRlZCwgcG9zaXRpb24sIEZMQUdfRElEX1ZJU0lUX1BPU0lUSU9OKSkgewogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBTZXQgdGhlIGZsYWcgc28gd2Ugd29uJ3QgdmlzaXQgaXQgYWdhaW4KICAgICAgICAgICAgICAgIHNldEZsYWcodmlzaXRlZCwgcG9zaXRpb24sIEZMQUdfRElEX1ZJU0lUX1BPU0lUSU9OKTsKCiAgICAgICAgICAgICAgICAvLyBBZGQgdGhhdCBwb3NpdGlvbiB0byB0aGUgcmV0dXJuIHZhbHVlCiAgICAgICAgICAgICAgICBncm91cFBvc2l0aW9uc1tncm91cFNpemUrK10gPSBwb3NpdGlvbjsKCiAgICAgICAgICAgICAgICAvLyBHZXQgdGhhdCBwb3NpdGlvbiBhZGphY2VudCBjZWxscwogICAgICAgICAgICAgICAgdWludDhbTUFYX0FESkFDRU5UX0NFTExTXSBtZW1vcnkgYWRqYWNlbnRBcnJheSA9IGdldEFkamFjZW50Q2VsbHMocG9zaXRpb24pOwoKICAgICAgICAgICAgICAgIC8vIFJ1biBvdmVyIHRoZSBhZGphY2VudCBjZWxscwogICAgICAgICAgICAgICAgZm9yICh1aW50OCBjdXJyQWRqYWNlbnRJbmRleCA9IDA7IGN1cnJBZGphY2VudEluZGV4IDwgTUFYX0FESkFDRU5UX0NFTExTICYmIGFkamFjZW50QXJyYXlbY3VyckFkamFjZW50SW5kZXhdIDwgTUFYX1VJTlQ4OyBjdXJyQWRqYWNlbnRJbmRleCsrKSB7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gR2V0IHRoZSBjdXJyZW50IGFkamFjZW50IGNlbGwgY29sb3IKICAgICAgICAgICAgICAgICAgICB1aW50OCBjdXJyQ29sb3IgPSBib2FyZC5wb3NpdGlvblRvQ29sb3JbYWRqYWNlbnRBcnJheVtjdXJyQWRqYWNlbnRJbmRleF1dOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIElmIGl0J3MgdGhlIHNhbWUgY29sb3IgYXMgdGhlIG9yaWdpbmFsIHBvc2l0aW9uIGNvbG9yCiAgICAgICAgICAgICAgICAgICAgaWYgKGN1cnJDb2xvciA9PSBwb3NpdGlvbkNvbG9yKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBBZGQgdGhhdCBwb3NpdGlvbiB0byB0aGUgc3RhY2sKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFpc0ZsYWdTZXQodmlzaXRlZCwgYWRqYWNlbnRBcnJheVtjdXJyQWRqYWNlbnRJbmRleF0sIEZMQUdfUE9TSVRJT05fV0FTX0lOX1NUQUNLKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhY2tbc3RhY2tTaXplKytdID0gYWRqYWNlbnRBcnJheVtjdXJyQWRqYWNlbnRJbmRleF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXRGbGFnKHZpc2l0ZWQsIGFkamFjZW50QXJyYXlbY3VyckFkamFjZW50SW5kZXhdLCBGTEFHX1BPU0lUSU9OX1dBU19JTl9TVEFDSyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAvLyBJZiB0aGF0IHBvc2l0aW9uIGlzIGVtcHR5LCB0aGUgZ3JvdXAgaXNuJ3QgY2FwdHVyZWQsIG5vIG5lZWQgdG8gY29udGludWUgcnVubmluZwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY3VyckNvbG9yID09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAoZ3JvdXBQb3NpdGlvbnMsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIEZsYWcgdGhlIGVuZCBvZiB0aGUgZ3JvdXAgYXJyYXkgb25seSBpZiBuZWVkZWQKICAgICAgICBpZiAoZ3JvdXBTaXplIDwgQk9BUkRfU0laRSkgewogICAgICAgICAgICBncm91cFBvc2l0aW9uc1tncm91cFNpemVdID0gTUFYX1VJTlQ4OwogICAgICAgIH0KICAgICAgICAKICAgICAgICAvLyBUaGUgZ3JvdXAgaXMgY2FwdHVyZWQsIHJldHVybiBpdAogICAgICAgIHJldHVybiAoZ3JvdXBQb3NpdGlvbnMsIHRydWUpOwogICAgfQogICAgCiAgICAvLy8gVGhlIG1heCBudW1iZXIgb2YgYWRqYWNlbnQgY2VsbHMgaXMgNAogICAgdWludDggY29uc3RhbnQgTUFYX0FESkFDRU5UX0NFTExTID0gNDsKCiAgICAvLy8gQGRldiByZXR1cm5zIHRoZSBhZGphY2VudCBwb3NpdGlvbnMgZm9yIGEgZ2l2ZW4gcG9zaXRpb24uCiAgICAvLy8gQHBhcmFtIHBvc2l0aW9uIHRvIGdldCBpdHMgYWRqYWNlbnRzLgogICAgLy8vIEByZXR1cm4gdGhlIGFkamFjZW50IHBvc2l0aW9ucyBhcnJheSwgZmlsbGVkIHdpdGggTUFYX0lOVDggaW4gY2FzZSB0aGVyZSBhcmVuJ3QgNCBhZGphY2VudCBwb3NpdGlvbnMuCiAgICBmdW5jdGlvbiBnZXRBZGphY2VudENlbGxzKHVpbnQ4IHBvc2l0aW9uKSBwcml2YXRlIHB1cmUgcmV0dXJucyAodWludDhbTUFYX0FESkFDRU5UX0NFTExTXSkgewoKICAgICAgICAvLyBJbml0IHRoZSByZXR1cm4gYXJyYXkgYW5kIGN1cnJlbnQgaW5kZXgKICAgICAgICB1aW50OFtNQVhfQURKQUNFTlRfQ0VMTFNdIG1lbW9yeSByZXR1cm5DZWxscyA9IFtNQVhfVUlOVDgsIE1BWF9VSU5UOCwgTUFYX1VJTlQ4LCBNQVhfVUlOVDhdOwogICAgICAgIHVpbnQ4IGFkamFjZW50Q2VsbHNJbmRleCA9IDA7CgogICAgICAgIC8vIFNldCB0aGUgdXAgcG9zaXRpb24sIGlmIHJlbGV2YW50CiAgICAgICAgaWYgKHBvc2l0aW9uIC8gQk9BUkRfUk9XX1NJWkUgPiAwKSB7CiAgICAgICAgICAgIHJldHVybkNlbGxzW2FkamFjZW50Q2VsbHNJbmRleCsrXSA9IHBvc2l0aW9uIC0gQk9BUkRfUk9XX1NJWkU7CiAgICAgICAgfQoKICAgICAgICAvLyBTZXQgdGhlIGRvd24gcG9zaXRpb24sIGlmIHJlbGV2YW50CiAgICAgICAgaWYgKHBvc2l0aW9uIC8gQk9BUkRfUk9XX1NJWkUgPCBCT0FSRF9ST1dfU0laRSAtIDEpIHsKICAgICAgICAgICAgcmV0dXJuQ2VsbHNbYWRqYWNlbnRDZWxsc0luZGV4KytdID0gcG9zaXRpb24gKyBCT0FSRF9ST1dfU0laRTsKICAgICAgICB9CgogICAgICAgIC8vIFNldCB0aGUgbGVmdCBwb3NpdGlvbiwgaWYgcmVsZXZhbnQKICAgICAgICBpZiAocG9zaXRpb24gJSBCT0FSRF9ST1dfU0laRSA+IDApIHsKICAgICAgICAgICAgcmV0dXJuQ2VsbHNbYWRqYWNlbnRDZWxsc0luZGV4KytdID0gcG9zaXRpb24gLSAxOwogICAgICAgIH0KCiAgICAgICAgLy8gU2V0IHRoZSByaWdodCBwb3NpdGlvbiwgaWYgcmVsZXZhbnQKICAgICAgICBpZiAocG9zaXRpb24gJSBCT0FSRF9ST1dfU0laRSA8IEJPQVJEX1JPV19TSVpFIC0gMSkgewogICAgICAgICAgICByZXR1cm5DZWxsc1thZGphY2VudENlbGxzSW5kZXgrK10gPSBwb3NpdGlvbiArIDE7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcmV0dXJuQ2VsbHM7CiAgICB9CgogICAgLy8vIEBub3RpY2UgQ2FsY3VsYXRlcyB0aGUgYm9hcmQncyBzY29yZSwgdXNpbmcgYXJlYSBzY29yaW5nLgogICAgLy8vIEBwYXJhbSBib2FyZElkIHRoZSBib2FyZCB0byBjYWxjdWxhdGUgdGhlIHNjb3JlIGZvci4KICAgIC8vLyBAcmV0dXJuIGJsYWNrU2NvcmUgJiB3aGl0ZVNjb3JlLCB0aGUgcGxheWVycycgc2NvcmVzLgogICAgZnVuY3Rpb24gY2FsY3VsYXRlQm9hcmRTY29yZSh1aW50IGJvYXJkSWQpIHB1YmxpYyB2aWV3IHJldHVybnMgKHVpbnQ4IGJsYWNrU2NvcmUsIHVpbnQ4IHdoaXRlU2NvcmUpIHsKCiAgICAgICAgR29Cb2FyZCBzdG9yYWdlIGJvYXJkID0gYWxsQm9hcmRzW2JvYXJkSWRdOwogICAgICAgIHVpbnQ4W0JPQVJEX1NJWkVdIG1lbW9yeSBib2FyZEVtcHR5R3JvdXBzOwogICAgICAgIHVpbnQ4IG1heEVtcHR5R3JvdXBJZDsKICAgICAgICAoYm9hcmRFbXB0eUdyb3VwcywgbWF4RW1wdHlHcm91cElkKSA9IGdldEJvYXJkRW1wdHlHcm91cHMoYm9hcmQpOwogICAgICAgIHVpbnQ4W0JPQVJEX1NJWkVdIG1lbW9yeSBncm91cHNTaXplOwogICAgICAgIHVpbnQ4W0JPQVJEX1NJWkVdIG1lbW9yeSBncm91cHNTdGF0ZTsKICAgICAgICAKICAgICAgICBibGFja1Njb3JlID0gMDsKICAgICAgICB3aGl0ZVNjb3JlID0gMDsKCiAgICAgICAgLy8gQ291bnQgc3RvbmVzIGFuZCBmaW5kIGVtcHR5IHRlcnJpdG9yaWVzCiAgICAgICAgZm9yICh1aW50OCBwb3NpdGlvbiA9IDA7IHBvc2l0aW9uIDwgQk9BUkRfU0laRTsgcG9zaXRpb24rKykgewoKICAgICAgICAgICAgaWYgKFBsYXllckNvbG9yKGJvYXJkLnBvc2l0aW9uVG9Db2xvcltwb3NpdGlvbl0pID09IFBsYXllckNvbG9yLkJsYWNrKSB7CgogICAgICAgICAgICAgICAgYmxhY2tTY29yZSsrOwogICAgICAgICAgICB9IGVsc2UgaWYgKFBsYXllckNvbG9yKGJvYXJkLnBvc2l0aW9uVG9Db2xvcltwb3NpdGlvbl0pID09IFBsYXllckNvbG9yLldoaXRlKSB7CgogICAgICAgICAgICAgICAgd2hpdGVTY29yZSsrOwogICAgICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgICAgIHVpbnQ4IGdyb3VwSWQgPSBib2FyZEVtcHR5R3JvdXBzW3Bvc2l0aW9uXTsKICAgICAgICAgICAgICAgIGdyb3Vwc1NpemVbZ3JvdXBJZF0rKzsKCiAgICAgICAgICAgICAgICAvLyBDaGVja2luZyBpcyBuZWVkZWQgb25seSBpZiB3ZSBkaWRuJ3QgZmluZCB0aGUgZ3JvdXAgaXMgYWRqYWNlbnQgdG8gdGhlIHR3byBjb2xvcnMgYWxyZWFkeQogICAgICAgICAgICAgICAgaWYgKChncm91cHNTdGF0ZVtncm91cElkXSAmIHVpbnQ4KFBsYXllckNvbG9yLkJsYWNrKSA9PSAwKSB8fCAoZ3JvdXBzU3RhdGVbZ3JvdXBJZF0gJiB1aW50OChQbGF5ZXJDb2xvci5XaGl0ZSkgPT0gMCkpIHsKCiAgICAgICAgICAgICAgICAgICAgdWludDhbTUFYX0FESkFDRU5UX0NFTExTXSBtZW1vcnkgYWRqYWNlbnRBcnJheSA9IGdldEFkamFjZW50Q2VsbHMocG9zaXRpb24pOwoKICAgICAgICAgICAgICAgICAgICAvLyBDaGVjayBhZGphY2VudCBjZWxscyB0byBtYXJrIHRoZSBncm91cCdzIGJvdW5kZXJpZXMKICAgICAgICAgICAgICAgICAgICBmb3IgKHVpbnQ4IGN1cnJBZGphY2VudEluZGV4ID0gMDsgY3VyckFkamFjZW50SW5kZXggPCBNQVhfQURKQUNFTlRfQ0VMTFMgJiYgYWRqYWNlbnRBcnJheVtjdXJyQWRqYWNlbnRJbmRleF0gPCBNQVhfVUlOVDg7IGN1cnJBZGphY2VudEluZGV4KyspIHsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIENoZWNrIGlmIHRoZSBncm91cCBoYXMgYSBibGFjayBib3VuZHJ5CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgoUGxheWVyQ29sb3IoYm9hcmQucG9zaXRpb25Ub0NvbG9yW2FkamFjZW50QXJyYXlbY3VyckFkamFjZW50SW5kZXhdXSkgPT0gUGxheWVyQ29sb3IuQmxhY2spICYmIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgKGdyb3Vwc1N0YXRlW2dyb3VwSWRdICYgdWludDgoUGxheWVyQ29sb3IuQmxhY2spID09IDApKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JvdXBzU3RhdGVbZ3JvdXBJZF0gfD0gdWludDgoUGxheWVyQ29sb3IuQmxhY2spOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQ2hlY2sgaWYgdGhlIGdyb3VwIGhhcyBhIHdoaXRlIGJvdW5kcnkKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICgoUGxheWVyQ29sb3IoYm9hcmQucG9zaXRpb25Ub0NvbG9yW2FkamFjZW50QXJyYXlbY3VyckFkamFjZW50SW5kZXhdXSkgPT0gUGxheWVyQ29sb3IuV2hpdGUpICYmIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChncm91cHNTdGF0ZVtncm91cElkXSAmIHVpbnQ4KFBsYXllckNvbG9yLldoaXRlKSA9PSAwKSkgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyb3Vwc1N0YXRlW2dyb3VwSWRdIHw9IHVpbnQ4KFBsYXllckNvbG9yLldoaXRlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gQWRkIHRlcnJpdG9yaWVzIHNpemUgdG8gdGhlIHJlbGV2YW50IHBsYXllcgogICAgICAgIGZvciAodWludDggY3Vyckdyb3VwSWQgPSAxOyBjdXJyR3JvdXBJZCA8IG1heEVtcHR5R3JvdXBJZDsgY3Vyckdyb3VwSWQrKykgewogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQ2hlY2sgaWYgaXQncyBhIGJsYWNrIHRlcnJpdG9yeQogICAgICAgICAgICBpZiAoKGdyb3Vwc1N0YXRlW2N1cnJHcm91cElkXSAmIHVpbnQ4KFBsYXllckNvbG9yLkJsYWNrKSA+IDApICYmCiAgICAgICAgICAgICAgICAoZ3JvdXBzU3RhdGVbY3Vyckdyb3VwSWRdICYgdWludDgoUGxheWVyQ29sb3IuV2hpdGUpID09IDApKSB7CgogICAgICAgICAgICAgICAgYmxhY2tTY29yZSArPSBncm91cHNTaXplW2N1cnJHcm91cElkXTsKCiAgICAgICAgICAgIC8vIENoZWNrIGlmIGl0J3MgYSB3aGl0ZSB0ZXJyaXRvcnkKICAgICAgICAgICAgfSBlbHNlIGlmICgoZ3JvdXBzU3RhdGVbY3Vyckdyb3VwSWRdICYgdWludDgoUGxheWVyQ29sb3IuV2hpdGUpID4gMCkgJiYKICAgICAgICAgICAgICAgICAgICAgICAoZ3JvdXBzU3RhdGVbY3Vyckdyb3VwSWRdICYgdWludDgoUGxheWVyQ29sb3IuQmxhY2spID09IDApKSB7CgogICAgICAgICAgICAgICAgd2hpdGVTY29yZSArPSBncm91cHNTaXplW2N1cnJHcm91cElkXTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIChibGFja1Njb3JlLCB3aGl0ZVNjb3JlKTsKICAgIH0KCiAgICAvLy8gQGRldiBJRHMgZW1wdHkgZ3JvdXBzIG9uIHRoZSBib2FyZC4KICAgIC8vLyBAcGFyYW0gYm9hcmQgdGhlIGJvYXJkIHRvIG1hcC4KICAgIC8vLyBAcmV0dXJuIGFuIGFycmF5IHRoYXQgY29udGFpbnMgdGhlIG1hcHBlZCBlbXB0eSBncm91cCBpZHMsIGFuZCB0aGUgbWF4IGVtcHR5IGdyb3VwIGlkCiAgICBmdW5jdGlvbiBnZXRCb2FyZEVtcHR5R3JvdXBzKEdvQm9hcmQgc3RvcmFnZSBib2FyZCkgcHJpdmF0ZSB2aWV3IHJldHVybnMgKHVpbnQ4W0JPQVJEX1NJWkVdLCB1aW50OCkgewoKICAgICAgICB1aW50OFtCT0FSRF9TSVpFXSBtZW1vcnkgYm9hcmRFbXB0eUdyb3VwczsKICAgICAgICB1aW50OCBuZXh0R3JvdXBJZCA9IDE7CgogICAgICAgIGZvciAodWludDggcG9zaXRpb24gPSAwOyBwb3NpdGlvbiA8IEJPQVJEX1NJWkU7IHBvc2l0aW9uKyspIHsKCiAgICAgICAgICAgIFBsYXllckNvbG9yIGN1cnJQb3NpdGlvbkNvbG9yID0gUGxheWVyQ29sb3IoYm9hcmQucG9zaXRpb25Ub0NvbG9yW3Bvc2l0aW9uXSk7CgogICAgICAgICAgICBpZiAoKGN1cnJQb3NpdGlvbkNvbG9yID09IFBsYXllckNvbG9yLk5vbmUpICYmIChib2FyZEVtcHR5R3JvdXBzW3Bvc2l0aW9uXSA9PSAwKSkgewoKICAgICAgICAgICAgICAgIHVpbnQ4W0JPQVJEX1NJWkVdIG1lbW9yeSBlbXB0eUdyb3VwOwogICAgICAgICAgICAgICAgYm9vbCBpc0dyb3VwQ2FwdHVyZWQ7CiAgICAgICAgICAgICAgICAoZW1wdHlHcm91cCwgaXNHcm91cENhcHR1cmVkKSA9IGdldEdyb3VwKGJvYXJkLCBwb3NpdGlvbiwgMCk7CgogICAgICAgICAgICAgICAgZm9yICh1aW50OCBjdXJyR3JvdXBJbmRleCA9IDA7IGN1cnJHcm91cEluZGV4IDwgQk9BUkRfU0laRSAmJiBlbXB0eUdyb3VwW2N1cnJHcm91cEluZGV4XSA8IE1BWF9VSU5UODsgY3Vyckdyb3VwSW5kZXgrKykgewoKICAgICAgICAgICAgICAgICAgICBib2FyZEVtcHR5R3JvdXBzW2VtcHR5R3JvdXBbY3Vyckdyb3VwSW5kZXhdXSA9IG5leHRHcm91cElkOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIG5leHRHcm91cElkKys7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiAoYm9hcmRFbXB0eUdyb3VwcywgbmV4dEdyb3VwSWQpOwogICAgfQp9'.
	

]
