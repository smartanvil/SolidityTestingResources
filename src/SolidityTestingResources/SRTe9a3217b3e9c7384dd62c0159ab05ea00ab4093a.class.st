Class {
	#name : #SRTe9a3217b3e9c7384dd62c0159ab05ea00ab4093a,
	#superclass : #SRTContracts,
	#category : #SolidityTestingResources
}

{ #category : #base64 }
SRTe9a3217b3e9c7384dd62c0159ab05ea00ab4093a >> base64 [
	^ 'cHJhZ21hIHNvbGlkaXR5IF4wLjQuMTg7Ci8qKgogKiBNYXRoIG9wZXJhdGlvbnMgd2l0aCBzYWZldHkgY2hlY2tzCiAqLwpsaWJyYXJ5IFNhZmVNYXRoIHsKICBmdW5jdGlvbiBtdWwodWludCBhLCB1aW50IGIpIGludGVybmFsIHB1cmUgcmV0dXJucyAodWludCkgewogICAgdWludCBjID0gYSAqIGI7CiAgICBhc3NlcnQoYSA9PSAwIHx8IGMgLyBhID09IGIpOwogICAgcmV0dXJuIGM7CiAgfQoKICBmdW5jdGlvbiBkaXYodWludCBhLCB1aW50IGIpIGludGVybmFsIHB1cmUgcmV0dXJucyAodWludCkgewogICAgLy8gYXNzZXJ0KGIgPiAwKTsgLy8gU29saWRpdHkgYXV0b21hdGljYWxseSB0aHJvd3Mgd2hlbiBkaXZpZGluZyBieSAwCiAgICB1aW50IGMgPSBhIC8gYjsKICAgIC8vIGFzc2VydChhID09IGIgKiBjICsgYSAlIGIpOyAvLyBUaGVyZSBpcyBubyBjYXNlIGluIHdoaWNoIHRoaXMgZG9lc24ndCBob2xkCiAgICByZXR1cm4gYzsKICB9CgogIGZ1bmN0aW9uIHN1Yih1aW50IGEsIHVpbnQgYikgaW50ZXJuYWwgcHVyZSByZXR1cm5zICh1aW50KSB7CiAgICBhc3NlcnQoYiA8PSBhKTsKICAgIHJldHVybiBhIC0gYjsKICB9CgogIGZ1bmN0aW9uIGFkZCh1aW50IGEsIHVpbnQgYikgaW50ZXJuYWwgcHVyZSByZXR1cm5zICh1aW50KSB7CiAgICB1aW50IGMgPSBhICsgYjsKICAgIGFzc2VydChjID49IGEpOwogICAgcmV0dXJuIGM7CiAgfQoKICBmdW5jdGlvbiBtYXg2NCh1aW50NjQgYSwgdWludDY0IGIpIGludGVybmFsIHB1cmUgcmV0dXJucyAodWludDY0KSB7CiAgICByZXR1cm4gYSA+PSBiID8gYSA6IGI7CiAgfQoKICBmdW5jdGlvbiBtaW42NCh1aW50NjQgYSwgdWludDY0IGIpIGludGVybmFsIHB1cmUgcmV0dXJucyAodWludDY0KSB7CiAgICByZXR1cm4gYSA8IGIgPyBhIDogYjsKICB9CgogIGZ1bmN0aW9uIG1heDI1Nih1aW50MjU2IGEsIHVpbnQyNTYgYikgaW50ZXJuYWwgcHVyZSByZXR1cm5zICh1aW50MjU2KSB7CiAgICByZXR1cm4gYSA+PSBiID8gYSA6IGI7CiAgfQoKICBmdW5jdGlvbiBtaW4yNTYodWludDI1NiBhLCB1aW50MjU2IGIpIGludGVybmFsIHB1cmUgcmV0dXJucyAodWludDI1NikgewogICAgcmV0dXJuIGEgPCBiID8gYSA6IGI7CiAgfQp9CgovLyBFUkMyMCB0b2tlbiBpbnRlcmZhY2UgaXMgaW1wbGVtZW50ZWQgb25seSBwYXJ0aWFsbHkuCmludGVyZmFjZSB0b2tlblJlY2lwaWVudCB7IGZ1bmN0aW9uIHJlY2VpdmVBcHByb3ZhbChhZGRyZXNzIF9mcm9tLCB1aW50MjU2IF92YWx1ZSwgYWRkcmVzcyBfdG9rZW4sIGJ5dGVzIF9leHRyYURhdGEpIHB1YmxpYzsgfQoKY29udHJhY3QgTmFtaUNyb3dkU2FsZSB7CiAgICB1c2luZyBTYWZlTWF0aCBmb3IgdWludDI1NjsKCiAgICAvLy8gTkFDIEJyb2tlciBQcmVzYWxlIFRva2VuCiAgICAvLy8gQGRldiBDb25zdHJ1Y3RvcgogICAgZnVuY3Rpb24gTmFtaUNyb3dkU2FsZShhZGRyZXNzIF9lc2Nyb3csIGFkZHJlc3MgX25hbWlNdWx0aVNpZ1dhbGxldCwgYWRkcmVzcyBfbmFtaVByZXNhbGUpIHB1YmxpYyB7CiAgICAgICAgcmVxdWlyZShfbmFtaU11bHRpU2lnV2FsbGV0ICE9IDB4MCk7CiAgICAgICAgZXNjcm93ID0gX2VzY3JvdzsKICAgICAgICBuYW1pTXVsdGlTaWdXYWxsZXQgPSBfbmFtaU11bHRpU2lnV2FsbGV0OwogICAgICAgIG5hbWlQcmVzYWxlID0gX25hbWlQcmVzYWxlOwogICAgfQoKCiAgICAvKi8KICAgICAqICBDb25zdGFudHMKICAgIC8qLwoKICAgIHN0cmluZyBwdWJsaWMgbmFtZSA9ICJOYW1pIElDTyI7CiAgICBzdHJpbmcgcHVibGljICBzeW1ib2wgPSAiTkFDIjsKICAgIHVpbnQgICBwdWJsaWMgZGVjaW1hbHMgPSAxODsKCiAgICBib29sIHB1YmxpYyBUUkFOU0ZFUkFCTEUgPSBmYWxzZTsgLy8gZGVmYXVsdCBub3QgdHJhbnNmZXJhYmxlCgogICAgdWludCBwdWJsaWMgY29uc3RhbnQgVE9LRU5fU1VQUExZX0xJTUlUID0gMTAwMDAwMDAwMCAqICgxIGV0aGVyIC8gMSB3ZWkpOwogICAgCiAgICB1aW50IHB1YmxpYyBiaW5hcnkgPSAwOwoKICAgIC8qLwogICAgICogIFRva2VuIHN0YXRlCiAgICAvKi8KCiAgICBlbnVtIFBoYXNlIHsKICAgICAgICBDcmVhdGVkLAogICAgICAgIFJ1bm5pbmcsCiAgICAgICAgUGF1c2VkLAogICAgICAgIE1pZ3JhdGluZywKICAgICAgICBNaWdyYXRlZAogICAgfQoKICAgIFBoYXNlIHB1YmxpYyBjdXJyZW50UGhhc2UgPSBQaGFzZS5DcmVhdGVkOwogICAgdWludCBwdWJsaWMgdG90YWxTdXBwbHkgPSAwOyAvLyBhbW91bnQgb2YgdG9rZW5zIGFscmVhZHkgc29sZAoKICAgIC8vIGVzY3JvdyBoYXMgZXhjbHVzaXZlIHByaXZlbGVnZXMgdG8gY2FsbCBhZG1pbmlzdHJhdGl2ZQogICAgLy8gZnVuY3Rpb25zIG9uIHRoaXMgY29udHJhY3QuCiAgICBhZGRyZXNzIHB1YmxpYyBlc2Nyb3c7CgogICAgLy8gR2F0aGVyZWQgZnVuZHMgY2FuIGJlIHdpdGhkcmF3biBvbmx5IHRvIG5hbWltdWx0aXNpZ3dhbGxldCdzIGFkZHJlc3MuCiAgICBhZGRyZXNzIHB1YmxpYyBuYW1pTXVsdGlTaWdXYWxsZXQ7CgogICAgLy8gbmFtaSBwcmVzYWxlIGNvbnRyYWN0CiAgICBhZGRyZXNzIHB1YmxpYyBuYW1pUHJlc2FsZTsKCiAgICAvLyBDcm93ZHNhbGUgbWFuYWdlciBoYXMgZXhjbHVzaXZlIHByaXZlbGVnZXMgdG8gYnVybiBwcmVzYWxlIHRva2Vucy4KICAgIGFkZHJlc3MgcHVibGljIGNyb3dkc2FsZU1hbmFnZXI7CiAgICAKICAgIC8vIGJpbmFyeSBvcHRpb24gYWRkcmVzcwogICAgYWRkcmVzcyBwdWJsaWMgYmluYXJ5QWRkcmVzczsKICAgIAogICAgLy8gVGhpcyBjcmVhdGVzIGFuIGFycmF5IHdpdGggYWxsIGJhbGFuY2VzCiAgICBtYXBwaW5nIChhZGRyZXNzID0+IHVpbnQyNTYpIHB1YmxpYyBiYWxhbmNlT2Y7CiAgICBtYXBwaW5nIChhZGRyZXNzID0+IG1hcHBpbmcgKGFkZHJlc3MgPT4gdWludDI1NikpIHB1YmxpYyBhbGxvd2FuY2U7CgogICAgbW9kaWZpZXIgb25seUNyb3dkc2FsZU1hbmFnZXIoKSB7CiAgICAgICAgcmVxdWlyZShtc2cuc2VuZGVyID09IGNyb3dkc2FsZU1hbmFnZXIpOyAKICAgICAgICBfOyAKICAgIH0KCiAgICBtb2RpZmllciBvbmx5RXNjcm93KCkgewogICAgICAgIHJlcXVpcmUobXNnLnNlbmRlciA9PSBlc2Nyb3cpOwogICAgICAgIF87CiAgICB9CiAgICAKICAgIG1vZGlmaWVyIG9ubHlUcmFuZmVyYWJsZSgpIHsKICAgICAgICByZXF1aXJlKFRSQU5TRkVSQUJMRSk7CiAgICAgICAgXzsKICAgIH0KICAgIAogICAgbW9kaWZpZXIgb25seU5hbWlNdWx0aXNpZygpIHsKICAgICAgICByZXF1aXJlKG1zZy5zZW5kZXIgPT0gbmFtaU11bHRpU2lnV2FsbGV0KTsKICAgICAgICBfOwogICAgfQogICAgCiAgICAvKi8KICAgICAqICBFdmVudHMKICAgIC8qLwoKICAgIGV2ZW50IExvZ0J1eShhZGRyZXNzIGluZGV4ZWQgb3duZXIsIHVpbnQgdmFsdWUpOwogICAgZXZlbnQgTG9nQnVybihhZGRyZXNzIGluZGV4ZWQgb3duZXIsIHVpbnQgdmFsdWUpOwogICAgZXZlbnQgTG9nUGhhc2VTd2l0Y2goUGhhc2UgbmV3UGhhc2UpOwogICAgLy8gTG9nIG1pZ3JhdGUgdG9rZW4KICAgIGV2ZW50IExvZ01pZ3JhdGUoYWRkcmVzcyBfZnJvbSwgYWRkcmVzcyBfdG8sIHVpbnQyNTYgYW1vdW50KTsKICAgIC8vIFRoaXMgZ2VuZXJhdGVzIGEgcHVibGljIGV2ZW50IG9uIHRoZSBibG9ja2NoYWluIHRoYXQgd2lsbCBub3RpZnkgY2xpZW50cwogICAgZXZlbnQgVHJhbnNmZXIoYWRkcmVzcyBpbmRleGVkIGZyb20sIGFkZHJlc3MgaW5kZXhlZCB0bywgdWludDI1NiB2YWx1ZSk7CgogICAgLyovCiAgICAgKiAgUHVibGljIGZ1bmN0aW9ucwogICAgLyovCgogICAgLyoqCiAgICAgKiBJbnRlcm5hbCB0cmFuc2Zlciwgb25seSBjYW4gYmUgY2FsbGVkIGJ5IHRoaXMgY29udHJhY3QKICAgICAqLwogICAgZnVuY3Rpb24gX3RyYW5zZmVyKGFkZHJlc3MgX2Zyb20sIGFkZHJlc3MgX3RvLCB1aW50IF92YWx1ZSkgaW50ZXJuYWwgewogICAgICAgIC8vIFByZXZlbnQgdHJhbnNmZXIgdG8gMHgwIGFkZHJlc3MuIFVzZSBidXJuKCkgaW5zdGVhZAogICAgICAgIHJlcXVpcmUoX3RvICE9IDB4MCk7CiAgICAgICAgLy8gQ2hlY2sgaWYgdGhlIHNlbmRlciBoYXMgZW5vdWdoCiAgICAgICAgcmVxdWlyZShiYWxhbmNlT2ZbX2Zyb21dID49IF92YWx1ZSk7CiAgICAgICAgLy8gQ2hlY2sgZm9yIG92ZXJmbG93cwogICAgICAgIHJlcXVpcmUoYmFsYW5jZU9mW190b10gKyBfdmFsdWUgPiBiYWxhbmNlT2ZbX3RvXSk7CiAgICAgICAgLy8gU2F2ZSB0aGlzIGZvciBhbiBhc3NlcnRpb24gaW4gdGhlIGZ1dHVyZQogICAgICAgIHVpbnQgcHJldmlvdXNCYWxhbmNlcyA9IGJhbGFuY2VPZltfZnJvbV0gKyBiYWxhbmNlT2ZbX3RvXTsKICAgICAgICAvLyBTdWJ0cmFjdCBmcm9tIHRoZSBzZW5kZXIKICAgICAgICBiYWxhbmNlT2ZbX2Zyb21dIC09IF92YWx1ZTsKICAgICAgICAvLyBBZGQgdGhlIHNhbWUgdG8gdGhlIHJlY2lwaWVudAogICAgICAgIGJhbGFuY2VPZltfdG9dICs9IF92YWx1ZTsKICAgICAgICBUcmFuc2ZlcihfZnJvbSwgX3RvLCBfdmFsdWUpOwogICAgICAgIC8vIEFzc2VydHMgYXJlIHVzZWQgdG8gdXNlIHN0YXRpYyBhbmFseXNpcyB0byBmaW5kIGJ1Z3MgaW4geW91ciBjb2RlLiBUaGV5IHNob3VsZCBuZXZlciBmYWlsCiAgICAgICAgYXNzZXJ0KGJhbGFuY2VPZltfZnJvbV0gKyBiYWxhbmNlT2ZbX3RvXSA9PSBwcmV2aW91c0JhbGFuY2VzKTsKICAgIH0KCiAgICAvLyBUcmFuc2ZlciB0aGUgYmFsYW5jZSBmcm9tIG93bmVyJ3MgYWNjb3VudCB0byBhbm90aGVyIGFjY291bnQKICAgIC8vIG9ubHkgZXNjcm93IGNhbiBzZW5kIHRva2VuICh0byBzZW5kIHRva2VuIHByaXZhdGUgc2FsZSkKICAgIGZ1bmN0aW9uIHRyYW5zZmVyRm9yVGVhbShhZGRyZXNzIF90bywgdWludDI1NiBfdmFsdWUpIHB1YmxpYwogICAgICAgIG9ubHlFc2Nyb3cKICAgIHsKICAgICAgICBfdHJhbnNmZXIobXNnLnNlbmRlciwgX3RvLCBfdmFsdWUpOwogICAgfQogICAgCiAgICAvKioKICAgICAqIFRyYW5zZmVyIHRva2VucwogICAgICoKICAgICAqIFNlbmQgYF92YWx1ZWAgdG9rZW5zIHRvIGBfdG9gIGZyb20geW91ciBhY2NvdW50CiAgICAgKgogICAgICogQHBhcmFtIF90byBUaGUgYWRkcmVzcyBvZiB0aGUgcmVjaXBpZW50CiAgICAgKiBAcGFyYW0gX3ZhbHVlIHRoZSBhbW91bnQgdG8gc2VuZAogICAgICovCiAgICBmdW5jdGlvbiB0cmFuc2ZlcihhZGRyZXNzIF90bywgdWludDI1NiBfdmFsdWUpIHB1YmxpYwogICAgICAgIG9ubHlUcmFuZmVyYWJsZQogICAgewogICAgICAgIF90cmFuc2Zlcihtc2cuc2VuZGVyLCBfdG8sIF92YWx1ZSk7CiAgICB9CiAgICAKICAgICAgIC8qKgogICAgICogVHJhbnNmZXIgdG9rZW5zIGZyb20gb3RoZXIgYWRkcmVzcwogICAgICoKICAgICAqIFNlbmQgYF92YWx1ZWAgdG9rZW5zIHRvIGBfdG9gIGluIGJlaGFsZiBvZiBgX2Zyb21gCiAgICAgKgogICAgICogQHBhcmFtIF9mcm9tIFRoZSBhZGRyZXNzIG9mIHRoZSBzZW5kZXIKICAgICAqIEBwYXJhbSBfdG8gVGhlIGFkZHJlc3Mgb2YgdGhlIHJlY2lwaWVudAogICAgICogQHBhcmFtIF92YWx1ZSB0aGUgYW1vdW50IHRvIHNlbmQKICAgICAqLwogICAgZnVuY3Rpb24gdHJhbnNmZXJGcm9tKGFkZHJlc3MgX2Zyb20sIGFkZHJlc3MgX3RvLCB1aW50MjU2IF92YWx1ZSkgCiAgICAgICAgcHVibGljCiAgICAgICAgb25seVRyYW5mZXJhYmxlCiAgICAgICAgcmV0dXJucyAoYm9vbCBzdWNjZXNzKQogICAgewogICAgICAgIHJlcXVpcmUoX3ZhbHVlIDw9IGFsbG93YW5jZVtfZnJvbV1bbXNnLnNlbmRlcl0pOyAgICAgLy8gQ2hlY2sgYWxsb3dhbmNlCiAgICAgICAgYWxsb3dhbmNlW19mcm9tXVttc2cuc2VuZGVyXSAtPSBfdmFsdWU7CiAgICAgICAgX3RyYW5zZmVyKF9mcm9tLCBfdG8sIF92YWx1ZSk7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgLyoqCiAgICAgKiBTZXQgYWxsb3dhbmNlIGZvciBvdGhlciBhZGRyZXNzCiAgICAgKgogICAgICogQWxsb3dzIGBfc3BlbmRlcmAgdG8gc3BlbmQgbm8gbW9yZSB0aGFuIGBfdmFsdWVgIHRva2VucyBpbiB5b3VyIGJlaGFsZgogICAgICoKICAgICAqIEBwYXJhbSBfc3BlbmRlciBUaGUgYWRkcmVzcyBhdXRob3JpemVkIHRvIHNwZW5kCiAgICAgKiBAcGFyYW0gX3ZhbHVlIHRoZSBtYXggYW1vdW50IHRoZXkgY2FuIHNwZW5kCiAgICAgKi8KICAgIGZ1bmN0aW9uIGFwcHJvdmUoYWRkcmVzcyBfc3BlbmRlciwgdWludDI1NiBfdmFsdWUpIHB1YmxpYwogICAgICAgIG9ubHlUcmFuZmVyYWJsZQogICAgICAgIHJldHVybnMgKGJvb2wgc3VjY2VzcykgCiAgICB7CiAgICAgICAgYWxsb3dhbmNlW21zZy5zZW5kZXJdW19zcGVuZGVyXSA9IF92YWx1ZTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICAvKioKICAgICAqIFNldCBhbGxvd2FuY2UgZm9yIG90aGVyIGFkZHJlc3MgYW5kIG5vdGlmeQogICAgICoKICAgICAqIEFsbG93cyBgX3NwZW5kZXJgIHRvIHNwZW5kIG5vIG1vcmUgdGhhbiBgX3ZhbHVlYCB0b2tlbnMgaW4geW91ciBiZWhhbGYsIGFuZCB0aGVuIHBpbmcgdGhlIGNvbnRyYWN0IGFib3V0IGl0CiAgICAgKgogICAgICogQHBhcmFtIF9zcGVuZGVyIFRoZSBhZGRyZXNzIGF1dGhvcml6ZWQgdG8gc3BlbmQKICAgICAqIEBwYXJhbSBfdmFsdWUgdGhlIG1heCBhbW91bnQgdGhleSBjYW4gc3BlbmQKICAgICAqIEBwYXJhbSBfZXh0cmFEYXRhIHNvbWUgZXh0cmEgaW5mb3JtYXRpb24gdG8gc2VuZCB0byB0aGUgYXBwcm92ZWQgY29udHJhY3QKICAgICAqLwogICAgZnVuY3Rpb24gYXBwcm92ZUFuZENhbGwoYWRkcmVzcyBfc3BlbmRlciwgdWludDI1NiBfdmFsdWUsIGJ5dGVzIF9leHRyYURhdGEpCiAgICAgICAgcHVibGljCiAgICAgICAgb25seVRyYW5mZXJhYmxlCiAgICAgICAgcmV0dXJucyAoYm9vbCBzdWNjZXNzKSAKICAgIHsKICAgICAgICB0b2tlblJlY2lwaWVudCBzcGVuZGVyID0gdG9rZW5SZWNpcGllbnQoX3NwZW5kZXIpOwogICAgICAgIGlmIChhcHByb3ZlKF9zcGVuZGVyLCBfdmFsdWUpKSB7CiAgICAgICAgICAgIHNwZW5kZXIucmVjZWl2ZUFwcHJvdmFsKG1zZy5zZW5kZXIsIF92YWx1ZSwgdGhpcywgX2V4dHJhRGF0YSk7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgIH0KCiAgICAvLyBhbGxvd3MgdHJhbnNmZXIgdG9rZW4KICAgIGZ1bmN0aW9uIGNoYW5nZVRyYW5zZmVyYWJsZSAoKSBwdWJsaWMKICAgICAgICBvbmx5RXNjcm93CiAgICB7CiAgICAgICAgVFJBTlNGRVJBQkxFID0gIVRSQU5TRkVSQUJMRTsKICAgIH0KICAgIAogICAgLy8gY2hhbmdlIGVzY3JvdwogICAgZnVuY3Rpb24gY2hhbmdlRXNjcm93KGFkZHJlc3MgX2VzY3JvdykgcHVibGljCiAgICAgICAgb25seU5hbWlNdWx0aXNpZwogICAgewogICAgICAgIHJlcXVpcmUoX2VzY3JvdyAhPSAweDApOwogICAgICAgIGVzY3JvdyA9IF9lc2Nyb3c7CiAgICB9CiAgICAKICAgIC8vIGNoYW5nZSBiaW5hcnkgdmFsdWUKICAgIGZ1bmN0aW9uIGNoYW5nZUJpbmFyeSh1aW50IF9iaW5hcnkpCiAgICAgICAgcHVibGljCiAgICAgICAgb25seUVzY3JvdwogICAgewogICAgICAgIGJpbmFyeSA9IF9iaW5hcnk7CiAgICB9CiAgICAKICAgIC8vIGNoYW5nZSBiaW5hcnkgYWRkcmVzcwogICAgZnVuY3Rpb24gY2hhbmdlQmluYXJ5QWRkcmVzcyhhZGRyZXNzIF9iaW5hcnlBZGRyZXNzKQogICAgICAgIHB1YmxpYwogICAgICAgIG9ubHlFc2Nyb3cKICAgIHsKICAgICAgICByZXF1aXJlKF9iaW5hcnlBZGRyZXNzICE9IDB4MCk7CiAgICAgICAgYmluYXJ5QWRkcmVzcyA9IF9iaW5hcnlBZGRyZXNzOwogICAgfQogICAgCiAgICAvKgogICAgKiBwcmljZSBpbiBJQ086CiAgICAqIGZpcnN0IHdlZWs6IDEgRVRIID0gMjQwMCBOQUMKICAgICogc2Vjb25kIHdlZWs6IDEgRVRIID0gMjMwMDAgTkFDCiAgICAqIDNyZCB3ZWVrOiAxIEVUSCA9IDIyMDAgTkFDCiAgICAqIDR0aCB3ZWVrOiAxIEVUSCA9IDIxMDAgTkFDCiAgICAqIDV0aCB3ZWVrOiAxIEVUSCA9IDIwMDAgTkFDCiAgICAqIDZ0aCB3ZWVrOiAxIEVUSCA9IDE5MDAgTkFDCiAgICAqIDd0aCB3ZWVrOiAxIEVUSCA9IDE4MDAgTkFDCiAgICAqIDh0aCB3ZWVrOiAxIEVUSCA9IDE3MDAgbmFjCiAgICAqIHRpbWU6IAogICAgKiAxNTE3NDQzMjAwOiBUaHVyc2RheSwgRmVicnVhcnkgMSwgMjAxOCAxMjowMDowMCBBTQogICAgKiAxNTE4MDQ4MDAwOiBUaHVyc2RheSwgRmVicnVhcnkgOCwgMjAxOCAxMjowMDowMCBBTQogICAgKiAxNTE4NjUyODAwOiBUaHVyc2RheSwgRmVicnVhcnkgMTUsIDIwMTggMTI6MDA6MDAgQU0KICAgICogMTUxOTI1NzYwMDogVGh1cnNkYXksIEZlYnJ1YXJ5IDIyLCAyMDE4IDEyOjAwOjAwIEFNCiAgICAqIDE1MTk4NjI0MDA6IFRodXJzZGF5LCBNYXJjaCAxLCAyMDE4IDEyOjAwOjAwIEFNCiAgICAqIDE1MjA0NjcyMDA6IFRodXJzZGF5LCBNYXJjaCA4LCAyMDE4IDEyOjAwOjAwIEFNCiAgICAqIDE1MjEwNzIwMDA6IFRodXJzZGF5LCBNYXJjaCAxNSwgMjAxOCAxMjowMDowMCBBTQogICAgKiAxNTIxNjc2ODAwOiBUaHVyc2RheSwgTWFyY2ggMjIsIDIwMTggMTI6MDA6MDAgQU0KICAgICogMTUyMjI4MTYwMDogVGh1cnNkYXksIE1hcmNoIDI5LCAyMDE4IDEyOjAwOjAwIEFNCiAgICAqLwogICAgZnVuY3Rpb24gZ2V0UHJpY2UoKSBwdWJsaWMgdmlldyByZXR1cm5zICh1aW50IHByaWNlKSB7CiAgICAgICAgaWYgKG5vdyA8IDE1MTc0NDMyMDApIHsKICAgICAgICAgICAgLy8gcHJlc2FsZQogICAgICAgICAgICByZXR1cm4gMzQ1MDsKICAgICAgICB9IGVsc2UgaWYgKDE1MTc0NDMyMDAgPCBub3cgJiYgbm93IDw9IDE1MTgwNDgwMDApIHsKICAgICAgICAgICAgLy8gMXN0IHdlZWsKICAgICAgICAgICAgcmV0dXJuIDI0MDA7CiAgICAgICAgfSBlbHNlIGlmICgxNTE4MDQ4MDAwIDwgbm93ICYmIG5vdyA8PSAxNTE4NjUyODAwKSB7CiAgICAgICAgICAgIC8vIDJuZCB3ZWVrCiAgICAgICAgICAgIHJldHVybiAyMzAwOwogICAgICAgIH0gZWxzZSBpZiAoMTUxODY1MjgwMCA8IG5vdyAmJiBub3cgPD0gMTUxOTI1NzYwMCkgewogICAgICAgICAgICAvLyAzcmQgd2VlawogICAgICAgICAgICByZXR1cm4gMjIwMDsKICAgICAgICB9IGVsc2UgaWYgKDE1MTkyNTc2MDAgPCBub3cgJiYgbm93IDw9IDE1MTk4NjI0MDApIHsKICAgICAgICAgICAgLy8gNHRoIHdlZWsKICAgICAgICAgICAgcmV0dXJuIDIxMDA7CiAgICAgICAgfSBlbHNlIGlmICgxNTE5ODYyNDAwIDwgbm93ICYmIG5vdyA8PSAxNTIwNDY3MjAwKSB7CiAgICAgICAgICAgIC8vIDV0aCB3ZWVrCiAgICAgICAgICAgIHJldHVybiAyMDAwOwogICAgICAgIH0gZWxzZSBpZiAoMTUyMDQ2NzIwMCA8IG5vdyAmJiBub3cgPD0gMTUyMTA3MjAwMCkgewogICAgICAgICAgICAvLyA2dGggd2VlawogICAgICAgICAgICByZXR1cm4gMTkwMDsKICAgICAgICB9IGVsc2UgaWYgKDE1MjEwNzIwMDAgPCBub3cgJiYgbm93IDw9IDE1MjE2NzY4MDApIHsKICAgICAgICAgICAgLy8gN3RoIHdlZWsKICAgICAgICAgICAgcmV0dXJuIDE4MDA7CiAgICAgICAgfSBlbHNlIGlmICgxNTIxNjc2ODAwIDwgbm93ICYmIG5vdyA8PSAxNTIyMjgxNjAwKSB7CiAgICAgICAgICAgIC8vIDh0aCB3ZWVrCiAgICAgICAgICAgIHJldHVybiAxNzAwOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBiaW5hcnk7CiAgICAgICAgfQogICAgfQoKCiAgICBmdW5jdGlvbigpIHBheWFibGUgcHVibGljIHsKICAgICAgICBidXkobXNnLnNlbmRlcik7CiAgICB9CiAgICAKICAgIAogICAgZnVuY3Rpb24gYnV5KGFkZHJlc3MgX2J1eWVyKSBwYXlhYmxlIHB1YmxpYyB7CiAgICAgICAgLy8gQXZhaWxhYmxlIG9ubHkgaWYgcHJlc2FsZSBpcyBydW5uaW5nLgogICAgICAgIHJlcXVpcmUoY3VycmVudFBoYXNlID09IFBoYXNlLlJ1bm5pbmcpOwogICAgICAgIC8vIHJlcXVpcmUgSUNPIHRpbWUgb3IgYmluYXJ5IG9wdGlvbgogICAgICAgIHJlcXVpcmUobm93IDw9IDE1MjIyODE2MDAgfHwgbXNnLnNlbmRlciA9PSBiaW5hcnlBZGRyZXNzKTsKICAgICAgICByZXF1aXJlKG1zZy52YWx1ZSAhPSAwKTsKICAgICAgICB1aW50IG5ld1Rva2VucyA9IG1zZy52YWx1ZSAqIGdldFByaWNlKCk7CiAgICAgICAgcmVxdWlyZSAodG90YWxTdXBwbHkgKyBuZXdUb2tlbnMgPCBUT0tFTl9TVVBQTFlfTElNSVQpOwogICAgICAgIC8vIGFkZCBuZXcgdG9rZW4gdG8gYnV5ZXIKICAgICAgICBiYWxhbmNlT2ZbX2J1eWVyXSA9IGJhbGFuY2VPZltfYnV5ZXJdLmFkZChuZXdUb2tlbnMpOwogICAgICAgIC8vIGFkZCBuZXcgdG9rZW4gdG8gdG90YWxTdXBwbHkKICAgICAgICB0b3RhbFN1cHBseSA9IHRvdGFsU3VwcGx5LmFkZChuZXdUb2tlbnMpOwogICAgICAgIExvZ0J1eShfYnV5ZXIsbmV3VG9rZW5zKTsKICAgICAgICBUcmFuc2Zlcih0aGlzLF9idXllcixuZXdUb2tlbnMpOwogICAgfQogICAgCgogICAgLy8vIEBkZXYgUmV0dXJucyBudW1iZXIgb2YgdG9rZW5zIG93bmVkIGJ5IGdpdmVuIGFkZHJlc3MuCiAgICAvLy8gQHBhcmFtIF9vd25lciBBZGRyZXNzIG9mIHRva2VuIG93bmVyLgogICAgZnVuY3Rpb24gYnVyblRva2VucyhhZGRyZXNzIF9vd25lcikgcHVibGljCiAgICAgICAgb25seUNyb3dkc2FsZU1hbmFnZXIKICAgIHsKICAgICAgICAvLyBBdmFpbGFibGUgb25seSBkdXJpbmcgbWlncmF0aW9uIHBoYXNlCiAgICAgICAgcmVxdWlyZShjdXJyZW50UGhhc2UgPT0gUGhhc2UuTWlncmF0aW5nKTsKCiAgICAgICAgdWludCB0b2tlbnMgPSBiYWxhbmNlT2ZbX293bmVyXTsKICAgICAgICByZXF1aXJlKHRva2VucyAhPSAwKTsKICAgICAgICBiYWxhbmNlT2ZbX293bmVyXSA9IDA7CiAgICAgICAgdG90YWxTdXBwbHkgLT0gdG9rZW5zOwogICAgICAgIExvZ0J1cm4oX293bmVyLCB0b2tlbnMpOwogICAgICAgIFRyYW5zZmVyKF9vd25lciwgY3Jvd2RzYWxlTWFuYWdlciwgdG9rZW5zKTsKCiAgICAgICAgLy8gQXV0b21hdGljYWxseSBzd2l0Y2ggcGhhc2Ugd2hlbiBtaWdyYXRpb24gaXMgZG9uZS4KICAgICAgICBpZiAodG90YWxTdXBwbHkgPT0gMCkgewogICAgICAgICAgICBjdXJyZW50UGhhc2UgPSBQaGFzZS5NaWdyYXRlZDsKICAgICAgICAgICAgTG9nUGhhc2VTd2l0Y2goUGhhc2UuTWlncmF0ZWQpOwogICAgICAgIH0KICAgIH0KCgogICAgLyovCiAgICAgKiAgQWRtaW5pc3RyYXRpdmUgZnVuY3Rpb25zCiAgICAvKi8KICAgIGZ1bmN0aW9uIHNldFByZXNhbGVQaGFzZShQaGFzZSBfbmV4dFBoYXNlKSBwdWJsaWMKICAgICAgICBvbmx5RXNjcm93CiAgICB7CiAgICAgICAgYm9vbCBjYW5Td2l0Y2hQaGFzZQogICAgICAgICAgICA9ICAoY3VycmVudFBoYXNlID09IFBoYXNlLkNyZWF0ZWQgJiYgX25leHRQaGFzZSA9PSBQaGFzZS5SdW5uaW5nKQogICAgICAgICAgICB8fCAoY3VycmVudFBoYXNlID09IFBoYXNlLlJ1bm5pbmcgJiYgX25leHRQaGFzZSA9PSBQaGFzZS5QYXVzZWQpCiAgICAgICAgICAgICAgICAvLyBzd2l0Y2ggdG8gbWlncmF0aW9uIHBoYXNlIG9ubHkgaWYgY3Jvd2RzYWxlIG1hbmFnZXIgaXMgc2V0CiAgICAgICAgICAgIHx8ICgoY3VycmVudFBoYXNlID09IFBoYXNlLlJ1bm5pbmcgfHwgY3VycmVudFBoYXNlID09IFBoYXNlLlBhdXNlZCkKICAgICAgICAgICAgICAgICYmIF9uZXh0UGhhc2UgPT0gUGhhc2UuTWlncmF0aW5nCiAgICAgICAgICAgICAgICAmJiBjcm93ZHNhbGVNYW5hZ2VyICE9IDB4MCkKICAgICAgICAgICAgfHwgKGN1cnJlbnRQaGFzZSA9PSBQaGFzZS5QYXVzZWQgJiYgX25leHRQaGFzZSA9PSBQaGFzZS5SdW5uaW5nKQogICAgICAgICAgICAgICAgLy8gc3dpdGNoIHRvIG1pZ3JhdGVkIG9ubHkgaWYgZXZlcnl0aW5nIGlzIG1pZ3JhdGVkCiAgICAgICAgICAgIHx8IChjdXJyZW50UGhhc2UgPT0gUGhhc2UuTWlncmF0aW5nICYmIF9uZXh0UGhhc2UgPT0gUGhhc2UuTWlncmF0ZWQKICAgICAgICAgICAgICAgICYmIHRvdGFsU3VwcGx5ID09IDApOwoKICAgICAgICByZXF1aXJlKGNhblN3aXRjaFBoYXNlKTsKICAgICAgICBjdXJyZW50UGhhc2UgPSBfbmV4dFBoYXNlOwogICAgICAgIExvZ1BoYXNlU3dpdGNoKF9uZXh0UGhhc2UpOwogICAgfQoKCiAgICBmdW5jdGlvbiB3aXRoZHJhd0V0aGVyKHVpbnQgX2Ftb3VudCkgcHVibGljCiAgICAgICAgb25seUVzY3JvdwogICAgewogICAgICAgIHJlcXVpcmUobmFtaU11bHRpU2lnV2FsbGV0ICE9IDB4MCk7CiAgICAgICAgLy8gQXZhaWxhYmxlIGF0IGFueSBwaGFzZS4KICAgICAgICBpZiAodGhpcy5iYWxhbmNlID4gMCkgewogICAgICAgICAgICBuYW1pTXVsdGlTaWdXYWxsZXQudHJhbnNmZXIoX2Ftb3VudCk7CiAgICAgICAgfQogICAgfQogICAgCiAgICBmdW5jdGlvbiBzYWZlV2l0aGRyYXcoYWRkcmVzcyBfd2l0aGRyYXcsIHVpbnQgX2Ftb3VudCkgcHVibGljCiAgICAgICAgb25seUVzY3JvdwogICAgewogICAgICAgIE5hbWlNdWx0aVNpZ1dhbGxldCBuYW1pV2FsbGV0ID0gTmFtaU11bHRpU2lnV2FsbGV0KG5hbWlNdWx0aVNpZ1dhbGxldCk7CiAgICAgICAgaWYgKG5hbWlXYWxsZXQuaXNPd25lcihfd2l0aGRyYXcpKSB7CiAgICAgICAgICAgIF93aXRoZHJhdy50cmFuc2ZlcihfYW1vdW50KTsKICAgICAgICB9CiAgICB9CgoKICAgIGZ1bmN0aW9uIHNldENyb3dkc2FsZU1hbmFnZXIoYWRkcmVzcyBfbWdyKSBwdWJsaWMKICAgICAgICBvbmx5RXNjcm93CiAgICB7CiAgICAgICAgLy8gWW91IGNhbid0IGNoYW5nZSBjcm93ZHNhbGUgY29udHJhY3Qgd2hlbiBtaWdyYXRpb24gaXMgaW4gcHJvZ3Jlc3MuCiAgICAgICAgcmVxdWlyZShjdXJyZW50UGhhc2UgIT0gUGhhc2UuTWlncmF0aW5nKTsKICAgICAgICBjcm93ZHNhbGVNYW5hZ2VyID0gX21ncjsKICAgIH0KCiAgICAvLyBpbnRlcm5hbCBtaWdyYXRlIG1pZ3JhdGlvbiB0b2tlbnMKICAgIGZ1bmN0aW9uIF9taWdyYXRlVG9rZW4oYWRkcmVzcyBfZnJvbSwgYWRkcmVzcyBfdG8pCiAgICAgICAgaW50ZXJuYWwKICAgIHsKICAgICAgICBQcmVzYWxlVG9rZW4gcHJlc2FsZSA9IFByZXNhbGVUb2tlbihuYW1pUHJlc2FsZSk7CiAgICAgICAgdWludDI1NiBuZXdUb2tlbiA9IHByZXNhbGUuYmFsYW5jZU9mKF9mcm9tKTsKICAgICAgICByZXF1aXJlKG5ld1Rva2VuID4gMCk7CiAgICAgICAgLy8gYnVybiBvbGQgdG9rZW4KICAgICAgICBwcmVzYWxlLmJ1cm5Ub2tlbnMoX2Zyb20pOwogICAgICAgIC8vIGFkZCBuZXcgdG9rZW4gdG8gX3RvCiAgICAgICAgYmFsYW5jZU9mW190b10gPSBiYWxhbmNlT2ZbX3RvXS5hZGQobmV3VG9rZW4pOwogICAgICAgIC8vIGFkZCBuZXcgdG9rZW4gdG8gdG90YWxTdXBwbHkKICAgICAgICB0b3RhbFN1cHBseSA9IHRvdGFsU3VwcGx5LmFkZChuZXdUb2tlbik7CiAgICAgICAgTG9nTWlncmF0ZShfZnJvbSwgX3RvLCBuZXdUb2tlbik7CiAgICAgICAgVHJhbnNmZXIodGhpcyxfdG8sbmV3VG9rZW4pOwogICAgfQoKICAgIC8vIG1pZ2F0ZSB0b2tlbiBmdW5jdGlvbiBmb3IgTmFtaSBUZWFtCiAgICBmdW5jdGlvbiBtaWdyYXRlVG9rZW4oYWRkcmVzcyBfZnJvbSwgYWRkcmVzcyBfdG8pIHB1YmxpYwogICAgICAgIG9ubHlFc2Nyb3cKICAgIHsKICAgICAgICBfbWlncmF0ZVRva2VuKF9mcm9tLCBfdG8pOwogICAgfQoKICAgIC8vIG1pZ3JhdGUgdG9rZW4gZm9yIGludmVzdG9yCiAgICBmdW5jdGlvbiBtaWdyYXRlRm9ySW52ZXN0b3IoKSBwdWJsaWMgewogICAgICAgIF9taWdyYXRlVG9rZW4obXNnLnNlbmRlciwgbXNnLnNlbmRlcik7CiAgICB9CgogICAgLy8gTmFtaSBpbnRlcm5hbCBleGNoYW5nZQogICAgCiAgICAvLyBldmVudCBmb3IgTmFtaSBleGNoYW5nZQogICAgZXZlbnQgVHJhbnNmZXJUb0J1eWVyKGFkZHJlc3MgaW5kZXhlZCBfZnJvbSwgYWRkcmVzcyBpbmRleGVkIF90bywgdWludCBfdmFsdWUsIGFkZHJlc3MgaW5kZXhlZCBfc2VsbGVyKTsKICAgIGV2ZW50IFRyYW5zZmVyVG9FeGNoYW5nZShhZGRyZXNzIGluZGV4ZWQgX2Zyb20sIGFkZHJlc3MgaW5kZXhlZCBfdG8sIHVpbnQgX3ZhbHVlLCB1aW50IF9wcmljZSk7CiAgICAKICAgIAogICAgLyoqCiAgICAgKiBAZGV2IFRyYW5zZmVyIHRoZSBzcGVjaWZpZWQgYW1vdW50IG9mIHRva2VucyB0byB0aGUgTmFtaUV4Y2hhbmdlIGFkZHJlc3MuCiAgICAgKiAgICAgIEludm9rZXMgdGhlIGB0b2tlbkZhbGxiYWNrRXhjaGFuZ2VgIGZ1bmN0aW9uLgogICAgICogICAgICBUaGUgdG9rZW4gdHJhbnNmZXIgZmFpbHMgaWYgdGhlIHJlY2lwaWVudCBpcyBhIGNvbnRyYWN0CiAgICAgKiAgICAgIGJ1dCBkb2VzIG5vdCBpbXBsZW1lbnQgdGhlIGB0b2tlbkZhbGxiYWNrRXhjaGFuZ2VgIGZ1bmN0aW9uCiAgICAgKiAgICAgIG9yIHRoZSBmYWxsYmFjayBmdW5jdGlvbiB0byByZWNlaXZlIGZ1bmRzLgogICAgICoKICAgICAqIEBwYXJhbSBfdG8gICAgUmVjZWl2ZXIgYWRkcmVzcy4KICAgICAqIEBwYXJhbSBfdmFsdWUgQW1vdW50IG9mIHRva2VucyB0aGF0IHdpbGwgYmUgdHJhbnNmZXJyZWQuCiAgICAgKiBAcGFyYW0gX3ByaWNlIHByaWNlIHRvIHNlbGwgdG9rZW4uCiAgICAgKi8KICAgICAKICAgIGZ1bmN0aW9uIHRyYW5zZmVyVG9FeGNoYW5nZShhZGRyZXNzIF90bywgdWludCBfdmFsdWUsIHVpbnQgX3ByaWNlKSBwdWJsaWMgewogICAgICAgIHVpbnQgY29kZUxlbmd0aDsKICAgICAgICAKICAgICAgICBhc3NlbWJseSB7CiAgICAgICAgICAgIGNvZGVMZW5ndGggOj0gZXh0Y29kZXNpemUoX3RvKQogICAgICAgIH0KICAgICAgICAKICAgICAgICBiYWxhbmNlT2ZbbXNnLnNlbmRlcl0gPSBiYWxhbmNlT2ZbbXNnLnNlbmRlcl0uc3ViKF92YWx1ZSk7CiAgICAgICAgYmFsYW5jZU9mW190b10gPSBiYWxhbmNlT2ZbX3RvXS5hZGQoX3ZhbHVlKTsKICAgICAgICBUcmFuc2Zlcihtc2cuc2VuZGVyLF90byxfdmFsdWUpOwogICAgICAgIGlmIChjb2RlTGVuZ3RoID4gMCkgewogICAgICAgICAgICBFUkMyMjNSZWNlaXZpbmdDb250cmFjdCByZWNlaXZlciA9IEVSQzIyM1JlY2VpdmluZ0NvbnRyYWN0KF90byk7CiAgICAgICAgICAgIHJlY2VpdmVyLnRva2VuRmFsbGJhY2tFeGNoYW5nZShtc2cuc2VuZGVyLCBfdmFsdWUsIF9wcmljZSk7CiAgICAgICAgICAgIFRyYW5zZmVyVG9FeGNoYW5nZShtc2cuc2VuZGVyLCBfdG8sIF92YWx1ZSwgX3ByaWNlKTsKICAgICAgICB9CiAgICB9CiAgICAKICAgIC8qKgogICAgICogQGRldiBUcmFuc2ZlciB0aGUgc3BlY2lmaWVkIGFtb3VudCBvZiB0b2tlbnMgdG8gdGhlIE5hbWlFeGNoYW5nZSBhZGRyZXNzLgogICAgICogICAgICBJbnZva2VzIHRoZSBgdG9rZW5GYWxsYmFja0J1eWVyYCBmdW5jdGlvbi4KICAgICAqICAgICAgVGhlIHRva2VuIHRyYW5zZmVyIGZhaWxzIGlmIHRoZSByZWNpcGllbnQgaXMgYSBjb250cmFjdAogICAgICogICAgICBidXQgZG9lcyBub3QgaW1wbGVtZW50IHRoZSBgdG9rZW5GYWxsYmFja0J1eWVyYCBmdW5jdGlvbgogICAgICogICAgICBvciB0aGUgZmFsbGJhY2sgZnVuY3Rpb24gdG8gcmVjZWl2ZSBmdW5kcy4KICAgICAqCiAgICAgKiBAcGFyYW0gX3RvICAgIFJlY2VpdmVyIGFkZHJlc3MuCiAgICAgKiBAcGFyYW0gX3ZhbHVlIEFtb3VudCBvZiB0b2tlbnMgdGhhdCB3aWxsIGJlIHRyYW5zZmVycmVkLgogICAgICogQHBhcmFtIF9idXllciBhZGRyZXNzIG9mIHNlbGxlci4KICAgICAqLwogICAgIAogICAgZnVuY3Rpb24gdHJhbnNmZXJUb0J1eWVyKGFkZHJlc3MgX3RvLCB1aW50IF92YWx1ZSwgYWRkcmVzcyBfYnV5ZXIpIHB1YmxpYyB7CiAgICAgICAgdWludCBjb2RlTGVuZ3RoOwogICAgICAgIAogICAgICAgIGFzc2VtYmx5IHsKICAgICAgICAgICAgY29kZUxlbmd0aCA6PSBleHRjb2Rlc2l6ZShfdG8pCiAgICAgICAgfQogICAgICAgIAogICAgICAgIGJhbGFuY2VPZlttc2cuc2VuZGVyXSA9IGJhbGFuY2VPZlttc2cuc2VuZGVyXS5zdWIoX3ZhbHVlKTsKICAgICAgICBiYWxhbmNlT2ZbX3RvXSA9IGJhbGFuY2VPZltfdG9dLmFkZChfdmFsdWUpOwogICAgICAgIFRyYW5zZmVyKG1zZy5zZW5kZXIsX3RvLF92YWx1ZSk7CiAgICAgICAgaWYgKGNvZGVMZW5ndGggPiAwKSB7CiAgICAgICAgICAgIEVSQzIyM1JlY2VpdmluZ0NvbnRyYWN0IHJlY2VpdmVyID0gRVJDMjIzUmVjZWl2aW5nQ29udHJhY3QoX3RvKTsKICAgICAgICAgICAgcmVjZWl2ZXIudG9rZW5GYWxsYmFja0J1eWVyKG1zZy5zZW5kZXIsIF92YWx1ZSwgX2J1eWVyKTsKICAgICAgICAgICAgVHJhbnNmZXJUb0J1eWVyKG1zZy5zZW5kZXIsIF90bywgX3ZhbHVlLCBfYnV5ZXIpOwogICAgICAgIH0KICAgIH0KLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCn0KCgovKgoqIEJpbmFyeSBvcHRpb24gc21hcnQgY29udHJhY3QtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiovCmNvbnRyYWN0IEJpbmFyeU9wdGlvbiB7CiAgICAvKgogICAgICogYmluYXJ5IG9wdGlvbiBjb250cm9sZWQgYnkgZXNjcm93IHRvIGJ1eSBOQUMgd2l0aCBnb29kIHByaWNlCiAgICAgKi8KICAgIC8vIE5hbWlDcm93ZFNhbGUgYWRkcmVzcwogICAgYWRkcmVzcyBwdWJsaWMgbmFtaUNyb3dkU2FsZUFkZHI7CiAgICBhZGRyZXNzIHB1YmxpYyBlc2Nyb3c7CiAgICAKICAgIC8vIG5hbWlNdWx0aVNpZ1dhbGxldAogICAgYWRkcmVzcyBwdWJsaWMgbmFtaU11bHRpU2lnV2FsbGV0OwogICAgCiAgICBTZXNzaW9uIHB1YmxpYyBzZXNzaW9uOwogICAgdWludCBwdWJsaWMgdGltZUludmVzdEluTWludXRlID0gMTA7CiAgICB1aW50IHB1YmxpYyB0aW1lT25lU2Vzc2lvbiA9IDE1OwogICAgdWludCBwdWJsaWMgc2Vzc2lvbklkID0gMTsKICAgIHVpbnQgcHVibGljIHJhdGVXaW4gPSAxMDA7CiAgICB1aW50IHB1YmxpYyByYXRlTG9zcyA9IDIwOwogICAgdWludCBwdWJsaWMgcmF0ZUZlZSA9IDU7CiAgICB1aW50IHB1YmxpYyBjb25zdGFudCBNQVhfSU5WRVNUT1IgPSAyMDsKICAgIHVpbnQgcHVibGljIG1pbmltdW5FdGggPSAxMDAwMDAwMDAwMDAwMDAwMDsgLy8gbWluaW11bkV0aCA9IDAuMDEgZXRoCiAgICAvKioKICAgICAqIEV2ZW50cyBmb3IgYmluYW55IG9wdGlvbiBzeXN0ZW0KICAgICAqLwogICAgZXZlbnQgU2Vzc2lvbk9wZW4odWludCB0aW1lT3BlbiwgdWludCBpbmRleGVkIHNlc3Npb25JZCk7CiAgICBldmVudCBJbnZlc3RDbG9zZSh1aW50IHRpbWVJbnZlc3RDbG9zZSwgdWludCBwcmljZU9wZW4sIHVpbnQgaW5kZXhlZCBzZXNzaW9uSWQpOwogICAgZXZlbnQgSW52ZXN0KGFkZHJlc3MgaW5kZXhlZCBpbnZlc3RvciwgYm9vbCBjaG9vc2UsIHVpbnQgYW1vdW50LCB1aW50IHRpbWVJbnZlc3QsIHVpbnQgaW5kZXhlZCBzZXNzaW9uSWQpOwogICAgZXZlbnQgU2Vzc2lvbkNsb3NlKHVpbnQgdGltZUNsb3NlLCB1aW50IGluZGV4ZWQgc2Vzc2lvbklkLCB1aW50IHByaWNlQ2xvc2UsIHVpbnQgbmFjUHJpY2UsIHVpbnQgcmF0ZVdpbiwgdWludCByYXRlTG9zcywgdWludCByYXRlRmVlKTsKCiAgICBldmVudCBEZXBvc2l0KGFkZHJlc3MgaW5kZXhlZCBzZW5kZXIsIHVpbnQgdmFsdWUpOwogICAgLy8vIEBkZXYgRmFsbGJhY2sgZnVuY3Rpb24gYWxsb3dzIHRvIGRlcG9zaXQgZXRoZXIuCiAgICBmdW5jdGlvbigpIHB1YmxpYyBwYXlhYmxlIHsKICAgICAgICBpZiAobXNnLnZhbHVlID4gMCkKICAgICAgICAgICAgRGVwb3NpdChtc2cuc2VuZGVyLCBtc2cudmFsdWUpOwogICAgfQogICAgLy8gdGhlcmUgaXMgb25seSBvbmUgc2Vzc2lvbiBhdmFpbGFibGUgYXQgb25lIHRpbWVPcGVuCiAgICAvLyBwcmljZU9wZW4gaXMgcHJpY2Ugb2YgRVRIIGluIFVTRAogICAgLy8gcHJpY2VDbG9zZSBpcyBwcmljZSBvZiBFVEggaW4gVVNECiAgICAvLyBwcm9jZXNzIG9mIG9uZSBTZXNzaW9uCiAgICAvLyAxc3Q6IGVzY3JvdyByZXNldCBzZXNzaW9uIGJ5IHJ1biByZXNldFNlc3Npb24oKQogICAgLy8gMm5kOiBlc2Nyb3cgb3BlbiBzZXNzaW9uIGJ5IHJ1biBvcGVuU2Vzc2lvbigpID0+IHNhdmUgdGltZU9wZW4gYXQgdGhpcyB0aW1lCiAgICAvLyAzcmQ6IGFsbCBpbnZlc3RvciBjYW4gaW52ZXN0IGJ5IHJ1biBpbnZlc3QoKSwgc2VuZCBtaW5pbXVtIDAuMSBFVEgKICAgIC8vIDR0aDogZXNjcm93IGNsb3NlIGludmVzdCBhbmQgaW5zZXJ0IHByaWNlIG9wZW4gZm9yIHRoaXMgU2Vzc2lvbgogICAgLy8gNXRoOiBlc2Nyb3cgY2xvc2Ugc2Vzc2lvbiBhbmQgc2VuZCBOQUMgZm9yIGludmVzdG9yCiAgICBzdHJ1Y3QgU2Vzc2lvbiB7CiAgICAgICAgdWludCBwcmljZU9wZW47CiAgICAgICAgdWludCBwcmljZUNsb3NlOwogICAgICAgIHVpbnQgdGltZU9wZW47CiAgICAgICAgYm9vbCBpc1Jlc2V0OwogICAgICAgIGJvb2wgaXNPcGVuOwogICAgICAgIGJvb2wgaW52ZXN0T3BlbjsKICAgICAgICB1aW50IGludmVzdG9yQ291bnQ7CiAgICAgICAgbWFwcGluZyh1aW50ID0+IGFkZHJlc3MpIGludmVzdG9yOwogICAgICAgIG1hcHBpbmcodWludCA9PiBib29sKSB3aW47CiAgICAgICAgbWFwcGluZyh1aW50ID0+IHVpbnQpIGFtb3VudEludmVzdDsKICAgIH0KICAgIAogICAgZnVuY3Rpb24gQmluYXJ5T3B0aW9uKGFkZHJlc3MgX25hbWlDcm93ZFNhbGUsIGFkZHJlc3MgX2VzY3JvdywgYWRkcmVzcyBfbmFtaU11bHRpU2lnV2FsbGV0KSBwdWJsaWMgewogICAgICAgIHJlcXVpcmUoX25hbWlDcm93ZFNhbGUgIT0gMHgwICYmIF9lc2Nyb3cgIT0gMHgwKTsKICAgICAgICBuYW1pQ3Jvd2RTYWxlQWRkciA9IF9uYW1pQ3Jvd2RTYWxlOwogICAgICAgIGVzY3JvdyA9IF9lc2Nyb3c7CiAgICAgICAgbmFtaU11bHRpU2lnV2FsbGV0ID0gX25hbWlNdWx0aVNpZ1dhbGxldDsKICAgIH0KICAgIAogICAgCiAgICBtb2RpZmllciBvbmx5RXNjcm93KCkgewogICAgICAgIHJlcXVpcmUobXNnLnNlbmRlcj09ZXNjcm93KTsKICAgICAgICBfOwogICAgfQogICAgCiAgICAgICAgCiAgICBtb2RpZmllciBvbmx5TmFtaU11bHRpc2lnKCkgewogICAgICAgIHJlcXVpcmUobXNnLnNlbmRlciA9PSBuYW1pTXVsdGlTaWdXYWxsZXQpOwogICAgICAgIF87CiAgICB9CiAgICAKICAgIC8vIGNoYW5nZSBlc2Nyb3cKICAgIGZ1bmN0aW9uIGNoYW5nZUVzY3JvdyhhZGRyZXNzIF9lc2Nyb3cpIHB1YmxpYwogICAgICAgIG9ubHlOYW1pTXVsdGlzaWcKICAgIHsKICAgICAgICByZXF1aXJlKF9lc2Nyb3cgIT0gMHgwKTsKICAgICAgICBlc2Nyb3cgPSBfZXNjcm93OwogICAgfQogICAgCiAgICAvLyBjaGFnbmUgbWluaW11bkV0aAogICAgZnVuY3Rpb24gY2hhbmdlTWluRXRoKHVpbnQgX21pbmltdW5FdGgpIHB1YmxpYyAKICAgICAgICBvbmx5RXNjcm93CiAgICB7CiAgICAgICAgcmVxdWlyZShfbWluaW11bkV0aCAhPSAwKTsKICAgICAgICBtaW5pbXVuRXRoID0gX21pbmltdW5FdGg7CiAgICB9CiAgICAKICAgIC8vLyBAZGV2IENoYW5nZSB0aW1lIGZvciBpbnZlc3RvciBjYW4gaW52ZXN0IGluIG9uZSBzZXNzaW9uLCBjYW4gb25seSBjaGFuZ2UgYXQgdGltZSBub3QgaW4gc2Vzc2lvbgogICAgLy8vIEBwYXJhbSBfdGltZUludmVzdCB0aW1lIGludmVzdCBpbiBtaW51dGVzCiAgICAvLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1jaGFuZ2UgdGltZSBmdW5jdGlvbi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgZnVuY3Rpb24gY2hhbmdlVGltZUludmVzdCh1aW50IF90aW1lSW52ZXN0KQogICAgICAgIHB1YmxpYwogICAgICAgIG9ubHlFc2Nyb3cKICAgIHsKICAgICAgICByZXF1aXJlKCFzZXNzaW9uLmlzT3BlbiAmJiBfdGltZUludmVzdCA8IHRpbWVPbmVTZXNzaW9uKTsKICAgICAgICB0aW1lSW52ZXN0SW5NaW51dGUgPSBfdGltZUludmVzdDsKICAgIH0KCiAgICBmdW5jdGlvbiBjaGFuZ2VUaW1lT25lU2Vzc2lvbih1aW50IF90aW1lT25lU2Vzc2lvbikgCiAgICAgICAgcHVibGljCiAgICAgICAgb25seUVzY3JvdwogICAgewogICAgICAgIHJlcXVpcmUoIXNlc3Npb24uaXNPcGVuICYmIF90aW1lT25lU2Vzc2lvbiA+IHRpbWVJbnZlc3RJbk1pbnV0ZSk7CiAgICAgICAgdGltZU9uZVNlc3Npb24gPSBfdGltZU9uZVNlc3Npb247CiAgICB9CgogICAgLy8vLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1jaGFuZ2UgcmF0ZSBmdW5jdGlvbi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIAogICAgZnVuY3Rpb24gY2hhbmdlUmF0ZVdpbih1aW50IF9yYXRlV2luKQogICAgICAgIHB1YmxpYwogICAgICAgIG9ubHlFc2Nyb3cKICAgIHsKICAgICAgICByZXF1aXJlKCFzZXNzaW9uLmlzT3Blbik7CiAgICAgICAgcmF0ZVdpbiA9IF9yYXRlV2luOwogICAgfQogICAgCiAgICBmdW5jdGlvbiBjaGFuZ2VSYXRlTG9zcyh1aW50IF9yYXRlTG9zcykKICAgICAgICBwdWJsaWMKICAgICAgICBvbmx5RXNjcm93CiAgICB7CiAgICAgICAgcmVxdWlyZSghc2Vzc2lvbi5pc09wZW4pOwogICAgICAgIHJhdGVMb3NzID0gX3JhdGVMb3NzOwogICAgfQogICAgCiAgICBmdW5jdGlvbiBjaGFuZ2VSYXRlRmVlKHVpbnQgX3JhdGVGZWUpCiAgICAgICAgcHVibGljCiAgICAgICAgb25seUVzY3JvdwogICAgewogICAgICAgIHJlcXVpcmUoIXNlc3Npb24uaXNPcGVuKTsKICAgICAgICByYXRlRmVlID0gX3JhdGVGZWU7CiAgICB9CiAgICAKICAgIAogICAgLy8vIEBkZXYgd2l0aGRyYXcgZXRoZXIgdG8gbmFtaSBtdWx0aXNpZ25hdHVyZSB3YWxsZXQsIG9ubHkgZXNjcm93IGNhbiBjYWxsCiAgICAvLy8gQHBhcmFtIF9hbW91bnQgdmFsdWUgZXRoZXIgaW4gd2VpIHRvIHdpdGhkcmF3CiAgICBmdW5jdGlvbiB3aXRoZHJhd0V0aGVyKHVpbnQgX2Ftb3VudCkgcHVibGljCiAgICAgICAgb25seUVzY3JvdwogICAgewogICAgICAgIHJlcXVpcmUobmFtaU11bHRpU2lnV2FsbGV0ICE9IDB4MCk7CiAgICAgICAgLy8gQXZhaWxhYmxlIGF0IGFueSBwaGFzZS4KICAgICAgICBpZiAodGhpcy5iYWxhbmNlID4gMCkgewogICAgICAgICAgICBuYW1pTXVsdGlTaWdXYWxsZXQudHJhbnNmZXIoX2Ftb3VudCk7CiAgICAgICAgfQogICAgfQogICAgCiAgICAvLy8gQGRldiBzYWZlIHdpdGhkcmF3IEV0aGVyIHRvIG9uZSBvZiBvd25lciBvZiBuYW1pIG11bHRpc2lnbmF0dXJlIHdhbGxldAogICAgLy8vIEBwYXJhbSBfd2l0aGRyYXcgYWRkcmVzcyB0byB3aXRoZHJhdwogICAgZnVuY3Rpb24gc2FmZVdpdGhkcmF3KGFkZHJlc3MgX3dpdGhkcmF3LCB1aW50IF9hbW91bnQpIHB1YmxpYwogICAgICAgIG9ubHlFc2Nyb3cKICAgIHsKICAgICAgICBOYW1pTXVsdGlTaWdXYWxsZXQgbmFtaVdhbGxldCA9IE5hbWlNdWx0aVNpZ1dhbGxldChuYW1pTXVsdGlTaWdXYWxsZXQpOwogICAgICAgIGlmIChuYW1pV2FsbGV0LmlzT3duZXIoX3dpdGhkcmF3KSkgewogICAgICAgICAgICBfd2l0aGRyYXcudHJhbnNmZXIoX2Ftb3VudCk7CiAgICAgICAgfQogICAgfQogICAgCiAgICAvLyBAZGV2IFJldHVybnMgbGlzdCBvZiBvd25lcnMuCiAgICAvLyBAcmV0dXJuIExpc3Qgb2Ygb3duZXIgYWRkcmVzc2VzLgogICAgLy8gTUFYX0lOVkVTVE9SID0gMjAKICAgIGZ1bmN0aW9uIGdldEludmVzdG9ycygpCiAgICAgICAgcHVibGljCiAgICAgICAgdmlldwogICAgICAgIHJldHVybnMgKGFkZHJlc3NbMjBdKQogICAgewogICAgICAgIGFkZHJlc3NbMjBdIG1lbW9yeSBsaXN0SW52ZXN0b3I7CiAgICAgICAgZm9yICh1aW50IGkgPSAwOyBpIDwgTUFYX0lOVkVTVE9SOyBpKyspIHsKICAgICAgICAgICAgbGlzdEludmVzdG9yW2ldID0gc2Vzc2lvbi5pbnZlc3RvcltpXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGxpc3RJbnZlc3RvcjsKICAgIH0KICAgIAogICAgZnVuY3Rpb24gZ2V0Q2hvb3NlcygpCiAgICAgICAgcHVibGljCiAgICAgICAgdmlldwogICAgICAgIHJldHVybnMgKGJvb2xbMjBdKQogICAgewogICAgICAgIGJvb2xbMjBdIG1lbW9yeSBsaXN0Q2hvb3NlczsKICAgICAgICBmb3IgKHVpbnQgaSA9IDA7IGkgPCBNQVhfSU5WRVNUT1I7IGkrKykgewogICAgICAgICAgICBsaXN0Q2hvb3Nlc1tpXSA9IHNlc3Npb24ud2luW2ldOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbGlzdENob29zZXM7CiAgICB9CiAgICAKICAgIGZ1bmN0aW9uIGdldEFtb3VudCgpCiAgICAgICAgcHVibGljCiAgICAgICAgdmlldwogICAgICAgIHJldHVybnMgKHVpbnRbMjBdKQogICAgewogICAgICAgIHVpbnRbMjBdIG1lbW9yeSBsaXN0QW1vdW50OwogICAgICAgIGZvciAodWludCBpID0gMDsgaSA8IE1BWF9JTlZFU1RPUjsgaSsrKSB7CiAgICAgICAgICAgIGxpc3RBbW91bnRbaV0gPSBzZXNzaW9uLmFtb3VudEludmVzdFtpXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGxpc3RBbW91bnQ7CiAgICB9CiAgICAKICAgIC8vLyBAZGV2IHJlc2V0IGFsbCBkYXRhIG9mIHByZXZpb3VzIHNlc3Npb24sIG11c3QgcnVuIGJlZm9yZSBvcGVuIG5ldyBzZXNzaW9uCiAgICAvLyBvbmx5IGVzY3JvdyBjYW4gY2FsbAogICAgZnVuY3Rpb24gcmVzZXRTZXNzaW9uKCkKICAgICAgICBwdWJsaWMKICAgICAgICBvbmx5RXNjcm93CiAgICB7CiAgICAgICAgcmVxdWlyZSghc2Vzc2lvbi5pc1Jlc2V0ICYmICFzZXNzaW9uLmlzT3Blbik7CiAgICAgICAgc2Vzc2lvbi5wcmljZU9wZW4gPSAwOwogICAgICAgIHNlc3Npb24ucHJpY2VDbG9zZSA9IDA7CiAgICAgICAgc2Vzc2lvbi5pc1Jlc2V0ID0gdHJ1ZTsKICAgICAgICBzZXNzaW9uLmlzT3BlbiA9IGZhbHNlOwogICAgICAgIHNlc3Npb24uaW52ZXN0T3BlbiA9IGZhbHNlOwogICAgICAgIHNlc3Npb24uaW52ZXN0b3JDb3VudCA9IDA7CiAgICAgICAgZm9yICh1aW50IGkgPSAwOyBpIDwgTUFYX0lOVkVTVE9SOyBpKyspIHsKICAgICAgICAgICAgc2Vzc2lvbi5pbnZlc3RvcltpXSA9IDB4MDsKICAgICAgICAgICAgc2Vzc2lvbi53aW5baV0gPSBmYWxzZTsKICAgICAgICAgICAgc2Vzc2lvbi5hbW91bnRJbnZlc3RbaV0gPSAwOwogICAgICAgIH0KICAgIH0KICAgIAogICAgLy8vIEBkZXYgT3BlbiBuZXcgc2Vzc2lvbiwgb25seSBlc2Nyb3cgY2FuIGNhbGwKICAgIGZ1bmN0aW9uIG9wZW5TZXNzaW9uICgpCiAgICAgICAgcHVibGljCiAgICAgICAgb25seUVzY3JvdwogICAgewogICAgICAgIHJlcXVpcmUoc2Vzc2lvbi5pc1Jlc2V0ICYmICFzZXNzaW9uLmlzT3Blbik7CiAgICAgICAgc2Vzc2lvbi5pc1Jlc2V0ID0gZmFsc2U7CiAgICAgICAgLy8gb3BlbiBpbnZlc3QKICAgICAgICBzZXNzaW9uLmludmVzdE9wZW4gPSB0cnVlOwogICAgICAgIHNlc3Npb24udGltZU9wZW4gPSBub3c7CiAgICAgICAgc2Vzc2lvbi5pc09wZW4gPSB0cnVlOwogICAgICAgIFNlc3Npb25PcGVuKG5vdywgc2Vzc2lvbklkKTsKICAgIH0KICAgIAogICAgLy8vIEBkZXYgRnVjdGlvbiBmb3IgaW52ZXN0b3IsIG1pbmltdW4gZXRoZXIgc2VuZCBpcyAwLjEsIG9uZSBhZGRyZXNzIGNhbiBjYWxsIG9uZSB0aW1lIGluIG9uZSBzZXNzaW9uCiAgICAvLy8gQHBhcmFtIF9jaG9vc2UgY2hvaXNlIG9mIGludmVzdG9yLCB0cnVlIGlzIGNhbGwsIGZhbHNlIGlzIHB1dAogICAgZnVuY3Rpb24gaW52ZXN0IChib29sIF9jaG9vc2UpCiAgICAgICAgcHVibGljCiAgICAgICAgcGF5YWJsZQogICAgewogICAgICAgIHJlcXVpcmUobXNnLnZhbHVlID49IG1pbmltdW5FdGggJiYgc2Vzc2lvbi5pbnZlc3RPcGVuKTsgLy8gbXNnLnZhbHVlID49IDAuMSBldGhlcgogICAgICAgIHJlcXVpcmUobm93IDwgKHNlc3Npb24udGltZU9wZW4gKyB0aW1lSW52ZXN0SW5NaW51dGUgKiAxIG1pbnV0ZXMpKTsKICAgICAgICByZXF1aXJlKHNlc3Npb24uaW52ZXN0b3JDb3VudCA8IE1BWF9JTlZFU1RPUik7CiAgICAgICAgc2Vzc2lvbi5pbnZlc3RvcltzZXNzaW9uLmludmVzdG9yQ291bnRdID0gbXNnLnNlbmRlcjsKICAgICAgICBzZXNzaW9uLndpbltzZXNzaW9uLmludmVzdG9yQ291bnRdID0gX2Nob29zZTsKICAgICAgICBzZXNzaW9uLmFtb3VudEludmVzdFtzZXNzaW9uLmludmVzdG9yQ291bnRdID0gbXNnLnZhbHVlOwogICAgICAgIHNlc3Npb24uaW52ZXN0b3JDb3VudCArPSAxOwogICAgICAgIEludmVzdChtc2cuc2VuZGVyLCBfY2hvb3NlLCBtc2cudmFsdWUsIG5vdywgc2Vzc2lvbklkKTsKICAgIH0KICAgIAogICAgLy8vIEBkZXYgY2xvc2UgaW52ZXN0IGZvciBlc2Nyb3cKICAgIC8vLyBAcGFyYW0gX3ByaWNlT3BlbiBwcmljZSBFVEggaW4gVVNECiAgICBmdW5jdGlvbiBjbG9zZUludmVzdCAodWludCBfcHJpY2VPcGVuKSAKICAgICAgICBwdWJsaWMKICAgICAgICBvbmx5RXNjcm93CiAgICB7CiAgICAgICAgcmVxdWlyZShfcHJpY2VPcGVuICE9IDAgJiYgc2Vzc2lvbi5pbnZlc3RPcGVuKTsKICAgICAgICByZXF1aXJlKG5vdyA+IChzZXNzaW9uLnRpbWVPcGVuICsgdGltZUludmVzdEluTWludXRlICogMSBtaW51dGVzKSk7CiAgICAgICAgc2Vzc2lvbi5pbnZlc3RPcGVuID0gZmFsc2U7CiAgICAgICAgc2Vzc2lvbi5wcmljZU9wZW4gPSBfcHJpY2VPcGVuOwogICAgICAgIEludmVzdENsb3NlKG5vdywgX3ByaWNlT3Blbiwgc2Vzc2lvbklkKTsKICAgIH0KICAgIAogICAgLy8vIEBkZXYgZ2V0IGFtb3VudCBvZiBldGhlciB0byBidXkgTkFDIGZvciBpbnZlc3RvcgogICAgLy8vIEBwYXJhbSBfZXRoZXIgYW1vdW50IGV0aGVyIHdoaWNoIGludmVzdG9yIGludmVzdAogICAgLy8vIEBwYXJhbSBfc3RhdHVzIHRydWUgZm9yIGludmVzdG9yIHdpbiBhbmQgZmFsc2UgZm9yIGludmVzdG9yIGxvc3MKICAgIGZ1bmN0aW9uIGdldEV0aGVyVG9CdXkgKHVpbnQgX2V0aGVyLCBib29sIF9zdGF0dXMpCiAgICAgICAgcHVibGljCiAgICAgICAgdmlldwogICAgICAgIHJldHVybnMgKHVpbnQpCiAgICB7CiAgICAgICAgaWYgKF9zdGF0dXMpIHsKICAgICAgICAgICAgcmV0dXJuIF9ldGhlciAqIHJhdGVXaW4gLyAxMDA7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIF9ldGhlciAqIHJhdGVMb3NzIC8gMTAwOwogICAgICAgIH0KICAgIH0KCiAgICAvLy8gQGRldiBjbG9zZSBzZXNzaW9uLCBvbmx5IGVzY3JvdyBjYW4gY2FsbAogICAgLy8vIEBwYXJhbSBfcHJpY2VDbG9zZSBwcmljZSBvZiBFVEggaW4gVVNECiAgICBmdW5jdGlvbiBjbG9zZVNlc3Npb24gKHVpbnQgX3ByaWNlQ2xvc2UpCiAgICAgICAgcHVibGljCiAgICAgICAgb25seUVzY3JvdwogICAgewogICAgICAgIHJlcXVpcmUoX3ByaWNlQ2xvc2UgIT0gMCAmJiBub3cgPiAoc2Vzc2lvbi50aW1lT3BlbiArIHRpbWVPbmVTZXNzaW9uICogMSBtaW51dGVzKSk7CiAgICAgICAgcmVxdWlyZSghc2Vzc2lvbi5pbnZlc3RPcGVuICYmIHNlc3Npb24uaXNPcGVuKTsKICAgICAgICBzZXNzaW9uLnByaWNlQ2xvc2UgPSBfcHJpY2VDbG9zZTsKICAgICAgICBib29sIHJlc3VsdCA9IChfcHJpY2VDbG9zZT5zZXNzaW9uLnByaWNlT3Blbik/dHJ1ZTpmYWxzZTsKICAgICAgICB1aW50IGV0aGVyVG9CdXk7CiAgICAgICAgTmFtaUNyb3dkU2FsZSBuYW1pQ29udHJhY3QgPSBOYW1pQ3Jvd2RTYWxlKG5hbWlDcm93ZFNhbGVBZGRyKTsKICAgICAgICB1aW50IHByaWNlID0gbmFtaUNvbnRyYWN0LmdldFByaWNlKCk7CiAgICAgICAgcmVxdWlyZShwcmljZSAhPSAwKTsKICAgICAgICBmb3IgKHVpbnQgaSA9IDA7IGkgPCBzZXNzaW9uLmludmVzdG9yQ291bnQ7IGkrKykgewogICAgICAgICAgICBpZiAoc2Vzc2lvbi53aW5baV09PXJlc3VsdCkgewogICAgICAgICAgICAgICAgZXRoZXJUb0J1eSA9IChzZXNzaW9uLmFtb3VudEludmVzdFtpXSAtIHNlc3Npb24uYW1vdW50SW52ZXN0W2ldICogcmF0ZUZlZSAvIDEwMCkgKiByYXRlV2luIC8gMTAwOwogICAgICAgICAgICAgICAgdWludCBldGhlclJldHVybiA9IHNlc3Npb24uYW1vdW50SW52ZXN0W2ldIC0gc2Vzc2lvbi5hbW91bnRJbnZlc3RbaV0gKiByYXRlRmVlIC8gMTAwOwogICAgICAgICAgICAgICAgKHNlc3Npb24uaW52ZXN0b3JbaV0pLnRyYW5zZmVyKGV0aGVyUmV0dXJuKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGV0aGVyVG9CdXkgPSAoc2Vzc2lvbi5hbW91bnRJbnZlc3RbaV0gLSBzZXNzaW9uLmFtb3VudEludmVzdFtpXSAqIHJhdGVGZWUgLyAxMDApICogcmF0ZUxvc3MgLyAxMDA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbmFtaUNvbnRyYWN0LmJ1eS52YWx1ZShldGhlclRvQnV5KShzZXNzaW9uLmludmVzdG9yW2ldKTsKICAgICAgICAgICAgLy8gcmVzZXQgaW52ZXN0b3IKICAgICAgICAgICAgc2Vzc2lvbi5pbnZlc3RvcltpXSA9IDB4MDsKICAgICAgICAgICAgc2Vzc2lvbi53aW5baV0gPSBmYWxzZTsKICAgICAgICAgICAgc2Vzc2lvbi5hbW91bnRJbnZlc3RbaV0gPSAwOwogICAgICAgIH0KICAgICAgICBzZXNzaW9uLmlzT3BlbiA9IGZhbHNlOwogICAgICAgIFNlc3Npb25DbG9zZShub3csIHNlc3Npb25JZCwgX3ByaWNlQ2xvc2UsIHByaWNlLCByYXRlV2luLCByYXRlTG9zcywgcmF0ZUZlZSk7CiAgICAgICAgc2Vzc2lvbklkICs9IDE7CiAgICAgICAgCiAgICAgICAgLy8gcmVxdWlyZSghc2Vzc2lvbi5pc1Jlc2V0ICYmICFzZXNzaW9uLmlzT3Blbik7CiAgICAgICAgLy8gcmVzZXQgc3RhdGUgc2Vzc2lvbgogICAgICAgIHNlc3Npb24ucHJpY2VPcGVuID0gMDsKICAgICAgICBzZXNzaW9uLnByaWNlQ2xvc2UgPSAwOwogICAgICAgIHNlc3Npb24uaXNSZXNldCA9IHRydWU7CiAgICAgICAgc2Vzc2lvbi5pbnZlc3RPcGVuID0gZmFsc2U7CiAgICAgICAgc2Vzc2lvbi5pbnZlc3RvckNvdW50ID0gMDsKICAgIH0KfQoKCmNvbnRyYWN0IFByZXNhbGVUb2tlbiB7CiAgICBtYXBwaW5nIChhZGRyZXNzID0+IHVpbnQyNTYpIHB1YmxpYyBiYWxhbmNlT2Y7CiAgICBmdW5jdGlvbiBidXJuVG9rZW5zKGFkZHJlc3MgX293bmVyKSBwdWJsaWM7Cn0KCiAvKgogKiBDb250cmFjdCB0aGF0IGlzIHdvcmtpbmcgd2l0aCBFUkMyMjMgdG9rZW5zCiAqLwogCiAvKioKICogQHRpdGxlIENvbnRyYWN0IHRoYXQgd2lsbCB3b3JrIHdpdGggRVJDMjIzIHRva2Vucy4KICovCiAKY29udHJhY3QgRVJDMjIzUmVjZWl2aW5nQ29udHJhY3QgewovKioKICogQGRldiBTdGFuZGFyZCBFUkMyMjMgZnVuY3Rpb24gdGhhdCB3aWxsIGhhbmRsZSBpbmNvbWluZyB0b2tlbiB0cmFuc2ZlcnMuCiAqCiAqIEBwYXJhbSBfZnJvbSAgVG9rZW4gc2VuZGVyIGFkZHJlc3MuCiAqIEBwYXJhbSBfdmFsdWUgQW1vdW50IG9mIHRva2Vucy4KICogQHBhcmFtIF9kYXRhICBUcmFuc2FjdGlvbiBtZXRhZGF0YS4KICovCiAgICBmdW5jdGlvbiB0b2tlbkZhbGxiYWNrKGFkZHJlc3MgX2Zyb20sIHVpbnQgX3ZhbHVlLCBieXRlcyBfZGF0YSkgcHVibGljIHJldHVybnMgKGJvb2wgc3VjY2Vzcyk7CiAgICBmdW5jdGlvbiB0b2tlbkZhbGxiYWNrQnV5ZXIoYWRkcmVzcyBfZnJvbSwgdWludCBfdmFsdWUsIGFkZHJlc3MgX2J1eWVyKSBwdWJsaWMgcmV0dXJucyAoYm9vbCBzdWNjZXNzKTsKICAgIGZ1bmN0aW9uIHRva2VuRmFsbGJhY2tFeGNoYW5nZShhZGRyZXNzIF9mcm9tLCB1aW50IF92YWx1ZSwgdWludCBfcHJpY2UpIHB1YmxpYyByZXR1cm5zIChib29sIHN1Y2Nlc3MpOwp9CgoKIC8qCiAqIE5hbWkgSW50ZXJuYWwgRXhjaGFuZ2Ugc21hcnRjb250cmFjdC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAqCiAqLwoKY29udHJhY3QgTmFtaUV4Y2hhbmdlIHsKICAgIHVzaW5nIFNhZmVNYXRoIGZvciB1aW50OwogICAgCiAgICBmdW5jdGlvbiBOYW1pRXhjaGFuZ2UoYWRkcmVzcyBfbmFtaUFkZHJlc3MpIHB1YmxpYyB7CiAgICAgICAgTmFtaUFkZHIgPSBfbmFtaUFkZHJlc3M7CiAgICB9CgogICAgZXZlbnQgVXBkYXRlQmlkKGFkZHJlc3Mgb3duZXIsIHVpbnQgcHJpY2UsIHVpbnQgYmFsYW5jZSk7CiAgICBldmVudCBVcGRhdGVBc2soYWRkcmVzcyBvd25lciwgdWludCBwcmljZSwgdWludCB2b2x1bWUpOwogICAgZXZlbnQgQnV5SGlzdG9yeShhZGRyZXNzIGluZGV4ZWQgYnV5ZXIsIGFkZHJlc3MgaW5kZXhlZCBzZWxsZXIsIHVpbnQgcHJpY2UsIHVpbnQgdm9sdW1lLCB1aW50IHRpbWUpOwogICAgZXZlbnQgU2VsbEhpc3RvcnkoYWRkcmVzcyBpbmRleGVkIHNlbGxlciwgYWRkcmVzcyBpbmRleGVkIGJ1eWVyLCB1aW50IHByaWNlLCB1aW50IHZvbHVtZSwgdWludCB0aW1lKTsKCiAgICAKICAgIG1hcHBpbmcoYWRkcmVzcyA9PiBPcmRlckJpZCkgcHVibGljIGJpZDsKICAgIG1hcHBpbmcoYWRkcmVzcyA9PiBPcmRlckFzaykgcHVibGljIGFzazsKICAgIHN0cmluZyBwdWJsaWMgbmFtZSA9ICJOYWNFeGNoYW5nZSI7CiAgICAKICAgIC8vLyBhZGRyZXNzIG9mIE5hbWkgdG9rZW4KICAgIGFkZHJlc3MgcHVibGljIE5hbWlBZGRyOwogICAgCiAgICAvLy8gcHJpY2Ugb2YgTmFjID0gRVRIL05BQwogICAgdWludCBwdWJsaWMgcHJpY2UgPSAxOwogICAgLy8gc3RydWN0IHN0b3JlIG9yZGVyIG9mIHVzZXIKICAgIHN0cnVjdCBPcmRlckJpZCB7CiAgICAgICAgdWludCBwcmljZTsKICAgICAgICB1aW50IGV0aDsKICAgIH0KICAgIAogICAgc3RydWN0IE9yZGVyQXNrIHsKICAgICAgICB1aW50IHByaWNlOwogICAgICAgIHVpbnQgdm9sdW1lOwogICAgfQogICAgCiAgICAgICAgCiAgICAvLyBwcmV2ZW50IGxvc3QgZXRoZXIKICAgIGZ1bmN0aW9uKCkgcGF5YWJsZSBwdWJsaWMgewogICAgICAgIHJlcXVpcmUobXNnLmRhdGEubGVuZ3RoICE9IDApOwogICAgICAgIHJlcXVpcmUobXNnLnZhbHVlID09IDApOwogICAgfQogICAgCiAgICBtb2RpZmllciBvbmx5TmFtaSB7CiAgICAgICAgcmVxdWlyZShtc2cuc2VuZGVyID09IE5hbWlBZGRyKTsKICAgICAgICBfOwogICAgfQogICAgCiAgICAvLy8vLy8vLy8vLy8vLy8vLwogICAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1mdW5jdGlvbiBhYm91dCBiaWQgT3JkZXItLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgCiAgICBmdW5jdGlvbiBwbGFjZUJ1eU9yZGVyKHVpbnQgX3ByaWNlKSBwYXlhYmxlIHB1YmxpYyB7CiAgICAgICAgcmVxdWlyZShfcHJpY2UgPiAwICYmIG1zZy52YWx1ZSA+IDAgJiYgYmlkW21zZy5zZW5kZXJdLmV0aCA9PSAwKTsKICAgICAgICBpZiAobXNnLnZhbHVlID4gMCkgewogICAgICAgICAgICBiaWRbbXNnLnNlbmRlcl0uZXRoID0gKGJpZFttc2cuc2VuZGVyXS5ldGgpLmFkZChtc2cudmFsdWUpOwogICAgICAgICAgICBiaWRbbXNnLnNlbmRlcl0ucHJpY2UgPSBfcHJpY2U7CiAgICAgICAgICAgIFVwZGF0ZUJpZChtc2cuc2VuZGVyLCBfcHJpY2UsIGJpZFttc2cuc2VuZGVyXS5ldGgpOwogICAgICAgIH0KICAgIH0KICAgIAogICAgZnVuY3Rpb24gc2VsbE5hYyh1aW50IF92YWx1ZSwgYWRkcmVzcyBfYnV5ZXIsIHVpbnQgX3ByaWNlKSBwdWJsaWMgcmV0dXJucyAoYm9vbCBzdWNjZXNzKSB7CiAgICAgICAgcmVxdWlyZShfcHJpY2UgPT0gYmlkW19idXllcl0ucHJpY2UgJiYgX2J1eWVyICE9IG1zZy5zZW5kZXIpOwogICAgICAgIE5hbWlDcm93ZFNhbGUgbmFtaVRva2VuID0gTmFtaUNyb3dkU2FsZShOYW1pQWRkcik7CiAgICAgICAgdWludCBldGhPZkJ1eWVyID0gYmlkW19idXllcl0uZXRoOwogICAgICAgIHVpbnQgbWF4VG9rZW4gPSBldGhPZkJ1eWVyLm11bChiaWRbX2J1eWVyXS5wcmljZSk7CiAgICAgICAgcmVxdWlyZShuYW1pVG9rZW4uYWxsb3dhbmNlKG1zZy5zZW5kZXIsIHRoaXMpID49IF92YWx1ZSAmJiBfdmFsdWUgPiAwICYmIGV0aE9mQnV5ZXIgIT0gMCAmJiBfYnV5ZXIgIT0gMHgwKTsKICAgICAgICBpZiAoX3ZhbHVlID4gbWF4VG9rZW4pIHsKICAgICAgICAgICAgaWYgKG1zZy5zZW5kZXIuc2VuZChldGhPZkJ1eWVyKSAmJiBuYW1pVG9rZW4udHJhbnNmZXJGcm9tKG1zZy5zZW5kZXIsX2J1eWVyLG1heFRva2VuKSkgewogICAgICAgICAgICAgICAgLy8gdXBkYXRlIG9yZGVyCiAgICAgICAgICAgICAgICBiaWRbX2J1eWVyXS5ldGggPSAwOwogICAgICAgICAgICAgICAgVXBkYXRlQmlkKF9idXllciwgYmlkW19idXllcl0ucHJpY2UsIGJpZFtfYnV5ZXJdLmV0aCk7CiAgICAgICAgICAgICAgICBCdXlIaXN0b3J5KF9idXllciwgbXNnLnNlbmRlciwgYmlkW19idXllcl0ucHJpY2UsIG1heFRva2VuLCBub3cpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyByZXZlcnQgYW55dGhpbmcKICAgICAgICAgICAgICAgIHJldmVydCgpOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdWludCBldGggPSBfdmFsdWUuZGl2KGJpZFtfYnV5ZXJdLnByaWNlKTsKICAgICAgICAgICAgaWYgKG1zZy5zZW5kZXIuc2VuZChldGgpICYmIG5hbWlUb2tlbi50cmFuc2ZlckZyb20obXNnLnNlbmRlcixfYnV5ZXIsX3ZhbHVlKSkgewogICAgICAgICAgICAgICAgLy8gdXBkYXRlIG9yZGVyCiAgICAgICAgICAgICAgICBiaWRbX2J1eWVyXS5ldGggPSAoYmlkW19idXllcl0uZXRoKS5zdWIoZXRoKTsKICAgICAgICAgICAgICAgIFVwZGF0ZUJpZChfYnV5ZXIsIGJpZFtfYnV5ZXJdLnByaWNlLCBiaWRbX2J1eWVyXS5ldGgpOwogICAgICAgICAgICAgICAgQnV5SGlzdG9yeShfYnV5ZXIsIG1zZy5zZW5kZXIsIGJpZFtfYnV5ZXJdLnByaWNlLCBfdmFsdWUsIG5vdyk7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIHJldmVydCBhbnl0aGluZwogICAgICAgICAgICAgICAgcmV2ZXJ0KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICAKICAgIGZ1bmN0aW9uIGNsb3NlQmlkT3JkZXIoKSBwdWJsaWMgewogICAgICAgIHJlcXVpcmUoYmlkW21zZy5zZW5kZXJdLmV0aCA+IDAgJiYgYmlkW21zZy5zZW5kZXJdLnByaWNlID4gMCk7CiAgICAgICAgLy8gdHJhbnNmZXIgRVRICiAgICAgICAgbXNnLnNlbmRlci50cmFuc2ZlcihiaWRbbXNnLnNlbmRlcl0uZXRoKTsKICAgICAgICAvLyB1cGRhdGUgb3JkZXIKICAgICAgICBiaWRbbXNnLnNlbmRlcl0uZXRoID0gMDsKICAgICAgICBVcGRhdGVCaWQobXNnLnNlbmRlciwgYmlkW21zZy5zZW5kZXJdLnByaWNlLCBiaWRbbXNnLnNlbmRlcl0uZXRoKTsKICAgIH0KICAgIAoKICAgIC8vLy8vLy8vLy8vLy8vLy8KICAgIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tZnVuY3Rpb24gYWJvdXQgYXNrIE9yZGVyLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIAogICAgLy8gcGxhY2UgYXNrIG9yZGVyIGJ5IHNlbmQgTkFDIHRvIE5hbWkgRXhjaGFuZ2UgY29udHJhY3QKICAgIC8vIHRoaXMgZnVuY3Rpb24gcGxhY2Ugc2VsbCBvcmRlcgogICAgZnVuY3Rpb24gdG9rZW5GYWxsYmFja0V4Y2hhbmdlKGFkZHJlc3MgX2Zyb20sIHVpbnQgX3ZhbHVlLCB1aW50IF9wcmljZSkgb25seU5hbWkgcHVibGljIHJldHVybnMgKGJvb2wgc3VjY2VzcykgewogICAgICAgIHJlcXVpcmUoX3ByaWNlID4gMCAmJiBfdmFsdWUgPiAwICYmIGFza1tfZnJvbV0udm9sdW1lID09IDApOwogICAgICAgIGlmIChfdmFsdWUgPiAwKSB7CiAgICAgICAgICAgIGFza1tfZnJvbV0udm9sdW1lID0gKGFza1tfZnJvbV0udm9sdW1lKS5hZGQoX3ZhbHVlKTsKICAgICAgICAgICAgYXNrW19mcm9tXS5wcmljZSA9IF9wcmljZTsKICAgICAgICAgICAgVXBkYXRlQXNrKF9mcm9tLCBfcHJpY2UsIGFza1tfZnJvbV0udm9sdW1lKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICAKICAgIGZ1bmN0aW9uIGNsb3NlQXNrT3JkZXIoKSBwdWJsaWMgewogICAgICAgIHJlcXVpcmUoYXNrW21zZy5zZW5kZXJdLnZvbHVtZSA+IDAgJiYgYXNrW21zZy5zZW5kZXJdLnByaWNlID4gMCk7CiAgICAgICAgTmFtaUNyb3dkU2FsZSBuYW1pVG9rZW4gPSBOYW1pQ3Jvd2RTYWxlKE5hbWlBZGRyKTsKICAgICAgICB1aW50IHByZXZpb3VzQmFsYW5jZXMgPSBuYW1pVG9rZW4uYmFsYW5jZU9mKG1zZy5zZW5kZXIpOwogICAgICAgIC8vIHRyYW5zZmVyIHRva2VuCiAgICAgICAgbmFtaVRva2VuLnRyYW5zZmVyKG1zZy5zZW5kZXIsIGFza1ttc2cuc2VuZGVyXS52b2x1bWUpOwogICAgICAgIC8vIHVwZGF0ZSBvcmRlcgogICAgICAgIGFza1ttc2cuc2VuZGVyXS52b2x1bWUgPSAwOwogICAgICAgIFVwZGF0ZUFzayhtc2cuc2VuZGVyLCBhc2tbbXNnLnNlbmRlcl0ucHJpY2UsIDApOwogICAgICAgIC8vIGNoZWNrIGJhbGFuY2UKICAgICAgICBhc3NlcnQocHJldmlvdXNCYWxhbmNlcyA8IG5hbWlUb2tlbi5iYWxhbmNlT2YobXNnLnNlbmRlcikpOwogICAgfQogICAgCiAgICBmdW5jdGlvbiBidXlOYWMoYWRkcmVzcyBfc2VsbGVyLCB1aW50IF9wcmljZSkgcGF5YWJsZSBwdWJsaWMgcmV0dXJucyAoYm9vbCBzdWNjZXNzKSB7CiAgICAgICAgcmVxdWlyZShtc2cudmFsdWUgPiAwICYmIGFza1tfc2VsbGVyXS52b2x1bWUgPiAwICYmIGFza1tfc2VsbGVyXS5wcmljZSA+IDApOwogICAgICAgIHJlcXVpcmUoX3ByaWNlID09IGFza1tfc2VsbGVyXS5wcmljZSAmJiBfc2VsbGVyICE9IG1zZy5zZW5kZXIpOwogICAgICAgIE5hbWlDcm93ZFNhbGUgbmFtaVRva2VuID0gTmFtaUNyb3dkU2FsZShOYW1pQWRkcik7CiAgICAgICAgdWludCBtYXhFdGggPSAoYXNrW19zZWxsZXJdLnZvbHVtZSkuZGl2KGFza1tfc2VsbGVyXS5wcmljZSk7CiAgICAgICAgdWludCBwcmV2aW91c0JhbGFuY2VzID0gbmFtaVRva2VuLmJhbGFuY2VPZihtc2cuc2VuZGVyKTsKICAgICAgICBpZiAobXNnLnZhbHVlID4gbWF4RXRoKSB7CiAgICAgICAgICAgIGlmIChfc2VsbGVyLnNlbmQobWF4RXRoKSAmJiBtc2cuc2VuZGVyLnNlbmQobXNnLnZhbHVlLnN1YihtYXhFdGgpKSkgewogICAgICAgICAgICAgICAgLy8gdHJhbnNmZXIgdG9rZW4KICAgICAgICAgICAgICAgIG5hbWlUb2tlbi50cmFuc2Zlcihtc2cuc2VuZGVyLCBhc2tbX3NlbGxlcl0udm9sdW1lKTsKICAgICAgICAgICAgICAgIFNlbGxIaXN0b3J5KF9zZWxsZXIsIG1zZy5zZW5kZXIsIGFza1tfc2VsbGVyXS5wcmljZSwgYXNrW19zZWxsZXJdLnZvbHVtZSwgbm93KTsKICAgICAgICAgICAgICAgIC8vIHVwZGF0ZSBvcmRlcgogICAgICAgICAgICAgICAgYXNrW19zZWxsZXJdLnZvbHVtZSA9IDA7CiAgICAgICAgICAgICAgICBVcGRhdGVBc2soX3NlbGxlciwgYXNrW19zZWxsZXJdLnByaWNlLCAwKTsKICAgICAgICAgICAgICAgIGFzc2VydChwcmV2aW91c0JhbGFuY2VzIDwgbmFtaVRva2VuLmJhbGFuY2VPZihtc2cuc2VuZGVyKSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIHJldmVydCBhbnl0aGluZwogICAgICAgICAgICAgICAgcmV2ZXJ0KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB1aW50IG5hYyA9IChtc2cudmFsdWUpLm11bChhc2tbX3NlbGxlcl0ucHJpY2UpOwogICAgICAgICAgICBpZiAoX3NlbGxlci5zZW5kKG1zZy52YWx1ZSkpIHsKICAgICAgICAgICAgICAgIC8vIHRyYW5zZmVyIHRva2VuCiAgICAgICAgICAgICAgICBuYW1pVG9rZW4udHJhbnNmZXIobXNnLnNlbmRlciwgbmFjKTsKICAgICAgICAgICAgICAgIC8vIHVwZGF0ZSBvcmRlcgogICAgICAgICAgICAgICAgYXNrW19zZWxsZXJdLnZvbHVtZSA9IChhc2tbX3NlbGxlcl0udm9sdW1lKS5zdWIobmFjKTsKICAgICAgICAgICAgICAgIFVwZGF0ZUFzayhfc2VsbGVyLCBhc2tbX3NlbGxlcl0ucHJpY2UsIGFza1tfc2VsbGVyXS52b2x1bWUpOwogICAgICAgICAgICAgICAgU2VsbEhpc3RvcnkoX3NlbGxlciwgbXNnLnNlbmRlciwgYXNrW19zZWxsZXJdLnByaWNlLCBuYWMsIG5vdyk7CiAgICAgICAgICAgICAgICBhc3NlcnQocHJldmlvdXNCYWxhbmNlcyA8IG5hbWlUb2tlbi5iYWxhbmNlT2YobXNnLnNlbmRlcikpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyByZXZlcnQgYW55dGhpbmcKICAgICAgICAgICAgICAgIHJldmVydCgpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQp9Cgpjb250cmFjdCBFUkMyMyB7CiAgZnVuY3Rpb24gYmFsYW5jZU9mKGFkZHJlc3Mgd2hvKSBwdWJsaWMgY29uc3RhbnQgcmV0dXJucyAodWludCk7CiAgZnVuY3Rpb24gdHJhbnNmZXIoYWRkcmVzcyB0bywgdWludCB2YWx1ZSkgcHVibGljIHJldHVybnMgKGJvb2wgc3VjY2Vzcyk7Cn0KCgoKLyoKKiBOYW1pTXVsdGlTaWdXYWxsZXQgc21hcnQgY29udHJhY3QtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiovCi8vLyBAdGl0bGUgTXVsdGlzaWduYXR1cmUgd2FsbGV0IC0gQWxsb3dzIG11bHRpcGxlIHBhcnRpZXMgdG8gYWdyZWUgb24gdHJhbnNhY3Rpb25zIGJlZm9yZSBleGVjdXRpb24uCmNvbnRyYWN0IE5hbWlNdWx0aVNpZ1dhbGxldCB7CgogICAgdWludCBjb25zdGFudCBwdWJsaWMgTUFYX09XTkVSX0NPVU5UID0gNTA7CgogICAgZXZlbnQgQ29uZmlybWF0aW9uKGFkZHJlc3MgaW5kZXhlZCBzZW5kZXIsIHVpbnQgaW5kZXhlZCB0cmFuc2FjdGlvbklkKTsKICAgIGV2ZW50IFJldm9jYXRpb24oYWRkcmVzcyBpbmRleGVkIHNlbmRlciwgdWludCBpbmRleGVkIHRyYW5zYWN0aW9uSWQpOwogICAgZXZlbnQgU3VibWlzc2lvbih1aW50IGluZGV4ZWQgdHJhbnNhY3Rpb25JZCk7CiAgICBldmVudCBFeGVjdXRpb24odWludCBpbmRleGVkIHRyYW5zYWN0aW9uSWQpOwogICAgZXZlbnQgRXhlY3V0aW9uRmFpbHVyZSh1aW50IGluZGV4ZWQgdHJhbnNhY3Rpb25JZCk7CiAgICBldmVudCBEZXBvc2l0KGFkZHJlc3MgaW5kZXhlZCBzZW5kZXIsIHVpbnQgdmFsdWUpOwogICAgZXZlbnQgT3duZXJBZGRpdGlvbihhZGRyZXNzIGluZGV4ZWQgb3duZXIpOwogICAgZXZlbnQgT3duZXJSZW1vdmFsKGFkZHJlc3MgaW5kZXhlZCBvd25lcik7CiAgICBldmVudCBSZXF1aXJlbWVudENoYW5nZSh1aW50IHJlcXVpcmVkKTsKCiAgICBtYXBwaW5nICh1aW50ID0+IFRyYW5zYWN0aW9uKSBwdWJsaWMgdHJhbnNhY3Rpb25zOwogICAgbWFwcGluZyAodWludCA9PiBtYXBwaW5nIChhZGRyZXNzID0+IGJvb2wpKSBwdWJsaWMgY29uZmlybWF0aW9uczsKICAgIG1hcHBpbmcgKGFkZHJlc3MgPT4gYm9vbCkgcHVibGljIGlzT3duZXI7CiAgICBhZGRyZXNzW10gcHVibGljIG93bmVyczsKICAgIHVpbnQgcHVibGljIHJlcXVpcmVkOwogICAgdWludCBwdWJsaWMgdHJhbnNhY3Rpb25Db3VudDsKCiAgICBzdHJ1Y3QgVHJhbnNhY3Rpb24gewogICAgICAgIGFkZHJlc3MgZGVzdGluYXRpb247CiAgICAgICAgdWludCB2YWx1ZTsKICAgICAgICBieXRlcyBkYXRhOwogICAgICAgIGJvb2wgZXhlY3V0ZWQ7CiAgICB9CgogICAgbW9kaWZpZXIgb25seVdhbGxldCgpIHsKICAgICAgICByZXF1aXJlKG1zZy5zZW5kZXIgPT0gYWRkcmVzcyh0aGlzKSk7CiAgICAgICAgXzsKICAgIH0KCiAgICBtb2RpZmllciBvd25lckRvZXNOb3RFeGlzdChhZGRyZXNzIG93bmVyKSB7CiAgICAgICAgcmVxdWlyZSghaXNPd25lcltvd25lcl0pOwogICAgICAgIF87CiAgICB9CgogICAgbW9kaWZpZXIgb3duZXJFeGlzdHMoYWRkcmVzcyBvd25lcikgewogICAgICAgIHJlcXVpcmUoaXNPd25lcltvd25lcl0pOwogICAgICAgIF87CiAgICB9CgogICAgbW9kaWZpZXIgdHJhbnNhY3Rpb25FeGlzdHModWludCB0cmFuc2FjdGlvbklkKSB7CiAgICAgICAgcmVxdWlyZSh0cmFuc2FjdGlvbnNbdHJhbnNhY3Rpb25JZF0uZGVzdGluYXRpb24gIT0gMCk7CiAgICAgICAgXzsKICAgIH0KCiAgICBtb2RpZmllciBjb25maXJtZWQodWludCB0cmFuc2FjdGlvbklkLCBhZGRyZXNzIG93bmVyKSB7CiAgICAgICAgcmVxdWlyZShjb25maXJtYXRpb25zW3RyYW5zYWN0aW9uSWRdW293bmVyXSk7CiAgICAgICAgXzsKICAgIH0KCiAgICBtb2RpZmllciBub3RDb25maXJtZWQodWludCB0cmFuc2FjdGlvbklkLCBhZGRyZXNzIG93bmVyKSB7CiAgICAgICAgcmVxdWlyZSghY29uZmlybWF0aW9uc1t0cmFuc2FjdGlvbklkXVtvd25lcl0pOwogICAgICAgIF87CiAgICB9CgogICAgbW9kaWZpZXIgbm90RXhlY3V0ZWQodWludCB0cmFuc2FjdGlvbklkKSB7CiAgICAgICAgcmVxdWlyZSghdHJhbnNhY3Rpb25zW3RyYW5zYWN0aW9uSWRdLmV4ZWN1dGVkKTsKICAgICAgICBfOwogICAgfQoKICAgIG1vZGlmaWVyIG5vdE51bGwoYWRkcmVzcyBfYWRkcmVzcykgewogICAgICAgIHJlcXVpcmUoX2FkZHJlc3MgIT0gMCk7CiAgICAgICAgXzsKICAgIH0KCiAgICBtb2RpZmllciB2YWxpZFJlcXVpcmVtZW50KHVpbnQgb3duZXJDb3VudCwgdWludCBfcmVxdWlyZWQpIHsKICAgICAgICByZXF1aXJlKCEob3duZXJDb3VudCA+IE1BWF9PV05FUl9DT1VOVAogICAgICAgICAgICB8fCBfcmVxdWlyZWQgPiBvd25lckNvdW50CiAgICAgICAgICAgIHx8IF9yZXF1aXJlZCA9PSAwCiAgICAgICAgICAgIHx8IG93bmVyQ291bnQgPT0gMCkpOwogICAgICAgIF87CiAgICB9CgogICAgLy8vIEBkZXYgRmFsbGJhY2sgZnVuY3Rpb24gYWxsb3dzIHRvIGRlcG9zaXQgZXRoZXIuCiAgICBmdW5jdGlvbigpIHB1YmxpYyBwYXlhYmxlIHsKICAgICAgICBpZiAobXNnLnZhbHVlID4gMCkKICAgICAgICAgICAgRGVwb3NpdChtc2cuc2VuZGVyLCBtc2cudmFsdWUpOwogICAgfQoKICAgIC8qCiAgICAgKiBQdWJsaWMgZnVuY3Rpb25zCiAgICAgKi8KICAgIC8vLyBAZGV2IENvbnRyYWN0IGNvbnN0cnVjdG9yIHNldHMgaW5pdGlhbCBvd25lcnMgYW5kIHJlcXVpcmVkIG51bWJlciBvZiBjb25maXJtYXRpb25zLgogICAgLy8vIEBwYXJhbSBfb3duZXJzIExpc3Qgb2YgaW5pdGlhbCBvd25lcnMuCiAgICAvLy8gQHBhcmFtIF9yZXF1aXJlZCBOdW1iZXIgb2YgcmVxdWlyZWQgY29uZmlybWF0aW9ucy4KICAgIGZ1bmN0aW9uIE5hbWlNdWx0aVNpZ1dhbGxldChhZGRyZXNzW10gX293bmVycywgdWludCBfcmVxdWlyZWQpCiAgICAgICAgcHVibGljCiAgICAgICAgdmFsaWRSZXF1aXJlbWVudChfb3duZXJzLmxlbmd0aCwgX3JlcXVpcmVkKQogICAgewogICAgICAgIGZvciAodWludCBpID0gMDsgaSA8IF9vd25lcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgcmVxdWlyZSghKGlzT3duZXJbX293bmVyc1tpXV0gfHwgX293bmVyc1tpXSA9PSAwKSk7CiAgICAgICAgICAgIGlzT3duZXJbX293bmVyc1tpXV0gPSB0cnVlOwogICAgICAgIH0KICAgICAgICBvd25lcnMgPSBfb3duZXJzOwogICAgICAgIHJlcXVpcmVkID0gX3JlcXVpcmVkOwogICAgfQoKICAgIC8vLyBAZGV2IEFsbG93cyB0byBhZGQgYSBuZXcgb3duZXIuIFRyYW5zYWN0aW9uIGhhcyB0byBiZSBzZW50IGJ5IHdhbGxldC4KICAgIC8vLyBAcGFyYW0gb3duZXIgQWRkcmVzcyBvZiBuZXcgb3duZXIuCiAgICBmdW5jdGlvbiBhZGRPd25lcihhZGRyZXNzIG93bmVyKQogICAgICAgIHB1YmxpYwogICAgICAgIG9ubHlXYWxsZXQKICAgICAgICBvd25lckRvZXNOb3RFeGlzdChvd25lcikKICAgICAgICBub3ROdWxsKG93bmVyKQogICAgICAgIHZhbGlkUmVxdWlyZW1lbnQob3duZXJzLmxlbmd0aCArIDEsIHJlcXVpcmVkKQogICAgewogICAgICAgIGlzT3duZXJbb3duZXJdID0gdHJ1ZTsKICAgICAgICBvd25lcnMucHVzaChvd25lcik7CiAgICAgICAgT3duZXJBZGRpdGlvbihvd25lcik7CiAgICB9CgogICAgLy8vIEBkZXYgQWxsb3dzIHRvIHJlbW92ZSBhbiBvd25lci4gVHJhbnNhY3Rpb24gaGFzIHRvIGJlIHNlbnQgYnkgd2FsbGV0LgogICAgLy8vIEBwYXJhbSBvd25lciBBZGRyZXNzIG9mIG93bmVyLgogICAgZnVuY3Rpb24gcmVtb3ZlT3duZXIoYWRkcmVzcyBvd25lcikKICAgICAgICBwdWJsaWMKICAgICAgICBvbmx5V2FsbGV0CiAgICAgICAgb3duZXJFeGlzdHMob3duZXIpCiAgICB7CiAgICAgICAgaXNPd25lcltvd25lcl0gPSBmYWxzZTsKICAgICAgICBmb3IgKHVpbnQgaT0wOyBpPG93bmVycy5sZW5ndGggLSAxOyBpKyspIHsKICAgICAgICAgICAgaWYgKG93bmVyc1tpXSA9PSBvd25lcikgewogICAgICAgICAgICAgICAgb3duZXJzW2ldID0gb3duZXJzW293bmVycy5sZW5ndGggLSAxXTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIG93bmVycy5sZW5ndGggLT0gMTsKICAgICAgICBpZiAocmVxdWlyZWQgPiBvd25lcnMubGVuZ3RoKQogICAgICAgICAgICBjaGFuZ2VSZXF1aXJlbWVudChvd25lcnMubGVuZ3RoKTsKICAgICAgICBPd25lclJlbW92YWwob3duZXIpOwogICAgfQoKICAgIC8vLyBAZGV2IEFsbG93cyB0byByZXBsYWNlIGFuIG93bmVyIHdpdGggYSBuZXcgb3duZXIuIFRyYW5zYWN0aW9uIGhhcyB0byBiZSBzZW50IGJ5IHdhbGxldC4KICAgIC8vLyBAcGFyYW0gb3duZXIgQWRkcmVzcyBvZiBvd25lciB0byBiZSByZXBsYWNlZC4KICAgIC8vLyBAcGFyYW0gb3duZXIgQWRkcmVzcyBvZiBuZXcgb3duZXIuCiAgICBmdW5jdGlvbiByZXBsYWNlT3duZXIoYWRkcmVzcyBvd25lciwgYWRkcmVzcyBuZXdPd25lcikKICAgICAgICBwdWJsaWMKICAgICAgICBvbmx5V2FsbGV0CiAgICAgICAgb3duZXJFeGlzdHMob3duZXIpCiAgICAgICAgb3duZXJEb2VzTm90RXhpc3QobmV3T3duZXIpCiAgICB7CiAgICAgICAgZm9yICh1aW50IGk9MDsgaTxvd25lcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgaWYgKG93bmVyc1tpXSA9PSBvd25lcikgewogICAgICAgICAgICAgICAgb3duZXJzW2ldID0gbmV3T3duZXI7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpc093bmVyW293bmVyXSA9IGZhbHNlOwogICAgICAgIGlzT3duZXJbbmV3T3duZXJdID0gdHJ1ZTsKICAgICAgICBPd25lclJlbW92YWwob3duZXIpOwogICAgICAgIE93bmVyQWRkaXRpb24obmV3T3duZXIpOwogICAgfQoKICAgIC8vLyBAZGV2IEFsbG93cyB0byBjaGFuZ2UgdGhlIG51bWJlciBvZiByZXF1aXJlZCBjb25maXJtYXRpb25zLiBUcmFuc2FjdGlvbiBoYXMgdG8gYmUgc2VudCBieSB3YWxsZXQuCiAgICAvLy8gQHBhcmFtIF9yZXF1aXJlZCBOdW1iZXIgb2YgcmVxdWlyZWQgY29uZmlybWF0aW9ucy4KICAgIGZ1bmN0aW9uIGNoYW5nZVJlcXVpcmVtZW50KHVpbnQgX3JlcXVpcmVkKQogICAgICAgIHB1YmxpYwogICAgICAgIG9ubHlXYWxsZXQKICAgICAgICB2YWxpZFJlcXVpcmVtZW50KG93bmVycy5sZW5ndGgsIF9yZXF1aXJlZCkKICAgIHsKICAgICAgICByZXF1aXJlZCA9IF9yZXF1aXJlZDsKICAgICAgICBSZXF1aXJlbWVudENoYW5nZShfcmVxdWlyZWQpOwogICAgfQoKICAgIC8vLyBAZGV2IEFsbG93cyBhbiBvd25lciB0byBzdWJtaXQgYW5kIGNvbmZpcm0gYSB0cmFuc2FjdGlvbi4KICAgIC8vLyBAcGFyYW0gZGVzdGluYXRpb24gVHJhbnNhY3Rpb24gdGFyZ2V0IGFkZHJlc3MuCiAgICAvLy8gQHBhcmFtIHZhbHVlIFRyYW5zYWN0aW9uIGV0aGVyIHZhbHVlLgogICAgLy8vIEBwYXJhbSBkYXRhIFRyYW5zYWN0aW9uIGRhdGEgcGF5bG9hZC4KICAgIC8vLyBAcmV0dXJuIFJldHVybnMgdHJhbnNhY3Rpb24gSUQuCiAgICBmdW5jdGlvbiBzdWJtaXRUcmFuc2FjdGlvbihhZGRyZXNzIGRlc3RpbmF0aW9uLCB1aW50IHZhbHVlLCBieXRlcyBkYXRhKQogICAgICAgIHB1YmxpYwogICAgICAgIHJldHVybnMgKHVpbnQgdHJhbnNhY3Rpb25JZCkKICAgIHsKICAgICAgICB0cmFuc2FjdGlvbklkID0gYWRkVHJhbnNhY3Rpb24oZGVzdGluYXRpb24sIHZhbHVlLCBkYXRhKTsKICAgICAgICBjb25maXJtVHJhbnNhY3Rpb24odHJhbnNhY3Rpb25JZCk7CiAgICB9CgogICAgLy8vIEBkZXYgQWxsb3dzIGFuIG93bmVyIHRvIGNvbmZpcm0gYSB0cmFuc2FjdGlvbi4KICAgIC8vLyBAcGFyYW0gdHJhbnNhY3Rpb25JZCBUcmFuc2FjdGlvbiBJRC4KICAgIGZ1bmN0aW9uIGNvbmZpcm1UcmFuc2FjdGlvbih1aW50IHRyYW5zYWN0aW9uSWQpCiAgICAgICAgcHVibGljCiAgICAgICAgb3duZXJFeGlzdHMobXNnLnNlbmRlcikKICAgICAgICB0cmFuc2FjdGlvbkV4aXN0cyh0cmFuc2FjdGlvbklkKQogICAgICAgIG5vdENvbmZpcm1lZCh0cmFuc2FjdGlvbklkLCBtc2cuc2VuZGVyKQogICAgewogICAgICAgIGNvbmZpcm1hdGlvbnNbdHJhbnNhY3Rpb25JZF1bbXNnLnNlbmRlcl0gPSB0cnVlOwogICAgICAgIENvbmZpcm1hdGlvbihtc2cuc2VuZGVyLCB0cmFuc2FjdGlvbklkKTsKICAgICAgICBleGVjdXRlVHJhbnNhY3Rpb24odHJhbnNhY3Rpb25JZCk7CiAgICB9CgogICAgLy8vIEBkZXYgQWxsb3dzIGFuIG93bmVyIHRvIHJldm9rZSBhIGNvbmZpcm1hdGlvbiBmb3IgYSB0cmFuc2FjdGlvbi4KICAgIC8vLyBAcGFyYW0gdHJhbnNhY3Rpb25JZCBUcmFuc2FjdGlvbiBJRC4KICAgIGZ1bmN0aW9uIHJldm9rZUNvbmZpcm1hdGlvbih1aW50IHRyYW5zYWN0aW9uSWQpCiAgICAgICAgcHVibGljCiAgICAgICAgb3duZXJFeGlzdHMobXNnLnNlbmRlcikKICAgICAgICBjb25maXJtZWQodHJhbnNhY3Rpb25JZCwgbXNnLnNlbmRlcikKICAgICAgICBub3RFeGVjdXRlZCh0cmFuc2FjdGlvbklkKQogICAgewogICAgICAgIGNvbmZpcm1hdGlvbnNbdHJhbnNhY3Rpb25JZF1bbXNnLnNlbmRlcl0gPSBmYWxzZTsKICAgICAgICBSZXZvY2F0aW9uKG1zZy5zZW5kZXIsIHRyYW5zYWN0aW9uSWQpOwogICAgfQoKICAgIC8vLyBAZGV2IEFsbG93cyBhbnlvbmUgdG8gZXhlY3V0ZSBhIGNvbmZpcm1lZCB0cmFuc2FjdGlvbi4KICAgIC8vLyBAcGFyYW0gdHJhbnNhY3Rpb25JZCBUcmFuc2FjdGlvbiBJRC4KICAgIGZ1bmN0aW9uIGV4ZWN1dGVUcmFuc2FjdGlvbih1aW50IHRyYW5zYWN0aW9uSWQpCiAgICAgICAgcHVibGljCiAgICAgICAgbm90RXhlY3V0ZWQodHJhbnNhY3Rpb25JZCkKICAgIHsKICAgICAgICBpZiAoaXNDb25maXJtZWQodHJhbnNhY3Rpb25JZCkpIHsKICAgICAgICAgICAgLy8gVHJhbnNhY3Rpb24gdHggPSB0cmFuc2FjdGlvbnNbdHJhbnNhY3Rpb25JZF07CiAgICAgICAgICAgIHRyYW5zYWN0aW9uc1t0cmFuc2FjdGlvbklkXS5leGVjdXRlZCA9IHRydWU7CiAgICAgICAgICAgIC8vIHR4LmV4ZWN1dGVkID0gdHJ1ZTsKICAgICAgICAgICAgaWYgKHRyYW5zYWN0aW9uc1t0cmFuc2FjdGlvbklkXS5kZXN0aW5hdGlvbi5jYWxsLnZhbHVlKHRyYW5zYWN0aW9uc1t0cmFuc2FjdGlvbklkXS52YWx1ZSkodHJhbnNhY3Rpb25zW3RyYW5zYWN0aW9uSWRdLmRhdGEpKSB7CiAgICAgICAgICAgICAgICBFeGVjdXRpb24odHJhbnNhY3Rpb25JZCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBFeGVjdXRpb25GYWlsdXJlKHRyYW5zYWN0aW9uSWQpOwogICAgICAgICAgICAgICAgdHJhbnNhY3Rpb25zW3RyYW5zYWN0aW9uSWRdLmV4ZWN1dGVkID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgLy8vIEBkZXYgUmV0dXJucyB0aGUgY29uZmlybWF0aW9uIHN0YXR1cyBvZiBhIHRyYW5zYWN0aW9uLgogICAgLy8vIEBwYXJhbSB0cmFuc2FjdGlvbklkIFRyYW5zYWN0aW9uIElELgogICAgLy8vIEByZXR1cm4gQ29uZmlybWF0aW9uIHN0YXR1cy4KICAgIGZ1bmN0aW9uIGlzQ29uZmlybWVkKHVpbnQgdHJhbnNhY3Rpb25JZCkKICAgICAgICBwdWJsaWMKICAgICAgICBjb25zdGFudAogICAgICAgIHJldHVybnMgKGJvb2wpCiAgICB7CiAgICAgICAgdWludCBjb3VudCA9IDA7CiAgICAgICAgZm9yICh1aW50IGkgPSAwOyBpIDwgb3duZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGlmIChjb25maXJtYXRpb25zW3RyYW5zYWN0aW9uSWRdW293bmVyc1tpXV0pCiAgICAgICAgICAgICAgICBjb3VudCArPSAxOwogICAgICAgICAgICBpZiAoY291bnQgPT0gcmVxdWlyZWQpCiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICB9CgogICAgLyoKICAgICAqIEludGVybmFsIGZ1bmN0aW9ucwogICAgICovCiAgICAvLy8gQGRldiBBZGRzIGEgbmV3IHRyYW5zYWN0aW9uIHRvIHRoZSB0cmFuc2FjdGlvbiBtYXBwaW5nLCBpZiB0cmFuc2FjdGlvbiBkb2VzIG5vdCBleGlzdCB5ZXQuCiAgICAvLy8gQHBhcmFtIGRlc3RpbmF0aW9uIFRyYW5zYWN0aW9uIHRhcmdldCBhZGRyZXNzLgogICAgLy8vIEBwYXJhbSB2YWx1ZSBUcmFuc2FjdGlvbiBldGhlciB2YWx1ZS4KICAgIC8vLyBAcGFyYW0gZGF0YSBUcmFuc2FjdGlvbiBkYXRhIHBheWxvYWQuCiAgICAvLy8gQHJldHVybiBSZXR1cm5zIHRyYW5zYWN0aW9uIElELgogICAgZnVuY3Rpb24gYWRkVHJhbnNhY3Rpb24oYWRkcmVzcyBkZXN0aW5hdGlvbiwgdWludCB2YWx1ZSwgYnl0ZXMgZGF0YSkKICAgICAgICBpbnRlcm5hbAogICAgICAgIG5vdE51bGwoZGVzdGluYXRpb24pCiAgICAgICAgcmV0dXJucyAodWludCB0cmFuc2FjdGlvbklkKQogICAgewogICAgICAgIHRyYW5zYWN0aW9uSWQgPSB0cmFuc2FjdGlvbkNvdW50OwogICAgICAgIHRyYW5zYWN0aW9uc1t0cmFuc2FjdGlvbklkXSA9IFRyYW5zYWN0aW9uKHsKICAgICAgICAgICAgZGVzdGluYXRpb246IGRlc3RpbmF0aW9uLCAKICAgICAgICAgICAgdmFsdWU6IHZhbHVlLAogICAgICAgICAgICBkYXRhOiBkYXRhLAogICAgICAgICAgICBleGVjdXRlZDogZmFsc2UKICAgICAgICB9KTsKICAgICAgICB0cmFuc2FjdGlvbkNvdW50ICs9IDE7CiAgICAgICAgU3VibWlzc2lvbih0cmFuc2FjdGlvbklkKTsKICAgIH0KCiAgICAvKgogICAgICogV2ViMyBjYWxsIGZ1bmN0aW9ucwogICAgICovCiAgICAvLy8gQGRldiBSZXR1cm5zIG51bWJlciBvZiBjb25maXJtYXRpb25zIG9mIGEgdHJhbnNhY3Rpb24uCiAgICAvLy8gQHBhcmFtIHRyYW5zYWN0aW9uSWQgVHJhbnNhY3Rpb24gSUQuCiAgICAvLy8gQHJldHVybiBOdW1iZXIgb2YgY29uZmlybWF0aW9ucy4KICAgIGZ1bmN0aW9uIGdldENvbmZpcm1hdGlvbkNvdW50KHVpbnQgdHJhbnNhY3Rpb25JZCkKICAgICAgICBwdWJsaWMKICAgICAgICBjb25zdGFudAogICAgICAgIHJldHVybnMgKHVpbnQgY291bnQpCiAgICB7CiAgICAgICAgZm9yICh1aW50IGkgPSAwOyBpIDwgb3duZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGlmIChjb25maXJtYXRpb25zW3RyYW5zYWN0aW9uSWRdW293bmVyc1tpXV0pCiAgICAgICAgICAgICAgICBjb3VudCArPSAxOwogICAgICAgIH0KICAgIH0KCiAgICAvLy8gQGRldiBSZXR1cm5zIHRvdGFsIG51bWJlciBvZiB0cmFuc2FjdGlvbnMgYWZ0ZXIgZmlsZXJzIGFyZSBhcHBsaWVkLgogICAgLy8vIEBwYXJhbSBwZW5kaW5nIEluY2x1ZGUgcGVuZGluZyB0cmFuc2FjdGlvbnMuCiAgICAvLy8gQHBhcmFtIGV4ZWN1dGVkIEluY2x1ZGUgZXhlY3V0ZWQgdHJhbnNhY3Rpb25zLgogICAgLy8vIEByZXR1cm4gVG90YWwgbnVtYmVyIG9mIHRyYW5zYWN0aW9ucyBhZnRlciBmaWx0ZXJzIGFyZSBhcHBsaWVkLgogICAgZnVuY3Rpb24gZ2V0VHJhbnNhY3Rpb25Db3VudChib29sIHBlbmRpbmcsIGJvb2wgZXhlY3V0ZWQpCiAgICAgICAgcHVibGljCiAgICAgICAgY29uc3RhbnQKICAgICAgICByZXR1cm5zICh1aW50IGNvdW50KQogICAgewogICAgICAgIGZvciAodWludCBpID0gMDsgaSA8IHRyYW5zYWN0aW9uQ291bnQ7IGkrKykgewogICAgICAgICAgICBpZiAocGVuZGluZyAmJiAhdHJhbnNhY3Rpb25zW2ldLmV4ZWN1dGVkIHx8IGV4ZWN1dGVkICYmIHRyYW5zYWN0aW9uc1tpXS5leGVjdXRlZCkKICAgICAgICAgICAgICAgIGNvdW50ICs9IDE7CiAgICAgICAgfQogICAgfQoKICAgIC8vLyBAZGV2IFJldHVybnMgbGlzdCBvZiBvd25lcnMuCiAgICAvLy8gQHJldHVybiBMaXN0IG9mIG93bmVyIGFkZHJlc3Nlcy4KICAgIGZ1bmN0aW9uIGdldE93bmVycygpCiAgICAgICAgcHVibGljCiAgICAgICAgY29uc3RhbnQKICAgICAgICByZXR1cm5zIChhZGRyZXNzW10pCiAgICB7CiAgICAgICAgcmV0dXJuIG93bmVyczsKICAgIH0KCiAgICAvLy8gQGRldiBSZXR1cm5zIGFycmF5IHdpdGggb3duZXIgYWRkcmVzc2VzLCB3aGljaCBjb25maXJtZWQgdHJhbnNhY3Rpb24uCiAgICAvLy8gQHBhcmFtIHRyYW5zYWN0aW9uSWQgVHJhbnNhY3Rpb24gSUQuCiAgICAvLy8gQHJldHVybiBSZXR1cm5zIGFycmF5IG9mIG93bmVyIGFkZHJlc3Nlcy4KICAgIGZ1bmN0aW9uIGdldENvbmZpcm1hdGlvbnModWludCB0cmFuc2FjdGlvbklkKQogICAgICAgIHB1YmxpYwogICAgICAgIGNvbnN0YW50CiAgICAgICAgcmV0dXJucyAoYWRkcmVzc1tdIF9jb25maXJtYXRpb25zKQogICAgewogICAgICAgIGFkZHJlc3NbXSBtZW1vcnkgY29uZmlybWF0aW9uc1RlbXAgPSBuZXcgYWRkcmVzc1tdKG93bmVycy5sZW5ndGgpOwogICAgICAgIHVpbnQgY291bnQgPSAwOwogICAgICAgIHVpbnQgaTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgb3duZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGlmIChjb25maXJtYXRpb25zW3RyYW5zYWN0aW9uSWRdW293bmVyc1tpXV0pIHsKICAgICAgICAgICAgICAgIGNvbmZpcm1hdGlvbnNUZW1wW2NvdW50XSA9IG93bmVyc1tpXTsKICAgICAgICAgICAgICAgIGNvdW50ICs9IDE7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgX2NvbmZpcm1hdGlvbnMgPSBuZXcgYWRkcmVzc1tdKGNvdW50KTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgY291bnQ7IGkrKykgewogICAgICAgICAgICBfY29uZmlybWF0aW9uc1tpXSA9IGNvbmZpcm1hdGlvbnNUZW1wW2ldOwogICAgICAgIH0KICAgIH0KCiAgICAvLy8gQGRldiBSZXR1cm5zIGxpc3Qgb2YgdHJhbnNhY3Rpb24gSURzIGluIGRlZmluZWQgcmFuZ2UuCiAgICAvLy8gQHBhcmFtIGZyb20gSW5kZXggc3RhcnQgcG9zaXRpb24gb2YgdHJhbnNhY3Rpb24gYXJyYXkuCiAgICAvLy8gQHBhcmFtIHRvIEluZGV4IGVuZCBwb3NpdGlvbiBvZiB0cmFuc2FjdGlvbiBhcnJheS4KICAgIC8vLyBAcGFyYW0gcGVuZGluZyBJbmNsdWRlIHBlbmRpbmcgdHJhbnNhY3Rpb25zLgogICAgLy8vIEBwYXJhbSBleGVjdXRlZCBJbmNsdWRlIGV4ZWN1dGVkIHRyYW5zYWN0aW9ucy4KICAgIC8vLyBAcmV0dXJuIFJldHVybnMgYXJyYXkgb2YgdHJhbnNhY3Rpb24gSURzLgogICAgZnVuY3Rpb24gZ2V0VHJhbnNhY3Rpb25JZHModWludCBmcm9tLCB1aW50IHRvLCBib29sIHBlbmRpbmcsIGJvb2wgZXhlY3V0ZWQpCiAgICAgICAgcHVibGljCiAgICAgICAgY29uc3RhbnQKICAgICAgICByZXR1cm5zICh1aW50W10gX3RyYW5zYWN0aW9uSWRzKQogICAgewogICAgICAgIHVpbnRbXSBtZW1vcnkgdHJhbnNhY3Rpb25JZHNUZW1wID0gbmV3IHVpbnRbXSh0cmFuc2FjdGlvbkNvdW50KTsKICAgICAgICB1aW50IGNvdW50ID0gMDsKICAgICAgICB1aW50IGk7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IHRyYW5zYWN0aW9uQ291bnQ7IGkrKykgewogICAgICAgICAgICBpZiAocGVuZGluZyAmJiAhdHJhbnNhY3Rpb25zW2ldLmV4ZWN1dGVkIHx8IGV4ZWN1dGVkICYmIHRyYW5zYWN0aW9uc1tpXS5leGVjdXRlZCkgewogICAgICAgICAgICAgICAgdHJhbnNhY3Rpb25JZHNUZW1wW2NvdW50XSA9IGk7CiAgICAgICAgICAgICAgICBjb3VudCArPSAxOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIF90cmFuc2FjdGlvbklkcyA9IG5ldyB1aW50W10odG8gLSBmcm9tKTsKICAgICAgICBmb3IgKGkgPSBmcm9tOyBpIDwgdG87IGkrKykgewogICAgICAgICAgICBfdHJhbnNhY3Rpb25JZHNbaSAtIGZyb21dID0gdHJhbnNhY3Rpb25JZHNUZW1wW2ldOwogICAgICAgIH0KICAgIH0KfQ=='.
	

]
