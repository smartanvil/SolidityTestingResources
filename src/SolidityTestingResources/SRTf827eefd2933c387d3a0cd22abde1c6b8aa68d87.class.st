Class {
	#name : #SRTf827eefd2933c387d3a0cd22abde1c6b8aa68d87,
	#superclass : #SRTContracts,
	#category : #SolidityTestingResources
}

{ #category : #base64 }
SRTf827eefd2933c387d3a0cd22abde1c6b8aa68d87 >> base64 [
	^ 'cHJhZ21hIHNvbGlkaXR5IF4wLjQuMTg7Cgpjb250cmFjdCBVdGlscyB7CgogICAgRVJDMjAgY29uc3RhbnQgaW50ZXJuYWwgRVRIX1RPS0VOX0FERFJFU1MgPSBFUkMyMCgweDAwZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZSk7CiAgICB1aW50ICBjb25zdGFudCBpbnRlcm5hbCBQUkVDSVNJT04gPSAoMTAqKjE4KTsKICAgIHVpbnQgIGNvbnN0YW50IGludGVybmFsIE1BWF9RVFkgICA9ICgxMCoqMjgpOyAvLyAxQiB0b2tlbnMKICAgIHVpbnQgIGNvbnN0YW50IGludGVybmFsIE1BWF9SQVRFICA9IChQUkVDSVNJT04gKiAxMCoqNik7IC8vIHVwIHRvIDFNIHRva2VucyBwZXIgRVRICiAgICB1aW50ICBjb25zdGFudCBpbnRlcm5hbCBNQVhfREVDSU1BTFMgPSAxODsKCiAgICBmdW5jdGlvbiBjYWxjRHN0UXR5KHVpbnQgc3JjUXR5LCB1aW50IHNyY0RlY2ltYWxzLCB1aW50IGRzdERlY2ltYWxzLCB1aW50IHJhdGUpIGludGVybmFsIHB1cmUgcmV0dXJucyh1aW50KSB7CiAgICAgICAgaWYgKGRzdERlY2ltYWxzID49IHNyY0RlY2ltYWxzKSB7CiAgICAgICAgICAgIHJlcXVpcmUoKGRzdERlY2ltYWxzIC0gc3JjRGVjaW1hbHMpIDw9IE1BWF9ERUNJTUFMUyk7CiAgICAgICAgICAgIHJldHVybiAoc3JjUXR5ICogcmF0ZSAqICgxMCoqKGRzdERlY2ltYWxzIC0gc3JjRGVjaW1hbHMpKSkgLyBQUkVDSVNJT047CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVxdWlyZSgoc3JjRGVjaW1hbHMgLSBkc3REZWNpbWFscykgPD0gTUFYX0RFQ0lNQUxTKTsKICAgICAgICAgICAgcmV0dXJuIChzcmNRdHkgKiByYXRlKSAvIChQUkVDSVNJT04gKiAoMTAqKihzcmNEZWNpbWFscyAtIGRzdERlY2ltYWxzKSkpOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBjYWxjU3JjUXR5KHVpbnQgZHN0UXR5LCB1aW50IHNyY0RlY2ltYWxzLCB1aW50IGRzdERlY2ltYWxzLCB1aW50IHJhdGUpIGludGVybmFsIHB1cmUgcmV0dXJucyh1aW50KSB7CiAgICAgICAgLy9zb3VyY2UgcXVhbnRpdHkgaXMgcm91bmRlZCB1cC4gdG8gYXZvaWQgZGVzdCBxdWFudGl0eSBiZWluZyB0b28gbG93LgogICAgICAgIHVpbnQgbnVtZXJhdG9yOwogICAgICAgIHVpbnQgZGVub21pbmF0b3I7CiAgICAgICAgaWYgKHNyY0RlY2ltYWxzID49IGRzdERlY2ltYWxzKSB7CiAgICAgICAgICAgIHJlcXVpcmUoKHNyY0RlY2ltYWxzIC0gZHN0RGVjaW1hbHMpIDw9IE1BWF9ERUNJTUFMUyk7CiAgICAgICAgICAgIG51bWVyYXRvciA9IChQUkVDSVNJT04gKiBkc3RRdHkgKiAoMTAqKihzcmNEZWNpbWFscyAtIGRzdERlY2ltYWxzKSkpOwogICAgICAgICAgICBkZW5vbWluYXRvciA9IHJhdGU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVxdWlyZSgoZHN0RGVjaW1hbHMgLSBzcmNEZWNpbWFscykgPD0gTUFYX0RFQ0lNQUxTKTsKICAgICAgICAgICAgbnVtZXJhdG9yID0gKFBSRUNJU0lPTiAqIGRzdFF0eSk7CiAgICAgICAgICAgIGRlbm9taW5hdG9yID0gKHJhdGUgKiAoMTAqKihkc3REZWNpbWFscyAtIHNyY0RlY2ltYWxzKSkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gKG51bWVyYXRvciArIGRlbm9taW5hdG9yIC0gMSkgLyBkZW5vbWluYXRvcjsgLy9hdm9pZCByb3VuZGluZyBkb3duIGVycm9ycwogICAgfQp9CgppbnRlcmZhY2UgRVJDMjAgewogICAgZnVuY3Rpb24gdG90YWxTdXBwbHkoKSBwdWJsaWMgdmlldyByZXR1cm5zICh1aW50IHN1cHBseSk7CiAgICBmdW5jdGlvbiBiYWxhbmNlT2YoYWRkcmVzcyBfb3duZXIpIHB1YmxpYyB2aWV3IHJldHVybnMgKHVpbnQgYmFsYW5jZSk7CiAgICBmdW5jdGlvbiB0cmFuc2ZlcihhZGRyZXNzIF90bywgdWludCBfdmFsdWUpIHB1YmxpYyByZXR1cm5zIChib29sIHN1Y2Nlc3MpOwogICAgZnVuY3Rpb24gdHJhbnNmZXJGcm9tKGFkZHJlc3MgX2Zyb20sIGFkZHJlc3MgX3RvLCB1aW50IF92YWx1ZSkgcHVibGljIHJldHVybnMgKGJvb2wgc3VjY2Vzcyk7CiAgICBmdW5jdGlvbiBhcHByb3ZlKGFkZHJlc3MgX3NwZW5kZXIsIHVpbnQgX3ZhbHVlKSBwdWJsaWMgcmV0dXJucyAoYm9vbCBzdWNjZXNzKTsKICAgIGZ1bmN0aW9uIGFsbG93YW5jZShhZGRyZXNzIF9vd25lciwgYWRkcmVzcyBfc3BlbmRlcikgcHVibGljIHZpZXcgcmV0dXJucyAodWludCByZW1haW5pbmcpOwogICAgZnVuY3Rpb24gZGVjaW1hbHMoKSBwdWJsaWMgdmlldyByZXR1cm5zKHVpbnQgZGlnaXRzKTsKICAgIGV2ZW50IEFwcHJvdmFsKGFkZHJlc3MgaW5kZXhlZCBfb3duZXIsIGFkZHJlc3MgaW5kZXhlZCBfc3BlbmRlciwgdWludCBfdmFsdWUpOwp9CgppbnRlcmZhY2UgQnVybmFibGVUb2tlbiB7CiAgICBmdW5jdGlvbiB0cmFuc2ZlckZyb20oYWRkcmVzcyBfZnJvbSwgYWRkcmVzcyBfdG8sIHVpbnQgX3ZhbHVlKSBwdWJsaWMgcmV0dXJucyAoYm9vbCk7CiAgICBmdW5jdGlvbiBidXJuRnJvbShhZGRyZXNzIF9mcm9tLCB1aW50MjU2IF92YWx1ZSkgcHVibGljIHJldHVybnMgKGJvb2wpOwp9CgppbnRlcmZhY2UgRXhwZWN0ZWRSYXRlSW50ZXJmYWNlIHsKICAgIGZ1bmN0aW9uIGdldEV4cGVjdGVkUmF0ZShFUkMyMCBzcmMsIEVSQzIwIGRlc3QsIHVpbnQgc3JjUXR5KSBwdWJsaWMgdmlldwogICAgICAgIHJldHVybnMgKHVpbnQgZXhwZWN0ZWRSYXRlLCB1aW50IHNsaXBwYWdlUmF0ZSk7Cn0KCmNvbnRyYWN0IFBlcm1pc3Npb25Hcm91cHMgewoKICAgIGFkZHJlc3MgcHVibGljIGFkbWluOwogICAgYWRkcmVzcyBwdWJsaWMgcGVuZGluZ0FkbWluOwogICAgbWFwcGluZyhhZGRyZXNzPT5ib29sKSBpbnRlcm5hbCBvcGVyYXRvcnM7CiAgICBtYXBwaW5nKGFkZHJlc3M9PmJvb2wpIGludGVybmFsIGFsZXJ0ZXJzOwogICAgYWRkcmVzc1tdIGludGVybmFsIG9wZXJhdG9yc0dyb3VwOwogICAgYWRkcmVzc1tdIGludGVybmFsIGFsZXJ0ZXJzR3JvdXA7CgogICAgZnVuY3Rpb24gUGVybWlzc2lvbkdyb3VwcygpIHB1YmxpYyB7CiAgICAgICAgYWRtaW4gPSBtc2cuc2VuZGVyOwogICAgfQoKICAgIG1vZGlmaWVyIG9ubHlBZG1pbigpIHsKICAgICAgICByZXF1aXJlKG1zZy5zZW5kZXIgPT0gYWRtaW4pOwogICAgICAgIF87CiAgICB9CgogICAgbW9kaWZpZXIgb25seU9wZXJhdG9yKCkgewogICAgICAgIHJlcXVpcmUob3BlcmF0b3JzW21zZy5zZW5kZXJdKTsKICAgICAgICBfOwogICAgfQoKICAgIG1vZGlmaWVyIG9ubHlBbGVydGVyKCkgewogICAgICAgIHJlcXVpcmUoYWxlcnRlcnNbbXNnLnNlbmRlcl0pOwogICAgICAgIF87CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0T3BlcmF0b3JzICgpIGV4dGVybmFsIHZpZXcgcmV0dXJucyhhZGRyZXNzW10pIHsKICAgICAgICByZXR1cm4gb3BlcmF0b3JzR3JvdXA7CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0QWxlcnRlcnMgKCkgZXh0ZXJuYWwgdmlldyByZXR1cm5zKGFkZHJlc3NbXSkgewogICAgICAgIHJldHVybiBhbGVydGVyc0dyb3VwOwogICAgfQoKICAgIGV2ZW50IFRyYW5zZmVyQWRtaW5QZW5kaW5nKGFkZHJlc3MgcGVuZGluZ0FkbWluKTsKCiAgICAvKioKICAgICAqIEBkZXYgQWxsb3dzIHRoZSBjdXJyZW50IGFkbWluIHRvIHNldCB0aGUgcGVuZGluZ0FkbWluIGFkZHJlc3MuCiAgICAgKiBAcGFyYW0gbmV3QWRtaW4gVGhlIGFkZHJlc3MgdG8gdHJhbnNmZXIgb3duZXJzaGlwIHRvLgogICAgICovCiAgICBmdW5jdGlvbiB0cmFuc2ZlckFkbWluKGFkZHJlc3MgbmV3QWRtaW4pIHB1YmxpYyBvbmx5QWRtaW4gewogICAgICAgIHJlcXVpcmUobmV3QWRtaW4gIT0gYWRkcmVzcygwKSk7CiAgICAgICAgVHJhbnNmZXJBZG1pblBlbmRpbmcocGVuZGluZ0FkbWluKTsKICAgICAgICBwZW5kaW5nQWRtaW4gPSBuZXdBZG1pbjsKICAgIH0KCiAgICBldmVudCBBZG1pbkNsYWltZWQoIGFkZHJlc3MgbmV3QWRtaW4sIGFkZHJlc3MgcHJldmlvdXNBZG1pbik7CgogICAgLyoqCiAgICAgKiBAZGV2IEFsbG93cyB0aGUgcGVuZGluZ0FkbWluIGFkZHJlc3MgdG8gZmluYWxpemUgdGhlIGNoYW5nZSBhZG1pbiBwcm9jZXNzLgogICAgICovCiAgICBmdW5jdGlvbiBjbGFpbUFkbWluKCkgcHVibGljIHsKICAgICAgICByZXF1aXJlKHBlbmRpbmdBZG1pbiA9PSBtc2cuc2VuZGVyKTsKICAgICAgICBBZG1pbkNsYWltZWQocGVuZGluZ0FkbWluLCBhZG1pbik7CiAgICAgICAgYWRtaW4gPSBwZW5kaW5nQWRtaW47CiAgICAgICAgcGVuZGluZ0FkbWluID0gYWRkcmVzcygwKTsKICAgIH0KCiAgICBldmVudCBBbGVydGVyQWRkZWQgKGFkZHJlc3MgbmV3QWxlcnRlciwgYm9vbCBpc0FkZCk7CgogICAgZnVuY3Rpb24gYWRkQWxlcnRlcihhZGRyZXNzIG5ld0FsZXJ0ZXIpIHB1YmxpYyBvbmx5QWRtaW4gewogICAgICAgIHJlcXVpcmUoIWFsZXJ0ZXJzW25ld0FsZXJ0ZXJdKTsgLy8gcHJldmVudCBkdXBsaWNhdGVzLgogICAgICAgIEFsZXJ0ZXJBZGRlZChuZXdBbGVydGVyLCB0cnVlKTsKICAgICAgICBhbGVydGVyc1tuZXdBbGVydGVyXSA9IHRydWU7CiAgICAgICAgYWxlcnRlcnNHcm91cC5wdXNoKG5ld0FsZXJ0ZXIpOwogICAgfQoKICAgIGZ1bmN0aW9uIHJlbW92ZUFsZXJ0ZXIgKGFkZHJlc3MgYWxlcnRlcikgcHVibGljIG9ubHlBZG1pbiB7CiAgICAgICAgcmVxdWlyZShhbGVydGVyc1thbGVydGVyXSk7CiAgICAgICAgYWxlcnRlcnNbYWxlcnRlcl0gPSBmYWxzZTsKCiAgICAgICAgZm9yICh1aW50IGkgPSAwOyBpIDwgYWxlcnRlcnNHcm91cC5sZW5ndGg7ICsraSkgewogICAgICAgICAgICBpZiAoYWxlcnRlcnNHcm91cFtpXSA9PSBhbGVydGVyKSB7CiAgICAgICAgICAgICAgICBhbGVydGVyc0dyb3VwW2ldID0gYWxlcnRlcnNHcm91cFthbGVydGVyc0dyb3VwLmxlbmd0aCAtIDFdOwogICAgICAgICAgICAgICAgYWxlcnRlcnNHcm91cC5sZW5ndGgtLTsKICAgICAgICAgICAgICAgIEFsZXJ0ZXJBZGRlZChhbGVydGVyLCBmYWxzZSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBldmVudCBPcGVyYXRvckFkZGVkKGFkZHJlc3MgbmV3T3BlcmF0b3IsIGJvb2wgaXNBZGQpOwoKICAgIGZ1bmN0aW9uIGFkZE9wZXJhdG9yKGFkZHJlc3MgbmV3T3BlcmF0b3IpIHB1YmxpYyBvbmx5QWRtaW4gewogICAgICAgIHJlcXVpcmUoIW9wZXJhdG9yc1tuZXdPcGVyYXRvcl0pOyAvLyBwcmV2ZW50IGR1cGxpY2F0ZXMuCiAgICAgICAgT3BlcmF0b3JBZGRlZChuZXdPcGVyYXRvciwgdHJ1ZSk7CiAgICAgICAgb3BlcmF0b3JzW25ld09wZXJhdG9yXSA9IHRydWU7CiAgICAgICAgb3BlcmF0b3JzR3JvdXAucHVzaChuZXdPcGVyYXRvcik7CiAgICB9CgogICAgZnVuY3Rpb24gcmVtb3ZlT3BlcmF0b3IgKGFkZHJlc3Mgb3BlcmF0b3IpIHB1YmxpYyBvbmx5QWRtaW4gewogICAgICAgIHJlcXVpcmUob3BlcmF0b3JzW29wZXJhdG9yXSk7CiAgICAgICAgb3BlcmF0b3JzW29wZXJhdG9yXSA9IGZhbHNlOwoKICAgICAgICBmb3IgKHVpbnQgaSA9IDA7IGkgPCBvcGVyYXRvcnNHcm91cC5sZW5ndGg7ICsraSkgewogICAgICAgICAgICBpZiAob3BlcmF0b3JzR3JvdXBbaV0gPT0gb3BlcmF0b3IpIHsKICAgICAgICAgICAgICAgIG9wZXJhdG9yc0dyb3VwW2ldID0gb3BlcmF0b3JzR3JvdXBbb3BlcmF0b3JzR3JvdXAubGVuZ3RoIC0gMV07CiAgICAgICAgICAgICAgICBvcGVyYXRvcnNHcm91cC5sZW5ndGggLT0gMTsKICAgICAgICAgICAgICAgIE9wZXJhdG9yQWRkZWQob3BlcmF0b3IsIGZhbHNlKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQp9CgppbnRlcmZhY2UgU2FuaXR5UmF0ZXNJbnRlcmZhY2UgewogICAgZnVuY3Rpb24gZ2V0U2FuaXR5UmF0ZShFUkMyMCBzcmMsIEVSQzIwIGRlc3QpIHB1YmxpYyB2aWV3IHJldHVybnModWludCk7Cn0KCmNvbnRyYWN0IFdpdGhkcmF3YWJsZSBpcyBQZXJtaXNzaW9uR3JvdXBzIHsKCiAgICBldmVudCBUb2tlbldpdGhkcmF3KEVSQzIwIHRva2VuLCB1aW50IGFtb3VudCwgYWRkcmVzcyBzZW5kVG8pOwoKICAgIC8qKgogICAgICogQGRldiBXaXRoZHJhdyBhbGwgRVJDMjAgY29tcGF0aWJsZSB0b2tlbnMKICAgICAqIEBwYXJhbSB0b2tlbiBFUkMyMCBUaGUgYWRkcmVzcyBvZiB0aGUgdG9rZW4gY29udHJhY3QKICAgICAqLwogICAgZnVuY3Rpb24gd2l0aGRyYXdUb2tlbihFUkMyMCB0b2tlbiwgdWludCBhbW91bnQsIGFkZHJlc3Mgc2VuZFRvKSBleHRlcm5hbCBvbmx5QWRtaW4gewogICAgICAgIHJlcXVpcmUodG9rZW4udHJhbnNmZXIoc2VuZFRvLCBhbW91bnQpKTsKICAgICAgICBUb2tlbldpdGhkcmF3KHRva2VuLCBhbW91bnQsIHNlbmRUbyk7CiAgICB9CgogICAgZXZlbnQgRXRoZXJXaXRoZHJhdyh1aW50IGFtb3VudCwgYWRkcmVzcyBzZW5kVG8pOwoKICAgIC8qKgogICAgICogQGRldiBXaXRoZHJhdyBFdGhlcnMKICAgICAqLwogICAgZnVuY3Rpb24gd2l0aGRyYXdFdGhlcih1aW50IGFtb3VudCwgYWRkcmVzcyBzZW5kVG8pIGV4dGVybmFsIG9ubHlBZG1pbiB7CiAgICAgICAgc2VuZFRvLnRyYW5zZmVyKGFtb3VudCk7CiAgICAgICAgRXRoZXJXaXRoZHJhdyhhbW91bnQsIHNlbmRUbyk7CiAgICB9Cn0KCmNvbnRyYWN0IEt5YmVyTmV0d29yayBpcyBXaXRoZHJhd2FibGUsIFV0aWxzIHsKCiAgICB1aW50IHB1YmxpYyBuZWdsaWdpYmxlUmF0ZURpZmYgPSAxMDsgLy8gYmFzaWMgcmF0ZSBzdGVwcyB3aWxsIGJlIGluIDAuMDElCiAgICBLeWJlclJlc2VydmVbXSBwdWJsaWMgcmVzZXJ2ZXM7CiAgICBtYXBwaW5nKGFkZHJlc3M9PmJvb2wpIHB1YmxpYyBpc1Jlc2VydmU7CiAgICBXaGl0ZUxpc3QgcHVibGljIHdoaXRlTGlzdENvbnRyYWN0OwogICAgRXhwZWN0ZWRSYXRlSW50ZXJmYWNlIHB1YmxpYyBleHBlY3RlZFJhdGVDb250cmFjdDsKICAgIEZlZUJ1cm5lckludGVyZmFjZSAgICBwdWJsaWMgZmVlQnVybmVyQ29udHJhY3Q7CiAgICB1aW50ICAgICAgICAgICAgICAgICAgcHVibGljIG1heEdhc1ByaWNlID0gNTAgKiAxMDAwICogMTAwMCAqIDEwMDA7IC8vIDUwIGd3ZWkKICAgIGJvb2wgICAgICAgICAgICAgICAgICBwdWJsaWMgZW5hYmxlZCA9IGZhbHNlOyAvLyBuZXR3b3JrIGlzIGVuYWJsZWQKICAgIG1hcHBpbmcoYWRkcmVzcz0+bWFwcGluZyhieXRlczMyPT5ib29sKSkgcHVibGljIHBlclJlc2VydmVMaXN0ZWRQYWlyczsKCiAgICBmdW5jdGlvbiBLeWJlck5ldHdvcmsoYWRkcmVzcyBfYWRtaW4pIHB1YmxpYyB7CiAgICAgICAgcmVxdWlyZShfYWRtaW4gIT0gYWRkcmVzcygwKSk7CiAgICAgICAgYWRtaW4gPSBfYWRtaW47CiAgICB9CgogICAgZXZlbnQgRXRoZXJSZWNlaXZhbChhZGRyZXNzIGluZGV4ZWQgc2VuZGVyLCB1aW50IGFtb3VudCk7CgogICAgLyogc29saGludC1kaXNhYmxlIG5vLWNvbXBsZXgtZmFsbGJhY2sgKi8KICAgIGZ1bmN0aW9uKCkgcHVibGljIHBheWFibGUgewogICAgICAgIHJlcXVpcmUoaXNSZXNlcnZlW21zZy5zZW5kZXJdKTsKICAgICAgICBFdGhlclJlY2VpdmFsKG1zZy5zZW5kZXIsIG1zZy52YWx1ZSk7CiAgICB9CiAgICAvKiBzb2xoaW50LWVuYWJsZSBuby1jb21wbGV4LWZhbGxiYWNrICovCgogICAgZXZlbnQgRXhlY3V0ZVRyYWRlKGFkZHJlc3MgaW5kZXhlZCBzZW5kZXIsIEVSQzIwIHNyYywgRVJDMjAgZGVzdCwgdWludCBhY3R1YWxTcmNBbW91bnQsIHVpbnQgYWN0dWFsRGVzdEFtb3VudCk7CgogICAgLy8vIEBub3RpY2UgdXNlIHRva2VuIGFkZHJlc3MgRVRIX1RPS0VOX0FERFJFU1MgZm9yIGV0aGVyCiAgICAvLy8gQGRldiBtYWtlcyBhIHRyYWRlIGJldHdlZW4gc3JjIGFuZCBkZXN0IHRva2VuIGFuZCBzZW5kIGRlc3QgdG9rZW4gdG8gZGVzdEFkZHJlc3MKICAgIC8vLyBAcGFyYW0gc3JjIFNyYyB0b2tlbgogICAgLy8vIEBwYXJhbSBzcmNBbW91bnQgYW1vdW50IG9mIHNyYyB0b2tlbnMKICAgIC8vLyBAcGFyYW0gZGVzdCAgIERlc3RpbmF0aW9uIHRva2VuCiAgICAvLy8gQHBhcmFtIGRlc3RBZGRyZXNzIEFkZHJlc3MgdG8gc2VuZCB0b2tlbnMgdG8KICAgIC8vLyBAcGFyYW0gbWF4RGVzdEFtb3VudCBBIGxpbWl0IG9uIHRoZSBhbW91bnQgb2YgZGVzdCB0b2tlbnMKICAgIC8vLyBAcGFyYW0gbWluQ29udmVyc2lvblJhdGUgVGhlIG1pbmltYWwgY29udmVyc2lvbiByYXRlLiBJZiBhY3R1YWwgcmF0ZSBpcyBsb3dlciwgdHJhZGUgaXMgY2FuY2VsZWQuCiAgICAvLy8gQHBhcmFtIHdhbGxldElkIGlzIHRoZSB3YWxsZXQgSUQgdG8gc2VuZCBwYXJ0IG9mIHRoZSBmZWVzCiAgICAvLy8gQHJldHVybiBhbW91bnQgb2YgYWN0dWFsIGRlc3QgdG9rZW5zCiAgICBmdW5jdGlvbiB0cmFkZSgKICAgICAgICBFUkMyMCBzcmMsCiAgICAgICAgdWludCBzcmNBbW91bnQsCiAgICAgICAgRVJDMjAgZGVzdCwKICAgICAgICBhZGRyZXNzIGRlc3RBZGRyZXNzLAogICAgICAgIHVpbnQgbWF4RGVzdEFtb3VudCwKICAgICAgICB1aW50IG1pbkNvbnZlcnNpb25SYXRlLAogICAgICAgIGFkZHJlc3Mgd2FsbGV0SWQKICAgICkKICAgICAgICBwdWJsaWMKICAgICAgICBwYXlhYmxlCiAgICAgICAgcmV0dXJucyh1aW50KQogICAgewogICAgICAgIHJlcXVpcmUoZW5hYmxlZCk7CgogICAgICAgIHVpbnQgdXNlclNyY0JhbGFuY2VCZWZvcmU7CiAgICAgICAgdWludCB1c2VyU3JjQmFsYW5jZUFmdGVyOwogICAgICAgIHVpbnQgdXNlckRlc3RCYWxhbmNlQmVmb3JlOwogICAgICAgIHVpbnQgdXNlckRlc3RCYWxhbmNlQWZ0ZXI7CgogICAgICAgIHVzZXJTcmNCYWxhbmNlQmVmb3JlID0gZ2V0QmFsYW5jZShzcmMsIG1zZy5zZW5kZXIpOwogICAgICAgIGlmIChzcmMgPT0gRVRIX1RPS0VOX0FERFJFU1MpCiAgICAgICAgICAgIHVzZXJTcmNCYWxhbmNlQmVmb3JlICs9IG1zZy52YWx1ZTsKICAgICAgICB1c2VyRGVzdEJhbGFuY2VCZWZvcmUgPSBnZXRCYWxhbmNlKGRlc3QsIGRlc3RBZGRyZXNzKTsKCiAgICAgICAgdWludCBhY3R1YWxEZXN0QW1vdW50ID0gZG9UcmFkZShzcmMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzcmNBbW91bnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXN0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVzdEFkZHJlc3MsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXhEZXN0QW1vdW50LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWluQ29udmVyc2lvblJhdGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3YWxsZXRJZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICByZXF1aXJlKGFjdHVhbERlc3RBbW91bnQgPiAwKTsKCiAgICAgICAgdXNlclNyY0JhbGFuY2VBZnRlciA9IGdldEJhbGFuY2Uoc3JjLCBtc2cuc2VuZGVyKTsKICAgICAgICB1c2VyRGVzdEJhbGFuY2VBZnRlciA9IGdldEJhbGFuY2UoZGVzdCwgZGVzdEFkZHJlc3MpOwoKICAgICAgICByZXF1aXJlKHVzZXJTcmNCYWxhbmNlQWZ0ZXIgPD0gdXNlclNyY0JhbGFuY2VCZWZvcmUpOwogICAgICAgIHJlcXVpcmUodXNlckRlc3RCYWxhbmNlQWZ0ZXIgPj0gdXNlckRlc3RCYWxhbmNlQmVmb3JlKTsKCiAgICAgICAgcmVxdWlyZSgodXNlckRlc3RCYWxhbmNlQWZ0ZXIgLSB1c2VyRGVzdEJhbGFuY2VCZWZvcmUpID49CiAgICAgICAgICAgIGNhbGNEc3RRdHkoKHVzZXJTcmNCYWxhbmNlQmVmb3JlIC0gdXNlclNyY0JhbGFuY2VBZnRlciksIGdldERlY2ltYWxzKHNyYyksIGdldERlY2ltYWxzKGRlc3QpLAogICAgICAgICAgICAgICAgbWluQ29udmVyc2lvblJhdGUpKTsKCiAgICAgICAgcmV0dXJuIGFjdHVhbERlc3RBbW91bnQ7CiAgICB9CgogICAgZXZlbnQgQWRkUmVzZXJ2ZVRvTmV0d29yayhLeWJlclJlc2VydmUgcmVzZXJ2ZSwgYm9vbCBhZGQpOwoKICAgIC8vLyBAbm90aWNlIGNhbiBiZSBjYWxsZWQgb25seSBieSBhZG1pbgogICAgLy8vIEBkZXYgYWRkIG9yIGRlbGV0ZXMgYSByZXNlcnZlIHRvL2Zyb20gdGhlIG5ldHdvcmsuCiAgICAvLy8gQHBhcmFtIHJlc2VydmUgVGhlIHJlc2VydmUgYWRkcmVzcy4KICAgIC8vLyBAcGFyYW0gYWRkIElmIHRydWUsIHRoZSBhZGQgcmVzZXJ2ZS4gT3RoZXJ3aXNlIGRlbGV0ZSByZXNlcnZlLgogICAgZnVuY3Rpb24gYWRkUmVzZXJ2ZShLeWJlclJlc2VydmUgcmVzZXJ2ZSwgYm9vbCBhZGQpIHB1YmxpYyBvbmx5QWRtaW4gewoKICAgICAgICBpZiAoYWRkKSB7CiAgICAgICAgICAgIHJlcXVpcmUoIWlzUmVzZXJ2ZVtyZXNlcnZlXSk7CiAgICAgICAgICAgIHJlc2VydmVzLnB1c2gocmVzZXJ2ZSk7CiAgICAgICAgICAgIGlzUmVzZXJ2ZVtyZXNlcnZlXSA9IHRydWU7CiAgICAgICAgICAgIEFkZFJlc2VydmVUb05ldHdvcmsocmVzZXJ2ZSwgdHJ1ZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaXNSZXNlcnZlW3Jlc2VydmVdID0gZmFsc2U7CiAgICAgICAgICAgIC8vIHdpbGwgaGF2ZSB0cm91YmxlIGlmIG1vcmUgdGhhbiA1MGsgcmVzZXJ2ZXMuLi4KICAgICAgICAgICAgZm9yICh1aW50IGkgPSAwOyBpIDwgcmVzZXJ2ZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmIChyZXNlcnZlc1tpXSA9PSByZXNlcnZlKSB7CiAgICAgICAgICAgICAgICAgICAgcmVzZXJ2ZXNbaV0gPSByZXNlcnZlc1tyZXNlcnZlcy5sZW5ndGggLSAxXTsKICAgICAgICAgICAgICAgICAgICByZXNlcnZlcy5sZW5ndGgtLTsKICAgICAgICAgICAgICAgICAgICBBZGRSZXNlcnZlVG9OZXR3b3JrKHJlc2VydmUsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBldmVudCBMaXN0UmVzZXJ2ZVBhaXJzKGFkZHJlc3MgcmVzZXJ2ZSwgRVJDMjAgc3JjLCBFUkMyMCBkZXN0LCBib29sIGFkZCk7CgogICAgLy8vIEBub3RpY2UgY2FuIGJlIGNhbGxlZCBvbmx5IGJ5IGFkbWluCiAgICAvLy8gQGRldiBhbGxvdyBvciBwcmV2ZW50IGEgc3BlY2lmaWMgcmVzZXJ2ZSB0byB0cmFkZSBhIHBhaXIgb2YgdG9rZW5zCiAgICAvLy8gQHBhcmFtIHJlc2VydmUgVGhlIHJlc2VydmUgYWRkcmVzcy4KICAgIC8vLyBAcGFyYW0gc3JjIFNyYyB0b2tlbgogICAgLy8vIEBwYXJhbSBkZXN0IERlc3RpbmF0aW9uIHRva2VuCiAgICAvLy8gQHBhcmFtIGFkZCBJZiB0cnVlIHRoZW4gZW5hYmxlIHRyYWRlLCBvdGhlcndpc2UgZGVsaXN0IHBhaXIuCiAgICBmdW5jdGlvbiBsaXN0UGFpckZvclJlc2VydmUoYWRkcmVzcyByZXNlcnZlLCBFUkMyMCBzcmMsIEVSQzIwIGRlc3QsIGJvb2wgYWRkKSBwdWJsaWMgb25seUFkbWluIHsKICAgICAgICAocGVyUmVzZXJ2ZUxpc3RlZFBhaXJzW3Jlc2VydmVdKVtrZWNjYWsyNTYoc3JjLCBkZXN0KV0gPSBhZGQ7CgogICAgICAgIGlmIChzcmMgIT0gRVRIX1RPS0VOX0FERFJFU1MpIHsKICAgICAgICAgICAgaWYgKGFkZCkgewogICAgICAgICAgICAgICAgc3JjLmFwcHJvdmUocmVzZXJ2ZSwgMioqMjU1KTsgLy8gYXBwcm92ZSBpbmZpbml0eQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgc3JjLmFwcHJvdmUocmVzZXJ2ZSwgMCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIExpc3RSZXNlcnZlUGFpcnMocmVzZXJ2ZSwgc3JjLCBkZXN0LCBhZGQpOwogICAgfQoKICAgIGZ1bmN0aW9uIHNldFBhcmFtcygKICAgICAgICBXaGl0ZUxpc3QgX3doaXRlTGlzdCwKICAgICAgICBFeHBlY3RlZFJhdGVJbnRlcmZhY2UgX2V4cGVjdGVkUmF0ZSwKICAgICAgICBGZWVCdXJuZXJJbnRlcmZhY2UgICAgX2ZlZUJ1cm5lciwKICAgICAgICB1aW50ICAgICAgICAgICAgICAgICAgX21heEdhc1ByaWNlLAogICAgICAgIHVpbnQgICAgICAgICAgICAgICAgICBfbmVnbGlnaWJsZVJhdGVEaWZmCiAgICApCiAgICAgICAgcHVibGljCiAgICAgICAgb25seUFkbWluCiAgICB7CiAgICAgICAgcmVxdWlyZShfd2hpdGVMaXN0ICE9IGFkZHJlc3MoMCkpOwogICAgICAgIHJlcXVpcmUoX2ZlZUJ1cm5lciAhPSBhZGRyZXNzKDApKTsKICAgICAgICByZXF1aXJlKF9leHBlY3RlZFJhdGUgIT0gYWRkcmVzcygwKSk7CiAgICAgICAgd2hpdGVMaXN0Q29udHJhY3QgPSBfd2hpdGVMaXN0OwogICAgICAgIGV4cGVjdGVkUmF0ZUNvbnRyYWN0ID0gX2V4cGVjdGVkUmF0ZTsKICAgICAgICBmZWVCdXJuZXJDb250cmFjdCA9IF9mZWVCdXJuZXI7CiAgICAgICAgbWF4R2FzUHJpY2UgPSBfbWF4R2FzUHJpY2U7CiAgICAgICAgbmVnbGlnaWJsZVJhdGVEaWZmID0gX25lZ2xpZ2libGVSYXRlRGlmZjsKICAgIH0KCiAgICBmdW5jdGlvbiBzZXRFbmFibGUoYm9vbCBfZW5hYmxlKSBwdWJsaWMgb25seUFkbWluIHsKICAgICAgICBpZiAoX2VuYWJsZSkgewogICAgICAgICAgICByZXF1aXJlKHdoaXRlTGlzdENvbnRyYWN0ICE9IGFkZHJlc3MoMCkpOwogICAgICAgICAgICByZXF1aXJlKGZlZUJ1cm5lckNvbnRyYWN0ICE9IGFkZHJlc3MoMCkpOwogICAgICAgICAgICByZXF1aXJlKGV4cGVjdGVkUmF0ZUNvbnRyYWN0ICE9IGFkZHJlc3MoMCkpOwogICAgICAgIH0KICAgICAgICBlbmFibGVkID0gX2VuYWJsZTsKICAgIH0KCiAgICAvLy8gQGRldiByZXR1cm5zIG51bWJlciBvZiByZXNlcnZlcwogICAgLy8vIEByZXR1cm4gbnVtYmVyIG9mIHJlc2VydmVzCiAgICBmdW5jdGlvbiBnZXROdW1SZXNlcnZlcygpIHB1YmxpYyB2aWV3IHJldHVybnModWludCkgewogICAgICAgIHJldHVybiByZXNlcnZlcy5sZW5ndGg7CiAgICB9CgogICAgLy8vIEBub3RpY2Ugc2hvdWxkIGJlIGNhbGxlZCBvZmYgY2hhaW4gd2l0aCBhcyBtdWNoIGdhcyBhcyBuZWVkZWQKICAgIC8vLyBAZGV2IGdldCBhbiBhcnJheSBvZiBhbGwgcmVzZXJ2ZXMKICAgIC8vLyBAcmV0dXJuIEFuIGFycmF5IG9mIGFsbCByZXNlcnZlcwogICAgZnVuY3Rpb24gZ2V0UmVzZXJ2ZXMoKSBwdWJsaWMgdmlldyByZXR1cm5zKEt5YmVyUmVzZXJ2ZVtdKSB7CiAgICAgICAgcmV0dXJuIHJlc2VydmVzOwogICAgfQoKICAgIC8vLyBAZGV2IGdldCB0aGUgYmFsYW5jZSBvZiBhIHVzZXIuCiAgICAvLy8gQHBhcmFtIHRva2VuIFRoZSB0b2tlbiB0eXBlCiAgICAvLy8gQHJldHVybiBUaGUgYmFsYW5jZQogICAgZnVuY3Rpb24gZ2V0QmFsYW5jZShFUkMyMCB0b2tlbiwgYWRkcmVzcyB1c2VyKSBwdWJsaWMgdmlldyByZXR1cm5zKHVpbnQpIHsKICAgICAgICBpZiAodG9rZW4gPT0gRVRIX1RPS0VOX0FERFJFU1MpCiAgICAgICAgICAgIHJldHVybiB1c2VyLmJhbGFuY2U7CiAgICAgICAgZWxzZQogICAgICAgICAgICByZXR1cm4gdG9rZW4uYmFsYW5jZU9mKHVzZXIpOwogICAgfQoKICAgIC8vLyBAbm90aWNlIHVzZSB0b2tlbiBhZGRyZXNzIEVUSF9UT0tFTl9BRERSRVNTIGZvciBldGhlcgogICAgLy8vIEBkZXYgYmVzdCBjb252ZXJzaW9uIHJhdGUgZm9yIGEgcGFpciBvZiB0b2tlbnMsIGlmIG51bWJlciBvZiByZXNlcnZlcyBoYXZlIHNtYWxsIGRpZmZlcmVuY2VzLiByYW5kb21pemUKICAgIC8vLyBAcGFyYW0gc3JjIFNyYyB0b2tlbgogICAgLy8vIEBwYXJhbSBkZXN0IERlc3RpbmF0aW9uIHRva2VuCiAgICAvKiBzb2xoaW50LWRpc2FibGUgY29kZS1jb21wbGV4aXR5ICovCiAgICBmdW5jdGlvbiBmaW5kQmVzdFJhdGUoRVJDMjAgc3JjLCBFUkMyMCBkZXN0LCB1aW50IHNyY1F0eSkgcHVibGljIHZpZXcgcmV0dXJucyh1aW50LCB1aW50KSB7CiAgICAgICAgdWludCBiZXN0UmF0ZSA9IDA7CiAgICAgICAgdWludCBiZXN0UmVzZXJ2ZSA9IDA7CiAgICAgICAgdWludCBudW1SZWxldmFudFJlc2VydmVzID0gMDsKICAgICAgICB1aW50IG51bVJlc2VydmVzID0gcmVzZXJ2ZXMubGVuZ3RoOwogICAgICAgIHVpbnRbXSBtZW1vcnkgcmF0ZXMgPSBuZXcgdWludFtdKG51bVJlc2VydmVzKTsKICAgICAgICB1aW50W10gbWVtb3J5IHJlc2VydmVDYW5kaWRhdGVzID0gbmV3IHVpbnRbXShudW1SZXNlcnZlcyk7CgogICAgICAgIGZvciAodWludCBpID0gMDsgaSA8IG51bVJlc2VydmVzOyBpKyspIHsKICAgICAgICAgICAgLy9saXN0IGFsbCByZXNlcnZlcyB0aGF0IGhhdmUgdGhpcyB0b2tlbi4KICAgICAgICAgICAgaWYgKCEocGVyUmVzZXJ2ZUxpc3RlZFBhaXJzW3Jlc2VydmVzW2ldXSlba2VjY2FrMjU2KHNyYywgZGVzdCldKSBjb250aW51ZTsKCiAgICAgICAgICAgIHJhdGVzW2ldID0gcmVzZXJ2ZXNbaV0uZ2V0Q29udmVyc2lvblJhdGUoc3JjLCBkZXN0LCBzcmNRdHksIGJsb2NrLm51bWJlcik7CgogICAgICAgICAgICBpZiAocmF0ZXNbaV0gPiBiZXN0UmF0ZSkgewogICAgICAgICAgICAgICAgLy9iZXN0IHJhdGUgaXMgaGlnaGVzdCByYXRlCiAgICAgICAgICAgICAgICBiZXN0UmF0ZSA9IHJhdGVzW2ldOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoYmVzdFJhdGUgPiAwKSB7CiAgICAgICAgICAgIHVpbnQgcmFuZG9tID0gMDsKICAgICAgICAgICAgdWludCBzbWFsbGVzdFJlbGV2YW50UmF0ZSA9IChiZXN0UmF0ZSAqIDEwMDAwKSAvICgxMDAwMCArIG5lZ2xpZ2libGVSYXRlRGlmZik7CgogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbnVtUmVzZXJ2ZXM7IGkrKykgewogICAgICAgICAgICAgICAgaWYgKHJhdGVzW2ldID49IHNtYWxsZXN0UmVsZXZhbnRSYXRlKSB7CiAgICAgICAgICAgICAgICAgICAgcmVzZXJ2ZUNhbmRpZGF0ZXNbbnVtUmVsZXZhbnRSZXNlcnZlcysrXSA9IGk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChudW1SZWxldmFudFJlc2VydmVzID4gMSkgewogICAgICAgICAgICAgICAgLy93aGVuIGVuY291bnRlcmluZyBzbWFsbCByYXRlIGRpZmYgZnJvbSBiZXN0UmF0ZS4gZHJhdyBmcm9tIHJlbGV2YW50IHJlc2VydmVzCiAgICAgICAgICAgICAgICByYW5kb20gPSB1aW50KGJsb2NrLmJsb2NraGFzaChibG9jay5udW1iZXItMSkpICUgbnVtUmVsZXZhbnRSZXNlcnZlczsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgYmVzdFJlc2VydmUgPSByZXNlcnZlQ2FuZGlkYXRlc1tyYW5kb21dOwogICAgICAgICAgICBiZXN0UmF0ZSA9IHJhdGVzW2Jlc3RSZXNlcnZlXTsKICAgICAgICB9CgogICAgICAgIHJldHVybiAoYmVzdFJlc2VydmUsIGJlc3RSYXRlKTsKICAgIH0KICAgIC8qIHNvbGhpbnQtZW5hYmxlIGNvZGUtY29tcGxleGl0eSAqLwoKICAgIGZ1bmN0aW9uIGdldEV4cGVjdGVkUmF0ZShFUkMyMCBzcmMsIEVSQzIwIGRlc3QsIHVpbnQgc3JjUXR5KQogICAgICAgIHB1YmxpYyB2aWV3CiAgICAgICAgcmV0dXJucyAodWludCBleHBlY3RlZFJhdGUsIHVpbnQgc2xpcHBhZ2VSYXRlKQogICAgewogICAgICAgIHJlcXVpcmUoZXhwZWN0ZWRSYXRlQ29udHJhY3QgIT0gYWRkcmVzcygwKSk7CiAgICAgICAgcmV0dXJuIGV4cGVjdGVkUmF0ZUNvbnRyYWN0LmdldEV4cGVjdGVkUmF0ZShzcmMsIGRlc3QsIHNyY1F0eSk7CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0VXNlckNhcEluV2VpKGFkZHJlc3MgdXNlcikgcHVibGljIHZpZXcgcmV0dXJucyh1aW50KSB7CiAgICAgICAgcmV0dXJuIHdoaXRlTGlzdENvbnRyYWN0LmdldFVzZXJDYXBJbldlaSh1c2VyKTsKICAgIH0KCiAgICBmdW5jdGlvbiBkb1RyYWRlKAogICAgICAgIEVSQzIwIHNyYywKICAgICAgICB1aW50IHNyY0Ftb3VudCwKICAgICAgICBFUkMyMCBkZXN0LAogICAgICAgIGFkZHJlc3MgZGVzdEFkZHJlc3MsCiAgICAgICAgdWludCBtYXhEZXN0QW1vdW50LAogICAgICAgIHVpbnQgbWluQ29udmVyc2lvblJhdGUsCiAgICAgICAgYWRkcmVzcyB3YWxsZXRJZAogICAgKQogICAgICAgIGludGVybmFsCiAgICAgICAgcmV0dXJucyh1aW50KQogICAgewogICAgICAgIHJlcXVpcmUodHguZ2FzcHJpY2UgPD0gbWF4R2FzUHJpY2UpOwogICAgICAgIHJlcXVpcmUodmFsaWRhdGVUcmFkZUlucHV0KHNyYywgc3JjQW1vdW50LCBkZXN0QWRkcmVzcykpOwoKICAgICAgICB1aW50IHJlc2VydmVJbmQ7CiAgICAgICAgdWludCByYXRlOwoKICAgICAgICAocmVzZXJ2ZUluZCwgcmF0ZSkgPSBmaW5kQmVzdFJhdGUoc3JjLCBkZXN0LCBzcmNBbW91bnQpOwogICAgICAgIEt5YmVyUmVzZXJ2ZSB0aGVSZXNlcnZlID0gcmVzZXJ2ZXNbcmVzZXJ2ZUluZF07CiAgICAgICAgcmVxdWlyZShyYXRlID4gMCk7CiAgICAgICAgcmVxdWlyZShyYXRlIDwgTUFYX1JBVEUpOwogICAgICAgIHJlcXVpcmUocmF0ZSA+PSBtaW5Db252ZXJzaW9uUmF0ZSk7CgogICAgICAgIHVpbnQgYWN0dWFsU3JjQW1vdW50ID0gc3JjQW1vdW50OwogICAgICAgIHVpbnQgYWN0dWFsRGVzdEFtb3VudCA9IGNhbGNEZXN0QW1vdW50KHNyYywgZGVzdCwgYWN0dWFsU3JjQW1vdW50LCByYXRlKTsKICAgICAgICBpZiAoYWN0dWFsRGVzdEFtb3VudCA+IG1heERlc3RBbW91bnQpIHsKICAgICAgICAgICAgYWN0dWFsRGVzdEFtb3VudCA9IG1heERlc3RBbW91bnQ7CiAgICAgICAgICAgIGFjdHVhbFNyY0Ftb3VudCA9IGNhbGNTcmNBbW91bnQoc3JjLCBkZXN0LCBhY3R1YWxEZXN0QW1vdW50LCByYXRlKTsKICAgICAgICAgICAgcmVxdWlyZShhY3R1YWxTcmNBbW91bnQgPD0gc3JjQW1vdW50KTsKICAgICAgICB9CgogICAgICAgIC8vIGRvIHRoZSB0cmFkZQogICAgICAgIC8vIHZlcmlmeSB0cmFkZSBzaXplIGlzIHNtYWxsZXIgdGhhbiB1c2VyIGNhcAogICAgICAgIHVpbnQgZXRoQW1vdW50OwogICAgICAgIGlmIChzcmMgPT0gRVRIX1RPS0VOX0FERFJFU1MpIHsKICAgICAgICAgICAgZXRoQW1vdW50ID0gYWN0dWFsU3JjQW1vdW50OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGV0aEFtb3VudCA9IGFjdHVhbERlc3RBbW91bnQ7CiAgICAgICAgfQoKICAgICAgICByZXF1aXJlKGV0aEFtb3VudCA8PSBnZXRVc2VyQ2FwSW5XZWkobXNnLnNlbmRlcikpOwogICAgICAgIHJlcXVpcmUoZG9SZXNlcnZlVHJhZGUoCiAgICAgICAgICAgICAgICBzcmMsCiAgICAgICAgICAgICAgICBhY3R1YWxTcmNBbW91bnQsCiAgICAgICAgICAgICAgICBkZXN0LAogICAgICAgICAgICAgICAgZGVzdEFkZHJlc3MsCiAgICAgICAgICAgICAgICBhY3R1YWxEZXN0QW1vdW50LAogICAgICAgICAgICAgICAgdGhlUmVzZXJ2ZSwKICAgICAgICAgICAgICAgIHJhdGUsCiAgICAgICAgICAgICAgICB0cnVlKSk7CgogICAgICAgIGlmICgoYWN0dWFsU3JjQW1vdW50IDwgc3JjQW1vdW50KSAmJiAoc3JjID09IEVUSF9UT0tFTl9BRERSRVNTKSkgewogICAgICAgICAgICBtc2cuc2VuZGVyLnRyYW5zZmVyKHNyY0Ftb3VudCAtIGFjdHVhbFNyY0Ftb3VudCk7CiAgICAgICAgfQoKICAgICAgICByZXF1aXJlKGZlZUJ1cm5lckNvbnRyYWN0LmhhbmRsZUZlZXMoZXRoQW1vdW50LCB0aGVSZXNlcnZlLCB3YWxsZXRJZCkpOwoKICAgICAgICBFeGVjdXRlVHJhZGUobXNnLnNlbmRlciwgc3JjLCBkZXN0LCBhY3R1YWxTcmNBbW91bnQsIGFjdHVhbERlc3RBbW91bnQpOwogICAgICAgIHJldHVybiBhY3R1YWxEZXN0QW1vdW50OwogICAgfQoKICAgIC8vLyBAbm90aWNlIHVzZSB0b2tlbiBhZGRyZXNzIEVUSF9UT0tFTl9BRERSRVNTIGZvciBldGhlcgogICAgLy8vIEBkZXYgZG8gb25lIHRyYWRlIHdpdGggYSByZXNlcnZlCiAgICAvLy8gQHBhcmFtIHNyYyBTcmMgdG9rZW4KICAgIC8vLyBAcGFyYW0gYW1vdW50IGFtb3VudCBvZiBzcmMgdG9rZW5zCiAgICAvLy8gQHBhcmFtIGRlc3QgICBEZXN0aW5hdGlvbiB0b2tlbgogICAgLy8vIEBwYXJhbSBkZXN0QWRkcmVzcyBBZGRyZXNzIHRvIHNlbmQgdG9rZW5zIHRvCiAgICAvLy8gQHBhcmFtIHJlc2VydmUgUmVzZXJ2ZSB0byB1c2UKICAgIC8vLyBAcGFyYW0gdmFsaWRhdGUgSWYgdHJ1ZSwgYWRkaXRpb25hbCB2YWxpZGF0aW9ucyBhcmUgYXBwbGljYWJsZQogICAgLy8vIEByZXR1cm4gdHJ1ZSBpZiB0cmFkZSBpcyBzdWNjZXNzZnVsCiAgICBmdW5jdGlvbiBkb1Jlc2VydmVUcmFkZSgKICAgICAgICBFUkMyMCBzcmMsCiAgICAgICAgdWludCBhbW91bnQsCiAgICAgICAgRVJDMjAgZGVzdCwKICAgICAgICBhZGRyZXNzIGRlc3RBZGRyZXNzLAogICAgICAgIHVpbnQgZXhwZWN0ZWREZXN0QW1vdW50LAogICAgICAgIEt5YmVyUmVzZXJ2ZSByZXNlcnZlLAogICAgICAgIHVpbnQgY29udmVyc2lvblJhdGUsCiAgICAgICAgYm9vbCB2YWxpZGF0ZQogICAgKQogICAgICAgIGludGVybmFsCiAgICAgICAgcmV0dXJucyhib29sKQogICAgewogICAgICAgIHVpbnQgY2FsbFZhbHVlID0gMDsKCiAgICAgICAgaWYgKHNyYyA9PSBFVEhfVE9LRU5fQUREUkVTUykgewogICAgICAgICAgICBjYWxsVmFsdWUgPSBhbW91bnQ7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gdGFrZSBzcmMgdG9rZW5zIHRvIHRoaXMgY29udHJhY3QKICAgICAgICAgICAgc3JjLnRyYW5zZmVyRnJvbShtc2cuc2VuZGVyLCB0aGlzLCBhbW91bnQpOwogICAgICAgIH0KCiAgICAgICAgLy8gcmVzZXJ2ZSBzZW5kcyB0b2tlbnMvZXRoIHRvIG5ldHdvcmsuIG5ldHdvcmsgc2VuZHMgaXQgdG8gZGVzdGluYXRpb24KICAgICAgICByZXF1aXJlKHJlc2VydmUudHJhZGUudmFsdWUoY2FsbFZhbHVlKShzcmMsIGFtb3VudCwgZGVzdCwgdGhpcywgY29udmVyc2lvblJhdGUsIHZhbGlkYXRlKSk7CgogICAgICAgIGlmIChkZXN0ID09IEVUSF9UT0tFTl9BRERSRVNTKSB7CiAgICAgICAgICAgIGRlc3RBZGRyZXNzLnRyYW5zZmVyKGV4cGVjdGVkRGVzdEFtb3VudCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVxdWlyZShkZXN0LnRyYW5zZmVyKGRlc3RBZGRyZXNzLCBleHBlY3RlZERlc3RBbW91bnQpKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIGZ1bmN0aW9uIGdldERlY2ltYWxzKEVSQzIwIHRva2VuKSBpbnRlcm5hbCB2aWV3IHJldHVybnModWludCkgewogICAgICAgIGlmICh0b2tlbiA9PSBFVEhfVE9LRU5fQUREUkVTUykgcmV0dXJuIDE4OwogICAgICAgIHJldHVybiB0b2tlbi5kZWNpbWFscygpOwogICAgfQoKICAgIGZ1bmN0aW9uIGNhbGNEZXN0QW1vdW50KEVSQzIwIHNyYywgRVJDMjAgZGVzdCwgdWludCBzcmNBbW91bnQsIHVpbnQgcmF0ZSkgaW50ZXJuYWwgdmlldyByZXR1cm5zKHVpbnQpIHsKICAgICAgICByZXR1cm4gY2FsY0RzdFF0eShzcmNBbW91bnQsIGdldERlY2ltYWxzKHNyYyksIGdldERlY2ltYWxzKGRlc3QpLCByYXRlKTsKICAgIH0KCiAgICBmdW5jdGlvbiBjYWxjU3JjQW1vdW50KEVSQzIwIHNyYywgRVJDMjAgZGVzdCwgdWludCBkZXN0QW1vdW50LCB1aW50IHJhdGUpIGludGVybmFsIHZpZXcgcmV0dXJucyh1aW50KSB7CiAgICAgICAgcmV0dXJuIGNhbGNTcmNRdHkoZGVzdEFtb3VudCwgZ2V0RGVjaW1hbHMoc3JjKSwgZ2V0RGVjaW1hbHMoZGVzdCksIHJhdGUpOwogICAgfQoKICAgIC8vLyBAbm90aWNlIHVzZSB0b2tlbiBhZGRyZXNzIEVUSF9UT0tFTl9BRERSRVNTIGZvciBldGhlcgogICAgLy8vIEBkZXYgY2hlY2tzIHRoYXQgdXNlciBzZW50IGV0aGVyL3Rva2VucyB0byBjb250cmFjdCBiZWZvcmUgdHJhZGUKICAgIC8vLyBAcGFyYW0gc3JjIFNyYyB0b2tlbgogICAgLy8vIEBwYXJhbSBzcmNBbW91bnQgYW1vdW50IG9mIHNyYyB0b2tlbnMKICAgIC8vLyBAcmV0dXJuIHRydWUgaWYgaW5wdXQgaXMgdmFsaWQKICAgIGZ1bmN0aW9uIHZhbGlkYXRlVHJhZGVJbnB1dChFUkMyMCBzcmMsIHVpbnQgc3JjQW1vdW50LCBhZGRyZXNzIGRlc3RBZGRyZXNzKSBpbnRlcm5hbCB2aWV3IHJldHVybnMoYm9vbCkgewogICAgICAgIGlmICgoc3JjQW1vdW50ID49IE1BWF9RVFkpIHx8IChzcmNBbW91bnQgPT0gMCkgfHwgKGRlc3RBZGRyZXNzID09IDApKQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CgogICAgICAgIGlmIChzcmMgPT0gRVRIX1RPS0VOX0FERFJFU1MpIHsKICAgICAgICAgICAgaWYgKG1zZy52YWx1ZSAhPSBzcmNBbW91bnQpCiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKChtc2cudmFsdWUgIT0gMCkgfHwgKHNyYy5hbGxvd2FuY2UobXNnLnNlbmRlciwgdGhpcykgPCBzcmNBbW91bnQpKQogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9Cn0KCmNvbnRyYWN0IEt5YmVyUmVzZXJ2ZSBpcyBXaXRoZHJhd2FibGUsIFV0aWxzIHsKCiAgICBhZGRyZXNzIHB1YmxpYyBreWJlck5ldHdvcms7CiAgICBib29sIHB1YmxpYyB0cmFkZUVuYWJsZWQ7CiAgICBDb252ZXJzaW9uUmF0ZXMgcHVibGljIGNvbnZlcnNpb25SYXRlc0NvbnRyYWN0OwogICAgU2FuaXR5UmF0ZXNJbnRlcmZhY2UgcHVibGljIHNhbml0eVJhdGVzQ29udHJhY3Q7CiAgICBtYXBwaW5nKGJ5dGVzMzI9PmJvb2wpIHB1YmxpYyBhcHByb3ZlZFdpdGhkcmF3QWRkcmVzc2VzOyAvLyBzaGEzKHRva2VuLGFkZHJlc3MpPT5ib29sCgogICAgZnVuY3Rpb24gS3liZXJSZXNlcnZlKGFkZHJlc3MgX2t5YmVyTmV0d29yaywgQ29udmVyc2lvblJhdGVzIF9yYXRlc0NvbnRyYWN0LCBhZGRyZXNzIF9hZG1pbikgcHVibGljIHsKICAgICAgICByZXF1aXJlKF9hZG1pbiAhPSBhZGRyZXNzKDApKTsKICAgICAgICByZXF1aXJlKF9yYXRlc0NvbnRyYWN0ICE9IGFkZHJlc3MoMCkpOwogICAgICAgIHJlcXVpcmUoX2t5YmVyTmV0d29yayAhPSBhZGRyZXNzKDApKTsKICAgICAgICBreWJlck5ldHdvcmsgPSBfa3liZXJOZXR3b3JrOwogICAgICAgIGNvbnZlcnNpb25SYXRlc0NvbnRyYWN0ID0gX3JhdGVzQ29udHJhY3Q7CiAgICAgICAgYWRtaW4gPSBfYWRtaW47CiAgICAgICAgdHJhZGVFbmFibGVkID0gdHJ1ZTsKICAgIH0KCiAgICBldmVudCBEZXBvc2l0VG9rZW4oRVJDMjAgdG9rZW4sIHVpbnQgYW1vdW50KTsKCiAgICBmdW5jdGlvbigpIHB1YmxpYyBwYXlhYmxlIHsKICAgICAgICBEZXBvc2l0VG9rZW4oRVRIX1RPS0VOX0FERFJFU1MsIG1zZy52YWx1ZSk7CiAgICB9CgogICAgZXZlbnQgVHJhZGVFeGVjdXRlKAogICAgICAgIGFkZHJlc3MgaW5kZXhlZCBvcmlnaW4sCiAgICAgICAgYWRkcmVzcyBzcmMsCiAgICAgICAgdWludCBzcmNBbW91bnQsCiAgICAgICAgYWRkcmVzcyBkZXN0VG9rZW4sCiAgICAgICAgdWludCBkZXN0QW1vdW50LAogICAgICAgIGFkZHJlc3MgZGVzdEFkZHJlc3MKICAgICk7CgogICAgZnVuY3Rpb24gdHJhZGUoCiAgICAgICAgRVJDMjAgc3JjVG9rZW4sCiAgICAgICAgdWludCBzcmNBbW91bnQsCiAgICAgICAgRVJDMjAgZGVzdFRva2VuLAogICAgICAgIGFkZHJlc3MgZGVzdEFkZHJlc3MsCiAgICAgICAgdWludCBjb252ZXJzaW9uUmF0ZSwKICAgICAgICBib29sIHZhbGlkYXRlCiAgICApCiAgICAgICAgcHVibGljCiAgICAgICAgcGF5YWJsZQogICAgICAgIHJldHVybnMoYm9vbCkKICAgIHsKICAgICAgICByZXF1aXJlKHRyYWRlRW5hYmxlZCk7CiAgICAgICAgcmVxdWlyZShtc2cuc2VuZGVyID09IGt5YmVyTmV0d29yayk7CgogICAgICAgIHJlcXVpcmUoZG9UcmFkZShzcmNUb2tlbiwgc3JjQW1vdW50LCBkZXN0VG9rZW4sIGRlc3RBZGRyZXNzLCBjb252ZXJzaW9uUmF0ZSwgdmFsaWRhdGUpKTsKCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgZXZlbnQgVHJhZGVFbmFibGVkKGJvb2wgZW5hYmxlKTsKCiAgICBmdW5jdGlvbiBlbmFibGVUcmFkZSgpIHB1YmxpYyBvbmx5QWRtaW4gcmV0dXJucyhib29sKSB7CiAgICAgICAgdHJhZGVFbmFibGVkID0gdHJ1ZTsKICAgICAgICBUcmFkZUVuYWJsZWQodHJ1ZSk7CgogICAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIGZ1bmN0aW9uIGRpc2FibGVUcmFkZSgpIHB1YmxpYyBvbmx5QWxlcnRlciByZXR1cm5zKGJvb2wpIHsKICAgICAgICB0cmFkZUVuYWJsZWQgPSBmYWxzZTsKICAgICAgICBUcmFkZUVuYWJsZWQoZmFsc2UpOwoKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICBldmVudCBXaXRoZHJhd0FkZHJlc3NBcHByb3ZlZChFUkMyMCB0b2tlbiwgYWRkcmVzcyBhZGRyLCBib29sIGFwcHJvdmUpOwoKICAgIGZ1bmN0aW9uIGFwcHJvdmVXaXRoZHJhd0FkZHJlc3MoRVJDMjAgdG9rZW4sIGFkZHJlc3MgYWRkciwgYm9vbCBhcHByb3ZlKSBwdWJsaWMgb25seUFkbWluIHsKICAgICAgICBhcHByb3ZlZFdpdGhkcmF3QWRkcmVzc2VzW2tlY2NhazI1Nih0b2tlbiwgYWRkcildID0gYXBwcm92ZTsKICAgICAgICBXaXRoZHJhd0FkZHJlc3NBcHByb3ZlZCh0b2tlbiwgYWRkciwgYXBwcm92ZSk7CiAgICB9CgogICAgZXZlbnQgV2l0aGRyYXdGdW5kcyhFUkMyMCB0b2tlbiwgdWludCBhbW91bnQsIGFkZHJlc3MgZGVzdGluYXRpb24pOwoKICAgIGZ1bmN0aW9uIHdpdGhkcmF3KEVSQzIwIHRva2VuLCB1aW50IGFtb3VudCwgYWRkcmVzcyBkZXN0aW5hdGlvbikgcHVibGljIG9ubHlPcGVyYXRvciByZXR1cm5zKGJvb2wpIHsKICAgICAgICByZXF1aXJlKGFwcHJvdmVkV2l0aGRyYXdBZGRyZXNzZXNba2VjY2FrMjU2KHRva2VuLCBkZXN0aW5hdGlvbildKTsKCiAgICAgICAgaWYgKHRva2VuID09IEVUSF9UT0tFTl9BRERSRVNTKSB7CiAgICAgICAgICAgIGRlc3RpbmF0aW9uLnRyYW5zZmVyKGFtb3VudCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVxdWlyZSh0b2tlbi50cmFuc2ZlcihkZXN0aW5hdGlvbiwgYW1vdW50KSk7CiAgICAgICAgfQoKICAgICAgICBXaXRoZHJhd0Z1bmRzKHRva2VuLCBhbW91bnQsIGRlc3RpbmF0aW9uKTsKCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgZXZlbnQgU2V0Q29udHJhY3RBZGRyZXNzZXMoYWRkcmVzcyBuZXR3b3JrLCBhZGRyZXNzIHJhdGUsIGFkZHJlc3Mgc2FuaXR5KTsKCiAgICBmdW5jdGlvbiBzZXRDb250cmFjdHMoYWRkcmVzcyBfa3liZXJOZXR3b3JrLCBDb252ZXJzaW9uUmF0ZXMgX2NvbnZlcnNpb25SYXRlcywgU2FuaXR5UmF0ZXNJbnRlcmZhY2UgX3Nhbml0eVJhdGVzKQogICAgICAgIHB1YmxpYwogICAgICAgIG9ubHlBZG1pbgogICAgewogICAgICAgIHJlcXVpcmUoX2t5YmVyTmV0d29yayAhPSBhZGRyZXNzKDApKTsKICAgICAgICByZXF1aXJlKF9jb252ZXJzaW9uUmF0ZXMgIT0gYWRkcmVzcygwKSk7CgogICAgICAgIGt5YmVyTmV0d29yayA9IF9reWJlck5ldHdvcms7CiAgICAgICAgY29udmVyc2lvblJhdGVzQ29udHJhY3QgPSBfY29udmVyc2lvblJhdGVzOwogICAgICAgIHNhbml0eVJhdGVzQ29udHJhY3QgPSBfc2FuaXR5UmF0ZXM7CgogICAgICAgIFNldENvbnRyYWN0QWRkcmVzc2VzKGt5YmVyTmV0d29yaywgY29udmVyc2lvblJhdGVzQ29udHJhY3QsIHNhbml0eVJhdGVzQ29udHJhY3QpOwogICAgfQoKICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgIC8vLyBzdGF0dXMgZnVuY3Rpb25zIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgIGZ1bmN0aW9uIGdldEJhbGFuY2UoRVJDMjAgdG9rZW4pIHB1YmxpYyB2aWV3IHJldHVybnModWludCkgewogICAgICAgIGlmICh0b2tlbiA9PSBFVEhfVE9LRU5fQUREUkVTUykKICAgICAgICAgICAgcmV0dXJuIHRoaXMuYmFsYW5jZTsKICAgICAgICBlbHNlCiAgICAgICAgICAgIHJldHVybiB0b2tlbi5iYWxhbmNlT2YodGhpcyk7CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0RGVjaW1hbHMoRVJDMjAgdG9rZW4pIHB1YmxpYyB2aWV3IHJldHVybnModWludCkgewogICAgICAgIGlmICh0b2tlbiA9PSBFVEhfVE9LRU5fQUREUkVTUykgcmV0dXJuIDE4OwogICAgICAgIHJldHVybiB0b2tlbi5kZWNpbWFscygpOwogICAgfQoKICAgIGZ1bmN0aW9uIGdldERlc3RRdHkoRVJDMjAgc3JjLCBFUkMyMCBkZXN0LCB1aW50IHNyY1F0eSwgdWludCByYXRlKSBwdWJsaWMgdmlldyByZXR1cm5zKHVpbnQpIHsKICAgICAgICB1aW50IGRzdERlY2ltYWxzID0gZ2V0RGVjaW1hbHMoZGVzdCk7CiAgICAgICAgdWludCBzcmNEZWNpbWFscyA9IGdldERlY2ltYWxzKHNyYyk7CgogICAgICAgIHJldHVybiBjYWxjRHN0UXR5KHNyY1F0eSwgc3JjRGVjaW1hbHMsIGRzdERlY2ltYWxzLCByYXRlKTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRTcmNRdHkoRVJDMjAgc3JjLCBFUkMyMCBkZXN0LCB1aW50IGRzdFF0eSwgdWludCByYXRlKSBwdWJsaWMgdmlldyByZXR1cm5zKHVpbnQpIHsKICAgICAgICB1aW50IGRzdERlY2ltYWxzID0gZ2V0RGVjaW1hbHMoZGVzdCk7CiAgICAgICAgdWludCBzcmNEZWNpbWFscyA9IGdldERlY2ltYWxzKHNyYyk7CgogICAgICAgIHJldHVybiBjYWxjU3JjUXR5KGRzdFF0eSwgc3JjRGVjaW1hbHMsIGRzdERlY2ltYWxzLCByYXRlKTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRDb252ZXJzaW9uUmF0ZShFUkMyMCBzcmMsIEVSQzIwIGRlc3QsIHVpbnQgc3JjUXR5LCB1aW50IGJsb2NrTnVtYmVyKSBwdWJsaWMgdmlldyByZXR1cm5zKHVpbnQpIHsKICAgICAgICBFUkMyMCB0b2tlbjsKICAgICAgICBib29sICBidXk7CgogICAgICAgIGlmICghdHJhZGVFbmFibGVkKSByZXR1cm4gMDsKCiAgICAgICAgaWYgKEVUSF9UT0tFTl9BRERSRVNTID09IHNyYykgewogICAgICAgICAgICBidXkgPSB0cnVlOwogICAgICAgICAgICB0b2tlbiA9IGRlc3Q7CiAgICAgICAgfSBlbHNlIGlmIChFVEhfVE9LRU5fQUREUkVTUyA9PSBkZXN0KSB7CiAgICAgICAgICAgIGJ1eSA9IGZhbHNlOwogICAgICAgICAgICB0b2tlbiA9IHNyYzsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gMDsgLy8gcGFpciBpcyBub3QgbGlzdGVkCiAgICAgICAgfQoKICAgICAgICB1aW50IHJhdGUgPSBjb252ZXJzaW9uUmF0ZXNDb250cmFjdC5nZXRSYXRlKHRva2VuLCBibG9ja051bWJlciwgYnV5LCBzcmNRdHkpOwogICAgICAgIHVpbnQgZGVzdFF0eSA9IGdldERlc3RRdHkoc3JjLCBkZXN0LCBzcmNRdHksIHJhdGUpOwoKICAgICAgICBpZiAoZ2V0QmFsYW5jZShkZXN0KSA8IGRlc3RRdHkpIHJldHVybiAwOwoKICAgICAgICBpZiAoc2FuaXR5UmF0ZXNDb250cmFjdCAhPSBhZGRyZXNzKDApKSB7CiAgICAgICAgICAgIHVpbnQgc2FuaXR5UmF0ZSA9IHNhbml0eVJhdGVzQ29udHJhY3QuZ2V0U2FuaXR5UmF0ZShzcmMsIGRlc3QpOwogICAgICAgICAgICBpZiAocmF0ZSA+IHNhbml0eVJhdGUpIHJldHVybiAwOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHJhdGU7CiAgICB9CgogICAgLy8vIEBkZXYgZG8gYSB0cmFkZQogICAgLy8vIEBwYXJhbSBzcmNUb2tlbiBTcmMgdG9rZW4KICAgIC8vLyBAcGFyYW0gc3JjQW1vdW50IEFtb3VudCBvZiBzcmMgdG9rZW4KICAgIC8vLyBAcGFyYW0gZGVzdFRva2VuIERlc3RpbmF0aW9uIHRva2VuCiAgICAvLy8gQHBhcmFtIGRlc3RBZGRyZXNzIERlc3RpbmF0aW9uIGFkZHJlc3MgdG8gc2VuZCB0b2tlbnMgdG8KICAgIC8vLyBAcGFyYW0gdmFsaWRhdGUgSWYgdHJ1ZSwgYWRkaXRpb25hbCB2YWxpZGF0aW9ucyBhcmUgYXBwbGljYWJsZQogICAgLy8vIEByZXR1cm4gdHJ1ZSBpZmYgdHJhZGUgaXMgc3VjY2Vzc2Z1bAogICAgZnVuY3Rpb24gZG9UcmFkZSgKICAgICAgICBFUkMyMCBzcmNUb2tlbiwKICAgICAgICB1aW50IHNyY0Ftb3VudCwKICAgICAgICBFUkMyMCBkZXN0VG9rZW4sCiAgICAgICAgYWRkcmVzcyBkZXN0QWRkcmVzcywKICAgICAgICB1aW50IGNvbnZlcnNpb25SYXRlLAogICAgICAgIGJvb2wgdmFsaWRhdGUKICAgICkKICAgICAgICBpbnRlcm5hbAogICAgICAgIHJldHVybnMoYm9vbCkKICAgIHsKICAgICAgICAvLyBjYW4gc2tpcCB2YWxpZGF0aW9uIGlmIGRvbmUgYXQga3liZXIgbmV0d29yayBsZXZlbAogICAgICAgIGlmICh2YWxpZGF0ZSkgewogICAgICAgICAgICByZXF1aXJlKGNvbnZlcnNpb25SYXRlID4gMCk7CiAgICAgICAgICAgIGlmIChzcmNUb2tlbiA9PSBFVEhfVE9LRU5fQUREUkVTUykKICAgICAgICAgICAgICAgIHJlcXVpcmUobXNnLnZhbHVlID09IHNyY0Ftb3VudCk7CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHJlcXVpcmUobXNnLnZhbHVlID09IDApOwogICAgICAgIH0KCiAgICAgICAgdWludCBkZXN0QW1vdW50ID0gZ2V0RGVzdFF0eShzcmNUb2tlbiwgZGVzdFRva2VuLCBzcmNBbW91bnQsIGNvbnZlcnNpb25SYXRlKTsKICAgICAgICAvLyBzYW5pdHkgY2hlY2sKICAgICAgICByZXF1aXJlKGRlc3RBbW91bnQgPiAwKTsKCiAgICAgICAgLy8gYWRkIHRvIGltYmFsYW5jZQogICAgICAgIEVSQzIwIHRva2VuOwogICAgICAgIGludCBidXk7CiAgICAgICAgaWYgKHNyY1Rva2VuID09IEVUSF9UT0tFTl9BRERSRVNTKSB7CiAgICAgICAgICAgIGJ1eSA9IGludChkZXN0QW1vdW50KTsKICAgICAgICAgICAgdG9rZW4gPSBkZXN0VG9rZW47CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgYnV5ID0gLTEgKiBpbnQoc3JjQW1vdW50KTsKICAgICAgICAgICAgdG9rZW4gPSBzcmNUb2tlbjsKICAgICAgICB9CgogICAgICAgIGNvbnZlcnNpb25SYXRlc0NvbnRyYWN0LnJlY29yZEltYmFsYW5jZSgKICAgICAgICAgICAgdG9rZW4sCiAgICAgICAgICAgIGJ1eSwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgYmxvY2subnVtYmVyCiAgICAgICAgKTsKCiAgICAgICAgLy8gY29sbGVjdCBzcmMgdG9rZW5zCiAgICAgICAgaWYgKHNyY1Rva2VuICE9IEVUSF9UT0tFTl9BRERSRVNTKSB7CiAgICAgICAgICAgIHJlcXVpcmUoc3JjVG9rZW4udHJhbnNmZXJGcm9tKG1zZy5zZW5kZXIsIHRoaXMsIHNyY0Ftb3VudCkpOwogICAgICAgIH0KCiAgICAgICAgLy8gc2VuZCBkZXN0IHRva2VucwogICAgICAgIGlmIChkZXN0VG9rZW4gPT0gRVRIX1RPS0VOX0FERFJFU1MpIHsKICAgICAgICAgICAgZGVzdEFkZHJlc3MudHJhbnNmZXIoZGVzdEFtb3VudCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVxdWlyZShkZXN0VG9rZW4udHJhbnNmZXIoZGVzdEFkZHJlc3MsIGRlc3RBbW91bnQpKTsKICAgICAgICB9CgogICAgICAgIFRyYWRlRXhlY3V0ZShtc2cuc2VuZGVyLCBzcmNUb2tlbiwgc3JjQW1vdW50LCBkZXN0VG9rZW4sIGRlc3RBbW91bnQsIGRlc3RBZGRyZXNzKTsKCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9Cn0KCmNvbnRyYWN0IFZvbHVtZUltYmFsYW5jZVJlY29yZGVyIGlzIFdpdGhkcmF3YWJsZSB7CgogICAgdWludCBjb25zdGFudCBpbnRlcm5hbCBTTElESU5HX1dJTkRPV19TSVpFID0gNTsKICAgIHVpbnQgY29uc3RhbnQgaW50ZXJuYWwgUE9XXzJfNjQgPSAyICoqIDY0OwoKICAgIHN0cnVjdCBUb2tlbkNvbnRyb2xJbmZvIHsKICAgICAgICB1aW50IG1pbmltYWxSZWNvcmRSZXNvbHV0aW9uOyAvLyBjYW4gYmUgcm91Z2hseSAxIGNlbnQKICAgICAgICB1aW50IG1heFBlckJsb2NrSW1iYWxhbmNlOyAvLyBpbiB0d2VpIHJlc29sdXRpb24KICAgICAgICB1aW50IG1heFRvdGFsSW1iYWxhbmNlOyAvLyBtYXggdG90YWwgaW1iYWxhbmNlIChiZXR3ZWVuIHJhdGUgdXBkYXRlcykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGJlZm9yZSBoYWx0aW5nIHRyYWRlCiAgICB9CgogICAgbWFwcGluZyhhZGRyZXNzID0+IFRva2VuQ29udHJvbEluZm8pIGludGVybmFsIHRva2VuQ29udHJvbEluZm87CgogICAgc3RydWN0IFRva2VuSW1iYWxhbmNlRGF0YSB7CiAgICAgICAgaW50ICBsYXN0QmxvY2tCdXlVbml0c0ltYmFsYW5jZTsKICAgICAgICB1aW50IGxhc3RCbG9jazsKCiAgICAgICAgaW50ICB0b3RhbEJ1eVVuaXRzSW1iYWxhbmNlOwogICAgICAgIHVpbnQgbGFzdFJhdGVVcGRhdGVCbG9jazsKICAgIH0KCiAgICBtYXBwaW5nKGFkZHJlc3MgPT4gbWFwcGluZyh1aW50PT51aW50KSkgcHVibGljIHRva2VuSW1iYWxhbmNlRGF0YTsKCiAgICBmdW5jdGlvbiBWb2x1bWVJbWJhbGFuY2VSZWNvcmRlcihhZGRyZXNzIF9hZG1pbikgcHVibGljIHsKICAgICAgICByZXF1aXJlKF9hZG1pbiAhPSBhZGRyZXNzKDApKTsKICAgICAgICBhZG1pbiA9IF9hZG1pbjsKICAgIH0KCiAgICBmdW5jdGlvbiBzZXRUb2tlbkNvbnRyb2xJbmZvKAogICAgICAgIEVSQzIwIHRva2VuLAogICAgICAgIHVpbnQgbWluaW1hbFJlY29yZFJlc29sdXRpb24sCiAgICAgICAgdWludCBtYXhQZXJCbG9ja0ltYmFsYW5jZSwKICAgICAgICB1aW50IG1heFRvdGFsSW1iYWxhbmNlCiAgICApCiAgICAgICAgcHVibGljCiAgICAgICAgb25seUFkbWluCiAgICB7CiAgICAgICAgdG9rZW5Db250cm9sSW5mb1t0b2tlbl0gPQogICAgICAgICAgICBUb2tlbkNvbnRyb2xJbmZvKAogICAgICAgICAgICAgICAgbWluaW1hbFJlY29yZFJlc29sdXRpb24sCiAgICAgICAgICAgICAgICBtYXhQZXJCbG9ja0ltYmFsYW5jZSwKICAgICAgICAgICAgICAgIG1heFRvdGFsSW1iYWxhbmNlCiAgICAgICAgICAgICk7CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0VG9rZW5Db250cm9sSW5mbyhFUkMyMCB0b2tlbikgcHVibGljIHZpZXcgcmV0dXJucyh1aW50LCB1aW50LCB1aW50KSB7CiAgICAgICAgcmV0dXJuICh0b2tlbkNvbnRyb2xJbmZvW3Rva2VuXS5taW5pbWFsUmVjb3JkUmVzb2x1dGlvbiwKICAgICAgICAgICAgICAgIHRva2VuQ29udHJvbEluZm9bdG9rZW5dLm1heFBlckJsb2NrSW1iYWxhbmNlLAogICAgICAgICAgICAgICAgdG9rZW5Db250cm9sSW5mb1t0b2tlbl0ubWF4VG90YWxJbWJhbGFuY2UpOwogICAgfQoKICAgIGZ1bmN0aW9uIGFkZEltYmFsYW5jZSgKICAgICAgICBFUkMyMCB0b2tlbiwKICAgICAgICBpbnQgYnV5QW1vdW50LAogICAgICAgIHVpbnQgcmF0ZVVwZGF0ZUJsb2NrLAogICAgICAgIHVpbnQgY3VycmVudEJsb2NrCiAgICApCiAgICAgICAgaW50ZXJuYWwKICAgIHsKICAgICAgICB1aW50IGN1cnJlbnRCbG9ja0luZGV4ID0gY3VycmVudEJsb2NrICUgU0xJRElOR19XSU5ET1dfU0laRTsKICAgICAgICBpbnQgcmVjb3JkZWRCdXlBbW91bnQgPSBpbnQoYnV5QW1vdW50IC8gaW50KHRva2VuQ29udHJvbEluZm9bdG9rZW5dLm1pbmltYWxSZWNvcmRSZXNvbHV0aW9uKSk7CgogICAgICAgIGludCBwcmV2SW1iYWxhbmNlID0gMDsKCiAgICAgICAgVG9rZW5JbWJhbGFuY2VEYXRhIG1lbW9yeSBjdXJyZW50QmxvY2tEYXRhID0KICAgICAgICAgICAgZGVjb2RlVG9rZW5JbWJhbGFuY2VEYXRhKHRva2VuSW1iYWxhbmNlRGF0YVt0b2tlbl1bY3VycmVudEJsb2NrSW5kZXhdKTsKCiAgICAgICAgLy8gZmlyc3Qgc2NlbmFyaW8gLSB0aGlzIGlzIG5vdCB0aGUgZmlyc3QgdHggaW4gdGhlIGN1cnJlbnQgYmxvY2sKICAgICAgICBpZiAoY3VycmVudEJsb2NrRGF0YS5sYXN0QmxvY2sgPT0gY3VycmVudEJsb2NrKSB7CiAgICAgICAgICAgIGlmICh1aW50KGN1cnJlbnRCbG9ja0RhdGEubGFzdFJhdGVVcGRhdGVCbG9jaykgPT0gcmF0ZVVwZGF0ZUJsb2NrKSB7CiAgICAgICAgICAgICAgICAvLyBqdXN0IGluY3JlYXNlIGltYmFsYW5jZQogICAgICAgICAgICAgICAgY3VycmVudEJsb2NrRGF0YS5sYXN0QmxvY2tCdXlVbml0c0ltYmFsYW5jZSArPSByZWNvcmRlZEJ1eUFtb3VudDsKICAgICAgICAgICAgICAgIGN1cnJlbnRCbG9ja0RhdGEudG90YWxCdXlVbml0c0ltYmFsYW5jZSArPSByZWNvcmRlZEJ1eUFtb3VudDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIGltYmFsYW5jZSB3YXMgY2hhbmdlZCBpbiB0aGUgbWlkZGxlIG9mIHRoZSBibG9jawogICAgICAgICAgICAgICAgcHJldkltYmFsYW5jZSA9IGdldEltYmFsYW5jZUluUmFuZ2UodG9rZW4sIHJhdGVVcGRhdGVCbG9jaywgY3VycmVudEJsb2NrKTsKICAgICAgICAgICAgICAgIGN1cnJlbnRCbG9ja0RhdGEudG90YWxCdXlVbml0c0ltYmFsYW5jZSA9IGludChwcmV2SW1iYWxhbmNlKSArIHJlY29yZGVkQnV5QW1vdW50OwogICAgICAgICAgICAgICAgY3VycmVudEJsb2NrRGF0YS5sYXN0QmxvY2tCdXlVbml0c0ltYmFsYW5jZSArPSByZWNvcmRlZEJ1eUFtb3VudDsKICAgICAgICAgICAgICAgIGN1cnJlbnRCbG9ja0RhdGEubGFzdFJhdGVVcGRhdGVCbG9jayA9IHVpbnQocmF0ZVVwZGF0ZUJsb2NrKTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIGZpcnN0IHR4IGluIHRoZSBjdXJyZW50IGJsb2NrCiAgICAgICAgICAgIGludCBjdXJyZW50QmxvY2tJbWJhbGFuY2U7CiAgICAgICAgICAgIChwcmV2SW1iYWxhbmNlLCBjdXJyZW50QmxvY2tJbWJhbGFuY2UpID0gZ2V0SW1iYWxhbmNlU2luY2VSYXRlVXBkYXRlKHRva2VuLCByYXRlVXBkYXRlQmxvY2ssIGN1cnJlbnRCbG9jayk7CgogICAgICAgICAgICBjdXJyZW50QmxvY2tEYXRhLmxhc3RCbG9ja0J1eVVuaXRzSW1iYWxhbmNlID0gcmVjb3JkZWRCdXlBbW91bnQ7CiAgICAgICAgICAgIGN1cnJlbnRCbG9ja0RhdGEubGFzdEJsb2NrID0gdWludChjdXJyZW50QmxvY2spOwogICAgICAgICAgICBjdXJyZW50QmxvY2tEYXRhLmxhc3RSYXRlVXBkYXRlQmxvY2sgPSB1aW50KHJhdGVVcGRhdGVCbG9jayk7CiAgICAgICAgICAgIGN1cnJlbnRCbG9ja0RhdGEudG90YWxCdXlVbml0c0ltYmFsYW5jZSA9IGludChwcmV2SW1iYWxhbmNlKSArIHJlY29yZGVkQnV5QW1vdW50OwogICAgICAgIH0KCiAgICAgICAgdG9rZW5JbWJhbGFuY2VEYXRhW3Rva2VuXVtjdXJyZW50QmxvY2tJbmRleF0gPSBlbmNvZGVUb2tlbkltYmFsYW5jZURhdGEoY3VycmVudEJsb2NrRGF0YSk7CiAgICB9CgogICAgZnVuY3Rpb24gc2V0R2FyYmFnZVRvVm9sdW1lUmVjb3JkZXIoRVJDMjAgdG9rZW4pIGludGVybmFsIHsKICAgICAgICBmb3IgKHVpbnQgaSA9IDA7IGkgPCBTTElESU5HX1dJTkRPV19TSVpFOyBpKyspIHsKICAgICAgICAgICAgdG9rZW5JbWJhbGFuY2VEYXRhW3Rva2VuXVtpXSA9IDB4MTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0SW1iYWxhbmNlSW5SYW5nZShFUkMyMCB0b2tlbiwgdWludCBzdGFydEJsb2NrLCB1aW50IGVuZEJsb2NrKSBpbnRlcm5hbCB2aWV3IHJldHVybnMoaW50IGJ1eUltYmFsYW5jZSkgewogICAgICAgIC8vIGNoZWNrIHRoZSBpbWJhbGFuY2UgaW4gdGhlIHNsaWRpbmcgd2luZG93CiAgICAgICAgcmVxdWlyZShzdGFydEJsb2NrIDw9IGVuZEJsb2NrKTsKCiAgICAgICAgYnV5SW1iYWxhbmNlID0gMDsKCiAgICAgICAgZm9yICh1aW50IHdpbmRvd0luZCA9IDA7IHdpbmRvd0luZCA8IFNMSURJTkdfV0lORE9XX1NJWkU7IHdpbmRvd0luZCsrKSB7CiAgICAgICAgICAgIFRva2VuSW1iYWxhbmNlRGF0YSBtZW1vcnkgcGVyQmxvY2tEYXRhID0gZGVjb2RlVG9rZW5JbWJhbGFuY2VEYXRhKHRva2VuSW1iYWxhbmNlRGF0YVt0b2tlbl1bd2luZG93SW5kXSk7CgogICAgICAgICAgICBpZiAocGVyQmxvY2tEYXRhLmxhc3RCbG9jayA8PSBlbmRCbG9jayAmJiBwZXJCbG9ja0RhdGEubGFzdEJsb2NrID49IHN0YXJ0QmxvY2spIHsKICAgICAgICAgICAgICAgIGJ1eUltYmFsYW5jZSArPSBpbnQocGVyQmxvY2tEYXRhLmxhc3RCbG9ja0J1eVVuaXRzSW1iYWxhbmNlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBnZXRJbWJhbGFuY2VTaW5jZVJhdGVVcGRhdGUoRVJDMjAgdG9rZW4sIHVpbnQgcmF0ZVVwZGF0ZUJsb2NrLCB1aW50IGN1cnJlbnRCbG9jaykKICAgICAgICBpbnRlcm5hbCB2aWV3CiAgICAgICAgcmV0dXJucyhpbnQgYnV5SW1iYWxhbmNlLCBpbnQgY3VycmVudEJsb2NrSW1iYWxhbmNlKQogICAgewogICAgICAgIGJ1eUltYmFsYW5jZSA9IDA7CiAgICAgICAgY3VycmVudEJsb2NrSW1iYWxhbmNlID0gMDsKICAgICAgICB1aW50IGxhdGVzdEJsb2NrID0gMDsKICAgICAgICBpbnQgaW1iYWxhbmNlSW5SYW5nZSA9IDA7CiAgICAgICAgdWludCBzdGFydEJsb2NrID0gcmF0ZVVwZGF0ZUJsb2NrOwogICAgICAgIHVpbnQgZW5kQmxvY2sgPSBjdXJyZW50QmxvY2s7CgogICAgICAgIGZvciAodWludCB3aW5kb3dJbmQgPSAwOyB3aW5kb3dJbmQgPCBTTElESU5HX1dJTkRPV19TSVpFOyB3aW5kb3dJbmQrKykgewogICAgICAgICAgICBUb2tlbkltYmFsYW5jZURhdGEgbWVtb3J5IHBlckJsb2NrRGF0YSA9IGRlY29kZVRva2VuSW1iYWxhbmNlRGF0YSh0b2tlbkltYmFsYW5jZURhdGFbdG9rZW5dW3dpbmRvd0luZF0pOwoKICAgICAgICAgICAgaWYgKHBlckJsb2NrRGF0YS5sYXN0QmxvY2sgPD0gZW5kQmxvY2sgJiYgcGVyQmxvY2tEYXRhLmxhc3RCbG9jayA+PSBzdGFydEJsb2NrKSB7CiAgICAgICAgICAgICAgICBpbWJhbGFuY2VJblJhbmdlICs9IHBlckJsb2NrRGF0YS5sYXN0QmxvY2tCdXlVbml0c0ltYmFsYW5jZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHBlckJsb2NrRGF0YS5sYXN0UmF0ZVVwZGF0ZUJsb2NrICE9IHJhdGVVcGRhdGVCbG9jaykgY29udGludWU7CiAgICAgICAgICAgIGlmIChwZXJCbG9ja0RhdGEubGFzdEJsb2NrIDwgbGF0ZXN0QmxvY2spIGNvbnRpbnVlOwoKICAgICAgICAgICAgbGF0ZXN0QmxvY2sgPSBwZXJCbG9ja0RhdGEubGFzdEJsb2NrOwogICAgICAgICAgICBidXlJbWJhbGFuY2UgPSBwZXJCbG9ja0RhdGEudG90YWxCdXlVbml0c0ltYmFsYW5jZTsKICAgICAgICAgICAgaWYgKHVpbnQocGVyQmxvY2tEYXRhLmxhc3RCbG9jaykgPT0gY3VycmVudEJsb2NrKSB7CiAgICAgICAgICAgICAgICBjdXJyZW50QmxvY2tJbWJhbGFuY2UgPSBwZXJCbG9ja0RhdGEubGFzdEJsb2NrQnV5VW5pdHNJbWJhbGFuY2U7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChidXlJbWJhbGFuY2UgPT0gMCkgewogICAgICAgICAgICBidXlJbWJhbGFuY2UgPSBpbWJhbGFuY2VJblJhbmdlOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBnZXRJbWJhbGFuY2UoRVJDMjAgdG9rZW4sIHVpbnQgcmF0ZVVwZGF0ZUJsb2NrLCB1aW50IGN1cnJlbnRCbG9jaykKICAgICAgICBpbnRlcm5hbCB2aWV3CiAgICAgICAgcmV0dXJucyhpbnQgdG90YWxJbWJhbGFuY2UsIGludCBjdXJyZW50QmxvY2tJbWJhbGFuY2UpCiAgICB7CgogICAgICAgIGludCByZXNvbHV0aW9uID0gaW50KHRva2VuQ29udHJvbEluZm9bdG9rZW5dLm1pbmltYWxSZWNvcmRSZXNvbHV0aW9uKTsKCiAgICAgICAgKHRvdGFsSW1iYWxhbmNlLCBjdXJyZW50QmxvY2tJbWJhbGFuY2UpID0KICAgICAgICAgICAgZ2V0SW1iYWxhbmNlU2luY2VSYXRlVXBkYXRlKAogICAgICAgICAgICAgICAgdG9rZW4sCiAgICAgICAgICAgICAgICByYXRlVXBkYXRlQmxvY2ssCiAgICAgICAgICAgICAgICBjdXJyZW50QmxvY2spOwoKICAgICAgICB0b3RhbEltYmFsYW5jZSAqPSByZXNvbHV0aW9uOwogICAgICAgIGN1cnJlbnRCbG9ja0ltYmFsYW5jZSAqPSByZXNvbHV0aW9uOwogICAgfQoKICAgIGZ1bmN0aW9uIGdldE1heFBlckJsb2NrSW1iYWxhbmNlKEVSQzIwIHRva2VuKSBpbnRlcm5hbCB2aWV3IHJldHVybnModWludCkgewogICAgICAgIHJldHVybiB0b2tlbkNvbnRyb2xJbmZvW3Rva2VuXS5tYXhQZXJCbG9ja0ltYmFsYW5jZTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRNYXhUb3RhbEltYmFsYW5jZShFUkMyMCB0b2tlbikgaW50ZXJuYWwgdmlldyByZXR1cm5zKHVpbnQpIHsKICAgICAgICByZXR1cm4gdG9rZW5Db250cm9sSW5mb1t0b2tlbl0ubWF4VG90YWxJbWJhbGFuY2U7CiAgICB9CgogICAgZnVuY3Rpb24gZW5jb2RlVG9rZW5JbWJhbGFuY2VEYXRhKFRva2VuSW1iYWxhbmNlRGF0YSBkYXRhKSBpbnRlcm5hbCBwdXJlIHJldHVybnModWludCkgewogICAgICAgIC8vIGNoZWNrIGZvciBvdmVyZmxvd3MKICAgICAgICByZXF1aXJlKGRhdGEubGFzdEJsb2NrQnV5VW5pdHNJbWJhbGFuY2UgPCBpbnQoUE9XXzJfNjQgLyAyKSk7CiAgICAgICAgcmVxdWlyZShkYXRhLmxhc3RCbG9ja0J1eVVuaXRzSW1iYWxhbmNlID4gaW50KC0xICogaW50KFBPV18yXzY0KSAvIDIpKTsKICAgICAgICByZXF1aXJlKGRhdGEubGFzdEJsb2NrIDwgUE9XXzJfNjQpOwogICAgICAgIHJlcXVpcmUoZGF0YS50b3RhbEJ1eVVuaXRzSW1iYWxhbmNlIDwgaW50KFBPV18yXzY0IC8gMikpOwogICAgICAgIHJlcXVpcmUoZGF0YS50b3RhbEJ1eVVuaXRzSW1iYWxhbmNlID4gaW50KC0xICogaW50KFBPV18yXzY0KSAvIDIpKTsKICAgICAgICByZXF1aXJlKGRhdGEubGFzdFJhdGVVcGRhdGVCbG9jayA8IFBPV18yXzY0KTsKCiAgICAgICAgLy8gZG8gZW5jb2RpbmcKICAgICAgICB1aW50IHJlc3VsdCA9IHVpbnQoZGF0YS5sYXN0QmxvY2tCdXlVbml0c0ltYmFsYW5jZSkgJiAoUE9XXzJfNjQgLSAxKTsKICAgICAgICByZXN1bHQgfD0gZGF0YS5sYXN0QmxvY2sgKiBQT1dfMl82NDsKICAgICAgICByZXN1bHQgfD0gKHVpbnQoZGF0YS50b3RhbEJ1eVVuaXRzSW1iYWxhbmNlKSAmIChQT1dfMl82NCAtIDEpKSAqIFBPV18yXzY0ICogUE9XXzJfNjQ7CiAgICAgICAgcmVzdWx0IHw9IGRhdGEubGFzdFJhdGVVcGRhdGVCbG9jayAqIFBPV18yXzY0ICogUE9XXzJfNjQgKiBQT1dfMl82NDsKCiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICBmdW5jdGlvbiBkZWNvZGVUb2tlbkltYmFsYW5jZURhdGEodWludCBpbnB1dCkgaW50ZXJuYWwgcHVyZSByZXR1cm5zKFRva2VuSW1iYWxhbmNlRGF0YSkgewogICAgICAgIFRva2VuSW1iYWxhbmNlRGF0YSBtZW1vcnkgZGF0YTsKCiAgICAgICAgZGF0YS5sYXN0QmxvY2tCdXlVbml0c0ltYmFsYW5jZSA9IGludChpbnQ2NChpbnB1dCAmIChQT1dfMl82NCAtIDEpKSk7CiAgICAgICAgZGF0YS5sYXN0QmxvY2sgPSB1aW50KHVpbnQ2NCgoaW5wdXQgLyBQT1dfMl82NCkgJiAoUE9XXzJfNjQgLSAxKSkpOwogICAgICAgIGRhdGEudG90YWxCdXlVbml0c0ltYmFsYW5jZSA9IGludChpbnQ2NCgoaW5wdXQgLyAoUE9XXzJfNjQgKiBQT1dfMl82NCkpICYgKFBPV18yXzY0IC0gMSkpKTsKICAgICAgICBkYXRhLmxhc3RSYXRlVXBkYXRlQmxvY2sgPSB1aW50KHVpbnQ2NCgoaW5wdXQgLyAoUE9XXzJfNjQgKiBQT1dfMl82NCAqIFBPV18yXzY0KSkpKTsKCiAgICAgICAgcmV0dXJuIGRhdGE7CiAgICB9Cn0KCmNvbnRyYWN0IENvbnZlcnNpb25SYXRlcyBpcyBWb2x1bWVJbWJhbGFuY2VSZWNvcmRlciwgVXRpbHMgewoKICAgIC8vIGJwcyAtIGJhc2ljIHJhdGUgc3RlcHMuIG9uZSBzdGVwIGlzIDEgLyAxMDAwMCBvZiB0aGUgcmF0ZS4KICAgIHN0cnVjdCBTdGVwRnVuY3Rpb24gewogICAgICAgIGludFtdIHg7IC8vIHF1YW50aXR5IGZvciBlYWNoIHN0ZXAuIFF1YW50aXR5IG9mIGVhY2ggc3RlcCBpbmNsdWRlcyBwcmV2aW91cyBzdGVwcy4KICAgICAgICBpbnRbXSB5OyAvLyByYXRlIGNoYW5nZSBwZXIgcXVhbnRpdHkgc3RlcCAgaW4gYnBzLgogICAgfQoKICAgIHN0cnVjdCBUb2tlbkRhdGEgewogICAgICAgIGJvb2wgbGlzdGVkOyAgLy8gd2FzIGFkZGVkIHRvIHJlc2VydmUKICAgICAgICBib29sIGVuYWJsZWQ7IC8vIHdoZXRoZXIgdHJhZGUgaXMgZW5hYmxlZAoKICAgICAgICAvLyBwb3NpdGlvbiBpbiB0aGUgY29tcGFjdCBkYXRhCiAgICAgICAgdWludCBjb21wYWN0RGF0YUFycmF5SW5kZXg7CiAgICAgICAgdWludCBjb21wYWN0RGF0YUZpZWxkSW5kZXg7CgogICAgICAgIC8vIHJhdGUgZGF0YS4gYmFzZSBhbmQgY2hhbmdlcyBhY2NvcmRpbmcgdG8gcXVhbnRpdHkgYW5kIHJlc2VydmUgYmFsYW5jZS4KICAgICAgICAvLyBnZW5lcmFsbHkgc3BlYWtpbmcuIFNlbGwgcmF0ZSBpcyAxIC8gYnV5IHJhdGUgaS5lLiB0aGUgYnV5IGluIHRoZSBvdGhlciBkaXJlY3Rpb24uCiAgICAgICAgdWludCBiYXNlQnV5UmF0ZTsgIC8vIGluIFBSRUNJU0lPTiB1bml0cy4gc2VlIEt5YmVyQ29uc3RhbnRzCiAgICAgICAgdWludCBiYXNlU2VsbFJhdGU7IC8vIFBSRUNJU0lPTiB1bml0cy4gd2l0aG91dCAoc2VsbCAvIGJ1eSkgc3ByZWFkIGl0IGlzIDEgLyBiYXNlQnV5UmF0ZQogICAgICAgIFN0ZXBGdW5jdGlvbiBidXlSYXRlUXR5U3RlcEZ1bmN0aW9uOyAvLyBpbiBicHMuIGhpZ2hlciBxdWFudGl0eSAtIGJpZ2dlciB0aGUgcmF0ZS4KICAgICAgICBTdGVwRnVuY3Rpb24gc2VsbFJhdGVRdHlTdGVwRnVuY3Rpb247Ly8gaW4gYnBzLiBoaWdoZXIgdGhlIHF1YQogICAgICAgIFN0ZXBGdW5jdGlvbiBidXlSYXRlSW1iYWxhbmNlU3RlcEZ1bmN0aW9uOyAvLyBpbiBCUFMuIGhpZ2hlciByZXNlcnZlIGltYmFsYW5jZSAtIGJpZ2dlciB0aGUgcmF0ZS4KICAgICAgICBTdGVwRnVuY3Rpb24gc2VsbFJhdGVJbWJhbGFuY2VTdGVwRnVuY3Rpb247CiAgICB9CgogICAgLyoKICAgIHRoaXMgaXMgdGhlIGRhdGEgZm9yIHRva2VuUmF0ZXNDb21wYWN0RGF0YQogICAgYnV0IHNvbGlkaXR5IGNvbXBpbGVyIG9wdGltaXplciBpcyBzdWItb3B0aW1hbCwgYW5kIGNhbm5vdCB3cml0ZSB0aGlzIHN0cnVjdHVyZSBpbiBhIHNpbmdsZSBzdG9yYWdlIHdyaXRlCiAgICBzbyB3ZSByZXByZXNlbnQgaXQgYXMgYnl0ZXMzMiBhbmQgZG8gdGhlIGJ5dGUgdHJpY2tzIG91cnNlbHZlcy4KICAgIHN0cnVjdCBUb2tlblJhdGVzQ29tcGFjdERhdGEgewogICAgICAgIGJ5dGVzMTQgYnV5OyAgLy8gY2hhbmdlIGJ1eSByYXRlIG9mIHRva2VuIGZyb20gYmFzZUJ1eVJhdGUgaW4gMTAgYnBzCiAgICAgICAgYnl0ZXMxNCBzZWxsOyAvLyBjaGFuZ2Ugc2VsbCByYXRlIG9mIHRva2VuIGZyb20gYmFzZVNlbGxSYXRlIGluIDEwIGJwcwoKICAgICAgICB1aW50MzIgYmxvY2tOdW1iZXI7CiAgICB9ICovCiAgICB1aW50IHB1YmxpYyB2YWxpZFJhdGVEdXJhdGlvbkluQmxvY2tzID0gMTA7IC8vIHJhdGVzIGFyZSB2YWxpZCBmb3IgdGhpcyBhbW91bnQgb2YgYmxvY2tzCiAgICBFUkMyMFtdIGludGVybmFsIGxpc3RlZFRva2VuczsKICAgIG1hcHBpbmcoYWRkcmVzcz0+VG9rZW5EYXRhKSBpbnRlcm5hbCB0b2tlbkRhdGE7CiAgICBieXRlczMyW10gaW50ZXJuYWwgdG9rZW5SYXRlc0NvbXBhY3REYXRhOwogICAgdWludCBwdWJsaWMgbnVtVG9rZW5zSW5DdXJyZW50Q29tcGFjdERhdGEgPSAwOwogICAgYWRkcmVzcyBwdWJsaWMgcmVzZXJ2ZUNvbnRyYWN0OwogICAgdWludCBjb25zdGFudCBpbnRlcm5hbCBOVU1fVE9LRU5TX0lOX0NPTVBBQ1RfREFUQSA9IDE0OwogICAgdWludCBjb25zdGFudCBpbnRlcm5hbCBCWVRFU18xNF9PRkZTRVQgPSAoMiAqKiAoOCAqIE5VTV9UT0tFTlNfSU5fQ09NUEFDVF9EQVRBKSk7CgogICAgZnVuY3Rpb24gQ29udmVyc2lvblJhdGVzKGFkZHJlc3MgX2FkbWluKSBwdWJsaWMgVm9sdW1lSW1iYWxhbmNlUmVjb3JkZXIoX2FkbWluKQogICAgICAgIHsgfSAvLyBzb2xoaW50LWRpc2FibGUtbGluZSBuby1lbXB0eS1ibG9ja3MKCiAgICBmdW5jdGlvbiBhZGRUb2tlbihFUkMyMCB0b2tlbikgcHVibGljIG9ubHlBZG1pbiB7CgogICAgICAgIHJlcXVpcmUoIXRva2VuRGF0YVt0b2tlbl0ubGlzdGVkKTsKICAgICAgICB0b2tlbkRhdGFbdG9rZW5dLmxpc3RlZCA9IHRydWU7CiAgICAgICAgbGlzdGVkVG9rZW5zLnB1c2godG9rZW4pOwoKICAgICAgICBpZiAobnVtVG9rZW5zSW5DdXJyZW50Q29tcGFjdERhdGEgPT0gMCkgewogICAgICAgICAgICB0b2tlblJhdGVzQ29tcGFjdERhdGEubGVuZ3RoKys7IC8vIGFkZCBuZXcgc3RydWN0dXJlCiAgICAgICAgfQoKICAgICAgICB0b2tlbkRhdGFbdG9rZW5dLmNvbXBhY3REYXRhQXJyYXlJbmRleCA9IHRva2VuUmF0ZXNDb21wYWN0RGF0YS5sZW5ndGggLSAxOwogICAgICAgIHRva2VuRGF0YVt0b2tlbl0uY29tcGFjdERhdGFGaWVsZEluZGV4ID0gbnVtVG9rZW5zSW5DdXJyZW50Q29tcGFjdERhdGE7CgogICAgICAgIG51bVRva2Vuc0luQ3VycmVudENvbXBhY3REYXRhID0gKG51bVRva2Vuc0luQ3VycmVudENvbXBhY3REYXRhICsgMSkgJSBOVU1fVE9LRU5TX0lOX0NPTVBBQ1RfREFUQTsKCiAgICAgICAgc2V0R2FyYmFnZVRvVm9sdW1lUmVjb3JkZXIodG9rZW4pOwogICAgfQoKICAgIGZ1bmN0aW9uIHNldENvbXBhY3REYXRhKGJ5dGVzMTRbXSBidXksIGJ5dGVzMTRbXSBzZWxsLCB1aW50IGJsb2NrTnVtYmVyLCB1aW50W10gaW5kaWNlcykgcHVibGljIG9ubHlPcGVyYXRvciB7CgogICAgICAgIHJlcXVpcmUoYnV5Lmxlbmd0aCA9PSBzZWxsLmxlbmd0aCk7CiAgICAgICAgcmVxdWlyZShpbmRpY2VzLmxlbmd0aCA9PSBidXkubGVuZ3RoKTsKICAgICAgICByZXF1aXJlKGJsb2NrTnVtYmVyIDw9IDB4RkZGRkZGRkYpOwoKICAgICAgICB1aW50IGJ5dGVzMTRPZmZzZXQgPSBCWVRFU18xNF9PRkZTRVQ7CgogICAgICAgIGZvciAodWludCBpID0gMDsgaSA8IGluZGljZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgcmVxdWlyZShpbmRpY2VzW2ldIDwgdG9rZW5SYXRlc0NvbXBhY3REYXRhLmxlbmd0aCk7CiAgICAgICAgICAgIHVpbnQgZGF0YSA9IHVpbnQoYnV5W2ldKSB8IHVpbnQoc2VsbFtpXSkgKiBieXRlczE0T2Zmc2V0IHwgKGJsb2NrTnVtYmVyICogKGJ5dGVzMTRPZmZzZXQgKiBieXRlczE0T2Zmc2V0KSk7CiAgICAgICAgICAgIHRva2VuUmF0ZXNDb21wYWN0RGF0YVtpbmRpY2VzW2ldXSA9IGJ5dGVzMzIoZGF0YSk7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIHNldEJhc2VSYXRlKAogICAgICAgIEVSQzIwW10gdG9rZW5zLAogICAgICAgIHVpbnRbXSBiYXNlQnV5LAogICAgICAgIHVpbnRbXSBiYXNlU2VsbCwKICAgICAgICBieXRlczE0W10gYnV5LAogICAgICAgIGJ5dGVzMTRbXSBzZWxsLAogICAgICAgIHVpbnQgYmxvY2tOdW1iZXIsCiAgICAgICAgdWludFtdIGluZGljZXMKICAgICkKICAgICAgICBwdWJsaWMKICAgICAgICBvbmx5T3BlcmF0b3IKICAgIHsKICAgICAgICByZXF1aXJlKHRva2Vucy5sZW5ndGggPT0gYmFzZUJ1eS5sZW5ndGgpOwogICAgICAgIHJlcXVpcmUodG9rZW5zLmxlbmd0aCA9PSBiYXNlU2VsbC5sZW5ndGgpOwogICAgICAgIHJlcXVpcmUoc2VsbC5sZW5ndGggPT0gYnV5Lmxlbmd0aCk7CiAgICAgICAgcmVxdWlyZShzZWxsLmxlbmd0aCA9PSBpbmRpY2VzLmxlbmd0aCk7CgogICAgICAgIGZvciAodWludCBpbmQgPSAwOyBpbmQgPCB0b2tlbnMubGVuZ3RoOyBpbmQrKykgewogICAgICAgICAgICByZXF1aXJlKHRva2VuRGF0YVt0b2tlbnNbaW5kXV0ubGlzdGVkKTsKICAgICAgICAgICAgdG9rZW5EYXRhW3Rva2Vuc1tpbmRdXS5iYXNlQnV5UmF0ZSA9IGJhc2VCdXlbaW5kXTsKICAgICAgICAgICAgdG9rZW5EYXRhW3Rva2Vuc1tpbmRdXS5iYXNlU2VsbFJhdGUgPSBiYXNlU2VsbFtpbmRdOwogICAgICAgIH0KCiAgICAgICAgc2V0Q29tcGFjdERhdGEoYnV5LCBzZWxsLCBibG9ja051bWJlciwgaW5kaWNlcyk7CiAgICB9CgogICAgZnVuY3Rpb24gc2V0UXR5U3RlcEZ1bmN0aW9uKAogICAgICAgIEVSQzIwIHRva2VuLAogICAgICAgIGludFtdIHhCdXksCiAgICAgICAgaW50W10geUJ1eSwKICAgICAgICBpbnRbXSB4U2VsbCwKICAgICAgICBpbnRbXSB5U2VsbAogICAgKQogICAgICAgIHB1YmxpYwogICAgICAgIG9ubHlPcGVyYXRvcgogICAgewogICAgICAgIHJlcXVpcmUoeEJ1eS5sZW5ndGggPT0geUJ1eS5sZW5ndGgpOwogICAgICAgIHJlcXVpcmUoeFNlbGwubGVuZ3RoID09IHlTZWxsLmxlbmd0aCk7CiAgICAgICAgcmVxdWlyZSh0b2tlbkRhdGFbdG9rZW5dLmxpc3RlZCk7CgogICAgICAgIHRva2VuRGF0YVt0b2tlbl0uYnV5UmF0ZVF0eVN0ZXBGdW5jdGlvbiA9IFN0ZXBGdW5jdGlvbih4QnV5LCB5QnV5KTsKICAgICAgICB0b2tlbkRhdGFbdG9rZW5dLnNlbGxSYXRlUXR5U3RlcEZ1bmN0aW9uID0gU3RlcEZ1bmN0aW9uKHhTZWxsLCB5U2VsbCk7CiAgICB9CgogICAgZnVuY3Rpb24gc2V0SW1iYWxhbmNlU3RlcEZ1bmN0aW9uKAogICAgICAgIEVSQzIwIHRva2VuLAogICAgICAgIGludFtdIHhCdXksCiAgICAgICAgaW50W10geUJ1eSwKICAgICAgICBpbnRbXSB4U2VsbCwKICAgICAgICBpbnRbXSB5U2VsbAogICAgKQogICAgICAgIHB1YmxpYwogICAgICAgIG9ubHlPcGVyYXRvcgogICAgewogICAgICAgIHJlcXVpcmUoeEJ1eS5sZW5ndGggPT0geUJ1eS5sZW5ndGgpOwogICAgICAgIHJlcXVpcmUoeFNlbGwubGVuZ3RoID09IHlTZWxsLmxlbmd0aCk7CiAgICAgICAgcmVxdWlyZSh0b2tlbkRhdGFbdG9rZW5dLmxpc3RlZCk7CgogICAgICAgIHRva2VuRGF0YVt0b2tlbl0uYnV5UmF0ZUltYmFsYW5jZVN0ZXBGdW5jdGlvbiA9IFN0ZXBGdW5jdGlvbih4QnV5LCB5QnV5KTsKICAgICAgICB0b2tlbkRhdGFbdG9rZW5dLnNlbGxSYXRlSW1iYWxhbmNlU3RlcEZ1bmN0aW9uID0gU3RlcEZ1bmN0aW9uKHhTZWxsLCB5U2VsbCk7CiAgICB9CgogICAgZnVuY3Rpb24gc2V0VmFsaWRSYXRlRHVyYXRpb25JbkJsb2Nrcyh1aW50IGR1cmF0aW9uKSBwdWJsaWMgb25seUFkbWluIHsKICAgICAgICB2YWxpZFJhdGVEdXJhdGlvbkluQmxvY2tzID0gZHVyYXRpb247CiAgICB9CgogICAgZnVuY3Rpb24gZW5hYmxlVG9rZW5UcmFkZShFUkMyMCB0b2tlbikgcHVibGljIG9ubHlBZG1pbiB7CiAgICAgICAgcmVxdWlyZSh0b2tlbkRhdGFbdG9rZW5dLmxpc3RlZCk7CiAgICAgICAgcmVxdWlyZSh0b2tlbkNvbnRyb2xJbmZvW3Rva2VuXS5taW5pbWFsUmVjb3JkUmVzb2x1dGlvbiAhPSAwKTsKICAgICAgICB0b2tlbkRhdGFbdG9rZW5dLmVuYWJsZWQgPSB0cnVlOwogICAgfQoKICAgIGZ1bmN0aW9uIGRpc2FibGVUb2tlblRyYWRlKEVSQzIwIHRva2VuKSBwdWJsaWMgb25seUFsZXJ0ZXIgewogICAgICAgIHJlcXVpcmUodG9rZW5EYXRhW3Rva2VuXS5saXN0ZWQpOwogICAgICAgIHRva2VuRGF0YVt0b2tlbl0uZW5hYmxlZCA9IGZhbHNlOwogICAgfQoKICAgIGZ1bmN0aW9uIHNldFJlc2VydmVBZGRyZXNzKGFkZHJlc3MgcmVzZXJ2ZSkgcHVibGljIG9ubHlBZG1pbiB7CiAgICAgICAgcmVzZXJ2ZUNvbnRyYWN0ID0gcmVzZXJ2ZTsKICAgIH0KCiAgICBmdW5jdGlvbiByZWNvcmRJbWJhbGFuY2UoCiAgICAgICAgRVJDMjAgdG9rZW4sCiAgICAgICAgaW50IGJ1eUFtb3VudCwKICAgICAgICB1aW50IHJhdGVVcGRhdGVCbG9jaywKICAgICAgICB1aW50IGN1cnJlbnRCbG9jawogICAgKQogICAgICAgIHB1YmxpYwogICAgewogICAgICAgIHJlcXVpcmUobXNnLnNlbmRlciA9PSByZXNlcnZlQ29udHJhY3QpOwoKICAgICAgICBpZiAocmF0ZVVwZGF0ZUJsb2NrID09IDApIHJhdGVVcGRhdGVCbG9jayA9IGdldFJhdGVVcGRhdGVCbG9jayh0b2tlbik7CgogICAgICAgIHJldHVybiBhZGRJbWJhbGFuY2UodG9rZW4sIGJ1eUFtb3VudCwgcmF0ZVVwZGF0ZUJsb2NrLCBjdXJyZW50QmxvY2spOwogICAgfQoKICAgIC8qIHNvbGhpbnQtZGlzYWJsZSBmdW5jdGlvbi1tYXgtbGluZXMgKi8KICAgIGZ1bmN0aW9uIGdldFJhdGUoRVJDMjAgdG9rZW4sIHVpbnQgY3VycmVudEJsb2NrTnVtYmVyLCBib29sIGJ1eSwgdWludCBxdHkpIHB1YmxpYyB2aWV3IHJldHVybnModWludCkgewogICAgICAgIC8vIGNoZWNrIGlmIHRyYWRlIGlzIGVuYWJsZWQKICAgICAgICBpZiAoIXRva2VuRGF0YVt0b2tlbl0uZW5hYmxlZCkgcmV0dXJuIDA7CiAgICAgICAgaWYgKHRva2VuQ29udHJvbEluZm9bdG9rZW5dLm1pbmltYWxSZWNvcmRSZXNvbHV0aW9uID09IDApIHJldHVybiAwOyAvLyB0b2tlbiBjb250cm9sIGluZm8gbm90IHNldAoKICAgICAgICAvLyBnZXQgcmF0ZSB1cGRhdGUgYmxvY2sKICAgICAgICBieXRlczMyIGNvbXBhY3REYXRhID0gdG9rZW5SYXRlc0NvbXBhY3REYXRhW3Rva2VuRGF0YVt0b2tlbl0uY29tcGFjdERhdGFBcnJheUluZGV4XTsKCiAgICAgICAgdWludCB1cGRhdGVSYXRlQmxvY2sgPSBnZXRMYXN0NEJ5dGVzKGNvbXBhY3REYXRhKTsKICAgICAgICBpZiAoY3VycmVudEJsb2NrTnVtYmVyID49IHVwZGF0ZVJhdGVCbG9jayArIHZhbGlkUmF0ZUR1cmF0aW9uSW5CbG9ja3MpIHJldHVybiAwOyAvLyByYXRlIGlzIGV4cGlyZWQKICAgICAgICAvLyBjaGVjayBpbWJhbGFuY2UKICAgICAgICBpbnQgdG90YWxJbWJhbGFuY2U7CiAgICAgICAgaW50IGJsb2NrSW1iYWxhbmNlOwogICAgICAgICh0b3RhbEltYmFsYW5jZSwgYmxvY2tJbWJhbGFuY2UpID0gZ2V0SW1iYWxhbmNlKHRva2VuLCB1cGRhdGVSYXRlQmxvY2ssIGN1cnJlbnRCbG9ja051bWJlcik7CgogICAgICAgIC8vIGNhbGN1bGF0ZSBhY3R1YWwgcmF0ZQogICAgICAgIGludCBpbWJhbGFuY2VRdHk7CiAgICAgICAgaW50IGV4dHJhQnBzOwogICAgICAgIGludDggcmF0ZVVwZGF0ZTsKICAgICAgICB1aW50IHJhdGU7CgogICAgICAgIGlmIChidXkpIHsKICAgICAgICAgICAgLy8gc3RhcnQgd2l0aCBiYXNlIHJhdGUKICAgICAgICAgICAgcmF0ZSA9IHRva2VuRGF0YVt0b2tlbl0uYmFzZUJ1eVJhdGU7CgogICAgICAgICAgICAvLyBhZGQgcmF0ZSB1cGRhdGUKICAgICAgICAgICAgcmF0ZVVwZGF0ZSA9IGdldFJhdGVCeXRlRnJvbUNvbXBhY3REYXRhKGNvbXBhY3REYXRhLCB0b2tlbiwgdHJ1ZSk7CiAgICAgICAgICAgIGV4dHJhQnBzID0gaW50KHJhdGVVcGRhdGUpICogMTA7CiAgICAgICAgICAgIHJhdGUgPSBhZGRCcHMocmF0ZSwgZXh0cmFCcHMpOwoKICAgICAgICAgICAgLy8gY29tcHV0ZSB0b2tlbiBxdHkKICAgICAgICAgICAgcXR5ID0gZ2V0VG9rZW5RdHkodG9rZW4sIHJhdGUsIHF0eSk7CiAgICAgICAgICAgIGltYmFsYW5jZVF0eSA9IGludChxdHkpOwogICAgICAgICAgICB0b3RhbEltYmFsYW5jZSArPSBpbWJhbGFuY2VRdHk7CgogICAgICAgICAgICAvLyBhZGQgcXR5IG92ZXJoZWFkCiAgICAgICAgICAgIGV4dHJhQnBzID0gZXhlY3V0ZVN0ZXBGdW5jdGlvbih0b2tlbkRhdGFbdG9rZW5dLmJ1eVJhdGVRdHlTdGVwRnVuY3Rpb24sIGludChxdHkpKTsKICAgICAgICAgICAgcmF0ZSA9IGFkZEJwcyhyYXRlLCBleHRyYUJwcyk7CgogICAgICAgICAgICAvLyBhZGQgaW1iYWxhbmNlIG92ZXJoZWFkCiAgICAgICAgICAgIGV4dHJhQnBzID0gZXhlY3V0ZVN0ZXBGdW5jdGlvbih0b2tlbkRhdGFbdG9rZW5dLmJ1eVJhdGVJbWJhbGFuY2VTdGVwRnVuY3Rpb24sIHRvdGFsSW1iYWxhbmNlKTsKICAgICAgICAgICAgcmF0ZSA9IGFkZEJwcyhyYXRlLCBleHRyYUJwcyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gc3RhcnQgd2l0aCBiYXNlIHJhdGUKICAgICAgICAgICAgcmF0ZSA9IHRva2VuRGF0YVt0b2tlbl0uYmFzZVNlbGxSYXRlOwoKICAgICAgICAgICAgLy8gYWRkIHJhdGUgdXBkYXRlCiAgICAgICAgICAgIHJhdGVVcGRhdGUgPSBnZXRSYXRlQnl0ZUZyb21Db21wYWN0RGF0YShjb21wYWN0RGF0YSwgdG9rZW4sIGZhbHNlKTsKICAgICAgICAgICAgZXh0cmFCcHMgPSBpbnQocmF0ZVVwZGF0ZSkgKiAxMDsKICAgICAgICAgICAgcmF0ZSA9IGFkZEJwcyhyYXRlLCBleHRyYUJwcyk7CgogICAgICAgICAgICAvLyBjb21wdXRlIHRva2VuIHF0eQogICAgICAgICAgICBpbWJhbGFuY2VRdHkgPSAtMSAqIGludChxdHkpOwogICAgICAgICAgICB0b3RhbEltYmFsYW5jZSArPSBpbWJhbGFuY2VRdHk7CgogICAgICAgICAgICAvLyBhZGQgcXR5IG92ZXJoZWFkCiAgICAgICAgICAgIGV4dHJhQnBzID0gZXhlY3V0ZVN0ZXBGdW5jdGlvbih0b2tlbkRhdGFbdG9rZW5dLnNlbGxSYXRlUXR5U3RlcEZ1bmN0aW9uLCBpbnQocXR5KSk7CiAgICAgICAgICAgIHJhdGUgPSBhZGRCcHMocmF0ZSwgZXh0cmFCcHMpOwoKICAgICAgICAgICAgLy8gYWRkIGltYmFsYW5jZSBvdmVyaGVhZAogICAgICAgICAgICBleHRyYUJwcyA9IGV4ZWN1dGVTdGVwRnVuY3Rpb24odG9rZW5EYXRhW3Rva2VuXS5zZWxsUmF0ZUltYmFsYW5jZVN0ZXBGdW5jdGlvbiwgdG90YWxJbWJhbGFuY2UpOwogICAgICAgICAgICByYXRlID0gYWRkQnBzKHJhdGUsIGV4dHJhQnBzKTsKICAgICAgICB9CgogICAgICAgIGlmIChhYnModG90YWxJbWJhbGFuY2UgKyBpbWJhbGFuY2VRdHkpID49IGdldE1heFRvdGFsSW1iYWxhbmNlKHRva2VuKSkgcmV0dXJuIDA7CiAgICAgICAgaWYgKGFicyhibG9ja0ltYmFsYW5jZSArIGltYmFsYW5jZVF0eSkgPj0gZ2V0TWF4UGVyQmxvY2tJbWJhbGFuY2UodG9rZW4pKSByZXR1cm4gMDsKCiAgICAgICAgcmV0dXJuIHJhdGU7CiAgICB9CiAgICAvKiBzb2xoaW50LWVuYWJsZSBmdW5jdGlvbi1tYXgtbGluZXMgKi8KCiAgICBmdW5jdGlvbiBnZXRCYXNpY1JhdGUoRVJDMjAgdG9rZW4sIGJvb2wgYnV5KSBwdWJsaWMgdmlldyByZXR1cm5zKHVpbnQpIHsKICAgICAgICBpZiAoYnV5KQogICAgICAgICAgICByZXR1cm4gdG9rZW5EYXRhW3Rva2VuXS5iYXNlQnV5UmF0ZTsKICAgICAgICBlbHNlCiAgICAgICAgICAgIHJldHVybiB0b2tlbkRhdGFbdG9rZW5dLmJhc2VTZWxsUmF0ZTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRDb21wYWN0RGF0YShFUkMyMCB0b2tlbikgcHVibGljIHZpZXcgcmV0dXJucyh1aW50LCB1aW50LCBieXRlLCBieXRlKSB7CiAgICAgICAgdWludCBhcnJheUluZGV4ID0gdG9rZW5EYXRhW3Rva2VuXS5jb21wYWN0RGF0YUFycmF5SW5kZXg7CiAgICAgICAgdWludCBmaWVsZE9mZnNldCA9IHRva2VuRGF0YVt0b2tlbl0uY29tcGFjdERhdGFGaWVsZEluZGV4OwoKICAgICAgICByZXR1cm4gKAogICAgICAgICAgICBhcnJheUluZGV4LAogICAgICAgICAgICBmaWVsZE9mZnNldCwKICAgICAgICAgICAgYnl0ZShnZXRSYXRlQnl0ZUZyb21Db21wYWN0RGF0YSh0b2tlblJhdGVzQ29tcGFjdERhdGFbYXJyYXlJbmRleF0sIHRva2VuLCB0cnVlKSksCiAgICAgICAgICAgIGJ5dGUoZ2V0UmF0ZUJ5dGVGcm9tQ29tcGFjdERhdGEodG9rZW5SYXRlc0NvbXBhY3REYXRhW2FycmF5SW5kZXhdLCB0b2tlbiwgZmFsc2UpKQogICAgICAgICk7CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0VG9rZW5CYXNpY0RhdGEoRVJDMjAgdG9rZW4pIHB1YmxpYyB2aWV3IHJldHVybnMoYm9vbCwgYm9vbCkgewogICAgICAgIHJldHVybiAodG9rZW5EYXRhW3Rva2VuXS5saXN0ZWQsIHRva2VuRGF0YVt0b2tlbl0uZW5hYmxlZCk7CiAgICB9CgogICAgLyogc29saGludC1kaXNhYmxlIGNvZGUtY29tcGxleGl0eSAqLwogICAgZnVuY3Rpb24gZ2V0U3RlcEZ1bmN0aW9uRGF0YShFUkMyMCB0b2tlbiwgdWludCBjb21tYW5kLCB1aW50IHBhcmFtKSBwdWJsaWMgdmlldyByZXR1cm5zKGludCkgewogICAgICAgIGlmIChjb21tYW5kID09IDApIHJldHVybiBpbnQodG9rZW5EYXRhW3Rva2VuXS5idXlSYXRlUXR5U3RlcEZ1bmN0aW9uLngubGVuZ3RoKTsKICAgICAgICBpZiAoY29tbWFuZCA9PSAxKSByZXR1cm4gdG9rZW5EYXRhW3Rva2VuXS5idXlSYXRlUXR5U3RlcEZ1bmN0aW9uLnhbcGFyYW1dOwogICAgICAgIGlmIChjb21tYW5kID09IDIpIHJldHVybiBpbnQodG9rZW5EYXRhW3Rva2VuXS5idXlSYXRlUXR5U3RlcEZ1bmN0aW9uLnkubGVuZ3RoKTsKICAgICAgICBpZiAoY29tbWFuZCA9PSAzKSByZXR1cm4gdG9rZW5EYXRhW3Rva2VuXS5idXlSYXRlUXR5U3RlcEZ1bmN0aW9uLnlbcGFyYW1dOwoKICAgICAgICBpZiAoY29tbWFuZCA9PSA0KSByZXR1cm4gaW50KHRva2VuRGF0YVt0b2tlbl0uc2VsbFJhdGVRdHlTdGVwRnVuY3Rpb24ueC5sZW5ndGgpOwogICAgICAgIGlmIChjb21tYW5kID09IDUpIHJldHVybiB0b2tlbkRhdGFbdG9rZW5dLnNlbGxSYXRlUXR5U3RlcEZ1bmN0aW9uLnhbcGFyYW1dOwogICAgICAgIGlmIChjb21tYW5kID09IDYpIHJldHVybiBpbnQodG9rZW5EYXRhW3Rva2VuXS5zZWxsUmF0ZVF0eVN0ZXBGdW5jdGlvbi55Lmxlbmd0aCk7CiAgICAgICAgaWYgKGNvbW1hbmQgPT0gNykgcmV0dXJuIHRva2VuRGF0YVt0b2tlbl0uc2VsbFJhdGVRdHlTdGVwRnVuY3Rpb24ueVtwYXJhbV07CgogICAgICAgIGlmIChjb21tYW5kID09IDgpIHJldHVybiBpbnQodG9rZW5EYXRhW3Rva2VuXS5idXlSYXRlSW1iYWxhbmNlU3RlcEZ1bmN0aW9uLngubGVuZ3RoKTsKICAgICAgICBpZiAoY29tbWFuZCA9PSA5KSByZXR1cm4gdG9rZW5EYXRhW3Rva2VuXS5idXlSYXRlSW1iYWxhbmNlU3RlcEZ1bmN0aW9uLnhbcGFyYW1dOwogICAgICAgIGlmIChjb21tYW5kID09IDEwKSByZXR1cm4gaW50KHRva2VuRGF0YVt0b2tlbl0uYnV5UmF0ZUltYmFsYW5jZVN0ZXBGdW5jdGlvbi55Lmxlbmd0aCk7CiAgICAgICAgaWYgKGNvbW1hbmQgPT0gMTEpIHJldHVybiB0b2tlbkRhdGFbdG9rZW5dLmJ1eVJhdGVJbWJhbGFuY2VTdGVwRnVuY3Rpb24ueVtwYXJhbV07CgogICAgICAgIGlmIChjb21tYW5kID09IDEyKSByZXR1cm4gaW50KHRva2VuRGF0YVt0b2tlbl0uc2VsbFJhdGVJbWJhbGFuY2VTdGVwRnVuY3Rpb24ueC5sZW5ndGgpOwogICAgICAgIGlmIChjb21tYW5kID09IDEzKSByZXR1cm4gdG9rZW5EYXRhW3Rva2VuXS5zZWxsUmF0ZUltYmFsYW5jZVN0ZXBGdW5jdGlvbi54W3BhcmFtXTsKICAgICAgICBpZiAoY29tbWFuZCA9PSAxNCkgcmV0dXJuIGludCh0b2tlbkRhdGFbdG9rZW5dLnNlbGxSYXRlSW1iYWxhbmNlU3RlcEZ1bmN0aW9uLnkubGVuZ3RoKTsKICAgICAgICBpZiAoY29tbWFuZCA9PSAxNSkgcmV0dXJuIHRva2VuRGF0YVt0b2tlbl0uc2VsbFJhdGVJbWJhbGFuY2VTdGVwRnVuY3Rpb24ueVtwYXJhbV07CgogICAgICAgIHJldmVydCgpOwogICAgfQogICAgLyogc29saGludC1lbmFibGUgY29kZS1jb21wbGV4aXR5ICovCgogICAgZnVuY3Rpb24gZ2V0UmF0ZVVwZGF0ZUJsb2NrKEVSQzIwIHRva2VuKSBwdWJsaWMgdmlldyByZXR1cm5zKHVpbnQpIHsKICAgICAgICBieXRlczMyIGNvbXBhY3REYXRhID0gdG9rZW5SYXRlc0NvbXBhY3REYXRhW3Rva2VuRGF0YVt0b2tlbl0uY29tcGFjdERhdGFBcnJheUluZGV4XTsKICAgICAgICByZXR1cm4gZ2V0TGFzdDRCeXRlcyhjb21wYWN0RGF0YSk7CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0TGlzdGVkVG9rZW5zKCkgcHVibGljIHZpZXcgcmV0dXJucyhFUkMyMFtdKSB7CiAgICAgICAgcmV0dXJuIGxpc3RlZFRva2VuczsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRUb2tlblF0eShFUkMyMCB0b2tlbiwgdWludCBldGhRdHksIHVpbnQgcmF0ZSkgaW50ZXJuYWwgdmlldyByZXR1cm5zKHVpbnQpIHsKICAgICAgICB1aW50IGRzdERlY2ltYWxzID0gdG9rZW4uZGVjaW1hbHMoKTsKICAgICAgICB1aW50IHNyY0RlY2ltYWxzID0gMTg7CgogICAgICAgIHJldHVybiBjYWxjRHN0UXR5KGV0aFF0eSwgc3JjRGVjaW1hbHMsIGRzdERlY2ltYWxzLCByYXRlKTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRMYXN0NEJ5dGVzKGJ5dGVzMzIgYikgaW50ZXJuYWwgcHVyZSByZXR1cm5zKHVpbnQpIHsKICAgICAgICAvLyBjYW5ub3QgdHJ1c3QgY29tcGlsZXIgd2l0aCBub3QgdHVybmluZyBiaXQgb3BlcmF0aW9ucyBpbnRvIEVYUCBvcGNvZGUKICAgICAgICByZXR1cm4gdWludChiKSAvIChCWVRFU18xNF9PRkZTRVQgKiBCWVRFU18xNF9PRkZTRVQpOwogICAgfQoKICAgIGZ1bmN0aW9uIGdldFJhdGVCeXRlRnJvbUNvbXBhY3REYXRhKGJ5dGVzMzIgZGF0YSwgRVJDMjAgdG9rZW4sIGJvb2wgYnV5KSBpbnRlcm5hbCB2aWV3IHJldHVybnMoaW50OCkgewogICAgICAgIHVpbnQgZmllbGRPZmZzZXQgPSB0b2tlbkRhdGFbdG9rZW5dLmNvbXBhY3REYXRhRmllbGRJbmRleDsKICAgICAgICB1aW50IGJ5dGVPZmZzZXQ7CiAgICAgICAgaWYgKGJ1eSkKICAgICAgICAgICAgYnl0ZU9mZnNldCA9IDMyIC0gTlVNX1RPS0VOU19JTl9DT01QQUNUX0RBVEEgKyBmaWVsZE9mZnNldDsKICAgICAgICBlbHNlCiAgICAgICAgICAgIGJ5dGVPZmZzZXQgPSA0ICsgZmllbGRPZmZzZXQ7CgogICAgICAgIHJldHVybiBpbnQ4KGRhdGFbYnl0ZU9mZnNldF0pOwogICAgfQoKICAgIGZ1bmN0aW9uIGV4ZWN1dGVTdGVwRnVuY3Rpb24oU3RlcEZ1bmN0aW9uIGYsIGludCB4KSBpbnRlcm5hbCBwdXJlIHJldHVybnMoaW50KSB7CiAgICAgICAgdWludCBsZW4gPSBmLnkubGVuZ3RoOwogICAgICAgIGZvciAodWludCBpbmQgPSAwOyBpbmQgPCBsZW47IGluZCsrKSB7CiAgICAgICAgICAgIGlmICh4IDw9IGYueFtpbmRdKSByZXR1cm4gZi55W2luZF07CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZi55W2xlbi0xXTsKICAgIH0KCiAgICBmdW5jdGlvbiBhZGRCcHModWludCByYXRlLCBpbnQgYnBzKSBpbnRlcm5hbCBwdXJlIHJldHVybnModWludCkgewogICAgICAgIHVpbnQgbWF4QnBzID0gMTAwICogMTAwOwogICAgICAgIHJldHVybiAocmF0ZSAqIHVpbnQoaW50KG1heEJwcykgKyBicHMpKSAvIG1heEJwczsKICAgIH0KCiAgICBmdW5jdGlvbiBhYnMoaW50IHgpIGludGVybmFsIHB1cmUgcmV0dXJucyh1aW50KSB7CiAgICAgICAgaWYgKHggPCAwKQogICAgICAgICAgICByZXR1cm4gdWludCgtMSAqIHgpOwogICAgICAgIGVsc2UKICAgICAgICAgICAgcmV0dXJuIHVpbnQoeCk7CiAgICB9Cn0KCmNvbnRyYWN0IFNhbml0eVJhdGVzIGlzIFNhbml0eVJhdGVzSW50ZXJmYWNlLCBXaXRoZHJhd2FibGUsIFV0aWxzIHsKICAgIG1hcHBpbmcoYWRkcmVzcz0+dWludCkgcHVibGljIHRva2VuUmF0ZTsKICAgIG1hcHBpbmcoYWRkcmVzcz0+dWludCkgcHVibGljIHJlYXNvbmFibGVEaWZmSW5CcHM7CgogICAgZnVuY3Rpb24gU2FuaXR5UmF0ZXMoYWRkcmVzcyBfYWRtaW4pIHB1YmxpYyB7CiAgICAgICAgcmVxdWlyZShfYWRtaW4gIT0gYWRkcmVzcygwKSk7CiAgICAgICAgYWRtaW4gPSBfYWRtaW47CiAgICB9CgogICAgZnVuY3Rpb24gc2V0UmVhc29uYWJsZURpZmYoRVJDMjBbXSBzcmNzLCB1aW50W10gZGlmZikgcHVibGljIG9ubHlBZG1pbiB7CiAgICAgICAgcmVxdWlyZShzcmNzLmxlbmd0aCA9PSBkaWZmLmxlbmd0aCk7CiAgICAgICAgZm9yICh1aW50IGkgPSAwOyBpIDwgc3Jjcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICByZWFzb25hYmxlRGlmZkluQnBzW3NyY3NbaV1dID0gZGlmZltpXTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gc2V0U2FuaXR5UmF0ZXMoRVJDMjBbXSBzcmNzLCB1aW50W10gcmF0ZXMpIHB1YmxpYyBvbmx5T3BlcmF0b3IgewogICAgICAgIHJlcXVpcmUoc3Jjcy5sZW5ndGggPT0gcmF0ZXMubGVuZ3RoKTsKCiAgICAgICAgZm9yICh1aW50IGkgPSAwOyBpIDwgc3Jjcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB0b2tlblJhdGVbc3Jjc1tpXV0gPSByYXRlc1tpXTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0U2FuaXR5UmF0ZShFUkMyMCBzcmMsIEVSQzIwIGRlc3QpIHB1YmxpYyB2aWV3IHJldHVybnModWludCkgewogICAgICAgIGlmIChzcmMgIT0gRVRIX1RPS0VOX0FERFJFU1MgJiYgZGVzdCAhPSBFVEhfVE9LRU5fQUREUkVTUykgcmV0dXJuIDA7CgogICAgICAgIHVpbnQgcmF0ZTsKICAgICAgICBhZGRyZXNzIHRva2VuOwogICAgICAgIGlmIChzcmMgPT0gRVRIX1RPS0VOX0FERFJFU1MpIHsKICAgICAgICAgICAgcmF0ZSA9IChQUkVDSVNJT04qUFJFQ0lTSU9OKS90b2tlblJhdGVbZGVzdF07CiAgICAgICAgICAgIHRva2VuID0gZGVzdDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByYXRlID0gdG9rZW5SYXRlW3NyY107CiAgICAgICAgICAgIHRva2VuID0gc3JjOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHJhdGUgKiAoMTAwMDAgKyByZWFzb25hYmxlRGlmZkluQnBzW3Rva2VuXSkvMTAwMDA7CiAgICB9Cn0KCmNvbnRyYWN0IEV4cGVjdGVkUmF0ZSBpcyBXaXRoZHJhd2FibGUsIEV4cGVjdGVkUmF0ZUludGVyZmFjZSB7CgogICAgS3liZXJOZXR3b3JrIHB1YmxpYyBreWJlck5ldHdvcms7CiAgICB1aW50IHB1YmxpYyBxdWFudGl0eUZhY3RvciA9IDI7CiAgICB1aW50IHB1YmxpYyBtaW5TbGlwcGFnZUZhY3RvckluQnBzID0gNTA7CgogICAgZnVuY3Rpb24gRXhwZWN0ZWRSYXRlKEt5YmVyTmV0d29yayBfa3liZXJOZXR3b3JrLCBhZGRyZXNzIF9hZG1pbikgcHVibGljIHsKICAgICAgICByZXF1aXJlKF9hZG1pbiAhPSBhZGRyZXNzKDApKTsKICAgICAgICByZXF1aXJlKF9reWJlck5ldHdvcmsgIT0gYWRkcmVzcygwKSk7CiAgICAgICAga3liZXJOZXR3b3JrID0gX2t5YmVyTmV0d29yazsKICAgICAgICBhZG1pbiA9IF9hZG1pbjsKICAgIH0KCiAgICBldmVudCBRdWFudGl0eUZhY3RvclNldCAodWludCBuZXdGYWN0b3IsIHVpbnQgb2xkRmFjdG9yLCBhZGRyZXNzIHNlbmRlcik7CgogICAgZnVuY3Rpb24gc2V0UXVhbnRpdHlGYWN0b3IodWludCBuZXdGYWN0b3IpIHB1YmxpYyBvbmx5T3BlcmF0b3IgewogICAgICAgIFF1YW50aXR5RmFjdG9yU2V0KHF1YW50aXR5RmFjdG9yLCBuZXdGYWN0b3IsIG1zZy5zZW5kZXIpOwogICAgICAgIHF1YW50aXR5RmFjdG9yID0gbmV3RmFjdG9yOwogICAgfQoKICAgIGV2ZW50IE1pblNsaXBwYWdlRmFjdG9yU2V0ICh1aW50IG5ld01pbiwgdWludCBvbGRNaW4sIGFkZHJlc3Mgc2VuZGVyKTsKCiAgICBmdW5jdGlvbiBzZXRNaW5TbGlwcGFnZUZhY3Rvcih1aW50IGJwcykgcHVibGljIG9ubHlPcGVyYXRvciB7CiAgICAgICAgTWluU2xpcHBhZ2VGYWN0b3JTZXQoYnBzLCBtaW5TbGlwcGFnZUZhY3RvckluQnBzLCBtc2cuc2VuZGVyKTsKICAgICAgICBtaW5TbGlwcGFnZUZhY3RvckluQnBzID0gYnBzOwogICAgfQoKICAgIGZ1bmN0aW9uIGdldEV4cGVjdGVkUmF0ZShFUkMyMCBzcmMsIEVSQzIwIGRlc3QsIHVpbnQgc3JjUXR5KQogICAgICAgIHB1YmxpYyB2aWV3CiAgICAgICAgcmV0dXJucyAodWludCBleHBlY3RlZFJhdGUsIHVpbnQgc2xpcHBhZ2VSYXRlKQogICAgewogICAgICAgIHJlcXVpcmUocXVhbnRpdHlGYWN0b3IgIT0gMCk7CgogICAgICAgIHVpbnQgYmVzdFJlc2VydmU7CiAgICAgICAgdWludCBtaW5TbGlwcGFnZTsKCiAgICAgICAgKGJlc3RSZXNlcnZlLCBleHBlY3RlZFJhdGUpID0ga3liZXJOZXR3b3JrLmZpbmRCZXN0UmF0ZShzcmMsIGRlc3QsIHNyY1F0eSk7CiAgICAgICAgKGJlc3RSZXNlcnZlLCBzbGlwcGFnZVJhdGUpID0ga3liZXJOZXR3b3JrLmZpbmRCZXN0UmF0ZShzcmMsIGRlc3QsIChzcmNRdHkgKiBxdWFudGl0eUZhY3RvcikpOwoKICAgICAgICBtaW5TbGlwcGFnZSA9ICgoMTAwMDAgLSBtaW5TbGlwcGFnZUZhY3RvckluQnBzKSAqIGV4cGVjdGVkUmF0ZSkgLyAxMDAwMDsKICAgICAgICBpZiAoc2xpcHBhZ2VSYXRlID49IG1pblNsaXBwYWdlKSB7CiAgICAgICAgICAgIHNsaXBwYWdlUmF0ZSA9IG1pblNsaXBwYWdlOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIChleHBlY3RlZFJhdGUsIHNsaXBwYWdlUmF0ZSk7CiAgICB9Cn0KCmludGVyZmFjZSBGZWVCdXJuZXJJbnRlcmZhY2UgewogICAgZnVuY3Rpb24gaGFuZGxlRmVlcyAodWludCB0cmFkZVdlaUFtb3VudCwgYWRkcmVzcyByZXNlcnZlLCBhZGRyZXNzIHdhbGxldCkgcHVibGljIHJldHVybnMoYm9vbCk7Cn0KCmNvbnRyYWN0IEZlZUJ1cm5lciBpcyBXaXRoZHJhd2FibGUsIEZlZUJ1cm5lckludGVyZmFjZSB7CgogICAgbWFwcGluZyhhZGRyZXNzPT51aW50KSBwdWJsaWMgcmVzZXJ2ZUZlZXNJbkJwczsKICAgIG1hcHBpbmcoYWRkcmVzcz0+YWRkcmVzcykgcHVibGljIHJlc2VydmVLTkNXYWxsZXQ7CiAgICBtYXBwaW5nKGFkZHJlc3M9PnVpbnQpIHB1YmxpYyB3YWxsZXRGZWVzSW5CcHM7CiAgICBtYXBwaW5nKGFkZHJlc3M9PnVpbnQpIHB1YmxpYyByZXNlcnZlRmVlVG9CdXJuOwogICAgbWFwcGluZyhhZGRyZXNzPT5tYXBwaW5nKGFkZHJlc3M9PnVpbnQpKSBwdWJsaWMgcmVzZXJ2ZUZlZVRvV2FsbGV0OwoKICAgIEJ1cm5hYmxlVG9rZW4gcHVibGljIGtuYzsKICAgIGFkZHJlc3MgcHVibGljIGt5YmVyTmV0d29yazsKICAgIHVpbnQgcHVibGljIGtuY1BlckVUSFJhdGUgPSAzMDA7CgogICAgZnVuY3Rpb24gRmVlQnVybmVyKGFkZHJlc3MgX2FkbWluLCBCdXJuYWJsZVRva2VuIGtuY1Rva2VuKSBwdWJsaWMgewogICAgICAgIHJlcXVpcmUoX2FkbWluICE9IGFkZHJlc3MoMCkpOwogICAgICAgIHJlcXVpcmUoa25jVG9rZW4gIT0gYWRkcmVzcygwKSk7CiAgICAgICAgYWRtaW4gPSBfYWRtaW47CiAgICAgICAga25jID0ga25jVG9rZW47CiAgICB9CgogICAgZnVuY3Rpb24gc2V0UmVzZXJ2ZURhdGEoYWRkcmVzcyByZXNlcnZlLCB1aW50IGZlZXNJbkJwcywgYWRkcmVzcyBrbmNXYWxsZXQpIHB1YmxpYyBvbmx5QWRtaW4gewogICAgICAgIHJlcXVpcmUoZmVlc0luQnBzIDwgMTAwKTsgLy8gbWFrZSBzdXJlIGl0IGlzIGFsd2F5cyA8IDElCiAgICAgICAgcmVxdWlyZShrbmNXYWxsZXQgIT0gYWRkcmVzcygwKSk7CiAgICAgICAgcmVzZXJ2ZUZlZXNJbkJwc1tyZXNlcnZlXSA9IGZlZXNJbkJwczsKICAgICAgICByZXNlcnZlS05DV2FsbGV0W3Jlc2VydmVdID0ga25jV2FsbGV0OwogICAgfQoKICAgIGZ1bmN0aW9uIHNldFdhbGxldEZlZXMoYWRkcmVzcyB3YWxsZXQsIHVpbnQgZmVlc0luQnBzKSBwdWJsaWMgb25seUFkbWluIHsKICAgICAgICByZXF1aXJlKGZlZXNJbkJwcyA8IDEwMDAwKTsgLy8gdW5kZXIgMTAwJQogICAgICAgIHdhbGxldEZlZXNJbkJwc1t3YWxsZXRdID0gZmVlc0luQnBzOwogICAgfQoKICAgIGZ1bmN0aW9uIHNldEt5YmVyTmV0d29yayhhZGRyZXNzIF9reWJlck5ldHdvcmspIHB1YmxpYyBvbmx5QWRtaW4gewogICAgICAgIHJlcXVpcmUoX2t5YmVyTmV0d29yayAhPSBhZGRyZXNzKDApKTsKICAgICAgICBreWJlck5ldHdvcmsgPSBfa3liZXJOZXR3b3JrOwogICAgfQoKICAgIGZ1bmN0aW9uIHNldEtOQ1JhdGUodWludCByYXRlKSBwdWJsaWMgb25seUFkbWluIHsKICAgICAgICBrbmNQZXJFVEhSYXRlID0gcmF0ZTsKICAgIH0KCiAgICBldmVudCBBc3NpZ25GZWVUb1dhbGxldChhZGRyZXNzIHJlc2VydmUsIGFkZHJlc3Mgd2FsbGV0LCB1aW50IHdhbGxldEZlZSk7CiAgICBldmVudCBBc3NpZ25CdXJuRmVlcyhhZGRyZXNzIHJlc2VydmUsIHVpbnQgYnVybkZlZSk7CgogICAgZnVuY3Rpb24gaGFuZGxlRmVlcyh1aW50IHRyYWRlV2VpQW1vdW50LCBhZGRyZXNzIHJlc2VydmUsIGFkZHJlc3Mgd2FsbGV0KSBwdWJsaWMgcmV0dXJucyhib29sKSB7CiAgICAgICAgcmVxdWlyZShtc2cuc2VuZGVyID09IGt5YmVyTmV0d29yayk7CgogICAgICAgIHVpbnQga25jQW1vdW50ID0gdHJhZGVXZWlBbW91bnQgKiBrbmNQZXJFVEhSYXRlOwogICAgICAgIHVpbnQgZmVlID0ga25jQW1vdW50ICogcmVzZXJ2ZUZlZXNJbkJwc1tyZXNlcnZlXSAvIDEwMDAwOwoKICAgICAgICB1aW50IHdhbGxldEZlZSA9IGZlZSAqIHdhbGxldEZlZXNJbkJwc1t3YWxsZXRdIC8gMTAwMDA7CiAgICAgICAgcmVxdWlyZShmZWUgPj0gd2FsbGV0RmVlKTsKICAgICAgICB1aW50IGZlZVRvQnVybiA9IGZlZSAtIHdhbGxldEZlZTsKCiAgICAgICAgaWYgKHdhbGxldEZlZSA+IDApIHsKICAgICAgICAgICAgcmVzZXJ2ZUZlZVRvV2FsbGV0W3Jlc2VydmVdW3dhbGxldF0gKz0gd2FsbGV0RmVlOwogICAgICAgICAgICBBc3NpZ25GZWVUb1dhbGxldChyZXNlcnZlLCB3YWxsZXQsIHdhbGxldEZlZSk7CiAgICAgICAgfQoKICAgICAgICBpZiAoZmVlVG9CdXJuID4gMCkgewogICAgICAgICAgICBBc3NpZ25CdXJuRmVlcyhyZXNlcnZlLCBmZWVUb0J1cm4pOwogICAgICAgICAgICByZXNlcnZlRmVlVG9CdXJuW3Jlc2VydmVdICs9IGZlZVRvQnVybjsKICAgICAgICB9CgogICAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIC8vIHRoaXMgZnVuY3Rpb24gaXMgY2FsbGFibGUgYnkgYW55b25lCiAgICBldmVudCBCdXJuQXNzaWduZWRGZWVzKGFkZHJlc3MgaW5kZXhlZCByZXNlcnZlLCBhZGRyZXNzIHNlbmRlcik7CgogICAgZnVuY3Rpb24gYnVyblJlc2VydmVGZWVzKGFkZHJlc3MgcmVzZXJ2ZSkgcHVibGljIHsKICAgICAgICB1aW50IGJ1cm5BbW91bnQgPSByZXNlcnZlRmVlVG9CdXJuW3Jlc2VydmVdOwogICAgICAgIHJlcXVpcmUoYnVybkFtb3VudCA+IDEpOwogICAgICAgIHJlc2VydmVGZWVUb0J1cm5bcmVzZXJ2ZV0gPSAxOyAvLyBsZWF2ZSAxIHR3ZWkgdG8gYXZvaWQgc3Bpa2VzIGluIGdhcyBmZWUKICAgICAgICByZXF1aXJlKGtuYy5idXJuRnJvbShyZXNlcnZlS05DV2FsbGV0W3Jlc2VydmVdLCBidXJuQW1vdW50IC0gMSkpOwoKICAgICAgICBCdXJuQXNzaWduZWRGZWVzKHJlc2VydmUsIG1zZy5zZW5kZXIpOwogICAgfQoKICAgIGV2ZW50IFNlbmRXYWxsZXRGZWVzKGFkZHJlc3MgaW5kZXhlZCB3YWxsZXQsIGFkZHJlc3MgcmVzZXJ2ZSwgYWRkcmVzcyBzZW5kZXIpOwoKICAgIC8vIHRoaXMgZnVuY3Rpb24gaXMgY2FsbGFibGUgYnkgYW55b25lCiAgICBmdW5jdGlvbiBzZW5kRmVlVG9XYWxsZXQoYWRkcmVzcyB3YWxsZXQsIGFkZHJlc3MgcmVzZXJ2ZSkgcHVibGljIHsKICAgICAgICB1aW50IGZlZUFtb3VudCA9IHJlc2VydmVGZWVUb1dhbGxldFtyZXNlcnZlXVt3YWxsZXRdOwogICAgICAgIHJlcXVpcmUoZmVlQW1vdW50ID4gMSk7CiAgICAgICAgcmVzZXJ2ZUZlZVRvV2FsbGV0W3Jlc2VydmVdW3dhbGxldF0gPSAxOyAvLyBsZWF2ZSAxIHR3ZWkgdG8gYXZvaWQgc3Bpa2VzIGluIGdhcyBmZWUKICAgICAgICByZXF1aXJlKGtuYy50cmFuc2ZlckZyb20ocmVzZXJ2ZUtOQ1dhbGxldFtyZXNlcnZlXSwgd2FsbGV0LCBmZWVBbW91bnQgLSAxKSk7CgogICAgICAgIFNlbmRXYWxsZXRGZWVzKHdhbGxldCwgcmVzZXJ2ZSwgbXNnLnNlbmRlcik7CiAgICB9Cn0KCmNvbnRyYWN0IFdoaXRlTGlzdCBpcyBXaXRoZHJhd2FibGUgewoKICAgIHVpbnQgcHVibGljIHdlaVBlclNnZDsgLy8gYW1vdW50IG9mIHdlaXMgaW4gMSBzaW5nYXBvcmUgZG9sbGFyCiAgICBtYXBwaW5nIChhZGRyZXNzPT51aW50KSBwdWJsaWMgdXNlckNhdGVnb3J5OyAvLyBlYWNoIHVzZXIgaGFzIGEgY2F0ZWdvcnkgZGVmaW5pbmcgY2FwIG9uIHRyYWRlLiAwIGZvciBzdGFuZGFyZC4KICAgIG1hcHBpbmcgKHVpbnQ9PnVpbnQpICAgIHB1YmxpYyBjYXRlZ29yeUNhcDsgIC8vIHdpbGwgZGVmaW5lIGNhcCBvbiB0cmFkZSBhbW91bnQgcGVyIGNhdGVnb3J5IGluIHNpbmdhcG9yZSBEb2xsYXIuCgogICAgZnVuY3Rpb24gV2hpdGVMaXN0KGFkZHJlc3MgX2FkbWluKSBwdWJsaWMgewogICAgICAgIHJlcXVpcmUoX2FkbWluICE9IGFkZHJlc3MoMCkpOwogICAgICAgIGFkbWluID0gX2FkbWluOwogICAgfQoKICAgIGZ1bmN0aW9uIGdldFVzZXJDYXBJbldlaShhZGRyZXNzIHVzZXIpIGV4dGVybmFsIHZpZXcgcmV0dXJucyAodWludCB1c2VyQ2FwV2VpKSB7CiAgICAgICAgdWludCBjYXRlZ29yeSA9IHVzZXJDYXRlZ29yeVt1c2VyXTsKICAgICAgICByZXR1cm4gKGNhdGVnb3J5Q2FwW2NhdGVnb3J5XSAqIHdlaVBlclNnZCk7CiAgICB9CgogICAgZXZlbnQgVXNlckNhdGVnb3J5U2V0KGFkZHJlc3MgdXNlciwgdWludCBjYXRlZ29yeSk7CgogICAgZnVuY3Rpb24gc2V0VXNlckNhdGVnb3J5KGFkZHJlc3MgdXNlciwgdWludCBjYXRlZ29yeSkgcHVibGljIG9ubHlPcGVyYXRvciB7CiAgICAgICAgdXNlckNhdGVnb3J5W3VzZXJdID0gY2F0ZWdvcnk7CiAgICAgICAgVXNlckNhdGVnb3J5U2V0KHVzZXIsIGNhdGVnb3J5KTsKICAgIH0KCiAgICBldmVudCBDYXRlZ29yeUNhcFNldCAodWludCBjYXRlZ29yeSwgdWludCBzZ2RDYXApOwoKICAgIGZ1bmN0aW9uIHNldENhdGVnb3J5Q2FwKHVpbnQgY2F0ZWdvcnksIHVpbnQgc2dkQ2FwKSBwdWJsaWMgb25seU9wZXJhdG9yIHsKICAgICAgICBjYXRlZ29yeUNhcFtjYXRlZ29yeV0gPSBzZ2RDYXA7CiAgICAgICAgQ2F0ZWdvcnlDYXBTZXQoY2F0ZWdvcnksIHNnZENhcCk7CiAgICB9CgogICAgZXZlbnQgU2dkVG9XZWlSYXRlU2V0ICh1aW50IHJhdGUpOwoKICAgIGZ1bmN0aW9uIHNldFNnZFRvRXRoUmF0ZSh1aW50IF9zZ2RUb1dlaVJhdGUpIHB1YmxpYyBvbmx5T3BlcmF0b3IgewogICAgICAgIHdlaVBlclNnZCA9IF9zZ2RUb1dlaVJhdGU7CiAgICAgICAgU2dkVG9XZWlSYXRlU2V0KF9zZ2RUb1dlaVJhdGUpOwogICAgfQp9'.
	

]
