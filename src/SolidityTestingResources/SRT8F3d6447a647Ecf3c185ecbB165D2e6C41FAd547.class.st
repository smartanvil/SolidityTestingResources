Class {
	#name : #SRT8F3d6447a647Ecf3c185ecbB165D2e6C41FAd547,
	#superclass : #SRTContracts,
	#category : #SolidityTestingResources
}

{ #category : #base64 }
SRT8F3d6447a647Ecf3c185ecbB165D2e6C41FAd547 >> base64 [
	^ 'cHJhZ21hIHNvbGlkaXR5IF4wLjQuMjsKCi8vIDxPUkFDTElaRV9BUEk+Ci8qCkNvcHlyaWdodCAoYykgMjAxNS0yMDE2IE9yYWNsaXplIFNSTApDb3B5cmlnaHQgKGMpIDIwMTYgT3JhY2xpemUgTFRECgoKClBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHkKb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgIlNvZnR3YXJlIiksIHRvIGRlYWwKaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cwp0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsCmNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcwpmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOgoKCgpUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbgphbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KCgoKVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1IKSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksCkZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuICBJTiBOTyBFVkVOVCBTSEFMTCBUSEUKQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUgpMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLApPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOClRIRSBTT0ZUV0FSRS4KKi8KCmNvbnRyYWN0IE9yYWNsaXplSSB7CiAgICBhZGRyZXNzIHB1YmxpYyBjYkFkZHJlc3M7CiAgICBmdW5jdGlvbiBxdWVyeSh1aW50IF90aW1lc3RhbXAsIHN0cmluZyBfZGF0YXNvdXJjZSwgc3RyaW5nIF9hcmcpIHBheWFibGUgcmV0dXJucyAoYnl0ZXMzMiBfaWQpOwogICAgZnVuY3Rpb24gcXVlcnlfd2l0aEdhc0xpbWl0KHVpbnQgX3RpbWVzdGFtcCwgc3RyaW5nIF9kYXRhc291cmNlLCBzdHJpbmcgX2FyZywgdWludCBfZ2FzbGltaXQpIHBheWFibGUgcmV0dXJucyAoYnl0ZXMzMiBfaWQpOwogICAgZnVuY3Rpb24gcXVlcnkyKHVpbnQgX3RpbWVzdGFtcCwgc3RyaW5nIF9kYXRhc291cmNlLCBzdHJpbmcgX2FyZzEsIHN0cmluZyBfYXJnMikgcGF5YWJsZSByZXR1cm5zIChieXRlczMyIF9pZCk7CiAgICBmdW5jdGlvbiBxdWVyeTJfd2l0aEdhc0xpbWl0KHVpbnQgX3RpbWVzdGFtcCwgc3RyaW5nIF9kYXRhc291cmNlLCBzdHJpbmcgX2FyZzEsIHN0cmluZyBfYXJnMiwgdWludCBfZ2FzbGltaXQpIHBheWFibGUgcmV0dXJucyAoYnl0ZXMzMiBfaWQpOwogICAgZnVuY3Rpb24gcXVlcnlOKHVpbnQgX3RpbWVzdGFtcCwgc3RyaW5nIF9kYXRhc291cmNlLCBieXRlcyBfYXJnTikgcGF5YWJsZSByZXR1cm5zIChieXRlczMyIF9pZCk7CiAgICBmdW5jdGlvbiBxdWVyeU5fd2l0aEdhc0xpbWl0KHVpbnQgX3RpbWVzdGFtcCwgc3RyaW5nIF9kYXRhc291cmNlLCBieXRlcyBfYXJnTiwgdWludCBfZ2FzbGltaXQpIHBheWFibGUgcmV0dXJucyAoYnl0ZXMzMiBfaWQpOwogICAgZnVuY3Rpb24gZ2V0UHJpY2Uoc3RyaW5nIF9kYXRhc291cmNlKSByZXR1cm5zICh1aW50IF9kc3ByaWNlKTsKICAgIGZ1bmN0aW9uIGdldFByaWNlKHN0cmluZyBfZGF0YXNvdXJjZSwgdWludCBnYXNsaW1pdCkgcmV0dXJucyAodWludCBfZHNwcmljZSk7CiAgICBmdW5jdGlvbiB1c2VDb3Vwb24oc3RyaW5nIF9jb3Vwb24pOwogICAgZnVuY3Rpb24gc2V0UHJvb2ZUeXBlKGJ5dGUgX3Byb29mVHlwZSk7CiAgICBmdW5jdGlvbiBzZXRDb25maWcoYnl0ZXMzMiBfY29uZmlnKTsKICAgIGZ1bmN0aW9uIHNldEN1c3RvbUdhc1ByaWNlKHVpbnQgX2dhc1ByaWNlKTsKfQpjb250cmFjdCBPcmFjbGl6ZUFkZHJSZXNvbHZlckkgewogICAgZnVuY3Rpb24gZ2V0QWRkcmVzcygpIHJldHVybnMgKGFkZHJlc3MgX2FkZHIpOwp9CmNvbnRyYWN0IHVzaW5nT3JhY2xpemUgewogICAgdWludCBjb25zdGFudCBkYXkgPSA2MCo2MCoyNDsKICAgIHVpbnQgY29uc3RhbnQgd2VlayA9IDYwKjYwKjI0Kjc7CiAgICB1aW50IGNvbnN0YW50IG1vbnRoID0gNjAqNjAqMjQqMzA7CiAgICBieXRlIGNvbnN0YW50IHByb29mVHlwZV9OT05FID0gMHgwMDsKICAgIGJ5dGUgY29uc3RhbnQgcHJvb2ZUeXBlX1RMU05vdGFyeSA9IDB4MTA7CiAgICBieXRlIGNvbnN0YW50IHByb29mU3RvcmFnZV9JUEZTID0gMHgwMTsKICAgIHVpbnQ4IGNvbnN0YW50IG5ldHdvcmtJRF9hdXRvID0gMDsKICAgIHVpbnQ4IGNvbnN0YW50IG5ldHdvcmtJRF9tYWlubmV0ID0gMTsKICAgIHVpbnQ4IGNvbnN0YW50IG5ldHdvcmtJRF90ZXN0bmV0ID0gMjsKICAgIHVpbnQ4IGNvbnN0YW50IG5ldHdvcmtJRF9tb3JkZW4gPSAyOwogICAgdWludDggY29uc3RhbnQgbmV0d29ya0lEX2NvbnNlbnN5cyA9IDE2MTsKCiAgICBPcmFjbGl6ZUFkZHJSZXNvbHZlckkgT0FSOwoKICAgIE9yYWNsaXplSSBvcmFjbGl6ZTsKICAgIG1vZGlmaWVyIG9yYWNsaXplQVBJIHsKICAgICAgICBpZigoYWRkcmVzcyhPQVIpPT0wKXx8KGdldENvZGVTaXplKGFkZHJlc3MoT0FSKSk9PTApKSBvcmFjbGl6ZV9zZXROZXR3b3JrKG5ldHdvcmtJRF9hdXRvKTsKICAgICAgICBvcmFjbGl6ZSA9IE9yYWNsaXplSShPQVIuZ2V0QWRkcmVzcygpKTsKICAgICAgICBfOwogICAgfQogICAgbW9kaWZpZXIgY291cG9uKHN0cmluZyBjb2RlKXsKICAgICAgICBvcmFjbGl6ZSA9IE9yYWNsaXplSShPQVIuZ2V0QWRkcmVzcygpKTsKICAgICAgICBvcmFjbGl6ZS51c2VDb3Vwb24oY29kZSk7CiAgICAgICAgXzsKICAgIH0KCiAgICBmdW5jdGlvbiBvcmFjbGl6ZV9zZXROZXR3b3JrKHVpbnQ4IG5ldHdvcmtJRCkgaW50ZXJuYWwgcmV0dXJucyhib29sKXsKICAgICAgICBpZiAoZ2V0Q29kZVNpemUoMHgxZDNCMjYzOGE3Y0M5ZjJDQjNEMjk4QTNEQTdhOTBCNjdFNTUwNmVkKT4wKXsgLy9tYWlubmV0CiAgICAgICAgICAgIE9BUiA9IE9yYWNsaXplQWRkclJlc29sdmVySSgweDFkM0IyNjM4YTdjQzlmMkNCM0QyOThBM0RBN2E5MEI2N0U1NTA2ZWQpOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgaWYgKGdldENvZGVTaXplKDB4YzAzQTI2MTVENWVmYWY1RjQ5RjYwQjdCQjY1ODNlYWVjMjEyZmRmMSk+MCl7IC8vcm9wc3RlbiB0ZXN0bmV0CiAgICAgICAgICAgIE9BUiA9IE9yYWNsaXplQWRkclJlc29sdmVySSgweGMwM0EyNjE1RDVlZmFmNUY0OUY2MEI3QkI2NTgzZWFlYzIxMmZkZjEpOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgaWYgKGdldENvZGVTaXplKDB4QjdBMDdCY0YyQmEyZjI3MDNiMjRDMDY5MWI1Mjc4OTk5QzU5QUM3ZSk+MCl7IC8va292YW4gdGVzdG5ldAogICAgICAgICAgICBPQVIgPSBPcmFjbGl6ZUFkZHJSZXNvbHZlckkoMHhCN0EwN0JjRjJCYTJmMjcwM2IyNEMwNjkxYjUyNzg5OTlDNTlBQzdlKTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGlmIChnZXRDb2RlU2l6ZSgweDZmNDg1QzhCRjZmYzQzZUEyMTJFOTNCQkY4Y2UwNDZDN2YxY2I0NzUpPjApeyAvL2V0aGVyZXVtLWJyaWRnZQogICAgICAgICAgICBPQVIgPSBPcmFjbGl6ZUFkZHJSZXNvbHZlckkoMHg2ZjQ4NUM4QkY2ZmM0M2VBMjEyRTkzQkJGOGNlMDQ2QzdmMWNiNDc1KTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGlmIChnZXRDb2RlU2l6ZSgweDIwZTEyQTFGODU5QjNGZWFFNUZiMkEwQTMyQzE4RjVhNjU1NTViQkYpPjApeyAvL2V0aGVyLmNhbXAgaWRlCiAgICAgICAgICAgIE9BUiA9IE9yYWNsaXplQWRkclJlc29sdmVySSgweDIwZTEyQTFGODU5QjNGZWFFNUZiMkEwQTMyQzE4RjVhNjU1NTViQkYpOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgaWYgKGdldENvZGVTaXplKDB4NTFlZmFGNGM4QjNDOUFmQkQ1YUI5RjRiYkM4Mjc4NEFiNmVmOGZBQSk+MCl7IC8vYnJvd3Nlci1zb2xpZGl0eQogICAgICAgICAgICBPQVIgPSBPcmFjbGl6ZUFkZHJSZXNvbHZlckkoMHg1MWVmYUY0YzhCM0M5QWZCRDVhQjlGNGJiQzgyNzg0QWI2ZWY4ZkFBKTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICBmdW5jdGlvbiBfX2NhbGxiYWNrKGJ5dGVzMzIgbXlpZCwgc3RyaW5nIHJlc3VsdCkgewogICAgICAgIF9fY2FsbGJhY2sobXlpZCwgcmVzdWx0LCBuZXcgYnl0ZXMoMCkpOwogICAgfQogICAgZnVuY3Rpb24gX19jYWxsYmFjayhieXRlczMyIG15aWQsIHN0cmluZyByZXN1bHQsIGJ5dGVzIHByb29mKSB7CiAgICB9CgogICAgZnVuY3Rpb24gb3JhY2xpemVfZ2V0UHJpY2Uoc3RyaW5nIGRhdGFzb3VyY2UpIG9yYWNsaXplQVBJIGludGVybmFsIHJldHVybnMgKHVpbnQpewogICAgICAgIHJldHVybiBvcmFjbGl6ZS5nZXRQcmljZShkYXRhc291cmNlKTsKICAgIH0KCiAgICBmdW5jdGlvbiBvcmFjbGl6ZV9nZXRQcmljZShzdHJpbmcgZGF0YXNvdXJjZSwgdWludCBnYXNsaW1pdCkgb3JhY2xpemVBUEkgaW50ZXJuYWwgcmV0dXJucyAodWludCl7CiAgICAgICAgcmV0dXJuIG9yYWNsaXplLmdldFByaWNlKGRhdGFzb3VyY2UsIGdhc2xpbWl0KTsKICAgIH0KICAgIAogICAgZnVuY3Rpb24gb3JhY2xpemVfcXVlcnkoc3RyaW5nIGRhdGFzb3VyY2UsIHN0cmluZyBhcmcpIG9yYWNsaXplQVBJIGludGVybmFsIHJldHVybnMgKGJ5dGVzMzIgaWQpewogICAgICAgIHVpbnQgcHJpY2UgPSBvcmFjbGl6ZS5nZXRQcmljZShkYXRhc291cmNlKTsKICAgICAgICBpZiAocHJpY2UgPiAxIGV0aGVyICsgdHguZ2FzcHJpY2UqMjAwMDAwKSByZXR1cm4gMDsgLy8gdW5leHBlY3RlZGx5IGhpZ2ggcHJpY2UKICAgICAgICByZXR1cm4gb3JhY2xpemUucXVlcnkudmFsdWUocHJpY2UpKDAsIGRhdGFzb3VyY2UsIGFyZyk7CiAgICB9CiAgICBmdW5jdGlvbiBvcmFjbGl6ZV9xdWVyeSh1aW50IHRpbWVzdGFtcCwgc3RyaW5nIGRhdGFzb3VyY2UsIHN0cmluZyBhcmcpIG9yYWNsaXplQVBJIGludGVybmFsIHJldHVybnMgKGJ5dGVzMzIgaWQpewogICAgICAgIHVpbnQgcHJpY2UgPSBvcmFjbGl6ZS5nZXRQcmljZShkYXRhc291cmNlKTsKICAgICAgICBpZiAocHJpY2UgPiAxIGV0aGVyICsgdHguZ2FzcHJpY2UqMjAwMDAwKSByZXR1cm4gMDsgLy8gdW5leHBlY3RlZGx5IGhpZ2ggcHJpY2UKICAgICAgICByZXR1cm4gb3JhY2xpemUucXVlcnkudmFsdWUocHJpY2UpKHRpbWVzdGFtcCwgZGF0YXNvdXJjZSwgYXJnKTsKICAgIH0KICAgIGZ1bmN0aW9uIG9yYWNsaXplX3F1ZXJ5KHVpbnQgdGltZXN0YW1wLCBzdHJpbmcgZGF0YXNvdXJjZSwgc3RyaW5nIGFyZywgdWludCBnYXNsaW1pdCkgb3JhY2xpemVBUEkgaW50ZXJuYWwgcmV0dXJucyAoYnl0ZXMzMiBpZCl7CiAgICAgICAgdWludCBwcmljZSA9IG9yYWNsaXplLmdldFByaWNlKGRhdGFzb3VyY2UsIGdhc2xpbWl0KTsKICAgICAgICBpZiAocHJpY2UgPiAxIGV0aGVyICsgdHguZ2FzcHJpY2UqZ2FzbGltaXQpIHJldHVybiAwOyAvLyB1bmV4cGVjdGVkbHkgaGlnaCBwcmljZQogICAgICAgIHJldHVybiBvcmFjbGl6ZS5xdWVyeV93aXRoR2FzTGltaXQudmFsdWUocHJpY2UpKHRpbWVzdGFtcCwgZGF0YXNvdXJjZSwgYXJnLCBnYXNsaW1pdCk7CiAgICB9CiAgICBmdW5jdGlvbiBvcmFjbGl6ZV9xdWVyeShzdHJpbmcgZGF0YXNvdXJjZSwgc3RyaW5nIGFyZywgdWludCBnYXNsaW1pdCkgb3JhY2xpemVBUEkgaW50ZXJuYWwgcmV0dXJucyAoYnl0ZXMzMiBpZCl7CiAgICAgICAgdWludCBwcmljZSA9IG9yYWNsaXplLmdldFByaWNlKGRhdGFzb3VyY2UsIGdhc2xpbWl0KTsKICAgICAgICBpZiAocHJpY2UgPiAxIGV0aGVyICsgdHguZ2FzcHJpY2UqZ2FzbGltaXQpIHJldHVybiAwOyAvLyB1bmV4cGVjdGVkbHkgaGlnaCBwcmljZQogICAgICAgIHJldHVybiBvcmFjbGl6ZS5xdWVyeV93aXRoR2FzTGltaXQudmFsdWUocHJpY2UpKDAsIGRhdGFzb3VyY2UsIGFyZywgZ2FzbGltaXQpOwogICAgfQogICAgZnVuY3Rpb24gb3JhY2xpemVfcXVlcnkoc3RyaW5nIGRhdGFzb3VyY2UsIHN0cmluZyBhcmcxLCBzdHJpbmcgYXJnMikgb3JhY2xpemVBUEkgaW50ZXJuYWwgcmV0dXJucyAoYnl0ZXMzMiBpZCl7CiAgICAgICAgdWludCBwcmljZSA9IG9yYWNsaXplLmdldFByaWNlKGRhdGFzb3VyY2UpOwogICAgICAgIGlmIChwcmljZSA+IDEgZXRoZXIgKyB0eC5nYXNwcmljZSoyMDAwMDApIHJldHVybiAwOyAvLyB1bmV4cGVjdGVkbHkgaGlnaCBwcmljZQogICAgICAgIHJldHVybiBvcmFjbGl6ZS5xdWVyeTIudmFsdWUocHJpY2UpKDAsIGRhdGFzb3VyY2UsIGFyZzEsIGFyZzIpOwogICAgfQogICAgZnVuY3Rpb24gb3JhY2xpemVfcXVlcnkodWludCB0aW1lc3RhbXAsIHN0cmluZyBkYXRhc291cmNlLCBzdHJpbmcgYXJnMSwgc3RyaW5nIGFyZzIpIG9yYWNsaXplQVBJIGludGVybmFsIHJldHVybnMgKGJ5dGVzMzIgaWQpewogICAgICAgIHVpbnQgcHJpY2UgPSBvcmFjbGl6ZS5nZXRQcmljZShkYXRhc291cmNlKTsKICAgICAgICBpZiAocHJpY2UgPiAxIGV0aGVyICsgdHguZ2FzcHJpY2UqMjAwMDAwKSByZXR1cm4gMDsgLy8gdW5leHBlY3RlZGx5IGhpZ2ggcHJpY2UKICAgICAgICByZXR1cm4gb3JhY2xpemUucXVlcnkyLnZhbHVlKHByaWNlKSh0aW1lc3RhbXAsIGRhdGFzb3VyY2UsIGFyZzEsIGFyZzIpOwogICAgfQogICAgZnVuY3Rpb24gb3JhY2xpemVfcXVlcnkodWludCB0aW1lc3RhbXAsIHN0cmluZyBkYXRhc291cmNlLCBzdHJpbmcgYXJnMSwgc3RyaW5nIGFyZzIsIHVpbnQgZ2FzbGltaXQpIG9yYWNsaXplQVBJIGludGVybmFsIHJldHVybnMgKGJ5dGVzMzIgaWQpewogICAgICAgIHVpbnQgcHJpY2UgPSBvcmFjbGl6ZS5nZXRQcmljZShkYXRhc291cmNlLCBnYXNsaW1pdCk7CiAgICAgICAgaWYgKHByaWNlID4gMSBldGhlciArIHR4Lmdhc3ByaWNlKmdhc2xpbWl0KSByZXR1cm4gMDsgLy8gdW5leHBlY3RlZGx5IGhpZ2ggcHJpY2UKICAgICAgICByZXR1cm4gb3JhY2xpemUucXVlcnkyX3dpdGhHYXNMaW1pdC52YWx1ZShwcmljZSkodGltZXN0YW1wLCBkYXRhc291cmNlLCBhcmcxLCBhcmcyLCBnYXNsaW1pdCk7CiAgICB9CiAgICBmdW5jdGlvbiBvcmFjbGl6ZV9xdWVyeShzdHJpbmcgZGF0YXNvdXJjZSwgc3RyaW5nIGFyZzEsIHN0cmluZyBhcmcyLCB1aW50IGdhc2xpbWl0KSBvcmFjbGl6ZUFQSSBpbnRlcm5hbCByZXR1cm5zIChieXRlczMyIGlkKXsKICAgICAgICB1aW50IHByaWNlID0gb3JhY2xpemUuZ2V0UHJpY2UoZGF0YXNvdXJjZSwgZ2FzbGltaXQpOwogICAgICAgIGlmIChwcmljZSA+IDEgZXRoZXIgKyB0eC5nYXNwcmljZSpnYXNsaW1pdCkgcmV0dXJuIDA7IC8vIHVuZXhwZWN0ZWRseSBoaWdoIHByaWNlCiAgICAgICAgcmV0dXJuIG9yYWNsaXplLnF1ZXJ5Ml93aXRoR2FzTGltaXQudmFsdWUocHJpY2UpKDAsIGRhdGFzb3VyY2UsIGFyZzEsIGFyZzIsIGdhc2xpbWl0KTsKICAgIH0KICAgIGZ1bmN0aW9uIG9yYWNsaXplX3F1ZXJ5KHN0cmluZyBkYXRhc291cmNlLCBzdHJpbmdbXSBhcmdOKSBvcmFjbGl6ZUFQSSBpbnRlcm5hbCByZXR1cm5zIChieXRlczMyIGlkKXsKICAgICAgICB1aW50IHByaWNlID0gb3JhY2xpemUuZ2V0UHJpY2UoZGF0YXNvdXJjZSk7CiAgICAgICAgaWYgKHByaWNlID4gMSBldGhlciArIHR4Lmdhc3ByaWNlKjIwMDAwMCkgcmV0dXJuIDA7IC8vIHVuZXhwZWN0ZWRseSBoaWdoIHByaWNlCiAgICAgICAgYnl0ZXMgbWVtb3J5IGFyZ3MgPSBzdHJhMmNib3IoYXJnTik7CiAgICAgICAgcmV0dXJuIG9yYWNsaXplLnF1ZXJ5Ti52YWx1ZShwcmljZSkoMCwgZGF0YXNvdXJjZSwgYXJncyk7CiAgICB9CiAgICBmdW5jdGlvbiBvcmFjbGl6ZV9xdWVyeSh1aW50IHRpbWVzdGFtcCwgc3RyaW5nIGRhdGFzb3VyY2UsIHN0cmluZ1tdIGFyZ04pIG9yYWNsaXplQVBJIGludGVybmFsIHJldHVybnMgKGJ5dGVzMzIgaWQpewogICAgICAgIHVpbnQgcHJpY2UgPSBvcmFjbGl6ZS5nZXRQcmljZShkYXRhc291cmNlKTsKICAgICAgICBpZiAocHJpY2UgPiAxIGV0aGVyICsgdHguZ2FzcHJpY2UqMjAwMDAwKSByZXR1cm4gMDsgLy8gdW5leHBlY3RlZGx5IGhpZ2ggcHJpY2UKICAgICAgICBieXRlcyBtZW1vcnkgYXJncyA9IHN0cmEyY2JvcihhcmdOKTsKICAgICAgICByZXR1cm4gb3JhY2xpemUucXVlcnlOLnZhbHVlKHByaWNlKSh0aW1lc3RhbXAsIGRhdGFzb3VyY2UsIGFyZ3MpOwogICAgfQogICAgZnVuY3Rpb24gb3JhY2xpemVfcXVlcnkodWludCB0aW1lc3RhbXAsIHN0cmluZyBkYXRhc291cmNlLCBzdHJpbmdbXSBhcmdOLCB1aW50IGdhc2xpbWl0KSBvcmFjbGl6ZUFQSSBpbnRlcm5hbCByZXR1cm5zIChieXRlczMyIGlkKXsKICAgICAgICB1aW50IHByaWNlID0gb3JhY2xpemUuZ2V0UHJpY2UoZGF0YXNvdXJjZSwgZ2FzbGltaXQpOwogICAgICAgIGlmIChwcmljZSA+IDEgZXRoZXIgKyB0eC5nYXNwcmljZSpnYXNsaW1pdCkgcmV0dXJuIDA7IC8vIHVuZXhwZWN0ZWRseSBoaWdoIHByaWNlCiAgICAgICAgYnl0ZXMgbWVtb3J5IGFyZ3MgPSBzdHJhMmNib3IoYXJnTik7CiAgICAgICAgcmV0dXJuIG9yYWNsaXplLnF1ZXJ5Tl93aXRoR2FzTGltaXQudmFsdWUocHJpY2UpKHRpbWVzdGFtcCwgZGF0YXNvdXJjZSwgYXJncywgZ2FzbGltaXQpOwogICAgfQogICAgZnVuY3Rpb24gb3JhY2xpemVfcXVlcnkoc3RyaW5nIGRhdGFzb3VyY2UsIHN0cmluZ1tdIGFyZ04sIHVpbnQgZ2FzbGltaXQpIG9yYWNsaXplQVBJIGludGVybmFsIHJldHVybnMgKGJ5dGVzMzIgaWQpewogICAgICAgIHVpbnQgcHJpY2UgPSBvcmFjbGl6ZS5nZXRQcmljZShkYXRhc291cmNlLCBnYXNsaW1pdCk7CiAgICAgICAgaWYgKHByaWNlID4gMSBldGhlciArIHR4Lmdhc3ByaWNlKmdhc2xpbWl0KSByZXR1cm4gMDsgLy8gdW5leHBlY3RlZGx5IGhpZ2ggcHJpY2UKICAgICAgICBieXRlcyBtZW1vcnkgYXJncyA9IHN0cmEyY2JvcihhcmdOKTsKICAgICAgICByZXR1cm4gb3JhY2xpemUucXVlcnlOX3dpdGhHYXNMaW1pdC52YWx1ZShwcmljZSkoMCwgZGF0YXNvdXJjZSwgYXJncywgZ2FzbGltaXQpOwogICAgfQogICAgZnVuY3Rpb24gb3JhY2xpemVfcXVlcnkoc3RyaW5nIGRhdGFzb3VyY2UsIHN0cmluZ1sxXSBhcmdzKSBvcmFjbGl6ZUFQSSBpbnRlcm5hbCByZXR1cm5zIChieXRlczMyIGlkKSB7CiAgICAgICAgc3RyaW5nW10gbWVtb3J5IGR5bmFyZ3MgPSBuZXcgc3RyaW5nW10oMSk7CiAgICAgICAgZHluYXJnc1swXSA9IGFyZ3NbMF07CiAgICAgICAgcmV0dXJuIG9yYWNsaXplX3F1ZXJ5KGRhdGFzb3VyY2UsIGR5bmFyZ3MpOwogICAgfQogICAgZnVuY3Rpb24gb3JhY2xpemVfcXVlcnkodWludCB0aW1lc3RhbXAsIHN0cmluZyBkYXRhc291cmNlLCBzdHJpbmdbMV0gYXJncykgb3JhY2xpemVBUEkgaW50ZXJuYWwgcmV0dXJucyAoYnl0ZXMzMiBpZCkgewogICAgICAgIHN0cmluZ1tdIG1lbW9yeSBkeW5hcmdzID0gbmV3IHN0cmluZ1tdKDEpOwogICAgICAgIGR5bmFyZ3NbMF0gPSBhcmdzWzBdOwogICAgICAgIHJldHVybiBvcmFjbGl6ZV9xdWVyeSh0aW1lc3RhbXAsIGRhdGFzb3VyY2UsIGR5bmFyZ3MpOwogICAgfQogICAgZnVuY3Rpb24gb3JhY2xpemVfcXVlcnkodWludCB0aW1lc3RhbXAsIHN0cmluZyBkYXRhc291cmNlLCBzdHJpbmdbMV0gYXJncywgdWludCBnYXNsaW1pdCkgb3JhY2xpemVBUEkgaW50ZXJuYWwgcmV0dXJucyAoYnl0ZXMzMiBpZCkgewogICAgICAgIHN0cmluZ1tdIG1lbW9yeSBkeW5hcmdzID0gbmV3IHN0cmluZ1tdKDEpOwogICAgICAgIGR5bmFyZ3NbMF0gPSBhcmdzWzBdOwogICAgICAgIHJldHVybiBvcmFjbGl6ZV9xdWVyeSh0aW1lc3RhbXAsIGRhdGFzb3VyY2UsIGR5bmFyZ3MsIGdhc2xpbWl0KTsKICAgIH0KICAgIGZ1bmN0aW9uIG9yYWNsaXplX3F1ZXJ5KHN0cmluZyBkYXRhc291cmNlLCBzdHJpbmdbMV0gYXJncywgdWludCBnYXNsaW1pdCkgb3JhY2xpemVBUEkgaW50ZXJuYWwgcmV0dXJucyAoYnl0ZXMzMiBpZCkgewogICAgICAgIHN0cmluZ1tdIG1lbW9yeSBkeW5hcmdzID0gbmV3IHN0cmluZ1tdKDEpOwogICAgICAgIGR5bmFyZ3NbMF0gPSBhcmdzWzBdOyAgICAgICAKICAgICAgICByZXR1cm4gb3JhY2xpemVfcXVlcnkoZGF0YXNvdXJjZSwgZHluYXJncywgZ2FzbGltaXQpOwogICAgfQogICAgCiAgICBmdW5jdGlvbiBvcmFjbGl6ZV9xdWVyeShzdHJpbmcgZGF0YXNvdXJjZSwgc3RyaW5nWzJdIGFyZ3MpIG9yYWNsaXplQVBJIGludGVybmFsIHJldHVybnMgKGJ5dGVzMzIgaWQpIHsKICAgICAgICBzdHJpbmdbXSBtZW1vcnkgZHluYXJncyA9IG5ldyBzdHJpbmdbXSgyKTsKICAgICAgICBkeW5hcmdzWzBdID0gYXJnc1swXTsKICAgICAgICBkeW5hcmdzWzFdID0gYXJnc1sxXTsKICAgICAgICByZXR1cm4gb3JhY2xpemVfcXVlcnkoZGF0YXNvdXJjZSwgZHluYXJncyk7CiAgICB9CiAgICBmdW5jdGlvbiBvcmFjbGl6ZV9xdWVyeSh1aW50IHRpbWVzdGFtcCwgc3RyaW5nIGRhdGFzb3VyY2UsIHN0cmluZ1syXSBhcmdzKSBvcmFjbGl6ZUFQSSBpbnRlcm5hbCByZXR1cm5zIChieXRlczMyIGlkKSB7CiAgICAgICAgc3RyaW5nW10gbWVtb3J5IGR5bmFyZ3MgPSBuZXcgc3RyaW5nW10oMik7CiAgICAgICAgZHluYXJnc1swXSA9IGFyZ3NbMF07CiAgICAgICAgZHluYXJnc1sxXSA9IGFyZ3NbMV07CiAgICAgICAgcmV0dXJuIG9yYWNsaXplX3F1ZXJ5KHRpbWVzdGFtcCwgZGF0YXNvdXJjZSwgZHluYXJncyk7CiAgICB9CiAgICBmdW5jdGlvbiBvcmFjbGl6ZV9xdWVyeSh1aW50IHRpbWVzdGFtcCwgc3RyaW5nIGRhdGFzb3VyY2UsIHN0cmluZ1syXSBhcmdzLCB1aW50IGdhc2xpbWl0KSBvcmFjbGl6ZUFQSSBpbnRlcm5hbCByZXR1cm5zIChieXRlczMyIGlkKSB7CiAgICAgICAgc3RyaW5nW10gbWVtb3J5IGR5bmFyZ3MgPSBuZXcgc3RyaW5nW10oMik7CiAgICAgICAgZHluYXJnc1swXSA9IGFyZ3NbMF07CiAgICAgICAgZHluYXJnc1sxXSA9IGFyZ3NbMV07CiAgICAgICAgcmV0dXJuIG9yYWNsaXplX3F1ZXJ5KHRpbWVzdGFtcCwgZGF0YXNvdXJjZSwgZHluYXJncywgZ2FzbGltaXQpOwogICAgfQogICAgZnVuY3Rpb24gb3JhY2xpemVfcXVlcnkoc3RyaW5nIGRhdGFzb3VyY2UsIHN0cmluZ1syXSBhcmdzLCB1aW50IGdhc2xpbWl0KSBvcmFjbGl6ZUFQSSBpbnRlcm5hbCByZXR1cm5zIChieXRlczMyIGlkKSB7CiAgICAgICAgc3RyaW5nW10gbWVtb3J5IGR5bmFyZ3MgPSBuZXcgc3RyaW5nW10oMik7CiAgICAgICAgZHluYXJnc1swXSA9IGFyZ3NbMF07CiAgICAgICAgZHluYXJnc1sxXSA9IGFyZ3NbMV07CiAgICAgICAgcmV0dXJuIG9yYWNsaXplX3F1ZXJ5KGRhdGFzb3VyY2UsIGR5bmFyZ3MsIGdhc2xpbWl0KTsKICAgIH0KICAgIGZ1bmN0aW9uIG9yYWNsaXplX3F1ZXJ5KHN0cmluZyBkYXRhc291cmNlLCBzdHJpbmdbM10gYXJncykgb3JhY2xpemVBUEkgaW50ZXJuYWwgcmV0dXJucyAoYnl0ZXMzMiBpZCkgewogICAgICAgIHN0cmluZ1tdIG1lbW9yeSBkeW5hcmdzID0gbmV3IHN0cmluZ1tdKDMpOwogICAgICAgIGR5bmFyZ3NbMF0gPSBhcmdzWzBdOwogICAgICAgIGR5bmFyZ3NbMV0gPSBhcmdzWzFdOwogICAgICAgIGR5bmFyZ3NbMl0gPSBhcmdzWzJdOwogICAgICAgIHJldHVybiBvcmFjbGl6ZV9xdWVyeShkYXRhc291cmNlLCBkeW5hcmdzKTsKICAgIH0KICAgIGZ1bmN0aW9uIG9yYWNsaXplX3F1ZXJ5KHVpbnQgdGltZXN0YW1wLCBzdHJpbmcgZGF0YXNvdXJjZSwgc3RyaW5nWzNdIGFyZ3MpIG9yYWNsaXplQVBJIGludGVybmFsIHJldHVybnMgKGJ5dGVzMzIgaWQpIHsKICAgICAgICBzdHJpbmdbXSBtZW1vcnkgZHluYXJncyA9IG5ldyBzdHJpbmdbXSgzKTsKICAgICAgICBkeW5hcmdzWzBdID0gYXJnc1swXTsKICAgICAgICBkeW5hcmdzWzFdID0gYXJnc1sxXTsKICAgICAgICBkeW5hcmdzWzJdID0gYXJnc1syXTsKICAgICAgICByZXR1cm4gb3JhY2xpemVfcXVlcnkodGltZXN0YW1wLCBkYXRhc291cmNlLCBkeW5hcmdzKTsKICAgIH0KICAgIGZ1bmN0aW9uIG9yYWNsaXplX3F1ZXJ5KHVpbnQgdGltZXN0YW1wLCBzdHJpbmcgZGF0YXNvdXJjZSwgc3RyaW5nWzNdIGFyZ3MsIHVpbnQgZ2FzbGltaXQpIG9yYWNsaXplQVBJIGludGVybmFsIHJldHVybnMgKGJ5dGVzMzIgaWQpIHsKICAgICAgICBzdHJpbmdbXSBtZW1vcnkgZHluYXJncyA9IG5ldyBzdHJpbmdbXSgzKTsKICAgICAgICBkeW5hcmdzWzBdID0gYXJnc1swXTsKICAgICAgICBkeW5hcmdzWzFdID0gYXJnc1sxXTsKICAgICAgICBkeW5hcmdzWzJdID0gYXJnc1syXTsKICAgICAgICByZXR1cm4gb3JhY2xpemVfcXVlcnkodGltZXN0YW1wLCBkYXRhc291cmNlLCBkeW5hcmdzLCBnYXNsaW1pdCk7CiAgICB9CiAgICBmdW5jdGlvbiBvcmFjbGl6ZV9xdWVyeShzdHJpbmcgZGF0YXNvdXJjZSwgc3RyaW5nWzNdIGFyZ3MsIHVpbnQgZ2FzbGltaXQpIG9yYWNsaXplQVBJIGludGVybmFsIHJldHVybnMgKGJ5dGVzMzIgaWQpIHsKICAgICAgICBzdHJpbmdbXSBtZW1vcnkgZHluYXJncyA9IG5ldyBzdHJpbmdbXSgzKTsKICAgICAgICBkeW5hcmdzWzBdID0gYXJnc1swXTsKICAgICAgICBkeW5hcmdzWzFdID0gYXJnc1sxXTsKICAgICAgICBkeW5hcmdzWzJdID0gYXJnc1syXTsKICAgICAgICByZXR1cm4gb3JhY2xpemVfcXVlcnkoZGF0YXNvdXJjZSwgZHluYXJncywgZ2FzbGltaXQpOwogICAgfQogICAgCiAgICBmdW5jdGlvbiBvcmFjbGl6ZV9xdWVyeShzdHJpbmcgZGF0YXNvdXJjZSwgc3RyaW5nWzRdIGFyZ3MpIG9yYWNsaXplQVBJIGludGVybmFsIHJldHVybnMgKGJ5dGVzMzIgaWQpIHsKICAgICAgICBzdHJpbmdbXSBtZW1vcnkgZHluYXJncyA9IG5ldyBzdHJpbmdbXSg0KTsKICAgICAgICBkeW5hcmdzWzBdID0gYXJnc1swXTsKICAgICAgICBkeW5hcmdzWzFdID0gYXJnc1sxXTsKICAgICAgICBkeW5hcmdzWzJdID0gYXJnc1syXTsKICAgICAgICBkeW5hcmdzWzNdID0gYXJnc1szXTsKICAgICAgICByZXR1cm4gb3JhY2xpemVfcXVlcnkoZGF0YXNvdXJjZSwgZHluYXJncyk7CiAgICB9CiAgICBmdW5jdGlvbiBvcmFjbGl6ZV9xdWVyeSh1aW50IHRpbWVzdGFtcCwgc3RyaW5nIGRhdGFzb3VyY2UsIHN0cmluZ1s0XSBhcmdzKSBvcmFjbGl6ZUFQSSBpbnRlcm5hbCByZXR1cm5zIChieXRlczMyIGlkKSB7CiAgICAgICAgc3RyaW5nW10gbWVtb3J5IGR5bmFyZ3MgPSBuZXcgc3RyaW5nW10oNCk7CiAgICAgICAgZHluYXJnc1swXSA9IGFyZ3NbMF07CiAgICAgICAgZHluYXJnc1sxXSA9IGFyZ3NbMV07CiAgICAgICAgZHluYXJnc1syXSA9IGFyZ3NbMl07CiAgICAgICAgZHluYXJnc1szXSA9IGFyZ3NbM107CiAgICAgICAgcmV0dXJuIG9yYWNsaXplX3F1ZXJ5KHRpbWVzdGFtcCwgZGF0YXNvdXJjZSwgZHluYXJncyk7CiAgICB9CiAgICBmdW5jdGlvbiBvcmFjbGl6ZV9xdWVyeSh1aW50IHRpbWVzdGFtcCwgc3RyaW5nIGRhdGFzb3VyY2UsIHN0cmluZ1s0XSBhcmdzLCB1aW50IGdhc2xpbWl0KSBvcmFjbGl6ZUFQSSBpbnRlcm5hbCByZXR1cm5zIChieXRlczMyIGlkKSB7CiAgICAgICAgc3RyaW5nW10gbWVtb3J5IGR5bmFyZ3MgPSBuZXcgc3RyaW5nW10oNCk7CiAgICAgICAgZHluYXJnc1swXSA9IGFyZ3NbMF07CiAgICAgICAgZHluYXJnc1sxXSA9IGFyZ3NbMV07CiAgICAgICAgZHluYXJnc1syXSA9IGFyZ3NbMl07CiAgICAgICAgZHluYXJnc1szXSA9IGFyZ3NbM107CiAgICAgICAgcmV0dXJuIG9yYWNsaXplX3F1ZXJ5KHRpbWVzdGFtcCwgZGF0YXNvdXJjZSwgZHluYXJncywgZ2FzbGltaXQpOwogICAgfQogICAgZnVuY3Rpb24gb3JhY2xpemVfcXVlcnkoc3RyaW5nIGRhdGFzb3VyY2UsIHN0cmluZ1s0XSBhcmdzLCB1aW50IGdhc2xpbWl0KSBvcmFjbGl6ZUFQSSBpbnRlcm5hbCByZXR1cm5zIChieXRlczMyIGlkKSB7CiAgICAgICAgc3RyaW5nW10gbWVtb3J5IGR5bmFyZ3MgPSBuZXcgc3RyaW5nW10oNCk7CiAgICAgICAgZHluYXJnc1swXSA9IGFyZ3NbMF07CiAgICAgICAgZHluYXJnc1sxXSA9IGFyZ3NbMV07CiAgICAgICAgZHluYXJnc1syXSA9IGFyZ3NbMl07CiAgICAgICAgZHluYXJnc1szXSA9IGFyZ3NbM107CiAgICAgICAgcmV0dXJuIG9yYWNsaXplX3F1ZXJ5KGRhdGFzb3VyY2UsIGR5bmFyZ3MsIGdhc2xpbWl0KTsKICAgIH0KICAgIGZ1bmN0aW9uIG9yYWNsaXplX3F1ZXJ5KHN0cmluZyBkYXRhc291cmNlLCBzdHJpbmdbNV0gYXJncykgb3JhY2xpemVBUEkgaW50ZXJuYWwgcmV0dXJucyAoYnl0ZXMzMiBpZCkgewogICAgICAgIHN0cmluZ1tdIG1lbW9yeSBkeW5hcmdzID0gbmV3IHN0cmluZ1tdKDUpOwogICAgICAgIGR5bmFyZ3NbMF0gPSBhcmdzWzBdOwogICAgICAgIGR5bmFyZ3NbMV0gPSBhcmdzWzFdOwogICAgICAgIGR5bmFyZ3NbMl0gPSBhcmdzWzJdOwogICAgICAgIGR5bmFyZ3NbM10gPSBhcmdzWzNdOwogICAgICAgIGR5bmFyZ3NbNF0gPSBhcmdzWzRdOwogICAgICAgIHJldHVybiBvcmFjbGl6ZV9xdWVyeShkYXRhc291cmNlLCBkeW5hcmdzKTsKICAgIH0KICAgIGZ1bmN0aW9uIG9yYWNsaXplX3F1ZXJ5KHVpbnQgdGltZXN0YW1wLCBzdHJpbmcgZGF0YXNvdXJjZSwgc3RyaW5nWzVdIGFyZ3MpIG9yYWNsaXplQVBJIGludGVybmFsIHJldHVybnMgKGJ5dGVzMzIgaWQpIHsKICAgICAgICBzdHJpbmdbXSBtZW1vcnkgZHluYXJncyA9IG5ldyBzdHJpbmdbXSg1KTsKICAgICAgICBkeW5hcmdzWzBdID0gYXJnc1swXTsKICAgICAgICBkeW5hcmdzWzFdID0gYXJnc1sxXTsKICAgICAgICBkeW5hcmdzWzJdID0gYXJnc1syXTsKICAgICAgICBkeW5hcmdzWzNdID0gYXJnc1szXTsKICAgICAgICBkeW5hcmdzWzRdID0gYXJnc1s0XTsKICAgICAgICByZXR1cm4gb3JhY2xpemVfcXVlcnkodGltZXN0YW1wLCBkYXRhc291cmNlLCBkeW5hcmdzKTsKICAgIH0KICAgIGZ1bmN0aW9uIG9yYWNsaXplX3F1ZXJ5KHVpbnQgdGltZXN0YW1wLCBzdHJpbmcgZGF0YXNvdXJjZSwgc3RyaW5nWzVdIGFyZ3MsIHVpbnQgZ2FzbGltaXQpIG9yYWNsaXplQVBJIGludGVybmFsIHJldHVybnMgKGJ5dGVzMzIgaWQpIHsKICAgICAgICBzdHJpbmdbXSBtZW1vcnkgZHluYXJncyA9IG5ldyBzdHJpbmdbXSg1KTsKICAgICAgICBkeW5hcmdzWzBdID0gYXJnc1swXTsKICAgICAgICBkeW5hcmdzWzFdID0gYXJnc1sxXTsKICAgICAgICBkeW5hcmdzWzJdID0gYXJnc1syXTsKICAgICAgICBkeW5hcmdzWzNdID0gYXJnc1szXTsKICAgICAgICBkeW5hcmdzWzRdID0gYXJnc1s0XTsKICAgICAgICByZXR1cm4gb3JhY2xpemVfcXVlcnkodGltZXN0YW1wLCBkYXRhc291cmNlLCBkeW5hcmdzLCBnYXNsaW1pdCk7CiAgICB9CiAgICBmdW5jdGlvbiBvcmFjbGl6ZV9xdWVyeShzdHJpbmcgZGF0YXNvdXJjZSwgc3RyaW5nWzVdIGFyZ3MsIHVpbnQgZ2FzbGltaXQpIG9yYWNsaXplQVBJIGludGVybmFsIHJldHVybnMgKGJ5dGVzMzIgaWQpIHsKICAgICAgICBzdHJpbmdbXSBtZW1vcnkgZHluYXJncyA9IG5ldyBzdHJpbmdbXSg1KTsKICAgICAgICBkeW5hcmdzWzBdID0gYXJnc1swXTsKICAgICAgICBkeW5hcmdzWzFdID0gYXJnc1sxXTsKICAgICAgICBkeW5hcmdzWzJdID0gYXJnc1syXTsKICAgICAgICBkeW5hcmdzWzNdID0gYXJnc1szXTsKICAgICAgICBkeW5hcmdzWzRdID0gYXJnc1s0XTsKICAgICAgICByZXR1cm4gb3JhY2xpemVfcXVlcnkoZGF0YXNvdXJjZSwgZHluYXJncywgZ2FzbGltaXQpOwogICAgfQoKICAgIGZ1bmN0aW9uIG9yYWNsaXplX2NiQWRkcmVzcygpIG9yYWNsaXplQVBJIGludGVybmFsIHJldHVybnMgKGFkZHJlc3MpewogICAgICAgIHJldHVybiBvcmFjbGl6ZS5jYkFkZHJlc3MoKTsKICAgIH0KICAgIGZ1bmN0aW9uIG9yYWNsaXplX3NldFByb29mKGJ5dGUgcHJvb2ZQKSBvcmFjbGl6ZUFQSSBpbnRlcm5hbCB7CiAgICAgICAgcmV0dXJuIG9yYWNsaXplLnNldFByb29mVHlwZShwcm9vZlApOwogICAgfQogICAgZnVuY3Rpb24gb3JhY2xpemVfc2V0Q3VzdG9tR2FzUHJpY2UodWludCBnYXNQcmljZSkgb3JhY2xpemVBUEkgaW50ZXJuYWwgewogICAgICAgIHJldHVybiBvcmFjbGl6ZS5zZXRDdXN0b21HYXNQcmljZShnYXNQcmljZSk7CiAgICB9CiAgICBmdW5jdGlvbiBvcmFjbGl6ZV9zZXRDb25maWcoYnl0ZXMzMiBjb25maWcpIG9yYWNsaXplQVBJIGludGVybmFsIHsKICAgICAgICByZXR1cm4gb3JhY2xpemUuc2V0Q29uZmlnKGNvbmZpZyk7CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0Q29kZVNpemUoYWRkcmVzcyBfYWRkcikgY29uc3RhbnQgaW50ZXJuYWwgcmV0dXJucyh1aW50IF9zaXplKSB7CiAgICAgICAgYXNzZW1ibHkgewogICAgICAgICAgICBfc2l6ZSA6PSBleHRjb2Rlc2l6ZShfYWRkcikKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gcGFyc2VBZGRyKHN0cmluZyBfYSkgaW50ZXJuYWwgcmV0dXJucyAoYWRkcmVzcyl7CiAgICAgICAgYnl0ZXMgbWVtb3J5IHRtcCA9IGJ5dGVzKF9hKTsKICAgICAgICB1aW50MTYwIGlhZGRyID0gMDsKICAgICAgICB1aW50MTYwIGIxOwogICAgICAgIHVpbnQxNjAgYjI7CiAgICAgICAgZm9yICh1aW50IGk9MjsgaTwyKzIqMjA7IGkrPTIpewogICAgICAgICAgICBpYWRkciAqPSAyNTY7CiAgICAgICAgICAgIGIxID0gdWludDE2MCh0bXBbaV0pOwogICAgICAgICAgICBiMiA9IHVpbnQxNjAodG1wW2krMV0pOwogICAgICAgICAgICBpZiAoKGIxID49IDk3KSYmKGIxIDw9IDEwMikpIGIxIC09IDg3OwogICAgICAgICAgICBlbHNlIGlmICgoYjEgPj0gNjUpJiYoYjEgPD0gNzApKSBiMSAtPSA1NTsKICAgICAgICAgICAgZWxzZSBpZiAoKGIxID49IDQ4KSYmKGIxIDw9IDU3KSkgYjEgLT0gNDg7CiAgICAgICAgICAgIGlmICgoYjIgPj0gOTcpJiYoYjIgPD0gMTAyKSkgYjIgLT0gODc7CiAgICAgICAgICAgIGVsc2UgaWYgKChiMiA+PSA2NSkmJihiMiA8PSA3MCkpIGIyIC09IDU1OwogICAgICAgICAgICBlbHNlIGlmICgoYjIgPj0gNDgpJiYoYjIgPD0gNTcpKSBiMiAtPSA0ODsKICAgICAgICAgICAgaWFkZHIgKz0gKGIxKjE2K2IyKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGFkZHJlc3MoaWFkZHIpOwogICAgfQoKICAgIGZ1bmN0aW9uIHN0ckNvbXBhcmUoc3RyaW5nIF9hLCBzdHJpbmcgX2IpIGludGVybmFsIHJldHVybnMgKGludCkgewogICAgICAgIGJ5dGVzIG1lbW9yeSBhID0gYnl0ZXMoX2EpOwogICAgICAgIGJ5dGVzIG1lbW9yeSBiID0gYnl0ZXMoX2IpOwogICAgICAgIHVpbnQgbWluTGVuZ3RoID0gYS5sZW5ndGg7CiAgICAgICAgaWYgKGIubGVuZ3RoIDwgbWluTGVuZ3RoKSBtaW5MZW5ndGggPSBiLmxlbmd0aDsKICAgICAgICBmb3IgKHVpbnQgaSA9IDA7IGkgPCBtaW5MZW5ndGg7IGkgKyspCiAgICAgICAgICAgIGlmIChhW2ldIDwgYltpXSkKICAgICAgICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICAgICAgZWxzZSBpZiAoYVtpXSA+IGJbaV0pCiAgICAgICAgICAgICAgICByZXR1cm4gMTsKICAgICAgICBpZiAoYS5sZW5ndGggPCBiLmxlbmd0aCkKICAgICAgICAgICAgcmV0dXJuIC0xOwogICAgICAgIGVsc2UgaWYgKGEubGVuZ3RoID4gYi5sZW5ndGgpCiAgICAgICAgICAgIHJldHVybiAxOwogICAgICAgIGVsc2UKICAgICAgICAgICAgcmV0dXJuIDA7CiAgICB9CgogICAgZnVuY3Rpb24gaW5kZXhPZihzdHJpbmcgX2hheXN0YWNrLCBzdHJpbmcgX25lZWRsZSkgaW50ZXJuYWwgcmV0dXJucyAoaW50KSB7CiAgICAgICAgYnl0ZXMgbWVtb3J5IGggPSBieXRlcyhfaGF5c3RhY2spOwogICAgICAgIGJ5dGVzIG1lbW9yeSBuID0gYnl0ZXMoX25lZWRsZSk7CiAgICAgICAgaWYoaC5sZW5ndGggPCAxIHx8IG4ubGVuZ3RoIDwgMSB8fCAobi5sZW5ndGggPiBoLmxlbmd0aCkpCiAgICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICBlbHNlIGlmKGgubGVuZ3RoID4gKDIqKjEyOCAtMSkpCiAgICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB1aW50IHN1YmluZGV4ID0gMDsKICAgICAgICAgICAgZm9yICh1aW50IGkgPSAwOyBpIDwgaC5sZW5ndGg7IGkgKyspCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmIChoW2ldID09IG5bMF0pCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgc3ViaW5kZXggPSAxOwogICAgICAgICAgICAgICAgICAgIHdoaWxlKHN1YmluZGV4IDwgbi5sZW5ndGggJiYgKGkgKyBzdWJpbmRleCkgPCBoLmxlbmd0aCAmJiBoW2kgKyBzdWJpbmRleF0gPT0gbltzdWJpbmRleF0pCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBzdWJpbmRleCsrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZihzdWJpbmRleCA9PSBuLmxlbmd0aCkKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGludChpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gLTE7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIHN0ckNvbmNhdChzdHJpbmcgX2EsIHN0cmluZyBfYiwgc3RyaW5nIF9jLCBzdHJpbmcgX2QsIHN0cmluZyBfZSkgaW50ZXJuYWwgcmV0dXJucyAoc3RyaW5nKSB7CiAgICAgICAgYnl0ZXMgbWVtb3J5IF9iYSA9IGJ5dGVzKF9hKTsKICAgICAgICBieXRlcyBtZW1vcnkgX2JiID0gYnl0ZXMoX2IpOwogICAgICAgIGJ5dGVzIG1lbW9yeSBfYmMgPSBieXRlcyhfYyk7CiAgICAgICAgYnl0ZXMgbWVtb3J5IF9iZCA9IGJ5dGVzKF9kKTsKICAgICAgICBieXRlcyBtZW1vcnkgX2JlID0gYnl0ZXMoX2UpOwogICAgICAgIHN0cmluZyBtZW1vcnkgYWJjZGUgPSBuZXcgc3RyaW5nKF9iYS5sZW5ndGggKyBfYmIubGVuZ3RoICsgX2JjLmxlbmd0aCArIF9iZC5sZW5ndGggKyBfYmUubGVuZ3RoKTsKICAgICAgICBieXRlcyBtZW1vcnkgYmFiY2RlID0gYnl0ZXMoYWJjZGUpOwogICAgICAgIHVpbnQgayA9IDA7CiAgICAgICAgZm9yICh1aW50IGkgPSAwOyBpIDwgX2JhLmxlbmd0aDsgaSsrKSBiYWJjZGVbaysrXSA9IF9iYVtpXTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgX2JiLmxlbmd0aDsgaSsrKSBiYWJjZGVbaysrXSA9IF9iYltpXTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgX2JjLmxlbmd0aDsgaSsrKSBiYWJjZGVbaysrXSA9IF9iY1tpXTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgX2JkLmxlbmd0aDsgaSsrKSBiYWJjZGVbaysrXSA9IF9iZFtpXTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgX2JlLmxlbmd0aDsgaSsrKSBiYWJjZGVbaysrXSA9IF9iZVtpXTsKICAgICAgICByZXR1cm4gc3RyaW5nKGJhYmNkZSk7CiAgICB9CgogICAgZnVuY3Rpb24gc3RyQ29uY2F0KHN0cmluZyBfYSwgc3RyaW5nIF9iLCBzdHJpbmcgX2MsIHN0cmluZyBfZCkgaW50ZXJuYWwgcmV0dXJucyAoc3RyaW5nKSB7CiAgICAgICAgcmV0dXJuIHN0ckNvbmNhdChfYSwgX2IsIF9jLCBfZCwgIiIpOwogICAgfQoKICAgIGZ1bmN0aW9uIHN0ckNvbmNhdChzdHJpbmcgX2EsIHN0cmluZyBfYiwgc3RyaW5nIF9jKSBpbnRlcm5hbCByZXR1cm5zIChzdHJpbmcpIHsKICAgICAgICByZXR1cm4gc3RyQ29uY2F0KF9hLCBfYiwgX2MsICIiLCAiIik7CiAgICB9CgogICAgZnVuY3Rpb24gc3RyQ29uY2F0KHN0cmluZyBfYSwgc3RyaW5nIF9iKSBpbnRlcm5hbCByZXR1cm5zIChzdHJpbmcpIHsKICAgICAgICByZXR1cm4gc3RyQ29uY2F0KF9hLCBfYiwgIiIsICIiLCAiIik7CiAgICB9CgogICAgLy8gcGFyc2VJbnQKICAgIGZ1bmN0aW9uIHBhcnNlSW50KHN0cmluZyBfYSkgaW50ZXJuYWwgcmV0dXJucyAodWludCkgewogICAgICAgIHJldHVybiBwYXJzZUludChfYSwgMCk7CiAgICB9CgogICAgLy8gcGFyc2VJbnQocGFyc2VGbG9hdCoxMF5fYikKICAgIGZ1bmN0aW9uIHBhcnNlSW50KHN0cmluZyBfYSwgdWludCBfYikgaW50ZXJuYWwgcmV0dXJucyAodWludCkgewogICAgICAgIGJ5dGVzIG1lbW9yeSBicmVzdWx0ID0gYnl0ZXMoX2EpOwogICAgICAgIHVpbnQgbWludCA9IDA7CiAgICAgICAgYm9vbCBkZWNpbWFscyA9IGZhbHNlOwogICAgICAgIGZvciAodWludCBpPTA7IGk8YnJlc3VsdC5sZW5ndGg7IGkrKyl7CiAgICAgICAgICAgIGlmICgoYnJlc3VsdFtpXSA+PSA0OCkmJihicmVzdWx0W2ldIDw9IDU3KSl7CiAgICAgICAgICAgICAgICBpZiAoZGVjaW1hbHMpewogICAgICAgICAgICAgICAgICAgaWYgKF9iID09IDApIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGVsc2UgX2ItLTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG1pbnQgKj0gMTA7CiAgICAgICAgICAgICAgICBtaW50ICs9IHVpbnQoYnJlc3VsdFtpXSkgLSA0ODsKICAgICAgICAgICAgfSBlbHNlIGlmIChicmVzdWx0W2ldID09IDQ2KSBkZWNpbWFscyA9IHRydWU7CiAgICAgICAgfQogICAgICAgIGlmIChfYiA+IDApIG1pbnQgKj0gMTAqKl9iOwogICAgICAgIHJldHVybiBtaW50OwogICAgfQoKICAgIGZ1bmN0aW9uIHVpbnQyc3RyKHVpbnQgaSkgaW50ZXJuYWwgcmV0dXJucyAoc3RyaW5nKXsKICAgICAgICBpZiAoaSA9PSAwKSByZXR1cm4gIjAiOwogICAgICAgIHVpbnQgaiA9IGk7CiAgICAgICAgdWludCBsZW47CiAgICAgICAgd2hpbGUgKGogIT0gMCl7CiAgICAgICAgICAgIGxlbisrOwogICAgICAgICAgICBqIC89IDEwOwogICAgICAgIH0KICAgICAgICBieXRlcyBtZW1vcnkgYnN0ciA9IG5ldyBieXRlcyhsZW4pOwogICAgICAgIHVpbnQgayA9IGxlbiAtIDE7CiAgICAgICAgd2hpbGUgKGkgIT0gMCl7CiAgICAgICAgICAgIGJzdHJbay0tXSA9IGJ5dGUoNDggKyBpICUgMTApOwogICAgICAgICAgICBpIC89IDEwOwogICAgICAgIH0KICAgICAgICByZXR1cm4gc3RyaW5nKGJzdHIpOwogICAgfQoKICAgIGZ1bmN0aW9uIHN0cmEyY2JvcihzdHJpbmdbXSBhcnIpIGludGVybmFsIHJldHVybnMgKGJ5dGVzKSB7CiAgICAgICAgICAgIHVpbnQgYXJybGVuID0gYXJyLmxlbmd0aDsKCiAgICAgICAgICAgIC8vIGdldCBjb3JyZWN0IGNib3Igb3V0cHV0IGxlbmd0aAogICAgICAgICAgICB1aW50IG91dHB1dGxlbiA9IDA7CiAgICAgICAgICAgIGJ5dGVzW10gbWVtb3J5IGVsZW1BcnJheSA9IG5ldyBieXRlc1tdKGFycmxlbik7CiAgICAgICAgICAgIGZvciAodWludCBpID0gMDsgaSA8IGFycmxlbjsgaSsrKSB7CiAgICAgICAgICAgICAgICBlbGVtQXJyYXlbaV0gPSAoYnl0ZXMoYXJyW2ldKSk7CiAgICAgICAgICAgICAgICBvdXRwdXRsZW4gKz0gZWxlbUFycmF5W2ldLmxlbmd0aCArIChlbGVtQXJyYXlbaV0ubGVuZ3RoIC0gMSkvMjMgKyAzOyAvLyszIGFjY291bnRzIGZvciBwYWlyZWQgaWRlbnRpZmllciB0eXBlcwogICAgICAgICAgICB9CiAgICAgICAgICAgIHVpbnQgY3RyID0gMDsKICAgICAgICAgICAgdWludCBjYm9ybGVuID0gYXJybGVuICsgMHg4MDsKICAgICAgICAgICAgb3V0cHV0bGVuICs9IGJ5dGUoY2JvcmxlbikubGVuZ3RoOwogICAgICAgICAgICBieXRlcyBtZW1vcnkgcmVzID0gbmV3IGJ5dGVzKG91dHB1dGxlbik7CgogICAgICAgICAgICB3aGlsZSAoYnl0ZShjYm9ybGVuKS5sZW5ndGggPiBjdHIpIHsKICAgICAgICAgICAgICAgIHJlc1tjdHJdID0gYnl0ZShjYm9ybGVuKVtjdHJdOwogICAgICAgICAgICAgICAgY3RyKys7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGFycmxlbjsgaSsrKSB7CiAgICAgICAgICAgICAgICByZXNbY3RyXSA9IDB4NUY7CiAgICAgICAgICAgICAgICBjdHIrKzsKICAgICAgICAgICAgICAgIGZvciAodWludCB4ID0gMDsgeCA8IGVsZW1BcnJheVtpXS5sZW5ndGg7IHgrKykgewogICAgICAgICAgICAgICAgICAgIC8vIGlmIHRoZXJlJ3MgYSBidWcgd2l0aCBsYXJnZXIgc3RyaW5ncywgdGhpcyBtYXkgYmUgdGhlIGN1bHByaXQKICAgICAgICAgICAgICAgICAgICBpZiAoeCAlIDIzID09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgdWludCBlbGVtY2JvcmxlbiA9IGVsZW1BcnJheVtpXS5sZW5ndGggLSB4ID49IDI0ID8gMjMgOiBlbGVtQXJyYXlbaV0ubGVuZ3RoIC0geDsKICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWNib3JsZW4gKz0gMHg0MDsKICAgICAgICAgICAgICAgICAgICAgICAgdWludCBsY3RyID0gY3RyOwogICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAoYnl0ZShlbGVtY2JvcmxlbikubGVuZ3RoID4gY3RyIC0gbGN0cikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzW2N0cl0gPSBieXRlKGVsZW1jYm9ybGVuKVtjdHIgLSBsY3RyXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN0cisrOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJlc1tjdHJdID0gZWxlbUFycmF5W2ldW3hdOwogICAgICAgICAgICAgICAgICAgIGN0cisrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmVzW2N0cl0gPSAweEZGOwogICAgICAgICAgICAgICAgY3RyKys7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHJlczsKICAgICAgICB9Cn0KLy8gPC9PUkFDTElaRV9BUEk+CgovKgogKiBAdGl0bGUgU3RyaW5nICYgc2xpY2UgdXRpbGl0eSBsaWJyYXJ5IGZvciBTb2xpZGl0eSBjb250cmFjdHMuCiAqIEBhdXRob3IgTmljayBKb2huc29uIDw8c3BhbiBjbGFzcz0iX19jZl9lbWFpbF9fIiBkYXRhLWNmZW1haWw9IjE3NzY2NTc2NzQ3Zjc5N2U3MzU3Nzk3ODYzNzM3ODYzMzk3OTcyNjMiPltlbWFpbCYjMTYwO3Byb3RlY3RlZF08L3NwYW4+PgogKgogKiBAZGV2IEZ1bmN0aW9uYWxpdHkgaW4gdGhpcyBsaWJyYXJ5IGlzIGxhcmdlbHkgaW1wbGVtZW50ZWQgdXNpbmcgYW4KICogICAgICBhYnN0cmFjdGlvbiBjYWxsZWQgYSAnc2xpY2UnLiBBIHNsaWNlIHJlcHJlc2VudHMgYSBwYXJ0IG9mIGEgc3RyaW5nIC0KICogICAgICBhbnl0aGluZyBmcm9tIHRoZSBlbnRpcmUgc3RyaW5nIHRvIGEgc2luZ2xlIGNoYXJhY3Rlciwgb3IgZXZlbiBubwogKiAgICAgIGNoYXJhY3RlcnMgYXQgYWxsIChhIDAtbGVuZ3RoIHNsaWNlKS4gU2luY2UgYSBzbGljZSBvbmx5IGhhcyB0byBzcGVjaWZ5CiAqICAgICAgYW4gb2Zmc2V0IGFuZCBhIGxlbmd0aCwgY29weWluZyBhbmQgbWFuaXB1bGF0aW5nIHNsaWNlcyBpcyBhIGxvdCBsZXNzCiAqICAgICAgZXhwZW5zaXZlIHRoYW4gY29weWluZyBhbmQgbWFuaXB1bGF0aW5nIHRoZSBzdHJpbmdzIHRoZXkgcmVmZXJlbmNlLgogKgogKiAgICAgIFRvIGZ1cnRoZXIgcmVkdWNlIGdhcyBjb3N0cywgbW9zdCBmdW5jdGlvbnMgb24gc2xpY2UgdGhhdCBuZWVkIHRvIHJldHVybgogKiAgICAgIGEgc2xpY2UgbW9kaWZ5IHRoZSBvcmlnaW5hbCBvbmUgaW5zdGVhZCBvZiBhbGxvY2F0aW5nIGEgbmV3IG9uZTsgZm9yCiAqICAgICAgaW5zdGFuY2UsIGBzLnNwbGl0KCIuIilgIHdpbGwgcmV0dXJuIHRoZSB0ZXh0IHVwIHRvIHRoZSBmaXJzdCAnLicsCiAqICAgICAgbW9kaWZ5aW5nIHMgdG8gb25seSBjb250YWluIHRoZSByZW1haW5kZXIgb2YgdGhlIHN0cmluZyBhZnRlciB0aGUgJy4nLgogKiAgICAgIEluIHNpdHVhdGlvbnMgd2hlcmUgeW91IGRvIG5vdCB3YW50IHRvIG1vZGlmeSB0aGUgb3JpZ2luYWwgc2xpY2UsIHlvdQogKiAgICAgIGNhbiBtYWtlIGEgY29weSBmaXJzdCB3aXRoIGAuY29weSgpYCwgZm9yIGV4YW1wbGU6CiAqICAgICAgYHMuY29weSgpLnNwbGl0KCIuIilgLiBUcnkgYW5kIGF2b2lkIHVzaW5nIHRoaXMgaWRpb20gaW4gbG9vcHM7IHNpbmNlCiAqICAgICAgU29saWRpdHkgaGFzIG5vIG1lbW9yeSBtYW5hZ2VtZW50LCBpdCB3aWxsIHJlc3VsdCBpbiBhbGxvY2F0aW5nIG1hbnkKICogICAgICBzaG9ydC1saXZlZCBzbGljZXMgdGhhdCBhcmUgbGF0ZXIgZGlzY2FyZGVkLgogKgogKiAgICAgIEZ1bmN0aW9ucyB0aGF0IHJldHVybiB0d28gc2xpY2VzIGNvbWUgaW4gdHdvIHZlcnNpb25zOiBhIG5vbi1hbGxvY2F0aW5nCiAqICAgICAgdmVyc2lvbiB0aGF0IHRha2VzIHRoZSBzZWNvbmQgc2xpY2UgYXMgYW4gYXJndW1lbnQsIG1vZGlmeWluZyBpdCBpbgogKiAgICAgIHBsYWNlLCBhbmQgYW4gYWxsb2NhdGluZyB2ZXJzaW9uIHRoYXQgYWxsb2NhdGVzIGFuZCByZXR1cm5zIHRoZSBzZWNvbmQKICogICAgICBzbGljZTsgc2VlIGBuZXh0UnVuZWAgZm9yIGV4YW1wbGUuCiAqCiAqICAgICAgRnVuY3Rpb25zIHRoYXQgaGF2ZSB0byBjb3B5IHN0cmluZyBkYXRhIHdpbGwgcmV0dXJuIHN0cmluZ3MgcmF0aGVyIHRoYW4KICogICAgICBzbGljZXM7IHRoZXNlIGNhbiBiZSBjYXN0IGJhY2sgdG8gc2xpY2VzIGZvciBmdXJ0aGVyIHByb2Nlc3NpbmcgaWYKICogICAgICByZXF1aXJlZC4KICoKICogICAgICBGb3IgY29udmVuaWVuY2UsIHNvbWUgZnVuY3Rpb25zIGFyZSBwcm92aWRlZCB3aXRoIG5vbi1tb2RpZnlpbmcKICogICAgICB2YXJpYW50cyB0aGF0IGNyZWF0ZSBhIG5ldyBzbGljZSBhbmQgcmV0dXJuIGJvdGg7IGZvciBpbnN0YW5jZSwKICogICAgICBgcy5zcGxpdE5ldygnLicpYCBsZWF2ZXMgcyB1bm1vZGlmaWVkLCBhbmQgcmV0dXJucyB0d28gdmFsdWVzCiAqICAgICAgY29ycmVzcG9uZGluZyB0byB0aGUgbGVmdCBhbmQgcmlnaHQgcGFydHMgb2YgdGhlIHN0cmluZy4KICovCmxpYnJhcnkgc3RyaW5ncyB7CiAgICBzdHJ1Y3Qgc2xpY2UgewogICAgICAgIHVpbnQgX2xlbjsKICAgICAgICB1aW50IF9wdHI7CiAgICB9CgogICAgZnVuY3Rpb24gbWVtY3B5KHVpbnQgZGVzdCwgdWludCBzcmMsIHVpbnQgbGVuKSBwcml2YXRlIHsKICAgICAgICAvLyBDb3B5IHdvcmQtbGVuZ3RoIGNodW5rcyB3aGlsZSBwb3NzaWJsZQogICAgICAgIGZvcig7IGxlbiA+PSAzMjsgbGVuIC09IDMyKSB7CiAgICAgICAgICAgIGFzc2VtYmx5IHsKICAgICAgICAgICAgICAgIG1zdG9yZShkZXN0LCBtbG9hZChzcmMpKQogICAgICAgICAgICB9CiAgICAgICAgICAgIGRlc3QgKz0gMzI7CiAgICAgICAgICAgIHNyYyArPSAzMjsKICAgICAgICB9CgogICAgICAgIC8vIENvcHkgcmVtYWluaW5nIGJ5dGVzCiAgICAgICAgdWludCBtYXNrID0gMjU2ICoqICgzMiAtIGxlbikgLSAxOwogICAgICAgIGFzc2VtYmx5IHsKICAgICAgICAgICAgbGV0IHNyY3BhcnQgOj0gYW5kKG1sb2FkKHNyYyksIG5vdChtYXNrKSkKICAgICAgICAgICAgbGV0IGRlc3RwYXJ0IDo9IGFuZChtbG9hZChkZXN0KSwgbWFzaykKICAgICAgICAgICAgbXN0b3JlKGRlc3QsIG9yKGRlc3RwYXJ0LCBzcmNwYXJ0KSkKICAgICAgICB9CiAgICB9CgogICAgLyoKICAgICAqIEBkZXYgUmV0dXJucyBhIHNsaWNlIGNvbnRhaW5pbmcgdGhlIGVudGlyZSBzdHJpbmcuCiAgICAgKiBAcGFyYW0gc2VsZiBUaGUgc3RyaW5nIHRvIG1ha2UgYSBzbGljZSBmcm9tLgogICAgICogQHJldHVybiBBIG5ld2x5IGFsbG9jYXRlZCBzbGljZSBjb250YWluaW5nIHRoZSBlbnRpcmUgc3RyaW5nLgogICAgICovCiAgICBmdW5jdGlvbiB0b1NsaWNlKHN0cmluZyBzZWxmKSBpbnRlcm5hbCByZXR1cm5zIChzbGljZSkgewogICAgICAgIHVpbnQgcHRyOwogICAgICAgIGFzc2VtYmx5IHsKICAgICAgICAgICAgcHRyIDo9IGFkZChzZWxmLCAweDIwKQogICAgICAgIH0KICAgICAgICByZXR1cm4gc2xpY2UoYnl0ZXMoc2VsZikubGVuZ3RoLCBwdHIpOwogICAgfQoKICAgIC8qCiAgICAgKiBAZGV2IFJldHVybnMgdGhlIGxlbmd0aCBvZiBhIG51bGwtdGVybWluYXRlZCBieXRlczMyIHN0cmluZy4KICAgICAqIEBwYXJhbSBzZWxmIFRoZSB2YWx1ZSB0byBmaW5kIHRoZSBsZW5ndGggb2YuCiAgICAgKiBAcmV0dXJuIFRoZSBsZW5ndGggb2YgdGhlIHN0cmluZywgZnJvbSAwIHRvIDMyLgogICAgICovCiAgICBmdW5jdGlvbiBsZW4oYnl0ZXMzMiBzZWxmKSBpbnRlcm5hbCByZXR1cm5zICh1aW50KSB7CiAgICAgICAgdWludCByZXQ7CiAgICAgICAgaWYgKHNlbGYgPT0gMCkKICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgaWYgKHNlbGYgJiAweGZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmID09IDApIHsKICAgICAgICAgICAgcmV0ICs9IDE2OwogICAgICAgICAgICBzZWxmID0gYnl0ZXMzMih1aW50KHNlbGYpIC8gMHgxMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDApOwogICAgICAgIH0KICAgICAgICBpZiAoc2VsZiAmIDB4ZmZmZmZmZmZmZmZmZmZmZiA9PSAwKSB7CiAgICAgICAgICAgIHJldCArPSA4OwogICAgICAgICAgICBzZWxmID0gYnl0ZXMzMih1aW50KHNlbGYpIC8gMHgxMDAwMDAwMDAwMDAwMDAwMCk7CiAgICAgICAgfQogICAgICAgIGlmIChzZWxmICYgMHhmZmZmZmZmZiA9PSAwKSB7CiAgICAgICAgICAgIHJldCArPSA0OwogICAgICAgICAgICBzZWxmID0gYnl0ZXMzMih1aW50KHNlbGYpIC8gMHgxMDAwMDAwMDApOwogICAgICAgIH0KICAgICAgICBpZiAoc2VsZiAmIDB4ZmZmZiA9PSAwKSB7CiAgICAgICAgICAgIHJldCArPSAyOwogICAgICAgICAgICBzZWxmID0gYnl0ZXMzMih1aW50KHNlbGYpIC8gMHgxMDAwMCk7CiAgICAgICAgfQogICAgICAgIGlmIChzZWxmICYgMHhmZiA9PSAwKSB7CiAgICAgICAgICAgIHJldCArPSAxOwogICAgICAgIH0KICAgICAgICByZXR1cm4gMzIgLSByZXQ7CiAgICB9CgogICAgLyoKICAgICAqIEBkZXYgUmV0dXJucyBhIHNsaWNlIGNvbnRhaW5pbmcgdGhlIGVudGlyZSBieXRlczMyLCBpbnRlcnByZXRlZCBhcyBhCiAgICAgKiAgICAgIG51bGwtdGVybWludGFlZCB1dGYtOCBzdHJpbmcuCiAgICAgKiBAcGFyYW0gc2VsZiBUaGUgYnl0ZXMzMiB2YWx1ZSB0byBjb252ZXJ0IHRvIGEgc2xpY2UuCiAgICAgKiBAcmV0dXJuIEEgbmV3IHNsaWNlIGNvbnRhaW5pbmcgdGhlIHZhbHVlIG9mIHRoZSBpbnB1dCBhcmd1bWVudCB1cCB0byB0aGUKICAgICAqICAgICAgICAgZmlyc3QgbnVsbC4KICAgICAqLwogICAgZnVuY3Rpb24gdG9TbGljZUIzMihieXRlczMyIHNlbGYpIGludGVybmFsIHJldHVybnMgKHNsaWNlIHJldCkgewogICAgICAgIC8vIEFsbG9jYXRlIHNwYWNlIGZvciBgc2VsZmAgaW4gbWVtb3J5LCBjb3B5IGl0IHRoZXJlLCBhbmQgcG9pbnQgcmV0IGF0IGl0CiAgICAgICAgYXNzZW1ibHkgewogICAgICAgICAgICBsZXQgcHRyIDo9IG1sb2FkKDB4NDApCiAgICAgICAgICAgIG1zdG9yZSgweDQwLCBhZGQocHRyLCAweDIwKSkKICAgICAgICAgICAgbXN0b3JlKHB0ciwgc2VsZikKICAgICAgICAgICAgbXN0b3JlKGFkZChyZXQsIDB4MjApLCBwdHIpCiAgICAgICAgfQogICAgICAgIHJldC5fbGVuID0gbGVuKHNlbGYpOwogICAgfQoKICAgIC8qCiAgICAgKiBAZGV2IFJldHVybnMgYSBuZXcgc2xpY2UgY29udGFpbmluZyB0aGUgc2FtZSBkYXRhIGFzIHRoZSBjdXJyZW50IHNsaWNlLgogICAgICogQHBhcmFtIHNlbGYgVGhlIHNsaWNlIHRvIGNvcHkuCiAgICAgKiBAcmV0dXJuIEEgbmV3IHNsaWNlIGNvbnRhaW5pbmcgdGhlIHNhbWUgZGF0YSBhcyBgc2VsZmAuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNvcHkoc2xpY2Ugc2VsZikgaW50ZXJuYWwgcmV0dXJucyAoc2xpY2UpIHsKICAgICAgICByZXR1cm4gc2xpY2Uoc2VsZi5fbGVuLCBzZWxmLl9wdHIpOwogICAgfQoKICAgIC8qCiAgICAgKiBAZGV2IENvcGllcyBhIHNsaWNlIHRvIGEgbmV3IHN0cmluZy4KICAgICAqIEBwYXJhbSBzZWxmIFRoZSBzbGljZSB0byBjb3B5LgogICAgICogQHJldHVybiBBIG5ld2x5IGFsbG9jYXRlZCBzdHJpbmcgY29udGFpbmluZyB0aGUgc2xpY2UncyB0ZXh0LgogICAgICovCiAgICBmdW5jdGlvbiB0b1N0cmluZyhzbGljZSBzZWxmKSBpbnRlcm5hbCByZXR1cm5zIChzdHJpbmcpIHsKICAgICAgICB2YXIgcmV0ID0gbmV3IHN0cmluZyhzZWxmLl9sZW4pOwogICAgICAgIHVpbnQgcmV0cHRyOwogICAgICAgIGFzc2VtYmx5IHsgcmV0cHRyIDo9IGFkZChyZXQsIDMyKSB9CgogICAgICAgIG1lbWNweShyZXRwdHIsIHNlbGYuX3B0ciwgc2VsZi5fbGVuKTsKICAgICAgICByZXR1cm4gcmV0OwogICAgfQoKICAgIC8qCiAgICAgKiBAZGV2IFJldHVybnMgdGhlIGxlbmd0aCBpbiBydW5lcyBvZiB0aGUgc2xpY2UuIE5vdGUgdGhhdCB0aGlzIG9wZXJhdGlvbgogICAgICogICAgICB0YWtlcyB0aW1lIHByb3BvcnRpb25hbCB0byB0aGUgbGVuZ3RoIG9mIHRoZSBzbGljZTsgYXZvaWQgdXNpbmcgaXQKICAgICAqICAgICAgaW4gbG9vcHMsIGFuZCBjYWxsIGBzbGljZS5lbXB0eSgpYCBpZiB5b3Ugb25seSBuZWVkIHRvIGtub3cgd2hldGhlcgogICAgICogICAgICB0aGUgc2xpY2UgaXMgZW1wdHkgb3Igbm90LgogICAgICogQHBhcmFtIHNlbGYgVGhlIHNsaWNlIHRvIG9wZXJhdGUgb24uCiAgICAgKiBAcmV0dXJuIFRoZSBsZW5ndGggb2YgdGhlIHNsaWNlIGluIHJ1bmVzLgogICAgICovCiAgICBmdW5jdGlvbiBsZW4oc2xpY2Ugc2VsZikgaW50ZXJuYWwgcmV0dXJucyAodWludCkgewogICAgICAgIC8vIFN0YXJ0aW5nIGF0IHB0ci0zMSBtZWFucyB0aGUgTFNCIHdpbGwgYmUgdGhlIGJ5dGUgd2UgY2FyZSBhYm91dAogICAgICAgIHZhciBwdHIgPSBzZWxmLl9wdHIgLSAzMTsKICAgICAgICB2YXIgZW5kID0gcHRyICsgc2VsZi5fbGVuOwogICAgICAgIGZvciAodWludCBsZW4gPSAwOyBwdHIgPCBlbmQ7IGxlbisrKSB7CiAgICAgICAgICAgIHVpbnQ4IGI7CiAgICAgICAgICAgIGFzc2VtYmx5IHsgYiA6PSBhbmQobWxvYWQocHRyKSwgMHhGRikgfQogICAgICAgICAgICBpZiAoYiA8IDB4ODApIHsKICAgICAgICAgICAgICAgIHB0ciArPSAxOwogICAgICAgICAgICB9IGVsc2UgaWYoYiA8IDB4RTApIHsKICAgICAgICAgICAgICAgIHB0ciArPSAyOwogICAgICAgICAgICB9IGVsc2UgaWYoYiA8IDB4RjApIHsKICAgICAgICAgICAgICAgIHB0ciArPSAzOwogICAgICAgICAgICB9IGVsc2UgaWYoYiA8IDB4RjgpIHsKICAgICAgICAgICAgICAgIHB0ciArPSA0OwogICAgICAgICAgICB9IGVsc2UgaWYoYiA8IDB4RkMpIHsKICAgICAgICAgICAgICAgIHB0ciArPSA1OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcHRyICs9IDY7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGxlbjsKICAgIH0KCiAgICAvKgogICAgICogQGRldiBSZXR1cm5zIHRydWUgaWYgdGhlIHNsaWNlIGlzIGVtcHR5IChoYXMgYSBsZW5ndGggb2YgMCkuCiAgICAgKiBAcGFyYW0gc2VsZiBUaGUgc2xpY2UgdG8gb3BlcmF0ZSBvbi4KICAgICAqIEByZXR1cm4gVHJ1ZSBpZiB0aGUgc2xpY2UgaXMgZW1wdHksIEZhbHNlIG90aGVyd2lzZS4KICAgICAqLwogICAgZnVuY3Rpb24gZW1wdHkoc2xpY2Ugc2VsZikgaW50ZXJuYWwgcmV0dXJucyAoYm9vbCkgewogICAgICAgIHJldHVybiBzZWxmLl9sZW4gPT0gMDsKICAgIH0KCiAgICAvKgogICAgICogQGRldiBSZXR1cm5zIGEgcG9zaXRpdmUgbnVtYmVyIGlmIGBvdGhlcmAgY29tZXMgbGV4aWNvZ3JhcGhpY2FsbHkgYWZ0ZXIKICAgICAqICAgICAgYHNlbGZgLCBhIG5lZ2F0aXZlIG51bWJlciBpZiBpdCBjb21lcyBiZWZvcmUsIG9yIHplcm8gaWYgdGhlCiAgICAgKiAgICAgIGNvbnRlbnRzIG9mIHRoZSB0d28gc2xpY2VzIGFyZSBlcXVhbC4gQ29tcGFyaXNvbiBpcyBkb25lIHBlci1ydW5lLAogICAgICogICAgICBvbiB1bmljb2RlIGNvZGVwb2ludHMuCiAgICAgKiBAcGFyYW0gc2VsZiBUaGUgZmlyc3Qgc2xpY2UgdG8gY29tcGFyZS4KICAgICAqIEBwYXJhbSBvdGhlciBUaGUgc2Vjb25kIHNsaWNlIHRvIGNvbXBhcmUuCiAgICAgKiBAcmV0dXJuIFRoZSByZXN1bHQgb2YgdGhlIGNvbXBhcmlzb24uCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNvbXBhcmUoc2xpY2Ugc2VsZiwgc2xpY2Ugb3RoZXIpIGludGVybmFsIHJldHVybnMgKGludCkgewogICAgICAgIHVpbnQgc2hvcnRlc3QgPSBzZWxmLl9sZW47CiAgICAgICAgaWYgKG90aGVyLl9sZW4gPCBzZWxmLl9sZW4pCiAgICAgICAgICAgIHNob3J0ZXN0ID0gb3RoZXIuX2xlbjsKCiAgICAgICAgdmFyIHNlbGZwdHIgPSBzZWxmLl9wdHI7CiAgICAgICAgdmFyIG90aGVycHRyID0gb3RoZXIuX3B0cjsKICAgICAgICBmb3IgKHVpbnQgaWR4ID0gMDsgaWR4IDwgc2hvcnRlc3Q7IGlkeCArPSAzMikgewogICAgICAgICAgICB1aW50IGE7CiAgICAgICAgICAgIHVpbnQgYjsKICAgICAgICAgICAgYXNzZW1ibHkgewogICAgICAgICAgICAgICAgYSA6PSBtbG9hZChzZWxmcHRyKQogICAgICAgICAgICAgICAgYiA6PSBtbG9hZChvdGhlcnB0cikKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYSAhPSBiKSB7CiAgICAgICAgICAgICAgICAvLyBNYXNrIG91dCBpcnJlbGV2YW50IGJ5dGVzIGFuZCBjaGVjayBhZ2FpbgogICAgICAgICAgICAgICAgdWludCBtYXNrID0gfigyICoqICg4ICogKDMyIC0gc2hvcnRlc3QgKyBpZHgpKSAtIDEpOwogICAgICAgICAgICAgICAgdmFyIGRpZmYgPSAoYSAmIG1hc2spIC0gKGIgJiBtYXNrKTsKICAgICAgICAgICAgICAgIGlmIChkaWZmICE9IDApCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGludChkaWZmKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBzZWxmcHRyICs9IDMyOwogICAgICAgICAgICBvdGhlcnB0ciArPSAzMjsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGludChzZWxmLl9sZW4pIC0gaW50KG90aGVyLl9sZW4pOwogICAgfQoKICAgIC8qCiAgICAgKiBAZGV2IFJldHVybnMgdHJ1ZSBpZiB0aGUgdHdvIHNsaWNlcyBjb250YWluIHRoZSBzYW1lIHRleHQuCiAgICAgKiBAcGFyYW0gc2VsZiBUaGUgZmlyc3Qgc2xpY2UgdG8gY29tcGFyZS4KICAgICAqIEBwYXJhbSBzZWxmIFRoZSBzZWNvbmQgc2xpY2UgdG8gY29tcGFyZS4KICAgICAqIEByZXR1cm4gVHJ1ZSBpZiB0aGUgc2xpY2VzIGFyZSBlcXVhbCwgZmFsc2Ugb3RoZXJ3aXNlLgogICAgICovCiAgICBmdW5jdGlvbiBlcXVhbHMoc2xpY2Ugc2VsZiwgc2xpY2Ugb3RoZXIpIGludGVybmFsIHJldHVybnMgKGJvb2wpIHsKICAgICAgICByZXR1cm4gY29tcGFyZShzZWxmLCBvdGhlcikgPT0gMDsKICAgIH0KCiAgICAvKgogICAgICogQGRldiBFeHRyYWN0cyB0aGUgZmlyc3QgcnVuZSBpbiB0aGUgc2xpY2UgaW50byBgcnVuZWAsIGFkdmFuY2luZyB0aGUKICAgICAqICAgICAgc2xpY2UgdG8gcG9pbnQgdG8gdGhlIG5leHQgcnVuZSBhbmQgcmV0dXJuaW5nIGBzZWxmYC4KICAgICAqIEBwYXJhbSBzZWxmIFRoZSBzbGljZSB0byBvcGVyYXRlIG9uLgogICAgICogQHBhcmFtIHJ1bmUgVGhlIHNsaWNlIHRoYXQgd2lsbCBjb250YWluIHRoZSBmaXJzdCBydW5lLgogICAgICogQHJldHVybiBgcnVuZWAuCiAgICAgKi8KICAgIGZ1bmN0aW9uIG5leHRSdW5lKHNsaWNlIHNlbGYsIHNsaWNlIHJ1bmUpIGludGVybmFsIHJldHVybnMgKHNsaWNlKSB7CiAgICAgICAgcnVuZS5fcHRyID0gc2VsZi5fcHRyOwoKICAgICAgICBpZiAoc2VsZi5fbGVuID09IDApIHsKICAgICAgICAgICAgcnVuZS5fbGVuID0gMDsKICAgICAgICAgICAgcmV0dXJuIHJ1bmU7CiAgICAgICAgfQoKICAgICAgICB1aW50IGxlbjsKICAgICAgICB1aW50IGI7CiAgICAgICAgLy8gTG9hZCB0aGUgZmlyc3QgYnl0ZSBvZiB0aGUgcnVuZSBpbnRvIHRoZSBMU0JzIG9mIGIKICAgICAgICBhc3NlbWJseSB7IGIgOj0gYW5kKG1sb2FkKHN1YihtbG9hZChhZGQoc2VsZiwgMzIpKSwgMzEpKSwgMHhGRikgfQogICAgICAgIGlmIChiIDwgMHg4MCkgewogICAgICAgICAgICBsZW4gPSAxOwogICAgICAgIH0gZWxzZSBpZihiIDwgMHhFMCkgewogICAgICAgICAgICBsZW4gPSAyOwogICAgICAgIH0gZWxzZSBpZihiIDwgMHhGMCkgewogICAgICAgICAgICBsZW4gPSAzOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGxlbiA9IDQ7CiAgICAgICAgfQoKICAgICAgICAvLyBDaGVjayBmb3IgdHJ1bmNhdGVkIGNvZGVwb2ludHMKICAgICAgICBpZiAobGVuID4gc2VsZi5fbGVuKSB7CiAgICAgICAgICAgIHJ1bmUuX2xlbiA9IHNlbGYuX2xlbjsKICAgICAgICAgICAgc2VsZi5fcHRyICs9IHNlbGYuX2xlbjsKICAgICAgICAgICAgc2VsZi5fbGVuID0gMDsKICAgICAgICAgICAgcmV0dXJuIHJ1bmU7CiAgICAgICAgfQoKICAgICAgICBzZWxmLl9wdHIgKz0gbGVuOwogICAgICAgIHNlbGYuX2xlbiAtPSBsZW47CiAgICAgICAgcnVuZS5fbGVuID0gbGVuOwogICAgICAgIHJldHVybiBydW5lOwogICAgfQoKICAgIC8qCiAgICAgKiBAZGV2IFJldHVybnMgdGhlIGZpcnN0IHJ1bmUgaW4gdGhlIHNsaWNlLCBhZHZhbmNpbmcgdGhlIHNsaWNlIHRvIHBvaW50CiAgICAgKiAgICAgIHRvIHRoZSBuZXh0IHJ1bmUuCiAgICAgKiBAcGFyYW0gc2VsZiBUaGUgc2xpY2UgdG8gb3BlcmF0ZSBvbi4KICAgICAqIEByZXR1cm4gQSBzbGljZSBjb250YWluaW5nIG9ubHkgdGhlIGZpcnN0IHJ1bmUgZnJvbSBgc2VsZmAuCiAgICAgKi8KICAgIGZ1bmN0aW9uIG5leHRSdW5lKHNsaWNlIHNlbGYpIGludGVybmFsIHJldHVybnMgKHNsaWNlIHJldCkgewogICAgICAgIG5leHRSdW5lKHNlbGYsIHJldCk7CiAgICB9CgogICAgLyoKICAgICAqIEBkZXYgUmV0dXJucyB0aGUgbnVtYmVyIG9mIHRoZSBmaXJzdCBjb2RlcG9pbnQgaW4gdGhlIHNsaWNlLgogICAgICogQHBhcmFtIHNlbGYgVGhlIHNsaWNlIHRvIG9wZXJhdGUgb24uCiAgICAgKiBAcmV0dXJuIFRoZSBudW1iZXIgb2YgdGhlIGZpcnN0IGNvZGVwb2ludCBpbiB0aGUgc2xpY2UuCiAgICAgKi8KICAgIGZ1bmN0aW9uIG9yZChzbGljZSBzZWxmKSBpbnRlcm5hbCByZXR1cm5zICh1aW50IHJldCkgewogICAgICAgIGlmIChzZWxmLl9sZW4gPT0gMCkgewogICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICB9CgogICAgICAgIHVpbnQgd29yZDsKICAgICAgICB1aW50IGxlbjsKICAgICAgICB1aW50IGRpdiA9IDIgKiogMjQ4OwoKICAgICAgICAvLyBMb2FkIHRoZSBydW5lIGludG8gdGhlIE1TQnMgb2YgYgogICAgICAgIGFzc2VtYmx5IHsgd29yZDo9IG1sb2FkKG1sb2FkKGFkZChzZWxmLCAzMikpKSB9CiAgICAgICAgdmFyIGIgPSB3b3JkIC8gZGl2OwogICAgICAgIGlmIChiIDwgMHg4MCkgewogICAgICAgICAgICByZXQgPSBiOwogICAgICAgICAgICBsZW4gPSAxOwogICAgICAgIH0gZWxzZSBpZihiIDwgMHhFMCkgewogICAgICAgICAgICByZXQgPSBiICYgMHgxRjsKICAgICAgICAgICAgbGVuID0gMjsKICAgICAgICB9IGVsc2UgaWYoYiA8IDB4RjApIHsKICAgICAgICAgICAgcmV0ID0gYiAmIDB4MEY7CiAgICAgICAgICAgIGxlbiA9IDM7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0ID0gYiAmIDB4MDc7CiAgICAgICAgICAgIGxlbiA9IDQ7CiAgICAgICAgfQoKICAgICAgICAvLyBDaGVjayBmb3IgdHJ1bmNhdGVkIGNvZGVwb2ludHMKICAgICAgICBpZiAobGVuID4gc2VsZi5fbGVuKSB7CiAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgIH0KCiAgICAgICAgZm9yICh1aW50IGkgPSAxOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAgZGl2ID0gZGl2IC8gMjU2OwogICAgICAgICAgICBiID0gKHdvcmQgLyBkaXYpICYgMHhGRjsKICAgICAgICAgICAgaWYgKGIgJiAweEMwICE9IDB4ODApIHsKICAgICAgICAgICAgICAgIC8vIEludmFsaWQgVVRGLTggc2VxdWVuY2UKICAgICAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldCA9IChyZXQgKiA2NCkgfCAoYiAmIDB4M0YpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHJldDsKICAgIH0KCiAgICAvKgogICAgICogQGRldiBSZXR1cm5zIHRoZSBrZWNjYWstMjU2IGhhc2ggb2YgdGhlIHNsaWNlLgogICAgICogQHBhcmFtIHNlbGYgVGhlIHNsaWNlIHRvIGhhc2guCiAgICAgKiBAcmV0dXJuIFRoZSBoYXNoIG9mIHRoZSBzbGljZS4KICAgICAqLwogICAgZnVuY3Rpb24ga2VjY2FrKHNsaWNlIHNlbGYpIGludGVybmFsIHJldHVybnMgKGJ5dGVzMzIgcmV0KSB7CiAgICAgICAgYXNzZW1ibHkgewogICAgICAgICAgICByZXQgOj0gc2hhMyhtbG9hZChhZGQoc2VsZiwgMzIpKSwgbWxvYWQoc2VsZikpCiAgICAgICAgfQogICAgfQoKICAgIC8qCiAgICAgKiBAZGV2IFJldHVybnMgdHJ1ZSBpZiBgc2VsZmAgc3RhcnRzIHdpdGggYG5lZWRsZWAuCiAgICAgKiBAcGFyYW0gc2VsZiBUaGUgc2xpY2UgdG8gb3BlcmF0ZSBvbi4KICAgICAqIEBwYXJhbSBuZWVkbGUgVGhlIHNsaWNlIHRvIHNlYXJjaCBmb3IuCiAgICAgKiBAcmV0dXJuIFRydWUgaWYgdGhlIHNsaWNlIHN0YXJ0cyB3aXRoIHRoZSBwcm92aWRlZCB0ZXh0LCBmYWxzZSBvdGhlcndpc2UuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHN0YXJ0c1dpdGgoc2xpY2Ugc2VsZiwgc2xpY2UgbmVlZGxlKSBpbnRlcm5hbCByZXR1cm5zIChib29sKSB7CiAgICAgICAgaWYgKHNlbGYuX2xlbiA8IG5lZWRsZS5fbGVuKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIGlmIChzZWxmLl9wdHIgPT0gbmVlZGxlLl9wdHIpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQoKICAgICAgICBib29sIGVxdWFsOwogICAgICAgIGFzc2VtYmx5IHsKICAgICAgICAgICAgbGV0IGxlbiA6PSBtbG9hZChuZWVkbGUpCiAgICAgICAgICAgIGxldCBzZWxmcHRyIDo9IG1sb2FkKGFkZChzZWxmLCAweDIwKSkKICAgICAgICAgICAgbGV0IG5lZWRsZXB0ciA6PSBtbG9hZChhZGQobmVlZGxlLCAweDIwKSkKICAgICAgICAgICAgZXF1YWwgOj0gZXEoc2hhMyhzZWxmcHRyLCBsZW4pLCBzaGEzKG5lZWRsZXB0ciwgbGVuKSkKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGVxdWFsOwogICAgfQoKICAgIC8qCiAgICAgKiBAZGV2IElmIGBzZWxmYCBzdGFydHMgd2l0aCBgbmVlZGxlYCwgYG5lZWRsZWAgaXMgcmVtb3ZlZCBmcm9tIHRoZQogICAgICogICAgICBiZWdpbm5pbmcgb2YgYHNlbGZgLiBPdGhlcndpc2UsIGBzZWxmYCBpcyB1bm1vZGlmaWVkLgogICAgICogQHBhcmFtIHNlbGYgVGhlIHNsaWNlIHRvIG9wZXJhdGUgb24uCiAgICAgKiBAcGFyYW0gbmVlZGxlIFRoZSBzbGljZSB0byBzZWFyY2ggZm9yLgogICAgICogQHJldHVybiBgc2VsZmAKICAgICAqLwogICAgZnVuY3Rpb24gYmV5b25kKHNsaWNlIHNlbGYsIHNsaWNlIG5lZWRsZSkgaW50ZXJuYWwgcmV0dXJucyAoc2xpY2UpIHsKICAgICAgICBpZiAoc2VsZi5fbGVuIDwgbmVlZGxlLl9sZW4pIHsKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgfQoKICAgICAgICBib29sIGVxdWFsID0gdHJ1ZTsKICAgICAgICBpZiAoc2VsZi5fcHRyICE9IG5lZWRsZS5fcHRyKSB7CiAgICAgICAgICAgIGFzc2VtYmx5IHsKICAgICAgICAgICAgICAgIGxldCBsZW4gOj0gbWxvYWQobmVlZGxlKQogICAgICAgICAgICAgICAgbGV0IHNlbGZwdHIgOj0gbWxvYWQoYWRkKHNlbGYsIDB4MjApKQogICAgICAgICAgICAgICAgbGV0IG5lZWRsZXB0ciA6PSBtbG9hZChhZGQobmVlZGxlLCAweDIwKSkKICAgICAgICAgICAgICAgIGVxdWFsIDo9IGVxKHNoYTMoc2VsZnB0ciwgbGVuKSwgc2hhMyhuZWVkbGVwdHIsIGxlbikpCiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChlcXVhbCkgewogICAgICAgICAgICBzZWxmLl9sZW4gLT0gbmVlZGxlLl9sZW47CiAgICAgICAgICAgIHNlbGYuX3B0ciArPSBuZWVkbGUuX2xlbjsKICAgICAgICB9CgogICAgICAgIHJldHVybiBzZWxmOwogICAgfQoKICAgIC8qCiAgICAgKiBAZGV2IFJldHVybnMgdHJ1ZSBpZiB0aGUgc2xpY2UgZW5kcyB3aXRoIGBuZWVkbGVgLgogICAgICogQHBhcmFtIHNlbGYgVGhlIHNsaWNlIHRvIG9wZXJhdGUgb24uCiAgICAgKiBAcGFyYW0gbmVlZGxlIFRoZSBzbGljZSB0byBzZWFyY2ggZm9yLgogICAgICogQHJldHVybiBUcnVlIGlmIHRoZSBzbGljZSBzdGFydHMgd2l0aCB0aGUgcHJvdmlkZWQgdGV4dCwgZmFsc2Ugb3RoZXJ3aXNlLgogICAgICovCiAgICBmdW5jdGlvbiBlbmRzV2l0aChzbGljZSBzZWxmLCBzbGljZSBuZWVkbGUpIGludGVybmFsIHJldHVybnMgKGJvb2wpIHsKICAgICAgICBpZiAoc2VsZi5fbGVuIDwgbmVlZGxlLl9sZW4pIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgdmFyIHNlbGZwdHIgPSBzZWxmLl9wdHIgKyBzZWxmLl9sZW4gLSBuZWVkbGUuX2xlbjsKCiAgICAgICAgaWYgKHNlbGZwdHIgPT0gbmVlZGxlLl9wdHIpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQoKICAgICAgICBib29sIGVxdWFsOwogICAgICAgIGFzc2VtYmx5IHsKICAgICAgICAgICAgbGV0IGxlbiA6PSBtbG9hZChuZWVkbGUpCiAgICAgICAgICAgIGxldCBuZWVkbGVwdHIgOj0gbWxvYWQoYWRkKG5lZWRsZSwgMHgyMCkpCiAgICAgICAgICAgIGVxdWFsIDo9IGVxKHNoYTMoc2VsZnB0ciwgbGVuKSwgc2hhMyhuZWVkbGVwdHIsIGxlbikpCiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZXF1YWw7CiAgICB9CgogICAgLyoKICAgICAqIEBkZXYgSWYgYHNlbGZgIGVuZHMgd2l0aCBgbmVlZGxlYCwgYG5lZWRsZWAgaXMgcmVtb3ZlZCBmcm9tIHRoZQogICAgICogICAgICBlbmQgb2YgYHNlbGZgLiBPdGhlcndpc2UsIGBzZWxmYCBpcyB1bm1vZGlmaWVkLgogICAgICogQHBhcmFtIHNlbGYgVGhlIHNsaWNlIHRvIG9wZXJhdGUgb24uCiAgICAgKiBAcGFyYW0gbmVlZGxlIFRoZSBzbGljZSB0byBzZWFyY2ggZm9yLgogICAgICogQHJldHVybiBgc2VsZmAKICAgICAqLwogICAgZnVuY3Rpb24gdW50aWwoc2xpY2Ugc2VsZiwgc2xpY2UgbmVlZGxlKSBpbnRlcm5hbCByZXR1cm5zIChzbGljZSkgewogICAgICAgIGlmIChzZWxmLl9sZW4gPCBuZWVkbGUuX2xlbikgewogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICB9CgogICAgICAgIHZhciBzZWxmcHRyID0gc2VsZi5fcHRyICsgc2VsZi5fbGVuIC0gbmVlZGxlLl9sZW47CiAgICAgICAgYm9vbCBlcXVhbCA9IHRydWU7CiAgICAgICAgaWYgKHNlbGZwdHIgIT0gbmVlZGxlLl9wdHIpIHsKICAgICAgICAgICAgYXNzZW1ibHkgewogICAgICAgICAgICAgICAgbGV0IGxlbiA6PSBtbG9hZChuZWVkbGUpCiAgICAgICAgICAgICAgICBsZXQgbmVlZGxlcHRyIDo9IG1sb2FkKGFkZChuZWVkbGUsIDB4MjApKQogICAgICAgICAgICAgICAgZXF1YWwgOj0gZXEoc2hhMyhzZWxmcHRyLCBsZW4pLCBzaGEzKG5lZWRsZXB0ciwgbGVuKSkKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKGVxdWFsKSB7CiAgICAgICAgICAgIHNlbGYuX2xlbiAtPSBuZWVkbGUuX2xlbjsKICAgICAgICB9CgogICAgICAgIHJldHVybiBzZWxmOwogICAgfQoKICAgIC8vIFJldHVybnMgdGhlIG1lbW9yeSBhZGRyZXNzIG9mIHRoZSBmaXJzdCBieXRlIG9mIHRoZSBmaXJzdCBvY2N1cnJlbmNlIG9mCiAgICAvLyBgbmVlZGxlYCBpbiBgc2VsZmAsIG9yIHRoZSBmaXJzdCBieXRlIGFmdGVyIGBzZWxmYCBpZiBub3QgZm91bmQuCiAgICBmdW5jdGlvbiBmaW5kUHRyKHVpbnQgc2VsZmxlbiwgdWludCBzZWxmcHRyLCB1aW50IG5lZWRsZWxlbiwgdWludCBuZWVkbGVwdHIpIHByaXZhdGUgcmV0dXJucyAodWludCkgewogICAgICAgIHVpbnQgcHRyOwogICAgICAgIHVpbnQgaWR4OwoKICAgICAgICBpZiAobmVlZGxlbGVuIDw9IHNlbGZsZW4pIHsKICAgICAgICAgICAgaWYgKG5lZWRsZWxlbiA8PSAzMikgewogICAgICAgICAgICAgICAgLy8gT3B0aW1pemVkIGFzc2VtYmx5IGZvciA2OCBnYXMgcGVyIGJ5dGUgb24gc2hvcnQgc3RyaW5ncwogICAgICAgICAgICAgICAgYXNzZW1ibHkgewogICAgICAgICAgICAgICAgICAgIGxldCBtYXNrIDo9IG5vdChzdWIoZXhwKDIsIG11bCg4LCBzdWIoMzIsIG5lZWRsZWxlbikpKSwgMSkpCiAgICAgICAgICAgICAgICAgICAgbGV0IG5lZWRsZWRhdGEgOj0gYW5kKG1sb2FkKG5lZWRsZXB0ciksIG1hc2spCiAgICAgICAgICAgICAgICAgICAgbGV0IGVuZCA6PSBhZGQoc2VsZnB0ciwgc3ViKHNlbGZsZW4sIG5lZWRsZWxlbikpCiAgICAgICAgICAgICAgICAgICAgcHRyIDo9IHNlbGZwdHIKICAgICAgICAgICAgICAgICAgICBsb29wOgogICAgICAgICAgICAgICAgICAgIGp1bXBpKGV4aXQsIGVxKGFuZChtbG9hZChwdHIpLCBtYXNrKSwgbmVlZGxlZGF0YSkpCiAgICAgICAgICAgICAgICAgICAgcHRyIDo9IGFkZChwdHIsIDEpCiAgICAgICAgICAgICAgICAgICAganVtcGkobG9vcCwgbHQoc3ViKHB0ciwgMSksIGVuZCkpCiAgICAgICAgICAgICAgICAgICAgcHRyIDo9IGFkZChzZWxmcHRyLCBzZWxmbGVuKQogICAgICAgICAgICAgICAgICAgIGV4aXQ6CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gcHRyOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gRm9yIGxvbmcgbmVlZGxlcywgdXNlIGhhc2hpbmcKICAgICAgICAgICAgICAgIGJ5dGVzMzIgaGFzaDsKICAgICAgICAgICAgICAgIGFzc2VtYmx5IHsgaGFzaCA6PSBzaGEzKG5lZWRsZXB0ciwgbmVlZGxlbGVuKSB9CiAgICAgICAgICAgICAgICBwdHIgPSBzZWxmcHRyOwogICAgICAgICAgICAgICAgZm9yIChpZHggPSAwOyBpZHggPD0gc2VsZmxlbiAtIG5lZWRsZWxlbjsgaWR4KyspIHsKICAgICAgICAgICAgICAgICAgICBieXRlczMyIHRlc3RIYXNoOwogICAgICAgICAgICAgICAgICAgIGFzc2VtYmx5IHsgdGVzdEhhc2ggOj0gc2hhMyhwdHIsIG5lZWRsZWxlbikgfQogICAgICAgICAgICAgICAgICAgIGlmIChoYXNoID09IHRlc3RIYXNoKQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcHRyOwogICAgICAgICAgICAgICAgICAgIHB0ciArPSAxOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBzZWxmcHRyICsgc2VsZmxlbjsKICAgIH0KCiAgICAvLyBSZXR1cm5zIHRoZSBtZW1vcnkgYWRkcmVzcyBvZiB0aGUgZmlyc3QgYnl0ZSBhZnRlciB0aGUgbGFzdCBvY2N1cnJlbmNlIG9mCiAgICAvLyBgbmVlZGxlYCBpbiBgc2VsZmAsIG9yIHRoZSBhZGRyZXNzIG9mIGBzZWxmYCBpZiBub3QgZm91bmQuCiAgICBmdW5jdGlvbiByZmluZFB0cih1aW50IHNlbGZsZW4sIHVpbnQgc2VsZnB0ciwgdWludCBuZWVkbGVsZW4sIHVpbnQgbmVlZGxlcHRyKSBwcml2YXRlIHJldHVybnMgKHVpbnQpIHsKICAgICAgICB1aW50IHB0cjsKCiAgICAgICAgaWYgKG5lZWRsZWxlbiA8PSBzZWxmbGVuKSB7CiAgICAgICAgICAgIGlmIChuZWVkbGVsZW4gPD0gMzIpIHsKICAgICAgICAgICAgICAgIC8vIE9wdGltaXplZCBhc3NlbWJseSBmb3IgNjkgZ2FzIHBlciBieXRlIG9uIHNob3J0IHN0cmluZ3MKICAgICAgICAgICAgICAgIGFzc2VtYmx5IHsKICAgICAgICAgICAgICAgICAgICBsZXQgbWFzayA6PSBub3Qoc3ViKGV4cCgyLCBtdWwoOCwgc3ViKDMyLCBuZWVkbGVsZW4pKSksIDEpKQogICAgICAgICAgICAgICAgICAgIGxldCBuZWVkbGVkYXRhIDo9IGFuZChtbG9hZChuZWVkbGVwdHIpLCBtYXNrKQogICAgICAgICAgICAgICAgICAgIHB0ciA6PSBhZGQoc2VsZnB0ciwgc3ViKHNlbGZsZW4sIG5lZWRsZWxlbikpCiAgICAgICAgICAgICAgICAgICAgbG9vcDoKICAgICAgICAgICAgICAgICAgICBqdW1waShyZXQsIGVxKGFuZChtbG9hZChwdHIpLCBtYXNrKSwgbmVlZGxlZGF0YSkpCiAgICAgICAgICAgICAgICAgICAgcHRyIDo9IHN1YihwdHIsIDEpCiAgICAgICAgICAgICAgICAgICAganVtcGkobG9vcCwgZ3QoYWRkKHB0ciwgMSksIHNlbGZwdHIpKQogICAgICAgICAgICAgICAgICAgIHB0ciA6PSBzZWxmcHRyCiAgICAgICAgICAgICAgICAgICAganVtcChleGl0KQogICAgICAgICAgICAgICAgICAgIHJldDoKICAgICAgICAgICAgICAgICAgICBwdHIgOj0gYWRkKHB0ciwgbmVlZGxlbGVuKQogICAgICAgICAgICAgICAgICAgIGV4aXQ6CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gcHRyOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gRm9yIGxvbmcgbmVlZGxlcywgdXNlIGhhc2hpbmcKICAgICAgICAgICAgICAgIGJ5dGVzMzIgaGFzaDsKICAgICAgICAgICAgICAgIGFzc2VtYmx5IHsgaGFzaCA6PSBzaGEzKG5lZWRsZXB0ciwgbmVlZGxlbGVuKSB9CiAgICAgICAgICAgICAgICBwdHIgPSBzZWxmcHRyICsgKHNlbGZsZW4gLSBuZWVkbGVsZW4pOwogICAgICAgICAgICAgICAgd2hpbGUgKHB0ciA+PSBzZWxmcHRyKSB7CiAgICAgICAgICAgICAgICAgICAgYnl0ZXMzMiB0ZXN0SGFzaDsKICAgICAgICAgICAgICAgICAgICBhc3NlbWJseSB7IHRlc3RIYXNoIDo9IHNoYTMocHRyLCBuZWVkbGVsZW4pIH0KICAgICAgICAgICAgICAgICAgICBpZiAoaGFzaCA9PSB0ZXN0SGFzaCkKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHB0ciArIG5lZWRsZWxlbjsKICAgICAgICAgICAgICAgICAgICBwdHIgLT0gMTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gc2VsZnB0cjsKICAgIH0KCiAgICAvKgogICAgICogQGRldiBNb2RpZmllcyBgc2VsZmAgdG8gY29udGFpbiBldmVyeXRoaW5nIGZyb20gdGhlIGZpcnN0IG9jY3VycmVuY2Ugb2YKICAgICAqICAgICAgYG5lZWRsZWAgdG8gdGhlIGVuZCBvZiB0aGUgc2xpY2UuIGBzZWxmYCBpcyBzZXQgdG8gdGhlIGVtcHR5IHNsaWNlCiAgICAgKiAgICAgIGlmIGBuZWVkbGVgIGlzIG5vdCBmb3VuZC4KICAgICAqIEBwYXJhbSBzZWxmIFRoZSBzbGljZSB0byBzZWFyY2ggYW5kIG1vZGlmeS4KICAgICAqIEBwYXJhbSBuZWVkbGUgVGhlIHRleHQgdG8gc2VhcmNoIGZvci4KICAgICAqIEByZXR1cm4gYHNlbGZgLgogICAgICovCiAgICBmdW5jdGlvbiBmaW5kKHNsaWNlIHNlbGYsIHNsaWNlIG5lZWRsZSkgaW50ZXJuYWwgcmV0dXJucyAoc2xpY2UpIHsKICAgICAgICB1aW50IHB0ciA9IGZpbmRQdHIoc2VsZi5fbGVuLCBzZWxmLl9wdHIsIG5lZWRsZS5fbGVuLCBuZWVkbGUuX3B0cik7CiAgICAgICAgc2VsZi5fbGVuIC09IHB0ciAtIHNlbGYuX3B0cjsKICAgICAgICBzZWxmLl9wdHIgPSBwdHI7CiAgICAgICAgcmV0dXJuIHNlbGY7CiAgICB9CgogICAgLyoKICAgICAqIEBkZXYgTW9kaWZpZXMgYHNlbGZgIHRvIGNvbnRhaW4gdGhlIHBhcnQgb2YgdGhlIHN0cmluZyBmcm9tIHRoZSBzdGFydCBvZgogICAgICogICAgICBgc2VsZmAgdG8gdGhlIGVuZCBvZiB0aGUgZmlyc3Qgb2NjdXJyZW5jZSBvZiBgbmVlZGxlYC4gSWYgYG5lZWRsZWAKICAgICAqICAgICAgaXMgbm90IGZvdW5kLCBgc2VsZmAgaXMgc2V0IHRvIHRoZSBlbXB0eSBzbGljZS4KICAgICAqIEBwYXJhbSBzZWxmIFRoZSBzbGljZSB0byBzZWFyY2ggYW5kIG1vZGlmeS4KICAgICAqIEBwYXJhbSBuZWVkbGUgVGhlIHRleHQgdG8gc2VhcmNoIGZvci4KICAgICAqIEByZXR1cm4gYHNlbGZgLgogICAgICovCiAgICBmdW5jdGlvbiByZmluZChzbGljZSBzZWxmLCBzbGljZSBuZWVkbGUpIGludGVybmFsIHJldHVybnMgKHNsaWNlKSB7CiAgICAgICAgdWludCBwdHIgPSByZmluZFB0cihzZWxmLl9sZW4sIHNlbGYuX3B0ciwgbmVlZGxlLl9sZW4sIG5lZWRsZS5fcHRyKTsKICAgICAgICBzZWxmLl9sZW4gPSBwdHIgLSBzZWxmLl9wdHI7CiAgICAgICAgcmV0dXJuIHNlbGY7CiAgICB9CgogICAgLyoKICAgICAqIEBkZXYgU3BsaXRzIHRoZSBzbGljZSwgc2V0dGluZyBgc2VsZmAgdG8gZXZlcnl0aGluZyBhZnRlciB0aGUgZmlyc3QKICAgICAqICAgICAgb2NjdXJyZW5jZSBvZiBgbmVlZGxlYCwgYW5kIGB0b2tlbmAgdG8gZXZlcnl0aGluZyBiZWZvcmUgaXQuIElmCiAgICAgKiAgICAgIGBuZWVkbGVgIGRvZXMgbm90IG9jY3VyIGluIGBzZWxmYCwgYHNlbGZgIGlzIHNldCB0byB0aGUgZW1wdHkgc2xpY2UsCiAgICAgKiAgICAgIGFuZCBgdG9rZW5gIGlzIHNldCB0byB0aGUgZW50aXJldHkgb2YgYHNlbGZgLgogICAgICogQHBhcmFtIHNlbGYgVGhlIHNsaWNlIHRvIHNwbGl0LgogICAgICogQHBhcmFtIG5lZWRsZSBUaGUgdGV4dCB0byBzZWFyY2ggZm9yIGluIGBzZWxmYC4KICAgICAqIEBwYXJhbSB0b2tlbiBBbiBvdXRwdXQgcGFyYW1ldGVyIHRvIHdoaWNoIHRoZSBmaXJzdCB0b2tlbiBpcyB3cml0dGVuLgogICAgICogQHJldHVybiBgdG9rZW5gLgogICAgICovCiAgICBmdW5jdGlvbiBzcGxpdChzbGljZSBzZWxmLCBzbGljZSBuZWVkbGUsIHNsaWNlIHRva2VuKSBpbnRlcm5hbCByZXR1cm5zIChzbGljZSkgewogICAgICAgIHVpbnQgcHRyID0gZmluZFB0cihzZWxmLl9sZW4sIHNlbGYuX3B0ciwgbmVlZGxlLl9sZW4sIG5lZWRsZS5fcHRyKTsKICAgICAgICB0b2tlbi5fcHRyID0gc2VsZi5fcHRyOwogICAgICAgIHRva2VuLl9sZW4gPSBwdHIgLSBzZWxmLl9wdHI7CiAgICAgICAgaWYgKHB0ciA9PSBzZWxmLl9wdHIgKyBzZWxmLl9sZW4pIHsKICAgICAgICAgICAgLy8gTm90IGZvdW5kCiAgICAgICAgICAgIHNlbGYuX2xlbiA9IDA7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2VsZi5fbGVuIC09IHRva2VuLl9sZW4gKyBuZWVkbGUuX2xlbjsKICAgICAgICAgICAgc2VsZi5fcHRyID0gcHRyICsgbmVlZGxlLl9sZW47CiAgICAgICAgfQogICAgICAgIHJldHVybiB0b2tlbjsKICAgIH0KCiAgICAvKgogICAgICogQGRldiBTcGxpdHMgdGhlIHNsaWNlLCBzZXR0aW5nIGBzZWxmYCB0byBldmVyeXRoaW5nIGFmdGVyIHRoZSBmaXJzdAogICAgICogICAgICBvY2N1cnJlbmNlIG9mIGBuZWVkbGVgLCBhbmQgcmV0dXJuaW5nIGV2ZXJ5dGhpbmcgYmVmb3JlIGl0LiBJZgogICAgICogICAgICBgbmVlZGxlYCBkb2VzIG5vdCBvY2N1ciBpbiBgc2VsZmAsIGBzZWxmYCBpcyBzZXQgdG8gdGhlIGVtcHR5IHNsaWNlLAogICAgICogICAgICBhbmQgdGhlIGVudGlyZXR5IG9mIGBzZWxmYCBpcyByZXR1cm5lZC4KICAgICAqIEBwYXJhbSBzZWxmIFRoZSBzbGljZSB0byBzcGxpdC4KICAgICAqIEBwYXJhbSBuZWVkbGUgVGhlIHRleHQgdG8gc2VhcmNoIGZvciBpbiBgc2VsZmAuCiAgICAgKiBAcmV0dXJuIFRoZSBwYXJ0IG9mIGBzZWxmYCB1cCB0byB0aGUgZmlyc3Qgb2NjdXJyZW5jZSBvZiBgZGVsaW1gLgogICAgICovCiAgICBmdW5jdGlvbiBzcGxpdChzbGljZSBzZWxmLCBzbGljZSBuZWVkbGUpIGludGVybmFsIHJldHVybnMgKHNsaWNlIHRva2VuKSB7CiAgICAgICAgc3BsaXQoc2VsZiwgbmVlZGxlLCB0b2tlbik7CiAgICB9CgogICAgLyoKICAgICAqIEBkZXYgU3BsaXRzIHRoZSBzbGljZSwgc2V0dGluZyBgc2VsZmAgdG8gZXZlcnl0aGluZyBiZWZvcmUgdGhlIGxhc3QKICAgICAqICAgICAgb2NjdXJyZW5jZSBvZiBgbmVlZGxlYCwgYW5kIGB0b2tlbmAgdG8gZXZlcnl0aGluZyBhZnRlciBpdC4gSWYKICAgICAqICAgICAgYG5lZWRsZWAgZG9lcyBub3Qgb2NjdXIgaW4gYHNlbGZgLCBgc2VsZmAgaXMgc2V0IHRvIHRoZSBlbXB0eSBzbGljZSwKICAgICAqICAgICAgYW5kIGB0b2tlbmAgaXMgc2V0IHRvIHRoZSBlbnRpcmV0eSBvZiBgc2VsZmAuCiAgICAgKiBAcGFyYW0gc2VsZiBUaGUgc2xpY2UgdG8gc3BsaXQuCiAgICAgKiBAcGFyYW0gbmVlZGxlIFRoZSB0ZXh0IHRvIHNlYXJjaCBmb3IgaW4gYHNlbGZgLgogICAgICogQHBhcmFtIHRva2VuIEFuIG91dHB1dCBwYXJhbWV0ZXIgdG8gd2hpY2ggdGhlIGZpcnN0IHRva2VuIGlzIHdyaXR0ZW4uCiAgICAgKiBAcmV0dXJuIGB0b2tlbmAuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHJzcGxpdChzbGljZSBzZWxmLCBzbGljZSBuZWVkbGUsIHNsaWNlIHRva2VuKSBpbnRlcm5hbCByZXR1cm5zIChzbGljZSkgewogICAgICAgIHVpbnQgcHRyID0gcmZpbmRQdHIoc2VsZi5fbGVuLCBzZWxmLl9wdHIsIG5lZWRsZS5fbGVuLCBuZWVkbGUuX3B0cik7CiAgICAgICAgdG9rZW4uX3B0ciA9IHB0cjsKICAgICAgICB0b2tlbi5fbGVuID0gc2VsZi5fbGVuIC0gKHB0ciAtIHNlbGYuX3B0cik7CiAgICAgICAgaWYgKHB0ciA9PSBzZWxmLl9wdHIpIHsKICAgICAgICAgICAgLy8gTm90IGZvdW5kCiAgICAgICAgICAgIHNlbGYuX2xlbiA9IDA7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2VsZi5fbGVuIC09IHRva2VuLl9sZW4gKyBuZWVkbGUuX2xlbjsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRva2VuOwogICAgfQoKICAgIC8qCiAgICAgKiBAZGV2IFNwbGl0cyB0aGUgc2xpY2UsIHNldHRpbmcgYHNlbGZgIHRvIGV2ZXJ5dGhpbmcgYmVmb3JlIHRoZSBsYXN0CiAgICAgKiAgICAgIG9jY3VycmVuY2Ugb2YgYG5lZWRsZWAsIGFuZCByZXR1cm5pbmcgZXZlcnl0aGluZyBhZnRlciBpdC4gSWYKICAgICAqICAgICAgYG5lZWRsZWAgZG9lcyBub3Qgb2NjdXIgaW4gYHNlbGZgLCBgc2VsZmAgaXMgc2V0IHRvIHRoZSBlbXB0eSBzbGljZSwKICAgICAqICAgICAgYW5kIHRoZSBlbnRpcmV0eSBvZiBgc2VsZmAgaXMgcmV0dXJuZWQuCiAgICAgKiBAcGFyYW0gc2VsZiBUaGUgc2xpY2UgdG8gc3BsaXQuCiAgICAgKiBAcGFyYW0gbmVlZGxlIFRoZSB0ZXh0IHRvIHNlYXJjaCBmb3IgaW4gYHNlbGZgLgogICAgICogQHJldHVybiBUaGUgcGFydCBvZiBgc2VsZmAgYWZ0ZXIgdGhlIGxhc3Qgb2NjdXJyZW5jZSBvZiBgZGVsaW1gLgogICAgICovCiAgICBmdW5jdGlvbiByc3BsaXQoc2xpY2Ugc2VsZiwgc2xpY2UgbmVlZGxlKSBpbnRlcm5hbCByZXR1cm5zIChzbGljZSB0b2tlbikgewogICAgICAgIHJzcGxpdChzZWxmLCBuZWVkbGUsIHRva2VuKTsKICAgIH0KCiAgICAvKgogICAgICogQGRldiBDb3VudHMgdGhlIG51bWJlciBvZiBub25vdmVybGFwcGluZyBvY2N1cnJlbmNlcyBvZiBgbmVlZGxlYCBpbiBgc2VsZmAuCiAgICAgKiBAcGFyYW0gc2VsZiBUaGUgc2xpY2UgdG8gc2VhcmNoLgogICAgICogQHBhcmFtIG5lZWRsZSBUaGUgdGV4dCB0byBzZWFyY2ggZm9yIGluIGBzZWxmYC4KICAgICAqIEByZXR1cm4gVGhlIG51bWJlciBvZiBvY2N1cnJlbmNlcyBvZiBgbmVlZGxlYCBmb3VuZCBpbiBgc2VsZmAuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNvdW50KHNsaWNlIHNlbGYsIHNsaWNlIG5lZWRsZSkgaW50ZXJuYWwgcmV0dXJucyAodWludCBjb3VudCkgewogICAgICAgIHVpbnQgcHRyID0gZmluZFB0cihzZWxmLl9sZW4sIHNlbGYuX3B0ciwgbmVlZGxlLl9sZW4sIG5lZWRsZS5fcHRyKSArIG5lZWRsZS5fbGVuOwogICAgICAgIHdoaWxlIChwdHIgPD0gc2VsZi5fcHRyICsgc2VsZi5fbGVuKSB7CiAgICAgICAgICAgIGNvdW50Kys7CiAgICAgICAgICAgIHB0ciA9IGZpbmRQdHIoc2VsZi5fbGVuIC0gKHB0ciAtIHNlbGYuX3B0ciksIHB0ciwgbmVlZGxlLl9sZW4sIG5lZWRsZS5fcHRyKSArIG5lZWRsZS5fbGVuOwogICAgICAgIH0KICAgIH0KCiAgICAvKgogICAgICogQGRldiBSZXR1cm5zIFRydWUgaWYgYHNlbGZgIGNvbnRhaW5zIGBuZWVkbGVgLgogICAgICogQHBhcmFtIHNlbGYgVGhlIHNsaWNlIHRvIHNlYXJjaC4KICAgICAqIEBwYXJhbSBuZWVkbGUgVGhlIHRleHQgdG8gc2VhcmNoIGZvciBpbiBgc2VsZmAuCiAgICAgKiBAcmV0dXJuIFRydWUgaWYgYG5lZWRsZWAgaXMgZm91bmQgaW4gYHNlbGZgLCBmYWxzZSBvdGhlcndpc2UuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNvbnRhaW5zKHNsaWNlIHNlbGYsIHNsaWNlIG5lZWRsZSkgaW50ZXJuYWwgcmV0dXJucyAoYm9vbCkgewogICAgICAgIHJldHVybiByZmluZFB0cihzZWxmLl9sZW4sIHNlbGYuX3B0ciwgbmVlZGxlLl9sZW4sIG5lZWRsZS5fcHRyKSAhPSBzZWxmLl9wdHI7CiAgICB9CgogICAgLyoKICAgICAqIEBkZXYgUmV0dXJucyBhIG5ld2x5IGFsbG9jYXRlZCBzdHJpbmcgY29udGFpbmluZyB0aGUgY29uY2F0ZW5hdGlvbiBvZgogICAgICogICAgICBgc2VsZmAgYW5kIGBvdGhlcmAuCiAgICAgKiBAcGFyYW0gc2VsZiBUaGUgZmlyc3Qgc2xpY2UgdG8gY29uY2F0ZW5hdGUuCiAgICAgKiBAcGFyYW0gb3RoZXIgVGhlIHNlY29uZCBzbGljZSB0byBjb25jYXRlbmF0ZS4KICAgICAqIEByZXR1cm4gVGhlIGNvbmNhdGVuYXRpb24gb2YgdGhlIHR3byBzdHJpbmdzLgogICAgICovCiAgICBmdW5jdGlvbiBjb25jYXQoc2xpY2Ugc2VsZiwgc2xpY2Ugb3RoZXIpIGludGVybmFsIHJldHVybnMgKHN0cmluZykgewogICAgICAgIHZhciByZXQgPSBuZXcgc3RyaW5nKHNlbGYuX2xlbiArIG90aGVyLl9sZW4pOwogICAgICAgIHVpbnQgcmV0cHRyOwogICAgICAgIGFzc2VtYmx5IHsgcmV0cHRyIDo9IGFkZChyZXQsIDMyKSB9CiAgICAgICAgbWVtY3B5KHJldHB0ciwgc2VsZi5fcHRyLCBzZWxmLl9sZW4pOwogICAgICAgIG1lbWNweShyZXRwdHIgKyBzZWxmLl9sZW4sIG90aGVyLl9wdHIsIG90aGVyLl9sZW4pOwogICAgICAgIHJldHVybiByZXQ7CiAgICB9CgogICAgLyoKICAgICAqIEBkZXYgSm9pbnMgYW4gYXJyYXkgb2Ygc2xpY2VzLCB1c2luZyBgc2VsZmAgYXMgYSBkZWxpbWl0ZXIsIHJldHVybmluZyBhCiAgICAgKiAgICAgIG5ld2x5IGFsbG9jYXRlZCBzdHJpbmcuCiAgICAgKiBAcGFyYW0gc2VsZiBUaGUgZGVsaW1pdGVyIHRvIHVzZS4KICAgICAqIEBwYXJhbSBwYXJ0cyBBIGxpc3Qgb2Ygc2xpY2VzIHRvIGpvaW4uCiAgICAgKiBAcmV0dXJuIEEgbmV3bHkgYWxsb2NhdGVkIHN0cmluZyBjb250YWluaW5nIGFsbCB0aGUgc2xpY2VzIGluIGBwYXJ0c2AsCiAgICAgKiAgICAgICAgIGpvaW5lZCB3aXRoIGBzZWxmYC4KICAgICAqLwogICAgZnVuY3Rpb24gam9pbihzbGljZSBzZWxmLCBzbGljZVtdIHBhcnRzKSBpbnRlcm5hbCByZXR1cm5zIChzdHJpbmcpIHsKICAgICAgICBpZiAocGFydHMubGVuZ3RoID09IDApCiAgICAgICAgICAgIHJldHVybiAiIjsKCiAgICAgICAgdWludCBsZW4gPSBzZWxmLl9sZW4gKiAocGFydHMubGVuZ3RoIC0gMSk7CiAgICAgICAgZm9yKHVpbnQgaSA9IDA7IGkgPCBwYXJ0cy5sZW5ndGg7IGkrKykKICAgICAgICAgICAgbGVuICs9IHBhcnRzW2ldLl9sZW47CgogICAgICAgIHZhciByZXQgPSBuZXcgc3RyaW5nKGxlbik7CiAgICAgICAgdWludCByZXRwdHI7CiAgICAgICAgYXNzZW1ibHkgeyByZXRwdHIgOj0gYWRkKHJldCwgMzIpIH0KCiAgICAgICAgZm9yKGkgPSAwOyBpIDwgcGFydHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgbWVtY3B5KHJldHB0ciwgcGFydHNbaV0uX3B0ciwgcGFydHNbaV0uX2xlbik7CiAgICAgICAgICAgIHJldHB0ciArPSBwYXJ0c1tpXS5fbGVuOwogICAgICAgICAgICBpZiAoaSA8IHBhcnRzLmxlbmd0aCAtIDEpIHsKICAgICAgICAgICAgICAgIG1lbWNweShyZXRwdHIsIHNlbGYuX3B0ciwgc2VsZi5fbGVuKTsKICAgICAgICAgICAgICAgIHJldHB0ciArPSBzZWxmLl9sZW47CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiByZXQ7CiAgICB9Cn0KCgpjb250cmFjdCBEU1NhZmVBZGRTdWIgewogICAgZnVuY3Rpb24gc2FmZVRvQWRkKHVpbnQgYSwgdWludCBiKSBpbnRlcm5hbCByZXR1cm5zIChib29sKSB7CiAgICAgICAgcmV0dXJuIChhICsgYiA+PSBhKTsKICAgIH0KICAgIGZ1bmN0aW9uIHNhZmVBZGQodWludCBhLCB1aW50IGIpIGludGVybmFsIHJldHVybnMgKHVpbnQpIHsKICAgICAgICBpZiAoIXNhZmVUb0FkZChhLCBiKSkgdGhyb3c7CiAgICAgICAgcmV0dXJuIGEgKyBiOwogICAgfQoKICAgIGZ1bmN0aW9uIHNhZmVUb1N1YnRyYWN0KHVpbnQgYSwgdWludCBiKSBpbnRlcm5hbCByZXR1cm5zIChib29sKSB7CiAgICAgICAgcmV0dXJuIChiIDw9IGEpOwogICAgfQoKICAgIGZ1bmN0aW9uIHNhZmVTdWIodWludCBhLCB1aW50IGIpIGludGVybmFsIHJldHVybnMgKHVpbnQpIHsKICAgICAgICBpZiAoIXNhZmVUb1N1YnRyYWN0KGEsIGIpKSB0aHJvdzsKICAgICAgICByZXR1cm4gYSAtIGI7CiAgICB9IAp9CgoKCmNvbnRyYWN0IEV0aGVyb2xsIGlzIHVzaW5nT3JhY2xpemUsIERTU2FmZUFkZFN1YiB7CiAgICAKICAgICB1c2luZyBzdHJpbmdzIGZvciAqOwoKICAgIC8qCiAgICAgKiBjaGVja3MgcGxheWVyIHByb2ZpdCwgYmV0IHNpemUgYW5kIHBsYXllciBudW1iZXIgaXMgd2l0aGluIHJhbmdlCiAgICAqLwogICAgbW9kaWZpZXIgYmV0SXNWYWxpZCh1aW50IF9iZXRTaXplLCB1aW50IF9wbGF5ZXJOdW1iZXIpIHsgICAgICAKICAgICAgICBpZigoKCgoX2JldFNpemUgKiAoMTAwLShzYWZlU3ViKF9wbGF5ZXJOdW1iZXIsMSkpKSkgLyAoc2FmZVN1YihfcGxheWVyTnVtYmVyLDEpKStfYmV0U2l6ZSkpKmhvdXNlRWRnZS9ob3VzZUVkZ2VEaXZpc29yKS1fYmV0U2l6ZSA+IG1heFByb2ZpdCB8fCBfYmV0U2l6ZSA8IG1pbkJldCB8fCBfcGxheWVyTnVtYmVyIDwgbWluTnVtYmVyIHx8IF9wbGF5ZXJOdW1iZXIgPiBtYXhOdW1iZXIpIHRocm93OyAgICAgICAgCgkJXzsKICAgIH0KCiAgICAvKgogICAgICogY2hlY2tzIGdhbWUgaXMgY3VycmVudGx5IGFjdGl2ZQogICAgKi8KICAgIG1vZGlmaWVyIGdhbWVJc0FjdGl2ZSB7CiAgICAgICAgaWYoZ2FtZVBhdXNlZCA9PSB0cnVlKSB0aHJvdzsKCQlfOwogICAgfSAgICAKCiAgICAvKgogICAgICogY2hlY2tzIHBheW91dHMgYXJlIGN1cnJlbnRseSBhY3RpdmUKICAgICovCiAgICBtb2RpZmllciBwYXlvdXRzQXJlQWN0aXZlIHsKICAgICAgICBpZihwYXlvdXRzUGF1c2VkID09IHRydWUpIHRocm93OwoJCV87CiAgICB9ICAgIAoKICAgIC8qCiAgICAgKiBjaGVja3Mgb25seSBPcmFjbGl6ZSBhZGRyZXNzIGlzIGNhbGxpbmcKICAgICovCiAgICBtb2RpZmllciBvbmx5T3JhY2xpemUgewogICAgICAgIGlmIChtc2cuc2VuZGVyICE9IG9yYWNsaXplX2NiQWRkcmVzcygpKSB0aHJvdzsKICAgICAgICBfOwogICAgfQoKICAgIC8qCiAgICAgKiBjaGVja3Mgb25seSBvd25lciBhZGRyZXNzIGlzIGNhbGxpbmcKICAgICovCiAgICBtb2RpZmllciBvbmx5T3duZXIgewogICAgICAgICBpZiAobXNnLnNlbmRlciAhPSBvd25lcikgdGhyb3c7CiAgICAgICAgIF87CiAgICB9CgogICAgLyoKICAgICAqIGNoZWNrcyBvbmx5IHRyZWFzdXJ5IGFkZHJlc3MgaXMgY2FsbGluZwogICAgKi8KICAgIG1vZGlmaWVyIG9ubHlUcmVhc3VyeSB7CiAgICAgICAgIGlmIChtc2cuc2VuZGVyICE9IHRyZWFzdXJ5KSB0aHJvdzsKICAgICAgICAgXzsKICAgIH0gICAgCgogICAgLyoKICAgICAqIGdhbWUgdmFycwogICAgKi8gCiAgICB1aW50IGNvbnN0YW50IHB1YmxpYyBtYXhQcm9maXREaXZpc29yID0gMTAwMDAwMDsKICAgIHVpbnQgY29uc3RhbnQgcHVibGljIGhvdXNlRWRnZURpdmlzb3IgPSAxMDAwOyAgICAKICAgIHVpbnQgY29uc3RhbnQgcHVibGljIG1heE51bWJlciA9IDk5OyAKICAgIHVpbnQgY29uc3RhbnQgcHVibGljIG1pbk51bWJlciA9IDI7Cglib29sIHB1YmxpYyBnYW1lUGF1c2VkOwogICAgdWludDMyIHB1YmxpYyBnYXNGb3JPcmFjbGl6ZTsKICAgIGFkZHJlc3MgcHVibGljIG93bmVyOwogICAgYm9vbCBwdWJsaWMgcGF5b3V0c1BhdXNlZDsgCiAgICBhZGRyZXNzIHB1YmxpYyB0cmVhc3VyeTsKICAgIHVpbnQgcHVibGljIGNvbnRyYWN0QmFsYW5jZTsKICAgIHVpbnQgcHVibGljIGhvdXNlRWRnZTsgICAgIAogICAgdWludCBwdWJsaWMgbWF4UHJvZml0OyAgIAogICAgdWludCBwdWJsaWMgbWF4UHJvZml0QXNQZXJjZW50T2ZIb3VzZTsgICAgICAgICAgICAgICAgICAgIAogICAgdWludCBwdWJsaWMgbWluQmV0OyAgICAgICAKICAgIGludCBwdWJsaWMgdG90YWxCZXRzOwogICAgdWludCBwdWJsaWMgbWF4UGVuZGluZ1BheW91dHM7CiAgICB1aW50IHB1YmxpYyB0b3RhbFdlaVdvbjsKICAgIHVpbnQgcHVibGljIHRvdGFsV2VpV2FnZXJlZDsgICAgCgogICAgLyoKICAgICAqIHBsYXllciB2YXJzCiAgICAqLwogICAgbWFwcGluZyAoYnl0ZXMzMiA9PiBhZGRyZXNzKSBwbGF5ZXJBZGRyZXNzOwogICAgbWFwcGluZyAoYnl0ZXMzMiA9PiBhZGRyZXNzKSBwbGF5ZXJUZW1wQWRkcmVzczsKICAgIG1hcHBpbmcgKGJ5dGVzMzIgPT4gYnl0ZXMzMikgcGxheWVyQmV0SWQ7CiAgICBtYXBwaW5nIChieXRlczMyID0+IHVpbnQpIHBsYXllckJldFZhbHVlOwogICAgbWFwcGluZyAoYnl0ZXMzMiA9PiB1aW50KSBwbGF5ZXJUZW1wQmV0VmFsdWU7ICAKICAgIG1hcHBpbmcgKGJ5dGVzMzIgPT4gdWludCkgcGxheWVyUmFuZG9tUmVzdWx0OyAgICAgCiAgICBtYXBwaW5nIChieXRlczMyID0+IHVpbnQpIHBsYXllckRpZVJlc3VsdDsKICAgIG1hcHBpbmcgKGJ5dGVzMzIgPT4gdWludCkgcGxheWVyTnVtYmVyOwogICAgbWFwcGluZyAoYWRkcmVzcyA9PiB1aW50KSBwbGF5ZXJQZW5kaW5nV2l0aGRyYXdhbHM7ICAgICAgCiAgICBtYXBwaW5nIChieXRlczMyID0+IHVpbnQpIHBsYXllclByb2ZpdDsKICAgIG1hcHBpbmcgKGJ5dGVzMzIgPT4gdWludCkgcGxheWVyVGVtcFJld2FyZDsgICAgCiAgICAgICAgCgogICAgLyoKICAgICAqIGV2ZW50cwogICAgKi8KICAgIC8qIGxvZyBiZXRzICsgb3V0cHV0IHRvIHdlYjMgZm9yIHByZWNpc2UgJ3BheW91dCBvbiB3aW4nIGZpZWxkIGluIFVJICovCiAgICBldmVudCBMb2dCZXQoYnl0ZXMzMiBpbmRleGVkIEJldElELCBhZGRyZXNzIGluZGV4ZWQgUGxheWVyQWRkcmVzcywgdWludCBpbmRleGVkIFJld2FyZFZhbHVlLCB1aW50IFByb2ZpdFZhbHVlLCB1aW50IEJldFZhbHVlLCB1aW50IFBsYXllck51bWJlcik7ICAgICAgCiAgICAvKiBvdXRwdXQgdG8gd2ViMyBVSSBvbiBiZXQgcmVzdWx0Ki8KICAgIC8qIFN0YXR1czogMD1sb3NlLCAxPXdpbiwgMj13aW4gKyBmYWlsZWQgc2VuZCwgMz1yZWZ1bmQsIDQ9cmVmdW5kICsgZmFpbGVkIHNlbmQqLwoJZXZlbnQgTG9nUmVzdWx0KHVpbnQgaW5kZXhlZCBSZXN1bHRTZXJpYWxOdW1iZXIsIGJ5dGVzMzIgaW5kZXhlZCBCZXRJRCwgYWRkcmVzcyBpbmRleGVkIFBsYXllckFkZHJlc3MsIHVpbnQgUGxheWVyTnVtYmVyLCB1aW50IERpY2VSZXN1bHQsIHVpbnQgVmFsdWUsIGludCBTdGF0dXMsIGJ5dGVzIFByb29mKTsgICAKICAgIC8qIGxvZyBtYW51YWwgcmVmdW5kcyAqLwogICAgZXZlbnQgTG9nUmVmdW5kKGJ5dGVzMzIgaW5kZXhlZCBCZXRJRCwgYWRkcmVzcyBpbmRleGVkIFBsYXllckFkZHJlc3MsIHVpbnQgaW5kZXhlZCBSZWZ1bmRWYWx1ZSk7CiAgICAvKiBsb2cgb3duZXIgdHJhbnNmZXJzICovCiAgICBldmVudCBMb2dPd25lclRyYW5zZmVyKGFkZHJlc3MgaW5kZXhlZCBTZW50VG9BZGRyZXNzLCB1aW50IGluZGV4ZWQgQW1vdW50VHJhbnNmZXJyZWQpOyAgICAgICAgICAgICAgIAoKCiAgICAvKgogICAgICogaW5pdAogICAgKi8KICAgIGZ1bmN0aW9uIEV0aGVyb2xsKCkgewoKICAgICAgICBvd25lciA9IG1zZy5zZW5kZXI7CiAgICAgICAgdHJlYXN1cnkgPSBtc2cuc2VuZGVyOwogICAgICAgIAogICAgICAgIG9yYWNsaXplX3NldE5ldHdvcmsobmV0d29ya0lEX2F1dG8pOyAgICAgICAgCiAgICAgICAgLyogdXNlIFRMU05vdGFyeSBmb3Igb3JhY2xpemUgY2FsbCAqLwoJCW9yYWNsaXplX3NldFByb29mKHByb29mVHlwZV9UTFNOb3RhcnkgfCBwcm9vZlN0b3JhZ2VfSVBGUyk7CiAgICAgICAgLyogaW5pdCA5OTAgPSA5OSUgKDElIGhvdXNlRWRnZSkqLwogICAgICAgIG93bmVyU2V0SG91c2VFZGdlKDk5MCk7CiAgICAgICAgLyogaW5pdCAxMCwwMDAgPSAxJSAgKi8KICAgICAgICBvd25lclNldE1heFByb2ZpdEFzUGVyY2VudE9mSG91c2UoMTAwMDApOwogICAgICAgIC8qIGluaXQgbWluIGJldCAoMC4xIGV0aGVyKSAqLwogICAgICAgIG93bmVyU2V0TWluQmV0KDEwMDAwMDAwMDAwMDAwMDAwMCk7ICAgICAgICAKICAgICAgICAvKiBpbml0IGdhcyBmb3Igb3JhY2xpemUgKi8gICAgICAgIAogICAgICAgIGdhc0Zvck9yYWNsaXplID0gMjUwMDAwOyAgICAgICAgCgogICAgfQoKICAgIC8qCiAgICAgKiBwdWJsaWMgZnVuY3Rpb24KICAgICAqIHBsYXllciBzdWJtaXQgYmV0CiAgICAgKiBvbmx5IGlmIGdhbWUgaXMgYWN0aXZlICYgYmV0IGlzIHZhbGlkIGNhbiBxdWVyeSBvcmFjbGl6ZSBhbmQgc2V0IHBsYXllciB2YXJzICAgICAKICAgICovCiAgICBmdW5jdGlvbiBwbGF5ZXJSb2xsRGljZSh1aW50IHJvbGxVbmRlcikgcHVibGljIAogICAgICAgIHBheWFibGUKICAgICAgICBnYW1lSXNBY3RpdmUKICAgICAgICBiZXRJc1ZhbGlkKG1zZy52YWx1ZSwgcm9sbFVuZGVyKQoJeyAgICAgICAgCiAgICAgICAgCgogICAgICAgIC8qIHNhZmVseSB1cGRhdGUgY29udHJhY3QgYmFsYW5jZSB0byBhY2NvdW50IGZvciBjb3N0IHRvIGNhbGwgb3JhY2xpemUqLwogICAgICAgIGNvbnRyYWN0QmFsYW5jZSA9IHNhZmVTdWIoY29udHJhY3RCYWxhbmNlLCBvcmFjbGl6ZV9nZXRQcmljZSgiVVJMIiwgZ2FzRm9yT3JhY2xpemUpKTsKCiAgICAgICAgLyogdG90YWwgbnVtYmVyIG9mIGJldHMgKi8KICAgICAgICB0b3RhbEJldHMgKz0gMTsKCiAgICAgICAgLyogdG90YWwgd2FnZXJlZCAqLwogICAgICAgIHRvdGFsV2VpV2FnZXJlZCArPSBtc2cudmFsdWU7IAoKICAgICAgICAvKgogICAgICAgICogYXNzaWduIHBhcnRpYWxseSBlbmNyeXB0ZWQgcXVlcnkgdG8gb3JhY2xpemUKICAgICAgICAqIG9ubHkgdGhlIGFwaUtleSBpcyBlbmNyeXB0ZWQgCiAgICAgICAgKiBpbnRlZ2VyIHF1ZXJ5IGlzIGluIHBsYWluIHRleHQKICAgICAgICAqLwogICAgICAgIGJ5dGVzMzIgcm5nSWQgPSBvcmFjbGl6ZV9xdWVyeSgibmVzdGVkIiwgIltVUkxdIFsnanNvbihodHRwczovL2FwaS5yYW5kb20ub3JnL2pzb24tcnBjLzEvaW52b2tlKS5yZXN1bHQucmFuZG9tW1wic2VyaWFsTnVtYmVyXCIsXCJkYXRhXCJdJywgJ1xcbntcImpzb25ycGNcIjpcIjIuMFwiLFwibWV0aG9kXCI6XCJnZW5lcmF0ZVNpZ25lZEludGVnZXJzXCIsXCJwYXJhbXNcIjp7XCJhcGlLZXlcIjoke1tkZWNyeXB0XSBCSHJzdU1ycUdZR1JWbzZLZnJuaW00dUlwVUh2TWZTWjdHdXpoNVJ5blc5VkhtSXNwQmFSeUJzbC9adEdXOTRUZ1R5eERyOWM4Wmt2NUlpdmMwSGFZdjQ3amhCNUR0ZTgvSWlZaUJGams1WDh1anRac3FsQk9WRFk5UDVIYmF3ZlNQMTFpWVp3UGtoWmMyUHlTNE5mZTBhT295VlpLaUE9fSxcIm5cIjoxLFwibWluXCI6MSxcIm1heFwiOjEwMCxcInJlcGxhY2VtZW50XCI6dHJ1ZSxcImJhc2VcIjoxMCR7W2lkZW50aXR5XSBcIn1cIn0sXCJpZFwiOjEke1tpZGVudGl0eV0gXCJ9XCJ9J10iLCBnYXNGb3JPcmFjbGl6ZSk7CiAgICAgICAgCSAgICAKICAgICAgICAvKiBtYXAgYmV0IGlkIHRvIHRoaXMgb3JhY2xpemUgcXVlcnkgKi8KCQlwbGF5ZXJCZXRJZFtybmdJZF0gPSBybmdJZDsKICAgICAgICAvKiBtYXAgcGxheWVyIGx1Y2t5IG51bWJlciB0byB0aGlzIG9yYWNsaXplIHF1ZXJ5ICovCgkJcGxheWVyTnVtYmVyW3JuZ0lkXSA9IHJvbGxVbmRlcjsKICAgICAgICAvKiBtYXAgdmFsdWUgb2Ygd2FnZXIgdG8gdGhpcyBvcmFjbGl6ZSBxdWVyeSAqLwogICAgICAgIHBsYXllckJldFZhbHVlW3JuZ0lkXSA9IG1zZy52YWx1ZTsKICAgICAgICAvKiBtYXAgcGxheWVyIGFkZHJlc3MgdG8gdGhpcyBvcmFjbGl6ZSBxdWVyeSAqLwogICAgICAgIHBsYXllckFkZHJlc3Nbcm5nSWRdID0gbXNnLnNlbmRlcjsKICAgICAgICAvKiBzYWZlbHkgbWFwIHBsYXllciBwcm9maXQgdG8gdGhpcyBvcmFjbGl6ZSBxdWVyeSAqLyAgICAgICAgICAgICAgICAgICAgIAogICAgICAgIHBsYXllclByb2ZpdFtybmdJZF0gPSAoKCgobXNnLnZhbHVlICogKDEwMC0oc2FmZVN1Yihyb2xsVW5kZXIsMSkpKSkgLyAoc2FmZVN1Yihyb2xsVW5kZXIsMSkpK21zZy52YWx1ZSkpKmhvdXNlRWRnZS9ob3VzZUVkZ2VEaXZpc29yKS1tc2cudmFsdWU7ICAgICAgICAKICAgICAgICAvKiBzYWZlbHkgaW5jcmVhc2UgbWF4UGVuZGluZ1BheW91dHMgbGlhYmlsaXR5IC0gY2FsYyBhbGwgcGVuZGluZyBwYXlvdXRzIHVuZGVyIGFzc3VtcHRpb24gdGhleSB3aW4gKi8KICAgICAgICBtYXhQZW5kaW5nUGF5b3V0cyA9IHNhZmVBZGQobWF4UGVuZGluZ1BheW91dHMsIHBsYXllclByb2ZpdFtybmdJZF0pOwogICAgICAgIC8qIGNoZWNrIGNvbnRyYWN0IGNhbiBwYXlvdXQgb24gd2luICovCiAgICAgICAgaWYobWF4UGVuZGluZ1BheW91dHMgPj0gY29udHJhY3RCYWxhbmNlKSB0aHJvdzsKICAgICAgICAvKiBwcm92aWRlcyBhY2N1cmF0ZSBudW1iZXJzIGZvciB3ZWIzIGFuZCBhbGxvd3MgZm9yIG1hbnVhbCByZWZ1bmRzIGluIGNhc2Ugb2Ygbm8gb3JhY2xpemUgX19jYWxsYmFjayAqLwogICAgICAgIExvZ0JldChwbGF5ZXJCZXRJZFtybmdJZF0sIHBsYXllckFkZHJlc3Nbcm5nSWRdLCBzYWZlQWRkKHBsYXllckJldFZhbHVlW3JuZ0lkXSwgcGxheWVyUHJvZml0W3JuZ0lkXSksIHBsYXllclByb2ZpdFtybmdJZF0sIHBsYXllckJldFZhbHVlW3JuZ0lkXSwgcGxheWVyTnVtYmVyW3JuZ0lkXSk7ICAgICAgICAgIAoKICAgIH0gICAKICAgICAgICAgICAgIAoKICAgIC8qCiAgICAqIHNlbWktcHVibGljIGZ1bmN0aW9uIC0gb25seSBvcmFjbGl6ZSBjYW4gY2FsbAogICAgKi8KICAgIC8qVExTTm90YXJ5IGZvciBvcmFjbGl6ZSBjYWxsICovCglmdW5jdGlvbiBfX2NhbGxiYWNrKGJ5dGVzMzIgbXlpZCwgc3RyaW5nIHJlc3VsdCwgYnl0ZXMgcHJvb2YpIHB1YmxpYyAgIAoJCW9ubHlPcmFjbGl6ZQoJCXBheW91dHNBcmVBY3RpdmUKCXsgIAoKICAgICAgICAvKiBwbGF5ZXIgYWRkcmVzcyBtYXBwZWQgdG8gcXVlcnkgaWQgZG9lcyBub3QgZXhpc3QgKi8KICAgICAgICBpZiAocGxheWVyQWRkcmVzc1tteWlkXT09MHgwKSB0aHJvdzsKICAgICAgICAKICAgICAgICAvKiBrZWVwIG9yYWNsaXplIGhvbmVzdCBieSByZXRyaWV2aW5nIHRoZSBzZXJpYWxOdW1iZXIgZnJvbSByYW5kb20ub3JnIHJlc3VsdCAqLwogICAgICAgIHZhciBzbF9yZXN1bHQgPSByZXN1bHQudG9TbGljZSgpOwogICAgICAgIHNsX3Jlc3VsdC5iZXlvbmQoIlsiLnRvU2xpY2UoKSkudW50aWwoIl0iLnRvU2xpY2UoKSk7CiAgICAgICAgdWludCBzZXJpYWxOdW1iZXJPZlJlc3VsdCA9IHBhcnNlSW50KHNsX3Jlc3VsdC5zcGxpdCgnLCAnLnRvU2xpY2UoKSkudG9TdHJpbmcoKSk7ICAgICAgICAgIAoKCSAgICAvKiBtYXAgcmVzdWx0IHRvIHBsYXllciAqLwogICAgICAgIHBsYXllclJhbmRvbVJlc3VsdFtteWlkXSA9IHBhcnNlSW50KHNsX3Jlc3VsdC5iZXlvbmQoIlsiLnRvU2xpY2UoKSkudW50aWwoIl0iLnRvU2xpY2UoKSkudG9TdHJpbmcoKSk7CiAgICAgICAgCiAgICAgICAgLyogcHJvZHVjZSBpbnRlZ2VyIGJvdW5kZWQgdG8gMS0xMDAgaW5jbHVzaXZlCiAgICAgICAgKiAgdmlhIHNoYTMgcmVzdWx0IGZyb20gcmFuZG9tLm9yZyBhbmQgcHJvb2YgKElQRlMgYWRkcmVzcyBvZiBUTFNOb3RhcnkgcHJvb2YpCiAgICAgICAgKi8KICAgICAgICBwbGF5ZXJEaWVSZXN1bHRbbXlpZF0gPSB1aW50KHNoYTMocGxheWVyUmFuZG9tUmVzdWx0W215aWRdLCBwcm9vZikpICUgMTAwICsgMTsKICAgICAgICAKICAgICAgICAvKiBnZXQgdGhlIHBsYXllckFkZHJlc3MgZm9yIHRoaXMgcXVlcnkgaWQgKi8KICAgICAgICBwbGF5ZXJUZW1wQWRkcmVzc1tteWlkXSA9IHBsYXllckFkZHJlc3NbbXlpZF07CiAgICAgICAgLyogZGVsZXRlIHBsYXllckFkZHJlc3MgZm9yIHRoaXMgcXVlcnkgaWQgKi8KICAgICAgICBkZWxldGUgcGxheWVyQWRkcmVzc1tteWlkXTsKCiAgICAgICAgLyogbWFwIHRoZSBwbGF5ZXJQcm9maXQgZm9yIHRoaXMgcXVlcnkgaWQgKi8KICAgICAgICBwbGF5ZXJUZW1wUmV3YXJkW215aWRdID0gcGxheWVyUHJvZml0W215aWRdOwogICAgICAgIC8qIHNldCAgcGxheWVyUHJvZml0IGZvciB0aGlzIHF1ZXJ5IGlkIHRvIDAgKi8KICAgICAgICBwbGF5ZXJQcm9maXRbbXlpZF0gPSAwOyAKCiAgICAgICAgLyogc2FmZWx5IHJlZHVjZSBtYXhQZW5kaW5nUGF5b3V0cyBsaWFiaWxpdHkgKi8KICAgICAgICBtYXhQZW5kaW5nUGF5b3V0cyA9IHNhZmVTdWIobWF4UGVuZGluZ1BheW91dHMsIHBsYXllclRlbXBSZXdhcmRbbXlpZF0pOyAgICAgICAgIAoKICAgICAgICAvKiBtYXAgdGhlIHBsYXllckJldFZhbHVlIGZvciB0aGlzIHF1ZXJ5IGlkICovCiAgICAgICAgcGxheWVyVGVtcEJldFZhbHVlW215aWRdID0gcGxheWVyQmV0VmFsdWVbbXlpZF07CiAgICAgICAgLyogc2V0ICBwbGF5ZXJCZXRWYWx1ZSBmb3IgdGhpcyBxdWVyeSBpZCB0byAwICovCiAgICAgICAgcGxheWVyQmV0VmFsdWVbbXlpZF0gPSAwOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAoKICAgICAgICAvKgogICAgICAgICogcmVmdW5kCiAgICAgICAgKiBpZiByZXN1bHQgZnJvbSBvcmFjbGl6ZSBpcyAwIHJlZnVuZCBvbmx5IHRoZSBvcmlnaW5hbCBiZXQgdmFsdWUKICAgICAgICAqIGlmIHJlZnVuZCBmYWlscyBzYXZlIHJlZnVuZCB2YWx1ZSB0byBwbGF5ZXJQZW5kaW5nV2l0aGRyYXdhbHMKICAgICAgICAqLwogICAgICAgIGlmKHBsYXllckRpZVJlc3VsdFtteWlkXT09MCl7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKCiAgICAgICAgICAgICBMb2dSZXN1bHQoc2VyaWFsTnVtYmVyT2ZSZXN1bHQsIHBsYXllckJldElkW215aWRdLCBwbGF5ZXJUZW1wQWRkcmVzc1tteWlkXSwgcGxheWVyTnVtYmVyW215aWRdLCBwbGF5ZXJEaWVSZXN1bHRbbXlpZF0sIHBsYXllclRlbXBCZXRWYWx1ZVtteWlkXSwgMywgcHJvb2YpOyAgICAgICAgICAgIAoKICAgICAgICAgICAgLyoKICAgICAgICAgICAgKiBzZW5kIHJlZnVuZCAtIGV4dGVybmFsIGNhbGwgdG8gYW4gdW50cnVzdGVkIGNvbnRyYWN0CiAgICAgICAgICAgICogaWYgc2VuZCBmYWlscyBtYXAgcmVmdW5kIHZhbHVlIHRvIHBsYXllclBlbmRpbmdXaXRoZHJhd2Fsc1thZGRyZXNzXQogICAgICAgICAgICAqIGZvciB3aXRoZHJhd2FsIGxhdGVyIHZpYSBwbGF5ZXJXaXRoZHJhd1BlbmRpbmdUcmFuc2FjdGlvbnMKICAgICAgICAgICAgKi8KICAgICAgICAgICAgaWYoIXBsYXllclRlbXBBZGRyZXNzW215aWRdLnNlbmQocGxheWVyVGVtcEJldFZhbHVlW215aWRdKSl7CiAgICAgICAgICAgICAgICBMb2dSZXN1bHQoc2VyaWFsTnVtYmVyT2ZSZXN1bHQsIHBsYXllckJldElkW215aWRdLCBwbGF5ZXJUZW1wQWRkcmVzc1tteWlkXSwgcGxheWVyTnVtYmVyW215aWRdLCBwbGF5ZXJEaWVSZXN1bHRbbXlpZF0sIHBsYXllclRlbXBCZXRWYWx1ZVtteWlkXSwgNCwgcHJvb2YpOyAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvKiBpZiBzZW5kIGZhaWxlZCBsZXQgcGxheWVyIHdpdGhkcmF3IHZpYSBwbGF5ZXJXaXRoZHJhd1BlbmRpbmdUcmFuc2FjdGlvbnMgKi8KICAgICAgICAgICAgICAgIHBsYXllclBlbmRpbmdXaXRoZHJhd2Fsc1twbGF5ZXJUZW1wQWRkcmVzc1tteWlkXV0gPSBzYWZlQWRkKHBsYXllclBlbmRpbmdXaXRoZHJhd2Fsc1twbGF5ZXJUZW1wQWRkcmVzc1tteWlkXV0sIHBsYXllclRlbXBCZXRWYWx1ZVtteWlkXSk7ICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIC8qCiAgICAgICAgKiBwYXkgd2lubmVyCiAgICAgICAgKiB1cGRhdGUgY29udHJhY3QgYmFsYW5jZSB0byBjYWxjdWxhdGUgbmV3IG1heCBiZXQKICAgICAgICAqIHNlbmQgcmV3YXJkCiAgICAgICAgKiBpZiBzZW5kIG9mIHJld2FyZCBmYWlscyBzYXZlIHZhbHVlIHRvIHBsYXllclBlbmRpbmdXaXRoZHJhd2FscyAgICAgICAgCiAgICAgICAgKi8KICAgICAgICBpZihwbGF5ZXJEaWVSZXN1bHRbbXlpZF0gPCBwbGF5ZXJOdW1iZXJbbXlpZF0peyAKCiAgICAgICAgICAgIC8qIHNhZmVseSByZWR1Y2UgY29udHJhY3QgYmFsYW5jZSBieSBwbGF5ZXIgcHJvZml0ICovCiAgICAgICAgICAgIGNvbnRyYWN0QmFsYW5jZSA9IHNhZmVTdWIoY29udHJhY3RCYWxhbmNlLCBwbGF5ZXJUZW1wUmV3YXJkW215aWRdKTsgCgogICAgICAgICAgICAvKiB1cGRhdGUgdG90YWwgd2VpIHdvbiAqLwogICAgICAgICAgICB0b3RhbFdlaVdvbiA9IHNhZmVBZGQodG90YWxXZWlXb24sIHBsYXllclRlbXBSZXdhcmRbbXlpZF0pOyAgICAgICAgICAgICAgCgogICAgICAgICAgICAvKiBzYWZlbHkgY2FsY3VsYXRlIHBheW91dCB2aWEgcHJvZml0IHBsdXMgb3JpZ2luYWwgd2FnZXIgKi8KICAgICAgICAgICAgcGxheWVyVGVtcFJld2FyZFtteWlkXSA9IHNhZmVBZGQocGxheWVyVGVtcFJld2FyZFtteWlkXSwgcGxheWVyVGVtcEJldFZhbHVlW215aWRdKTsgCgogICAgICAgICAgICBMb2dSZXN1bHQoc2VyaWFsTnVtYmVyT2ZSZXN1bHQsIHBsYXllckJldElkW215aWRdLCBwbGF5ZXJUZW1wQWRkcmVzc1tteWlkXSwgcGxheWVyTnVtYmVyW215aWRdLCBwbGF5ZXJEaWVSZXN1bHRbbXlpZF0sIHBsYXllclRlbXBSZXdhcmRbbXlpZF0sIDEsIHByb29mKTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgCgogICAgICAgICAgICAvKiB1cGRhdGUgbWF4aW11bSBwcm9maXQgKi8KICAgICAgICAgICAgc2V0TWF4UHJvZml0KCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvKgogICAgICAgICAgICAqIHNlbmQgd2luIC0gZXh0ZXJuYWwgY2FsbCB0byBhbiB1bnRydXN0ZWQgY29udHJhY3QKICAgICAgICAgICAgKiBpZiBzZW5kIGZhaWxzIG1hcCByZXdhcmQgdmFsdWUgdG8gcGxheWVyUGVuZGluZ1dpdGhkcmF3YWxzW2FkZHJlc3NdCiAgICAgICAgICAgICogZm9yIHdpdGhkcmF3YWwgbGF0ZXIgdmlhIHBsYXllcldpdGhkcmF3UGVuZGluZ1RyYW5zYWN0aW9ucwogICAgICAgICAgICAqLwogICAgICAgICAgICBpZighcGxheWVyVGVtcEFkZHJlc3NbbXlpZF0uc2VuZChwbGF5ZXJUZW1wUmV3YXJkW215aWRdKSl7CiAgICAgICAgICAgICAgICBMb2dSZXN1bHQoc2VyaWFsTnVtYmVyT2ZSZXN1bHQsIHBsYXllckJldElkW215aWRdLCBwbGF5ZXJUZW1wQWRkcmVzc1tteWlkXSwgcGxheWVyTnVtYmVyW215aWRdLCBwbGF5ZXJEaWVSZXN1bHRbbXlpZF0sIHBsYXllclRlbXBSZXdhcmRbbXlpZF0sIDIsIHByb29mKTsgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvKiBpZiBzZW5kIGZhaWxlZCBsZXQgcGxheWVyIHdpdGhkcmF3IHZpYSBwbGF5ZXJXaXRoZHJhd1BlbmRpbmdUcmFuc2FjdGlvbnMgKi8KICAgICAgICAgICAgICAgIHBsYXllclBlbmRpbmdXaXRoZHJhd2Fsc1twbGF5ZXJUZW1wQWRkcmVzc1tteWlkXV0gPSBzYWZlQWRkKHBsYXllclBlbmRpbmdXaXRoZHJhd2Fsc1twbGF5ZXJUZW1wQWRkcmVzc1tteWlkXV0sIHBsYXllclRlbXBSZXdhcmRbbXlpZF0pOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuOwoKICAgICAgICB9CgogICAgICAgIC8qCiAgICAgICAgKiBubyB3aW4KICAgICAgICAqIHNlbmQgMSB3ZWkgdG8gYSBsb3NpbmcgYmV0CiAgICAgICAgKiB1cGRhdGUgY29udHJhY3QgYmFsYW5jZSB0byBjYWxjdWxhdGUgbmV3IG1heCBiZXQKICAgICAgICAqLwogICAgICAgIGlmKHBsYXllckRpZVJlc3VsdFtteWlkXSA+PSBwbGF5ZXJOdW1iZXJbbXlpZF0pewoKICAgICAgICAgICAgTG9nUmVzdWx0KHNlcmlhbE51bWJlck9mUmVzdWx0LCBwbGF5ZXJCZXRJZFtteWlkXSwgcGxheWVyVGVtcEFkZHJlc3NbbXlpZF0sIHBsYXllck51bWJlcltteWlkXSwgcGxheWVyRGllUmVzdWx0W215aWRdLCBwbGF5ZXJUZW1wQmV0VmFsdWVbbXlpZF0sIDAsIHByb29mKTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAoKICAgICAgICAgICAgLyogIAogICAgICAgICAgICAqICBzYWZlIGFkanVzdCBjb250cmFjdEJhbGFuY2UKICAgICAgICAgICAgKiAgc2V0TWF4UHJvZml0CiAgICAgICAgICAgICogIHNlbmQgMSB3ZWkgdG8gbG9zaW5nIGJldAogICAgICAgICAgICAqLwogICAgICAgICAgICBjb250cmFjdEJhbGFuY2UgPSBzYWZlQWRkKGNvbnRyYWN0QmFsYW5jZSwgKHBsYXllclRlbXBCZXRWYWx1ZVtteWlkXS0xKSk7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAoKICAgICAgICAgICAgLyogdXBkYXRlIG1heGltdW0gcHJvZml0ICovCiAgICAgICAgICAgIHNldE1heFByb2ZpdCgpOyAKCiAgICAgICAgICAgIC8qCiAgICAgICAgICAgICogc2VuZCAxIHdlaSAtIGV4dGVybmFsIGNhbGwgdG8gYW4gdW50cnVzdGVkIGNvbnRyYWN0ICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICovCiAgICAgICAgICAgIGlmKCFwbGF5ZXJUZW1wQWRkcmVzc1tteWlkXS5zZW5kKDEpKXsKICAgICAgICAgICAgICAgIC8qIGlmIHNlbmQgZmFpbGVkIGxldCBwbGF5ZXIgd2l0aGRyYXcgdmlhIHBsYXllcldpdGhkcmF3UGVuZGluZ1RyYW5zYWN0aW9ucyAqLyAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgcGxheWVyUGVuZGluZ1dpdGhkcmF3YWxzW3BsYXllclRlbXBBZGRyZXNzW215aWRdXSA9IHNhZmVBZGQocGxheWVyUGVuZGluZ1dpdGhkcmF3YWxzW3BsYXllclRlbXBBZGRyZXNzW215aWRdXSwgMSk7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgfSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCgogICAgICAgICAgICByZXR1cm47CgogICAgICAgIH0KCiAgICB9CiAgICAKICAgIC8qCiAgICAqIHB1YmxpYyBmdW5jdGlvbgogICAgKiBpbiBjYXNlIG9mIGEgZmFpbGVkIHJlZnVuZCBvciB3aW4gc2VuZAogICAgKi8KICAgIGZ1bmN0aW9uIHBsYXllcldpdGhkcmF3UGVuZGluZ1RyYW5zYWN0aW9ucygpIHB1YmxpYyAKICAgICAgICBwYXlvdXRzQXJlQWN0aXZlCiAgICAgICAgcmV0dXJucyAoYm9vbCkKICAgICB7CiAgICAgICAgdWludCB3aXRoZHJhd0Ftb3VudCA9IHBsYXllclBlbmRpbmdXaXRoZHJhd2Fsc1ttc2cuc2VuZGVyXTsKICAgICAgICBwbGF5ZXJQZW5kaW5nV2l0aGRyYXdhbHNbbXNnLnNlbmRlcl0gPSAwOwogICAgICAgIC8qIGV4dGVybmFsIGNhbGwgdG8gdW50cnVzdGVkIGNvbnRyYWN0ICovCiAgICAgICAgaWYgKG1zZy5zZW5kZXIuY2FsbC52YWx1ZSh3aXRoZHJhd0Ftb3VudCkoKSkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvKiBpZiBzZW5kIGZhaWxlZCByZXZlcnQgcGxheWVyUGVuZGluZ1dpdGhkcmF3YWxzW21zZy5zZW5kZXJdID0gMDsgKi8KICAgICAgICAgICAgLyogcGxheWVyIGNhbiB0cnkgdG8gd2l0aGRyYXcgYWdhaW4gbGF0ZXIgKi8KICAgICAgICAgICAgcGxheWVyUGVuZGluZ1dpdGhkcmF3YWxzW21zZy5zZW5kZXJdID0gd2l0aGRyYXdBbW91bnQ7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICB9CgogICAgLyogY2hlY2sgZm9yIHBlbmRpbmcgd2l0aGRyYXdhbHMgICovCiAgICBmdW5jdGlvbiBwbGF5ZXJHZXRQZW5kaW5nVHhCeUFkZHJlc3MoYWRkcmVzcyBhZGRyZXNzVG9DaGVjaykgcHVibGljIGNvbnN0YW50IHJldHVybnMgKHVpbnQpIHsKICAgICAgICByZXR1cm4gcGxheWVyUGVuZGluZ1dpdGhkcmF3YWxzW2FkZHJlc3NUb0NoZWNrXTsKICAgIH0KCiAgICAvKgogICAgKiBpbnRlcm5hbCBmdW5jdGlvbgogICAgKiBzZXRzIG1heCBwcm9maXQKICAgICovCiAgICBmdW5jdGlvbiBzZXRNYXhQcm9maXQoKSBpbnRlcm5hbCB7CiAgICAgICAgbWF4UHJvZml0ID0gKGNvbnRyYWN0QmFsYW5jZSptYXhQcm9maXRBc1BlcmNlbnRPZkhvdXNlKS9tYXhQcm9maXREaXZpc29yOyAgCiAgICB9ICAgCgogICAgLyoKICAgICogb3duZXIvdHJlYXN1cnkgYWRkcmVzcyBvbmx5IGZ1bmN0aW9ucwogICAgKi8KICAgIGZ1bmN0aW9uICgpCiAgICAgICAgcGF5YWJsZQogICAgICAgIG9ubHlUcmVhc3VyeQogICAgewogICAgICAgIC8qIHNhZmVseSB1cGRhdGUgY29udHJhY3QgYmFsYW5jZSAqLwogICAgICAgIGNvbnRyYWN0QmFsYW5jZSA9IHNhZmVBZGQoY29udHJhY3RCYWxhbmNlLCBtc2cudmFsdWUpOyAgICAgICAgCiAgICAgICAgLyogdXBkYXRlIHRoZSBtYXhpbXVtIHByb2ZpdCAqLwogICAgICAgIHNldE1heFByb2ZpdCgpOwogICAgfSAKCiAgICAvKiBzZXQgZ2FzIGZvciBvcmFjbGl6ZSBxdWVyeSAqLwogICAgZnVuY3Rpb24gb3duZXJTZXRPcmFjbGl6ZVNhZmVHYXModWludDMyIG5ld1NhZmVHYXNUb09yYWNsaXplKSBwdWJsaWMgCgkJb25seU93bmVyCgl7CiAgICAJZ2FzRm9yT3JhY2xpemUgPSBuZXdTYWZlR2FzVG9PcmFjbGl6ZTsKICAgIH0KCiAgICAvKiBvbmx5IG93bmVyIGFkanVzdCBjb250cmFjdCBiYWxhbmNlIHZhcmlhYmxlIChvbmx5IHVzZWQgZm9yIG1heCBwcm9maXQgY2FsYykgKi8KICAgIGZ1bmN0aW9uIG93bmVyVXBkYXRlQ29udHJhY3RCYWxhbmNlKHVpbnQgbmV3Q29udHJhY3RCYWxhbmNlSW5XZWkpIHB1YmxpYyAKCQlvbmx5T3duZXIKICAgIHsgICAgICAgIAogICAgICAgY29udHJhY3RCYWxhbmNlID0gbmV3Q29udHJhY3RCYWxhbmNlSW5XZWk7CiAgICB9ICAgIAoKICAgIC8qIG9ubHkgb3duZXIgYWRkcmVzcyBjYW4gc2V0IGhvdXNlRWRnZSAqLwogICAgZnVuY3Rpb24gb3duZXJTZXRIb3VzZUVkZ2UodWludCBuZXdIb3VzZUVkZ2UpIHB1YmxpYyAKCQlvbmx5T3duZXIKICAgIHsKICAgICAgICBob3VzZUVkZ2UgPSBuZXdIb3VzZUVkZ2U7CiAgICB9CgogICAgLyogb25seSBvd25lciBhZGRyZXNzIGNhbiBzZXQgbWF4UHJvZml0QXNQZXJjZW50T2ZIb3VzZSAqLwogICAgZnVuY3Rpb24gb3duZXJTZXRNYXhQcm9maXRBc1BlcmNlbnRPZkhvdXNlKHVpbnQgbmV3TWF4UHJvZml0QXNQZXJjZW50KSBwdWJsaWMgCgkJb25seU93bmVyCiAgICB7CiAgICAgICAgLyogcmVzdHJpY3QgZWFjaCBiZXQgdG8gYSBtYXhpbXVtIHByb2ZpdCBvZiAxJSBjb250cmFjdEJhbGFuY2UgKi8KICAgICAgICBpZihuZXdNYXhQcm9maXRBc1BlcmNlbnQgPiAxMDAwMCkgdGhyb3c7CiAgICAgICAgbWF4UHJvZml0QXNQZXJjZW50T2ZIb3VzZSA9IG5ld01heFByb2ZpdEFzUGVyY2VudDsKICAgICAgICBzZXRNYXhQcm9maXQoKTsKICAgIH0KCiAgICAvKiBvbmx5IG93bmVyIGFkZHJlc3MgY2FuIHNldCBtaW5CZXQgKi8KICAgIGZ1bmN0aW9uIG93bmVyU2V0TWluQmV0KHVpbnQgbmV3TWluaW11bUJldCkgcHVibGljIAoJCW9ubHlPd25lcgogICAgewogICAgICAgIG1pbkJldCA9IG5ld01pbmltdW1CZXQ7CiAgICB9ICAgICAgIAoKICAgIC8qIG9ubHkgb3duZXIgYWRkcmVzcyBjYW4gdHJhbnNmZXIgZXRoZXIgKi8KICAgIGZ1bmN0aW9uIG93bmVyVHJhbnNmZXJFdGhlcihhZGRyZXNzIHNlbmRUbywgdWludCBhbW91bnQpIHB1YmxpYyAKCQlvbmx5T3duZXIKICAgIHsgICAgICAgIAogICAgICAgIC8qIHNhZmVseSB1cGRhdGUgY29udHJhY3QgYmFsYW5jZSB3aGVuIHNlbmRpbmcgb3V0IGZ1bmRzKi8KICAgICAgICBjb250cmFjdEJhbGFuY2UgPSBzYWZlU3ViKGNvbnRyYWN0QmFsYW5jZSwgYW1vdW50KTsJCQogICAgICAgIC8qIHVwZGF0ZSBtYXggcHJvZml0ICovCiAgICAgICAgc2V0TWF4UHJvZml0KCk7CiAgICAgICAgaWYoIXNlbmRUby5zZW5kKGFtb3VudCkpIHRocm93OwogICAgICAgIExvZ093bmVyVHJhbnNmZXIoc2VuZFRvLCBhbW91bnQpOyAKICAgIH0KCiAgICAvKiBvbmx5IG93bmVyIGFkZHJlc3MgY2FuIGRvIG1hbnVhbCByZWZ1bmQKICAgICogdXNlZCBvbmx5IGlmIGJldCBwbGFjZWQgKyBvcmFjbGl6ZSBmYWlsZWQgdG8gX19jYWxsYmFjawogICAgKiBmaWx0ZXIgTG9nQmV0IGJ5IGFkZHJlc3MgYW5kL29yIHBsYXllckJldElkOgogICAgKiBMb2dCZXQocGxheWVyQmV0SWRbcm5nSWRdLCBwbGF5ZXJBZGRyZXNzW3JuZ0lkXSwgc2FmZUFkZChwbGF5ZXJCZXRWYWx1ZVtybmdJZF0sIHBsYXllclByb2ZpdFtybmdJZF0pLCBwbGF5ZXJQcm9maXRbcm5nSWRdLCBwbGF5ZXJCZXRWYWx1ZVtybmdJZF0sIHBsYXllck51bWJlcltybmdJZF0pOwogICAgKiBjaGVjayB0aGUgZm9sbG93aW5nIGxvZ3MgZG8gbm90IGV4aXN0IGZvciBwbGF5ZXJCZXRJZCBhbmQvb3IgcGxheWVyQWRkcmVzc1tybmdJZF0gYmVmb3JlIHJlZnVuZGluZzoKICAgICogTG9nUmVzdWx0IG9yIExvZ1JlZnVuZAogICAgKiBpZiBMb2dSZXN1bHQgZXhpc3RzIHBsYXllciBzaG91bGQgdXNlIHRoZSB3aXRoZHJhdyBwYXR0ZXJuIHBsYXllcldpdGhkcmF3UGVuZGluZ1RyYW5zYWN0aW9ucyAKICAgICovCiAgICBmdW5jdGlvbiBvd25lclJlZnVuZFBsYXllcihieXRlczMyIG9yaWdpbmFsUGxheWVyQmV0SWQsIGFkZHJlc3Mgc2VuZFRvLCB1aW50IG9yaWdpbmFsUGxheWVyUHJvZml0LCB1aW50IG9yaWdpbmFsUGxheWVyQmV0VmFsdWUpIHB1YmxpYyAKCQlvbmx5T3duZXIKICAgIHsgICAgICAgIAogICAgICAgIC8qIHNhZmVseSByZWR1Y2UgcGVuZGluZ1BheW91dHMgYnkgcGxheWVyUHJvZml0W3JuZ0lkXSAqLwogICAgICAgIG1heFBlbmRpbmdQYXlvdXRzID0gc2FmZVN1YihtYXhQZW5kaW5nUGF5b3V0cywgb3JpZ2luYWxQbGF5ZXJQcm9maXQpOwogICAgICAgIC8qIHNlbmQgcmVmdW5kICovCiAgICAgICAgaWYoIXNlbmRUby5zZW5kKG9yaWdpbmFsUGxheWVyQmV0VmFsdWUpKSB0aHJvdzsKICAgICAgICAvKiBsb2cgcmVmdW5kcyAqLwogICAgICAgIExvZ1JlZnVuZChvcmlnaW5hbFBsYXllckJldElkLCBzZW5kVG8sIG9yaWdpbmFsUGxheWVyQmV0VmFsdWUpOyAgICAgICAgCiAgICB9ICAgIAoKICAgIC8qIG9ubHkgb3duZXIgYWRkcmVzcyBjYW4gc2V0IGVtZXJnZW5jeSBwYXVzZSAjMSAqLwogICAgZnVuY3Rpb24gb3duZXJQYXVzZUdhbWUoYm9vbCBuZXdTdGF0dXMpIHB1YmxpYyAKCQlvbmx5T3duZXIKICAgIHsKCQlnYW1lUGF1c2VkID0gbmV3U3RhdHVzOwogICAgfQoKICAgIC8qIG9ubHkgb3duZXIgYWRkcmVzcyBjYW4gc2V0IGVtZXJnZW5jeSBwYXVzZSAjMiAqLwogICAgZnVuY3Rpb24gb3duZXJQYXVzZVBheW91dHMoYm9vbCBuZXdQYXlvdXRTdGF0dXMpIHB1YmxpYyAKCQlvbmx5T3duZXIKICAgIHsKCQlwYXlvdXRzUGF1c2VkID0gbmV3UGF5b3V0U3RhdHVzOwogICAgfSAKCiAgICAvKiBvbmx5IG93bmVyIGFkZHJlc3MgY2FuIHNldCB0cmVhc3VyeSBhZGRyZXNzICovCiAgICBmdW5jdGlvbiBvd25lclNldFRyZWFzdXJ5KGFkZHJlc3MgbmV3VHJlYXN1cnkpIHB1YmxpYyAKCQlvbmx5T3duZXIKCXsKICAgICAgICB0cmVhc3VyeSA9IG5ld1RyZWFzdXJ5OwogICAgfSAgICAgICAgIAoKICAgIC8qIG9ubHkgb3duZXIgYWRkcmVzcyBjYW4gc2V0IG93bmVyIGFkZHJlc3MgKi8KICAgIGZ1bmN0aW9uIG93bmVyQ2hhbmdlT3duZXIoYWRkcmVzcyBuZXdPd25lcikgcHVibGljIAoJCW9ubHlPd25lcgoJewogICAgICAgIG93bmVyID0gbmV3T3duZXI7CiAgICB9CgogICAgLyogb25seSBvd25lciBhZGRyZXNzIGNhbiBzdWljaWRlIC0gZW1lcmdlbmN5ICovCiAgICBmdW5jdGlvbiBvd25lcmtpbGwoKSBwdWJsaWMgCgkJb25seU93bmVyCgl7CgkJc3VpY2lkZShvd25lcik7Cgl9ICAgIAoKCn0='.
	

]
