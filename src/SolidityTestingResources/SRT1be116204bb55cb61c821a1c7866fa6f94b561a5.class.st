Class {
	#name : #SRT1be116204bb55cb61c821a1c7866fa6f94b561a5,
	#superclass : #SRTContracts,
	#category : #SolidityTestingResources
}

{ #category : #base64 }
SRT1be116204bb55cb61c821a1c7866fa6f94b561a5 >> base64 [
	^ 'LyoKVGhlIE1JVCBMaWNlbnNlIChNSVQpCgpDb3B5cmlnaHQgKGMpIDIwMTYgREZJTklUWSBTdGlmdHVuZyAKClBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHkKb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgIlNvZnR3YXJlIiksIHRvIGRlYWwKaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cwp0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsCmNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcwpmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOgoKVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW4gYWxsCmNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCgpUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUgpJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSwKRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFCkFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIKTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwKT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTiBUSEUKU09GVFdBUkUuCiovCgovKioKICogdGl0bGU6ICBUaGUgREZJTklUWSBTdGlmdHVuZyBkb25hdGlvbiBjb250cmFjdCAoRkRDKS4KICogYXV0aG9yOiBUaW1vIEhhbmtlIAogKgogKiBUaGlzIGNvbnRyYWN0IAogKiAgLSBhY2NlcHRzIG9uLWNoYWluIGRvbmF0aW9ucyBmb3IgdGhlIGZvdW5kYXRpb24gaW4gZXRoZXIgCiAqICAtIHRyYWNrcyBvbi1jaGFpbiBhbmQgb2ZmLWNoYWluIGRvbmF0aW9ucyBtYWRlIHRvIHRoZSBmb3VuZGF0aW9uCiAqICAtIGFzc2lnbnMgdW5yZXN0cmljdGVkIHRva2VucyB0byBhZGRyZXNzZXMgcHJvdmlkZWQgYnkgZG9ub3JzCiAqICAtIGFzc2lnbnMgcmVzdHJpY3RlZCB0b2tlbnMgdG8gREZJTklUWSBTdGlmdHVuZyBhbmQgZWFybHkgY29udHJpYnV0b3JzIAogKgogKiBPbi1jaGFpbiBkb25hdGlvbnMgYXJlIHJlY2VpdmVkIGluIGV0aGVyIGFyZSBjb252ZXJ0ZWQgdG8gU3dpc3MgZnJhbmNzIChDSEYpLgogKiBPZmYtY2hhaW4gZG9uYXRpb25zIGFyZSByZWNlaXZlZCBhbmQgcmVjb3JkZWQgZGlyZWN0bHkgaW4gU3dpc3MgZnJhbmNzLgogKiBUb2tlbnMgYXJlIGFzc2lnbmVkIGF0IGEgcmF0ZSBvZiAxMCB0b2tlbnMgcGVyIENIRi4gCiAqCiAqIFRoZXJlIGFyZSB0d28gdHlwZXMgb2YgdG9rZW5zIGluaXRpYWxseS4gVW5yZXN0cmljdGVkIHRva2VucyBhcmUgYXNzaWduZWQgdG8KICogZG9ub3JzIGFuZCByZXN0cmljdGVkIHRva2VucyBhcmUgYXNzaWduZWQgdG8gREZJTklUWSBTdGlmdHVuZyBhbmQgZWFybHkgCiAqIGNvbnRyaWJ1dG9ycy4gUmVzdHJpY3RlZCB0b2tlbnMgYXJlIGNvbnZlcnRlZCB0byB1bnJlc3RyaWN0ZWQgdG9rZW5zIGluIHRoZSAKICogZmluYWxpemF0aW9uIHBoYXNlLCBhZnRlciB3aGljaCBvbmx5IHVucmVzdHJpY3RlZCB0b2tlbnMgZXhpc3QuCiAqCiAqIEFmdGVyIHRoZSBmaW5hbGl6YXRpb24gcGhhc2UsIHRva2VucyBhc3NpZ25lZCB0byBERklOSVRZIFN0aWZ0dW5nIGFuZCBlYXJseSAKICogY29udHJpYnV0b3JzIHdpbGwgbWFrZSB1cCBhIHByZS1kZWZpbmVkIHNoYXJlIG9mIGFsbCB0b2tlbnMuIFRoaXMgaXMgYWNoaWV2ZWQKICogdGhyb3VnaCBidXJuaW5nIGV4Y2VzcyByZXN0cmljdGVkIHRva2VucyBiZWZvcmUgdGhlaXIgcmVzdHJpY3Rpb24gaXMgcmVtb3ZlZC4KICovCgpwcmFnbWEgc29saWRpdHkgXjAuNC42OwoKLy8gaW1wb3J0ICJUb2tlblRyYWNrZXIuc29sIjsKCi8qKgogKiB0aXRsZTogIEEgY29udHJhY3QgdGhhdCB0cmFja3MgbnVtYmVycyBvZiB0b2tlbnMgYXNzaWduZWQgdG8gYWRkcmVzc2VzLiAKICogYXV0aG9yOiBUaW1vIEhhbmtlIAogKgogKiBPcHRpb25hbGx5LCBhc3NpZ25tZW50cyBjYW4gYmUgY2hvc2VuIHRvIGJlIG9mICJyZXN0cmljdGVkIHR5cGUiLiAKICogQmVpbmcgInJlc3RyaWN0ZWQiIG1lYW5zIHRoYXQgdGhlIHRva2VuIGFzc2lnbm1lbnQgbWF5IGxhdGVyIGJlIHBhcnRpYWxseQogKiByZXZlcnRlZCAob3IgdGhlIHRva2VucyAiYnVybmVkIikgYnkgdGhlIGNvbnRyYWN0LiAKICoKICogQWZ0ZXIgYWxsIHRva2VuIGFzc2lnbm1lbnRzIGFyZSBjb21wbGV0ZWQgdGhlIGNvbnRyYWN0CiAqICAgLSBidXJucyBzb21lIHJlc3RyaWN0ZWQgdG9rZW5zCiAqICAgLSByZWxlYXNlcyB0aGUgcmVzdHJpY3Rpb24gb24gdGhlIHJlbWFpbmluZyB0b2tlbnMKICogVGhlIHBlcmNlbnRhZ2Ugb2YgdG9rZW5zIHRoYXQgYnVybmVkIG91dCBvZiBlYWNoIGFzc2lnbm1lbnQgb2YgcmVzdHJpY3RlZAogKiB0b2tlbnMgaXMgY2FsY3VsYXRlZCB0byBhY2hpZXZlIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uOgogKiAgIC0gdGhlIHJlbWFpbmluZyBmb3JtZXJseSByZXN0cmljdGVkIHRva2VucyBjb21iaW5lZCBoYXZlIGEgcHJlLWNvbmZpZ3VyZWQKICogICAgIHNoYXJlIChwZXJjZW50YWdlKSBhbW9uZyBhbGwgcmVtYWluaW5nIHRva2Vucy4KICoKICogT25jZSB0aGUgY29udmVyc2lvbiBwcm9jZXNzIGhhcyBzdGFydGVkIHRoZSBjb250cmFjdCBlbnRlcnMgYSBzdGF0ZSBpbiB3aGljaAogKiBubyBtb3JlIGFzc2lnbm1lbnRzIGNhbiBiZSBtYWRlLgogKi8KCmNvbnRyYWN0IFRva2VuVHJhY2tlciB7CiAgLy8gU2hhcmUgb2YgZm9ybWVybHkgcmVzdHJpY3RlZCB0b2tlbnMgYW1vbmcgYWxsIHRva2VucyBpbiBwZXJjZW50IAogIHVpbnQgcHVibGljIHJlc3RyaWN0ZWRTaGFyZTsgCgogIC8vIE1hcHBpbmcgZnJvbSBhZGRyZXNzIHRvIG51bWJlciBvZiB0b2tlbnMgYXNzaWduZWQgdG8gdGhlIGFkZHJlc3MKICBtYXBwaW5nKGFkZHJlc3MgPT4gdWludCkgcHVibGljIHRva2VuczsKCiAgLy8gTWFwcGluZyBmcm9tIGFkZHJlc3MgdG8gbnVtYmVyIG9mIHRva2VucyBhc3NpZ25lZCB0byB0aGUgYWRkcmVzcyB0aGF0CiAgLy8gdW5kZXJseSBhIHJlc3RyaWN0aW9uCiAgbWFwcGluZyhhZGRyZXNzID0+IHVpbnQpIHB1YmxpYyByZXN0cmljdGlvbnM7CiAgCiAgLy8gVG90YWwgbnVtYmVyIG9mICh1bilyZXN0cmljdGVkIHRva2VucyBjdXJyZW50bHkgaW4gZXhpc3RlbmNlCiAgdWludCBwdWJsaWMgdG90YWxSZXN0cmljdGVkVG9rZW5zOyAKICB1aW50IHB1YmxpYyB0b3RhbFVucmVzdHJpY3RlZFRva2VuczsgCiAgCiAgLy8gVG90YWwgbnVtYmVyIG9mIGluZGl2aWR1YWwgYXNzaWdubWVudCBjYWxscyBoYXZlIGJlZW4gZm9yICh1bilyZXN0cmljdGVkCiAgLy8gdG9rZW5zCiAgdWludCBwdWJsaWMgdG90YWxSZXN0cmljdGVkQXNzaWdubWVudHM7IAogIHVpbnQgcHVibGljIHRvdGFsVW5yZXN0cmljdGVkQXNzaWdubWVudHM7IAoKICAvLyBTdGF0ZSBmbGFnLiBBc3NpZ25tZW50cyBjYW4gb25seSBiZSBtYWRlIGlmIGZhbHNlLiAKICAvLyBTdGFydGluZyB0aGUgY29udmVyc2lvbiAoYnVybikgcHJvY2VzcyBpcnJldmVyc2libHkgc2V0cyB0aGlzIHRvIHRydWUuIAogIGJvb2wgcHVibGljIGFzc2lnbm1lbnRzQ2xvc2VkID0gZmFsc2U7CiAgCiAgLy8gVGhlIG11bHRpcGxpZXIgKGRlZmluZWQgYnkgbm9taW5hdG9yIGFuZCBkZW5vbWluYXRvcikgdGhhdCBkZWZpbmVzIHRoZQogIC8vIGZyYWN0aW9uIG9mIGFsbCByZXN0cmljdGVkIHRva2VucyB0byBiZSBidXJuZWQuIAogIC8vIFRoaXMgaXMgY29tcHV0ZWQgYWZ0ZXIgYXNzaWdubWVudHMgaGF2ZSBlbmRlZCBhbmQgYmVmb3JlIHRoZSBjb252ZXJzaW9uCiAgLy8gcHJvY2VzcyBzdGFydHMuCiAgdWludCBwdWJsaWMgYnVybk11bHREZW47CiAgdWludCBwdWJsaWMgYnVybk11bHROb207CgogIGZ1bmN0aW9uIFRva2VuVHJhY2tlcih1aW50IF9yZXN0cmljdGVkU2hhcmUpIHsKICAgIC8vIFRocm93IGlmIHJlc3RyaWN0ZWQgc2hhcmUgPj0gMTAwCiAgICBpZiAoX3Jlc3RyaWN0ZWRTaGFyZSA+PSAxMDApIHsgdGhyb3c7IH0KICAgIAogICAgcmVzdHJpY3RlZFNoYXJlID0gX3Jlc3RyaWN0ZWRTaGFyZTsKICB9CiAgCiAgLyoqIAogICAqIFBVQkxJQyBmdW5jdGlvbnMKICAgKgogICAqICAtIGlzVW5yZXN0cmljdGVkIChnZXR0ZXIpCiAgICogIC0gbXVsdEZyYWNDZWlsaW5nIChsaWJyYXJ5IGZ1bmN0aW9uKQogICAqICAtIGlzUmVnaXN0ZXJlZChhZGRyKSAoZ2V0dGVyKQogICAqLwogIAogIC8qKgogICAqIFJldHVybiB0cnVlIGlmZiB0aGUgYXNzaWdubWVudHMgYXJlIGNsb3NlZCBhbmQgdGhlcmUgYXJlIG5vIHJlc3RyaWN0ZWQKICAgKiB0b2tlbnMgbGVmdCAKICAgKi8KICBmdW5jdGlvbiBpc1VucmVzdHJpY3RlZCgpIGNvbnN0YW50IHJldHVybnMgKGJvb2wpIHsKICAgIHJldHVybiAoYXNzaWdubWVudHNDbG9zZWQgJiYgdG90YWxSZXN0cmljdGVkVG9rZW5zID09IDApOwogIH0KCiAgLyoqCiAgICogUmV0dXJuIHRoZSBjZWlsaW5nIG9mICh4KmEpL2IKICAgKgogICAqIEVkZ2UgY2FzZXM6CiAgICogICBhID0gMDogcmV0dXJuIDAKICAgKiAgIGIgPSAwLCBhICE9IDA6IGVycm9yIChzb2xpZGl0eSB0aHJvd3Mgb24gZGl2aXNpb24gYnkgMCkKICAgKi8KICBmdW5jdGlvbiBtdWx0RnJhY0NlaWxpbmcodWludCB4LCB1aW50IGEsIHVpbnQgYikgcmV0dXJucyAodWludCkgewogICAgLy8gQ2F0Y2ggdGhlIGNhc2UgYSA9IDAKICAgIGlmIChhID09IDApIHsgcmV0dXJuIDA7IH0KICAgIAogICAgLy8gUm91bmRpbmcgdXAgaXMgdGhlIHNhbWUgYXMgYWRkaW5nIDEtZXBzaWxvbiBhbmQgcm91bmRpbmcgZG93bi4KICAgIC8vIDEtZXBzaWxvbiBpcyBtb2RlbGVkIGFzIChiLTEpL2IgYmVsb3cuCiAgICByZXR1cm4gKHggKiBhICsgKGIgLSAxKSkgLyBiOyAKICB9CiAgICAKICAvKioKICAgKiBSZXR1cm4gdHJ1ZSBpZmYgdGhlIGFkZHJlc3MgaGFzIHRva2VucyBhc3NpZ25lZCAocmVzcC4gcmVzdHJpY3RlZCB0b2tlbnMpCiAgICovCiAgZnVuY3Rpb24gaXNSZWdpc3RlcmVkKGFkZHJlc3MgYWRkciwgYm9vbCByZXN0cmljdGVkKSBjb25zdGFudCByZXR1cm5zIChib29sKSB7CiAgICBpZiAocmVzdHJpY3RlZCkgewogICAgICByZXR1cm4gKHJlc3RyaWN0aW9uc1thZGRyXSA+IDApOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuICh0b2tlbnNbYWRkcl0gPiAwKTsKICAgIH0KICB9CgogIC8qKgogICAqIElOVEVSTkFMIGZ1bmN0aW9ucwogICAqCiAgICogIC0gYXNzaWduCiAgICogIC0gY2xvc2VBc3NpZ25tZW50cyAKICAgKiAgLSB1bnJlc3RyaWN0IAogICAqLwogICAKICAvKioKICAgKiBBc3NpZ24gKHVuKXJlc3RyaWN0ZWQgdG9rZW5zIHRvIGdpdmVuIGFkZHJlc3MKICAgKi8KICBmdW5jdGlvbiBhc3NpZ24oYWRkcmVzcyBhZGRyLCB1aW50IHRva2VuQW1vdW50LCBib29sIHJlc3RyaWN0ZWQpIGludGVybmFsIHsKICAgIC8vIFRocm93IGlmIGFzc2lnbm1lbnRzIGhhdmUgYmVlbiBjbG9zZWQKICAgIGlmIChhc3NpZ25tZW50c0Nsb3NlZCkgeyB0aHJvdzsgfQoKICAgIC8vIEFzc2lnbiB0b2tlbnMKICAgIHRva2Vuc1thZGRyXSArPSB0b2tlbkFtb3VudDsKCiAgICAvLyBSZWNvcmQgcmVzdHJpY3Rpb25zIGFuZCB1cGRhdGUgdG90YWwgY291bnRlcnMKICAgIGlmIChyZXN0cmljdGVkKSB7CiAgICAgIHRvdGFsUmVzdHJpY3RlZFRva2VucyArPSB0b2tlbkFtb3VudDsKICAgICAgdG90YWxSZXN0cmljdGVkQXNzaWdubWVudHMgKz0gMTsKICAgICAgcmVzdHJpY3Rpb25zW2FkZHJdICs9IHRva2VuQW1vdW50OwogICAgfSBlbHNlIHsKICAgICAgdG90YWxVbnJlc3RyaWN0ZWRUb2tlbnMgKz0gdG9rZW5BbW91bnQ7CiAgICAgIHRvdGFsVW5yZXN0cmljdGVkQXNzaWdubWVudHMgKz0gMTsKICAgIH0KICB9CgogIC8qKgogICAqIENsb3NlIGZ1dHVyZSBhc3NpZ25tZW50cy4KICAgKgogICAqIFRoaXMgaXMgaXJyZXZlcnNpYmxlIGFuZCBjbG9zZXMgYWxsIGZ1dHVyZSBhc3NpZ25tZW50cy4KICAgKiBUaGUgZnVuY3Rpb24gY2FuIG9ubHkgYmUgY2FsbGVkIG9uY2UuCiAgICoKICAgKiBBIGNhbGwgdHJpZ2dlcnMgdGhlIGNhbGN1bGF0aW9uIG9mIHdoYXQgZnJhY3Rpb24gb2YgcmVzdHJpY3RlZCB0b2tlbnMKICAgKiBzaG91bGQgYmUgYnVybmVkIGJ5IHN1YnNlcXVlbnQgY2FsbHMgdG8gdGhlIHVucmVzdHJpY3QoKSBmdW5jdGlvbi4KICAgKiBUaGUgcmVzdWx0IG9mIHRoaXMgY2FsY3VsYXRpb24gaXMgYSBtdWx0aXBsaWNhdGlvbiBmYWN0b3Igd2hvc2Ugbm9taW5hdG9yCiAgICogYW5kIGRlbm9taW5hdG9yIGFyZSBzdG9yZWQgaW4gdGhlIGNvbnRyYWN0IHZhcmlhYmxlcyBidXJuTXVsdE5vbSwKICAgKiBidXJuTXVsdERlbi4KICAgKi8KICBmdW5jdGlvbiBjbG9zZUFzc2lnbm1lbnRzSWZPcGVuKCkgaW50ZXJuYWwgewogICAgLy8gUmV0dXJuIGlmIGFzc2lnbm1lbnRzIGFyZSBub3Qgb3BlbgogICAgaWYgKGFzc2lnbm1lbnRzQ2xvc2VkKSB7IHJldHVybjsgfSAKICAgIAogICAgLy8gU2V0IHRoZSBzdGF0ZSB0byAiY2xvc2VkIgogICAgYXNzaWdubWVudHNDbG9zZWQgPSB0cnVlOwoKICAgIC8qCiAgICAgKiAgQ2FsY3VsYXRlIHRoZSB0b3RhbCBudW1iZXIgb2YgdG9rZW5zIHRoYXQgc2hvdWxkIHJlbWFpbiBhZnRlcgogICAgICogIGNvbnZlcnNpb24uICBUaGlzIGlzIGJhc2VkIG9uIHRoZSB0b3RhbCBudW1iZXIgb2YgdW5yZXN0cmljdGVkIHRva2VucwogICAgICogIGFzc2lnbmVkIHNvIGZhciBhbmQgdGhlIHByZS1jb25maWd1cmVkIHNoYXJlIHRoYXQgdGhlIHJlbWFpbmluZwogICAgICogIGZvcm1lcmx5IHJlc3RyaWN0ZWQgdG9rZW5zIHNob3VsZCBoYXZlLgogICAgICovCiAgICB1aW50IHRvdGFsVG9rZW5zVGFyZ2V0ID0gKHRvdGFsVW5yZXN0cmljdGVkVG9rZW5zICogMTAwKSAvIAogICAgICAoMTAwIC0gcmVzdHJpY3RlZFNoYXJlKTsKICAgIAogICAgLy8gVGhlIHRvdGFsIG51bWJlciBvZiB0b2tlbnMgaW4gZXhpc3RlbmNlIG5vdy4KICAgIHVpbnQgdG90YWxUb2tlbnNFeGlzdGluZyA9IHRvdGFsUmVzdHJpY3RlZFRva2VucyArIHRvdGFsVW5yZXN0cmljdGVkVG9rZW5zOwogICAgICAKICAgIC8qCiAgICAgKiBUaGUgdG90YWwgbnVtYmVyIG9mIHRva2VucyB0aGF0IG5lZWQgdG8gYmUgYnVybmVkIHRvIGJyaW5nIHRoZSBleGlzdGluZwogICAgICogbnVtYmVyIGRvd24gdG8gdGhlIHRhcmdldCBudW1iZXIuIElmIHRoZSBleGlzdGluZyBudW1iZXIgaXMgbG93ZXIgdGhhbgogICAgICogdGhlIHRhcmdldCB0aGVuIHdlIHdvbid0IGJ1cm4gYW55dGhpbmcuCiAgICAgKi8KICAgIHVpbnQgdG90YWxCdXJuID0gMDsgCiAgICBpZiAodG90YWxUb2tlbnNFeGlzdGluZyA+IHRvdGFsVG9rZW5zVGFyZ2V0KSB7CiAgICAgIHRvdGFsQnVybiA9IHRvdGFsVG9rZW5zRXhpc3RpbmcgLSB0b3RhbFRva2Vuc1RhcmdldDsgCiAgICB9CgogICAgLy8gVGhlIGZyYWN0aW9uIG9mIHJlc3RyaWN0ZWQgdG9rZW5zIHRvIGJlIGJ1cm5lZCAoYnkgbm9taW5hdG9yIGFuZAogICAgLy8gZGVub21pbmF0b3IpLgogICAgYnVybk11bHROb20gPSB0b3RhbEJ1cm47CiAgICBidXJuTXVsdERlbiA9IHRvdGFsUmVzdHJpY3RlZFRva2VuczsKICAgIAogICAgLyoKICAgICAqIEZvciB2ZXJpZnlpbmcgdGhlIGNvcnJlY3RuZXNzIG9mIHRoZSBhYm92ZSBjYWxjdWxhdGlvbiBpdCBtYXkgaGVscCB0bwogICAgICogbm90ZSB0aGUgZm9sbG93aW5nLgogICAgICogR2l2ZW4gMCA8PSByZXN0cmljdGVkU2hhcmUgPCAxMDAsIHdlIGhhdmU6CiAgICAgKiAgLSB0b3RhbFRva2Vuc1RhcmdldCA+PSB0b3RhbFVucmVzdHJpY3RlZFRva2VucwogICAgICogIC0gdG90YWxUb2tlbnNFeGlzdGluZyA8PSB0b3RhbFJlc3RyaWN0ZWRUb2tlbnMgKyB0b3RhbFRva2Vuc1RhcmdldAogICAgICogIC0gdG90YWxCdXJuIDw9IHRvdGFsUmVzdHJpY3RlZFRva2VucwogICAgICogIC0gYnVybk11bHROb20gPD0gYnVybk11bHREZW4KICAgICAqIEFsc28gbm90ZSB0aGF0IGJ1cm5NdWx0RGVuID0gMCBtZWFucyB0b3RhbFJlc3RyaWN0ZWRUb2tlbnMgPSAwLCBpbiB3aGljaAogICAgICogYnVybk11bHROb20gPSAwIGFzIHdlbGwuCiAgICAgKi8KICB9CgogIC8qKgogICAqIFVucmVzdHJpY3QgKGNvbnZlcnQpIGFsbCByZXN0cmljdGVkIHRva2VucyBhc3NpZ25lZCB0byB0aGUgZ2l2ZW4gYWRkcmVzcwogICAqCiAgICogVGhpcyBmdW5jdGlvbiBjYW4gb25seSBiZSBjYWxsZWQgYWZ0ZXIgYXNzaWdubWVudHMgaGF2ZSBiZWVuIGNsb3NlZCB2aWEKICAgKiBjbG9zZUFzc2lnbm1lbnRzKCkuCiAgICogVGhlIHJldHVybiB2YWx1ZSBpcyB0aGUgbnVtYmVyIG9mIHJlc3RyaWN0ZWQgdG9rZW5zIHRoYXQgd2VyZSBidXJuZWQgaW4KICAgKiB0aGUgY29udmVyc2lvbi4KICAgKi8KICBmdW5jdGlvbiB1bnJlc3RyaWN0KGFkZHJlc3MgYWRkcikgaW50ZXJuYWwgcmV0dXJucyAodWludCkgewogICAgLy8gVGhyb3cgaXMgYXNzaWdubWVudHMgYXJlIG5vdCB5ZXQgY2xvc2VkCiAgICBpZiAoIWFzc2lnbm1lbnRzQ2xvc2VkKSB7IHRocm93OyB9CgogICAgLy8gVGhlIGJhbGFuY2Ugb2YgcmVzdHJpY3RlZCB0b2tlbnMgZm9yIHRoZSBnaXZlbiBhZGRyZXNzIAogICAgdWludCByZXN0cmljdGlvbnNGb3JBZGRyID0gcmVzdHJpY3Rpb25zW2FkZHJdOwogICAgCiAgICAvLyBUaHJvdyBpZiB0aGVyZSBhcmUgbm9uZQogICAgaWYgKHJlc3RyaWN0aW9uc0ZvckFkZHIgPT0gMCkgeyB0aHJvdzsgfQoKICAgIC8vIEFwcGx5IHRoZSBidXJuIG11bHRpcGxpZXIgdG8gdGhlIGJhbGFuY2Ugb2YgcmVzdHJpY3RlZCB0b2tlbnMKICAgIC8vIFRoZSByZXN1bHQgaXMgdGhlIGNlaWxpbmcgb2YgdGhlIHZhbHVlOiAKICAgIC8vIChyZXN0cmljdGlvbkZvckFkZHIgKiBidXJuTXVsdE5vbSkgLyBidXJuTXVsdERlbgogICAgdWludCBidXJuID0gbXVsdEZyYWNDZWlsaW5nKHJlc3RyaWN0aW9uc0ZvckFkZHIsIGJ1cm5NdWx0Tm9tLCBidXJuTXVsdERlbik7CgogICAgLy8gUmVtb3ZlIHRoZSB0b2tlbnMgdG8gYmUgYnVybmVkIGZyb20gdGhlIGFkZHJlc3MncyBiYWxhbmNlCiAgICB0b2tlbnNbYWRkcl0gLT0gYnVybjsKICAgIAogICAgLy8gRGVsZXRlIHJlY29yZCBvZiByZXN0cmljdGlvbnMgCiAgICBkZWxldGUgcmVzdHJpY3Rpb25zW2FkZHJdOwogICAgCiAgICAvLyBVcGRhdGUgdGhlIGNvdW50ZXJzIGZvciB0b3RhbCAodW4pcmVzdHJpY3RlZCB0b2tlbnMKICAgIHRvdGFsUmVzdHJpY3RlZFRva2VucyAgIC09IHJlc3RyaWN0aW9uc0ZvckFkZHI7CiAgICB0b3RhbFVucmVzdHJpY3RlZFRva2VucyArPSByZXN0cmljdGlvbnNGb3JBZGRyIC0gYnVybjsKICAgICAgCiAgICByZXR1cm4gYnVybjsKICB9Cn0KCi8vIGltcG9ydCAiUGhhc2VkLnNvbCI7CgovKgogKiB0aXRsZTogQ29udHJhY3QgdGhhdCBhZHZhbmNlcyB0aHJvdWdoIG11bHRpcGxlIGNvbmZpZ3VyYWJsZSBwaGFzZXMgb3ZlciB0aW1lCiAqIGF1dGhvcjogVGltbyBIYW5rZSAKICogCiAqIFBoYXNlcyBhcmUgZGVmaW5lZCBieSB0aGVpciB0cmFuc2l0aW9uIHRpbWVzLiBUaGUgbW9tZW50IG9uZSBwaGFzZSBlbmRzIHRoZQogKiBuZXh0IG9uZSBzdGFydHMuIEVhY2ggdGltZSBiZWxvbmdzIHRvIGV4YWN0bHkgb25lIHBoYXNlLgogKgogKiBUaGUgY29udHJhY3QgYWxsb3dzIGEgbGltaXRlZCBzZXQgb2YgY2hhbmdlcyB0byBiZSBhcHBsaWVkIHRvIHRoZSBwaGFzZQogKiB0cmFuc2l0aW9ucyB3aGlsZSB0aGUgY29udHJhY3QgaXMgYWN0aXZlLiAgQXMgYSBtYXR0ZXIgb2YgcHJpbmNpcGxlLCBjaGFuZ2VzCiAqIGFyZSBwcm9oaWJpdGVkIGZyb20gZWZmZWN0aW5nIHRoZSBwYXN0LiBUaGV5IG1heSBvbmx5IGV2ZXIgYWZmZWN0IGZ1dHVyZQogKiBwaGFzZSB0cmFuc2l0aW9ucy4KICoKICogVGhlIHBlcm1pdHRlZCBjaGFuZ2VzIGFyZToKICogICAtIGFkZCBhIG5ldyBwaGFzZSBhZnRlciB0aGUgbGFzdCBvbmUKICogICAtIGVuZCB0aGUgY3VycmVudCBwaGFzZSByaWdodCBub3cgYW5kIHRyYW5zaXRpb24gdG8gdGhlIG5leHQgcGhhc2UKICogICAgIGltbWVkaWF0ZWx5IAogKiAgIC0gZGVsYXkgdGhlIHN0YXJ0IG9mIGEgZnV0dXJlIHBoYXNlICh0aGVyZWJ5IHB1c2hpbmcgb3V0IGFsbCBzdWJzZXF1ZW50CiAqICAgICBwaGFzZXMgYnkgYW4gZXF1YWwgYW1vdW50IG9mIHRpbWUpCiAqICAgLSBkZWZpbmUgYSBtYXhpbXVtIGRlbGF5IGZvciBhIHNwZWNpZmllZCBwaGFzZSAKICovCiAKCmNvbnRyYWN0IFBoYXNlZCB7CiAgLyoqCiAgICogQXJyYXkgb2YgdHJhbnNpdGlvbiB0aW1lcyBkZWZpbmluZyB0aGUgcGhhc2VzCiAgICogICAKICAgKiBwaGFzZUVuZFRpbWVbaV0gaXMgdGhlIHRpbWUgd2hlbiBwaGFzZSBpIGhhcyBqdXN0IGVuZGVkLgogICAqIFBoYXNlIGkgaXMgZGVmaW5lZCBhcyB0aGUgZm9sbG93aW5nIHRpbWUgaW50ZXJ2YWw6IAogICAqICAgWyBwaGFzZUVuZFRpbWVbaS0xXSwgKiBwaGFzZUVuZFRpbWVbaV0gKQogICAqLwogIHVpbnRbXSBwdWJsaWMgcGhhc2VFbmRUaW1lOwoKICAvKioKICAgKiBOdW1iZXIgb2YgcGhhc2UgdHJhbnNpdGlvbnMgTiA9IHBoYXNlRW5kVGltZS5sZW5ndGggCiAgICoKICAgKiBUaGVyZSBhcmUgTisxIHBoYXNlcywgbnVtYmVyZWQgMCwuLixOLgogICAqIFRoZSBmaXJzdCBwaGFzZSBoYXMgbm8gc3RhcnQgYW5kIHRoZSBsYXN0IHBoYXNlIGhhcyBubyBlbmQuCiAgICovCiAgdWludCBwdWJsaWMgTjsgCgogIC8qKgogICAqICBNYXhpbXVtIGRlbGF5IGZvciBwaGFzZSB0cmFuc2l0aW9ucwogICAqCiAgICogIG1heERlbGF5W2ldIGlzIHRoZSBtYXhpbXVtIGFtb3VudCBvZiB0aW1lIGJ5IHdoaWNoIHRoZSB0cmFuc2l0aW9uCiAgICogIHBoYXNlRW5kVGltZVtpXSBjYW4gYmUgZGVsYXllZC4KICAqLwogIG1hcHBpbmcodWludCA9PiB1aW50KSBwdWJsaWMgbWF4RGVsYXk7IAoKICAvKgogICAqIFRoZSBjb250cmFjdCBoYXMgbm8gY29uc3RydWN0b3IuCiAgICogVGhlIGNvbnRyYWN0IGluaXRpYWxpemVkIGl0c2VsZiB3aXRoIG5vIHBoYXNlIHRyYW5zaXRpb25zIChOID0gMCkgYW5kIG9uZQogICAqIHBoYXNlIChOKzE9MSkuCiAgICoKICAgKiBUaGVyZSBhcmUgdHdvIFBVQkxJQyBmdW5jdGlvbnMgKGdldHRlcnMpOgogICAqICAtIGdldFBoYXNlQXRUaW1lCiAgICogIC0gaXNQaGFzZQogICAqICAtIGdldFBoYXNlU3RhcnRUaW1lCiAgICoKICAgKiBOb3RlIHRoYXQgYm90aCBmdW5jdGlvbnMgYXJlIGd1YXJhbnRlZWQgdG8gcmV0dXJuIHRoZSBzYW1lIHZhbHVlIHdoZW4KICAgKiBjYWxsZWQgdHdpY2Ugd2l0aCB0aGUgc2FtZSBhcmd1bWVudCAoYnV0IGF0IGRpZmZlcmVudCB0aW1lcykuCiAgICovCgogIC8qKgogICAqIFJldHVybiB0aGUgbnVtYmVyIG9mIHRoZSBwaGFzZSB0byB3aGljaCB0aGUgZ2l2ZW4gdGltZSBiZWxvbmdzLgogICAqCiAgICogUmV0dXJuIHZhbHVlIGkgbWVhbnMgcGhhc2VFbmRUaW1lW2ktMV0gPD0gdGltZSA8IHBoYXNlRW5kVGltZVtpXS4KICAgKiBUaGUgZ2l2ZW4gdGltZSBtdXN0IG5vdCBiZSBpbiB0aGUgZnV0dXJlIChiZWNhdXNlIGZ1dHVyZSBwaGFzZSBudW1iZXJzIG1heQogICAqIHN0aWxsIGJlIHN1YmplY3QgdG8gY2hhbmdlKS4KICAgKi8KICBmdW5jdGlvbiBnZXRQaGFzZUF0VGltZSh1aW50IHRpbWUpIGNvbnN0YW50IHJldHVybnMgKHVpbnQgbikgewogICAgLy8gVGhyb3cgaWYgdGltZSBpcyBpbiB0aGUgZnV0dXJlCiAgICBpZiAodGltZSA+IG5vdykgeyB0aHJvdzsgfQogICAgCiAgICAvLyBMb29wIHVudGlsIHdlIGhhdmUgZm91bmQgdGhlICJhY3RpdmUiIHBoYXNlCiAgICB3aGlsZSAobiA8IE4gJiYgcGhhc2VFbmRUaW1lW25dIDw9IHRpbWUpIHsKICAgICAgbisrOwogICAgfQogIH0KCiAgLyoqCiAgICogUmV0dXJuIHRydWUgaWYgdGhlIGdpdmVuIHRpbWUgYmVsb25ncyB0byB0aGUgZ2l2ZW4gcGhhc2UuCiAgICoKICAgKiBSZXR1cm5zIHRoZSBsb2dpY2FsIGVxdWl2YWxlbnQgb2YgdGhlIGV4cHJlc3Npb24gCiAgICogICAocGhhc2VFbmRUaW1lW2ktMV0gPD0gdGltZSA8IHBoYXNlRW5kVGltZVtpXSkuCiAgICoKICAgKiBUaGUgZ2l2ZW4gdGltZSBtdXN0IG5vdCBiZSBpbiB0aGUgZnV0dXJlIChiZWNhdXNlIGZ1dHVyZSBwaGFzZSBudW1iZXJzIG1heQogICAqIHN0aWxsIGJlIHN1YmplY3QgdG8gY2hhbmdlKS4KICAgKi8KICBmdW5jdGlvbiBpc1BoYXNlKHVpbnQgdGltZSwgdWludCBuKSBjb25zdGFudCByZXR1cm5zIChib29sKSB7CiAgICAvLyBUaHJvdyBpZiB0aW1lIGlzIGluIHRoZSBmdXR1cmUKICAgIGlmICh0aW1lID4gbm93KSB7IHRocm93OyB9CiAgICAKICAgIC8vIFRocm93IGlmIGluZGV4IGlzIG91dC1vZi1yYW5nZQogICAgaWYgKG4gPj0gTikgeyB0aHJvdzsgfQogICAgCiAgICAvLyBDb25kaXRpb24gMQogICAgaWYgKG4gPiAwICYmIHBoYXNlRW5kVGltZVtuLTFdID4gdGltZSkgeyByZXR1cm4gZmFsc2U7IH0gCiAgICAKICAgIC8vIENvbmRpdGlvbiAyCiAgICBpZiAobiA8IE4gJiYgdGltZSA+PSBwaGFzZUVuZFRpbWVbbl0pIHsgcmV0dXJuIGZhbHNlOyB9IAogICAKICAgIHJldHVybiB0cnVlOyAKICB9CiAgCiAgLyoqCiAgICogUmV0dXJuIHRoZSBzdGFydCB0aW1lIG9mIHRoZSBnaXZlbiBwaGFzZS4KICAgKgogICAqIFRoaXMgZnVuY3Rpb24gaXMgcHJvdmlkZWQgZm9yIGNvbnZlbmllbmNlLgogICAqIFRoZSBnaXZlbiBwaGFzZSBudW1iZXIgbXVzdCBub3QgYmUgMCwgYXMgdGhlIGZpcnN0IHBoYXNlIGhhcyBubyBzdGFydCB0aW1lLgogICAqIElmIGNhbGxpbmcgZm9yIGEgZnV0dXJlIHBoYXNlIG51bWJlciB0aGUgY2FsbGVyIG11c3QgYmUgYXdhcmUgdGhhdCBmdXR1cmUKICAgKiBwaGFzZSB0aW1lcyBjYW4gYmUgc3ViamVjdCB0byBjaGFuZ2UuCiAgICovCiAgZnVuY3Rpb24gZ2V0UGhhc2VTdGFydFRpbWUodWludCBuKSBjb25zdGFudCByZXR1cm5zICh1aW50KSB7CiAgICAvLyBUaHJvdyBpZiBwaGFzZSBpcyB0aGUgZmlyc3QgcGhhc2UKICAgIGlmIChuID09IDApIHsgdGhyb3c7IH0KICAgCiAgICByZXR1cm4gcGhhc2VFbmRUaW1lW24tMV07CiAgfQogICAgCiAgLyoKICAgKiAgVGhlcmUgYXJlIDQgSU5URVJOQUwgZnVuY3Rpb25zOgogICAqICAgIDEuIGFkZFBoYXNlCiAgICogICAgMi4gc2V0TWF4RGVsYXkKICAgKiAgICAzLiBkZWxheVBoYXNlRW5kQnkKICAgKiAgICA0LiBlbmRDdXJyZW50UGhhc2VJbgogICAqCiAgICogIFRoaXMgY29udHJhY3QgZG9lcyBub3QgaW1wbGVtZW50IGFjY2VzcyBjb250cm9sIHRvIHRoZXNlIGZ1bmN0aW9uLCBzbwogICAqICB0aGV5IGFyZSBtYWRlIGludGVybmFsLgogICAqLwogICAKICAvKioKICAgKiAxLiBBZGQgYSBwaGFzZSBhZnRlciB0aGUgbGFzdCBwaGFzZS4KICAgKgogICAqIFRoZSBhcmd1bWVudCBpcyB0aGUgbmV3IGVuZFRpbWUgb2YgdGhlIHBoYXNlIGN1cnJlbnRseSBrbm93biBhcyB0aGUgbGFzdAogICAqIHBoYXNlLCBvciwgaW4gb3RoZXIgd29yZHMgdGhlIHN0YXJ0IHRpbWUgb2YgdGhlIG5ld2x5IGludHJvZHVjZWQgcGhhc2UuICAKICAgKiBBbGwgY2FsbHMgdG8gYWRkUGhhc2UoKSBNVVNUIGJlIHdpdGggc3RyaWN0bHkgaW5jcmVhc2luZyB0aW1lIGFyZ3VtZW50cy4KICAgKiBJdCBpcyBub3QgYWxsb3dlZCB0byBhZGQgYSBwaGFzZSB0cmFuc2l0aW9uIHRoYXQgbGllcyBpbiB0aGUgcGFzdCByZWxhdGl2ZQogICAqIHRvIHRoZSBjdXJyZW50IGJsb2NrIHRpbWUuCiAgICovCiAgZnVuY3Rpb24gYWRkUGhhc2UodWludCB0aW1lKSBpbnRlcm5hbCB7CiAgICAvLyBUaHJvdyBpZiBuZXcgdHJhbnNpdGlvbiB0aW1lIGlzIG5vdCBzdHJpY3RseSBpbmNyZWFzaW5nCiAgICBpZiAoTiA+IDAgJiYgdGltZSA8PSBwaGFzZUVuZFRpbWVbTi0xXSkgeyB0aHJvdzsgfSAKCiAgICAvLyBUaHJvdyBpZiBuZXcgdHJhbnNpdGlvbiB0aW1lIGlzIG5vdCBpbiB0aGUgZnV0dXJlCiAgICBpZiAodGltZSA8PSBub3cpIHsgdGhyb3c7IH0KICAgCiAgICAvLyBBcHBlbmQgbmV3IHRyYW5zaXRpb24gdGltZSB0byBhcnJheSAKICAgIHBoYXNlRW5kVGltZS5wdXNoKHRpbWUpOwogICAgTisrOwogIH0KICAKICAvKioKICAgKiAyLiBEZWZpbmUgYSBsaW1pdCBvbiB0aGUgYW1vdW50IG9mIHRpbWUgYnkgd2hpY2ggdGhlIGdpdmVuIHRyYW5zaXRpb24gKGkpCiAgICogICAgY2FuIGJlIGRlbGF5ZWQuCiAgICoKICAgKiBCeSBkZWZhdWx0LCB0cmFuc2l0aW9ucyBjYW4gbm90IGJlIGRlbGF5ZWQgKGxpbWl0ID0gMCkuCiAgICovCiAgZnVuY3Rpb24gc2V0TWF4RGVsYXkodWludCBpLCB1aW50IHRpbWVEZWx0YSkgaW50ZXJuYWwgewogICAgLy8gVGhyb3cgaWYgaW5kZXggaXMgb3V0LW9mLXJhbmdlCiAgICBpZiAoaSA+PSBOKSB7IHRocm93OyB9CgogICAgbWF4RGVsYXlbaV0gPSB0aW1lRGVsdGE7CiAgfQoKICAvKioKICAgKiAzLiBEZWxheSB0aGUgZW5kIG9mIHRoZSBnaXZlbiBwaGFzZSAobikgYnkgdGhlIGdpdmVuIHRpbWUgZGVsdGEuIAogICAqCiAgICogVGhlIGdpdmVuIHBoYXNlIG11c3Qgbm90IGhhdmUgZW5kZWQuCiAgICoKICAgKiBUaGlzIGZ1bmN0aW9uIGNhbiBiZSBjYWxsZWQgbXVsdGlwbGUgdGltZXMgZm9yIHRoZSBzYW1lIHBoYXNlLiAKICAgKiBUaGUgZGVmaW5lZCBtYXhpbXVtIGRlbGF5IHdpbGwgYmUgZW5mb3JjZWQgYWNyb3NzIG11bHRpcGxlIGNhbGxzLgogICAqLwogIGZ1bmN0aW9uIGRlbGF5UGhhc2VFbmRCeSh1aW50IG4sIHVpbnQgdGltZURlbHRhKSBpbnRlcm5hbCB7CiAgICAvLyBUaHJvdyBpZiBpbmRleCBpcyBvdXQgb2YgcmFuZ2UKICAgIGlmIChuID49IE4pIHsgdGhyb3c7IH0KCiAgICAvLyBUaHJvdyBpZiBwaGFzZSBoYXMgYWxyZWFkeSBlbmRlZAogICAgaWYgKG5vdyA+PSBwaGFzZUVuZFRpbWVbbl0pIHsgdGhyb3c7IH0KCiAgICAvLyBUaHJvdyBpZiB0aGUgcmVxdWVzdGVkIGRlbGF5IGlzIGhpZ2hlciB0aGFuIHRoZSBkZWZpbmVkIG1heGltdW0gZm9yIHRoZQogICAgLy8gdHJhbnNpdGlvbgogICAgaWYgKHRpbWVEZWx0YSA+IG1heERlbGF5W25dKSB7IHRocm93OyB9CgogICAgLy8gU3VidHJhY3QgZnJvbSB0aGUgY3VycmVudCBtYXggZGVsYXksIHNvIG1heERlbGF5IGlzIGhvbm9yZWQgYWNyb3NzCiAgICAvLyBtdWx0aXBsZSBjYWxscwogICAgbWF4RGVsYXlbbl0gLT0gdGltZURlbHRhOwoKICAgIC8vIFB1c2ggb3V0IGFsbCBzdWJzZXF1ZW50IHRyYW5zaXRpb25zIGJ5IHRoZSBzYW1lIGFtb3VudAogICAgZm9yICh1aW50IGkgPSBuOyBpIDwgTjsgaSsrKSB7CiAgICAgIHBoYXNlRW5kVGltZVtpXSArPSB0aW1lRGVsdGE7CiAgICB9CiAgfQoKICAvKioKICAgKiA0LiBFbmQgdGhlIGN1cnJlbnQgcGhhc2UgZWFybHkuCiAgICoKICAgKiBUaGUgY3VycmVudCBwaGFzZSBtdXN0IG5vdCBiZSB0aGUgbGFzdCBwaGFzZSwgYXMgdGhlIGxhc3QgcGhhc2UgaGFzIG5vIGVuZC4KICAgKiBUaGUgY3VycmVudCBwaGFzZSB3aWxsIGVuZCBhdCB0aW1lIG5vdyBwbHVzIHRoZSBnaXZlbiB0aW1lIGRlbHRhLgogICAqCiAgICogVGhlIG1pbmltYWwgYWxsb3dlZCB0aW1lIGRlbHRhIGlzIDEuIFRoaXMgaXMgYXZvaWQgYSByYWNlIGNvbmRpdGlvbiBmb3IgCiAgICogb3RoZXIgdHJhbnNhY3Rpb25zIHRoYXQgYXJlIHByb2Nlc3NlZCBpbiB0aGUgc2FtZSBibG9jay4gCiAgICogU2V0dGluZyBwaGFzZUVuZFRpbWVbbl0gdG8gbm93IHdvdWxkIHB1c2ggYWxsIGxhdGVyIHRyYW5zYWN0aW9ucyBmcm9tIHRoZSAKICAgKiBzYW1lIGJsb2NrIGludG8gdGhlIG5leHQgcGhhc2UuCiAgICogSWYgdGhlIHNwZWNpZmllZCB0aW1lRGVsdGEgaXMgMCB0aGUgZnVuY3Rpb24gZ3JhY2VmdWxseSBidW1wcyBpdCB1cCB0byAxLgogICAqLwogIGZ1bmN0aW9uIGVuZEN1cnJlbnRQaGFzZUluKHVpbnQgdGltZURlbHRhKSBpbnRlcm5hbCB7CiAgICAvLyBHZXQgdGhlIGN1cnJlbnQgcGhhc2UgbnVtYmVyCiAgICB1aW50IG4gPSBnZXRQaGFzZUF0VGltZShub3cpOwoKICAgIC8vIFRocm93IGlmIHdlIGFyZSBpbiB0aGUgbGFzdCBwaGFzZQogICAgaWYgKG4gPj0gTikgeyB0aHJvdzsgfQogICAKICAgIC8vIFNldCB0aW1lRGVsdGEgdG8gdGhlIG1pbmltYWwgYWxsb3dlZCB2YWx1ZQogICAgaWYgKHRpbWVEZWx0YSA9PSAwKSB7IAogICAgICB0aW1lRGVsdGEgPSAxOyAKICAgIH0KICAgIAogICAgLy8gVGhlIG5ldyBwaGFzZSBlbmQgc2hvdWxkIGJlIGVhcmxpZXIgdGhhbiB0aGUgY3VycmVudGx5IGRlZmluZWQgcGhhc2UKICAgIC8vIGVuZCwgb3RoZXJ3aXNlIHdlIGRvbid0IGNoYW5nZSBpdC4KICAgIGlmIChub3cgKyB0aW1lRGVsdGEgPCBwaGFzZUVuZFRpbWVbbl0pIHsgCiAgICAgIHBoYXNlRW5kVGltZVtuXSA9IG5vdyArIHRpbWVEZWx0YTsKICAgIH0KICB9Cn0KCi8vIGltcG9ydCAiU3RlcEZ1bmN0aW9uLnNvbCI7CgovKgogKiB0aXRsZTogIEEgY29uZmlndXJhYmxlIHN0ZXAgZnVuY3Rpb24gCiAqIGF1dGhvcjogVGltbyBIYW5rZSAKICoKICogVGhlIGNvbnRyYWN0IGltcGxlbWVudHMgYSBzdGVwIGZ1bmN0aW9uIGdvaW5nIGRvd24gZnJvbSBhbiBpbml0aWFsVmFsdWUgdG8gMAogKiBpbiBhIG51bWJlciBvZiBzdGVwcyAoblN0ZXBzKS4KICogVGhlIHN0ZXBzIGFyZSBkaXN0cmlidXRlZCBlcXVhbGx5IG92ZXIgYSBnaXZlbiB0aW1lIChwaGFzZUxlbmd0aCkuCiAqIEhhdmluZyBuIHN0ZXBzIG1lYW5zIHRoYXQgdGhlIHRpbWUgcGhhc2VMZW5ndGggaXMgZGl2aWRlZCBpbnRvIG4rMQogKiBzdWItaW50ZXJ2YWxscyBvZiBlcXVhbCBsZW5ndGggZHVyaW5nIGVhY2ggb2Ygd2hpY2ggdGhlIGZ1bmN0aW9uIHZhbHVlIGlzCiAqIGNvbnN0YW50LiAKICovCgpjb250cmFjdCBTdGVwRnVuY3Rpb24gewogIHVpbnQgcHVibGljIHBoYXNlTGVuZ3RoOwogIHVpbnQgcHVibGljIG5TdGVwczsKICB1aW50IHB1YmxpYyBzdGVwOwoKICBmdW5jdGlvbiBTdGVwRnVuY3Rpb24odWludCBfcGhhc2VMZW5ndGgsIHVpbnQgX2luaXRpYWxWYWx1ZSwgdWludCBfblN0ZXBzKSB7CiAgICAvLyBUaHJvdyBpZiBwaGFzZUxlbmd0aCBkb2VzIG5vdCBsZWF2ZSBlbm91Z2ggcm9vbSBmb3IgbnVtYmVyIG9mIHN0ZXBzCiAgICBpZiAoX25TdGVwcyA+IF9waGFzZUxlbmd0aCkgeyB0aHJvdzsgfSAKICAKICAgIC8vIFRoZSByZWR1Y3Rpb24gaW4gdmFsdWUgcGVyIHN0ZXAgCiAgICBzdGVwID0gX2luaXRpYWxWYWx1ZSAvIF9uU3RlcHM7CiAgICAKICAgIC8vIFRocm93IGlmIF9pbml0aWFsVmFsdWUgd2FzIG5vdCBkaXZpc2libGUgYnkgX25TdGVwcwogICAgaWYgKCBzdGVwICogX25TdGVwcyAhPSBfaW5pdGlhbFZhbHVlKSB7IHRocm93OyB9IAoKICAgIHBoYXNlTGVuZ3RoID0gX3BoYXNlTGVuZ3RoOwogICAgblN0ZXBzID0gX25TdGVwczsgCiAgfQogCiAgLyoKICAgKiBOb3RlIHRoZSBmb2xsb3dpbmcgZWRnZSBjYXNlcy4KICAgKiAgIGluaXRpYWxWYWx1ZSA9IDA6IGlzIHZhbGlkIGFuZCB3aWxsIGNyZWF0ZSB0aGUgY29uc3RhbnQgemVybyBmdW5jdGlvbgogICAqICAgblN0ZXBzID0gMDogaXMgdmFsaWQgYW5kIHdpbGwgY3JlYXRlIHRoZSBjb25zdGFudCB6ZXJvIGZ1bmN0aW9uIChvbmx5IDEKICAgKiAgIHN1Yi1pbnRlcnZhbCkKICAgKiAgIHBoYXNlTGVuZ3RoIDwgblN0ZXBzOiBpcyB2YWxpZCwgYnV0IHVubGlrZWx5IHRvIGJlIGludGVuZGVkIChzbyB0aGUKICAgKiAgIGNvbnN0cnVjdG9yIHRocm93cykKICAgKi8KICAKICAvKioKICAgKiBFdmFsdWF0ZSB0aGUgc3RlcCBmdW5jdGlvbiBhdCBhIGdpdmVuIHRpbWUgIAogICAqCiAgICogZWxhcHNlZFRpbWUgTVVTVCBiZSBpbiB0aGUgaW50ZXJ2YWxsIFswLHBoYXNlTGVuZ3RoKQogICAqIFRoZSByZXR1cm4gdmFsdWUgaXMgYmV0d2VlbiBpbml0aWFsVmFsdWUgYW5kIDAsIG5ldmVyIG5lZ2F0aXZlLgogICAqLwogIGZ1bmN0aW9uIGdldFN0ZXBGdW5jdGlvbih1aW50IGVsYXBzZWRUaW1lKSBjb25zdGFudCByZXR1cm5zICh1aW50KSB7CiAgICAvLyBUaHJvdyBpcyBlbGFwc2VkVGltZSBpcyBvdXQtb2YtcmFuZ2UKICAgIGlmIChlbGFwc2VkVGltZSA+PSBwaGFzZUxlbmd0aCkgeyB0aHJvdzsgfQogICAgCiAgICAvLyBUaGUgZnVuY3Rpb24gdmFsdWUgd2lsbCBiZWwgY2FsY3VsYXRlZCBmcm9tIHRoZSBlbmQgdmFsdWUgYmFja3dhcmRzLgogICAgLy8gSGVuY2Ugd2UgbmVlZCB0aGUgdGltZSBsZWZ0LCB3aGljaCB3aWxsIGxpZSBpbiB0aGUgaW50ZXJ2YWxsCiAgICAvLyBbMCxwaGFzZUxlbmd0aCkKICAgIHVpbnQgdGltZUxlZnQgID0gcGhhc2VMZW5ndGggLSBlbGFwc2VkVGltZSAtIDE7IAoKICAgIC8vIENhbGN1bGF0ZSB0aGUgbnVtYmVyIG9mIHN0ZXBzIGF3YXkgZnJvbSByZWFjaGluZyBlbmQgdmFsdWUKICAgIC8vIFdoZW4gdmVyaWZ5aW5nIHRoZSBmb3J1bWxhIGJlbG93IGl0IG1heSBoZWxwIHRvIG5vdGU6CiAgICAvLyAgIGF0IGVsYXBzZWRUaW1lID0gMCBzdGVwc0xlZnQgZXZhbHVhdGVzIHRvIG5TdGVwcywKICAgIC8vICAgYXQgZWxhcHNlZFRpbWUgPSAtMSBzdGVwc0xlZnQgd291bGQgZXZhbHVhdGUgdG8gblN0ZXBzICsgMS4KICAgIHVpbnQgc3RlcHNMZWZ0ID0gKChuU3RlcHMgKyAxKSAqIHRpbWVMZWZ0KSAvIHBoYXNlTGVuZ3RoOyAKCiAgICAvLyBBcHBseSB0aGUgc3RlcCBmdW5jdGlvbgogICAgcmV0dXJuIHN0ZXBzTGVmdCAqIHN0ZXA7CiAgfQp9CgovLyBpbXBvcnQgIlRhcmdldHMuc29sIjsKCi8qCiAqIHRpdGxlOiBDb250cmFjdCBpbXBsZW1lbnRpbmcgY291bnRlcnMgd2l0aCBjb25maWd1cmFibGUgdGFyZ2V0cwogKiBhdXRob3I6IFRpbW8gSGFua2UgCiAqCiAqIFRoZXJlIGlzIGFuIGFyYml0cmFyeSBudW1iZXIgb2YgY291bnRlcnMuIEVhY2ggY291bnRlciBpcyBpZGVudGlmaWVkIGJ5IGl0cwogKiBjb3VudGVyIGlkLCBhIHVpbnQuIENvdW50ZXJzIGNhbiBuZXZlciBkZWNyZWFzZS4KICogCiAqIFRoZSBjb250cmFjdCBoYXMgbm8gY29uc3RydWN0b3IuIFRoZSB0YXJnZXQgdmFsdWVzIGFyZSBzZXQgYW5kIHJlLXNldCB2aWEKICogc2V0VGFyZ2V0KCkuCiAqLwoKY29udHJhY3QgVGFyZ2V0cyB7CgogIC8vIE1hcHBpbmcgZnJvbSBjb3VudGVyIGlkIHRvIGNvdW50ZXIgdmFsdWUgCiAgbWFwcGluZyh1aW50ID0+IHVpbnQpIHB1YmxpYyBjb3VudGVyOwogIAogIC8vIE1hcHBpbmcgZnJvbSBjb3VudGVyIGlkIHRvIHRhcmdldCB2YWx1ZSAKICBtYXBwaW5nKHVpbnQgPT4gdWludCkgcHVibGljIHRhcmdldDsKCiAgLy8gQSBwdWJsaWMgZ2V0dGVyIHRoYXQgcmV0dXJucyB3aGV0aGVyIHRoZSB0YXJnZXQgd2FzIHJlYWNoZWQKICBmdW5jdGlvbiB0YXJnZXRSZWFjaGVkKHVpbnQgaWQpIGNvbnN0YW50IHJldHVybnMgKGJvb2wpIHsKICAgIHJldHVybiAoY291bnRlcltpZF0gPj0gdGFyZ2V0W2lkXSk7CiAgfQogIAogIC8qCiAgICogTW9kaWZ5aW5nIGNvdW50ZXIgb3IgdGFyZ2V0IGFyZSBpbnRlcm5hbCBmdW5jdGlvbnMuCiAgICovCiAgCiAgLy8gKFJlLSlzZXQgdGhlIHRhcmdldAogIGZ1bmN0aW9uIHNldFRhcmdldCh1aW50IGlkLCB1aW50IF90YXJnZXQpIGludGVybmFsIHsKICAgIHRhcmdldFtpZF0gPSBfdGFyZ2V0OwogIH0KIAogIC8vIEFkZCB0byB0aGUgY291bnRlciAKICAvLyBUaGUgZnVuY3Rpb24gcmV0dXJucyB3aGV0aGVyIHRoaXMgY3VycmVudCBhZGRpdGlvbiBtYWtlcyB0aGUgY291bnRlciByZWFjaAogIC8vIG9yIGNyb3NzIGl0cyB0YXJnZXQgdmFsdWUgCiAgZnVuY3Rpb24gYWRkVG93YXJkc1RhcmdldCh1aW50IGlkLCB1aW50IGFtb3VudCkgCiAgICBpbnRlcm5hbCAKICAgIHJldHVybnMgKGJvb2wgZmlyc3RSZWFjaGVkKSAKICB7CiAgICBmaXJzdFJlYWNoZWQgPSAoY291bnRlcltpZF0gPCB0YXJnZXRbaWRdKSAmJiAKICAgICAgICAgICAgICAgICAgIChjb3VudGVyW2lkXSArIGFtb3VudCA+PSB0YXJnZXRbaWRdKTsKICAgIGNvdW50ZXJbaWRdICs9IGFtb3VudDsKICB9Cn0KCi8vIGltcG9ydCAiUGFyYW1ldGVycy5zb2wiOwoKLyoqCiAqIHRpdGxlOiAgQ29uZmlndXJhdGlvbiBwYXJhbWV0ZXJzIGZvciB0aGUgRkRDCiAqIGF1dGhvcjogVGltbyBIYW5rZSAKICovCgpjb250cmFjdCBQYXJhbWV0ZXJzIHsKCiAgLyoKICAgKiBUaW1lIENvbnN0YW50cwogICAqCiAgICogUGhhc2VzIGFyZSwgaW4gdGhpcyBvcmRlcjogCiAgICogIGVhcmx5Q29udHJpYnV0aW9uIChkZWZpbmVkIGJ5IGVuZCB0aW1lKQogICAqICBwYXVzZQogICAqICBkb25hdGlvbiByb3VuZDAgKGRlZmluZWQgYnkgc3RhcnQgYW5kIGVuZCB0aW1lKQogICAqICBwYXVzZQogICAqICBkb25hdGlvbiByb3VuZDEgKGRlZmluZWQgYnkgc3RhcnQgYW5kIGVuZCB0aW1lKQogICAqICBwYXVzZQogICAqICBmaW5hbGl6YXRpb24gKGRlZmluZWQgYnkgc3RhcnQgdGltZSwgZW5kcyBtYW51YWxseSkKICAgKiAgZG9uZQogICAqLwoKICAvLyBUaGUgc3RhcnQgb2Ygcm91bmQgMCBpcyBzZXQgdG8gMjAxNy0wMS0xNyAxOTowMCBvZiB0aW1lem9uZSBFdXJvcGUvWnVyaWNoCiAgdWludCBwdWJsaWMgY29uc3RhbnQgcm91bmQwU3RhcnRUaW1lICAgICAgPSAxNDg0Njc2MDAwOyAKICAKICAvLyBUaGUgc3RhcnQgb2Ygcm91bmQgMSBpcyBzZXQgdG8gMjAxNy0wNS0xNyAxOTowMCBvZiB0aW1lem9uZSBFdXJvcGUvWnVyaWNoCiAgLy8gVFo9IkV1cm9wZS9adXJpY2giIGRhdGUgLWQgIjIwMTctMDUtMTcgMTk6MDAiICIrJXMiCiAgdWludCBwdWJsaWMgY29uc3RhbnQgcm91bmQxU3RhcnRUaW1lICAgICAgPSAxNDk1MDQwNDAwOyAKICAKICAvLyBUcmFuc2l0aW9uIHRpbWVzIHRoYXQgYXJlIGRlZmluZWQgYnkgZHVyYXRpb24KICB1aW50IHB1YmxpYyBjb25zdGFudCByb3VuZDBFbmRUaW1lICAgICAgICA9IHJvdW5kMFN0YXJ0VGltZSArIDYgd2Vla3M7CiAgdWludCBwdWJsaWMgY29uc3RhbnQgcm91bmQxRW5kVGltZSAgICAgICAgPSByb3VuZDFTdGFydFRpbWUgKyA2IHdlZWtzOwogIHVpbnQgcHVibGljIGNvbnN0YW50IGZpbmFsaXplU3RhcnRUaW1lICAgID0gcm91bmQxRW5kVGltZSAgICsgMSB3ZWVrczsKICAKICAvLyBUaGUgZmluYWxpemF0aW9uIHBoYXNlIGhhcyBhIGR1bW15IGVuZCB0aW1lIGJlY2F1c2UgaXQgaXMgZW5kZWQgbWFudWFsbHkKICB1aW50IHB1YmxpYyBjb25zdGFudCBmaW5hbGl6ZUVuZFRpbWUgICAgICA9IGZpbmFsaXplU3RhcnRUaW1lICsgMTAwMCB5ZWFyczsKICAKICAvLyBUaGUgbWF4aW11bSB0aW1lIGJ5IHdoaWNoIGRvbmF0aW9uIHJvdW5kIDEgY2FuIGJlIGRlbGF5ZWQgZnJvbSB0aGUgc3RhcnQgCiAgLy8gdGltZSBkZWZpbmVkIGFib3ZlCiAgdWludCBwdWJsaWMgY29uc3RhbnQgbWF4Um91bmREZWxheSAgICAgPSAyNzAgZGF5czsKCiAgLy8gVGhlIHRpbWUgZm9yIHdoaWNoIGRvbmF0aW9uIHJvdW5kcyByZW1haW4gb3BlbiBhZnRlciB0aGV5IHJlYWNoIHRoZWlyIAogIC8vIHJlc3BlY3RpdmUgdGFyZ2V0cyAgIAogIHVpbnQgcHVibGljIGNvbnN0YW50IGdyYWNlUGVyaW9kQWZ0ZXJSb3VuZDBUYXJnZXQgID0gMSBkYXlzOwogIHVpbnQgcHVibGljIGNvbnN0YW50IGdyYWNlUGVyaW9kQWZ0ZXJSb3VuZDFUYXJnZXQgID0gMCBkYXlzOwoKICAvKgogICAqIFRva2VuIGlzc3VhbmNlCiAgICogCiAgICogVGhlIGZvbGxvd2luZyBjb25maWd1cmF0aW9uIHBhcmFtZXRlcnMgY29tcGxldGVseSBnb3Zlcm4gYWxsIGFzcGVjdHMgb2YgdGhlIAogICAqIHRva2VuIGlzc3VhbmNlLgogICAqLwogIAogIC8vIFRva2VucyBhc3NpZ25lZCBmb3IgdGhlIGVxdWl2YWxlbnQgb2YgMSBDSEYgaW4gZG9uYXRpb25zCiAgdWludCBwdWJsaWMgY29uc3RhbnQgdG9rZW5zUGVyQ0hGID0gMTA7IAogIAogIC8vIE1pbmltYWwgZG9uYXRpb24gYW1vdW50IGZvciBhIHNpbmdsZSBvbi1jaGFpbiBkb25hdGlvbgogIHVpbnQgcHVibGljIGNvbnN0YW50IG1pbkRvbmF0aW9uID0gMSBldGhlcjsgCiAKICAvLyBCb251cyBpbiBwZXJjZW50IGFkZGVkIHRvIGRvbmF0aW9ucyB0aHJvdWdob3V0IGRvbmF0aW9uIHJvdW5kIDAgCiAgdWludCBwdWJsaWMgY29uc3RhbnQgcm91bmQwQm9udXMgPSAyMDA7IAogIAogIC8vIEJvbnVzIGluIHBlcmNlbnQgYWRkZWQgdG8gZG9uYXRpb25zIGF0IGJlZ2lubmluZyBvZiBkb25hdGlvbiByb3VuZCAxICAKICB1aW50IHB1YmxpYyBjb25zdGFudCByb3VuZDFJbml0aWFsQm9udXMgPSAyNTsKICAKICAvLyBOdW1iZXIgb2YgZG93bi1zdGVwcyBmb3IgdGhlIGJvbnVzIGR1cmluZyBkb25hdGlvbiByb3VuZCAxCiAgdWludCBwdWJsaWMgY29uc3RhbnQgcm91bmQxQm9udXNTdGVwcyA9IDU7CiAKICAvLyBUaGUgQ0hGIHRhcmdldHMgZm9yIGVhY2ggb2YgdGhlIGRvbmF0aW9uIHJvdW5kcywgbWVhc3VyZWQgaW4gY2VudHMgb2YgQ0hGIAogIHVpbnQgcHVibGljIGNvbnN0YW50IG1pbGxpb25JbkNlbnRzID0gMTAqKjYgKiAxMDA7CiAgdWludCBwdWJsaWMgY29uc3RhbnQgcm91bmQwVGFyZ2V0ID0gMSAqIG1pbGxpb25JbkNlbnRzOyAKICB1aW50IHB1YmxpYyBjb25zdGFudCByb3VuZDFUYXJnZXQgPSAyMCAqIG1pbGxpb25JbkNlbnRzOwoKICAvLyBTaGFyZSBvZiB0b2tlbnMgZXZlbnR1YWxseSBhc3NpZ25lZCB0byBERklOSVRZIFN0aWZ0dW5nIGFuZCBlYXJseSAKICAvLyBjb250cmlidXRvcnMgaW4gJSBvZiBhbGwgdG9rZW5zIGV2ZW50dWFsbHkgaW4gZXhpc3RlbmNlCiAgdWludCBwdWJsaWMgY29uc3RhbnQgZWFybHlDb250cmliU2hhcmUgPSAyMjsgCn0KCi8vIEZEQy5zb2wKCmNvbnRyYWN0IEZEQyBpcyBUb2tlblRyYWNrZXIsIFBoYXNlZCwgU3RlcEZ1bmN0aW9uLCBUYXJnZXRzLCBQYXJhbWV0ZXJzIHsKICAvLyBBbiBpZGVudGlmeWluZyBzdHJpbmcsIHNldCBieSB0aGUgY29uc3RydWN0b3IKICBzdHJpbmcgcHVibGljIG5hbWU7CiAgCiAgLyoKICAgKiBQaGFzZXMKICAgKgogICAqIFRoZSBGREMgb3ZlciBpdHMgbGlmZXRpbWUgcnVucyB0aHJvdWdoIGEgbnVtYmVyIG9mIHBoYXNlcy4gVGhlc2UgcGhhc2VzIGFyZQogICAqIHRyYWNrZWQgYnkgdGhlIGJhc2UgY29udHJhY3QgUGhhc2VkLgogICAqCiAgICogVGhlIEZEQyBtYXBzIHRoZSBjaHJvbm9sb2dpY2FsbHkgZGVmaW5lZCBwaGFzZSBudW1iZXJzIHRvIHNlbWFudGljYWxseSAKICAgKiBkZWZpbmVkIHN0YXRlcy4KICAgKi8KCiAgLy8gVGhlIEZEQyBzdGF0ZXMKICBlbnVtIHN0YXRlIHsKICAgIHBhdXNlLCAgICAgICAgIC8vIFBhdXNlIHdpdGhvdXQgYW55IGFjdGl2aXR5IAogICAgZWFybHlDb250cmliLCAgLy8gUmVnaXN0cmF0aW9uIG9mIERGSU5JVFkgU3RpZnR1bmcvZWFybHkgY29udHJpYnV0aW9ucwogICAgcm91bmQwLCAgICAgICAgLy8gRG9uYXRpb24gcm91bmQgMCAgCiAgICByb3VuZDEsICAgICAgICAvLyBEb25hdGlvbiByb3VuZCAxIAogICAgb2ZmQ2hhaW5SZWcsICAgLy8gR3JhY2UgcGVyaW9kIGZvciByZWdpc3RyYXRpb24gb2Ygb2ZmLWNoYWluIGRvbmF0aW9ucwogICAgZmluYWxpemF0aW9uLCAgLy8gQWRqdXN0bWVudCBvZiBERklOSVRZIFN0aWZ0dW5nL2Vhcmx5IGNvbnRyaWJ1dGlvbiB0b2tlbnMKICAgICAgICAgICAgICAgICAgIC8vIGRvd24gdG8gdGhlaXIgc2hhcmUKICAgIGRvbmUgICAgICAgICAgIC8vIFJlYWQtb25seSBwaGFzZQogIH0KCiAgLy8gTWFwcGluZyBmcm9tIHBoYXNlIG51bWJlciAoZnJvbSB0aGUgYmFzZSBjb250cmFjdCBQaGFzZWQpIHRvIEZEQyBzdGF0ZSAKICBtYXBwaW5nKHVpbnQgPT4gc3RhdGUpIHN0YXRlT2ZQaGFzZTsKCiAgLyoKICAgKiBUb2tlbnMKICAgKgogICAqIFRoZSBGREMgdXNlcyBiYXNlIGNvbnRyYWN0IFRva2VuVHJhY2tlciB0bzoKICAgKiAgLSB0cmFjayB0b2tlbiBhc3NpZ25tZW50cyBmb3IgCiAgICogICAgICAtIGRvbm9ycyAodW5yZXN0cmljdGVkIHRva2VucykKICAgKiAgICAgIC0gREZJTklUWSBTdGlmdHVuZy9lYXJseSBjb250cmlidXRvcnMgKHJlc3RyaWN0ZWQgdG9rZW5zKQogICAqICAtIGNvbnZlcnQgREZJTklUWSBTdGlmdHVuZy9lYXJseSBjb250cmlidXRvciB0b2tlbnMgZG93biB0byB0aGVpciBzaGFyZQogICAqCiAgICogVGhlIEZEQyB1c2VzIHRoZSBiYXNlIGNvbnRyYWN0IFRhcmdldHMgdG86CiAgICogIC0gdHJhY2sgdGhlIHRhcmdldHMgbWVhc3VyZWQgaW4gQ0hGIGZvciBlYWNoIGRvbmF0aW9uIHJvdW5kCiAgICoKICAgKiBUaGUgRkRDIGl0c2VsZjoKICAgKiAgLSB0cmFja3MgdGhlIG1lbW9zIG9mIG9mZi1jaGFpbiBkb25hdGlvbnMgKGFuZCBwcmV2ZW50cyBkdXBsaWNhdGVzKQogICAqICAtIHRyYWNrcyBkb25vciBhbmQgZWFybHkgY29udHJpYnV0b3IgYWRkcmVzc2VzIGluIHR3byBsaXN0cwogICAqLwogICAKICAvLyBNYXBwaW5nIHRvIHN0b3JlIG1lbW9zIHRoYXQgaGF2ZSBiZWVuIHVzZWQgCiAgbWFwcGluZyhieXRlczMyID0+IGJvb2wpIG1lbW9Vc2VkOwoKICAvLyBMaXN0IG9mIHJlZ2lzdGVyZWQgYWRkcmVzc2VzIChlYWNoIGFkZHJlc3Mgd2lsbCBhcHBlYXIgaW4gb25lKQogIGFkZHJlc3NbXSBwdWJsaWMgZG9ub3JMaXN0OyAgCiAgYWRkcmVzc1tdIHB1YmxpYyBlYXJseUNvbnRyaWJMaXN0OyAgCiAgCiAgLyoKICAgKiBFeGNoYW5nZSByYXRlIGFuZCBldGhlciBoYW5kbGluZwogICAqCiAgICogVGhlIEZEQyBrZWVwcyB0cmFjayBvZjoKICAgKiAgLSB0aGUgZXhjaGFuZ2UgcmF0ZSBiZXR3ZWVuIGV0aGVyIGFuZCBTd2lzcyBmcmFuY3MKICAgKiAgLSB0aGUgdG90YWwgYW5kIHBlciBhZGRyZXNzIGV0aGVyIGRvbmF0aW9ucwogICAqLwogICAKICAvLyBFeGNoYW5nZSByYXRlIGJldHdlZW4gZXRoZXIgYW5kIFN3aXNzIGZyYW5jcwogIHVpbnQgcHVibGljIHdlaVBlckNIRjsgICAgICAgCiAgCiAgLy8gVG90YWwgbnVtYmVyIG9mIFdlaSBkb25hdGVkIG9uLWNoYWluIHNvIGZhciAKICB1aW50IHB1YmxpYyB0b3RhbFdlaURvbmF0ZWQ7IAogIAogIC8vIE1hcHBpbmcgZnJvbSBhZGRyZXNzIHRvIHRvdGFsIG51bWJlciBvZiBXZWkgZG9uYXRlZCBmb3IgdGhlIGFkZHJlc3MKICBtYXBwaW5nKGFkZHJlc3MgPT4gdWludCkgcHVibGljIHdlaURvbmF0ZWQ7IAoKICAvKgogICAqIEFjY2VzcyBjb250cm9sIAogICAqIAogICAqIFRoZSBmb2xsb3dpbmcgdGhyZWUgYWRkcmVzc2VzIGhhdmUgYWNjZXNzIHRvIHJlc3RyaWN0ZWQgZnVuY3Rpb25zIG9mIHRoZSAKICAgKiBGREMgYW5kIHRvIHRoZSBkb25hdGVkIGZ1bmRzLgogICAqLwogICAKICAvLyBXYWxsZXQgYWRkcmVzcyB0byB3aGljaCBvbi1jaGFpbiBkb25hdGlvbnMgYXJlIGJlaW5nIGZvcndhcmRlZAogIGFkZHJlc3MgcHVibGljIGZvdW5kYXRpb25XYWxsZXQ7IAogIAogIC8vIEFkZHJlc3MgdGhhdCBpcyBhbGxvd2VkIHRvIHJlZ2lzdGVyIERGSU5JVFkgU3RpZnR1bmcvZWFybHkgY29udHJpYnV0aW9ucwogIC8vIGFuZCBvZmYtY2hhaW4gZG9uYXRpb25zIGFuZCB0byBkZWxheSBkb25hdGlvbiByb3VuZCAxCiAgYWRkcmVzcyBwdWJsaWMgcmVnaXN0cmFyQXV0aDsgCiAgCiAgLy8gQWRkcmVzcyB0aGF0IGlzIGFsbG93ZWQgdG8gdXBkYXRlIHRoZSBleGNoYW5nZSByYXRlCiAgYWRkcmVzcyBwdWJsaWMgZXhjaGFuZ2VSYXRlQXV0aDsgCgogIC8vIEFkZHJlc3MgdGhhdCBpcyBhbGxvd2VkIHRvIHVwZGF0ZSB0aGUgb3RoZXIgYXV0aGVudGljYXRlZCBhZGRyZXNzZXMKICBhZGRyZXNzIHB1YmxpYyBtYXN0ZXJBdXRoOyAKCiAgLyoKICAgKiBHbG9iYWwgdmFyaWFibGVzCiAgICovCiAKICAvLyBUaGUgcGhhc2UgbnVtYmVycyBvZiB0aGUgZG9uYXRpb24gcGhhc2VzIChzZXQgYnkgdGhlIGNvbnN0cnVjdG9yLCAKICAvLyB0aGVyZWFmdGVyIGNvbnN0YW50KQogIHVpbnQgcGhhc2VPZlJvdW5kMDsKICB1aW50IHBoYXNlT2ZSb3VuZDE7CiAgCiAgLyoKICAgKiBFdmVudHMKICAgKgogICAqICAtIERvbmF0aW9uUmVjZWlwdDogICAgIGxvZ3MgYW4gb24tY2hhaW4gb3Igb2ZmLWNoYWluIGRvbmF0aW9uCiAgICogIC0gRWFybHlDb250cmliUmVjZWlwdDogbG9ncyB0aGUgcmVnaXN0cmF0aW9uIG9mIGVhcmx5IGNvbnRyaWJ1dGlvbiAKICAgKiAgLSBCdXJuUmVjZWlwdDogICAgICAgICBsb2dzIHRoZSBidXJuaW5nIG9mIHRva2VuIGR1cmluZyBmaW5hbGl6YXRpb24KICAgKi8KICBldmVudCBEb25hdGlvblJlY2VpcHQgKGFkZHJlc3MgaW5kZXhlZCBhZGRyLCAgICAgICAgICAvLyBERk4gYWRkcmVzcyBvZiBkb25vcgogICAgICAgICAgICAgICAgICAgICAgICAgc3RyaW5nIGluZGV4ZWQgY3VycmVuY3ksICAgICAgIC8vIGRvbmF0aW9uIGN1cnJlbmN5CiAgICAgICAgICAgICAgICAgICAgICAgICB1aW50IGluZGV4ZWQgYm9udXNNdWx0aXBsaWVyQXBwbGllZCwgLy8gZGVwZW5kcyBzdGFnZQogICAgICAgICAgICAgICAgICAgICAgICAgdWludCB0aW1lc3RhbXAsICAgICAgICAgICAgICAgIC8vIHRpbWUgb2NjdXJyZWQKICAgICAgICAgICAgICAgICAgICAgICAgIHVpbnQgdG9rZW5BbW91bnQsICAgICAgICAgICAgICAvLyBERk4gdG8gYiByZWNvbW1lbmRlZAogICAgICAgICAgICAgICAgICAgICAgICAgYnl0ZXMzMiBtZW1vKTsgICAgICAgICAgICAgICAgIC8vIHVuaXF1ZSBub3RlIGUuZyBUeElECiAgZXZlbnQgRWFybHlDb250cmliUmVjZWlwdCAoYWRkcmVzcyBpbmRleGVkIGFkZHIsICAgICAgLy8gREZOIGFkZHJlc3Mgb2YgZG9ub3IgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdWludCB0b2tlbkFtb3VudCwgICAgICAgICAgLy8gKnJlc3RyaWN0ZWQqIHRva2VucwogICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJ5dGVzMzIgbWVtbyk7ICAgICAgICAgICAgIC8vIGFyYml0cmFyeSBub3RlCiAgZXZlbnQgQnVyblJlY2VpcHQgKGFkZHJlc3MgaW5kZXhlZCBhZGRyLCAgICAgICAgICAgICAgLy8gREZOIGFkZHJlc3MgYWRqdXN0ZWQKICAgICAgICAgICAgICAgICAgICAgdWludCB0b2tlbkFtb3VudEJ1cm5lZCk7ICAgICAgICAgICAvLyBERk4gZGVsZXRlZCBieSBhZGouCgogIC8qKgogICAqIENvbnN0cnVjdG9yCiAgICoKICAgKiBUaGUgY29uc3RydWN0b3IgZGVmaW5lcyAKICAgKiAgLSB0aGUgcHJpdmlsZWdlZCBhZGRyZXNzZXMgZm9yIGFjY2VzcyBjb250cm9sCiAgICogIC0gdGhlIHBoYXNlcyBpbiBiYXNlIGNvbnRyYWN0IFBoYXNlZAogICAqICAtIHRoZSBtYXBwaW5nIGJldHdlZW4gcGhhc2UgbnVtYmVycyBhbmQgc3RhdGVzCiAgICogIC0gdGhlIHRhcmdldHMgaW4gYmFzZSBjb250cmFjdCBUYXJnZXRzIAogICAqICAtIHRoZSBzaGFyZSBmb3IgZWFybHkgY29udHJpYnV0b3JzIGluIGJhc2UgY29udHJhY3QgVG9rZW5UcmFja2VyCiAgICogIC0gdGhlIHN0ZXAgZnVuY3Rpb24gZm9yIHRoZSBib251cyBjYWxjdWxhdGlvbiBpbiBkb25hdGlvbiByb3VuZCAxIAogICAqCiAgICogQWxsIGNvbmZpZ3VyYXRpb24gcGFyYW1ldGVycyBhcmUgdGFrZW4gZnJvbSBiYXNlIGNvbnRyYWN0IFBhcmFtZXRlcnMuCiAgICovCiAgZnVuY3Rpb24gRkRDKGFkZHJlc3MgX21hc3RlckF1dGgsIHN0cmluZyBfbmFtZSkKICAgIFRva2VuVHJhY2tlcihlYXJseUNvbnRyaWJTaGFyZSkKICAgIFN0ZXBGdW5jdGlvbihyb3VuZDFFbmRUaW1lLXJvdW5kMVN0YXJ0VGltZSwgcm91bmQxSW5pdGlhbEJvbnVzLCAKICAgICAgICAgICAgICAgICByb3VuZDFCb251c1N0ZXBzKSAKICB7CiAgICAvKgogICAgICogU2V0IGlkZW50aWZ5aW5nIHN0cmluZwogICAgICovCiAgICBuYW1lID0gX25hbWU7CgogICAgLyoKICAgICAqIFNldCBwcml2aWxlZ2VkIGFkZHJlc3NlcyBmb3IgYWNjZXNzIGNvbnRyb2wKICAgICAqLwogICAgZm91bmRhdGlvbldhbGxldCAgPSBfbWFzdGVyQXV0aDsKICAgIG1hc3RlckF1dGggICAgID0gX21hc3RlckF1dGg7CiAgICBleGNoYW5nZVJhdGVBdXRoICA9IF9tYXN0ZXJBdXRoOwogICAgcmVnaXN0cmFyQXV0aCAgPSBfbWFzdGVyQXV0aDsKCiAgICAvKgogICAgICogSW5pdGlhbGl6ZSBiYXNlIGNvbnRyYWN0IFBoYXNlZAogICAgICogCiAgICAgKiAgICAgICAgICAgfC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gUGhhc2UgbnVtYmVyICgwLTcpCiAgICAgKiAgICAgICAgICAgfCAgICB8LS0tLS0tLS0tLS0tLS0tLS0tLS0gU3RhdGUgbmFtZQogICAgICogICAgICAgICAgIHwgICAgfCAgICAgICAgICAgICAgIHwtLS0tIFRyYW5zaXRpb24gbnVtYmVyICgwLTYpCiAgICAgKiAgICAgICAgICAgViAgICBWICAgICAgICAgICAgICAgVgogICAgICovCiAgICBzdGF0ZU9mUGhhc2VbMF0gPSBzdGF0ZS5lYXJseUNvbnRyaWI7IAogICAgYWRkUGhhc2Uocm91bmQwU3RhcnRUaW1lKTsgICAgIC8vIDAKICAgIHN0YXRlT2ZQaGFzZVsxXSA9IHN0YXRlLnJvdW5kMDsKICAgIGFkZFBoYXNlKHJvdW5kMEVuZFRpbWUpOyAgICAgICAvLyAxIAogICAgc3RhdGVPZlBoYXNlWzJdID0gc3RhdGUub2ZmQ2hhaW5SZWc7CiAgICBhZGRQaGFzZShyb3VuZDFTdGFydFRpbWUpOyAgICAgLy8gMgogICAgc3RhdGVPZlBoYXNlWzNdID0gc3RhdGUucm91bmQxOwogICAgYWRkUGhhc2Uocm91bmQxRW5kVGltZSk7ICAgICAgIC8vIDMgCiAgICBzdGF0ZU9mUGhhc2VbNF0gPSBzdGF0ZS5vZmZDaGFpblJlZzsKICAgIGFkZFBoYXNlKGZpbmFsaXplU3RhcnRUaW1lKTsgICAvLyA0IAogICAgc3RhdGVPZlBoYXNlWzVdID0gc3RhdGUuZmluYWxpemF0aW9uOwogICAgYWRkUGhhc2UoZmluYWxpemVFbmRUaW1lKTsgICAgIC8vIDUgCiAgICBzdGF0ZU9mUGhhc2VbNl0gPSBzdGF0ZS5kb25lOwoKICAgIC8vIExldCB0aGUgb3RoZXIgZnVuY3Rpb25zIGtub3cgd2hhdCBwaGFzZSBudW1iZXJzIHRoZSBkb25hdGlvbiByb3VuZHMgd2VyZQogICAgLy8gYXNzaWduZWQgdG8KICAgIHBoYXNlT2ZSb3VuZDAgPSAxOwogICAgcGhhc2VPZlJvdW5kMSA9IDM7CiAgICAKICAgIC8vIE1heGltdW0gZGVsYXkgZm9yIHN0YXJ0IG9mIGRvbmF0aW9uIHJvdW5kcyAKICAgIHNldE1heERlbGF5KHBoYXNlT2ZSb3VuZDAgLSAxLCBtYXhSb3VuZERlbGF5KTsKICAgIHNldE1heERlbGF5KHBoYXNlT2ZSb3VuZDEgLSAxLCBtYXhSb3VuZERlbGF5KTsKCiAgICAvKgogICAgICogSW5pdGlhbGl6ZSBiYXNlIGNvbnRyYWN0IFRhcmdldHMKICAgICAqLwogICAgc2V0VGFyZ2V0KHBoYXNlT2ZSb3VuZDAsIHJvdW5kMFRhcmdldCk7CiAgICBzZXRUYXJnZXQocGhhc2VPZlJvdW5kMSwgcm91bmQxVGFyZ2V0KTsKICB9CiAgCiAgLyoKICAgKiBQVUJMSUMgZnVuY3Rpb25zCiAgICogCiAgICogVW4tYXV0aGVudGljYXRlZDoKICAgKiAgLSBnZXRTdGF0ZQogICAqICAtIGdldE11bHRpcGxpZXJBdFRpbWUKICAgKiAgLSBkb25hdGVBc1dpdGhDaGVja3N1bQogICAqICAtIGZpbmFsaXplCiAgICogIC0gZW1wdHkKICAgKiAgLSBnZXRTdGF0dXMKICAgKgogICAqIEF1dGhlbnRpY2F0ZWQ6CiAgICogIC0gcmVnaXN0ZXJFYXJseUNvbnRyaWIKICAgKiAgLSByZWdpc3Rlck9mZkNoYWluRG9uYXRpb24KICAgKiAgLSBzZXRFeGNoYW5nZVJhdGUKICAgKiAgLSBkZWxheVJvdW5kMQogICAqICAtIHNldEZvdW5kYXRpb25XYWxsZXQKICAgKiAgLSBzZXRSZWdpc3RyYXJBdXRoCiAgICogIC0gc2V0RXhjaGFuZ2VSYXRlQXV0aAogICAqICAtIHNldEFkbWluQXV0aAogICAqLwoKICAvKioKICAgKiBHZXQgY3VycmVudCBzdGF0ZSBhdCB0aGUgY3VycmVudCBibG9jayB0aW1lIAogICAqLwogIGZ1bmN0aW9uIGdldFN0YXRlKCkgY29uc3RhbnQgcmV0dXJucyAoc3RhdGUpIHsKICAgIHJldHVybiBzdGF0ZU9mUGhhc2VbZ2V0UGhhc2VBdFRpbWUobm93KV07CiAgfQogIAogIC8qKgogICAqIFJldHVybiB0aGUgYm9udXMgbXVsdGlwbGllciBhdCBhIGdpdmVuIHRpbWUKICAgKgogICAqIFRoZSBnaXZlbiB0aW1lIG11c3QgIAogICAqICAtIGxpZSBpbiBvbmUgb2YgdGhlIGRvbmF0aW9uIHJvdW5kcywgCiAgICogIC0gbm90IGxpZSBpbiB0aGUgZnV0dXJlLgogICAqIE90aGVyd2lzZSB0aGVyZSBpcyBubyB2YWxpZCBtdWx0aXBsaWVyLgogICAqLwogIGZ1bmN0aW9uIGdldE11bHRpcGxpZXJBdFRpbWUodWludCB0aW1lKSBjb25zdGFudCByZXR1cm5zICh1aW50KSB7CiAgICAvLyBHZXQgcGhhc2UgbnVtYmVyICh3aWxsIHRocm93IGlmIHRpbWUgbGllcyBpbiB0aGUgZnV0dXJlKQogICAgdWludCBuID0gZ2V0UGhhc2VBdFRpbWUodGltZSk7CgogICAgLy8gSWYgdGltZSBsaWVzIGluIGRvbmF0aW9uIHJvdW5kIDAgd2UgcmV0dXJuIHRoZSBjb25zdGFudCBtdWx0aXBsaWVyIAogICAgaWYgKHN0YXRlT2ZQaGFzZVtuXSA9PSBzdGF0ZS5yb3VuZDApIHsKICAgICAgcmV0dXJuIDEwMCArIHJvdW5kMEJvbnVzOwogICAgfQoKICAgIC8vIElmIHRpbWUgbGllcyBpbiBkb25hdGlvbiByb3VuZCAxIHdlIHJldHVybiB0aGUgc3RlcCBmdW5jdGlvbgogICAgaWYgKHN0YXRlT2ZQaGFzZVtuXSA9PSBzdGF0ZS5yb3VuZDEpIHsKICAgICAgcmV0dXJuIDEwMCArIGdldFN0ZXBGdW5jdGlvbih0aW1lIC0gZ2V0UGhhc2VTdGFydFRpbWUobikpOwogICAgfQoKICAgIC8vIFRocm93IG91dHNpZGUgb2YgZG9uYXRpb24gcm91bmRzCiAgICB0aHJvdzsKICB9CgogIC8qKgogICAqIFNlbmQgZG9uYXRpb24gaW4gdGhlIG5hbWUgYSB0aGUgZ2l2ZW4gYWRkcmVzcyB3aXRoIGNoZWNrc3VtCiAgICoKICAgKiBUaGUgc2Vjb25kIGFyZ3VtZW50IGlzIGEgY2hlY2tzdW0gd2hpY2ggbXVzdCBlcXVhbCB0aGUgZmlyc3QgNCBieXRlcyBvZiB0aGUKICAgKiBTSEEtMjU2IGRpZ2VzdCBvZiB0aGUgYnl0ZSByZXByZXNlbnRhdGlvbiBvZiB0aGUgYWRkcmVzcy4KICAgKi8KICBmdW5jdGlvbiBkb25hdGVBc1dpdGhDaGVja3N1bShhZGRyZXNzIGFkZHIsIGJ5dGVzNCBjaGVja3N1bSkgCiAgICBwYXlhYmxlIAogICAgcmV0dXJucyAoYm9vbCkgCiAgewogICAgLy8gQ2FsY3VsYXRlIFNIQS0yNTYgZGlnZXN0IG9mIHRoZSBhZGRyZXNzIAogICAgYnl0ZXMzMiBoYXNoID0gc2hhMjU2KGFkZHIpOwogICAgCiAgICAvLyBUaHJvdyBpcyB0aGUgY2hlY2tzdW0gZG9lcyBub3QgbWF0Y2ggdGhlIGZpcnN0IDQgYnl0ZXMKICAgIGlmIChieXRlczQoaGFzaCkgIT0gY2hlY2tzdW0pIHsgdGhyb3cgOyB9CgogICAgLy8gQ2FsbCB1bi1jaGVja3N1bW1lZCBkb25hdGUgZnVuY3Rpb24gCiAgICByZXR1cm4gZG9uYXRlQXMoYWRkcik7CiAgfQoKICAvKioKICAgKiBGaW5hbGl6ZSB0aGUgYmFsYW5jZSBmb3IgdGhlIGdpdmVuIGFkZHJlc3MKICAgKgogICAqIFRoaXMgZnVuY3Rpb24gdHJpZ2dlcnMgdGhlIGNvbnZlcnNpb24gKGFuZCBidXJuKSBvZiB0aGUgcmVzdHJpY3RlZCB0b2tlbnMKICAgKiB0aGF0IGFyZSBhc3NpZ25lZCB0byB0aGUgZ2l2ZW4gYWRkcmVzcy4KICAgKgogICAqIFRoaXMgZnVuY3Rpb24gaXMgb25seSBhdmFpbGFibGUgZHVyaW5nIHRoZSBmaW5hbGl6YXRpb24gcGhhc2UuIEl0IG1hbmFnZXMKICAgKiB0aGUgY2FsbHMgdG8gY2xvc2VBc3NpZ25tZW50cygpIGFuZCB1bnJlc3RyaWN0KCkgb2YgVG9rZW5UcmFja2VyLgogICAqLwogIGZ1bmN0aW9uIGZpbmFsaXplKGFkZHJlc3MgYWRkcikgewogICAgLy8gVGhyb3cgaWYgd2UgYXJlIG5vdCBpbiB0aGUgZmluYWxpemF0aW9uIHBoYXNlIAogICAgaWYgKGdldFN0YXRlKCkgIT0gc3RhdGUuZmluYWxpemF0aW9uKSB7IHRocm93OyB9CgogICAgLy8gQ2xvc2UgZG93biBmdXJ0aGVyIGFzc2lnbm1lbnRzIGluIFRva2VuVHJhY2tlcgogICAgY2xvc2VBc3NpZ25tZW50c0lmT3BlbigpOyAKCiAgICAvLyBCdXJuIHRva2VucwogICAgdWludCB0b2tlbnNCdXJuZWQgPSB1bnJlc3RyaWN0KGFkZHIpOyAKICAgIAogICAgLy8gSXNzdWUgYnVybiByZWNlaXB0CiAgICBCdXJuUmVjZWlwdChhZGRyLCB0b2tlbnNCdXJuZWQpOwoKICAgIC8vIElmIG5vIHJlc3RyaWN0ZWQgdG9rZW5zIGxlZnQKICAgIGlmIChpc1VucmVzdHJpY3RlZCgpKSB7IAogICAgICAvLyB0aGVuIGVuZCB0aGUgZmluYWxpemF0aW9uIHBoYXNlIGltbWVkaWF0ZWx5CiAgICAgIGVuZEN1cnJlbnRQaGFzZUluKDApOyAKICAgIH0KICB9CgogIC8qKgogICAqIFNlbmQgYW55IHJlbWFpbmluZyBiYWxhbmNlIHRvIHRoZSBmb3VuZGF0aW9uIHdhbGxldAogICAqLwogIGZ1bmN0aW9uIGVtcHR5KCkgcmV0dXJucyAoYm9vbCkgewogICAgcmV0dXJuIGZvdW5kYXRpb25XYWxsZXQuY2FsbC52YWx1ZSh0aGlzLmJhbGFuY2UpKCk7CiAgfQoKICAvKioKICAgKiBHZXQgc3RhdHVzIGluZm9ybWF0aW9uIGZyb20gdGhlIEZEQwogICAqCiAgICogVGhpcyBmdW5jdGlvbiByZXR1cm5zIGEgbWl4IG9mCiAgICogIC0gZ2xvYmFsIHN0YXR1cyBvZiB0aGUgRkRDCiAgICogIC0gZ2xvYmFsIHN0YXR1cyBvZiB0aGUgRkRDIHNwZWNpZmljIGZvciBvbmUgb2YgdGhlIHR3byBkb25hdGlvbiByb3VuZHMKICAgKiAgLSBzdGF0dXMgcmVsYXRlZCB0byBhIHNwZWNpZmljIHRva2VuIGFkZHJlc3MgKERGSU5JVFkgYWRkcmVzcykKICAgKiAgLSBzdGF0dXMgKGJhbGFuY2UpIG9mIGFuIGV4dGVybmFsIEV0aGVyZXVtIGFjY291bnQgCiAgICoKICAgKiBBcmd1bWVudHMgYXJlOgogICAqICAtIGRvbmF0aW9uUm91bmQ6IGRvbmF0aW9uIHJvdW5kIHRvIHF1ZXJ5ICgwIG9yIDEpCiAgICogIC0gZGZuQWRkcjogdG9rZW4gYWRkcmVzcyB0byBxdWVyeQogICAqICAtIGZ3ZEFkZHI6IGV4dGVybmFsIEV0aGVyZXVtIGFkZHJlc3MgdG8gcXVlcnkKICAgKi8KICBmdW5jdGlvbiBnZXRTdGF0dXModWludCBkb25hdGlvblJvdW5kLCBhZGRyZXNzIGRmbkFkZHIsIGFkZHJlc3MgZndkQWRkcikKICAgIHB1YmxpYyBjb25zdGFudAogICAgcmV0dXJucyAoCiAgICAgIHN0YXRlIGN1cnJlbnRTdGF0ZSwgICAgIC8vIGN1cnJlbnQgc3RhdGUgKGFuIGVudW0pCiAgICAgIHVpbnQgZnhSYXRlLCAgICAgICAgICAgIC8vIGV4Y2hhbmdlIHJhdGUgb2YgQ0hGIC0+IEVUSCAoV2VpL0NIRikKICAgICAgdWludCBjdXJyZW50TXVsdGlwbGllciwgLy8gY3VycmVudCBib251cyBtdWx0aXBsaWVyICgwIGlmIGludmFsaWQpCiAgICAgIHVpbnQgZG9uYXRpb25Db3VudCwgICAgIC8vIHRvdGFsIGluZGl2aWR1YWwgZG9uYXRpb25zIG1hZGUgKGEgY291bnQpCiAgICAgIHVpbnQgdG90YWxUb2tlbkFtb3VudCwgIC8vIHRvdGFsIERGTiBwbGFubmVkIGFsbG9jYXRlZCB0byBkb25vcnMKICAgICAgdWludCBzdGFydFRpbWUsICAgICAgICAgLy8gZXhwZWN0ZWQgc3RhcnQgdGltZSBvZiBzcGVjaWZpZWQgZG9uYXRpb24gcm91bmQKICAgICAgdWludCBlbmRUaW1lLCAgICAgICAgICAgLy8gZXhwZWN0ZWQgZW5kIHRpbWUgb2Ygc3BlY2lmaWVkIGRvbmF0aW9uIHJvdW5kCiAgICAgIGJvb2wgaXNUYXJnZXRSZWFjaGVkLCAgIC8vIHdoZXRoZXIgcm91bmQgdGFyZ2V0IGhhcyBiZWVuIHJlYWNoZWQKICAgICAgdWludCBjaGZDZW50c0RvbmF0ZWQsICAgLy8gdG90YWwgdmFsdWUgZG9uYXRlZCBpbiBzcGVjaWZpZWQgcm91bmQgYXMgQ0hGCiAgICAgIHVpbnQgdG9rZW5BbW91bnQsICAgICAgIC8vIHRvdGFsIERGTiBwbGFubmVkIGFsbG9jdGVkIHRvIGRvbm9yICh1c2VyKQogICAgICB1aW50IGZ3ZEJhbGFuY2UsICAgICAgICAvLyB0b3RhbCBFVEggKGluIFdlaSkgd2FpdGluZyBpbiBmb3dhcmRpbmcgYWRkcmVzcwogICAgICB1aW50IGRvbmF0ZWQpICAgICAgICAgICAvLyB0b3RhbCBFVEggKGluIFdlaSkgZG9uYXRlZCBieSBERk4gYWRkcmVzcyAKICB7CiAgICAvLyBUaGUgZ2xvYmFsIHN0YXR1cwogICAgY3VycmVudFN0YXRlID0gZ2V0U3RhdGUoKTsKICAgIGlmIChjdXJyZW50U3RhdGUgPT0gc3RhdGUucm91bmQwIHx8IGN1cnJlbnRTdGF0ZSA9PSBzdGF0ZS5yb3VuZDEpIHsKICAgICAgY3VycmVudE11bHRpcGxpZXIgPSBnZXRNdWx0aXBsaWVyQXRUaW1lKG5vdyk7CiAgICB9IAogICAgZnhSYXRlID0gd2VpUGVyQ0hGOwogICAgZG9uYXRpb25Db3VudCA9IHRvdGFsVW5yZXN0cmljdGVkQXNzaWdubWVudHM7CiAgICB0b3RhbFRva2VuQW1vdW50ID0gdG90YWxVbnJlc3RyaWN0ZWRUb2tlbnM7CiAgIAogICAgLy8gVGhlIHJvdW5kIHNwZWNpZmljIHN0YXR1cwogICAgaWYgKGRvbmF0aW9uUm91bmQgPT0gMCkgewogICAgICBzdGFydFRpbWUgPSBnZXRQaGFzZVN0YXJ0VGltZShwaGFzZU9mUm91bmQwKTsKICAgICAgZW5kVGltZSA9IGdldFBoYXNlU3RhcnRUaW1lKHBoYXNlT2ZSb3VuZDAgKyAxKTsKICAgICAgaXNUYXJnZXRSZWFjaGVkID0gdGFyZ2V0UmVhY2hlZChwaGFzZU9mUm91bmQwKTsKICAgICAgY2hmQ2VudHNEb25hdGVkID0gY291bnRlcltwaGFzZU9mUm91bmQwXTsKICAgIH0gZWxzZSB7CiAgICAgIHN0YXJ0VGltZSA9IGdldFBoYXNlU3RhcnRUaW1lKHBoYXNlT2ZSb3VuZDEpOwogICAgICBlbmRUaW1lID0gZ2V0UGhhc2VTdGFydFRpbWUocGhhc2VPZlJvdW5kMSArIDEpOwogICAgICBpc1RhcmdldFJlYWNoZWQgPSB0YXJnZXRSZWFjaGVkKHBoYXNlT2ZSb3VuZDEpOwogICAgICBjaGZDZW50c0RvbmF0ZWQgPSBjb3VudGVyW3BoYXNlT2ZSb3VuZDFdOwogICAgfQogICAgCiAgICAvLyBUaGUgc3RhdHVzIHNwZWNpZmljIHRvIHRoZSBERk4gYWRkcmVzcwogICAgdG9rZW5BbW91bnQgPSB0b2tlbnNbZGZuQWRkcl07CiAgICBkb25hdGVkID0gd2VpRG9uYXRlZFtkZm5BZGRyXTsKICAgIAogICAgLy8gVGhlIHN0YXR1cyBzcGVjaWZpYyB0byB0aGUgRXRoZXJldW0gYWRkcmVzcwogICAgZndkQmFsYW5jZSA9IGZ3ZEFkZHIuYmFsYW5jZTsKICB9CiAgCiAgLyoqCiAgICogU2V0IHRoZSBleGNoYW5nZSByYXRlIGJldHdlZW4gZXRoZXIgYW5kIFN3aXNzIGZyYW5jcyBpbiBXZWkgcGVyIENIRgogICAqCiAgICogTXVzdCBiZSBjYWxsZWQgZnJvbSBleGNoYW5nZVJhdGVBdXRoLgogICAqLwogIGZ1bmN0aW9uIHNldFdlaVBlckNIRih1aW50IHdlaXMpIHsKICAgIC8vIFJlcXVpcmUgcGVybWlzc2lvbgogICAgaWYgKG1zZy5zZW5kZXIgIT0gZXhjaGFuZ2VSYXRlQXV0aCkgeyB0aHJvdzsgfQoKICAgIC8vIFNldCB0aGUgZ2xvYmFsIHN0YXRlIHZhcmlhYmxlIGZvciBleGNoYW5nZSByYXRlIAogICAgd2VpUGVyQ0hGID0gd2VpczsKICB9CgogIC8qKgogICAqIFJlZ2lzdGVyIGVhcmx5IGNvbnRyaWJ1dGlvbiBpbiB0aGUgbmFtZSBvZiB0aGUgZ2l2ZW4gYWRkcmVzcwogICAqCiAgICogTXVzdCBiZSBjYWxsZWQgZnJvbSByZWdpc3RyYXJBdXRoLgogICAqCiAgICogQXJndW1lbnRzIGFyZToKICAgKiAgLSBhZGRyOiBhZGRyZXNzIHRvIHRoZSB0b2tlbnMgYXJlIGFzc2lnbmVkCiAgICogIC0gdG9rZW5BbW91bnQ6IG51bWJlciBvZiByZXN0cmljdGVkIHRva2VucyB0byBhc3NpZ24KICAgKiAgLSBtZW1vOiBvcHRpb25hbCBkeW5hbWljIGJ5dGVzIG9mIGRhdGEgdG8gYXBwZWFyIGluIHRoZSByZWNlaXB0CiAgICovCiAgZnVuY3Rpb24gcmVnaXN0ZXJFYXJseUNvbnRyaWIoYWRkcmVzcyBhZGRyLCB1aW50IHRva2VuQW1vdW50LCBieXRlczMyIG1lbW8pIHsKICAgIC8vIFJlcXVpcmUgcGVybWlzc2lvbgogICAgaWYgKG1zZy5zZW5kZXIgIT0gcmVnaXN0cmFyQXV0aCkgeyB0aHJvdzsgfQoKICAgIC8vIFJlamVjdCByZWdpc3RyYXRpb25zIG91dHNpZGUgdGhlIGVhcmx5IGNvbnRyaWJ1dGlvbiBwaGFzZQogICAgaWYgKGdldFN0YXRlKCkgIT0gc3RhdGUuZWFybHlDb250cmliKSB7IHRocm93OyB9CgogICAgLy8gQWRkIGFkZHJlc3MgdG8gbGlzdCBpZiBuZXcKICAgIGlmICghaXNSZWdpc3RlcmVkKGFkZHIsIHRydWUpKSB7CiAgICAgIGVhcmx5Q29udHJpYkxpc3QucHVzaChhZGRyKTsKICAgIH0KICAgIAogICAgLy8gQXNzaWduIHJlc3RyaWN0ZWQgdG9rZW5zIGluIFRva2VuVHJhY2tlcgogICAgYXNzaWduKGFkZHIsIHRva2VuQW1vdW50LCB0cnVlKTsKICAgIAogICAgLy8gSXNzdWUgZWFybHkgY29udHJpYnV0aW9uIHJlY2VpcHQKICAgIEVhcmx5Q29udHJpYlJlY2VpcHQoYWRkciwgdG9rZW5BbW91bnQsIG1lbW8pOwogIH0KCiAgLyoqCiAgICogUmVnaXN0ZXIgb2ZmLWNoYWluIGRvbmF0aW9uIGluIHRoZSBuYW1lIG9mIHRoZSBnaXZlbiBhZGRyZXNzCiAgICoKICAgKiBNdXN0IGJlIGNhbGxlZCBmcm9tIHJlZ2lzdHJhckF1dGguCiAgICoKICAgKiBBcmd1bWVudHMgYXJlOgogICAqICAtIGFkZHI6IGFkZHJlc3MgdG8gdGhlIHRva2VucyBhcmUgYXNzaWduZWQKICAgKiAgLSB0aW1lc3RhbXA6IHRpbWUgd2hlbiB0aGUgZG9uYXRpb24gY2FtZSBpbiAoZGV0ZXJtaW5lcyByb3VuZCBhbmQgYm9udXMpCiAgICogIC0gY2hmQ2VudHM6IHZhbHVlIG9mIHRoZSBkb25hdGlvbiBpbiBjZW50cyBvZiBTd2lzcyBmcmFuY3MKICAgKiAgLSBjdXJyZW5jeTogdGhlIG9yaWdpbmFsIGN1cnJlbmN5IG9mIHRoZSBkb25hdGlvbiAodGhyZWUgbGV0dGVyIHN0cmluZykKICAgKiAgLSBtZW1vOiBvcHRpb25hbCBieXRlcyBvZiBkYXRhIHRvIGFwcGVhciBpbiB0aGUgcmVjZWlwdAogICAqCiAgICogVGhlIHRpbWVzdGFtcCBtdXN0IG5vdCBiZSBpbiB0aGUgZnV0dXJlLiBUaGlzIGlzIGJlY2F1c2UgdGhlIHRpbWVzdGFtcCAKICAgKiBkZWZpbmVzIHRoZSBkb25hdGlvbiByb3VuZCBhbmQgdGhlIG11bHRpcGxpZXIgYW5kIGZ1dHVyZSBwaGFzZSB0aW1lcyBhcmUKICAgKiBzdGlsbCBzdWJqZWN0IHRvIGNoYW5nZS4KICAgKgogICAqIElmIGNhbGxlZCBkdXJpbmcgYSBkb25hdGlvbiByb3VuZCB0aGVuIHRoZSB0aW1lc3RhbXAgbXVzdCBsaWUgaW4gdGhlIHNhbWUgCiAgICogcGhhc2UgYW5kIGlmIGNhbGxlZCBkdXJpbmcgdGhlIGV4dGVuZGVkIHBlcmlvZCBmb3Igb2ZmLWNoYWluIGRvbmF0aW9ucyB0aGVuCiAgICogdGhlIHRpbWVzdGFtcCBtdXN0IGxpZSBpbiB0aGUgaW1tZWRpYXRlbHkgcHJlY2VkaW5nIGRvbmF0aW9uIHJvdW5kLiAKICAgKi8KICBmdW5jdGlvbiByZWdpc3Rlck9mZkNoYWluRG9uYXRpb24oYWRkcmVzcyBhZGRyLCB1aW50IHRpbWVzdGFtcCwgdWludCBjaGZDZW50cywgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0cmluZyBjdXJyZW5jeSwgYnl0ZXMzMiBtZW1vKQogIHsKICAgIC8vIFJlcXVpcmUgcGVybWlzc2lvbgogICAgaWYgKG1zZy5zZW5kZXIgIT0gcmVnaXN0cmFyQXV0aCkgeyB0aHJvdzsgfQoKICAgIC8vIFRoZSBjdXJyZW50IHBoYXNlIG51bWJlciBhbmQgc3RhdGUgY29ycmVzcG9uZGluZyBzdGF0ZQogICAgdWludCBjdXJyZW50UGhhc2UgPSBnZXRQaGFzZUF0VGltZShub3cpOwogICAgc3RhdGUgY3VycmVudFN0YXRlID0gc3RhdGVPZlBoYXNlW2N1cnJlbnRQaGFzZV07CiAgICAKICAgIC8vIFJlamVjdCByZWdpc3RyYXRpb25zIG91dHNpZGUgdGhlIHR3byBkb25hdGlvbiByb3VuZHMgKGluY2wuIHRoZWlyCiAgICAvLyBleHRlbmRlZCByZWdpc3RyYXRpb24gcGVyaW9kcyBmb3Igb2ZmLWNoYWluIGRvbmF0aW9ucykKICAgIGlmIChjdXJyZW50U3RhdGUgIT0gc3RhdGUucm91bmQwICYmIGN1cnJlbnRTdGF0ZSAhPSBzdGF0ZS5yb3VuZDEgJiYKICAgICAgICBjdXJyZW50U3RhdGUgIT0gc3RhdGUub2ZmQ2hhaW5SZWcpIHsKICAgICAgdGhyb3c7CiAgICB9CiAgIAogICAgLy8gVGhyb3cgaWYgdGltZXN0YW1wIGlzIGluIHRoZSBmdXR1cmUKICAgIGlmICh0aW1lc3RhbXAgPiBub3cpIHsgdGhyb3c7IH0KICAgCiAgICAvLyBQaGFzZSBudW1iZXIgYW5kIGNvcnJlc3BvbmRpbmcgc3RhdGUgb2YgdGhlIHRpbWVzdGFtcCAgCiAgICB1aW50IHRpbWVzdGFtcFBoYXNlID0gZ2V0UGhhc2VBdFRpbWUodGltZXN0YW1wKTsKICAgIHN0YXRlIHRpbWVzdGFtcFN0YXRlID0gc3RhdGVPZlBoYXNlW3RpbWVzdGFtcFBoYXNlXTsKICAgCiAgICAvLyBUaHJvdyBpZiBjYWxsZWQgZHVyaW5nIGEgZG9uYXRpb24gcm91bmQgYW5kIHRoZSB0aW1lc3RhbXAgZG9lcyBub3QgbWF0Y2gKICAgIC8vIHRoYXQgcGhhc2UuCiAgICBpZiAoKGN1cnJlbnRTdGF0ZSA9PSBzdGF0ZS5yb3VuZDAgfHwgY3VycmVudFN0YXRlID09IHN0YXRlLnJvdW5kMSkgJiYKICAgICAgICAodGltZXN0YW1wU3RhdGUgIT0gY3VycmVudFN0YXRlKSkgeyAKICAgICAgdGhyb3c7CiAgICB9CiAgICAKICAgIC8vIFRocm93IGlmIGNhbGxlZCBkdXJpbmcgdGhlIGV4dGVuZGVkIHBlcmlvZCBmb3Igb2ZmLWNoYWluIGRvbmF0aW9ucyBhbmQKICAgIC8vIHRoZSB0aW1lc3RhbXAgZG9lcyBub3QgbGllIGluIHRoZSBpbW1lZGlhdGVseSBwcmVjZWRpbmcgZG9uYXRpb24gcGhhc2UuCiAgICBpZiAoY3VycmVudFN0YXRlID09IHN0YXRlLm9mZkNoYWluUmVnICYmIHRpbWVzdGFtcFBoYXNlICE9IGN1cnJlbnRQaGFzZS0xKSB7CiAgICAgIHRocm93OwogICAgfQoKICAgIC8vIFRocm93IGlmIHRoZSBtZW1vIGlzIGR1cGxpY2F0ZWQKICAgIGlmIChtZW1vVXNlZFttZW1vXSkgewogICAgICB0aHJvdzsKICAgIH0KCiAgICAvLyBTZXQgdGhlIG1lbW8gaXRlbSB0byB0cnVlCiAgICBtZW1vVXNlZFttZW1vXSA9IHRydWU7CgogICAgLy8gRG8gdGhlIGJvb2sta2VlcGluZwogICAgYm9va0RvbmF0aW9uKGFkZHIsIHRpbWVzdGFtcCwgY2hmQ2VudHMsIGN1cnJlbmN5LCBtZW1vKTsKICB9CgogIC8qKgogICAqIERlbGF5IGEgZG9uYXRpb24gcm91bmQKICAgKgogICAqIE11c3QgYmUgY2FsbGVkIGZyb20gdGhlIGFkZHJlc3MgcmVnaXN0cmFyQXV0aC4KICAgKgogICAqIFRoaXMgZnVuY3Rpb24gZGVsYXlzIHRoZSBzdGFydCBvZiBkb25hdGlvbiByb3VuZCAxIGJ5IHRoZSBnaXZlbiB0aW1lIGRlbHRhCiAgICogdW5sZXNzIHRoZSB0aW1lIGRlbHRhIGlzIGJpZ2dlciB0aGFuIHRoZSBjb25maWd1cmVkIG1heGltdW0gZGVsYXkuCiAgICovCiAgZnVuY3Rpb24gZGVsYXlEb25QaGFzZSh1aW50IGRvblBoYXNlLCB1aW50IHRpbWVkZWx0YSkgewogICAgLy8gUmVxdWlyZSBwZXJtaXNzaW9uCiAgICBpZiAobXNnLnNlbmRlciAhPSByZWdpc3RyYXJBdXRoKSB7IHRocm93OyB9CgogICAgLy8gUGFzcyB0aGUgY2FsbCBvbiB0byBiYXNlIGNvbnRyYWN0IFBoYXNlZAogICAgLy8gRGVsYXlpbmcgdGhlIHN0YXJ0IG9mIGEgZG9uYXRpb24gcm91bmQgaXMgdGhlIHNhbWUgYXMgZGVsYXlpbmcgdGhlIGVuZCAKICAgIC8vIG9mIHRoZSBwcmVjZWRpbmcgcGhhc2UKICAgIGlmIChkb25QaGFzZSA9PSAwKSB7CiAgICAgIGRlbGF5UGhhc2VFbmRCeShwaGFzZU9mUm91bmQwIC0gMSwgdGltZWRlbHRhKTsKICAgIH0gZWxzZSBpZiAoZG9uUGhhc2UgPT0gMSkgewogICAgICBkZWxheVBoYXNlRW5kQnkocGhhc2VPZlJvdW5kMSAtIDEsIHRpbWVkZWx0YSk7CiAgICB9CiAgfQoKICAvKioKICAgKiBTZXQgdGhlIGZvcndhcmRpbmcgYWRkcmVzcyBmb3IgZG9uYXRlZCBldGhlcgogICAqIAogICAqIE11c3QgYmUgY2FsbGVkIGZyb20gdGhlIGFkZHJlc3MgbWFzdGVyQXV0aCBiZWZvcmUgZG9uYXRpb24gcm91bmQgMCBzdGFydHMuCiAgICovCiAgZnVuY3Rpb24gc2V0Rm91bmRhdGlvbldhbGxldChhZGRyZXNzIG5ld0FkZHIpIHsKICAgIC8vIFJlcXVpcmUgcGVybWlzc2lvbgogICAgaWYgKG1zZy5zZW5kZXIgIT0gbWFzdGVyQXV0aCkgeyB0aHJvdzsgfQogICAgCiAgICAvLyBSZXF1aXJlIHBoYXNlIGJlZm9yZSByb3VuZCAwCiAgICBpZiAoZ2V0UGhhc2VBdFRpbWUobm93KSA+PSBwaGFzZU9mUm91bmQwKSB7IHRocm93OyB9CiAKICAgIGZvdW5kYXRpb25XYWxsZXQgPSBuZXdBZGRyOwogIH0KCiAgLyoqCiAgICogU2V0IG5ldyBhdXRoZW50aWNhdGVkIGFkZHJlc3MgZm9yIHNldHRpbmcgZXhjaGFuZ2UgcmF0ZQogICAqIAogICAqIE11c3QgYmUgY2FsbGVkIGZyb20gdGhlIGFkZHJlc3MgbWFzdGVyQXV0aC4KICAgKi8KICBmdW5jdGlvbiBzZXRFeGNoYW5nZVJhdGVBdXRoKGFkZHJlc3MgbmV3QXV0aCkgewogICAgLy8gUmVxdWlyZSBwZXJtaXNzaW9uCiAgICBpZiAobXNnLnNlbmRlciAhPSBtYXN0ZXJBdXRoKSB7IHRocm93OyB9CiAKICAgIGV4Y2hhbmdlUmF0ZUF1dGggPSBuZXdBdXRoOwogIH0KCiAgLyoqCiAgICogU2V0IG5ldyBhdXRoZW50aWNhdGVkIGFkZHJlc3MgZm9yIHJlZ2lzdHJhdGlvbnMKICAgKiAKICAgKiBNdXN0IGJlIGNhbGxlZCBmcm9tIHRoZSBhZGRyZXNzIG1hc3RlckF1dGguCiAgICovCiAgZnVuY3Rpb24gc2V0UmVnaXN0cmFyQXV0aChhZGRyZXNzIG5ld0F1dGgpIHsKICAgIC8vIFJlcXVpcmUgcGVybWlzc2lvbgogICAgaWYgKG1zZy5zZW5kZXIgIT0gbWFzdGVyQXV0aCkgeyB0aHJvdzsgfQogCiAgICByZWdpc3RyYXJBdXRoID0gbmV3QXV0aDsKICB9CgogIC8qKgogICAqIFNldCBuZXcgYXV0aGVudGljYXRlZCBhZGRyZXNzIGZvciBhZG1pbgogICAqIAogICAqIE11c3QgYmUgY2FsbGVkIGZyb20gdGhlIGFkZHJlc3MgbWFzdGVyQXV0aC4KICAgKi8KICBmdW5jdGlvbiBzZXRNYXN0ZXJBdXRoKGFkZHJlc3MgbmV3QXV0aCkgewogICAgLy8gUmVxdWlyZSBwZXJtaXNzaW9uCiAgICBpZiAobXNnLnNlbmRlciAhPSBtYXN0ZXJBdXRoKSB7IHRocm93OyB9CiAKICAgIG1hc3RlckF1dGggPSBuZXdBdXRoOwogIH0KCiAgLyoKICAgKiBQUklWQVRFIGZ1bmN0aW9ucwogICAqCiAgICogIC0gZG9uYXRlQXMKICAgKiAgLSBib29rRG9uYXRpb24KICAgKi8KICAKICAvKioKICAgKiBQcm9jZXNzIG9uLWNoYWluIGRvbmF0aW9uIGluIHRoZSBuYW1lIG9mIHRoZSBnaXZlbiBhZGRyZXNzIAogICAqCiAgICogVGhpcyBmdW5jdGlvbiBpcyBwcml2YXRlIGJlY2F1c2UgaXQgc2hhbGwgb25seSBiZSBjYWxsZWQgdGhyb3VnaCBpdHMgCiAgICogd3JhcHBlciBkb25hdGVBc1dpdGhDaGVja3N1bS4KICAgKi8KICBmdW5jdGlvbiBkb25hdGVBcyhhZGRyZXNzIGFkZHIpIHByaXZhdGUgcmV0dXJucyAoYm9vbCkgewogICAgLy8gVGhlIGN1cnJlbnQgc3RhdGUKICAgIHN0YXRlIHN0ID0gZ2V0U3RhdGUoKTsKICAgIAogICAgLy8gVGhyb3cgaWYgY3VycmVudCBzdGF0ZSBpcyBub3QgYSBkb25hdGlvbiByb3VuZAogICAgaWYgKHN0ICE9IHN0YXRlLnJvdW5kMCAmJiBzdCAhPSBzdGF0ZS5yb3VuZDEpIHsgdGhyb3c7IH0KCiAgICAvLyBUaHJvdyBpZiBkb25hdGlvbiBhbW91bnQgaXMgYmVsb3cgbWluaW11bQogICAgaWYgKG1zZy52YWx1ZSA8IG1pbkRvbmF0aW9uKSB7IHRocm93OyB9CgogICAgLy8gVGhyb3cgaWYgdGhlIGV4Y2hhbmdlIHJhdGUgaXMgbm90IHlldCBkZWZpbmVkCiAgICBpZiAod2VpUGVyQ0hGID09IDApIHsgdGhyb3c7IH0gCgogICAgLy8gVXBkYXRlIGNvdW50ZXJzIGZvciBldGhlciBkb25hdGlvbnMKICAgIHRvdGFsV2VpRG9uYXRlZCArPSBtc2cudmFsdWU7CiAgICB3ZWlEb25hdGVkW2FkZHJdICs9IG1zZy52YWx1ZTsKCiAgICAvLyBDb252ZXJ0IGV0aGVyIHRvIFN3aXNzIGZyYW5jcwogICAgdWludCBjaGZDZW50cyA9IChtc2cudmFsdWUgKiAxMDApIC8gd2VpUGVyQ0hGOwogICAgCiAgICAvLyBEbyB0aGUgYm9vay1rZWVwaW5nCiAgICBib29rRG9uYXRpb24oYWRkciwgbm93LCBjaGZDZW50cywgIkVUSCIsICIiKTsKCiAgICAvLyBGb3J3YXJkIGJhbGFuY2UgdG8gdGhlIGZvdW5kYXRpb24gd2FsbGV0CiAgICByZXR1cm4gZm91bmRhdGlvbldhbGxldC5jYWxsLnZhbHVlKHRoaXMuYmFsYW5jZSkoKTsKICB9CgogIC8qKgogICAqIFB1dCBhbiBhY2NlcHRlZCBkb25hdGlvbiBpbiB0aGUgYm9va3MuCiAgICoKICAgKiBUaGlzIGZ1bmN0aW9uCiAgICogIC0gY2Fubm90IHRocm93IGFzIGFsbCBjaGVja3MgaGF2ZSBiZWVuIGRvbmUgYmVmb3JlLCAKICAgKiAgLSBpcyBhZ25vc3RpYyB0byB0aGUgc291cmNlIG9mIHRoZSBkb25hdGlvbiAob24tY2hhaW4gb3Igb2ZmLWNoYWluKQogICAqICAtIGlzIGFnbm9zdGljIHRvIHRoZSBjdXJyZW5jeSAKICAgKiAgICAodGhlIGN1cnJlbmN5IGFyZ3VtZW50IGlzIHNpbXBseSBwYXNzZWQgdGhyb3VnaCB0byB0aGUgRG9uYXRpb25SZWNlaXB0KQogICAqCiAgICovCiAgZnVuY3Rpb24gYm9va0RvbmF0aW9uKGFkZHJlc3MgYWRkciwgdWludCB0aW1lc3RhbXAsIHVpbnQgY2hmQ2VudHMsIAogICAgICAgICAgICAgICAgICAgICAgICBzdHJpbmcgY3VycmVuY3ksIGJ5dGVzMzIgbWVtbykgcHJpdmF0ZQogIHsKICAgIC8vIFRoZSBjdXJyZW50IHBoYXNlCiAgICB1aW50IHBoYXNlID0gZ2V0UGhhc2VBdFRpbWUodGltZXN0YW1wKTsKICAgIAogICAgLy8gQWRkIGFtb3VudCB0byB0aGUgY291bnRlciBvZiB0aGUgY3VycmVudCBwaGFzZQogICAgYm9vbCB0YXJnZXRSZWFjaGVkID0gYWRkVG93YXJkc1RhcmdldChwaGFzZSwgY2hmQ2VudHMpOwogICAgCiAgICAvLyBJZiB0aGUgdGFyZ2V0IHdhcyBjcm9zc2VkIHRoZW4gc3RhcnQgdGhlIGdyYWNlIHBlcmlvZAogICAgaWYgKHRhcmdldFJlYWNoZWQgJiYgcGhhc2UgPT0gZ2V0UGhhc2VBdFRpbWUobm93KSkgewogICAgICBpZiAocGhhc2UgPT0gcGhhc2VPZlJvdW5kMCkgewogICAgICAgIGVuZEN1cnJlbnRQaGFzZUluKGdyYWNlUGVyaW9kQWZ0ZXJSb3VuZDBUYXJnZXQpOwogICAgICB9IGVsc2UgaWYgKHBoYXNlID09IHBoYXNlT2ZSb3VuZDEpIHsKICAgICAgICBlbmRDdXJyZW50UGhhc2VJbihncmFjZVBlcmlvZEFmdGVyUm91bmQxVGFyZ2V0KTsKICAgICAgfQogICAgfQoKICAgIC8vIEJvbnVzIG11bHRpcGxpZXIgdGhhdCB3YXMgdmFsaWQgYXQgdGhlIGdpdmVuIHRpbWUgCiAgICB1aW50IGJvbnVzTXVsdGlwbGllciA9IGdldE11bHRpcGxpZXJBdFRpbWUodGltZXN0YW1wKTsKICAgIAogICAgLy8gQXBwbHkgYm9udXMgdG8gYW1vdW50IGluIFN3aXNzIGZyYW5jcwogICAgY2hmQ2VudHMgPSAoY2hmQ2VudHMgKiBib251c011bHRpcGxpZXIpIC8gMTAwOwoKICAgIC8vIENvbnZlcnQgU3dpc3MgZnJhbmNzIHRvIGFtb3VudCBvZiB0b2tlbnMKICAgIHVpbnQgdG9rZW5BbW91bnQgPSAoY2hmQ2VudHMgKiB0b2tlbnNQZXJDSEYpIC8gMTAwOwoKICAgIC8vIEFkZCBhZGRyZXNzIHRvIGxpc3QgaWYgbmV3CiAgICBpZiAoIWlzUmVnaXN0ZXJlZChhZGRyLCBmYWxzZSkpIHsKICAgICAgZG9ub3JMaXN0LnB1c2goYWRkcik7CiAgICB9CiAgICAKICAgIC8vIEFzc2lnbiB1bnJlc3RyaWN0ZWQgdG9rZW5zIGluIFRva2VuVHJhY2tlcgogICAgYXNzaWduKGFkZHIsdG9rZW5BbW91bnQsZmFsc2UpOwoKICAgIC8vIElzc3VlIGRvbmF0aW9uIHJlY2VpcHQKICAgIERvbmF0aW9uUmVjZWlwdChhZGRyLCBjdXJyZW5jeSwgYm9udXNNdWx0aXBsaWVyLCB0aW1lc3RhbXAsIHRva2VuQW1vdW50LCAKICAgICAgICAgICAgICAgICAgICBtZW1vKTsKICB9Cn0='.
	

]
