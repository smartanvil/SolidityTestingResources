Class {
	#name : #SRT0abdace70d3790235af448c88547603b945604ea,
	#superclass : #SRTContracts,
	#category : #SolidityTestingResources
}

{ #category : #base64 }
SRT0abdace70d3790235af448c88547603b945604ea >> base64 [
	^ 'cHJhZ21hIHNvbGlkaXR5IF4wLjQuMTE7CgoKbGlicmFyeSBTYWZlTWF0aCB7CiAgZnVuY3Rpb24gbXVsKHVpbnQgYSwgdWludCBiKSBpbnRlcm5hbCByZXR1cm5zICh1aW50KSB7CiAgICB1aW50IGMgPSBhICogYjsKICAgIGFzc2VydChhID09IDAgfHwgYyAvIGEgPT0gYik7CiAgICByZXR1cm4gYzsKICB9CgogIGZ1bmN0aW9uIGRpdih1aW50IGEsIHVpbnQgYikgaW50ZXJuYWwgcmV0dXJucyAodWludCkgewogICAgLy8gYXNzZXJ0KGIgPiAwKTsgLy8gU29saWRpdHkgYXV0b21hdGljYWxseSB0aHJvd3Mgd2hlbiBkaXZpZGluZyBieSAwCiAgICB1aW50IGMgPSBhIC8gYjsKICAgIC8vIGFzc2VydChhID09IGIgKiBjICsgYSAlIGIpOyAvLyBUaGVyZSBpcyBubyBjYXNlIGluIHdoaWNoIHRoaXMgZG9lc24ndCBob2xkCiAgICByZXR1cm4gYzsKICB9CgogIGZ1bmN0aW9uIHN1Yih1aW50IGEsIHVpbnQgYikgaW50ZXJuYWwgcmV0dXJucyAodWludCkgewogICAgYXNzZXJ0KGIgPD0gYSk7CiAgICByZXR1cm4gYSAtIGI7CiAgfQoKICBmdW5jdGlvbiBhZGQodWludCBhLCB1aW50IGIpIGludGVybmFsIHJldHVybnMgKHVpbnQpIHsKICAgIHVpbnQgYyA9IGEgKyBiOwogICAgYXNzZXJ0KGMgPj0gYSk7CiAgICByZXR1cm4gYzsKICB9CgogIGZ1bmN0aW9uIG1heDY0KHVpbnQ2NCBhLCB1aW50NjQgYikgaW50ZXJuYWwgY29uc3RhbnQgcmV0dXJucyAodWludDY0KSB7CiAgICByZXR1cm4gYSA+PSBiID8gYSA6IGI7CiAgfQoKICBmdW5jdGlvbiBtaW42NCh1aW50NjQgYSwgdWludDY0IGIpIGludGVybmFsIGNvbnN0YW50IHJldHVybnMgKHVpbnQ2NCkgewogICAgcmV0dXJuIGEgPCBiID8gYSA6IGI7CiAgfQoKICBmdW5jdGlvbiBtYXgyNTYodWludDI1NiBhLCB1aW50MjU2IGIpIGludGVybmFsIGNvbnN0YW50IHJldHVybnMgKHVpbnQyNTYpIHsKICAgIHJldHVybiBhID49IGIgPyBhIDogYjsKICB9CgogIGZ1bmN0aW9uIG1pbjI1Nih1aW50MjU2IGEsIHVpbnQyNTYgYikgaW50ZXJuYWwgY29uc3RhbnQgcmV0dXJucyAodWludDI1NikgewogICAgcmV0dXJuIGEgPCBiID8gYSA6IGI7CiAgfQoKICBmdW5jdGlvbiBhc3NlcnQoYm9vbCBhc3NlcnRpb24pIGludGVybmFsIHsKICAgIGlmICghYXNzZXJ0aW9uKSB7CiAgICAgIHRocm93OwogICAgfQogIH0KfQoKY29udHJhY3QgT3duYWJsZSB7CgogICAgLy8vIEBkZXYgYG93bmVyYCBpcyB0aGUgb25seSBhZGRyZXNzIHRoYXQgY2FuIGNhbGwgYSBmdW5jdGlvbiB3aXRoIHRoaXMKICAgIC8vLyBtb2RpZmllcgogICAgbW9kaWZpZXIgb25seU93bmVyKCkgewogICAgICAgIHJlcXVpcmUobXNnLnNlbmRlciA9PSBvd25lcik7CiAgICAgICAgXzsKICAgIH0KCiAgICBhZGRyZXNzIHB1YmxpYyBvd25lcjsKCiAgICAvLy8gQG5vdGljZSBUaGUgQ29uc3RydWN0b3IgYXNzaWducyB0aGUgbWVzc2FnZSBzZW5kZXIgdG8gYmUgYG93bmVyYAogICAgZnVuY3Rpb24gT3duYWJsZSgpIHsKICAgICAgICBvd25lciA9IG1zZy5zZW5kZXI7CiAgICB9CgogICAgYWRkcmVzcyBwdWJsaWMgbmV3T3duZXI7CgogICAgLy8vIEBub3RpY2UgYG93bmVyYCBjYW4gc3RlcCBkb3duIGFuZCBhc3NpZ24gc29tZSBvdGhlciBhZGRyZXNzIHRvIHRoaXMgcm9sZQogICAgLy8vIEBwYXJhbSBfbmV3T3duZXIgVGhlIGFkZHJlc3Mgb2YgdGhlIG5ldyBvd25lci4KICAgIGZ1bmN0aW9uIGNoYW5nZU93bmVyKGFkZHJlc3MgX25ld093bmVyKSBvbmx5T3duZXIgewogICAgICAgIG5ld093bmVyID0gX25ld093bmVyOwogICAgfQoKCiAgICBmdW5jdGlvbiBhY2NlcHRPd25lcnNoaXAoKSB7CiAgICAgICAgaWYgKG1zZy5zZW5kZXIgPT0gbmV3T3duZXIpIHsKICAgICAgICAgICAgb3duZXIgPSBuZXdPd25lcjsKICAgICAgICB9CiAgICB9Cn0KCmNvbnRyYWN0IFBhdXNhYmxlIGlzIE93bmFibGUgewogIGJvb2wgcHVibGljIHN0b3BwZWQ7CiAgZXZlbnQgb25FbWVyZ2VuY3lDaGFuZ2VkKGJvb2wgaXNTdG9wcGVkKTsKCiAgbW9kaWZpZXIgc3RvcEluRW1lcmdlbmN5IHsKICAgIGlmIChzdG9wcGVkKSB7CiAgICAgIHRocm93OwogICAgfQogICAgXzsKICB9CgogIG1vZGlmaWVyIG9ubHlJbkVtZXJnZW5jeSB7CiAgICBpZiAoIXN0b3BwZWQpIHsKICAgICAgdGhyb3c7CiAgICB9CiAgICBfOwogIH0KCiAgLy8gY2FsbGVkIGJ5IHRoZSBvd25lciBvbiBlbWVyZ2VuY3ksIHRyaWdnZXJzIHN0b3BwZWQgc3RhdGUKICBmdW5jdGlvbiBlbWVyZ2VuY3lTdG9wKCkgZXh0ZXJuYWwgb25seU93bmVyIHsKICAgIHN0b3BwZWQgPSB0cnVlOwogICAgb25FbWVyZ2VuY3lDaGFuZ2VkKHN0b3BwZWQpOwogIH0KCiAgLy8gY2FsbGVkIGJ5IHRoZSBvd25lciBvbiBlbmQgb2YgZW1lcmdlbmN5LCByZXR1cm5zIHRvIG5vcm1hbCBzdGF0ZQogIGZ1bmN0aW9uIHJlbGVhc2UoKSBleHRlcm5hbCBvbmx5T3duZXIgb25seUluRW1lcmdlbmN5IHsKICAgIHN0b3BwZWQgPSBmYWxzZTsKICAgIG9uRW1lcmdlbmN5Q2hhbmdlZChzdG9wcGVkKTsKICB9Cgp9Cgpjb250cmFjdCBFUkMyMEJhc2ljIHsKICBmdW5jdGlvbiB0b3RhbFN1cHBseSgpIGNvbnN0YW50IHJldHVybnMgKHVpbnQpOwogIGZ1bmN0aW9uIGJhbGFuY2VPZihhZGRyZXNzIHdobykgY29uc3RhbnQgcmV0dXJucyAodWludCk7CiAgZnVuY3Rpb24gdHJhbnNmZXIoYWRkcmVzcyB0bywgdWludCB2YWx1ZSkgcmV0dXJucyAoYm9vbCk7CiAgZXZlbnQgVHJhbnNmZXIoYWRkcmVzcyBpbmRleGVkIGZyb20sIGFkZHJlc3MgaW5kZXhlZCB0bywgdWludCB2YWx1ZSk7Cn0KCmNvbnRyYWN0IEVSQzIwIGlzIEVSQzIwQmFzaWMgewoKICBtYXBwaW5nKGFkZHJlc3MgPT4gdWludCkgYmFsYW5jZXM7CgogIGZ1bmN0aW9uIGFsbG93YW5jZShhZGRyZXNzIG93bmVyLCBhZGRyZXNzIHNwZW5kZXIpIGNvbnN0YW50IHJldHVybnMgKHVpbnQpOwogIGZ1bmN0aW9uIHRyYW5zZmVyRnJvbShhZGRyZXNzIGZyb20sIGFkZHJlc3MgdG8sIHVpbnQgdmFsdWUpIHJldHVybnMgKGJvb2wpOwogIGZ1bmN0aW9uIGFwcHJvdmUoYWRkcmVzcyBzcGVuZGVyLCB1aW50IHZhbHVlKSByZXR1cm5zIChib29sKTsKICBmdW5jdGlvbiBhcHByb3ZlQW5kQ2FsbChhZGRyZXNzIHNwZW5kZXIsIHVpbnQyNTYgdmFsdWUsIGJ5dGVzIGV4dHJhRGF0YSkgcmV0dXJucyAoYm9vbCk7CiAgZXZlbnQgQXBwcm92YWwoYWRkcmVzcyBpbmRleGVkIG93bmVyLCBhZGRyZXNzIGluZGV4ZWQgc3BlbmRlciwgdWludCB2YWx1ZSk7CgogIGZ1bmN0aW9uIGRvVHJhbnNmZXIoYWRkcmVzcyBfZnJvbSwgYWRkcmVzcyBfdG8sIHVpbnQgX2Ftb3VudCkgaW50ZXJuYWwgcmV0dXJucyhib29sKTsKfQoKY29udHJhY3QgR3JhbnRzQ29udHJvbGxlZCB7CiAgICBtb2RpZmllciBvbmx5R3JhbnRzQ29udHJvbGxlciB7IGlmIChtc2cuc2VuZGVyICE9IGdyYW50c0NvbnRyb2xsZXIpIHRocm93OyBfOyB9CgogICAgYWRkcmVzcyBwdWJsaWMgZ3JhbnRzQ29udHJvbGxlcjsKCiAgICBmdW5jdGlvbiBHcmFudHNDb250cm9sbGVkKCkgeyBncmFudHNDb250cm9sbGVyID0gbXNnLnNlbmRlcjt9CgogICAgZnVuY3Rpb24gY2hhbmdlR3JhbnRzQ29udHJvbGxlcihhZGRyZXNzIF9uZXdDb250cm9sbGVyKSBvbmx5R3JhbnRzQ29udHJvbGxlciB7CiAgICAgICAgZ3JhbnRzQ29udHJvbGxlciA9IF9uZXdDb250cm9sbGVyOwogICAgfQp9Cgpjb250cmFjdCBMaW1pdGVkVHJhbnNmZXJUb2tlbiBpcyBFUkMyMCB7CiAgLy8gQ2hlY2tzIHdoZXRoZXIgaXQgY2FuIHRyYW5zZmVyIG9yIG90aGVyd2lzZSB0aHJvd3MuCiAgbW9kaWZpZXIgY2FuVHJhbnNmZXIoYWRkcmVzcyBfc2VuZGVyLCB1aW50IF92YWx1ZSkgewogICBpZiAoX3ZhbHVlID4gdHJhbnNmZXJhYmxlVG9rZW5zKF9zZW5kZXIsIHVpbnQ2NChub3cpKSkgdGhyb3c7CiAgIF87CiAgfQoKICAvLyBDaGVja3MgbW9kaWZpZXIgYW5kIGFsbG93cyB0cmFuc2ZlciBpZiB0b2tlbnMgYXJlIG5vdCBsb2NrZWQuCiAgZnVuY3Rpb24gdHJhbnNmZXIoYWRkcmVzcyBfdG8sIHVpbnQgX3ZhbHVlKSBjYW5UcmFuc2Zlcihtc2cuc2VuZGVyLCBfdmFsdWUpIHJldHVybnMgKGJvb2wpIHsKICAgcmV0dXJuIHN1cGVyLnRyYW5zZmVyKF90bywgX3ZhbHVlKTsKICB9CgogIC8vIENoZWNrcyBtb2RpZmllciBhbmQgYWxsb3dzIHRyYW5zZmVyIGlmIHRva2VucyBhcmUgbm90IGxvY2tlZC4KICBmdW5jdGlvbiB0cmFuc2ZlckZyb20oYWRkcmVzcyBfZnJvbSwgYWRkcmVzcyBfdG8sIHVpbnQgX3ZhbHVlKSBjYW5UcmFuc2ZlcihfZnJvbSwgX3ZhbHVlKSByZXR1cm5zIChib29sKSB7CiAgIHJldHVybiBzdXBlci50cmFuc2ZlckZyb20oX2Zyb20sIF90bywgX3ZhbHVlKTsKICB9CgogIC8vIERlZmF1bHQgdHJhbnNmZXJhYmxlIHRva2VucyBmdW5jdGlvbiByZXR1cm5zIGFsbCB0b2tlbnMgZm9yIGEgaG9sZGVyIChubyBsaW1pdCkuCiAgZnVuY3Rpb24gdHJhbnNmZXJhYmxlVG9rZW5zKGFkZHJlc3MgaG9sZGVyLCB1aW50NjQgdGltZSkgY29uc3RhbnQgcHVibGljIHJldHVybnMgKHVpbnQyNTYpIHsKICAgIHJldHVybiBiYWxhbmNlT2YoaG9sZGVyKTsKICB9Cn0KCmNvbnRyYWN0IENvbnRyb2xsZWQgewogICAgLy8vIEBub3RpY2UgVGhlIGFkZHJlc3Mgb2YgdGhlIGNvbnRyb2xsZXIgaXMgdGhlIG9ubHkgYWRkcmVzcyB0aGF0IGNhbiBjYWxsCiAgICAvLy8gIGEgZnVuY3Rpb24gd2l0aCB0aGlzIG1vZGlmaWVyCiAgICBtb2RpZmllciBvbmx5Q29udHJvbGxlciB7IGlmIChtc2cuc2VuZGVyICE9IGNvbnRyb2xsZXIpIHRocm93OyBfOyB9CgogICAgYWRkcmVzcyBwdWJsaWMgY29udHJvbGxlcjsKCiAgICBmdW5jdGlvbiBDb250cm9sbGVkKCkgeyBjb250cm9sbGVyID0gbXNnLnNlbmRlcjt9CgogICAgLy8vIEBub3RpY2UgQ2hhbmdlcyB0aGUgY29udHJvbGxlciBvZiB0aGUgY29udHJhY3QKICAgIC8vLyBAcGFyYW0gX25ld0NvbnRyb2xsZXIgVGhlIG5ldyBjb250cm9sbGVyIG9mIHRoZSBjb250cmFjdAogICAgZnVuY3Rpb24gY2hhbmdlQ29udHJvbGxlcihhZGRyZXNzIF9uZXdDb250cm9sbGVyKSBvbmx5Q29udHJvbGxlciB7CiAgICAgICAgY29udHJvbGxlciA9IF9uZXdDb250cm9sbGVyOwogICAgfQp9Cgpjb250cmFjdCBNaW5pTWVUb2tlbiBpcyBFUkMyMCwgQ29udHJvbGxlZCB7CiAgICB1c2luZyBTYWZlTWF0aCBmb3IgdWludDsKCiAgICBzdHJpbmcgcHVibGljIG5hbWU7ICAgICAgICAgICAgICAgIC8vVGhlIFRva2VuJ3MgbmFtZTogZS5nLiBEaWdpeERBTyBUb2tlbnMKICAgIHVpbnQ4IHB1YmxpYyBkZWNpbWFsczsgICAgICAgICAgICAgLy9OdW1iZXIgb2YgZGVjaW1hbHMgb2YgdGhlIHNtYWxsZXN0IHVuaXQKICAgIHN0cmluZyBwdWJsaWMgc3ltYm9sOyAgICAgICAgICAgICAgLy9BbiBpZGVudGlmaWVyOiBlLmcuIFJFUAogICAgc3RyaW5nIHB1YmxpYyB2ZXJzaW9uID0gJ01NVF8wLjEnOyAvL0FuIGFyYml0cmFyeSB2ZXJzaW9uaW5nIHNjaGVtZQoKCiAgICAvLy8gQGRldiBgQ2hlY2twb2ludGAgaXMgdGhlIHN0cnVjdHVyZSB0aGF0IGF0dGFjaGVzIGEgYmxvY2sgbnVtYmVyIHRvIGEKICAgIC8vLyAgZ2l2ZW4gdmFsdWUsIHRoZSBibG9jayBudW1iZXIgYXR0YWNoZWQgaXMgdGhlIG9uZSB0aGF0IGxhc3QgY2hhbmdlZCB0aGUKICAgIC8vLyAgdmFsdWUKICAgIHN0cnVjdCAgQ2hlY2twb2ludCB7CgogICAgICAgIC8vIGBmcm9tQmxvY2tgIGlzIHRoZSBibG9jayBudW1iZXIgdGhhdCB0aGUgdmFsdWUgd2FzIGdlbmVyYXRlZCBmcm9tCiAgICAgICAgdWludDEyOCBmcm9tQmxvY2s7CgogICAgICAgIC8vIGB2YWx1ZWAgaXMgdGhlIGFtb3VudCBvZiB0b2tlbnMgYXQgYSBzcGVjaWZpYyBibG9jayBudW1iZXIKICAgICAgICB1aW50MTI4IHZhbHVlOwogICAgfQoKICAgIC8vIGBwYXJlbnRUb2tlbmAgaXMgdGhlIFRva2VuIGFkZHJlc3MgdGhhdCB3YXMgY2xvbmVkIHRvIHByb2R1Y2UgdGhpcyB0b2tlbjsKICAgIC8vICBpdCB3aWxsIGJlIDB4MCBmb3IgYSB0b2tlbiB0aGF0IHdhcyBub3QgY2xvbmVkCiAgICBNaW5pTWVUb2tlbiBwdWJsaWMgcGFyZW50VG9rZW47CgogICAgLy8gYHBhcmVudFNuYXBTaG90QmxvY2tgIGlzIHRoZSBibG9jayBudW1iZXIgZnJvbSB0aGUgUGFyZW50IFRva2VuIHRoYXQgd2FzCiAgICAvLyAgdXNlZCB0byBkZXRlcm1pbmUgdGhlIGluaXRpYWwgZGlzdHJpYnV0aW9uIG9mIHRoZSBDbG9uZSBUb2tlbgogICAgdWludCBwdWJsaWMgcGFyZW50U25hcFNob3RCbG9jazsKCiAgICAvLyBgY3JlYXRpb25CbG9ja2AgaXMgdGhlIGJsb2NrIG51bWJlciB0aGF0IHRoZSBDbG9uZSBUb2tlbiB3YXMgY3JlYXRlZAogICAgdWludCBwdWJsaWMgY3JlYXRpb25CbG9jazsKCiAgICAvLyBgYmFsYW5jZXNgIGlzIHRoZSBtYXAgdGhhdCB0cmFja3MgdGhlIGJhbGFuY2Ugb2YgZWFjaCBhZGRyZXNzLCBpbiB0aGlzCiAgICAvLyAgY29udHJhY3Qgd2hlbiB0aGUgYmFsYW5jZSBjaGFuZ2VzIHRoZSBibG9jayBudW1iZXIgdGhhdCB0aGUgY2hhbmdlCiAgICAvLyAgb2NjdXJyZWQgaXMgYWxzbyBpbmNsdWRlZCBpbiB0aGUgbWFwCiAgICBtYXBwaW5nIChhZGRyZXNzID0+IENoZWNrcG9pbnRbXSkgYmFsYW5jZXM7CgogICAgLy8gYGFsbG93ZWRgIHRyYWNrcyBhbnkgZXh0cmEgdHJhbnNmZXIgcmlnaHRzIGFzIGluIGFsbCBFUkMyMCB0b2tlbnMKICAgIG1hcHBpbmcgKGFkZHJlc3MgPT4gbWFwcGluZyAoYWRkcmVzcyA9PiB1aW50MjU2KSkgYWxsb3dlZDsKCiAgICAvLyBUcmFja3MgdGhlIGhpc3Rvcnkgb2YgdGhlIGB0b3RhbFN1cHBseWAgb2YgdGhlIHRva2VuCiAgICBDaGVja3BvaW50W10gdG90YWxTdXBwbHlIaXN0b3J5OwoKICAgIC8vIEZsYWcgdGhhdCBkZXRlcm1pbmVzIGlmIHRoZSB0b2tlbiBpcyB0cmFuc2ZlcmFibGUgb3Igbm90LgogICAgYm9vbCBwdWJsaWMgdHJhbnNmZXJzRW5hYmxlZDsKCiAgICAvLyBUaGUgZmFjdG9yeSB1c2VkIHRvIGNyZWF0ZSBuZXcgY2xvbmUgdG9rZW5zCiAgICBNaW5pTWVUb2tlbkZhY3RvcnkgcHVibGljIHRva2VuRmFjdG9yeTsKCi8vLy8vLy8vLy8vLy8vLy8KLy8gQ29uc3RydWN0b3IKLy8vLy8vLy8vLy8vLy8vLwoKICAgIC8vLyBAbm90aWNlIENvbnN0cnVjdG9yIHRvIGNyZWF0ZSBhIE1pbmlNZVRva2VuCiAgICAvLy8gQHBhcmFtIF90b2tlbkZhY3RvcnkgVGhlIGFkZHJlc3Mgb2YgdGhlIE1pbmlNZVRva2VuRmFjdG9yeSBjb250cmFjdCB0aGF0CiAgICAvLy8gIHdpbGwgY3JlYXRlIHRoZSBDbG9uZSB0b2tlbiBjb250cmFjdHMsIHRoZSB0b2tlbiBmYWN0b3J5IG5lZWRzIHRvIGJlCiAgICAvLy8gIGRlcGxveWVkIGZpcnN0CiAgICAvLy8gQHBhcmFtIF9wYXJlbnRUb2tlbiBBZGRyZXNzIG9mIHRoZSBwYXJlbnQgdG9rZW4sIHNldCB0byAweDAgaWYgaXQgaXMgYQogICAgLy8vICBuZXcgdG9rZW4KICAgIC8vLyBAcGFyYW0gX3BhcmVudFNuYXBTaG90QmxvY2sgQmxvY2sgb2YgdGhlIHBhcmVudCB0b2tlbiB0aGF0IHdpbGwKICAgIC8vLyAgZGV0ZXJtaW5lIHRoZSBpbml0aWFsIGRpc3RyaWJ1dGlvbiBvZiB0aGUgY2xvbmUgdG9rZW4sIHNldCB0byAwIGlmIGl0CiAgICAvLy8gIGlzIGEgbmV3IHRva2VuCiAgICAvLy8gQHBhcmFtIF90b2tlbk5hbWUgTmFtZSBvZiB0aGUgbmV3IHRva2VuCiAgICAvLy8gQHBhcmFtIF9kZWNpbWFsVW5pdHMgTnVtYmVyIG9mIGRlY2ltYWxzIG9mIHRoZSBuZXcgdG9rZW4KICAgIC8vLyBAcGFyYW0gX3Rva2VuU3ltYm9sIFRva2VuIFN5bWJvbCBmb3IgdGhlIG5ldyB0b2tlbgogICAgLy8vIEBwYXJhbSBfdHJhbnNmZXJzRW5hYmxlZCBJZiB0cnVlLCB0b2tlbnMgd2lsbCBiZSBhYmxlIHRvIGJlIHRyYW5zZmVycmVkCiAgICBmdW5jdGlvbiBNaW5pTWVUb2tlbigKICAgICAgICBhZGRyZXNzIF90b2tlbkZhY3RvcnksCiAgICAgICAgYWRkcmVzcyBfcGFyZW50VG9rZW4sCiAgICAgICAgdWludCBfcGFyZW50U25hcFNob3RCbG9jaywKICAgICAgICBzdHJpbmcgX3Rva2VuTmFtZSwKICAgICAgICB1aW50OCBfZGVjaW1hbFVuaXRzLAogICAgICAgIHN0cmluZyBfdG9rZW5TeW1ib2wsCiAgICAgICAgYm9vbCBfdHJhbnNmZXJzRW5hYmxlZAogICAgKSB7CiAgICAgICAgdG9rZW5GYWN0b3J5ID0gTWluaU1lVG9rZW5GYWN0b3J5KF90b2tlbkZhY3RvcnkpOwogICAgICAgIG5hbWUgPSBfdG9rZW5OYW1lOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNldCB0aGUgbmFtZQogICAgICAgIGRlY2ltYWxzID0gX2RlY2ltYWxVbml0czsgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNldCB0aGUgZGVjaW1hbHMKICAgICAgICBzeW1ib2wgPSBfdG9rZW5TeW1ib2w7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBTZXQgdGhlIHN5bWJvbAogICAgICAgIHBhcmVudFRva2VuID0gTWluaU1lVG9rZW4oX3BhcmVudFRva2VuKTsKICAgICAgICBwYXJlbnRTbmFwU2hvdEJsb2NrID0gX3BhcmVudFNuYXBTaG90QmxvY2s7CiAgICAgICAgdHJhbnNmZXJzRW5hYmxlZCA9IF90cmFuc2ZlcnNFbmFibGVkOwogICAgICAgIGNyZWF0aW9uQmxvY2sgPSBibG9jay5udW1iZXI7CiAgICB9CgoKLy8vLy8vLy8vLy8vLy8vLy8vLwovLyBFUkMyMCBNZXRob2RzCi8vLy8vLy8vLy8vLy8vLy8vLy8KCiAgICAvLy8gQG5vdGljZSBTZW5kIGBfYW1vdW50YCB0b2tlbnMgdG8gYF90b2AgZnJvbSBgbXNnLnNlbmRlcmAKICAgIC8vLyBAcGFyYW0gX3RvIFRoZSBhZGRyZXNzIG9mIHRoZSByZWNpcGllbnQKICAgIC8vLyBAcGFyYW0gX2Ftb3VudCBUaGUgYW1vdW50IG9mIHRva2VucyB0byBiZSB0cmFuc2ZlcnJlZAogICAgLy8vIEByZXR1cm4gV2hldGhlciB0aGUgdHJhbnNmZXIgd2FzIHN1Y2Nlc3NmdWwgb3Igbm90CiAgICBmdW5jdGlvbiB0cmFuc2ZlcihhZGRyZXNzIF90bywgdWludDI1NiBfYW1vdW50KSByZXR1cm5zIChib29sIHN1Y2Nlc3MpIHsKICAgICAgICBpZiAoIXRyYW5zZmVyc0VuYWJsZWQpIHRocm93OwogICAgICAgIHJldHVybiBkb1RyYW5zZmVyKG1zZy5zZW5kZXIsIF90bywgX2Ftb3VudCk7CiAgICB9CgogICAgLy8vIEBub3RpY2UgU2VuZCBgX2Ftb3VudGAgdG9rZW5zIHRvIGBfdG9gIGZyb20gYF9mcm9tYCBvbiB0aGUgY29uZGl0aW9uIGl0CiAgICAvLy8gIGlzIGFwcHJvdmVkIGJ5IGBfZnJvbWAKICAgIC8vLyBAcGFyYW0gX2Zyb20gVGhlIGFkZHJlc3MgaG9sZGluZyB0aGUgdG9rZW5zIGJlaW5nIHRyYW5zZmVycmVkCiAgICAvLy8gQHBhcmFtIF90byBUaGUgYWRkcmVzcyBvZiB0aGUgcmVjaXBpZW50CiAgICAvLy8gQHBhcmFtIF9hbW91bnQgVGhlIGFtb3VudCBvZiB0b2tlbnMgdG8gYmUgdHJhbnNmZXJyZWQKICAgIC8vLyBAcmV0dXJuIFRydWUgaWYgdGhlIHRyYW5zZmVyIHdhcyBzdWNjZXNzZnVsCiAgICBmdW5jdGlvbiB0cmFuc2ZlckZyb20oYWRkcmVzcyBfZnJvbSwgYWRkcmVzcyBfdG8sIHVpbnQyNTYgX2Ftb3VudAogICAgKSByZXR1cm5zIChib29sIHN1Y2Nlc3MpIHsKCiAgICAgICAgLy8gVGhlIGNvbnRyb2xsZXIgb2YgdGhpcyBjb250cmFjdCBjYW4gbW92ZSB0b2tlbnMgYXJvdW5kIGF0IHdpbGwsCiAgICAgICAgLy8gIHRoaXMgaXMgaW1wb3J0YW50IHRvIHJlY29nbml6ZSEgQ29uZmlybSB0aGF0IHlvdSB0cnVzdCB0aGUKICAgICAgICAvLyAgY29udHJvbGxlciBvZiB0aGlzIGNvbnRyYWN0LCB3aGljaCBpbiBtb3N0IHNpdHVhdGlvbnMgc2hvdWxkIGJlCiAgICAgICAgLy8gIGFub3RoZXIgb3BlbiBzb3VyY2Ugc21hcnQgY29udHJhY3Qgb3IgMHgwCiAgICAgICAgaWYgKG1zZy5zZW5kZXIgIT0gY29udHJvbGxlcikgewogICAgICAgICAgICBpZiAoIXRyYW5zZmVyc0VuYWJsZWQpIHRocm93OwoKICAgICAgICAgICAgLy8gVGhlIHN0YW5kYXJkIEVSQyAyMCB0cmFuc2ZlckZyb20gZnVuY3Rpb25hbGl0eQogICAgICAgICAgICBpZiAoYWxsb3dlZFtfZnJvbV1bbXNnLnNlbmRlcl0gPCBfYW1vdW50KSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIGFsbG93ZWRbX2Zyb21dW21zZy5zZW5kZXJdID0gYWxsb3dlZFtfZnJvbV1bbXNnLnNlbmRlcl0uc3ViKF9hbW91bnQpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZG9UcmFuc2ZlcihfZnJvbSwgX3RvLCBfYW1vdW50KTsKICAgIH0KCiAgICAvLy8gQGRldiBUaGlzIGlzIHRoZSBhY3R1YWwgdHJhbnNmZXIgZnVuY3Rpb24gaW4gdGhlIHRva2VuIGNvbnRyYWN0LCBpdCBjYW4KICAgIC8vLyAgb25seSBiZSBjYWxsZWQgYnkgb3RoZXIgZnVuY3Rpb25zIGluIHRoaXMgY29udHJhY3QuCiAgICAvLy8gQHBhcmFtIF9mcm9tIFRoZSBhZGRyZXNzIGhvbGRpbmcgdGhlIHRva2VucyBiZWluZyB0cmFuc2ZlcnJlZAogICAgLy8vIEBwYXJhbSBfdG8gVGhlIGFkZHJlc3Mgb2YgdGhlIHJlY2lwaWVudAogICAgLy8vIEBwYXJhbSBfYW1vdW50IFRoZSBhbW91bnQgb2YgdG9rZW5zIHRvIGJlIHRyYW5zZmVycmVkCiAgICAvLy8gQHJldHVybiBUcnVlIGlmIHRoZSB0cmFuc2ZlciB3YXMgc3VjY2Vzc2Z1bAogICAgZnVuY3Rpb24gZG9UcmFuc2ZlcihhZGRyZXNzIF9mcm9tLCBhZGRyZXNzIF90bywgdWludCBfYW1vdW50CiAgICApIGludGVybmFsIHJldHVybnMoYm9vbCkgewoKICAgICAgICAgICBpZiAoX2Ftb3VudCA9PSAwKSB7CiAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgIH0KCiAgICAgICAgICAgaWYgKHBhcmVudFNuYXBTaG90QmxvY2sgPj0gYmxvY2subnVtYmVyKSB0aHJvdzsKCiAgICAgICAgICAgLy8gRG8gbm90IGFsbG93IHRyYW5zZmVyIHRvIDB4MCBvciB0aGUgdG9rZW4gY29udHJhY3QgaXRzZWxmCiAgICAgICAgICAgaWYgKChfdG8gPT0gMCkgfHwgKF90byA9PSBhZGRyZXNzKHRoaXMpKSkgdGhyb3c7CgogICAgICAgICAgIC8vIElmIHRoZSBhbW91bnQgYmVpbmcgdHJhbnNmZXJlZCBpcyBtb3JlIHRoYW4gdGhlIGJhbGFuY2Ugb2YgdGhlCiAgICAgICAgICAgLy8gIGFjY291bnQgdGhlIHRyYW5zZmVyIHJldHVybnMgZmFsc2UKICAgICAgICAgICB2YXIgcHJldmlvdXNCYWxhbmNlRnJvbSA9IGJhbGFuY2VPZkF0KF9mcm9tLCBibG9jay5udW1iZXIpOwogICAgICAgICAgIGlmIChwcmV2aW91c0JhbGFuY2VGcm9tIDwgX2Ftb3VudCkgewogICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgfQoKICAgICAgICAgICAvLyBBbGVydHMgdGhlIHRva2VuIGNvbnRyb2xsZXIgb2YgdGhlIHRyYW5zZmVyCiAgICAgICAgICAgaWYgKGlzQ29udHJhY3QoY29udHJvbGxlcikpIHsKICAgICAgICAgICAgICAgaWYgKCFUb2tlbkNvbnRyb2xsZXIoY29udHJvbGxlcikub25UcmFuc2ZlcihfZnJvbSwgX3RvLCBfYW1vdW50KSkKICAgICAgICAgICAgICAgdGhyb3c7CiAgICAgICAgICAgfQoKICAgICAgICAgICAvLyBGaXJzdCB1cGRhdGUgdGhlIGJhbGFuY2UgYXJyYXkgd2l0aCB0aGUgbmV3IHZhbHVlIGZvciB0aGUgYWRkcmVzcwogICAgICAgICAgIC8vICBzZW5kaW5nIHRoZSB0b2tlbnMKICAgICAgICAgICB1cGRhdGVWYWx1ZUF0Tm93KGJhbGFuY2VzW19mcm9tXSwgcHJldmlvdXNCYWxhbmNlRnJvbS5zdWIoX2Ftb3VudCkpOwoKICAgICAgICAgICAvLyBUaGVuIHVwZGF0ZSB0aGUgYmFsYW5jZSBhcnJheSB3aXRoIHRoZSBuZXcgdmFsdWUgZm9yIHRoZSBhZGRyZXNzCiAgICAgICAgICAgLy8gIHJlY2VpdmluZyB0aGUgdG9rZW5zCiAgICAgICAgICAgdmFyIHByZXZpb3VzQmFsYW5jZVRvID0gYmFsYW5jZU9mQXQoX3RvLCBibG9jay5udW1iZXIpOwogICAgICAgICAgIHVwZGF0ZVZhbHVlQXROb3coYmFsYW5jZXNbX3RvXSwgcHJldmlvdXNCYWxhbmNlVG8uYWRkKF9hbW91bnQpKTsKCiAgICAgICAgICAgLy8gQW4gZXZlbnQgdG8gbWFrZSB0aGUgdHJhbnNmZXIgZWFzeSB0byBmaW5kIG9uIHRoZSBibG9ja2NoYWluCiAgICAgICAgICAgVHJhbnNmZXIoX2Zyb20sIF90bywgX2Ftb3VudCk7CgogICAgICAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIC8vLyBAcGFyYW0gX293bmVyIFRoZSBhZGRyZXNzIHRoYXQncyBiYWxhbmNlIGlzIGJlaW5nIHJlcXVlc3RlZAogICAgLy8vIEByZXR1cm4gVGhlIGJhbGFuY2Ugb2YgYF9vd25lcmAgYXQgdGhlIGN1cnJlbnQgYmxvY2sKICAgIGZ1bmN0aW9uIGJhbGFuY2VPZihhZGRyZXNzIF9vd25lcikgY29uc3RhbnQgcmV0dXJucyAodWludDI1NiBiYWxhbmNlKSB7CiAgICAgICAgcmV0dXJuIGJhbGFuY2VPZkF0KF9vd25lciwgYmxvY2subnVtYmVyKTsKICAgIH0KCiAgICAvLy8gQG5vdGljZSBgbXNnLnNlbmRlcmAgYXBwcm92ZXMgYF9zcGVuZGVyYCB0byBzcGVuZCBgX2Ftb3VudGAgdG9rZW5zIG9uCiAgICAvLy8gIGl0cyBiZWhhbGYuIFRoaXMgaXMgYSBtb2RpZmllZCB2ZXJzaW9uIG9mIHRoZSBFUkMyMCBhcHByb3ZlIGZ1bmN0aW9uCiAgICAvLy8gIHRvIGJlIGEgbGl0dGxlIGJpdCBzYWZlcgogICAgLy8vIEBwYXJhbSBfc3BlbmRlciBUaGUgYWRkcmVzcyBvZiB0aGUgYWNjb3VudCBhYmxlIHRvIHRyYW5zZmVyIHRoZSB0b2tlbnMKICAgIC8vLyBAcGFyYW0gX2Ftb3VudCBUaGUgYW1vdW50IG9mIHRva2VucyB0byBiZSBhcHByb3ZlZCBmb3IgdHJhbnNmZXIKICAgIC8vLyBAcmV0dXJuIFRydWUgaWYgdGhlIGFwcHJvdmFsIHdhcyBzdWNjZXNzZnVsCiAgICBmdW5jdGlvbiBhcHByb3ZlKGFkZHJlc3MgX3NwZW5kZXIsIHVpbnQyNTYgX2Ftb3VudCkgcmV0dXJucyAoYm9vbCBzdWNjZXNzKSB7CiAgICAgICAgaWYgKCF0cmFuc2ZlcnNFbmFibGVkKSB0aHJvdzsKCiAgICAgICAgLy8gVG8gY2hhbmdlIHRoZSBhcHByb3ZlIGFtb3VudCB5b3UgZmlyc3QgaGF2ZSB0byByZWR1Y2UgdGhlIGFkZHJlc3Nlc2AKICAgICAgICAvLyAgYWxsb3dhbmNlIHRvIHplcm8gYnkgY2FsbGluZyBgYXBwcm92ZShfc3BlbmRlciwwKWAgaWYgaXQgaXMgbm90CiAgICAgICAgLy8gIGFscmVhZHkgMCB0byBtaXRpZ2F0ZSB0aGUgcmFjZSBjb25kaXRpb24gZGVzY3JpYmVkIGhlcmU6CiAgICAgICAgLy8gIGh0dHBzOi8vZ2l0aHViLmNvbS9ldGhlcmV1bS9FSVBzL2lzc3Vlcy8yMCNpc3N1ZWNvbW1lbnQtMjYzNTI0NzI5CiAgICAgICAgaWYgKChfYW1vdW50IT0wKSAmJiAoYWxsb3dlZFttc2cuc2VuZGVyXVtfc3BlbmRlcl0gIT0wKSkgdGhyb3c7CgogICAgICAgIC8vIEFsZXJ0cyB0aGUgdG9rZW4gY29udHJvbGxlciBvZiB0aGUgYXBwcm92ZSBmdW5jdGlvbiBjYWxsCiAgICAgICAgaWYgKGlzQ29udHJhY3QoY29udHJvbGxlcikpIHsKICAgICAgICAgICAgaWYgKCFUb2tlbkNvbnRyb2xsZXIoY29udHJvbGxlcikub25BcHByb3ZlKG1zZy5zZW5kZXIsIF9zcGVuZGVyLCBfYW1vdW50KSkKICAgICAgICAgICAgICAgIHRocm93OwogICAgICAgIH0KCiAgICAgICAgYWxsb3dlZFttc2cuc2VuZGVyXVtfc3BlbmRlcl0gPSBfYW1vdW50OwogICAgICAgIEFwcHJvdmFsKG1zZy5zZW5kZXIsIF9zcGVuZGVyLCBfYW1vdW50KTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICAvLy8gQGRldiBUaGlzIGZ1bmN0aW9uIG1ha2VzIGl0IGVhc3kgdG8gcmVhZCB0aGUgYGFsbG93ZWRbXWAgbWFwCiAgICAvLy8gQHBhcmFtIF9vd25lciBUaGUgYWRkcmVzcyBvZiB0aGUgYWNjb3VudCB0aGF0IG93bnMgdGhlIHRva2VuCiAgICAvLy8gQHBhcmFtIF9zcGVuZGVyIFRoZSBhZGRyZXNzIG9mIHRoZSBhY2NvdW50IGFibGUgdG8gdHJhbnNmZXIgdGhlIHRva2VucwogICAgLy8vIEByZXR1cm4gQW1vdW50IG9mIHJlbWFpbmluZyB0b2tlbnMgb2YgX293bmVyIHRoYXQgX3NwZW5kZXIgaXMgYWxsb3dlZAogICAgLy8vICB0byBzcGVuZAogICAgZnVuY3Rpb24gYWxsb3dhbmNlKGFkZHJlc3MgX293bmVyLCBhZGRyZXNzIF9zcGVuZGVyCiAgICApIGNvbnN0YW50IHJldHVybnMgKHVpbnQyNTYgcmVtYWluaW5nKSB7CiAgICAgICAgcmV0dXJuIGFsbG93ZWRbX293bmVyXVtfc3BlbmRlcl07CiAgICB9CgogICAgLy8vIEBub3RpY2UgYG1zZy5zZW5kZXJgIGFwcHJvdmVzIGBfc3BlbmRlcmAgdG8gc2VuZCBgX2Ftb3VudGAgdG9rZW5zIG9uCiAgICAvLy8gIGl0cyBiZWhhbGYsIGFuZCB0aGVuIGEgZnVuY3Rpb24gaXMgdHJpZ2dlcmVkIGluIHRoZSBjb250cmFjdCB0aGF0IGlzCiAgICAvLy8gIGJlaW5nIGFwcHJvdmVkLCBgX3NwZW5kZXJgLiBUaGlzIGFsbG93cyB1c2VycyB0byB1c2UgdGhlaXIgdG9rZW5zIHRvCiAgICAvLy8gIGludGVyYWN0IHdpdGggY29udHJhY3RzIGluIG9uZSBmdW5jdGlvbiBjYWxsIGluc3RlYWQgb2YgdHdvCiAgICAvLy8gQHBhcmFtIF9zcGVuZGVyIFRoZSBhZGRyZXNzIG9mIHRoZSBjb250cmFjdCBhYmxlIHRvIHRyYW5zZmVyIHRoZSB0b2tlbnMKICAgIC8vLyBAcGFyYW0gX2Ftb3VudCBUaGUgYW1vdW50IG9mIHRva2VucyB0byBiZSBhcHByb3ZlZCBmb3IgdHJhbnNmZXIKICAgIC8vLyBAcmV0dXJuIFRydWUgaWYgdGhlIGZ1bmN0aW9uIGNhbGwgd2FzIHN1Y2Nlc3NmdWwKICAgIGZ1bmN0aW9uIGFwcHJvdmVBbmRDYWxsKGFkZHJlc3MgX3NwZW5kZXIsIHVpbnQyNTYgX2Ftb3VudCwgYnl0ZXMgX2V4dHJhRGF0YQogICAgKSByZXR1cm5zIChib29sIHN1Y2Nlc3MpIHsKICAgICAgICBpZiAoIWFwcHJvdmUoX3NwZW5kZXIsIF9hbW91bnQpKSB0aHJvdzsKCiAgICAgICAgQXBwcm92ZUFuZENhbGxGYWxsQmFjayhfc3BlbmRlcikucmVjZWl2ZUFwcHJvdmFsKAogICAgICAgICAgICBtc2cuc2VuZGVyLAogICAgICAgICAgICBfYW1vdW50LAogICAgICAgICAgICB0aGlzLAogICAgICAgICAgICBfZXh0cmFEYXRhCiAgICAgICAgKTsKCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgLy8vIEBkZXYgVGhpcyBmdW5jdGlvbiBtYWtlcyBpdCBlYXN5IHRvIGdldCB0aGUgdG90YWwgbnVtYmVyIG9mIHRva2VucwogICAgLy8vIEByZXR1cm4gVGhlIHRvdGFsIG51bWJlciBvZiB0b2tlbnMKICAgIGZ1bmN0aW9uIHRvdGFsU3VwcGx5KCkgY29uc3RhbnQgcmV0dXJucyAodWludCkgewogICAgICAgIHJldHVybiB0b3RhbFN1cHBseUF0KGJsb2NrLm51bWJlcik7CiAgICB9CgoKLy8vLy8vLy8vLy8vLy8vLwovLyBRdWVyeSBiYWxhbmNlIGFuZCB0b3RhbFN1cHBseSBpbiBIaXN0b3J5Ci8vLy8vLy8vLy8vLy8vLy8KCiAgICAvLy8gQGRldiBRdWVyaWVzIHRoZSBiYWxhbmNlIG9mIGBfb3duZXJgIGF0IGEgc3BlY2lmaWMgYF9ibG9ja051bWJlcmAKICAgIC8vLyBAcGFyYW0gX293bmVyIFRoZSBhZGRyZXNzIGZyb20gd2hpY2ggdGhlIGJhbGFuY2Ugd2lsbCBiZSByZXRyaWV2ZWQKICAgIC8vLyBAcGFyYW0gX2Jsb2NrTnVtYmVyIFRoZSBibG9jayBudW1iZXIgd2hlbiB0aGUgYmFsYW5jZSBpcyBxdWVyaWVkCiAgICAvLy8gQHJldHVybiBUaGUgYmFsYW5jZSBhdCBgX2Jsb2NrTnVtYmVyYAogICAgZnVuY3Rpb24gYmFsYW5jZU9mQXQoYWRkcmVzcyBfb3duZXIsIHVpbnQgX2Jsb2NrTnVtYmVyKSBjb25zdGFudAogICAgICAgIHJldHVybnMgKHVpbnQpIHsKCiAgICAgICAgLy8gVGhlc2UgbmV4dCBmZXcgbGluZXMgYXJlIHVzZWQgd2hlbiB0aGUgYmFsYW5jZSBvZiB0aGUgdG9rZW4gaXMKICAgICAgICAvLyAgcmVxdWVzdGVkIGJlZm9yZSBhIGNoZWNrIHBvaW50IHdhcyBldmVyIGNyZWF0ZWQgZm9yIHRoaXMgdG9rZW4sIGl0CiAgICAgICAgLy8gIHJlcXVpcmVzIHRoYXQgdGhlIGBwYXJlbnRUb2tlbi5iYWxhbmNlT2ZBdGAgYmUgcXVlcmllZCBhdCB0aGUKICAgICAgICAvLyAgZ2VuZXNpcyBibG9jayBmb3IgdGhhdCB0b2tlbiBhcyB0aGlzIGNvbnRhaW5zIGluaXRpYWwgYmFsYW5jZSBvZgogICAgICAgIC8vICB0aGlzIHRva2VuCiAgICAgICAgaWYgKChiYWxhbmNlc1tfb3duZXJdLmxlbmd0aCA9PSAwKQogICAgICAgICAgICB8fCAoYmFsYW5jZXNbX293bmVyXVswXS5mcm9tQmxvY2sgPiBfYmxvY2tOdW1iZXIpKSB7CiAgICAgICAgICAgIGlmIChhZGRyZXNzKHBhcmVudFRva2VuKSAhPSAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcGFyZW50VG9rZW4uYmFsYW5jZU9mQXQoX293bmVyLCBtaW4oX2Jsb2NrTnVtYmVyLCBwYXJlbnRTbmFwU2hvdEJsb2NrKSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBIYXMgbm8gcGFyZW50CiAgICAgICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgICAgfQoKICAgICAgICAvLyBUaGlzIHdpbGwgcmV0dXJuIHRoZSBleHBlY3RlZCBiYWxhbmNlIGR1cmluZyBub3JtYWwgc2l0dWF0aW9ucwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBnZXRWYWx1ZUF0KGJhbGFuY2VzW19vd25lcl0sIF9ibG9ja051bWJlcik7CiAgICAgICAgfQogICAgfQoKICAgIC8vLyBAbm90aWNlIFRvdGFsIGFtb3VudCBvZiB0b2tlbnMgYXQgYSBzcGVjaWZpYyBgX2Jsb2NrTnVtYmVyYC4KICAgIC8vLyBAcGFyYW0gX2Jsb2NrTnVtYmVyIFRoZSBibG9jayBudW1iZXIgd2hlbiB0aGUgdG90YWxTdXBwbHkgaXMgcXVlcmllZAogICAgLy8vIEByZXR1cm4gVGhlIHRvdGFsIGFtb3VudCBvZiB0b2tlbnMgYXQgYF9ibG9ja051bWJlcmAKICAgIGZ1bmN0aW9uIHRvdGFsU3VwcGx5QXQodWludCBfYmxvY2tOdW1iZXIpIGNvbnN0YW50IHJldHVybnModWludCkgewoKICAgICAgICAvLyBUaGVzZSBuZXh0IGZldyBsaW5lcyBhcmUgdXNlZCB3aGVuIHRoZSB0b3RhbFN1cHBseSBvZiB0aGUgdG9rZW4gaXMKICAgICAgICAvLyAgcmVxdWVzdGVkIGJlZm9yZSBhIGNoZWNrIHBvaW50IHdhcyBldmVyIGNyZWF0ZWQgZm9yIHRoaXMgdG9rZW4sIGl0CiAgICAgICAgLy8gIHJlcXVpcmVzIHRoYXQgdGhlIGBwYXJlbnRUb2tlbi50b3RhbFN1cHBseUF0YCBiZSBxdWVyaWVkIGF0IHRoZQogICAgICAgIC8vICBnZW5lc2lzIGJsb2NrIGZvciB0aGlzIHRva2VuIGFzIHRoYXQgY29udGFpbnMgdG90YWxTdXBwbHkgb2YgdGhpcwogICAgICAgIC8vICB0b2tlbiBhdCB0aGlzIGJsb2NrIG51bWJlci4KICAgICAgICBpZiAoKHRvdGFsU3VwcGx5SGlzdG9yeS5sZW5ndGggPT0gMCkKICAgICAgICAgICAgfHwgKHRvdGFsU3VwcGx5SGlzdG9yeVswXS5mcm9tQmxvY2sgPiBfYmxvY2tOdW1iZXIpKSB7CiAgICAgICAgICAgIGlmIChhZGRyZXNzKHBhcmVudFRva2VuKSAhPSAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcGFyZW50VG9rZW4udG90YWxTdXBwbHlBdChtaW4oX2Jsb2NrTnVtYmVyLCBwYXJlbnRTbmFwU2hvdEJsb2NrKSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgICAgfQoKICAgICAgICAvLyBUaGlzIHdpbGwgcmV0dXJuIHRoZSBleHBlY3RlZCB0b3RhbFN1cHBseSBkdXJpbmcgbm9ybWFsIHNpdHVhdGlvbnMKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gZ2V0VmFsdWVBdCh0b3RhbFN1cHBseUhpc3RvcnksIF9ibG9ja051bWJlcik7CiAgICAgICAgfQogICAgfQoKLy8vLy8vLy8vLy8vLy8vLwovLyBDbG9uZSBUb2tlbiBNZXRob2QKLy8vLy8vLy8vLy8vLy8vLwoKICAgIC8vLyBAbm90aWNlIENyZWF0ZXMgYSBuZXcgY2xvbmUgdG9rZW4gd2l0aCB0aGUgaW5pdGlhbCBkaXN0cmlidXRpb24gYmVpbmcKICAgIC8vLyAgdGhpcyB0b2tlbiBhdCBgX3NuYXBzaG90QmxvY2tgCiAgICAvLy8gQHBhcmFtIF9jbG9uZVRva2VuTmFtZSBOYW1lIG9mIHRoZSBjbG9uZSB0b2tlbgogICAgLy8vIEBwYXJhbSBfY2xvbmVEZWNpbWFsVW5pdHMgTnVtYmVyIG9mIGRlY2ltYWxzIG9mIHRoZSBzbWFsbGVzdCB1bml0CiAgICAvLy8gQHBhcmFtIF9jbG9uZVRva2VuU3ltYm9sIFN5bWJvbCBvZiB0aGUgY2xvbmUgdG9rZW4KICAgIC8vLyBAcGFyYW0gX3NuYXBzaG90QmxvY2sgQmxvY2sgd2hlbiB0aGUgZGlzdHJpYnV0aW9uIG9mIHRoZSBwYXJlbnQgdG9rZW4gaXMKICAgIC8vLyAgY29waWVkIHRvIHNldCB0aGUgaW5pdGlhbCBkaXN0cmlidXRpb24gb2YgdGhlIG5ldyBjbG9uZSB0b2tlbjsKICAgIC8vLyAgaWYgdGhlIGJsb2NrIGlzIHplcm8gdGhhbiB0aGUgYWN0dWFsIGJsb2NrLCB0aGUgY3VycmVudCBibG9jayBpcyB1c2VkCiAgICAvLy8gQHBhcmFtIF90cmFuc2ZlcnNFbmFibGVkIFRydWUgaWYgdHJhbnNmZXJzIGFyZSBhbGxvd2VkIGluIHRoZSBjbG9uZQogICAgLy8vIEByZXR1cm4gVGhlIGFkZHJlc3Mgb2YgdGhlIG5ldyBNaW5pTWVUb2tlbiBDb250cmFjdAogICAgZnVuY3Rpb24gY3JlYXRlQ2xvbmVUb2tlbigKICAgICAgICBzdHJpbmcgX2Nsb25lVG9rZW5OYW1lLAogICAgICAgIHVpbnQ4IF9jbG9uZURlY2ltYWxVbml0cywKICAgICAgICBzdHJpbmcgX2Nsb25lVG9rZW5TeW1ib2wsCiAgICAgICAgdWludCBfc25hcHNob3RCbG9jaywKICAgICAgICBib29sIF90cmFuc2ZlcnNFbmFibGVkCiAgICAgICAgKSByZXR1cm5zKGFkZHJlc3MpIHsKICAgICAgICBpZiAoX3NuYXBzaG90QmxvY2sgPT0gMCkgX3NuYXBzaG90QmxvY2sgPSBibG9jay5udW1iZXI7CiAgICAgICAgTWluaU1lVG9rZW4gY2xvbmVUb2tlbiA9IHRva2VuRmFjdG9yeS5jcmVhdGVDbG9uZVRva2VuKAogICAgICAgICAgICB0aGlzLAogICAgICAgICAgICBfc25hcHNob3RCbG9jaywKICAgICAgICAgICAgX2Nsb25lVG9rZW5OYW1lLAogICAgICAgICAgICBfY2xvbmVEZWNpbWFsVW5pdHMsCiAgICAgICAgICAgIF9jbG9uZVRva2VuU3ltYm9sLAogICAgICAgICAgICBfdHJhbnNmZXJzRW5hYmxlZAogICAgICAgICAgICApOwoKICAgICAgICBjbG9uZVRva2VuLmNoYW5nZUNvbnRyb2xsZXIobXNnLnNlbmRlcik7CgogICAgICAgIC8vIEFuIGV2ZW50IHRvIG1ha2UgdGhlIHRva2VuIGVhc3kgdG8gZmluZCBvbiB0aGUgYmxvY2tjaGFpbgogICAgICAgIE5ld0Nsb25lVG9rZW4oYWRkcmVzcyhjbG9uZVRva2VuKSwgX3NuYXBzaG90QmxvY2spOwogICAgICAgIHJldHVybiBhZGRyZXNzKGNsb25lVG9rZW4pOwogICAgfQoKLy8vLy8vLy8vLy8vLy8vLwovLyBHZW5lcmF0ZSBhbmQgZGVzdHJveSB0b2tlbnMKLy8vLy8vLy8vLy8vLy8vLwoKICAgIC8vLyBAbm90aWNlIEdlbmVyYXRlcyBgX2Ftb3VudGAgdG9rZW5zIHRoYXQgYXJlIGFzc2lnbmVkIHRvIGBfb3duZXJgCiAgICAvLy8gQHBhcmFtIF9vd25lciBUaGUgYWRkcmVzcyB0aGF0IHdpbGwgYmUgYXNzaWduZWQgdGhlIG5ldyB0b2tlbnMKICAgIC8vLyBAcGFyYW0gX2Ftb3VudCBUaGUgcXVhbnRpdHkgb2YgdG9rZW5zIGdlbmVyYXRlZAogICAgLy8vIEByZXR1cm4gVHJ1ZSBpZiB0aGUgdG9rZW5zIGFyZSBnZW5lcmF0ZWQgY29ycmVjdGx5CiAgICBmdW5jdGlvbiBnZW5lcmF0ZVRva2VucyhhZGRyZXNzIF9vd25lciwgdWludCBfYW1vdW50CiAgICApIG9ubHlDb250cm9sbGVyIHJldHVybnMgKGJvb2wpIHsKICAgICAgICB1aW50IGN1clRvdGFsU3VwcGx5ID0gZ2V0VmFsdWVBdCh0b3RhbFN1cHBseUhpc3RvcnksIGJsb2NrLm51bWJlcik7CiAgICAgICAgdXBkYXRlVmFsdWVBdE5vdyh0b3RhbFN1cHBseUhpc3RvcnksIGN1clRvdGFsU3VwcGx5LmFkZChfYW1vdW50KSk7CiAgICAgICAgdmFyIHByZXZpb3VzQmFsYW5jZVRvID0gYmFsYW5jZU9mKF9vd25lcik7CiAgICAgICAgdXBkYXRlVmFsdWVBdE5vdyhiYWxhbmNlc1tfb3duZXJdLCBwcmV2aW91c0JhbGFuY2VUby5hZGQoX2Ftb3VudCkpOwogICAgICAgIFRyYW5zZmVyKDAsIF9vd25lciwgX2Ftb3VudCk7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgoKICAgIC8vLyBAbm90aWNlIEJ1cm5zIGBfYW1vdW50YCB0b2tlbnMgZnJvbSBgX293bmVyYAogICAgLy8vIEBwYXJhbSBfb3duZXIgVGhlIGFkZHJlc3MgdGhhdCB3aWxsIGxvc2UgdGhlIHRva2VucwogICAgLy8vIEBwYXJhbSBfYW1vdW50IFRoZSBxdWFudGl0eSBvZiB0b2tlbnMgdG8gYnVybgogICAgLy8vIEByZXR1cm4gVHJ1ZSBpZiB0aGUgdG9rZW5zIGFyZSBidXJuZWQgY29ycmVjdGx5CiAgICBmdW5jdGlvbiBkZXN0cm95VG9rZW5zKGFkZHJlc3MgX293bmVyLCB1aW50IF9hbW91bnQKICAgICkgb25seUNvbnRyb2xsZXIgcmV0dXJucyAoYm9vbCkgewogICAgICAgIHVpbnQgY3VyVG90YWxTdXBwbHkgPSBnZXRWYWx1ZUF0KHRvdGFsU3VwcGx5SGlzdG9yeSwgYmxvY2subnVtYmVyKTsKICAgICAgICBpZiAoY3VyVG90YWxTdXBwbHkgPCBfYW1vdW50KSB0aHJvdzsKICAgICAgICB1cGRhdGVWYWx1ZUF0Tm93KHRvdGFsU3VwcGx5SGlzdG9yeSwgY3VyVG90YWxTdXBwbHkuc3ViKF9hbW91bnQpKTsKICAgICAgICB2YXIgcHJldmlvdXNCYWxhbmNlRnJvbSA9IGJhbGFuY2VPZihfb3duZXIpOwogICAgICAgIGlmIChwcmV2aW91c0JhbGFuY2VGcm9tIDwgX2Ftb3VudCkgdGhyb3c7CiAgICAgICAgdXBkYXRlVmFsdWVBdE5vdyhiYWxhbmNlc1tfb3duZXJdLCBwcmV2aW91c0JhbGFuY2VGcm9tLnN1YihfYW1vdW50KSk7CiAgICAgICAgVHJhbnNmZXIoX293bmVyLCAwLCBfYW1vdW50KTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCi8vLy8vLy8vLy8vLy8vLy8KLy8gRW5hYmxlIHRva2VucyB0cmFuc2ZlcnMKLy8vLy8vLy8vLy8vLy8vLwoKCiAgICAvLy8gQG5vdGljZSBFbmFibGVzIHRva2VuIGhvbGRlcnMgdG8gdHJhbnNmZXIgdGhlaXIgdG9rZW5zIGZyZWVseSBpZiB0cnVlCiAgICAvLy8gQHBhcmFtIF90cmFuc2ZlcnNFbmFibGVkIFRydWUgaWYgdHJhbnNmZXJzIGFyZSBhbGxvd2VkIGluIHRoZSBjbG9uZQogICAgZnVuY3Rpb24gZW5hYmxlVHJhbnNmZXJzKGJvb2wgX3RyYW5zZmVyc0VuYWJsZWQpIG9ubHlDb250cm9sbGVyIHsKICAgICAgICB0cmFuc2ZlcnNFbmFibGVkID0gX3RyYW5zZmVyc0VuYWJsZWQ7CiAgICB9CgovLy8vLy8vLy8vLy8vLy8vCi8vIEludGVybmFsIGhlbHBlciBmdW5jdGlvbnMgdG8gcXVlcnkgYW5kIHNldCBhIHZhbHVlIGluIGEgc25hcHNob3QgYXJyYXkKLy8vLy8vLy8vLy8vLy8vLwoKICAgIC8vLyBAZGV2IGBnZXRWYWx1ZUF0YCByZXRyaWV2ZXMgdGhlIG51bWJlciBvZiB0b2tlbnMgYXQgYSBnaXZlbiBibG9jayBudW1iZXIKICAgIC8vLyBAcGFyYW0gY2hlY2twb2ludHMgVGhlIGhpc3Rvcnkgb2YgdmFsdWVzIGJlaW5nIHF1ZXJpZWQKICAgIC8vLyBAcGFyYW0gX2Jsb2NrIFRoZSBibG9jayBudW1iZXIgdG8gcmV0cmlldmUgdGhlIHZhbHVlIGF0CiAgICAvLy8gQHJldHVybiBUaGUgbnVtYmVyIG9mIHRva2VucyBiZWluZyBxdWVyaWVkCiAgICBmdW5jdGlvbiBnZXRWYWx1ZUF0KENoZWNrcG9pbnRbXSBzdG9yYWdlIGNoZWNrcG9pbnRzLCB1aW50IF9ibG9jawogICAgKSBjb25zdGFudCBpbnRlcm5hbCByZXR1cm5zICh1aW50KSB7CiAgICAgICAgaWYgKGNoZWNrcG9pbnRzLmxlbmd0aCA9PSAwKSByZXR1cm4gMDsKCiAgICAgICAgLy8gU2hvcnRjdXQgZm9yIHRoZSBhY3R1YWwgdmFsdWUKICAgICAgICBpZiAoX2Jsb2NrID49IGNoZWNrcG9pbnRzW2NoZWNrcG9pbnRzLmxlbmd0aC0xXS5mcm9tQmxvY2spCiAgICAgICAgICAgIHJldHVybiBjaGVja3BvaW50c1tjaGVja3BvaW50cy5sZW5ndGgtMV0udmFsdWU7CiAgICAgICAgaWYgKF9ibG9jayA8IGNoZWNrcG9pbnRzWzBdLmZyb21CbG9jaykgcmV0dXJuIDA7CgogICAgICAgIC8vIEJpbmFyeSBzZWFyY2ggb2YgdGhlIHZhbHVlIGluIHRoZSBhcnJheQogICAgICAgIHVpbnQgbWluID0gMDsKICAgICAgICB1aW50IG1heCA9IGNoZWNrcG9pbnRzLmxlbmd0aC0xOwogICAgICAgIHdoaWxlIChtYXggPiBtaW4pIHsKICAgICAgICAgICAgdWludCBtaWQgPSAobWF4ICsgbWluICsgMSkvIDI7CiAgICAgICAgICAgIGlmIChjaGVja3BvaW50c1ttaWRdLmZyb21CbG9jazw9X2Jsb2NrKSB7CiAgICAgICAgICAgICAgICBtaW4gPSBtaWQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBtYXggPSBtaWQtMTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gY2hlY2twb2ludHNbbWluXS52YWx1ZTsKICAgIH0KCiAgICAvLy8gQGRldiBgdXBkYXRlVmFsdWVBdE5vd2AgdXNlZCB0byB1cGRhdGUgdGhlIGBiYWxhbmNlc2AgbWFwIGFuZCB0aGUKICAgIC8vLyAgYHRvdGFsU3VwcGx5SGlzdG9yeWAKICAgIC8vLyBAcGFyYW0gY2hlY2twb2ludHMgVGhlIGhpc3Rvcnkgb2YgZGF0YSBiZWluZyB1cGRhdGVkCiAgICAvLy8gQHBhcmFtIF92YWx1ZSBUaGUgbmV3IG51bWJlciBvZiB0b2tlbnMKICAgIGZ1bmN0aW9uIHVwZGF0ZVZhbHVlQXROb3coQ2hlY2twb2ludFtdIHN0b3JhZ2UgY2hlY2twb2ludHMsIHVpbnQgX3ZhbHVlCiAgICApIGludGVybmFsICB7CiAgICAgICAgaWYgKChjaGVja3BvaW50cy5sZW5ndGggPT0gMCkKICAgICAgICB8fCAoY2hlY2twb2ludHNbY2hlY2twb2ludHMubGVuZ3RoIC0xXS5mcm9tQmxvY2sgPCBibG9jay5udW1iZXIpKSB7CiAgICAgICAgICAgICAgIENoZWNrcG9pbnQgbmV3Q2hlY2tQb2ludCA9IGNoZWNrcG9pbnRzWyBjaGVja3BvaW50cy5sZW5ndGgrKyBdOwogICAgICAgICAgICAgICBuZXdDaGVja1BvaW50LmZyb21CbG9jayA9ICB1aW50MTI4KGJsb2NrLm51bWJlcik7CiAgICAgICAgICAgICAgIG5ld0NoZWNrUG9pbnQudmFsdWUgPSB1aW50MTI4KF92YWx1ZSk7CiAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgQ2hlY2twb2ludCBvbGRDaGVja1BvaW50ID0gY2hlY2twb2ludHNbY2hlY2twb2ludHMubGVuZ3RoLTFdOwogICAgICAgICAgICAgICBvbGRDaGVja1BvaW50LnZhbHVlID0gdWludDEyOChfdmFsdWUpOwogICAgICAgICAgIH0KICAgIH0KCiAgICAvLy8gQGRldiBJbnRlcm5hbCBmdW5jdGlvbiB0byBkZXRlcm1pbmUgaWYgYW4gYWRkcmVzcyBpcyBhIGNvbnRyYWN0CiAgICAvLy8gQHBhcmFtIF9hZGRyIFRoZSBhZGRyZXNzIGJlaW5nIHF1ZXJpZWQKICAgIC8vLyBAcmV0dXJuIFRydWUgaWYgYF9hZGRyYCBpcyBhIGNvbnRyYWN0CiAgICBmdW5jdGlvbiBpc0NvbnRyYWN0KGFkZHJlc3MgX2FkZHIpIGNvbnN0YW50IGludGVybmFsIHJldHVybnMoYm9vbCkgewogICAgICAgIHVpbnQgc2l6ZTsKICAgICAgICBpZiAoX2FkZHIgPT0gMCkgcmV0dXJuIGZhbHNlOwogICAgICAgIGFzc2VtYmx5IHsKICAgICAgICAgICAgc2l6ZSA6PSBleHRjb2Rlc2l6ZShfYWRkcikKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHNpemU+MDsKICAgIH0KCiAgICAvLy8gQGRldiBIZWxwZXIgZnVuY3Rpb24gdG8gcmV0dXJuIGEgbWluIGJldHdlbiB0aGUgdHdvIHVpbnRzCiAgICBmdW5jdGlvbiBtaW4odWludCBhLCB1aW50IGIpIGludGVybmFsIHJldHVybnMgKHVpbnQpIHsKICAgICAgICByZXR1cm4gYSA8IGIgPyBhIDogYjsKICAgIH0KCiAgICAvLy8gQG5vdGljZSBUaGUgZmFsbGJhY2sgZnVuY3Rpb246IElmIHRoZSBjb250cmFjdCdzIGNvbnRyb2xsZXIgaGFzIG5vdCBiZWVuCiAgICAvLy8gIHNldCB0byAwLCB0aGVuIHRoZSBgcHJveHlQYXltZW50YCBtZXRob2QgaXMgY2FsbGVkIHdoaWNoIHJlbGF5cyB0aGUKICAgIC8vLyAgZXRoZXIgYW5kIGNyZWF0ZXMgdG9rZW5zIGFzIGRlc2NyaWJlZCBpbiB0aGUgdG9rZW4gY29udHJvbGxlciBjb250cmFjdAogICAgZnVuY3Rpb24gKCkgIHBheWFibGUgewogICAgICAgIGlmIChpc0NvbnRyYWN0KGNvbnRyb2xsZXIpKSB7CiAgICAgICAgICAgIGlmICghIFRva2VuQ29udHJvbGxlcihjb250cm9sbGVyKS5wcm94eVBheW1lbnQudmFsdWUobXNnLnZhbHVlKShtc2cuc2VuZGVyKSkKICAgICAgICAgICAgICAgIHRocm93OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRocm93OwogICAgICAgIH0KICAgIH0KCiAgICAvLy8vLy8vLy8vCiAgICAvLyBTYWZldHkgTWV0aG9kcwogICAgLy8vLy8vLy8vLwoKICAgIC8vLyBAbm90aWNlIFRoaXMgbWV0aG9kIGNhbiBiZSB1c2VkIGJ5IHRoZSBjb250cm9sbGVyIHRvIGV4dHJhY3QgbWlzdGFrZW5seQogICAgLy8vICBzZW50IHRva2VucyB0byB0aGlzIGNvbnRyYWN0LgogICAgLy8vIEBwYXJhbSBfdG9rZW4gVGhlIGFkZHJlc3Mgb2YgdGhlIHRva2VuIGNvbnRyYWN0IHRoYXQgeW91IHdhbnQgdG8gcmVjb3ZlcgogICAgLy8vICBzZXQgdG8gMCBpbiBjYXNlIHlvdSB3YW50IHRvIGV4dHJhY3QgZXRoZXIuCiAgICAvLy8gQHBhcmFtIF9jbGFpbWVyIEFkZHJlc3MgdGhhdCB0b2tlbnMgd2lsbCBiZSBzZW5kIHRvCiAgICBmdW5jdGlvbiBjbGFpbVRva2VucyhhZGRyZXNzIF90b2tlbiwgYWRkcmVzcyBfY2xhaW1lcikgb25seUNvbnRyb2xsZXIgewogICAgICAgIGlmIChfdG9rZW4gPT0gMHgwKSB7CiAgICAgICAgICAgIF9jbGFpbWVyLnRyYW5zZmVyKHRoaXMuYmFsYW5jZSk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIEVSQzIwQmFzaWMgdG9rZW4gPSBFUkMyMEJhc2ljKF90b2tlbik7CiAgICAgICAgdWludCBiYWxhbmNlID0gdG9rZW4uYmFsYW5jZU9mKHRoaXMpOwogICAgICAgIHRva2VuLnRyYW5zZmVyKF9jbGFpbWVyLCBiYWxhbmNlKTsKICAgICAgICBDbGFpbWVkVG9rZW5zKF90b2tlbiwgX2NsYWltZXIsIGJhbGFuY2UpOwogICAgfQoKCi8vLy8vLy8vLy8vLy8vLy8KLy8gRXZlbnRzCi8vLy8vLy8vLy8vLy8vLy8KICAgIGV2ZW50IENsYWltZWRUb2tlbnMoYWRkcmVzcyBpbmRleGVkIF90b2tlbiwgYWRkcmVzcyBpbmRleGVkIF9jbGFpbWVyLCB1aW50IF9hbW91bnQpOwogICAgZXZlbnQgVHJhbnNmZXIoYWRkcmVzcyBpbmRleGVkIF9mcm9tLCBhZGRyZXNzIGluZGV4ZWQgX3RvLCB1aW50MjU2IF9hbW91bnQpOwogICAgZXZlbnQgTmV3Q2xvbmVUb2tlbihhZGRyZXNzIGluZGV4ZWQgX2Nsb25lVG9rZW4sIHVpbnQgX3NuYXBzaG90QmxvY2spOwogICAgZXZlbnQgQXBwcm92YWwoCiAgICAgICAgYWRkcmVzcyBpbmRleGVkIF9vd25lciwKICAgICAgICBhZGRyZXNzIGluZGV4ZWQgX3NwZW5kZXIsCiAgICAgICAgdWludDI1NiBfYW1vdW50CiAgICAgICAgKTsKCn0KCgovLy8vLy8vLy8vLy8vLy8vCi8vIE1pbmlNZVRva2VuRmFjdG9yeQovLy8vLy8vLy8vLy8vLy8vCgovLy8gQGRldiBUaGlzIGNvbnRyYWN0IGlzIHVzZWQgdG8gZ2VuZXJhdGUgY2xvbmUgY29udHJhY3RzIGZyb20gYSBjb250cmFjdC4KLy8vICBJbiBzb2xpZGl0eSB0aGlzIGlzIHRoZSB3YXkgdG8gY3JlYXRlIGEgY29udHJhY3QgZnJvbSBhIGNvbnRyYWN0IG9mIHRoZQovLy8gIHNhbWUgY2xhc3MKY29udHJhY3QgTWluaU1lVG9rZW5GYWN0b3J5IHsKCiAgICAvLy8gQG5vdGljZSBVcGRhdGUgdGhlIERBcHAgYnkgY3JlYXRpbmcgYSBuZXcgdG9rZW4gd2l0aCBuZXcgZnVuY3Rpb25hbGl0aWVzCiAgICAvLy8gIHRoZSBtc2cuc2VuZGVyIGJlY29tZXMgdGhlIGNvbnRyb2xsZXIgb2YgdGhpcyBjbG9uZSB0b2tlbgogICAgLy8vIEBwYXJhbSBfcGFyZW50VG9rZW4gQWRkcmVzcyBvZiB0aGUgdG9rZW4gYmVpbmcgY2xvbmVkCiAgICAvLy8gQHBhcmFtIF9zbmFwc2hvdEJsb2NrIEJsb2NrIG9mIHRoZSBwYXJlbnQgdG9rZW4gdGhhdCB3aWxsCiAgICAvLy8gIGRldGVybWluZSB0aGUgaW5pdGlhbCBkaXN0cmlidXRpb24gb2YgdGhlIGNsb25lIHRva2VuCiAgICAvLy8gQHBhcmFtIF90b2tlbk5hbWUgTmFtZSBvZiB0aGUgbmV3IHRva2VuCiAgICAvLy8gQHBhcmFtIF9kZWNpbWFsVW5pdHMgTnVtYmVyIG9mIGRlY2ltYWxzIG9mIHRoZSBuZXcgdG9rZW4KICAgIC8vLyBAcGFyYW0gX3Rva2VuU3ltYm9sIFRva2VuIFN5bWJvbCBmb3IgdGhlIG5ldyB0b2tlbgogICAgLy8vIEBwYXJhbSBfdHJhbnNmZXJzRW5hYmxlZCBJZiB0cnVlLCB0b2tlbnMgd2lsbCBiZSBhYmxlIHRvIGJlIHRyYW5zZmVycmVkCiAgICAvLy8gQHJldHVybiBUaGUgYWRkcmVzcyBvZiB0aGUgbmV3IHRva2VuIGNvbnRyYWN0CiAgICBmdW5jdGlvbiBjcmVhdGVDbG9uZVRva2VuKAogICAgICAgIGFkZHJlc3MgX3BhcmVudFRva2VuLAogICAgICAgIHVpbnQgX3NuYXBzaG90QmxvY2ssCiAgICAgICAgc3RyaW5nIF90b2tlbk5hbWUsCiAgICAgICAgdWludDggX2RlY2ltYWxVbml0cywKICAgICAgICBzdHJpbmcgX3Rva2VuU3ltYm9sLAogICAgICAgIGJvb2wgX3RyYW5zZmVyc0VuYWJsZWQKICAgICkgcmV0dXJucyAoTWluaU1lVG9rZW4pIHsKICAgICAgICBNaW5pTWVUb2tlbiBuZXdUb2tlbiA9IG5ldyBNaW5pTWVUb2tlbigKICAgICAgICAgICAgdGhpcywKICAgICAgICAgICAgX3BhcmVudFRva2VuLAogICAgICAgICAgICBfc25hcHNob3RCbG9jaywKICAgICAgICAgICAgX3Rva2VuTmFtZSwKICAgICAgICAgICAgX2RlY2ltYWxVbml0cywKICAgICAgICAgICAgX3Rva2VuU3ltYm9sLAogICAgICAgICAgICBfdHJhbnNmZXJzRW5hYmxlZAogICAgICAgICAgICApOwoKICAgICAgICBuZXdUb2tlbi5jaGFuZ2VDb250cm9sbGVyKG1zZy5zZW5kZXIpOwogICAgICAgIHJldHVybiBuZXdUb2tlbjsKICAgIH0KfQoKY29udHJhY3QgVmVzdGVkVG9rZW4gaXMgTGltaXRlZFRyYW5zZmVyVG9rZW4sIEdyYW50c0NvbnRyb2xsZWQgewogIHVzaW5nIFNhZmVNYXRoIGZvciB1aW50OwoKICB1aW50MjU2IE1BWF9HUkFOVFNfUEVSX0FERFJFU1MgPSAyMDsKCiAgc3RydWN0IFRva2VuR3JhbnQgewogICAgYWRkcmVzcyBncmFudGVyOyAgICAgLy8gMjAgYnl0ZXMKICAgIHVpbnQyNTYgdmFsdWU7ICAgICAgIC8vIDMyIGJ5dGVzCiAgICB1aW50NjQgY2xpZmY7CiAgICB1aW50NjQgdmVzdGluZzsKICAgIHVpbnQ2NCBzdGFydDsgICAgICAgIC8vIDMgKiA4ID0gMjQgYnl0ZXMKICAgIGJvb2wgcmV2b2thYmxlOwogICAgYm9vbCBidXJuc09uUmV2b2tlOyAgLy8gMiAqIDEgPSAyIGJpdHM/IG9yIDIgYnl0ZXM/CiAgfSAvLyB0b3RhbCA3OCBieXRlcyA9IDMgc3N0b3JlIHBlciBvcGVyYXRpb24gKDMyIHBlciBzc3RvcmUpCgogIG1hcHBpbmcgKGFkZHJlc3MgPT4gVG9rZW5HcmFudFtdKSBwdWJsaWMgZ3JhbnRzOwoKICBldmVudCBOZXdUb2tlbkdyYW50KGFkZHJlc3MgaW5kZXhlZCBmcm9tLCBhZGRyZXNzIGluZGV4ZWQgdG8sIHVpbnQyNTYgdmFsdWUsIHVpbnQyNTYgZ3JhbnRJZCk7CgogIC8qKgogICAqIEBkZXYgR3JhbnQgdG9rZW5zIHRvIGEgc3BlY2lmaWVkIGFkZHJlc3MKICAgKiBAcGFyYW0gX3RvIGFkZHJlc3MgVGhlIGFkZHJlc3Mgd2hpY2ggdGhlIHRva2VucyB3aWxsIGJlIGdyYW50ZWQgdG8uCiAgICogQHBhcmFtIF92YWx1ZSB1aW50MjU2IFRoZSBhbW91bnQgb2YgdG9rZW5zIHRvIGJlIGdyYW50ZWQuCiAgICogQHBhcmFtIF9zdGFydCB1aW50NjQgVGltZSBvZiB0aGUgYmVnaW5uaW5nIG9mIHRoZSBncmFudC4KICAgKiBAcGFyYW0gX2NsaWZmIHVpbnQ2NCBUaW1lIG9mIHRoZSBjbGlmZiBwZXJpb2QuCiAgICogQHBhcmFtIF92ZXN0aW5nIHVpbnQ2NCBUaGUgdmVzdGluZyBwZXJpb2QuCiAgICovCiAgZnVuY3Rpb24gZ3JhbnRWZXN0ZWRUb2tlbnMoCiAgICBhZGRyZXNzIF90bywKICAgIHVpbnQyNTYgX3ZhbHVlLAogICAgdWludDY0IF9zdGFydCwKICAgIHVpbnQ2NCBfY2xpZmYsCiAgICB1aW50NjQgX3Zlc3RpbmcsCiAgICBib29sIF9yZXZva2FibGUsCiAgICBib29sIF9idXJuc09uUmV2b2tlCiAgKSBvbmx5R3JhbnRzQ29udHJvbGxlciBwdWJsaWMgewoKICAgIC8vIENoZWNrIGZvciBkYXRlIGluY29uc2lzdGVuY2llcyB0aGF0IG1heSBjYXVzZSB1bmV4cGVjdGVkIGJlaGF2aW9yCiAgICBpZiAoX2NsaWZmIDwgX3N0YXJ0IHx8IF92ZXN0aW5nIDwgX2NsaWZmKSB7CiAgICAgIHRocm93OwogICAgfQoKICAgIGlmICh0b2tlbkdyYW50c0NvdW50KF90bykgPiBNQVhfR1JBTlRTX1BFUl9BRERSRVNTKSB0aHJvdzsgICAvLyBUbyBwcmV2ZW50IGEgdXNlciBiZWluZyBzcGFtbWVkIGFuZCBoYXZlIGhpcyBiYWxhbmNlIGxvY2tlZCAob3V0IG9mIGdhcyBhdHRhY2sgd2hlbiBjYWxjdWxhdGluZyB2ZXN0aW5nKS4KCiAgICB1aW50IGNvdW50ID0gZ3JhbnRzW190b10ucHVzaCgKICAgICAgICAgICAgICAgIFRva2VuR3JhbnQoCiAgICAgICAgICAgICAgICAgIF9yZXZva2FibGUgPyBtc2cuc2VuZGVyIDogMCwgLy8gYXZvaWQgc3RvcmluZyBhbiBleHRyYSAyMCBieXRlcyB3aGVuIGl0IGlzIG5vbi1yZXZva2FibGUKICAgICAgICAgICAgICAgICAgX3ZhbHVlLAogICAgICAgICAgICAgICAgICBfY2xpZmYsCiAgICAgICAgICAgICAgICAgIF92ZXN0aW5nLAogICAgICAgICAgICAgICAgICBfc3RhcnQsCiAgICAgICAgICAgICAgICAgIF9yZXZva2FibGUsCiAgICAgICAgICAgICAgICAgIF9idXJuc09uUmV2b2tlCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgKTsKCiAgICB0cmFuc2ZlcihfdG8sIF92YWx1ZSk7CgogICAgTmV3VG9rZW5HcmFudChtc2cuc2VuZGVyLCBfdG8sIF92YWx1ZSwgY291bnQgLSAxKTsKICB9CgogIC8qKgogICAqIEBkZXYgUmV2b2tlIHRoZSBncmFudCBvZiB0b2tlbnMgb2YgYSBzcGVjaWZlZCBhZGRyZXNzLgogICAqIEBwYXJhbSBfaG9sZGVyIFRoZSBhZGRyZXNzIHdoaWNoIHdpbGwgaGF2ZSBpdHMgdG9rZW5zIHJldm9rZWQuCiAgICogQHBhcmFtIF9ncmFudElkIFRoZSBpZCBvZiB0aGUgdG9rZW4gZ3JhbnQuCiAgICovCiAgZnVuY3Rpb24gcmV2b2tlVG9rZW5HcmFudChhZGRyZXNzIF9ob2xkZXIsIHVpbnQgX2dyYW50SWQpIHB1YmxpYyB7CiAgICBUb2tlbkdyYW50IGdyYW50ID0gZ3JhbnRzW19ob2xkZXJdW19ncmFudElkXTsKCiAgICBpZiAoIWdyYW50LnJldm9rYWJsZSkgeyAvLyBDaGVjayBpZiBncmFudCB3YXMgcmV2b2thYmxlCiAgICAgIHRocm93OwogICAgfQoKICAgIGlmIChncmFudC5ncmFudGVyICE9IG1zZy5zZW5kZXIpIHsgLy8gT25seSBncmFudGVyIGNhbiByZXZva2UgaXQKICAgICAgdGhyb3c7CiAgICB9CgogICAgYWRkcmVzcyByZWNlaXZlciA9IGdyYW50LmJ1cm5zT25SZXZva2UgPyAweGRlYWQgOiBtc2cuc2VuZGVyOwoKICAgIHVpbnQyNTYgbm9uVmVzdGVkID0gbm9uVmVzdGVkVG9rZW5zKGdyYW50LCB1aW50NjQobm93KSk7CgogICAgLy8gcmVtb3ZlIGdyYW50IGZyb20gYXJyYXkKICAgIGRlbGV0ZSBncmFudHNbX2hvbGRlcl1bX2dyYW50SWRdOwogICAgZ3JhbnRzW19ob2xkZXJdW19ncmFudElkXSA9IGdyYW50c1tfaG9sZGVyXVtncmFudHNbX2hvbGRlcl0ubGVuZ3RoLnN1YigxKV07CiAgICBncmFudHNbX2hvbGRlcl0ubGVuZ3RoIC09IDE7CgogICAgLy8gVGhpcyB3aWxsIGNhbGwgTWluaU1lJ3MgZG9UcmFuc2ZlciBtZXRob2QsIHNvIHRva2VuIGlzIHRyYW5zZmVycmVkIGFjY29yZGluZyB0bwogICAgLy8gTWluaU1lIFRva2VuIGxvZ2ljCiAgICBkb1RyYW5zZmVyKF9ob2xkZXIsIHJlY2VpdmVyLCBub25WZXN0ZWQpOwoKICAgIFRyYW5zZmVyKF9ob2xkZXIsIHJlY2VpdmVyLCBub25WZXN0ZWQpOwogIH0KCiAgLyoqCiAgICogQGRldiBSZXZva2UgYWxsIGdyYW50cyBvZiB0b2tlbnMgb2YgYSBzcGVjaWZlZCBhZGRyZXNzLgogICAqIEBwYXJhbSBfaG9sZGVyIFRoZSBhZGRyZXNzIHdoaWNoIHdpbGwgaGF2ZSBpdHMgdG9rZW5zIHJldm9rZWQuCiAgICovCiAgICBmdW5jdGlvbiByZXZva2VBbGxUb2tlbkdyYW50cyhhZGRyZXNzIF9ob2xkZXIpIHsKICAgICAgICB2YXIgZ3JhbmRzQ291bnQgPSB0b2tlbkdyYW50c0NvdW50KF9ob2xkZXIpOwogICAgICAgIGZvciAodWludCBpID0gMDsgaSA8IGdyYW5kc0NvdW50OyBpKyspIHsKICAgICAgICAgIHJldm9rZVRva2VuR3JhbnQoX2hvbGRlciwgMCk7CiAgICAgICAgfQogICAgfQoKICAvKioKICAgKiBAZGV2IENhbGN1bGF0ZSB0aGUgdG90YWwgYW1vdW50IG9mIHRyYW5zZmVyYWJsZSB0b2tlbnMgb2YgYSBob2xkZXIgYXQgYSBnaXZlbiB0aW1lCiAgICogQHBhcmFtIGhvbGRlciBhZGRyZXNzIFRoZSBhZGRyZXNzIG9mIHRoZSBob2xkZXIKICAgKiBAcGFyYW0gdGltZSB1aW50NjQgVGhlIHNwZWNpZmljIHRpbWUuCiAgICogQHJldHVybiBBbiB1aW50IHJlcHJlc2VudGluZyBhIGhvbGRlcidzIHRvdGFsIGFtb3VudCBvZiB0cmFuc2ZlcmFibGUgdG9rZW5zLgogICAqLwogIGZ1bmN0aW9uIHRyYW5zZmVyYWJsZVRva2VucyhhZGRyZXNzIGhvbGRlciwgdWludDY0IHRpbWUpIGNvbnN0YW50IHB1YmxpYyByZXR1cm5zICh1aW50MjU2KSB7CiAgICB1aW50MjU2IGdyYW50SW5kZXggPSB0b2tlbkdyYW50c0NvdW50KGhvbGRlcik7CgogICAgaWYgKGdyYW50SW5kZXggPT0gMCkgcmV0dXJuIGJhbGFuY2VPZihob2xkZXIpOyAvLyBzaG9ydGN1dCBmb3IgaG9sZGVyIHdpdGhvdXQgZ3JhbnRzCgogICAgLy8gSXRlcmF0ZSB0aHJvdWdoIGFsbCB0aGUgZ3JhbnRzIHRoZSBob2xkZXIgaGFzLCBhbmQgYWRkIGFsbCBub24tdmVzdGVkIHRva2VucwogICAgdWludDI1NiBub25WZXN0ZWQgPSAwOwogICAgZm9yICh1aW50MjU2IGkgPSAwOyBpIDwgZ3JhbnRJbmRleDsgaSsrKSB7CiAgICAgIG5vblZlc3RlZCA9IFNhZmVNYXRoLmFkZChub25WZXN0ZWQsIG5vblZlc3RlZFRva2VucyhncmFudHNbaG9sZGVyXVtpXSwgdGltZSkpOwogICAgfQoKICAgIC8vIEJhbGFuY2UgLSB0b3RhbE5vblZlc3RlZCBpcyB0aGUgYW1vdW50IG9mIHRva2VucyBhIGhvbGRlciBjYW4gdHJhbnNmZXIgYXQgYW55IGdpdmVuIHRpbWUKICAgIHVpbnQyNTYgdmVzdGVkVHJhbnNmZXJhYmxlID0gU2FmZU1hdGguc3ViKGJhbGFuY2VPZihob2xkZXIpLCBub25WZXN0ZWQpOwoKICAgIC8vIFJldHVybiB0aGUgbWluaW11bSBvZiBob3cgbWFueSB2ZXN0ZWQgY2FuIHRyYW5zZmVyIGFuZCBvdGhlciB2YWx1ZQogICAgLy8gaW4gY2FzZSB0aGVyZSBhcmUgb3RoZXIgbGltaXRpbmcgdHJhbnNmZXJhYmlsaXR5IGZhY3RvcnMgKGRlZmF1bHQgaXMgYmFsYW5jZU9mKQogICAgcmV0dXJuIFNhZmVNYXRoLm1pbjI1Nih2ZXN0ZWRUcmFuc2ZlcmFibGUsIHN1cGVyLnRyYW5zZmVyYWJsZVRva2Vucyhob2xkZXIsIHRpbWUpKTsKICB9CgogIC8qKgogICAqIEBkZXYgQ2hlY2sgdGhlIGFtb3VudCBvZiBncmFudHMgdGhhdCBhbiBhZGRyZXNzIGhhcy4KICAgKiBAcGFyYW0gX2hvbGRlciBUaGUgaG9sZGVyIG9mIHRoZSBncmFudHMuCiAgICogQHJldHVybiBBIHVpbnQgcmVwcmVzZW50aW5nIHRoZSB0b3RhbCBhbW91bnQgb2YgZ3JhbnRzLgogICAqLwogIGZ1bmN0aW9uIHRva2VuR3JhbnRzQ291bnQoYWRkcmVzcyBfaG9sZGVyKSBjb25zdGFudCByZXR1cm5zICh1aW50IGluZGV4KSB7CiAgICByZXR1cm4gZ3JhbnRzW19ob2xkZXJdLmxlbmd0aDsKICB9CgogIC8qKgogICAqIEBkZXYgQ2FsY3VsYXRlIGFtb3VudCBvZiB2ZXN0ZWQgdG9rZW5zIGF0IGEgc3BlY2lmYyB0aW1lLgogICAqIEBwYXJhbSB0b2tlbnMgdWludDI1NiBUaGUgYW1vdW50IG9mIHRva2VucyBncmFudHRlZC4KICAgKiBAcGFyYW0gdGltZSB1aW50NjQgVGhlIHRpbWUgdG8gYmUgY2hlY2tlZAogICAqIEBwYXJhbSBzdGFydCB1aW50NjQgQSB0aW1lIHJlcHJlc2VudGluZyB0aGUgYmVnaW5pbmcgb2YgdGhlIGdyYW50CiAgICogQHBhcmFtIGNsaWZmIHVpbnQ2NCBUaGUgY2xpZmYgcGVyaW9kLgogICAqIEBwYXJhbSB2ZXN0aW5nIHVpbnQ2NCBUaGUgdmVzdGluZyBwZXJpb2QuCiAgICogQHJldHVybiBBbiB1aW50IHJlcHJlc2VudGluZyB0aGUgYW1vdW50IG9mIHZlc3RlZCB0b2tlbnNvZiBhIHNwZWNpZiBncmFudC4KICAgKiAgdHJhbnNmZXJhYmxlVG9rZW5zCiAgICogICB8ICAgICAgICAgICAgICAgICAgICAgICAgIF8vLS0tLS0tLS0gICB2ZXN0ZWRUb2tlbnMgcmVjdAogICAqICAgfCAgICAgICAgICAgICAgICAgICAgICAgXy8KICAgKiAgIHwgICAgICAgICAgICAgICAgICAgICBfLwogICAqICAgfCAgICAgICAgICAgICAgICAgICBfLwogICAqICAgfCAgICAgICAgICAgICAgICAgXy8KICAgKiAgIHwgICAgICAgICAgICAgICAgLwogICAqICAgfCAgICAgICAgICAgICAgLnwKICAgKiAgIHwgICAgICAgICAgICAuICB8CiAgICogICB8ICAgICAgICAgIC4gICAgfAogICAqICAgfCAgICAgICAgLiAgICAgIHwKICAgKiAgIHwgICAgICAuICAgICAgICB8CiAgICogICB8ICAgIC4gICAgICAgICAgfAogICAqICAgKz09PSs9PT09PT09PT09PSstLS0tLS0tLS0rLS0tLS0tLS0tLT4gdGltZQogICAqICAgICAgU3RhcnQgICAgICAgQ2xpZnQgICAgVmVzdGluZwogICAqLwogIGZ1bmN0aW9uIGNhbGN1bGF0ZVZlc3RlZFRva2VucygKICAgIHVpbnQyNTYgdG9rZW5zLAogICAgdWludDI1NiB0aW1lLAogICAgdWludDI1NiBzdGFydCwKICAgIHVpbnQyNTYgY2xpZmYsCiAgICB1aW50MjU2IHZlc3RpbmcpIGNvbnN0YW50IHJldHVybnMgKHVpbnQyNTYpCiAgICB7CiAgICAgIC8vIFNob3J0Y3V0cyBmb3IgYmVmb3JlIGNsaWZmIGFuZCBhZnRlciB2ZXN0aW5nIGNhc2VzLgogICAgICBpZiAodGltZSA8IGNsaWZmKSByZXR1cm4gMDsKICAgICAgaWYgKHRpbWUgPj0gdmVzdGluZykgcmV0dXJuIHRva2VuczsKCiAgICAgIC8vIEludGVycG9sYXRlIGFsbCB2ZXN0ZWQgdG9rZW5zLgogICAgICAvLyBBcyBiZWZvcmUgY2xpZmYgdGhlIHNob3J0Y3V0IHJldHVybnMgMCwgd2UgY2FuIHVzZSBqdXN0IGNhbGN1bGF0ZSBhIHZhbHVlCiAgICAgIC8vIGluIHRoZSB2ZXN0aW5nIHJlY3QgKGFzIHNob3duIGluIGFib3ZlJ3MgZmlndXJlKQoKICAgICAgLy8gdmVzdGVkVG9rZW5zID0gdG9rZW5zICogKHRpbWUgLSBzdGFydCkgLyAodmVzdGluZyAtIHN0YXJ0KQogICAgICB1aW50MjU2IHZlc3RlZFRva2VucyA9IFNhZmVNYXRoLmRpdigKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgU2FmZU1hdGgubXVsKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRva2VucywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBTYWZlTWF0aC5zdWIodGltZSwgc3RhcnQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgU2FmZU1hdGguc3ViKHZlc3RpbmcsIHN0YXJ0KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApOwoKICAgICAgcmV0dXJuIHZlc3RlZFRva2VuczsKICB9CgogIC8qKgogICAqIEBkZXYgR2V0IGFsbCBpbmZvcm1hdGlvbiBhYm91dCBhIHNwZWNpZmMgZ3JhbnQuCiAgICogQHBhcmFtIF9ob2xkZXIgVGhlIGFkZHJlc3Mgd2hpY2ggd2lsbCBoYXZlIGl0cyB0b2tlbnMgcmV2b2tlZC4KICAgKiBAcGFyYW0gX2dyYW50SWQgVGhlIGlkIG9mIHRoZSB0b2tlbiBncmFudC4KICAgKiBAcmV0dXJuIFJldHVybnMgYWxsIHRoZSB2YWx1ZXMgdGhhdCByZXByZXNlbnQgYSBUb2tlbkdyYW50KGFkZHJlc3MsIHZhbHVlLCBzdGFydCwgY2xpZmYsCiAgICogcmV2b2thYmlsaXR5LCBidXJuc09uUmV2b2tlLCBhbmQgdmVzdGluZykgcGx1cyB0aGUgdmVzdGVkIHZhbHVlIGF0IHRoZSBjdXJyZW50IHRpbWUuCiAgICovCiAgZnVuY3Rpb24gdG9rZW5HcmFudChhZGRyZXNzIF9ob2xkZXIsIHVpbnQgX2dyYW50SWQpIGNvbnN0YW50IHJldHVybnMgKGFkZHJlc3MgZ3JhbnRlciwgdWludDI1NiB2YWx1ZSwgdWludDI1NiB2ZXN0ZWQsIHVpbnQ2NCBzdGFydCwgdWludDY0IGNsaWZmLCB1aW50NjQgdmVzdGluZywgYm9vbCByZXZva2FibGUsIGJvb2wgYnVybnNPblJldm9rZSkgewogICAgVG9rZW5HcmFudCBncmFudCA9IGdyYW50c1tfaG9sZGVyXVtfZ3JhbnRJZF07CgogICAgZ3JhbnRlciA9IGdyYW50LmdyYW50ZXI7CiAgICB2YWx1ZSA9IGdyYW50LnZhbHVlOwogICAgc3RhcnQgPSBncmFudC5zdGFydDsKICAgIGNsaWZmID0gZ3JhbnQuY2xpZmY7CiAgICB2ZXN0aW5nID0gZ3JhbnQudmVzdGluZzsKICAgIHJldm9rYWJsZSA9IGdyYW50LnJldm9rYWJsZTsKICAgIGJ1cm5zT25SZXZva2UgPSBncmFudC5idXJuc09uUmV2b2tlOwoKICAgIHZlc3RlZCA9IHZlc3RlZFRva2VucyhncmFudCwgdWludDY0KG5vdykpOwogIH0KCiAgLyoqCiAgICogQGRldiBHZXQgdGhlIGFtb3VudCBvZiB2ZXN0ZWQgdG9rZW5zIGF0IGEgc3BlY2lmaWMgdGltZS4KICAgKiBAcGFyYW0gZ3JhbnQgVG9rZW5HcmFudCBUaGUgZ3JhbnQgdG8gYmUgY2hlY2tlZC4KICAgKiBAcGFyYW0gdGltZSBUaGUgdGltZSB0byBiZSBjaGVja2VkCiAgICogQHJldHVybiBBbiB1aW50IHJlcHJlc2VudGluZyB0aGUgYW1vdW50IG9mIHZlc3RlZCB0b2tlbnMgb2YgYSBzcGVjaWZpYyBncmFudCBhdCBhIHNwZWNpZmljIHRpbWUuCiAgICovCiAgZnVuY3Rpb24gdmVzdGVkVG9rZW5zKFRva2VuR3JhbnQgZ3JhbnQsIHVpbnQ2NCB0aW1lKSBwcml2YXRlIGNvbnN0YW50IHJldHVybnMgKHVpbnQyNTYpIHsKICAgIHJldHVybiBjYWxjdWxhdGVWZXN0ZWRUb2tlbnMoCiAgICAgIGdyYW50LnZhbHVlLAogICAgICB1aW50MjU2KHRpbWUpLAogICAgICB1aW50MjU2KGdyYW50LnN0YXJ0KSwKICAgICAgdWludDI1NihncmFudC5jbGlmZiksCiAgICAgIHVpbnQyNTYoZ3JhbnQudmVzdGluZykKICAgICk7CiAgfQoKICAvKioKICAgKiBAZGV2IENhbGN1bGF0ZSB0aGUgYW1vdW50IG9mIG5vbiB2ZXN0ZWQgdG9rZW5zIGF0IGEgc3BlY2lmaWMgdGltZS4KICAgKiBAcGFyYW0gZ3JhbnQgVG9rZW5HcmFudCBUaGUgZ3JhbnQgdG8gYmUgY2hlY2tlZC4KICAgKiBAcGFyYW0gdGltZSB1aW50NjQgVGhlIHRpbWUgdG8gYmUgY2hlY2tlZAogICAqIEByZXR1cm4gQW4gdWludCByZXByZXNlbnRpbmcgdGhlIGFtb3VudCBvZiBub24gdmVzdGVkIHRva2VucyBvZiBhIHNwZWNpZmMgZ3JhbnQgb24gdGhlCiAgICogcGFzc2VkIHRpbWUgZnJhbWUuCiAgICovCiAgZnVuY3Rpb24gbm9uVmVzdGVkVG9rZW5zKFRva2VuR3JhbnQgZ3JhbnQsIHVpbnQ2NCB0aW1lKSBwcml2YXRlIGNvbnN0YW50IHJldHVybnMgKHVpbnQyNTYpIHsKICAgIHJldHVybiBncmFudC52YWx1ZS5zdWIodmVzdGVkVG9rZW5zKGdyYW50LCB0aW1lKSk7CiAgfQoKICAvKioKICAgKiBAZGV2IENhbGN1bGF0ZSB0aGUgZGF0ZSB3aGVuIHRoZSBob2xkZXIgY2FuIHRyYXNmZXIgYWxsIGl0cyB0b2tlbnMKICAgKiBAcGFyYW0gaG9sZGVyIGFkZHJlc3MgVGhlIGFkZHJlc3Mgb2YgdGhlIGhvbGRlcgogICAqIEByZXR1cm4gQW4gdWludCByZXByZXNlbnRpbmcgdGhlIGRhdGUgb2YgdGhlIGxhc3QgdHJhbnNmZXJhYmxlIHRva2Vucy4KICAgKi8KICBmdW5jdGlvbiBsYXN0VG9rZW5Jc1RyYW5zZmVyYWJsZURhdGUoYWRkcmVzcyBob2xkZXIpIGNvbnN0YW50IHB1YmxpYyByZXR1cm5zICh1aW50NjQgZGF0ZSkgewogICAgZGF0ZSA9IHVpbnQ2NChub3cpOwogICAgdWludDI1NiBncmFudEluZGV4ID0gZ3JhbnRzW2hvbGRlcl0ubGVuZ3RoOwogICAgZm9yICh1aW50MjU2IGkgPSAwOyBpIDwgZ3JhbnRJbmRleDsgaSsrKSB7CiAgICAgIGRhdGUgPSBTYWZlTWF0aC5tYXg2NChncmFudHNbaG9sZGVyXVtpXS52ZXN0aW5nLCBkYXRlKTsKICAgIH0KICB9Cn0KCmNvbnRyYWN0IEFwcHJvdmVBbmRDYWxsRmFsbEJhY2sgewogICAgZnVuY3Rpb24gcmVjZWl2ZUFwcHJvdmFsKGFkZHJlc3MgZnJvbSwgdWludDI1NiBfYW1vdW50LCBhZGRyZXNzIF90b2tlbiwgYnl0ZXMgX2RhdGEpOwp9CgoKY29udHJhY3QgVG9rZW5Db250cm9sbGVyIHsKICAgIC8vLyBAbm90aWNlIENhbGxlZCB3aGVuIGBfb3duZXJgIHNlbmRzIGV0aGVyIHRvIHRoZSBNaW5pTWUgVG9rZW4gY29udHJhY3QKICAgIC8vLyBAcGFyYW0gX293bmVyIFRoZSBhZGRyZXNzIHRoYXQgc2VudCB0aGUgZXRoZXIgdG8gY3JlYXRlIHRva2VucwogICAgLy8vIEByZXR1cm4gVHJ1ZSBpZiB0aGUgZXRoZXIgaXMgYWNjZXB0ZWQsIGZhbHNlIGlmIGl0IHRocm93cwogICAgZnVuY3Rpb24gcHJveHlQYXltZW50KGFkZHJlc3MgX293bmVyKSBwYXlhYmxlIHJldHVybnMoYm9vbCk7CgogICAgLy8vIEBub3RpY2UgTm90aWZpZXMgdGhlIGNvbnRyb2xsZXIgYWJvdXQgYSB0b2tlbiB0cmFuc2ZlciBhbGxvd2luZyB0aGUKICAgIC8vLyAgY29udHJvbGxlciB0byByZWFjdCBpZiBkZXNpcmVkCiAgICAvLy8gQHBhcmFtIF9mcm9tIFRoZSBvcmlnaW4gb2YgdGhlIHRyYW5zZmVyCiAgICAvLy8gQHBhcmFtIF90byBUaGUgZGVzdGluYXRpb24gb2YgdGhlIHRyYW5zZmVyCiAgICAvLy8gQHBhcmFtIF9hbW91bnQgVGhlIGFtb3VudCBvZiB0aGUgdHJhbnNmZXIKICAgIC8vLyBAcmV0dXJuIEZhbHNlIGlmIHRoZSBjb250cm9sbGVyIGRvZXMgbm90IGF1dGhvcml6ZSB0aGUgdHJhbnNmZXIKICAgIGZ1bmN0aW9uIG9uVHJhbnNmZXIoYWRkcmVzcyBfZnJvbSwgYWRkcmVzcyBfdG8sIHVpbnQgX2Ftb3VudCkgcmV0dXJucyhib29sKTsKCiAgICAvLy8gQG5vdGljZSBOb3RpZmllcyB0aGUgY29udHJvbGxlciBhYm91dCBhbiBhcHByb3ZhbCBhbGxvd2luZyB0aGUKICAgIC8vLyAgY29udHJvbGxlciB0byByZWFjdCBpZiBkZXNpcmVkCiAgICAvLy8gQHBhcmFtIF9vd25lciBUaGUgYWRkcmVzcyB0aGF0IGNhbGxzIGBhcHByb3ZlKClgCiAgICAvLy8gQHBhcmFtIF9zcGVuZGVyIFRoZSBzcGVuZGVyIGluIHRoZSBgYXBwcm92ZSgpYCBjYWxsCiAgICAvLy8gQHBhcmFtIF9hbW91bnQgVGhlIGFtb3VudCBpbiB0aGUgYGFwcHJvdmUoKWAgY2FsbAogICAgLy8vIEByZXR1cm4gRmFsc2UgaWYgdGhlIGNvbnRyb2xsZXIgZG9lcyBub3QgYXV0aG9yaXplIHRoZSBhcHByb3ZhbAogICAgZnVuY3Rpb24gb25BcHByb3ZlKGFkZHJlc3MgX293bmVyLCBhZGRyZXNzIF9zcGVuZGVyLCB1aW50IF9hbW91bnQpCiAgICAgICAgcmV0dXJucyhib29sKTsKfQoKY29udHJhY3QgRGlzdHJpY3QweE5ldHdvcmtUb2tlbiBpcyBNaW5pTWVUb2tlbiwgVmVzdGVkVG9rZW4gewogICAgZnVuY3Rpb24gRGlzdHJpY3QweE5ldHdvcmtUb2tlbihhZGRyZXNzIF9jb250cm9sbGVyLCBhZGRyZXNzIF90b2tlbkZhY3RvcnkpCiAgICAgICAgTWluaU1lVG9rZW4oCiAgICAgICAgICAgIF90b2tlbkZhY3RvcnksCiAgICAgICAgICAgIDB4MCwgICAgICAgICAgICAgICAgICAgICAgICAvLyBubyBwYXJlbnQgdG9rZW4KICAgICAgICAgICAgMCwgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIG5vIHNuYXBzaG90IGJsb2NrIG51bWJlciBmcm9tIHBhcmVudAogICAgICAgICAgICAiZGlzdHJpY3QweCBOZXR3b3JrIFRva2VuIiwgLy8gVG9rZW4gbmFtZQogICAgICAgICAgICAxOCwgICAgICAgICAgICAgICAgICAgICAgICAgLy8gRGVjaW1hbHMKICAgICAgICAgICAgIkROVCIsICAgICAgICAgICAgICAgICAgICAgIC8vIFN5bWJvbAogICAgICAgICAgICB0cnVlICAgICAgICAgICAgICAgICAgICAgICAgLy8gRW5hYmxlIHRyYW5zZmVycwogICAgICAgICAgICApCiAgICB7CiAgICAgICAgY2hhbmdlQ29udHJvbGxlcihfY29udHJvbGxlcik7CiAgICAgICAgY2hhbmdlR3JhbnRzQ29udHJvbGxlcihfY29udHJvbGxlcik7CiAgICB9Cn0KCmNvbnRyYWN0IEhhc05vVG9rZW5zIGlzIE93bmFibGUgewoKICBEaXN0cmljdDB4TmV0d29ya1Rva2VuIHB1YmxpYyBkaXN0cmljdDB4TmV0d29ya1Rva2VuOwoKIC8qKgogICogQGRldiBSZWplY3QgYWxsIEVSQzIzIGNvbXBhdGlibGUgdG9rZW5zCiAgKiBAcGFyYW0gZnJvbV8gYWRkcmVzcyBUaGUgYWRkcmVzcyB0aGF0IGlzIHRyYW5zZmVycmluZyB0aGUgdG9rZW5zCiAgKiBAcGFyYW0gdmFsdWVfIHVpbnQyNTYgdGhlIGFtb3VudCBvZiB0aGUgc3BlY2lmaWVkIHRva2VuCiAgKiBAcGFyYW0gZGF0YV8gQnl0ZXMgVGhlIGRhdGEgcGFzc2VkIGZyb20gdGhlIGNhbGxlci4KICAqLwogIGZ1bmN0aW9uIHRva2VuRmFsbGJhY2soYWRkcmVzcyBmcm9tXywgdWludDI1NiB2YWx1ZV8sIGJ5dGVzIGRhdGFfKSBleHRlcm5hbCB7CiAgICB0aHJvdzsKICB9CgogIGZ1bmN0aW9uIGlzVG9rZW5TYWxlVG9rZW4oYWRkcmVzcyB0b2tlbkFkZHIpIHJldHVybnMoYm9vbCk7CgogIC8qKgogICAqIEBkZXYgUmVjbGFpbSBhbGwgRVJDMjBCYXNpYyBjb21wYXRpYmxlIHRva2VucwogICAqIEBwYXJhbSB0b2tlbkFkZHIgYWRkcmVzcyBUaGUgYWRkcmVzcyBvZiB0aGUgdG9rZW4gY29udHJhY3QKICAgKi8KICBmdW5jdGlvbiByZWNsYWltVG9rZW4oYWRkcmVzcyB0b2tlbkFkZHIpIGV4dGVybmFsIG9ubHlPd25lciB7CiAgICByZXF1aXJlKCFpc1Rva2VuU2FsZVRva2VuKHRva2VuQWRkcikpOwogICAgRVJDMjBCYXNpYyB0b2tlbkluc3QgPSBFUkMyMEJhc2ljKHRva2VuQWRkcik7CiAgICB1aW50MjU2IGJhbGFuY2UgPSB0b2tlbkluc3QuYmFsYW5jZU9mKHRoaXMpOwogICAgdG9rZW5JbnN0LnRyYW5zZmVyKG1zZy5zZW5kZXIsIGJhbGFuY2UpOwogIH0KfQoKCmNvbnRyYWN0IERpc3RyaWN0MHhDb250cmlidXRpb24gaXMgUGF1c2FibGUsIEhhc05vVG9rZW5zLCBUb2tlbkNvbnRyb2xsZXIgewogICAgdXNpbmcgU2FmZU1hdGggZm9yIHVpbnQ7CgogICAgRGlzdHJpY3QweE5ldHdvcmtUb2tlbiBwdWJsaWMgZGlzdHJpY3QweE5ldHdvcmtUb2tlbjsKICAgIGFkZHJlc3MgcHVibGljIG11bHRpc2lnV2FsbGV0OyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gV2FsbGV0IHRoYXQgcmVjZWl2ZXMgYWxsIHNhbGUgZnVuZHMKICAgIGFkZHJlc3MgcHVibGljIGZvdW5kZXIxOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gV2FsbGV0IG9mIGZvdW5kZXIgMQogICAgYWRkcmVzcyBwdWJsaWMgZm91bmRlcjI7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBXYWxsZXQgb2YgZm91bmRlciAyCiAgICBhZGRyZXNzIHB1YmxpYyBlYXJseVNwb25zb3I7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFdhbGxldCBvZiBlYXJseSBzcG9uc29yCiAgICBhZGRyZXNzW10gcHVibGljIGFkdmlzZXJzOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIDQgV2FsbGV0cyBvZiBhZHZpc29ycwoKICAgIHVpbnQgcHVibGljIGNvbnN0YW50IEZPVU5ERVIxX1NUQUtFID0gMTE5MDAwMDAwIGV0aGVyOyAgICAgICAgICAgICAgLy8gMTE5TSBETlQKICAgIHVpbnQgcHVibGljIGNvbnN0YW50IEZPVU5ERVIyX1NUQUtFID0gNzkwMDAwMDAgZXRoZXI7ICAgICAgICAgICAgICAgLy8gNzlNICBETlQKICAgIHVpbnQgcHVibGljIGNvbnN0YW50IEVBUkxZX0NPTlRSSUJVVE9SX1NUQUtFID0gNTAwMDAwMCBldGhlcjsgICAgICAgLy8gNU0gICBETlQKICAgIHVpbnQgcHVibGljIGNvbnN0YW50IEFEVklTRVJfU1RBS0UgPSA1MDAwMDAwIGV0aGVyOyAgICAgICAgICAgICAgICAgLy8gNU0gICBETlQKICAgIHVpbnQgcHVibGljIGNvbnN0YW50IEFEVklTRVJfU1RBS0UyID0gMTAwMDAwMCBldGhlcjsgICAgICAgICAgICAgICAgLy8gMU0gICBETlQKICAgIHVpbnQgcHVibGljIGNvbnN0YW50IENPTU1VTklUWV9BRFZJU0VSU19TVEFLRSA9IDUwMDAwMDAgZXRoZXI7ICAgICAgLy8gNU0gICBETlQKICAgIHVpbnQgcHVibGljIGNvbnN0YW50IENPTlRSSUJfUEVSSU9EMV9TVEFLRSA9IDYwMDAwMDAwMCBldGhlcjsgICAgICAgLy8gNjAwTSBETlQKICAgIHVpbnQgcHVibGljIGNvbnN0YW50IENPTlRSSUJfUEVSSU9EMl9TVEFLRSA9IDE0MDAwMDAwMCBldGhlcjsgICAgICAgLy8gMTQwTSBETlQKICAgIHVpbnQgcHVibGljIGNvbnN0YW50IENPTlRSSUJfUEVSSU9EM19TVEFLRSA9IDQwMDAwMDAwIGV0aGVyOyAgICAgICAgLy8gNDBNICBETlQKCiAgICB1aW50IHB1YmxpYyBtaW5Db250cmliQW1vdW50ID0gMC4wMSBldGhlcjsgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIDAuMDEgZXRoZXIKICAgIHVpbnQgcHVibGljIG1heEdhc1ByaWNlID0gNTAwMDAwMDAwMDA7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gNTAgR1dlaQoKICAgIHVpbnQgcHVibGljIGNvbnN0YW50IFRFQU1fVkVTVElOR19DTElGRiA9IDI0IHdlZWtzOyAgICAgICAgICAgICAgICAgLy8gNiBtb250aHMgdmVzdGluZyBjbGlmZiBmb3IgZm91bmRlcnMgYW5kIGFkdmlzb3JzLCBleGNlcHQgY29tbXVuaXR5IGFkdmlzb3JzCiAgICB1aW50IHB1YmxpYyBjb25zdGFudCBURUFNX1ZFU1RJTkdfUEVSSU9EID0gOTYgd2Vla3M7ICAgICAgICAgICAgICAgIC8vIDIgeWVhcnMgdmVzdGluZyBwZXJpb2QgZm9yIGZvdW5kZXJzIGFuZCBhZHZpc29ycywgZXhjZXB0IGNvbW11bml0eSBhZHZpc29ycwoKICAgIHVpbnQgcHVibGljIGNvbnN0YW50IEVBUkxZX0NPTlRSSUJVVE9SX1ZFU1RJTkdfQ0xJRkYgPSAxMiB3ZWVrczsgICAgLy8gMyBtb250aHMgdmVzdGluZyBjbGlmZiBmb3IgZWFybHkgc3BvbnNvcgogICAgdWludCBwdWJsaWMgY29uc3RhbnQgRUFSTFlfQ09OVFJJQlVUT1JfVkVTVElOR19QRVJJT0QgPSAyNCB3ZWVrczsgICAvLyA2IG1vbnRocyB2ZXN0aW5nIGNsaWZmIGZvciBlYXJseSBzcG9uc29yCgogICAgYm9vbCBwdWJsaWMgdG9rZW5UcmFuc2ZlcnNFbmFibGVkID0gZmFsc2U7ICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBETlQgdG9rZW4gdHJhbnNmZXJzIHdpbGwgYmUgZW5hYmxlZCBtYW51YWxseQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBhZnRlciBmaXJzdCBjb250cmlidXRpb24gcGVyaW9kCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIENhbid0IGJlIGRpc2FibGVkIGJhY2sKICAgIHN0cnVjdCBDb250cmlidXRvciB7CiAgICAgICAgdWludCBhbW91bnQ7ICAgICAgICAgICAgICAgICAgICAgICAgLy8gQW1vdW50IG9mIEVUSCBjb250cmlidXRlZCBieSBhbiBhZGRyZXNzIGluIGdpdmVuIGNvbnRyaWJ1dGlvbiBwZXJpb2QKICAgICAgICBib29sIGlzQ29tcGVuc2F0ZWQ7ICAgICAgICAgICAgICAgICAvLyBXaGV0aGVyIHRoaXMgY29udHJpYnV0b3IgcmVjZWl2ZWQgRE5UIHRva2VuIGZvciBFVEggY29udHJpYnV0aW9uCiAgICAgICAgdWludCBhbW91bnRDb21wZW5zYXRlZDsgICAgICAgICAgICAgLy8gQW1vdW50IG9mIEROVCByZWNlaXZlZC4gTm90IHJlYWxseSBuZWVkZWQgdG8gc3RvcmUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gYnV0IHN0b3JlZCBmb3IgYWNjb3VudGluZyBhbmQgc2VjdXJpdHkgcHVycG9zZXMKICAgIH0KCiAgICB1aW50IHB1YmxpYyBzb2Z0Q2FwQW1vdW50OyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNvZnQgY2FwIG9mIGNvbnRyaWJ1dGlvbiBwZXJpb2QgaW4gd2VpCiAgICB1aW50IHB1YmxpYyBhZnRlclNvZnRDYXBEdXJhdGlvbjsgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIE51bWJlciBvZiBzZWNvbmRzIHRvIHRoZSBlbmQgb2Ygc2FsZSBmcm9tIHRoZSBtb21lbnQgb2YgcmVhY2hpbmcgc29mdCBjYXAgKHVubGVzcyByZWFjaGluZyBoYXJkY2FwKQogICAgdWludCBwdWJsaWMgaGFyZENhcEFtb3VudDsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBXaGVuIHJlYWNoZWQgdGhpcyBhbW91bnQgb2Ygd2VpLCB0aGUgY29udHJpYnV0aW9uIHdpbGwgZW5kIGluc3RhbnRseQogICAgdWludCBwdWJsaWMgc3RhcnRUaW1lOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBTdGFydCB0aW1lIG9mIGNvbnRyaWJ1dGlvbiBwZXJpb2QgaW4gVU5JWCB0aW1lCiAgICB1aW50IHB1YmxpYyBlbmRUaW1lOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEVuZCB0aW1lIG9mIGNvbnRyaWJ1dGlvbiBwZXJpb2QgaW4gVU5JWCB0aW1lCiAgICBib29sIHB1YmxpYyBpc0VuYWJsZWQ7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIElmIGNvbnRyaWJ1dGlvbiBwZXJpb2Qgd2FzIGVuYWJsZWQgYnkgbXVsdGlzaWduYXR1cmUKICAgIGJvb2wgcHVibGljIHNvZnRDYXBSZWFjaGVkOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gSWYgc29mdCBjYXAgd2FzIHJlYWNoZWQKICAgIGJvb2wgcHVibGljIGhhcmRDYXBSZWFjaGVkOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gSWYgaGFyZCBjYXAgd2FzIHJlYWNoZWQKICAgIHVpbnQgcHVibGljIHRvdGFsQ29udHJpYnV0ZWQ7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVG90YWwgYW1vdW50IG9mIEVUSCBjb250cmlidXRlZCBpbiBnaXZlbiBwZXJpb2QKICAgIGFkZHJlc3NbXSBwdWJsaWMgY29udHJpYnV0b3JzS2V5czsgICAgICAgICAgICAgICAgICAgICAgICAgLy8gQWRkcmVzc2VzIG9mIGFsbCBjb250cmlidXRvcnMgaW4gZ2l2ZW4gY29udHJpYnV0aW9uIHBlcmlvZAogICAgbWFwcGluZyAoYWRkcmVzcyA9PiBDb250cmlidXRvcikgcHVibGljIGNvbnRyaWJ1dG9yczsKCiAgICBldmVudCBvbkNvbnRyaWJ1dGlvbih1aW50IHRvdGFsQ29udHJpYnV0ZWQsIGFkZHJlc3MgaW5kZXhlZCBjb250cmlidXRvciwgdWludCBhbW91bnQsCiAgICAgICAgdWludCBjb250cmlidXRvcnNDb3VudCk7CiAgICBldmVudCBvblNvZnRDYXBSZWFjaGVkKHVpbnQgZW5kVGltZSk7CiAgICBldmVudCBvbkhhcmRDYXBSZWFjaGVkKHVpbnQgZW5kVGltZSk7CiAgICBldmVudCBvbkNvbXBlbnNhdGVkKGFkZHJlc3MgaW5kZXhlZCBjb250cmlidXRvciwgdWludCBhbW91bnQpOwoKICAgIG1vZGlmaWVyIG9ubHlNdWx0aXNpZygpIHsKICAgICAgICByZXF1aXJlKG11bHRpc2lnV2FsbGV0ID09IG1zZy5zZW5kZXIpOwogICAgICAgIF87CiAgICB9CgogICAgZnVuY3Rpb24gRGlzdHJpY3QweENvbnRyaWJ1dGlvbigKICAgICAgICBhZGRyZXNzIF9tdWx0aXNpZ1dhbGxldCwKICAgICAgICBhZGRyZXNzIF9mb3VuZGVyMSwKICAgICAgICBhZGRyZXNzIF9mb3VuZGVyMiwKICAgICAgICBhZGRyZXNzIF9lYXJseVNwb25zb3IsCiAgICAgICAgYWRkcmVzc1tdIF9hZHZpc2VycwogICAgKSB7CiAgICAgICAgcmVxdWlyZShfYWR2aXNlcnMubGVuZ3RoID09IDUpOwogICAgICAgIG11bHRpc2lnV2FsbGV0ID0gX211bHRpc2lnV2FsbGV0OwogICAgICAgIGZvdW5kZXIxID0gX2ZvdW5kZXIxOwogICAgICAgIGZvdW5kZXIyID0gX2ZvdW5kZXIyOwogICAgICAgIGVhcmx5U3BvbnNvciA9IF9lYXJseVNwb25zb3I7CiAgICAgICAgYWR2aXNlcnMgPSBfYWR2aXNlcnM7CiAgICB9CgogICAgLy8gQG5vdGljZSBSZXR1cm5zIHRydWUgaWYgY29udHJpYnV0aW9uIHBlcmlvZCBpcyBjdXJyZW50bHkgcnVubmluZwogICAgZnVuY3Rpb24gaXNDb250cmliUGVyaW9kUnVubmluZygpIGNvbnN0YW50IHJldHVybnMgKGJvb2wpIHsKICAgICAgICByZXR1cm4gIWhhcmRDYXBSZWFjaGVkICYmCiAgICAgICAgICAgICAgIGlzRW5hYmxlZCAmJgogICAgICAgICAgICAgICBzdGFydFRpbWUgPD0gbm93ICYmCiAgICAgICAgICAgICAgIGVuZFRpbWUgPiBub3c7CiAgICB9CgogICAgZnVuY3Rpb24gY29udHJpYnV0ZSgpCiAgICAgICAgcGF5YWJsZQogICAgICAgIHN0b3BJbkVtZXJnZW5jeQogICAgewogICAgICAgIGNvbnRyaWJ1dGVXaXRoQWRkcmVzcyhtc2cuc2VuZGVyKTsKICAgIH0KCiAgICAvLyBAbm90aWNlIEZ1bmN0aW9uIHRvIHBhcnRpY2lwYXRlIGluIGNvbnRyaWJ1dGlvbiBwZXJpb2QKICAgIC8vICBBbW91bnRzIGZyb20gdGhlIHNhbWUgYWRkcmVzcyBzaG91bGQgYmUgYWRkZWQgdXAKICAgIC8vICBJZiBzb2Z0IG9yIGhhcmQgY2FwIGlzIHJlYWNoZWQsIGVuZCB0aW1lIHNob3VsZCBiZSBtb2RpZmllZAogICAgLy8gIEZ1bmRzIHNob3VsZCBiZSB0cmFuc2ZlcnJlZCBpbnRvIG11bHRpc2lnIHdhbGxldAogICAgLy8gQHBhcmFtIGNvbnRyaWJ1dG9yIEFkZHJlc3MgdGhhdCB3aWxsIHJlY2VpdmUgRE5UIHRva2VuCiAgICBmdW5jdGlvbiBjb250cmlidXRlV2l0aEFkZHJlc3MoYWRkcmVzcyBjb250cmlidXRvcikKICAgICAgICBwYXlhYmxlCiAgICAgICAgc3RvcEluRW1lcmdlbmN5CiAgICB7CiAgICAgICAgcmVxdWlyZSh0eC5nYXNwcmljZSA8PSBtYXhHYXNQcmljZSk7CiAgICAgICAgcmVxdWlyZShtc2cudmFsdWUgPj0gbWluQ29udHJpYkFtb3VudCk7CiAgICAgICAgcmVxdWlyZShpc0NvbnRyaWJQZXJpb2RSdW5uaW5nKCkpOwoKICAgICAgICB1aW50IGNvbnRyaWJWYWx1ZSA9IG1zZy52YWx1ZTsKICAgICAgICB1aW50IGV4Y2Vzc0NvbnRyaWJWYWx1ZSA9IDA7CgogICAgICAgIHVpbnQgb2xkVG90YWxDb250cmlidXRlZCA9IHRvdGFsQ29udHJpYnV0ZWQ7CgogICAgICAgIHRvdGFsQ29udHJpYnV0ZWQgPSBvbGRUb3RhbENvbnRyaWJ1dGVkLmFkZChjb250cmliVmFsdWUpOwoKICAgICAgICB1aW50IG5ld1RvdGFsQ29udHJpYnV0ZWQgPSB0b3RhbENvbnRyaWJ1dGVkOwoKICAgICAgICAvLyBTb2Z0IGNhcCB3YXMgcmVhY2hlZAogICAgICAgIGlmIChuZXdUb3RhbENvbnRyaWJ1dGVkID49IHNvZnRDYXBBbW91bnQgJiYKICAgICAgICAgICAgb2xkVG90YWxDb250cmlidXRlZCA8IHNvZnRDYXBBbW91bnQpCiAgICAgICAgewogICAgICAgICAgICBzb2Z0Q2FwUmVhY2hlZCA9IHRydWU7CiAgICAgICAgICAgIGVuZFRpbWUgPSBhZnRlclNvZnRDYXBEdXJhdGlvbi5hZGQobm93KTsKICAgICAgICAgICAgb25Tb2Z0Q2FwUmVhY2hlZChlbmRUaW1lKTsKICAgICAgICB9CiAgICAgICAgLy8gSGFyZCBjYXAgd2FzIHJlYWNoZWQKICAgICAgICBpZiAobmV3VG90YWxDb250cmlidXRlZCA+PSBoYXJkQ2FwQW1vdW50ICYmCiAgICAgICAgICAgIG9sZFRvdGFsQ29udHJpYnV0ZWQgPCBoYXJkQ2FwQW1vdW50KQogICAgICAgIHsKICAgICAgICAgICAgaGFyZENhcFJlYWNoZWQgPSB0cnVlOwogICAgICAgICAgICBlbmRUaW1lID0gbm93OwogICAgICAgICAgICBvbkhhcmRDYXBSZWFjaGVkKGVuZFRpbWUpOwoKICAgICAgICAgICAgLy8gRXZlcnl0aGluZyBhYm92ZSBoYXJkIGNhcCB3aWxsIGJlIHNlbnQgYmFjayB0byBjb250cmlidXRvcgogICAgICAgICAgICBleGNlc3NDb250cmliVmFsdWUgPSBuZXdUb3RhbENvbnRyaWJ1dGVkLnN1YihoYXJkQ2FwQW1vdW50KTsKICAgICAgICAgICAgY29udHJpYlZhbHVlID0gY29udHJpYlZhbHVlLnN1YihleGNlc3NDb250cmliVmFsdWUpOwoKICAgICAgICAgICAgdG90YWxDb250cmlidXRlZCA9IGhhcmRDYXBBbW91bnQ7CiAgICAgICAgfQoKICAgICAgICBpZiAoY29udHJpYnV0b3JzW2NvbnRyaWJ1dG9yXS5hbW91bnQgPT0gMCkgewogICAgICAgICAgICBjb250cmlidXRvcnNLZXlzLnB1c2goY29udHJpYnV0b3IpOwogICAgICAgIH0KCiAgICAgICAgY29udHJpYnV0b3JzW2NvbnRyaWJ1dG9yXS5hbW91bnQgPSBjb250cmlidXRvcnNbY29udHJpYnV0b3JdLmFtb3VudC5hZGQoY29udHJpYlZhbHVlKTsKCiAgICAgICAgbXVsdGlzaWdXYWxsZXQudHJhbnNmZXIoY29udHJpYlZhbHVlKTsKICAgICAgICBpZiAoZXhjZXNzQ29udHJpYlZhbHVlID4gMCkgewogICAgICAgICAgICBtc2cuc2VuZGVyLnRyYW5zZmVyKGV4Y2Vzc0NvbnRyaWJWYWx1ZSk7CiAgICAgICAgfQogICAgICAgIG9uQ29udHJpYnV0aW9uKG5ld1RvdGFsQ29udHJpYnV0ZWQsIGNvbnRyaWJ1dG9yLCBjb250cmliVmFsdWUsIGNvbnRyaWJ1dG9yc0tleXMubGVuZ3RoKTsKICAgIH0KCiAgICAvLyBAbm90aWNlIFRoaXMgbWV0aG9kIGlzIGNhbGxlZCBieSBvd25lciBhZnRlciBjb250cmlidXRpb24gcGVyaW9kIGVuZHMsIHRvIGRpc3RyaWJ1dGUgRE5UIGluIHByb3BvcnRpb25hbCBtYW5uZXIKICAgIC8vICBFYWNoIGNvbnRyaWJ1dG9yIHNob3VsZCByZWNlaXZlIEROVCBqdXN0IG9uY2UgZXZlbiBpZiB0aGlzIG1ldGhvZCBpcyBjYWxsZWQgbXVsdGlwbGUgdGltZXMKICAgIC8vICBJbiBjYXNlIG9mIG1hbnkgY29udHJpYnV0b3JzIG11c3QgYmUgYWJsZSB0byBjb21wZW5zYXRlIGNvbnRyaWJ1dG9ycyBpbiBwYWdpbmF0aW9uYWwgd2F5LCBvdGhlcndpc2UgbWlnaHQKICAgIC8vICBydW4gb3V0IG9mIGdhcyBpZiB3YW50ZWQgdG8gY29tcGVuc2F0ZSBhbGwgb24gb25lIG1ldGhvZCBjYWxsLiBUaGVyZWZvcmUgcGFyYW1ldGVycyBvZmZzZXQgYW5kIGxpbWl0CiAgICAvLyBAcGFyYW0gcGVyaW9kSW5kZXggSW5kZXggb2YgY29udHJpYnV0aW9uIHBlcmlvZCAoMC0yKQogICAgLy8gQHBhcmFtIG9mZnNldCBOdW1iZXIgb2YgZmlyc3QgY29udHJpYnV0b3JzIHRvIHNraXAuCiAgICAvLyBAcGFyYW0gbGltaXQgTWF4IG51bWJlciBvZiBjb250cmlidXRvcnMgY29tcGVuc2F0ZWQgb24gdGhpcyBjYWxsCiAgICBmdW5jdGlvbiBjb21wZW5zYXRlQ29udHJpYnV0b3JzKHVpbnQgb2Zmc2V0LCB1aW50IGxpbWl0KQogICAgICAgIG9ubHlPd25lcgogICAgewogICAgICAgIHJlcXVpcmUoaXNFbmFibGVkKTsKICAgICAgICByZXF1aXJlKGVuZFRpbWUgPCBub3cpOwoKICAgICAgICB1aW50IGkgPSBvZmZzZXQ7CiAgICAgICAgdWludCBjb21wZW5zYXRlZENvdW50ID0gMDsKICAgICAgICB1aW50IGNvbnRyaWJ1dG9yc0NvdW50ID0gY29udHJpYnV0b3JzS2V5cy5sZW5ndGg7CgogICAgICAgIHVpbnQgcmF0aW8gPSBDT05UUklCX1BFUklPRDFfU1RBS0UKICAgICAgICAgICAgLm11bCgxMDAwMDAwMDAwMDAwMDAwMDAwKQogICAgICAgICAgICAuZGl2KHRvdGFsQ29udHJpYnV0ZWQpOwoKICAgICAgICB3aGlsZSAoaSA8IGNvbnRyaWJ1dG9yc0NvdW50ICYmIGNvbXBlbnNhdGVkQ291bnQgPCBsaW1pdCkgewogICAgICAgICAgICBhZGRyZXNzIGNvbnRyaWJ1dG9yQWRkcmVzcyA9IGNvbnRyaWJ1dG9yc0tleXNbaV07CiAgICAgICAgICAgIGlmICghY29udHJpYnV0b3JzW2NvbnRyaWJ1dG9yQWRkcmVzc10uaXNDb21wZW5zYXRlZCkgewogICAgICAgICAgICAgICAgdWludCBhbW91bnRDb250cmlidXRlZCA9IGNvbnRyaWJ1dG9yc1tjb250cmlidXRvckFkZHJlc3NdLmFtb3VudDsKICAgICAgICAgICAgICAgIGNvbnRyaWJ1dG9yc1tjb250cmlidXRvckFkZHJlc3NdLmlzQ29tcGVuc2F0ZWQgPSB0cnVlOwoKICAgICAgICAgICAgICAgIGNvbnRyaWJ1dG9yc1tjb250cmlidXRvckFkZHJlc3NdLmFtb3VudENvbXBlbnNhdGVkID0KICAgICAgICAgICAgICAgICAgICBhbW91bnRDb250cmlidXRlZC5tdWwocmF0aW8pLmRpdigxMDAwMDAwMDAwMDAwMDAwMDAwKTsKCiAgICAgICAgICAgICAgICBkaXN0cmljdDB4TmV0d29ya1Rva2VuLnRyYW5zZmVyKGNvbnRyaWJ1dG9yQWRkcmVzcywgY29udHJpYnV0b3JzW2NvbnRyaWJ1dG9yQWRkcmVzc10uYW1vdW50Q29tcGVuc2F0ZWQpOwogICAgICAgICAgICAgICAgb25Db21wZW5zYXRlZChjb250cmlidXRvckFkZHJlc3MsIGNvbnRyaWJ1dG9yc1tjb250cmlidXRvckFkZHJlc3NdLmFtb3VudENvbXBlbnNhdGVkKTsKCiAgICAgICAgICAgICAgICBjb21wZW5zYXRlZENvdW50Kys7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaSsrOwogICAgICAgIH0KICAgIH0KCiAgICAvLyBAbm90aWNlIE1ldGhvZCBmb3Igc2V0dGluZyB1cCBjb250cmlidXRpb24gcGVyaW9kCiAgICAvLyAgT25seSBvd25lciBzaG91bGQgYmUgYWJsZSB0byBleGVjdXRlCiAgICAvLyAgU2V0dGluZyBmaXJzdCBjb250cmlidXRpb24gcGVyaW9kIHNldHMgdXAgdmVzdGluZyBmb3IgZm91bmRlcnMgJiBhZHZpc29ycwogICAgLy8gIENvbnRyaWJ1dGlvbiBwZXJpb2Qgc2hvdWxkIHN0aWxsIG5vdCBiZSBlbmFibGVkIGFmdGVyIGNhbGxpbmcgdGhpcyBtZXRob2QKICAgIC8vIEBwYXJhbSBzb2Z0Q2FwQW1vdW50IFNvZnQgQ2FwIGluIHdlaQogICAgLy8gQHBhcmFtIGFmdGVyU29mdENhcER1cmF0aW9uIE51bWJlciBvZiBzZWNvbmRzIHRpbGwgdGhlIGVuZCBvZiBzYWxlIGluIHRoZSBtb21lbnQgb2YgcmVhY2hpbmcgc29mdCBjYXAgKHVubGVzcyByZWFjaGluZyBoYXJkIGNhcCkKICAgIC8vIEBwYXJhbSBoYXJkQ2FwQW1vdW50IEhhcmQgQ2FwIGluIHdlaQogICAgLy8gQHBhcmFtIHN0YXJ0VGltZSBDb250cmlidXRpb24gc3RhcnQgdGltZSBpbiBVTklYIHRpbWUKICAgIC8vIEBwYXJhbSBlbmRUaW1lIENvbnRyaWJ1dGlvbiBlbmQgdGltZSBpbiBVTklYIHRpbWUKICAgIGZ1bmN0aW9uIHNldENvbnRyaWJQZXJpb2QoCiAgICAgICAgdWludCBfc29mdENhcEFtb3VudCwKICAgICAgICB1aW50IF9hZnRlclNvZnRDYXBEdXJhdGlvbiwKICAgICAgICB1aW50IF9oYXJkQ2FwQW1vdW50LAogICAgICAgIHVpbnQgX3N0YXJ0VGltZSwKICAgICAgICB1aW50IF9lbmRUaW1lCiAgICApCiAgICAgICAgb25seU93bmVyCiAgICB7CiAgICAgICAgcmVxdWlyZShfc29mdENhcEFtb3VudCA+IDApOwogICAgICAgIHJlcXVpcmUoX2hhcmRDYXBBbW91bnQgPiBfc29mdENhcEFtb3VudCk7CiAgICAgICAgcmVxdWlyZShfYWZ0ZXJTb2Z0Q2FwRHVyYXRpb24gPiAwKTsKICAgICAgICByZXF1aXJlKF9zdGFydFRpbWUgPiBub3cpOwogICAgICAgIHJlcXVpcmUoX2VuZFRpbWUgPiBfc3RhcnRUaW1lKTsKICAgICAgICByZXF1aXJlKCFpc0VuYWJsZWQpOwoKICAgICAgICBzb2Z0Q2FwQW1vdW50ID0gX3NvZnRDYXBBbW91bnQ7CiAgICAgICAgYWZ0ZXJTb2Z0Q2FwRHVyYXRpb24gPSBfYWZ0ZXJTb2Z0Q2FwRHVyYXRpb247CiAgICAgICAgaGFyZENhcEFtb3VudCA9IF9oYXJkQ2FwQW1vdW50OwogICAgICAgIHN0YXJ0VGltZSA9IF9zdGFydFRpbWU7CiAgICAgICAgZW5kVGltZSA9IF9lbmRUaW1lOwoKICAgICAgICBkaXN0cmljdDB4TmV0d29ya1Rva2VuLnJldm9rZUFsbFRva2VuR3JhbnRzKGZvdW5kZXIxKTsKICAgICAgICBkaXN0cmljdDB4TmV0d29ya1Rva2VuLnJldm9rZUFsbFRva2VuR3JhbnRzKGZvdW5kZXIyKTsKICAgICAgICBkaXN0cmljdDB4TmV0d29ya1Rva2VuLnJldm9rZUFsbFRva2VuR3JhbnRzKGVhcmx5U3BvbnNvcik7CgogICAgICAgIGZvciAodWludCBqID0gMDsgaiA8IGFkdmlzZXJzLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICAgIGRpc3RyaWN0MHhOZXR3b3JrVG9rZW4ucmV2b2tlQWxsVG9rZW5HcmFudHMoYWR2aXNlcnNbal0pOwogICAgICAgIH0KCiAgICAgICAgdWludDY0IHZlc3RpbmdEYXRlID0gdWludDY0KHN0YXJ0VGltZS5hZGQoVEVBTV9WRVNUSU5HX1BFUklPRCkpOwogICAgICAgIHVpbnQ2NCBjbGlmZkRhdGUgPSB1aW50NjQoc3RhcnRUaW1lLmFkZChURUFNX1ZFU1RJTkdfQ0xJRkYpKTsKICAgICAgICB1aW50NjQgZWFybHlDb250cmliVmVzdGluZ0RhdGUgPSB1aW50NjQoc3RhcnRUaW1lLmFkZChFQVJMWV9DT05UUklCVVRPUl9WRVNUSU5HX1BFUklPRCkpOwogICAgICAgIHVpbnQ2NCBlYXJseUNvbnRyaWJDbGlmZkRhdGUgPSB1aW50NjQoc3RhcnRUaW1lLmFkZChFQVJMWV9DT05UUklCVVRPUl9WRVNUSU5HX0NMSUZGKSk7CiAgICAgICAgdWludDY0IHN0YXJ0RGF0ZSA9IHVpbnQ2NChzdGFydFRpbWUpOwoKICAgICAgICBkaXN0cmljdDB4TmV0d29ya1Rva2VuLmdyYW50VmVzdGVkVG9rZW5zKGZvdW5kZXIxLCBGT1VOREVSMV9TVEFLRSwgc3RhcnREYXRlLCBjbGlmZkRhdGUsIHZlc3RpbmdEYXRlLCB0cnVlLCBmYWxzZSk7CiAgICAgICAgZGlzdHJpY3QweE5ldHdvcmtUb2tlbi5ncmFudFZlc3RlZFRva2Vucyhmb3VuZGVyMiwgRk9VTkRFUjJfU1RBS0UsIHN0YXJ0RGF0ZSwgY2xpZmZEYXRlLCB2ZXN0aW5nRGF0ZSwgdHJ1ZSwgZmFsc2UpOwogICAgICAgIGRpc3RyaWN0MHhOZXR3b3JrVG9rZW4uZ3JhbnRWZXN0ZWRUb2tlbnMoZWFybHlTcG9uc29yLCBFQVJMWV9DT05UUklCVVRPUl9TVEFLRSwgc3RhcnREYXRlLCBlYXJseUNvbnRyaWJDbGlmZkRhdGUsIGVhcmx5Q29udHJpYlZlc3RpbmdEYXRlLCB0cnVlLCBmYWxzZSk7CiAgICAgICAgZGlzdHJpY3QweE5ldHdvcmtUb2tlbi5ncmFudFZlc3RlZFRva2VucyhhZHZpc2Vyc1swXSwgQURWSVNFUl9TVEFLRSwgc3RhcnREYXRlLCBjbGlmZkRhdGUsIHZlc3RpbmdEYXRlLCB0cnVlLCBmYWxzZSk7CiAgICAgICAgZGlzdHJpY3QweE5ldHdvcmtUb2tlbi5ncmFudFZlc3RlZFRva2VucyhhZHZpc2Vyc1sxXSwgQURWSVNFUl9TVEFLRSwgc3RhcnREYXRlLCBjbGlmZkRhdGUsIHZlc3RpbmdEYXRlLCB0cnVlLCBmYWxzZSk7CiAgICAgICAgZGlzdHJpY3QweE5ldHdvcmtUb2tlbi5ncmFudFZlc3RlZFRva2VucyhhZHZpc2Vyc1syXSwgQURWSVNFUl9TVEFLRTIsIHN0YXJ0RGF0ZSwgY2xpZmZEYXRlLCB2ZXN0aW5nRGF0ZSwgdHJ1ZSwgZmFsc2UpOwogICAgICAgIGRpc3RyaWN0MHhOZXR3b3JrVG9rZW4uZ3JhbnRWZXN0ZWRUb2tlbnMoYWR2aXNlcnNbM10sIEFEVklTRVJfU1RBS0UyLCBzdGFydERhdGUsIGNsaWZmRGF0ZSwgdmVzdGluZ0RhdGUsIHRydWUsIGZhbHNlKTsKCiAgICAgICAgLy8gQ29tbXVuaXR5IGFkdmlzb3JzIHN0YWtlIGhhcyBubyB2ZXN0aW5nLCBidXQgd2Ugc2V0IGl0IHVwIHRoaXMgd2F5LCBzbyB3ZSBjYW4gcmV2b2tlIGl0IGluIGNhc2Ugb2YKICAgICAgICAvLyByZS1zZXR0aW5nIHVwIGNvbnRyaWJ1dGlvbiBwZXJpb2QKICAgICAgICBkaXN0cmljdDB4TmV0d29ya1Rva2VuLmdyYW50VmVzdGVkVG9rZW5zKGFkdmlzZXJzWzRdLCBDT01NVU5JVFlfQURWSVNFUlNfU1RBS0UsIHN0YXJ0RGF0ZSwgc3RhcnREYXRlLCBzdGFydERhdGUsIHRydWUsIGZhbHNlKTsKICAgIH0KCiAgICAvLyBAbm90aWNlIEVuYWJsZXMgY29udHJpYnV0aW9uIHBlcmlvZAogICAgLy8gIE11c3QgYmUgZXhlY3V0ZWQgYnkgbXVsdGlzaWduYXR1cmUKICAgIGZ1bmN0aW9uIGVuYWJsZUNvbnRyaWJQZXJpb2QoKQogICAgICAgIG9ubHlNdWx0aXNpZwogICAgewogICAgICAgIHJlcXVpcmUoc3RhcnRUaW1lID4gbm93KTsKICAgICAgICBpc0VuYWJsZWQgPSB0cnVlOwogICAgfQoKICAgIC8vIEBub3RpY2UgU2V0cyBuZXcgbWluLiBjb250cmlidXRpb24gYW1vdW50CiAgICAvLyAgT25seSBvd25lciBjYW4gZXhlY3V0ZQogICAgLy8gIENhbm5vdCBiZSBleGVjdXRlZCB3aGlsZSBjb250cmlidXRpb24gcGVyaW9kIGlzIHJ1bm5pbmcKICAgIC8vIEBwYXJhbSBfbWluQ29udHJpYkFtb3VudCBuZXcgbWluLiBhbW91bnQKICAgIGZ1bmN0aW9uIHNldE1pbkNvbnRyaWJBbW91bnQodWludCBfbWluQ29udHJpYkFtb3VudCkKICAgICAgICBvbmx5T3duZXIKICAgIHsKICAgICAgICByZXF1aXJlKF9taW5Db250cmliQW1vdW50ID4gMCk7CiAgICAgICAgcmVxdWlyZShzdGFydFRpbWUgPiBub3cpOwogICAgICAgIG1pbkNvbnRyaWJBbW91bnQgPSBfbWluQ29udHJpYkFtb3VudDsKICAgIH0KCiAgICAvLyBAbm90aWNlIFNldHMgbmV3IG1heCBnYXMgcHJpY2UgZm9yIGNvbnRyaWJ1dGlvbgogICAgLy8gIE9ubHkgb3duZXIgY2FuIGV4ZWN1dGUKICAgIC8vICBDYW5ub3QgYmUgZXhlY3V0ZWQgd2hpbGUgY29udHJpYnV0aW9uIHBlcmlvZCBpcyBydW5uaW5nCiAgICAvLyBAcGFyYW0gX21pbkNvbnRyaWJBbW91bnQgbmV3IG1pbi4gYW1vdW50CiAgICBmdW5jdGlvbiBzZXRNYXhHYXNQcmljZSh1aW50IF9tYXhHYXNQcmljZSkKICAgICAgICBvbmx5T3duZXIKICAgIHsKICAgICAgICByZXF1aXJlKF9tYXhHYXNQcmljZSA+IDApOwogICAgICAgIHJlcXVpcmUoc3RhcnRUaW1lID4gbm93KTsKICAgICAgICBtYXhHYXNQcmljZSA9IF9tYXhHYXNQcmljZTsKICAgIH0KCiAgICAvLyBAbm90aWNlIFNldHMgRGlzdHJpY3QweE5ldHdvcmtUb2tlbiBjb250cmFjdAogICAgLy8gIEdlbmVyYXRlcyBhbGwgRE5UIHRva2VucyBhbmQgYXNzaWducyB0aGVtIHRvIHRoaXMgY29udHJhY3QKICAgIC8vICBJZiB0b2tlbiBjb250cmFjdCBoYXMgYWxyZWFkeSBnZW5lcmF0ZWQgdG9rZW5zLCBkbyBub3QgZ2VuZXJhdGUgYWdhaW4KICAgIC8vIEBwYXJhbSBfZGlzdHJpY3QweE5ldHdvcmtUb2tlbiBEaXN0cmljdDB4TmV0d29ya1Rva2VuIGFkZHJlc3MKICAgIGZ1bmN0aW9uIHNldERpc3RyaWN0MHhOZXR3b3JrVG9rZW4oYWRkcmVzcyBfZGlzdHJpY3QweE5ldHdvcmtUb2tlbikKICAgICAgICBvbmx5T3duZXIKICAgIHsKICAgICAgICByZXF1aXJlKF9kaXN0cmljdDB4TmV0d29ya1Rva2VuICE9IDB4MCk7CiAgICAgICAgcmVxdWlyZSghaXNFbmFibGVkKTsKICAgICAgICBkaXN0cmljdDB4TmV0d29ya1Rva2VuID0gRGlzdHJpY3QweE5ldHdvcmtUb2tlbihfZGlzdHJpY3QweE5ldHdvcmtUb2tlbik7CiAgICAgICAgaWYgKGRpc3RyaWN0MHhOZXR3b3JrVG9rZW4udG90YWxTdXBwbHkoKSA9PSAwKSB7CiAgICAgICAgICAgIGRpc3RyaWN0MHhOZXR3b3JrVG9rZW4uZ2VuZXJhdGVUb2tlbnModGhpcywgRk9VTkRFUjFfU1RBS0UKICAgICAgICAgICAgICAgIC5hZGQoRk9VTkRFUjJfU1RBS0UpCiAgICAgICAgICAgICAgICAuYWRkKEVBUkxZX0NPTlRSSUJVVE9SX1NUQUtFKQogICAgICAgICAgICAgICAgLmFkZChBRFZJU0VSX1NUQUtFLm11bCgyKSkKICAgICAgICAgICAgICAgIC5hZGQoQURWSVNFUl9TVEFLRTIubXVsKDIpKQogICAgICAgICAgICAgICAgLmFkZChDT01NVU5JVFlfQURWSVNFUlNfU1RBS0UpCiAgICAgICAgICAgICAgICAuYWRkKENPTlRSSUJfUEVSSU9EMV9TVEFLRSkpOwoKICAgICAgICAgICAgZGlzdHJpY3QweE5ldHdvcmtUb2tlbi5nZW5lcmF0ZVRva2VucyhtdWx0aXNpZ1dhbGxldCwgQ09OVFJJQl9QRVJJT0QyX1NUQUtFCiAgICAgICAgICAgICAgICAuYWRkKENPTlRSSUJfUEVSSU9EM19TVEFLRSkpOwogICAgICAgIH0KICAgIH0KCiAgICAvLyBAbm90aWNlIEVuYWJsZXMgdHJhbnNmZXJzIG9mIEROVAogICAgLy8gIFdpbGwgYmUgZXhlY3V0ZWQgYWZ0ZXIgZmlyc3QgY29udHJpYnV0aW9uIHBlcmlvZCBieSBvd25lcgogICAgZnVuY3Rpb24gZW5hYmxlRGlzdHJpY3QweE5ldHdvcmtUb2tlblRyYW5zZmVycygpCiAgICAgICAgb25seU93bmVyCiAgICB7CiAgICAgICAgcmVxdWlyZShlbmRUaW1lIDwgbm93KTsKICAgICAgICB0b2tlblRyYW5zZmVyc0VuYWJsZWQgPSB0cnVlOwogICAgfQoKICAgIC8vIEBub3RpY2UgTWV0aG9kIHRvIGNsYWltIHRva2VucyBhY2NpZGVudGFsbHkgc2VudCB0byBhIEROVCBjb250cmFjdAogICAgLy8gIE9ubHkgbXVsdGlzaWcgd2FsbGV0IGNhbiBleGVjdXRlCiAgICAvLyBAcGFyYW0gX3Rva2VuIEFkZHJlc3Mgb2YgY2xhaW1lZCBFUkMyMCBUb2tlbgogICAgZnVuY3Rpb24gY2xhaW1Ub2tlbnNGcm9tVG9rZW5EaXN0cmljdDB4TmV0d29ya1Rva2VuKGFkZHJlc3MgX3Rva2VuKQogICAgICAgIG9ubHlNdWx0aXNpZwogICAgewogICAgICAgIGRpc3RyaWN0MHhOZXR3b3JrVG9rZW4uY2xhaW1Ub2tlbnMoX3Rva2VuLCBtdWx0aXNpZ1dhbGxldCk7CiAgICB9CgogICAgLy8gQG5vdGljZSBLaWxsIG1ldGhvZCBzaG91bGQgbm90IHJlYWxseSBiZSBuZWVkZWQsIGJ1dCBqdXN0IGluIGNhc2UKICAgIGZ1bmN0aW9uIGtpbGwoYWRkcmVzcyBfdG8pIG9ubHlNdWx0aXNpZyBleHRlcm5hbCB7CiAgICAgICAgc3VpY2lkZShfdG8pOwogICAgfQoKICAgIGZ1bmN0aW9uKCkKICAgICAgICBwYXlhYmxlCiAgICAgICAgc3RvcEluRW1lcmdlbmN5CiAgICB7CiAgICAgICAgY29udHJpYnV0ZVdpdGhBZGRyZXNzKG1zZy5zZW5kZXIpOwogICAgfQoKICAgIC8vIE1pbmlNZSBDb250cm9sbGVyIGRlZmF1bHQgc2V0dGluZ3MgZm9yIGFsbG93aW5nIHRva2VuIHRyYW5zZmVycy4KICAgIGZ1bmN0aW9uIHByb3h5UGF5bWVudChhZGRyZXNzIF9vd25lcikgcGF5YWJsZSBwdWJsaWMgcmV0dXJucyAoYm9vbCkgewogICAgICAgIHRocm93OwogICAgfQoKICAgIC8vIEJlZm9yZSB0cmFuc2ZlcnMgYXJlIGVuYWJsZWQgZm9yIGV2ZXJ5b25lLCBvbmx5IHRoaXMgY29udHJhY3QgaXMgYWxsb3dlZCB0byBkaXN0cmlidXRlIEROVAogICAgZnVuY3Rpb24gb25UcmFuc2ZlcihhZGRyZXNzIF9mcm9tLCBhZGRyZXNzIF90bywgdWludCBfYW1vdW50KSBwdWJsaWMgcmV0dXJucyAoYm9vbCkgewogICAgICAgIHJldHVybiB0b2tlblRyYW5zZmVyc0VuYWJsZWQgfHwgX2Zyb20gPT0gYWRkcmVzcyh0aGlzKSB8fCBfdG8gPT0gYWRkcmVzcyh0aGlzKTsKICAgIH0KCiAgICBmdW5jdGlvbiBvbkFwcHJvdmUoYWRkcmVzcyBfb3duZXIsIGFkZHJlc3MgX3NwZW5kZXIsIHVpbnQgX2Ftb3VudCkgcHVibGljIHJldHVybnMgKGJvb2wpIHsKICAgICAgICByZXR1cm4gdG9rZW5UcmFuc2ZlcnNFbmFibGVkOwogICAgfQoKICAgIGZ1bmN0aW9uIGlzVG9rZW5TYWxlVG9rZW4oYWRkcmVzcyB0b2tlbkFkZHIpIHJldHVybnMoYm9vbCkgewogICAgICAgIHJldHVybiBkaXN0cmljdDB4TmV0d29ya1Rva2VuID09IHRva2VuQWRkcjsKICAgIH0KCiAgICAvKgogICAgIEZvbGxvd2luZyBjb25zdGFudCBtZXRob2RzIGFyZSB1c2VkIGZvciB0ZXN0cyBhbmQgY29udHJpYnV0aW9uIHdlYiBhcHAKICAgICBUaGV5IGRvbid0IGltcGFjdCBsb2dpYyBvZiBjb250cmlidXRpb24gY29udHJhY3QsIHRoZXJlZm9yIERPRVMgTk9UIE5FRUQgVE8gQkUgQVVESVRFRAogICAgICovCgogICAgLy8gVXNlZCBieSBjb250cmlidXRpb24gZnJvbnQtZW5kIHRvIG9idGFpbiBjb250cmlidXRpb24gcGVyaW9kIHByb3BlcnRpZXMKICAgIGZ1bmN0aW9uIGdldENvbnRyaWJQZXJpb2QoKQogICAgICAgIGNvbnN0YW50CiAgICAgICAgcmV0dXJucyAoYm9vbFszXSBib29sVmFsdWVzLCB1aW50WzhdIHVpbnRWYWx1ZXMpCiAgICB7CiAgICAgICAgYm9vbFZhbHVlc1swXSA9IGlzRW5hYmxlZDsKICAgICAgICBib29sVmFsdWVzWzFdID0gc29mdENhcFJlYWNoZWQ7CiAgICAgICAgYm9vbFZhbHVlc1syXSA9IGhhcmRDYXBSZWFjaGVkOwoKICAgICAgICB1aW50VmFsdWVzWzBdID0gc29mdENhcEFtb3VudDsKICAgICAgICB1aW50VmFsdWVzWzFdID0gYWZ0ZXJTb2Z0Q2FwRHVyYXRpb247CiAgICAgICAgdWludFZhbHVlc1syXSA9IGhhcmRDYXBBbW91bnQ7CiAgICAgICAgdWludFZhbHVlc1szXSA9IHN0YXJ0VGltZTsKICAgICAgICB1aW50VmFsdWVzWzRdID0gZW5kVGltZTsKICAgICAgICB1aW50VmFsdWVzWzVdID0gdG90YWxDb250cmlidXRlZDsKICAgICAgICB1aW50VmFsdWVzWzZdID0gY29udHJpYnV0b3JzS2V5cy5sZW5ndGg7CiAgICAgICAgdWludFZhbHVlc1s3XSA9IENPTlRSSUJfUEVSSU9EMV9TVEFLRTsKCiAgICAgICAgcmV0dXJuIChib29sVmFsdWVzLCB1aW50VmFsdWVzKTsKICAgIH0KCiAgICAvLyBVc2VkIGJ5IGNvbnRyaWJ1dGlvbiBmcm9udC1lbmQgdG8gb2J0YWluIGNvbnRyaWJ1dGlvbiBjb250cmFjdCBwcm9wZXJ0aWVzCiAgICBmdW5jdGlvbiBnZXRDb25maWd1cmF0aW9uKCkKICAgICAgICBjb25zdGFudAogICAgICAgIHJldHVybnMgKGJvb2wsIGFkZHJlc3MsIGFkZHJlc3MsIGFkZHJlc3MsIGFkZHJlc3MsIGFkZHJlc3NbXSBfYWR2aXNlcnMsIGJvb2wsIHVpbnQpCiAgICB7CiAgICAgICAgX2FkdmlzZXJzID0gbmV3IGFkZHJlc3NbXShhZHZpc2Vycy5sZW5ndGgpOwogICAgICAgIGZvciAodWludCBpID0gMDsgaSA8IGFkdmlzZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIF9hZHZpc2Vyc1tpXSA9IGFkdmlzZXJzW2ldOwogICAgICAgIH0KICAgICAgICByZXR1cm4gKHN0b3BwZWQsIG11bHRpc2lnV2FsbGV0LCBmb3VuZGVyMSwgZm91bmRlcjIsIGVhcmx5U3BvbnNvciwgX2FkdmlzZXJzLCB0b2tlblRyYW5zZmVyc0VuYWJsZWQsCiAgICAgICAgICAgIG1heEdhc1ByaWNlKTsKICAgIH0KCiAgICAvLyBVc2VkIGJ5IGNvbnRyaWJ1dGlvbiBmcm9udC1lbmQgdG8gb2J0YWluIGNvbnRyaWJ1dG9yJ3MgcHJvcGVydGllcwogICAgZnVuY3Rpb24gZ2V0Q29udHJpYnV0b3IoYWRkcmVzcyBjb250cmlidXRvckFkZHJlc3MpCiAgICAgICAgY29uc3RhbnQKICAgICAgICByZXR1cm5zKHVpbnQsIGJvb2wsIHVpbnQpCiAgICB7CiAgICAgICAgQ29udHJpYnV0b3IgY29udHJpYnV0b3IgPSBjb250cmlidXRvcnNbY29udHJpYnV0b3JBZGRyZXNzXTsKICAgICAgICByZXR1cm4gKGNvbnRyaWJ1dG9yLmFtb3VudCwgY29udHJpYnV0b3IuaXNDb21wZW5zYXRlZCwgY29udHJpYnV0b3IuYW1vdW50Q29tcGVuc2F0ZWQpOwogICAgfQoKICAgIC8vIEZ1bmN0aW9uIHRvIHZlcmlmeSBpZiBhbGwgY29udHJpYnV0b3JzIHdlcmUgY29tcGVuc2F0ZWQKICAgIGZ1bmN0aW9uIGdldFVuY29tcGVuc2F0ZWRDb250cmlidXRvcnModWludCBvZmZzZXQsIHVpbnQgbGltaXQpCiAgICAgICAgY29uc3RhbnQKICAgICAgICByZXR1cm5zICh1aW50W10gY29udHJpYnV0b3JJbmRleGVzKQogICAgewogICAgICAgIHVpbnQgY29udHJpYnV0b3JzQ291bnQgPSBjb250cmlidXRvcnNLZXlzLmxlbmd0aDsKCiAgICAgICAgaWYgKGxpbWl0ID09IDApIHsKICAgICAgICAgICAgbGltaXQgPSBjb250cmlidXRvcnNDb3VudDsKICAgICAgICB9CgogICAgICAgIHVpbnQgaSA9IG9mZnNldDsKICAgICAgICB1aW50IHJlc3VsdHNDb3VudCA9IDA7CiAgICAgICAgdWludFtdIG1lbW9yeSBfY29udHJpYnV0b3JJbmRleGVzID0gbmV3IHVpbnRbXShsaW1pdCk7CgogICAgICAgIHdoaWxlIChpIDwgY29udHJpYnV0b3JzQ291bnQgJiYgcmVzdWx0c0NvdW50IDwgbGltaXQpIHsKICAgICAgICAgICAgaWYgKCFjb250cmlidXRvcnNbY29udHJpYnV0b3JzS2V5c1tpXV0uaXNDb21wZW5zYXRlZCkgewogICAgICAgICAgICAgICAgX2NvbnRyaWJ1dG9ySW5kZXhlc1tyZXN1bHRzQ291bnRdID0gaTsKICAgICAgICAgICAgICAgIHJlc3VsdHNDb3VudCsrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGkrKzsKICAgICAgICB9CgogICAgICAgIGNvbnRyaWJ1dG9ySW5kZXhlcyA9IG5ldyB1aW50W10ocmVzdWx0c0NvdW50KTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgcmVzdWx0c0NvdW50OyBpKyspIHsKICAgICAgICAgICAgY29udHJpYnV0b3JJbmRleGVzW2ldID0gX2NvbnRyaWJ1dG9ySW5kZXhlc1tpXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGNvbnRyaWJ1dG9ySW5kZXhlczsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXROb3coKQogICAgICAgIGNvbnN0YW50CiAgICAgICAgcmV0dXJucyh1aW50KQogICAgewogICAgICAgIHJldHVybiBub3c7CiAgICB9Cn0='.
	

]
