Class {
	#name : #SRT007112089f32c0fb6cc1921d4877c2c97270c5ab,
	#superclass : #SRTContracts,
	#category : #SolidityTestingResources
}

{ #category : #base64 }
SRT007112089f32c0fb6cc1921d4877c2c97270c5ab >> base64 [
	^ 'cHJhZ21hIHNvbGlkaXR5IF4wLjQuMTg7CgpwcmFnbWEgc29saWRpdHkgXjAuNC4xODsKCi8qKgogKiBAdGl0bGUgU2FmZU1hdGgKICogQGRldiBNYXRoIG9wZXJhdGlvbnMgd2l0aCBzYWZldHkgY2hlY2tzIHRoYXQgdGhyb3cgb24gZXJyb3IKICovCmxpYnJhcnkgU2FmZU1hdGggewogIGZ1bmN0aW9uIG11bCh1aW50MjU2IGEsIHVpbnQyNTYgYikgaW50ZXJuYWwgcHVyZSByZXR1cm5zICh1aW50MjU2KSB7CiAgICBpZiAoYSA9PSAwKSB7CiAgICAgIHJldHVybiAwOwogICAgfQogICAgdWludDI1NiBjID0gYSAqIGI7CiAgICBhc3NlcnQoYyAvIGEgPT0gYik7CiAgICByZXR1cm4gYzsKICB9CgogIGZ1bmN0aW9uIGRpdih1aW50MjU2IGEsIHVpbnQyNTYgYikgaW50ZXJuYWwgcHVyZSByZXR1cm5zICh1aW50MjU2KSB7CiAgICAvLyBhc3NlcnQoYiA+IDApOyAvLyBTb2xpZGl0eSBhdXRvbWF0aWNhbGx5IHRocm93cyB3aGVuIGRpdmlkaW5nIGJ5IDAKICAgIHVpbnQyNTYgYyA9IGEgLyBiOwogICAgLy8gYXNzZXJ0KGEgPT0gYiAqIGMgKyBhICUgYik7IC8vIFRoZXJlIGlzIG5vIGNhc2UgaW4gd2hpY2ggdGhpcyBkb2Vzbid0IGhvbGQKICAgIHJldHVybiBjOwogIH0KCiAgZnVuY3Rpb24gc3ViKHVpbnQyNTYgYSwgdWludDI1NiBiKSBpbnRlcm5hbCBwdXJlIHJldHVybnMgKHVpbnQyNTYpIHsKICAgIGFzc2VydChiIDw9IGEpOwogICAgcmV0dXJuIGEgLSBiOwogIH0KCiAgZnVuY3Rpb24gYWRkKHVpbnQyNTYgYSwgdWludDI1NiBiKSBpbnRlcm5hbCBwdXJlIHJldHVybnMgKHVpbnQyNTYpIHsKICAgIHVpbnQyNTYgYyA9IGEgKyBiOwogICAgYXNzZXJ0KGMgPj0gYSk7CiAgICByZXR1cm4gYzsKICB9Cn0KCnByYWdtYSBzb2xpZGl0eSBeMC40LjE4OwoKLyoqCiAqIEB0aXRsZSBTYWZlTWF0aDMyCiAqIEBkZXYgTWF0aCBvcGVyYXRpb25zIHdpdGggc2FmZXR5IGNoZWNrcyB0aGF0IHRocm93IG9uIGVycm9yCiAqIEBkZXYgQ29weSBvZiBTYWZlTWF0aCBidXQgZm9yIHVpbnQzMiBpbnN0ZWFkIG9mIHVpbnQyNTYKICogQGRldiBEZWxldGVkIGZ1bmN0aW9ucyB3ZSBkb24ndCB1c2UKICovCmxpYnJhcnkgU2FmZU1hdGgzMiB7CiAgZnVuY3Rpb24gYWRkKHVpbnQzMiBhLCB1aW50MzIgYikgaW50ZXJuYWwgcHVyZSByZXR1cm5zICh1aW50MzIpIHsKICAgIHVpbnQzMiBjID0gYSArIGI7CiAgICBhc3NlcnQoYyA+PSBhKTsKICAgIHJldHVybiBjOwogIH0KfQoKcHJhZ21hIHNvbGlkaXR5IF4wLjQuMTg7Cgpjb250cmFjdCBCYWxhbmNlSG9sZGVyIHsKCiAgICBtYXBwaW5nKGFkZHJlc3MgPT4gdWludDI1NikgcHVibGljIGJhbGFuY2VPZjsKCiAgICBldmVudCBMb2dXaXRoZHJhdygKICAgICAgICBhZGRyZXNzIGluZGV4ZWQgdXNlciwKICAgICAgICB1aW50MjU2IGFtb3VudAogICAgKTsKCiAgICBmdW5jdGlvbiB3aXRoZHJhdygpIAogICAgcHVibGljIHsKICAgICAgICB1aW50MjU2IGJhbCA9IGJhbGFuY2VPZlttc2cuc2VuZGVyXTsKICAgICAgICBiYWxhbmNlT2ZbbXNnLnNlbmRlcl0gPSAwOwogICAgICAgIG1zZy5zZW5kZXIudHJhbnNmZXIoYmFsKTsKICAgICAgICBMb2dXaXRoZHJhdyhtc2cuc2VuZGVyLCBiYWwpOwogICAgfQoKfQoKY29udHJhY3QgUmVhbGl0eUNoZWNrIGlzIEJhbGFuY2VIb2xkZXIgewoKICAgIHVzaW5nIFNhZmVNYXRoIGZvciB1aW50MjU2OwogICAgdXNpbmcgU2FmZU1hdGgzMiBmb3IgdWludDMyOwoKICAgIGFkZHJlc3MgY29uc3RhbnQgTlVMTF9BRERSRVNTID0gYWRkcmVzcygwKTsKCiAgICAvLyBIaXN0b3J5IGhhc2ggd2hlbiBubyBoaXN0b3J5IGlzIGNyZWF0ZWQsIG9yIGhpc3RvcnkgaGFzIGJlZW4gY2xlYXJlZAogICAgYnl0ZXMzMiBjb25zdGFudCBOVUxMX0hBU0ggPSBieXRlczMyKDApOwoKICAgIC8vIEFuIHVuaXRpbmFsaXplZCBmaW5hbGl6ZV90cyBmb3IgYSBxdWVzdGlvbiB3aWxsIGluZGljYXRlIGFuIHVuYW5zd2VyZWQgcXVlc3Rpb24uCiAgICB1aW50MzIgY29uc3RhbnQgVU5BTlNXRVJFRCA9IDA7CgogICAgLy8gQW4gdW5hbnN3ZXJlZCByZXZlYWxfdHMgZm9yIGEgY29tbWl0bWVudCB3aWxsIGluZGljYXRlIHRoYXQgaXQgZG9lcyBub3QgZXhpc3QuCiAgICB1aW50MjU2IGNvbnN0YW50IENPTU1JVE1FTlRfTk9OX0VYSVNURU5UID0gMDsKCiAgICAvLyBDb21taXQtPnJldmVhbCB0aW1lb3V0IGlzIDEvOCBvZiB0aGUgcXVlc3Rpb24gdGltZW91dCAocm91bmRlZCBkb3duKS4KICAgIHVpbnQzMiBjb25zdGFudCBDT01NSVRNRU5UX1RJTUVPVVRfUkFUSU8gPSA4OwoKICAgIGV2ZW50IExvZ1NldFF1ZXN0aW9uRmVlKAogICAgICAgIGFkZHJlc3MgYXJiaXRyYXRvciwKICAgICAgICB1aW50MjU2IGFtb3VudAogICAgKTsKCiAgICBldmVudCBMb2dOZXdUZW1wbGF0ZSgKICAgICAgICB1aW50MjU2IGluZGV4ZWQgdGVtcGxhdGVfaWQsCiAgICAgICAgYWRkcmVzcyBpbmRleGVkIHVzZXIsIAogICAgICAgIHN0cmluZyBxdWVzdGlvbl90ZXh0CiAgICApOwoKICAgIGV2ZW50IExvZ05ld1F1ZXN0aW9uKAogICAgICAgIGJ5dGVzMzIgaW5kZXhlZCBxdWVzdGlvbl9pZCwKICAgICAgICBhZGRyZXNzIGluZGV4ZWQgdXNlciwgCiAgICAgICAgdWludDI1NiB0ZW1wbGF0ZV9pZCwKICAgICAgICBzdHJpbmcgcXVlc3Rpb24sCiAgICAgICAgYnl0ZXMzMiBpbmRleGVkIGNvbnRlbnRfaGFzaCwKICAgICAgICBhZGRyZXNzIGFyYml0cmF0b3IsIAogICAgICAgIHVpbnQzMiB0aW1lb3V0LAogICAgICAgIHVpbnQzMiBvcGVuaW5nX3RzLAogICAgICAgIHVpbnQyNTYgbm9uY2UsCiAgICAgICAgdWludDI1NiBjcmVhdGVkCiAgICApOwoKICAgIGV2ZW50IExvZ0Z1bmRBbnN3ZXJCb3VudHkoCiAgICAgICAgYnl0ZXMzMiBpbmRleGVkIHF1ZXN0aW9uX2lkLAogICAgICAgIHVpbnQyNTYgYm91bnR5X2FkZGVkLAogICAgICAgIHVpbnQyNTYgYm91bnR5LAogICAgICAgIGFkZHJlc3MgaW5kZXhlZCB1c2VyIAogICAgKTsKCiAgICBldmVudCBMb2dOZXdBbnN3ZXIoCiAgICAgICAgYnl0ZXMzMiBhbnN3ZXIsCiAgICAgICAgYnl0ZXMzMiBpbmRleGVkIHF1ZXN0aW9uX2lkLAogICAgICAgIGJ5dGVzMzIgaGlzdG9yeV9oYXNoLAogICAgICAgIGFkZHJlc3MgaW5kZXhlZCB1c2VyLAogICAgICAgIHVpbnQyNTYgYm9uZCwKICAgICAgICB1aW50MjU2IHRzLAogICAgICAgIGJvb2wgaXNfY29tbWl0bWVudAogICAgKTsKCiAgICBldmVudCBMb2dBbnN3ZXJSZXZlYWwoCiAgICAgICAgYnl0ZXMzMiBpbmRleGVkIHF1ZXN0aW9uX2lkLCAKICAgICAgICBhZGRyZXNzIGluZGV4ZWQgdXNlciwgCiAgICAgICAgYnl0ZXMzMiBpbmRleGVkIGFuc3dlcl9oYXNoLCAKICAgICAgICBieXRlczMyIGFuc3dlciwgCiAgICAgICAgdWludDI1NiBub25jZSwgCiAgICAgICAgdWludDI1NiBib25kCiAgICApOwoKICAgIGV2ZW50IExvZ05vdGlmeU9mQXJiaXRyYXRpb25SZXF1ZXN0KAogICAgICAgIGJ5dGVzMzIgaW5kZXhlZCBxdWVzdGlvbl9pZCwKICAgICAgICBhZGRyZXNzIGluZGV4ZWQgdXNlciAKICAgICk7CgogICAgZXZlbnQgTG9nRmluYWxpemUoCiAgICAgICAgYnl0ZXMzMiBpbmRleGVkIHF1ZXN0aW9uX2lkLAogICAgICAgIGJ5dGVzMzIgaW5kZXhlZCBhbnN3ZXIKICAgICk7CgogICAgZXZlbnQgTG9nQ2xhaW0oCiAgICAgICAgYnl0ZXMzMiBpbmRleGVkIHF1ZXN0aW9uX2lkLAogICAgICAgIGFkZHJlc3MgaW5kZXhlZCB1c2VyLAogICAgICAgIHVpbnQyNTYgYW1vdW50CiAgICApOwoKICAgIHN0cnVjdCBRdWVzdGlvbiB7CiAgICAgICAgYnl0ZXMzMiBjb250ZW50X2hhc2g7CiAgICAgICAgYWRkcmVzcyBhcmJpdHJhdG9yOwogICAgICAgIHVpbnQzMiBvcGVuaW5nX3RzOwogICAgICAgIHVpbnQzMiB0aW1lb3V0OwogICAgICAgIHVpbnQzMiBmaW5hbGl6ZV90czsKICAgICAgICBib29sIGlzX3BlbmRpbmdfYXJiaXRyYXRpb247CiAgICAgICAgdWludDI1NiBib3VudHk7CiAgICAgICAgYnl0ZXMzMiBiZXN0X2Fuc3dlcjsKICAgICAgICBieXRlczMyIGhpc3RvcnlfaGFzaDsKICAgICAgICB1aW50MjU2IGJvbmQ7CiAgICB9CgogICAgLy8gU3RvcmVkIGluIGEgbWFwcGluZyBpbmRleGVkIGJ5IGNvbW1pdG1lbnRfaWQsIGEgaGFzaCBvZiBjb21taXRtZW50IGhhc2gsIHF1ZXN0aW9uLCBib25kLiAKICAgIHN0cnVjdCBDb21taXRtZW50IHsKICAgICAgICB1aW50MzIgcmV2ZWFsX3RzOwogICAgICAgIGJvb2wgaXNfcmV2ZWFsZWQ7CiAgICAgICAgYnl0ZXMzMiByZXZlYWxlZF9hbnN3ZXI7CiAgICB9CgogICAgLy8gT25seSB1c2VkIHdoZW4gY2xhaW1pbmcgbW9yZSBib25kcyB0aGFuIGZpdHMgaW50byBhIHRyYW5zYWN0aW9uCiAgICAvLyBTdG9yZWQgaW4gYSBtYXBwaW5nIGluZGV4ZWQgYnkgcXVlc3Rpb25faWQuCiAgICBzdHJ1Y3QgQ2xhaW0gewogICAgICAgIGFkZHJlc3MgcGF5ZWU7CiAgICAgICAgdWludDI1NiBsYXN0X2JvbmQ7CiAgICAgICAgdWludDI1NiBxdWV1ZWRfZnVuZHM7CiAgICB9CgogICAgdWludDI1NiBuZXh0VGVtcGxhdGVJRCA9IDA7CiAgICBtYXBwaW5nKHVpbnQyNTYgPT4gdWludDI1NikgcHVibGljIHRlbXBsYXRlczsKICAgIG1hcHBpbmcoYnl0ZXMzMiA9PiBRdWVzdGlvbikgcHVibGljIHF1ZXN0aW9uczsKICAgIG1hcHBpbmcoYnl0ZXMzMiA9PiBDbGFpbSkgcXVlc3Rpb25fY2xhaW1zOwogICAgbWFwcGluZyhieXRlczMyID0+IENvbW1pdG1lbnQpIHB1YmxpYyBjb21taXRtZW50czsKICAgIG1hcHBpbmcoYWRkcmVzcyA9PiB1aW50MjU2KSBwdWJsaWMgYXJiaXRyYXRvcl9xdWVzdGlvbl9mZWVzOyAKCiAgICBtb2RpZmllciBvbmx5QXJiaXRyYXRvcihieXRlczMyIHF1ZXN0aW9uX2lkKSB7CiAgICAgICAgcmVxdWlyZShtc2cuc2VuZGVyID09IHF1ZXN0aW9uc1txdWVzdGlvbl9pZF0uYXJiaXRyYXRvcik7CiAgICAgICAgXzsKICAgIH0KCiAgICBtb2RpZmllciBzdGF0ZUFueSgpIHsKICAgICAgICBfOwogICAgfQoKICAgIG1vZGlmaWVyIHN0YXRlTm90Q3JlYXRlZChieXRlczMyIHF1ZXN0aW9uX2lkKSB7CiAgICAgICAgcmVxdWlyZShxdWVzdGlvbnNbcXVlc3Rpb25faWRdLnRpbWVvdXQgPT0gMCk7CiAgICAgICAgXzsKICAgIH0KCiAgICBtb2RpZmllciBzdGF0ZU9wZW4oYnl0ZXMzMiBxdWVzdGlvbl9pZCkgewogICAgICAgIHJlcXVpcmUocXVlc3Rpb25zW3F1ZXN0aW9uX2lkXS50aW1lb3V0ID4gMCk7IC8vIENoZWNrIGV4aXN0ZW5jZQogICAgICAgIHJlcXVpcmUoIXF1ZXN0aW9uc1txdWVzdGlvbl9pZF0uaXNfcGVuZGluZ19hcmJpdHJhdGlvbik7CiAgICAgICAgdWludDMyIGZpbmFsaXplX3RzID0gcXVlc3Rpb25zW3F1ZXN0aW9uX2lkXS5maW5hbGl6ZV90czsKICAgICAgICByZXF1aXJlKGZpbmFsaXplX3RzID09IFVOQU5TV0VSRUQgfHwgZmluYWxpemVfdHMgPiB1aW50MzIobm93KSk7CiAgICAgICAgdWludDMyIG9wZW5pbmdfdHMgPSBxdWVzdGlvbnNbcXVlc3Rpb25faWRdLm9wZW5pbmdfdHM7CiAgICAgICAgcmVxdWlyZShvcGVuaW5nX3RzID09IDAgfHwgb3BlbmluZ190cyA8PSB1aW50MzIobm93KSk7IAogICAgICAgIF87CiAgICB9CgogICAgbW9kaWZpZXIgc3RhdGVQZW5kaW5nQXJiaXRyYXRpb24oYnl0ZXMzMiBxdWVzdGlvbl9pZCkgewogICAgICAgIHJlcXVpcmUocXVlc3Rpb25zW3F1ZXN0aW9uX2lkXS5pc19wZW5kaW5nX2FyYml0cmF0aW9uKTsKICAgICAgICBfOwogICAgfQoKICAgIG1vZGlmaWVyIHN0YXRlRmluYWxpemVkKGJ5dGVzMzIgcXVlc3Rpb25faWQpIHsKICAgICAgICByZXF1aXJlKGlzRmluYWxpemVkKHF1ZXN0aW9uX2lkKSk7CiAgICAgICAgXzsKICAgIH0KCiAgICBtb2RpZmllciBib25kTXVzdEJlWmVybygpIHsKICAgICAgICByZXF1aXJlKG1zZy52YWx1ZSA9PSAwKTsKICAgICAgICBfOwogICAgfQoKICAgIG1vZGlmaWVyIGJvbmRNdXN0RG91YmxlKGJ5dGVzMzIgcXVlc3Rpb25faWQpIHsKICAgICAgICByZXF1aXJlKG1zZy52YWx1ZSA+IDApOyAKICAgICAgICByZXF1aXJlKG1zZy52YWx1ZSA+PSAocXVlc3Rpb25zW3F1ZXN0aW9uX2lkXS5ib25kLm11bCgyKSkpOwogICAgICAgIF87CiAgICB9CgogICAgbW9kaWZpZXIgcHJldmlvdXNCb25kTXVzdE5vdEJlYXRNYXhQcmV2aW91cyhieXRlczMyIHF1ZXN0aW9uX2lkLCB1aW50MjU2IG1heF9wcmV2aW91cykgewogICAgICAgIGlmIChtYXhfcHJldmlvdXMgPiAwKSB7CiAgICAgICAgICAgIHJlcXVpcmUocXVlc3Rpb25zW3F1ZXN0aW9uX2lkXS5ib25kIDw9IG1heF9wcmV2aW91cyk7CiAgICAgICAgfQogICAgICAgIF87CiAgICB9CgogICAgLy8vIEBub3RpY2UgQ29uc3RydWN0b3IsIHNldHMgdXAgc29tZSBpbml0aWFsIHRlbXBsYXRlcwogICAgLy8vIEBkZXYgQ3JlYXRlcyBzb21lIGdlbmVyYWxpemVkIHRlbXBsYXRlcyBmb3IgZGlmZmVyZW50IHF1ZXN0aW9uIHR5cGVzIHVzZWQgaW4gdGhlIERBcHAuCiAgICBmdW5jdGlvbiBSZWFsaXR5Q2hlY2soKSAKICAgIHB1YmxpYyB7CiAgICAgICAgY3JlYXRlVGVtcGxhdGUoJ3sidGl0bGUiOiAiJXMiLCAidHlwZSI6ICJib29sIiwgImNhdGVnb3J5IjogIiVzIn0nKTsKICAgICAgICBjcmVhdGVUZW1wbGF0ZSgneyJ0aXRsZSI6ICIlcyIsICJ0eXBlIjogInVpbnQiLCAiZGVjaW1hbHMiOiAxOCwgImNhdGVnb3J5IjogIiVzIn0nKTsKICAgICAgICBjcmVhdGVUZW1wbGF0ZSgneyJ0aXRsZSI6ICIlcyIsICJ0eXBlIjogImludCIsICJkZWNpbWFscyI6IDE4LCAiY2F0ZWdvcnkiOiAiJXMifScpOwogICAgICAgIGNyZWF0ZVRlbXBsYXRlKCd7InRpdGxlIjogIiVzIiwgInR5cGUiOiAic2luZ2xlLXNlbGVjdCIsICJvdXRjb21lcyI6IFslc10sICJjYXRlZ29yeSI6ICIlcyJ9Jyk7CiAgICAgICAgY3JlYXRlVGVtcGxhdGUoJ3sidGl0bGUiOiAiJXMiLCAidHlwZSI6ICJtdWx0aXBsZS1zZWxlY3QiLCAib3V0Y29tZXMiOiBbJXNdLCAiY2F0ZWdvcnkiOiAiJXMifScpOwogICAgICAgIGNyZWF0ZVRlbXBsYXRlKCd7InRpdGxlIjogIiVzIiwgInR5cGUiOiAiZGF0ZXRpbWUiLCAiY2F0ZWdvcnkiOiAiJXMifScpOwogICAgfQoKICAgIC8vLyBAbm90aWNlIEZ1bmN0aW9uIGZvciBhcmJpdHJhdG9yIHRvIHNldCBhbiBvcHRpb25hbCBwZXItcXVlc3Rpb24gZmVlLiAKICAgIC8vLyBAZGV2IFRoZSBwZXItcXVlc3Rpb24gZmVlLCBjaGFyZ2VkIHdoZW4gYSBxdWVzdGlvbiBpcyBhc2tlZCwgaXMgaW50ZW5kZWQgYXMgYW4gYW50aS1zcGFtIG1lYXN1cmUuCiAgICAvLy8gQHBhcmFtIGZlZSBUaGUgZmVlIHRvIGJlIGNoYXJnZWQgYnkgdGhlIGFyYml0cmF0b3Igd2hlbiBhIHF1ZXN0aW9uIGlzIGFza2VkCiAgICBmdW5jdGlvbiBzZXRRdWVzdGlvbkZlZSh1aW50MjU2IGZlZSkgCiAgICAgICAgc3RhdGVBbnkoKSAKICAgIGV4dGVybmFsIHsKICAgICAgICBhcmJpdHJhdG9yX3F1ZXN0aW9uX2ZlZXNbbXNnLnNlbmRlcl0gPSBmZWU7CiAgICAgICAgTG9nU2V0UXVlc3Rpb25GZWUobXNnLnNlbmRlciwgZmVlKTsKICAgIH0KCiAgICAvLy8gQG5vdGljZSBDcmVhdGUgYSByZXVzYWJsZSB0ZW1wbGF0ZSwgd2hpY2ggc2hvdWxkIGJlIGEgSlNPTiBkb2N1bWVudC4KICAgIC8vLyBQbGFjZWhvbGRlcnMgc2hvdWxkIHVzZSBnZXR0ZXh0KCkgc3ludGF4LCBlZyAlcy4KICAgIC8vLyBAZGV2IFRlbXBsYXRlIGRhdGEgaXMgb25seSBzdG9yZWQgaW4gdGhlIGV2ZW50IGxvZ3MsIGJ1dCBpdHMgYmxvY2sgbnVtYmVyIGlzIGtlcHQgaW4gY29udHJhY3Qgc3RvcmFnZS4KICAgIC8vLyBAcGFyYW0gY29udGVudCBUaGUgdGVtcGxhdGUgY29udGVudAogICAgLy8vIEByZXR1cm4gVGhlIElEIG9mIHRoZSBuZXdseS1jcmVhdGVkIHRlbXBsYXRlLCB3aGljaCBpcyBjcmVhdGVkIHNlcXVlbnRpYWxseS4KICAgIGZ1bmN0aW9uIGNyZWF0ZVRlbXBsYXRlKHN0cmluZyBjb250ZW50KSAKICAgICAgICBzdGF0ZUFueSgpCiAgICBwdWJsaWMgcmV0dXJucyAodWludDI1NikgewogICAgICAgIHVpbnQyNTYgaWQgPSBuZXh0VGVtcGxhdGVJRDsKICAgICAgICB0ZW1wbGF0ZXNbaWRdID0gYmxvY2subnVtYmVyOwogICAgICAgIExvZ05ld1RlbXBsYXRlKGlkLCBtc2cuc2VuZGVyLCBjb250ZW50KTsKICAgICAgICBuZXh0VGVtcGxhdGVJRCA9IGlkLmFkZCgxKTsKICAgICAgICByZXR1cm4gaWQ7CiAgICB9CgogICAgLy8vIEBub3RpY2UgQ3JlYXRlIGEgbmV3IHJldXNhYmxlIHRlbXBsYXRlIGFuZCB1c2UgaXQgdG8gYXNrIGEgcXVlc3Rpb24KICAgIC8vLyBAZGV2IFRlbXBsYXRlIGRhdGEgaXMgb25seSBzdG9yZWQgaW4gdGhlIGV2ZW50IGxvZ3MsIGJ1dCBpdHMgYmxvY2sgbnVtYmVyIGlzIGtlcHQgaW4gY29udHJhY3Qgc3RvcmFnZS4KICAgIC8vLyBAcGFyYW0gY29udGVudCBUaGUgdGVtcGxhdGUgY29udGVudAogICAgLy8vIEBwYXJhbSBxdWVzdGlvbiBBIHN0cmluZyBjb250YWluaW5nIHRoZSBwYXJhbWV0ZXJzIHRoYXQgd2lsbCBiZSBwYXNzZWQgaW50byB0aGUgdGVtcGxhdGUgdG8gbWFrZSB0aGUgcXVlc3Rpb24KICAgIC8vLyBAcGFyYW0gYXJiaXRyYXRvciBUaGUgYXJiaXRyYXRpb24gY29udHJhY3QgdGhhdCB3aWxsIGhhdmUgdGhlIGZpbmFsIHdvcmQgb24gdGhlIGFuc3dlciBpZiB0aGVyZSBpcyBhIGRpc3B1dGUKICAgIC8vLyBAcGFyYW0gdGltZW91dCBIb3cgbG9uZyB0aGUgY29udHJhY3Qgc2hvdWxkIHdhaXQgYWZ0ZXIgdGhlIGFuc3dlciBpcyBjaGFuZ2VkIGJlZm9yZSBmaW5hbGl6aW5nIG9uIHRoYXQgYW5zd2VyCiAgICAvLy8gQHBhcmFtIG9wZW5pbmdfdHMgSWYgc2V0LCB0aGUgZWFybGllc3QgdGltZSBpdCBzaG91bGQgYmUgcG9zc2libGUgdG8gYW5zd2VyIHRoZSBxdWVzdGlvbi4KICAgIC8vLyBAcGFyYW0gbm9uY2UgQSB1c2VyLXNwZWNpZmllZCBub25jZSB1c2VkIGluIHRoZSBxdWVzdGlvbiBJRC4gQ2hhbmdlIGl0IHRvIHJlcGVhdCBhIHF1ZXN0aW9uLgogICAgLy8vIEByZXR1cm4gVGhlIElEIG9mIHRoZSBuZXdseS1jcmVhdGVkIHRlbXBsYXRlLCB3aGljaCBpcyBjcmVhdGVkIHNlcXVlbnRpYWxseS4KICAgIGZ1bmN0aW9uIGNyZWF0ZVRlbXBsYXRlQW5kQXNrUXVlc3Rpb24oCiAgICAgICAgc3RyaW5nIGNvbnRlbnQsIAogICAgICAgIHN0cmluZyBxdWVzdGlvbiwgYWRkcmVzcyBhcmJpdHJhdG9yLCB1aW50MzIgdGltZW91dCwgdWludDMyIG9wZW5pbmdfdHMsIHVpbnQyNTYgbm9uY2UgCiAgICApIAogICAgICAgIC8vIHN0YXRlTm90Q3JlYXRlZCBpcyBlbmZvcmNlZCBieSB0aGUgaW50ZXJuYWwgX2Fza1F1ZXN0aW9uCiAgICBwdWJsaWMgcGF5YWJsZSByZXR1cm5zIChieXRlczMyKSB7CiAgICAgICAgdWludDI1NiB0ZW1wbGF0ZV9pZCA9IGNyZWF0ZVRlbXBsYXRlKGNvbnRlbnQpOwogICAgICAgIHJldHVybiBhc2tRdWVzdGlvbih0ZW1wbGF0ZV9pZCwgcXVlc3Rpb24sIGFyYml0cmF0b3IsIHRpbWVvdXQsIG9wZW5pbmdfdHMsIG5vbmNlKTsKICAgIH0KCiAgICAvLy8gQG5vdGljZSBBc2sgYSBuZXcgcXVlc3Rpb24gYW5kIHJldHVybiB0aGUgSUQKICAgIC8vLyBAZGV2IFRlbXBsYXRlIGRhdGEgaXMgb25seSBzdG9yZWQgaW4gdGhlIGV2ZW50IGxvZ3MsIGJ1dCBpdHMgYmxvY2sgbnVtYmVyIGlzIGtlcHQgaW4gY29udHJhY3Qgc3RvcmFnZS4KICAgIC8vLyBAcGFyYW0gdGVtcGxhdGVfaWQgVGhlIElEIG51bWJlciBvZiB0aGUgdGVtcGxhdGUgdGhlIHF1ZXN0aW9uIHdpbGwgdXNlCiAgICAvLy8gQHBhcmFtIHF1ZXN0aW9uIEEgc3RyaW5nIGNvbnRhaW5pbmcgdGhlIHBhcmFtZXRlcnMgdGhhdCB3aWxsIGJlIHBhc3NlZCBpbnRvIHRoZSB0ZW1wbGF0ZSB0byBtYWtlIHRoZSBxdWVzdGlvbgogICAgLy8vIEBwYXJhbSBhcmJpdHJhdG9yIFRoZSBhcmJpdHJhdGlvbiBjb250cmFjdCB0aGF0IHdpbGwgaGF2ZSB0aGUgZmluYWwgd29yZCBvbiB0aGUgYW5zd2VyIGlmIHRoZXJlIGlzIGEgZGlzcHV0ZQogICAgLy8vIEBwYXJhbSB0aW1lb3V0IEhvdyBsb25nIHRoZSBjb250cmFjdCBzaG91bGQgd2FpdCBhZnRlciB0aGUgYW5zd2VyIGlzIGNoYW5nZWQgYmVmb3JlIGZpbmFsaXppbmcgb24gdGhhdCBhbnN3ZXIKICAgIC8vLyBAcGFyYW0gb3BlbmluZ190cyBJZiBzZXQsIHRoZSBlYXJsaWVzdCB0aW1lIGl0IHNob3VsZCBiZSBwb3NzaWJsZSB0byBhbnN3ZXIgdGhlIHF1ZXN0aW9uLgogICAgLy8vIEBwYXJhbSBub25jZSBBIHVzZXItc3BlY2lmaWVkIG5vbmNlIHVzZWQgaW4gdGhlIHF1ZXN0aW9uIElELiBDaGFuZ2UgaXQgdG8gcmVwZWF0IGEgcXVlc3Rpb24uCiAgICAvLy8gQHJldHVybiBUaGUgSUQgb2YgdGhlIG5ld2x5LWNyZWF0ZWQgcXVlc3Rpb24sIGNyZWF0ZWQgZGV0ZXJtaW5pc3RpY2FsbHkuCiAgICBmdW5jdGlvbiBhc2tRdWVzdGlvbih1aW50MjU2IHRlbXBsYXRlX2lkLCBzdHJpbmcgcXVlc3Rpb24sIGFkZHJlc3MgYXJiaXRyYXRvciwgdWludDMyIHRpbWVvdXQsIHVpbnQzMiBvcGVuaW5nX3RzLCB1aW50MjU2IG5vbmNlKSAKICAgICAgICAvLyBzdGF0ZU5vdENyZWF0ZWQgaXMgZW5mb3JjZWQgYnkgdGhlIGludGVybmFsIF9hc2tRdWVzdGlvbgogICAgcHVibGljIHBheWFibGUgcmV0dXJucyAoYnl0ZXMzMikgewoKICAgICAgICByZXF1aXJlKHRlbXBsYXRlc1t0ZW1wbGF0ZV9pZF0gPiAwKTsgLy8gVGVtcGxhdGUgbXVzdCBleGlzdAoKICAgICAgICBieXRlczMyIGNvbnRlbnRfaGFzaCA9IGtlY2NhazI1Nih0ZW1wbGF0ZV9pZCwgb3BlbmluZ190cywgcXVlc3Rpb24pOwogICAgICAgIGJ5dGVzMzIgcXVlc3Rpb25faWQgPSBrZWNjYWsyNTYoY29udGVudF9oYXNoLCBhcmJpdHJhdG9yLCB0aW1lb3V0LCBtc2cuc2VuZGVyLCBub25jZSk7CgogICAgICAgIF9hc2tRdWVzdGlvbihxdWVzdGlvbl9pZCwgY29udGVudF9oYXNoLCBhcmJpdHJhdG9yLCB0aW1lb3V0LCBvcGVuaW5nX3RzKTsKICAgICAgICBMb2dOZXdRdWVzdGlvbihxdWVzdGlvbl9pZCwgbXNnLnNlbmRlciwgdGVtcGxhdGVfaWQsIHF1ZXN0aW9uLCBjb250ZW50X2hhc2gsIGFyYml0cmF0b3IsIHRpbWVvdXQsIG9wZW5pbmdfdHMsIG5vbmNlLCBub3cpOwoKICAgICAgICByZXR1cm4gcXVlc3Rpb25faWQ7CiAgICB9CgogICAgZnVuY3Rpb24gX2Fza1F1ZXN0aW9uKGJ5dGVzMzIgcXVlc3Rpb25faWQsIGJ5dGVzMzIgY29udGVudF9oYXNoLCBhZGRyZXNzIGFyYml0cmF0b3IsIHVpbnQzMiB0aW1lb3V0LCB1aW50MzIgb3BlbmluZ190cykgCiAgICAgICAgc3RhdGVOb3RDcmVhdGVkKHF1ZXN0aW9uX2lkKQogICAgaW50ZXJuYWwgewoKICAgICAgICAvLyBBIHRpbWVvdXQgb2YgMCBtYWtlcyBubyBzZW5zZSwgYW5kIHdlIHdpbGwgdXNlIHRoaXMgdG8gY2hlY2sgZXhpc3RlbmNlCiAgICAgICAgcmVxdWlyZSh0aW1lb3V0ID4gMCk7IAogICAgICAgIHJlcXVpcmUodGltZW91dCA8IDM2NSBkYXlzKTsgCiAgICAgICAgcmVxdWlyZShhcmJpdHJhdG9yICE9IE5VTExfQUREUkVTUyk7CgogICAgICAgIHVpbnQyNTYgYm91bnR5ID0gbXNnLnZhbHVlOwoKICAgICAgICAvLyBUaGUgYXJiaXRyYXRvciBjYW4gc2V0IGEgZmVlIGZvciBhc2tpbmcgYSBxdWVzdGlvbi4gCiAgICAgICAgLy8gVGhpcyBpcyBpbnRlbmRlZCBhcyBhbiBhbnRpLXNwYW0gZGVmZW5jZS4KICAgICAgICAvLyBUaGUgZmVlIGlzIHdhaXZlZCBpZiB0aGUgYXJiaXRyYXRvciBpcyBhc2tpbmcgdGhlIHF1ZXN0aW9uLgogICAgICAgIC8vIFRoaXMgYWxsb3dzIHRoZW0gdG8gc2V0IGFuIGltcG9zc2libHkgaGlnaCBmZWUgYW5kIG1ha2UgdXNlcnMgcHJveHkgdGhlIHF1ZXN0aW9uIHRocm91Z2ggdGhlbS4KICAgICAgICAvLyBUaGlzIHdvdWxkIGFsbG93IG1vcmUgc29waGlzdGljYXRlZCBwcmljaW5nLCBxdWVzdGlvbiB3aGl0ZWxpc3RpbmcgZXRjLgogICAgICAgIGlmIChtc2cuc2VuZGVyICE9IGFyYml0cmF0b3IpIHsKICAgICAgICAgICAgdWludDI1NiBxdWVzdGlvbl9mZWUgPSBhcmJpdHJhdG9yX3F1ZXN0aW9uX2ZlZXNbYXJiaXRyYXRvcl07CiAgICAgICAgICAgIHJlcXVpcmUoYm91bnR5ID49IHF1ZXN0aW9uX2ZlZSk7IAogICAgICAgICAgICBib3VudHkgPSBib3VudHkuc3ViKHF1ZXN0aW9uX2ZlZSk7CiAgICAgICAgICAgIGJhbGFuY2VPZlthcmJpdHJhdG9yXSA9IGJhbGFuY2VPZlthcmJpdHJhdG9yXS5hZGQocXVlc3Rpb25fZmVlKTsKICAgICAgICB9CgogICAgICAgIHF1ZXN0aW9uc1txdWVzdGlvbl9pZF0uY29udGVudF9oYXNoID0gY29udGVudF9oYXNoOwogICAgICAgIHF1ZXN0aW9uc1txdWVzdGlvbl9pZF0uYXJiaXRyYXRvciA9IGFyYml0cmF0b3I7CiAgICAgICAgcXVlc3Rpb25zW3F1ZXN0aW9uX2lkXS5vcGVuaW5nX3RzID0gb3BlbmluZ190czsKICAgICAgICBxdWVzdGlvbnNbcXVlc3Rpb25faWRdLnRpbWVvdXQgPSB0aW1lb3V0OwogICAgICAgIHF1ZXN0aW9uc1txdWVzdGlvbl9pZF0uYm91bnR5ID0gYm91bnR5OwoKICAgIH0KCiAgICAvLy8gQG5vdGljZSBBZGQgZnVuZHMgdG8gdGhlIGJvdW50eSBmb3IgYSBxdWVzdGlvbgogICAgLy8vIEBkZXYgQWRkIGJvdW50eSBmdW5kcyBhZnRlciB0aGUgaW5pdGlhbCBxdWVzdGlvbiBjcmVhdGlvbi4gQ2FuIGJlIGRvbmUgYW55IHRpbWUgdW50aWwgdGhlIHF1ZXN0aW9uIGlzIGZpbmFsaXplZC4KICAgIC8vLyBAcGFyYW0gcXVlc3Rpb25faWQgVGhlIElEIG9mIHRoZSBxdWVzdGlvbiB5b3Ugd2lzaCB0byBmdW5kCiAgICBmdW5jdGlvbiBmdW5kQW5zd2VyQm91bnR5KGJ5dGVzMzIgcXVlc3Rpb25faWQpIAogICAgICAgIHN0YXRlT3BlbihxdWVzdGlvbl9pZCkKICAgIGV4dGVybmFsIHBheWFibGUgewogICAgICAgIHF1ZXN0aW9uc1txdWVzdGlvbl9pZF0uYm91bnR5ID0gcXVlc3Rpb25zW3F1ZXN0aW9uX2lkXS5ib3VudHkuYWRkKG1zZy52YWx1ZSk7CiAgICAgICAgTG9nRnVuZEFuc3dlckJvdW50eShxdWVzdGlvbl9pZCwgbXNnLnZhbHVlLCBxdWVzdGlvbnNbcXVlc3Rpb25faWRdLmJvdW50eSwgbXNnLnNlbmRlcik7CiAgICB9CgogICAgLy8vIEBub3RpY2UgU3VibWl0IGFuIGFuc3dlciBmb3IgYSBxdWVzdGlvbi4KICAgIC8vLyBAZGV2IEFkZHMgdGhlIGFuc3dlciB0byB0aGUgaGlzdG9yeSBhbmQgdXBkYXRlcyB0aGUgY3VycmVudCAiYmVzdCIgYW5zd2VyLgogICAgLy8vIE1heSBiZSBzdWJqZWN0IHRvIGZyb250LXJ1bm5pbmcgYXR0YWNrczsgU3Vic3RpdHV0ZSBzdWJtaXRBbnN3ZXJDb21taXRtZW50KCktPnN1Ym1pdEFuc3dlclJldmVhbCgpIHRvIHByZXZlbnQgdGhlbS4KICAgIC8vLyBAcGFyYW0gcXVlc3Rpb25faWQgVGhlIElEIG9mIHRoZSBxdWVzdGlvbgogICAgLy8vIEBwYXJhbSBhbnN3ZXIgVGhlIGFuc3dlciwgZW5jb2RlZCBpbnRvIGJ5dGVzMzIKICAgIC8vLyBAcGFyYW0gbWF4X3ByZXZpb3VzIElmIHNwZWNpZmllZCwgcmV2ZXJ0cyBpZiBhIGJvbmQgaGlnaGVyIHRoYW4gdGhpcyB3YXMgc3VibWl0dGVkIGFmdGVyIHlvdSBzZW50IHlvdXIgdHJhbnNhY3Rpb24uCiAgICBmdW5jdGlvbiBzdWJtaXRBbnN3ZXIoYnl0ZXMzMiBxdWVzdGlvbl9pZCwgYnl0ZXMzMiBhbnN3ZXIsIHVpbnQyNTYgbWF4X3ByZXZpb3VzKSAKICAgICAgICBzdGF0ZU9wZW4ocXVlc3Rpb25faWQpCiAgICAgICAgYm9uZE11c3REb3VibGUocXVlc3Rpb25faWQpCiAgICAgICAgcHJldmlvdXNCb25kTXVzdE5vdEJlYXRNYXhQcmV2aW91cyhxdWVzdGlvbl9pZCwgbWF4X3ByZXZpb3VzKQogICAgZXh0ZXJuYWwgcGF5YWJsZSB7CiAgICAgICAgX2FkZEFuc3dlclRvSGlzdG9yeShxdWVzdGlvbl9pZCwgYW5zd2VyLCBtc2cuc2VuZGVyLCBtc2cudmFsdWUsIGZhbHNlKTsKICAgICAgICBfdXBkYXRlQ3VycmVudEFuc3dlcihxdWVzdGlvbl9pZCwgYW5zd2VyLCBxdWVzdGlvbnNbcXVlc3Rpb25faWRdLnRpbWVvdXQpOwogICAgfQoKICAgIC8vLyBAbm90aWNlIFN1Ym1pdCB0aGUgaGFzaCBvZiBhbiBhbnN3ZXIsIGxheWluZyB5b3VyIGNsYWltIHRvIHRoYXQgYW5zd2VyIGlmIHlvdSByZXZlYWwgaXQgaW4gYSBzdWJzZXF1ZW50IHRyYW5zYWN0aW9uLgogICAgLy8vIEBkZXYgQ3JlYXRlcyBhIGhhc2gsIGNvbW1pdG1lbnRfaWQsIHVuaXF1ZWx5IGlkZW50aWZ5aW5nIHRoaXMgYW5zd2VyLCB0byB0aGlzIHF1ZXN0aW9uLCB3aXRoIHRoaXMgYm9uZC4KICAgIC8vLyBUaGUgY29tbWl0bWVudF9pZCBpcyBzdG9yZWQgaW4gdGhlIGFuc3dlciBoaXN0b3J5IHdoZXJlIHRoZSBhbnN3ZXIgd291bGQgbm9ybWFsbHkgZ28uCiAgICAvLy8gRG9lcyBub3QgdXBkYXRlIHRoZSBjdXJyZW50IGJlc3QgYW5zd2VyIC0gdGhpcyBpcyBsZWZ0IHRvIHRoZSBsYXRlciBzdWJtaXRBbnN3ZXJSZXZlYWwoKSB0cmFuc2FjdGlvbi4KICAgIC8vLyBAcGFyYW0gcXVlc3Rpb25faWQgVGhlIElEIG9mIHRoZSBxdWVzdGlvbgogICAgLy8vIEBwYXJhbSBhbnN3ZXJfaGFzaCBUaGUgaGFzaCBvZiB5b3VyIGFuc3dlciwgcGx1cyBhIG5vbmNlIHRoYXQgeW91IHdpbGwgbGF0ZXIgcmV2ZWFsCiAgICAvLy8gQHBhcmFtIG1heF9wcmV2aW91cyBJZiBzcGVjaWZpZWQsIHJldmVydHMgaWYgYSBib25kIGhpZ2hlciB0aGFuIHRoaXMgd2FzIHN1Ym1pdHRlZCBhZnRlciB5b3Ugc2VudCB5b3VyIHRyYW5zYWN0aW9uLgogICAgLy8vIEBwYXJhbSBfYW5zd2VyZXIgSWYgc3BlY2lmaWVkLCB0aGUgYWRkcmVzcyB0byBiZSBnaXZlbiBhcyB0aGUgcXVlc3Rpb24gYW5zd2VyZXIuIERlZmF1bHRzIHRvIHRoZSBzZW5kZXIuCiAgICAvLy8gQGRldiBTcGVjaWZ5aW5nIHRoZSBhbnN3ZXJlciBpcyB1c2VmdWwgaWYgeW91IHdhbnQgdG8gZGVsZWdhdGUgdGhlIGNvbW1pdC1hbmQtcmV2ZWFsIHRvIGEgdGhpcmQtcGFydHkuCiAgICBmdW5jdGlvbiBzdWJtaXRBbnN3ZXJDb21taXRtZW50KGJ5dGVzMzIgcXVlc3Rpb25faWQsIGJ5dGVzMzIgYW5zd2VyX2hhc2gsIHVpbnQyNTYgbWF4X3ByZXZpb3VzLCBhZGRyZXNzIF9hbnN3ZXJlcikgCiAgICAgICAgc3RhdGVPcGVuKHF1ZXN0aW9uX2lkKQogICAgICAgIGJvbmRNdXN0RG91YmxlKHF1ZXN0aW9uX2lkKQogICAgICAgIHByZXZpb3VzQm9uZE11c3ROb3RCZWF0TWF4UHJldmlvdXMocXVlc3Rpb25faWQsIG1heF9wcmV2aW91cykKICAgIGV4dGVybmFsIHBheWFibGUgewoKICAgICAgICBieXRlczMyIGNvbW1pdG1lbnRfaWQgPSBrZWNjYWsyNTYocXVlc3Rpb25faWQsIGFuc3dlcl9oYXNoLCBtc2cudmFsdWUpOwogICAgICAgIGFkZHJlc3MgYW5zd2VyZXIgPSAoX2Fuc3dlcmVyID09IE5VTExfQUREUkVTUykgPyBtc2cuc2VuZGVyIDogX2Fuc3dlcmVyOwoKICAgICAgICByZXF1aXJlKGNvbW1pdG1lbnRzW2NvbW1pdG1lbnRfaWRdLnJldmVhbF90cyA9PSBDT01NSVRNRU5UX05PTl9FWElTVEVOVCk7CgogICAgICAgIHVpbnQzMiBjb21taXRtZW50X3RpbWVvdXQgPSBxdWVzdGlvbnNbcXVlc3Rpb25faWRdLnRpbWVvdXQgLyBDT01NSVRNRU5UX1RJTUVPVVRfUkFUSU87CiAgICAgICAgY29tbWl0bWVudHNbY29tbWl0bWVudF9pZF0ucmV2ZWFsX3RzID0gdWludDMyKG5vdykuYWRkKGNvbW1pdG1lbnRfdGltZW91dCk7CgogICAgICAgIF9hZGRBbnN3ZXJUb0hpc3RvcnkocXVlc3Rpb25faWQsIGNvbW1pdG1lbnRfaWQsIGFuc3dlcmVyLCBtc2cudmFsdWUsIHRydWUpOwoKICAgIH0KCiAgICAvLy8gQG5vdGljZSBTdWJtaXQgdGhlIGFuc3dlciB3aG9zZSBoYXNoIHlvdSBzZW50IGluIGEgcHJldmlvdXMgc3VibWl0QW5zd2VyQ29tbWl0bWVudCgpIHRyYW5zYWN0aW9uCiAgICAvLy8gQGRldiBDaGVja3MgdGhlIHBhcmFtZXRlcnMgc3VwcGxpZWQgcmVjcmVhdGUgYW4gZXhpc3RpbmcgY29tbWl0bWVudCwgYW5kIHN0b3JlcyB0aGUgcmV2ZWFsZWQgYW5zd2VyCiAgICAvLy8gVXBkYXRlcyB0aGUgY3VycmVudCBhbnN3ZXIgdW5sZXNzIHNvbWVvbmUgaGFzIHNpbmNlIHN1cHBsaWVkIGEgbmV3IGFuc3dlciB3aXRoIGEgaGlnaGVyIGJvbmQKICAgIC8vLyBtc2cuc2VuZGVyIGlzIGludGVudGlvbmFsbHkgbm90IHJlc3RyaWN0ZWQgdG8gdGhlIHVzZXIgd2hvIG9yaWdpbmFsbHkgc2VudCB0aGUgY29tbWl0bWVudDsgCiAgICAvLy8gRm9yIGV4YW1wbGUsIHRoZSB1c2VyIG1heSB3YW50IHRvIHByb3ZpZGUgdGhlIGFuc3dlcitub25jZSB0byBhIHRoaXJkLXBhcnR5IHNlcnZpY2UgYW5kIGxldCB0aGVtIHNlbmQgdGhlIHR4CiAgICAvLy8gQHBhcmFtIHF1ZXN0aW9uX2lkIFRoZSBJRCBvZiB0aGUgcXVlc3Rpb24KICAgIC8vLyBAcGFyYW0gYW5zd2VyIFRoZSBhbnN3ZXIsIGVuY29kZWQgYXMgYnl0ZXMzMgogICAgLy8vIEBwYXJhbSBub25jZSBUaGUgbm9uY2UgdGhhdCwgY29tYmluZWQgd2l0aCB0aGUgYW5zd2VyLCByZWNyZWF0ZXMgdGhlIGFuc3dlcl9oYXNoIHlvdSBnYXZlIGluIHN1Ym1pdEFuc3dlckNvbW1pdG1lbnQoKQogICAgLy8vIEBwYXJhbSBib25kIFRoZSBib25kIHRoYXQgeW91IHBhaWQgaW4geW91ciBzdWJtaXRBbnN3ZXJDb21taXRtZW50KCkgdHJhbnNhY3Rpb24KICAgIGZ1bmN0aW9uIHN1Ym1pdEFuc3dlclJldmVhbChieXRlczMyIHF1ZXN0aW9uX2lkLCBieXRlczMyIGFuc3dlciwgdWludDI1NiBub25jZSwgdWludDI1NiBib25kKSAKICAgICAgICBzdGF0ZU9wZW4ocXVlc3Rpb25faWQpCiAgICBleHRlcm5hbCB7CgogICAgICAgIGJ5dGVzMzIgYW5zd2VyX2hhc2ggPSBrZWNjYWsyNTYoYW5zd2VyLCBub25jZSk7CiAgICAgICAgYnl0ZXMzMiBjb21taXRtZW50X2lkID0ga2VjY2FrMjU2KHF1ZXN0aW9uX2lkLCBhbnN3ZXJfaGFzaCwgYm9uZCk7CgogICAgICAgIHJlcXVpcmUoIWNvbW1pdG1lbnRzW2NvbW1pdG1lbnRfaWRdLmlzX3JldmVhbGVkKTsKICAgICAgICByZXF1aXJlKGNvbW1pdG1lbnRzW2NvbW1pdG1lbnRfaWRdLnJldmVhbF90cyA+IHVpbnQzMihub3cpKTsgLy8gUmV2ZWFsIGRlYWRsaW5lIG11c3Qgbm90IGhhdmUgcGFzc2VkCgogICAgICAgIGNvbW1pdG1lbnRzW2NvbW1pdG1lbnRfaWRdLnJldmVhbGVkX2Fuc3dlciA9IGFuc3dlcjsKICAgICAgICBjb21taXRtZW50c1tjb21taXRtZW50X2lkXS5pc19yZXZlYWxlZCA9IHRydWU7CgogICAgICAgIGlmIChib25kID09IHF1ZXN0aW9uc1txdWVzdGlvbl9pZF0uYm9uZCkgewogICAgICAgICAgICBfdXBkYXRlQ3VycmVudEFuc3dlcihxdWVzdGlvbl9pZCwgYW5zd2VyLCBxdWVzdGlvbnNbcXVlc3Rpb25faWRdLnRpbWVvdXQpOwogICAgICAgIH0KCiAgICAgICAgTG9nQW5zd2VyUmV2ZWFsKHF1ZXN0aW9uX2lkLCBtc2cuc2VuZGVyLCBhbnN3ZXJfaGFzaCwgYW5zd2VyLCBub25jZSwgYm9uZCk7CgogICAgfQoKICAgIGZ1bmN0aW9uIF9hZGRBbnN3ZXJUb0hpc3RvcnkoYnl0ZXMzMiBxdWVzdGlvbl9pZCwgYnl0ZXMzMiBhbnN3ZXJfb3JfY29tbWl0bWVudF9pZCwgYWRkcmVzcyBhbnN3ZXJlciwgdWludDI1NiBib25kLCBib29sIGlzX2NvbW1pdG1lbnQpIAogICAgaW50ZXJuYWwgCiAgICB7CiAgICAgICAgYnl0ZXMzMiBuZXdfaGlzdG9yeV9oYXNoID0ga2VjY2FrMjU2KHF1ZXN0aW9uc1txdWVzdGlvbl9pZF0uaGlzdG9yeV9oYXNoLCBhbnN3ZXJfb3JfY29tbWl0bWVudF9pZCwgYm9uZCwgYW5zd2VyZXIsIGlzX2NvbW1pdG1lbnQpOwoKICAgICAgICBxdWVzdGlvbnNbcXVlc3Rpb25faWRdLmJvbmQgPSBib25kOwogICAgICAgIHF1ZXN0aW9uc1txdWVzdGlvbl9pZF0uaGlzdG9yeV9oYXNoID0gbmV3X2hpc3RvcnlfaGFzaDsKCiAgICAgICAgTG9nTmV3QW5zd2VyKGFuc3dlcl9vcl9jb21taXRtZW50X2lkLCBxdWVzdGlvbl9pZCwgbmV3X2hpc3RvcnlfaGFzaCwgYW5zd2VyZXIsIGJvbmQsIG5vdywgaXNfY29tbWl0bWVudCk7CiAgICB9CgogICAgZnVuY3Rpb24gX3VwZGF0ZUN1cnJlbnRBbnN3ZXIoYnl0ZXMzMiBxdWVzdGlvbl9pZCwgYnl0ZXMzMiBhbnN3ZXIsIHVpbnQzMiB0aW1lb3V0X3NlY3MpCiAgICBpbnRlcm5hbCB7CiAgICAgICAgcXVlc3Rpb25zW3F1ZXN0aW9uX2lkXS5iZXN0X2Fuc3dlciA9IGFuc3dlcjsKICAgICAgICBxdWVzdGlvbnNbcXVlc3Rpb25faWRdLmZpbmFsaXplX3RzID0gdWludDMyKG5vdykuYWRkKHRpbWVvdXRfc2Vjcyk7CiAgICB9CgogICAgLy8vIEBub3RpY2UgTm90aWZ5IHRoZSBjb250cmFjdCB0aGF0IHRoZSBhcmJpdHJhdG9yIGhhcyBiZWVuIHBhaWQgZm9yIGEgcXVlc3Rpb24sIGZyZWV6aW5nIGl0IHBlbmRpbmcgdGhlaXIgZGVjaXNpb24uCiAgICAvLy8gQGRldiBUaGUgYXJiaXRyYXRvciBjb250cmFjdCBpcyB0cnVzdGVkIHRvIG9ubHkgY2FsbCB0aGlzIGlmIHRoZXkndmUgYmVlbiBwYWlkLCBhbmQgdGVsbCB1cyB3aG8gcGFpZCB0aGVtLgogICAgLy8vIEBwYXJhbSBxdWVzdGlvbl9pZCBUaGUgSUQgb2YgdGhlIHF1ZXN0aW9uCiAgICAvLy8gQHBhcmFtIHJlcXVlc3RlciBUaGUgYWNjb3VudCB0aGF0IHJlcXVlc3RlZCBhcmJpdHJhdGlvbgogICAgZnVuY3Rpb24gbm90aWZ5T2ZBcmJpdHJhdGlvblJlcXVlc3QoYnl0ZXMzMiBxdWVzdGlvbl9pZCwgYWRkcmVzcyByZXF1ZXN0ZXIpIAogICAgICAgIG9ubHlBcmJpdHJhdG9yKHF1ZXN0aW9uX2lkKQogICAgICAgIHN0YXRlT3BlbihxdWVzdGlvbl9pZCkKICAgIGV4dGVybmFsIHsKICAgICAgICBxdWVzdGlvbnNbcXVlc3Rpb25faWRdLmlzX3BlbmRpbmdfYXJiaXRyYXRpb24gPSB0cnVlOwogICAgICAgIExvZ05vdGlmeU9mQXJiaXRyYXRpb25SZXF1ZXN0KHF1ZXN0aW9uX2lkLCByZXF1ZXN0ZXIpOwogICAgfQoKICAgIC8vLyBAbm90aWNlIFN1Ym1pdCB0aGUgYW5zd2VyIGZvciBhIHF1ZXN0aW9uLCBmb3IgdXNlIGJ5IHRoZSBhcmJpdHJhdG9yLgogICAgLy8vIEBkZXYgRG9lc24ndCByZXF1aXJlIChvciBhbGxvdykgYSBib25kLgogICAgLy8vIElmIHRoZSBjdXJyZW50IGZpbmFsIGFuc3dlciBpcyBjb3JyZWN0LCB0aGUgYWNjb3VudCBzaG91bGQgYmUgd2hvZXZlciBzdWJtaXR0ZWQgaXQuCiAgICAvLy8gSWYgdGhlIGN1cnJlbnQgZmluYWwgYW5zd2VyIGlzIHdyb25nLCB0aGUgYWNjb3VudCBzaG91bGQgYmUgd2hvZXZlciBwYWlkIGZvciBhcmJpdHJhdGlvbi4KICAgIC8vLyBIb3dldmVyLCB0aGUgYW5zd2VyZXIgc3RpcHVsYXRpb25zIGFyZSBub3QgZW5mb3JjZWQgYnkgdGhlIGNvbnRyYWN0LgogICAgLy8vIEBwYXJhbSBxdWVzdGlvbl9pZCBUaGUgSUQgb2YgdGhlIHF1ZXN0aW9uCiAgICAvLy8gQHBhcmFtIGFuc3dlciBUaGUgYW5zd2VyLCBlbmNvZGVkIGludG8gYnl0ZXMzMgogICAgLy8vIEBwYXJhbSBhbnN3ZXJlciBUaGUgYWNjb3VudCBjcmVkaXRlZCB3aXRoIHRoaXMgYW5zd2VyIGZvciB0aGUgcHVycG9zZSBvZiBib25kIGNsYWltcwogICAgZnVuY3Rpb24gc3VibWl0QW5zd2VyQnlBcmJpdHJhdG9yKGJ5dGVzMzIgcXVlc3Rpb25faWQsIGJ5dGVzMzIgYW5zd2VyLCBhZGRyZXNzIGFuc3dlcmVyKSAKICAgICAgICBvbmx5QXJiaXRyYXRvcihxdWVzdGlvbl9pZCkKICAgICAgICBzdGF0ZVBlbmRpbmdBcmJpdHJhdGlvbihxdWVzdGlvbl9pZCkKICAgICAgICBib25kTXVzdEJlWmVybwogICAgZXh0ZXJuYWwgewoKICAgICAgICByZXF1aXJlKGFuc3dlcmVyICE9IE5VTExfQUREUkVTUyk7CiAgICAgICAgTG9nRmluYWxpemUocXVlc3Rpb25faWQsIGFuc3dlcik7CgogICAgICAgIHF1ZXN0aW9uc1txdWVzdGlvbl9pZF0uaXNfcGVuZGluZ19hcmJpdHJhdGlvbiA9IGZhbHNlOwogICAgICAgIF9hZGRBbnN3ZXJUb0hpc3RvcnkocXVlc3Rpb25faWQsIGFuc3dlciwgYW5zd2VyZXIsIDAsIGZhbHNlKTsKICAgICAgICBfdXBkYXRlQ3VycmVudEFuc3dlcihxdWVzdGlvbl9pZCwgYW5zd2VyLCAwKTsKCiAgICB9CgogICAgLy8vIEBub3RpY2UgUmVwb3J0IHdoZXRoZXIgdGhlIGFuc3dlciB0byB0aGUgc3BlY2lmaWVkIHF1ZXN0aW9uIGlzIGZpbmFsaXplZAogICAgLy8vIEBwYXJhbSBxdWVzdGlvbl9pZCBUaGUgSUQgb2YgdGhlIHF1ZXN0aW9uCiAgICAvLy8gQHJldHVybiBSZXR1cm4gdHJ1ZSBpZiBmaW5hbGl6ZWQKICAgIGZ1bmN0aW9uIGlzRmluYWxpemVkKGJ5dGVzMzIgcXVlc3Rpb25faWQpIAogICAgY29uc3RhbnQgcHVibGljIHJldHVybnMgKGJvb2wpIHsKICAgICAgICB1aW50MzIgZmluYWxpemVfdHMgPSBxdWVzdGlvbnNbcXVlc3Rpb25faWRdLmZpbmFsaXplX3RzOwogICAgICAgIHJldHVybiAoICFxdWVzdGlvbnNbcXVlc3Rpb25faWRdLmlzX3BlbmRpbmdfYXJiaXRyYXRpb24gJiYgKGZpbmFsaXplX3RzID4gVU5BTlNXRVJFRCkgJiYgKGZpbmFsaXplX3RzIDw9IHVpbnQzMihub3cpKSApOwogICAgfQoKICAgIC8vLyBAbm90aWNlIFJldHVybiB0aGUgZmluYWwgYW5zd2VyIHRvIHRoZSBzcGVjaWZpZWQgcXVlc3Rpb24sIG9yIHJldmVydCBpZiB0aGVyZSBpc24ndCBvbmUKICAgIC8vLyBAcGFyYW0gcXVlc3Rpb25faWQgVGhlIElEIG9mIHRoZSBxdWVzdGlvbgogICAgLy8vIEByZXR1cm4gVGhlIGFuc3dlciBmb3JtYXR0ZWQgYXMgYSBieXRlczMyCiAgICBmdW5jdGlvbiBnZXRGaW5hbEFuc3dlcihieXRlczMyIHF1ZXN0aW9uX2lkKSAKICAgICAgICBzdGF0ZUZpbmFsaXplZChxdWVzdGlvbl9pZCkKICAgIGV4dGVybmFsIGNvbnN0YW50IHJldHVybnMgKGJ5dGVzMzIpIHsKICAgICAgICByZXR1cm4gcXVlc3Rpb25zW3F1ZXN0aW9uX2lkXS5iZXN0X2Fuc3dlcjsKICAgIH0KCiAgICAvLy8gQG5vdGljZSBSZXR1cm4gdGhlIGZpbmFsIGFuc3dlciB0byB0aGUgc3BlY2lmaWVkIHF1ZXN0aW9uLCBwcm92aWRlZCBpdCBtYXRjaGVzIHRoZSBzcGVjaWZpZWQgY3JpdGVyaWEuCiAgICAvLy8gQGRldiBSZXZlcnRzIGlmIHRoZSBxdWVzdGlvbiBpcyBub3QgZmluYWxpemVkLCBvciBpZiBpdCBkb2VzIG5vdCBtYXRjaCB0aGUgc3BlY2lmaWVkIGNyaXRlcmlhLgogICAgLy8vIEBwYXJhbSBxdWVzdGlvbl9pZCBUaGUgSUQgb2YgdGhlIHF1ZXN0aW9uCiAgICAvLy8gQHBhcmFtIGNvbnRlbnRfaGFzaCBUaGUgaGFzaCBvZiB0aGUgcXVlc3Rpb24gY29udGVudCAodGVtcGxhdGUgSUQgKyBvcGVuaW5nIHRpbWUgKyBxdWVzdGlvbiBwYXJhbWV0ZXIgc3RyaW5nKQogICAgLy8vIEBwYXJhbSBhcmJpdHJhdG9yIFRoZSBhcmJpdHJhdG9yIGNob3NlbiBmb3IgdGhlIHF1ZXN0aW9uIChyZWdhcmRsZXNzIG9mIHdoZXRoZXIgdGhleSBhcmUgYXNrZWQgdG8gYXJiaXRyYXRlKQogICAgLy8vIEBwYXJhbSBtaW5fdGltZW91dCBUaGUgdGltZW91dCBzZXQgaW4gdGhlIGluaXRpYWwgcXVlc3Rpb24gc2V0dGluZ3MgbXVzdCBiZSB0aGlzIGhpZ2ggb3IgaGlnaGVyCiAgICAvLy8gQHBhcmFtIG1pbl9ib25kIFRoZSBib25kIHNlbnQgd2l0aCB0aGUgZmluYWwgYW5zd2VyIG11c3QgYmUgdGhpcyBoaWdoIG9yIGhpZ2hlcgogICAgLy8vIEByZXR1cm4gVGhlIGFuc3dlciBmb3JtYXR0ZWQgYXMgYSBieXRlczMyCiAgICBmdW5jdGlvbiBnZXRGaW5hbEFuc3dlcklmTWF0Y2hlcygKICAgICAgICBieXRlczMyIHF1ZXN0aW9uX2lkLCAKICAgICAgICBieXRlczMyIGNvbnRlbnRfaGFzaCwgYWRkcmVzcyBhcmJpdHJhdG9yLCB1aW50MzIgbWluX3RpbWVvdXQsIHVpbnQyNTYgbWluX2JvbmQKICAgICkgCiAgICAgICAgc3RhdGVGaW5hbGl6ZWQocXVlc3Rpb25faWQpCiAgICBleHRlcm5hbCBjb25zdGFudCByZXR1cm5zIChieXRlczMyKSB7CiAgICAgICAgcmVxdWlyZShjb250ZW50X2hhc2ggPT0gcXVlc3Rpb25zW3F1ZXN0aW9uX2lkXS5jb250ZW50X2hhc2gpOwogICAgICAgIHJlcXVpcmUoYXJiaXRyYXRvciA9PSBxdWVzdGlvbnNbcXVlc3Rpb25faWRdLmFyYml0cmF0b3IpOwogICAgICAgIHJlcXVpcmUobWluX3RpbWVvdXQgPD0gcXVlc3Rpb25zW3F1ZXN0aW9uX2lkXS50aW1lb3V0KTsKICAgICAgICByZXF1aXJlKG1pbl9ib25kIDw9IHF1ZXN0aW9uc1txdWVzdGlvbl9pZF0uYm9uZCk7CiAgICAgICAgcmV0dXJuIHF1ZXN0aW9uc1txdWVzdGlvbl9pZF0uYmVzdF9hbnN3ZXI7CiAgICB9CgogICAgLy8vIEBub3RpY2UgQXNzaWducyB0aGUgd2lubmluZ3MgKGJvdW50eSBhbmQgYm9uZHMpIHRvIGV2ZXJ5b25lIHdobyBnYXZlIHRoZSBhY2NlcHRlZCBhbnN3ZXIKICAgIC8vLyBDYWxsZXIgbXVzdCBwcm92aWRlIHRoZSBhbnN3ZXIgaGlzdG9yeSwgaW4gcmV2ZXJzZSBvcmRlcgogICAgLy8vIEBkZXYgV29ya3MgdXAgdGhlIGNoYWluIGFuZCBhc3NpZ24gYm9uZHMgdG8gdGhlIHBlcnNvbiB3aG8gZ2F2ZSB0aGUgcmlnaHQgYW5zd2VyCiAgICAvLy8gSWYgc29tZW9uZSBnYXZlIHRoZSB3aW5uaW5nIGFuc3dlciBlYXJsaWVyLCB0aGV5IG11c3QgZ2V0IHBhaWQgZnJvbSB0aGUgaGlnaGVyIGJvbmQKICAgIC8vLyBUaGF0IG1lYW5zIHdlIGNhbid0IHBheSBvdXQgdGhlIGJvbmQgYWRkZWQgYXQgbiB1bnRpbCB3ZSBoYXZlIGxvb2tlZCBhdCBuLTEKICAgIC8vLyBUaGUgZmlyc3QgYW5zd2VyIGlzIGF1dGhlbnRpY2F0ZWQgYnkgY2hlY2tpbmcgYWdhaW5zdCB0aGUgc3RvcmVkIGhpc3RvcnlfaGFzaC4KICAgIC8vLyBPbmUgb2YgdGhlIGlucHV0cyB0byBoaXN0b3J5X2hhc2ggaXMgdGhlIGhpc3RvcnlfaGFzaCBiZWZvcmUgaXQsIHNvIHdlIHVzZSB0aGF0IHRvIGF1dGhlbnRpY2F0ZSB0aGUgbmV4dCBlbnRyeSwgZXRjCiAgICAvLy8gT25jZSB3ZSBnZXQgdG8gYSBudWxsIGhhc2ggd2UnbGwga25vdyB3ZSdyZSBkb25lIGFuZCB0aGVyZSBhcmUgbm8gbW9yZSBhbnN3ZXJzLgogICAgLy8vIFVzdWFsbHkgeW91IHdvdWxkIGNhbGwgdGhlIHdob2xlIHRoaW5nIGluIGEgc2luZ2xlIHRyYW5zYWN0aW9uLCBidXQgaWYgbm90IHRoZW4gdGhlIGRhdGEgaXMgcGVyc2lzdGVkIHRvIHBpY2sgdXAgbGF0ZXIuCiAgICAvLy8gQHBhcmFtIHF1ZXN0aW9uX2lkIFRoZSBJRCBvZiB0aGUgcXVlc3Rpb24KICAgIC8vLyBAcGFyYW0gaGlzdG9yeV9oYXNoZXMgU2Vjb25kLWxhc3QtdG8tZmlyc3QsIHRoZSBoYXNoIG9mIGVhY2ggaGlzdG9yeSBlbnRyeS4gKEZpbmFsIG9uZSBzaG91bGQgYmUgZW1wdHkpLgogICAgLy8vIEBwYXJhbSBhZGRycyBMYXN0LXRvLWZpcnN0LCB0aGUgYWRkcmVzcyBvZiBlYWNoIGFuc3dlcmVyIG9yIGNvbW1pdG1lbnQgc2VuZGVyCiAgICAvLy8gQHBhcmFtIGJvbmRzIExhc3QtdG8tZmlyc3QsIHRoZSBib25kIHN1cHBsaWVkIHdpdGggZWFjaCBhbnN3ZXIgb3IgY29tbWl0bWVudAogICAgLy8vIEBwYXJhbSBhbnN3ZXJzIExhc3QtdG8tZmlyc3QsIGVhY2ggYW5zd2VyIHN1cHBsaWVkLCBvciBjb21taXRtZW50IElEIGlmIHRoZSBhbnN3ZXIgd2FzIHN1cHBsaWVkIHdpdGggY29tbWl0LT5yZXZlYWwKICAgIGZ1bmN0aW9uIGNsYWltV2lubmluZ3MoCiAgICAgICAgYnl0ZXMzMiBxdWVzdGlvbl9pZCwgCiAgICAgICAgYnl0ZXMzMltdIGhpc3RvcnlfaGFzaGVzLCBhZGRyZXNzW10gYWRkcnMsIHVpbnQyNTZbXSBib25kcywgYnl0ZXMzMltdIGFuc3dlcnMKICAgICkgCiAgICAgICAgc3RhdGVGaW5hbGl6ZWQocXVlc3Rpb25faWQpCiAgICBwdWJsaWMgewoKICAgICAgICByZXF1aXJlKGhpc3RvcnlfaGFzaGVzLmxlbmd0aCA+IDApOwoKICAgICAgICAvLyBUaGVzZSBhcmUgb25seSBzZXQgaWYgd2Ugc3BsaXQgb3VyIGNsYWltIG92ZXIgbXVsdGlwbGUgdHJhbnNhY3Rpb25zLgogICAgICAgIGFkZHJlc3MgcGF5ZWUgPSBxdWVzdGlvbl9jbGFpbXNbcXVlc3Rpb25faWRdLnBheWVlOyAKICAgICAgICB1aW50MjU2IGxhc3RfYm9uZCA9IHF1ZXN0aW9uX2NsYWltc1txdWVzdGlvbl9pZF0ubGFzdF9ib25kOyAKICAgICAgICB1aW50MjU2IHF1ZXVlZF9mdW5kcyA9IHF1ZXN0aW9uX2NsYWltc1txdWVzdGlvbl9pZF0ucXVldWVkX2Z1bmRzOyAKCiAgICAgICAgLy8gU3RhcnRzIGFzIHRoZSBoYXNoIG9mIHRoZSBmaW5hbCBhbnN3ZXIgc3VibWl0dGVkLiBJdCdsbCBiZSBjbGVhcmVkIHdoZW4gd2UncmUgZG9uZS4KICAgICAgICAvLyBJZiB3ZSdyZSBzcGxpdHRpbmcgdGhlIGNsYWltIG92ZXIgbXVsdGlwbGUgdHJhbnNhY3Rpb25zLCBpdCdsbCBiZSB0aGUgaGFzaCB3aGVyZSB3ZSBsZWZ0IG9mZiBsYXN0IHRpbWUKICAgICAgICBieXRlczMyIGxhc3RfaGlzdG9yeV9oYXNoID0gcXVlc3Rpb25zW3F1ZXN0aW9uX2lkXS5oaXN0b3J5X2hhc2g7CgogICAgICAgIGJ5dGVzMzIgYmVzdF9hbnN3ZXIgPSBxdWVzdGlvbnNbcXVlc3Rpb25faWRdLmJlc3RfYW5zd2VyOwoKICAgICAgICB1aW50MjU2IGk7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGhpc3RvcnlfaGFzaGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgCiAgICAgICAgICAgIC8vIENoZWNrIGlucHV0IGFnYWluc3QgdGhlIGhpc3RvcnkgaGFzaCwgYW5kIHNlZSB3aGljaCBvZiAyIHBvc3NpYmxlIHZhbHVlcyBvZiBpc19jb21taXRtZW50IGZpdHMuCiAgICAgICAgICAgIGJvb2wgaXNfY29tbWl0bWVudCA9IF92ZXJpZnlIaXN0b3J5SW5wdXRPclJldmVydChsYXN0X2hpc3RvcnlfaGFzaCwgaGlzdG9yeV9oYXNoZXNbaV0sIGFuc3dlcnNbaV0sIGJvbmRzW2ldLCBhZGRyc1tpXSk7CiAgICAgICAgICAgIAogICAgICAgICAgICBxdWV1ZWRfZnVuZHMgPSBxdWV1ZWRfZnVuZHMuYWRkKGxhc3RfYm9uZCk7IAogICAgICAgICAgICAocXVldWVkX2Z1bmRzLCBwYXllZSkgPSBfcHJvY2Vzc0hpc3RvcnlJdGVtKAogICAgICAgICAgICAgICAgcXVlc3Rpb25faWQsIGJlc3RfYW5zd2VyLCBxdWV1ZWRfZnVuZHMsIHBheWVlLCAKICAgICAgICAgICAgICAgIGFkZHJzW2ldLCBib25kc1tpXSwgYW5zd2Vyc1tpXSwgaXNfY29tbWl0bWVudCk7CiAKICAgICAgICAgICAgLy8gTGluZSB0aGUgYm9uZCB1cCBmb3IgbmV4dCB0aW1lLCB3aGVuIGl0IHdpbGwgYmUgYWRkZWQgdG8gc29tZWJvZHkncyBxdWV1ZWRfZnVuZHMKICAgICAgICAgICAgbGFzdF9ib25kID0gYm9uZHNbaV07CiAgICAgICAgICAgIGxhc3RfaGlzdG9yeV9oYXNoID0gaGlzdG9yeV9oYXNoZXNbaV07CgogICAgICAgIH0KIAogICAgICAgIGlmIChsYXN0X2hpc3RvcnlfaGFzaCAhPSBOVUxMX0hBU0gpIHsKICAgICAgICAgICAgLy8gV2UgaGF2ZW4ndCB5ZXQgZ290IHRvIHRoZSBudWxsIGhhc2ggKDFzdCBhbnN3ZXIpLCBpZSB0aGUgY2FsbGVyIGRpZG4ndCBzdXBwbHkgdGhlIGZ1bGwgYW5zd2VyIGNoYWluLgogICAgICAgICAgICAvLyBQZXJzaXN0IHRoZSBkZXRhaWxzIHNvIHdlIGNhbiBwaWNrIHVwIGxhdGVyIHdoZXJlIHdlIGxlZnQgb2ZmIGxhdGVyLgoKICAgICAgICAgICAgLy8gSWYgd2Uga25vdyB3aG8gdG8gcGF5IHdlIGNhbiBnbyBhaGVhZCBhbmQgcGF5IHRoZW0gb3V0LCBvbmx5IGtlZXBpbmcgYmFjayBsYXN0X2JvbmQKICAgICAgICAgICAgLy8gKFdlIGFsd2F5cyBrbm93IHdobyB0byBwYXkgdW5sZXNzIGFsbCB3ZSBzYXcgd2VyZSB1bnJldmVhbGVkIGNvbW1pdHMpCiAgICAgICAgICAgIGlmIChwYXllZSAhPSBOVUxMX0FERFJFU1MpIHsKICAgICAgICAgICAgICAgIF9wYXlQYXllZShxdWVzdGlvbl9pZCwgcGF5ZWUsIHF1ZXVlZF9mdW5kcyk7CiAgICAgICAgICAgICAgICBxdWV1ZWRfZnVuZHMgPSAwOwogICAgICAgICAgICB9CgogICAgICAgICAgICBxdWVzdGlvbl9jbGFpbXNbcXVlc3Rpb25faWRdLnBheWVlID0gcGF5ZWU7CiAgICAgICAgICAgIHF1ZXN0aW9uX2NsYWltc1txdWVzdGlvbl9pZF0ubGFzdF9ib25kID0gbGFzdF9ib25kOwogICAgICAgICAgICBxdWVzdGlvbl9jbGFpbXNbcXVlc3Rpb25faWRdLnF1ZXVlZF9mdW5kcyA9IHF1ZXVlZF9mdW5kczsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBUaGVyZSBpcyBub3RoaW5nIGxlZnQgYmVsb3cgdXMgc28gdGhlIHBheWVlIGNhbiBrZWVwIHdoYXQgcmVtYWlucwogICAgICAgICAgICBfcGF5UGF5ZWUocXVlc3Rpb25faWQsIHBheWVlLCBxdWV1ZWRfZnVuZHMuYWRkKGxhc3RfYm9uZCkpOwogICAgICAgICAgICBkZWxldGUgcXVlc3Rpb25fY2xhaW1zW3F1ZXN0aW9uX2lkXTsKICAgICAgICB9CgogICAgICAgIHF1ZXN0aW9uc1txdWVzdGlvbl9pZF0uaGlzdG9yeV9oYXNoID0gbGFzdF9oaXN0b3J5X2hhc2g7CgogICAgfQoKICAgIGZ1bmN0aW9uIF9wYXlQYXllZShieXRlczMyIHF1ZXN0aW9uX2lkLCBhZGRyZXNzIHBheWVlLCB1aW50MjU2IHZhbHVlKSAKICAgIGludGVybmFsIHsKICAgICAgICBiYWxhbmNlT2ZbcGF5ZWVdID0gYmFsYW5jZU9mW3BheWVlXS5hZGQodmFsdWUpOwogICAgICAgIExvZ0NsYWltKHF1ZXN0aW9uX2lkLCBwYXllZSwgdmFsdWUpOwogICAgfQoKICAgIGZ1bmN0aW9uIF92ZXJpZnlIaXN0b3J5SW5wdXRPclJldmVydCgKICAgICAgICBieXRlczMyIGxhc3RfaGlzdG9yeV9oYXNoLAogICAgICAgIGJ5dGVzMzIgaGlzdG9yeV9oYXNoLCBieXRlczMyIGFuc3dlciwgdWludDI1NiBib25kLCBhZGRyZXNzIGFkZHIKICAgICkKICAgIGludGVybmFsIHB1cmUgcmV0dXJucyAoYm9vbCkgewogICAgICAgIGlmIChsYXN0X2hpc3RvcnlfaGFzaCA9PSBrZWNjYWsyNTYoaGlzdG9yeV9oYXNoLCBhbnN3ZXIsIGJvbmQsIGFkZHIsIHRydWUpICkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgaWYgKGxhc3RfaGlzdG9yeV9oYXNoID09IGtlY2NhazI1NihoaXN0b3J5X2hhc2gsIGFuc3dlciwgYm9uZCwgYWRkciwgZmFsc2UpICkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfSAKICAgICAgICByZXZlcnQoKTsKICAgIH0KCiAgICBmdW5jdGlvbiBfcHJvY2Vzc0hpc3RvcnlJdGVtKAogICAgICAgIGJ5dGVzMzIgcXVlc3Rpb25faWQsIGJ5dGVzMzIgYmVzdF9hbnN3ZXIsIAogICAgICAgIHVpbnQyNTYgcXVldWVkX2Z1bmRzLCBhZGRyZXNzIHBheWVlLCAKICAgICAgICBhZGRyZXNzIGFkZHIsIHVpbnQyNTYgYm9uZCwgYnl0ZXMzMiBhbnN3ZXIsIGJvb2wgaXNfY29tbWl0bWVudAogICAgKQogICAgaW50ZXJuYWwgcmV0dXJucyAodWludDI1NiwgYWRkcmVzcykgewoKICAgICAgICAvLyBGb3IgY29tbWl0LWFuZC1yZXZlYWwsIHRoZSBhbnN3ZXIgaGlzdG9yeSBob2xkcyB0aGUgY29tbWl0bWVudCBJRCBpbnN0ZWFkIG9mIHRoZSBhbnN3ZXIuCiAgICAgICAgLy8gV2UgbG9vayBhdCB0aGUgcmVmZXJlbmNlZCBjb21taXRtZW50IElEIGFuZCBzd2l0Y2ggaW4gdGhlIGFjdHVhbCBhbnN3ZXIuCiAgICAgICAgaWYgKGlzX2NvbW1pdG1lbnQpIHsKICAgICAgICAgICAgYnl0ZXMzMiBjb21taXRtZW50X2lkID0gYW5zd2VyOwogICAgICAgICAgICAvLyBJZiBpdCdzIGEgY29tbWl0IGJ1dCBpdCBoYXNuJ3QgYmVlbiByZXZlYWxlZCwgaXQgd2lsbCBhbHdheXMgYmUgY29uc2lkZXJlZCB3cm9uZy4KICAgICAgICAgICAgaWYgKCFjb21taXRtZW50c1tjb21taXRtZW50X2lkXS5pc19yZXZlYWxlZCkgewogICAgICAgICAgICAgICAgZGVsZXRlIGNvbW1pdG1lbnRzW2NvbW1pdG1lbnRfaWRdOwogICAgICAgICAgICAgICAgcmV0dXJuIChxdWV1ZWRfZnVuZHMsIHBheWVlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGFuc3dlciA9IGNvbW1pdG1lbnRzW2NvbW1pdG1lbnRfaWRdLnJldmVhbGVkX2Fuc3dlcjsKICAgICAgICAgICAgICAgIGRlbGV0ZSBjb21taXRtZW50c1tjb21taXRtZW50X2lkXTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKGFuc3dlciA9PSBiZXN0X2Fuc3dlcikgewoKICAgICAgICAgICAgaWYgKHBheWVlID09IE5VTExfQUREUkVTUykgewoKICAgICAgICAgICAgICAgIC8vIFRoZSBlbnRyeSBpcyBmb3IgdGhlIGZpcnN0IHBheWVlIHdlIGNvbWUgdG8sIGllIHRoZSB3aW5uZXIuCiAgICAgICAgICAgICAgICAvLyBUaGV5IGdldCB0aGUgcXVlc3Rpb24gYm91bnR5LgogICAgICAgICAgICAgICAgcGF5ZWUgPSBhZGRyOwogICAgICAgICAgICAgICAgcXVldWVkX2Z1bmRzID0gcXVldWVkX2Z1bmRzLmFkZChxdWVzdGlvbnNbcXVlc3Rpb25faWRdLmJvdW50eSk7CiAgICAgICAgICAgICAgICBxdWVzdGlvbnNbcXVlc3Rpb25faWRdLmJvdW50eSA9IDA7CgogICAgICAgICAgICB9IGVsc2UgaWYgKGFkZHIgIT0gcGF5ZWUpIHsKCiAgICAgICAgICAgICAgICAvLyBBbnN3ZXJlciBoYXMgY2hhbmdlZCwgaWUgd2UgZm91bmQgc29tZW9uZSBsb3dlciBkb3duIHdobyBuZWVkcyB0byBiZSBwYWlkCgogICAgICAgICAgICAgICAgLy8gVGhlIGxvd2VyIGFuc3dlcmVyIHdpbGwgdGFrZSBvdmVyIHJlY2VpdmluZyBib25kcyBmcm9tIGhpZ2hlciBhbnN3ZXJlci4KICAgICAgICAgICAgICAgIC8vIFRoZXkgc2hvdWxkIGFsc28gYmUgcGFpZCB0aGUgdGFrZW92ZXIgZmVlLCB3aGljaCBpcyBzZXQgYXQgYSByYXRlIGVxdWl2YWxlbnQgdG8gdGhlaXIgYm9uZC4gCiAgICAgICAgICAgICAgICAvLyAoVGhpcyBpcyBvdXIgYXJiaXRyYXJ5IHJ1bGUsIHRvIGdpdmUgY29uc2lzdGVudCByaWdodC1hbnN3ZXJlcnMgYSBkZWZlbmNlIGFnYWluc3QgaGlnaC1yb2xsZXJzLikKCiAgICAgICAgICAgICAgICAvLyBUaGVyZSBzaG91bGQgYmUgZW5vdWdoIGZvciB0aGUgZmVlLCBidXQgaWYgbm90LCB0YWtlIHdoYXQgd2UgaGF2ZS4KICAgICAgICAgICAgICAgIC8vIFRoZXJlJ3MgYW4gZWRnZSBjYXNlIGludm9sdmluZyB3ZWlyZCBhcmJpdHJhdG9yIGJlaGF2aW91ciB3aGVyZSB3ZSBtYXkgYmUgc2hvcnQuCiAgICAgICAgICAgICAgICB1aW50MjU2IGFuc3dlcl90YWtlb3Zlcl9mZWUgPSAocXVldWVkX2Z1bmRzID49IGJvbmQpID8gYm9uZCA6IHF1ZXVlZF9mdW5kczsKCiAgICAgICAgICAgICAgICAvLyBTZXR0bGUgdXAgd2l0aCB0aGUgb2xkIChoaWdoZXItYm9uZGVkKSBwYXllZQogICAgICAgICAgICAgICAgX3BheVBheWVlKHF1ZXN0aW9uX2lkLCBwYXllZSwgcXVldWVkX2Z1bmRzLnN1YihhbnN3ZXJfdGFrZW92ZXJfZmVlKSk7CgogICAgICAgICAgICAgICAgLy8gTm93IHN0YXJ0IHF1ZXVlZF9mdW5kcyBhZ2FpbiBmb3IgdGhlIG5ldyAobG93ZXItYm9uZGVkKSBwYXllZQogICAgICAgICAgICAgICAgcGF5ZWUgPSBhZGRyOwogICAgICAgICAgICAgICAgcXVldWVkX2Z1bmRzID0gYW5zd2VyX3Rha2VvdmVyX2ZlZTsKCiAgICAgICAgICAgIH0KCiAgICAgICAgfQoKICAgICAgICByZXR1cm4gKHF1ZXVlZF9mdW5kcywgcGF5ZWUpOwoKICAgIH0KCiAgICAvLy8gQG5vdGljZSBDb252ZW5pZW5jZSBmdW5jdGlvbiB0byBhc3NpZ24gYm91bnRpZXMvYm9uZHMgZm9yIG11bHRpcGxlIHF1ZXN0aW9ucyBpbiBvbmUgZ28sIHRoZW4gd2l0aGRyYXcgYWxsIHlvdXIgZnVuZHMuCiAgICAvLy8gQ2FsbGVyIG11c3QgcHJvdmlkZSB0aGUgYW5zd2VyIGhpc3RvcnkgZm9yIGVhY2ggcXVlc3Rpb24sIGluIHJldmVyc2Ugb3JkZXIKICAgIC8vLyBAZGV2IENhbiBiZSBjYWxsZWQgYnkgYW55b25lIHRvIGFzc2lnbiBib25kcy9ib3VudGllcywgYnV0IGZ1bmRzIGFyZSBvbmx5IHdpdGhkcmF3biBmb3IgdGhlIHVzZXIgbWFraW5nIHRoZSBjYWxsLgogICAgLy8vIEBwYXJhbSBxdWVzdGlvbl9pZHMgVGhlIElEcyBvZiB0aGUgcXVlc3Rpb25zIHlvdSB3YW50IHRvIGNsYWltIGZvcgogICAgLy8vIEBwYXJhbSBsZW5ndGhzIFRoZSBudW1iZXIgb2YgaGlzdG9yeSBlbnRyaWVzIHlvdSB3aWxsIHN1cHBseSBmb3IgZWFjaCBxdWVzdGlvbiBJRAogICAgLy8vIEBwYXJhbSBoaXN0X2hhc2hlcyBJbiBhIHNpbmdsZSBsaXN0IGZvciBhbGwgc3VwcGxpZWQgcXVlc3Rpb25zLCB0aGUgaGFzaCBvZiBlYWNoIGhpc3RvcnkgZW50cnkuCiAgICAvLy8gQHBhcmFtIGFkZHJzIEluIGEgc2luZ2xlIGxpc3QgZm9yIGFsbCBzdXBwbGllZCBxdWVzdGlvbnMsIHRoZSBhZGRyZXNzIG9mIGVhY2ggYW5zd2VyZXIgb3IgY29tbWl0bWVudCBzZW5kZXIKICAgIC8vLyBAcGFyYW0gYm9uZHMgSW4gYSBzaW5nbGUgbGlzdCBmb3IgYWxsIHN1cHBsaWVkIHF1ZXN0aW9ucywgdGhlIGJvbmQgc3VwcGxpZWQgd2l0aCBlYWNoIGFuc3dlciBvciBjb21taXRtZW50CiAgICAvLy8gQHBhcmFtIGFuc3dlcnMgSW4gYSBzaW5nbGUgbGlzdCBmb3IgYWxsIHN1cHBsaWVkIHF1ZXN0aW9ucywgZWFjaCBhbnN3ZXIgc3VwcGxpZWQsIG9yIGNvbW1pdG1lbnQgSUQgCiAgICBmdW5jdGlvbiBjbGFpbU11bHRpcGxlQW5kV2l0aGRyYXdCYWxhbmNlKAogICAgICAgIGJ5dGVzMzJbXSBxdWVzdGlvbl9pZHMsIHVpbnQyNTZbXSBsZW5ndGhzLCAKICAgICAgICBieXRlczMyW10gaGlzdF9oYXNoZXMsIGFkZHJlc3NbXSBhZGRycywgdWludDI1NltdIGJvbmRzLCBieXRlczMyW10gYW5zd2VycwogICAgKSAKICAgICAgICBzdGF0ZUFueSgpIC8vIFRoZSBmaW5hbGl6YXRpb24gY2hlY2tzIGFyZSBkb25lIGluIHRoZSBjbGFpbVdpbm5pbmdzIGZ1bmN0aW9uCiAgICBwdWJsaWMgewogICAgICAgIAogICAgICAgIHVpbnQyNTYgcWk7CiAgICAgICAgdWludDI1NiBpOwogICAgICAgIGZvciAocWkgPSAwOyBxaSA8IHF1ZXN0aW9uX2lkcy5sZW5ndGg7IHFpKyspIHsKICAgICAgICAgICAgYnl0ZXMzMiBxaWQgPSBxdWVzdGlvbl9pZHNbcWldOwogICAgICAgICAgICB1aW50MjU2IGxuID0gbGVuZ3Roc1txaV07CiAgICAgICAgICAgIGJ5dGVzMzJbXSBtZW1vcnkgaGggPSBuZXcgYnl0ZXMzMltdKGxuKTsKICAgICAgICAgICAgYWRkcmVzc1tdIG1lbW9yeSBhZCA9IG5ldyBhZGRyZXNzW10obG4pOwogICAgICAgICAgICB1aW50MjU2W10gbWVtb3J5IGJvID0gbmV3IHVpbnQyNTZbXShsbik7CiAgICAgICAgICAgIGJ5dGVzMzJbXSBtZW1vcnkgYW4gPSBuZXcgYnl0ZXMzMltdKGxuKTsKICAgICAgICAgICAgdWludDI1NiBqOwogICAgICAgICAgICBmb3IgKGogPSAwOyBqIDwgbG47IGorKykgewogICAgICAgICAgICAgICAgaGhbal0gPSBoaXN0X2hhc2hlc1tpXTsKICAgICAgICAgICAgICAgIGFkW2pdID0gYWRkcnNbaV07CiAgICAgICAgICAgICAgICBib1tqXSA9IGJvbmRzW2ldOwogICAgICAgICAgICAgICAgYW5bal0gPSBhbnN3ZXJzW2ldOwogICAgICAgICAgICAgICAgaSsrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNsYWltV2lubmluZ3MocWlkLCBoaCwgYWQsIGJvLCBhbik7CiAgICAgICAgfQogICAgICAgIHdpdGhkcmF3KCk7CiAgICB9Cn0='.
	

]
