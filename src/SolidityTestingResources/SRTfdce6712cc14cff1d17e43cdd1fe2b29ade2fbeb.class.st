Class {
	#name : #SRTfdce6712cc14cff1d17e43cdd1fe2b29ade2fbeb,
	#superclass : #SRTContracts,
	#category : #SolidityTestingResources
}

{ #category : #base64 }
SRTfdce6712cc14cff1d17e43cdd1fe2b29ade2fbeb >> base64 [
	^ 'cHJhZ21hIHNvbGlkaXR5IF4wLjQuMTg7CgovKioKICogQHRpdGxlIFdhbGxldCBBZG1pbiBMaWJyYXJ5CiAqIEBhdXRob3IgTW9kdWxhci5uZXR3b3JrCiAqCiAqIHZlcnNpb24gMS4xLjAKICogQ29weXJpZ2h0IChjKSAyMDE3IE1vZHVsYXIsIEluYwogKiBUaGUgTUlUIExpY2Vuc2UgKE1JVCkKICogaHR0cHM6Ly9naXRodWIuY29tL01vZHVsYXItTmV0d29yay9ldGhlcmV1bS1saWJyYXJpZXMvYmxvYi9tYXN0ZXIvTElDRU5TRQogKgogKiBUaGUgV2FsbGV0IExpYnJhcnkgZmFtaWx5IGlzIGluc3BpcmVkIGJ5IHRoZSBtdWx0aXNpZyB3YWxsZXRzIGJ1aWx0IGJ5IENvbnNlbnN5cwogKiBhdCBodHRwczovL2dpdGh1Yi5jb20vQ29uc2VuU3lzL011bHRpU2lnV2FsbGV0IGFuZCBQYXJpdHkgYXQKICogaHR0cHM6Ly9naXRodWIuY29tL3Bhcml0eXRlY2gvY29udHJhY3RzL2Jsb2IvbWFzdGVyL1dhbGxldC5zb2wgd2l0aCBhZGRlZAogKiBmdW5jdGlvbmFsaXR5LiBNb2R1bGFyIHdvcmtzIG9uIG9wZW4gc291cmNlIHByb2plY3RzIGluIHRoZSBFdGhlcmV1bQogKiBjb21tdW5pdHkgd2l0aCB0aGUgcHVycG9zZSBvZiB0ZXN0aW5nLCBkb2N1bWVudGluZywgYW5kIGRlcGxveWluZyByZXVzYWJsZQogKiBjb2RlIG9udG8gdGhlIGJsb2NrY2hhaW4gdG8gaW1wcm92ZSBzZWN1cml0eSBhbmQgdXNhYmlsaXR5IG9mIHNtYXJ0IGNvbnRyYWN0cy4KICogTW9kdWxhciBhbHNvIHN0cml2ZXMgdG8gZWR1Y2F0ZSBub24tcHJvZml0cywgc2Nob29scywgYW5kIG90aGVyIGNvbW11bml0eQogKiBtZW1iZXJzIGFib3V0IHRoZSBhcHBsaWNhdGlvbiBvZiBibG9ja2NoYWluIHRlY2hub2xvZ3kuIEZvciBmdXJ0aGVyCiAqIGluZm9ybWF0aW9uOiBtb2R1bGFyLm5ldHdvcmssIGNvbnNlbnN5cy5uZXQsIHBhcml0eXRlY2guaW8KICoKICogVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MKICogT1IgSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRgogKiBNRVJDSEFOVEFCSUxJVFksIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuCiAqIElOIE5PIEVWRU5UIFNIQUxMIFRIRSBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZCiAqIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsCiAqIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFCiAqIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4gVEhFIFNPRlRXQVJFLgogKi8KCmxpYnJhcnkgV2FsbGV0QWRtaW5MaWIgewogIHVzaW5nIFdhbGxldE1haW5MaWIgZm9yIFdhbGxldE1haW5MaWIuV2FsbGV0RGF0YTsKCiAgLypFdmVudHMqLwogIGV2ZW50IExvZ1RyYW5zYWN0aW9uQ29uZmlybWVkKGJ5dGVzMzIgdHhpZCwgYWRkcmVzcyBzZW5kZXIsIHVpbnQyNTYgY29uZmlybXNOZWVkZWQpOwogIGV2ZW50IExvZ093bmVyQWRkZWQoYWRkcmVzcyBuZXdPd25lcik7CiAgZXZlbnQgTG9nT3duZXJSZW1vdmVkKGFkZHJlc3Mgb3duZXJSZW1vdmVkKTsKICBldmVudCBMb2dPd25lckNoYW5nZWQoYWRkcmVzcyBmcm9tLCBhZGRyZXNzIHRvKTsKICBldmVudCBMb2dSZXF1aXJlbWVudENoYW5nZSh1aW50MjU2IG5ld1JlcXVpcmVkKTsKICBldmVudCBMb2dUaHJlc2hvbGRDaGFuZ2UoYWRkcmVzcyB0b2tlbiwgdWludDI1NiBuZXdUaHJlc2hvbGQpOwogIGV2ZW50IExvZ0Vycm9yTXNnKHVpbnQyNTYgYW1vdW50LCBzdHJpbmcgbXNnKTsKCiAgLypDaGVja3MqLwoKICAvLy8gQGRldiBWYWxpZGF0ZXMgYXJndW1lbnRzIGZvciBjaGFuZ2VPd25lciBmdW5jdGlvbgogIC8vLyBAcGFyYW0gX2Zyb20gSW5kZXggb2YgY3VycmVudCBvd25lciByZW1vdmluZwogIC8vLyBAcGFyYW0gX3RvIEluZGV4IG9mIG5ldyBwb3RlbnRpYWwgb3duZXIsIHNob3VsZCBiZSAwCiAgLy8vIEByZXR1cm4gUmV0dXJucyB0cnVlIGlmIGNoZWNrIHBhc3NlcywgZmFsc2Ugb3RoZXJ3aXNlCiAgZnVuY3Rpb24gY2hlY2tDaGFuZ2VPd25lckFyZ3ModWludDI1NiBfZnJvbSwgdWludDI1NiBfdG8pCiAgICAgICAgICAgcHJpdmF0ZSByZXR1cm5zIChib29sKQogIHsKICAgIGlmKF9mcm9tID09IDApewogICAgICBMb2dFcnJvck1zZyhfZnJvbSwgIkNoYW5nZSBmcm9tIGFkZHJlc3MgaXMgbm90IGFuIG93bmVyIik7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIGlmKF90byAhPSAwKXsKICAgICAgTG9nRXJyb3JNc2coX3RvLCAiQ2hhbmdlIHRvIGFkZHJlc3MgaXMgYW4gb3duZXIiKTsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgcmV0dXJuIHRydWU7CiAgfQoKICAvLy8gQGRldiBWYWxpZGF0ZXMgYXJndW1lbnRzIGZvciBhZGRPd25lciBmdW5jdGlvbgogIC8vLyBAcGFyYW0gX2luZGV4IEluZGV4IG9mIG5ldyBvd25lciwgc2hvdWxkIGJlIDAKICAvLy8gQHBhcmFtIF9sZW5ndGggQ3VycmVudCBsZW5ndGggb2Ygb3duZXIgYXJyYXkKICAvLy8gQHJldHVybiBSZXR1cm5zIHRydWUgaWYgY2hlY2sgcGFzc2VzLCBmYWxzZSBvdGhlcndpc2UKICBmdW5jdGlvbiBjaGVja05ld093bmVyQXJncyh1aW50MjU2IF9pbmRleCwgdWludDI1NiBfbGVuZ3RoLCB1aW50MjU2IF9tYXgpCiAgICAgICAgICAgcHJpdmF0ZSByZXR1cm5zIChib29sKQogIHsKICAgIGlmKF9pbmRleCAhPSAwKXsKICAgICAgTG9nRXJyb3JNc2coX2luZGV4LCAiTmV3IG93bmVyIGFscmVhZHkgb3duZXIiKTsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgaWYoKF9sZW5ndGggKyAxKSA+IF9tYXgpewogICAgICBMb2dFcnJvck1zZyhfbGVuZ3RoLCAiVG9vIG1hbnkgb3duZXJzIik7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIHJldHVybiB0cnVlOwogIH0KCiAgLy8vIEBkZXYgVmFsaWRhdGVzIGFyZ3VtZW50cyBmb3IgcmVtb3ZlT3duZXIgZnVuY3Rpb24KICAvLy8gQHBhcmFtIF9pbmRleCBJbmRleCBvZiBvd25lciByZW1vdmluZwogIC8vLyBAcGFyYW0gX2xlbmd0aCBDdXJyZW50IG51bWJlciBvZiBvd25lcnMKICAvLy8gQHBhcmFtIF9taW4gTWluaW11bSBvd25lcnMgY3VycmVudGx5IHJlcXVpcmVkIHRvIG1lZXQgc2lnIHJlcXVpcmVtZW50cwogIC8vLyBAcmV0dXJuIFJldHVycyB0cnVlIGlmIGNoZWNrIHBhc3NlcywgZmFsc2Ugb3RoZXJ3aXNlCiAgZnVuY3Rpb24gY2hlY2tSZW1vdmVPd25lckFyZ3ModWludDI1NiBfaW5kZXgsIHVpbnQyNTYgX2xlbmd0aCwgdWludDI1NiBfbWluKQogICAgICAgICAgIHByaXZhdGUgcmV0dXJucyAoYm9vbCkKICB7CiAgICBpZihfaW5kZXggPT0gMCl7CiAgICAgIExvZ0Vycm9yTXNnKF9pbmRleCwgIk93bmVyIHJlbW92aW5nIG5vdCBhbiBvd25lciIpOwogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICBpZihfbGVuZ3RoIC0gMiA8IF9taW4pIHsKICAgICAgTG9nRXJyb3JNc2coX2luZGV4LCAiTXVzdCByZWR1Y2UgcmVxdWlyZWRBZG1pbiBmaXJzdCIpOwogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICByZXR1cm4gdHJ1ZTsKICB9CgogIC8vLyBAZGV2IFZhbGlkYXRlcyBhcmd1bWVudHMgZm9yIGNoYW5naW5nIGFueSBvZiB0aGUgc2lnIHJlcXVpcmVtZW50IHBhcmFtZXRlcnMKICAvLy8gQHBhcmFtIF9uZXdSZXF1aXJlZCBUaGUgbmV3IHNpZyByZXF1aXJlbWVudAogIC8vLyBAcGFyYW0gX2xlbmd0aCBDdXJyZW50IG51bWJlciBvZiBvd25lcnMKICAvLy8gQHJldHVybiBSZXR1cm5zIHRydWUgaWYgY2hlY2tzIHBhc3MsIGZhbHNlIG90aGVyd2lzZQogIGZ1bmN0aW9uIGNoZWNrUmVxdWlyZWRDaGFuZ2UodWludDI1NiBfbmV3UmVxdWlyZWQsIHVpbnQyNTYgX2xlbmd0aCkKICAgICAgICAgICBwcml2YXRlIHJldHVybnMgKGJvb2wpCiAgewogICAgaWYoX25ld1JlcXVpcmVkID09IDApewogICAgICBMb2dFcnJvck1zZyhfbmV3UmVxdWlyZWQsICJDYW50IHJlZHVjZSB0byAwIik7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIGlmKF9sZW5ndGggLSAyIDwgX25ld1JlcXVpcmVkKXsKICAgICAgTG9nRXJyb3JNc2coX2xlbmd0aCwgIk1ha2luZyByZXF1aXJlbWVudCB0b28gaGlnaCIpOwogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICByZXR1cm4gdHJ1ZTsKICB9CgogIC8qVXRpbGl0eSBGdW5jdGlvbnMqLwoKICAvLy8gQGRldiBVc2VkIGxhdGVyIHRvIGNhbGN1bGF0ZSB0aGUgbnVtYmVyIG9mIGNvbmZpcm1hdGlvbnMgbmVlZGVkIGZvciB0eAogIC8vLyBAcGFyYW0gX3JlcXVpcmVkIE51bWJlciBvZiBzaWdzIHJlcXVpcmVkCiAgLy8vIEBwYXJhbSBfY291bnQgQ3VycmVudCBudW1iZXIgb2Ygc2lncwogIGZ1bmN0aW9uIGNhbGNDb25maXJtc05lZWRlZCh1aW50MjU2IF9yZXF1aXJlZCwgdWludDI1NiBfY291bnQpIHByaXZhdGUgcHVyZSByZXR1cm5zICh1aW50MjU2KSB7CiAgICByZXR1cm4gX3JlcXVpcmVkIC0gX2NvdW50OwogIH0KCiAgLypBZG1pbmlzdHJhdGl2ZSBGdW5jdGlvbnMqLwoKICAvLy8gQGRldiBDaGFuZ2VzIG93bmVyIGFkZHJlc3MgdG8gYSBuZXcgYWRkcmVzcwogIC8vLyBAcGFyYW0gc2VsZiBXYWxsZXQgaW4gY29udHJhY3Qgc3RvcmFnZQogIC8vLyBAcGFyYW0gX2Zyb20gQ3VycmVudCBvd25lciBhZGRyZXNzCiAgLy8vIEBwYXJhbSBfdG8gTmV3IGFkZHJlc3MKICAvLy8gQHBhcmFtIF9jb25maXJtIFRydWUgaWYgY29uZmlybWluZywgZmFsc2UgaWYgcmV2b2tpbmcgY29uZmlybWF0aW9uCiAgLy8vIEBwYXJhbSBfZGF0YSBNZXNzYWdlIGRhdGEgcGFzc2VkIGZyb20gd2FsbGV0IGNvbnRyYWN0CiAgLy8vIEByZXR1cm4gYm9vbCBSZXR1cm5zIHRydWUgaWYgc3VjY2Vzc2Z1bCwgZmFsc2Ugb3RoZXJ3aXNlCiAgLy8vIEByZXR1cm4gYnl0ZXMzMiBSZXR1cm5zIHRoZSB0eCBJRCwgY2FuIGJlIHVzZWQgZm9yIGNvbmZpcm0vcmV2b2tlIGZ1bmN0aW9ucwogIGZ1bmN0aW9uIGNoYW5nZU93bmVyKFdhbGxldE1haW5MaWIuV2FsbGV0RGF0YSBzdG9yYWdlIHNlbGYsCiAgICAgICAgICAgICAgICAgICAgICAgYWRkcmVzcyBfZnJvbSwKICAgICAgICAgICAgICAgICAgICAgICBhZGRyZXNzIF90bywKICAgICAgICAgICAgICAgICAgICAgICBib29sIF9jb25maXJtLAogICAgICAgICAgICAgICAgICAgICAgIGJ5dGVzIF9kYXRhKQogICAgICAgICAgICAgICAgICAgICAgIHB1YmxpYwogICAgICAgICAgICAgICAgICAgICAgIHJldHVybnMgKGJvb2wsYnl0ZXMzMikKICB7CiAgICBieXRlczMyIF9pZCA9IGtlY2NhazI1NigiY2hhbmdlT3duZXIiLF9mcm9tLF90byk7CiAgICB1aW50MjU2IF90eEluZGV4ID0gc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXS5sZW5ndGg7CiAgICBib29sIGFsbEdvb2Q7CgogICAgaWYobXNnLnNlbmRlciAhPSBhZGRyZXNzKHRoaXMpKXsKICAgICAgaWYoIV9jb25maXJtKSB7CiAgICAgICAgYWxsR29vZCA9IHNlbGYucmV2b2tlQ29uZmlybShfaWQpOwogICAgICAgIHJldHVybiAoYWxsR29vZCxfaWQpOwogICAgICB9IGVsc2UgewogICAgICAgIGlmKF90eEluZGV4ID09IDAgfHwgc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfdHhJbmRleCAtIDFdLnN1Y2Nlc3MpewogICAgICAgICAgcmVxdWlyZShzZWxmLm93bmVySW5kZXhbbXNnLnNlbmRlcl0gPiAwKTsKICAgICAgICAgIGFsbEdvb2QgPSBjaGVja0NoYW5nZU93bmVyQXJncyhzZWxmLm93bmVySW5kZXhbX2Zyb21dLCBzZWxmLm93bmVySW5kZXhbX3RvXSk7CiAgICAgICAgICBpZighYWxsR29vZCkKICAgICAgICAgICAgcmV0dXJuIChmYWxzZSwwKTsKCiAgICAgICAgICBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdLmxlbmd0aCsrOwogICAgICAgICAgc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfdHhJbmRleF0uY29uZmlybVJlcXVpcmVkID0gc2VsZi5yZXF1aXJlZEFkbWluOwogICAgICAgICAgc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfdHhJbmRleF0uZGF5ID0gbm93IC8gMSBkYXlzOwogICAgICAgICAgc2VsZi50cmFuc2FjdGlvbnNbbm93IC8gMSBkYXlzXS5wdXNoKF9pZCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIF90eEluZGV4LS07CiAgICAgICAgICBhbGxHb29kID0gc2VsZi5jaGVja05vdENvbmZpcm1lZChfaWQsIF90eEluZGV4KTsKICAgICAgICAgIGlmKCFhbGxHb29kKQogICAgICAgICAgICByZXR1cm4gKGZhbHNlLF9pZCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX3R4SW5kZXhdLmNvbmZpcm1lZE93bmVycy5wdXNoKHVpbnQyNTYobXNnLnNlbmRlcikpOwogICAgICBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW190eEluZGV4XS5jb25maXJtQ291bnQrKzsKICAgIH0gZWxzZSB7CiAgICAgIF90eEluZGV4LS07CiAgICB9CgogICAgaWYoc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfdHhJbmRleF0uY29uZmlybUNvdW50ID09CiAgICAgICBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW190eEluZGV4XS5jb25maXJtUmVxdWlyZWQpCiAgICB7CiAgICAgIHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX3R4SW5kZXhdLnN1Y2Nlc3MgPSB0cnVlOwogICAgICB1aW50MjU2IGkgPSBzZWxmLm93bmVySW5kZXhbX2Zyb21dOwogICAgICBzZWxmLm93bmVySW5kZXhbX2Zyb21dID0gMDsKICAgICAgc2VsZi5vd25lcnNbaV0gPSBfdG87CiAgICAgIHNlbGYub3duZXJJbmRleFtfdG9dID0gaTsKICAgICAgZGVsZXRlIHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX3R4SW5kZXhdLmRhdGE7CiAgICAgIExvZ093bmVyQ2hhbmdlZChfZnJvbSwgX3RvKTsKICAgIH0gZWxzZSB7CiAgICAgIGlmKHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX3R4SW5kZXhdLmRhdGEubGVuZ3RoID09IDApCiAgICAgICAgc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfdHhJbmRleF0uZGF0YSA9IF9kYXRhOwoKICAgICAgdWludDI1NiBjb25maXJtc05lZWRlZCA9IGNhbGNDb25maXJtc05lZWRlZChzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW190eEluZGV4XS5jb25maXJtUmVxdWlyZWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfdHhJbmRleF0uY29uZmlybUNvdW50KTsKCiAgICAgIExvZ1RyYW5zYWN0aW9uQ29uZmlybWVkKF9pZCwgbXNnLnNlbmRlciwgY29uZmlybXNOZWVkZWQpOwogICAgfQoKICAgIHJldHVybiAodHJ1ZSxfaWQpOwoJfQoKICAvLy8gQGRldiBBZGRzIG93bmVyIHRvIHdhbGxldAogIC8vLyBAcGFyYW0gc2VsZiBXYWxsZXQgaW4gY29udHJhY3Qgc3RvcmFnZQogIC8vLyBAcGFyYW0gX25ld093bmVyIEFkZHJlc3MgZm9yIG5ldyBvd25lcgogIC8vLyBAcGFyYW0gX2NvbmZpcm0gVHJ1ZSBpZiBjb25maXJtaW5nLCBmYWxzZSBpZiByZXZva2luZyBjb25maXJtYXRpb24KICAvLy8gQHBhcmFtIF9kYXRhIE1lc3NhZ2UgZGF0YSBwYXNzZWQgZnJvbSB3YWxsZXQgY29udHJhY3QKICAvLy8gQHJldHVybiBib29sIFJldHVybnMgdHJ1ZSBpZiBzdWNjZXNzZnVsLCBmYWxzZSBvdGhlcndpc2UKICAvLy8gQHJldHVybiBieXRlczMyIFJldHVybnMgdGhlIHR4IElELCBjYW4gYmUgdXNlZCBmb3IgY29uZmlybS9yZXZva2UgZnVuY3Rpb25zCiAgZnVuY3Rpb24gYWRkT3duZXIoV2FsbGV0TWFpbkxpYi5XYWxsZXREYXRhIHN0b3JhZ2Ugc2VsZiwKICAgICAgICAgICAgICAgICAgICBhZGRyZXNzIF9uZXdPd25lciwKICAgICAgICAgICAgICAgICAgICBib29sIF9jb25maXJtLAogICAgICAgICAgICAgICAgICAgIGJ5dGVzIF9kYXRhKQogICAgICAgICAgICAgICAgICAgIHB1YmxpYwogICAgICAgICAgICAgICAgICAgIHJldHVybnMgKGJvb2wsYnl0ZXMzMikKICB7CiAgICBieXRlczMyIF9pZCA9IGtlY2NhazI1NigiYWRkT3duZXIiLF9uZXdPd25lcik7CiAgICB1aW50MjU2IF90eEluZGV4ID0gc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXS5sZW5ndGg7CiAgICBib29sIGFsbEdvb2Q7CgogICAgaWYobXNnLnNlbmRlciAhPSBhZGRyZXNzKHRoaXMpKXsKICAgICAgcmVxdWlyZShfbmV3T3duZXIgIT0gMCk7CgogICAgICBpZighX2NvbmZpcm0pIHsKICAgICAgICBhbGxHb29kID0gc2VsZi5yZXZva2VDb25maXJtKF9pZCk7CiAgICAgICAgcmV0dXJuIChhbGxHb29kLF9pZCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYoX3R4SW5kZXggPT0gMCB8fCBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW190eEluZGV4IC0gMV0uc3VjY2Vzcyl7CiAgICAgICAgICByZXF1aXJlKHNlbGYub3duZXJJbmRleFttc2cuc2VuZGVyXSA+IDApOwogICAgICAgICAgYWxsR29vZCA9IGNoZWNrTmV3T3duZXJBcmdzKHNlbGYub3duZXJJbmRleFtfbmV3T3duZXJdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYub3duZXJzLmxlbmd0aCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLm1heE93bmVycyk7CiAgICAgICAgICBpZighYWxsR29vZCkKICAgICAgICAgICAgcmV0dXJuIChmYWxzZSwwKTsKCiAgICAgICAgICBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdLmxlbmd0aCsrOwogICAgICAgICAgc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfdHhJbmRleF0uY29uZmlybVJlcXVpcmVkID0gc2VsZi5yZXF1aXJlZEFkbWluOwogICAgICAgICAgc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfdHhJbmRleF0uZGF5ID0gbm93IC8gMSBkYXlzOwogICAgICAgICAgc2VsZi50cmFuc2FjdGlvbnNbbm93IC8gMSBkYXlzXS5wdXNoKF9pZCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIF90eEluZGV4LS07CiAgICAgICAgICBhbGxHb29kID0gc2VsZi5jaGVja05vdENvbmZpcm1lZChfaWQsIF90eEluZGV4KTsKICAgICAgICAgIGlmKCFhbGxHb29kKQogICAgICAgICAgICByZXR1cm4gKGZhbHNlLF9pZCk7CiAgICAgICAgfQogICAgICB9CgogICAgICBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW190eEluZGV4XS5jb25maXJtZWRPd25lcnMucHVzaCh1aW50MjU2KG1zZy5zZW5kZXIpKTsKICAgICAgc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfdHhJbmRleF0uY29uZmlybUNvdW50Kys7CiAgICB9IGVsc2UgewogICAgICBfdHhJbmRleC0tOwogICAgfQoKICAgIGlmKHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX3R4SW5kZXhdLmNvbmZpcm1Db3VudCA9PQogICAgICAgc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfdHhJbmRleF0uY29uZmlybVJlcXVpcmVkKQogICAgewogICAgICBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW190eEluZGV4XS5zdWNjZXNzID0gdHJ1ZTsKICAgICAgc2VsZi5vd25lcnMucHVzaChfbmV3T3duZXIpOwogICAgICBzZWxmLm93bmVySW5kZXhbX25ld093bmVyXSA9IHNlbGYub3duZXJzLmxlbmd0aCAtIDE7CiAgICAgIGRlbGV0ZSBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW190eEluZGV4XS5kYXRhOwogICAgICBMb2dPd25lckFkZGVkKF9uZXdPd25lcik7CiAgICB9IGVsc2UgewogICAgICBpZihzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW190eEluZGV4XS5kYXRhLmxlbmd0aCA9PSAwKQogICAgICAgIHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX3R4SW5kZXhdLmRhdGEgPSBfZGF0YTsKCiAgICAgIHVpbnQyNTYgY29uZmlybXNOZWVkZWQgPSBjYWxjQ29uZmlybXNOZWVkZWQoc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfdHhJbmRleF0uY29uZmlybVJlcXVpcmVkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX3R4SW5kZXhdLmNvbmZpcm1Db3VudCk7CiAgICAgIExvZ1RyYW5zYWN0aW9uQ29uZmlybWVkKF9pZCwgbXNnLnNlbmRlciwgY29uZmlybXNOZWVkZWQpOwogICAgfQoKICAgIHJldHVybiAodHJ1ZSxfaWQpOwoJfQoKICAvLy8gQGRldiBSZW1vdmVzIG93bmVyIGZyb20gd2FsbGV0CiAgLy8vIEBwYXJhbSBzZWxmIFdhbGxldCBpbiBjb250cmFjdCBzdG9yYWdlCiAgLy8vIEBwYXJhbSBfb3duZXJSZW1vdmluZyBBZGRyZXNzIG9mIG93bmVyIHRvIGJlIHJlbW92ZWQKICAvLy8gQHBhcmFtIF9jb25maXJtIFRydWUgaWYgY29uZmlybWluZywgZmFsc2UgaWYgcmV2b2tpbmcgY29uZmlybWF0aW9uCiAgLy8vIEBwYXJhbSBfZGF0YSBNZXNzYWdlIGRhdGEgcGFzc2VkIGZyb20gd2FsbGV0IGNvbnRyYWN0CiAgLy8vIEByZXR1cm4gYm9vbCBSZXR1cm5zIHRydWUgaWYgc3VjY2Vzc2Z1bCwgZmFsc2Ugb3RoZXJ3aXNlCiAgLy8vIEByZXR1cm4gYnl0ZXMzMiBSZXR1cm5zIHRoZSB0eCBJRCwgY2FuIGJlIHVzZWQgZm9yIGNvbmZpcm0vcmV2b2tlIGZ1bmN0aW9ucwogIGZ1bmN0aW9uIHJlbW92ZU93bmVyKFdhbGxldE1haW5MaWIuV2FsbGV0RGF0YSBzdG9yYWdlIHNlbGYsCiAgICAgICAgICAgICAgICAgICAgICAgYWRkcmVzcyBfb3duZXJSZW1vdmluZywKICAgICAgICAgICAgICAgICAgICAgICBib29sIF9jb25maXJtLAogICAgICAgICAgICAgICAgICAgICAgIGJ5dGVzIF9kYXRhKQogICAgICAgICAgICAgICAgICAgICAgIHB1YmxpYwogICAgICAgICAgICAgICAgICAgICAgIHJldHVybnMgKGJvb2wsYnl0ZXMzMikKICB7CiAgICBieXRlczMyIF9pZCA9IGtlY2NhazI1NigicmVtb3ZlT3duZXIiLF9vd25lclJlbW92aW5nKTsKICAgIHVpbnQyNTYgX3R4SW5kZXggPSBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdLmxlbmd0aDsKICAgIGJvb2wgYWxsR29vZDsKCiAgICBpZihtc2cuc2VuZGVyICE9IGFkZHJlc3ModGhpcykpewogICAgICBpZighX2NvbmZpcm0pIHsKICAgICAgICBhbGxHb29kID0gc2VsZi5yZXZva2VDb25maXJtKF9pZCk7CiAgICAgICAgcmV0dXJuIChhbGxHb29kLF9pZCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYoX3R4SW5kZXggPT0gMCB8fCBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW190eEluZGV4IC0gMV0uc3VjY2Vzcyl7CiAgICAgICAgICByZXF1aXJlKHNlbGYub3duZXJJbmRleFttc2cuc2VuZGVyXSA+IDApOwogICAgICAgICAgYWxsR29vZCA9IGNoZWNrUmVtb3ZlT3duZXJBcmdzKHNlbGYub3duZXJJbmRleFtfb3duZXJSZW1vdmluZ10sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5vd25lcnMubGVuZ3RoLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYucmVxdWlyZWRBZG1pbik7CiAgICAgICAgICBpZighYWxsR29vZCkKICAgICAgICAgICAgcmV0dXJuIChmYWxzZSwwKTsKCiAgICAgICAgICBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdLmxlbmd0aCsrOwogICAgICAgICAgc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfdHhJbmRleF0uY29uZmlybVJlcXVpcmVkID0gc2VsZi5yZXF1aXJlZEFkbWluOwogICAgICAgICAgc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfdHhJbmRleF0uZGF5ID0gbm93IC8gMSBkYXlzOwogICAgICAgICAgc2VsZi50cmFuc2FjdGlvbnNbbm93IC8gMSBkYXlzXS5wdXNoKF9pZCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIF90eEluZGV4LS07CiAgICAgICAgICBhbGxHb29kID0gc2VsZi5jaGVja05vdENvbmZpcm1lZChfaWQsIF90eEluZGV4KTsKICAgICAgICAgIGlmKCFhbGxHb29kKQogICAgICAgICAgICByZXR1cm4gKGZhbHNlLF9pZCk7CiAgICAgICAgfQogICAgICB9CgogICAgICBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW190eEluZGV4XS5jb25maXJtZWRPd25lcnMucHVzaCh1aW50MjU2KG1zZy5zZW5kZXIpKTsKICAgICAgc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfdHhJbmRleF0uY29uZmlybUNvdW50Kys7CiAgICB9IGVsc2UgewogICAgICBfdHhJbmRleC0tOwogICAgfQoKICAgIGlmKHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX3R4SW5kZXhdLmNvbmZpcm1Db3VudCA9PQogICAgICAgc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfdHhJbmRleF0uY29uZmlybVJlcXVpcmVkKQogICAgewogICAgICBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW190eEluZGV4XS5zdWNjZXNzID0gdHJ1ZTsKICAgICAgc2VsZi5vd25lcnNbc2VsZi5vd25lckluZGV4W19vd25lclJlbW92aW5nXV0gPSBzZWxmLm93bmVyc1tzZWxmLm93bmVycy5sZW5ndGggLSAxXTsKICAgICAgc2VsZi5vd25lckluZGV4W3NlbGYub3duZXJzW3NlbGYub3duZXJzLmxlbmd0aCAtIDFdXSA9IHNlbGYub3duZXJJbmRleFtfb3duZXJSZW1vdmluZ107CiAgICAgIHNlbGYub3duZXJJbmRleFtfb3duZXJSZW1vdmluZ10gPSAwOwogICAgICBzZWxmLm93bmVycy5sZW5ndGgtLTsKICAgICAgZGVsZXRlIHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX3R4SW5kZXhdLmRhdGE7CiAgICAgIExvZ093bmVyUmVtb3ZlZChfb3duZXJSZW1vdmluZyk7CiAgICB9IGVsc2UgewogICAgICBpZihzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW190eEluZGV4XS5kYXRhLmxlbmd0aCA9PSAwKQogICAgICAgIHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX3R4SW5kZXhdLmRhdGEgPSBfZGF0YTsKCiAgICAgIHVpbnQyNTYgY29uZmlybXNOZWVkZWQgPSBjYWxjQ29uZmlybXNOZWVkZWQoc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfdHhJbmRleF0uY29uZmlybVJlcXVpcmVkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX3R4SW5kZXhdLmNvbmZpcm1Db3VudCk7CiAgICAgIExvZ1RyYW5zYWN0aW9uQ29uZmlybWVkKF9pZCwgbXNnLnNlbmRlciwgY29uZmlybXNOZWVkZWQpOwogICAgfQoKICAgIHJldHVybiAodHJ1ZSxfaWQpOwoJfQoKICAvLy8gQGRldiBDaGFuZ2VzIHJlcXVpcmVkIHNpZ3MgdG8gY2hhbmdlIHdhbGxldCBwYXJhbWV0ZXJzCiAgLy8vIEBwYXJhbSBzZWxmIFdhbGxldCBpbiBjb250cmFjdCBzdG9yYWdlCiAgLy8vIEBwYXJhbSBfcmVxdWlyZWRBZG1pbiBUaGUgbmV3IHNpZ25hdHVyZSByZXF1aXJlbWVudAogIC8vLyBAcGFyYW0gX2NvbmZpcm0gVHJ1ZSBpZiBjb25maXJtaW5nLCBmYWxzZSBpZiByZXZva2luZyBjb25maXJtYXRpb24KICAvLy8gQHBhcmFtIF9kYXRhIE1lc3NhZ2UgZGF0YSBwYXNzZWQgZnJvbSB3YWxsZXQgY29udHJhY3QKICAvLy8gQHJldHVybiBib29sIFJldHVybnMgdHJ1ZSBpZiBzdWNjZXNzZnVsLCBmYWxzZSBvdGhlcndpc2UKICAvLy8gQHJldHVybiBieXRlczMyIFJldHVybnMgdGhlIHR4IElELCBjYW4gYmUgdXNlZCBmb3IgY29uZmlybS9yZXZva2UgZnVuY3Rpb25zCiAgZnVuY3Rpb24gY2hhbmdlUmVxdWlyZWRBZG1pbihXYWxsZXRNYWluTGliLldhbGxldERhdGEgc3RvcmFnZSBzZWxmLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdWludDI1NiBfcmVxdWlyZWRBZG1pbiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJvb2wgX2NvbmZpcm0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBieXRlcyBfZGF0YSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHB1YmxpYwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJucyAoYm9vbCxieXRlczMyKQogIHsKICAgIGJ5dGVzMzIgX2lkID0ga2VjY2FrMjU2KCJjaGFuZ2VSZXF1aXJlZEFkbWluIixfcmVxdWlyZWRBZG1pbik7CiAgICB1aW50MjU2IF90eEluZGV4ID0gc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXS5sZW5ndGg7CgogICAgaWYobXNnLnNlbmRlciAhPSBhZGRyZXNzKHRoaXMpKXsKICAgICAgYm9vbCBhbGxHb29kOwoKICAgICAgaWYoIV9jb25maXJtKSB7CiAgICAgICAgYWxsR29vZCA9IHNlbGYucmV2b2tlQ29uZmlybShfaWQpOwogICAgICAgIHJldHVybiAoYWxsR29vZCxfaWQpOwogICAgICB9IGVsc2UgewogICAgICAgIGlmKF90eEluZGV4ID09IDAgfHwgc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfdHhJbmRleCAtIDFdLnN1Y2Nlc3MpewogICAgICAgICAgcmVxdWlyZShzZWxmLm93bmVySW5kZXhbbXNnLnNlbmRlcl0gPiAwKTsKICAgICAgICAgIGFsbEdvb2QgPSBjaGVja1JlcXVpcmVkQ2hhbmdlKF9yZXF1aXJlZEFkbWluLCBzZWxmLm93bmVycy5sZW5ndGgpOwogICAgICAgICAgaWYoIWFsbEdvb2QpCiAgICAgICAgICAgIHJldHVybiAoZmFsc2UsMCk7CgogICAgICAgICAgc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXS5sZW5ndGgrKzsKICAgICAgICAgIHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX3R4SW5kZXhdLmNvbmZpcm1SZXF1aXJlZCA9IHNlbGYucmVxdWlyZWRBZG1pbjsKICAgICAgICAgIHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX3R4SW5kZXhdLmRheSA9IG5vdyAvIDEgZGF5czsKICAgICAgICAgIHNlbGYudHJhbnNhY3Rpb25zW25vdyAvIDEgZGF5c10ucHVzaChfaWQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBfdHhJbmRleC0tOwogICAgICAgICAgYWxsR29vZCA9IHNlbGYuY2hlY2tOb3RDb25maXJtZWQoX2lkLCBfdHhJbmRleCk7CiAgICAgICAgICBpZighYWxsR29vZCkKICAgICAgICAgICAgcmV0dXJuIChmYWxzZSxfaWQpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfdHhJbmRleF0uY29uZmlybWVkT3duZXJzLnB1c2godWludDI1Nihtc2cuc2VuZGVyKSk7CiAgICAgIHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX3R4SW5kZXhdLmNvbmZpcm1Db3VudCsrOwogICAgfSBlbHNlIHsKICAgICAgX3R4SW5kZXgtLTsKICAgIH0KCiAgICBpZihzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW190eEluZGV4XS5jb25maXJtQ291bnQgPT0KICAgICAgc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfdHhJbmRleF0uY29uZmlybVJlcXVpcmVkKQogICAgewogICAgICBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW190eEluZGV4XS5zdWNjZXNzID0gdHJ1ZTsKICAgICAgc2VsZi5yZXF1aXJlZEFkbWluID0gX3JlcXVpcmVkQWRtaW47CiAgICAgIGRlbGV0ZSBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW190eEluZGV4XS5kYXRhOwogICAgICBMb2dSZXF1aXJlbWVudENoYW5nZShfcmVxdWlyZWRBZG1pbik7CiAgICB9IGVsc2UgewogICAgICBpZihzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW190eEluZGV4XS5kYXRhLmxlbmd0aCA9PSAwKQogICAgICAgIHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX3R4SW5kZXhdLmRhdGEgPSBfZGF0YTsKCiAgICAgIHVpbnQyNTYgY29uZmlybXNOZWVkZWQgPSBjYWxjQ29uZmlybXNOZWVkZWQoc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfdHhJbmRleF0uY29uZmlybVJlcXVpcmVkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX3R4SW5kZXhdLmNvbmZpcm1Db3VudCk7CiAgICAgIExvZ1RyYW5zYWN0aW9uQ29uZmlybWVkKF9pZCwgbXNnLnNlbmRlciwgY29uZmlybXNOZWVkZWQpOwogICAgfQoKICAgIHJldHVybiAodHJ1ZSxfaWQpOwoJfQoKICAvLy8gQGRldiBDaGFuZ2VzIHJlcXVpcmVkIHNpZ3MgZm9yIG1ham9yIHRyYW5zYWN0aW9ucwogIC8vLyBAcGFyYW0gc2VsZiBXYWxsZXQgaW4gY29udHJhY3Qgc3RvcmFnZQogIC8vLyBAcGFyYW0gX3JlcXVpcmVkTWFqb3IgVGhlIG5ldyBzaWduYXR1cmUgcmVxdWlyZW1lbnQKICAvLy8gQHBhcmFtIF9jb25maXJtIFRydWUgaWYgY29uZmlybWluZywgZmFsc2UgaWYgcmV2b2tpbmcgY29uZmlybWF0aW9uCiAgLy8vIEBwYXJhbSBfZGF0YSBNZXNzYWdlIGRhdGEgcGFzc2VkIGZyb20gd2FsbGV0IGNvbnRyYWN0CiAgLy8vIEByZXR1cm4gYm9vbCBSZXR1cm5zIHRydWUgaWYgc3VjY2Vzc2Z1bCwgZmFsc2Ugb3RoZXJ3aXNlCiAgLy8vIEByZXR1cm4gYnl0ZXMzMiBSZXR1cm5zIHRoZSB0eCBJRCwgY2FuIGJlIHVzZWQgZm9yIGNvbmZpcm0vcmV2b2tlIGZ1bmN0aW9ucwogIGZ1bmN0aW9uIGNoYW5nZVJlcXVpcmVkTWFqb3IoV2FsbGV0TWFpbkxpYi5XYWxsZXREYXRhIHN0b3JhZ2Ugc2VsZiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVpbnQyNTYgX3JlcXVpcmVkTWFqb3IsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBib29sIF9jb25maXJtLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnl0ZXMgX2RhdGEpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwdWJsaWMKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybnMgKGJvb2wsYnl0ZXMzMikKICB7CiAgICBieXRlczMyIF9pZCA9IGtlY2NhazI1NigiY2hhbmdlUmVxdWlyZWRNYWpvciIsX3JlcXVpcmVkTWFqb3IpOwogICAgdWludDI1NiBfdHhJbmRleCA9IHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF0ubGVuZ3RoOwoKICAgIGlmKG1zZy5zZW5kZXIgIT0gYWRkcmVzcyh0aGlzKSl7CiAgICAgIGJvb2wgYWxsR29vZDsKCiAgICAgIGlmKCFfY29uZmlybSkgewogICAgICAgIGFsbEdvb2QgPSBzZWxmLnJldm9rZUNvbmZpcm0oX2lkKTsKICAgICAgICByZXR1cm4gKGFsbEdvb2QsX2lkKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZihfdHhJbmRleCA9PSAwIHx8IHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX3R4SW5kZXggLSAxXS5zdWNjZXNzKXsKICAgICAgICAgIHJlcXVpcmUoc2VsZi5vd25lckluZGV4W21zZy5zZW5kZXJdID4gMCk7CiAgICAgICAgICBhbGxHb29kID0gY2hlY2tSZXF1aXJlZENoYW5nZShfcmVxdWlyZWRNYWpvciwgc2VsZi5vd25lcnMubGVuZ3RoKTsKICAgICAgICAgIGlmKCFhbGxHb29kKQogICAgICAgICAgICByZXR1cm4gKGZhbHNlLDApOwoKICAgICAgICAgIHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF0ubGVuZ3RoKys7CiAgICAgICAgICBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW190eEluZGV4XS5jb25maXJtUmVxdWlyZWQgPSBzZWxmLnJlcXVpcmVkQWRtaW47CiAgICAgICAgICBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW190eEluZGV4XS5kYXkgPSBub3cgLyAxIGRheXM7CiAgICAgICAgICBzZWxmLnRyYW5zYWN0aW9uc1tub3cgLyAxIGRheXNdLnB1c2goX2lkKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgX3R4SW5kZXgtLTsKICAgICAgICAgIGFsbEdvb2QgPSBzZWxmLmNoZWNrTm90Q29uZmlybWVkKF9pZCwgX3R4SW5kZXgpOwogICAgICAgICAgaWYoIWFsbEdvb2QpCiAgICAgICAgICAgIHJldHVybiAoZmFsc2UsX2lkKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX3R4SW5kZXhdLmNvbmZpcm1lZE93bmVycy5wdXNoKHVpbnQyNTYobXNnLnNlbmRlcikpOwogICAgICBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW190eEluZGV4XS5jb25maXJtQ291bnQrKzsKICAgIH0gZWxzZSB7CiAgICAgIF90eEluZGV4LS07CiAgICB9CgogICAgaWYoc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfdHhJbmRleF0uY29uZmlybUNvdW50ID09CiAgICAgICBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW190eEluZGV4XS5jb25maXJtUmVxdWlyZWQpCiAgICB7CiAgICAgIHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX3R4SW5kZXhdLnN1Y2Nlc3MgPSB0cnVlOwogICAgICBzZWxmLnJlcXVpcmVkTWFqb3IgPSBfcmVxdWlyZWRNYWpvcjsKICAgICAgZGVsZXRlIHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX3R4SW5kZXhdLmRhdGE7CiAgICAgIExvZ1JlcXVpcmVtZW50Q2hhbmdlKF9yZXF1aXJlZE1ham9yKTsKICAgIH0gZWxzZSB7CiAgICAgIGlmKHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX3R4SW5kZXhdLmRhdGEubGVuZ3RoID09IDApCiAgICAgICAgc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfdHhJbmRleF0uZGF0YSA9IF9kYXRhOwoKICAgICAgdWludDI1NiBjb25maXJtc05lZWRlZCA9IGNhbGNDb25maXJtc05lZWRlZChzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW190eEluZGV4XS5jb25maXJtUmVxdWlyZWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfdHhJbmRleF0uY29uZmlybUNvdW50KTsKICAgICAgTG9nVHJhbnNhY3Rpb25Db25maXJtZWQoX2lkLCBtc2cuc2VuZGVyLCBjb25maXJtc05lZWRlZCk7CiAgICB9CgogICAgcmV0dXJuICh0cnVlLF9pZCk7Cgl9CgogIC8vLyBAZGV2IENoYW5nZXMgcmVxdWlyZWQgc2lncyBmb3IgbWlub3IgdHJhbnNhY3Rpb25zCiAgLy8vIEBwYXJhbSBzZWxmIFdhbGxldCBpbiBjb250cmFjdCBzdG9yYWdlCiAgLy8vIEBwYXJhbSBfcmVxdWlyZWRNaW5vciBUaGUgbmV3IHNpZ25hdHVyZSByZXF1aXJlbWVudAogIC8vLyBAcGFyYW0gX2NvbmZpcm0gVHJ1ZSBpZiBjb25maXJtaW5nLCBmYWxzZSBpZiByZXZva2luZyBjb25maXJtYXRpb24KICAvLy8gQHBhcmFtIF9kYXRhIE1lc3NhZ2UgZGF0YSBwYXNzZWQgZnJvbSB3YWxsZXQgY29udHJhY3QKICAvLy8gQHJldHVybiBib29sIFJldHVybnMgdHJ1ZSBpZiBzdWNjZXNzZnVsLCBmYWxzZSBvdGhlcndpc2UKICAvLy8gQHJldHVybiBieXRlczMyIFJldHVybnMgdGhlIHR4IElELCBjYW4gYmUgdXNlZCBmb3IgY29uZmlybS9yZXZva2UgZnVuY3Rpb25zCiAgZnVuY3Rpb24gY2hhbmdlUmVxdWlyZWRNaW5vcihXYWxsZXRNYWluTGliLldhbGxldERhdGEgc3RvcmFnZSBzZWxmLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdWludDI1NiBfcmVxdWlyZWRNaW5vciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJvb2wgX2NvbmZpcm0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBieXRlcyBfZGF0YSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHB1YmxpYwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJucyAoYm9vbCxieXRlczMyKQogIHsKICAgIGJ5dGVzMzIgX2lkID0ga2VjY2FrMjU2KCJjaGFuZ2VSZXF1aXJlZE1pbm9yIixfcmVxdWlyZWRNaW5vcik7CiAgICB1aW50MjU2IF90eEluZGV4ID0gc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXS5sZW5ndGg7CgogICAgaWYobXNnLnNlbmRlciAhPSBhZGRyZXNzKHRoaXMpKXsKICAgICAgYm9vbCBhbGxHb29kOwoKICAgICAgaWYoIV9jb25maXJtKSB7CiAgICAgICAgYWxsR29vZCA9IHNlbGYucmV2b2tlQ29uZmlybShfaWQpOwogICAgICAgIHJldHVybiAoYWxsR29vZCxfaWQpOwogICAgICB9IGVsc2UgewogICAgICAgIGlmKF90eEluZGV4ID09IDAgfHwgc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfdHhJbmRleCAtIDFdLnN1Y2Nlc3MpewogICAgICAgICAgcmVxdWlyZShzZWxmLm93bmVySW5kZXhbbXNnLnNlbmRlcl0gPiAwKTsKICAgICAgICAgIGFsbEdvb2QgPSBjaGVja1JlcXVpcmVkQ2hhbmdlKF9yZXF1aXJlZE1pbm9yLCBzZWxmLm93bmVycy5sZW5ndGgpOwogICAgICAgICAgaWYoIWFsbEdvb2QpCiAgICAgICAgICAgIHJldHVybiAoZmFsc2UsMCk7CgogICAgICAgICAgc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXS5sZW5ndGgrKzsKICAgICAgICAgIHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX3R4SW5kZXhdLmNvbmZpcm1SZXF1aXJlZCA9IHNlbGYucmVxdWlyZWRBZG1pbjsKICAgICAgICAgIHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX3R4SW5kZXhdLmRheSA9IG5vdyAvIDEgZGF5czsKICAgICAgICAgIHNlbGYudHJhbnNhY3Rpb25zW25vdyAvIDEgZGF5c10ucHVzaChfaWQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBfdHhJbmRleC0tOwogICAgICAgICAgYWxsR29vZCA9IHNlbGYuY2hlY2tOb3RDb25maXJtZWQoX2lkLCBfdHhJbmRleCk7CiAgICAgICAgICBpZighYWxsR29vZCkKICAgICAgICAgICAgcmV0dXJuIChmYWxzZSxfaWQpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfdHhJbmRleF0uY29uZmlybWVkT3duZXJzLnB1c2godWludDI1Nihtc2cuc2VuZGVyKSk7CiAgICAgIHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX3R4SW5kZXhdLmNvbmZpcm1Db3VudCsrOwogICAgfSBlbHNlIHsKICAgICAgX3R4SW5kZXgtLTsKICAgIH0KCiAgICBpZihzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW190eEluZGV4XS5jb25maXJtQ291bnQgPT0KICAgICAgIHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX3R4SW5kZXhdLmNvbmZpcm1SZXF1aXJlZCkKICAgIHsKICAgICAgc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfdHhJbmRleF0uc3VjY2VzcyA9IHRydWU7CiAgICAgIHNlbGYucmVxdWlyZWRNaW5vciA9IF9yZXF1aXJlZE1pbm9yOwogICAgICBkZWxldGUgc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfdHhJbmRleF0uZGF0YTsKICAgICAgTG9nUmVxdWlyZW1lbnRDaGFuZ2UoX3JlcXVpcmVkTWlub3IpOwogICAgfSBlbHNlIHsKICAgICAgaWYoc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfdHhJbmRleF0uZGF0YS5sZW5ndGggPT0gMCkKICAgICAgICBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW190eEluZGV4XS5kYXRhID0gX2RhdGE7CgogICAgICB1aW50MjU2IGNvbmZpcm1zTmVlZGVkID0gY2FsY0NvbmZpcm1zTmVlZGVkKHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX3R4SW5kZXhdLmNvbmZpcm1SZXF1aXJlZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW190eEluZGV4XS5jb25maXJtQ291bnQpOwogICAgICBMb2dUcmFuc2FjdGlvbkNvbmZpcm1lZChfaWQsIG1zZy5zZW5kZXIsIGNvbmZpcm1zTmVlZGVkKTsKICAgIH0KCiAgICByZXR1cm4gKHRydWUsX2lkKTsKCX0KCiAgLy8vIEBkZXYgQ2hhbmdlcyB0aHJlc2hvbGQgZm9yIG1ham9yIHRyYW5zYWN0aW9uIGRheSBzcGVuZCBwZXIgdG9rZW4KICAvLy8gQHBhcmFtIHNlbGYgV2FsbGV0IGluIGNvbnRyYWN0IHN0b3JhZ2UKICAvLy8gQHBhcmFtIF90b2tlbiBBZGRyZXNzIG9mIHRva2VuLCBldGhlciBpcyAwCiAgLy8vIEBwYXJhbSBfbWFqb3JUaHJlc2hvbGQgTmV3IHRocmVzaG9sZAogIC8vLyBAcGFyYW0gX2NvbmZpcm0gVHJ1ZSBpZiBjb25maXJtaW5nLCBmYWxzZSBpZiByZXZva2luZyBjb25maXJtYXRpb24KICAvLy8gQHBhcmFtIF9kYXRhIE1lc3NhZ2UgZGF0YSBwYXNzZWQgZnJvbSB3YWxsZXQgY29udHJhY3QKICAvLy8gQHJldHVybiBib29sIFJldHVybnMgdHJ1ZSBpZiBzdWNjZXNzZnVsLCBmYWxzZSBvdGhlcndpc2UKICAvLy8gQHJldHVybiBieXRlczMyIFJldHVybnMgdGhlIHR4IElELCBjYW4gYmUgdXNlZCBmb3IgY29uZmlybS9yZXZva2UgZnVuY3Rpb25zCiAgZnVuY3Rpb24gY2hhbmdlTWFqb3JUaHJlc2hvbGQoV2FsbGV0TWFpbkxpYi5XYWxsZXREYXRhIHN0b3JhZ2Ugc2VsZiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRyZXNzIF90b2tlbiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1aW50MjU2IF9tYWpvclRocmVzaG9sZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBib29sIF9jb25maXJtLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJ5dGVzIF9kYXRhKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHB1YmxpYwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybnMgKGJvb2wsYnl0ZXMzMikKICB7CiAgICBieXRlczMyIF9pZCA9IGtlY2NhazI1NigiY2hhbmdlTWFqb3JUaHJlc2hvbGQiLCBfdG9rZW4sIF9tYWpvclRocmVzaG9sZCk7CiAgICB1aW50MjU2IF90eEluZGV4ID0gc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXS5sZW5ndGg7CgogICAgaWYobXNnLnNlbmRlciAhPSBhZGRyZXNzKHRoaXMpKXsKICAgICAgYm9vbCBhbGxHb29kOwoKICAgICAgaWYoIV9jb25maXJtKSB7CiAgICAgICAgYWxsR29vZCA9IHNlbGYucmV2b2tlQ29uZmlybShfaWQpOwogICAgICAgIHJldHVybiAoYWxsR29vZCxfaWQpOwogICAgICB9IGVsc2UgewogICAgICAgIGlmKF90eEluZGV4ID09IDAgfHwgc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfdHhJbmRleCAtIDFdLnN1Y2Nlc3MpewogICAgICAgICAgcmVxdWlyZShzZWxmLm93bmVySW5kZXhbbXNnLnNlbmRlcl0gPiAwKTsKCiAgICAgICAgICBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdLmxlbmd0aCsrOwogICAgICAgICAgc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfdHhJbmRleF0uY29uZmlybVJlcXVpcmVkID0gc2VsZi5yZXF1aXJlZEFkbWluOwogICAgICAgICAgc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfdHhJbmRleF0uZGF5ID0gbm93IC8gMSBkYXlzOwogICAgICAgICAgc2VsZi50cmFuc2FjdGlvbnNbbm93IC8gMSBkYXlzXS5wdXNoKF9pZCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIF90eEluZGV4LS07CiAgICAgICAgICBhbGxHb29kID0gc2VsZi5jaGVja05vdENvbmZpcm1lZChfaWQsIF90eEluZGV4KTsKICAgICAgICAgIGlmKCFhbGxHb29kKQogICAgICAgICAgICByZXR1cm4gKGZhbHNlLF9pZCk7CiAgICAgICAgfQogICAgICB9CgogICAgICBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW190eEluZGV4XS5jb25maXJtZWRPd25lcnMucHVzaCh1aW50MjU2KG1zZy5zZW5kZXIpKTsKICAgICAgc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfdHhJbmRleF0uY29uZmlybUNvdW50Kys7CiAgICB9IGVsc2UgewogICAgICBfdHhJbmRleC0tOwogICAgfQoKICAgIGlmKHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX3R4SW5kZXhdLmNvbmZpcm1Db3VudCA9PQogICAgICAgc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfdHhJbmRleF0uY29uZmlybVJlcXVpcmVkKQogICAgewogICAgICBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW190eEluZGV4XS5zdWNjZXNzID0gdHJ1ZTsKICAgICAgc2VsZi5tYWpvclRocmVzaG9sZFtfdG9rZW5dID0gX21ham9yVGhyZXNob2xkOwogICAgICBkZWxldGUgc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfdHhJbmRleF0uZGF0YTsKICAgICAgTG9nVGhyZXNob2xkQ2hhbmdlKF90b2tlbiwgX21ham9yVGhyZXNob2xkKTsKICAgIH0gZWxzZSB7CiAgICAgIGlmKHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX3R4SW5kZXhdLmRhdGEubGVuZ3RoID09IDApCiAgICAgICAgc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfdHhJbmRleF0uZGF0YSA9IF9kYXRhOwoKICAgICAgdWludDI1NiBjb25maXJtc05lZWRlZCA9IGNhbGNDb25maXJtc05lZWRlZChzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW190eEluZGV4XS5jb25maXJtUmVxdWlyZWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfdHhJbmRleF0uY29uZmlybUNvdW50KTsKICAgICAgTG9nVHJhbnNhY3Rpb25Db25maXJtZWQoX2lkLCBtc2cuc2VuZGVyLCBjb25maXJtc05lZWRlZCk7CiAgICB9CgogICAgcmV0dXJuICh0cnVlLF9pZCk7Cgl9Cn0KCmxpYnJhcnkgV2FsbGV0TWFpbkxpYiB7CiAgdXNpbmcgQXJyYXkyNTZMaWIgZm9yIHVpbnQyNTZbXTsKICB1c2luZyBCYXNpY01hdGhMaWIgZm9yIHVpbnQyNTY7CgogIHN0cnVjdCBXYWxsZXREYXRhIHsKICAgIHVpbnQyNTYgbWF4T3duZXJzOyAvL01heGltdW0gd2FsbGV0IG93bmVycywgc2hvdWxkIGJlIDUwCiAgICBhZGRyZXNzW10gb3duZXJzOyAvL0FycmF5IG9mIGFsbCBvd25lcnMKICAgIHVpbnQyNTYgcmVxdWlyZWRBZG1pbjsgLy9OdW1iZXIgb2Ygc2lncyByZXF1aXJlZCBmb3IgYWRtaW5pc3RyYXRpdmUgY2hhbmdlcwogICAgdWludDI1NiByZXF1aXJlZE1ham9yOyAvL051bWJlciBvZiBzaWdzIHJlcXVpcmVkIGZvciBtYWpvciB0cmFuc2FjdGlvbnMKICAgIHVpbnQyNTYgcmVxdWlyZWRNaW5vcjsgLy9OdW1iZXIgb2Ygc2lncyByZXF1aXJlZCBmb3IgbWlub3IgdHJhbnNhY3Rpb25zCgogICAgLy8gVGhlIGFtb3VudCBvZiBhIHRva2VuIHNwZW50IHBlciBkYXksIGV0aGVyIGlzIGF0IGFkZHJlc3MgbWFwcGluZyAwLAogICAgLy8gYWxsIG90aGVyIHRva2VucyBkZWZpbmVkIGJ5IGFkZHJlc3MuIHVpbnQyNTZbMF0gY29ycmVzcG9uZHMgdG8gdGhlIGN1cnJlbnQKICAgIC8vIGRheSwgIHVpbnQyNTZbMV0gaXMgdGhlIHNwZW5kIGFtb3VudAogICAgbWFwcGluZyAoYWRkcmVzcyA9PiB1aW50MjU2WzJdKSBjdXJyZW50U3BlbmQ7CiAgICAvL1RoZSBkYXkgc3BlbmQgdGhyZXNob2xkIGZvciB0cmFuc2FjdGlvbnMgdG8gYmUgbWFqb3IsIGV0aGVyIGF0IDAsIGFsbCBvdGhlcnMgYnkgYWRkcmVzcwogICAgbWFwcGluZyAoYWRkcmVzcyA9PiB1aW50MjU2KSBtYWpvclRocmVzaG9sZDsKICAgIC8vQXJyYXkgb2YgdHJhbnNhY3Rpb25zIHBlciBkYXksIHVpbnQyNTYgaXMgdGhlIGRheSB0aW1lc3RhbXAsIGJ5dGVzMzIgaXMgdGhlIHRyYW5zYWN0aW9uIGlkCiAgICBtYXBwaW5nICh1aW50MjU2ID0+IGJ5dGVzMzJbXSkgdHJhbnNhY3Rpb25zOwogICAgLy9UcmFja3MgdGhlIGluZGV4IG9mIGVhY2ggb3duZXIgaW4gdGhlIG93bmVycyBBcnJheQogICAgbWFwcGluZyAoYWRkcmVzcyA9PiB1aW50MjU2KSBvd25lckluZGV4OwogICAgLy9BcnJheSBvZiBUcmFuc2FjdGlvbidzIGJ5IGlkLCBuZXcgdHgncyB3aXRoIGV4YWN0IGlucHV0cyBhcyBwcmV2aW91cyB0eCB3aWxsIGFkZCB0byBhcnJheQogICAgbWFwcGluZyAoYnl0ZXMzMiA9PiBUcmFuc2FjdGlvbltdKSB0cmFuc2FjdGlvbkluZm87CgogIH0KCiAgc3RydWN0IFRyYW5zYWN0aW9uIHsKICAgIHVpbnQyNTYgZGF5OyAvL1RpbWVzdGFtcCBvZiB0aGUgZGF5IGluaXRpYWxpemVkCiAgICB1aW50MjU2IHZhbHVlOyAvL0Ftb3VudCBvZiBldGhlciBiZWluZyBzZW50CiAgICBhZGRyZXNzIHRva2VuQWRyZXNzOyAvL0FkZHJlc3Mgb2YgdG9rZW4gdHJhbnNmZXJyZWQKICAgIHVpbnQyNTYgYW1vdW50OyAvL0Ftb3VudCBvZiB0b2tlbnMgdHJhbnNmZXJyZWQKICAgIGJ5dGVzIGRhdGE7IC8vVGVtcCBsb2NhdGlvbiBmb3IgcGVuZGluZyB0cmFuc2FjdGlvbnMsIGVyYXNlZCBhZnRlciBmaW5hbCBjb25maXJtYXRpb24KICAgIHVpbnQyNTZbXSBjb25maXJtZWRPd25lcnM7IC8vQXJyYXkgb2Ygb3duZXJzIGNvbmZpcm1pbmcgdHJhbnNhY3Rpb24KICAgIHVpbnQyNTYgY29uZmlybUNvdW50OyAvL1RyYWNrcyB0aGUgbnVtYmVyIG9mIGNvbmZpcm1zCiAgICB1aW50MjU2IGNvbmZpcm1SZXF1aXJlZDsgLy9OdW1iZXIgb2Ygc2lncyByZXF1aXJlZCBmb3IgdGhpcyB0cmFuc2FjdGlvbgogICAgYm9vbCBzdWNjZXNzOyAvL1RydWUgYWZ0ZXIgZmluYWwgY29uZmlybWF0aW9uCiAgfQoKICAvKkV2ZW50cyovCiAgZXZlbnQgTG9nUmV2b2tlTm90aWNlKGJ5dGVzMzIgdHhpZCwgYWRkcmVzcyBzZW5kZXIsIHVpbnQyNTYgY29uZmlybXNOZWVkZWQpOwogIGV2ZW50IExvZ1RyYW5zYWN0aW9uRmFpbGVkKGJ5dGVzMzIgdHhpZCwgYWRkcmVzcyBzZW5kZXIpOwogIGV2ZW50IExvZ1RyYW5zYWN0aW9uQ29uZmlybWVkKGJ5dGVzMzIgdHhpZCwgYWRkcmVzcyBzZW5kZXIsIHVpbnQyNTYgY29uZmlybXNOZWVkZWQpOwogIGV2ZW50IExvZ1RyYW5zYWN0aW9uQ29tcGxldGUoYnl0ZXMzMiB0eGlkLCBhZGRyZXNzIHRhcmdldCwgdWludDI1NiB2YWx1ZSwgYnl0ZXMgZGF0YSk7CiAgZXZlbnQgTG9nQ29udHJhY3RDcmVhdGVkKGFkZHJlc3MgbmV3Q29udHJhY3QsIHVpbnQyNTYgdmFsdWUpOwogIGV2ZW50IExvZ0Vycm9yTXNnKHVpbnQyNTYgYW1vdW50LCBzdHJpbmcgbXNnKTsKCiAgLy8vIEBkZXYgQ29uc3RydWN0b3IKICAvLy8gQHBhcmFtIHNlbGYgVGhlIHdhbGxldCBpbiBjb250cmFjdCBzdG9yYWdlCiAgLy8vIEBwYXJhbSBfb3duZXJzIEFycmF5IG9mIGluaXRpYWwgb3duZXJzCiAgLy8vIEBwYXJhbSBfcmVxdWlyZWRBZG1pbiBTZXQgbnVtYmVyIG9mIHNpZ3MgZm9yIGFkbWluaXN0cmF0aXZlIHRhc2tzCiAgLy8vIEBwYXJhbSBfcmVxdWlyZWRNYWpvciBTZXQgbnVtYmVyIG9mIHNpZ3MgZm9yIG1ham9yIHR4CiAgLy8vIEBwYXJhbSBfcmVxdWlyZWRNaW5vciBTZXQgbnVtYmVyIG9mIHNpZ3MgZm9yIG1pbm9yIHR4CiAgLy8vIEBwYXJhbSBfbWFqb3JUaHJlc2hvbGQgU2V0IG1ham9yIHR4IHRocmVzaG9sZCBhbW91bnQgZm9yIGV0aGVyCiAgLy8vIEByZXR1cm4gV2lsbCByZXR1cm4gdHJ1ZSB3aGVuIGNvbXBsZXRlCiAgZnVuY3Rpb24gaW5pdChXYWxsZXREYXRhIHN0b3JhZ2Ugc2VsZiwKICAgICAgICAgICAgICAgIGFkZHJlc3NbXSBfb3duZXJzLAogICAgICAgICAgICAgICAgdWludDI1NiBfcmVxdWlyZWRBZG1pbiwKICAgICAgICAgICAgICAgIHVpbnQyNTYgX3JlcXVpcmVkTWFqb3IsCiAgICAgICAgICAgICAgICB1aW50MjU2IF9yZXF1aXJlZE1pbm9yLAogICAgICAgICAgICAgICAgdWludDI1NiBfbWFqb3JUaHJlc2hvbGQpIHB1YmxpYyByZXR1cm5zIChib29sKQogIHsKICAgIHJlcXVpcmUoc2VsZi5vd25lcnMubGVuZ3RoID09IDApOwogICAgcmVxdWlyZShfb3duZXJzLmxlbmd0aCA+PSBfcmVxdWlyZWRBZG1pbiAmJiBfcmVxdWlyZWRBZG1pbiA+IDApOwogICAgcmVxdWlyZShfb3duZXJzLmxlbmd0aCA+PSBfcmVxdWlyZWRNYWpvciAmJiBfcmVxdWlyZWRNYWpvciA+IDApOwogICAgcmVxdWlyZShfb3duZXJzLmxlbmd0aCA+PSBfcmVxdWlyZWRNaW5vciAmJiBfcmVxdWlyZWRNaW5vciA+IDApOwogICAgc2VsZi5vd25lcnMucHVzaCgwKTsgLy9MZWF2ZSBpbmRleC0wIGVtcHR5IGZvciBlYXNpZXIgb3duZXIgY2hlY2tzCgogICAgZm9yICh1aW50MjU2IGk9MDsgaTxfb3duZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHJlcXVpcmUoX293bmVyc1tpXSAhPSAwKTsKICAgICAgc2VsZi5vd25lcnMucHVzaChfb3duZXJzW2ldKTsKICAgICAgc2VsZi5vd25lckluZGV4W19vd25lcnNbaV1dID0gaSsxOwogICAgfQogICAgc2VsZi5yZXF1aXJlZEFkbWluID0gX3JlcXVpcmVkQWRtaW47CiAgICBzZWxmLnJlcXVpcmVkTWFqb3IgPSBfcmVxdWlyZWRNYWpvcjsKICAgIHNlbGYucmVxdWlyZWRNaW5vciA9IF9yZXF1aXJlZE1pbm9yOwogICAgc2VsZi5tYXhPd25lcnMgPSA1MDsgLy9MaW1pdHMgdG8gNTAgb3duZXJzLCBzaG91bGQgY3JlYXRlIHdhbGxldCBwb29scyBmb3IgbW9yZSBvd25lcnMKICAgIHNlbGYubWFqb3JUaHJlc2hvbGRbMF0gPSBfbWFqb3JUaHJlc2hvbGQ7IC8vU2V0cyBldGhlciB0aHJlc2hvbGQgYXQgYWRkcmVzcyAwCgogICAgcmV0dXJuIHRydWU7CiAgfQoKICAvKkNoZWNrcyovCgogIC8vLyBAZGV2IFZlcmlmaWVzIGEgY29uZmlybWluZyBvd25lciBoYXMgbm90IGNvbmZpcm1lZCBhbHJlYWR5CiAgLy8vIEBwYXJhbSBzZWxmIENvbnRyYWN0IHdhbGxldCBpbiBzdG9yYWdlCiAgLy8vIEBwYXJhbSBfaWQgSUQgb2YgdGhlIHR4IGJlaW5nIGNoZWNrZWQKICAvLy8gQHBhcmFtIF90eEluZGV4IEluZGV4IG51bWJlciBvZiB0aGlzIHR4CiAgLy8vIEByZXR1cm4gUmV0dXJucyB0cnVlIGlmIGNoZWNrIHBhc3NlcywgZmFsc2Ugb3RoZXJ3aXNlCiAgZnVuY3Rpb24gY2hlY2tOb3RDb25maXJtZWQoV2FsbGV0RGF0YSBzdG9yYWdlIHNlbGYsIGJ5dGVzMzIgX2lkLCB1aW50MjU2IF90eEluZGV4KQogICAgICAgICAgIHB1YmxpYyByZXR1cm5zIChib29sKQogIHsKICAgIHJlcXVpcmUoc2VsZi5vd25lckluZGV4W21zZy5zZW5kZXJdID4gMCk7CiAgICB1aW50MjU2IF90eExlbiA9IHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF0ubGVuZ3RoOwoKICAgIGlmKF90eExlbiA9PSAwIHx8IF90eEluZGV4ID49IF90eExlbil7CiAgICAgIExvZ0Vycm9yTXNnKF90eExlbiwgIlR4IG5vdCBpbml0aWF0ZWQiKTsKICAgICAgTG9nVHJhbnNhY3Rpb25GYWlsZWQoX2lkLCBtc2cuc2VuZGVyKTsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIGlmKHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX3R4SW5kZXhdLnN1Y2Nlc3MpewogICAgICBMb2dFcnJvck1zZyhfdHhJbmRleCwgIlRyYW5zYWN0aW9uIGFscmVhZHkgY29tcGxldGUiKTsKICAgICAgTG9nVHJhbnNhY3Rpb25GYWlsZWQoX2lkLCBtc2cuc2VuZGVyKTsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIC8vRnVuY3Rpb24gZnJvbSBNb2R1bGFyLmlvIGFycmF5IHV0aWxpdHkgbGlicmFyeQogICAgYm9vbCBmb3VuZDsKICAgIHVpbnQyNTYgaW5kZXg7CiAgICAoZm91bmQsIGluZGV4KSA9IHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX3R4SW5kZXhdLmNvbmZpcm1lZE93bmVycy5pbmRleE9mKHVpbnQyNTYobXNnLnNlbmRlciksIGZhbHNlKTsKICAgIGlmKGZvdW5kKXsKICAgICAgTG9nRXJyb3JNc2coaW5kZXgsICJPd25lciBhbHJlYWR5IGNvbmZpcm1lZCIpOwogICAgICBMb2dUcmFuc2FjdGlvbkZhaWxlZChfaWQsIG1zZy5zZW5kZXIpOwogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgcmV0dXJuIHRydWU7CiAgfQoKICAvKlV0aWxpdHkgRnVuY3Rpb25zKi8KCiAgLy8vIEBkZXYgVXNlZCBsYXRlciB0byBjYWxjdWxhdGUgdGhlIG51bWJlciBvZiBjb25maXJtYXRpb25zIG5lZWRlZCBmb3IgdHgKICAvLy8gQHBhcmFtIF9yZXF1aXJlZCBOdW1iZXIgb2Ygc2lncyByZXF1aXJlZAogIC8vLyBAcGFyYW0gX2NvdW50IEN1cnJlbnQgbnVtYmVyIG9mIHNpZ3MKICBmdW5jdGlvbiBjYWxjQ29uZmlybXNOZWVkZWQodWludDI1NiBfcmVxdWlyZWQsIHVpbnQyNTYgX2NvdW50KSBwdWJsaWMgcHVyZSByZXR1cm5zICh1aW50MjU2KXsKICAgIHJldHVybiBfcmVxdWlyZWQgLSBfY291bnQ7CiAgfQoKICAvLy8gQGRldiBVc2VkIHRvIGNoZWNrIGlmIHR4IGlzIG1vdmluZyB0b2tlbnMgYW5kIHBhcnNlcyBhbW91bnQKICAvLy8gQHBhcmFtIF90eERhdGEgRGF0YSBmb3IgcHJvcG9zZWQgdHgKICAvLy8gQHJldHVybiBib29sIFRydWUgaWYgdHJhbnNhY3Rpb24gaXMgbW92aW5nIHRva2VucwogIC8vLyBAcmV0dXJuIHVpbnQyNTYgQW1vdW50IG9mIHRva2VucyBpbnZvbHZlZCwgMCBpZiBub3Qgc3BlbmRpbmcgdHgKICBmdW5jdGlvbiBnZXRBbW91bnQoYnl0ZXMgX3R4RGF0YSkgcHVibGljIHB1cmUgcmV0dXJucyAoYm9vbCx1aW50MjU2KSB7CiAgICBieXRlczMyIGdldFNpZzsKICAgIGJ5dGVzNCBzaWc7CiAgICBieXRlczQgdFNpZyA9IDB4YTkwNTljYmI7IC8vdHJhbnNmZXIgZnVuYyBzaWduYXR1cmUKICAgIGJ5dGVzNCBhU2lnID0gMHgwOTVlYTdiMzsgLy9hcHByb3ZlIGZ1bmMgc2lnbmF0dXJlCiAgICBieXRlczQgdGZTaWcgPSAweDIzYjg3MmRkOyAvL3RyYW5zZmVyRnJvbSBmdW5jIHNpZ25hdHVyZQogICAgYm9vbCB0cmFuc2ZlcjsKICAgIGJ5dGVzMzIgX2Ftb3VudERhdGE7CiAgICB1aW50MjU2IF9hbW91bnQ7CgogICAgYXNzZW1ibHkgeyBnZXRTaWcgOj0gbWxvYWQoYWRkKF90eERhdGEsMHgyMCkpIH0KICAgIHNpZyA9IGJ5dGVzNChnZXRTaWcpOwogICAgaWYoc2lnID09ICB0U2lnIHx8IHNpZyA9PSBhU2lnKXsKICAgICAgdHJhbnNmZXIgPSB0cnVlOwogICAgICBhc3NlbWJseSB7IF9hbW91bnREYXRhIDo9IG1sb2FkKGFkZChfdHhEYXRhLDB4NDQpKSB9CiAgICAgIF9hbW91bnQgPSB1aW50MjU2KF9hbW91bnREYXRhKTsKICAgIH0gZWxzZSBpZihzaWcgPT0gdGZTaWcpewogICAgICB0cmFuc2ZlciA9IHRydWU7CiAgICAgIGFzc2VtYmx5IHsgX2Ftb3VudERhdGEgOj0gbWxvYWQoYWRkKF90eERhdGEsMHg2NCkpIH0KICAgICAgX2Ftb3VudCA9IHVpbnQyNTYoX2Ftb3VudERhdGEpOwogICAgfQogICAgcmV0dXJuICh0cmFuc2ZlcixfYW1vdW50KTsKICB9CgogIC8vLyBAZGV2IFJldHJpZXZlcyBzaWcgcmVxdWlyZW1lbnQgZm9yIHNwZW5kaW5nIHR4CiAgLy8vIEBwYXJhbSBzZWxmIENvbnRyYWN0IHdhbGxldCBpbiBzdG9yYWdlCiAgLy8vIEBwYXJhbSBfdG8gVGFyZ2V0IGFkZHJlc3Mgb2YgdHJhbnNhY3Rpb24KICAvLy8gQHBhcmFtIF92YWx1ZSBBbW91bnQgb2YgZXRoZXIgc3BlbmQKICAvLy8gQHBhcmFtIF9pc1RyYW5zZmVyIFRydWUgaWYgdHJhbnNmZXJyaW5nIG90aGVyIHRva2VucywgZmFsc2Ugb3RoZXJ3aXNlCiAgLy8vIEBwYXJhbSBfYW1vdW50IEFtb3VudCBvZiB0b2tlbnMgYmVpbmcgdHJhbnNmZXJyZWQsIDAgaWYgbm90IGEgdHJhbnNmZXIgdHgKICAvLy8gQHJldHVybiB1aW50MjU2IFRoZSByZXF1aXJlZCBzaWdzIGZvciB0eAogIGZ1bmN0aW9uIGdldFJlcXVpcmVkKFdhbGxldERhdGEgc3RvcmFnZSBzZWxmLAogICAgICAgICAgICAgICAgICAgICAgIGFkZHJlc3MgX3RvLAogICAgICAgICAgICAgICAgICAgICAgIHVpbnQyNTYgX3ZhbHVlLAogICAgICAgICAgICAgICAgICAgICAgIGJvb2wgX2lzVHJhbnNmZXIsCiAgICAgICAgICAgICAgICAgICAgICAgdWludDI1NiBfYW1vdW50KQogICAgICAgICAgICAgICAgICAgICAgIHB1YmxpYyByZXR1cm5zICh1aW50MjU2KQogIHsKICAgIGJvb2wgZXJyOwogICAgdWludDI1NiByZXM7CiAgICBib29sIG1ham9yID0gdHJ1ZTsKICAgIC8vUmVzZXQgc3BlbmQgaWYgdGhpcyBpcyBmaXJzdCBjaGVjayBvZiB0aGUgZGF5CiAgICBpZigobm93IC8gMSBkYXlzKSA+IHNlbGYuY3VycmVudFNwZW5kWzBdWzBdKXsKICAgICAgc2VsZi5jdXJyZW50U3BlbmRbMF1bMF0gPSBub3cgLyAxIGRheXM7CiAgICAgIHNlbGYuY3VycmVudFNwZW5kWzBdWzFdID0gMDsKICAgIH0KCiAgICAoZXJyLCByZXMpID0gc2VsZi5jdXJyZW50U3BlbmRbMF1bMV0ucGx1cyhfdmFsdWUpOwogICAgcmVxdWlyZSghZXJyKTsKCiAgICBpZihyZXMgPCBzZWxmLm1ham9yVGhyZXNob2xkWzBdKQogICAgICBtYWpvciA9IGZhbHNlOwoKICAgIGlmKF90byAhPSAwICYmIF9pc1RyYW5zZmVyKXsKICAgICAgaWYoKG5vdyAvIDEgZGF5cykgPiBzZWxmLmN1cnJlbnRTcGVuZFtfdG9dWzBdKXsKICAgICAgICBzZWxmLmN1cnJlbnRTcGVuZFtfdG9dWzBdID0gbm93IC8gMSBkYXlzOwogICAgICAgIHNlbGYuY3VycmVudFNwZW5kW190b11bMV0gPSAwOwogICAgICB9CgogICAgICAoZXJyLCByZXMpID0gc2VsZi5jdXJyZW50U3BlbmRbX3RvXVsxXS5wbHVzKF9hbW91bnQpOwogICAgICByZXF1aXJlKCFlcnIpOwoKICAgICAgaWYocmVzID49IHNlbGYubWFqb3JUaHJlc2hvbGRbX3RvXSkKICAgICAgICBtYWpvciA9IHRydWU7CiAgICB9CgogICAgcmV0dXJuIG1ham9yID8gc2VsZi5yZXF1aXJlZE1ham9yIDogc2VsZi5yZXF1aXJlZE1pbm9yOwogIH0KCiAgLy8vIEBkZXYgRnVuY3Rpb24gdG8gY3JlYXRlIG5ldyBjb250cmFjdAogIC8vLyBAcGFyYW0gX3R4RGF0YSBUcmFuc2FjdGlvbiBkYXRhCiAgLy8vIEBwYXJhbSBfdmFsdWUgQW1vdW50IG9mIGV0aCBzZW5kaW5nIHRvIG5ldyBjb250cmFjdAogIGZ1bmN0aW9uIGNyZWF0ZUNvbnRyYWN0KGJ5dGVzIF90eERhdGEsIHVpbnQyNTYgX3ZhbHVlKSBwdWJsaWMgewogICAgYWRkcmVzcyBfbmV3Q29udHJhY3Q7CiAgICBib29sIGFsbEdvb2Q7CgogICAgYXNzZW1ibHkgewogICAgICBfbmV3Q29udHJhY3QgOj0gY3JlYXRlKF92YWx1ZSwgYWRkKF90eERhdGEsIDB4MjApLCBtbG9hZChfdHhEYXRhKSkKICAgICAgYWxsR29vZCA6PSBndChleHRjb2Rlc2l6ZShfbmV3Q29udHJhY3QpLDApCiAgICB9CiAgICByZXF1aXJlKGFsbEdvb2QpOwogICAgTG9nQ29udHJhY3RDcmVhdGVkKF9uZXdDb250cmFjdCwgX3ZhbHVlKTsKICB9CgogIC8qUHJpbWFyeSBGdW5jdGlvbiovCgogIC8vLyBAZGV2IENyZWF0ZSBhbmQgZXhlY3V0ZSB0cmFuc2FjdGlvbiBmcm9tIHdhbGxldAogIC8vLyBAcGFyYW0gc2VsZiBXYWxsZXQgaW4gY29udHJhY3Qgc3RvcmFnZQogIC8vLyBAcGFyYW0gX3RvIEFkZHJlc3Mgb2YgdGFyZ2V0CiAgLy8vIEBwYXJhbSBfdmFsdWUgQW1vdW50IG9mIGV0aGVyIHNlbmRpbmcKICAvLy8gQHBhcmFtIF90eERhdGEgRGF0YSBmb3IgZXhlY3V0aW5nIHRyYW5zYWN0aW9uCiAgLy8vIEBwYXJhbSBfY29uZmlybSBUcnVlIGlmIGNvbmZpcm1pbmcsIGZhbHNlIGlmIHJldm9raW5nIGNvbmZpcm1hdGlvbgogIC8vLyBAcGFyYW0gX2RhdGEgTWVzc2FnZSBkYXRhIHBhc3NlZCBmcm9tIHdhbGxldCBjb250cmFjdAogIC8vLyBAcmV0dXJuIGJvb2wgUmV0dXJucyB0cnVlIGlmIHN1Y2Nlc3NmdWwsIGZhbHNlIG90aGVyd2lzZQogIC8vLyBAcmV0dXJuIGJ5dGVzMzIgUmV0dXJucyB0aGUgdHggSUQsIGNhbiBiZSB1c2VkIGZvciBjb25maXJtL3Jldm9rZSBmdW5jdGlvbnMKICBmdW5jdGlvbiBzZXJ2ZVR4KFdhbGxldERhdGEgc3RvcmFnZSBzZWxmLAogICAgICAgICAgICAgICAgICAgYWRkcmVzcyBfdG8sCiAgICAgICAgICAgICAgICAgICB1aW50MjU2IF92YWx1ZSwKICAgICAgICAgICAgICAgICAgIGJ5dGVzIF90eERhdGEsCiAgICAgICAgICAgICAgICAgICBib29sIF9jb25maXJtLAogICAgICAgICAgICAgICAgICAgYnl0ZXMgX2RhdGEpCiAgICAgICAgICAgICAgICAgICBwdWJsaWMgcmV0dXJucyAoYm9vbCxieXRlczMyKQogIHsKICAgIGJ5dGVzMzIgX2lkID0ga2VjY2FrMjU2KCJzZXJ2ZVR4IixfdG8sX3ZhbHVlLF90eERhdGEpOwogICAgdWludDI1NiBfdHhJbmRleCA9IHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF0ubGVuZ3RoOwogICAgdWludDI1NiBfcmVxdWlyZWQgPSBzZWxmLnJlcXVpcmVkTWFqb3I7CgogICAgLy9SdW4gY2hlY2tzIGlmIG5vdCBjYWxsZWQgZnJvbSBnZW5lcmljIGNvbmZpcm0vcmV2b2tlIGZ1bmN0aW9uCiAgICBpZihtc2cuc2VuZGVyICE9IGFkZHJlc3ModGhpcykpewogICAgICBib29sIGFsbEdvb2Q7CiAgICAgIHVpbnQyNTYgX2Ftb3VudDsKICAgICAgLy8gaWYgdGhlIG93bmVyIGlzIHJldm9raW5nIGhpcy9oZXIgY29uZmlybWF0aW9uIGJ1dCBkb2Vzbid0IGtub3cgdGhlCiAgICAgIC8vIHNwZWNpZmljIHRyYW5zYWN0aW9uIGlkIGhhc2gKICAgICAgaWYoIV9jb25maXJtKSB7CiAgICAgICAgYWxsR29vZCA9IHJldm9rZUNvbmZpcm0oc2VsZiwgX2lkKTsKICAgICAgICByZXR1cm4gKGFsbEdvb2QsX2lkKTsKICAgICAgfSBlbHNlIHsgLy8gZWxzZSBjb25maXJtaW5nIHRoZSB0cmFuc2FjdGlvbgogICAgICAgIC8vUmV1c2UgYWxsR29vZCBkdWUgdG8gc3RhY2sgbGltaXQKICAgICAgICBpZihfdG8gIT0gMCkKICAgICAgICAgIChhbGxHb29kLF9hbW91bnQpID0gZ2V0QW1vdW50KF90eERhdGEpOwoKICAgICAgICAvL2lmIHRoaXMgaXMgYSBuZXcgdHJhbnNhY3Rpb24gaWQgb3IgaWYgYSBwcmV2aW91cyBpZGVudGljYWwgdHJhbnNhY3Rpb24gaGFkIGFscmVhZHkgc3VjY2VlZGVkCiAgICAgICAgaWYoX3R4SW5kZXggPT0gMCB8fCBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW190eEluZGV4IC0gMV0uc3VjY2Vzcyl7CiAgICAgICAgICByZXF1aXJlKHNlbGYub3duZXJJbmRleFttc2cuc2VuZGVyXSA+IDApOwoKICAgICAgICAgIF9yZXF1aXJlZCA9IGdldFJlcXVpcmVkKHNlbGYsIF90bywgX3ZhbHVlLCBhbGxHb29kLF9hbW91bnQpOwoKICAgICAgICAgIC8vIGFkZCB0aGlzIHRyYW5zYWN0aW9uIHRvIHRoZSB3YWxsZXRzIHJlY29yZCBhbmQgaW5pdGlhbGl6ZSB0aGUgc2V0dGluZ3MKICAgICAgICAgIHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF0ubGVuZ3RoKys7CiAgICAgICAgICBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW190eEluZGV4XS5jb25maXJtUmVxdWlyZWQgPSBfcmVxdWlyZWQ7CiAgICAgICAgICBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW190eEluZGV4XS5kYXkgPSBub3cgLyAxIGRheXM7CiAgICAgICAgICBzZWxmLnRyYW5zYWN0aW9uc1tub3cgLyAxIGRheXNdLnB1c2goX2lkKTsKICAgICAgICB9IGVsc2UgeyAvLyBlbHNlIHRoZSB0cmFuc2FjdGlvbiBpcyBhbHJlYWR5IHBlbmRpbmcKICAgICAgICAgIF90eEluZGV4LS07IC8vIHNldCB0aGUgaW5kZXggdG8gdGhlIGluZGV4IG9mIHRoZSBleGlzdGluZyB0cmFuc2FjdGlvbgogICAgICAgICAgLy9tYWtlIHN1cmUgdGhlIHNlbmRlciBpc24ndCBhbHJlYWR5IGNvbmZpcm1lZAogICAgICAgICAgYWxsR29vZCA9IGNoZWNrTm90Q29uZmlybWVkKHNlbGYsIF9pZCwgX3R4SW5kZXgpOwogICAgICAgICAgaWYoIWFsbEdvb2QpCiAgICAgICAgICAgIHJldHVybiAoZmFsc2UsX2lkKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIGFkZCB0aGUgc2VuZGVycyBjb25maXJtYXRpb24gdG8gdGhlIHRyYW5zYWN0aW9uCiAgICAgIHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX3R4SW5kZXhdLmNvbmZpcm1lZE93bmVycy5wdXNoKHVpbnQyNTYobXNnLnNlbmRlcikpOwogICAgICBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW190eEluZGV4XS5jb25maXJtQ291bnQrKzsKICAgIH0gZWxzZSB7CiAgICAgIC8vIGVsc2Ugd2VyZSBjYWxsaW5nIGZyb20gZ2VuZXJpYyBjb25maXJtL3Jldm9rZSBmdW5jdGlvbiwgc2V0IHRoZQogICAgICAvLyBfdHhJbmRleCBpbmRleCB0byB0aGUgaW5kZXggb2YgdGhlIGV4aXN0aW5nIHRyYW5zYWN0aW9uCiAgICAgIF90eEluZGV4LS07CiAgICB9CgogICAgLy8gaWYgdGhlcmUgYXJlIGVub3VnaCBjb25maXJtYXRpb25zCiAgICBpZihzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW190eEluZGV4XS5jb25maXJtQ291bnQgPT0KICAgICAgIHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX3R4SW5kZXhdLmNvbmZpcm1SZXF1aXJlZCkKICAgIHsKICAgICAgLy8gZXhlY3V0ZSB0aGUgdHJhbnNhY3Rpb24KICAgICAgc2VsZi5jdXJyZW50U3BlbmRbMF1bMV0gKz0gX3ZhbHVlOwogICAgICBzZWxmLmN1cnJlbnRTcGVuZFtfdG9dWzFdICs9IF9hbW91bnQ7CiAgICAgIHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX3R4SW5kZXhdLnN1Y2Nlc3MgPSB0cnVlOwoKICAgICAgaWYoX3RvID09IDApewogICAgICAgIC8vRmFpbHVyZSBpcyBzZWxmIGNvbnRhaW5lZCBpbiBtZXRob2QKICAgICAgICBjcmVhdGVDb250cmFjdChfdHhEYXRhLCBfdmFsdWUpOwogICAgICB9IGVsc2UgewogICAgICAgIHJlcXVpcmUoX3RvLmNhbGwudmFsdWUoX3ZhbHVlKShfdHhEYXRhKSk7CiAgICAgIH0KICAgICAgZGVsZXRlIHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX3R4SW5kZXhdLmRhdGE7CiAgICAgIExvZ1RyYW5zYWN0aW9uQ29tcGxldGUoX2lkLCBfdG8sIF92YWx1ZSwgX2RhdGEpOwogICAgfSBlbHNlIHsKICAgICAgaWYoc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfdHhJbmRleF0uZGF0YS5sZW5ndGggPT0gMCkKICAgICAgICBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW190eEluZGV4XS5kYXRhID0gX2RhdGE7CgogICAgICB1aW50MjU2IGNvbmZpcm1zTmVlZGVkID0gY2FsY0NvbmZpcm1zTmVlZGVkKHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX3R4SW5kZXhdLmNvbmZpcm1SZXF1aXJlZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW190eEluZGV4XS5jb25maXJtQ291bnQpOwogICAgICBMb2dUcmFuc2FjdGlvbkNvbmZpcm1lZChfaWQsIG1zZy5zZW5kZXIsIGNvbmZpcm1zTmVlZGVkKTsKICAgIH0KCiAgICByZXR1cm4gKHRydWUsX2lkKTsKICB9CgogIC8qIENvbmZpcm0vUmV2b2tlIGZ1bmN0aW9ucyB1c2luZyB0eCBJRCAqLwoKICAvLy8gQGRldiBDb25maXJtcyBhIGN1cnJlbnQgcGVuZGluZyB0eCwgd2lsbCBleGVjdXRlIGlmIGZpbmFsIGNvbmZpcm1hdGlvbgogIC8vLyBAcGFyYW0gc2VsZiBXYWxsZXQgaW4gY29udHJhY3Qgc3RvcmFnZQogIC8vLyBAcGFyYW0gX2lkIElEIG9mIHRoZSB0cmFuc2FjdGlvbgogIC8vLyBAcmV0dXJuIFJldHVybnMgdHJ1ZSBpZiBzdWNjZXNzZnVsLCBmYWxzZSBvdGhlcndpc2UKICBmdW5jdGlvbiBjb25maXJtVHgoV2FsbGV0RGF0YSBzdG9yYWdlIHNlbGYsIGJ5dGVzMzIgX2lkKQogICAgICAgICAgICAgICAgICAgICBwdWJsaWMgcmV0dXJucyAoYm9vbCkgewogICAgcmVxdWlyZShzZWxmLm93bmVySW5kZXhbbXNnLnNlbmRlcl0gPiAwKTsKICAgIHVpbnQyNTYgX3R4SW5kZXggPSBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdLmxlbmd0aDsKICAgIGJvb2wgcmV0OwoKICAgIGlmKF90eEluZGV4ID09IDApewogICAgICBMb2dFcnJvck1zZyhfdHhJbmRleCwgIlR4IG5vdCBpbml0aWF0ZWQiKTsKICAgICAgTG9nVHJhbnNhY3Rpb25GYWlsZWQoX2lkLCBtc2cuc2VuZGVyKTsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIF90eEluZGV4LS07CiAgICBib29sIGFsbEdvb2QgPSBjaGVja05vdENvbmZpcm1lZChzZWxmLCBfaWQsIF90eEluZGV4KTsKICAgIGlmKCFhbGxHb29kKQogICAgICByZXR1cm4gZmFsc2U7CgogICAgc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfdHhJbmRleF0uY29uZmlybWVkT3duZXJzLnB1c2godWludDI1Nihtc2cuc2VuZGVyKSk7CiAgICBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW190eEluZGV4XS5jb25maXJtQ291bnQrKzsKCiAgICBpZihzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW190eEluZGV4XS5jb25maXJtQ291bnQgPT0KICAgICAgIHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX3R4SW5kZXhdLmNvbmZpcm1SZXF1aXJlZCkKICAgIHsKICAgICAgYWRkcmVzcyBhID0gYWRkcmVzcyh0aGlzKTsKICAgICAgcmVxdWlyZShhLmNhbGwoc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfdHhJbmRleF0uZGF0YSkpOwogICAgfSBlbHNlIHsKICAgICAgdWludDI1NiBjb25maXJtc05lZWRlZCA9IGNhbGNDb25maXJtc05lZWRlZChzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW190eEluZGV4XS5jb25maXJtUmVxdWlyZWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfdHhJbmRleF0uY29uZmlybUNvdW50KTsKCiAgICAgIExvZ1RyYW5zYWN0aW9uQ29uZmlybWVkKF9pZCwgbXNnLnNlbmRlciwgY29uZmlybXNOZWVkZWQpOwogICAgICByZXQgPSB0cnVlOwogICAgfQoKICAgIHJldHVybiByZXQ7CiAgfQoKICAvLy8gQGRldiBSZXZva2VzIGEgcHJpb3IgY29uZmlybWF0aW9uIGZyb20gc2VuZGVyLCBjYWxsIHdpdGggdHggSUQKICAvLy8gQHBhcmFtIHNlbGYgV2FsbGV0IGluIGNvbnRyYWN0IHN0b3JhZ2UKICAvLy8gQHBhcmFtIF9pZCBJRCBvZiB0aGUgdHJhbnNhY3Rpb24KICAvLy8gQHJldHVybiBSZXR1cm5zIHRydWUgaWYgc3VjY2Vzc2Z1bCwgZmFsc2Ugb3RoZXJ3aXNlCiAgZnVuY3Rpb24gcmV2b2tlQ29uZmlybShXYWxsZXREYXRhIHN0b3JhZ2Ugc2VsZiwgYnl0ZXMzMiBfaWQpCiAgICAgICAgICAgcHVibGljCiAgICAgICAgICAgcmV0dXJucyAoYm9vbCkKICB7CiAgICByZXF1aXJlKHNlbGYub3duZXJJbmRleFttc2cuc2VuZGVyXSA+IDApOwogICAgdWludDI1NiBfdHhJbmRleCA9IHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF0ubGVuZ3RoOwoKICAgIGlmKF90eEluZGV4ID09IDApewogICAgICBMb2dFcnJvck1zZyhfdHhJbmRleCwgIlR4IG5vdCBpbml0aWF0ZWQiKTsKICAgICAgTG9nVHJhbnNhY3Rpb25GYWlsZWQoX2lkLCBtc2cuc2VuZGVyKTsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIF90eEluZGV4LS07CiAgICBpZihzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW190eEluZGV4XS5zdWNjZXNzKXsKICAgICAgTG9nRXJyb3JNc2coX3R4SW5kZXgsICJUcmFuc2FjdGlvbiBhbHJlYWR5IGNvbXBsZXRlIik7CiAgICAgIExvZ1RyYW5zYWN0aW9uRmFpbGVkKF9pZCwgbXNnLnNlbmRlcik7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICAvL0Z1bmN0aW9uIGZyb20gTW9kdWxhci5pbyBhcnJheSB1dGlsaXR5IGxpYnJhcnkKICAgIGJvb2wgZm91bmQ7CiAgICB1aW50MjU2IGluZGV4OwogICAgKGZvdW5kLCBpbmRleCkgPSBzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW190eEluZGV4XS5jb25maXJtZWRPd25lcnMuaW5kZXhPZih1aW50MjU2KG1zZy5zZW5kZXIpLCBmYWxzZSk7CiAgICBpZighZm91bmQpewogICAgICBMb2dFcnJvck1zZyhpbmRleCwgIk93bmVyIGhhcyBub3QgY29uZmlybWVkIHR4Iik7CiAgICAgIExvZ1RyYW5zYWN0aW9uRmFpbGVkKF9pZCwgbXNnLnNlbmRlcik7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX3R4SW5kZXhdLmNvbmZpcm1lZE93bmVyc1tpbmRleF0gPSAwOwogICAgc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfdHhJbmRleF0uY29uZmlybUNvdW50LS07CgogICAgdWludDI1NiBjb25maXJtc05lZWRlZCA9IGNhbGNDb25maXJtc05lZWRlZChzZWxmLnRyYW5zYWN0aW9uSW5mb1tfaWRdW190eEluZGV4XS5jb25maXJtUmVxdWlyZWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF1bX3R4SW5kZXhdLmNvbmZpcm1Db3VudCk7CiAgICAvL1RyYW5zYWN0aW9uIHJlbW92ZWQgaWYgYWxsIHNpZ3MgcmV2b2tlZCBidXQgaWQgcmVtYWlucyBpbiB3YWxsZXQgdHJhbnNhY3Rpb24gbGlzdAogICAgaWYoc2VsZi50cmFuc2FjdGlvbkluZm9bX2lkXVtfdHhJbmRleF0uY29uZmlybUNvdW50ID09IDApCiAgICAgIHNlbGYudHJhbnNhY3Rpb25JbmZvW19pZF0ubGVuZ3RoLS07CgogICAgTG9nUmV2b2tlTm90aWNlKF9pZCwgbXNnLnNlbmRlciwgY29uZmlybXNOZWVkZWQpOwogICAgcmV0dXJuIHRydWU7CiAgfQp9CgpsaWJyYXJ5IEFycmF5MjU2TGliIHsKCiAgLy8vIEBkZXYgU3VtIHZlY3RvcgogIC8vLyBAcGFyYW0gc2VsZiBTdG9yYWdlIGFycmF5IGNvbnRhaW5pbmcgdWludDI1NiB0eXBlIHZhcmlhYmxlcwogIC8vLyBAcmV0dXJuIHN1bSBUaGUgc3VtIG9mIGFsbCBlbGVtZW50cywgZG9lcyBub3QgY2hlY2sgZm9yIG92ZXJmbG93CiAgZnVuY3Rpb24gc3VtRWxlbWVudHModWludDI1NltdIHN0b3JhZ2Ugc2VsZikgcHVibGljIHZpZXcgcmV0dXJucyh1aW50MjU2IHN1bSkgewogICAgYXNzZW1ibHkgewogICAgICBtc3RvcmUoMHg2MCxzZWxmX3Nsb3QpCgogICAgICBmb3IgeyBsZXQgaSA6PSAwIH0gbHQoaSwgc2xvYWQoc2VsZl9zbG90KSkgeyBpIDo9IGFkZChpLCAxKSB9IHsKICAgICAgICBzdW0gOj0gYWRkKHNsb2FkKGFkZChzaGEzKDB4NjAsMHgyMCksaSkpLHN1bSkKICAgICAgfQogICAgfQogIH0KCiAgLy8vIEBkZXYgUmV0dXJucyB0aGUgbWF4IHZhbHVlIGluIGFuIGFycmF5LgogIC8vLyBAcGFyYW0gc2VsZiBTdG9yYWdlIGFycmF5IGNvbnRhaW5pbmcgdWludDI1NiB0eXBlIHZhcmlhYmxlcwogIC8vLyBAcmV0dXJuIG1heFZhbHVlIFRoZSBoaWdoZXN0IHZhbHVlIGluIHRoZSBhcnJheQogIGZ1bmN0aW9uIGdldE1heCh1aW50MjU2W10gc3RvcmFnZSBzZWxmKSBwdWJsaWMgdmlldyByZXR1cm5zKHVpbnQyNTYgbWF4VmFsdWUpIHsKICAgIGFzc2VtYmx5IHsKICAgICAgbXN0b3JlKDB4NjAsc2VsZl9zbG90KQogICAgICBtYXhWYWx1ZSA6PSBzbG9hZChzaGEzKDB4NjAsMHgyMCkpCgogICAgICBmb3IgeyBsZXQgaSA6PSAwIH0gbHQoaSwgc2xvYWQoc2VsZl9zbG90KSkgeyBpIDo9IGFkZChpLCAxKSB9IHsKICAgICAgICBzd2l0Y2ggZ3Qoc2xvYWQoYWRkKHNoYTMoMHg2MCwweDIwKSxpKSksIG1heFZhbHVlKQogICAgICAgIGNhc2UgMSB7CiAgICAgICAgICBtYXhWYWx1ZSA6PSBzbG9hZChhZGQoc2hhMygweDYwLDB4MjApLGkpKQogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KCiAgLy8vIEBkZXYgUmV0dXJucyB0aGUgbWluaW11bSB2YWx1ZSBpbiBhbiBhcnJheS4KICAvLy8gQHBhcmFtIHNlbGYgU3RvcmFnZSBhcnJheSBjb250YWluaW5nIHVpbnQyNTYgdHlwZSB2YXJpYWJsZXMKICAvLy8gQHJldHVybiBtaW5WYWx1ZSBUaGUgaGlnaGVzdCB2YWx1ZSBpbiB0aGUgYXJyYXkKICBmdW5jdGlvbiBnZXRNaW4odWludDI1NltdIHN0b3JhZ2Ugc2VsZikgcHVibGljIHZpZXcgcmV0dXJucyh1aW50MjU2IG1pblZhbHVlKSB7CiAgICBhc3NlbWJseSB7CiAgICAgIG1zdG9yZSgweDYwLHNlbGZfc2xvdCkKICAgICAgbWluVmFsdWUgOj0gc2xvYWQoc2hhMygweDYwLDB4MjApKQoKICAgICAgZm9yIHsgbGV0IGkgOj0gMCB9IGx0KGksIHNsb2FkKHNlbGZfc2xvdCkpIHsgaSA6PSBhZGQoaSwgMSkgfSB7CiAgICAgICAgc3dpdGNoIGd0KHNsb2FkKGFkZChzaGEzKDB4NjAsMHgyMCksaSkpLCBtaW5WYWx1ZSkKICAgICAgICBjYXNlIDAgewogICAgICAgICAgbWluVmFsdWUgOj0gc2xvYWQoYWRkKHNoYTMoMHg2MCwweDIwKSxpKSkKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CgogIC8vLyBAZGV2IEZpbmRzIHRoZSBpbmRleCBvZiBhIGdpdmVuIHZhbHVlIGluIGFuIGFycmF5CiAgLy8vIEBwYXJhbSBzZWxmIFN0b3JhZ2UgYXJyYXkgY29udGFpbmluZyB1aW50MjU2IHR5cGUgdmFyaWFibGVzCiAgLy8vIEBwYXJhbSB2YWx1ZSBUaGUgdmFsdWUgdG8gc2VhcmNoIGZvcgogIC8vLyBAcGFyYW0gaXNTb3J0ZWQgVHJ1ZSBpZiB0aGUgYXJyYXkgaXMgc29ydGVkLCBmYWxzZSBvdGhlcndpc2UKICAvLy8gQHJldHVybiBmb3VuZCBUcnVlIGlmIHRoZSB2YWx1ZSB3YXMgZm91bmQsIGZhbHNlIG90aGVyd2lzZQogIC8vLyBAcmV0dXJuIGluZGV4IFRoZSBpbmRleCBvZiB0aGUgZ2l2ZW4gdmFsdWUsIHJldHVybnMgMCBpZiBmb3VuZCBpcyBmYWxzZQogIGZ1bmN0aW9uIGluZGV4T2YodWludDI1NltdIHN0b3JhZ2Ugc2VsZiwgdWludDI1NiB2YWx1ZSwgYm9vbCBpc1NvcnRlZCkKICAgICAgICAgICBwdWJsaWMKICAgICAgICAgICB2aWV3CiAgICAgICAgICAgcmV0dXJucyhib29sIGZvdW5kLCB1aW50MjU2IGluZGV4KSB7CiAgICBhc3NlbWJseXsKICAgICAgbXN0b3JlKDB4NjAsc2VsZl9zbG90KQogICAgICBzd2l0Y2ggaXNTb3J0ZWQKICAgICAgY2FzZSAxIHsKICAgICAgICBsZXQgaGlnaCA6PSBzdWIoc2xvYWQoc2VsZl9zbG90KSwxKQogICAgICAgIGxldCBtaWQgOj0gMAogICAgICAgIGxldCBsb3cgOj0gMAogICAgICAgIGZvciB7IH0gaXN6ZXJvKGd0KGxvdywgaGlnaCkpIHsgfSB7CiAgICAgICAgICBtaWQgOj0gZGl2KGFkZChsb3csaGlnaCksMikKCiAgICAgICAgICBzd2l0Y2ggbHQoc2xvYWQoYWRkKHNoYTMoMHg2MCwweDIwKSxtaWQpKSx2YWx1ZSkKICAgICAgICAgIGNhc2UgMSB7CiAgICAgICAgICAgICBsb3cgOj0gYWRkKG1pZCwxKQogICAgICAgICAgfQogICAgICAgICAgY2FzZSAwIHsKICAgICAgICAgICAgc3dpdGNoIGd0KHNsb2FkKGFkZChzaGEzKDB4NjAsMHgyMCksbWlkKSksdmFsdWUpCiAgICAgICAgICAgIGNhc2UgMSB7CiAgICAgICAgICAgICAgaGlnaCA6PSBzdWIobWlkLDEpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSAwIHsKICAgICAgICAgICAgICBmb3VuZCA6PSAxCiAgICAgICAgICAgICAgaW5kZXggOj0gbWlkCiAgICAgICAgICAgICAgbG93IDo9IGFkZChoaWdoLDEpCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgY2FzZSAwIHsKICAgICAgICBmb3IgeyBsZXQgbG93IDo9IDAgfSBsdChsb3csIHNsb2FkKHNlbGZfc2xvdCkpIHsgbG93IDo9IGFkZChsb3csIDEpIH0gewogICAgICAgICAgc3dpdGNoIGVxKHNsb2FkKGFkZChzaGEzKDB4NjAsMHgyMCksbG93KSksIHZhbHVlKQogICAgICAgICAgY2FzZSAxIHsKICAgICAgICAgICAgZm91bmQgOj0gMQogICAgICAgICAgICBpbmRleCA6PSBsb3cKICAgICAgICAgICAgbG93IDo9IHNsb2FkKHNlbGZfc2xvdCkKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CgogIC8vLyBAZGV2IFV0aWxpdHkgZnVuY3Rpb24gZm9yIGhlYXBTb3J0CiAgLy8vIEBwYXJhbSBpbmRleCBUaGUgaW5kZXggb2YgY2hpbGQgbm9kZQogIC8vLyBAcmV0dXJuIHBJIFRoZSBwYXJlbnQgbm9kZSBpbmRleAogIGZ1bmN0aW9uIGdldFBhcmVudEkodWludDI1NiBpbmRleCkgcHJpdmF0ZSBwdXJlIHJldHVybnMgKHVpbnQyNTYgcEkpIHsKICAgIHVpbnQyNTYgaSA9IGluZGV4IC0gMTsKICAgIHBJID0gaS8yOwogIH0KCiAgLy8vIEBkZXYgVXRpbGl0eSBmdW5jdGlvbiBmb3IgaGVhcFNvcnQKICAvLy8gQHBhcmFtIGluZGV4IFRoZSBpbmRleCBvZiBwYXJlbnQgbm9kZQogIC8vLyBAcmV0dXJuIGxjSSBUaGUgaW5kZXggb2YgbGVmdCBjaGlsZAogIGZ1bmN0aW9uIGdldExlZnRDaGlsZEkodWludDI1NiBpbmRleCkgcHJpdmF0ZSBwdXJlIHJldHVybnMgKHVpbnQyNTYgbGNJKSB7CiAgICB1aW50MjU2IGkgPSBpbmRleCAqIDI7CiAgICBsY0kgPSBpICsgMTsKICB9CgogIC8vLyBAZGV2IFNvcnRzIGdpdmVuIGFycmF5IGluIHBsYWNlCiAgLy8vIEBwYXJhbSBzZWxmIFN0b3JhZ2UgYXJyYXkgY29udGFpbmluZyB1aW50MjU2IHR5cGUgdmFyaWFibGVzCiAgZnVuY3Rpb24gaGVhcFNvcnQodWludDI1NltdIHN0b3JhZ2Ugc2VsZikgcHVibGljIHsKICAgIHVpbnQyNTYgZW5kID0gc2VsZi5sZW5ndGggLSAxOwogICAgdWludDI1NiBzdGFydCA9IGdldFBhcmVudEkoZW5kKTsKICAgIHVpbnQyNTYgcm9vdCA9IHN0YXJ0OwogICAgdWludDI1NiBsQ2hpbGQ7CiAgICB1aW50MjU2IHJDaGlsZDsKICAgIHVpbnQyNTYgc3dhcDsKICAgIHVpbnQyNTYgdGVtcDsKICAgIHdoaWxlKHN0YXJ0ID49IDApewogICAgICByb290ID0gc3RhcnQ7CiAgICAgIGxDaGlsZCA9IGdldExlZnRDaGlsZEkoc3RhcnQpOwogICAgICB3aGlsZShsQ2hpbGQgPD0gZW5kKXsKICAgICAgICByQ2hpbGQgPSBsQ2hpbGQgKyAxOwogICAgICAgIHN3YXAgPSByb290OwogICAgICAgIGlmKHNlbGZbc3dhcF0gPCBzZWxmW2xDaGlsZF0pCiAgICAgICAgICBzd2FwID0gbENoaWxkOwogICAgICAgIGlmKChyQ2hpbGQgPD0gZW5kKSAmJiAoc2VsZltzd2FwXTxzZWxmW3JDaGlsZF0pKQogICAgICAgICAgc3dhcCA9IHJDaGlsZDsKICAgICAgICBpZihzd2FwID09IHJvb3QpCiAgICAgICAgICBsQ2hpbGQgPSBlbmQrMTsKICAgICAgICBlbHNlIHsKICAgICAgICAgIHRlbXAgPSBzZWxmW3N3YXBdOwogICAgICAgICAgc2VsZltzd2FwXSA9IHNlbGZbcm9vdF07CiAgICAgICAgICBzZWxmW3Jvb3RdID0gdGVtcDsKICAgICAgICAgIHJvb3QgPSBzd2FwOwogICAgICAgICAgbENoaWxkID0gZ2V0TGVmdENoaWxkSShyb290KTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYoc3RhcnQgPT0gMCkKICAgICAgICBicmVhazsKICAgICAgZWxzZQogICAgICAgIHN0YXJ0ID0gc3RhcnQgLSAxOwogICAgfQogICAgd2hpbGUoZW5kID4gMCl7CiAgICAgIHRlbXAgPSBzZWxmW2VuZF07CiAgICAgIHNlbGZbZW5kXSA9IHNlbGZbMF07CiAgICAgIHNlbGZbMF0gPSB0ZW1wOwogICAgICBlbmQgPSBlbmQgLSAxOwogICAgICByb290ID0gMDsKICAgICAgbENoaWxkID0gZ2V0TGVmdENoaWxkSSgwKTsKICAgICAgd2hpbGUobENoaWxkIDw9IGVuZCl7CiAgICAgICAgckNoaWxkID0gbENoaWxkICsgMTsKICAgICAgICBzd2FwID0gcm9vdDsKICAgICAgICBpZihzZWxmW3N3YXBdIDwgc2VsZltsQ2hpbGRdKQogICAgICAgICAgc3dhcCA9IGxDaGlsZDsKICAgICAgICBpZigockNoaWxkIDw9IGVuZCkgJiYgKHNlbGZbc3dhcF08c2VsZltyQ2hpbGRdKSkKICAgICAgICAgIHN3YXAgPSByQ2hpbGQ7CiAgICAgICAgaWYoc3dhcCA9PSByb290KQogICAgICAgICAgbENoaWxkID0gZW5kICsgMTsKICAgICAgICBlbHNlIHsKICAgICAgICAgIHRlbXAgPSBzZWxmW3N3YXBdOwogICAgICAgICAgc2VsZltzd2FwXSA9IHNlbGZbcm9vdF07CiAgICAgICAgICBzZWxmW3Jvb3RdID0gdGVtcDsKICAgICAgICAgIHJvb3QgPSBzd2FwOwogICAgICAgICAgbENoaWxkID0gZ2V0TGVmdENoaWxkSShyb290KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CgogIC8vLyBAZGV2IFJlbW92ZXMgZHVwbGljYXRlcyBmcm9tIGEgZ2l2ZW4gYXJyYXkuCiAgLy8vIEBwYXJhbSBzZWxmIFN0b3JhZ2UgYXJyYXkgY29udGFpbmluZyB1aW50MjU2IHR5cGUgdmFyaWFibGVzCiAgZnVuY3Rpb24gdW5pcSh1aW50MjU2W10gc3RvcmFnZSBzZWxmKSBwdWJsaWMgcmV0dXJucyAodWludDI1NiBsZW5ndGgpIHsKICAgIGJvb2wgY29udGFpbnM7CiAgICB1aW50MjU2IGluZGV4OwoKICAgIGZvciAodWludDI1NiBpID0gMDsgaSA8IHNlbGYubGVuZ3RoOyBpKyspIHsKICAgICAgKGNvbnRhaW5zLCBpbmRleCkgPSBpbmRleE9mKHNlbGYsIHNlbGZbaV0sIGZhbHNlKTsKCiAgICAgIGlmIChpID4gaW5kZXgpIHsKICAgICAgICBmb3IgKHVpbnQyNTYgaiA9IGk7IGogPCBzZWxmLmxlbmd0aCAtIDE7IGorKyl7CiAgICAgICAgICBzZWxmW2pdID0gc2VsZltqICsgMV07CiAgICAgICAgfQoKICAgICAgICBkZWxldGUgc2VsZltzZWxmLmxlbmd0aCAtIDFdOwogICAgICAgIHNlbGYubGVuZ3RoLS07CiAgICAgICAgaS0tOwogICAgICB9CiAgICB9CgogICAgbGVuZ3RoID0gc2VsZi5sZW5ndGg7CiAgfQp9CgpsaWJyYXJ5IEJhc2ljTWF0aExpYiB7CiAgLy8vIEBkZXYgTXVsdGlwbGllcyB0d28gbnVtYmVycyBhbmQgY2hlY2tzIGZvciBvdmVyZmxvdyBiZWZvcmUgcmV0dXJuaW5nLgogIC8vLyBEb2VzIG5vdCB0aHJvdy4KICAvLy8gQHBhcmFtIGEgRmlyc3QgbnVtYmVyCiAgLy8vIEBwYXJhbSBiIFNlY29uZCBudW1iZXIKICAvLy8gQHJldHVybiBlcnIgRmFsc2Ugbm9ybWFsbHksIG9yIHRydWUgaWYgdGhlcmUgaXMgb3ZlcmZsb3cKICAvLy8gQHJldHVybiByZXMgVGhlIHByb2R1Y3Qgb2YgYSBhbmQgYiwgb3IgMCBpZiB0aGVyZSBpcyBvdmVyZmxvdwogIGZ1bmN0aW9uIHRpbWVzKHVpbnQyNTYgYSwgdWludDI1NiBiKSBwdWJsaWMgdmlldyByZXR1cm5zIChib29sIGVycix1aW50MjU2IHJlcykgewogICAgYXNzZW1ibHl7CiAgICAgIHJlcyA6PSBtdWwoYSxiKQogICAgICBzd2l0Y2ggb3IoaXN6ZXJvKGIpLCBlcShkaXYocmVzLGIpLCBhKSkKICAgICAgY2FzZSAwIHsKICAgICAgICBlcnIgOj0gMQogICAgICAgIHJlcyA6PSAwCiAgICAgIH0KICAgIH0KICB9CgogIC8vLyBAZGV2IERpdmlkZXMgdHdvIG51bWJlcnMgYnV0IGNoZWNrcyBmb3IgMCBpbiB0aGUgZGl2aXNvciBmaXJzdC4KICAvLy8gRG9lcyBub3QgdGhyb3cuCiAgLy8vIEBwYXJhbSBhIEZpcnN0IG51bWJlcgogIC8vLyBAcGFyYW0gYiBTZWNvbmQgbnVtYmVyCiAgLy8vIEByZXR1cm4gZXJyIEZhbHNlIG5vcm1hbGx5LCBvciB0cnVlIGlmIGBiYCBpcyAwCiAgLy8vIEByZXR1cm4gcmVzIFRoZSBxdW90aWVudCBvZiBhIGFuZCBiLCBvciAwIGlmIGBiYCBpcyAwCiAgZnVuY3Rpb24gZGl2aWRlZEJ5KHVpbnQyNTYgYSwgdWludDI1NiBiKSBwdWJsaWMgdmlldyByZXR1cm5zIChib29sIGVycix1aW50MjU2IGkpIHsKICAgIHVpbnQyNTYgcmVzOwogICAgYXNzZW1ibHl7CiAgICAgIHN3aXRjaCBpc3plcm8oYikKICAgICAgY2FzZSAwIHsKICAgICAgICByZXMgOj0gZGl2KGEsYikKICAgICAgICBsZXQgbG9jIDo9IG1sb2FkKDB4NDApCiAgICAgICAgbXN0b3JlKGFkZChsb2MsMHgyMCkscmVzKQogICAgICAgIGkgOj0gbWxvYWQoYWRkKGxvYywweDIwKSkKICAgICAgfQogICAgICBkZWZhdWx0IHsKICAgICAgICBlcnIgOj0gMQogICAgICAgIGkgOj0gMAogICAgICB9CiAgICB9CiAgfQoKICAvLy8gQGRldiBBZGRzIHR3byBudW1iZXJzIGFuZCBjaGVja3MgZm9yIG92ZXJmbG93IGJlZm9yZSByZXR1cm5pbmcuCiAgLy8vIERvZXMgbm90IHRocm93LgogIC8vLyBAcGFyYW0gYSBGaXJzdCBudW1iZXIKICAvLy8gQHBhcmFtIGIgU2Vjb25kIG51bWJlcgogIC8vLyBAcmV0dXJuIGVyciBGYWxzZSBub3JtYWxseSwgb3IgdHJ1ZSBpZiB0aGVyZSBpcyBvdmVyZmxvdwogIC8vLyBAcmV0dXJuIHJlcyBUaGUgc3VtIG9mIGEgYW5kIGIsIG9yIDAgaWYgdGhlcmUgaXMgb3ZlcmZsb3cKICBmdW5jdGlvbiBwbHVzKHVpbnQyNTYgYSwgdWludDI1NiBiKSBwdWJsaWMgdmlldyByZXR1cm5zIChib29sIGVyciwgdWludDI1NiByZXMpIHsKICAgIGFzc2VtYmx5ewogICAgICByZXMgOj0gYWRkKGEsYikKICAgICAgc3dpdGNoIGFuZChlcShzdWIocmVzLGIpLCBhKSwgb3IoZ3QocmVzLGIpLGVxKHJlcyxiKSkpCiAgICAgIGNhc2UgMCB7CiAgICAgICAgZXJyIDo9IDEKICAgICAgICByZXMgOj0gMAogICAgICB9CiAgICB9CiAgfQoKICAvLy8gQGRldiBTdWJ0cmFjdHMgdHdvIG51bWJlcnMgYW5kIGNoZWNrcyBmb3IgdW5kZXJmbG93IGJlZm9yZSByZXR1cm5pbmcuCiAgLy8vIERvZXMgbm90IHRocm93IGJ1dCByYXRoZXIgbG9ncyBhbiBFcnIgZXZlbnQgaWYgdGhlcmUgaXMgdW5kZXJmbG93LgogIC8vLyBAcGFyYW0gYSBGaXJzdCBudW1iZXIKICAvLy8gQHBhcmFtIGIgU2Vjb25kIG51bWJlcgogIC8vLyBAcmV0dXJuIGVyciBGYWxzZSBub3JtYWxseSwgb3IgdHJ1ZSBpZiB0aGVyZSBpcyB1bmRlcmZsb3cKICAvLy8gQHJldHVybiByZXMgVGhlIGRpZmZlcmVuY2UgYmV0d2VlbiBhIGFuZCBiLCBvciAwIGlmIHRoZXJlIGlzIHVuZGVyZmxvdwogIGZ1bmN0aW9uIG1pbnVzKHVpbnQyNTYgYSwgdWludDI1NiBiKSBwdWJsaWMgdmlldyByZXR1cm5zIChib29sIGVycix1aW50MjU2IHJlcykgewogICAgYXNzZW1ibHl7CiAgICAgIHJlcyA6PSBzdWIoYSxiKQogICAgICBzd2l0Y2ggZXEoYW5kKGVxKGFkZChyZXMsYiksIGEpLCBvcihsdChyZXMsYSksIGVxKHJlcyxhKSkpLCAxKQogICAgICBjYXNlIDAgewogICAgICAgIGVyciA6PSAxCiAgICAgICAgcmVzIDo9IDAKICAgICAgfQogICAgfQogIH0KfQ=='.
	

]
