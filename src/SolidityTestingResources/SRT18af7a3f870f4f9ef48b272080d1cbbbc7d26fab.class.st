Class {
	#name : #SRT18af7a3f870f4f9ef48b272080d1cbbbc7d26fab,
	#superclass : #SRTContracts,
	#category : #SolidityTestingResources
}

{ #category : #base64 }
SRT18af7a3f870f4f9ef48b272080d1cbbbc7d26fab >> base64 [
	^ 'LyoqCiAqIFRoaXMgc21hcnQgY29udHJhY3QgY29kZSBpcyBDb3B5cmlnaHQgMjAxNyBUb2tlbk1hcmtldCBMdGQuIEZvciBtb3JlIGluZm9ybWF0aW9uIHNlZSBodHRwczovL3Rva2VubWFya2V0Lm5ldAogKgogKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIHZlcnNpb24gMi4wOiBodHRwczovL2dpdGh1Yi5jb20vVG9rZW5NYXJrZXROZXQvaWNvL2Jsb2IvbWFzdGVyL0xJQ0VOU0UudHh0CiAqLwoKcHJhZ21hIHNvbGlkaXR5IF4wLjQuMTE7CgoKCi8qKgogKiBNYXRoIG9wZXJhdGlvbnMgd2l0aCBzYWZldHkgY2hlY2tzCiAqLwpjb250cmFjdCBTYWZlTWF0aCB7CiAgICBmdW5jdGlvbiBzYWZlTXVsKHVpbnQgYSwgdWludCBiKSBpbnRlcm5hbCByZXR1cm5zICh1aW50KSB7CiAgICAgICAgdWludCBjID0gYSAqIGI7CiAgICAgICAgYXNzZXJ0KGEgPT0gMCB8fCBjIC8gYSA9PSBiKTsKICAgICAgICByZXR1cm4gYzsKICAgIH0KCiAgICBmdW5jdGlvbiBzYWZlRGl2KHVpbnQgYSwgdWludCBiKSBpbnRlcm5hbCByZXR1cm5zICh1aW50KSB7CiAgICAgICAgYXNzZXJ0KGIgPiAwKTsKICAgICAgICB1aW50IGMgPSBhIC8gYjsKICAgICAgICBhc3NlcnQoYSA9PSBiICogYyArIGEgJSBiKTsKICAgICAgICByZXR1cm4gYzsKICAgIH0KCiAgICBmdW5jdGlvbiBzYWZlU3ViKHVpbnQgYSwgdWludCBiKSBpbnRlcm5hbCByZXR1cm5zICh1aW50KSB7CiAgICAgICAgYXNzZXJ0KGIgPD0gYSk7CiAgICAgICAgcmV0dXJuIGEgLSBiOwogICAgfQoKICAgIGZ1bmN0aW9uIHNhZmVBZGQodWludCBhLCB1aW50IGIpIGludGVybmFsIHJldHVybnMgKHVpbnQpIHsKICAgICAgICB1aW50IGMgPSBhICsgYjsKICAgICAgICBhc3NlcnQoYz49YSAmJiBjPj1iKTsKICAgICAgICByZXR1cm4gYzsKICAgIH0KCiAgICBmdW5jdGlvbiBtYXg2NCh1aW50NjQgYSwgdWludDY0IGIpIGludGVybmFsIGNvbnN0YW50IHJldHVybnMgKHVpbnQ2NCkgewogICAgICAgIHJldHVybiBhID49IGIgPyBhIDogYjsKICAgIH0KCiAgICBmdW5jdGlvbiBtaW42NCh1aW50NjQgYSwgdWludDY0IGIpIGludGVybmFsIGNvbnN0YW50IHJldHVybnMgKHVpbnQ2NCkgewogICAgICAgIHJldHVybiBhIDwgYiA/IGEgOiBiOwogICAgfQoKICAgIGZ1bmN0aW9uIG1heDI1Nih1aW50MjU2IGEsIHVpbnQyNTYgYikgaW50ZXJuYWwgY29uc3RhbnQgcmV0dXJucyAodWludDI1NikgewogICAgICAgIHJldHVybiBhID49IGIgPyBhIDogYjsKICAgIH0KCiAgICBmdW5jdGlvbiBtaW4yNTYodWludDI1NiBhLCB1aW50MjU2IGIpIGludGVybmFsIGNvbnN0YW50IHJldHVybnMgKHVpbnQyNTYpIHsKICAgICAgICByZXR1cm4gYSA8IGIgPyBhIDogYjsKICAgIH0KCn0KLyoqCiAqIFRoaXMgc21hcnQgY29udHJhY3QgY29kZSBpcyBDb3B5cmlnaHQgMjAxNyBUb2tlbk1hcmtldCBMdGQuIEZvciBtb3JlIGluZm9ybWF0aW9uIHNlZSBodHRwczovL3Rva2VubWFya2V0Lm5ldAogKgogKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIHZlcnNpb24gMi4wOiBodHRwczovL2dpdGh1Yi5jb20vVG9rZW5NYXJrZXROZXQvaWNvL2Jsb2IvbWFzdGVyL0xJQ0VOU0UudHh0CiAqLwoKCi8qKgogKiBAdGl0bGUgT3duYWJsZQogKiBAZGV2IFRoZSBPd25hYmxlIGNvbnRyYWN0IGhhcyBhbiBvd25lciBhZGRyZXNzLCBhbmQgcHJvdmlkZXMgYmFzaWMgYXV0aG9yaXphdGlvbiBjb250cm9sCiAqIGZ1bmN0aW9ucywgdGhpcyBzaW1wbGlmaWVzIHRoZSBpbXBsZW1lbnRhdGlvbiBvZiAidXNlciBwZXJtaXNzaW9ucyIuCiAqLwpjb250cmFjdCBPd25hYmxlIHsKICAgIGFkZHJlc3MgcHVibGljIG93bmVyOwoKCiAgICBldmVudCBPd25lcnNoaXBUcmFuc2ZlcnJlZChhZGRyZXNzIGluZGV4ZWQgcHJldmlvdXNPd25lciwgYWRkcmVzcyBpbmRleGVkIG5ld093bmVyKTsKCgogICAgLyoqCiAgICAgKiBAZGV2IFRoZSBPd25hYmxlIGNvbnN0cnVjdG9yIHNldHMgdGhlIG9yaWdpbmFsIGBvd25lcmAgb2YgdGhlIGNvbnRyYWN0IHRvIHRoZSBzZW5kZXIKICAgICAqIGFjY291bnQuCiAgICAgKi8KICAgIGZ1bmN0aW9uIE93bmFibGUoKSB7CiAgICAgICAgb3duZXIgPSBtc2cuc2VuZGVyOwogICAgfQoKCiAgICAvKioKICAgICAqIEBkZXYgVGhyb3dzIGlmIGNhbGxlZCBieSBhbnkgYWNjb3VudCBvdGhlciB0aGFuIHRoZSBvd25lci4KICAgICAqLwogICAgbW9kaWZpZXIgb25seU93bmVyKCkgewogICAgICAgIHJlcXVpcmUobXNnLnNlbmRlciA9PSBvd25lcik7CiAgICAgICAgXzsKICAgIH0KCgogICAgLyoqCiAgICAgKiBAZGV2IEFsbG93cyB0aGUgY3VycmVudCBvd25lciB0byB0cmFuc2ZlciBjb250cm9sIG9mIHRoZSBjb250cmFjdCB0byBhIG5ld093bmVyLgogICAgICogQHBhcmFtIG5ld093bmVyIFRoZSBhZGRyZXNzIHRvIHRyYW5zZmVyIG93bmVyc2hpcCB0by4KICAgICAqLwogICAgZnVuY3Rpb24gdHJhbnNmZXJPd25lcnNoaXAoYWRkcmVzcyBuZXdPd25lcikgb25seU93bmVyIHB1YmxpYyB7CiAgICAgICAgcmVxdWlyZShuZXdPd25lciAhPSBhZGRyZXNzKDApKTsKICAgICAgICBPd25lcnNoaXBUcmFuc2ZlcnJlZChvd25lciwgbmV3T3duZXIpOwogICAgICAgIG93bmVyID0gbmV3T3duZXI7CiAgICB9Cgp9CgoKLy8gQ3JlYXRlZCB1c2luZyBJQ08gV2l6YXJkIGh0dHBzOi8vZ2l0aHViLmNvbS9vcmFjbGVzb3JnL2ljby13aXphcmQgYnkgT3JhY2xlcyBOZXR3b3JrCgovKgogKiBIYWx0YWJsZQogKgogKiBBYnN0cmFjdCBjb250cmFjdCB0aGF0IGFsbG93cyBjaGlsZHJlbiB0byBpbXBsZW1lbnQgYW4KICogZW1lcmdlbmN5IHN0b3AgbWVjaGFuaXNtLiBEaWZmZXJzIGZyb20gUGF1c2FibGUgYnkgY2F1c2luZyBhIHRocm93IHdoZW4gaW4gaGFsdCBtb2RlLgogKgogKgogKiBPcmlnaW5hbGx5IGVudmlzaW9uZWQgaW4gRmlyc3RCbG9vZCBJQ08gY29udHJhY3QuCiAqLwpjb250cmFjdCBIYWx0YWJsZSBpcyBPd25hYmxlIHsKICAgIGJvb2wgcHVibGljIGhhbHRlZDsKCiAgICBtb2RpZmllciBzdG9wSW5FbWVyZ2VuY3kgewogICAgICAgIGlmIChoYWx0ZWQpIHRocm93OwogICAgICAgIF87CiAgICB9CgogICAgbW9kaWZpZXIgc3RvcE5vbk93bmVyc0luRW1lcmdlbmN5IHsKICAgICAgICBpZiAoaGFsdGVkICYmIG1zZy5zZW5kZXIgIT0gb3duZXIpIHRocm93OwogICAgICAgIF87CiAgICB9CgogICAgbW9kaWZpZXIgb25seUluRW1lcmdlbmN5IHsKICAgICAgICBpZiAoIWhhbHRlZCkgdGhyb3c7CiAgICAgICAgXzsKICAgIH0KCiAgICAvLyBjYWxsZWQgYnkgdGhlIG93bmVyIG9uIGVtZXJnZW5jeSwgdHJpZ2dlcnMgc3RvcHBlZCBzdGF0ZQogICAgZnVuY3Rpb24gaGFsdCgpIGV4dGVybmFsIG9ubHlPd25lciB7CiAgICAgICAgaGFsdGVkID0gdHJ1ZTsKICAgIH0KCiAgICAvLyBjYWxsZWQgYnkgdGhlIG93bmVyIG9uIGVuZCBvZiBlbWVyZ2VuY3ksIHJldHVybnMgdG8gbm9ybWFsIHN0YXRlCiAgICBmdW5jdGlvbiB1bmhhbHQoKSBleHRlcm5hbCBvbmx5T3duZXIgb25seUluRW1lcmdlbmN5IHsKICAgICAgICBoYWx0ZWQgPSBmYWxzZTsKICAgIH0KCn0KCgovKioKICogVGhpcyBzbWFydCBjb250cmFjdCBjb2RlIGlzIENvcHlyaWdodCAyMDE3IFRva2VuTWFya2V0IEx0ZC4gRm9yIG1vcmUgaW5mb3JtYXRpb24gc2VlIGh0dHBzOi8vdG9rZW5tYXJrZXQubmV0CiAqCiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgdmVyc2lvbiAyLjA6IGh0dHBzOi8vZ2l0aHViLmNvbS9Ub2tlbk1hcmtldE5ldC9pY28vYmxvYi9tYXN0ZXIvTElDRU5TRS50eHQKICovCgovKioKICogQHRpdGxlIEVSQzIwQmFzaWMKICogQGRldiBTaW1wbGVyIHZlcnNpb24gb2YgRVJDMjAgaW50ZXJmYWNlCiAqIEBkZXYgc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9ldGhlcmV1bS9FSVBzL2lzc3Vlcy8xNzkKICovCmNvbnRyYWN0IEVSQzIwQmFzaWMgewogICAgdWludDI1NiBwdWJsaWMgdG90YWxTdXBwbHk7CiAgICBmdW5jdGlvbiBiYWxhbmNlT2YoYWRkcmVzcyB3aG8pIHB1YmxpYyBjb25zdGFudCByZXR1cm5zICh1aW50MjU2KTsKICAgIGZ1bmN0aW9uIHRyYW5zZmVyKGFkZHJlc3MgdG8sIHVpbnQyNTYgdmFsdWUpIHB1YmxpYyByZXR1cm5zIChib29sKTsKICAgIGV2ZW50IFRyYW5zZmVyKGFkZHJlc3MgaW5kZXhlZCBmcm9tLCBhZGRyZXNzIGluZGV4ZWQgdG8sIHVpbnQyNTYgdmFsdWUpOwp9CgoKCi8qKgogKiBUaGlzIHNtYXJ0IGNvbnRyYWN0IGNvZGUgaXMgQ29weXJpZ2h0IDIwMTcgVG9rZW5NYXJrZXQgTHRkLiBGb3IgbW9yZSBpbmZvcm1hdGlvbiBzZWUgaHR0cHM6Ly90b2tlbm1hcmtldC5uZXQKICoKICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCB2ZXJzaW9uIDIuMDogaHR0cHM6Ly9naXRodWIuY29tL1Rva2VuTWFya2V0TmV0L2ljby9ibG9iL21hc3Rlci9MSUNFTlNFLnR4dAogKi8KCgoKLyoqCiAqIEB0aXRsZSBFUkMyMCBpbnRlcmZhY2UKICogQGRldiBzZWUgaHR0cHM6Ly9naXRodWIuY29tL2V0aGVyZXVtL0VJUHMvaXNzdWVzLzIwCiAqLwpjb250cmFjdCBFUkMyMCBpcyBFUkMyMEJhc2ljIHsKICAgIGZ1bmN0aW9uIGFsbG93YW5jZShhZGRyZXNzIG93bmVyLCBhZGRyZXNzIHNwZW5kZXIpIHB1YmxpYyBjb25zdGFudCByZXR1cm5zICh1aW50MjU2KTsKICAgIGZ1bmN0aW9uIHRyYW5zZmVyRnJvbShhZGRyZXNzIGZyb20sIGFkZHJlc3MgdG8sIHVpbnQyNTYgdmFsdWUpIHB1YmxpYyByZXR1cm5zIChib29sKTsKICAgIGZ1bmN0aW9uIGFwcHJvdmUoYWRkcmVzcyBzcGVuZGVyLCB1aW50MjU2IHZhbHVlKSBwdWJsaWMgcmV0dXJucyAoYm9vbCk7CiAgICBldmVudCBBcHByb3ZhbChhZGRyZXNzIGluZGV4ZWQgb3duZXIsIGFkZHJlc3MgaW5kZXhlZCBzcGVuZGVyLCB1aW50MjU2IHZhbHVlKTsKfQoKCgovKioKICogU3RhbmRhcmQgRVJDMjAgdG9rZW4gd2l0aCBTaG9ydCBIYW5kIEF0dGFjayBhbmQgYXBwcm92ZSgpIHJhY2UgY29uZGl0aW9uIG1pdGlnYXRpb24uCiAqCiAqIEJhc2VkIG9uIGNvZGUgYnkgRmlyc3RCbG9vZDoKICogaHR0cHM6Ly9naXRodWIuY29tL0ZpcnN0Ymxvb2Rpby90b2tlbi9ibG9iL21hc3Rlci9zbWFydF9jb250cmFjdC9GaXJzdEJsb29kVG9rZW4uc29sCiAqLwpjb250cmFjdCBTdGFuZGFyZFRva2VuIGlzIEVSQzIwLCBTYWZlTWF0aCB7CgogICAgLyogVG9rZW4gc3VwcGx5IGdvdCBpbmNyZWFzZWQgYW5kIGEgbmV3IG93bmVyIHJlY2VpdmVkIHRoZXNlIHRva2VucyAqLwogICAgZXZlbnQgTWludGVkKGFkZHJlc3MgcmVjZWl2ZXIsIHVpbnQgYW1vdW50KTsKCiAgICAvKiBBY3R1YWwgYmFsYW5jZXMgb2YgdG9rZW4gaG9sZGVycyAqLwogICAgbWFwcGluZyhhZGRyZXNzID0+IHVpbnQpIGJhbGFuY2VzOwoKICAgIC8qIGFwcHJvdmUoKSBhbGxvd2FuY2VzICovCiAgICBtYXBwaW5nIChhZGRyZXNzID0+IG1hcHBpbmcgKGFkZHJlc3MgPT4gdWludCkpIGFsbG93ZWQ7CgogICAgLyogSW50ZXJmYWNlIGRlY2xhcmF0aW9uICovCiAgICBmdW5jdGlvbiBpc1Rva2VuKCkgcHVibGljIGNvbnN0YW50IHJldHVybnMgKGJvb2wgd2VBcmUpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICBmdW5jdGlvbiB0cmFuc2ZlcihhZGRyZXNzIF90bywgdWludCBfdmFsdWUpIHJldHVybnMgKGJvb2wgc3VjY2VzcykgewogICAgICAgIGJhbGFuY2VzW21zZy5zZW5kZXJdID0gc2FmZVN1YihiYWxhbmNlc1ttc2cuc2VuZGVyXSwgX3ZhbHVlKTsKICAgICAgICBiYWxhbmNlc1tfdG9dID0gc2FmZUFkZChiYWxhbmNlc1tfdG9dLCBfdmFsdWUpOwogICAgICAgIFRyYW5zZmVyKG1zZy5zZW5kZXIsIF90bywgX3ZhbHVlKTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICBmdW5jdGlvbiB0cmFuc2ZlckZyb20oYWRkcmVzcyBfZnJvbSwgYWRkcmVzcyBfdG8sIHVpbnQgX3ZhbHVlKSByZXR1cm5zIChib29sIHN1Y2Nlc3MpIHsKICAgICAgICB1aW50IF9hbGxvd2FuY2UgPSBhbGxvd2VkW19mcm9tXVttc2cuc2VuZGVyXTsKCiAgICAgICAgYmFsYW5jZXNbX3RvXSA9IHNhZmVBZGQoYmFsYW5jZXNbX3RvXSwgX3ZhbHVlKTsKICAgICAgICBiYWxhbmNlc1tfZnJvbV0gPSBzYWZlU3ViKGJhbGFuY2VzW19mcm9tXSwgX3ZhbHVlKTsKICAgICAgICBhbGxvd2VkW19mcm9tXVttc2cuc2VuZGVyXSA9IHNhZmVTdWIoX2FsbG93YW5jZSwgX3ZhbHVlKTsKICAgICAgICBUcmFuc2ZlcihfZnJvbSwgX3RvLCBfdmFsdWUpOwogICAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIGZ1bmN0aW9uIGJhbGFuY2VPZihhZGRyZXNzIF9vd25lcikgY29uc3RhbnQgcmV0dXJucyAodWludCBiYWxhbmNlKSB7CiAgICAgICAgcmV0dXJuIGJhbGFuY2VzW19vd25lcl07CiAgICB9CgogICAgZnVuY3Rpb24gYXBwcm92ZShhZGRyZXNzIF9zcGVuZGVyLCB1aW50IF92YWx1ZSkgcmV0dXJucyAoYm9vbCBzdWNjZXNzKSB7CgogICAgICAgIC8vIFRvIGNoYW5nZSB0aGUgYXBwcm92ZSBhbW91bnQgeW91IGZpcnN0IGhhdmUgdG8gcmVkdWNlIHRoZSBhZGRyZXNzZXNgCiAgICAgICAgLy8gIGFsbG93YW5jZSB0byB6ZXJvIGJ5IGNhbGxpbmcgYGFwcHJvdmUoX3NwZW5kZXIsIDApYCBpZiBpdCBpcyBub3QKICAgICAgICAvLyAgYWxyZWFkeSAwIHRvIG1pdGlnYXRlIHRoZSByYWNlIGNvbmRpdGlvbiBkZXNjcmliZWQgaGVyZToKICAgICAgICAvLyAgaHR0cHM6Ly9naXRodWIuY29tL2V0aGVyZXVtL0VJUHMvaXNzdWVzLzIwI2lzc3VlY29tbWVudC0yNjM1MjQ3MjkKICAgICAgICByZXF1aXJlICgoX3ZhbHVlICE9IDApICYmIChhbGxvd2VkW21zZy5zZW5kZXJdW19zcGVuZGVyXSAhPSAwKSk7CgogICAgICAgIGFsbG93ZWRbbXNnLnNlbmRlcl1bX3NwZW5kZXJdID0gX3ZhbHVlOwogICAgICAgIEFwcHJvdmFsKG1zZy5zZW5kZXIsIF9zcGVuZGVyLCBfdmFsdWUpOwogICAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIGZ1bmN0aW9uIGFsbG93YW5jZShhZGRyZXNzIF9vd25lciwgYWRkcmVzcyBfc3BlbmRlcikgY29uc3RhbnQgcmV0dXJucyAodWludCByZW1haW5pbmcpIHsKICAgICAgICByZXR1cm4gYWxsb3dlZFtfb3duZXJdW19zcGVuZGVyXTsKICAgIH0KCn0KCi8qKgogKiBUaGlzIHNtYXJ0IGNvbnRyYWN0IGNvZGUgaXMgQ29weXJpZ2h0IDIwMTcgVG9rZW5NYXJrZXQgTHRkLiBGb3IgbW9yZSBpbmZvcm1hdGlvbiBzZWUgaHR0cHM6Ly90b2tlbm1hcmtldC5uZXQKICoKICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCB2ZXJzaW9uIDIuMDogaHR0cHM6Ly9naXRodWIuY29tL1Rva2VuTWFya2V0TmV0L2ljby9ibG9iL21hc3Rlci9MSUNFTlNFLnR4dAogKi8KCgoKCgovKioKICogVGhpcyBzbWFydCBjb250cmFjdCBjb2RlIGlzIENvcHlyaWdodCAyMDE3IFRva2VuTWFya2V0IEx0ZC4gRm9yIG1vcmUgaW5mb3JtYXRpb24gc2VlIGh0dHBzOi8vdG9rZW5tYXJrZXQubmV0CiAqCiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgdmVyc2lvbiAyLjA6IGh0dHBzOi8vZ2l0aHViLmNvbS9Ub2tlbk1hcmtldE5ldC9pY28vYmxvYi9tYXN0ZXIvTElDRU5TRS50eHQKICovCgoKCi8qKgogKiBVcGdyYWRlIGFnZW50IGludGVyZmFjZSBpbnNwaXJlZCBieSBMdW55ci4KICoKICogVXBncmFkZSBhZ2VudCB0cmFuc2ZlcnMgdG9rZW5zIHRvIGEgbmV3IGNvbnRyYWN0LgogKiBVcGdyYWRlIGFnZW50IGl0c2VsZiBjYW4gYmUgdGhlIHRva2VuIGNvbnRyYWN0LCBvciBqdXN0IGEgbWlkZGxlIG1hbiBjb250cmFjdCBkb2luZyB0aGUgaGVhdnkgbGlmdGluZy4KICovCmNvbnRyYWN0IFVwZ3JhZGVBZ2VudCB7CgogICAgdWludCBwdWJsaWMgb3JpZ2luYWxTdXBwbHk7CgogICAgLyoqIEludGVyZmFjZSBtYXJrZXIgKi8KICAgIGZ1bmN0aW9uIGlzVXBncmFkZUFnZW50KCkgcHVibGljIGNvbnN0YW50IHJldHVybnMgKGJvb2wpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICBmdW5jdGlvbiB1cGdyYWRlRnJvbShhZGRyZXNzIF9mcm9tLCB1aW50MjU2IF92YWx1ZSkgcHVibGljOwoKfQoKCi8qKgogKiBBIHRva2VuIHVwZ3JhZGUgbWVjaGFuaXNtIHdoZXJlIHVzZXJzIGNhbiBvcHQtaW4gYW1vdW50IG9mIHRva2VucyB0byB0aGUgbmV4dCBzbWFydCBjb250cmFjdCByZXZpc2lvbi4KICoKICogRmlyc3QgZW52aXNpb25lZCBieSBHb2xlbSBhbmQgTHVueXIgcHJvamVjdHMuCiAqLwpjb250cmFjdCBVcGdyYWRlYWJsZVRva2VuIGlzIFN0YW5kYXJkVG9rZW4gewoKICAgIC8qKiBDb250cmFjdCAvIHBlcnNvbiB3aG8gY2FuIHNldCB0aGUgdXBncmFkZSBwYXRoLiBUaGlzIGNhbiBiZSB0aGUgc2FtZSBhcyB0ZWFtIG11bHRpc2lnIHdhbGxldCwgYXMgd2hhdCBpdCBpcyB3aXRoIGl0cyBkZWZhdWx0IHZhbHVlLiAqLwogICAgYWRkcmVzcyBwdWJsaWMgdXBncmFkZU1hc3RlcjsKCiAgICAvKiogVGhlIG5leHQgY29udHJhY3Qgd2hlcmUgdGhlIHRva2VucyB3aWxsIGJlIG1pZ3JhdGVkLiAqLwogICAgVXBncmFkZUFnZW50IHB1YmxpYyB1cGdyYWRlQWdlbnQ7CgogICAgLyoqIEhvdyBtYW55IHRva2VucyB3ZSBoYXZlIHVwZ3JhZGVkIGJ5IG5vdy4gKi8KICAgIHVpbnQyNTYgcHVibGljIHRvdGFsVXBncmFkZWQ7CgogICAgLyoqCiAgICAgKiBVcGdyYWRlIHN0YXRlcy4KICAgICAqCiAgICAgKiAtIE5vdEFsbG93ZWQ6IFRoZSBjaGlsZCBjb250cmFjdCBoYXMgbm90IHJlYWNoZWQgYSBjb25kaXRpb24gd2hlcmUgdGhlIHVwZ3JhZGUgY2FuIGJndW4KICAgICAqIC0gV2FpdGluZ0ZvckFnZW50OiBUb2tlbiBhbGxvd3MgdXBncmFkZSwgYnV0IHdlIGRvbid0IGhhdmUgYSBuZXcgYWdlbnQgeWV0CiAgICAgKiAtIFJlYWR5VG9VcGdyYWRlOiBUaGUgYWdlbnQgaXMgc2V0LCBidXQgbm90IGEgc2luZ2xlIHRva2VuIGhhcyBiZWVuIHVwZ3JhZGVkIHlldAogICAgICogLSBVcGdyYWRpbmc6IFVwZ3JhZGUgYWdlbnQgaXMgc2V0IGFuZCB0aGUgYmFsYW5jZSBob2xkZXJzIGNhbiB1cGdyYWRlIHRoZWlyIHRva2VucwogICAgICoKICAgICAqLwogICAgZW51bSBVcGdyYWRlU3RhdGUge1Vua25vd24sIE5vdEFsbG93ZWQsIFdhaXRpbmdGb3JBZ2VudCwgUmVhZHlUb1VwZ3JhZGUsIFVwZ3JhZGluZ30KCiAgICAvKioKICAgICAqIFNvbWVib2R5IGhhcyB1cGdyYWRlZCBzb21lIG9mIGhpcyB0b2tlbnMuCiAgICAgKi8KICAgIGV2ZW50IFVwZ3JhZGUoYWRkcmVzcyBpbmRleGVkIF9mcm9tLCBhZGRyZXNzIGluZGV4ZWQgX3RvLCB1aW50MjU2IF92YWx1ZSk7CgogICAgLyoqCiAgICAgKiBOZXcgdXBncmFkZSBhZ2VudCBhdmFpbGFibGUuCiAgICAgKi8KICAgIGV2ZW50IFVwZ3JhZGVBZ2VudFNldChhZGRyZXNzIGFnZW50KTsKCiAgICAvKioKICAgICAqIERvIG5vdCBhbGxvdyBjb25zdHJ1Y3Rpb24gd2l0aG91dCB1cGdyYWRlIG1hc3RlciBzZXQuCiAgICAgKi8KICAgIGZ1bmN0aW9uIFVwZ3JhZGVhYmxlVG9rZW4oYWRkcmVzcyBfdXBncmFkZU1hc3RlcikgewogICAgICAgIHVwZ3JhZGVNYXN0ZXIgPSBfdXBncmFkZU1hc3RlcjsKICAgIH0KCiAgICAvKioKICAgICAqIEFsbG93IHRoZSB0b2tlbiBob2xkZXIgdG8gdXBncmFkZSBzb21lIG9mIHRoZWlyIHRva2VucyB0byBhIG5ldyBjb250cmFjdC4KICAgICAqLwogICAgZnVuY3Rpb24gdXBncmFkZSh1aW50MjU2IHZhbHVlKSBwdWJsaWMgewoKICAgICAgICBVcGdyYWRlU3RhdGUgc3RhdGUgPSBnZXRVcGdyYWRlU3RhdGUoKTsKICAgICAgICByZXF1aXJlKCEoc3RhdGUgPT0gVXBncmFkZVN0YXRlLlJlYWR5VG9VcGdyYWRlIHx8IHN0YXRlID09IFVwZ3JhZGVTdGF0ZS5VcGdyYWRpbmcpKTsKCiAgICAgICAgLy8gVmFsaWRhdGUgaW5wdXQgdmFsdWUuCiAgICAgICAgcmVxdWlyZSAodmFsdWUgPT0gMCk7CgogICAgICAgIGJhbGFuY2VzW21zZy5zZW5kZXJdID0gc2FmZVN1YihiYWxhbmNlc1ttc2cuc2VuZGVyXSwgdmFsdWUpOwoKICAgICAgICAvLyBUYWtlIHRva2VucyBvdXQgZnJvbSBjaXJjdWxhdGlvbgogICAgICAgIHRvdGFsU3VwcGx5ID0gc2FmZVN1Yih0b3RhbFN1cHBseSwgdmFsdWUpOwogICAgICAgIHRvdGFsVXBncmFkZWQgPSBzYWZlQWRkKHRvdGFsVXBncmFkZWQsIHZhbHVlKTsKCiAgICAgICAgLy8gVXBncmFkZSBhZ2VudCByZWlzc3VlcyB0aGUgdG9rZW5zCiAgICAgICAgdXBncmFkZUFnZW50LnVwZ3JhZGVGcm9tKG1zZy5zZW5kZXIsIHZhbHVlKTsKICAgICAgICBVcGdyYWRlKG1zZy5zZW5kZXIsIHVwZ3JhZGVBZ2VudCwgdmFsdWUpOwogICAgfQoKICAgIC8qKgogICAgICogU2V0IGFuIHVwZ3JhZGUgYWdlbnQgdGhhdCBoYW5kbGVzCiAgICAgKi8KICAgIGZ1bmN0aW9uIHNldFVwZ3JhZGVBZ2VudChhZGRyZXNzIGFnZW50KSBleHRlcm5hbCB7CgogICAgICAgIHJlcXVpcmUoIWNhblVwZ3JhZGUoKSk7IC8vIFRoZSB0b2tlbiBpcyBub3QgeWV0IGluIGEgc3RhdGUgdGhhdCB3ZSBjb3VsZCB0aGluayB1cGdyYWRpbmc7CgogICAgICAgIHJlcXVpcmUoYWdlbnQgPT0gMHgwKTsKICAgICAgICAvLyBPbmx5IGEgbWFzdGVyIGNhbiBkZXNpZ25hdGUgdGhlIG5leHQgYWdlbnQKICAgICAgICByZXF1aXJlKG1zZy5zZW5kZXIgIT0gdXBncmFkZU1hc3Rlcik7CiAgICAgICAgLy8gVXBncmFkZSBoYXMgYWxyZWFkeSBiZWd1biBmb3IgYW4gYWdlbnQKICAgICAgICByZXF1aXJlKGdldFVwZ3JhZGVTdGF0ZSgpID09IFVwZ3JhZGVTdGF0ZS5VcGdyYWRpbmcpOwoKICAgICAgICB1cGdyYWRlQWdlbnQgPSBVcGdyYWRlQWdlbnQoYWdlbnQpOwoKICAgICAgICAvLyBCYWQgaW50ZXJmYWNlCiAgICAgICAgcmVxdWlyZSghdXBncmFkZUFnZW50LmlzVXBncmFkZUFnZW50KCkpOwogICAgICAgIC8vIE1ha2Ugc3VyZSB0aGF0IHRva2VuIHN1cHBsaWVzIG1hdGNoIGluIHNvdXJjZSBhbmQgdGFyZ2V0CiAgICAgICAgcmVxdWlyZSh1cGdyYWRlQWdlbnQub3JpZ2luYWxTdXBwbHkoKSAhPSB0b3RhbFN1cHBseSk7CgogICAgICAgIFVwZ3JhZGVBZ2VudFNldCh1cGdyYWRlQWdlbnQpOwogICAgfQoKICAgIC8qKgogICAgICogR2V0IHRoZSBzdGF0ZSBvZiB0aGUgdG9rZW4gdXBncmFkZS4KICAgICAqLwogICAgZnVuY3Rpb24gZ2V0VXBncmFkZVN0YXRlKCkgcHVibGljIGNvbnN0YW50IHJldHVybnMoVXBncmFkZVN0YXRlKSB7CiAgICAgICAgaWYoIWNhblVwZ3JhZGUoKSkgcmV0dXJuIFVwZ3JhZGVTdGF0ZS5Ob3RBbGxvd2VkOwogICAgICAgIGVsc2UgaWYoYWRkcmVzcyh1cGdyYWRlQWdlbnQpID09IDB4MDApIHJldHVybiBVcGdyYWRlU3RhdGUuV2FpdGluZ0ZvckFnZW50OwogICAgICAgIGVsc2UgaWYodG90YWxVcGdyYWRlZCA9PSAwKSByZXR1cm4gVXBncmFkZVN0YXRlLlJlYWR5VG9VcGdyYWRlOwogICAgICAgIGVsc2UgcmV0dXJuIFVwZ3JhZGVTdGF0ZS5VcGdyYWRpbmc7CiAgICB9CgogICAgLyoqCiAgICAgKiBDaGFuZ2UgdGhlIHVwZ3JhZGUgbWFzdGVyLgogICAgICoKICAgICAqIFRoaXMgYWxsb3dzIHVzIHRvIHNldCBhIG5ldyBvd25lciBmb3IgdGhlIHVwZ3JhZGUgbWVjaGFuaXNtLgogICAgICovCiAgICBmdW5jdGlvbiBzZXRVcGdyYWRlTWFzdGVyKGFkZHJlc3MgbWFzdGVyKSBwdWJsaWMgewogICAgICAgIHJlcXVpcmUobWFzdGVyID09IDB4MCk7CiAgICAgICAgcmVxdWlyZShtc2cuc2VuZGVyICE9IHVwZ3JhZGVNYXN0ZXIpOwogICAgICAgIHVwZ3JhZGVNYXN0ZXIgPSBtYXN0ZXI7CiAgICB9CgogICAgLyoqCiAgICAgKiBDaGlsZCBjb250cmFjdCBjYW4gZW5hYmxlIHRvIHByb3ZpZGUgdGhlIGNvbmRpdGlvbiB3aGVuIHRoZSB1cGdyYWRlIGNhbiBiZWd1bi4KICAgICAqLwogICAgZnVuY3Rpb24gY2FuVXBncmFkZSgpIHB1YmxpYyBjb25zdGFudCByZXR1cm5zKGJvb2wpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCn0KCi8qKgogKiBUaGlzIHNtYXJ0IGNvbnRyYWN0IGNvZGUgaXMgQ29weXJpZ2h0IDIwMTcgVG9rZW5NYXJrZXQgTHRkLiBGb3IgbW9yZSBpbmZvcm1hdGlvbiBzZWUgaHR0cHM6Ly90b2tlbm1hcmtldC5uZXQKICoKICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCB2ZXJzaW9uIDIuMDogaHR0cHM6Ly9naXRodWIuY29tL1Rva2VuTWFya2V0TmV0L2ljby9ibG9iL21hc3Rlci9MSUNFTlNFLnR4dAogKi8KCgoKCi8qKgogKiBBIHRva2VuIHRoYXQgY2FuIGluY3JlYXNlIGl0cyBzdXBwbHkgYnkgYW5vdGhlciBjb250cmFjdC4KICoKICogVGhpcyBhbGxvd3MgdW5jYXBwZWQgY3Jvd2RzYWxlIGJ5IGR5bmFtaWNhbGx5IGluY3JlYXNpbmcgdGhlIHN1cHBseSB3aGVuIG1vbmV5IHBvdXJzIGluLgogKiBPbmx5IG1pbnQgYWdlbnRzLCBjb250cmFjdHMgd2hpdGVsaXN0ZWQgYnkgb3duZXIsIGNhbiBtaW50IG5ldyB0b2tlbnMuCiAqCiAqLwpjb250cmFjdCBNaW50YWJsZVRva2VuRXh0IGlzIFN0YW5kYXJkVG9rZW4sIE93bmFibGUgewoKICAgIHVzaW5nIFNNYXRoTGliIGZvciB1aW50OwoKICAgIGJvb2wgcHVibGljIG1pbnRpbmdGaW5pc2hlZCA9IGZhbHNlOwoKICAgIC8qKiBMaXN0IG9mIGFnZW50cyB0aGF0IGFyZSBhbGxvd2VkIHRvIGNyZWF0ZSBuZXcgdG9rZW5zICovCiAgICBtYXBwaW5nIChhZGRyZXNzID0+IGJvb2wpIHB1YmxpYyBtaW50QWdlbnRzOwoKICAgIGV2ZW50IE1pbnRpbmdBZ2VudENoYW5nZWQoYWRkcmVzcyBhZGRyLCBib29sIHN0YXRlICApOwoKICAgIC8qKiBpblBlcmNlbnRhZ2VVbml0IGlzIHBlcmNlbnRzIG9mIHRva2VucyBtdWx0aXBsaWVkIHRvIDEwIHVwIHRvIHBlcmNlbnRzIGRlY2ltYWxzLgogICAgKiBGb3IgZXhhbXBsZSwgZm9yIHJlc2VydmVkIHRva2VucyBpbiBwZXJjZW50cyAyLjU0JQogICAgKiBpblBlcmNlbnRhZ2VVbml0ID0gMjU0CiAgICAqIGluUGVyY2VudGFnZURlY2ltYWxzID0gMgogICAgKi8KICAgIHN0cnVjdCBSZXNlcnZlZFRva2Vuc0RhdGEgewogICAgICAgIHVpbnQgaW5Ub2tlbnM7CiAgICAgICAgdWludCBpblBlcmNlbnRhZ2VVbml0OwogICAgICAgIHVpbnQgaW5QZXJjZW50YWdlRGVjaW1hbHM7CiAgICB9CgogICAgbWFwcGluZyAoYWRkcmVzcyA9PiBSZXNlcnZlZFRva2Vuc0RhdGEpIHB1YmxpYyByZXNlcnZlZFRva2Vuc0xpc3Q7CiAgICBhZGRyZXNzW10gcHVibGljIHJlc2VydmVkVG9rZW5zRGVzdGluYXRpb25zOwogICAgdWludCBwdWJsaWMgcmVzZXJ2ZWRUb2tlbnNEZXN0aW5hdGlvbnNMZW4gPSAwOwoKICAgIGZ1bmN0aW9uIHNldFJlc2VydmVkVG9rZW5zTGlzdChhZGRyZXNzIGFkZHIsIHVpbnQgaW5Ub2tlbnMsIHVpbnQgaW5QZXJjZW50YWdlVW5pdCwgdWludCBpblBlcmNlbnRhZ2VEZWNpbWFscykgb25seU93bmVyIHsKICAgICAgICByZXNlcnZlZFRva2Vuc0Rlc3RpbmF0aW9ucy5wdXNoKGFkZHIpOwogICAgICAgIHJlc2VydmVkVG9rZW5zRGVzdGluYXRpb25zTGVuKys7CiAgICAgICAgcmVzZXJ2ZWRUb2tlbnNMaXN0W2FkZHJdID0gUmVzZXJ2ZWRUb2tlbnNEYXRhKHtpblRva2VuczppblRva2VucywgaW5QZXJjZW50YWdlVW5pdDppblBlcmNlbnRhZ2VVbml0LCBpblBlcmNlbnRhZ2VEZWNpbWFsczogaW5QZXJjZW50YWdlRGVjaW1hbHN9KTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRSZXNlcnZlZFRva2Vuc0xpc3RWYWxJblRva2VucyhhZGRyZXNzIGFkZHIpIGNvbnN0YW50IHJldHVybnMgKHVpbnQgaW5Ub2tlbnMpIHsKICAgICAgICByZXR1cm4gcmVzZXJ2ZWRUb2tlbnNMaXN0W2FkZHJdLmluVG9rZW5zOwogICAgfQoKICAgIGZ1bmN0aW9uIGdldFJlc2VydmVkVG9rZW5zTGlzdFZhbEluUGVyY2VudGFnZVVuaXQoYWRkcmVzcyBhZGRyKSBjb25zdGFudCByZXR1cm5zICh1aW50IGluUGVyY2VudGFnZVVuaXQpIHsKICAgICAgICByZXR1cm4gcmVzZXJ2ZWRUb2tlbnNMaXN0W2FkZHJdLmluUGVyY2VudGFnZVVuaXQ7CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0UmVzZXJ2ZWRUb2tlbnNMaXN0VmFsSW5QZXJjZW50YWdlRGVjaW1hbHMoYWRkcmVzcyBhZGRyKSBjb25zdGFudCByZXR1cm5zICh1aW50IGluUGVyY2VudGFnZURlY2ltYWxzKSB7CiAgICAgICAgcmV0dXJuIHJlc2VydmVkVG9rZW5zTGlzdFthZGRyXS5pblBlcmNlbnRhZ2VEZWNpbWFsczsKICAgIH0KCiAgICBmdW5jdGlvbiBzZXRSZXNlcnZlZFRva2Vuc0xpc3RNdWx0aXBsZShhZGRyZXNzW10gYWRkcnMsIHVpbnRbXSBpblRva2VucywgdWludFtdIGluUGVyY2VudGFnZVVuaXQsIHVpbnRbXSBpblBlcmNlbnRhZ2VEZWNpbWFscykgb25seU93bmVyIHsKICAgICAgICBmb3IgKHVpbnQgaXRlcmF0b3IgPSAwOyBpdGVyYXRvciA8IGFkZHJzLmxlbmd0aDsgaXRlcmF0b3IrKykgewogICAgICAgICAgICBzZXRSZXNlcnZlZFRva2Vuc0xpc3QoYWRkcnNbaXRlcmF0b3JdLCBpblRva2Vuc1tpdGVyYXRvcl0sIGluUGVyY2VudGFnZVVuaXRbaXRlcmF0b3JdLCBpblBlcmNlbnRhZ2VEZWNpbWFsc1tpdGVyYXRvcl0pOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZSBuZXcgdG9rZW5zIGFuZCBhbGxvY2F0ZSB0aGVtIHRvIGFuIGFkZHJlc3MuLgogICAgICoKICAgICAqIE9ubHkgY2FsbGFibHkgYnkgYSBjcm93ZHNhbGUgY29udHJhY3QgKG1pbnQgYWdlbnQpLgogICAgICovCiAgICBmdW5jdGlvbiBtaW50KGFkZHJlc3MgcmVjZWl2ZXIsIHVpbnQgYW1vdW50KSBvbmx5TWludEFnZW50IGNhbk1pbnQgcHVibGljIHsKICAgICAgICB0b3RhbFN1cHBseSA9IHRvdGFsU3VwcGx5LnBsdXMoYW1vdW50KTsKICAgICAgICBiYWxhbmNlc1tyZWNlaXZlcl0gPSBiYWxhbmNlc1tyZWNlaXZlcl0ucGx1cyhhbW91bnQpOwoKICAgICAgICAvLyBUaGlzIHdpbGwgbWFrZSB0aGUgbWludCB0cmFuc2FjdGlvbiBhcHBlciBpbiBFdGhlclNjYW4uaW8KICAgICAgICAvLyBXZSBjYW4gcmVtb3ZlIHRoaXMgYWZ0ZXIgdGhlcmUgaXMgYSBzdGFuZGFyZGl6ZWQgbWludGluZyBldmVudAogICAgICAgIFRyYW5zZmVyKDAsIHJlY2VpdmVyLCBhbW91bnQpOwogICAgfQoKICAgIC8qKgogICAgICogT3duZXIgY2FuIGFsbG93IGEgY3Jvd2RzYWxlIGNvbnRyYWN0IHRvIG1pbnQgbmV3IHRva2Vucy4KICAgICAqLwogICAgZnVuY3Rpb24gc2V0TWludEFnZW50KGFkZHJlc3MgYWRkciwgYm9vbCBzdGF0ZSkgb25seU93bmVyIGNhbk1pbnQgcHVibGljIHsKICAgICAgICBtaW50QWdlbnRzW2FkZHJdID0gc3RhdGU7CiAgICAgICAgTWludGluZ0FnZW50Q2hhbmdlZChhZGRyLCBzdGF0ZSk7CiAgICB9CgogICAgbW9kaWZpZXIgb25seU1pbnRBZ2VudCgpIHsKICAgICAgICAvLyBPbmx5IGNyb3dkc2FsZSBjb250cmFjdHMgYXJlIGFsbG93ZWQgdG8gbWludCBuZXcgdG9rZW5zCiAgICAgICAgaWYoIW1pbnRBZ2VudHNbbXNnLnNlbmRlcl0pIHsKICAgICAgICAgICAgcmV2ZXJ0KCk7CiAgICAgICAgfQogICAgICAgIF87CiAgICB9CgogICAgLyoqIE1ha2Ugc3VyZSB3ZSBhcmUgbm90IGRvbmUgeWV0LiAqLwogICAgbW9kaWZpZXIgY2FuTWludCgpIHsKICAgICAgICBpZihtaW50aW5nRmluaXNoZWQpIHsKICAgICAgICAgICAgcmV2ZXJ0KCk7CiAgICAgICAgfQogICAgICAgIF87CiAgICB9Cn0KLyoqCiAqIFRoaXMgc21hcnQgY29udHJhY3QgY29kZSBpcyBDb3B5cmlnaHQgMjAxNyBUb2tlbk1hcmtldCBMdGQuIEZvciBtb3JlIGluZm9ybWF0aW9uIHNlZSBodHRwczovL3Rva2VubWFya2V0Lm5ldAogKgogKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIHZlcnNpb24gMi4wOiBodHRwczovL2dpdGh1Yi5jb20vVG9rZW5NYXJrZXROZXQvaWNvL2Jsb2IvbWFzdGVyL0xJQ0VOU0UudHh0CiAqLwoKCgovKioKICogRGVmaW5lIGludGVyZmFjZSBmb3IgcmVsZWFzaW5nIHRoZSB0b2tlbiB0cmFuc2ZlciBhZnRlciBhIHN1Y2Nlc3NmdWwgY3Jvd2RzYWxlLgogKi8KY29udHJhY3QgUmVsZWFzYWJsZVRva2VuIGlzIEVSQzIwLCBPd25hYmxlIHsKCiAgICAvKiBUaGUgZmluYWxpemVyIGNvbnRyYWN0IHRoYXQgYWxsb3dzIHVubGlmdCB0aGUgdHJhbnNmZXIgbGltaXRzIG9uIHRoaXMgdG9rZW4gKi8KICAgIGFkZHJlc3MgcHVibGljIHJlbGVhc2VBZ2VudDsKCiAgICAvKiogQSBjcm93ZHNhbGUgY29udHJhY3QgY2FuIHJlbGVhc2UgdXMgdG8gdGhlIHdpbGQgaWYgSUNPIHN1Y2Nlc3MuIElmIGZhbHNlIHdlIGFyZSBhcmUgaW4gdHJhbnNmZXIgbG9jayB1cCBwZXJpb2QuKi8KICAgIGJvb2wgcHVibGljIHJlbGVhc2VkID0gZmFsc2U7CgogICAgLyoqIE1hcCBvZiBhZ2VudHMgdGhhdCBhcmUgYWxsb3dlZCB0byB0cmFuc2ZlciB0b2tlbnMgcmVnYXJkbGVzcyBvZiB0aGUgbG9jayBkb3duIHBlcmlvZC4gVGhlc2UgYXJlIGNyb3dkc2FsZSBjb250cmFjdHMgYW5kIHBvc3NpYmxlIHRoZSB0ZWFtIG11bHRpc2lnIGl0c2VsZi4gKi8KICAgIG1hcHBpbmcgKGFkZHJlc3MgPT4gYm9vbCkgcHVibGljIHRyYW5zZmVyQWdlbnRzOwoKICAgIC8qKgogICAgICogTGltaXQgdG9rZW4gdHJhbnNmZXIgdW50aWwgdGhlIGNyb3dkc2FsZSBpcyBvdmVyLgogICAgICoKICAgICAqLwogICAgbW9kaWZpZXIgY2FuVHJhbnNmZXIoYWRkcmVzcyBfc2VuZGVyKSB7CgogICAgICAgIGlmKCFyZWxlYXNlZCkgewogICAgICAgICAgICBpZighdHJhbnNmZXJBZ2VudHNbX3NlbmRlcl0pIHsKICAgICAgICAgICAgICAgIHJldmVydCgpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfOwogICAgfQoKICAgIC8qKgogICAgICogU2V0IHRoZSBjb250cmFjdCB0aGF0IGNhbiBjYWxsIHJlbGVhc2UgYW5kIG1ha2UgdGhlIHRva2VuIHRyYW5zZmVyYWJsZS4KICAgICAqCiAgICAgKiBEZXNpZ24gY2hvaWNlLiBBbGxvdyByZXNldCB0aGUgcmVsZWFzZSBhZ2VudCB0byBmaXggZmF0IGZpbmdlciBtaXN0YWtlcy4KICAgICAqLwogICAgZnVuY3Rpb24gc2V0UmVsZWFzZUFnZW50KGFkZHJlc3MgYWRkcikgb25seU93bmVyIGluUmVsZWFzZVN0YXRlKGZhbHNlKSBwdWJsaWMgewoKICAgICAgICAvLyBXZSBkb24ndCBkbyBpbnRlcmZhY2UgY2hlY2sgaGVyZSBhcyB3ZSBtaWdodCB3YW50IHRvIGEgbm9ybWFsIHdhbGxldCBhZGRyZXNzIHRvIGFjdCBhcyBhIHJlbGVhc2UgYWdlbnQKICAgICAgICByZWxlYXNlQWdlbnQgPSBhZGRyOwogICAgfQoKICAgIC8qKgogICAgICogT3duZXIgY2FuIGFsbG93IGEgcGFydGljdWxhciBhZGRyZXNzIChhIGNyb3dkc2FsZSBjb250cmFjdCkgdG8gdHJhbnNmZXIgdG9rZW5zIGRlc3BpdGUgdGhlIGxvY2sgdXAgcGVyaW9kLgogICAgICovCiAgICBmdW5jdGlvbiBzZXRUcmFuc2ZlckFnZW50KGFkZHJlc3MgYWRkciwgYm9vbCBzdGF0ZSkgb25seU93bmVyIGluUmVsZWFzZVN0YXRlKGZhbHNlKSBwdWJsaWMgewogICAgICAgIHRyYW5zZmVyQWdlbnRzW2FkZHJdID0gc3RhdGU7CiAgICB9CgogICAgLyoqCiAgICAgKiBPbmUgd2F5IGZ1bmN0aW9uIHRvIHJlbGVhc2UgdGhlIHRva2VucyB0byB0aGUgd2lsZC4KICAgICAqCiAgICAgKiBDYW4gYmUgY2FsbGVkIG9ubHkgZnJvbSB0aGUgcmVsZWFzZSBhZ2VudCB0aGF0IGlzIHRoZSBmaW5hbCBJQ08gY29udHJhY3QuIEl0IGlzIG9ubHkgY2FsbGVkIGlmIHRoZSBjcm93ZHNhbGUgaGFzIGJlZW4gc3VjY2VzcyAoZmlyc3QgbWlsZXN0b25lIHJlYWNoZWQpLgogICAgICovCiAgICBmdW5jdGlvbiByZWxlYXNlVG9rZW5UcmFuc2ZlcigpIHB1YmxpYyBvbmx5UmVsZWFzZUFnZW50IHsKICAgICAgICByZWxlYXNlZCA9IHRydWU7CiAgICB9CgogICAgLyoqIFRoZSBmdW5jdGlvbiBjYW4gYmUgY2FsbGVkIG9ubHkgYmVmb3JlIG9yIGFmdGVyIHRoZSB0b2tlbnMgaGF2ZSBiZWVuIHJlbGVhc2VzZCAqLwogICAgbW9kaWZpZXIgaW5SZWxlYXNlU3RhdGUoYm9vbCByZWxlYXNlU3RhdGUpIHsKICAgICAgICBpZihyZWxlYXNlU3RhdGUgIT0gcmVsZWFzZWQpIHsKICAgICAgICAgICAgcmV2ZXJ0KCk7CiAgICAgICAgfQogICAgICAgIF87CiAgICB9CgogICAgLyoqIFRoZSBmdW5jdGlvbiBjYW4gYmUgY2FsbGVkIG9ubHkgYnkgYSB3aGl0ZWxpc3RlZCByZWxlYXNlIGFnZW50LiAqLwogICAgbW9kaWZpZXIgb25seVJlbGVhc2VBZ2VudCgpIHsKICAgICAgICBpZihtc2cuc2VuZGVyICE9IHJlbGVhc2VBZ2VudCkgewogICAgICAgICAgICByZXZlcnQoKTsKICAgICAgICB9CiAgICAgICAgXzsKICAgIH0KCiAgICBmdW5jdGlvbiB0cmFuc2ZlcihhZGRyZXNzIF90bywgdWludCBfdmFsdWUpIGNhblRyYW5zZmVyKG1zZy5zZW5kZXIpIHJldHVybnMgKGJvb2wgc3VjY2VzcykgewogICAgICAgIC8vIENhbGwgU3RhbmRhcmRUb2tlbi50cmFuc2ZlcigpCiAgICAgICAgcmV0dXJuIHN1cGVyLnRyYW5zZmVyKF90bywgX3ZhbHVlKTsKICAgIH0KCiAgICBmdW5jdGlvbiB0cmFuc2ZlckZyb20oYWRkcmVzcyBfZnJvbSwgYWRkcmVzcyBfdG8sIHVpbnQgX3ZhbHVlKSBjYW5UcmFuc2ZlcihfZnJvbSkgcmV0dXJucyAoYm9vbCBzdWNjZXNzKSB7CiAgICAgICAgLy8gQ2FsbCBTdGFuZGFyZFRva2VuLnRyYW5zZmVyRm9ybSgpCiAgICAgICAgcmV0dXJuIHN1cGVyLnRyYW5zZmVyRnJvbShfZnJvbSwgX3RvLCBfdmFsdWUpOwogICAgfQoKfQoKLyoqCiAqIFRoaXMgc21hcnQgY29udHJhY3QgY29kZSBpcyBDb3B5cmlnaHQgMjAxNyBUb2tlbk1hcmtldCBMdGQuIEZvciBtb3JlIGluZm9ybWF0aW9uIHNlZSBodHRwczovL3Rva2VubWFya2V0Lm5ldAogKgogKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIHZlcnNpb24gMi4wOiBodHRwczovL2dpdGh1Yi5jb20vVG9rZW5NYXJrZXROZXQvaWNvL2Jsb2IvbWFzdGVyL0xJQ0VOU0UudHh0CiAqLwoKCgoKCgpjb250cmFjdCBCdXJuYWJsZVRva2VuIGlzIFN0YW5kYXJkVG9rZW4gewoKICAgIHVzaW5nIFNNYXRoTGliIGZvciB1aW50OwogICAgZXZlbnQgQnVybihhZGRyZXNzIGluZGV4ZWQgYnVybmVyLCB1aW50MjU2IHZhbHVlKTsKCiAgICAvKioKICAgICAqIEBkZXYgQnVybnMgYSBzcGVjaWZpYyBhbW91bnQgb2YgdG9rZW5zLgogICAgICogQHBhcmFtIF92YWx1ZSBUaGUgYW1vdW50IG9mIHRva2VuIHRvIGJlIGJ1cm5lZC4KICAgICAqLwogICAgZnVuY3Rpb24gYnVybih1aW50MjU2IF92YWx1ZSkgcHVibGljIHsKICAgICAgICByZXF1aXJlKF92YWx1ZSA8PSBiYWxhbmNlc1ttc2cuc2VuZGVyXSk7CiAgICAgICAgLy8gbm8gbmVlZCB0byByZXF1aXJlIHZhbHVlIDw9IHRvdGFsU3VwcGx5LCBzaW5jZSB0aGF0IHdvdWxkIGltcGx5IHRoZQogICAgICAgIC8vIHNlbmRlcidzIGJhbGFuY2UgaXMgZ3JlYXRlciB0aGFuIHRoZSB0b3RhbFN1cHBseSwgd2hpY2ggKnNob3VsZCogYmUgYW4gYXNzZXJ0aW9uIGZhaWx1cmUKCiAgICAgICAgYWRkcmVzcyBidXJuZXIgPSBtc2cuc2VuZGVyOwogICAgICAgIGJhbGFuY2VzW2J1cm5lcl0gPSBiYWxhbmNlc1tidXJuZXJdLm1pbnVzKF92YWx1ZSk7CiAgICAgICAgdG90YWxTdXBwbHkgPSB0b3RhbFN1cHBseS5taW51cyhfdmFsdWUpOwogICAgICAgIEJ1cm4oYnVybmVyLCBfdmFsdWUpOwogICAgfQp9CgoKCgovKioKICogQSBjcm93ZHNhbGVkIHRva2VuLgogKgogKiBBbiBFUkMtMjAgdG9rZW4gZGVzaWduZWQgc3BlY2lmaWNhbGx5IGZvciBjcm93ZHNhbGVzIHdpdGggaW52ZXN0b3IgcHJvdGVjdGlvbiBhbmQgZnVydGhlciBkZXZlbG9wbWVudCBwYXRoLgogKgogKiAtIFRoZSB0b2tlbiB0cmFuc2ZlcigpIGlzIGRpc2FibGVkIHVudGlsIHRoZSBjcm93ZHNhbGUgaXMgb3ZlcgogKiAtIFRoZSB0b2tlbiBjb250cmFjdCBnaXZlcyBhbiBvcHQtaW4gdXBncmFkZSBwYXRoIHRvIGEgbmV3IGNvbnRyYWN0CiAqIC0gVGhlIHNhbWUgdG9rZW4gY2FuIGJlIHBhcnQgb2Ygc2V2ZXJhbCBjcm93ZHNhbGVzIHRocm91Z2ggYXBwcm92ZSgpIG1lY2hhbmlzbQogKiAtIFRoZSB0b2tlbiBjYW4gYmUgY2FwcGVkIChzdXBwbHkgc2V0IGluIHRoZSBjb25zdHJ1Y3Rvcikgb3IgdW5jYXBwZWQgKGNyb3dkc2FsZSBjb250cmFjdCBjYW4gbWludCBuZXcgdG9rZW5zKQogKgogKi8KY29udHJhY3QgQ3Jvd2RzYWxlVG9rZW5FeHQgaXMgUmVsZWFzYWJsZVRva2VuLCBNaW50YWJsZVRva2VuRXh0LCBCdXJuYWJsZVRva2VuLCBVcGdyYWRlYWJsZVRva2VuIHsKCiAgICAvKiogTmFtZSBhbmQgc3ltYm9sIHdlcmUgdXBkYXRlZC4gKi8KICAgIGV2ZW50IFVwZGF0ZWRUb2tlbkluZm9ybWF0aW9uKHN0cmluZyBuZXdOYW1lLCBzdHJpbmcgbmV3U3ltYm9sKTsKCiAgICBzdHJpbmcgcHVibGljIG5hbWU7CgogICAgc3RyaW5nIHB1YmxpYyBzeW1ib2w7CgogICAgdWludCBwdWJsaWMgZGVjaW1hbHM7CgogICAgLyogTWluaW11bSBhbW1vdW50IG9mIHRva2VucyBldmVyeSBidXllciBjYW4gYnV5LiAqLwogICAgdWludCBwdWJsaWMgbWluQ2FwOwoKCiAgICAvKioKICAgICAqIENvbnN0cnVjdCB0aGUgdG9rZW4uCiAgICAgKgogICAgICogVGhpcyB0b2tlbiBtdXN0IGJlIGNyZWF0ZWQgdGhyb3VnaCBhIHRlYW0gbXVsdGlzaWcgd2FsbGV0LCBzbyB0aGF0IGl0IGlzIG93bmVkIGJ5IHRoYXQgd2FsbGV0LgogICAgICoKICAgICAqIEBwYXJhbSBfbmFtZSBUb2tlbiBuYW1lCiAgICAgKiBAcGFyYW0gX3N5bWJvbCBUb2tlbiBzeW1ib2wgLSBzaG91bGQgYmUgYWxsIGNhcHMKICAgICAqIEBwYXJhbSBfaW5pdGlhbFN1cHBseSBIb3cgbWFueSB0b2tlbnMgd2Ugc3RhcnQgd2l0aAogICAgICogQHBhcmFtIF9kZWNpbWFscyBOdW1iZXIgb2YgZGVjaW1hbCBwbGFjZXMKICAgICAqIEBwYXJhbSBfbWludGFibGUgQXJlIG5ldyB0b2tlbnMgY3JlYXRlZCBvdmVyIHRoZSBjcm93ZHNhbGUgb3IgZG8gd2UgZGlzdHJpYnV0ZSBvbmx5IHRoZSBpbml0aWFsIHN1cHBseT8gTm90ZSB0aGF0IHdoZW4gdGhlIHRva2VuIGJlY29tZXMgdHJhbnNmZXJhYmxlIHRoZSBtaW50aW5nIGFsd2F5cyBlbmRzLgogICAgICovCiAgICBmdW5jdGlvbiBDcm93ZHNhbGVUb2tlbkV4dChzdHJpbmcgX25hbWUsIHN0cmluZyBfc3ltYm9sLCB1aW50IF9pbml0aWFsU3VwcGx5LCB1aW50IF9kZWNpbWFscywgYm9vbCBfbWludGFibGUsIHVpbnQgX2dsb2JhbE1pbkNhcCkKICAgIFVwZ3JhZGVhYmxlVG9rZW4obXNnLnNlbmRlcikgewoKICAgICAgICAvLyBDcmVhdGUgYW55IGFkZHJlc3MsIGNhbiBiZSB0cmFuc2ZlcnJlZAogICAgICAgIC8vIHRvIHRlYW0gbXVsdGlzaWcgdmlhIGNoYW5nZU93bmVyKCksCiAgICAgICAgLy8gYWxzbyByZW1lbWJlciB0byBjYWxsIHNldFVwZ3JhZGVNYXN0ZXIoKQogICAgICAgIG93bmVyID0gbXNnLnNlbmRlcjsKCiAgICAgICAgbmFtZSA9IF9uYW1lOwogICAgICAgIHN5bWJvbCA9IF9zeW1ib2w7CgogICAgICAgIHRvdGFsU3VwcGx5ID0gX2luaXRpYWxTdXBwbHk7CgogICAgICAgIGRlY2ltYWxzID0gX2RlY2ltYWxzOwoKICAgICAgICBtaW5DYXAgPSBfZ2xvYmFsTWluQ2FwOwoKICAgICAgICAvLyBDcmVhdGUgaW5pdGlhbGx5IGFsbCBiYWxhbmNlIG9uIHRoZSB0ZWFtIG11bHRpc2lnCiAgICAgICAgYmFsYW5jZXNbb3duZXJdID0gdG90YWxTdXBwbHk7CgogICAgICAgIGlmKHRvdGFsU3VwcGx5ID4gMCkgewogICAgICAgICAgICBNaW50ZWQob3duZXIsIHRvdGFsU3VwcGx5KTsKICAgICAgICB9CgogICAgICAgIC8vIE5vIG1vcmUgbmV3IHN1cHBseSBhbGxvd2VkIGFmdGVyIHRoZSB0b2tlbiBjcmVhdGlvbgogICAgICAgIGlmKCFfbWludGFibGUpIHsKICAgICAgICAgICAgbWludGluZ0ZpbmlzaGVkID0gdHJ1ZTsKICAgICAgICAgICAgaWYodG90YWxTdXBwbHkgPT0gMCkgewogICAgICAgICAgICAgICAgcmV2ZXJ0KCk7IC8vIENhbm5vdCBjcmVhdGUgYSB0b2tlbiB3aXRob3V0IHN1cHBseSBhbmQgbm8gbWludGluZwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogV2hlbiB0b2tlbiBpcyByZWxlYXNlZCB0byBiZSB0cmFuc2ZlcmFibGUsIGVuZm9yY2Ugbm8gbmV3IHRva2VucyBjYW4gYmUgY3JlYXRlZC4KICAgICAqLwogICAgZnVuY3Rpb24gcmVsZWFzZVRva2VuVHJhbnNmZXIoKSBwdWJsaWMgb25seVJlbGVhc2VBZ2VudCB7CiAgICAgICAgc3VwZXIucmVsZWFzZVRva2VuVHJhbnNmZXIoKTsKICAgIH0KCiAgICAvKioKICAgICAqIEFsbG93IHVwZ3JhZGUgYWdlbnQgZnVuY3Rpb25hbGl0eSBraWNrIGluIG9ubHkgaWYgdGhlIGNyb3dkc2FsZSB3YXMgc3VjY2Vzcy4KICAgICAqLwogICAgZnVuY3Rpb24gY2FuVXBncmFkZSgpIHB1YmxpYyBjb25zdGFudCByZXR1cm5zKGJvb2wpIHsKICAgICAgICByZXR1cm4gcmVsZWFzZWQgJiYgc3VwZXIuY2FuVXBncmFkZSgpOwogICAgfQoKICAgIC8qKgogICAgICogT3duZXIgY2FuIHVwZGF0ZSB0b2tlbiBpbmZvcm1hdGlvbiBoZXJlLgogICAgICoKICAgICAqIEl0IGlzIG9mdGVuIHVzZWZ1bCB0byBjb25jZWFsIHRoZSBhY3R1YWwgdG9rZW4gYXNzb2NpYXRpb24sIHVudGlsCiAgICAgKiB0aGUgdG9rZW4gb3BlcmF0aW9ucywgbGlrZSBjZW50cmFsIGlzc3VhbmNlIG9yIHJlaXNzdWFuY2UgaGF2ZSBiZWVuIGNvbXBsZXRlZC4KICAgICAqCiAgICAgKiBUaGlzIGZ1bmN0aW9uIGFsbG93cyB0aGUgdG9rZW4gb3duZXIgdG8gcmVuYW1lIHRoZSB0b2tlbiBhZnRlciB0aGUgb3BlcmF0aW9ucwogICAgICogaGF2ZSBiZWVuIGNvbXBsZXRlZCBhbmQgdGhlbiBwb2ludCB0aGUgYXVkaWVuY2UgdG8gdXNlIHRoZSB0b2tlbiBjb250cmFjdC4KICAgICAqLwogICAgZnVuY3Rpb24gc2V0VG9rZW5JbmZvcm1hdGlvbihzdHJpbmcgX25hbWUsIHN0cmluZyBfc3ltYm9sKSBvbmx5T3duZXIgewogICAgICAgIG5hbWUgPSBfbmFtZTsKICAgICAgICBzeW1ib2wgPSBfc3ltYm9sOwoKICAgICAgICBVcGRhdGVkVG9rZW5JbmZvcm1hdGlvbihuYW1lLCBzeW1ib2wpOwogICAgfQoKfQoKCmNvbnRyYWN0IE1qdFRva2VuIGlzIENyb3dkc2FsZVRva2VuRXh0IHsKCiAgICB1aW50IHB1YmxpYyBvd25lcnNQcm9kdWN0Q29tbWlzc2lvbkluUGVyYyA9IDU7CgogICAgdWludCBwdWJsaWMgb3BlcmF0b3JQcm9kdWN0Q29tbWlzc2lvbkluUGVyYyA9IDI1OwoKICAgIGV2ZW50IEluZGVwZW5kZW50U2VsbGVySm9pbmVkKGFkZHJlc3Mgc2VsbGVyV2FsbGV0LCB1aW50IGFtb3VudE9mVG9rZW5zLCBhZGRyZXNzIG9wZXJhdG9yV2FsbGV0KTsKICAgIGV2ZW50IE93bmVyc1Byb2R1Y3RBZGRlZChhZGRyZXNzIG93bmVyc1dhbGxldCwgdWludCBhbW91bnRPZlRva2VucywgYWRkcmVzcyBvcGVyYXRvcldhbGxldCk7CiAgICBldmVudCBPcGVyYXRvclByb2R1Y3RDb21taXNzaW9uQ2hhbmdlZCh1aW50IF92YWx1ZSk7CiAgICBldmVudCBPd25lcnNQcm9kdWN0Q29tbWlzc2lvbkNoYW5nZWQodWludCBfdmFsdWUpOwoKCiAgICBmdW5jdGlvbiBzZXRPcGVyYXRvckNvbW1pc3Npb24odWludCBfdmFsdWUpIHB1YmxpYyBvbmx5T3duZXIgewogICAgICAgIHJlcXVpcmUoX3ZhbHVlID49IDApOwogICAgICAgIG9wZXJhdG9yUHJvZHVjdENvbW1pc3Npb25JblBlcmMgPSBfdmFsdWU7CiAgICAgICAgT3BlcmF0b3JQcm9kdWN0Q29tbWlzc2lvbkNoYW5nZWQoX3ZhbHVlKTsKICAgIH0KCiAgICBmdW5jdGlvbiBzZXRPd25lcnNDb21taXNzaW9uKHVpbnQgX3ZhbHVlKSBwdWJsaWMgb25seU93bmVyIHsKICAgICAgICByZXF1aXJlKF92YWx1ZSA+PSAwKTsKICAgICAgICBvd25lcnNQcm9kdWN0Q29tbWlzc2lvbkluUGVyYyA9IF92YWx1ZTsKICAgICAgICBPd25lcnNQcm9kdWN0Q29tbWlzc2lvbkNoYW5nZWQoX3ZhbHVlKTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBNZXRob2QgY2FsbGVkIHdoZW4gbmV3IHNlbGxlciBqb2luZWQgdGhlIHByb2dyYW0KICAgICAqIFRvIGF2b2lkIHZhbHVlIGxvc3QgYWZ0ZXIgZGl2aXNpb24sIGFtb3VudE9mVG9rZW5zIG11c3QgYmUgbXVsdGlwbGUgb2YgMTAwCiAgICAgKi8KICAgIGZ1bmN0aW9uIGluZGVwZW5kZW50U2VsbGVySm9pbmVkKGFkZHJlc3Mgc2VsbGVyV2FsbGV0LCB1aW50IGFtb3VudE9mVG9rZW5zLCBhZGRyZXNzIG9wZXJhdG9yV2FsbGV0KSBwdWJsaWMgb25seU93bmVyIGNhbk1pbnQgewogICAgICAgIHJlcXVpcmUoYW1vdW50T2ZUb2tlbnMgPiAxMDApOwogICAgICAgIHJlcXVpcmUoc2VsbGVyV2FsbGV0ICE9IGFkZHJlc3MoMCkpOwogICAgICAgIHJlcXVpcmUob3BlcmF0b3JXYWxsZXQgIT0gYWRkcmVzcygwKSk7CgogICAgICAgIHVpbnQgb3BlcmF0b3JDb21taXNzaW9uID0gYW1vdW50T2ZUb2tlbnMuZGl2aWRlcygxMDApLnRpbWVzKG9wZXJhdG9yUHJvZHVjdENvbW1pc3Npb25JblBlcmMpOwogICAgICAgIHVpbnQgc2VsbGVyQW1vdW50ID0gYW1vdW50T2ZUb2tlbnMubWludXMob3BlcmF0b3JDb21taXNzaW9uKTsKCiAgICAgICAgaWYgKG9wZXJhdG9yQ29tbWlzc2lvbiA+IDApIHsKICAgICAgICAgICAgbWludChvcGVyYXRvcldhbGxldCwgb3BlcmF0b3JDb21taXNzaW9uKTsKICAgICAgICB9CgogICAgICAgIGlmIChzZWxsZXJBbW91bnQgPiAwKSB7CiAgICAgICAgICAgIG1pbnQoc2VsbGVyV2FsbGV0LCBzZWxsZXJBbW91bnQpOwogICAgICAgIH0KICAgICAgICBJbmRlcGVuZGVudFNlbGxlckpvaW5lZChzZWxsZXJXYWxsZXQsIGFtb3VudE9mVG9rZW5zLCBvcGVyYXRvcldhbGxldCk7CiAgICB9CgoKICAgIC8qKgogICAgKiBNZXRob2QgY2FsbGVkIHdoZW4gb3duZXJzIGFkZCB0aGVpciBvd24gcHJvZHVjdAogICAgKiBUbyBhdm9pZCB2YWx1ZSBsb3N0IGFmdGVyIGRpdmlzaW9uLCBhbW91bnRPZlRva2VucyBtdXN0IGJlIG11bHRpcGxlIG9mIDEwMAogICAgKi8KICAgIGZ1bmN0aW9uIG93bmVyc1Byb2R1Y3RBZGRlZChhZGRyZXNzIG93bmVyc1dhbGxldCwgdWludCBhbW91bnRPZlRva2VucywgYWRkcmVzcyBvcGVyYXRvcldhbGxldCkgcHVibGljIG9ubHlPd25lciBjYW5NaW50IHsKICAgICAgICByZXF1aXJlKGFtb3VudE9mVG9rZW5zID4gMTAwKTsKICAgICAgICByZXF1aXJlKG93bmVyc1dhbGxldCAhPSBhZGRyZXNzKDApKTsKICAgICAgICByZXF1aXJlKG9wZXJhdG9yV2FsbGV0ICE9IGFkZHJlc3MoMCkpOwoKICAgICAgICB1aW50IG93bmVyc0NvbWlzc2lvbiA9IGFtb3VudE9mVG9rZW5zLmRpdmlkZXMoMTAwKS50aW1lcyhvd25lcnNQcm9kdWN0Q29tbWlzc2lvbkluUGVyYyk7CiAgICAgICAgdWludCBvcGVyYXRvckFtb3VudCA9IGFtb3VudE9mVG9rZW5zLm1pbnVzKG93bmVyc0NvbWlzc2lvbik7CgoKICAgICAgICBpZiAob3duZXJzQ29taXNzaW9uID4gMCkgewogICAgICAgICAgICBtaW50KG93bmVyc1dhbGxldCwgb3duZXJzQ29taXNzaW9uKTsKICAgICAgICB9CgogICAgICAgIGlmIChvcGVyYXRvckFtb3VudCA+IDApIHsKICAgICAgICAgICAgbWludChvcGVyYXRvcldhbGxldCwgb3BlcmF0b3JBbW91bnQpOwogICAgICAgIH0KCiAgICAgICAgT3duZXJzUHJvZHVjdEFkZGVkKG93bmVyc1dhbGxldCwgYW1vdW50T2ZUb2tlbnMsIG9wZXJhdG9yV2FsbGV0KTsKICAgIH0KCiAgICBmdW5jdGlvbiBNanRUb2tlbihzdHJpbmcgX25hbWUsIHN0cmluZyBfc3ltYm9sLCB1aW50IF9pbml0aWFsU3VwcGx5LCB1aW50IF9kZWNpbWFscywgYm9vbCBfbWludGFibGUsIHVpbnQgX2dsb2JhbE1pbkNhcCkKICAgIENyb3dkc2FsZVRva2VuRXh0KF9uYW1lLCBfc3ltYm9sLCBfaW5pdGlhbFN1cHBseSwgX2RlY2ltYWxzLCBfbWludGFibGUsIF9nbG9iYWxNaW5DYXApIHt9Cgp9CgoKCgovKioKICogRmluYWxpemUgYWdlbnQgZGVmaW5lcyB3aGF0IGhhcHBlbnMgYXQgdGhlIGVuZCBvZiBzdWNjZXNlZnVsIGNyb3dkc2FsZS4KICoKICogLSBBbGxvY2F0ZSB0b2tlbnMgZm9yIGZvdW5kZXJzLCBib3VudGllcyBhbmQgY29tbXVuaXR5CiAqIC0gTWFrZSB0b2tlbnMgdHJhbnNmZXJhYmxlCiAqIC0gZXRjLgogKi8KY29udHJhY3QgRmluYWxpemVBZ2VudCB7CgogICAgZnVuY3Rpb24gaXNGaW5hbGl6ZUFnZW50KCkgcHVibGljIGNvbnN0YW50IHJldHVybnMoYm9vbCkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIC8qKiBSZXR1cm4gdHJ1ZSBpZiB3ZSBjYW4gcnVuIGZpbmFsaXplQ3Jvd2RzYWxlKCkgcHJvcGVybHkuCiAgICAgKgogICAgICogVGhpcyBpcyBhIHNhZmV0eSBjaGVjayBmdW5jdGlvbiB0aGF0IGRvZXNuJ3QgYWxsb3cgY3Jvd2RzYWxlIHRvIGJlZ2luCiAgICAgKiB1bmxlc3MgdGhlIGZpbmFsaXplciBoYXMgYmVlbiBzZXQgdXAgcHJvcGVybHkuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzU2FuZSgpIHB1YmxpYyBjb25zdGFudCByZXR1cm5zIChib29sKTsKCiAgICAvKiogQ2FsbGVkIG9uY2UgYnkgY3Jvd2RzYWxlIGZpbmFsaXplKCkgaWYgdGhlIHNhbGUgd2FzIHN1Y2Nlc3MuICovCiAgICBmdW5jdGlvbiBmaW5hbGl6ZUNyb3dkc2FsZSgpOwoKfQoKLyoqCiAqIFRoaXMgc21hcnQgY29udHJhY3QgY29kZSBpcyBDb3B5cmlnaHQgMjAxNyBUb2tlbk1hcmtldCBMdGQuIEZvciBtb3JlIGluZm9ybWF0aW9uIHNlZSBodHRwczovL3Rva2VubWFya2V0Lm5ldAogKgogKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIHZlcnNpb24gMi4wOiBodHRwczovL2dpdGh1Yi5jb20vVG9rZW5NYXJrZXROZXQvaWNvL2Jsb2IvbWFzdGVyL0xJQ0VOU0UudHh0CiAqLwoKCi8qKgogKiBJbnRlcmZhY2UgZm9yIGRlZmluaW5nIGNyb3dkc2FsZSBwcmljaW5nLgogKi8KY29udHJhY3QgUHJpY2luZ1N0cmF0ZWd5IHsKCiAgICAvKiogSW50ZXJmYWNlIGRlY2xhcmF0aW9uLiAqLwogICAgZnVuY3Rpb24gaXNQcmljaW5nU3RyYXRlZ3koKSBwdWJsaWMgY29uc3RhbnQgcmV0dXJucyAoYm9vbCkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIC8qKiBTZWxmIGNoZWNrIGlmIGFsbCByZWZlcmVuY2VzIGFyZSBjb3JyZWN0bHkgc2V0LgogICAgICoKICAgICAqIENoZWNrcyB0aGF0IHByaWNpbmcgc3RyYXRlZ3kgbWF0Y2hlcyBjcm93ZHNhbGUgcGFyYW1ldGVycy4KICAgICAqLwogICAgZnVuY3Rpb24gaXNTYW5lKGFkZHJlc3MgY3Jvd2RzYWxlKSBwdWJsaWMgY29uc3RhbnQgcmV0dXJucyAoYm9vbCkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIC8qKgogICAgICogQGRldiBQcmljaW5nIHRlbGxzIGlmIHRoaXMgaXMgYSBwcmVzYWxlIHB1cmNoYXNlIG9yIG5vdC4KICAgICAgIEBwYXJhbSBwdXJjaGFzZXIgQWRkcmVzcyBvZiB0aGUgcHVyY2hhc2VyCiAgICAgICBAcmV0dXJuIEZhbHNlIGJ5IGRlZmF1bHQsIHRydWUgaWYgYSBwcmVzYWxlIHB1cmNoYXNlcgogICAgICovCiAgICBmdW5jdGlvbiBpc1ByZXNhbGVQdXJjaGFzZShhZGRyZXNzIHB1cmNoYXNlcikgcHVibGljIGNvbnN0YW50IHJldHVybnMgKGJvb2wpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgLyoqCiAgICAgKiBXaGVuIHNvbWVib2R5IHRyaWVzIHRvIGJ1eSB0b2tlbnMgZm9yIFggZXRoLCBjYWxjdWxhdGUgaG93IG1hbnkgdG9rZW5zIHRoZXkgZ2V0LgogICAgICoKICAgICAqCiAgICAgKiBAcGFyYW0gdmFsdWUgLSBXaGF0IGlzIHRoZSB2YWx1ZSBvZiB0aGUgdHJhbnNhY3Rpb24gc2VuZCBpbiBhcyB3ZWkKICAgICAqIEBwYXJhbSB0b2tlbnNTb2xkIC0gaG93IG11Y2ggdG9rZW5zIGhhdmUgYmVlbiBzb2xkIHRoaXMgZmFyCiAgICAgKiBAcGFyYW0gd2VpUmFpc2VkIC0gaG93IG11Y2ggbW9uZXkgaGFzIGJlZW4gcmFpc2VkIHRoaXMgZmFyIGluIHRoZSBtYWluIHRva2VuIHNhbGUgLSB0aGlzIG51bWJlciBleGNsdWRlcyBwcmVzYWxlCiAgICAgKiBAcGFyYW0gbXNnU2VuZGVyIC0gd2hvIGlzIHRoZSBpbnZlc3RvciBvZiB0aGlzIHRyYW5zYWN0aW9uCiAgICAgKiBAcGFyYW0gZGVjaW1hbHMgLSBob3cgbWFueSBkZWNpbWFsIHVuaXRzIHRoZSB0b2tlbiBoYXMKICAgICAqIEByZXR1cm4gQW1vdW50IG9mIHRva2VucyB0aGUgaW52ZXN0b3IgcmVjZWl2ZXMKICAgICAqLwogICAgZnVuY3Rpb24gY2FsY3VsYXRlUHJpY2UodWludCB2YWx1ZSwgdWludCB3ZWlSYWlzZWQsIHVpbnQgdG9rZW5zU29sZCwgYWRkcmVzcyBtc2dTZW5kZXIsIHVpbnQgZGVjaW1hbHMpIHB1YmxpYyBjb25zdGFudCByZXR1cm5zICh1aW50IHRva2VuQW1vdW50KTsKfQoKCgovLy8gQGRldiBUaW1lIG1pbGVzdG9uZSBiYXNlZCBwcmljaW5nIHdpdGggc3BlY2lhbCBzdXBwb3J0IGZvciBwcmUtaWNvIGRlYWxzLgpjb250cmFjdCBNaWxlc3RvbmVQcmljaW5nIGlzIFByaWNpbmdTdHJhdGVneSwgT3duYWJsZSB7CgogICAgdXNpbmcgU01hdGhMaWIgZm9yIHVpbnQ7CgogICAgdWludCBwdWJsaWMgY29uc3RhbnQgTUFYX01JTEVTVE9ORSA9IDEwOwoKICAgIC8vIFRoaXMgY29udGFpbnMgYWxsIHByZS1JQ08gYWRkcmVzc2VzLCBhbmQgdGhlaXIgcHJpY2VzICh3ZWlzIHBlciB0b2tlbikKICAgIG1hcHBpbmcgKGFkZHJlc3MgPT4gdWludCkgcHVibGljIHByZWljb0FkZHJlc3NlczsKCiAgICAvKioKICAgICogRGVmaW5lIHByaWNpbmcgc2NoZWR1bGUgdXNpbmcgbWlsZXN0b25lcy4KICAgICovCiAgICBzdHJ1Y3QgTWlsZXN0b25lIHsKCiAgICAgICAgLy8gVU5JWCB0aW1lc3RhbXAgd2hlbiB0aGlzIG1pbGVzdG9uZSBraWNrcyBpbgogICAgICAgIHVpbnQgdGltZTsKCiAgICAgICAgLy8gSG93IG1hbnkgdG9rZW5zIHBlciBzYXRvc2hpIHlvdSB3aWxsIGdldCBhZnRlciB0aGlzIG1pbGVzdG9uZSBoYXMgYmVlbiBwYXNzZWQKICAgICAgICB1aW50IHByaWNlOwogICAgfQoKICAgIC8vIFN0b3JlIG1pbGVzdG9uZXMgaW4gYSBmaXhlZCBhcnJheSwgc28gdGhhdCBpdCBjYW4gYmUgc2VlbiBpbiBhIGJsb2NrY2hhaW4gZXhwbG9yZXIKICAgIC8vIE1pbGVzdG9uZSAwIGlzIGFsd2F5cyAoMCwgMCkKICAgIC8vIChUT0RPOiBjaGFuZ2UgdGhpcyB3aGVuIHdlIGNvbmZpcm0gZHluYW1pYyBhcnJheXMgYXJlIGV4cGxvcmFibGUpCiAgICBNaWxlc3RvbmVbMTBdIHB1YmxpYyBtaWxlc3RvbmVzOwoKICAgIC8vIEhvdyBtYW55IGFjdGl2ZSBtaWxlc3RvbmVzIHdlIGhhdmUKICAgIHVpbnQgcHVibGljIG1pbGVzdG9uZUNvdW50OwoKICAgIC8vLyBAZGV2IENvbnRydWN0aW9uLCBjcmVhdGluZyBhIGxpc3Qgb2YgbWlsZXN0b25lcwogICAgLy8vIEBwYXJhbSBfbWlsZXN0b25lcyB1aW50W10gbWlsZXN0b25lcyBQYWlycyBvZiAodGltZSwgcHJpY2UpCiAgICBmdW5jdGlvbiBNaWxlc3RvbmVQcmljaW5nKHVpbnRbXSBfbWlsZXN0b25lcykgewogICAgICAgIC8vIE5lZWQgdG8gaGF2ZSB0dXBsZXMsIGxlbmd0aCBjaGVjawogICAgICAgIGlmKF9taWxlc3RvbmVzLmxlbmd0aCAlIDIgPT0gMSB8fCBfbWlsZXN0b25lcy5sZW5ndGggPj0gTUFYX01JTEVTVE9ORSoyKSB7CiAgICAgICAgICAgIHRocm93OwogICAgICAgIH0KCiAgICAgICAgbWlsZXN0b25lQ291bnQgPSBfbWlsZXN0b25lcy5sZW5ndGggLyAyOwoKICAgICAgICB1aW50IGxhc3RUaW1lc3RhbXAgPSAwOwoKICAgICAgICBmb3IodWludCBpPTA7IGk8X21pbGVzdG9uZXMubGVuZ3RoLzI7IGkrKykgewogICAgICAgICAgICBtaWxlc3RvbmVzW2ldLnRpbWUgPSBfbWlsZXN0b25lc1tpKjJdOwogICAgICAgICAgICBtaWxlc3RvbmVzW2ldLnByaWNlID0gX21pbGVzdG9uZXNbaSoyKzFdOwoKICAgICAgICAgICAgLy8gTm8gaW52YWxpZCBzdGVwcwogICAgICAgICAgICBpZigobGFzdFRpbWVzdGFtcCAhPSAwKSAmJiAobWlsZXN0b25lc1tpXS50aW1lIDw9IGxhc3RUaW1lc3RhbXApKSB7CiAgICAgICAgICAgICAgICB0aHJvdzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgbGFzdFRpbWVzdGFtcCA9IG1pbGVzdG9uZXNbaV0udGltZTsKICAgICAgICB9CgogICAgICAgIC8vIExhc3QgbWlsZXN0b25lIHByaWNlIG11c3QgYmUgemVybywgdGVybWluYXRpbmcgdGhlIGNyb3dkYWxlCiAgICAgICAgaWYobWlsZXN0b25lc1ttaWxlc3RvbmVDb3VudC0xXS5wcmljZSAhPSAwKSB7CiAgICAgICAgICAgIHRocm93OwogICAgICAgIH0KICAgIH0KCiAgICAvLy8gQGRldiBUaGlzIGlzIGludm9rZWQgb25jZSBmb3IgZXZlcnkgcHJlLUlDTyBhZGRyZXNzLCBzZXQgcHJpY2VQZXJUb2tlbgogICAgLy8vICAgICAgdG8gMCB0byBkaXNhYmxlCiAgICAvLy8gQHBhcmFtIHByZWljb0FkZHJlc3MgUHJlc2FsZUZ1bmRDb2xsZWN0b3IgYWRkcmVzcwogICAgLy8vIEBwYXJhbSBwcmljZVBlclRva2VuIEhvdyBtYW55IHdlaXMgb25lIHRva2VuIGNvc3QgZm9yIHByZS1pY28gaW52ZXN0b3JzCiAgICBmdW5jdGlvbiBzZXRQcmVpY29BZGRyZXNzKGFkZHJlc3MgcHJlaWNvQWRkcmVzcywgdWludCBwcmljZVBlclRva2VuKQogICAgcHVibGljCiAgICBvbmx5T3duZXIKICAgIHsKICAgICAgICBwcmVpY29BZGRyZXNzZXNbcHJlaWNvQWRkcmVzc10gPSBwcmljZVBlclRva2VuOwogICAgfQoKICAgIC8vLyBAZGV2IEl0ZXJhdGUgdGhyb3VnaCBtaWxlc3RvbmVzLiBZb3UgcmVhY2ggZW5kIG9mIG1pbGVzdG9uZXMgd2hlbiBwcmljZSA9IDAKICAgIC8vLyBAcmV0dXJuIHR1cGxlICh0aW1lLCBwcmljZSkKICAgIGZ1bmN0aW9uIGdldE1pbGVzdG9uZSh1aW50IG4pIHB1YmxpYyBjb25zdGFudCByZXR1cm5zICh1aW50LCB1aW50KSB7CiAgICAgICAgcmV0dXJuIChtaWxlc3RvbmVzW25dLnRpbWUsIG1pbGVzdG9uZXNbbl0ucHJpY2UpOwogICAgfQoKICAgIGZ1bmN0aW9uIGdldEZpcnN0TWlsZXN0b25lKCkgcHJpdmF0ZSBjb25zdGFudCByZXR1cm5zIChNaWxlc3RvbmUpIHsKICAgICAgICByZXR1cm4gbWlsZXN0b25lc1swXTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRMYXN0TWlsZXN0b25lKCkgcHJpdmF0ZSBjb25zdGFudCByZXR1cm5zIChNaWxlc3RvbmUpIHsKICAgICAgICByZXR1cm4gbWlsZXN0b25lc1ttaWxlc3RvbmVDb3VudC0xXTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRQcmljaW5nU3RhcnRzQXQoKSBwdWJsaWMgY29uc3RhbnQgcmV0dXJucyAodWludCkgewogICAgICAgIHJldHVybiBnZXRGaXJzdE1pbGVzdG9uZSgpLnRpbWU7CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0UHJpY2luZ0VuZHNBdCgpIHB1YmxpYyBjb25zdGFudCByZXR1cm5zICh1aW50KSB7CiAgICAgICAgcmV0dXJuIGdldExhc3RNaWxlc3RvbmUoKS50aW1lOwogICAgfQoKICAgIGZ1bmN0aW9uIGlzU2FuZShhZGRyZXNzIF9jcm93ZHNhbGUpIHB1YmxpYyBjb25zdGFudCByZXR1cm5zKGJvb2wpIHsKICAgICAgICBDcm93ZHNhbGVFeHQgY3Jvd2RzYWxlID0gQ3Jvd2RzYWxlRXh0KF9jcm93ZHNhbGUpOwogICAgICAgIHJldHVybiBjcm93ZHNhbGUuc3RhcnRzQXQoKSA9PSBnZXRQcmljaW5nU3RhcnRzQXQoKSAmJiBjcm93ZHNhbGUuZW5kc0F0KCkgPT0gZ2V0UHJpY2luZ0VuZHNBdCgpOwogICAgfQoKICAgIC8vLyBAZGV2IEdldCB0aGUgY3VycmVudCBtaWxlc3RvbmUgb3IgYmFpbCBvdXQgaWYgd2UgYXJlIG5vdCBpbiB0aGUgbWlsZXN0b25lIHBlcmlvZHMuCiAgICAvLy8gQHJldHVybiB7W3R5cGVdfSBbZGVzY3JpcHRpb25dCiAgICBmdW5jdGlvbiBnZXRDdXJyZW50TWlsZXN0b25lKCkgcHJpdmF0ZSBjb25zdGFudCByZXR1cm5zIChNaWxlc3RvbmUpIHsKICAgICAgICB1aW50IGk7CgogICAgICAgIGZvcihpPTA7IGk8bWlsZXN0b25lcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBpZihub3cgPCBtaWxlc3RvbmVzW2ldLnRpbWUpIHsKICAgICAgICAgICAgICAgIHJldHVybiBtaWxlc3RvbmVzW2ktMV07CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgLy8vIEBkZXYgR2V0IHRoZSBjdXJyZW50IHByaWNlLgogICAgLy8vIEByZXR1cm4gVGhlIGN1cnJlbnQgcHJpY2Ugb3IgMCBpZiB3ZSBhcmUgb3V0c2lkZSBtaWxlc3RvbmUgcGVyaW9kCiAgICBmdW5jdGlvbiBnZXRDdXJyZW50UHJpY2UoKSBwdWJsaWMgY29uc3RhbnQgcmV0dXJucyAodWludCByZXN1bHQpIHsKICAgICAgICByZXR1cm4gZ2V0Q3VycmVudE1pbGVzdG9uZSgpLnByaWNlOwogICAgfQoKICAgIC8vLyBAZGV2IENhbGN1bGF0ZSB0aGUgY3VycmVudCBwcmljZSBmb3IgYnV5IGluIGFtb3VudC4KICAgIGZ1bmN0aW9uIGNhbGN1bGF0ZVByaWNlKHVpbnQgdmFsdWUsIHVpbnQgd2VpUmFpc2VkLCB1aW50IHRva2Vuc1NvbGQsIGFkZHJlc3MgbXNnU2VuZGVyLCB1aW50IGRlY2ltYWxzKSBwdWJsaWMgY29uc3RhbnQgcmV0dXJucyAodWludCkgewoKICAgICAgICB1aW50IG11bHRpcGxpZXIgPSAxMCAqKiBkZWNpbWFsczsKCiAgICAgICAgLy8gVGhpcyBpbnZlc3RvciBpcyBjb21pbmcgdGhyb3VnaCBwcmUtaWNvCiAgICAgICAgaWYocHJlaWNvQWRkcmVzc2VzW21zZ1NlbmRlcl0gPiAwKSB7CiAgICAgICAgICAgIHJldHVybiB2YWx1ZS50aW1lcyhtdWx0aXBsaWVyKSAvIHByZWljb0FkZHJlc3Nlc1ttc2dTZW5kZXJdOwogICAgICAgIH0KCiAgICAgICAgdWludCBwcmljZSA9IGdldEN1cnJlbnRQcmljZSgpOwogICAgICAgIHJldHVybiB2YWx1ZS50aW1lcyhtdWx0aXBsaWVyKSAvIHByaWNlOwogICAgfQoKICAgIGZ1bmN0aW9uIGlzUHJlc2FsZVB1cmNoYXNlKGFkZHJlc3MgcHVyY2hhc2VyKSBwdWJsaWMgY29uc3RhbnQgcmV0dXJucyAoYm9vbCkgewogICAgICAgIGlmKHByZWljb0FkZHJlc3Nlc1twdXJjaGFzZXJdID4gMCkKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgZWxzZQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgZnVuY3Rpb24oKSBwYXlhYmxlIHsKICAgICAgICB0aHJvdzsgLy8gTm8gbW9uZXkgb24gdGhpcyBjb250cmFjdAogICAgfQoKfQoKCgovKioKICogQSB0b2tlbiB0aGF0IGRlZmluZXMgZnJhY3Rpb25hbCB1bml0cyBhcyBkZWNpbWFscy4KICovCmNvbnRyYWN0IEZyYWN0aW9uYWxFUkMyMEV4dCBpcyBFUkMyMCB7CgogICAgdWludCBwdWJsaWMgZGVjaW1hbHM7CiAgICB1aW50IHB1YmxpYyBtaW5DYXA7Cgp9CgoKCi8qKgogKiBBYnN0cmFjdCBiYXNlIGNvbnRyYWN0IGZvciB0b2tlbiBzYWxlcy4KICoKICogSGFuZGxlCiAqIC0gc3RhcnQgYW5kIGVuZCBkYXRlcwogKiAtIGFjY2VwdGluZyBpbnZlc3RtZW50cwogKiAtIG1pbmltdW0gZnVuZGluZyBnb2FsIGFuZCByZWZ1bmQKICogLSB2YXJpb3VzIHN0YXRpc3RpY3MgZHVyaW5nIHRoZSBjcm93ZGZ1bmQKICogLSBkaWZmZXJlbnQgcHJpY2luZyBzdHJhdGVnaWVzCiAqIC0gZGlmZmVyZW50IGludmVzdG1lbnQgcG9saWNpZXMgKHJlcXVpcmUgc2VydmVyIHNpZGUgY3VzdG9tZXIgaWQsIGFsbG93IG9ubHkgd2hpdGVsaXN0ZWQgYWRkcmVzc2VzKQogKgogKi8KY29udHJhY3QgQ3Jvd2RzYWxlRXh0IGlzIEhhbHRhYmxlIHsKCiAgICAvKiBNYXggaW52ZXN0bWVudCBjb3VudCB3aGVuIHdlIGFyZSBzdGlsbCBhbGxvd2VkIHRvIGNoYW5nZSB0aGUgbXVsdGlzaWcgYWRkcmVzcyAqLwogICAgdWludCBwdWJsaWMgTUFYX0lOVkVTVE1FTlRTX0JFRk9SRV9NVUxUSVNJR19DSEFOR0UgPSA1OwoKICAgIHVzaW5nIFNNYXRoTGliIGZvciB1aW50OwoKICAgIC8qIFRoZSB0b2tlbiB3ZSBhcmUgc2VsbGluZyAqLwogICAgRnJhY3Rpb25hbEVSQzIwRXh0IHB1YmxpYyB0b2tlbjsKCiAgICAvKiBIb3cgd2UgYXJlIGdvaW5nIHRvIHByaWNlIG91ciBvZmZlcmluZyAqLwogICAgTWlsZXN0b25lUHJpY2luZyBwdWJsaWMgcHJpY2luZ1N0cmF0ZWd5OwoKICAgIC8qIFBvc3Qtc3VjY2VzcyBjYWxsYmFjayAqLwogICAgRmluYWxpemVBZ2VudCBwdWJsaWMgZmluYWxpemVBZ2VudDsKCiAgICAvKiB0b2tlbnMgd2lsbCBiZSB0cmFuc2ZlcmVkIGZyb20gdGhpcyBhZGRyZXNzICovCiAgICBhZGRyZXNzIHB1YmxpYyBtdWx0aXNpZ1dhbGxldDsKCiAgICAvKiBpZiB0aGUgZnVuZGluZyBnb2FsIGlzIG5vdCByZWFjaGVkLCBpbnZlc3RvcnMgbWF5IHdpdGhkcmF3IHRoZWlyIGZ1bmRzICovCiAgICB1aW50IHB1YmxpYyBtaW5pbXVtRnVuZGluZ0dvYWw7CgogICAgLyogdGhlIFVOSVggdGltZXN0YW1wIHN0YXJ0IGRhdGUgb2YgdGhlIGNyb3dkc2FsZSAqLwogICAgdWludCBwdWJsaWMgc3RhcnRzQXQ7CgogICAgLyogdGhlIFVOSVggdGltZXN0YW1wIGVuZCBkYXRlIG9mIHRoZSBjcm93ZHNhbGUgKi8KICAgIHVpbnQgcHVibGljIGVuZHNBdDsKCiAgICAvKiB0aGUgbnVtYmVyIG9mIHRva2VucyBhbHJlYWR5IHNvbGQgdGhyb3VnaCB0aGlzIGNvbnRyYWN0Ki8KICAgIHVpbnQgcHVibGljIHRva2Vuc1NvbGQgPSAwOwoKICAgIC8qIEhvdyBtYW55IHdlaSBvZiBmdW5kaW5nIHdlIGhhdmUgcmFpc2VkICovCiAgICB1aW50IHB1YmxpYyB3ZWlSYWlzZWQgPSAwOwoKICAgIC8qIENhbGN1bGF0ZSBpbmNvbWluZyBmdW5kcyBmcm9tIHByZXNhbGUgY29udHJhY3RzIGFuZCBhZGRyZXNzZXMgKi8KICAgIHVpbnQgcHVibGljIHByZXNhbGVXZWlSYWlzZWQgPSAwOwoKICAgIC8qIEhvdyBtYW55IGRpc3RpbmN0IGFkZHJlc3NlcyBoYXZlIGludmVzdGVkICovCiAgICB1aW50IHB1YmxpYyBpbnZlc3RvckNvdW50ID0gMDsKCiAgICAvKiBIb3cgbXVjaCB3ZWkgd2UgaGF2ZSByZXR1cm5lZCBiYWNrIHRvIHRoZSBjb250cmFjdCBhZnRlciBhIGZhaWxlZCBjcm93ZGZ1bmQuICovCiAgICB1aW50IHB1YmxpYyBsb2FkZWRSZWZ1bmQgPSAwOwoKICAgIC8qIEhvdyBtdWNoIHdlaSB3ZSBoYXZlIGdpdmVuIGJhY2sgdG8gaW52ZXN0b3JzLiovCiAgICB1aW50IHB1YmxpYyB3ZWlSZWZ1bmRlZCA9IDA7CgogICAgLyogSGFzIHRoaXMgY3Jvd2RzYWxlIGJlZW4gZmluYWxpemVkICovCiAgICBib29sIHB1YmxpYyBmaW5hbGl6ZWQ7CgogICAgLyogRG8gd2UgbmVlZCB0byBoYXZlIHVuaXF1ZSBjb250cmlidXRvciBpZCBmb3IgZWFjaCBjdXN0b21lciAqLwogICAgYm9vbCBwdWJsaWMgcmVxdWlyZUN1c3RvbWVySWQ7CgogICAgYm9vbCBwdWJsaWMgaXNXaGl0ZUxpc3RlZDsKCiAgICBhZGRyZXNzW10gcHVibGljIGpvaW5lZENyb3dkc2FsZXM7CiAgICB1aW50IHB1YmxpYyBqb2luZWRDcm93ZHNhbGVzTGVuID0gMDsKCiAgICBhZGRyZXNzIHB1YmxpYyBsYXN0Q3Jvd2RzYWxlOwoKICAgIC8qKgogICAgICAqIERvIHdlIHZlcmlmeSB0aGF0IGNvbnRyaWJ1dG9yIGhhcyBiZWVuIGNsZWFyZWQgb24gdGhlIHNlcnZlciBzaWRlIChhY2NyZWRpdGVkIGludmVzdG9ycyBvbmx5KS4KICAgICAgKiBUaGlzIG1ldGhvZCB3YXMgZmlyc3QgdXNlZCBpbiBGaXJzdEJsb29kIGNyb3dkc2FsZSB0byBlbnN1cmUgYWxsIGNvbnRyaWJ1dG9ycyBoYXZlIGFjY2VwdGVkIHRlcm1zIG9uIHNhbGUgKG9uIHRoZSB3ZWIpLgogICAgICAqLwogICAgYm9vbCBwdWJsaWMgcmVxdWlyZWRTaWduZWRBZGRyZXNzOwoKICAgIC8qIFNlcnZlciBzaWRlIGFkZHJlc3MgdGhhdCBzaWduZWQgYWxsb3dlZCBjb250cmlidXRvcnMgKEV0aGVyZXVtIGFkZHJlc3NlcykgdGhhdCBjYW4gcGFydGljaXBhdGUgdGhlIGNyb3dkc2FsZSAqLwogICAgYWRkcmVzcyBwdWJsaWMgc2lnbmVyQWRkcmVzczsKCiAgICAvKiogSG93IG11Y2ggRVRIIGVhY2ggYWRkcmVzcyBoYXMgaW52ZXN0ZWQgdG8gdGhpcyBjcm93ZHNhbGUgKi8KICAgIG1hcHBpbmcgKGFkZHJlc3MgPT4gdWludDI1NikgcHVibGljIGludmVzdGVkQW1vdW50T2Y7CgogICAgLyoqIEhvdyBtdWNoIHRva2VucyB0aGlzIGNyb3dkc2FsZSBoYXMgY3JlZGl0ZWQgZm9yIGVhY2ggaW52ZXN0b3IgYWRkcmVzcyAqLwogICAgbWFwcGluZyAoYWRkcmVzcyA9PiB1aW50MjU2KSBwdWJsaWMgdG9rZW5BbW91bnRPZjsKCiAgICBzdHJ1Y3QgV2hpdGVMaXN0RGF0YSB7CiAgICAgICAgYm9vbCBzdGF0dXM7CiAgICAgICAgdWludCBtaW5DYXA7CiAgICAgICAgdWludCBtYXhDYXA7CiAgICB9CgogICAgLy9pcyBjcm93ZHNhbGUgdXBkYXRhYmxlCiAgICBib29sIHB1YmxpYyBpc1VwZGF0YWJsZTsKCiAgICAvKiogQWRkcmVzc2VzIHRoYXQgYXJlIGFsbG93ZWQgdG8gaW52ZXN0IGV2ZW4gYmVmb3JlIElDTyBvZmZpY2FsIG9wZW5zLiBGb3IgdGVzdGluZywgZm9yIElDTyBwYXJ0bmVycywgZXRjLiAqLwogICAgbWFwcGluZyAoYWRkcmVzcyA9PiBXaGl0ZUxpc3REYXRhKSBwdWJsaWMgZWFybHlQYXJ0aWNpcGFudFdoaXRlbGlzdDsKCiAgICAvKiogVGhpcyBpcyBmb3IgbWFudWwgdGVzdGluZyBmb3IgdGhlIGludGVyYWN0aW9uIGZyb20gb3duZXIgd2FsbGV0LiBZb3UgY2FuIHNldCBpdCB0byBhbnkgdmFsdWUgYW5kIGluc3BlY3QgdGhpcyBpbiBibG9ja2NoYWluIGV4cGxvcmVyIHRvIHNlZSB0aGF0IGNyb3dkc2FsZSBpbnRlcmFjdGlvbiB3b3Jrcy4gKi8KICAgIHVpbnQgcHVibGljIG93bmVyVGVzdFZhbHVlOwoKICAgIC8qKiBTdGF0ZSBtYWNoaW5lCiAgICAgKgogICAgICogLSBQcmVwYXJpbmc6IEFsbCBjb250cmFjdCBpbml0aWFsaXphdGlvbiBjYWxscyBhbmQgdmFyaWFibGVzIGhhdmUgbm90IGJlZW4gc2V0IHlldAogICAgICogLSBQcmVmdW5kaW5nOiBXZSBoYXZlIG5vdCBwYXNzZWQgc3RhcnQgdGltZSB5ZXQKICAgICAqIC0gRnVuZGluZzogQWN0aXZlIGNyb3dkc2FsZQogICAgICogLSBTdWNjZXNzOiBNaW5pbXVtIGZ1bmRpbmcgZ29hbCByZWFjaGVkCiAgICAgKiAtIEZhaWx1cmU6IE1pbmltdW0gZnVuZGluZyBnb2FsIG5vdCByZWFjaGVkIGJlZm9yZSBlbmRpbmcgdGltZQogICAgICogLSBGaW5hbGl6ZWQ6IFRoZSBmaW5hbGl6ZWQgaGFzIGJlZW4gY2FsbGVkIGFuZCBzdWNjZXNmdWxseSBleGVjdXRlZAogICAgICogLSBSZWZ1bmRpbmc6IFJlZnVuZHMgYXJlIGxvYWRlZCBvbiB0aGUgY29udHJhY3QgZm9yIHJlY2xhaW0uCiAgICAgKi8KICAgIGVudW0gU3RhdGV7VW5rbm93biwgUHJlcGFyaW5nLCBQcmVGdW5kaW5nLCBGdW5kaW5nLCBTdWNjZXNzLCBGYWlsdXJlLCBGaW5hbGl6ZWQsIFJlZnVuZGluZ30KCiAgICAvLyBBIG5ldyBpbnZlc3RtZW50IHdhcyBtYWRlCiAgICBldmVudCBJbnZlc3RlZChhZGRyZXNzIGludmVzdG9yLCB1aW50IHdlaUFtb3VudCwgdWludCB0b2tlbkFtb3VudCwgdWludDEyOCBjdXN0b21lcklkKTsKCiAgICAvLyBSZWZ1bmQgd2FzIHByb2Nlc3NlZCBmb3IgYSBjb250cmlidXRvcgogICAgZXZlbnQgUmVmdW5kKGFkZHJlc3MgaW52ZXN0b3IsIHVpbnQgd2VpQW1vdW50KTsKCiAgICAvLyBUaGUgcnVsZXMgd2VyZSBjaGFuZ2VkIHdoYXQga2luZCBvZiBpbnZlc3RtZW50cyB3ZSBhY2NlcHQKICAgIGV2ZW50IEludmVzdG1lbnRQb2xpY3lDaGFuZ2VkKGJvb2wgbmV3UmVxdWlyZUN1c3RvbWVySWQsIGJvb2wgbmV3UmVxdWlyZWRTaWduZWRBZGRyZXNzLCBhZGRyZXNzIG5ld1NpZ25lckFkZHJlc3MpOwoKICAgIC8vIEFkZHJlc3MgZWFybHkgcGFydGljaXBhdGlvbiB3aGl0ZWxpc3Qgc3RhdHVzIGNoYW5nZWQKICAgIGV2ZW50IFdoaXRlbGlzdGVkKGFkZHJlc3MgYWRkciwgYm9vbCBzdGF0dXMpOwoKICAgIC8vIENyb3dkc2FsZSBzdGFydCB0aW1lIGhhcyBiZWVuIGNoYW5nZWQKICAgIGV2ZW50IFN0YXJ0c0F0Q2hhbmdlZCh1aW50IG5ld1N0YXJ0c0F0KTsKCiAgICAvLyBDcm93ZHNhbGUgZW5kIHRpbWUgaGFzIGJlZW4gY2hhbmdlZAogICAgZXZlbnQgRW5kc0F0Q2hhbmdlZCh1aW50IG5ld0VuZHNBdCk7CgogICAgZnVuY3Rpb24gQ3Jvd2RzYWxlRXh0KGFkZHJlc3MgX3Rva2VuLCBNaWxlc3RvbmVQcmljaW5nIF9wcmljaW5nU3RyYXRlZ3ksIGFkZHJlc3MgX211bHRpc2lnV2FsbGV0LCB1aW50IF9zdGFydCwgdWludCBfZW5kLCB1aW50IF9taW5pbXVtRnVuZGluZ0dvYWwsIGJvb2wgX2lzVXBkYXRhYmxlLCBib29sIF9pc1doaXRlTGlzdGVkKSB7CgogICAgICAgIG93bmVyID0gbXNnLnNlbmRlcjsKCiAgICAgICAgdG9rZW4gPSBGcmFjdGlvbmFsRVJDMjBFeHQoX3Rva2VuKTsKCiAgICAgICAgc2V0UHJpY2luZ1N0cmF0ZWd5KF9wcmljaW5nU3RyYXRlZ3kpOwoKICAgICAgICBtdWx0aXNpZ1dhbGxldCA9IF9tdWx0aXNpZ1dhbGxldDsKICAgICAgICBpZihtdWx0aXNpZ1dhbGxldCA9PSAwKSB7CiAgICAgICAgICAgIHRocm93OwogICAgICAgIH0KCiAgICAgICAgaWYoX3N0YXJ0ID09IDApIHsKICAgICAgICAgICAgdGhyb3c7CiAgICAgICAgfQoKICAgICAgICBzdGFydHNBdCA9IF9zdGFydDsKCiAgICAgICAgaWYoX2VuZCA9PSAwKSB7CiAgICAgICAgICAgIHRocm93OwogICAgICAgIH0KCiAgICAgICAgZW5kc0F0ID0gX2VuZDsKCiAgICAgICAgLy8gRG9uJ3QgbWVzcyB0aGUgZGF0ZXMKICAgICAgICBpZihzdGFydHNBdCA+PSBlbmRzQXQpIHsKICAgICAgICAgICAgdGhyb3c7CiAgICAgICAgfQoKICAgICAgICAvLyBNaW5pbXVtIGZ1bmRpbmcgZ29hbCBjYW4gYmUgemVybwogICAgICAgIG1pbmltdW1GdW5kaW5nR29hbCA9IF9taW5pbXVtRnVuZGluZ0dvYWw7CgogICAgICAgIGlzVXBkYXRhYmxlID0gX2lzVXBkYXRhYmxlOwoKICAgICAgICBpc1doaXRlTGlzdGVkID0gX2lzV2hpdGVMaXN0ZWQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBEb24ndCBleHBlY3QgdG8ganVzdCBzZW5kIGluIG1vbmV5IGFuZCBnZXQgdG9rZW5zLgogICAgICovCiAgICBmdW5jdGlvbigpIHBheWFibGUgewogICAgICAgIHRocm93OwogICAgfQoKICAgIC8qKgogICAgICogTWFrZSBhbiBpbnZlc3RtZW50LgogICAgICoKICAgICAqIENyb3dkc2FsZSBtdXN0IGJlIHJ1bm5pbmcgZm9yIG9uZSB0byBpbnZlc3QuCiAgICAgKiBXZSBtdXN0IGhhdmUgbm90IHByZXNzZWQgdGhlIGVtZXJnZW5jeSBicmFrZS4KICAgICAqCiAgICAgKiBAcGFyYW0gcmVjZWl2ZXIgVGhlIEV0aGVyZXVtIGFkZHJlc3Mgd2hvIHJlY2VpdmVzIHRoZSB0b2tlbnMKICAgICAqIEBwYXJhbSBjdXN0b21lcklkIChvcHRpb25hbCkgVVVJRCB2NCB0byB0cmFjayB0aGUgc3VjY2Vzc2Z1bCBwYXltZW50cyBvbiB0aGUgc2VydmVyIHNpZGUKICAgICAqCiAgICAgKi8KICAgIGZ1bmN0aW9uIGludmVzdEludGVybmFsKGFkZHJlc3MgcmVjZWl2ZXIsIHVpbnQxMjggY3VzdG9tZXJJZCkgc3RvcEluRW1lcmdlbmN5IHByaXZhdGUgewoKICAgICAgICAvLyBEZXRlcm1pbmUgaWYgaXQncyBhIGdvb2QgdGltZSB0byBhY2NlcHQgaW52ZXN0bWVudCBmcm9tIHRoaXMgcGFydGljaXBhbnQKICAgICAgICBpZihnZXRTdGF0ZSgpID09IFN0YXRlLlByZUZ1bmRpbmcpIHsKICAgICAgICAgICAgLy8gQXJlIHdlIHdoaXRlbGlzdGVkIGZvciBlYXJseSBkZXBvc2l0CiAgICAgICAgICAgIHRocm93OwogICAgICAgIH0gZWxzZSBpZihnZXRTdGF0ZSgpID09IFN0YXRlLkZ1bmRpbmcpIHsKICAgICAgICAgICAgLy8gUmV0YWlsIHBhcnRpY2lwYW50cyBjYW4gb25seSBjb21lIGluIHdoZW4gdGhlIGNyb3dkc2FsZSBpcyBydW5uaW5nCiAgICAgICAgICAgIC8vIHBhc3MKICAgICAgICAgICAgaWYoaXNXaGl0ZUxpc3RlZCkgewogICAgICAgICAgICAgICAgaWYoIWVhcmx5UGFydGljaXBhbnRXaGl0ZWxpc3RbcmVjZWl2ZXJdLnN0YXR1cykgewogICAgICAgICAgICAgICAgICAgIHRocm93OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gVW53YW50ZWQgc3RhdGUKICAgICAgICAgICAgdGhyb3c7CiAgICAgICAgfQoKICAgICAgICB1aW50IHdlaUFtb3VudCA9IG1zZy52YWx1ZTsKCiAgICAgICAgLy8gQWNjb3VudCBwcmVzYWxlIHNhbGVzIHNlcGFyYXRlbHksIHNvIHRoYXQgdGhleSBkbyBub3QgY291bnQgYWdhaW5zdCBwcmljaW5nIHRyYW5jaGVzCiAgICAgICAgdWludCB0b2tlbkFtb3VudCA9IHByaWNpbmdTdHJhdGVneS5jYWxjdWxhdGVQcmljZSh3ZWlBbW91bnQsIHdlaVJhaXNlZCAtIHByZXNhbGVXZWlSYWlzZWQsIHRva2Vuc1NvbGQsIG1zZy5zZW5kZXIsIHRva2VuLmRlY2ltYWxzKCkpOwoKICAgICAgICBpZih0b2tlbkFtb3VudCA9PSAwKSB7CiAgICAgICAgICAgIC8vIER1c3QgdHJhbnNhY3Rpb24KICAgICAgICAgICAgdGhyb3c7CiAgICAgICAgfQoKICAgICAgICBpZihpc1doaXRlTGlzdGVkKSB7CiAgICAgICAgICAgIGlmKHRva2VuQW1vdW50IDwgZWFybHlQYXJ0aWNpcGFudFdoaXRlbGlzdFtyZWNlaXZlcl0ubWluQ2FwICYmIHRva2VuQW1vdW50T2ZbcmVjZWl2ZXJdID09IDApIHsKICAgICAgICAgICAgICAgIC8vIHRva2VuQW1vdW50IDwgbWluQ2FwIGZvciBpbnZlc3RvcgogICAgICAgICAgICAgICAgdGhyb3c7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYodG9rZW5BbW91bnQgPiBlYXJseVBhcnRpY2lwYW50V2hpdGVsaXN0W3JlY2VpdmVyXS5tYXhDYXApIHsKICAgICAgICAgICAgICAgIC8vIHRva2VuQW1vdW50ID4gbWF4Q2FwIGZvciBpbnZlc3RvcgogICAgICAgICAgICAgICAgdGhyb3c7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIENoZWNrIHRoYXQgd2UgZGlkIG5vdCBidXN0IHRoZSBpbnZlc3RvcidzIGNhcAogICAgICAgICAgICBpZiAoaXNCcmVha2luZ0ludmVzdG9yQ2FwKHJlY2VpdmVyLCB0b2tlbkFtb3VudCkpIHsKICAgICAgICAgICAgICAgIHRocm93OwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYodG9rZW5BbW91bnQgPCB0b2tlbi5taW5DYXAoKSAmJiB0b2tlbkFtb3VudE9mW3JlY2VpdmVyXSA9PSAwKSB7CiAgICAgICAgICAgICAgICB0aHJvdzsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYoaW52ZXN0ZWRBbW91bnRPZltyZWNlaXZlcl0gPT0gMCkgewogICAgICAgICAgICAvLyBBIG5ldyBpbnZlc3RvcgogICAgICAgICAgICBpbnZlc3RvckNvdW50Kys7CiAgICAgICAgfQoKICAgICAgICAvLyBVcGRhdGUgaW52ZXN0b3IKICAgICAgICBpbnZlc3RlZEFtb3VudE9mW3JlY2VpdmVyXSA9IGludmVzdGVkQW1vdW50T2ZbcmVjZWl2ZXJdLnBsdXMod2VpQW1vdW50KTsKICAgICAgICB0b2tlbkFtb3VudE9mW3JlY2VpdmVyXSA9IHRva2VuQW1vdW50T2ZbcmVjZWl2ZXJdLnBsdXModG9rZW5BbW91bnQpOwoKICAgICAgICAvLyBVcGRhdGUgdG90YWxzCiAgICAgICAgd2VpUmFpc2VkID0gd2VpUmFpc2VkLnBsdXMod2VpQW1vdW50KTsKICAgICAgICB0b2tlbnNTb2xkID0gdG9rZW5zU29sZC5wbHVzKHRva2VuQW1vdW50KTsKCiAgICAgICAgaWYocHJpY2luZ1N0cmF0ZWd5LmlzUHJlc2FsZVB1cmNoYXNlKHJlY2VpdmVyKSkgewogICAgICAgICAgICBwcmVzYWxlV2VpUmFpc2VkID0gcHJlc2FsZVdlaVJhaXNlZC5wbHVzKHdlaUFtb3VudCk7CiAgICAgICAgfQoKICAgICAgICAvLyBDaGVjayB0aGF0IHdlIGRpZCBub3QgYnVzdCB0aGUgY2FwCiAgICAgICAgaWYoaXNCcmVha2luZ0NhcCh3ZWlBbW91bnQsIHRva2VuQW1vdW50LCB3ZWlSYWlzZWQsIHRva2Vuc1NvbGQpKSB7CiAgICAgICAgICAgIHRocm93OwogICAgICAgIH0KCiAgICAgICAgYXNzaWduVG9rZW5zKHJlY2VpdmVyLCB0b2tlbkFtb3VudCk7CgogICAgICAgIC8vIFBvY2tldCB0aGUgbW9uZXkKICAgICAgICBpZighbXVsdGlzaWdXYWxsZXQuc2VuZCh3ZWlBbW91bnQpKSB0aHJvdzsKCiAgICAgICAgaWYgKGlzV2hpdGVMaXN0ZWQpIHsKICAgICAgICAgICAgdWludCBudW0gPSAwOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGpvaW5lZENyb3dkc2FsZXNMZW47IGkrKykgewogICAgICAgICAgICAgICAgaWYgKHRoaXMgPT0gam9pbmVkQ3Jvd2RzYWxlc1tpXSkKICAgICAgICAgICAgICAgICAgICBudW0gPSBpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAobnVtICsgMSA8IGpvaW5lZENyb3dkc2FsZXNMZW4pIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIGogPSBudW0gKyAxOyBqIDwgam9pbmVkQ3Jvd2RzYWxlc0xlbjsgaisrKSB7CiAgICAgICAgICAgICAgICAgICAgQ3Jvd2RzYWxlRXh0IGNyb3dkc2FsZSA9IENyb3dkc2FsZUV4dChqb2luZWRDcm93ZHNhbGVzW2pdKTsKICAgICAgICAgICAgICAgICAgICBjcm93ZHNhbGUudXBkYXRlRWFybHlQYXJpY2lwYW50V2hpdGVsaXN0KG1zZy5zZW5kZXIsIHRoaXMsIHRva2VuQW1vdW50KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gVGVsbCB1cyBpbnZlc3Qgd2FzIHN1Y2Nlc3MKICAgICAgICBJbnZlc3RlZChyZWNlaXZlciwgd2VpQW1vdW50LCB0b2tlbkFtb3VudCwgY3VzdG9tZXJJZCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBQcmVhbGxvY2F0ZSB0b2tlbnMgZm9yIHRoZSBlYXJseSBpbnZlc3RvcnMuCiAgICAgKgogICAgICogUHJlYWxsb2NhdGVkIHRva2VucyBoYXZlIGJlZW4gc29sZCBiZWZvcmUgdGhlIGFjdHVhbCBjcm93ZHNhbGUgb3BlbnMuCiAgICAgKiBUaGlzIGZ1bmN0aW9uIG1pbnRzIHRoZSB0b2tlbnMgYW5kIG1vdmVzIHRoZSBjcm93ZHNhbGUgbmVlZGxlLgogICAgICoKICAgICAqIEludmVzdG9yIGNvdW50IGlzIG5vdCBoYW5kbGVkOyBpdCBpcyBhc3N1bWVkIHRoaXMgZ29lcyBmb3IgbXVsdGlwbGUgaW52ZXN0b3JzCiAgICAgKiBhbmQgdGhlIHRva2VuIGRpc3RyaWJ1dGlvbiBoYXBwZW5zIG91dHNpZGUgdGhlIHNtYXJ0IGNvbnRyYWN0IGZsb3cuCiAgICAgKgogICAgICogTm8gbW9uZXkgaXMgZXhjaGFuZ2VkLCBhcyB0aGUgY3Jvd2RzYWxlIHRlYW0gYWxyZWFkeSBoYXZlIHJlY2VpdmVkIHRoZSBwYXltZW50LgogICAgICoKICAgICAqIEBwYXJhbSBmdWxsVG9rZW5zIHRva2VucyBhcyBmdWxsIHRva2VucyAtIGRlY2ltYWwgcGxhY2VzIGFkZGVkIGludGVybmFsbHkKICAgICAqIEBwYXJhbSB3ZWlQcmljZSBQcmljZSBvZiBhIHNpbmdsZSBmdWxsIHRva2VuIGluIHdlaQogICAgICoKICAgICAqLwogICAgZnVuY3Rpb24gcHJlYWxsb2NhdGUoYWRkcmVzcyByZWNlaXZlciwgdWludCBmdWxsVG9rZW5zLCB1aW50IHdlaVByaWNlKSBwdWJsaWMgb25seU93bmVyIHsKCiAgICAgICAgdWludCB0b2tlbkFtb3VudCA9IGZ1bGxUb2tlbnMgKiAxMCoqdG9rZW4uZGVjaW1hbHMoKTsKICAgICAgICB1aW50IHdlaUFtb3VudCA9IHdlaVByaWNlICogZnVsbFRva2VuczsgLy8gVGhpcyBjYW4gYmUgYWxzbyAwLCB3ZSBnaXZlIG91dCB0b2tlbnMgZm9yIGZyZWUKCiAgICAgICAgd2VpUmFpc2VkID0gd2VpUmFpc2VkLnBsdXMod2VpQW1vdW50KTsKICAgICAgICB0b2tlbnNTb2xkID0gdG9rZW5zU29sZC5wbHVzKHRva2VuQW1vdW50KTsKCiAgICAgICAgaW52ZXN0ZWRBbW91bnRPZltyZWNlaXZlcl0gPSBpbnZlc3RlZEFtb3VudE9mW3JlY2VpdmVyXS5wbHVzKHdlaUFtb3VudCk7CiAgICAgICAgdG9rZW5BbW91bnRPZltyZWNlaXZlcl0gPSB0b2tlbkFtb3VudE9mW3JlY2VpdmVyXS5wbHVzKHRva2VuQW1vdW50KTsKCiAgICAgICAgYXNzaWduVG9rZW5zKHJlY2VpdmVyLCB0b2tlbkFtb3VudCk7CgogICAgICAgIC8vIFRlbGwgdXMgaW52ZXN0IHdhcyBzdWNjZXNzCiAgICAgICAgSW52ZXN0ZWQocmVjZWl2ZXIsIHdlaUFtb3VudCwgdG9rZW5BbW91bnQsIDApOwogICAgfQoKICAgIC8qKgogICAgICogQWxsb3cgYW5vbnltb3VzIGNvbnRyaWJ1dGlvbnMgdG8gdGhpcyBjcm93ZHNhbGUuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGludmVzdFdpdGhTaWduZWRBZGRyZXNzKGFkZHJlc3MgYWRkciwgdWludDEyOCBjdXN0b21lcklkLCB1aW50OCB2LCBieXRlczMyIHIsIGJ5dGVzMzIgcykgcHVibGljIHBheWFibGUgewogICAgICAgIGJ5dGVzMzIgaGFzaCA9IHNoYTI1NihhZGRyKTsKICAgICAgICBpZiAoZWNyZWNvdmVyKGhhc2gsIHYsIHIsIHMpICE9IHNpZ25lckFkZHJlc3MpIHRocm93OwogICAgICAgIGlmKGN1c3RvbWVySWQgPT0gMCkgdGhyb3c7ICAvLyBVVUlEdjQgc2FuaXR5IGNoZWNrCiAgICAgICAgaW52ZXN0SW50ZXJuYWwoYWRkciwgY3VzdG9tZXJJZCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBUcmFjayB3aG8gaXMgdGhlIGN1c3RvbWVyIG1ha2luZyB0aGUgcGF5bWVudCBzbyB3ZSBjYW4gc2VuZCB0aGFuayB5b3UgZW1haWwuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGludmVzdFdpdGhDdXN0b21lcklkKGFkZHJlc3MgYWRkciwgdWludDEyOCBjdXN0b21lcklkKSBwdWJsaWMgcGF5YWJsZSB7CiAgICAgICAgaWYocmVxdWlyZWRTaWduZWRBZGRyZXNzKSB0aHJvdzsgLy8gQ3Jvd2RzYWxlIGFsbG93cyBvbmx5IHNlcnZlci1zaWRlIHNpZ25lZCBwYXJ0aWNpcGFudHMKICAgICAgICBpZihjdXN0b21lcklkID09IDApIHRocm93OyAgLy8gVVVJRHY0IHNhbml0eSBjaGVjawogICAgICAgIGludmVzdEludGVybmFsKGFkZHIsIGN1c3RvbWVySWQpOwogICAgfQoKICAgIC8qKgogICAgICogQWxsb3cgYW5vbnltb3VzIGNvbnRyaWJ1dGlvbnMgdG8gdGhpcyBjcm93ZHNhbGUuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGludmVzdChhZGRyZXNzIGFkZHIpIHB1YmxpYyBwYXlhYmxlIHsKICAgICAgICBpZihyZXF1aXJlQ3VzdG9tZXJJZCkgdGhyb3c7IC8vIENyb3dkc2FsZSBuZWVkcyB0byB0cmFjayBwYXJ0aWNpcGFudHMgZm9yIHRoYW5rIHlvdSBlbWFpbAogICAgICAgIGlmKHJlcXVpcmVkU2lnbmVkQWRkcmVzcykgdGhyb3c7IC8vIENyb3dkc2FsZSBhbGxvd3Mgb25seSBzZXJ2ZXItc2lkZSBzaWduZWQgcGFydGljaXBhbnRzCiAgICAgICAgaW52ZXN0SW50ZXJuYWwoYWRkciwgMCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBJbnZlc3QgdG8gdG9rZW5zLCByZWNvZ25pemUgdGhlIHBheWVyIGFuZCBjbGVhciBoaXMgYWRkcmVzcy4KICAgICAqCiAgICAgKi8KICAgIGZ1bmN0aW9uIGJ1eVdpdGhTaWduZWRBZGRyZXNzKHVpbnQxMjggY3VzdG9tZXJJZCwgdWludDggdiwgYnl0ZXMzMiByLCBieXRlczMyIHMpIHB1YmxpYyBwYXlhYmxlIHsKICAgICAgICBpbnZlc3RXaXRoU2lnbmVkQWRkcmVzcyhtc2cuc2VuZGVyLCBjdXN0b21lcklkLCB2LCByLCBzKTsKICAgIH0KCiAgICAvKioKICAgICAqIEludmVzdCB0byB0b2tlbnMsIHJlY29nbml6ZSB0aGUgcGF5ZXIuCiAgICAgKgogICAgICovCiAgICBmdW5jdGlvbiBidXlXaXRoQ3VzdG9tZXJJZCh1aW50MTI4IGN1c3RvbWVySWQpIHB1YmxpYyBwYXlhYmxlIHsKICAgICAgICBpbnZlc3RXaXRoQ3VzdG9tZXJJZChtc2cuc2VuZGVyLCBjdXN0b21lcklkKTsKICAgIH0KCiAgICAvKioKICAgICAqIFRoZSBiYXNpYyBlbnRyeSBwb2ludCB0byBwYXJ0aWNpcGF0ZSB0aGUgY3Jvd2RzYWxlIHByb2Nlc3MuCiAgICAgKgogICAgICogUGF5IGZvciBmdW5kaW5nLCBnZXQgaW52ZXN0ZWQgdG9rZW5zIGJhY2sgaW4gdGhlIHNlbmRlciBhZGRyZXNzLgogICAgICovCiAgICBmdW5jdGlvbiBidXkoKSBwdWJsaWMgcGF5YWJsZSB7CiAgICAgICAgaW52ZXN0KG1zZy5zZW5kZXIpOwogICAgfQoKICAgIC8qKgogICAgICogRmluYWxpemUgYSBzdWNjY2VzZnVsIGNyb3dkc2FsZS4KICAgICAqCiAgICAgKiBUaGUgb3duZXIgY2FuIHRyaWdncmUgYSBjYWxsIHRoZSBjb250cmFjdCB0aGF0IHByb3ZpZGVzIHBvc3QtY3Jvd2RzYWxlIGFjdGlvbnMsIGxpa2UgcmVsZWFzaW5nIHRoZSB0b2tlbnMuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGZpbmFsaXplKCkgcHVibGljIGluU3RhdGUoU3RhdGUuU3VjY2Vzcykgb25seU93bmVyIHN0b3BJbkVtZXJnZW5jeSB7CgogICAgICAgIC8vIEFscmVhZHkgZmluYWxpemVkCiAgICAgICAgaWYoZmluYWxpemVkKSB7CiAgICAgICAgICAgIHRocm93OwogICAgICAgIH0KCiAgICAgICAgLy8gRmluYWxpemluZyBpcyBvcHRpb25hbC4gV2Ugb25seSBjYWxsIGl0IGlmIHdlIGFyZSBnaXZlbiBhIGZpbmFsaXppbmcgYWdlbnQuCiAgICAgICAgaWYoYWRkcmVzcyhmaW5hbGl6ZUFnZW50KSAhPSAwKSB7CiAgICAgICAgICAgIGZpbmFsaXplQWdlbnQuZmluYWxpemVDcm93ZHNhbGUoKTsKICAgICAgICB9CgogICAgICAgIGZpbmFsaXplZCA9IHRydWU7CiAgICB9CgogICAgLyoqCiAgICAgKiBBbGxvdyB0byAocmUpc2V0IGZpbmFsaXplIGFnZW50LgogICAgICoKICAgICAqIERlc2lnbiBjaG9pY2U6IG5vIHN0YXRlIHJlc3RyaWN0aW9ucyBvbiBzZXR0aW5nIHRoaXMsIHNvIHRoYXQgd2UgY2FuIGZpeCBmYXQgZmluZ2VyIG1pc3Rha2VzLgogICAgICovCiAgICBmdW5jdGlvbiBzZXRGaW5hbGl6ZUFnZW50KEZpbmFsaXplQWdlbnQgYWRkcikgb25seU93bmVyIHsKICAgICAgICBmaW5hbGl6ZUFnZW50ID0gYWRkcjsKCiAgICAgICAgLy8gRG9uJ3QgYWxsb3cgc2V0dGluZyBiYWQgYWdlbnQKICAgICAgICBpZighZmluYWxpemVBZ2VudC5pc0ZpbmFsaXplQWdlbnQoKSkgewogICAgICAgICAgICB0aHJvdzsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBTZXQgcG9saWN5IGRvIHdlIG5lZWQgdG8gaGF2ZSBzZXJ2ZXItc2lkZSBjdXN0b21lciBpZHMgZm9yIHRoZSBpbnZlc3RtZW50cy4KICAgICAqCiAgICAgKi8KICAgIGZ1bmN0aW9uIHNldFJlcXVpcmVDdXN0b21lcklkKGJvb2wgdmFsdWUpIG9ubHlPd25lciB7CiAgICAgICAgcmVxdWlyZUN1c3RvbWVySWQgPSB2YWx1ZTsKICAgICAgICBJbnZlc3RtZW50UG9saWN5Q2hhbmdlZChyZXF1aXJlQ3VzdG9tZXJJZCwgcmVxdWlyZWRTaWduZWRBZGRyZXNzLCBzaWduZXJBZGRyZXNzKTsKICAgIH0KCiAgICAvKioKICAgICAqIFNldCBwb2xpY3kgaWYgYWxsIGludmVzdG9ycyBtdXN0IGJlIGNsZWFyZWQgb24gdGhlIHNlcnZlciBzaWRlIGZpcnN0LgogICAgICoKICAgICAqIFRoaXMgaXMgZS5nLiBmb3IgdGhlIGFjY3JlZGl0ZWQgaW52ZXN0b3IgY2xlYXJpbmcuCiAgICAgKgogICAgICovCiAgICBmdW5jdGlvbiBzZXRSZXF1aXJlU2lnbmVkQWRkcmVzcyhib29sIHZhbHVlLCBhZGRyZXNzIF9zaWduZXJBZGRyZXNzKSBvbmx5T3duZXIgewogICAgICAgIHJlcXVpcmVkU2lnbmVkQWRkcmVzcyA9IHZhbHVlOwogICAgICAgIHNpZ25lckFkZHJlc3MgPSBfc2lnbmVyQWRkcmVzczsKICAgICAgICBJbnZlc3RtZW50UG9saWN5Q2hhbmdlZChyZXF1aXJlQ3VzdG9tZXJJZCwgcmVxdWlyZWRTaWduZWRBZGRyZXNzLCBzaWduZXJBZGRyZXNzKTsKICAgIH0KCiAgICAvKioKICAgICAqIEFsbG93IGFkZHJlc3NlcyB0byBkbyBlYXJseSBwYXJ0aWNpcGF0aW9uLgogICAgICoKICAgICAqIFRPRE86IEZpeCBzcGVsbGluZyBlcnJvciBpbiB0aGUgbmFtZQogICAgICovCiAgICBmdW5jdGlvbiBzZXRFYXJseVBhcmljaXBhbnRXaGl0ZWxpc3QoYWRkcmVzcyBhZGRyLCBib29sIHN0YXR1cywgdWludCBtaW5DYXAsIHVpbnQgbWF4Q2FwKSBvbmx5T3duZXIgewogICAgICAgIGlmICghaXNXaGl0ZUxpc3RlZCkgdGhyb3c7CiAgICAgICAgZWFybHlQYXJ0aWNpcGFudFdoaXRlbGlzdFthZGRyXSA9IFdoaXRlTGlzdERhdGEoe3N0YXR1czpzdGF0dXMsIG1pbkNhcDptaW5DYXAsIG1heENhcDptYXhDYXB9KTsKICAgICAgICBXaGl0ZWxpc3RlZChhZGRyLCBzdGF0dXMpOwogICAgfQoKICAgIGZ1bmN0aW9uIHNldEVhcmx5UGFyaWNpcGFudHNXaGl0ZWxpc3QoYWRkcmVzc1tdIGFkZHJzLCBib29sW10gc3RhdHVzZXMsIHVpbnRbXSBtaW5DYXBzLCB1aW50W10gbWF4Q2Fwcykgb25seU93bmVyIHsKICAgICAgICBpZiAoIWlzV2hpdGVMaXN0ZWQpIHRocm93OwogICAgICAgIGZvciAodWludCBpdGVyYXRvciA9IDA7IGl0ZXJhdG9yIDwgYWRkcnMubGVuZ3RoOyBpdGVyYXRvcisrKSB7CiAgICAgICAgICAgIHNldEVhcmx5UGFyaWNpcGFudFdoaXRlbGlzdChhZGRyc1tpdGVyYXRvcl0sIHN0YXR1c2VzW2l0ZXJhdG9yXSwgbWluQ2Fwc1tpdGVyYXRvcl0sIG1heENhcHNbaXRlcmF0b3JdKTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gdXBkYXRlRWFybHlQYXJpY2lwYW50V2hpdGVsaXN0KGFkZHJlc3MgYWRkciwgYWRkcmVzcyBjb250cmFjdEFkZHIsIHVpbnQgdG9rZW5zQm91Z2h0KSB7CiAgICAgICAgaWYgKHRva2Vuc0JvdWdodCA8IGVhcmx5UGFydGljaXBhbnRXaGl0ZWxpc3RbYWRkcl0ubWluQ2FwKSB0aHJvdzsKICAgICAgICBpZiAoIWlzV2hpdGVMaXN0ZWQpIHRocm93OwogICAgICAgIGlmIChhZGRyICE9IG1zZy5zZW5kZXIgJiYgY29udHJhY3RBZGRyICE9IG1zZy5zZW5kZXIpIHRocm93OwogICAgICAgIHVpbnQgbmV3TWF4Q2FwID0gZWFybHlQYXJ0aWNpcGFudFdoaXRlbGlzdFthZGRyXS5tYXhDYXA7CiAgICAgICAgbmV3TWF4Q2FwID0gbmV3TWF4Q2FwLm1pbnVzKHRva2Vuc0JvdWdodCk7CiAgICAgICAgZWFybHlQYXJ0aWNpcGFudFdoaXRlbGlzdFthZGRyXSA9IFdoaXRlTGlzdERhdGEoe3N0YXR1czplYXJseVBhcnRpY2lwYW50V2hpdGVsaXN0W2FkZHJdLnN0YXR1cywgbWluQ2FwOjAsIG1heENhcDpuZXdNYXhDYXB9KTsKICAgIH0KCiAgICBmdW5jdGlvbiB1cGRhdGVKb2luZWRDcm93ZHNhbGVzKGFkZHJlc3MgYWRkcikgb25seU93bmVyIHsKICAgICAgICBqb2luZWRDcm93ZHNhbGVzW2pvaW5lZENyb3dkc2FsZXNMZW4rK10gPSBhZGRyOwogICAgfQoKICAgIGZ1bmN0aW9uIHNldExhc3RDcm93ZHNhbGUoYWRkcmVzcyBhZGRyKSBvbmx5T3duZXIgewogICAgICAgIGxhc3RDcm93ZHNhbGUgPSBhZGRyOwogICAgfQoKICAgIGZ1bmN0aW9uIGNsZWFySm9pbmVkQ3Jvd2RzYWxlcygpIG9ubHlPd25lciB7CiAgICAgICAgam9pbmVkQ3Jvd2RzYWxlc0xlbiA9IDA7CiAgICB9CgogICAgZnVuY3Rpb24gdXBkYXRlSm9pbmVkQ3Jvd2RzYWxlc011bHRpcGxlKGFkZHJlc3NbXSBhZGRycykgb25seU93bmVyIHsKICAgICAgICBjbGVhckpvaW5lZENyb3dkc2FsZXMoKTsKICAgICAgICBmb3IgKHVpbnQgaXRlciA9IDA7IGl0ZXIgPCBhZGRycy5sZW5ndGg7IGl0ZXIrKykgewogICAgICAgICAgICBpZihqb2luZWRDcm93ZHNhbGVzTGVuID09IGpvaW5lZENyb3dkc2FsZXMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBqb2luZWRDcm93ZHNhbGVzLmxlbmd0aCArPSAxOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGpvaW5lZENyb3dkc2FsZXNbam9pbmVkQ3Jvd2RzYWxlc0xlbisrXSA9IGFkZHJzW2l0ZXJdOwogICAgICAgICAgICBpZiAoaXRlciA9PSBhZGRycy5sZW5ndGggLSAxKQogICAgICAgICAgICAgICAgc2V0TGFzdENyb3dkc2FsZShhZGRyc1tpdGVyXSk7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIHNldFN0YXJ0c0F0KHVpbnQgdGltZSkgb25seU93bmVyIHsKICAgICAgICBpZiAoZmluYWxpemVkKSB0aHJvdzsKCiAgICAgICAgaWYgKCFpc1VwZGF0YWJsZSkgdGhyb3c7CgogICAgICAgIGlmKG5vdyA+IHRpbWUpIHsKICAgICAgICAgICAgdGhyb3c7IC8vIERvbid0IGNoYW5nZSBwYXN0CiAgICAgICAgfQoKICAgICAgICBpZih0aW1lID4gZW5kc0F0KSB7CiAgICAgICAgICAgIHRocm93OwogICAgICAgIH0KCiAgICAgICAgQ3Jvd2RzYWxlRXh0IGxhc3RDcm93ZHNhbGVDbnRyY3QgPSBDcm93ZHNhbGVFeHQobGFzdENyb3dkc2FsZSk7CiAgICAgICAgaWYgKGxhc3RDcm93ZHNhbGVDbnRyY3QuZmluYWxpemVkKCkpIHRocm93OwoKICAgICAgICBzdGFydHNBdCA9IHRpbWU7CiAgICAgICAgU3RhcnRzQXRDaGFuZ2VkKHN0YXJ0c0F0KTsKICAgIH0KCiAgICAvKioKICAgICAqIEFsbG93IGNyb3dkc2FsZSBvd25lciB0byBjbG9zZSBlYXJseSBvciBleHRlbmQgdGhlIGNyb3dkc2FsZS4KICAgICAqCiAgICAgKiBUaGlzIGlzIHVzZWZ1bCBlLmcuIGZvciBhIG1hbnVhbCBzb2Z0IGNhcCBpbXBsZW1lbnRhdGlvbjoKICAgICAqIC0gYWZ0ZXIgWCBhbW91bnQgaXMgcmVhY2hlZCBkZXRlcm1pbmUgbWFudWFsIGNsb3NpbmcKICAgICAqCiAgICAgKiBUaGlzIG1heSBwdXQgdGhlIGNyb3dkc2FsZSB0byBhbiBpbnZhbGlkIHN0YXRlLAogICAgICogYnV0IHdlIHRydXN0IG93bmVycyBrbm93IHdoYXQgdGhleSBhcmUgZG9pbmcuCiAgICAgKgogICAgICovCiAgICBmdW5jdGlvbiBzZXRFbmRzQXQodWludCB0aW1lKSBvbmx5T3duZXIgewogICAgICAgIGlmIChmaW5hbGl6ZWQpIHRocm93OwoKICAgICAgICBpZiAoIWlzVXBkYXRhYmxlKSB0aHJvdzsKCiAgICAgICAgaWYobm93ID4gdGltZSkgewogICAgICAgICAgICB0aHJvdzsgLy8gRG9uJ3QgY2hhbmdlIHBhc3QKICAgICAgICB9CgogICAgICAgIGlmKHN0YXJ0c0F0ID4gdGltZSkgewogICAgICAgICAgICB0aHJvdzsKICAgICAgICB9CgogICAgICAgIENyb3dkc2FsZUV4dCBsYXN0Q3Jvd2RzYWxlQ250cmN0ID0gQ3Jvd2RzYWxlRXh0KGxhc3RDcm93ZHNhbGUpOwogICAgICAgIGlmIChsYXN0Q3Jvd2RzYWxlQ250cmN0LmZpbmFsaXplZCgpKSB0aHJvdzsKCiAgICAgICAgdWludCBudW0gPSAwOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgam9pbmVkQ3Jvd2RzYWxlc0xlbjsgaSsrKSB7CiAgICAgICAgICAgIGlmICh0aGlzID09IGpvaW5lZENyb3dkc2FsZXNbaV0pCiAgICAgICAgICAgICAgICBudW0gPSBpOwogICAgICAgIH0KCiAgICAgICAgaWYgKG51bSArIDEgPCBqb2luZWRDcm93ZHNhbGVzTGVuKSB7CiAgICAgICAgICAgIGZvciAodmFyIGogPSBudW0gKyAxOyBqIDwgam9pbmVkQ3Jvd2RzYWxlc0xlbjsgaisrKSB7CiAgICAgICAgICAgICAgICBDcm93ZHNhbGVFeHQgY3Jvd2RzYWxlID0gQ3Jvd2RzYWxlRXh0KGpvaW5lZENyb3dkc2FsZXNbal0pOwogICAgICAgICAgICAgICAgaWYgKHRpbWUgPiBjcm93ZHNhbGUuc3RhcnRzQXQoKSkgdGhyb3c7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGVuZHNBdCA9IHRpbWU7CiAgICAgICAgRW5kc0F0Q2hhbmdlZChlbmRzQXQpOwogICAgfQoKICAgIC8qKgogICAgICogQWxsb3cgdG8gKHJlKXNldCBwcmljaW5nIHN0cmF0ZWd5LgogICAgICoKICAgICAqIERlc2lnbiBjaG9pY2U6IG5vIHN0YXRlIHJlc3RyaWN0aW9ucyBvbiB0aGUgc2V0LCBzbyB0aGF0IHdlIGNhbiBmaXggZmF0IGZpbmdlciBtaXN0YWtlcy4KICAgICAqLwogICAgZnVuY3Rpb24gc2V0UHJpY2luZ1N0cmF0ZWd5KE1pbGVzdG9uZVByaWNpbmcgX3ByaWNpbmdTdHJhdGVneSkgb25seU93bmVyIHsKICAgICAgICBwcmljaW5nU3RyYXRlZ3kgPSBfcHJpY2luZ1N0cmF0ZWd5OwoKICAgICAgICAvLyBEb24ndCBhbGxvdyBzZXR0aW5nIGJhZCBhZ2VudAogICAgICAgIGlmKCFwcmljaW5nU3RyYXRlZ3kuaXNQcmljaW5nU3RyYXRlZ3koKSkgewogICAgICAgICAgICB0aHJvdzsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBBbGxvdyB0byBjaGFuZ2UgdGhlIHRlYW0gbXVsdGlzaWcgYWRkcmVzcyBpbiB0aGUgY2FzZSBvZiBlbWVyZ2VuY3kuCiAgICAgKgogICAgICogVGhpcyBhbGxvd3MgdG8gc2F2ZSBhIGRlcGxveWVkIGNyb3dkc2FsZSB3YWxsZXQgaW4gdGhlIGNhc2UgdGhlIGNyb3dkc2FsZSBoYXMgbm90IHlldCBiZWd1bgogICAgICogKHdlIGhhdmUgZG9uZSBvbmx5IGZldyB0ZXN0IHRyYW5zYWN0aW9ucykuIEFmdGVyIHRoZSBjcm93ZHNhbGUgaXMgZ29pbmcKICAgICAqIHRoZW4gbXVsdGlzaWcgYWRkcmVzcyBzdGF5cyBsb2NrZWQgZm9yIHRoZSBzYWZldHkgcmVhc29ucy4KICAgICAqLwogICAgZnVuY3Rpb24gc2V0TXVsdGlzaWcoYWRkcmVzcyBhZGRyKSBwdWJsaWMgb25seU93bmVyIHsKCiAgICAgICAgLy8gQ2hhbmdlCiAgICAgICAgaWYoaW52ZXN0b3JDb3VudCA+IE1BWF9JTlZFU1RNRU5UU19CRUZPUkVfTVVMVElTSUdfQ0hBTkdFKSB7CiAgICAgICAgICAgIHRocm93OwogICAgICAgIH0KCiAgICAgICAgbXVsdGlzaWdXYWxsZXQgPSBhZGRyOwogICAgfQoKICAgIC8qKgogICAgICogQWxsb3cgbG9hZCByZWZ1bmRzIGJhY2sgb24gdGhlIGNvbnRyYWN0IGZvciB0aGUgcmVmdW5kaW5nLgogICAgICoKICAgICAqIFRoZSB0ZWFtIGNhbiB0cmFuc2ZlciB0aGUgZnVuZHMgYmFjayBvbiB0aGUgc21hcnQgY29udHJhY3QgaW4gdGhlIGNhc2UgdGhlIG1pbmltdW0gZ29hbCB3YXMgbm90IHJlYWNoZWQuLgogICAgICovCiAgICBmdW5jdGlvbiBsb2FkUmVmdW5kKCkgcHVibGljIHBheWFibGUgaW5TdGF0ZShTdGF0ZS5GYWlsdXJlKSB7CiAgICAgICAgaWYobXNnLnZhbHVlID09IDApIHRocm93OwogICAgICAgIGxvYWRlZFJlZnVuZCA9IGxvYWRlZFJlZnVuZC5wbHVzKG1zZy52YWx1ZSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBJbnZlc3RvcnMgY2FuIGNsYWltIHJlZnVuZC4KICAgICAqCiAgICAgKiBOb3RlIHRoYXQgYW55IHJlZnVuZHMgZnJvbSBwcm94eSBidXllcnMgc2hvdWxkIGJlIGhhbmRsZWQgc2VwYXJhdGVseSwKICAgICAqIGFuZCBub3QgdGhyb3VnaCB0aGlzIGNvbnRyYWN0LgogICAgICovCiAgICBmdW5jdGlvbiByZWZ1bmQoKSBwdWJsaWMgaW5TdGF0ZShTdGF0ZS5SZWZ1bmRpbmcpIHsKICAgICAgICB1aW50MjU2IHdlaVZhbHVlID0gaW52ZXN0ZWRBbW91bnRPZlttc2cuc2VuZGVyXTsKICAgICAgICBpZiAod2VpVmFsdWUgPT0gMCkgdGhyb3c7CiAgICAgICAgaW52ZXN0ZWRBbW91bnRPZlttc2cuc2VuZGVyXSA9IDA7CiAgICAgICAgd2VpUmVmdW5kZWQgPSB3ZWlSZWZ1bmRlZC5wbHVzKHdlaVZhbHVlKTsKICAgICAgICBSZWZ1bmQobXNnLnNlbmRlciwgd2VpVmFsdWUpOwogICAgICAgIGlmICghbXNnLnNlbmRlci5zZW5kKHdlaVZhbHVlKSkgdGhyb3c7CiAgICB9CgogICAgLyoqCiAgICAgKiBAcmV0dXJuIHRydWUgaWYgdGhlIGNyb3dkc2FsZSBoYXMgcmFpc2VkIGVub3VnaCBtb25leSB0byBiZSBhIHN1Y2Nlc3NmdWwuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzTWluaW11bUdvYWxSZWFjaGVkKCkgcHVibGljIGNvbnN0YW50IHJldHVybnMgKGJvb2wgcmVhY2hlZCkgewogICAgICAgIHJldHVybiB3ZWlSYWlzZWQgPj0gbWluaW11bUZ1bmRpbmdHb2FsOwogICAgfQoKICAgIC8qKgogICAgICogQ2hlY2sgaWYgdGhlIGNvbnRyYWN0IHJlbGF0aW9uc2hpcCBsb29rcyBnb29kLgogICAgICovCiAgICBmdW5jdGlvbiBpc0ZpbmFsaXplclNhbmUoKSBwdWJsaWMgY29uc3RhbnQgcmV0dXJucyAoYm9vbCBzYW5lKSB7CiAgICAgICAgcmV0dXJuIGZpbmFsaXplQWdlbnQuaXNTYW5lKCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDaGVjayBpZiB0aGUgY29udHJhY3QgcmVsYXRpb25zaGlwIGxvb2tzIGdvb2QuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzUHJpY2luZ1NhbmUoKSBwdWJsaWMgY29uc3RhbnQgcmV0dXJucyAoYm9vbCBzYW5lKSB7CiAgICAgICAgcmV0dXJuIHByaWNpbmdTdHJhdGVneS5pc1NhbmUoYWRkcmVzcyh0aGlzKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcm93ZGZ1bmQgc3RhdGUgbWFjaGluZSBtYW5hZ2VtZW50LgogICAgICoKICAgICAqIFdlIG1ha2UgaXQgYSBmdW5jdGlvbiBhbmQgZG8gbm90IGFzc2lnbiB0aGUgcmVzdWx0IHRvIGEgdmFyaWFibGUsIHNvIHRoZXJlIGlzIG5vIGNoYW5jZSBvZiB0aGUgdmFyaWFibGUgYmVpbmcgc3RhbGUuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGdldFN0YXRlKCkgcHVibGljIGNvbnN0YW50IHJldHVybnMgKFN0YXRlKSB7CiAgICAgICAgaWYoZmluYWxpemVkKSByZXR1cm4gU3RhdGUuRmluYWxpemVkOwogICAgICAgIGVsc2UgaWYgKGFkZHJlc3MoZmluYWxpemVBZ2VudCkgPT0gMCkgcmV0dXJuIFN0YXRlLlByZXBhcmluZzsKICAgICAgICBlbHNlIGlmICghZmluYWxpemVBZ2VudC5pc1NhbmUoKSkgcmV0dXJuIFN0YXRlLlByZXBhcmluZzsKICAgICAgICBlbHNlIGlmICghcHJpY2luZ1N0cmF0ZWd5LmlzU2FuZShhZGRyZXNzKHRoaXMpKSkgcmV0dXJuIFN0YXRlLlByZXBhcmluZzsKICAgICAgICBlbHNlIGlmIChibG9jay50aW1lc3RhbXAgPCBzdGFydHNBdCkgcmV0dXJuIFN0YXRlLlByZUZ1bmRpbmc7CiAgICAgICAgZWxzZSBpZiAoYmxvY2sudGltZXN0YW1wIDw9IGVuZHNBdCAmJiAhaXNDcm93ZHNhbGVGdWxsKCkpIHJldHVybiBTdGF0ZS5GdW5kaW5nOwogICAgICAgIGVsc2UgaWYgKGlzTWluaW11bUdvYWxSZWFjaGVkKCkpIHJldHVybiBTdGF0ZS5TdWNjZXNzOwogICAgICAgIGVsc2UgaWYgKCFpc01pbmltdW1Hb2FsUmVhY2hlZCgpICYmIHdlaVJhaXNlZCA+IDAgJiYgbG9hZGVkUmVmdW5kID49IHdlaVJhaXNlZCkgcmV0dXJuIFN0YXRlLlJlZnVuZGluZzsKICAgICAgICBlbHNlIHJldHVybiBTdGF0ZS5GYWlsdXJlOwogICAgfQoKICAgIC8qKiBUaGlzIGlzIGZvciBtYW51YWwgdGVzdGluZyBvZiBtdWx0aXNpZyB3YWxsZXQgaW50ZXJhY3Rpb24gKi8KICAgIGZ1bmN0aW9uIHNldE93bmVyVGVzdFZhbHVlKHVpbnQgdmFsKSBvbmx5T3duZXIgewogICAgICAgIG93bmVyVGVzdFZhbHVlID0gdmFsOwogICAgfQoKICAgIC8qKiBJbnRlcmZhY2UgbWFya2VyLiAqLwogICAgZnVuY3Rpb24gaXNDcm93ZHNhbGUoKSBwdWJsaWMgY29uc3RhbnQgcmV0dXJucyAoYm9vbCkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIC8vCiAgICAvLyBNb2RpZmllcnMKICAgIC8vCgogICAgLyoqIE1vZGlmaWVkIGFsbG93aW5nIGV4ZWN1dGlvbiBvbmx5IGlmIHRoZSBjcm93ZHNhbGUgaXMgY3VycmVudGx5IHJ1bm5pbmcuICAqLwogICAgbW9kaWZpZXIgaW5TdGF0ZShTdGF0ZSBzdGF0ZSkgewogICAgICAgIGlmKGdldFN0YXRlKCkgIT0gc3RhdGUpIHRocm93OwogICAgICAgIF87CiAgICB9CgoKICAgIC8vCiAgICAvLyBBYnN0cmFjdCBmdW5jdGlvbnMKICAgIC8vCgogICAgLyoqCiAgICAgKiBDaGVjayBpZiB0aGUgY3VycmVudCBpbnZlc3RlZCBicmVha3Mgb3VyIGNhcCBydWxlcy4KICAgICAqCiAgICAgKgogICAgICogVGhlIGNoaWxkIGNvbnRyYWN0IG11c3QgZGVmaW5lIHRoZWlyIG93biBjYXAgc2V0dGluZyBydWxlcy4KICAgICAqIFdlIGFsbG93IGEgbG90IG9mIGZsZXhpYmlsaXR5IHRocm91Z2ggZGlmZmVyZW50IGNhcHBpbmcgc3RyYXRlZ2llcyAoRVRILCB0b2tlbiBjb3VudCkKICAgICAqIENhbGxlZCBmcm9tIGludmVzdCgpLgogICAgICoKICAgICAqIEBwYXJhbSB3ZWlBbW91bnQgVGhlIGFtb3VudCBvZiB3ZWkgdGhlIGludmVzdG9yIHRyaWVzIHRvIGludmVzdCBpbiB0aGUgY3VycmVudCB0cmFuc2FjdGlvbgogICAgICogQHBhcmFtIHRva2VuQW1vdW50IFRoZSBhbW91bnQgb2YgdG9rZW5zIHdlIHRyeSB0byBnaXZlIHRvIHRoZSBpbnZlc3RvciBpbiB0aGUgY3VycmVudCB0cmFuc2FjdGlvbgogICAgICogQHBhcmFtIHdlaVJhaXNlZFRvdGFsIFdoYXQgd291bGQgYmUgb3VyIHRvdGFsIHJhaXNlZCBiYWxhbmNlIGFmdGVyIHRoaXMgdHJhbnNhY3Rpb24KICAgICAqIEBwYXJhbSB0b2tlbnNTb2xkVG90YWwgV2hhdCB3b3VsZCBiZSBvdXIgdG90YWwgc29sZCB0b2tlbnMgY291bnQgYWZ0ZXIgdGhpcyB0cmFuc2FjdGlvbgogICAgICoKICAgICAqIEByZXR1cm4gdHJ1ZSBpZiB0YWtpbmcgdGhpcyBpbnZlc3RtZW50IHdvdWxkIGJyZWFrIG91ciBjYXAgcnVsZXMKICAgICAqLwogICAgZnVuY3Rpb24gaXNCcmVha2luZ0NhcCh1aW50IHdlaUFtb3VudCwgdWludCB0b2tlbkFtb3VudCwgdWludCB3ZWlSYWlzZWRUb3RhbCwgdWludCB0b2tlbnNTb2xkVG90YWwpIGNvbnN0YW50IHJldHVybnMgKGJvb2wgbGltaXRCcm9rZW4pOwoKICAgIGZ1bmN0aW9uIGlzQnJlYWtpbmdJbnZlc3RvckNhcChhZGRyZXNzIHJlY2VpdmVyLCB1aW50IHRva2VuQW1vdW50KSBjb25zdGFudCByZXR1cm5zIChib29sIGxpbWl0QnJva2VuKTsKCiAgICAvKioKICAgICAqIENoZWNrIGlmIHRoZSBjdXJyZW50IGNyb3dkc2FsZSBpcyBmdWxsIGFuZCB3ZSBjYW4gbm8gbG9uZ2VyIHNlbGwgYW55IHRva2Vucy4KICAgICAqLwogICAgZnVuY3Rpb24gaXNDcm93ZHNhbGVGdWxsKCkgcHVibGljIGNvbnN0YW50IHJldHVybnMgKGJvb2wpOwoKICAgIC8qKgogICAgICogQ3JlYXRlIG5ldyB0b2tlbnMgb3IgdHJhbnNmZXIgaXNzdWVkIHRva2VucyB0byB0aGUgaW52ZXN0b3IgZGVwZW5kaW5nIG9uIHRoZSBjYXAgbW9kZWwuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGFzc2lnblRva2VucyhhZGRyZXNzIHJlY2VpdmVyLCB1aW50IHRva2VuQW1vdW50KSBwcml2YXRlOwp9CgoKLyoqCiAqIFRoaXMgc21hcnQgY29udHJhY3QgY29kZSBpcyBDb3B5cmlnaHQgMjAxNyBUb2tlbk1hcmtldCBMdGQuIEZvciBtb3JlIGluZm9ybWF0aW9uIHNlZSBodHRwczovL3Rva2VubWFya2V0Lm5ldAogKgogKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIHZlcnNpb24gMi4wOiBodHRwczovL2dpdGh1Yi5jb20vVG9rZW5NYXJrZXROZXQvaWNvL2Jsb2IvbWFzdGVyL0xJQ0VOU0UudHh0CiAqLwoKCmNvbnRyYWN0IE1pbnRlZFRva2VuQ2FwcGVkQ3Jvd2RzYWxlRXh0IGlzIENyb3dkc2FsZUV4dCB7CgogICAgLyogTWF4aW11bSBhbW91bnQgb2YgdG9rZW5zIHRoaXMgY3Jvd2RzYWxlIGNhbiBzZWxsLiAqLwogICAgdWludCBwdWJsaWMgbWF4aW11bVNlbGxhYmxlVG9rZW5zOwoKICAgIGZ1bmN0aW9uIE1pbnRlZFRva2VuQ2FwcGVkQ3Jvd2RzYWxlRXh0KGFkZHJlc3MgX3Rva2VuLCBNaWxlc3RvbmVQcmljaW5nIF9wcmljaW5nU3RyYXRlZ3ksIGFkZHJlc3MgX211bHRpc2lnV2FsbGV0LCB1aW50IF9zdGFydCwgdWludCBfZW5kLCB1aW50IF9taW5pbXVtRnVuZGluZ0dvYWwsIHVpbnQgX21heGltdW1TZWxsYWJsZVRva2VucywgYm9vbCBfaXNVcGRhdGFibGUsIGJvb2wgX2lzV2hpdGVMaXN0ZWQpIENyb3dkc2FsZUV4dChfdG9rZW4sIF9wcmljaW5nU3RyYXRlZ3ksIF9tdWx0aXNpZ1dhbGxldCwgX3N0YXJ0LCBfZW5kLCBfbWluaW11bUZ1bmRpbmdHb2FsLCBfaXNVcGRhdGFibGUsIF9pc1doaXRlTGlzdGVkKSB7CiAgICAgICAgbWF4aW11bVNlbGxhYmxlVG9rZW5zID0gX21heGltdW1TZWxsYWJsZVRva2VuczsKICAgIH0KCiAgICAvLyBDcm93ZHNhbGUgbWF4aW11bVNlbGxhYmxlVG9rZW5zIGhhcyBiZWVuIGNoYW5nZWQKICAgIGV2ZW50IE1heGltdW1TZWxsYWJsZVRva2Vuc0NoYW5nZWQodWludCBuZXdNYXhpbXVtU2VsbGFibGVUb2tlbnMpOwoKICAgIC8qKgogICAgICogQ2FsbGVkIGZyb20gaW52ZXN0KCkgdG8gY29uZmlybSBpZiB0aGUgY3VycmV0IGludmVzdG1lbnQgZG9lcyBub3QgYnJlYWsgb3VyIGNhcCBydWxlLgogICAgICovCiAgICBmdW5jdGlvbiBpc0JyZWFraW5nQ2FwKHVpbnQgd2VpQW1vdW50LCB1aW50IHRva2VuQW1vdW50LCB1aW50IHdlaVJhaXNlZFRvdGFsLCB1aW50IHRva2Vuc1NvbGRUb3RhbCkgY29uc3RhbnQgcmV0dXJucyAoYm9vbCBsaW1pdEJyb2tlbikgewogICAgICAgIHJldHVybiB0b2tlbnNTb2xkVG90YWwgPiBtYXhpbXVtU2VsbGFibGVUb2tlbnM7CiAgICB9CgogICAgZnVuY3Rpb24gaXNCcmVha2luZ0ludmVzdG9yQ2FwKGFkZHJlc3MgYWRkciwgdWludCB0b2tlbkFtb3VudCkgY29uc3RhbnQgcmV0dXJucyAoYm9vbCBsaW1pdEJyb2tlbikgewogICAgICAgIGlmICghaXNXaGl0ZUxpc3RlZCkgdGhyb3c7CiAgICAgICAgdWludCBtYXhDYXAgPSBlYXJseVBhcnRpY2lwYW50V2hpdGVsaXN0W2FkZHJdLm1heENhcDsKICAgICAgICByZXR1cm4gKHRva2VuQW1vdW50T2ZbYWRkcl0ucGx1cyh0b2tlbkFtb3VudCkpID4gbWF4Q2FwOwogICAgfQoKICAgIGZ1bmN0aW9uIGlzQ3Jvd2RzYWxlRnVsbCgpIHB1YmxpYyBjb25zdGFudCByZXR1cm5zIChib29sKSB7CiAgICAgICAgcmV0dXJuIHRva2Vuc1NvbGQgPj0gbWF4aW11bVNlbGxhYmxlVG9rZW5zOwogICAgfQoKICAgIC8qKgogICAgICogRHluYW1pY2FsbHkgY3JlYXRlIHRva2VucyBhbmQgYXNzaWduIHRoZW0gdG8gdGhlIGludmVzdG9yLgogICAgICovCiAgICBmdW5jdGlvbiBhc3NpZ25Ub2tlbnMoYWRkcmVzcyByZWNlaXZlciwgdWludCB0b2tlbkFtb3VudCkgcHJpdmF0ZSB7CiAgICAgICAgQ3Jvd2RzYWxlVG9rZW5FeHQgbWludGFibGVUb2tlbiA9IENyb3dkc2FsZVRva2VuRXh0KHRva2VuKTsKICAgICAgICBtaW50YWJsZVRva2VuLm1pbnQocmVjZWl2ZXIsIHRva2VuQW1vdW50KTsKICAgIH0KCiAgICBmdW5jdGlvbiBzZXRNYXhpbXVtU2VsbGFibGVUb2tlbnModWludCB0b2tlbnMpIG9ubHlPd25lciB7CiAgICAgICAgaWYgKGZpbmFsaXplZCkgdGhyb3c7CgogICAgICAgIGlmICghaXNVcGRhdGFibGUpIHRocm93OwoKICAgICAgICBDcm93ZHNhbGVFeHQgbGFzdENyb3dkc2FsZUNudHJjdCA9IENyb3dkc2FsZUV4dChsYXN0Q3Jvd2RzYWxlKTsKICAgICAgICBpZiAobGFzdENyb3dkc2FsZUNudHJjdC5maW5hbGl6ZWQoKSkgdGhyb3c7CgogICAgICAgIG1heGltdW1TZWxsYWJsZVRva2VucyA9IHRva2VuczsKICAgICAgICBNYXhpbXVtU2VsbGFibGVUb2tlbnNDaGFuZ2VkKG1heGltdW1TZWxsYWJsZVRva2Vucyk7CiAgICB9Cn0KCi8qKgogKiBUaGlzIHNtYXJ0IGNvbnRyYWN0IGNvZGUgaXMgQ29weXJpZ2h0IDIwMTcgVG9rZW5NYXJrZXQgTHRkLiBGb3IgbW9yZSBpbmZvcm1hdGlvbiBzZWUgaHR0cHM6Ly90b2tlbm1hcmtldC5uZXQKICoKICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCB2ZXJzaW9uIDIuMDogaHR0cHM6Ly9naXRodWIuY29tL1Rva2VuTWFya2V0TmV0L2ljby9ibG9iL21hc3Rlci9MSUNFTlNFLnR4dAogKi8KCgoKLyoqCiAqIFNhZmUgdW5zaWduZWQgc2FmZSBtYXRoLgogKgogKiBodHRwczovL2Jsb2cuYXJhZ29uLm9uZS9saWJyYXJ5LWRyaXZlbi1kZXZlbG9wbWVudC1pbi1zb2xpZGl0eS0yYmViY2FmODg3MzYjLjc1MGd3dHdsaQogKgogKiBPcmlnaW5hbGx5IGZyb20gaHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL0FyYWdvbk9uZS96ZXBwZWxpbi1zb2xpZGl0eS9tYXN0ZXIvY29udHJhY3RzL1NhZmVNYXRoTGliLnNvbAogKgogKiBNYWludGFpbmVkIGhlcmUgdW50aWwgbWVyZ2VkIHRvIG1haW5saW5lIHplcHBlbGluLXNvbGlkaXR5LgogKgogKi8KbGlicmFyeSBTTWF0aExpYiB7CgogICAgZnVuY3Rpb24gdGltZXModWludCBhLCB1aW50IGIpIHJldHVybnMgKHVpbnQpIHsKICAgICAgICB1aW50IGMgPSBhICogYjsKICAgICAgICBhc3NlcnQoYSA9PSAwIHx8IGMgLyBhID09IGIpOwogICAgICAgIHJldHVybiBjOwogICAgfQoKICAgIGZ1bmN0aW9uIGRpdmlkZXModWludCBhLCB1aW50IGIpIHJldHVybnMgKHVpbnQpIHsKICAgICAgICBhc3NlcnQoYiA+IDApOwogICAgICAgIHVpbnQgYyA9IGEgLyBiOwogICAgICAgIGFzc2VydChhID09IGIgKiBjICsgYSAlIGIpOwogICAgICAgIHJldHVybiBjOwogICAgfQoKICAgIGZ1bmN0aW9uIG1pbnVzKHVpbnQgYSwgdWludCBiKSByZXR1cm5zICh1aW50KSB7CiAgICAgICAgYXNzZXJ0KGIgPD0gYSk7CiAgICAgICAgcmV0dXJuIGEgLSBiOwogICAgfQoKICAgIGZ1bmN0aW9uIHBsdXModWludCBhLCB1aW50IGIpIHJldHVybnMgKHVpbnQpIHsKICAgICAgICB1aW50IGMgPSBhICsgYjsKICAgICAgICBhc3NlcnQoYz49YSk7CiAgICAgICAgcmV0dXJuIGM7CiAgICB9Cgp9'.
	

]
