Class {
	#name : #SRT07307d0b136a79bac718f43388aed706389c4588,
	#superclass : #SRTContracts,
	#category : #SolidityTestingResources
}

{ #category : #base64 }
SRT07307d0b136a79bac718f43388aed706389c4588 >> base64 [
	^ 'Ly8gU3RyaW5nIFV0aWxzIHYwLjEKCi8vLyBAdGl0bGUgU3RyaW5nIFV0aWxzIC0gU3RyaW5nIHV0aWxpdHkgZnVuY3Rpb25zCi8vLyBAYXV0aG9yIFBpcGVyIE1lcnJpYW0gLSAKbGlicmFyeSBTdHJpbmdMaWIgewogICAgLyoKICAgICAqICBBZGRyZXNzOiAweDQ0M2I1MzU1OWQzMzcyNzczNzMxNzEyODBlYzU3MDI5NzE4MjAzZmIKICAgICAqLwoKICAgIC8vLyBAZGV2IENvbnZlcnRzIGFuIHVuc2lnbmVkIGludGVnZXJ0IHRvIGl0cyBzdHJpbmcgcmVwcmVzZW50YXRpb24uCiAgICAvLy8gQHBhcmFtIHYgVGhlIG51bWJlciB0byBiZSBjb252ZXJ0ZWQuCiAgICBmdW5jdGlvbiB1aW50VG9CeXRlcyh1aW50IHYpIGNvbnN0YW50IHJldHVybnMgKGJ5dGVzMzIgcmV0KSB7CiAgICAgICAgaWYgKHYgPT0gMCkgewogICAgICAgICAgICByZXQgPSAnMCc7CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgICB3aGlsZSAodiA+IDApIHsKICAgICAgICAgICAgICAgIHJldCA9IGJ5dGVzMzIodWludChyZXQpIC8gKDIgKiogOCkpOwogICAgICAgICAgICAgICAgcmV0IHw9IGJ5dGVzMzIoKCh2ICUgMTApICsgNDgpICogMiAqKiAoOCAqIDMxKSk7CiAgICAgICAgICAgICAgICB2IC89IDEwOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXQ7CiAgICB9CgogICAgLy8vIEBkZXYgQ29udmVydHMgYSBudW1lcmljIHN0cmluZyB0byBpdCdzIHVuc2lnbmVkIGludGVnZXIgcmVwcmVzZW50YXRpb24uCiAgICAvLy8gQHBhcmFtIHYgVGhlIHN0cmluZyB0byBiZSBjb252ZXJ0ZWQuCiAgICBmdW5jdGlvbiBieXRlc1RvVUludChieXRlczMyIHYpIGNvbnN0YW50IHJldHVybnMgKHVpbnQgcmV0KSB7CiAgICAgICAgaWYgKHYgPT0gMHgwKSB7CiAgICAgICAgICAgIHRocm93OwogICAgICAgIH0KCiAgICAgICAgdWludCBkaWdpdDsKCiAgICAgICAgZm9yICh1aW50IGkgPSAwOyBpIDwgMzI7IGkrKykgewogICAgICAgICAgICBkaWdpdCA9IHVpbnQoKHVpbnQodikgLyAoMiAqKiAoOCAqICgzMSAtIGkpKSkpICYgMHhmZik7CiAgICAgICAgICAgIGlmIChkaWdpdCA9PSAwKSB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmIChkaWdpdCA8IDQ4IHx8IGRpZ2l0ID4gNTcpIHsKICAgICAgICAgICAgICAgIHRocm93OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldCAqPSAxMDsKICAgICAgICAgICAgcmV0ICs9IChkaWdpdCAtIDQ4KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJldDsKICAgIH0KfQoKCi8vIEFjY291bnRpbmcgdjAuMSAobm90IHRoZSBzYW1lIGFzIHRoZSAwLjEgcmVsZWFzZSBvZiB0aGlzIGxpYnJhcnkpCgovLy8gQHRpdGxlIEFjY291bnRpbmcgTGliIC0gQWNjb3VudGluZyB1dGlsaXRpZXMKLy8vIEBhdXRob3IgUGlwZXIgTWVycmlhbSAtIApsaWJyYXJ5IEFjY291bnRpbmdMaWIgewogICAgICAgIC8qCiAgICAgICAgICogIEFkZHJlc3M6IDB4N2RlNjE1ZDhhNTE3NDZhOWYxMGY3MmE1OTNmYjViMzcxOGRjM2Q1MgogICAgICAgICAqLwogICAgICAgIHN0cnVjdCBCYW5rIHsKICAgICAgICAgICAgbWFwcGluZyAoYWRkcmVzcyA9PiB1aW50KSBhY2NvdW50QmFsYW5jZXM7CiAgICAgICAgfQoKICAgICAgICAvLy8gQGRldiBMb3cgbGV2ZWwgbWV0aG9kIGZvciBhZGRpbmcgZnVuZHMgdG8gYW4gYWNjb3VudC4gIFByb3RlY3RzIGFnYWluc3Qgb3ZlcmZsb3cuCiAgICAgICAgLy8vIEBwYXJhbSBzZWxmIFRoZSBCYW5rIGluc3RhbmNlIHRvIG9wZXJhdGUgb24uCiAgICAgICAgLy8vIEBwYXJhbSBhY2NvdW50QWRkcmVzcyBUaGUgYWRkcmVzcyBvZiB0aGUgYWNjb3VudCB0aGUgZnVuZHMgc2hvdWxkIGJlIGFkZGVkIHRvLgogICAgICAgIC8vLyBAcGFyYW0gdmFsdWUgVGhlIGFtb3VudCB0aGF0IHNob3VsZCBiZSBhZGRlZCB0byB0aGUgYWNjb3VudC4KICAgICAgICBmdW5jdGlvbiBhZGRGdW5kcyhCYW5rIHN0b3JhZ2Ugc2VsZiwgYWRkcmVzcyBhY2NvdW50QWRkcmVzcywgdWludCB2YWx1ZSkgcHVibGljIHsKICAgICAgICAgICAgICAgIGlmIChzZWxmLmFjY291bnRCYWxhbmNlc1thY2NvdW50QWRkcmVzc10gKyB2YWx1ZSA8IHNlbGYuYWNjb3VudEJhbGFuY2VzW2FjY291bnRBZGRyZXNzXSkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBQcmV2ZW50IE92ZXJmbG93LgogICAgICAgICAgICAgICAgICAgICAgICB0aHJvdzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHNlbGYuYWNjb3VudEJhbGFuY2VzW2FjY291bnRBZGRyZXNzXSArPSB2YWx1ZTsKICAgICAgICB9CgogICAgICAgIGV2ZW50IF9EZXBvc2l0KGFkZHJlc3MgaW5kZXhlZCBfZnJvbSwgYWRkcmVzcyBpbmRleGVkIGFjY291bnRBZGRyZXNzLCB1aW50IHZhbHVlKTsKICAgICAgICAvLy8gQGRldiBGdW5jdGlvbiB3cmFwcGVyIGFyb3VuZCB0aGUgX0RlcG9zaXQgZXZlbnQgc28gdGhhdCBpdCBjYW4gYmUgdXNlZCBieSBjb250cmFjdHMuICBDYW4gYmUgdXNlZCB0byBsb2cgYSBkZXBvc2l0IHRvIGFuIGFjY291bnQuCiAgICAgICAgLy8vIEBwYXJhbSBfZnJvbSBUaGUgYWRkcmVzcyB0aGF0IGRlcG9zaXRlZCB0aGUgZnVuZHMuCiAgICAgICAgLy8vIEBwYXJhbSBhY2NvdW50QWRkcmVzcyBUaGUgYWRkcmVzcyBvZiB0aGUgYWNjb3VudCB0aGUgZnVuZHMgd2VyZSBhZGRlZCB0by4KICAgICAgICAvLy8gQHBhcmFtIHZhbHVlIFRoZSBhbW91bnQgdGhhdCB3YXMgYWRkZWQgdG8gdGhlIGFjY291bnQuCiAgICAgICAgZnVuY3Rpb24gRGVwb3NpdChhZGRyZXNzIF9mcm9tLCBhZGRyZXNzIGFjY291bnRBZGRyZXNzLCB1aW50IHZhbHVlKSBwdWJsaWMgewogICAgICAgICAgICBfRGVwb3NpdChfZnJvbSwgYWNjb3VudEFkZHJlc3MsIHZhbHVlKTsKICAgICAgICB9CgoKICAgICAgICAvLy8gQGRldiBTYWZlIGZ1bmN0aW9uIGZvciBkZXBvc2l0aW5nIGZ1bmRzLiAgUmV0dXJucyBib29sZWFuIGZvciB3aGV0aGVyIHRoZSBkZXBvc2l0IHdhcyBzdWNjZXNzZnVsCiAgICAgICAgLy8vIEBwYXJhbSBzZWxmIFRoZSBCYW5rIGluc3RhbmNlIHRvIG9wZXJhdGUgb24uCiAgICAgICAgLy8vIEBwYXJhbSBhY2NvdW50QWRkcmVzcyBUaGUgYWRkcmVzcyBvZiB0aGUgYWNjb3VudCB0aGUgZnVuZHMgc2hvdWxkIGJlIGFkZGVkIHRvLgogICAgICAgIC8vLyBAcGFyYW0gdmFsdWUgVGhlIGFtb3VudCB0aGF0IHNob3VsZCBiZSBhZGRlZCB0byB0aGUgYWNjb3VudC4KICAgICAgICBmdW5jdGlvbiBkZXBvc2l0KEJhbmsgc3RvcmFnZSBzZWxmLCBhZGRyZXNzIGFjY291bnRBZGRyZXNzLCB1aW50IHZhbHVlKSBwdWJsaWMgcmV0dXJucyAoYm9vbCkgewogICAgICAgICAgICAgICAgYWRkRnVuZHMoc2VsZiwgYWNjb3VudEFkZHJlc3MsIHZhbHVlKTsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KCiAgICAgICAgZXZlbnQgX1dpdGhkcmF3YWwoYWRkcmVzcyBpbmRleGVkIGFjY291bnRBZGRyZXNzLCB1aW50IHZhbHVlKTsKCiAgICAgICAgLy8vIEBkZXYgRnVuY3Rpb24gd3JhcHBlciBhcm91bmQgdGhlIF9XaXRoZHJhd2FsIGV2ZW50IHNvIHRoYXQgaXQgY2FuIGJlIHVzZWQgYnkgY29udHJhY3RzLiAgQ2FuIGJlIHVzZWQgdG8gbG9nIGEgd2l0aGRyYXdsIGZyb20gYW4gYWNjb3VudC4KICAgICAgICAvLy8gQHBhcmFtIGFjY291bnRBZGRyZXNzIFRoZSBhZGRyZXNzIG9mIHRoZSBhY2NvdW50IHRoZSBmdW5kcyB3ZXJlIHdpdGhkcmF3biBmcm9tLgogICAgICAgIC8vLyBAcGFyYW0gdmFsdWUgVGhlIGFtb3VudCB0aGF0IHdhcyB3aXRoZHJhd24gdG8gdGhlIGFjY291bnQuCiAgICAgICAgZnVuY3Rpb24gV2l0aGRyYXdhbChhZGRyZXNzIGFjY291bnRBZGRyZXNzLCB1aW50IHZhbHVlKSBwdWJsaWMgewogICAgICAgICAgICBfV2l0aGRyYXdhbChhY2NvdW50QWRkcmVzcywgdmFsdWUpOwogICAgICAgIH0KCiAgICAgICAgZXZlbnQgX0luc3VmZmljaWVudEZ1bmRzKGFkZHJlc3MgaW5kZXhlZCBhY2NvdW50QWRkcmVzcywgdWludCB2YWx1ZSwgdWludCBiYWxhbmNlKTsKCiAgICAgICAgLy8vIEBkZXYgRnVuY3Rpb24gd3JhcHBlciBhcm91bmQgdGhlIF9JbnN1ZmZpY2llbnRGdW5kcyBldmVudCBzbyB0aGF0IGl0IGNhbiBiZSB1c2VkIGJ5IGNvbnRyYWN0cy4gIENhbiBiZSB1c2VkIHRvIGxvZyBhIGZhaWxlZCB3aXRoZHJhd2wgZnJvbSBhbiBhY2NvdW50LgogICAgICAgIC8vLyBAcGFyYW0gYWNjb3VudEFkZHJlc3MgVGhlIGFkZHJlc3Mgb2YgdGhlIGFjY291bnQgdGhlIGZ1bmRzIHdlcmUgdG8gYmUgd2l0aGRyYXduIGZyb20uCiAgICAgICAgLy8vIEBwYXJhbSB2YWx1ZSBUaGUgYW1vdW50IHRoYXQgd2FzIGF0dGVtcHRlZCB0byBiZSB3aXRoZHJhd24gZnJvbSB0aGUgYWNjb3VudC4KICAgICAgICAvLy8gQHBhcmFtIGJhbGFuY2UgVGhlIGN1cnJlbnQgYmFsYW5jZSBvZiB0aGUgYWNjb3VudC4KICAgICAgICBmdW5jdGlvbiBJbnN1ZmZpY2llbnRGdW5kcyhhZGRyZXNzIGFjY291bnRBZGRyZXNzLCB1aW50IHZhbHVlLCB1aW50IGJhbGFuY2UpIHB1YmxpYyB7CiAgICAgICAgICAgIF9JbnN1ZmZpY2llbnRGdW5kcyhhY2NvdW50QWRkcmVzcywgdmFsdWUsIGJhbGFuY2UpOwogICAgICAgIH0KCiAgICAgICAgLy8vIEBkZXYgTG93IGxldmVsIG1ldGhvZCBmb3IgcmVtb3ZpbmcgZnVuZHMgZnJvbSBhbiBhY2NvdW50LiAgUHJvdGVjdHMgYWdhaW5zdCB1bmRlcmZsb3cuCiAgICAgICAgLy8vIEBwYXJhbSBzZWxmIFRoZSBCYW5rIGluc3RhbmNlIHRvIG9wZXJhdGUgb24uCiAgICAgICAgLy8vIEBwYXJhbSBhY2NvdW50QWRkcmVzcyBUaGUgYWRkcmVzcyBvZiB0aGUgYWNjb3VudCB0aGUgZnVuZHMgc2hvdWxkIGJlIGRlZHVjdGVkIGZyb20uCiAgICAgICAgLy8vIEBwYXJhbSB2YWx1ZSBUaGUgYW1vdW50IHRoYXQgc2hvdWxkIGJlIGRlZHVjdGVkIGZyb20gdGhlIGFjY291bnQuCiAgICAgICAgZnVuY3Rpb24gZGVkdWN0RnVuZHMoQmFuayBzdG9yYWdlIHNlbGYsIGFkZHJlc3MgYWNjb3VudEFkZHJlc3MsIHVpbnQgdmFsdWUpIHB1YmxpYyB7CiAgICAgICAgICAgICAgICAvKgogICAgICAgICAgICAgICAgICogIEhlbHBlciBmdW5jdGlvbiB0aGF0IHNob3VsZCBiZSB1c2VkIGZvciBhbnkgcmVkdWN0aW9uIG9mCiAgICAgICAgICAgICAgICAgKiAgYWNjb3VudCBmdW5kcy4gIEl0IGhhcyBlcnJvciBjaGVja2luZyB0byBwcmV2ZW50CiAgICAgICAgICAgICAgICAgKiAgdW5kZXJmbG93aW5nIHRoZSBhY2NvdW50IGJhbGFuY2Ugd2hpY2ggd291bGQgYmUgUkVBTExZIGJhZC4KICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgaWYgKHZhbHVlID4gc2VsZi5hY2NvdW50QmFsYW5jZXNbYWNjb3VudEFkZHJlc3NdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFByZXZlbnQgVW5kZXJmbG93LgogICAgICAgICAgICAgICAgICAgICAgICB0aHJvdzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHNlbGYuYWNjb3VudEJhbGFuY2VzW2FjY291bnRBZGRyZXNzXSAtPSB2YWx1ZTsKICAgICAgICB9CgogICAgICAgIC8vLyBAZGV2IFNhZmUgZnVuY3Rpb24gZm9yIHdpdGhkcmF3aW5nIGZ1bmRzLiAgUmV0dXJucyBib29sZWFuIGZvciB3aGV0aGVyIHRoZSBkZXBvc2l0IHdhcyBzdWNjZXNzZnVsIGFzIHdlbGwgYXMgc2VuZGluZyB0aGUgYW1vdW50IGluIGV0aGVyIHRvIHRoZSBhY2NvdW50IGFkZHJlc3MuCiAgICAgICAgLy8vIEBwYXJhbSBzZWxmIFRoZSBCYW5rIGluc3RhbmNlIHRvIG9wZXJhdGUgb24uCiAgICAgICAgLy8vIEBwYXJhbSBhY2NvdW50QWRkcmVzcyBUaGUgYWRkcmVzcyBvZiB0aGUgYWNjb3VudCB0aGUgZnVuZHMgc2hvdWxkIGJlIHdpdGhkcmF3biBmcm9tLgogICAgICAgIC8vLyBAcGFyYW0gdmFsdWUgVGhlIGFtb3VudCB0aGF0IHNob3VsZCBiZSB3aXRoZHJhd24gZnJvbSB0aGUgYWNjb3VudC4KICAgICAgICBmdW5jdGlvbiB3aXRoZHJhdyhCYW5rIHN0b3JhZ2Ugc2VsZiwgYWRkcmVzcyBhY2NvdW50QWRkcmVzcywgdWludCB2YWx1ZSkgcHVibGljIHJldHVybnMgKGJvb2wpIHsKICAgICAgICAgICAgICAgIC8qCiAgICAgICAgICAgICAgICAgKiAgUHVibGljIEFQSSBmb3Igd2l0aGRyYXdpbmcgZnVuZHMuCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIGlmIChzZWxmLmFjY291bnRCYWxhbmNlc1thY2NvdW50QWRkcmVzc10gPj0gdmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZGVkdWN0RnVuZHMoc2VsZiwgYWNjb3VudEFkZHJlc3MsIHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFhY2NvdW50QWRkcmVzcy5zZW5kKHZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFBvdGVudGlhbGx5IHNlbmRpbmcgbW9uZXkgdG8gYSBjb250cmFjdCB0aGF0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gaGFzIGEgZmFsbGJhY2sgZnVuY3Rpb24uICBTbyBpbnN0ZWFkLCB0cnkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB0cmFuZmVycmluZyB0aGUgZnVuZHMgd2l0aCB0aGUgY2FsbCBhcGkuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFhY2NvdW50QWRkcmVzcy5jYWxsLnZhbHVlKHZhbHVlKSgpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBSZXZlcnQgdGhlIGVudGlyZSB0cmFuc2FjdGlvbi4gIE5vCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBuZWVkIHRvIGRlc3Ryb3kgdGhlIGZ1bmRzLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3c7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KfQoKLy8gR3JvdmUgdjAuMyAobm90IHRoZSBzYW1lIGFzIHRoZSAwLjMgcmVsZWFzZSBvZiB0aGlzIGxpYnJhcnkpCgoKLy8vIEB0aXRsZSBHcm92ZUxpYiAtIExpYnJhcnkgZm9yIHF1ZXJpYWJsZSBpbmRleGVkIG9yZGVyZWQgZGF0YS4KLy8vIEBhdXRob3IgUGlwZXJNZXJyaWFtIC0gCmxpYnJhcnkgR3JvdmVMaWIgewogICAgICAgIC8qCiAgICAgICAgICogIEluZGV4ZXMgZm9yIG9yZGVyZWQgZGF0YQogICAgICAgICAqCiAgICAgICAgICogIEFkZHJlc3M6IDB4OTIwYzg5MGE5MGRiOGZiYTc2MDQ4NjRiMGNmMzhlZTY2NzMzMTMyMwogICAgICAgICAqLwogICAgICAgIHN0cnVjdCBJbmRleCB7CiAgICAgICAgICAgICAgICBieXRlczMyIHJvb3Q7CiAgICAgICAgICAgICAgICBtYXBwaW5nIChieXRlczMyID0+IE5vZGUpIG5vZGVzOwogICAgICAgIH0KCiAgICAgICAgc3RydWN0IE5vZGUgewogICAgICAgICAgICAgICAgYnl0ZXMzMiBpZDsKICAgICAgICAgICAgICAgIGludCB2YWx1ZTsKICAgICAgICAgICAgICAgIGJ5dGVzMzIgcGFyZW50OwogICAgICAgICAgICAgICAgYnl0ZXMzMiBsZWZ0OwogICAgICAgICAgICAgICAgYnl0ZXMzMiByaWdodDsKICAgICAgICAgICAgICAgIHVpbnQgaGVpZ2h0OwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gbWF4KHVpbnQgYSwgdWludCBiKSBpbnRlcm5hbCByZXR1cm5zICh1aW50KSB7CiAgICAgICAgICAgIGlmIChhID49IGIpIHsKICAgICAgICAgICAgICAgIHJldHVybiBhOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBiOwogICAgICAgIH0KCiAgICAgICAgLyoKICAgICAgICAgKiAgTm9kZSBnZXR0ZXJzCiAgICAgICAgICovCiAgICAgICAgLy8vIEBkZXYgUmV0cmlldmUgdGhlIHVuaXF1ZSBpZGVudGlmaWVyIGZvciB0aGUgbm9kZS4KICAgICAgICAvLy8gQHBhcmFtIGluZGV4IFRoZSBpbmRleCB0aGF0IHRoZSBub2RlIGlzIHBhcnQgb2YuCiAgICAgICAgLy8vIEBwYXJhbSBpZCBUaGUgaWQgZm9yIHRoZSBub2RlIHRvIGJlIGxvb2tlZCB1cC4KICAgICAgICBmdW5jdGlvbiBnZXROb2RlSWQoSW5kZXggc3RvcmFnZSBpbmRleCwgYnl0ZXMzMiBpZCkgY29uc3RhbnQgcmV0dXJucyAoYnl0ZXMzMikgewogICAgICAgICAgICByZXR1cm4gaW5kZXgubm9kZXNbaWRdLmlkOwogICAgICAgIH0KCiAgICAgICAgLy8vIEBkZXYgUmV0cmlldmUgdGhlIHZhbHVlIGZvciB0aGUgbm9kZS4KICAgICAgICAvLy8gQHBhcmFtIGluZGV4IFRoZSBpbmRleCB0aGF0IHRoZSBub2RlIGlzIHBhcnQgb2YuCiAgICAgICAgLy8vIEBwYXJhbSBpZCBUaGUgaWQgZm9yIHRoZSBub2RlIHRvIGJlIGxvb2tlZCB1cC4KICAgICAgICBmdW5jdGlvbiBnZXROb2RlVmFsdWUoSW5kZXggc3RvcmFnZSBpbmRleCwgYnl0ZXMzMiBpZCkgY29uc3RhbnQgcmV0dXJucyAoaW50KSB7CiAgICAgICAgICAgIHJldHVybiBpbmRleC5ub2Rlc1tpZF0udmFsdWU7CiAgICAgICAgfQoKICAgICAgICAvLy8gQGRldiBSZXRyaWV2ZSB0aGUgaGVpZ2h0IG9mIHRoZSBub2RlLgogICAgICAgIC8vLyBAcGFyYW0gaW5kZXggVGhlIGluZGV4IHRoYXQgdGhlIG5vZGUgaXMgcGFydCBvZi4KICAgICAgICAvLy8gQHBhcmFtIGlkIFRoZSBpZCBmb3IgdGhlIG5vZGUgdG8gYmUgbG9va2VkIHVwLgogICAgICAgIGZ1bmN0aW9uIGdldE5vZGVIZWlnaHQoSW5kZXggc3RvcmFnZSBpbmRleCwgYnl0ZXMzMiBpZCkgY29uc3RhbnQgcmV0dXJucyAodWludCkgewogICAgICAgICAgICByZXR1cm4gaW5kZXgubm9kZXNbaWRdLmhlaWdodDsKICAgICAgICB9CgogICAgICAgIC8vLyBAZGV2IFJldHJpZXZlIHRoZSBwYXJlbnQgaWQgb2YgdGhlIG5vZGUuCiAgICAgICAgLy8vIEBwYXJhbSBpbmRleCBUaGUgaW5kZXggdGhhdCB0aGUgbm9kZSBpcyBwYXJ0IG9mLgogICAgICAgIC8vLyBAcGFyYW0gaWQgVGhlIGlkIGZvciB0aGUgbm9kZSB0byBiZSBsb29rZWQgdXAuCiAgICAgICAgZnVuY3Rpb24gZ2V0Tm9kZVBhcmVudChJbmRleCBzdG9yYWdlIGluZGV4LCBieXRlczMyIGlkKSBjb25zdGFudCByZXR1cm5zIChieXRlczMyKSB7CiAgICAgICAgICAgIHJldHVybiBpbmRleC5ub2Rlc1tpZF0ucGFyZW50OwogICAgICAgIH0KCiAgICAgICAgLy8vIEBkZXYgUmV0cmlldmUgdGhlIGxlZnQgY2hpbGQgaWQgb2YgdGhlIG5vZGUuCiAgICAgICAgLy8vIEBwYXJhbSBpbmRleCBUaGUgaW5kZXggdGhhdCB0aGUgbm9kZSBpcyBwYXJ0IG9mLgogICAgICAgIC8vLyBAcGFyYW0gaWQgVGhlIGlkIGZvciB0aGUgbm9kZSB0byBiZSBsb29rZWQgdXAuCiAgICAgICAgZnVuY3Rpb24gZ2V0Tm9kZUxlZnRDaGlsZChJbmRleCBzdG9yYWdlIGluZGV4LCBieXRlczMyIGlkKSBjb25zdGFudCByZXR1cm5zIChieXRlczMyKSB7CiAgICAgICAgICAgIHJldHVybiBpbmRleC5ub2Rlc1tpZF0ubGVmdDsKICAgICAgICB9CgogICAgICAgIC8vLyBAZGV2IFJldHJpZXZlIHRoZSByaWdodCBjaGlsZCBpZCBvZiB0aGUgbm9kZS4KICAgICAgICAvLy8gQHBhcmFtIGluZGV4IFRoZSBpbmRleCB0aGF0IHRoZSBub2RlIGlzIHBhcnQgb2YuCiAgICAgICAgLy8vIEBwYXJhbSBpZCBUaGUgaWQgZm9yIHRoZSBub2RlIHRvIGJlIGxvb2tlZCB1cC4KICAgICAgICBmdW5jdGlvbiBnZXROb2RlUmlnaHRDaGlsZChJbmRleCBzdG9yYWdlIGluZGV4LCBieXRlczMyIGlkKSBjb25zdGFudCByZXR1cm5zIChieXRlczMyKSB7CiAgICAgICAgICAgIHJldHVybiBpbmRleC5ub2Rlc1tpZF0ucmlnaHQ7CiAgICAgICAgfQoKICAgICAgICAvLy8gQGRldiBSZXRyaWV2ZSB0aGUgbm9kZSBpZCBvZiB0aGUgbmV4dCBub2RlIGluIHRoZSB0cmVlLgogICAgICAgIC8vLyBAcGFyYW0gaW5kZXggVGhlIGluZGV4IHRoYXQgdGhlIG5vZGUgaXMgcGFydCBvZi4KICAgICAgICAvLy8gQHBhcmFtIGlkIFRoZSBpZCBmb3IgdGhlIG5vZGUgdG8gYmUgbG9va2VkIHVwLgogICAgICAgIGZ1bmN0aW9uIGdldFByZXZpb3VzTm9kZShJbmRleCBzdG9yYWdlIGluZGV4LCBieXRlczMyIGlkKSBjb25zdGFudCByZXR1cm5zIChieXRlczMyKSB7CiAgICAgICAgICAgIE5vZGUgc3RvcmFnZSBjdXJyZW50Tm9kZSA9IGluZGV4Lm5vZGVzW2lkXTsKCiAgICAgICAgICAgIGlmIChjdXJyZW50Tm9kZS5pZCA9PSAweDApIHsKICAgICAgICAgICAgICAgIC8vIFVua25vd24gbm9kZSwganVzdCByZXR1cm4gMHgwOwogICAgICAgICAgICAgICAgcmV0dXJuIDB4MDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgTm9kZSBtZW1vcnkgY2hpbGQ7CgogICAgICAgICAgICBpZiAoY3VycmVudE5vZGUubGVmdCAhPSAweDApIHsKICAgICAgICAgICAgICAgIC8vIFRyYWNlIGxlZnQgdG8gbGF0ZXN0IGNoaWxkIGluIGxlZnQgdHJlZS4KICAgICAgICAgICAgICAgIGNoaWxkID0gaW5kZXgubm9kZXNbY3VycmVudE5vZGUubGVmdF07CgogICAgICAgICAgICAgICAgd2hpbGUgKGNoaWxkLnJpZ2h0ICE9IDApIHsKICAgICAgICAgICAgICAgICAgICBjaGlsZCA9IGluZGV4Lm5vZGVzW2NoaWxkLnJpZ2h0XTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBjaGlsZC5pZDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGN1cnJlbnROb2RlLnBhcmVudCAhPSAweDApIHsKICAgICAgICAgICAgICAgIC8vIE5vdyB3ZSB0cmFjZSBiYWNrIHVwIHRocm91Z2ggcGFyZW50IHJlbGF0aW9uc2hpcHMsIGxvb2tpbmcKICAgICAgICAgICAgICAgIC8vIGZvciBhIGxpbmsgd2hlcmUgdGhlIGNoaWxkIGlzIHRoZSByaWdodCBjaGlsZCBvZiBpdCdzCiAgICAgICAgICAgICAgICAvLyBwYXJlbnQuCiAgICAgICAgICAgICAgICBOb2RlIHN0b3JhZ2UgcGFyZW50ID0gaW5kZXgubm9kZXNbY3VycmVudE5vZGUucGFyZW50XTsKICAgICAgICAgICAgICAgIGNoaWxkID0gY3VycmVudE5vZGU7CgogICAgICAgICAgICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAocGFyZW50LnJpZ2h0ID09IGNoaWxkLmlkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBwYXJlbnQuaWQ7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpZiAocGFyZW50LnBhcmVudCA9PSAweDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGNoaWxkID0gcGFyZW50OwogICAgICAgICAgICAgICAgICAgIHBhcmVudCA9IGluZGV4Lm5vZGVzW3BhcmVudC5wYXJlbnRdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBUaGlzIGlzIHRoZSBmaXJzdCBub2RlLCBhbmQgaGFzIG5vIHByZXZpb3VzIG5vZGUuCiAgICAgICAgICAgIHJldHVybiAweDA7CiAgICAgICAgfQoKICAgICAgICAvLy8gQGRldiBSZXRyaWV2ZSB0aGUgbm9kZSBpZCBvZiB0aGUgcHJldmlvdXMgbm9kZSBpbiB0aGUgdHJlZS4KICAgICAgICAvLy8gQHBhcmFtIGluZGV4IFRoZSBpbmRleCB0aGF0IHRoZSBub2RlIGlzIHBhcnQgb2YuCiAgICAgICAgLy8vIEBwYXJhbSBpZCBUaGUgaWQgZm9yIHRoZSBub2RlIHRvIGJlIGxvb2tlZCB1cC4KICAgICAgICBmdW5jdGlvbiBnZXROZXh0Tm9kZShJbmRleCBzdG9yYWdlIGluZGV4LCBieXRlczMyIGlkKSBjb25zdGFudCByZXR1cm5zIChieXRlczMyKSB7CiAgICAgICAgICAgIE5vZGUgc3RvcmFnZSBjdXJyZW50Tm9kZSA9IGluZGV4Lm5vZGVzW2lkXTsKCiAgICAgICAgICAgIGlmIChjdXJyZW50Tm9kZS5pZCA9PSAweDApIHsKICAgICAgICAgICAgICAgIC8vIFVua25vd24gbm9kZSwganVzdCByZXR1cm4gMHgwOwogICAgICAgICAgICAgICAgcmV0dXJuIDB4MDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgTm9kZSBtZW1vcnkgY2hpbGQ7CgogICAgICAgICAgICBpZiAoY3VycmVudE5vZGUucmlnaHQgIT0gMHgwKSB7CiAgICAgICAgICAgICAgICAvLyBUcmFjZSByaWdodCB0byBlYXJsaWVzdCBjaGlsZCBpbiByaWdodCB0cmVlLgogICAgICAgICAgICAgICAgY2hpbGQgPSBpbmRleC5ub2Rlc1tjdXJyZW50Tm9kZS5yaWdodF07CgogICAgICAgICAgICAgICAgd2hpbGUgKGNoaWxkLmxlZnQgIT0gMCkgewogICAgICAgICAgICAgICAgICAgIGNoaWxkID0gaW5kZXgubm9kZXNbY2hpbGQubGVmdF07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gY2hpbGQuaWQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChjdXJyZW50Tm9kZS5wYXJlbnQgIT0gMHgwKSB7CiAgICAgICAgICAgICAgICAvLyBpZiB0aGUgbm9kZSBpcyB0aGUgbGVmdCBjaGlsZCBvZiBpdCdzIHBhcmVudCwgdGhlbiB0aGUKICAgICAgICAgICAgICAgIC8vIHBhcmVudCBpcyB0aGUgbmV4dCBvbmUuCiAgICAgICAgICAgICAgICBOb2RlIHN0b3JhZ2UgcGFyZW50ID0gaW5kZXgubm9kZXNbY3VycmVudE5vZGUucGFyZW50XTsKICAgICAgICAgICAgICAgIGNoaWxkID0gY3VycmVudE5vZGU7CgogICAgICAgICAgICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAocGFyZW50LmxlZnQgPT0gY2hpbGQuaWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBhcmVudC5pZDsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmIChwYXJlbnQucGFyZW50ID09IDB4MCkgewogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgY2hpbGQgPSBwYXJlbnQ7CiAgICAgICAgICAgICAgICAgICAgcGFyZW50ID0gaW5kZXgubm9kZXNbcGFyZW50LnBhcmVudF07CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gTm93IHdlIG5lZWQgdG8gdHJhY2UgYWxsIHRoZSB3YXkgdXAgY2hlY2tpbmcgdG8gc2VlIGlmIGFueSBwYXJlbnQgaXMgdGhlIAogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBUaGlzIGlzIHRoZSBmaW5hbCBub2RlLgogICAgICAgICAgICByZXR1cm4gMHgwOwogICAgICAgIH0KCgogICAgICAgIC8vLyBAZGV2IFVwZGF0ZXMgb3IgSW5zZXJ0cyB0aGUgaWQgaW50byB0aGUgaW5kZXggYXQgaXRzIGFwcHJvcHJpYXRlIGxvY2F0aW9uIGJhc2VkIG9uIHRoZSB2YWx1ZSBwcm92aWRlZC4KICAgICAgICAvLy8gQHBhcmFtIGluZGV4IFRoZSBpbmRleCB0aGF0IHRoZSBub2RlIGlzIHBhcnQgb2YuCiAgICAgICAgLy8vIEBwYXJhbSBpZCBUaGUgdW5pcXVlIGlkZW50aWZpZXIgb2YgdGhlIGRhdGEgZWxlbWVudCB0aGUgaW5kZXggbm9kZSB3aWxsIHJlcHJlc2VudC4KICAgICAgICAvLy8gQHBhcmFtIHZhbHVlIFRoZSB2YWx1ZSBvZiB0aGUgZGF0YSBlbGVtZW50IHRoYXQgcmVwcmVzZW50cyBpdCdzIHRvdGFsIG9yZGVyaW5nIHdpdGggcmVzcGVjdCB0byBvdGhlciBlbGVtZW50ZXMuCiAgICAgICAgZnVuY3Rpb24gaW5zZXJ0KEluZGV4IHN0b3JhZ2UgaW5kZXgsIGJ5dGVzMzIgaWQsIGludCB2YWx1ZSkgcHVibGljIHsKICAgICAgICAgICAgICAgIGlmIChpbmRleC5ub2Rlc1tpZF0uaWQgPT0gaWQpIHsKICAgICAgICAgICAgICAgICAgICAvLyBBIG5vZGUgd2l0aCB0aGlzIGlkIGFscmVhZHkgZXhpc3RzLiAgSWYgdGhlIHZhbHVlIGlzCiAgICAgICAgICAgICAgICAgICAgLy8gdGhlIHNhbWUsIHRoZW4ganVzdCByZXR1cm4gZWFybHksIG90aGVyd2lzZSwgcmVtb3ZlIGl0CiAgICAgICAgICAgICAgICAgICAgLy8gYW5kIHJlaW5zZXJ0IGl0LgogICAgICAgICAgICAgICAgICAgIGlmIChpbmRleC5ub2Rlc1tpZF0udmFsdWUgPT0gdmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZW1vdmUoaW5kZXgsIGlkKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB1aW50IGxlZnRIZWlnaHQ7CiAgICAgICAgICAgICAgICB1aW50IHJpZ2h0SGVpZ2h0OwoKICAgICAgICAgICAgICAgIGJ5dGVzMzIgcHJldmlvdXNOb2RlSWQgPSAweDA7CgogICAgICAgICAgICAgICAgaWYgKGluZGV4LnJvb3QgPT0gMHgwKSB7CiAgICAgICAgICAgICAgICAgICAgaW5kZXgucm9vdCA9IGlkOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgTm9kZSBzdG9yYWdlIGN1cnJlbnROb2RlID0gaW5kZXgubm9kZXNbaW5kZXgucm9vdF07CgogICAgICAgICAgICAgICAgLy8gRG8gaW5zZXJ0aW9uCiAgICAgICAgICAgICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgICAgICAgICAgICAgIGlmIChjdXJyZW50Tm9kZS5pZCA9PSAweDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyBpcyBhIG5ldyB1bnBvcHVsYXRlZCBub2RlLgogICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50Tm9kZS5pZCA9IGlkOwogICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50Tm9kZS5wYXJlbnQgPSBwcmV2aW91c05vZGVJZDsKICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudE5vZGUudmFsdWUgPSB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBTZXQgdGhlIHByZXZpb3VzIG5vZGUgaWQuCiAgICAgICAgICAgICAgICAgICAgcHJldmlvdXNOb2RlSWQgPSBjdXJyZW50Tm9kZS5pZDsKCiAgICAgICAgICAgICAgICAgICAgLy8gVGhlIG5ldyBub2RlIGJlbG9uZ3MgaW4gdGhlIHJpZ2h0IHN1YnRyZWUKICAgICAgICAgICAgICAgICAgICBpZiAodmFsdWUgPj0gY3VycmVudE5vZGUudmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGN1cnJlbnROb2RlLnJpZ2h0ID09IDB4MCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudE5vZGUucmlnaHQgPSBpZDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50Tm9kZSA9IGluZGV4Lm5vZGVzW2N1cnJlbnROb2RlLnJpZ2h0XTsKICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBUaGUgbmV3IG5vZGUgYmVsb25ncyBpbiB0aGUgbGVmdCBzdWJ0cmVlLgogICAgICAgICAgICAgICAgICAgIGlmIChjdXJyZW50Tm9kZS5sZWZ0ID09IDB4MCkgewogICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50Tm9kZS5sZWZ0ID0gaWQ7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlID0gaW5kZXgubm9kZXNbY3VycmVudE5vZGUubGVmdF07CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gUmViYWxhbmNlIHRoZSB0cmVlCiAgICAgICAgICAgICAgICBfcmViYWxhbmNlVHJlZShpbmRleCwgY3VycmVudE5vZGUuaWQpOwogICAgICAgIH0KCiAgICAgICAgLy8vIEBkZXYgQ2hlY2tzIHdoZXRoZXIgYSBub2RlIGZvciB0aGUgZ2l2ZW4gdW5pcXVlIGlkZW50aWZpZXIgZXhpc3RzIHdpdGhpbiB0aGUgZ2l2ZW4gaW5kZXguCiAgICAgICAgLy8vIEBwYXJhbSBpbmRleCBUaGUgaW5kZXggdGhhdCBzaG91bGQgYmUgc2VhcmNoZWQKICAgICAgICAvLy8gQHBhcmFtIGlkIFRoZSB1bmlxdWUgaWRlbnRpZmllciBvZiB0aGUgZGF0YSBlbGVtZW50IHRvIGNoZWNrIGZvci4KICAgICAgICBmdW5jdGlvbiBleGlzdHMoSW5kZXggc3RvcmFnZSBpbmRleCwgYnl0ZXMzMiBpZCkgY29uc3RhbnQgcmV0dXJucyAoYm9vbCkgewogICAgICAgICAgICByZXR1cm4gKGluZGV4Lm5vZGVzW2lkXS5pZCA9PSBpZCk7CiAgICAgICAgfQoKICAgICAgICAvLy8gQGRldiBSZW1vdmUgdGhlIG5vZGUgZm9yIHRoZSBnaXZlbiB1bmlxdWUgaWRlbnRpZmllciBmcm9tIHRoZSBpbmRleC4KICAgICAgICAvLy8gQHBhcmFtIGluZGV4IFRoZSBpbmRleCB0aGF0IHNob3VsZCBiZSByZW1vdmVkCiAgICAgICAgLy8vIEBwYXJhbSBpZCBUaGUgdW5pcXVlIGlkZW50aWZpZXIgb2YgdGhlIGRhdGEgZWxlbWVudCB0byByZW1vdmUuCiAgICAgICAgZnVuY3Rpb24gcmVtb3ZlKEluZGV4IHN0b3JhZ2UgaW5kZXgsIGJ5dGVzMzIgaWQpIHB1YmxpYyB7CiAgICAgICAgICAgIE5vZGUgc3RvcmFnZSByZXBsYWNlbWVudE5vZGU7CiAgICAgICAgICAgIE5vZGUgc3RvcmFnZSBwYXJlbnQ7CiAgICAgICAgICAgIE5vZGUgc3RvcmFnZSBjaGlsZDsKICAgICAgICAgICAgYnl0ZXMzMiByZWJhbGFuY2VPcmlnaW47CgogICAgICAgICAgICBOb2RlIHN0b3JhZ2Ugbm9kZVRvRGVsZXRlID0gaW5kZXgubm9kZXNbaWRdOwoKICAgICAgICAgICAgaWYgKG5vZGVUb0RlbGV0ZS5pZCAhPSBpZCkgewogICAgICAgICAgICAgICAgLy8gVGhlIGlkIGRvZXMgbm90IGV4aXN0IGluIHRoZSB0cmVlLgogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAobm9kZVRvRGVsZXRlLmxlZnQgIT0gMHgwIHx8IG5vZGVUb0RlbGV0ZS5yaWdodCAhPSAweDApIHsKICAgICAgICAgICAgICAgIC8vIFRoaXMgbm9kZSBpcyBub3QgYSBsZWFmIG5vZGUgYW5kIHRodXMgbXVzdCByZXBsYWNlIGl0c2VsZiBpbgogICAgICAgICAgICAgICAgLy8gaXQncyB0cmVlIGJ5IGVpdGhlciB0aGUgcHJldmlvdXMgb3IgbmV4dCBub2RlLgogICAgICAgICAgICAgICAgaWYgKG5vZGVUb0RlbGV0ZS5sZWZ0ICE9IDB4MCkgewogICAgICAgICAgICAgICAgICAgIC8vIFRoaXMgbm9kZSBpcyBndWFyYW50ZWVkIHRvIG5vdCBoYXZlIGEgcmlnaHQgY2hpbGQuCiAgICAgICAgICAgICAgICAgICAgcmVwbGFjZW1lbnROb2RlID0gaW5kZXgubm9kZXNbZ2V0UHJldmlvdXNOb2RlKGluZGV4LCBub2RlVG9EZWxldGUuaWQpXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgIC8vIFRoaXMgbm9kZSBpcyBndWFyYW50ZWVkIHRvIG5vdCBoYXZlIGEgbGVmdCBjaGlsZC4KICAgICAgICAgICAgICAgICAgICByZXBsYWNlbWVudE5vZGUgPSBpbmRleC5ub2Rlc1tnZXROZXh0Tm9kZShpbmRleCwgbm9kZVRvRGVsZXRlLmlkKV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyBUaGUgcmVwbGFjZW1lbnROb2RlIGlzIGd1YXJhbnRlZWQgdG8gaGF2ZSBhIHBhcmVudC4KICAgICAgICAgICAgICAgIHBhcmVudCA9IGluZGV4Lm5vZGVzW3JlcGxhY2VtZW50Tm9kZS5wYXJlbnRdOwoKICAgICAgICAgICAgICAgIC8vIEtlZXAgbm90ZSBvZiB0aGUgbG9jYXRpb24gdGhhdCBvdXIgdHJlZSByZWJhbGFuY2luZyBzaG91bGQKICAgICAgICAgICAgICAgIC8vIHN0YXJ0IGF0LgogICAgICAgICAgICAgICAgcmViYWxhbmNlT3JpZ2luID0gcmVwbGFjZW1lbnROb2RlLmlkOwoKICAgICAgICAgICAgICAgIC8vIEpvaW4gdGhlIHBhcmVudCBvZiB0aGUgcmVwbGFjZW1lbnQgbm9kZSB3aXRoIGFueSBzdWJ0cmVlIG9mCiAgICAgICAgICAgICAgICAvLyB0aGUgcmVwbGFjZW1lbnQgbm9kZS4gIFdlIGNhbiBndWFyYW50ZWUgdGhhdCB0aGUgcmVwbGFjZW1lbnQKICAgICAgICAgICAgICAgIC8vIG5vZGUgaGFzIGF0IG1vc3Qgb25lIHN1YnRyZWUgYmVjYXVzZSBvZiBob3cgZ2V0TmV4dE5vZGUgYW5kCiAgICAgICAgICAgICAgICAvLyBnZXRQcmV2aW91c05vZGUgYXJlIHVzZWQuCiAgICAgICAgICAgICAgICBpZiAocGFyZW50LmxlZnQgPT0gcmVwbGFjZW1lbnROb2RlLmlkKSB7CiAgICAgICAgICAgICAgICAgICAgcGFyZW50LmxlZnQgPSByZXBsYWNlbWVudE5vZGUucmlnaHQ7CiAgICAgICAgICAgICAgICAgICAgaWYgKHJlcGxhY2VtZW50Tm9kZS5yaWdodCAhPSAweDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGQgPSBpbmRleC5ub2Rlc1tyZXBsYWNlbWVudE5vZGUucmlnaHRdOwogICAgICAgICAgICAgICAgICAgICAgICBjaGlsZC5wYXJlbnQgPSBwYXJlbnQuaWQ7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHBhcmVudC5yaWdodCA9PSByZXBsYWNlbWVudE5vZGUuaWQpIHsKICAgICAgICAgICAgICAgICAgICBwYXJlbnQucmlnaHQgPSByZXBsYWNlbWVudE5vZGUubGVmdDsKICAgICAgICAgICAgICAgICAgICBpZiAocmVwbGFjZW1lbnROb2RlLmxlZnQgIT0gMHgwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkID0gaW5kZXgubm9kZXNbcmVwbGFjZW1lbnROb2RlLmxlZnRdOwogICAgICAgICAgICAgICAgICAgICAgICBjaGlsZC5wYXJlbnQgPSBwYXJlbnQuaWQ7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIE5vdyB3ZSByZXBsYWNlIHRoZSBub2RlVG9EZWxldGUgd2l0aCB0aGUgcmVwbGFjZW1lbnROb2RlLgogICAgICAgICAgICAgICAgLy8gVGhpcyBpbmNsdWRlcyBwYXJlbnQvY2hpbGQgcmVsYXRpb25zaGlwcyBmb3IgYWxsIG9mIHRoZQogICAgICAgICAgICAgICAgLy8gcGFyZW50LCB0aGUgbGVmdCBjaGlsZCwgYW5kIHRoZSByaWdodCBjaGlsZC4KICAgICAgICAgICAgICAgIHJlcGxhY2VtZW50Tm9kZS5wYXJlbnQgPSBub2RlVG9EZWxldGUucGFyZW50OwogICAgICAgICAgICAgICAgaWYgKG5vZGVUb0RlbGV0ZS5wYXJlbnQgIT0gMHgwKSB7CiAgICAgICAgICAgICAgICAgICAgcGFyZW50ID0gaW5kZXgubm9kZXNbbm9kZVRvRGVsZXRlLnBhcmVudF07CiAgICAgICAgICAgICAgICAgICAgaWYgKHBhcmVudC5sZWZ0ID09IG5vZGVUb0RlbGV0ZS5pZCkgewogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQubGVmdCA9IHJlcGxhY2VtZW50Tm9kZS5pZDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKHBhcmVudC5yaWdodCA9PSBub2RlVG9EZWxldGUuaWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50LnJpZ2h0ID0gcmVwbGFjZW1lbnROb2RlLmlkOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgIC8vIElmIHRoZSBub2RlIHdlIGFyZSBkZWxldGluZyBpcyB0aGUgcm9vdCBub2RlIHVwZGF0ZSB0aGUKICAgICAgICAgICAgICAgICAgICAvLyBpbmRleCByb290IG5vZGUgcG9pbnRlci4KICAgICAgICAgICAgICAgICAgICBpbmRleC5yb290ID0gcmVwbGFjZW1lbnROb2RlLmlkOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJlcGxhY2VtZW50Tm9kZS5sZWZ0ID0gbm9kZVRvRGVsZXRlLmxlZnQ7CiAgICAgICAgICAgICAgICBpZiAobm9kZVRvRGVsZXRlLmxlZnQgIT0gMHgwKSB7CiAgICAgICAgICAgICAgICAgICAgY2hpbGQgPSBpbmRleC5ub2Rlc1tub2RlVG9EZWxldGUubGVmdF07CiAgICAgICAgICAgICAgICAgICAgY2hpbGQucGFyZW50ID0gcmVwbGFjZW1lbnROb2RlLmlkOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJlcGxhY2VtZW50Tm9kZS5yaWdodCA9IG5vZGVUb0RlbGV0ZS5yaWdodDsKICAgICAgICAgICAgICAgIGlmIChub2RlVG9EZWxldGUucmlnaHQgIT0gMHgwKSB7CiAgICAgICAgICAgICAgICAgICAgY2hpbGQgPSBpbmRleC5ub2Rlc1tub2RlVG9EZWxldGUucmlnaHRdOwogICAgICAgICAgICAgICAgICAgIGNoaWxkLnBhcmVudCA9IHJlcGxhY2VtZW50Tm9kZS5pZDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmIChub2RlVG9EZWxldGUucGFyZW50ICE9IDB4MCkgewogICAgICAgICAgICAgICAgLy8gVGhlIG5vZGUgYmVpbmcgZGVsZXRlZCBpcyBhIGxlYWYgbm9kZSBzbyB3ZSBvbmx5IGVyYXNlIGl0J3MKICAgICAgICAgICAgICAgIC8vIHBhcmVudCBsaW5rYWdlLgogICAgICAgICAgICAgICAgcGFyZW50ID0gaW5kZXgubm9kZXNbbm9kZVRvRGVsZXRlLnBhcmVudF07CgogICAgICAgICAgICAgICAgaWYgKHBhcmVudC5sZWZ0ID09IG5vZGVUb0RlbGV0ZS5pZCkgewogICAgICAgICAgICAgICAgICAgIHBhcmVudC5sZWZ0ID0gMHgwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHBhcmVudC5yaWdodCA9PSBub2RlVG9EZWxldGUuaWQpIHsKICAgICAgICAgICAgICAgICAgICBwYXJlbnQucmlnaHQgPSAweDA7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8ga2VlcCBub3RlIG9mIHdoZXJlIHRoZSByZWJhbGFuY2luZyBzaG91bGQgYmVnaW4uCiAgICAgICAgICAgICAgICByZWJhbGFuY2VPcmlnaW4gPSBwYXJlbnQuaWQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBUaGlzIGlzIGJvdGggYSBsZWFmIG5vZGUgYW5kIHRoZSByb290IG5vZGUsIHNvIHdlIG5lZWQgdG8KICAgICAgICAgICAgICAgIC8vIHVuc2V0IHRoZSByb290IG5vZGUgcG9pbnRlci4KICAgICAgICAgICAgICAgIGluZGV4LnJvb3QgPSAweDA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIE5vdyB3ZSB6ZXJvIG91dCBhbGwgb2YgdGhlIGZpZWxkcyBvbiB0aGUgbm9kZVRvRGVsZXRlLgogICAgICAgICAgICBub2RlVG9EZWxldGUuaWQgPSAweDA7CiAgICAgICAgICAgIG5vZGVUb0RlbGV0ZS52YWx1ZSA9IDA7CiAgICAgICAgICAgIG5vZGVUb0RlbGV0ZS5wYXJlbnQgPSAweDA7CiAgICAgICAgICAgIG5vZGVUb0RlbGV0ZS5sZWZ0ID0gMHgwOwogICAgICAgICAgICBub2RlVG9EZWxldGUucmlnaHQgPSAweDA7CgogICAgICAgICAgICAvLyBXYWxrIGJhY2sgdXAgdGhlIHRyZWUgcmViYWxhbmNpbmcKICAgICAgICAgICAgaWYgKHJlYmFsYW5jZU9yaWdpbiAhPSAweDApIHsKICAgICAgICAgICAgICAgIF9yZWJhbGFuY2VUcmVlKGluZGV4LCByZWJhbGFuY2VPcmlnaW4pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBieXRlczIgY29uc3RhbnQgR1QgPSAiPiI7CiAgICAgICAgYnl0ZXMyIGNvbnN0YW50IExUID0gIjwiOwogICAgICAgIGJ5dGVzMiBjb25zdGFudCBHVEUgPSAiPj0iOwogICAgICAgIGJ5dGVzMiBjb25zdGFudCBMVEUgPSAiPD0iOwogICAgICAgIGJ5dGVzMiBjb25zdGFudCBFUSA9ICI9PSI7CgogICAgICAgIGZ1bmN0aW9uIF9jb21wYXJlKGludCBsZWZ0LCBieXRlczIgb3BlcmF0b3IsIGludCByaWdodCkgaW50ZXJuYWwgcmV0dXJucyAoYm9vbCkgewogICAgICAgICAgICBpZiAob3BlcmF0b3IgPT0gR1QpIHsKICAgICAgICAgICAgICAgIHJldHVybiAobGVmdCA+IHJpZ2h0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAob3BlcmF0b3IgPT0gTFQpIHsKICAgICAgICAgICAgICAgIHJldHVybiAobGVmdCA8IHJpZ2h0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAob3BlcmF0b3IgPT0gR1RFKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gKGxlZnQgPj0gcmlnaHQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChvcGVyYXRvciA9PSBMVEUpIHsKICAgICAgICAgICAgICAgIHJldHVybiAobGVmdCA8PSByaWdodCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG9wZXJhdG9yID09IEVRKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gKGxlZnQgPT0gcmlnaHQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBJbnZhbGlkIG9wZXJhdG9yLgogICAgICAgICAgICB0aHJvdzsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIF9nZXRNYXhpbXVtKEluZGV4IHN0b3JhZ2UgaW5kZXgsIGJ5dGVzMzIgaWQpIGludGVybmFsIHJldHVybnMgKGludCkgewogICAgICAgICAgICAgICAgTm9kZSBzdG9yYWdlIGN1cnJlbnROb2RlID0gaW5kZXgubm9kZXNbaWRdOwoKICAgICAgICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGN1cnJlbnROb2RlLnJpZ2h0ID09IDB4MCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY3VycmVudE5vZGUudmFsdWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlID0gaW5kZXgubm9kZXNbY3VycmVudE5vZGUucmlnaHRdOwogICAgICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gX2dldE1pbmltdW0oSW5kZXggc3RvcmFnZSBpbmRleCwgYnl0ZXMzMiBpZCkgaW50ZXJuYWwgcmV0dXJucyAoaW50KSB7CiAgICAgICAgICAgICAgICBOb2RlIHN0b3JhZ2UgY3VycmVudE5vZGUgPSBpbmRleC5ub2Rlc1tpZF07CgogICAgICAgICAgICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudE5vZGUubGVmdCA9PSAweDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnROb2RlLnZhbHVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBjdXJyZW50Tm9kZSA9IGluZGV4Lm5vZGVzW2N1cnJlbnROb2RlLmxlZnRdOwogICAgICAgICAgICAgICAgfQogICAgICAgIH0KCgogICAgICAgIC8qKiBAZGV2IFF1ZXJ5IHRoZSBpbmRleCBmb3IgdGhlIGVkZ2UtbW9zdCBub2RlIHRoYXQgc2F0aXNmaWVzIHRoZQogICAgICAgICAqICBnaXZlbiBxdWVyeS4gIEZvciA+LCA+PSwgYW5kID09LCB0aGlzIHdpbGwgYmUgdGhlIGxlZnQtbW9zdCBub2RlCiAgICAgICAgICogIHRoYXQgc2F0aXNmaWVzIHRoZSBjb21wYXJpc29uLiAgRm9yIDwgYW5kIDw9IHRoaXMgd2lsbCBiZSB0aGUKICAgICAgICAgKiAgcmlnaHQtbW9zdCBub2RlIHRoYXQgc2F0aXNmaWVzIHRoZSBjb21wYXJpc29uLgogICAgICAgICAqLwogICAgICAgIC8vLyBAcGFyYW0gaW5kZXggVGhlIGluZGV4IHRoYXQgc2hvdWxkIGJlIHF1ZXJpZWQKICAgICAgICAvKiogQHBhcmFtIG9wZXJhdG9yIE9uZSBvZiAnPicsICc+PScsICc8JywgJzw9JywgJz09JyB0byBzcGVjaWZ5IHdoYXQKICAgICAgICAgKiAgdHlwZSBvZiBjb21wYXJpc29uIG9wZXJhdG9yIHNob3VsZCBiZSB1c2VkLgogICAgICAgICAqLwogICAgICAgIGZ1bmN0aW9uIHF1ZXJ5KEluZGV4IHN0b3JhZ2UgaW5kZXgsIGJ5dGVzMiBvcGVyYXRvciwgaW50IHZhbHVlKSBwdWJsaWMgcmV0dXJucyAoYnl0ZXMzMikgewogICAgICAgICAgICAgICAgYnl0ZXMzMiByb290Tm9kZUlkID0gaW5kZXgucm9vdDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHJvb3ROb2RlSWQgPT0gMHgwKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gRW1wdHkgdHJlZS4KICAgICAgICAgICAgICAgICAgICByZXR1cm4gMHgwOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIE5vZGUgc3RvcmFnZSBjdXJyZW50Tm9kZSA9IGluZGV4Lm5vZGVzW3Jvb3ROb2RlSWRdOwoKICAgICAgICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKF9jb21wYXJlKGN1cnJlbnROb2RlLnZhbHVlLCBvcGVyYXRvciwgdmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFdlIGhhdmUgZm91bmQgYSBtYXRjaCBidXQgaXQgbWlnaHQgbm90IGJlIHRoZQogICAgICAgICAgICAgICAgICAgICAgICAvLyAqY29ycmVjdCogbWF0Y2guCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgob3BlcmF0b3IgPT0gTFQpIHx8IChvcGVyYXRvciA9PSBMVEUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBOZWVkIHRvIGtlZXAgdHJhdmVyc2luZyByaWdodCB1bnRpbCB0aGlzIGlzIG5vCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBsb25nZXIgdHJ1ZS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjdXJyZW50Tm9kZS5yaWdodCA9PSAweDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY3VycmVudE5vZGUuaWQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoX2NvbXBhcmUoX2dldE1pbmltdW0oaW5kZXgsIGN1cnJlbnROb2RlLnJpZ2h0KSwgb3BlcmF0b3IsIHZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRoZXJlIGFyZSBzdGlsbCBub2RlcyB0byB0aGUgcmlnaHQgdGhhdAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIG1hdGNoLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlID0gaW5kZXgubm9kZXNbY3VycmVudE5vZGUucmlnaHRdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnROb2RlLmlkOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoKG9wZXJhdG9yID09IEdUKSB8fCAob3BlcmF0b3IgPT0gR1RFKSB8fCAob3BlcmF0b3IgPT0gRVEpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBOZWVkIHRvIGtlZXAgdHJhdmVyc2luZyBsZWZ0IHVudGlsIHRoaXMgaXMgbm8KICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGxvbmdlciB0cnVlLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGN1cnJlbnROb2RlLmxlZnQgPT0gMHgwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnROb2RlLmlkOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKF9jb21wYXJlKF9nZXRNYXhpbXVtKGluZGV4LCBjdXJyZW50Tm9kZS5sZWZ0KSwgb3BlcmF0b3IsIHZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlID0gaW5kZXgubm9kZXNbY3VycmVudE5vZGUubGVmdF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY3VycmVudE5vZGUuaWQ7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmICgob3BlcmF0b3IgPT0gTFQpIHx8IChvcGVyYXRvciA9PSBMVEUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjdXJyZW50Tm9kZS5sZWZ0ID09IDB4MCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVGhlcmUgYXJlIG5vIG5vZGVzIHRoYXQgYXJlIGxlc3MgdGhhbiB0aGUgdmFsdWUKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHNvIHJldHVybiBudWxsLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDB4MDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50Tm9kZSA9IGluZGV4Lm5vZGVzW2N1cnJlbnROb2RlLmxlZnRdOwogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmICgob3BlcmF0b3IgPT0gR1QpIHx8IChvcGVyYXRvciA9PSBHVEUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjdXJyZW50Tm9kZS5yaWdodCA9PSAweDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRoZXJlIGFyZSBubyBub2RlcyB0aGF0IGFyZSBncmVhdGVyIHRoYW4gdGhlIHZhbHVlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBzbyByZXR1cm4gbnVsbC4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAweDA7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudE5vZGUgPSBpbmRleC5ub2Rlc1tjdXJyZW50Tm9kZS5yaWdodF07CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKG9wZXJhdG9yID09IEVRKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjdXJyZW50Tm9kZS52YWx1ZSA8IHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudE5vZGUucmlnaHQgPT0gMHgwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDB4MDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlID0gaW5kZXgubm9kZXNbY3VycmVudE5vZGUucmlnaHRdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjdXJyZW50Tm9kZS52YWx1ZSA+IHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudE5vZGUubGVmdCA9PSAweDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gMHgwOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudE5vZGUgPSBpbmRleC5ub2Rlc1tjdXJyZW50Tm9kZS5sZWZ0XTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gX3JlYmFsYW5jZVRyZWUoSW5kZXggc3RvcmFnZSBpbmRleCwgYnl0ZXMzMiBpZCkgaW50ZXJuYWwgewogICAgICAgICAgICAvLyBUcmFjZSBiYWNrIHVwIHJlYmFsYW5jaW5nIHRoZSB0cmVlIGFuZCB1cGRhdGluZyBoZWlnaHRzIGFzCiAgICAgICAgICAgIC8vIG5lZWRlZC4uCiAgICAgICAgICAgIE5vZGUgc3RvcmFnZSBjdXJyZW50Tm9kZSA9IGluZGV4Lm5vZGVzW2lkXTsKCiAgICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgICAgICBpbnQgYmFsYW5jZUZhY3RvciA9IF9nZXRCYWxhbmNlRmFjdG9yKGluZGV4LCBjdXJyZW50Tm9kZS5pZCk7CgogICAgICAgICAgICAgICAgaWYgKGJhbGFuY2VGYWN0b3IgPT0gMikgewogICAgICAgICAgICAgICAgICAgIC8vIFJpZ2h0IHJvdGF0aW9uICh0cmVlIGlzIGhlYXZ5IG9uIHRoZSBsZWZ0KQogICAgICAgICAgICAgICAgICAgIGlmIChfZ2V0QmFsYW5jZUZhY3RvcihpbmRleCwgY3VycmVudE5vZGUubGVmdCkgPT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gVGhlIHN1YnRyZWUgaXMgbGVhbmluZyByaWdodCBzbyBpdCBuZWVkIHRvIGJlCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHJvdGF0ZWQgbGVmdCBiZWZvcmUgdGhlIGN1cnJlbnQgbm9kZSBpcyByb3RhdGVkCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHJpZ2h0LgogICAgICAgICAgICAgICAgICAgICAgICBfcm90YXRlTGVmdChpbmRleCwgY3VycmVudE5vZGUubGVmdCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIF9yb3RhdGVSaWdodChpbmRleCwgY3VycmVudE5vZGUuaWQpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChiYWxhbmNlRmFjdG9yID09IC0yKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gTGVmdCByb3RhdGlvbiAodHJlZSBpcyBoZWF2eSBvbiB0aGUgcmlnaHQpCiAgICAgICAgICAgICAgICAgICAgaWYgKF9nZXRCYWxhbmNlRmFjdG9yKGluZGV4LCBjdXJyZW50Tm9kZS5yaWdodCkgPT0gMSkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBUaGUgc3VidHJlZSBpcyBsZWFuaW5nIGxlZnQgc28gaXQgbmVlZCB0byBiZQogICAgICAgICAgICAgICAgICAgICAgICAvLyByb3RhdGVkIHJpZ2h0IGJlZm9yZSB0aGUgY3VycmVudCBub2RlIGlzIHJvdGF0ZWQKICAgICAgICAgICAgICAgICAgICAgICAgLy8gbGVmdC4KICAgICAgICAgICAgICAgICAgICAgICAgX3JvdGF0ZVJpZ2h0KGluZGV4LCBjdXJyZW50Tm9kZS5yaWdodCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIF9yb3RhdGVMZWZ0KGluZGV4LCBjdXJyZW50Tm9kZS5pZCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKCgtMSA8PSBiYWxhbmNlRmFjdG9yKSAmJiAoYmFsYW5jZUZhY3RvciA8PSAxKSkgewogICAgICAgICAgICAgICAgICAgIF91cGRhdGVOb2RlSGVpZ2h0KGluZGV4LCBjdXJyZW50Tm9kZS5pZCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnROb2RlLnBhcmVudCA9PSAweDApIHsKICAgICAgICAgICAgICAgICAgICAvLyBSZWFjaGVkIHRoZSByb290IHdoaWNoIG1heSBiZSBuZXcgZHVlIHRvIHRyZWUKICAgICAgICAgICAgICAgICAgICAvLyByb3RhdGlvbiwgc28gc2V0IGl0IGFzIHRoZSByb290IGFuZCB0aGVuIGJyZWFrLgogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlID0gaW5kZXgubm9kZXNbY3VycmVudE5vZGUucGFyZW50XTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gX2dldEJhbGFuY2VGYWN0b3IoSW5kZXggc3RvcmFnZSBpbmRleCwgYnl0ZXMzMiBpZCkgaW50ZXJuYWwgcmV0dXJucyAoaW50KSB7CiAgICAgICAgICAgICAgICBOb2RlIHN0b3JhZ2Ugbm9kZSA9IGluZGV4Lm5vZGVzW2lkXTsKCiAgICAgICAgICAgICAgICByZXR1cm4gaW50KGluZGV4Lm5vZGVzW25vZGUubGVmdF0uaGVpZ2h0KSAtIGludChpbmRleC5ub2Rlc1tub2RlLnJpZ2h0XS5oZWlnaHQpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gX3VwZGF0ZU5vZGVIZWlnaHQoSW5kZXggc3RvcmFnZSBpbmRleCwgYnl0ZXMzMiBpZCkgaW50ZXJuYWwgewogICAgICAgICAgICAgICAgTm9kZSBzdG9yYWdlIG5vZGUgPSBpbmRleC5ub2Rlc1tpZF07CgogICAgICAgICAgICAgICAgbm9kZS5oZWlnaHQgPSBtYXgoaW5kZXgubm9kZXNbbm9kZS5sZWZ0XS5oZWlnaHQsIGluZGV4Lm5vZGVzW25vZGUucmlnaHRdLmhlaWdodCkgKyAxOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gX3JvdGF0ZUxlZnQoSW5kZXggc3RvcmFnZSBpbmRleCwgYnl0ZXMzMiBpZCkgaW50ZXJuYWwgewogICAgICAgICAgICBOb2RlIHN0b3JhZ2Ugb3JpZ2luYWxSb290ID0gaW5kZXgubm9kZXNbaWRdOwoKICAgICAgICAgICAgaWYgKG9yaWdpbmFsUm9vdC5yaWdodCA9PSAweDApIHsKICAgICAgICAgICAgICAgIC8vIENhbm5vdCByb3RhdGUgbGVmdCBpZiB0aGVyZSBpcyBubyByaWdodCBvcmlnaW5hbFJvb3QgdG8gcm90YXRlIGludG8KICAgICAgICAgICAgICAgIC8vIHBsYWNlLgogICAgICAgICAgICAgICAgdGhyb3c7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFRoZSByaWdodCBjaGlsZCBpcyB0aGUgbmV3IHJvb3QsIHNvIGl0IGdldHMgdGhlIG9yaWdpbmFsCiAgICAgICAgICAgIC8vIGBvcmlnaW5hbFJvb3QucGFyZW50YCBhcyBpdCdzIHBhcmVudC4KICAgICAgICAgICAgTm9kZSBzdG9yYWdlIG5ld1Jvb3QgPSBpbmRleC5ub2Rlc1tvcmlnaW5hbFJvb3QucmlnaHRdOwogICAgICAgICAgICBuZXdSb290LnBhcmVudCA9IG9yaWdpbmFsUm9vdC5wYXJlbnQ7CgogICAgICAgICAgICAvLyBUaGUgb3JpZ2luYWwgcm9vdCBuZWVkcyB0byBoYXZlIGl0J3MgcmlnaHQgY2hpbGQgbnVsbGVkIG91dC4KICAgICAgICAgICAgb3JpZ2luYWxSb290LnJpZ2h0ID0gMHgwOwoKICAgICAgICAgICAgaWYgKG9yaWdpbmFsUm9vdC5wYXJlbnQgIT0gMHgwKSB7CiAgICAgICAgICAgICAgICAvLyBJZiB0aGVyZSBpcyBhIHBhcmVudCBub2RlLCBpdCBuZWVkcyB0byBub3cgcG9pbnQgZG93bndhcmQgYXQKICAgICAgICAgICAgICAgIC8vIHRoZSBuZXdSb290IHdoaWNoIGlzIHJvdGF0aW5nIGludG8gdGhlIHBsYWNlIHdoZXJlIGBub2RlYCB3YXMuCiAgICAgICAgICAgICAgICBOb2RlIHN0b3JhZ2UgcGFyZW50ID0gaW5kZXgubm9kZXNbb3JpZ2luYWxSb290LnBhcmVudF07CgogICAgICAgICAgICAgICAgLy8gZmlndXJlIG91dCBpZiB3ZSdyZSBhIGxlZnQgb3IgcmlnaHQgY2hpbGQgYW5kIGhhdmUgdGhlCiAgICAgICAgICAgICAgICAvLyBwYXJlbnQgcG9pbnQgdG8gdGhlIG5ldyBub2RlLgogICAgICAgICAgICAgICAgaWYgKHBhcmVudC5sZWZ0ID09IG9yaWdpbmFsUm9vdC5pZCkgewogICAgICAgICAgICAgICAgICAgIHBhcmVudC5sZWZ0ID0gbmV3Um9vdC5pZDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChwYXJlbnQucmlnaHQgPT0gb3JpZ2luYWxSb290LmlkKSB7CiAgICAgICAgICAgICAgICAgICAgcGFyZW50LnJpZ2h0ID0gbmV3Um9vdC5pZDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKCiAgICAgICAgICAgIGlmIChuZXdSb290LmxlZnQgIT0gMCkgewogICAgICAgICAgICAgICAgLy8gSWYgdGhlIG5ldyByb290IGhhZCBhIGxlZnQgY2hpbGQsIHRoYXQgbW92ZXMgdG8gYmUgdGhlCiAgICAgICAgICAgICAgICAvLyBuZXcgcmlnaHQgY2hpbGQgb2YgdGhlIG9yaWdpbmFsIHJvb3Qgbm9kZQogICAgICAgICAgICAgICAgTm9kZSBzdG9yYWdlIGxlZnRDaGlsZCA9IGluZGV4Lm5vZGVzW25ld1Jvb3QubGVmdF07CiAgICAgICAgICAgICAgICBvcmlnaW5hbFJvb3QucmlnaHQgPSBsZWZ0Q2hpbGQuaWQ7CiAgICAgICAgICAgICAgICBsZWZ0Q2hpbGQucGFyZW50ID0gb3JpZ2luYWxSb290LmlkOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBVcGRhdGUgdGhlIG5ld1Jvb3QncyBsZWZ0IG5vZGUgdG8gcG9pbnQgYXQgdGhlIG9yaWdpbmFsIG5vZGUuCiAgICAgICAgICAgIG9yaWdpbmFsUm9vdC5wYXJlbnQgPSBuZXdSb290LmlkOwogICAgICAgICAgICBuZXdSb290LmxlZnQgPSBvcmlnaW5hbFJvb3QuaWQ7CgogICAgICAgICAgICBpZiAobmV3Um9vdC5wYXJlbnQgPT0gMHgwKSB7CiAgICAgICAgICAgICAgICBpbmRleC5yb290ID0gbmV3Um9vdC5pZDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gVE9ETzogYXJlIGJvdGggb2YgdGhlc2UgdXBkYXRlcyBuZWNlc3Nhcnk/CiAgICAgICAgICAgIF91cGRhdGVOb2RlSGVpZ2h0KGluZGV4LCBvcmlnaW5hbFJvb3QuaWQpOwogICAgICAgICAgICBfdXBkYXRlTm9kZUhlaWdodChpbmRleCwgbmV3Um9vdC5pZCk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBfcm90YXRlUmlnaHQoSW5kZXggc3RvcmFnZSBpbmRleCwgYnl0ZXMzMiBpZCkgaW50ZXJuYWwgewogICAgICAgICAgICBOb2RlIHN0b3JhZ2Ugb3JpZ2luYWxSb290ID0gaW5kZXgubm9kZXNbaWRdOwoKICAgICAgICAgICAgaWYgKG9yaWdpbmFsUm9vdC5sZWZ0ID09IDB4MCkgewogICAgICAgICAgICAgICAgLy8gQ2Fubm90IHJvdGF0ZSByaWdodCBpZiB0aGVyZSBpcyBubyBsZWZ0IG5vZGUgdG8gcm90YXRlIGludG8KICAgICAgICAgICAgICAgIC8vIHBsYWNlLgogICAgICAgICAgICAgICAgdGhyb3c7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFRoZSBsZWZ0IGNoaWxkIGlzIHRha2luZyB0aGUgcGxhY2Ugb2Ygbm9kZSwgc28gd2UgdXBkYXRlIGl0J3MKICAgICAgICAgICAgLy8gcGFyZW50IHRvIGJlIHRoZSBvcmlnaW5hbCBwYXJlbnQgb2YgdGhlIG5vZGUuCiAgICAgICAgICAgIE5vZGUgc3RvcmFnZSBuZXdSb290ID0gaW5kZXgubm9kZXNbb3JpZ2luYWxSb290LmxlZnRdOwogICAgICAgICAgICBuZXdSb290LnBhcmVudCA9IG9yaWdpbmFsUm9vdC5wYXJlbnQ7CgogICAgICAgICAgICAvLyBOdWxsIG91dCB0aGUgb3JpZ2luYWxSb290LmxlZnQKICAgICAgICAgICAgb3JpZ2luYWxSb290LmxlZnQgPSAweDA7CgogICAgICAgICAgICBpZiAob3JpZ2luYWxSb290LnBhcmVudCAhPSAweDApIHsKICAgICAgICAgICAgICAgIC8vIElmIHRoZSBub2RlIGhhcyBhIHBhcmVudCwgdXBkYXRlIHRoZSBjb3JyZWN0IGNoaWxkIHRvIHBvaW50CiAgICAgICAgICAgICAgICAvLyBhdCB0aGUgbmV3Um9vdCBub3cuCiAgICAgICAgICAgICAgICBOb2RlIHN0b3JhZ2UgcGFyZW50ID0gaW5kZXgubm9kZXNbb3JpZ2luYWxSb290LnBhcmVudF07CgogICAgICAgICAgICAgICAgaWYgKHBhcmVudC5sZWZ0ID09IG9yaWdpbmFsUm9vdC5pZCkgewogICAgICAgICAgICAgICAgICAgIHBhcmVudC5sZWZ0ID0gbmV3Um9vdC5pZDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChwYXJlbnQucmlnaHQgPT0gb3JpZ2luYWxSb290LmlkKSB7CiAgICAgICAgICAgICAgICAgICAgcGFyZW50LnJpZ2h0ID0gbmV3Um9vdC5pZDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKG5ld1Jvb3QucmlnaHQgIT0gMHgwKSB7CiAgICAgICAgICAgICAgICBOb2RlIHN0b3JhZ2UgcmlnaHRDaGlsZCA9IGluZGV4Lm5vZGVzW25ld1Jvb3QucmlnaHRdOwogICAgICAgICAgICAgICAgb3JpZ2luYWxSb290LmxlZnQgPSBuZXdSb290LnJpZ2h0OwogICAgICAgICAgICAgICAgcmlnaHRDaGlsZC5wYXJlbnQgPSBvcmlnaW5hbFJvb3QuaWQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFVwZGF0ZSB0aGUgbmV3IHJvb3QncyByaWdodCBub2RlIHRvIHBvaW50IHRvIHRoZSBvcmlnaW5hbCBub2RlLgogICAgICAgICAgICBvcmlnaW5hbFJvb3QucGFyZW50ID0gbmV3Um9vdC5pZDsKICAgICAgICAgICAgbmV3Um9vdC5yaWdodCA9IG9yaWdpbmFsUm9vdC5pZDsKCiAgICAgICAgICAgIGlmIChuZXdSb290LnBhcmVudCA9PSAweDApIHsKICAgICAgICAgICAgICAgIGluZGV4LnJvb3QgPSBuZXdSb290LmlkOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBSZWNvbXB1dGUgaGVpZ2h0cy4KICAgICAgICAgICAgX3VwZGF0ZU5vZGVIZWlnaHQoaW5kZXgsIG9yaWdpbmFsUm9vdC5pZCk7CiAgICAgICAgICAgIF91cGRhdGVOb2RlSGVpZ2h0KGluZGV4LCBuZXdSb290LmlkKTsKICAgICAgICB9Cn0KCgovLyBSZXNvdXJjZSBQb29sIHYwLjEuMCAoaGFzIGJlZW4gbW9kaWZpZWQgZnJvbSB0aGUgbWFpbiByZWxlYXNlZCB2ZXJzaW9uIG9mIHRoaXMgbGlicmFyeSkKCgovLyBAdGl0bGUgUmVzb3VyY2VQb29sTGliIC0gTGlicmFyeSBmb3IgYSBzZXQgb2YgcmVzb3VyY2VzIHRoYXQgYXJlIHJlYWR5IGZvciB1c2UuCi8vIEBhdXRob3IgUGlwZXIgTWVycmlhbSAKbGlicmFyeSBSZXNvdXJjZVBvb2xMaWIgewogICAgICAgIC8qCiAgICAgICAgICogIEFkZHJlc3M6IDB4ZDZiYmQxNmVhYTZlYTNmNzFhNDU4YmZmYzY0YzBjYTI0ZmM4YzU4ZQogICAgICAgICAqLwogICAgICAgIHN0cnVjdCBQb29sIHsKICAgICAgICAgICAgICAgIHVpbnQgcm90YXRpb25EZWxheTsKICAgICAgICAgICAgICAgIHVpbnQgb3ZlcmxhcFNpemU7CiAgICAgICAgICAgICAgICB1aW50IGZyZWV6ZVBlcmlvZDsKCiAgICAgICAgICAgICAgICB1aW50IF9pZDsKCiAgICAgICAgICAgICAgICBHcm92ZUxpYi5JbmRleCBnZW5lcmF0aW9uU3RhcnQ7CiAgICAgICAgICAgICAgICBHcm92ZUxpYi5JbmRleCBnZW5lcmF0aW9uRW5kOwoKICAgICAgICAgICAgICAgIG1hcHBpbmcgKHVpbnQgPT4gR2VuZXJhdGlvbikgZ2VuZXJhdGlvbnM7CiAgICAgICAgICAgICAgICBtYXBwaW5nIChhZGRyZXNzID0+IHVpbnQpIGJvbmRzOwogICAgICAgIH0KCiAgICAgICAgLyoKICAgICAgICAgKiBHZW5lcmF0aW9ucyBoYXZlIHRoZSBmb2xsb3dpbmcgcHJvcGVydGllcy4KICAgICAgICAgKgogICAgICAgICAqIDEuIE11c3QgYWx3YXlzIG92ZXJsYXAgYnkgYSBtaW5pbXVtIGFtb3VudCBzcGVjaWZpZWQgYnkgTUlOX09WRVJMQVAuCiAgICAgICAgICoKICAgICAgICAgKiAgICAxICAgMiAgIDMgICA0ICAgNSAgIDYgICA3ICAgOCAgIDkgICAxMCAgMTEgIDEyICAxMwogICAgICAgICAqICAgIFsxOi0tLS0tLS0tLS0tLS0tLS0tXQogICAgICAgICAqICAgICAgICAgICAgICAgIFs0Oi0tLS0tLS0tLS0tLS0tLS0tLS0tLT4KICAgICAgICAgKi8KICAgICAgICBzdHJ1Y3QgR2VuZXJhdGlvbiB7CiAgICAgICAgICAgICAgICB1aW50IGlkOwogICAgICAgICAgICAgICAgdWludCBzdGFydEF0OwogICAgICAgICAgICAgICAgdWludCBlbmRBdDsKICAgICAgICAgICAgICAgIGFkZHJlc3NbXSBtZW1iZXJzOwogICAgICAgIH0KCiAgICAgICAgLy8vIEBkZXYgQ3JlYXRlcyB0aGUgbmV4dCBnZW5lcmF0aW9uIGZvciB0aGUgZ2l2ZW4gcG9vbC4gIEFsbCBtZW1iZXJzIGZyb20gdGhlIGN1cnJlbnQgZ2VuZXJhdGlvbiBhcmUgY2FycmllZCBvdmVyICh3aXRoIHRoZWlyIG9yZGVyIHJhbmRvbWl6ZWQpLiAgVGhlIGN1cnJlbnQgZ2VuZXJhdGlvbiB3aWxsIGhhdmUgaXQncyBlbmRBdCBibG9jayBzZXQuCiAgICAgICAgLy8vIEBwYXJhbSBzZWxmIFRoZSBwb29sIHRvIG9wZXJhdGUgb24uCiAgICAgICAgZnVuY3Rpb24gY3JlYXRlTmV4dEdlbmVyYXRpb24oUG9vbCBzdG9yYWdlIHNlbGYpIHB1YmxpYyByZXR1cm5zICh1aW50KSB7CiAgICAgICAgICAgICAgICAvKgogICAgICAgICAgICAgICAgICogIENyZWF0IGEgbmV3IHBvb2wgZ2VuZXJhdGlvbiB3aXRoIGFsbCBvZiB0aGUgY3VycmVudAogICAgICAgICAgICAgICAgICogIGdlbmVyYXRpb24ncyBtZW1iZXJzIGNvcGllZCBvdmVyIGluIHJhbmRvbSBvcmRlci4KICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgR2VuZXJhdGlvbiBzdG9yYWdlIHByZXZpb3VzR2VuZXJhdGlvbiA9IHNlbGYuZ2VuZXJhdGlvbnNbc2VsZi5faWRdOwoKICAgICAgICAgICAgICAgIHNlbGYuX2lkICs9IDE7CiAgICAgICAgICAgICAgICBHZW5lcmF0aW9uIHN0b3JhZ2UgbmV4dEdlbmVyYXRpb24gPSBzZWxmLmdlbmVyYXRpb25zW3NlbGYuX2lkXTsKICAgICAgICAgICAgICAgIG5leHRHZW5lcmF0aW9uLmlkID0gc2VsZi5faWQ7CiAgICAgICAgICAgICAgICBuZXh0R2VuZXJhdGlvbi5zdGFydEF0ID0gYmxvY2subnVtYmVyICsgc2VsZi5mcmVlemVQZXJpb2QgKyBzZWxmLnJvdGF0aW9uRGVsYXk7CiAgICAgICAgICAgICAgICBHcm92ZUxpYi5pbnNlcnQoc2VsZi5nZW5lcmF0aW9uU3RhcnQsIFN0cmluZ0xpYi51aW50VG9CeXRlcyhuZXh0R2VuZXJhdGlvbi5pZCksIGludChuZXh0R2VuZXJhdGlvbi5zdGFydEF0KSk7CgogICAgICAgICAgICAgICAgaWYgKHByZXZpb3VzR2VuZXJhdGlvbi5pZCA9PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRoaXMgaXMgdGhlIGZpcnN0IGdlbmVyYXRpb24gc28gd2UganVzdCBuZWVkIHRvIHNldAogICAgICAgICAgICAgICAgICAgICAgICAvLyBpdCdzIGBpZGAgYW5kIGBzdGFydEF0YC4KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5leHRHZW5lcmF0aW9uLmlkOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIFNldCB0aGUgZW5kIGRhdGUgZm9yIHRoZSBjdXJyZW50IGdlbmVyYXRpb24uCiAgICAgICAgICAgICAgICBwcmV2aW91c0dlbmVyYXRpb24uZW5kQXQgPSBibG9jay5udW1iZXIgKyBzZWxmLmZyZWV6ZVBlcmlvZCArIHNlbGYucm90YXRpb25EZWxheSArIHNlbGYub3ZlcmxhcFNpemU7CiAgICAgICAgICAgICAgICBHcm92ZUxpYi5pbnNlcnQoc2VsZi5nZW5lcmF0aW9uRW5kLCBTdHJpbmdMaWIudWludFRvQnl0ZXMocHJldmlvdXNHZW5lcmF0aW9uLmlkKSwgaW50KHByZXZpb3VzR2VuZXJhdGlvbi5lbmRBdCkpOwoKICAgICAgICAgICAgICAgIC8vIE5vdyB3ZSBjb3B5IHRoZSBtZW1iZXJzIG9mIHRoZSBwcmV2aW91cyBnZW5lcmF0aW9uIG92ZXIgdG8KICAgICAgICAgICAgICAgIC8vIHRoZSBuZXh0IGdlbmVyYXRpb24gYXMgd2VsbCBhcyByYW5kb21pemluZyB0aGVpciBvcmRlci4KICAgICAgICAgICAgICAgIGFkZHJlc3NbXSBtZW1vcnkgbWVtYmVycyA9IHByZXZpb3VzR2VuZXJhdGlvbi5tZW1iZXJzOwoKICAgICAgICAgICAgICAgIGZvciAodWludCBpID0gMDsgaSA8IG1lbWJlcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAvLyBQaWNrIGEgKnJhbmRvbSogaW5kZXggYW5kIHB1c2ggaXQgb250byB0aGUgbmV4dAogICAgICAgICAgICAgICAgICAgIC8vIGdlbmVyYXRpb24ncyBtZW1iZXJzLgogICAgICAgICAgICAgICAgICAgIHVpbnQgaW5kZXggPSB1aW50KHNoYTMoYmxvY2suYmxvY2toYXNoKGJsb2NrLm51bWJlcikpKSAlIChtZW1iZXJzLmxlbmd0aCAtIG5leHRHZW5lcmF0aW9uLm1lbWJlcnMubGVuZ3RoKTsKICAgICAgICAgICAgICAgICAgICBuZXh0R2VuZXJhdGlvbi5tZW1iZXJzLmxlbmd0aCArPSAxOwogICAgICAgICAgICAgICAgICAgIG5leHRHZW5lcmF0aW9uLm1lbWJlcnNbbmV4dEdlbmVyYXRpb24ubWVtYmVycy5sZW5ndGggLSAxXSA9IG1lbWJlcnNbaW5kZXhdOwoKICAgICAgICAgICAgICAgICAgICAvLyBUaGVuIG1vdmUgdGhlIG1lbWJlciBhdCB0aGUgbGFzdCBpbmRleCBpbnRvIHRoZSBwaWNrZWQKICAgICAgICAgICAgICAgICAgICAvLyBpbmRleCdzIGxvY2F0aW9uLgogICAgICAgICAgICAgICAgICAgIG1lbWJlcnNbaW5kZXhdID0gbWVtYmVyc1ttZW1iZXJzLmxlbmd0aCAtIDFdOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiBuZXh0R2VuZXJhdGlvbi5pZDsKICAgICAgICB9CgogICAgICAgIC8vLyBAZGV2IFJldHVybnMgdGhlIGZpcnN0IGdlbmVyYXRpb24gaWQgdGhhdCBmdWxseSBjb250YWlucyB0aGUgYmxvY2sgd2luZG93IHByb3ZpZGVkLgogICAgICAgIC8vLyBAcGFyYW0gc2VsZiBUaGUgcG9vbCB0byBvcGVyYXRlIG9uLgogICAgICAgIC8vLyBAcGFyYW0gbGVmdEJvdW5kIFRoZSBsZWZ0IGJvdW5kIGZvciB0aGUgYmxvY2sgd2luZG93IChpbmNsdXNpdmUpCiAgICAgICAgLy8vIEBwYXJhbSByaWdodEJvdW5kIFRoZSByaWdodCBib3VuZCBmb3IgdGhlIGJsb2NrIHdpbmRvdyAoaW5jbHVzaXZlKQogICAgICAgIGZ1bmN0aW9uIGdldEdlbmVyYXRpb25Gb3JXaW5kb3coUG9vbCBzdG9yYWdlIHNlbGYsIHVpbnQgbGVmdEJvdW5kLCB1aW50IHJpZ2h0Qm91bmQpIGNvbnN0YW50IHJldHVybnMgKHVpbnQpIHsKICAgICAgICAgICAgLy8gVE9ETzogdGVzdHMKICAgICAgICAgICAgICAgIHZhciBsZWZ0ID0gR3JvdmVMaWIucXVlcnkoc2VsZi5nZW5lcmF0aW9uU3RhcnQsICI8PSIsIGludChsZWZ0Qm91bmQpKTsKCiAgICAgICAgICAgICAgICBpZiAobGVmdCAhPSAweDApIHsKICAgICAgICAgICAgICAgICAgICBHZW5lcmF0aW9uIG1lbW9yeSBsZWZ0Q2FuZGlkYXRlID0gc2VsZi5nZW5lcmF0aW9uc1tTdHJpbmdMaWIuYnl0ZXNUb1VJbnQobGVmdCldOwogICAgICAgICAgICAgICAgICAgIGlmIChsZWZ0Q2FuZGlkYXRlLnN0YXJ0QXQgPD0gbGVmdEJvdW5kICYmIChsZWZ0Q2FuZGlkYXRlLmVuZEF0ID49IHJpZ2h0Qm91bmQgfHwgbGVmdENhbmRpZGF0ZS5lbmRBdCA9PSAwKSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbGVmdENhbmRpZGF0ZS5pZDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdmFyIHJpZ2h0ID0gR3JvdmVMaWIucXVlcnkoc2VsZi5nZW5lcmF0aW9uRW5kLCAiPj0iLCBpbnQocmlnaHRCb3VuZCkpOwogICAgICAgICAgICAgICAgaWYgKHJpZ2h0ICE9IDB4MCkgewogICAgICAgICAgICAgICAgICAgIEdlbmVyYXRpb24gbWVtb3J5IHJpZ2h0Q2FuZGlkYXRlID0gc2VsZi5nZW5lcmF0aW9uc1tTdHJpbmdMaWIuYnl0ZXNUb1VJbnQocmlnaHQpXTsKICAgICAgICAgICAgICAgICAgICBpZiAocmlnaHRDYW5kaWRhdGUuc3RhcnRBdCA8PSBsZWZ0Qm91bmQgJiYgKHJpZ2h0Q2FuZGlkYXRlLmVuZEF0ID49IHJpZ2h0Qm91bmQgfHwgcmlnaHRDYW5kaWRhdGUuZW5kQXQgPT0gMCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJpZ2h0Q2FuZGlkYXRlLmlkOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICB9CgogICAgICAgIC8vLyBAZGV2IFJldHVybnMgdGhlIGZpcnN0IGdlbmVyYXRpb24gaW4gdGhlIGZ1dHVyZSB0aGF0IGhhcyBub3QgeWV0IHN0YXJ0ZWQuCiAgICAgICAgLy8vIEBwYXJhbSBzZWxmIFRoZSBwb29sIHRvIG9wZXJhdGUgb24uCiAgICAgICAgZnVuY3Rpb24gZ2V0TmV4dEdlbmVyYXRpb25JZChQb29sIHN0b3JhZ2Ugc2VsZikgY29uc3RhbnQgcmV0dXJucyAodWludCkgewogICAgICAgICAgICAvLyBUT0RPOiB0ZXN0cwogICAgICAgICAgICAgICAgdmFyIG5leHQgPSBHcm92ZUxpYi5xdWVyeShzZWxmLmdlbmVyYXRpb25TdGFydCwgIj4iLCBpbnQoYmxvY2subnVtYmVyKSk7CiAgICAgICAgICAgICAgICBpZiAobmV4dCA9PSAweDApIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBTdHJpbmdMaWIuYnl0ZXNUb1VJbnQobmV4dCk7CiAgICAgICAgfQoKICAgICAgICAvLy8gQGRldiBSZXR1cm5zIHRoZSBmaXJzdCBnZW5lcmF0aW9uIHRoYXQgaXMgY3VycmVudGx5IGFjdGl2ZS4KICAgICAgICAvLy8gQHBhcmFtIHNlbGYgVGhlIHBvb2wgdG8gb3BlcmF0ZSBvbi4KICAgICAgICBmdW5jdGlvbiBnZXRDdXJyZW50R2VuZXJhdGlvbklkKFBvb2wgc3RvcmFnZSBzZWxmKSBjb25zdGFudCByZXR1cm5zICh1aW50KSB7CiAgICAgICAgICAgIC8vIFRPRE86IHRlc3RzCiAgICAgICAgICAgICAgICB2YXIgbmV4dCA9IEdyb3ZlTGliLnF1ZXJ5KHNlbGYuZ2VuZXJhdGlvbkVuZCwgIj4iLCBpbnQoYmxvY2subnVtYmVyKSk7CiAgICAgICAgICAgICAgICBpZiAobmV4dCAhPSAweDApIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gU3RyaW5nTGliLmJ5dGVzVG9VSW50KG5leHQpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIG5leHQgPSBHcm92ZUxpYi5xdWVyeShzZWxmLmdlbmVyYXRpb25TdGFydCwgIjw9IiwgaW50KGJsb2NrLm51bWJlcikpOwogICAgICAgICAgICAgICAgaWYgKG5leHQgIT0gMHgwKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFN0cmluZ0xpYi5ieXRlc1RvVUludChuZXh0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgIH0KCiAgICAgICAgLyoKICAgICAgICAgKiAgUG9vbCBtZW1iZXJzaGlwIEFQSQogICAgICAgICAqLwogICAgICAgIC8vLyBAZGV2IFJldHVybnMgYSBib29sZWFuIGZvciB3aGV0aGVyIHRoZSBnaXZlbiBhZGRyZXNzIGlzIGluIHRoZSBnaXZlbiBnZW5lcmF0aW9uLgogICAgICAgIC8vLyBAcGFyYW0gc2VsZiBUaGUgcG9vbCB0byBvcGVyYXRlIG9uLgogICAgICAgIC8vLyBAcGFyYW0gcmVzb3VyY2VBZGRyZXNzIFRoZSBhZGRyZXNzIHRvIGNoZWNrIG1lbWJlcnNoaXAgb2YKICAgICAgICAvLy8gQHBhcmFtIGdlbmVyYXRpb25JZCBUaGUgaWQgb2YgdGhlIGdlbmVyYXRpb24gdG8gY2hlY2suCiAgICAgICAgZnVuY3Rpb24gaXNJbkdlbmVyYXRpb24oUG9vbCBzdG9yYWdlIHNlbGYsIGFkZHJlc3MgcmVzb3VyY2VBZGRyZXNzLCB1aW50IGdlbmVyYXRpb25JZCkgY29uc3RhbnQgcmV0dXJucyAoYm9vbCkgewogICAgICAgICAgICAvLyBUT0RPOiB0ZXN0cwogICAgICAgICAgICBpZiAoZ2VuZXJhdGlvbklkID09IDApIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBHZW5lcmF0aW9uIG1lbW9yeSBnZW5lcmF0aW9uID0gc2VsZi5nZW5lcmF0aW9uc1tnZW5lcmF0aW9uSWRdOwogICAgICAgICAgICBmb3IgKHVpbnQgaSA9IDA7IGkgPCBnZW5lcmF0aW9uLm1lbWJlcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmIChnZW5lcmF0aW9uLm1lbWJlcnNbaV0gPT0gcmVzb3VyY2VBZGRyZXNzKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgLy8vIEBkZXYgUmV0dXJucyBhIGJvb2xlYW4gZm9yIHdoZXRoZXIgdGhlIGdpdmVuIGFkZHJlc3MgaXMgaW4gdGhlIGN1cnJlbnQgZ2VuZXJhdGlvbi4KICAgICAgICAvLy8gQHBhcmFtIHNlbGYgVGhlIHBvb2wgdG8gb3BlcmF0ZSBvbi4KICAgICAgICAvLy8gQHBhcmFtIHJlc291cmNlQWRkcmVzcyBUaGUgYWRkcmVzcyB0byBjaGVjayBtZW1iZXJzaGlwIG9mCiAgICAgICAgZnVuY3Rpb24gaXNJbkN1cnJlbnRHZW5lcmF0aW9uKFBvb2wgc3RvcmFnZSBzZWxmLCBhZGRyZXNzIHJlc291cmNlQWRkcmVzcykgY29uc3RhbnQgcmV0dXJucyAoYm9vbCkgewogICAgICAgICAgICAvLyBUT0RPOiB0ZXN0cwogICAgICAgICAgICByZXR1cm4gaXNJbkdlbmVyYXRpb24oc2VsZiwgcmVzb3VyY2VBZGRyZXNzLCBnZXRDdXJyZW50R2VuZXJhdGlvbklkKHNlbGYpKTsKICAgICAgICB9CgogICAgICAgIC8vLyBAZGV2IFJldHVybnMgYSBib29sZWFuIGZvciB3aGV0aGVyIHRoZSBnaXZlbiBhZGRyZXNzIGlzIGluIHRoZSBuZXh0IHF1ZXVlZCBnZW5lcmF0aW9uLgogICAgICAgIC8vLyBAcGFyYW0gc2VsZiBUaGUgcG9vbCB0byBvcGVyYXRlIG9uLgogICAgICAgIC8vLyBAcGFyYW0gcmVzb3VyY2VBZGRyZXNzIFRoZSBhZGRyZXNzIHRvIGNoZWNrIG1lbWJlcnNoaXAgb2YKICAgICAgICBmdW5jdGlvbiBpc0luTmV4dEdlbmVyYXRpb24oUG9vbCBzdG9yYWdlIHNlbGYsIGFkZHJlc3MgcmVzb3VyY2VBZGRyZXNzKSBjb25zdGFudCByZXR1cm5zIChib29sKSB7CiAgICAgICAgICAgIC8vIFRPRE86IHRlc3RzCiAgICAgICAgICAgIHJldHVybiBpc0luR2VuZXJhdGlvbihzZWxmLCByZXNvdXJjZUFkZHJlc3MsIGdldE5leHRHZW5lcmF0aW9uSWQoc2VsZikpOwogICAgICAgIH0KCiAgICAgICAgLy8vIEBkZXYgUmV0dXJucyBhIGJvb2xlYW4gZm9yIHdoZXRoZXIgdGhlIGdpdmVuIGFkZHJlc3MgaXMgaW4gZWl0aGVyIHRoZSBjdXJyZW50IGdlbmVyYXRpb24gb3IgdGhlIG5leHQgcXVldWVkIGdlbmVyYXRpb24uCiAgICAgICAgLy8vIEBwYXJhbSBzZWxmIFRoZSBwb29sIHRvIG9wZXJhdGUgb24uCiAgICAgICAgLy8vIEBwYXJhbSByZXNvdXJjZUFkZHJlc3MgVGhlIGFkZHJlc3MgdG8gY2hlY2sgbWVtYmVyc2hpcCBvZgogICAgICAgIGZ1bmN0aW9uIGlzSW5Qb29sKFBvb2wgc3RvcmFnZSBzZWxmLCBhZGRyZXNzIHJlc291cmNlQWRkcmVzcykgY29uc3RhbnQgcmV0dXJucyAoYm9vbCkgewogICAgICAgICAgICAvLyBUT0RPOiB0ZXN0cwogICAgICAgICAgICByZXR1cm4gKGlzSW5DdXJyZW50R2VuZXJhdGlvbihzZWxmLCByZXNvdXJjZUFkZHJlc3MpIHx8IGlzSW5OZXh0R2VuZXJhdGlvbihzZWxmLCByZXNvdXJjZUFkZHJlc3MpKTsKICAgICAgICB9CgogICAgICAgIGV2ZW50IF9BZGRlZFRvR2VuZXJhdGlvbihhZGRyZXNzIGluZGV4ZWQgcmVzb3VyY2VBZGRyZXNzLCB1aW50IGluZGV4ZWQgZ2VuZXJhdGlvbklkKTsKICAgICAgICAvLy8gQGRldiBGdW5jdGlvbiB0byBleHBvc2UgdGhlIF9BZGRlZFRvR2VuZXJhdGlvbiBldmVudCB0byBjb250cmFjdHMuCiAgICAgICAgLy8vIEBwYXJhbSByZXNvdXJjZUFkZHJlc3MgVGhlIGFkZHJlc3MgdGhhdCB3YXMgYWRkZWQKICAgICAgICAvLy8gQHBhcmFtIGdlbmVyYXRpb25JZCBUaGUgaWQgb2YgdGhlIGdlbmVyYXRpb24uCiAgICAgICAgZnVuY3Rpb24gQWRkZWRUb0dlbmVyYXRpb24oYWRkcmVzcyByZXNvdXJjZUFkZHJlc3MsIHVpbnQgZ2VuZXJhdGlvbklkKSBwdWJsaWMgewogICAgICAgICAgICAgICAgX0FkZGVkVG9HZW5lcmF0aW9uKHJlc291cmNlQWRkcmVzcywgZ2VuZXJhdGlvbklkKTsKICAgICAgICB9CgogICAgICAgIGV2ZW50IF9SZW1vdmVkRnJvbUdlbmVyYXRpb24oYWRkcmVzcyBpbmRleGVkIHJlc291cmNlQWRkcmVzcywgdWludCBpbmRleGVkIGdlbmVyYXRpb25JZCk7CiAgICAgICAgLy8vIEBkZXYgRnVuY3Rpb24gdG8gZXhwb3NlIHRoZSBfQWRkZWRUb0dlbmVyYXRpb24gZXZlbnQgdG8gY29udHJhY3RzLgogICAgICAgIC8vLyBAcGFyYW0gcmVzb3VyY2VBZGRyZXNzIFRoZSBhZGRyZXNzIHRoYXQgd2FzIHJlbW92ZWQuCiAgICAgICAgLy8vIEBwYXJhbSBnZW5lcmF0aW9uSWQgVGhlIGlkIG9mIHRoZSBnZW5lcmF0aW9uLgogICAgICAgIGZ1bmN0aW9uIFJlbW92ZWRGcm9tR2VuZXJhdGlvbihhZGRyZXNzIHJlc291cmNlQWRkcmVzcywgdWludCBnZW5lcmF0aW9uSWQpIHB1YmxpYyB7CiAgICAgICAgICAgICAgICBfUmVtb3ZlZEZyb21HZW5lcmF0aW9uKHJlc291cmNlQWRkcmVzcywgZ2VuZXJhdGlvbklkKTsKICAgICAgICB9CgogICAgICAgIC8vLyBAZGV2IFJldHVybnMgYSBib29sZWFuIGFzIHRvIHdoZXRoZXIgdGhlIHByb3ZpZGVkIGFkZHJlc3MgaXMgYWxsb3dlZCB0byBlbnRlciB0aGUgcG9vbCBhdCB0aGlzIHRpbWUuCiAgICAgICAgLy8vIEBwYXJhbSBzZWxmIFRoZSBwb29sIHRvIG9wZXJhdGUgb24uCiAgICAgICAgLy8vIEBwYXJhbSByZXNvdXJjZUFkZHJlc3MgVGhlIGFkZHJlc3MgaW4gcXVlc3Rpb24KICAgICAgICAvLy8gQHBhcmFtIG1pbmltdW1Cb25kIFRoZSBtaW5pbXVtIGJvbmQgYW1vdW50IHRoYXQgc2hvdWxkIGJlIHJlcXVpcmVkIGZvciBlbnRyeS4KICAgICAgICBmdW5jdGlvbiBjYW5FbnRlclBvb2woUG9vbCBzdG9yYWdlIHNlbGYsIGFkZHJlc3MgcmVzb3VyY2VBZGRyZXNzLCB1aW50IG1pbmltdW1Cb25kKSBjb25zdGFudCByZXR1cm5zIChib29sKSB7CiAgICAgICAgICAgIC8qCiAgICAgICAgICAgICAqICAtIGJvbmQKICAgICAgICAgICAgICogIC0gcG9vbCBpcyBvcGVuCiAgICAgICAgICAgICAqICAtIG5vdCBhbHJlYWR5IGluIGl0LgogICAgICAgICAgICAgKiAgLSBub3QgYWxyZWFkeSBsZWZ0IGl0LgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgLy8gVE9ETzogdGVzdHMKICAgICAgICAgICAgaWYgKHNlbGYuYm9uZHNbcmVzb3VyY2VBZGRyZXNzXSA8IG1pbmltdW1Cb25kKSB7CiAgICAgICAgICAgICAgICAvLyBJbnN1ZmZpY2llbnQgYm9uZCBiYWxhbmNlOwogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoaXNJblBvb2woc2VsZiwgcmVzb3VyY2VBZGRyZXNzKSkgewogICAgICAgICAgICAgICAgLy8gQWxyZWFkeSBpbiB0aGUgcG9vbCBlaXRoZXIgaW4gdGhlIG5leHQgdXBjb21pbmcgZ2VuZXJhdGlvbgogICAgICAgICAgICAgICAgLy8gb3IgdGhlIGN1cnJlbnRseSBhY3RpdmUgZ2VuZXJhdGlvbi4KICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIG5leHRHZW5lcmF0aW9uSWQgPSBnZXROZXh0R2VuZXJhdGlvbklkKHNlbGYpOwogICAgICAgICAgICBpZiAobmV4dEdlbmVyYXRpb25JZCAhPSAwKSB7CiAgICAgICAgICAgICAgICB2YXIgbmV4dEdlbmVyYXRpb24gPSBzZWxmLmdlbmVyYXRpb25zW25leHRHZW5lcmF0aW9uSWRdOwogICAgICAgICAgICAgICAgaWYgKGJsb2NrLm51bWJlciArIHNlbGYuZnJlZXplUGVyaW9kID49IG5leHRHZW5lcmF0aW9uLnN0YXJ0QXQpIHsKICAgICAgICAgICAgICAgICAgICAvLyBOZXh0IGdlbmVyYXRpb24gc3RhcnRzIHRvbyBzb29uLgogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQoKICAgICAgICAvLy8gQGRldiBBZGRzIHRoZSBhZGRyZXNzIHRvIHBvb2wgYnkgYWRkaW5nIHRoZW0gdG8gdGhlIG5leHQgZ2VuZXJhdGlvbiAoYXMgd2VsbCBhcyBjcmVhdGluZyBpdCBpZiBpdCBkb2Vzbid0IGV4aXN0KS4KICAgICAgICAvLy8gQHBhcmFtIHNlbGYgVGhlIHBvb2wgdG8gb3BlcmF0ZSBvbi4KICAgICAgICAvLy8gQHBhcmFtIHJlc291cmNlQWRkcmVzcyBUaGUgYWRkcmVzcyB0byBiZSBhZGRlZCB0byB0aGUgcG9vbAogICAgICAgIC8vLyBAcGFyYW0gbWluaW11bUJvbmQgVGhlIG1pbmltdW0gYm9uZCBhbW91bnQgdGhhdCBzaG91bGQgYmUgcmVxdWlyZWQgZm9yIGVudHJ5LgogICAgICAgIGZ1bmN0aW9uIGVudGVyUG9vbChQb29sIHN0b3JhZ2Ugc2VsZiwgYWRkcmVzcyByZXNvdXJjZUFkZHJlc3MsIHVpbnQgbWluaW11bUJvbmQpIHB1YmxpYyByZXR1cm5zICh1aW50KSB7CiAgICAgICAgICAgIGlmICghY2FuRW50ZXJQb29sKHNlbGYsIHJlc291cmNlQWRkcmVzcywgbWluaW11bUJvbmQpKSB7CiAgICAgICAgICAgICAgICB0aHJvdzsKICAgICAgICAgICAgfQogICAgICAgICAgICB1aW50IG5leHRHZW5lcmF0aW9uSWQgPSBnZXROZXh0R2VuZXJhdGlvbklkKHNlbGYpOwogICAgICAgICAgICBpZiAobmV4dEdlbmVyYXRpb25JZCA9PSAwKSB7CiAgICAgICAgICAgICAgICAvLyBObyBuZXh0IGdlbmVyYXRpb24gaGFzIGZvcm1lZCB5ZXQgc28gY3JlYXRlIGl0LgogICAgICAgICAgICAgICAgbmV4dEdlbmVyYXRpb25JZCA9IGNyZWF0ZU5leHRHZW5lcmF0aW9uKHNlbGYpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIEdlbmVyYXRpb24gc3RvcmFnZSBuZXh0R2VuZXJhdGlvbiA9IHNlbGYuZ2VuZXJhdGlvbnNbbmV4dEdlbmVyYXRpb25JZF07CiAgICAgICAgICAgIC8vIG5vdyBhZGQgdGhlIG5ldyBhZGRyZXNzLgogICAgICAgICAgICBuZXh0R2VuZXJhdGlvbi5tZW1iZXJzLmxlbmd0aCArPSAxOwogICAgICAgICAgICBuZXh0R2VuZXJhdGlvbi5tZW1iZXJzW25leHRHZW5lcmF0aW9uLm1lbWJlcnMubGVuZ3RoIC0gMV0gPSByZXNvdXJjZUFkZHJlc3M7CiAgICAgICAgICAgIHJldHVybiBuZXh0R2VuZXJhdGlvbklkOwogICAgICAgIH0KCiAgICAgICAgLy8vIEBkZXYgUmV0dXJucyBhIGJvb2xlYW4gYXMgdG8gd2hldGhlciB0aGUgcHJvdmlkZWQgYWRkcmVzcyBpcyBhbGxvd2VkIHRvIGV4aXQgdGhlIHBvb2wgYXQgdGhpcyB0aW1lLgogICAgICAgIC8vLyBAcGFyYW0gc2VsZiBUaGUgcG9vbCB0byBvcGVyYXRlIG9uLgogICAgICAgIC8vLyBAcGFyYW0gcmVzb3VyY2VBZGRyZXNzIFRoZSBhZGRyZXNzIGluIHF1ZXN0aW9uCiAgICAgICAgZnVuY3Rpb24gY2FuRXhpdFBvb2woUG9vbCBzdG9yYWdlIHNlbGYsIGFkZHJlc3MgcmVzb3VyY2VBZGRyZXNzKSBjb25zdGFudCByZXR1cm5zIChib29sKSB7CiAgICAgICAgICAgIGlmICghaXNJbkN1cnJlbnRHZW5lcmF0aW9uKHNlbGYsIHJlc291cmNlQWRkcmVzcykpIHsKICAgICAgICAgICAgICAgIC8vIE5vdCBpbiB0aGUgcG9vbC4KICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdWludCBuZXh0R2VuZXJhdGlvbklkID0gZ2V0TmV4dEdlbmVyYXRpb25JZChzZWxmKTsKICAgICAgICAgICAgaWYgKG5leHRHZW5lcmF0aW9uSWQgPT0gMCkgewogICAgICAgICAgICAgICAgLy8gTmV4dCBnZW5lcmF0aW9uIGhhc24ndCBiZWVuIGdlbmVyYXRlZCB5ZXQuCiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHNlbGYuZ2VuZXJhdGlvbnNbbmV4dEdlbmVyYXRpb25JZF0uc3RhcnRBdCAtIHNlbGYuZnJlZXplUGVyaW9kIDw9IGJsb2NrLm51bWJlcikgewogICAgICAgICAgICAgICAgLy8gTmV4dCBnZW5lcmF0aW9uIHN0YXJ0cyB0b28gc29vbi4KICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gVGhleSBjYW4gbGVhdmUgaWYgdGhleSBhcmUgc3RpbGwgaW4gdGhlIG5leHQgZ2VuZXJhdGlvbi4KICAgICAgICAgICAgLy8gb3RoZXJ3aXNlIHRoZXkgaGF2ZSBhbHJlYWR5IGxlZnQgaXQuCiAgICAgICAgICAgIHJldHVybiBpc0luTmV4dEdlbmVyYXRpb24oc2VsZiwgcmVzb3VyY2VBZGRyZXNzKTsKICAgICAgICB9CgoKICAgICAgICAvLy8gQGRldiBSZW1vdmVzIHRoZSBhZGRyZXNzIGZyb20gdGhlIHBvb2wgYnkgcmVtb3ZpbmcgdGhlbSBmcm9tIHRoZSBuZXh0IGdlbmVyYXRpb24gKGFzIHdlbGwgYXMgY3JlYXRpbmcgaXQgaWYgaXQgZG9lc24ndCBleGlzdCkKICAgICAgICAvLy8gQHBhcmFtIHNlbGYgVGhlIHBvb2wgdG8gb3BlcmF0ZSBvbi4KICAgICAgICAvLy8gQHBhcmFtIHJlc291cmNlQWRkcmVzcyBUaGUgYWRkcmVzcyBpbiBxdWVzdGlvbgogICAgICAgIGZ1bmN0aW9uIGV4aXRQb29sKFBvb2wgc3RvcmFnZSBzZWxmLCBhZGRyZXNzIHJlc291cmNlQWRkcmVzcykgcHVibGljIHJldHVybnMgKHVpbnQpIHsKICAgICAgICAgICAgaWYgKCFjYW5FeGl0UG9vbChzZWxmLCByZXNvdXJjZUFkZHJlc3MpKSB7CiAgICAgICAgICAgICAgICB0aHJvdzsKICAgICAgICAgICAgfQogICAgICAgICAgICB1aW50IG5leHRHZW5lcmF0aW9uSWQgPSBnZXROZXh0R2VuZXJhdGlvbklkKHNlbGYpOwogICAgICAgICAgICBpZiAobmV4dEdlbmVyYXRpb25JZCA9PSAwKSB7CiAgICAgICAgICAgICAgICAvLyBObyBuZXh0IGdlbmVyYXRpb24gaGFzIGZvcm1lZCB5ZXQgc28gY3JlYXRlIGl0LgogICAgICAgICAgICAgICAgbmV4dEdlbmVyYXRpb25JZCA9IGNyZWF0ZU5leHRHZW5lcmF0aW9uKHNlbGYpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIFJlbW92ZSB0aGVtIGZyb20gdGhlIGdlbmVyYXRpb24KICAgICAgICAgICAgcmVtb3ZlRnJvbUdlbmVyYXRpb24oc2VsZiwgbmV4dEdlbmVyYXRpb25JZCwgcmVzb3VyY2VBZGRyZXNzKTsKICAgICAgICAgICAgcmV0dXJuIG5leHRHZW5lcmF0aW9uSWQ7CiAgICAgICAgfQoKICAgICAgICAvLy8gQGRldiBSZW1vdmVzIHRoZSBhZGRyZXNzIGZyb20gYSBnZW5lcmF0aW9uJ3MgbWVtYmVycyBhcnJheS4gUmV0dXJucyBib29sZWFuIGFzIHRvIHdoZXRoZXIgcmVtb3ZhbCB3YXMgc3VjY2Vzc2Z1bC4KICAgICAgICAvLy8gQHBhcmFtIHNlbGYgVGhlIHBvb2wgdG8gb3BlcmF0ZSBvbi4KICAgICAgICAvLy8gQHBhcmFtIGdlbmVyYXRpb25JZCBUaGUgaWQgb2YgdGhlIGdlbmVyYXRpb24gdG8gb3BlcmF0ZSBvbi4KICAgICAgICAvLy8gQHBhcmFtIHJlc291cmNlQWRkcmVzcyBUaGUgYWRkcmVzcyB0byBiZSByZW1vdmVkLgogICAgICAgIGZ1bmN0aW9uIHJlbW92ZUZyb21HZW5lcmF0aW9uKFBvb2wgc3RvcmFnZSBzZWxmLCB1aW50IGdlbmVyYXRpb25JZCwgYWRkcmVzcyByZXNvdXJjZUFkZHJlc3MpIHB1YmxpYyByZXR1cm5zIChib29sKXsKICAgICAgICAgICAgR2VuZXJhdGlvbiBzdG9yYWdlIGdlbmVyYXRpb24gPSBzZWxmLmdlbmVyYXRpb25zW2dlbmVyYXRpb25JZF07CiAgICAgICAgICAgIC8vIG5vdyByZW1vdmUgdGhlIGFkZHJlc3MKICAgICAgICAgICAgZm9yICh1aW50IGkgPSAwOyBpIDwgZ2VuZXJhdGlvbi5tZW1iZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAoZ2VuZXJhdGlvbi5tZW1iZXJzW2ldID09IHJlc291cmNlQWRkcmVzcykgewogICAgICAgICAgICAgICAgICAgIGdlbmVyYXRpb24ubWVtYmVyc1tpXSA9IGdlbmVyYXRpb24ubWVtYmVyc1tnZW5lcmF0aW9uLm1lbWJlcnMubGVuZ3RoIC0gMV07CiAgICAgICAgICAgICAgICAgICAgZ2VuZXJhdGlvbi5tZW1iZXJzLmxlbmd0aCAtPSAxOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIC8qCiAgICAgICAgICogIEJvbmRpbmcKICAgICAgICAgKi8KCiAgICAgICAgLy8vIEBkZXYgU3VidHJhY3RzIHRoZSBhbW91bnQgZnJvbSBhbiBhY2NvdW50J3MgYm9uZCBiYWxhbmNlLgogICAgICAgIC8vLyBAcGFyYW0gc2VsZiBUaGUgcG9vbCB0byBvcGVyYXRlIG9uLgogICAgICAgIC8vLyBAcGFyYW0gcmVzb3VyY2VBZGRyZXNzIFRoZSBhZGRyZXNzIG9mIHRoZSBhY2NvdW50CiAgICAgICAgLy8vIEBwYXJhbSB2YWx1ZSBUaGUgdmFsdWUgdG8gc3VidHJhY3QuCiAgICAgICAgZnVuY3Rpb24gZGVkdWN0RnJvbUJvbmQoUG9vbCBzdG9yYWdlIHNlbGYsIGFkZHJlc3MgcmVzb3VyY2VBZGRyZXNzLCB1aW50IHZhbHVlKSBwdWJsaWMgewogICAgICAgICAgICAgICAgLyoKICAgICAgICAgICAgICAgICAqICBkZWR1Y3QgZnVuZHMgZnJvbSBhIGJvbmQgdmFsdWUgd2l0aG91dCByaXNrIG9mIGFuCiAgICAgICAgICAgICAgICAgKiAgdW5kZXJmbG93LgogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBpZiAodmFsdWUgPiBzZWxmLmJvbmRzW3Jlc291cmNlQWRkcmVzc10pIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gUHJldmVudCBVbmRlcmZsb3cuCiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc2VsZi5ib25kc1tyZXNvdXJjZUFkZHJlc3NdIC09IHZhbHVlOwogICAgICAgIH0KCiAgICAgICAgLy8vIEBkZXYgQWRkcyB0aGUgYW1vdW50IHRvIGFuIGFjY291bnQncyBib25kIGJhbGFuY2UuCiAgICAgICAgLy8vIEBwYXJhbSBzZWxmIFRoZSBwb29sIHRvIG9wZXJhdGUgb24uCiAgICAgICAgLy8vIEBwYXJhbSByZXNvdXJjZUFkZHJlc3MgVGhlIGFkZHJlc3Mgb2YgdGhlIGFjY291bnQKICAgICAgICAvLy8gQHBhcmFtIHZhbHVlIFRoZSB2YWx1ZSB0byBhZGQuCiAgICAgICAgZnVuY3Rpb24gYWRkVG9Cb25kKFBvb2wgc3RvcmFnZSBzZWxmLCBhZGRyZXNzIHJlc291cmNlQWRkcmVzcywgdWludCB2YWx1ZSkgcHVibGljIHsKICAgICAgICAgICAgICAgIC8qCiAgICAgICAgICAgICAgICAgKiAgQWRkIGZ1bmRzIHRvIGEgYm9uZCB2YWx1ZSB3aXRob3V0IHJpc2sgb2YgYW4KICAgICAgICAgICAgICAgICAqICBvdmVyZmxvdy4KICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgaWYgKHNlbGYuYm9uZHNbcmVzb3VyY2VBZGRyZXNzXSArIHZhbHVlIDwgc2VsZi5ib25kc1tyZXNvdXJjZUFkZHJlc3NdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFByZXZlbnQgT3ZlcmZsb3cKICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3c7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzZWxmLmJvbmRzW3Jlc291cmNlQWRkcmVzc10gKz0gdmFsdWU7CiAgICAgICAgfQoKICAgICAgICAvLy8gQGRldiBXaXRoZHJhd3MgYSBib25kIGFtb3VudCBmcm9tIGFuIGFkZHJlc3MncyBib25kIGFjY291bnQsIHNlbmRpbmcgdGhlbSB0aGUgY29ycmVzcG9uZGluZyBhbW91bnQgaW4gZXRoZXIuCiAgICAgICAgLy8vIEBwYXJhbSBzZWxmIFRoZSBwb29sIHRvIG9wZXJhdGUgb24uCiAgICAgICAgLy8vIEBwYXJhbSByZXNvdXJjZUFkZHJlc3MgVGhlIGFkZHJlc3Mgb2YgdGhlIGFjY291bnQKICAgICAgICAvLy8gQHBhcmFtIHZhbHVlIFRoZSB2YWx1ZSB0byB3aXRoZHJhdy4KICAgICAgICBmdW5jdGlvbiB3aXRoZHJhd0JvbmQoUG9vbCBzdG9yYWdlIHNlbGYsIGFkZHJlc3MgcmVzb3VyY2VBZGRyZXNzLCB1aW50IHZhbHVlLCB1aW50IG1pbmltdW1Cb25kKSBwdWJsaWMgewogICAgICAgICAgICAgICAgLyoKICAgICAgICAgICAgICAgICAqICBPbmx5IGlmIHlvdSBhcmUgbm90IGluIGVpdGhlciBvZiB0aGUgY3VycmVudCBjYWxsIHBvb2xzLgogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAvLyBQcmV2ZW50IHVuZGVyZmxvdwogICAgICAgICAgICAgICAgaWYgKHZhbHVlID4gc2VsZi5ib25kc1tyZXNvdXJjZUFkZHJlc3NdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIERvIGEgcGVybWlzc2lvbnMgY2hlY2sgdG8gYmUgc3VyZSB0aGV5IGNhbiB3aXRoZHJhdyB0aGUKICAgICAgICAgICAgICAgIC8vIGZ1bmRzLgogICAgICAgICAgICAgICAgaWYgKGlzSW5Qb29sKHNlbGYsIHJlc291cmNlQWRkcmVzcykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNlbGYuYm9uZHNbcmVzb3VyY2VBZGRyZXNzXSAtIHZhbHVlIDwgbWluaW11bUJvbmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGRlZHVjdEZyb21Cb25kKHNlbGYsIHJlc291cmNlQWRkcmVzcywgdmFsdWUpOwogICAgICAgICAgICAgICAgaWYgKCFyZXNvdXJjZUFkZHJlc3Muc2VuZCh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gUG90ZW50aWFsbHkgc2VuZGluZyBtb25leSB0byBhIGNvbnRyYWN0IHRoYXQKICAgICAgICAgICAgICAgICAgICAgICAgLy8gaGFzIGEgZmFsbGJhY2sgZnVuY3Rpb24uICBTbyBpbnN0ZWFkLCB0cnkKICAgICAgICAgICAgICAgICAgICAgICAgLy8gdHJhbmZlcnJpbmcgdGhlIGZ1bmRzIHdpdGggdGhlIGNhbGwgYXBpLgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXJlc291cmNlQWRkcmVzcy5jYWxsLmdhcyhtc2cuZ2FzKS52YWx1ZSh2YWx1ZSkoKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJldmVydCB0aGUgZW50aXJlIHRyYW5zYWN0aW9uLiAgTm8KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBuZWVkIHRvIGRlc3Ryb3kgdGhlIGZ1bmRzLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93OwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgfQp9CgoKY29udHJhY3QgUmVsYXkgewogICAgICAgIGFkZHJlc3Mgb3BlcmF0b3I7CgogICAgICAgIGZ1bmN0aW9uIFJlbGF5KCkgewogICAgICAgICAgICAgICAgb3BlcmF0b3IgPSBtc2cuc2VuZGVyOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gcmVsYXlDYWxsKGFkZHJlc3MgY29udHJhY3RBZGRyZXNzLCBieXRlczQgYWJpU2lnbmF0dXJlLCBieXRlcyBkYXRhKSBwdWJsaWMgcmV0dXJucyAoYm9vbCkgewogICAgICAgICAgICAgICAgaWYgKG1zZy5zZW5kZXIgIT0gb3BlcmF0b3IpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3c7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gY29udHJhY3RBZGRyZXNzLmNhbGwoYWJpU2lnbmF0dXJlLCBkYXRhKTsKICAgICAgICB9Cn0KCgoKCmxpYnJhcnkgU2NoZWR1bGVkQ2FsbExpYiB7CiAgICAvKgogICAgICogIEFkZHJlc3M6IDB4NWMzNjIzZGNlZjJkNTE2OGRiZTNlOGNjNTM4Nzg4Y2Q4OTEyZDg5OAogICAgICovCiAgICBzdHJ1Y3QgQ2FsbERhdGFiYXNlIHsKICAgICAgICBSZWxheSB1bmF1dGhvcml6ZWRSZWxheTsKICAgICAgICBSZWxheSBhdXRob3JpemVkUmVsYXk7CgogICAgICAgIGJ5dGVzMzIgbGFzdENhbGxLZXk7CiAgICAgICAgYnl0ZXMgbGFzdERhdGE7CiAgICAgICAgdWludCBsYXN0RGF0YUxlbmd0aDsKICAgICAgICBieXRlczMyIGxhc3REYXRhSGFzaDsKCiAgICAgICAgUmVzb3VyY2VQb29sTGliLlBvb2wgY2FsbGVyUG9vbDsKICAgICAgICBHcm92ZUxpYi5JbmRleCBjYWxsSW5kZXg7CgogICAgICAgIEFjY291bnRpbmdMaWIuQmFuayBnYXNCYW5rOwoKICAgICAgICBtYXBwaW5nIChieXRlczMyID0+IENhbGwpIGNhbGxzOwogICAgICAgIG1hcHBpbmcgKGJ5dGVzMzIgPT4gYnl0ZXMpIGRhdGFfcmVnaXN0cnk7CgogICAgICAgIG1hcHBpbmcgKGJ5dGVzMzIgPT4gYm9vbCkgYWNjb3VudEF1dGhvcml6YXRpb25zOwogICAgfQoKICAgIHN0cnVjdCBDYWxsIHsKICAgICAgICAgICAgYWRkcmVzcyBjb250cmFjdEFkZHJlc3M7CiAgICAgICAgICAgIGFkZHJlc3Mgc2NoZWR1bGVkQnk7CiAgICAgICAgICAgIHVpbnQgY2FsbGVkQXRCbG9jazsKICAgICAgICAgICAgdWludCB0YXJnZXRCbG9jazsKICAgICAgICAgICAgdWludDggZ3JhY2VQZXJpb2Q7CiAgICAgICAgICAgIHVpbnQgbm9uY2U7CiAgICAgICAgICAgIHVpbnQgYmFzZUdhc1ByaWNlOwogICAgICAgICAgICB1aW50IGdhc1ByaWNlOwogICAgICAgICAgICB1aW50IGdhc1VzZWQ7CiAgICAgICAgICAgIHVpbnQgZ2FzQ29zdDsKICAgICAgICAgICAgdWludCBwYXlvdXQ7CiAgICAgICAgICAgIHVpbnQgZmVlOwogICAgICAgICAgICBhZGRyZXNzIGV4ZWN1dGVkQnk7CiAgICAgICAgICAgIGJ5dGVzNCBhYmlTaWduYXR1cmU7CiAgICAgICAgICAgIGJvb2wgaXNDYW5jZWxsZWQ7CiAgICAgICAgICAgIGJvb2wgd2FzQ2FsbGVkOwogICAgICAgICAgICBib29sIHdhc1N1Y2Nlc3NmdWw7CiAgICAgICAgICAgIGJ5dGVzMzIgZGF0YUhhc2g7CiAgICB9CgogICAgLy8gVGhlIGF1dGhvciAoUGlwZXIgTWVycmlhbSkgYWRkcmVzcy4KICAgIGFkZHJlc3MgY29uc3RhbnQgb3duZXIgPSAweGQzY2RhOTEzZGViNmY2Nzk2N2I5OWQ2N2FjZGZhMTcxMmMyOTM2MDE7CgogICAgLyoKICAgICAqICBHZXR0ZXIgbWV0aG9kcyBmb3IgYENhbGxgIGluZm9ybWF0aW9uCiAgICAgKi8KICAgIGZ1bmN0aW9uIGdldENhbGxDb250cmFjdEFkZHJlc3MoQ2FsbERhdGFiYXNlIHN0b3JhZ2Ugc2VsZiwgYnl0ZXMzMiBjYWxsS2V5KSBjb25zdGFudCByZXR1cm5zIChhZGRyZXNzKSB7CiAgICAgICAgICAgIHJldHVybiBzZWxmLmNhbGxzW2NhbGxLZXldLmNvbnRyYWN0QWRkcmVzczsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRDYWxsU2NoZWR1bGVkQnkoQ2FsbERhdGFiYXNlIHN0b3JhZ2Ugc2VsZiwgYnl0ZXMzMiBjYWxsS2V5KSBjb25zdGFudCByZXR1cm5zIChhZGRyZXNzKSB7CiAgICAgICAgICAgIHJldHVybiBzZWxmLmNhbGxzW2NhbGxLZXldLnNjaGVkdWxlZEJ5OwogICAgfQoKICAgIGZ1bmN0aW9uIGdldENhbGxDYWxsZWRBdEJsb2NrKENhbGxEYXRhYmFzZSBzdG9yYWdlIHNlbGYsIGJ5dGVzMzIgY2FsbEtleSkgY29uc3RhbnQgcmV0dXJucyAodWludCkgewogICAgICAgICAgICByZXR1cm4gc2VsZi5jYWxsc1tjYWxsS2V5XS5jYWxsZWRBdEJsb2NrOwogICAgfQoKICAgIGZ1bmN0aW9uIGdldENhbGxHcmFjZVBlcmlvZChDYWxsRGF0YWJhc2Ugc3RvcmFnZSBzZWxmLCBieXRlczMyIGNhbGxLZXkpIGNvbnN0YW50IHJldHVybnMgKHVpbnQpIHsKICAgICAgICAgICAgcmV0dXJuIHNlbGYuY2FsbHNbY2FsbEtleV0uZ3JhY2VQZXJpb2Q7CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0Q2FsbFRhcmdldEJsb2NrKENhbGxEYXRhYmFzZSBzdG9yYWdlIHNlbGYsIGJ5dGVzMzIgY2FsbEtleSkgY29uc3RhbnQgcmV0dXJucyAodWludCkgewogICAgICAgICAgICByZXR1cm4gc2VsZi5jYWxsc1tjYWxsS2V5XS50YXJnZXRCbG9jazsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRDYWxsQmFzZUdhc1ByaWNlKENhbGxEYXRhYmFzZSBzdG9yYWdlIHNlbGYsIGJ5dGVzMzIgY2FsbEtleSkgY29uc3RhbnQgcmV0dXJucyAodWludCkgewogICAgICAgICAgICByZXR1cm4gc2VsZi5jYWxsc1tjYWxsS2V5XS5iYXNlR2FzUHJpY2U7CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0Q2FsbEdhc1ByaWNlKENhbGxEYXRhYmFzZSBzdG9yYWdlIHNlbGYsIGJ5dGVzMzIgY2FsbEtleSkgY29uc3RhbnQgcmV0dXJucyAodWludCkgewogICAgICAgICAgICByZXR1cm4gc2VsZi5jYWxsc1tjYWxsS2V5XS5nYXNQcmljZTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRDYWxsR2FzVXNlZChDYWxsRGF0YWJhc2Ugc3RvcmFnZSBzZWxmLCBieXRlczMyIGNhbGxLZXkpIGNvbnN0YW50IHJldHVybnMgKHVpbnQpIHsKICAgICAgICAgICAgcmV0dXJuIHNlbGYuY2FsbHNbY2FsbEtleV0uZ2FzVXNlZDsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRDYWxsQUJJU2lnbmF0dXJlKENhbGxEYXRhYmFzZSBzdG9yYWdlIHNlbGYsIGJ5dGVzMzIgY2FsbEtleSkgY29uc3RhbnQgcmV0dXJucyAoYnl0ZXM0KSB7CiAgICAgICAgICAgIHJldHVybiBzZWxmLmNhbGxzW2NhbGxLZXldLmFiaVNpZ25hdHVyZTsKICAgIH0KCiAgICBmdW5jdGlvbiBjaGVja0lmQ2FsbGVkKENhbGxEYXRhYmFzZSBzdG9yYWdlIHNlbGYsIGJ5dGVzMzIgY2FsbEtleSkgY29uc3RhbnQgcmV0dXJucyAoYm9vbCkgewogICAgICAgICAgICByZXR1cm4gc2VsZi5jYWxsc1tjYWxsS2V5XS53YXNDYWxsZWQ7CiAgICB9CgogICAgZnVuY3Rpb24gY2hlY2tJZlN1Y2Nlc3MoQ2FsbERhdGFiYXNlIHN0b3JhZ2Ugc2VsZiwgYnl0ZXMzMiBjYWxsS2V5KSBjb25zdGFudCByZXR1cm5zIChib29sKSB7CiAgICAgICAgICAgIHJldHVybiBzZWxmLmNhbGxzW2NhbGxLZXldLndhc1N1Y2Nlc3NmdWw7CiAgICB9CgogICAgZnVuY3Rpb24gY2hlY2tJZkNhbmNlbGxlZChDYWxsRGF0YWJhc2Ugc3RvcmFnZSBzZWxmLCBieXRlczMyIGNhbGxLZXkpIGNvbnN0YW50IHJldHVybnMgKGJvb2wpIHsKICAgICAgICAgICAgcmV0dXJuIHNlbGYuY2FsbHNbY2FsbEtleV0uaXNDYW5jZWxsZWQ7CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0Q2FsbERhdGFIYXNoKENhbGxEYXRhYmFzZSBzdG9yYWdlIHNlbGYsIGJ5dGVzMzIgY2FsbEtleSkgY29uc3RhbnQgcmV0dXJucyAoYnl0ZXMzMikgewogICAgICAgICAgICByZXR1cm4gc2VsZi5jYWxsc1tjYWxsS2V5XS5kYXRhSGFzaDsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRDYWxsUGF5b3V0KENhbGxEYXRhYmFzZSBzdG9yYWdlIHNlbGYsIGJ5dGVzMzIgY2FsbEtleSkgY29uc3RhbnQgcmV0dXJucyAodWludCkgewogICAgICAgICAgICByZXR1cm4gc2VsZi5jYWxsc1tjYWxsS2V5XS5wYXlvdXQ7CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0Q2FsbEZlZShDYWxsRGF0YWJhc2Ugc3RvcmFnZSBzZWxmLCBieXRlczMyIGNhbGxLZXkpIGNvbnN0YW50IHJldHVybnMgKHVpbnQpIHsKICAgICAgICAgICAgcmV0dXJuIHNlbGYuY2FsbHNbY2FsbEtleV0uZmVlOwogICAgfQoKICAgIC8qCiAgICAgKiAgU2NoZWR1bGluZyBBdXRob3JpemF0aW9uIEFQSQogICAgICovCgogICAgZnVuY3Rpb24gYWRkQXV0aG9yaXphdGlvbihDYWxsRGF0YWJhc2Ugc3RvcmFnZSBzZWxmLCBhZGRyZXNzIHNjaGVkdWxlckFkZHJlc3MsIGFkZHJlc3MgY29udHJhY3RBZGRyZXNzKSBwdWJsaWMgewogICAgICAgICAgICBzZWxmLmFjY291bnRBdXRob3JpemF0aW9uc1tzaGEzKHNjaGVkdWxlckFkZHJlc3MsIGNvbnRyYWN0QWRkcmVzcyldID0gdHJ1ZTsKICAgIH0KCiAgICBmdW5jdGlvbiByZW1vdmVBdXRob3JpemF0aW9uKENhbGxEYXRhYmFzZSBzdG9yYWdlIHNlbGYsIGFkZHJlc3Mgc2NoZWR1bGVyQWRkcmVzcywgYWRkcmVzcyBjb250cmFjdEFkZHJlc3MpIHB1YmxpYyB7CiAgICAgICAgICAgIHNlbGYuYWNjb3VudEF1dGhvcml6YXRpb25zW3NoYTMoc2NoZWR1bGVyQWRkcmVzcywgY29udHJhY3RBZGRyZXNzKV0gPSBmYWxzZTsKICAgIH0KCiAgICBmdW5jdGlvbiBjaGVja0F1dGhvcml6YXRpb24oQ2FsbERhdGFiYXNlIHN0b3JhZ2Ugc2VsZiwgYWRkcmVzcyBzY2hlZHVsZXJBZGRyZXNzLCBhZGRyZXNzIGNvbnRyYWN0QWRkcmVzcykgY29uc3RhbnQgcmV0dXJucyAoYm9vbCkgewogICAgICAgICAgICByZXR1cm4gc2VsZi5hY2NvdW50QXV0aG9yaXphdGlvbnNbc2hhMyhzY2hlZHVsZXJBZGRyZXNzLCBjb250cmFjdEFkZHJlc3MpXTsKICAgIH0KCiAgICAvKgogICAgICogIERhdGEgUmVnaXN0cnkgQVBJCiAgICAgKi8KICAgIGZ1bmN0aW9uIGdldENhbGxEYXRhKENhbGxEYXRhYmFzZSBzdG9yYWdlIHNlbGYsIGJ5dGVzMzIgY2FsbEtleSkgY29uc3RhbnQgcmV0dXJucyAoYnl0ZXMpIHsKICAgICAgICAgICAgcmV0dXJuIHNlbGYuZGF0YV9yZWdpc3RyeVtzZWxmLmNhbGxzW2NhbGxLZXldLmRhdGFIYXNoXTsKICAgIH0KCiAgICAvKgogICAgICogIEFQSSB1c2VkIGJ5IEFsYXJtIHNlcnZpY2UKICAgICAqLwogICAgLy8gVGhlIG51bWJlciBvZiBibG9ja3MgdGhhdCBlYWNoIGNhbGxlciBpbiB0aGUgcG9vbCBoYXMgdG8gY29tcGxldGUgdGhlaXIKICAgIC8vIGNhbGwuCiAgICB1aW50IGNvbnN0YW50IENBTExfV0lORE9XX1NJWkUgPSAxNjsKCiAgICBmdW5jdGlvbiBnZXRHZW5lcmF0aW9uSWRGb3JDYWxsKENhbGxEYXRhYmFzZSBzdG9yYWdlIHNlbGYsIGJ5dGVzMzIgY2FsbEtleSkgY29uc3RhbnQgcmV0dXJucyAodWludCkgewogICAgICAgICAgICBDYWxsIGNhbGwgPSBzZWxmLmNhbGxzW2NhbGxLZXldOwogICAgICAgICAgICByZXR1cm4gUmVzb3VyY2VQb29sTGliLmdldEdlbmVyYXRpb25Gb3JXaW5kb3coc2VsZi5jYWxsZXJQb29sLCBjYWxsLnRhcmdldEJsb2NrLCBjYWxsLnRhcmdldEJsb2NrICsgY2FsbC5ncmFjZVBlcmlvZCk7CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0RGVzaWduYXRlZENhbGxlcihDYWxsRGF0YWJhc2Ugc3RvcmFnZSBzZWxmLCBieXRlczMyIGNhbGxLZXksIHVpbnQgYmxvY2tOdW1iZXIpIGNvbnN0YW50IHJldHVybnMgKGFkZHJlc3MpIHsKICAgICAgICAgICAgLyoKICAgICAgICAgICAgICogIFJldHVybnMgdGhlIGNhbGxlciBmcm9tIHRoZSBjdXJyZW50IGNhbGwgcG9vbCB3aG8gaXMKICAgICAgICAgICAgICogIGRlc2lnbmF0ZWQgYXMgdGhlIGV4ZWN1dG9yIG9mIHRoaXMgY2FsbC4KICAgICAgICAgICAgICovCiAgICAgICAgICAgIENhbGwgY2FsbCA9IHNlbGYuY2FsbHNbY2FsbEtleV07CiAgICAgICAgICAgIGlmIChibG9ja051bWJlciA8IGNhbGwudGFyZ2V0QmxvY2sgfHwgYmxvY2tOdW1iZXIgPiBjYWxsLnRhcmdldEJsb2NrICsgY2FsbC5ncmFjZVBlcmlvZCkgewogICAgICAgICAgICAgICAgICAgIC8vIGJsb2NrTnVtYmVyIG5vdCB3aXRoaW4gY2FsbCB3aW5kb3cuCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDB4MDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQ2hlY2sgaWYgd2UgYXJlIGluIGZyZWUtZm9yLWFsbCB3aW5kb3cuCiAgICAgICAgICAgIHVpbnQgbnVtV2luZG93cyA9IGNhbGwuZ3JhY2VQZXJpb2QgLyBDQUxMX1dJTkRPV19TSVpFOwogICAgICAgICAgICB1aW50IGJsb2NrV2luZG93ID0gKGJsb2NrTnVtYmVyIC0gY2FsbC50YXJnZXRCbG9jaykgLyBDQUxMX1dJTkRPV19TSVpFOwoKICAgICAgICAgICAgaWYgKGJsb2NrV2luZG93ICsgMiA+IG51bVdpbmRvd3MpIHsKICAgICAgICAgICAgICAgICAgICAvLyBXZSBhcmUgd2l0aGluIHRoZSBmcmVlLWZvci1hbGwgcGVyaW9kLgogICAgICAgICAgICAgICAgICAgIHJldHVybiAweDA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIExvb2t1cCB0aGUgcG9vbCB0aGF0IGZ1bGwgY29udGFpbnMgdGhlIGNhbGwgd2luZG93IGZvciB0aGlzCiAgICAgICAgICAgIC8vIGNhbGwuCiAgICAgICAgICAgIHVpbnQgZ2VuZXJhdGlvbklkID0gUmVzb3VyY2VQb29sTGliLmdldEdlbmVyYXRpb25Gb3JXaW5kb3coc2VsZi5jYWxsZXJQb29sLCBjYWxsLnRhcmdldEJsb2NrLCBjYWxsLnRhcmdldEJsb2NrICsgY2FsbC5ncmFjZVBlcmlvZCk7CiAgICAgICAgICAgIGlmIChnZW5lcmF0aW9uSWQgPT0gMCkgewogICAgICAgICAgICAgICAgICAgIC8vIE5vIHBvb2wgY3VycmVudGx5IGluIG9wZXJhdGlvbi4KICAgICAgICAgICAgICAgICAgICByZXR1cm4gMHgwOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBnZW5lcmF0aW9uID0gc2VsZi5jYWxsZXJQb29sLmdlbmVyYXRpb25zW2dlbmVyYXRpb25JZF07CgogICAgICAgICAgICB1aW50IG9mZnNldCA9IHVpbnQoY2FsbEtleSkgJSBnZW5lcmF0aW9uLm1lbWJlcnMubGVuZ3RoOwogICAgICAgICAgICByZXR1cm4gZ2VuZXJhdGlvbi5tZW1iZXJzWyhvZmZzZXQgKyBibG9ja1dpbmRvdykgJSBnZW5lcmF0aW9uLm1lbWJlcnMubGVuZ3RoXTsKICAgIH0KCiAgICBldmVudCBfQXdhcmRlZE1pc3NlZEJsb2NrQm9udXMoYWRkcmVzcyBpbmRleGVkIGZyb21DYWxsZXIsIGFkZHJlc3MgaW5kZXhlZCB0b0NhbGxlciwgdWludCBpbmRleGVkIGdlbmVyYXRpb25JZCwgYnl0ZXMzMiBjYWxsS2V5LCB1aW50IGJsb2NrTnVtYmVyLCB1aW50IGJvbnVzQW1vdW50KTsKICAgIGZ1bmN0aW9uIEF3YXJkZWRNaXNzZWRCbG9ja0JvbnVzKGFkZHJlc3MgZnJvbUNhbGxlciwgYWRkcmVzcyB0b0NhbGxlciwgdWludCBnZW5lcmF0aW9uSWQsIGJ5dGVzMzIgY2FsbEtleSwgdWludCBibG9ja051bWJlciwgdWludCBib251c0Ftb3VudCkgcHVibGljIHsKICAgICAgICBfQXdhcmRlZE1pc3NlZEJsb2NrQm9udXMoZnJvbUNhbGxlciwgdG9DYWxsZXIsIGdlbmVyYXRpb25JZCwgY2FsbEtleSwgYmxvY2tOdW1iZXIsIGJvbnVzQW1vdW50KTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRNaW5pbXVtQm9uZCgpIGNvbnN0YW50IHJldHVybnMgKHVpbnQpIHsKICAgICAgICAgICAgcmV0dXJuIHR4Lmdhc3ByaWNlICogYmxvY2suZ2FzbGltaXQ7CiAgICB9CgogICAgZnVuY3Rpb24gZG9Cb25kQm9udXNUcmFuc2ZlcihDYWxsRGF0YWJhc2Ugc3RvcmFnZSBzZWxmLCBhZGRyZXNzIGZyb21DYWxsZXIsIGFkZHJlc3MgdG9DYWxsZXIpIGludGVybmFsIHJldHVybnMgKHVpbnQpIHsKICAgICAgICAgICAgdWludCBib251c0Ftb3VudCA9IGdldE1pbmltdW1Cb25kKCk7CiAgICAgICAgICAgIHVpbnQgYm9uZEJhbGFuY2UgPSBzZWxmLmNhbGxlclBvb2wuYm9uZHNbZnJvbUNhbGxlcl07CgogICAgICAgICAgICAvLyBJZiB0aGUgYm9uZCBiYWxhbmNlIGlzIGxvd2VyIHRoYW4gdGhlIGF3YXJkCiAgICAgICAgICAgIC8vIGJhbGFuY2UsIHRoZW4gYWRqdXN0IHRoZSByZXdhcmQgYW1vdW50IHRvCiAgICAgICAgICAgIC8vIG1hdGNoIHRoZSBib25kIGJhbGFuY2UuCiAgICAgICAgICAgIGlmIChib251c0Ftb3VudCA+IGJvbmRCYWxhbmNlKSB7CiAgICAgICAgICAgICAgICAgICAgYm9udXNBbW91bnQgPSBib25kQmFsYW5jZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gVHJhbnNmZXIgdGhlIGZ1bmRzIGZyb21DYWxsZXIgPT4gdG9DYWxsZXIKICAgICAgICAgICAgUmVzb3VyY2VQb29sTGliLmRlZHVjdEZyb21Cb25kKHNlbGYuY2FsbGVyUG9vbCwgZnJvbUNhbGxlciwgYm9udXNBbW91bnQpOwogICAgICAgICAgICBSZXNvdXJjZVBvb2xMaWIuYWRkVG9Cb25kKHNlbGYuY2FsbGVyUG9vbCwgdG9DYWxsZXIsIGJvbnVzQW1vdW50KTsKCiAgICAgICAgICAgIHJldHVybiBib251c0Ftb3VudDsKICAgIH0KCiAgICBmdW5jdGlvbiBhd2FyZE1pc3NlZEJsb2NrQm9udXMoQ2FsbERhdGFiYXNlIHN0b3JhZ2Ugc2VsZiwgYWRkcmVzcyB0b0NhbGxlciwgYnl0ZXMzMiBjYWxsS2V5KSBwdWJsaWMgewogICAgICAgICAgICB2YXIgY2FsbCA9IHNlbGYuY2FsbHNbY2FsbEtleV07CgogICAgICAgICAgICB2YXIgZ2VuZXJhdGlvbiA9IHNlbGYuY2FsbGVyUG9vbC5nZW5lcmF0aW9uc1tSZXNvdXJjZVBvb2xMaWIuZ2V0R2VuZXJhdGlvbkZvcldpbmRvdyhzZWxmLmNhbGxlclBvb2wsIGNhbGwudGFyZ2V0QmxvY2ssIGNhbGwudGFyZ2V0QmxvY2sgKyBjYWxsLmdyYWNlUGVyaW9kKV07CiAgICAgICAgICAgIHVpbnQgaTsKICAgICAgICAgICAgdWludCBib251c0Ftb3VudDsKICAgICAgICAgICAgYWRkcmVzcyBmcm9tQ2FsbGVyOwoKICAgICAgICAgICAgdWludCBudW1XaW5kb3dzID0gY2FsbC5ncmFjZVBlcmlvZCAvIENBTExfV0lORE9XX1NJWkU7CiAgICAgICAgICAgIHVpbnQgYmxvY2tXaW5kb3cgPSAoYmxvY2subnVtYmVyIC0gY2FsbC50YXJnZXRCbG9jaykgLyBDQUxMX1dJTkRPV19TSVpFOwoKICAgICAgICAgICAgLy8gQ2hlY2sgaWYgd2UgYXJlIHdpdGhpbiB0aGUgZnJlZS1mb3ItYWxsIHBlcmlvZC4gIElmIHNvLCB3ZQogICAgICAgICAgICAvLyBhd2FyZCBmcm9tIGFsbCBwb29sIG1lbWJlcnMuCiAgICAgICAgICAgIGlmIChibG9ja1dpbmRvdyArIDIgPiBudW1XaW5kb3dzKSB7CiAgICAgICAgICAgICAgICAgICAgYWRkcmVzcyBmaXJzdENhbGxlciA9IGdldERlc2lnbmF0ZWRDYWxsZXIoc2VsZiwgY2FsbEtleSwgY2FsbC50YXJnZXRCbG9jayk7CiAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gY2FsbC50YXJnZXRCbG9jazsgaSA8PSBjYWxsLnRhcmdldEJsb2NrICsgY2FsbC5ncmFjZVBlcmlvZDsgaSArPSBDQUxMX1dJTkRPV19TSVpFKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmcm9tQ2FsbGVyID0gZ2V0RGVzaWduYXRlZENhbGxlcihzZWxmLCBjYWxsS2V5LCBpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmcm9tQ2FsbGVyID09IGZpcnN0Q2FsbGVyICYmIGkgIT0gY2FsbC50YXJnZXRCbG9jaykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBXZSBoYXZlIGFscmVhZHkgZ29uZSB0aHJvdWdoIGFsbCBvZgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB0aGUgcG9vbCBjYWxsZXJzIHNvIHdlIHNob3VsZCBicmVhawogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBvdXQgb2YgdGhlIGxvb3AuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZyb21DYWxsZXIgPT0gdG9DYWxsZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBib251c0Ftb3VudCA9IGRvQm9uZEJvbnVzVHJhbnNmZXIoc2VsZiwgZnJvbUNhbGxlciwgdG9DYWxsZXIpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIExvZyB0aGUgYm9udXMgd2FzIGF3YXJkZWQuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBBd2FyZGVkTWlzc2VkQmxvY2tCb251cyhmcm9tQ2FsbGVyLCB0b0NhbGxlciwgZ2VuZXJhdGlvbi5pZCwgY2FsbEtleSwgYmxvY2subnVtYmVyLCBib251c0Ftb3VudCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU3BlY2lhbCBjYXNlIGZvciBzaW5nbGUgbWVtYmVyIGFuZCBlbXB0eSBwb29scwogICAgICAgICAgICBpZiAoZ2VuZXJhdGlvbi5tZW1iZXJzLmxlbmd0aCA8IDIpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIE90aGVyd2lzZSB0aGUgYXdhcmQgY29tZXMgZnJvbSB0aGUgcHJldmlvdXMgY2FsbGVyLgogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgZ2VuZXJhdGlvbi5tZW1iZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gRmluZCB3aGVyZSB0aGUgbWVtYmVyIGlzIGluIHRoZSBwb29sIGFuZAogICAgICAgICAgICAgICAgICAgIC8vIGF3YXJkIGZyb20gdGhlIHByZXZpb3VzIHBvb2wgbWVtYmVycyBib25kLgogICAgICAgICAgICAgICAgICAgIGlmIChnZW5lcmF0aW9uLm1lbWJlcnNbaV0gPT0gdG9DYWxsZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZyb21DYWxsZXIgPSBnZW5lcmF0aW9uLm1lbWJlcnNbKGkgKyBnZW5lcmF0aW9uLm1lbWJlcnMubGVuZ3RoIC0gMSkgJSBnZW5lcmF0aW9uLm1lbWJlcnMubGVuZ3RoXTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBib251c0Ftb3VudCA9IGRvQm9uZEJvbnVzVHJhbnNmZXIoc2VsZiwgZnJvbUNhbGxlciwgdG9DYWxsZXIpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIExvZyB0aGUgYm9udXMgd2FzIGF3YXJkZWQuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBBd2FyZGVkTWlzc2VkQmxvY2tCb251cyhmcm9tQ2FsbGVyLCB0b0NhbGxlciwgZ2VuZXJhdGlvbi5pZCwgY2FsbEtleSwgYmxvY2subnVtYmVyLCBib251c0Ftb3VudCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gUmVtb3ZlIHRoZSBjYWxsZXIgZnJvbSB0aGUgbmV4dCBwb29sLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKFJlc291cmNlUG9vbExpYi5nZXROZXh0R2VuZXJhdGlvbklkKHNlbGYuY2FsbGVyUG9vbCkgPT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBUaGlzIGlzIHRoZSBmaXJzdCBhZGRyZXNzIHRvIG1vZGlmeSB0aGUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gY3VycmVudCBwb29sIHNvIHdlIG5lZWQgdG8gc2V0dXAgdGhlIG5leHQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gcG9vbC4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgUmVzb3VyY2VQb29sTGliLmNyZWF0ZU5leHRHZW5lcmF0aW9uKHNlbGYuY2FsbGVyUG9vbCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBSZXNvdXJjZVBvb2xMaWIucmVtb3ZlRnJvbUdlbmVyYXRpb24oc2VsZi5jYWxsZXJQb29sLCBSZXNvdXJjZVBvb2xMaWIuZ2V0TmV4dEdlbmVyYXRpb25JZChzZWxmLmNhbGxlclBvb2wpLCBmcm9tQ2FsbGVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgIH0KCiAgICAvKgogICAgICogIERhdGEgcmVnaXN0cmF0aW9uIEFQSQogICAgICovCiAgICBldmVudCBfRGF0YVJlZ2lzdGVyZWQoYnl0ZXMzMiBpbmRleGVkIGRhdGFIYXNoKTsKICAgIGZ1bmN0aW9uIERhdGFSZWdpc3RlcmVkKGJ5dGVzMzIgZGF0YUhhc2gpIGNvbnN0YW50IHsKICAgICAgICBfRGF0YVJlZ2lzdGVyZWQoZGF0YUhhc2gpOwogICAgfQoKICAgIGZ1bmN0aW9uIHJlZ2lzdGVyRGF0YShDYWxsRGF0YWJhc2Ugc3RvcmFnZSBzZWxmLCBieXRlcyBkYXRhKSBwdWJsaWMgewogICAgICAgICAgICBzZWxmLmxhc3REYXRhLmxlbmd0aCA9IGRhdGEubGVuZ3RoIC0gNDsKICAgICAgICAgICAgaWYgKGRhdGEubGVuZ3RoID4gNCkgewogICAgICAgICAgICAgICAgICAgIGZvciAodWludCBpID0gMDsgaSA8IHNlbGYubGFzdERhdGEubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubGFzdERhdGFbaV0gPSBkYXRhW2kgKyA0XTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc2VsZi5kYXRhX3JlZ2lzdHJ5W3NoYTMoc2VsZi5sYXN0RGF0YSldID0gc2VsZi5sYXN0RGF0YTsKICAgICAgICAgICAgc2VsZi5sYXN0RGF0YUhhc2ggPSBzaGEzKHNlbGYubGFzdERhdGEpOwogICAgICAgICAgICBzZWxmLmxhc3REYXRhTGVuZ3RoID0gc2VsZi5sYXN0RGF0YS5sZW5ndGg7CiAgICB9CgogICAgLyoKICAgICAqICBDYWxsIGV4ZWN1dGlvbiBBUEkKICAgICAqLwogICAgLy8gVGhpcyBudW1iZXIgcmVwcmVzZW50cyB0aGUgY29uc3RhbnQgZ2FzIGNvc3Qgb2YgdGhlIGFkZGl0aW9uCiAgICAvLyBvcGVyYXRpb25zIHRoYXQgb2NjdXIgaW4gYGRvQ2FsbGAgdGhhdCBjYW5ub3QgYmUgdHJhY2tlZCB3aXRoCiAgICAvLyBtc2cuZ2FzLgogICAgdWludCBjb25zdGFudCBFWFRSQV9DQUxMX0dBUyA9IDE1MzMyMTsKCiAgICAvLyBUaGlzIG51bWJlciByZXByZXNlbnRzIHRoZSBvdmVyYWxsIG92ZXJoZWFkIGludm9sdmVkIGluIGV4ZWN1dGluZyBhCiAgICAvLyBzY2hlZHVsZWQgY2FsbC4KICAgIHVpbnQgY29uc3RhbnQgQ0FMTF9PVkVSSEVBRCA9IDEyMDEwNDsKCiAgICBldmVudCBfQ2FsbEV4ZWN1dGVkKGFkZHJlc3MgaW5kZXhlZCBleGVjdXRlZEJ5LCBieXRlczMyIGluZGV4ZWQgY2FsbEtleSk7CiAgICBmdW5jdGlvbiBDYWxsRXhlY3V0ZWQoYWRkcmVzcyBleGVjdXRlZEJ5LCBieXRlczMyIGNhbGxLZXkpIHB1YmxpYyB7CiAgICAgICAgX0NhbGxFeGVjdXRlZChleGVjdXRlZEJ5LCBjYWxsS2V5KTsKICAgIH0KICAgIGV2ZW50IF9DYWxsQWJvcnRlZChhZGRyZXNzIGluZGV4ZWQgZXhlY3V0ZWRCeSwgYnl0ZXMzMiBpbmRleGVkIGNhbGxLZXksIGJ5dGVzMTggcmVhc29uKTsKICAgIGZ1bmN0aW9uIENhbGxBYm9ydGVkKGFkZHJlc3MgZXhlY3V0ZWRCeSwgYnl0ZXMzMiBjYWxsS2V5LCBieXRlczE4IHJlYXNvbikgcHVibGljIHsKICAgICAgICBfQ2FsbEFib3J0ZWQoZXhlY3V0ZWRCeSwgY2FsbEtleSwgcmVhc29uKTsKICAgIH0KCiAgICBmdW5jdGlvbiBkb0NhbGwoQ2FsbERhdGFiYXNlIHN0b3JhZ2Ugc2VsZiwgYnl0ZXMzMiBjYWxsS2V5LCBhZGRyZXNzIG1zZ1NlbmRlcikgcHVibGljIHsKICAgICAgICAgICAgdWludCBnYXNCZWZvcmUgPSBtc2cuZ2FzOwoKICAgICAgICAgICAgQ2FsbCBzdG9yYWdlIGNhbGwgPSBzZWxmLmNhbGxzW2NhbGxLZXldOwoKICAgICAgICAgICAgaWYgKGNhbGwud2FzQ2FsbGVkKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gVGhlIGNhbGwgaGFzIGFscmVhZHkgYmVlbiBleGVjdXRlZCBzbyBkb24ndCBkbyBpdCBhZ2Fpbi4KICAgICAgICAgICAgICAgICAgICBfQ2FsbEFib3J0ZWQobXNnLnNlbmRlciwgY2FsbEtleSwgIkFMUkVBRFkgQ0FMTEVEIik7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoY2FsbC5pc0NhbmNlbGxlZCkgewogICAgICAgICAgICAgICAgICAgIC8vIFRoZSBjYWxsIHdhcyBjYW5jZWxsZWQgc28gZG9uJ3QgZXhlY3V0ZSBpdC4KICAgICAgICAgICAgICAgICAgICBfQ2FsbEFib3J0ZWQobXNnLnNlbmRlciwgY2FsbEtleSwgIkNBTkNFTExFRCIpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGNhbGwuY29udHJhY3RBZGRyZXNzID09IDB4MCkgewogICAgICAgICAgICAgICAgICAgIC8vIFRoaXMgY2FsbCBrZXkgZG9lc250IG1hcCB0byBhIHJlZ2lzdGVyZWQgY2FsbC4KICAgICAgICAgICAgICAgICAgICBfQ2FsbEFib3J0ZWQobXNnLnNlbmRlciwgY2FsbEtleSwgIlVOS05PV04iKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChibG9jay5udW1iZXIgPCBjYWxsLnRhcmdldEJsb2NrKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gVGFyZ2V0IGJsb2NrIGhhc250IGhhcHBlbmVkIHlldC4KICAgICAgICAgICAgICAgICAgICBfQ2FsbEFib3J0ZWQobXNnLnNlbmRlciwgY2FsbEtleSwgIlRPTyBFQVJMWSIpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGJsb2NrLm51bWJlciA+IGNhbGwudGFyZ2V0QmxvY2sgKyBjYWxsLmdyYWNlUGVyaW9kKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gVGhlIGJsb2NrY2hhaW4gaGFzIGFkdmFuY2VkIHBhc3NlZCB0aGUgcGVyaW9kIHdoZXJlCiAgICAgICAgICAgICAgICAgICAgLy8gaXQgd2FzIGFsbG93ZWQgdG8gYmUgY2FsbGVkLgogICAgICAgICAgICAgICAgICAgIF9DYWxsQWJvcnRlZChtc2cuc2VuZGVyLCBjYWxsS2V5LCAiVE9PIExBVEUiKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHVpbnQgaGVsZEJhbGFuY2UgPSBnZXRDYWxsTWF4Q29zdChzZWxmLCBjYWxsS2V5KTsKCiAgICAgICAgICAgIGlmIChzZWxmLmdhc0JhbmsuYWNjb3VudEJhbGFuY2VzW2NhbGwuc2NoZWR1bGVkQnldIDwgaGVsZEJhbGFuY2UpIHsKICAgICAgICAgICAgICAgICAgICAvLyBUaGUgc2NoZWR1bGVkQnkncyBhY2NvdW50IGJhbGFuY2UgaXMgbGVzcyB0aGFuIHRoZQogICAgICAgICAgICAgICAgICAgIC8vIGN1cnJlbnQgZ2FzTGltaXQgYW5kIHRodXMgcG90ZW50aWFsbCBjYW4ndCBwYXkgZm9yCiAgICAgICAgICAgICAgICAgICAgLy8gdGhlIGNhbGwuCgogICAgICAgICAgICAgICAgICAgIC8vIE1hcmsgaXQgYXMgY2FsbGVkIHNpbmNlIGl0IHdhcy4KICAgICAgICAgICAgICAgICAgICBjYWxsLndhc0NhbGxlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gTG9nIGl0LgogICAgICAgICAgICAgICAgICAgIF9DYWxsQWJvcnRlZChtc2cuc2VuZGVyLCBjYWxsS2V5LCAiSU5TVUZGSUNJRU5UX0ZVTkRTIik7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBDaGVjayBpZiB0aGlzIGNhbGxlciBpcyBhbGxvd2VkIHRvIGV4ZWN1dGUgdGhlIGNhbGwuCiAgICAgICAgICAgIGlmIChzZWxmLmNhbGxlclBvb2wuZ2VuZXJhdGlvbnNbUmVzb3VyY2VQb29sTGliLmdldEN1cnJlbnRHZW5lcmF0aW9uSWQoc2VsZi5jYWxsZXJQb29sKV0ubWVtYmVycy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgYWRkcmVzcyBkZXNpZ25hdGVkQ2FsbGVyID0gZ2V0RGVzaWduYXRlZENhbGxlcihzZWxmLCBjYWxsS2V5LCBibG9jay5udW1iZXIpOwogICAgICAgICAgICAgICAgICAgIGlmIChkZXNpZ25hdGVkQ2FsbGVyICE9IDB4MCAmJiBkZXNpZ25hdGVkQ2FsbGVyICE9IG1zZ1NlbmRlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyBjYWxsIHdhcyByZXNlcnZlZCBmb3Igc29tZW9uZSBmcm9tIHRoZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gYm9uZGVkIHBvb2wgb2YgY2FsbGVycyBhbmQgY2FuIG9ubHkgYmUKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNhbGxlZCBieSB0aGVtIGR1cmluZyB0aGlzIGJsb2NrIHdpbmRvdy4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9DYWxsQWJvcnRlZChtc2cuc2VuZGVyLCBjYWxsS2V5LCAiV1JPTkdfQ0FMTEVSIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICB1aW50IGJsb2NrV2luZG93ID0gKGJsb2NrLm51bWJlciAtIGNhbGwudGFyZ2V0QmxvY2spIC8gQ0FMTF9XSU5ET1dfU0laRTsKICAgICAgICAgICAgICAgICAgICBpZiAoYmxvY2tXaW5kb3cgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBTb21lb25lIG1pc3NlZCB0aGVpciBjYWxsIHNvIHRoaXMgY2FsbGVyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBnZXRzIHRvIGNsYWltIHRoZWlyIGJvbmQgZm9yIHBpY2tpbmcgdXAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoZWlyIHNsYWNrLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXdhcmRNaXNzZWRCbG9ja0JvbnVzKHNlbGYsIG1zZ1NlbmRlciwgY2FsbEtleSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBMb2cgbWV0YWRhdGEgYWJvdXQgdGhlIGNhbGwuCiAgICAgICAgICAgIGNhbGwuZ2FzUHJpY2UgPSB0eC5nYXNwcmljZTsKICAgICAgICAgICAgY2FsbC5leGVjdXRlZEJ5ID0gbXNnU2VuZGVyOwogICAgICAgICAgICBjYWxsLmNhbGxlZEF0QmxvY2sgPSBibG9jay5udW1iZXI7CgogICAgICAgICAgICAvLyBGZXRjaCB0aGUgY2FsbCBkYXRhCiAgICAgICAgICAgIHZhciBkYXRhID0gc2VsZi5kYXRhX3JlZ2lzdHJ5W2NhbGwuZGF0YUhhc2hdOwoKICAgICAgICAgICAgLy8gRHVyaW5nIHRoZSBjYWxsLCB3ZSBuZWVkIHRvIHB1dCBlbm91Z2ggZnVuZHMgdG8gcGF5IGZvciB0aGUKICAgICAgICAgICAgLy8gY2FsbCBvbiBob2xkIHRvIGVuc3VyZSB0aGV5IGFyZSBhdmFpbGFibGUgdG8gcGF5IHRoZSBjYWxsZXIuCiAgICAgICAgICAgIEFjY291bnRpbmdMaWIud2l0aGRyYXcoc2VsZi5nYXNCYW5rLCBjYWxsLnNjaGVkdWxlZEJ5LCBoZWxkQmFsYW5jZSk7CgogICAgICAgICAgICAvLyBNYXJrIHdoZXRoZXIgdGhlIGZ1bmN0aW9uIGNhbGwgd2FzIHN1Y2Nlc3NmdWwuCiAgICAgICAgICAgIGlmIChjaGVja0F1dGhvcml6YXRpb24oc2VsZiwgY2FsbC5zY2hlZHVsZWRCeSwgY2FsbC5jb250cmFjdEFkZHJlc3MpKSB7CiAgICAgICAgICAgICAgICAgICAgY2FsbC53YXNTdWNjZXNzZnVsID0gc2VsZi5hdXRob3JpemVkUmVsYXkucmVsYXlDYWxsLmdhcyhtc2cuZ2FzIC0gQ0FMTF9PVkVSSEVBRCkoY2FsbC5jb250cmFjdEFkZHJlc3MsIGNhbGwuYWJpU2lnbmF0dXJlLCBkYXRhKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjYWxsLndhc1N1Y2Nlc3NmdWwgPSBzZWxmLnVuYXV0aG9yaXplZFJlbGF5LnJlbGF5Q2FsbC5nYXMobXNnLmdhcyAtIENBTExfT1ZFUkhFQUQpKGNhbGwuY29udHJhY3RBZGRyZXNzLCBjYWxsLmFiaVNpZ25hdHVyZSwgZGF0YSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEFkZCB0aGUgaGVsZCBmdW5kcyBiYWNrIGludG8gdGhlIHNjaGVkdWxlcidzIGFjY291bnQuCiAgICAgICAgICAgIEFjY291bnRpbmdMaWIuZGVwb3NpdChzZWxmLmdhc0JhbmssIGNhbGwuc2NoZWR1bGVkQnksIGhlbGRCYWxhbmNlKTsKCiAgICAgICAgICAgIC8vIE1hcmsgdGhlIGNhbGwgYXMgaGF2aW5nIGJlZW4gZXhlY3V0ZWQuCiAgICAgICAgICAgIGNhbGwud2FzQ2FsbGVkID0gdHJ1ZTsKCiAgICAgICAgICAgIC8vIENvbXB1dGUgdGhlIHNjYWxhciAoMCAtIDIwMCkgZm9yIHRoZSBmZWUuCiAgICAgICAgICAgIHVpbnQgZmVlU2NhbGFyID0gZ2V0Q2FsbEZlZVNjYWxhcihjYWxsLmJhc2VHYXNQcmljZSwgY2FsbC5nYXNQcmljZSk7CgogICAgICAgICAgICAvLyBMb2cgaG93IG11Y2ggZ2FzIHRoaXMgY2FsbCB1c2VkLiAgRVhUUkFfQ0FMTF9HQVMgaXMgYSBmaXhlZAogICAgICAgICAgICAvLyBhbW91bnQgdGhhdCByZXByZXNlbnRzIHRoZSBnYXMgdXNhZ2Ugb2YgdGhlIGNvbW1hbmRzIHRoYXQKICAgICAgICAgICAgLy8gaGFwcGVuIGFmdGVyIHRoaXMgbGluZS4KICAgICAgICAgICAgY2FsbC5nYXNVc2VkID0gKGdhc0JlZm9yZSAtIG1zZy5nYXMgKyBFWFRSQV9DQUxMX0dBUyk7CiAgICAgICAgICAgIGNhbGwuZ2FzQ29zdCA9IGNhbGwuZ2FzVXNlZCAqIGNhbGwuZ2FzUHJpY2U7CgogICAgICAgICAgICAvLyBOb3cgd2UgbmVlZCB0byBwYXkgdGhlIGNhbGxlciBhcyB3ZWxsIGFzIGtlZXAgZmVlLgogICAgICAgICAgICAvLyBjYWxsZXJQYXlvdXQgLT4gY2FsbCBjb3N0ICsgMSUKICAgICAgICAgICAgLy8gZmVlIC0+IDElIG9mIGNhbGxlclBheW91dAogICAgICAgICAgICBjYWxsLnBheW91dCA9IGNhbGwuZ2FzQ29zdCAqIGZlZVNjYWxhciAqIDEwMSAvIDEwMDAwOwogICAgICAgICAgICBjYWxsLmZlZSA9IGNhbGwuZ2FzQ29zdCAqIGZlZVNjYWxhciAvIDEwMDAwOwoKICAgICAgICAgICAgQWNjb3VudGluZ0xpYi5kZWR1Y3RGdW5kcyhzZWxmLmdhc0JhbmssIGNhbGwuc2NoZWR1bGVkQnksIGNhbGwucGF5b3V0ICsgY2FsbC5mZWUpOwoKICAgICAgICAgICAgQWNjb3VudGluZ0xpYi5hZGRGdW5kcyhzZWxmLmdhc0JhbmssIG1zZ1NlbmRlciwgY2FsbC5wYXlvdXQpOwogICAgICAgICAgICBBY2NvdW50aW5nTGliLmFkZEZ1bmRzKHNlbGYuZ2FzQmFuaywgb3duZXIsIGNhbGwuZmVlKTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRDYWxsTWF4Q29zdChDYWxsRGF0YWJhc2Ugc3RvcmFnZSBzZWxmLCBieXRlczMyIGNhbGxLZXkpIGNvbnN0YW50IHJldHVybnMgKHVpbnQpIHsKICAgICAgICAgICAgLyoKICAgICAgICAgICAgICogIHR4Lmdhc3ByaWNlICogYmxvY2suZ2FzbGltaXQKICAgICAgICAgICAgICogIAogICAgICAgICAgICAgKi8KICAgICAgICAgICAgLy8gY2FsbCBjb3N0ICsgMiUKICAgICAgICAgICAgdmFyIGNhbGwgPSBzZWxmLmNhbGxzW2NhbGxLZXldOwoKICAgICAgICAgICAgdWludCBnYXNDb3N0ID0gdHguZ2FzcHJpY2UgKiBibG9jay5nYXNsaW1pdDsKICAgICAgICAgICAgdWludCBmZWVTY2FsYXIgPSBnZXRDYWxsRmVlU2NhbGFyKGNhbGwuYmFzZUdhc1ByaWNlLCB0eC5nYXNwcmljZSk7CgogICAgICAgICAgICByZXR1cm4gZ2FzQ29zdCAqIGZlZVNjYWxhciAqIDEwMiAvIDEwMDAwOwogICAgfQoKICAgIGZ1bmN0aW9uIGdldENhbGxGZWVTY2FsYXIodWludCBiYXNlR2FzUHJpY2UsIHVpbnQgZ2FzUHJpY2UpIGNvbnN0YW50IHJldHVybnMgKHVpbnQpIHsKICAgICAgICAgICAgLyoKICAgICAgICAgICAgICogIFJldHVybiBhIG51bWJlciBiZXR3ZWVuIDAgLSAyMDAgdG8gc2NhbGUgdGhlIGZlZSBiYXNlZCBvbgogICAgICAgICAgICAgKiAgdGhlIGdhcyBwcmljZSBzZXQgZm9yIHRoZSBjYWxsaW5nIHRyYW5zYWN0aW9uIGFzIGNvbXBhcmVkCiAgICAgICAgICAgICAqICB0byB0aGUgZ2FzIHByaWNlIG9mIHRoZSBzY2hlZHVsaW5nIHRyYW5zYWN0aW9uLgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiAgLSBudW1iZXIgYXBwcm9hY2hlcyB6ZXJvIGFzIHRoZSB0cmFuc2FjdGlvbiBnYXMgcHJpY2UgZ29lcwogICAgICAgICAgICAgKiAgYWJvdmUgdGhlIGdhcyBwcmljZSByZWNvcmRlZCB3aGVuIHRoZSBjYWxsIHdhcyBzY2hlZHVsZWQuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqICAtIHRoZSBudW1iZXIgYXBwcm9hY2hlcyAyMDAgYXMgdGhlIHRyYW5zYWN0aW9uIGdhcyBwcmljZQogICAgICAgICAgICAgKiAgZHJvcHMgdW5kZXIgdGhlIHByaWNlIHJlY29yZGVkIHdoZW4gdGhlIGNhbGwgd2FzIHNjaGVkdWxlZC4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogIFRoaXMgZW5jb3VyYWdlcyBsb3dlciBnYXMgY29zdHMgYXMgdGhlIGxvd2VyIHRoZSBnYXMgcHJpY2UKICAgICAgICAgICAgICogIGZvciB0aGUgZXhlY3V0aW5nIHRyYW5zYWN0aW9uLCB0aGUgaGlnaGVyIHRoZSBwYXlvdXQgdG8gdGhlCiAgICAgICAgICAgICAqICBjYWxsZXIuCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBpZiAoZ2FzUHJpY2UgPiBiYXNlR2FzUHJpY2UpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gMTAwICogYmFzZUdhc1ByaWNlIC8gZ2FzUHJpY2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDIwMCAtIDEwMCAqIGJhc2VHYXNQcmljZSAvICgyICogYmFzZUdhc1ByaWNlIC0gZ2FzUHJpY2UpOwogICAgICAgICAgICB9CiAgICB9CgogICAgLyoKICAgICAqICBDYWxsIFNjaGVkdWxpbmcgQVBJCiAgICAgKi8KCiAgICAvLyBUaGUgcmVzdWx0IG9mIGBzaGEoKWAgc28gdGhhdCB3ZSBjYW4gdmFsaWRhdGUgdGhhdCBwZW9wbGUgYXJlbid0CiAgICAvLyBsb29raW5nIHVwIGNhbGwgZGF0YSB0aGF0IGZhaWxlZCB0byByZWdpc3Rlci4KICAgIGJ5dGVzMzIgY29uc3RhbnQgZW1wdHlEYXRhSGFzaCA9IDB4YzVkMjQ2MDE4NmY3MjMzYzkyN2U3ZGIyZGNjNzAzYzBlNTAwYjY1M2NhODIyNzNiN2JmYWQ4MDQ1ZDg1YTQ3MDsKCiAgICBmdW5jdGlvbiBjb21wdXRlQ2FsbEtleShhZGRyZXNzIHNjaGVkdWxlZEJ5LCBhZGRyZXNzIGNvbnRyYWN0QWRkcmVzcywgYnl0ZXM0IGFiaVNpZ25hdHVyZSwgYnl0ZXMzMiBkYXRhSGFzaCwgdWludCB0YXJnZXRCbG9jaywgdWludDggZ3JhY2VQZXJpb2QsIHVpbnQgbm9uY2UpIGNvbnN0YW50IHJldHVybnMgKGJ5dGVzMzIpIHsKICAgICAgICAgICAgcmV0dXJuIHNoYTMoc2NoZWR1bGVkQnksIGNvbnRyYWN0QWRkcmVzcywgYWJpU2lnbmF0dXJlLCBkYXRhSGFzaCwgdGFyZ2V0QmxvY2ssIGdyYWNlUGVyaW9kLCBub25jZSk7CiAgICB9CgogICAgLy8gVGVuIG1pbnV0ZXMgaW50byB0aGUgZnV0dXJlLgogICAgdWludCBjb25zdGFudCBNQVhfQkxPQ0tTX0lOX0ZVVFVSRSA9IDQwOwoKICAgIGV2ZW50IF9DYWxsU2NoZWR1bGVkKGJ5dGVzMzIgaW5kZXhlZCBjYWxsS2V5KTsKICAgIGZ1bmN0aW9uIENhbGxTY2hlZHVsZWQoYnl0ZXMzMiBjYWxsS2V5KSBwdWJsaWMgewogICAgICAgIF9DYWxsU2NoZWR1bGVkKGNhbGxLZXkpOwogICAgfQogICAgZXZlbnQgX0NhbGxSZWplY3RlZChieXRlczMyIGluZGV4ZWQgY2FsbEtleSwgYnl0ZXMxNSByZWFzb24pOwogICAgZnVuY3Rpb24gQ2FsbFJlamVjdGVkKGJ5dGVzMzIgY2FsbEtleSwgYnl0ZXMxNSByZWFzb24pIHB1YmxpYyB7CiAgICAgICAgX0NhbGxSZWplY3RlZChjYWxsS2V5LCByZWFzb24pOwogICAgfQoKICAgIGZ1bmN0aW9uIGdldENhbGxXaW5kb3dTaXplKCkgcHVibGljIHJldHVybnMgKHVpbnQpIHsKICAgICAgICByZXR1cm4gQ0FMTF9XSU5ET1dfU0laRTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRNaW5pbXVtR3JhY2VQZXJpb2QoKSBwdWJsaWMgcmV0dXJucyAodWludCkgewogICAgICAgIHJldHVybiA0ICogQ0FMTF9XSU5ET1dfU0laRTsKICAgIH0KCiAgICBmdW5jdGlvbiBzY2hlZHVsZUNhbGwoQ2FsbERhdGFiYXNlIHN0b3JhZ2Ugc2VsZiwgYWRkcmVzcyBzY2hlZHVsZXJBZGRyZXNzLCBhZGRyZXNzIGNvbnRyYWN0QWRkcmVzcywgYnl0ZXM0IGFiaVNpZ25hdHVyZSwgYnl0ZXMzMiBkYXRhSGFzaCwgdWludCB0YXJnZXRCbG9jaywgdWludDggZ3JhY2VQZXJpb2QsIHVpbnQgbm9uY2UpIHB1YmxpYyByZXR1cm5zIChieXRlczE1KSB7CiAgICAgICAgICAgIC8qCiAgICAgICAgICAgICAqIFByaW1hcnkgQVBJIGZvciBzY2hlZHVsaW5nIGEgY2FsbC4gIFByaW9yIHRvIGNhbGxpbmcgdGhpcwogICAgICAgICAgICAgKiB0aGUgZGF0YSBzaG91bGQgYWxyZWFkeSBoYXZlIGJlZW4gcmVnaXN0ZXJlZCB0aHJvdWdoIHRoZQogICAgICAgICAgICAgKiBgcmVnaXN0ZXJEYXRhYCBBUEkuCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBieXRlczMyIGNhbGxLZXkgPSBjb21wdXRlQ2FsbEtleShzY2hlZHVsZXJBZGRyZXNzLCBjb250cmFjdEFkZHJlc3MsIGFiaVNpZ25hdHVyZSwgZGF0YUhhc2gsIHRhcmdldEJsb2NrLCBncmFjZVBlcmlvZCwgbm9uY2UpOwoKICAgICAgICAgICAgaWYgKGRhdGFIYXNoICE9IGVtcHR5RGF0YUhhc2ggJiYgc2VsZi5kYXRhX3JlZ2lzdHJ5W2RhdGFIYXNoXS5sZW5ndGggPT0gMCkgewogICAgICAgICAgICAgICAgICAgIC8vIERvbid0IGFsbG93IHJlZ2lzdGVyaW5nIGNhbGxzIGlmIHRoZSBkYXRhIGhhc2ggaGFzCiAgICAgICAgICAgICAgICAgICAgLy8gbm90IGFjdHVhbGx5IGJlZW4gcmVnaXN0ZXJlZC4gIFRoZSBvbmx5IGV4Y2VwdGlvbiBpcwogICAgICAgICAgICAgICAgICAgIC8vIHRoZSAqZW1wdHlEYXRhSGFzaCouCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICJOT19EQVRBIjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRhcmdldEJsb2NrIDwgYmxvY2subnVtYmVyICsgTUFYX0JMT0NLU19JTl9GVVRVUkUpIHsKICAgICAgICAgICAgICAgICAgICAvLyBEb24ndCBhbGxvdyBzY2hlZHVsaW5nIGZ1cnRoZXIgdGhhbgogICAgICAgICAgICAgICAgICAgIC8vIE1BWF9CTE9DS1NfSU5fRlVUVVJFCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICJUT09fU09PTiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgQ2FsbCBzdG9yYWdlIGNhbGwgPSBzZWxmLmNhbGxzW2NhbGxLZXldOwoKICAgICAgICAgICAgaWYgKGNhbGwuY29udHJhY3RBZGRyZXNzICE9IDB4MCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAiRFVQTElDQVRFIjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGdyYWNlUGVyaW9kIDwgZ2V0TWluaW11bUdyYWNlUGVyaW9kKCkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gIkdSQUNFX1RPT19TSE9SVCI7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHNlbGYubGFzdENhbGxLZXkgPSBjYWxsS2V5OwoKICAgICAgICAgICAgY2FsbC5jb250cmFjdEFkZHJlc3MgPSBjb250cmFjdEFkZHJlc3M7CiAgICAgICAgICAgIGNhbGwuc2NoZWR1bGVkQnkgPSBzY2hlZHVsZXJBZGRyZXNzOwogICAgICAgICAgICBjYWxsLm5vbmNlID0gbm9uY2U7CiAgICAgICAgICAgIGNhbGwuYWJpU2lnbmF0dXJlID0gYWJpU2lnbmF0dXJlOwogICAgICAgICAgICBjYWxsLmRhdGFIYXNoID0gZGF0YUhhc2g7CiAgICAgICAgICAgIGNhbGwudGFyZ2V0QmxvY2sgPSB0YXJnZXRCbG9jazsKICAgICAgICAgICAgY2FsbC5ncmFjZVBlcmlvZCA9IGdyYWNlUGVyaW9kOwogICAgICAgICAgICBjYWxsLmJhc2VHYXNQcmljZSA9IHR4Lmdhc3ByaWNlOwoKICAgICAgICAgICAgLy8gUHV0IHRoZSBjYWxsIGludG8gdGhlIGdyb3ZlIGluZGV4LgogICAgICAgICAgICBHcm92ZUxpYi5pbnNlcnQoc2VsZi5jYWxsSW5kZXgsIGNhbGxLZXksIGludChjYWxsLnRhcmdldEJsb2NrKSk7CgogICAgICAgICAgICByZXR1cm4gMHgwOwogICAgfQoKICAgIGV2ZW50IF9DYWxsQ2FuY2VsbGVkKGJ5dGVzMzIgaW5kZXhlZCBjYWxsS2V5KTsKICAgIGZ1bmN0aW9uIENhbGxDYW5jZWxsZWQoYnl0ZXMzMiBjYWxsS2V5KSBwdWJsaWMgewogICAgICAgIF9DYWxsQ2FuY2VsbGVkKGNhbGxLZXkpOwogICAgfQoKICAgIC8vIFR3byBtaW51dGVzCiAgICB1aW50IGNvbnN0YW50IE1JTl9DQU5DRUxfV0lORE9XID0gODsKCiAgICBmdW5jdGlvbiBjYW5jZWxDYWxsKENhbGxEYXRhYmFzZSBzdG9yYWdlIHNlbGYsIGJ5dGVzMzIgY2FsbEtleSwgYWRkcmVzcyBtc2dTZW5kZXIpIHB1YmxpYyByZXR1cm5zIChib29sKSB7CiAgICAgICAgICAgIENhbGwgc3RvcmFnZSBjYWxsID0gc2VsZi5jYWxsc1tjYWxsS2V5XTsKICAgICAgICAgICAgaWYgKGNhbGwuc2NoZWR1bGVkQnkgIT0gbXNnU2VuZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gTm9ib2R5IGJ1dCB0aGUgc2NoZWR1bGVyIGNhbiBjYW5jZWwgYSBjYWxsLgogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoY2FsbC53YXNDYWxsZWQpIHsKICAgICAgICAgICAgICAgICAgICAvLyBObyBuZWVkIHRvIGNhbmNlbCBhIGNhbGwgdGhhdCBhbHJlYWR5IHdhcyBleGVjdXRlZC4KICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGNhbGwudGFyZ2V0QmxvY2sgLSBNSU5fQ0FOQ0VMX1dJTkRPVyA8PSBibG9jay5udW1iZXIpIHsKICAgICAgICAgICAgICAgICAgICAvLyBDYWxsIGNhbm5vdCBiZSBjYW5jZWxsZWQgdGhpcyBjbG9zZSB0byBleGVjdXRpb24uCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhbGwuaXNDYW5jZWxsZWQgPSB0cnVlOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KfQoKCi8qCiAqICBFdGhlcmV1bSBBbGFybSBTZXJ2aWNlCiAqICBWZXJzaW9uIDAuNC4wCiAqCiAqICBhZGRyZXNzOiAweDA3MzA3ZDBiMTM2YTc5YmFjNzE4ZjQzMzg4YWVkNzA2Mzg5YzQ1ODgKICovCmNvbnRyYWN0IEFsYXJtIHsKICAgICAgICAvKgogICAgICAgICAqICBDb25zdHJ1Y3RvcgogICAgICAgICAqCiAgICAgICAgICogIC0gc2V0cyB1cCByZWxheXMKICAgICAgICAgKiAgLSBjb25maWd1cmVzIHRoZSBjYWxsZXIgcG9vbC4KICAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiBBbGFybSgpIHsKICAgICAgICAgICAgICAgIGNhbGxEYXRhYmFzZS51bmF1dGhvcml6ZWRSZWxheSA9IG5ldyBSZWxheSgpOwogICAgICAgICAgICAgICAgY2FsbERhdGFiYXNlLmF1dGhvcml6ZWRSZWxheSA9IG5ldyBSZWxheSgpOwoKICAgICAgICAgICAgICAgIGNhbGxEYXRhYmFzZS5jYWxsZXJQb29sLmZyZWV6ZVBlcmlvZCA9IDgwOwogICAgICAgICAgICAgICAgY2FsbERhdGFiYXNlLmNhbGxlclBvb2wucm90YXRpb25EZWxheSA9IDgwOwogICAgICAgICAgICAgICAgY2FsbERhdGFiYXNlLmNhbGxlclBvb2wub3ZlcmxhcFNpemUgPSAyNTY7CiAgICAgICAgfQoKICAgICAgICBTY2hlZHVsZWRDYWxsTGliLkNhbGxEYXRhYmFzZSBjYWxsRGF0YWJhc2U7CgogICAgICAgIC8vIFRoZSBhdXRob3IgKFBpcGVyIE1lcnJpYW0pIGFkZHJlc3MuCiAgICAgICAgYWRkcmVzcyBjb25zdGFudCBvd25lciA9IDB4ZDNjZGE5MTNkZWI2ZjY3OTY3Yjk5ZDY3YWNkZmExNzEyYzI5MzYwMTsKCiAgICAgICAgLyoKICAgICAgICAgKiAgQWNjb3VudCBNYW5hZ2VtZW50IEFQSQogICAgICAgICAqLwogICAgICAgIGZ1bmN0aW9uIGdldEFjY291bnRCYWxhbmNlKGFkZHJlc3MgYWNjb3VudEFkZHJlc3MpIGNvbnN0YW50IHB1YmxpYyByZXR1cm5zICh1aW50KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gY2FsbERhdGFiYXNlLmdhc0JhbmsuYWNjb3VudEJhbGFuY2VzW2FjY291bnRBZGRyZXNzXTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGRlcG9zaXQoKSBwdWJsaWMgewogICAgICAgICAgICAgICAgZGVwb3NpdChtc2cuc2VuZGVyKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGRlcG9zaXQoYWRkcmVzcyBhY2NvdW50QWRkcmVzcykgcHVibGljIHsKICAgICAgICAgICAgICAgIC8qCiAgICAgICAgICAgICAgICAgKiAgUHVibGljIEFQSSBmb3IgZGVwb3NpdGluZyBmdW5kcyBpbiBhIHNwZWNpZmllZCBhY2NvdW50LgogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBBY2NvdW50aW5nTGliLmRlcG9zaXQoY2FsbERhdGFiYXNlLmdhc0JhbmssIGFjY291bnRBZGRyZXNzLCBtc2cudmFsdWUpOwogICAgICAgICAgICAgICAgQWNjb3VudGluZ0xpYi5EZXBvc2l0KG1zZy5zZW5kZXIsIGFjY291bnRBZGRyZXNzLCBtc2cudmFsdWUpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gd2l0aGRyYXcodWludCB2YWx1ZSkgcHVibGljIHsKICAgICAgICAgICAgICAgIC8qCiAgICAgICAgICAgICAgICAgKiAgUHVibGljIEFQSSBmb3Igd2l0aGRyYXdpbmcgZnVuZHMuCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIGlmIChBY2NvdW50aW5nTGliLndpdGhkcmF3KGNhbGxEYXRhYmFzZS5nYXNCYW5rLCBtc2cuc2VuZGVyLCB2YWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgQWNjb3VudGluZ0xpYi5XaXRoZHJhd2FsKG1zZy5zZW5kZXIsIHZhbHVlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBBY2NvdW50aW5nTGliLkluc3VmZmljaWVudEZ1bmRzKG1zZy5zZW5kZXIsIHZhbHVlLCBjYWxsRGF0YWJhc2UuZ2FzQmFuay5hY2NvdW50QmFsYW5jZXNbbXNnLnNlbmRlcl0pOwogICAgICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAvKgogICAgICAgICAgICAgICAgICogIEZhbGxiYWNrIGZ1bmN0aW9uIHRoYXQgYWxsb3dzIGRlcG9zaXRpbmcgZnVuZHMganVzdCBieQogICAgICAgICAgICAgICAgICogIHNlbmRpbmcgYSB0cmFuc2FjdGlvbi4KICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgZGVwb3NpdChtc2cuc2VuZGVyKTsKICAgICAgICB9CgogICAgICAgIC8qCiAgICAgICAgICogIFNjaGVkdWxpbmcgQXV0aG9yaXphdGlvbiBBUEkKICAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiB1bmF1dGhvcml6ZWRBZGRyZXNzKCkgY29uc3RhbnQgcmV0dXJucyAoYWRkcmVzcykgewogICAgICAgICAgICAgICAgcmV0dXJuIGFkZHJlc3MoY2FsbERhdGFiYXNlLnVuYXV0aG9yaXplZFJlbGF5KTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGF1dGhvcml6ZWRBZGRyZXNzKCkgY29uc3RhbnQgcmV0dXJucyAoYWRkcmVzcykgewogICAgICAgICAgICAgICAgcmV0dXJuIGFkZHJlc3MoY2FsbERhdGFiYXNlLmF1dGhvcml6ZWRSZWxheSk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBhZGRBdXRob3JpemF0aW9uKGFkZHJlc3Mgc2NoZWR1bGVyQWRkcmVzcykgcHVibGljIHsKICAgICAgICAgICAgICAgIFNjaGVkdWxlZENhbGxMaWIuYWRkQXV0aG9yaXphdGlvbihjYWxsRGF0YWJhc2UsIHNjaGVkdWxlckFkZHJlc3MsIG1zZy5zZW5kZXIpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gcmVtb3ZlQXV0aG9yaXphdGlvbihhZGRyZXNzIHNjaGVkdWxlckFkZHJlc3MpIHB1YmxpYyB7CiAgICAgICAgICAgICAgICBjYWxsRGF0YWJhc2UuYWNjb3VudEF1dGhvcml6YXRpb25zW3NoYTMoc2NoZWR1bGVyQWRkcmVzcywgbXNnLnNlbmRlcildID0gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBjaGVja0F1dGhvcml6YXRpb24oYWRkcmVzcyBzY2hlZHVsZXJBZGRyZXNzLCBhZGRyZXNzIGNvbnRyYWN0QWRkcmVzcykgY29uc3RhbnQgcmV0dXJucyAoYm9vbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxEYXRhYmFzZS5hY2NvdW50QXV0aG9yaXphdGlvbnNbc2hhMyhzY2hlZHVsZXJBZGRyZXNzLCBjb250cmFjdEFkZHJlc3MpXTsKICAgICAgICB9CgogICAgICAgIC8qCiAgICAgICAgICogIENhbGxlciBib25kaW5nCiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gZ2V0TWluaW11bUJvbmQoKSBjb25zdGFudCByZXR1cm5zICh1aW50KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gU2NoZWR1bGVkQ2FsbExpYi5nZXRNaW5pbXVtQm9uZCgpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZGVwb3NpdEJvbmQoKSBwdWJsaWMgewogICAgICAgICAgICAgICAgUmVzb3VyY2VQb29sTGliLmFkZFRvQm9uZChjYWxsRGF0YWJhc2UuY2FsbGVyUG9vbCwgbXNnLnNlbmRlciwgbXNnLnZhbHVlKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHdpdGhkcmF3Qm9uZCh1aW50IHZhbHVlKSBwdWJsaWMgewogICAgICAgICAgICAgICAgUmVzb3VyY2VQb29sTGliLndpdGhkcmF3Qm9uZChjYWxsRGF0YWJhc2UuY2FsbGVyUG9vbCwgbXNnLnNlbmRlciwgdmFsdWUsIGdldE1pbmltdW1Cb25kKCkpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZ2V0Qm9uZEJhbGFuY2UoKSBjb25zdGFudCByZXR1cm5zICh1aW50KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0Qm9uZEJhbGFuY2UobXNnLnNlbmRlcik7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBnZXRCb25kQmFsYW5jZShhZGRyZXNzIGNhbGxlckFkZHJlc3MpIGNvbnN0YW50IHJldHVybnMgKHVpbnQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBjYWxsRGF0YWJhc2UuY2FsbGVyUG9vbC5ib25kc1tjYWxsZXJBZGRyZXNzXTsKICAgICAgICB9CgoKICAgICAgICAvKgogICAgICAgICAqICBQb29sIE1hbmFnZW1lbnQKICAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiBnZXRHZW5lcmF0aW9uRm9yQ2FsbChieXRlczMyIGNhbGxLZXkpIGNvbnN0YW50IHJldHVybnMgKHVpbnQpIHsKICAgICAgICAgICAgICAgIHZhciBjYWxsID0gY2FsbERhdGFiYXNlLmNhbGxzW2NhbGxLZXldOwogICAgICAgICAgICAgICAgcmV0dXJuIFJlc291cmNlUG9vbExpYi5nZXRHZW5lcmF0aW9uRm9yV2luZG93KGNhbGxEYXRhYmFzZS5jYWxsZXJQb29sLCBjYWxsLnRhcmdldEJsb2NrLCBjYWxsLnRhcmdldEJsb2NrICsgY2FsbC5ncmFjZVBlcmlvZCk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBnZXRHZW5lcmF0aW9uU2l6ZSh1aW50IGdlbmVyYXRpb25JZCkgY29uc3RhbnQgcmV0dXJucyAodWludCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxEYXRhYmFzZS5jYWxsZXJQb29sLmdlbmVyYXRpb25zW2dlbmVyYXRpb25JZF0ubWVtYmVycy5sZW5ndGg7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBnZXRHZW5lcmF0aW9uU3RhcnRBdCh1aW50IGdlbmVyYXRpb25JZCkgY29uc3RhbnQgcmV0dXJucyAodWludCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxEYXRhYmFzZS5jYWxsZXJQb29sLmdlbmVyYXRpb25zW2dlbmVyYXRpb25JZF0uc3RhcnRBdDsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGdldEdlbmVyYXRpb25FbmRBdCh1aW50IGdlbmVyYXRpb25JZCkgY29uc3RhbnQgcmV0dXJucyAodWludCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxEYXRhYmFzZS5jYWxsZXJQb29sLmdlbmVyYXRpb25zW2dlbmVyYXRpb25JZF0uZW5kQXQ7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBnZXRDdXJyZW50R2VuZXJhdGlvbklkKCkgY29uc3RhbnQgcmV0dXJucyAodWludCkgewogICAgICAgICAgICAgICAgcmV0dXJuIFJlc291cmNlUG9vbExpYi5nZXRDdXJyZW50R2VuZXJhdGlvbklkKGNhbGxEYXRhYmFzZS5jYWxsZXJQb29sKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGdldE5leHRHZW5lcmF0aW9uSWQoKSBjb25zdGFudCByZXR1cm5zICh1aW50KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gUmVzb3VyY2VQb29sTGliLmdldE5leHRHZW5lcmF0aW9uSWQoY2FsbERhdGFiYXNlLmNhbGxlclBvb2wpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gaXNJblBvb2woKSBjb25zdGFudCByZXR1cm5zIChib29sKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gUmVzb3VyY2VQb29sTGliLmlzSW5Qb29sKGNhbGxEYXRhYmFzZS5jYWxsZXJQb29sLCBtc2cuc2VuZGVyKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGlzSW5Qb29sKGFkZHJlc3MgY2FsbGVyQWRkcmVzcykgY29uc3RhbnQgcmV0dXJucyAoYm9vbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIFJlc291cmNlUG9vbExpYi5pc0luUG9vbChjYWxsRGF0YWJhc2UuY2FsbGVyUG9vbCwgY2FsbGVyQWRkcmVzcyk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBpc0luR2VuZXJhdGlvbih1aW50IGdlbmVyYXRpb25JZCkgY29uc3RhbnQgcmV0dXJucyAoYm9vbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGlzSW5HZW5lcmF0aW9uKG1zZy5zZW5kZXIsIGdlbmVyYXRpb25JZCk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBpc0luR2VuZXJhdGlvbihhZGRyZXNzIGNhbGxlckFkZHJlc3MsIHVpbnQgZ2VuZXJhdGlvbklkKSBjb25zdGFudCByZXR1cm5zIChib29sKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gUmVzb3VyY2VQb29sTGliLmlzSW5HZW5lcmF0aW9uKGNhbGxEYXRhYmFzZS5jYWxsZXJQb29sLCBjYWxsZXJBZGRyZXNzLCBnZW5lcmF0aW9uSWQpOwogICAgICAgIH0KCiAgICAgICAgLyoKICAgICAgICAgKiAgUG9vbCBNZXRhIGluZm9ybWF0aW9uCiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gZ2V0UG9vbEZyZWV6ZVBlcmlvZCgpIGNvbnN0YW50IHJldHVybnMgKHVpbnQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBjYWxsRGF0YWJhc2UuY2FsbGVyUG9vbC5mcmVlemVQZXJpb2Q7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBnZXRQb29sT3ZlcmxhcFNpemUoKSBjb25zdGFudCByZXR1cm5zICh1aW50KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gY2FsbERhdGFiYXNlLmNhbGxlclBvb2wub3ZlcmxhcFNpemU7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBnZXRQb29sUm90YXRpb25EZWxheSgpIGNvbnN0YW50IHJldHVybnMgKHVpbnQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBjYWxsRGF0YWJhc2UuY2FsbGVyUG9vbC5yb3RhdGlvbkRlbGF5OwogICAgICAgIH0KCiAgICAgICAgLyoKICAgICAgICAgKiAgUG9vbCBNZW1iZXJzaGlwCiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gY2FuRW50ZXJQb29sKCkgY29uc3RhbnQgcmV0dXJucyAoYm9vbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIFJlc291cmNlUG9vbExpYi5jYW5FbnRlclBvb2woY2FsbERhdGFiYXNlLmNhbGxlclBvb2wsIG1zZy5zZW5kZXIsIGdldE1pbmltdW1Cb25kKCkpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gY2FuRW50ZXJQb29sKGFkZHJlc3MgY2FsbGVyQWRkcmVzcykgY29uc3RhbnQgcmV0dXJucyAoYm9vbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIFJlc291cmNlUG9vbExpYi5jYW5FbnRlclBvb2woY2FsbERhdGFiYXNlLmNhbGxlclBvb2wsIGNhbGxlckFkZHJlc3MsIGdldE1pbmltdW1Cb25kKCkpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gY2FuRXhpdFBvb2woKSBjb25zdGFudCByZXR1cm5zIChib29sKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gUmVzb3VyY2VQb29sTGliLmNhbkV4aXRQb29sKGNhbGxEYXRhYmFzZS5jYWxsZXJQb29sLCBtc2cuc2VuZGVyKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGNhbkV4aXRQb29sKGFkZHJlc3MgY2FsbGVyQWRkcmVzcykgY29uc3RhbnQgcmV0dXJucyAoYm9vbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIFJlc291cmNlUG9vbExpYi5jYW5FeGl0UG9vbChjYWxsRGF0YWJhc2UuY2FsbGVyUG9vbCwgY2FsbGVyQWRkcmVzcyk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBlbnRlclBvb2woKSBwdWJsaWMgewogICAgICAgICAgICAgICAgdWludCBnZW5lcmF0aW9uSWQgPSBSZXNvdXJjZVBvb2xMaWIuZW50ZXJQb29sKGNhbGxEYXRhYmFzZS5jYWxsZXJQb29sLCBtc2cuc2VuZGVyLCBnZXRNaW5pbXVtQm9uZCgpKTsKICAgICAgICAgICAgICAgIFJlc291cmNlUG9vbExpYi5BZGRlZFRvR2VuZXJhdGlvbihtc2cuc2VuZGVyLCBnZW5lcmF0aW9uSWQpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZXhpdFBvb2woKSBwdWJsaWMgewogICAgICAgICAgICAgICAgdWludCBnZW5lcmF0aW9uSWQgPSBSZXNvdXJjZVBvb2xMaWIuZXhpdFBvb2woY2FsbERhdGFiYXNlLmNhbGxlclBvb2wsIG1zZy5zZW5kZXIpOwogICAgICAgICAgICAgICAgUmVzb3VyY2VQb29sTGliLlJlbW92ZWRGcm9tR2VuZXJhdGlvbihtc2cuc2VuZGVyLCBnZW5lcmF0aW9uSWQpOwogICAgICAgIH0KCiAgICAgICAgLyoKICAgICAgICAgKiAgQ2FsbCBJbmZvcm1hdGlvbiBBUEkKICAgICAgICAgKi8KCiAgICAgICAgZnVuY3Rpb24gZ2V0TGFzdENhbGxLZXkoKSBjb25zdGFudCByZXR1cm5zIChieXRlczMyKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gY2FsbERhdGFiYXNlLmxhc3RDYWxsS2V5OwogICAgICAgIH0KCiAgICAgICAgLyoKICAgICAgICAgKiAgR2V0dGVyIG1ldGhvZHMgZm9yIGBDYWxsYCBpbmZvcm1hdGlvbgogICAgICAgICAqLwogICAgICAgIGZ1bmN0aW9uIGdldENhbGxDb250cmFjdEFkZHJlc3MoYnl0ZXMzMiBjYWxsS2V5KSBjb25zdGFudCByZXR1cm5zIChhZGRyZXNzKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gU2NoZWR1bGVkQ2FsbExpYi5nZXRDYWxsQ29udHJhY3RBZGRyZXNzKGNhbGxEYXRhYmFzZSwgY2FsbEtleSk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBnZXRDYWxsU2NoZWR1bGVkQnkoYnl0ZXMzMiBjYWxsS2V5KSBjb25zdGFudCByZXR1cm5zIChhZGRyZXNzKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gU2NoZWR1bGVkQ2FsbExpYi5nZXRDYWxsU2NoZWR1bGVkQnkoY2FsbERhdGFiYXNlLCBjYWxsS2V5KTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGdldENhbGxDYWxsZWRBdEJsb2NrKGJ5dGVzMzIgY2FsbEtleSkgY29uc3RhbnQgcmV0dXJucyAodWludCkgewogICAgICAgICAgICAgICAgcmV0dXJuIFNjaGVkdWxlZENhbGxMaWIuZ2V0Q2FsbENhbGxlZEF0QmxvY2soY2FsbERhdGFiYXNlLCBjYWxsS2V5KTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGdldENhbGxHcmFjZVBlcmlvZChieXRlczMyIGNhbGxLZXkpIGNvbnN0YW50IHJldHVybnMgKHVpbnQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBTY2hlZHVsZWRDYWxsTGliLmdldENhbGxHcmFjZVBlcmlvZChjYWxsRGF0YWJhc2UsIGNhbGxLZXkpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZ2V0Q2FsbFRhcmdldEJsb2NrKGJ5dGVzMzIgY2FsbEtleSkgY29uc3RhbnQgcmV0dXJucyAodWludCkgewogICAgICAgICAgICAgICAgcmV0dXJuIFNjaGVkdWxlZENhbGxMaWIuZ2V0Q2FsbFRhcmdldEJsb2NrKGNhbGxEYXRhYmFzZSwgY2FsbEtleSk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBnZXRDYWxsQmFzZUdhc1ByaWNlKGJ5dGVzMzIgY2FsbEtleSkgY29uc3RhbnQgcmV0dXJucyAodWludCkgewogICAgICAgICAgICAgICAgcmV0dXJuIFNjaGVkdWxlZENhbGxMaWIuZ2V0Q2FsbEJhc2VHYXNQcmljZShjYWxsRGF0YWJhc2UsIGNhbGxLZXkpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZ2V0Q2FsbEdhc1ByaWNlKGJ5dGVzMzIgY2FsbEtleSkgY29uc3RhbnQgcmV0dXJucyAodWludCkgewogICAgICAgICAgICAgICAgcmV0dXJuIFNjaGVkdWxlZENhbGxMaWIuZ2V0Q2FsbEdhc1ByaWNlKGNhbGxEYXRhYmFzZSwgY2FsbEtleSk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBnZXRDYWxsR2FzVXNlZChieXRlczMyIGNhbGxLZXkpIGNvbnN0YW50IHJldHVybnMgKHVpbnQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBTY2hlZHVsZWRDYWxsTGliLmdldENhbGxHYXNVc2VkKGNhbGxEYXRhYmFzZSwgY2FsbEtleSk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBnZXRDYWxsQUJJU2lnbmF0dXJlKGJ5dGVzMzIgY2FsbEtleSkgY29uc3RhbnQgcmV0dXJucyAoYnl0ZXM0KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gU2NoZWR1bGVkQ2FsbExpYi5nZXRDYWxsQUJJU2lnbmF0dXJlKGNhbGxEYXRhYmFzZSwgY2FsbEtleSk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBjaGVja0lmQ2FsbGVkKGJ5dGVzMzIgY2FsbEtleSkgY29uc3RhbnQgcmV0dXJucyAoYm9vbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIFNjaGVkdWxlZENhbGxMaWIuY2hlY2tJZkNhbGxlZChjYWxsRGF0YWJhc2UsIGNhbGxLZXkpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gY2hlY2tJZlN1Y2Nlc3MoYnl0ZXMzMiBjYWxsS2V5KSBjb25zdGFudCByZXR1cm5zIChib29sKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gU2NoZWR1bGVkQ2FsbExpYi5jaGVja0lmU3VjY2VzcyhjYWxsRGF0YWJhc2UsIGNhbGxLZXkpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gY2hlY2tJZkNhbmNlbGxlZChieXRlczMyIGNhbGxLZXkpIGNvbnN0YW50IHJldHVybnMgKGJvb2wpIHsKICAgICAgICAgICAgICAgIHJldHVybiBTY2hlZHVsZWRDYWxsTGliLmNoZWNrSWZDYW5jZWxsZWQoY2FsbERhdGFiYXNlLCBjYWxsS2V5KTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGdldENhbGxEYXRhSGFzaChieXRlczMyIGNhbGxLZXkpIGNvbnN0YW50IHJldHVybnMgKGJ5dGVzMzIpIHsKICAgICAgICAgICAgICAgIHJldHVybiBTY2hlZHVsZWRDYWxsTGliLmdldENhbGxEYXRhSGFzaChjYWxsRGF0YWJhc2UsIGNhbGxLZXkpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZ2V0Q2FsbFBheW91dChieXRlczMyIGNhbGxLZXkpIGNvbnN0YW50IHJldHVybnMgKHVpbnQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBTY2hlZHVsZWRDYWxsTGliLmdldENhbGxQYXlvdXQoY2FsbERhdGFiYXNlLCBjYWxsS2V5KTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGdldENhbGxGZWUoYnl0ZXMzMiBjYWxsS2V5KSBjb25zdGFudCByZXR1cm5zICh1aW50KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gU2NoZWR1bGVkQ2FsbExpYi5nZXRDYWxsRmVlKGNhbGxEYXRhYmFzZSwgY2FsbEtleSk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBnZXRDYWxsTWF4Q29zdChieXRlczMyIGNhbGxLZXkpIGNvbnN0YW50IHJldHVybnMgKHVpbnQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBTY2hlZHVsZWRDYWxsTGliLmdldENhbGxNYXhDb3N0KGNhbGxEYXRhYmFzZSwgY2FsbEtleSk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBnZXRDYWxsRGF0YShieXRlczMyIGNhbGxLZXkpIGNvbnN0YW50IHJldHVybnMgKGJ5dGVzKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gY2FsbERhdGFiYXNlLmRhdGFfcmVnaXN0cnlbY2FsbERhdGFiYXNlLmNhbGxzW2NhbGxLZXldLmRhdGFIYXNoXTsKICAgICAgICB9CgogICAgICAgIC8qCiAgICAgICAgICogIERhdGEgcmVnaXN0cmF0aW9uIEFQSQogICAgICAgICAqLwogICAgICAgIGZ1bmN0aW9uIHJlZ2lzdGVyRGF0YSgpIHB1YmxpYyB7CiAgICAgICAgICAgICAgICBTY2hlZHVsZWRDYWxsTGliLnJlZ2lzdGVyRGF0YShjYWxsRGF0YWJhc2UsIG1zZy5kYXRhKTsKICAgICAgICAgICAgICAgIFNjaGVkdWxlZENhbGxMaWIuRGF0YVJlZ2lzdGVyZWQoY2FsbERhdGFiYXNlLmxhc3REYXRhSGFzaCk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBnZXRMYXN0RGF0YUhhc2goKSBjb25zdGFudCByZXR1cm5zIChieXRlczMyKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gY2FsbERhdGFiYXNlLmxhc3REYXRhSGFzaDsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGdldExhc3REYXRhTGVuZ3RoKCkgY29uc3RhbnQgcmV0dXJucyAodWludCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxEYXRhYmFzZS5sYXN0RGF0YUxlbmd0aDsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGdldExhc3REYXRhKCkgY29uc3RhbnQgcmV0dXJucyAoYnl0ZXMpIHsKICAgICAgICAgICAgICAgIHJldHVybiBjYWxsRGF0YWJhc2UubGFzdERhdGE7CiAgICAgICAgfQoKICAgICAgICAvKgogICAgICAgICAqICBDYWxsIGV4ZWN1dGlvbiBBUEkKICAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiBkb0NhbGwoYnl0ZXMzMiBjYWxsS2V5KSBwdWJsaWMgewogICAgICAgICAgICAgICAgU2NoZWR1bGVkQ2FsbExpYi5kb0NhbGwoY2FsbERhdGFiYXNlLCBjYWxsS2V5LCBtc2cuc2VuZGVyKTsKICAgICAgICB9CgogICAgICAgIC8qCiAgICAgICAgICogIENhbGwgU2NoZWR1bGluZyBBUEkKICAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiBnZXRNaW5pbXVtR3JhY2VQZXJpb2QoKSBjb25zdGFudCByZXR1cm5zICh1aW50KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gU2NoZWR1bGVkQ2FsbExpYi5nZXRNaW5pbXVtR3JhY2VQZXJpb2QoKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHNjaGVkdWxlQ2FsbChhZGRyZXNzIGNvbnRyYWN0QWRkcmVzcywgYnl0ZXM0IGFiaVNpZ25hdHVyZSwgYnl0ZXMzMiBkYXRhSGFzaCwgdWludCB0YXJnZXRCbG9jaykgcHVibGljIHsKICAgICAgICAgICAgICAgIC8qCiAgICAgICAgICAgICAgICAgKiAgU2NoZWR1bGUgY2FsbCB3aXRoIGdyYWNlUGVyaW9kIGRlZmF1bHRlZCB0byAyNTUgYW5kIG5vbmNlCiAgICAgICAgICAgICAgICAgKiAgZGVmYXVsdGVkIHRvIDAuCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIHNjaGVkdWxlQ2FsbChjb250cmFjdEFkZHJlc3MsIGFiaVNpZ25hdHVyZSwgZGF0YUhhc2gsIHRhcmdldEJsb2NrLCAyNTUsIDApOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gc2NoZWR1bGVDYWxsKGFkZHJlc3MgY29udHJhY3RBZGRyZXNzLCBieXRlczQgYWJpU2lnbmF0dXJlLCBieXRlczMyIGRhdGFIYXNoLCB1aW50IHRhcmdldEJsb2NrLCB1aW50OCBncmFjZVBlcmlvZCkgcHVibGljIHsKICAgICAgICAgICAgICAgIC8qCiAgICAgICAgICAgICAgICAgKiAgU2NoZWR1bGUgY2FsbCB3aXRoIG5vbmNlIGRlZmF1bHRlZCB0byAwLgogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBzY2hlZHVsZUNhbGwoY29udHJhY3RBZGRyZXNzLCBhYmlTaWduYXR1cmUsIGRhdGFIYXNoLCB0YXJnZXRCbG9jaywgZ3JhY2VQZXJpb2QsIDApOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gc2NoZWR1bGVDYWxsKGFkZHJlc3MgY29udHJhY3RBZGRyZXNzLCBieXRlczQgYWJpU2lnbmF0dXJlLCBieXRlczMyIGRhdGFIYXNoLCB1aW50IHRhcmdldEJsb2NrLCB1aW50OCBncmFjZVBlcmlvZCwgdWludCBub25jZSkgcHVibGljIHsKICAgICAgICAgICAgICAgIC8qCiAgICAgICAgICAgICAgICAgKiBQcmltYXJ5IEFQSSBmb3Igc2NoZWR1bGluZyBhIGNhbGwuICBQcmlvciB0byBjYWxsaW5nIHRoaXMKICAgICAgICAgICAgICAgICAqIHRoZSBkYXRhIHNob3VsZCBhbHJlYWR5IGhhdmUgYmVlbiByZWdpc3RlcmVkIHRocm91Z2ggdGhlCiAgICAgICAgICAgICAgICAgKiBgcmVnaXN0ZXJEYXRhYCBBUEkuCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIGJ5dGVzMTUgcmVhc29uID0gU2NoZWR1bGVkQ2FsbExpYi5zY2hlZHVsZUNhbGwoY2FsbERhdGFiYXNlLCBtc2cuc2VuZGVyLCBjb250cmFjdEFkZHJlc3MsIGFiaVNpZ25hdHVyZSwgZGF0YUhhc2gsIHRhcmdldEJsb2NrLCBncmFjZVBlcmlvZCwgbm9uY2UpOwogICAgICAgICAgICAgICAgYnl0ZXMzMiBjYWxsS2V5ID0gU2NoZWR1bGVkQ2FsbExpYi5jb21wdXRlQ2FsbEtleShtc2cuc2VuZGVyLCBjb250cmFjdEFkZHJlc3MsIGFiaVNpZ25hdHVyZSwgZGF0YUhhc2gsIHRhcmdldEJsb2NrLCBncmFjZVBlcmlvZCwgbm9uY2UpOwoKICAgICAgICAgICAgICAgIGlmIChyZWFzb24gIT0gMHgwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIFNjaGVkdWxlZENhbGxMaWIuQ2FsbFJlamVjdGVkKGNhbGxLZXksIHJlYXNvbik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgU2NoZWR1bGVkQ2FsbExpYi5DYWxsU2NoZWR1bGVkKGNhbGxLZXkpOwogICAgICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gY2FuY2VsQ2FsbChieXRlczMyIGNhbGxLZXkpIHB1YmxpYyB7CiAgICAgICAgICAgICAgICBpZiAoU2NoZWR1bGVkQ2FsbExpYi5jYW5jZWxDYWxsKGNhbGxEYXRhYmFzZSwgY2FsbEtleSwgYWRkcmVzcyhtc2cuc2VuZGVyKSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgU2NoZWR1bGVkQ2FsbExpYi5DYWxsQ2FuY2VsbGVkKGNhbGxLZXkpOwogICAgICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLyoKICAgICAgICAgKiAgTmV4dCBDYWxsIEFQSQogICAgICAgICAqLwogICAgICAgIGZ1bmN0aW9uIGdldENhbGxXaW5kb3dTaXplKCkgY29uc3RhbnQgcmV0dXJucyAodWludCkgewogICAgICAgICAgICAgICAgcmV0dXJuIFNjaGVkdWxlZENhbGxMaWIuZ2V0Q2FsbFdpbmRvd1NpemUoKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGdldEdlbmVyYXRpb25JZEZvckNhbGwoYnl0ZXMzMiBjYWxsS2V5KSBjb25zdGFudCByZXR1cm5zICh1aW50KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gU2NoZWR1bGVkQ2FsbExpYi5nZXRHZW5lcmF0aW9uSWRGb3JDYWxsKGNhbGxEYXRhYmFzZSwgY2FsbEtleSk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBnZXREZXNpZ25hdGVkQ2FsbGVyKGJ5dGVzMzIgY2FsbEtleSwgdWludCBibG9ja051bWJlcikgY29uc3RhbnQgcmV0dXJucyAoYWRkcmVzcykgewogICAgICAgICAgICAgICAgcmV0dXJuIFNjaGVkdWxlZENhbGxMaWIuZ2V0RGVzaWduYXRlZENhbGxlcihjYWxsRGF0YWJhc2UsIGNhbGxLZXksIGJsb2NrTnVtYmVyKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGdldE5leHRDYWxsKHVpbnQgYmxvY2tOdW1iZXIpIGNvbnN0YW50IHJldHVybnMgKGJ5dGVzMzIpIHsKICAgICAgICAgICAgICAgIHJldHVybiBHcm92ZUxpYi5xdWVyeShjYWxsRGF0YWJhc2UuY2FsbEluZGV4LCAiPj0iLCBpbnQoYmxvY2tOdW1iZXIpKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGdldE5leHRDYWxsU2libGluZyhieXRlczMyIGNhbGxLZXkpIGNvbnN0YW50IHJldHVybnMgKGJ5dGVzMzIpIHsKICAgICAgICAgICAgICAgIHJldHVybiBHcm92ZUxpYi5nZXROZXh0Tm9kZShjYWxsRGF0YWJhc2UuY2FsbEluZGV4LCBjYWxsS2V5KTsKICAgICAgICB9Cn0='.
	

]
